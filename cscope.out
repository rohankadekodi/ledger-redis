cscope 15 $HOME/projects/redis-4.0.10               0003505988
	@deps/hiredis/adapters/ae.h

31 #iâdeà
__HIREDIS_AE_H__


32 
	#__HIREDIS_AE_H__


	)

33 
	~<sys/ty³s.h
>

34 
	~<«.h
>

35 
	~"../hœedis.h
"

36 
	~"../async.h
"

38 
	s»disAeEv’ts
 {

39 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

40 
«Ev’tLoİ
 *
	mloİ
;

41 
	mfd
;

42 
	m»adšg
, 
	mwr™šg
;

43 } 
	t»disAeEv’ts
;

45 
	$»disAeR—dEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

46 (()
–
); (()
fd
); (()
mask
);

48 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

49 
	`»disAsyncHªdËR—d
(
e
->
cÚ‹xt
);

50 
	}
}

52 
	$»disAeWr™eEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

53 (()
–
); (()
fd
); (()
mask
);

55 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

56 
	`»disAsyncHªdËWr™e
(
e
->
cÚ‹xt
);

57 
	}
}

59 
	$»disAeAddR—d
(*
´ivd©a
) {

60 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

61 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

62 ià(!
e
->
»adšg
) {

63 
e
->
»adšg
 = 1;

64 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
,
»disAeR—dEv’t
,e);

66 
	}
}

68 
	$»disAeD–R—d
(*
´ivd©a
) {

69 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

70 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

71 ià(
e
->
»adšg
) {

72 
e
->
»adšg
 = 0;

73 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
);

75 
	}
}

77 
	$»disAeAddWr™e
(*
´ivd©a
) {

78 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

79 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

80 ià(!
e
->
wr™šg
) {

81 
e
->
wr™šg
 = 1;

82 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
,
»disAeWr™eEv’t
,e);

84 
	}
}

86 
	$»disAeD–Wr™e
(*
´ivd©a
) {

87 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

88 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

89 ià(
e
->
wr™šg
) {

90 
e
->
wr™šg
 = 0;

91 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
);

93 
	}
}

95 
	$»disAeCËªup
(*
´ivd©a
) {

96 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

97 
	`»disAeD–R—d
(
´ivd©a
);

98 
	`»disAeD–Wr™e
(
´ivd©a
);

99 
	`ä“
(
e
);

100 
	}
}

102 
	$»disAeA‰ach
(
«Ev’tLoİ
 *
loİ
, 
»disAsyncCÚ‹xt
 *
ac
) {

103 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

104 
»disAeEv’ts
 *
e
;

107 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

108  
REDIS_ERR
;

111 
e
 = (
»disAeEv’ts
*)
	`m®loc
((*e));

112 
e
->
cÚ‹xt
 = 
ac
;

113 
e
->
loİ
 =†oop;

114 
e
->
fd
 = 
c
->fd;

115 
e
->
»adšg
 =ƒ->
wr™šg
 = 0;

118 
ac
->
ev
.
addR—d
 = 
»disAeAddR—d
;

119 
ac
->
ev
.
d–R—d
 = 
»disAeD–R—d
;

120 
ac
->
ev
.
addWr™e
 = 
»disAeAddWr™e
;

121 
ac
->
ev
.
d–Wr™e
 = 
»disAeD–Wr™e
;

122 
ac
->
ev
.
ş—nup
 = 
»disAeCËªup
;

123 
ac
->
ev
.
d©a
 = 
e
;

125  
REDIS_OK
;

126 
	}
}

	@deps/hiredis/adapters/glib.h

1 #iâdeà
__HIREDIS_GLIB_H__


2 
	#__HIREDIS_GLIB_H__


	)

4 
	~<glib.h
>

6 
	~"../hœedis.h
"

7 
	~"../async.h
"

11 
GSourû
 
	msourû
;

12 
»disAsyncCÚ‹xt
 *
	mac
;

13 
GPŞlFD
 
	mpŞl_fd
;

14 } 
	tRedisSourû
;

17 
	$»dis_sourû_add_»ad
 (
gpoš‹r
 
d©a
)

19 
RedisSourû
 *
sourû
 = (RedisSourû *)
d©a
;

20 
	`g_»tuº_if_ç
(
sourû
);

21 
sourû
->
pŞl_fd
.
ev’ts
 |ğ
G_IO_IN
;

22 
	`g_maš_cÚ‹xt_wakeup
(
	`g_sourû_g‘_cÚ‹xt
((
GSourû
 *)
d©a
));

23 
	}
}

26 
	$»dis_sourû_d–_»ad
 (
gpoš‹r
 
d©a
)

28 
RedisSourû
 *
sourû
 = (RedisSourû *)
d©a
;

29 
	`g_»tuº_if_ç
(
sourû
);

30 
sourû
->
pŞl_fd
.
ev’ts
 &ğ~
G_IO_IN
;

31 
	`g_maš_cÚ‹xt_wakeup
(
	`g_sourû_g‘_cÚ‹xt
((
GSourû
 *)
d©a
));

32 
	}
}

35 
	$»dis_sourû_add_wr™e
 (
gpoš‹r
 
d©a
)

37 
RedisSourû
 *
sourû
 = (RedisSourû *)
d©a
;

38 
	`g_»tuº_if_ç
(
sourû
);

39 
sourû
->
pŞl_fd
.
ev’ts
 |ğ
G_IO_OUT
;

40 
	`g_maš_cÚ‹xt_wakeup
(
	`g_sourû_g‘_cÚ‹xt
((
GSourû
 *)
d©a
));

41 
	}
}

44 
	$»dis_sourû_d–_wr™e
 (
gpoš‹r
 
d©a
)

46 
RedisSourû
 *
sourû
 = (RedisSourû *)
d©a
;

47 
	`g_»tuº_if_ç
(
sourû
);

48 
sourû
->
pŞl_fd
.
ev’ts
 &ğ~
G_IO_OUT
;

49 
	`g_maš_cÚ‹xt_wakeup
(
	`g_sourû_g‘_cÚ‹xt
((
GSourû
 *)
d©a
));

50 
	}
}

53 
	$»dis_sourû_ş—nup
 (
gpoš‹r
 
d©a
)

55 
RedisSourû
 *
sourû
 = (RedisSourû *)
d©a
;

57 
	`g_»tuº_if_ç
(
sourû
);

59 
	`»dis_sourû_d–_»ad
(
sourû
);

60 
	`»dis_sourû_d–_wr™e
(
sourû
);

65 ià(
sourû
->
pŞl_fd
.
fd
 >= 0) {

66 
	`g_sourû_»move_pŞl
((
GSourû
 *)
d©a
, &
sourû
->
pŞl_fd
);

67 
sourû
->
pŞl_fd
.
fd
 = -1;

69 
	}
}

71 
gboŞ—n


72 
	$»dis_sourû_´•¬e
 (
GSourû
 *
sourû
,

73 
gšt
 *
timeout_
)

75 
RedisSourû
 *
»dis
 = (RedisSourû *)
sourû
;

76 *
timeout_
 = -1;

77  !!(
»dis
->
pŞl_fd
.
ev’ts
 &„edis->pŞl_fd.
»v’ts
);

78 
	}
}

80 
gboŞ—n


81 
	$»dis_sourû_check
 (
GSourû
 *
sourû
)

83 
RedisSourû
 *
»dis
 = (RedisSourû *)
sourû
;

84  !!(
»dis
->
pŞl_fd
.
ev’ts
 &„edis->pŞl_fd.
»v’ts
);

85 
	}
}

87 
gboŞ—n


88 
	$»dis_sourû_di¥©ch
 (
GSourû
 *
sourû
,

89 
GSourûFunc
 
ÿÎback
,

90 
gpoš‹r
 
u£r_d©a
)

92 
RedisSourû
 *
»dis
 = (RedisSourû *)
sourû
;

94 ià((
»dis
->
pŞl_fd
.
»v’ts
 & 
G_IO_OUT
)) {

95 
	`»disAsyncHªdËWr™e
(
»dis
->
ac
);

96 
»dis
->
pŞl_fd
.
»v’ts
 &ğ~
G_IO_OUT
;

99 ià((
»dis
->
pŞl_fd
.
»v’ts
 & 
G_IO_IN
)) {

100 
	`»disAsyncHªdËR—d
(
»dis
->
ac
);

101 
»dis
->
pŞl_fd
.
»v’ts
 &ğ~
G_IO_IN
;

104 ià(
ÿÎback
) {

105  
	`ÿÎback
(
u£r_d©a
);

108  
TRUE
;

109 
	}
}

112 
	$»dis_sourû_fš®ize
 (
GSourû
 *
sourû
)

114 
RedisSourû
 *
»dis
 = (RedisSourû *)
sourû
;

116 ià(
»dis
->
pŞl_fd
.
fd
 >= 0) {

117 
	`g_sourû_»move_pŞl
(
sourû
, &
»dis
->
pŞl_fd
);

118 
»dis
->
pŞl_fd
.
fd
 = -1;

120 
	}
}

122 
GSourû
 *

123 
	$»dis_sourû_Ãw
 (
»disAsyncCÚ‹xt
 *
ac
)

125 
GSourûFuncs
 
sourû_funcs
 = {

126 .
´•¬e
 = 
»dis_sourû_´•¬e
,

127 .
check
 = 
»dis_sourû_check
,

128 .
di¥©ch
 = 
»dis_sourû_di¥©ch
,

129 .
fš®ize
 = 
»dis_sourû_fš®ize
,

131 
»disCÚ‹xt
 *
c
 = &
ac
->c;

132 
RedisSourû
 *
sourû
;

134 
	`g_»tuº_v®_if_ç
(
ac
 !ğ
NULL
, NULL);

136 
sourû
 = (
RedisSourû
 *)
	`g_sourû_Ãw
(&
sourû_funcs
,  *source);

137 
sourû
->
ac
 =‡c;

138 
sourû
->
pŞl_fd
.
fd
 = 
c
->fd;

139 
sourû
->
pŞl_fd
.
ev’ts
 = 0;

140 
sourû
->
pŞl_fd
.
»v’ts
 = 0;

141 
	`g_sourû_add_pŞl
((
GSourû
 *)
sourû
, &sourû->
pŞl_fd
);

143 
ac
->
ev
.
addR—d
 = 
»dis_sourû_add_»ad
;

144 
ac
->
ev
.
d–R—d
 = 
»dis_sourû_d–_»ad
;

145 
ac
->
ev
.
addWr™e
 = 
»dis_sourû_add_wr™e
;

146 
ac
->
ev
.
d–Wr™e
 = 
»dis_sourû_d–_wr™e
;

147 
ac
->
ev
.
ş—nup
 = 
»dis_sourû_ş—nup
;

148 
ac
->
ev
.
d©a
 = 
sourû
;

150  (
GSourû
 *)
sourû
;

151 
	}
}

	@deps/hiredis/adapters/ivykis.h

1 #iâdeà
__HIREDIS_IVYKIS_H__


2 
	#__HIREDIS_IVYKIS_H__


	)

3 
	~<iv.h
>

4 
	~"../hœedis.h
"

5 
	~"../async.h
"

7 
	s»disIvykisEv’ts
 {

8 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

9 
iv_fd
 
	mfd
;

10 } 
	t»disIvykisEv’ts
;

12 
	$»disIvykisR—dEv’t
(*
¬g
) {

13 
»disAsyncCÚ‹xt
 *
cÚ‹xt
 = (»disAsyncCÚ‹xˆ*)
¬g
;

14 
	`»disAsyncHªdËR—d
(
cÚ‹xt
);

15 
	}
}

17 
	$»disIvykisWr™eEv’t
(*
¬g
) {

18 
»disAsyncCÚ‹xt
 *
cÚ‹xt
 = (»disAsyncCÚ‹xˆ*)
¬g
;

19 
	`»disAsyncHªdËWr™e
(
cÚ‹xt
);

20 
	}
}

22 
	$»disIvykisAddR—d
(*
´ivd©a
) {

23 
»disIvykisEv’ts
 *
e
 = (»disIvykisEv’ts*)
´ivd©a
;

24 
	`iv_fd_£t_hªdËr_š
(&
e
->
fd
, 
»disIvykisR—dEv’t
);

25 
	}
}

27 
	$»disIvykisD–R—d
(*
´ivd©a
) {

28 
»disIvykisEv’ts
 *
e
 = (»disIvykisEv’ts*)
´ivd©a
;

29 
	`iv_fd_£t_hªdËr_š
(&
e
->
fd
, 
NULL
);

30 
	}
}

32 
	$»disIvykisAddWr™e
(*
´ivd©a
) {

33 
»disIvykisEv’ts
 *
e
 = (»disIvykisEv’ts*)
´ivd©a
;

34 
	`iv_fd_£t_hªdËr_out
(&
e
->
fd
, 
»disIvykisWr™eEv’t
);

35 
	}
}

37 
	$»disIvykisD–Wr™e
(*
´ivd©a
) {

38 
»disIvykisEv’ts
 *
e
 = (»disIvykisEv’ts*)
´ivd©a
;

39 
	`iv_fd_£t_hªdËr_out
(&
e
->
fd
, 
NULL
);

40 
	}
}

42 
	$»disIvykisCËªup
(*
´ivd©a
) {

43 
»disIvykisEv’ts
 *
e
 = (»disIvykisEv’ts*)
´ivd©a
;

45 
	`iv_fd_uÄegi¡”
(&
e
->
fd
);

46 
	`ä“
(
e
);

47 
	}
}

49 
	$»disIvykisA‰ach
(
»disAsyncCÚ‹xt
 *
ac
) {

50 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

51 
»disIvykisEv’ts
 *
e
;

54 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

55  
REDIS_ERR
;

58 
e
 = (
»disIvykisEv’ts
*)
	`m®loc
((*e));

59 
e
->
cÚ‹xt
 = 
ac
;

62 
ac
->
ev
.
addR—d
 = 
»disIvykisAddR—d
;

63 
ac
->
ev
.
d–R—d
 = 
»disIvykisD–R—d
;

64 
ac
->
ev
.
addWr™e
 = 
»disIvykisAddWr™e
;

65 
ac
->
ev
.
d–Wr™e
 = 
»disIvykisD–Wr™e
;

66 
ac
->
ev
.
ş—nup
 = 
»disIvykisCËªup
;

67 
ac
->
ev
.
d©a
 = 
e
;

70 
	`IV_FD_INIT
(&
e
->
fd
);

71 
e
->
fd
.fd = 
c
->fd;

72 
e
->
fd
.
hªdËr_š
 = 
»disIvykisR—dEv’t
;

73 
e
->
fd
.
hªdËr_out
 = 
»disIvykisWr™eEv’t
;

74 
e
->
fd
.
hªdËr_”r
 = 
NULL
;

75 
e
->
fd
.
cook›
 =ƒ->
cÚ‹xt
;

77 
	`iv_fd_»gi¡”
(&
e
->
fd
);

79  
REDIS_OK
;

80 
	}
}

	@deps/hiredis/adapters/libev.h

31 #iâdeà
__HIREDIS_LIBEV_H__


32 
	#__HIREDIS_LIBEV_H__


	)

33 
	~<¡dlib.h
>

34 
	~<sys/ty³s.h
>

35 
	~<ev.h
>

36 
	~"../hœedis.h
"

37 
	~"../async.h
"

39 
	s»disLibevEv’ts
 {

40 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

41 
ev_loİ
 *
	mloİ
;

42 
	m»adšg
, 
	mwr™šg
;

43 
ev_io
 
	m»v
, 
	mwev
;

44 } 
	t»disLibevEv’ts
;

46 
	$»disLibevR—dEv’t
(
EV_P_
 
ev_io
 *
w©ch”
, 
»v’ts
) {

47 #ià
EV_MULTIPLICITY


48 (()
loİ
);

50 (()
»v’ts
);

52 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
w©ch”
->
d©a
;

53 
	`»disAsyncHªdËR—d
(
e
->
cÚ‹xt
);

54 
	}
}

56 
	$»disLibevWr™eEv’t
(
EV_P_
 
ev_io
 *
w©ch”
, 
»v’ts
) {

57 #ià
EV_MULTIPLICITY


58 (()
loİ
);

60 (()
»v’ts
);

62 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
w©ch”
->
d©a
;

63 
	`»disAsyncHªdËWr™e
(
e
->
cÚ‹xt
);

64 
	}
}

66 
	$»disLibevAddR—d
(*
´ivd©a
) {

67 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
´ivd©a
;

68 
ev_loİ
 *
loİ
 = 
e
->loop;

69 (()
loİ
);

70 ià(!
e
->
»adšg
) {

71 
e
->
»adšg
 = 1;

72 
	`ev_io_¡¬t
(
EV_A_
 &
e
->
»v
);

74 
	}
}

76 
	$»disLibevD–R—d
(*
´ivd©a
) {

77 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
´ivd©a
;

78 
ev_loİ
 *
loİ
 = 
e
->loop;

79 (()
loİ
);

80 ià(
e
->
»adšg
) {

81 
e
->
»adšg
 = 0;

82 
	`ev_io_¡İ
(
EV_A_
 &
e
->
»v
);

84 
	}
}

86 
	$»disLibevAddWr™e
(*
´ivd©a
) {

87 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
´ivd©a
;

88 
ev_loİ
 *
loİ
 = 
e
->loop;

89 (()
loİ
);

90 ià(!
e
->
wr™šg
) {

91 
e
->
wr™šg
 = 1;

92 
	`ev_io_¡¬t
(
EV_A_
 &
e
->
wev
);

94 
	}
}

96 
	$»disLibevD–Wr™e
(*
´ivd©a
) {

97 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
´ivd©a
;

98 
ev_loİ
 *
loİ
 = 
e
->loop;

99 (()
loİ
);

100 ià(
e
->
wr™šg
) {

101 
e
->
wr™šg
 = 0;

102 
	`ev_io_¡İ
(
EV_A_
 &
e
->
wev
);

104 
	}
}

106 
	$»disLibevCËªup
(*
´ivd©a
) {

107 
»disLibevEv’ts
 *
e
 = (»disLibevEv’ts*)
´ivd©a
;

108 
	`»disLibevD–R—d
(
´ivd©a
);

109 
	`»disLibevD–Wr™e
(
´ivd©a
);

110 
	`ä“
(
e
);

111 
	}
}

113 
	$»disLibevA‰ach
(
EV_P_
 
»disAsyncCÚ‹xt
 *
ac
) {

114 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

115 
»disLibevEv’ts
 *
e
;

118 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

119  
REDIS_ERR
;

122 
e
 = (
»disLibevEv’ts
*)
	`m®loc
((*e));

123 
e
->
cÚ‹xt
 = 
ac
;

124 #ià
EV_MULTIPLICITY


125 
e
->
loİ
 =†oop;

127 
e
->
loİ
 = 
NULL
;

129 
e
->
»adšg
 =ƒ->
wr™šg
 = 0;

130 
e
->
»v
.
d©a
 =ƒ;

131 
e
->
wev
.
d©a
 =ƒ;

134 
ac
->
ev
.
addR—d
 = 
»disLibevAddR—d
;

135 
ac
->
ev
.
d–R—d
 = 
»disLibevD–R—d
;

136 
ac
->
ev
.
addWr™e
 = 
»disLibevAddWr™e
;

137 
ac
->
ev
.
d–Wr™e
 = 
»disLibevD–Wr™e
;

138 
ac
->
ev
.
ş—nup
 = 
»disLibevCËªup
;

139 
ac
->
ev
.
d©a
 = 
e
;

142 
	`ev_io_š™
(&
e
->
»v
,
»disLibevR—dEv’t
,
c
->
fd
,
EV_READ
);

143 
	`ev_io_š™
(&
e
->
wev
,
»disLibevWr™eEv’t
,
c
->
fd
,
EV_WRITE
);

144  
REDIS_OK
;

145 
	}
}

	@deps/hiredis/adapters/libevent.h

31 #iâdeà
__HIREDIS_LIBEVENT_H__


32 
	#__HIREDIS_LIBEVENT_H__


	)

33 
	~<ev’t2/ev’t.h
>

34 
	~"../hœedis.h
"

35 
	~"../async.h
"

37 
	s»disLibev’tEv’ts
 {

38 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

39 
ev’t
 *
	m»v
, *
	mwev
;

40 } 
	t»disLibev’tEv’ts
;

42 
	$»disLibev’tR—dEv’t
(
fd
, 
ev’t
, *
¬g
) {

43 (()
fd
); (()
ev’t
);

44 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
¬g
;

45 
	`»disAsyncHªdËR—d
(
e
->
cÚ‹xt
);

46 
	}
}

48 
	$»disLibev’tWr™eEv’t
(
fd
, 
ev’t
, *
¬g
) {

49 (()
fd
); (()
ev’t
);

50 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
¬g
;

51 
	`»disAsyncHªdËWr™e
(
e
->
cÚ‹xt
);

52 
	}
}

54 
	$»disLibev’tAddR—d
(*
´ivd©a
) {

55 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
´ivd©a
;

56 
	`ev’t_add
(
e
->
»v
,
NULL
);

57 
	}
}

59 
	$»disLibev’tD–R—d
(*
´ivd©a
) {

60 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
´ivd©a
;

61 
	`ev’t_d–
(
e
->
»v
);

62 
	}
}

64 
	$»disLibev’tAddWr™e
(*
´ivd©a
) {

65 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
´ivd©a
;

66 
	`ev’t_add
(
e
->
wev
,
NULL
);

67 
	}
}

69 
	$»disLibev’tD–Wr™e
(*
´ivd©a
) {

70 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
´ivd©a
;

71 
	`ev’t_d–
(
e
->
wev
);

72 
	}
}

74 
	$»disLibev’tCËªup
(*
´ivd©a
) {

75 
»disLibev’tEv’ts
 *
e
 = (»disLibev’tEv’ts*)
´ivd©a
;

76 
	`ev’t_d–
(
e
->
»v
);

77 
	`ev’t_d–
(
e
->
wev
);

78 
	`ä“
(
e
);

79 
	}
}

81 
	$»disLibev’tA‰ach
(
»disAsyncCÚ‹xt
 *
ac
, 
ev’t_ba£
 *
ba£
) {

82 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

83 
»disLibev’tEv’ts
 *
e
;

86 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

87  
REDIS_ERR
;

90 
e
 = (
»disLibev’tEv’ts
*)
	`m®loc
((*e));

91 
e
->
cÚ‹xt
 = 
ac
;

94 
ac
->
ev
.
addR—d
 = 
»disLibev’tAddR—d
;

95 
ac
->
ev
.
d–R—d
 = 
»disLibev’tD–R—d
;

96 
ac
->
ev
.
addWr™e
 = 
»disLibev’tAddWr™e
;

97 
ac
->
ev
.
d–Wr™e
 = 
»disLibev’tD–Wr™e
;

98 
ac
->
ev
.
ş—nup
 = 
»disLibev’tCËªup
;

99 
ac
->
ev
.
d©a
 = 
e
;

102 
e
->
»v
 = 
	`ev’t_Ãw
(
ba£
, 
c
->
fd
, 
EV_READ
, 
»disLibev’tR—dEv’t
,ƒ);

103 
e
->
wev
 = 
	`ev’t_Ãw
(
ba£
, 
c
->
fd
, 
EV_WRITE
, 
»disLibev’tWr™eEv’t
,ƒ);

104 
	`ev’t_add
(
e
->
»v
, 
NULL
);

105 
	`ev’t_add
(
e
->
wev
, 
NULL
);

106  
REDIS_OK
;

107 
	}
}

	@deps/hiredis/adapters/libuv.h

1 #iâdeà
__HIREDIS_LIBUV_H__


2 
	#__HIREDIS_LIBUV_H__


	)

3 
	~<¡dlib.h
>

4 
	~<uv.h
>

5 
	~"../hœedis.h
"

6 
	~"../async.h
"

7 
	~<¡ršg.h
>

9 
	s»disLibuvEv’ts
 {

10 
»disAsyncCÚ‹xt
* 
	mcÚ‹xt
;

11 
uv_pŞl_t
 
	mhªdË
;

12 
	mev’ts
;

13 } 
	t»disLibuvEv’ts
;

16 
	$»disLibuvPŞl
(
uv_pŞl_t
* 
hªdË
, 
¡©us
, 
ev’ts
) {

17 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
hªdË
->
d©a
;

19 ià(
¡©us
 != 0) {

23 ià(
p
->
cÚ‹xt
 !ğ
NULL
 && (
ev’ts
 & 
UV_READABLE
)) {

24 
	`»disAsyncHªdËR—d
(
p
->
cÚ‹xt
);

26 ià(
p
->
cÚ‹xt
 !ğ
NULL
 && (
ev’ts
 & 
UV_WRITABLE
)) {

27 
	`»disAsyncHªdËWr™e
(
p
->
cÚ‹xt
);

29 
	}
}

32 
	$»disLibuvAddR—d
(*
´ivd©a
) {

33 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
´ivd©a
;

35 
p
->
ev’ts
 |ğ
UV_READABLE
;

37 
	`uv_pŞl_¡¬t
(&
p
->
hªdË
,…->
ev’ts
, 
»disLibuvPŞl
);

38 
	}
}

41 
	$»disLibuvD–R—d
(*
´ivd©a
) {

42 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
´ivd©a
;

44 
p
->
ev’ts
 &ğ~
UV_READABLE
;

46 ià(
p
->
ev’ts
) {

47 
	`uv_pŞl_¡¬t
(&
p
->
hªdË
,…->
ev’ts
, 
»disLibuvPŞl
);

49 
	`uv_pŞl_¡İ
(&
p
->
hªdË
);

51 
	}
}

54 
	$»disLibuvAddWr™e
(*
´ivd©a
) {

55 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
´ivd©a
;

57 
p
->
ev’ts
 |ğ
UV_WRITABLE
;

59 
	`uv_pŞl_¡¬t
(&
p
->
hªdË
,…->
ev’ts
, 
»disLibuvPŞl
);

60 
	}
}

63 
	$»disLibuvD–Wr™e
(*
´ivd©a
) {

64 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
´ivd©a
;

66 
p
->
ev’ts
 &ğ~
UV_WRITABLE
;

68 ià(
p
->
ev’ts
) {

69 
	`uv_pŞl_¡¬t
(&
p
->
hªdË
,…->
ev’ts
, 
»disLibuvPŞl
);

71 
	`uv_pŞl_¡İ
(&
p
->
hªdË
);

73 
	}
}

76 
	$Ú_şo£
(
uv_hªdË_t
* 
hªdË
) {

77 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
hªdË
->
d©a
;

79 
	`ä“
(
p
);

80 
	}
}

83 
	$»disLibuvCËªup
(*
´ivd©a
) {

84 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
´ivd©a
;

86 
p
->
cÚ‹xt
 = 
NULL
;

87 
	`uv_şo£
((
uv_hªdË_t
*)&
p
->
hªdË
, 
Ú_şo£
);

88 
	}
}

91 
	$»disLibuvA‰ach
(
»disAsyncCÚ‹xt
* 
ac
, 
uv_loİ_t
* 
loİ
) {

92 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

94 ià(
ac
->
ev
.
d©a
 !ğ
NULL
) {

95  
REDIS_ERR
;

98 
ac
->
ev
.
addR—d
 = 
»disLibuvAddR—d
;

99 
ac
->
ev
.
d–R—d
 = 
»disLibuvD–R—d
;

100 
ac
->
ev
.
addWr™e
 = 
»disLibuvAddWr™e
;

101 
ac
->
ev
.
d–Wr™e
 = 
»disLibuvD–Wr™e
;

102 
ac
->
ev
.
ş—nup
 = 
»disLibuvCËªup
;

104 
»disLibuvEv’ts
* 
p
 = (»disLibuvEv’ts*)
	`m®loc
((*p));

106 ià(!
p
) {

107  
REDIS_ERR
;

110 
	`mem£t
(
p
, 0, (*p));

112 ià(
	`uv_pŞl_š™
(
loİ
, &
p
->
hªdË
, 
c
->
fd
) != 0) {

113  
REDIS_ERR
;

116 
ac
->
ev
.
d©a
 = 
p
;

117 
p
->
hªdË
.
d©a
 =…;

118 
p
->
cÚ‹xt
 = 
ac
;

120  
REDIS_OK
;

121 
	}
}

	@deps/hiredis/adapters/macosx.h

6 #iâdeà
__HIREDIS_MACOSX_H__


7 
	#__HIREDIS_MACOSX_H__


	)

9 
	~<CÜeFound©iÚ/CÜeFound©iÚ.h
>

11 
	~"../hœedis.h
"

12 
	~"../async.h
"

15 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

16 
CFSock‘Ref
 
	msock‘Ref
;

17 
CFRunLoİSourûRef
 
	msourûRef
;

18 } 
	tRedisRunLoİ
;

20 
	$ä“RedisRunLoİ
(
RedisRunLoİ
* 
»disRunLoİ
) {

21 ifĞ
»disRunLoİ
 !ğ
NULL
 ) {

22 ifĞ
»disRunLoİ
->
sourûRef
 !ğ
NULL
 ) {

23 
	`CFRunLoİSourûInv®id©e
(
»disRunLoİ
->
sourûRef
);

24 
	`CFR–—£
(
»disRunLoİ
->
sourûRef
);

26 ifĞ
»disRunLoİ
->
sock‘Ref
 !ğ
NULL
 ) {

27 
	`CFSock‘Inv®id©e
(
»disRunLoİ
->
sock‘Ref
);

28 
	`CFR–—£
(
»disRunLoİ
->
sock‘Ref
);

30 
	`ä“
(
»disRunLoİ
);

32  
REDIS_ERR
;

33 
	}
}

35 
	$»disMacOSAddR—d
(*
´ivd©a
) {

36 
RedisRunLoİ
 *
»disRunLoİ
 = (RedisRunLoİ*)
´ivd©a
;

37 
	`CFSock‘EÇbËC®lBacks
(
»disRunLoİ
->
sock‘Ref
, 
kCFSock‘R—dC®lBack
);

38 
	}
}

40 
	$»disMacOSD–R—d
(*
´ivd©a
) {

41 
RedisRunLoİ
 *
»disRunLoİ
 = (RedisRunLoİ*)
´ivd©a
;

42 
	`CFSock‘Di§bËC®lBacks
(
»disRunLoİ
->
sock‘Ref
, 
kCFSock‘R—dC®lBack
);

43 
	}
}

45 
	$»disMacOSAddWr™e
(*
´ivd©a
) {

46 
RedisRunLoİ
 *
»disRunLoİ
 = (RedisRunLoİ*)
´ivd©a
;

47 
	`CFSock‘EÇbËC®lBacks
(
»disRunLoİ
->
sock‘Ref
, 
kCFSock‘Wr™eC®lBack
);

48 
	}
}

50 
	$»disMacOSD–Wr™e
(*
´ivd©a
) {

51 
RedisRunLoİ
 *
»disRunLoİ
 = (RedisRunLoİ*)
´ivd©a
;

52 
	`CFSock‘Di§bËC®lBacks
(
»disRunLoİ
->
sock‘Ref
, 
kCFSock‘Wr™eC®lBack
);

53 
	}
}

55 
	$»disMacOSCËªup
(*
´ivd©a
) {

56 
RedisRunLoİ
 *
»disRunLoİ
 = (RedisRunLoİ*)
´ivd©a
;

57 
	`ä“RedisRunLoİ
(
»disRunLoİ
);

58 
	}
}

60 
	$»disMacOSAsyncC®lback
(
CFSock‘Ref
 
__unu£d
 
s
, 
CFSock‘C®lBackTy³
 
ÿÎbackTy³
, 
CFD©aRef
 __unu£d 
add»ss
, cÚ¡ __unu£d *
d©a
, *
šfo
) {

61 
»disAsyncCÚ‹xt
* 
cÚ‹xt
 = (»disAsyncCÚ‹xt*è
šfo
;

63 
ÿÎbackTy³
) {

64 
kCFSock‘R—dC®lBack
:

65 
	`»disAsyncHªdËR—d
(
cÚ‹xt
);

68 
kCFSock‘Wr™eC®lBack
:

69 
	`»disAsyncHªdËWr™e
(
cÚ‹xt
);

75 
	}
}

77 
	$»disMacOSA‰ach
(
»disAsyncCÚ‹xt
 *
»disAsyncCtx
, 
CFRunLoİRef
 
runLoİ
) {

78 
»disCÚ‹xt
 *
»disCtx
 = &(
»disAsyncCtx
->
c
);

81 ifĞ
»disAsyncCtx
->
ev
.
d©a
 !ğ
NULL
 )  
REDIS_ERR
;

83 
RedisRunLoİ
* 
»disRunLoİ
 = (RedisRunLoİ*è
	`ÿÎoc
(1, (RedisRunLoop));

84 ifĞ!
»disRunLoİ
 )  
REDIS_ERR
;

87 
»disRunLoİ
->
cÚ‹xt
 = 
»disAsyncCtx
;

89 
»disAsyncCtx
->
ev
.
addR—d
 = 
»disMacOSAddR—d
;

90 
»disAsyncCtx
->
ev
.
d–R—d
 = 
»disMacOSD–R—d
;

91 
»disAsyncCtx
->
ev
.
addWr™e
 = 
»disMacOSAddWr™e
;

92 
»disAsyncCtx
->
ev
.
d–Wr™e
 = 
»disMacOSD–Wr™e
;

93 
»disAsyncCtx
->
ev
.
ş—nup
 = 
»disMacOSCËªup
;

94 
»disAsyncCtx
->
ev
.
d©a
 = 
»disRunLoİ
;

97 
CFSock‘CÚ‹xt
 
sock‘Ctx
 = { 0, 
»disAsyncCtx
, 
NULL
, NULL, NULL };

99 
»disRunLoİ
->
sock‘Ref
 = 
	`CFSock‘C»©eW™hN©ive
(
NULL
, 
»disCtx
->
fd
,

100 
kCFSock‘R—dC®lBack
 | 
kCFSock‘Wr™eC®lBack
,

101 
»disMacOSAsyncC®lback
,

102 &
sock‘Ctx
);

103 ifĞ!
»disRunLoİ
->
sock‘Ref
 )  
	`ä“RedisRunLoİ
(redisRunLoop);

105 
»disRunLoİ
->
sourûRef
 = 
	`CFSock‘C»©eRunLoİSourû
(
NULL
,„edisRunLoİ->
sock‘Ref
, 0);

106 ifĞ!
»disRunLoİ
->
sourûRef
 )  
	`ä“RedisRunLoİ
(redisRunLoop);

108 
	`CFRunLoİAddSourû
(
runLoİ
, 
»disRunLoİ
->
sourûRef
, 
kCFRunLoİDeçuÉMode
);

110  
REDIS_OK
;

111 
	}
}

	@deps/hiredis/adapters/qt.h

26 #iâdeà
__HIREDIS_QT_H__


27 
	#__HIREDIS_QT_H__


	)

28 
	~<QSock‘NÙif›r
>

29 
	~"../async.h
"

31 
RedisQtAddR—d
(*);

32 
RedisQtD–R—d
(*);

33 
RedisQtAddWr™e
(*);

34 
RedisQtD–Wr™e
(*);

35 
RedisQtCËªup
(*);

37 şas 
	cRedisQtAd­‹r
 : 
public
 
QObjeù
 {

39 
Q_OBJECT


41 
ä›nd


42 
	$RedisQtAddR—d
(* 
ad­‹r
) {

43 
RedisQtAd­‹r
 * 
a
 = 
¡©ic_ÿ¡
<RedisQtAd­‹¸*>(
ad­‹r
);

44 
a
->
	`addR—d
();

47 
ä›nd


48 
	$RedisQtD–R—d
(* 
ad­‹r
) {

49 
RedisQtAd­‹r
 * 
a
 = 
¡©ic_ÿ¡
<RedisQtAd­‹¸*>(
ad­‹r
);

50 
a
->
	`d–R—d
();

51 
	}
}

53 
ä›nd


54 
	$RedisQtAddWr™e
(* 
ad­‹r
) {

55 
RedisQtAd­‹r
 * 
a
 = 
¡©ic_ÿ¡
<RedisQtAd­‹¸*>(
ad­‹r
);

56 
a
->
	`addWr™e
();

57 
	}
}

59 
ä›nd


60 
	$RedisQtD–Wr™e
(* 
ad­‹r
) {

61 
RedisQtAd­‹r
 * 
a
 = 
¡©ic_ÿ¡
<RedisQtAd­‹¸*>(
ad­‹r
);

62 
a
->
	`d–Wr™e
();

63 
	}
}

65 
ä›nd


66 
	$RedisQtCËªup
(* 
ad­‹r
) {

67 
RedisQtAd­‹r
 * 
a
 = 
¡©ic_ÿ¡
<RedisQtAd­‹¸*>(
ad­‹r
);

68 
a
->
	`ş—nup
();

69 
	}
}

71 
	gpublic
:

72 
	$RedisQtAd­‹r
(
QObjeù
 * 
·»Á
 = 0)

73 : 
	`QObjeù
(
·»Á
), 
	`m_ùx
(0), 
	`m_»ad
(0), 
	$m_wr™e
(0è{ 
	}
}

75 ~
	$RedisQtAd­‹r
() {

76 ià(
m_ùx
 != 0) {

77 
m_ùx
->
ev
.
d©a
 = 
NULL
;

79 
	}
}

81 
	$£tCÚ‹xt
(
»disAsyncCÚ‹xt
 * 
ac
) {

82 ià(
ac
->
ev
.
d©a
 !ğ
NULL
) {

83  
REDIS_ERR
;

85 
m_ùx
 = 
ac
;

86 
m_ùx
->
ev
.
d©a
 = 
this
;

87 
m_ùx
->
ev
.
addR—d
 = 
RedisQtAddR—d
;

88 
m_ùx
->
ev
.
d–R—d
 = 
RedisQtD–R—d
;

89 
m_ùx
->
ev
.
addWr™e
 = 
RedisQtAddWr™e
;

90 
m_ùx
->
ev
.
d–Wr™e
 = 
RedisQtD–Wr™e
;

91 
m_ùx
->
ev
.
ş—nup
 = 
RedisQtCËªup
;

92  
REDIS_OK
;

93 
	}
}

95 
	g´iv©e
:

96 
	$addR—d
() {

97 ià(
m_»ad
) ;

98 
m_»ad
 = 
Ãw
 
	`QSock‘NÙif›r
(
m_ùx
->
c
.
fd
, 
QSock‘NÙif›r
::
R—d
, 0);

99 
	`cÚÃù
(
m_»ad
, 
	`SIGNAL
(
	`aùiv©ed
()), 
this
, 
	`SLOT
(
	`»ad
()));

100 
	}
}

102 
	$d–R—d
() {

103 ià(!
m_»ad
) ;

104 
d–‘e
 
m_»ad
;

105 
m_»ad
 = 0;

106 
	}
}

108 
	$addWr™e
() {

109 ià(
m_wr™e
) ;

110 
m_wr™e
 = 
Ãw
 
	`QSock‘NÙif›r
(
m_ùx
->
c
.
fd
, 
QSock‘NÙif›r
::
Wr™e
, 0);

111 
	`cÚÃù
(
m_wr™e
, 
	`SIGNAL
(
	`aùiv©ed
()), 
this
, 
	`SLOT
(
	`wr™e
()));

112 
	}
}

114 
	$d–Wr™e
() {

115 ià(!
m_wr™e
) ;

116 
d–‘e
 
m_wr™e
;

117 
m_wr™e
 = 0;

118 
	}
}

120 
	$ş—nup
() {

121 
	`d–R—d
();

122 
	`d–Wr™e
();

123 
	}
}

125 
´iv©e
 
	g¦Ùs
:

126 
	$»ad
(è{ 
	`»disAsyncHªdËR—d
(
m_ùx
); 
	}
}

127 
	$wr™e
(è{ 
	`»disAsyncHªdËWr™e
(
m_ùx
); 
	}
}

129 
	g´iv©e
:

130 
»disAsyncCÚ‹xt
 * 
m_ùx
;

131 
QSock‘NÙif›r
 * 
	gm_»ad
;

132 
QSock‘NÙif›r
 * 
	gm_wr™e
;

	@deps/hiredis/async.c

32 
	~"fmaüos.h
"

33 
	~<¡dlib.h
>

34 
	~<¡ršg.h
>

35 
	~<¡ršgs.h
>

36 
	~<as£¹.h
>

37 
	~<ùy³.h
>

38 
	~<”ºo.h
>

39 
	~"async.h
"

40 
	~"Ãt.h
"

41 
	~"diù.c
"

42 
	~"sds.h
"

44 
	#_EL_ADD_READ
(
ùx
) do { \

45 ià((
ùx
)->
ev
.
addR—d
è(ùx)->ev.
	`addR—d
((ùx)->ev.
d©a
); \

46 } 0)

	)

47 
	#_EL_DEL_READ
(
ùx
) do { \

48 ià((
ùx
)->
ev
.
d–R—d
è(ùx)->ev.
	`d–R—d
((ùx)->ev.
d©a
); \

49 } 0)

	)

50 
	#_EL_ADD_WRITE
(
ùx
) do { \

51 ià((
ùx
)->
ev
.
addWr™e
è(ùx)->ev.
	`addWr™e
((ùx)->ev.
d©a
); \

52 } 0)

	)

53 
	#_EL_DEL_WRITE
(
ùx
) do { \

54 ià((
ùx
)->
ev
.
d–Wr™e
è(ùx)->ev.
	`d–Wr™e
((ùx)->ev.
d©a
); \

55 } 0)

	)

56 
	#_EL_CLEANUP
(
ùx
) do { \

57 ià((
ùx
)->
ev
.
ş—nup
è(ùx)->ev.
	`ş—nup
((ùx)->ev.
d©a
); \

58 } 0);

	)

61 
__»disAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
cmd
, 
size_t
 
Ën
);

64 
	$ÿÎbackHash
(cÚ¡ *
key
) {

65  
	`diùG’HashFunùiÚ
((cÚ¡ *)
key
,

66 
	`sd¦’
((cÚ¡ 
sds
)
key
));

67 
	}
}

69 *
	$ÿÎbackV®Dup
(*
´ivd©a
, cÚ¡ *
¤c
) {

70 ((è
´ivd©a
);

71 
»disC®lback
 *
dup
 = 
	`m®loc
((*dup));

72 
	`memıy
(
dup
,
¤c
,(*dup));

73  
dup
;

74 
	}
}

76 
	$ÿÎbackKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

77 
l1
, 
l2
;

78 ((è
´ivd©a
);

80 
l1
 = 
	`sd¦’
((cÚ¡ 
sds
)
key1
);

81 
l2
 = 
	`sd¦’
((cÚ¡ 
sds
)
key2
);

82 ià(
l1
 !ğ
l2
)  0;

83  
	`memcmp
(
key1
,
key2
,
l1
) == 0;

84 
	}
}

86 
	$ÿÎbackKeyDe¡ruùÜ
(*
´ivd©a
, *
key
) {

87 ((è
´ivd©a
);

88 
	`sdsä“
((
sds
)
key
);

89 
	}
}

91 
	$ÿÎbackV®De¡ruùÜ
(*
´ivd©a
, *
v®
) {

92 ((è
´ivd©a
);

93 
	`ä“
(
v®
);

94 
	}
}

96 
diùTy³
 
	gÿÎbackDiù
 = {

97 
ÿÎbackHash
,

98 
NULL
,

99 
ÿÎbackV®Dup
,

100 
ÿÎbackKeyCom·»
,

101 
ÿÎbackKeyDe¡ruùÜ
,

102 
ÿÎbackV®De¡ruùÜ


105 
»disAsyncCÚ‹xt
 *
	$»disAsyncIn™Ÿlize
(
»disCÚ‹xt
 *
c
) {

106 
»disAsyncCÚ‹xt
 *
ac
;

108 
ac
 = 
	`»®loc
(
c
,(
»disAsyncCÚ‹xt
));

109 ià(
ac
 =ğ
NULL
)

110  
NULL
;

112 
c
 = &(
ac
->c);

117 
c
->
æags
 &ğ~
REDIS_CONNECTED
;

119 
ac
->
”r
 = 0;

120 
ac
->
”r¡r
 = 
NULL
;

121 
ac
->
d©a
 = 
NULL
;

123 
ac
->
ev
.
d©a
 = 
NULL
;

124 
ac
->
ev
.
addR—d
 = 
NULL
;

125 
ac
->
ev
.
d–R—d
 = 
NULL
;

126 
ac
->
ev
.
addWr™e
 = 
NULL
;

127 
ac
->
ev
.
d–Wr™e
 = 
NULL
;

128 
ac
->
ev
.
ş—nup
 = 
NULL
;

130 
ac
->
ÚCÚÃù
 = 
NULL
;

131 
ac
->
ÚDiscÚÃù
 = 
NULL
;

133 
ac
->
»¶›s
.
h—d
 = 
NULL
;

134 
ac
->
»¶›s
.

 = 
NULL
;

135 
ac
->
sub
.
šv®id
.
h—d
 = 
NULL
;

136 
ac
->
sub
.
šv®id
.

 = 
NULL
;

137 
ac
->
sub
.
chªÃls
 = 
	`diùC»©e
(&
ÿÎbackDiù
,
NULL
);

138 
ac
->
sub
.
·‰”ns
 = 
	`diùC»©e
(&
ÿÎbackDiù
,
NULL
);

139  
ac
;

140 
	}
}

144 
	$__»disAsyncCİyE¼Ü
(
»disAsyncCÚ‹xt
 *
ac
) {

145 ià(!
ac
)

148 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

149 
ac
->
”r
 = 
c
->err;

150 
ac
->
”r¡r
 = 
c
->errstr;

151 
	}
}

153 
»disAsyncCÚ‹xt
 *
	$»disAsyncCÚÃù
(cÚ¡ *

, 
pÜt
) {

154 
»disCÚ‹xt
 *
c
;

155 
»disAsyncCÚ‹xt
 *
ac
;

157 
c
 = 
	`»disCÚÃùNÚBlock
(

,
pÜt
);

158 ià(
c
 =ğ
NULL
)

159  
NULL
;

161 
ac
 = 
	`»disAsyncIn™Ÿlize
(
c
);

162 ià(
ac
 =ğ
NULL
) {

163 
	`»disF»e
(
c
);

164  
NULL
;

167 
	`__»disAsyncCİyE¼Ü
(
ac
);

168  
ac
;

169 
	}
}

171 
»disAsyncCÚ‹xt
 *
	$»disAsyncCÚÃùBšd
(cÚ¡ *

, 
pÜt
,

172 cÚ¡ *
sourû_addr
) {

173 
»disCÚ‹xt
 *
c
 = 
	`»disCÚÃùBšdNÚBlock
(

,
pÜt
,
sourû_addr
);

174 
»disAsyncCÚ‹xt
 *
ac
 = 
	`»disAsyncIn™Ÿlize
(
c
);

175 
	`__»disAsyncCİyE¼Ü
(
ac
);

176  
ac
;

177 
	}
}

179 
»disAsyncCÚ‹xt
 *
	$»disAsyncCÚÃùBšdW™hReu£
(cÚ¡ *

, 
pÜt
,

180 cÚ¡ *
sourû_addr
) {

181 
»disCÚ‹xt
 *
c
 = 
	`»disCÚÃùBšdNÚBlockW™hReu£
(

,
pÜt
,
sourû_addr
);

182 
»disAsyncCÚ‹xt
 *
ac
 = 
	`»disAsyncIn™Ÿlize
(
c
);

183 
	`__»disAsyncCİyE¼Ü
(
ac
);

184  
ac
;

185 
	}
}

187 
»disAsyncCÚ‹xt
 *
	$»disAsyncCÚÃùUnix
(cÚ¡ *
·th
) {

188 
»disCÚ‹xt
 *
c
;

189 
»disAsyncCÚ‹xt
 *
ac
;

191 
c
 = 
	`»disCÚÃùUnixNÚBlock
(
·th
);

192 ià(
c
 =ğ
NULL
)

193  
NULL
;

195 
ac
 = 
	`»disAsyncIn™Ÿlize
(
c
);

196 ià(
ac
 =ğ
NULL
) {

197 
	`»disF»e
(
c
);

198  
NULL
;

201 
	`__»disAsyncCİyE¼Ü
(
ac
);

202  
ac
;

203 
	}
}

205 
	$»disAsyncS‘CÚÃùC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disCÚÃùC®lback
 *
â
) {

206 ià(
ac
->
ÚCÚÃù
 =ğ
NULL
) {

207 
ac
->
ÚCÚÃù
 = 
â
;

212 
	`_EL_ADD_WRITE
(
ac
);

213  
REDIS_OK
;

215  
REDIS_ERR
;

216 
	}
}

218 
	$»disAsyncS‘DiscÚÃùC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disDiscÚÃùC®lback
 *
â
) {

219 ià(
ac
->
ÚDiscÚÃù
 =ğ
NULL
) {

220 
ac
->
ÚDiscÚÃù
 = 
â
;

221  
REDIS_OK
;

223  
REDIS_ERR
;

224 
	}
}

227 
	$__»disPushC®lback
(
»disC®lbackLi¡
 *
li¡
, 
»disC®lback
 *
sourû
) {

228 
»disC®lback
 *
cb
;

231 
cb
 = 
	`m®loc
((*cb));

232 ià(
cb
 =ğ
NULL
)

233  
REDIS_ERR_OOM
;

235 ià(
sourû
 !ğ
NULL
) {

236 
	`memıy
(
cb
,
sourû
,(*cb));

237 
cb
->
Ãxt
 = 
NULL
;

241 ià(
li¡
->
h—d
 =ğ
NULL
)

242 
li¡
->
h—d
 = 
cb
;

243 ià(
li¡
->

 !ğ
NULL
)

244 
li¡
->

->
Ãxt
 = 
cb
;

245 
li¡
->

 = 
cb
;

246  
REDIS_OK
;

247 
	}
}

249 
	$__»disShiáC®lback
(
»disC®lbackLi¡
 *
li¡
, 
»disC®lback
 *
rg‘
) {

250 
»disC®lback
 *
cb
 = 
li¡
->
h—d
;

251 ià(
cb
 !ğ
NULL
) {

252 
li¡
->
h—d
 = 
cb
->
Ãxt
;

253 ià(
cb
 =ğ
li¡
->

)

254 
li¡
->

 = 
NULL
;

257 ià(
rg‘
 !ğ
NULL
)

258 
	`memıy
(
rg‘
,
cb
,(*cb));

259 
	`ä“
(
cb
);

260  
REDIS_OK
;

262  
REDIS_ERR
;

263 
	}
}

265 
	$__»disRunC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lback
 *
cb
, 
»disR•ly
 *
»¶y
) {

266 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

267 ià(
cb
->
â
 !ğ
NULL
) {

268 
c
->
æags
 |ğ
REDIS_IN_CALLBACK
;

269 
cb
->
	`â
(
ac
,
»¶y
,cb->
´ivd©a
);

270 
c
->
æags
 &ğ~
REDIS_IN_CALLBACK
;

272 
	}
}

275 
	$__»disAsyncF»e
(
»disAsyncCÚ‹xt
 *
ac
) {

276 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

277 
»disC®lback
 
cb
;

278 
diùI‹¿tÜ
 *
™
;

279 
diùEÁry
 *
de
;

282 
	`__»disShiáC®lback
(&
ac
->
»¶›s
,&
cb
è=ğ
REDIS_OK
)

283 
	`__»disRunC®lback
(
ac
,&
cb
,
NULL
);

286 
	`__»disShiáC®lback
(&
ac
->
sub
.
šv®id
,&
cb
è=ğ
REDIS_OK
)

287 
	`__»disRunC®lback
(
ac
,&
cb
,
NULL
);

290 
™
 = 
	`diùG‘I‹¿tÜ
(
ac
->
sub
.
chªÃls
);

291 (
de
 = 
	`diùNext
(
™
)è!ğ
NULL
)

292 
	`__»disRunC®lback
(
ac
,
	`diùG‘EÁryV®
(
de
),
NULL
);

293 
	`diùR–—£I‹¿tÜ
(
™
);

294 
	`diùR–—£
(
ac
->
sub
.
chªÃls
);

296 
™
 = 
	`diùG‘I‹¿tÜ
(
ac
->
sub
.
·‰”ns
);

297 (
de
 = 
	`diùNext
(
™
)è!ğ
NULL
)

298 
	`__»disRunC®lback
(
ac
,
	`diùG‘EÁryV®
(
de
),
NULL
);

299 
	`diùR–—£I‹¿tÜ
(
™
);

300 
	`diùR–—£
(
ac
->
sub
.
·‰”ns
);

303 
	`_EL_CLEANUP
(
ac
);

307 ià(
ac
->
ÚDiscÚÃù
 && (
c
->
æags
 & 
REDIS_CONNECTED
)) {

308 ià(
c
->
æags
 & 
REDIS_FREEING
) {

309 
ac
->
	`ÚDiscÚÃù
×c,
REDIS_OK
);

311 
ac
->
	`ÚDiscÚÃù
×c,×c->
”r
 =ğ0è? 
REDIS_OK
 : 
REDIS_ERR
);

316 
	`»disF»e
(
c
);

317 
	}
}

323 
	$»disAsyncF»e
(
»disAsyncCÚ‹xt
 *
ac
) {

324 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

325 
c
->
æags
 |ğ
REDIS_FREEING
;

326 ià(!(
c
->
æags
 & 
REDIS_IN_CALLBACK
))

327 
	`__»disAsyncF»e
(
ac
);

328 
	}
}

331 
	$__»disAsyncDiscÚÃù
(
»disAsyncCÚ‹xt
 *
ac
) {

332 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

335 
	`__»disAsyncCİyE¼Ü
(
ac
);

337 ià(
ac
->
”r
 == 0) {

339 
	`as£¹
(
	`__»disShiáC®lback
(&
ac
->
»¶›s
,
NULL
è=ğ
REDIS_ERR
);

343 
c
->
æags
 |ğ
REDIS_DISCONNECTING
;

348 
	`__»disAsyncF»e
(
ac
);

349 
	}
}

357 
	$»disAsyncDiscÚÃù
(
»disAsyncCÚ‹xt
 *
ac
) {

358 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

359 
c
->
æags
 |ğ
REDIS_DISCONNECTING
;

360 ià(!(
c
->
æags
 & 
REDIS_IN_CALLBACK
è&& 
ac
->
»¶›s
.
h—d
 =ğ
NULL
)

361 
	`__»disAsyncDiscÚÃù
(
ac
);

362 
	}
}

364 
	$__»disG‘SubsüibeC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disR•ly
 *
»¶y
, 
»disC®lback
 *
d¡cb
) {

365 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

366 
diù
 *
ÿÎbacks
;

367 
diùEÁry
 *
de
;

368 
pv¬ŸÁ
;

369 *
¡y³
;

370 
sds
 
¢ame
;

374 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ARRAY
) {

375 
	`as£¹
(
»¶y
->
–em’ts
 >= 2);

376 
	`as£¹
(
»¶y
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_STRING
);

377 
¡y³
 = 
»¶y
->
–em’t
[0]->
¡r
;

378 
pv¬ŸÁ
 = (
	`tŞow”
(
¡y³
[0]) == 'p') ? 1 : 0;

380 ià(
pv¬ŸÁ
)

381 
ÿÎbacks
 = 
ac
->
sub
.
·‰”ns
;

383 
ÿÎbacks
 = 
ac
->
sub
.
chªÃls
;

386 
	`as£¹
(
»¶y
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_STRING
);

387 
¢ame
 = 
	`sd¢ewËn
(
»¶y
->
–em’t
[1]->
¡r
,»¶y->–em’t[1]->
Ën
);

388 
de
 = 
	`diùFšd
(
ÿÎbacks
,
¢ame
);

389 ià(
de
 !ğ
NULL
) {

390 
	`memıy
(
d¡cb
,
	`diùG‘EÁryV®
(
de
),(*dstcb));

393 ià(
	`¡rÿ£cmp
(
¡y³
+
pv¬ŸÁ
,"unsubscribe") == 0) {

394 
	`diùD–‘e
(
ÿÎbacks
,
¢ame
);

398 
	`as£¹
(
»¶y
->
–em’t
[2]->
ty³
 =ğ
REDIS_REPLY_INTEGER
);

399 ià(
»¶y
->
–em’t
[2]->
š‹g”
 == 0)

400 
c
->
æags
 &ğ~
REDIS_SUBSCRIBED
;

403 
	`sdsä“
(
¢ame
);

406 
	`__»disShiáC®lback
(&
ac
->
sub
.
šv®id
,
d¡cb
);

408  
REDIS_OK
;

409 
	}
}

411 
	$»disProûssC®lbacks
(
»disAsyncCÚ‹xt
 *
ac
) {

412 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

413 
»disC®lback
 
cb
 = {
NULL
, NULL, NULL};

414 *
»¶y
 = 
NULL
;

415 
¡©us
;

417 (
¡©us
 = 
	`»disG‘R•ly
(
c
,&
»¶y
)è=ğ
REDIS_OK
) {

418 ià(
»¶y
 =ğ
NULL
) {

421 ià(
c
->
æags
 & 
REDIS_DISCONNECTING
 && 
	`sd¦’
(c->
obuf
) == 0

422 && 
ac
->
»¶›s
.
h—d
 =ğ
NULL
) {

423 
	`__»disAsyncDiscÚÃù
(
ac
);

428 if(
c
->
æags
 & 
REDIS_MONITORING
) {

429 
	`__»disPushC®lback
(&
ac
->
»¶›s
,&
cb
);

439 ià(
	`__»disShiáC®lback
(&
ac
->
»¶›s
,&
cb
è!ğ
REDIS_OK
) {

455 ià(((
»disR•ly
*)
»¶y
)->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

456 
c
->
”r
 = 
REDIS_ERR_OTHER
;

457 
	`¢´štf
(
c
->
”r¡r
,(c->”r¡r),"%s",((
»disR•ly
*)
»¶y
)->
¡r
);

458 
c
->
»ad”
->
â
->
	`ä“Objeù
(
»¶y
);

459 
	`__»disAsyncDiscÚÃù
(
ac
);

463 
	`as£¹
((
c
->
æags
 & 
REDIS_SUBSCRIBED
 || c->æag & 
REDIS_MONITORING
));

464 if(
c
->
æags
 & 
REDIS_SUBSCRIBED
)

465 
	`__»disG‘SubsüibeC®lback
(
ac
,
»¶y
,&
cb
);

468 ià(
cb
.
â
 !ğ
NULL
) {

469 
	`__»disRunC®lback
(
ac
,&
cb
,
»¶y
);

470 
c
->
»ad”
->
â
->
	`ä“Objeù
(
»¶y
);

473 ià(
c
->
æags
 & 
REDIS_FREEING
) {

474 
	`__»disAsyncF»e
(
ac
);

482 
c
->
»ad”
->
â
->
	`ä“Objeù
(
»¶y
);

487 ià(
¡©us
 !ğ
REDIS_OK
)

488 
	`__»disAsyncDiscÚÃù
(
ac
);

489 
	}
}

494 
	$__»disAsyncHªdËCÚÃù
(
»disAsyncCÚ‹xt
 *
ac
) {

495 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

497 ià(
	`»disCheckSock‘E¼Ü
(
c
è=ğ
REDIS_ERR
) {

499 ià(
”ºo
 =ğ
EINPROGRESS
)

500  
REDIS_OK
;

502 ià(
ac
->
ÚCÚÃù
èac->
	`ÚCÚÃù
×c,
REDIS_ERR
);

503 
	`__»disAsyncDiscÚÃù
(
ac
);

504  
REDIS_ERR
;

508 
c
->
æags
 |ğ
REDIS_CONNECTED
;

509 ià(
ac
->
ÚCÚÃù
èac->
	`ÚCÚÃù
×c,
REDIS_OK
);

510  
REDIS_OK
;

511 
	}
}

516 
	$»disAsyncHªdËR—d
(
»disAsyncCÚ‹xt
 *
ac
) {

517 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

519 ià(!(
c
->
æags
 & 
REDIS_CONNECTED
)) {

521 ià(
	`__»disAsyncHªdËCÚÃù
(
ac
è!ğ
REDIS_OK
)

524 ià(!(
c
->
æags
 & 
REDIS_CONNECTED
))

528 ià(
	`»disBufãrR—d
(
c
è=ğ
REDIS_ERR
) {

529 
	`__»disAsyncDiscÚÃù
(
ac
);

532 
	`_EL_ADD_READ
(
ac
);

533 
	`»disProûssC®lbacks
(
ac
);

535 
	}
}

537 
	$»disAsyncHªdËWr™e
(
»disAsyncCÚ‹xt
 *
ac
) {

538 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

539 
dÚe
 = 0;

541 ià(!(
c
->
æags
 & 
REDIS_CONNECTED
)) {

543 ià(
	`__»disAsyncHªdËCÚÃù
(
ac
è!ğ
REDIS_OK
)

546 ià(!(
c
->
æags
 & 
REDIS_CONNECTED
))

550 ià(
	`»disBufãrWr™e
(
c
,&
dÚe
è=ğ
REDIS_ERR
) {

551 
	`__»disAsyncDiscÚÃù
(
ac
);

554 ià(!
dÚe
)

555 
	`_EL_ADD_WRITE
(
ac
);

557 
	`_EL_DEL_WRITE
(
ac
);

560 
	`_EL_ADD_READ
(
ac
);

562 
	}
}

566 cÚ¡ *
	$ÃxtArgum’t
(cÚ¡ *
¡¬t
, cÚ¡ **
¡r
, 
size_t
 *
Ën
) {

567 cÚ¡ *
p
 = 
¡¬t
;

568 ià(
p
[0] != '$') {

569 
p
 = 
	`¡rchr
(p,'$');

570 ià(
p
 =ğ
NULL
)  NULL;

573 *
Ën
 = ()
	`¡¹Ş
(
p
+1,
NULL
,10);

574 
p
 = 
	`¡rchr
(p,'\r');

575 
	`as£¹
(
p
);

576 *
¡r
 = 
p
+2;

577  
p
+2+(*
Ën
)+2;

578 
	}
}

583 
	$__»disAsyncCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
cmd
, 
size_t
 
Ën
) {

584 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

585 
»disC®lback
 
cb
;

586 
pv¬ŸÁ
, 
ha¢ext
;

587 cÚ¡ *
c¡r
, *
a¡r
;

588 
size_t
 
ş’
, 
®’
;

589 cÚ¡ *
p
;

590 
sds
 
¢ame
;

591 
»t
;

594 ià(
c
->
æags
 & (
REDIS_DISCONNECTING
 | 
REDIS_FREEING
)è 
REDIS_ERR
;

597 
cb
.
â
 = fn;

598 
cb
.
´ivd©a
 =…rivdata;

601 
p
 = 
	`ÃxtArgum’t
(
cmd
,&
c¡r
,&
ş’
);

602 
	`as£¹
(
p
 !ğ
NULL
);

603 
ha¢ext
 = (
p
[0] == '$');

604 
pv¬ŸÁ
 = (
	`tŞow”
(
c¡r
[0]) == 'p') ? 1 : 0;

605 
c¡r
 +ğ
pv¬ŸÁ
;

606 
ş’
 -ğ
pv¬ŸÁ
;

608 ià(
ha¢ext
 && 
	`¡ºÿ£cmp
(
c¡r
,"subscribe\r\n",11) == 0) {

609 
c
->
æags
 |ğ
REDIS_SUBSCRIBED
;

612 (
p
 = 
	`ÃxtArgum’t
Õ,&
a¡r
,&
®’
)è!ğ
NULL
) {

613 
¢ame
 = 
	`sd¢ewËn
(
a¡r
,
®’
);

614 ià(
pv¬ŸÁ
)

615 
»t
 = 
	`diùR•Ïû
(
ac
->
sub
.
·‰”ns
,
¢ame
,&
cb
);

617 
»t
 = 
	`diùR•Ïû
(
ac
->
sub
.
chªÃls
,
¢ame
,&
cb
);

619 ià(
»t
 =ğ0è
	`sdsä“
(
¢ame
);

621 } ià(
	`¡ºÿ£cmp
(
c¡r
,"unsubscribe\r\n",13) == 0) {

624 ià(!(
c
->
æags
 & 
REDIS_SUBSCRIBED
)è 
REDIS_ERR
;

629 } if(
	`¡ºÿ£cmp
(
c¡r
,"monitor\r\n",9) == 0) {

631 
c
->
æags
 |ğ
REDIS_MONITORING
;

632 
	`__»disPushC®lback
(&
ac
->
»¶›s
,&
cb
);

634 ià(
c
->
æags
 & 
REDIS_SUBSCRIBED
)

637 
	`__»disPushC®lback
(&
ac
->
sub
.
šv®id
,&
cb
);

639 
	`__»disPushC®lback
(&
ac
->
»¶›s
,&
cb
);

642 
	`__»disAµ’dCommªd
(
c
,
cmd
,
Ën
);

645 
	`_EL_ADD_WRITE
(
ac
);

647  
REDIS_OK
;

648 
	}
}

650 
	$»disvAsyncCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
) {

651 *
cmd
;

652 
Ën
;

653 
¡©us
;

654 
Ën
 = 
	`»disvFÜm©Commªd
(&
cmd
,
fÜm©
,
­
);

657 ià(
Ën
 < 0)

658  
REDIS_ERR
;

660 
¡©us
 = 
	`__»disAsyncCommªd
(
ac
,
â
,
´ivd©a
,
cmd
,
Ën
);

661 
	`ä“
(
cmd
);

662  
¡©us
;

663 
	}
}

665 
	$»disAsyncCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
fÜm©
, ...) {

666 
va_li¡
 
­
;

667 
¡©us
;

668 
	`va_¡¬t
(
­
,
fÜm©
);

669 
¡©us
 = 
	`»disvAsyncCommªd
(
ac
,
â
,
´ivd©a
,
fÜm©
,
­
);

670 
	`va_’d
(
­
);

671  
¡©us
;

672 
	}
}

674 
	$»disAsyncCommªdArgv
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
) {

675 
sds
 
cmd
;

676 
Ën
;

677 
¡©us
;

678 
Ën
 = 
	`»disFÜm©SdsCommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
¬gvËn
);

679 
¡©us
 = 
	`__»disAsyncCommªd
(
ac
,
â
,
´ivd©a
,
cmd
,
Ën
);

680 
	`sdsä“
(
cmd
);

681  
¡©us
;

682 
	}
}

684 
	$»disAsyncFÜm©‹dCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
cmd
, 
size_t
 
Ën
) {

685 
¡©us
 = 
	`__»disAsyncCommªd
(
ac
,
â
,
´ivd©a
,
cmd
,
Ën
);

686  
¡©us
;

687 
	}
}

	@deps/hiredis/async.h

32 #iâdeà
__HIREDIS_ASYNC_H


33 
	#__HIREDIS_ASYNC_H


	)

34 
	~"hœedis.h
"

36 #ifdeà
__ılu¥lus


40 
»disAsyncCÚ‹xt
;

41 
diù
;

44 (
»disC®lbackFn
)(
	t»disAsyncCÚ‹xt
*, *, *);

45 
	s»disC®lback
 {

46 
»disC®lback
 *
Ãxt
;

47 
»disC®lbackFn
 *
â
;

48 *
´ivd©a
;

49 } 
	t»disC®lback
;

52 
	s»disC®lbackLi¡
 {

53 
»disC®lback
 *
h—d
, *

;

54 } 
	t»disC®lbackLi¡
;

57 (
»disDiscÚÃùC®lback
)(cÚ¡ 
	t»disAsyncCÚ‹xt
*, 
	t¡©us
);

58 (
»disCÚÃùC®lback
)(cÚ¡ 
	t»disAsyncCÚ‹xt
*, 
	t¡©us
);

61 
	s»disAsyncCÚ‹xt
 {

63 
»disCÚ‹xt
 
c
;

66 
”r
;

67 *
”r¡r
;

70 *
d©a
;

74 *
d©a
;

78 (*
addR—d
)(*
´ivd©a
);

79 (*
d–R—d
)(*
´ivd©a
);

80 (*
addWr™e
)(*
´ivd©a
);

81 (*
d–Wr™e
)(*
´ivd©a
);

82 (*
ş—nup
)(*
´ivd©a
);

83 } 
ev
;

87 
»disDiscÚÃùC®lback
 *
ÚDiscÚÃù
;

90 
»disCÚÃùC®lback
 *
ÚCÚÃù
;

93 
»disC®lbackLi¡
 
»¶›s
;

97 
»disC®lbackLi¡
 
šv®id
;

98 
diù
 *
chªÃls
;

99 
diù
 *
·‰”ns
;

100 } 
sub
;

101 } 
	t»disAsyncCÚ‹xt
;

104 
»disAsyncCÚ‹xt
 *
»disAsyncCÚÃù
(cÚ¡ *

, 
pÜt
);

105 
»disAsyncCÚ‹xt
 *
»disAsyncCÚÃùBšd
(cÚ¡ *

, 
pÜt
, cÚ¡ *
sourû_addr
);

106 
»disAsyncCÚ‹xt
 *
»disAsyncCÚÃùBšdW™hReu£
(cÚ¡ *

, 
pÜt
,

107 cÚ¡ *
sourû_addr
);

108 
»disAsyncCÚ‹xt
 *
»disAsyncCÚÃùUnix
(cÚ¡ *
·th
);

109 
»disAsyncS‘CÚÃùC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disCÚÃùC®lback
 *
â
);

110 
»disAsyncS‘DiscÚÃùC®lback
(
»disAsyncCÚ‹xt
 *
ac
, 
»disDiscÚÃùC®lback
 *
â
);

111 
»disAsyncDiscÚÃù
(
»disAsyncCÚ‹xt
 *
ac
);

112 
»disAsyncF»e
(
»disAsyncCÚ‹xt
 *
ac
);

115 
»disAsyncHªdËR—d
(
»disAsyncCÚ‹xt
 *
ac
);

116 
»disAsyncHªdËWr™e
(
»disAsyncCÚ‹xt
 *
ac
);

120 
»disvAsyncCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

121 
»disAsyncCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
fÜm©
, ...);

122 
»disAsyncCommªdArgv
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

123 
»disAsyncFÜm©‹dCommªd
(
»disAsyncCÚ‹xt
 *
ac
, 
»disC®lbackFn
 *
â
, *
´ivd©a
, cÚ¡ *
cmd
, 
size_t
 
Ën
);

125 #ifdeà
__ılu¥lus


	@deps/hiredis/dict.c

36 
	~"fmaüos.h
"

37 
	~<¡dlib.h
>

38 
	~<as£¹.h
>

39 
	~<lim™s.h
>

40 
	~"diù.h
"

44 
_diùEx·ndIfN“ded
(
diù
 *
ht
);

45 
_diùNextPow”
(
size
);

46 
_diùKeyIndex
(
diù
 *
ht
, cÚ¡ *
key
);

47 
_diùIn™
(
diù
 *
ht
, 
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

53 
	$diùG’HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
) {

54 
hash
 = 5381;

56 
Ën
--)

57 
hash
 = ((hash << 5è+ hashè+ (*
buf
++);

58  
hash
;

59 
	}
}

65 
	$_diùRe£t
(
diù
 *
ht
) {

66 
ht
->
bË
 = 
NULL
;

67 
ht
->
size
 = 0;

68 
ht
->
sizemask
 = 0;

69 
ht
->
u£d
 = 0;

70 
	}
}

73 
diù
 *
	$diùC»©e
(
diùTy³
 *
ty³
, *
´ivD©aPŒ
) {

74 
diù
 *
ht
 = 
	`m®loc
((*ht));

75 
	`_diùIn™
(
ht
,
ty³
,
´ivD©aPŒ
);

76  
ht
;

77 
	}
}

80 
	$_diùIn™
(
diù
 *
ht
, 
diùTy³
 *
ty³
, *
´ivD©aPŒ
) {

81 
	`_diùRe£t
(
ht
);

82 
ht
->
ty³
 =ype;

83 
ht
->
´ivd©a
 = 
´ivD©aPŒ
;

84  
DICT_OK
;

85 
	}
}

88 
	$diùEx·nd
(
diù
 *
ht
, 
size
) {

89 
diù
 
n
;

90 
»®size
 = 
	`_diùNextPow”
(
size
), 
i
;

94 ià(
ht
->
u£d
 > 
size
)

95  
DICT_ERR
;

97 
	`_diùIn™
(&
n
, 
ht
->
ty³
, ht->
´ivd©a
);

98 
n
.
size
 = 
»®size
;

99 
n
.
sizemask
 = 
»®size
-1;

100 
n
.
bË
 = 
	`ÿÎoc
(
»®size
,(
diùEÁry
*));

105 
n
.
u£d
 = 
ht
->used;

106 
i
 = 0; i < 
ht
->
size
 && ht->
u£d
 > 0; i++) {

107 
diùEÁry
 *
he
, *
ÃxtHe
;

109 ià(
ht
->
bË
[
i
] =ğ
NULL
) ;

112 
he
 = 
ht
->
bË
[
i
];

113 
he
) {

114 
h
;

116 
ÃxtHe
 = 
he
->
Ãxt
;

118 
h
 = 
	`diùHashKey
(
ht
, 
he
->
key
è& 
n
.
sizemask
;

119 
he
->
Ãxt
 = 
n
.
bË
[
h
];

120 
n
.
bË
[
h
] = 
he
;

121 
ht
->
u£d
--;

123 
he
 = 
ÃxtHe
;

126 
	`as£¹
(
ht
->
u£d
 == 0);

127 
	`ä“
(
ht
->
bË
);

130 *
ht
 = 
n
;

131  
DICT_OK
;

132 
	}
}

135 
	$diùAdd
(
diù
 *
ht
, *
key
, *
v®
) {

136 
šdex
;

137 
diùEÁry
 *
’Œy
;

141 ià((
šdex
 = 
	`_diùKeyIndex
(
ht
, 
key
)) == -1)

142  
DICT_ERR
;

145 
’Œy
 = 
	`m®loc
((*entry));

146 
’Œy
->
Ãxt
 = 
ht
->
bË
[
šdex
];

147 
ht
->
bË
[
šdex
] = 
’Œy
;

150 
	`diùS‘HashKey
(
ht
, 
’Œy
, 
key
);

151 
	`diùS‘HashV®
(
ht
, 
’Œy
, 
v®
);

152 
ht
->
u£d
++;

153  
DICT_OK
;

154 
	}
}

160 
	$diùR•Ïû
(
diù
 *
ht
, *
key
, *
v®
) {

161 
diùEÁry
 *
’Œy
, 
aux’Œy
;

165 ià(
	`diùAdd
(
ht
, 
key
, 
v®
è=ğ
DICT_OK
)

168 
’Œy
 = 
	`diùFšd
(
ht
, 
key
);

175 
aux’Œy
 = *
’Œy
;

176 
	`diùS‘HashV®
(
ht
, 
’Œy
, 
v®
);

177 
	`diùF»eEÁryV®
(
ht
, &
aux’Œy
);

179 
	}
}

182 
	$diùD–‘e
(
diù
 *
ht
, cÚ¡ *
key
) {

183 
h
;

184 
diùEÁry
 *
de
, *
´evde
;

186 ià(
ht
->
size
 == 0)

187  
DICT_ERR
;

188 
h
 = 
	`diùHashKey
(
ht
, 
key
è& ht->
sizemask
;

189 
de
 = 
ht
->
bË
[
h
];

191 
´evde
 = 
NULL
;

192 
de
) {

193 ià(
	`diùCom·»HashKeys
(
ht
,
key
,
de
->key)) {

195 ià(
´evde
)

196 
´evde
->
Ãxt
 = 
de
->next;

198 
ht
->
bË
[
h
] = 
de
->
Ãxt
;

200 
	`diùF»eEÁryKey
(
ht
,
de
);

201 
	`diùF»eEÁryV®
(
ht
,
de
);

202 
	`ä“
(
de
);

203 
ht
->
u£d
--;

204  
DICT_OK
;

206 
´evde
 = 
de
;

207 
de
 = de->
Ãxt
;

209  
DICT_ERR
;

210 
	}
}

213 
	$_diùCË¬
(
diù
 *
ht
) {

214 
i
;

217 
i
 = 0; i < 
ht
->
size
 && ht->
u£d
 > 0; i++) {

218 
diùEÁry
 *
he
, *
ÃxtHe
;

220 ià((
he
 = 
ht
->
bË
[
i
]è=ğ
NULL
) ;

221 
he
) {

222 
ÃxtHe
 = 
he
->
Ãxt
;

223 
	`diùF»eEÁryKey
(
ht
, 
he
);

224 
	`diùF»eEÁryV®
(
ht
, 
he
);

225 
	`ä“
(
he
);

226 
ht
->
u£d
--;

227 
he
 = 
ÃxtHe
;

231 
	`ä“
(
ht
->
bË
);

233 
	`_diùRe£t
(
ht
);

234  
DICT_OK
;

235 
	}
}

238 
	$diùR–—£
(
diù
 *
ht
) {

239 
	`_diùCË¬
(
ht
);

240 
	`ä“
(
ht
);

241 
	}
}

243 
diùEÁry
 *
	$diùFšd
(
diù
 *
ht
, cÚ¡ *
key
) {

244 
diùEÁry
 *
he
;

245 
h
;

247 ià(
ht
->
size
 =ğ0è 
NULL
;

248 
h
 = 
	`diùHashKey
(
ht
, 
key
è& ht->
sizemask
;

249 
he
 = 
ht
->
bË
[
h
];

250 
he
) {

251 ià(
	`diùCom·»HashKeys
(
ht
, 
key
, 
he
->key))

252  
he
;

253 
he
 = he->
Ãxt
;

255  
NULL
;

256 
	}
}

258 
diùI‹¿tÜ
 *
	$diùG‘I‹¿tÜ
(
diù
 *
ht
) {

259 
diùI‹¿tÜ
 *
™”
 = 
	`m®loc
((*iter));

261 
™”
->
ht
 = ht;

262 
™”
->
šdex
 = -1;

263 
™”
->
’Œy
 = 
NULL
;

264 
™”
->
ÃxtEÁry
 = 
NULL
;

265  
™”
;

266 
	}
}

268 
diùEÁry
 *
	$diùNext
(
diùI‹¿tÜ
 *
™”
) {

270 ià(
™”
->
’Œy
 =ğ
NULL
) {

271 
™”
->
šdex
++;

272 ià(
™”
->
šdex
 >=

273 (sigÃd)
™”
->
ht
->
size
) ;

274 
™”
->
’Œy
 = i‹r->
ht
->
bË
[™”->
šdex
];

276 
™”
->
’Œy
 = i‹r->
ÃxtEÁry
;

278 ià(
™”
->
’Œy
) {

281 
™”
->
ÃxtEÁry
 = i‹r->
’Œy
->
Ãxt
;

282  
™”
->
’Œy
;

285  
NULL
;

286 
	}
}

288 
	$diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
) {

289 
	`ä“
(
™”
);

290 
	}
}

295 
	$_diùEx·ndIfN“ded
(
diù
 *
ht
) {

298 ià(
ht
->
size
 == 0)

299  
	`diùEx·nd
(
ht
, 
DICT_HT_INITIAL_SIZE
);

300 ià(
ht
->
u£d
 =ğht->
size
)

301  
	`diùEx·nd
(
ht
, ht->
size
*2);

302  
DICT_OK
;

303 
	}
}

306 
	$_diùNextPow”
(
size
) {

307 
i
 = 
DICT_HT_INITIAL_SIZE
;

309 ià(
size
 >ğ
LONG_MAX
)  LONG_MAX;

311 ià(
i
 >ğ
size
)

312  
i
;

313 
i
 *= 2;

315 
	}
}

320 
	$_diùKeyIndex
(
diù
 *
ht
, cÚ¡ *
key
) {

321 
h
;

322 
diùEÁry
 *
he
;

325 ià(
	`_diùEx·ndIfN“ded
(
ht
è=ğ
DICT_ERR
)

328 
h
 = 
	`diùHashKey
(
ht
, 
key
è& ht->
sizemask
;

330 
he
 = 
ht
->
bË
[
h
];

331 
he
) {

332 ià(
	`diùCom·»HashKeys
(
ht
, 
key
, 
he
->key))

334 
he
 = he->
Ãxt
;

336  
h
;

337 
	}
}

	@deps/hiredis/dict.h

36 #iâdeà
__DICT_H


37 
	#__DICT_H


	)

39 
	#DICT_OK
 0

	)

40 
	#DICT_ERR
 1

	)

43 
	#DICT_NOTUSED
(
V
è((èV)

	)

45 
	sdiùEÁry
 {

46 *
	mkey
;

47 *
	mv®
;

48 
diùEÁry
 *
	mÃxt
;

49 } 
	tdiùEÁry
;

51 
	sdiùTy³
 {

52 (*
	mhashFunùiÚ
)(cÚ¡ *
	mkey
);

53 *(*
	mkeyDup
)(*
	m´ivd©a
, cÚ¡ *
	mkey
);

54 *(*
	mv®Dup
)(*
	m´ivd©a
, cÚ¡ *
	mobj
);

55 (*
	mkeyCom·»
)(*
	m´ivd©a
, cÚ¡ *
	mkey1
, cÚ¡ *
	mkey2
);

56 (*
	mkeyDe¡ruùÜ
)(*
	m´ivd©a
, *
	mkey
);

57 (*
	mv®De¡ruùÜ
)(*
	m´ivd©a
, *
	mobj
);

58 } 
	tdiùTy³
;

60 
	sdiù
 {

61 
diùEÁry
 **
	mbË
;

62 
diùTy³
 *
	mty³
;

63 
	msize
;

64 
	msizemask
;

65 
	mu£d
;

66 *
	m´ivd©a
;

67 } 
	tdiù
;

69 
	sdiùI‹¿tÜ
 {

70 
diù
 *
	mht
;

71 
	mšdex
;

72 
diùEÁry
 *
	m’Œy
, *
	mÃxtEÁry
;

73 } 
	tdiùI‹¿tÜ
;

76 
	#DICT_HT_INITIAL_SIZE
 4

	)

79 
	#diùF»eEÁryV®
(
ht
, 
’Œy
) \

80 ià((
ht
)->
ty³
->
v®De¡ruùÜ
) \

81 (
ht
)->
ty³
->
	`v®De¡ruùÜ
((ht)->
´ivd©a
, (
’Œy
)->
v®
)

	)

83 
	#diùS‘HashV®
(
ht
, 
’Œy
, 
_v®_
) do { \

84 ià((
ht
)->
ty³
->
v®Dup
) \

85 
’Œy
->
v®
 = (
ht
)->
ty³
->
	`v®Dup
((ht)->
´ivd©a
, 
_v®_
); \

87 
’Œy
->
v®
 = (
_v®_
); \

88 } 0)

	)

90 
	#diùF»eEÁryKey
(
ht
, 
’Œy
) \

91 ià((
ht
)->
ty³
->
keyDe¡ruùÜ
) \

92 (
ht
)->
ty³
->
	`keyDe¡ruùÜ
((ht)->
´ivd©a
, (
’Œy
)->
key
)

	)

94 
	#diùS‘HashKey
(
ht
, 
’Œy
, 
_key_
) do { \

95 ià((
ht
)->
ty³
->
keyDup
) \

96 
’Œy
->
key
 = (
ht
)->
ty³
->
	`keyDup
((ht)->
´ivd©a
, 
_key_
); \

98 
’Œy
->
key
 = (
_key_
); \

99 } 0)

	)

101 
	#diùCom·»HashKeys
(
ht
, 
key1
, 
key2
) \

102 (((
ht
)->
ty³
->
keyCom·»
) ? \

103 (
ht
)->
ty³
->
	`keyCom·»
((ht)->
´ivd©a
, 
key1
, 
key2
) : \

104 (
key1
è=ğ(
key2
))

	)

106 
	#diùHashKey
(
ht
, 
key
è(ht)->
ty³
->
	`hashFunùiÚ
(key)

	)

108 
	#diùG‘EÁryKey
(
he
è((he)->
key
)

	)

109 
	#diùG‘EÁryV®
(
he
è((he)->
v®
)

	)

110 
	#diùSlÙs
(
ht
è((ht)->
size
)

	)

111 
	#diùSize
(
ht
è((ht)->
u£d
)

	)

114 
diùG’HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
);

115 
diù
 *
diùC»©e
(
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

116 
diùEx·nd
(
diù
 *
ht
, 
size
);

117 
diùAdd
(
diù
 *
ht
, *
key
, *
v®
);

118 
diùR•Ïû
(
diù
 *
ht
, *
key
, *
v®
);

119 
diùD–‘e
(
diù
 *
ht
, cÚ¡ *
key
);

120 
diùR–—£
(
diù
 *
ht
);

121 
diùEÁry
 * 
diùFšd
(
diù
 *
ht
, cÚ¡ *
key
);

122 
diùI‹¿tÜ
 *
diùG‘I‹¿tÜ
(
diù
 *
ht
);

123 
diùEÁry
 *
diùNext
(
diùI‹¿tÜ
 *
™”
);

124 
diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
);

	@deps/hiredis/examples/example-ae.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<sigÇl.h
>

6 
	~<hœedis.h
>

7 
	~<async.h
>

8 
	~<ad­‹rs/«.h
>

11 
«Ev’tLoİ
 *
	gloİ
;

13 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

14 
»disR•ly
 *
»¶y
 = 
r
;

15 ià(
»¶y
 =ğ
NULL
) ;

16 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

19 
	`»disAsyncDiscÚÃù
(
c
);

20 
	}
}

22 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

23 ià(
¡©us
 !ğ
REDIS_OK
) {

24 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

25 
	`«Stİ
(
loİ
);

29 
	`´štf
("Connected...\n");

30 
	}
}

32 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

33 ià(
¡©us
 !ğ
REDIS_OK
) {

34 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

35 
	`«Stİ
(
loİ
);

39 
	`´štf
("Disconnected...\n");

40 
	`«Stİ
(
loİ
);

41 
	}
}

43 
	$maš
 (
¬gc
, **
¬gv
) {

44 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

46 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

47 ià(
c
->
”r
) {

49 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

53 
loİ
 = 
	`«C»©eEv’tLoİ
(64);

54 
	`»disAeA‰ach
(
loİ
, 
c
);

55 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

56 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

57 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

58 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

59 
	`«Maš
(
loİ
);

61 
	}
}

	@deps/hiredis/examples/example-glib.c

1 
	~<¡dlib.h
>

3 
	~<hœedis.h
>

4 
	~<async.h
>

5 
	~<ad­‹rs/glib.h
>

7 
GMašLoİ
 *
	gmašloİ
;

10 
	$cÚÃù_cb
 (cÚ¡ 
»disAsyncCÚ‹xt
 *
ac
 
G_GNUC_UNUSED
,

11 
¡©us
)

13 ià(
¡©us
 !ğ
REDIS_OK
) {

14 
	`g_´š‹¼
("FaedØcÚÃù: %s\n", 
ac
->
”r¡r
);

15 
	`g_maš_loİ_qu™
(
mašloİ
);

17 
	`g_´š‹¼
("Connected...\n");

19 
	}
}

22 
	$discÚÃù_cb
 (cÚ¡ 
»disAsyncCÚ‹xt
 *
ac
 
G_GNUC_UNUSED
,

23 
¡©us
)

25 ià(
¡©us
 !ğ
REDIS_OK
) {

26 
	`g_”rÜ
("FaedØdiscÚÃù: %s", 
ac
->
”r¡r
);

28 
	`g_´š‹¼
("Disconnected...\n");

29 
	`g_maš_loİ_qu™
(
mašloİ
);

31 
	}
}

34 
	$commªd_cb
(
»disAsyncCÚ‹xt
 *
ac
,

35 
gpoš‹r
 
r
,

36 
gpoš‹r
 
u£r_d©a
 
G_GNUC_UNUSED
)

38 
»disR•ly
 *
»¶y
 = 
r
;

40 ià(
»¶y
) {

41 
	`g_´št
("REPLY: %s\n", 
»¶y
->
¡r
);

44 
	`»disAsyncDiscÚÃù
(
ac
);

45 
	}
}

47 
gšt


48 
	$maš
 (
gšt
 
¬gc
 
G_GNUC_UNUSED
,

49 
gch¬
 *
¬gv
[] 
G_GNUC_UNUSED
)

51 
»disAsyncCÚ‹xt
 *
ac
;

52 
GMašCÚ‹xt
 *
cÚ‹xt
 = 
NULL
;

53 
GSourû
 *
sourû
;

55 
ac
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

56 ià(
ac
->
”r
) {

57 
	`g_´š‹¼
("%s\n", 
ac
->
”r¡r
);

58 
	`ex™
(
EXIT_FAILURE
);

61 
sourû
 = 
	`»dis_sourû_Ãw
(
ac
);

62 
mašloİ
 = 
	`g_maš_loİ_Ãw
(
cÚ‹xt
, 
FALSE
);

63 
	`g_sourû_©ch
(
sourû
, 
cÚ‹xt
);

65 
	`»disAsyncS‘CÚÃùC®lback
(
ac
, 
cÚÃù_cb
);

66 
	`»disAsyncS‘DiscÚÃùC®lback
(
ac
, 
discÚÃù_cb
);

67 
	`»disAsyncCommªd
(
ac
, 
commªd_cb
, 
NULL
, "SET key 1234");

68 
	`»disAsyncCommªd
(
ac
, 
commªd_cb
, 
NULL
, "GET key");

70 
	`g_maš_loİ_run
(
mašloİ
);

72  
EXIT_SUCCESS
;

73 
	}
}

	@deps/hiredis/examples/example-ivykis.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<sigÇl.h
>

6 
	~<hœedis.h
>

7 
	~<async.h
>

8 
	~<ad­‹rs/ivykis.h
>

10 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

11 
»disR•ly
 *
»¶y
 = 
r
;

12 ià(
»¶y
 =ğ
NULL
) ;

13 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

16 
	`»disAsyncDiscÚÃù
(
c
);

17 
	}
}

19 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

20 ià(
¡©us
 !ğ
REDIS_OK
) {

21 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

24 
	`´štf
("Connected...\n");

25 
	}
}

27 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

28 ià(
¡©us
 !ğ
REDIS_OK
) {

29 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

32 
	`´štf
("Disconnected...\n");

33 
	}
}

35 
	$maš
 (
¬gc
, **
¬gv
) {

36 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

38 
	`iv_š™
();

40 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

41 ià(
c
->
”r
) {

43 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

47 
	`»disIvykisA‰ach
(
c
);

48 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

49 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

50 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

51 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

53 
	`iv_maš
();

55 
	`iv_deš™
();

58 
	}
}

	@deps/hiredis/examples/example-libev.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<sigÇl.h
>

6 
	~<hœedis.h
>

7 
	~<async.h
>

8 
	~<ad­‹rs/libev.h
>

10 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

11 
»disR•ly
 *
»¶y
 = 
r
;

12 ià(
»¶y
 =ğ
NULL
) ;

13 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

16 
	`»disAsyncDiscÚÃù
(
c
);

17 
	}
}

19 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

20 ià(
¡©us
 !ğ
REDIS_OK
) {

21 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

24 
	`´štf
("Connected...\n");

25 
	}
}

27 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

28 ià(
¡©us
 !ğ
REDIS_OK
) {

29 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

32 
	`´štf
("Disconnected...\n");

33 
	}
}

35 
	$maš
 (
¬gc
, **
¬gv
) {

36 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

38 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

39 ià(
c
->
”r
) {

41 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

45 
	`»disLibevA‰ach
(
EV_DEFAULT_
 
c
);

46 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

47 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

48 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

49 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

50 
	`ev_loİ
(
EV_DEFAULT_
 0);

52 
	}
}

	@deps/hiredis/examples/example-libevent.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<sigÇl.h
>

6 
	~<hœedis.h
>

7 
	~<async.h
>

8 
	~<ad­‹rs/libev’t.h
>

10 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

11 
»disR•ly
 *
»¶y
 = 
r
;

12 ià(
»¶y
 =ğ
NULL
) ;

13 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

16 
	`»disAsyncDiscÚÃù
(
c
);

17 
	}
}

19 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

20 ià(
¡©us
 !ğ
REDIS_OK
) {

21 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

24 
	`´štf
("Connected...\n");

25 
	}
}

27 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

28 ià(
¡©us
 !ğ
REDIS_OK
) {

29 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

32 
	`´štf
("Disconnected...\n");

33 
	}
}

35 
	$maš
 (
¬gc
, **
¬gv
) {

36 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

37 
ev’t_ba£
 *
ba£
 = 
	`ev’t_ba£_Ãw
();

39 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

40 ià(
c
->
”r
) {

42 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

46 
	`»disLibev’tA‰ach
(
c
,
ba£
);

47 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

48 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

49 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

50 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

51 
	`ev’t_ba£_di¥©ch
(
ba£
);

53 
	}
}

	@deps/hiredis/examples/example-libuv.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<sigÇl.h
>

6 
	~<hœedis.h
>

7 
	~<async.h
>

8 
	~<ad­‹rs/libuv.h
>

10 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

11 
»disR•ly
 *
»¶y
 = 
r
;

12 ià(
»¶y
 =ğ
NULL
) ;

13 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

16 
	`»disAsyncDiscÚÃù
(
c
);

17 
	}
}

19 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

20 ià(
¡©us
 !ğ
REDIS_OK
) {

21 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

24 
	`´štf
("Connected...\n");

25 
	}
}

27 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

28 ià(
¡©us
 !ğ
REDIS_OK
) {

29 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

32 
	`´štf
("Disconnected...\n");

33 
	}
}

35 
	$maš
 (
¬gc
, **
¬gv
) {

36 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

37 
uv_loİ_t
* 
loİ
 = 
	`uv_deçuÉ_loİ
();

39 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

40 ià(
c
->
”r
) {

42 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

46 
	`»disLibuvA‰ach
(
c
,
loİ
);

47 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

48 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

49 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

50 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

51 
	`uv_run
(
loİ
, 
UV_RUN_DEFAULT
);

53 
	}
}

	@deps/hiredis/examples/example-macosx.c

6 
	~<¡dio.h
>

8 
	~<hœedis.h
>

9 
	~<async.h
>

10 
	~<ad­‹rs/macosx.h
>

12 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *
c
, *
r
, *
´ivd©a
) {

13 
»disR•ly
 *
»¶y
 = 
r
;

14 ià(
»¶y
 =ğ
NULL
) ;

15 
	`´štf
("¬gv[%s]: %s\n", (*)
´ivd©a
, 
»¶y
->
¡r
);

18 
	`»disAsyncDiscÚÃù
(
c
);

19 
	}
}

21 
	$cÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

22 ià(
¡©us
 !ğ
REDIS_OK
) {

23 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

26 
	`´štf
("Connected...\n");

27 
	}
}

29 
	$discÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

30 ià(
¡©us
 !ğ
REDIS_OK
) {

31 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

34 
	`CFRunLoİStİ
(
	`CFRunLoİG‘Cu¼’t
());

35 
	`´štf
("Disconnected...\n");

36 
	}
}

38 
	$maš
 (
¬gc
, **
¬gv
) {

39 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

41 
CFRunLoİRef
 
loİ
 = 
	`CFRunLoİG‘Cu¼’t
();

42 ifĞ!
loİ
 ) {

43 
	`´štf
("Error: Cannot get current„un†oop\n");

47 
»disAsyncCÚ‹xt
 *
c
 = 
	`»disAsyncCÚÃù
("127.0.0.1", 6379);

48 ià(
c
->
”r
) {

50 
	`´štf
("E¼Ü: %s\n", 
c
->
”r¡r
);

54 
	`»disMacOSA‰ach
(
c
, 
loİ
);

56 
	`»disAsyncS‘CÚÃùC®lback
(
c
,
cÚÃùC®lback
);

57 
	`»disAsyncS‘DiscÚÃùC®lback
(
c
,
discÚÃùC®lback
);

59 
	`»disAsyncCommªd
(
c
, 
NULL
, NULL, "SET key %b", 
¬gv
[
¬gc
-1], 
	`¡¾’
(argv[argc-1]));

60 
	`»disAsyncCommªd
(
c
, 
g‘C®lback
, (*)"end-1", "GET key");

62 
	`CFRunLoİRun
();

65 
	}
}

	@deps/hiredis/examples/example-qt.cpp

1 
	~<io¡»am
>

2 
usšg
 
Çme¥aû
 
	g¡d
;

4 
	~<QCÜeAµliÿtiÚ
>

5 
	~<QTim”
>

7 
	~"exam¶e-qt.h
"

9 
	$g‘C®lback
(
»disAsyncCÚ‹xt
 *, * 
r
, * 
´ivd©a
) {

11 
»disR•ly
 * 
»¶y
 = 
¡©ic_ÿ¡
<»disR•ly *>(
r
);

12 
Exam¶eQt
 * 
ex
 = 
¡©ic_ÿ¡
<Exam¶eQˆ*>(
´ivd©a
);

13 ià(
»¶y
 =ğ
nuÎ±r
 || 
ex
 ==‚ullptr) ;

15 
cout
 << "key: " << 
»¶y
->
¡r
 << 
’dl
;

17 
ex
->
	`fšish
();

18 
	}
}

20 
	gExam¶eQt
::
	$run
() {

22 
m_ùx
 = 
	`»disAsyncCÚÃù
("localhost", 6379);

24 ià(
m_ùx
->
”r
) {

25 
û¼
 << "E¼Ü: " << 
m_ùx
->
”r¡r
 << 
’dl
;

26 
	`»disAsyncF»e
(
m_ùx
);

27 
em™
 
	`fšished
();

30 
m_ad­‹r
.
	`£tCÚ‹xt
(
m_ùx
);

32 
	`»disAsyncCommªd
(
m_ùx
, 
NULL
, NULL, "SET key %s", 
m_v®ue
);

33 
	`»disAsyncCommªd
(
m_ùx
, 
g‘C®lback
, 
this
, "GET key");

34 
	}
}

36 
	$maš
 (
¬gc
, **
¬gv
) {

38 
QCÜeAµliÿtiÚ
 
	`­p
(
¬gc
, 
¬gv
);

40 
Exam¶eQt
 
	`exam¶e
(
¬gv
[
¬gc
-1]);

42 
QObjeù
::
	`cÚÃù
(&
exam¶e
, 
	`SIGNAL
(
	`fšished
()), &
­p
, 
	`SLOT
(
	`qu™
()));

43 
QTim”
::
	`sšgËShÙ
(0, &
exam¶e
, 
	`SLOT
(
	`run
()));

45  
­p
.
	`exec
();

46 
	}
}

	@deps/hiredis/examples/example-qt.h

1 #iâdeà
__HIREDIS_EXAMPLE_QT_H


2 
	#__HIREDIS_EXAMPLE_QT_H


	)

4 
	~<ad­‹rs/qt.h
>

6 şas 
	cExam¶eQt
 : 
public
 
QObjeù
 {

8 
Q_OBJECT


10 
public
:

11 
	$Exam¶eQt
(cÚ¡ * 
v®ue
, 
QObjeù
 * 
·»Á
 = 0)

12 : 
	`QObjeù
(
·»Á
), 
	$m_v®ue
(
v®ue
) {}

14 
sigÇls
:

15 
	`fšished
();

17 
public
 
¦Ùs
:

18 
	`run
();

20 
´iv©e
:

21 
	$fšish
(è{ 
em™
 
	`fšished
(); 
	}
}

23 
	g´iv©e
:

24 cÚ¡ * 
m_v®ue
;

25 
»disAsyncCÚ‹xt
 * 
	gm_ùx
;

26 
RedisQtAd­‹r
 
	gm_ad­‹r
;

28 
ä›nd


29 
g‘C®lback
(
»disAsyncCÚ‹xt
 *, *, *);

	@deps/hiredis/examples/example.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

5 
	~<hœedis.h
>

7 
	$maš
(
¬gc
, **
¬gv
) {

8 
j
;

9 
»disCÚ‹xt
 *
c
;

10 
»disR•ly
 *
»¶y
;

11 cÚ¡ *
ho¡Çme
 = (
¬gc
 > 1è? 
¬gv
[1] : "127.0.0.1";

12 
pÜt
 = (
¬gc
 > 2è? 
	`©oi
(
¬gv
[2]) : 6379;

14 
timev®
 
timeout
 = { 1, 500000 };

15 
c
 = 
	`»disCÚÃùW™hTimeout
(
ho¡Çme
, 
pÜt
, 
timeout
);

16 ià(
c
 =ğ
NULL
 || c->
”r
) {

17 ià(
c
) {

18 
	`´štf
("CÚÃùiÚƒ¼Ü: %s\n", 
c
->
”r¡r
);

19 
	`»disF»e
(
c
);

21 
	`´štf
("Connectionƒrror: can't‡llocate„edis context\n");

23 
	`ex™
(1);

27 
»¶y
 = 
	`»disCommªd
(
c
,"PING");

28 
	`´štf
("PING: %s\n", 
»¶y
->
¡r
);

29 
	`ä“R•lyObjeù
(
»¶y
);

32 
»¶y
 = 
	`»disCommªd
(
c
,"SET %s %s", "foo", "hello world");

33 
	`´štf
("SET: %s\n", 
»¶y
->
¡r
);

34 
	`ä“R•lyObjeù
(
»¶y
);

37 
»¶y
 = 
	`»disCommªd
(
c
,"SET %b %b", "b¬", (
size_t
) 3, "hello", (size_t) 5);

38 
	`´štf
("SET (bš¬y API): %s\n", 
»¶y
->
¡r
);

39 
	`ä“R•lyObjeù
(
»¶y
);

42 
»¶y
 = 
	`»disCommªd
(
c
,"GET foo");

43 
	`´štf
("GET foo: %s\n", 
»¶y
->
¡r
);

44 
	`ä“R•lyObjeù
(
»¶y
);

46 
»¶y
 = 
	`»disCommªd
(
c
,"INCR counter");

47 
	`´štf
("INCR couÁ”: %Îd\n", 
»¶y
->
š‹g”
);

48 
	`ä“R•lyObjeù
(
»¶y
);

50 
»¶y
 = 
	`»disCommªd
(
c
,"INCR counter");

51 
	`´štf
("INCR couÁ”: %Îd\n", 
»¶y
->
š‹g”
);

52 
	`ä“R•lyObjeù
(
»¶y
);

55 
»¶y
 = 
	`»disCommªd
(
c
,"DEL mylist");

56 
	`ä“R•lyObjeù
(
»¶y
);

57 
j
 = 0; j < 10; j++) {

58 
buf
[64];

60 
	`¢´štf
(
buf
,64,"%u",
j
);

61 
»¶y
 = 
	`»disCommªd
(
c
,"LPUSH myli¡ƒËm’t-%s", 
buf
);

62 
	`ä“R•lyObjeù
(
»¶y
);

66 
»¶y
 = 
	`»disCommªd
(
c
,"LRANGE mylist 0 -1");

67 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ARRAY
) {

68 
j
 = 0; j < 
»¶y
->
–em’ts
; j++) {

69 
	`´štf
("%uè%s\n", 
j
, 
»¶y
->
–em’t
[j]->
¡r
);

72 
	`ä“R•lyObjeù
(
»¶y
);

75 
	`»disF»e
(
c
);

78 
	}
}

	@deps/hiredis/fmacros.h

1 #iâdeà
__HIREDIS_FMACRO_H


2 
	#__HIREDIS_FMACRO_H


	)

4 #ià
defšed
(
__lšux__
)

5 
	#_BSD_SOURCE


	)

6 
	#_DEFAULT_SOURCE


	)

9 #ià
defšed
(
__CYGWIN__
)

10 
	~<sys/cdefs.h
>

13 #ià
defšed
(
__sun__
)

14 
	#_POSIX_C_SOURCE
 200112L

	)

16 #ià!(
defšed
(
__APPLE__
è&& defšed(
__MACH__
)è&& !(defšed(
__F»eBSD__
))

17 
	#_XOPEN_SOURCE
 600

	)

21 #ià
defšed
(
__APPLE__
è&& defšed(
__MACH__
)

22 
	#_OSX


	)

	@deps/hiredis/hiredis.c

34 
	~"fmaüos.h
"

35 
	~<¡ršg.h
>

36 
	~<¡dlib.h
>

37 
	~<uni¡d.h
>

38 
	~<as£¹.h
>

39 
	~<”ºo.h
>

40 
	~<ùy³.h
>

42 
	~"hœedis.h
"

43 
	~"Ãt.h
"

44 
	~"sds.h
"

46 
»disR•ly
 *
ü—‹R•lyObjeù
(
ty³
);

47 *
ü—‹SŒšgObjeù
(cÚ¡ 
»disR—dTask
 *
sk
, *
¡r
, 
size_t
 
Ën
);

48 *
ü—‹A¼ayObjeù
(cÚ¡ 
»disR—dTask
 *
sk
, 
–em’ts
);

49 *
ü—‹IÁeg”Objeù
(cÚ¡ 
»disR—dTask
 *
sk
, 
v®ue
);

50 *
ü—‹NObjeù
(cÚ¡ 
»disR—dTask
 *
sk
);

54 
»disR•lyObjeùFunùiÚs
 
	gdeçuÉFunùiÚs
 = {

55 
ü—‹SŒšgObjeù
,

56 
ü—‹A¼ayObjeù
,

57 
ü—‹IÁeg”Objeù
,

58 
ü—‹NObjeù
,

59 
ä“R•lyObjeù


63 
»disR•ly
 *
	$ü—‹R•lyObjeù
(
ty³
) {

64 
»disR•ly
 *
r
 = 
	`ÿÎoc
(1,(*r));

66 ià(
r
 =ğ
NULL
)

67  
NULL
;

69 
r
->
ty³
 =ype;

70  
r
;

71 
	}
}

74 
	$ä“R•lyObjeù
(*
»¶y
) {

75 
»disR•ly
 *
r
 = 
»¶y
;

76 
size_t
 
j
;

78 ià(
r
 =ğ
NULL
)

81 
r
->
ty³
) {

82 
REDIS_REPLY_INTEGER
:

84 
REDIS_REPLY_ARRAY
:

85 ià(
r
->
–em’t
 !ğ
NULL
) {

86 
j
 = 0; j < 
r
->
–em’ts
; j++)

87 ià(
r
->
–em’t
[
j
] !ğ
NULL
)

88 
	`ä“R•lyObjeù
(
r
->
–em’t
[
j
]);

89 
	`ä“
(
r
->
–em’t
);

92 
REDIS_REPLY_ERROR
:

93 
REDIS_REPLY_STATUS
:

94 
REDIS_REPLY_STRING
:

95 ià(
r
->
¡r
 !ğ
NULL
)

96 
	`ä“
(
r
->
¡r
);

99 
	`ä“
(
r
);

100 
	}
}

102 *
	$ü—‹SŒšgObjeù
(cÚ¡ 
»disR—dTask
 *
sk
, *
¡r
, 
size_t
 
Ën
) {

103 
»disR•ly
 *
r
, *
·»Á
;

104 *
buf
;

106 
r
 = 
	`ü—‹R•lyObjeù
(
sk
->
ty³
);

107 ià(
r
 =ğ
NULL
)

108  
NULL
;

110 
buf
 = 
	`m®loc
(
Ën
+1);

111 ià(
buf
 =ğ
NULL
) {

112 
	`ä“R•lyObjeù
(
r
);

113  
NULL
;

116 
	`as£¹
(
sk
->
ty³
 =ğ
REDIS_REPLY_ERROR
 ||

117 
sk
->
ty³
 =ğ
REDIS_REPLY_STATUS
 ||

118 
sk
->
ty³
 =ğ
REDIS_REPLY_STRING
);

121 
	`memıy
(
buf
,
¡r
,
Ën
);

122 
buf
[
Ën
] = '\0';

123 
r
->
¡r
 = 
buf
;

124 
r
->
Ën
 =†en;

126 ià(
sk
->
·»Á
) {

127 
·»Á
 = 
sk
->·»Á->
obj
;

128 
	`as£¹
(
·»Á
->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

129 
·»Á
->
–em’t
[
sk
->
idx
] = 
r
;

131  
r
;

132 
	}
}

134 *
	$ü—‹A¼ayObjeù
(cÚ¡ 
»disR—dTask
 *
sk
, 
–em’ts
) {

135 
»disR•ly
 *
r
, *
·»Á
;

137 
r
 = 
	`ü—‹R•lyObjeù
(
REDIS_REPLY_ARRAY
);

138 ià(
r
 =ğ
NULL
)

139  
NULL
;

141 ià(
–em’ts
 > 0) {

142 
r
->
–em’t
 = 
	`ÿÎoc
(
–em’ts
,(
»disR•ly
*));

143 ià(
r
->
–em’t
 =ğ
NULL
) {

144 
	`ä“R•lyObjeù
(
r
);

145  
NULL
;

149 
r
->
–em’ts
 =ƒlements;

151 ià(
sk
->
·»Á
) {

152 
·»Á
 = 
sk
->·»Á->
obj
;

153 
	`as£¹
(
·»Á
->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

154 
·»Á
->
–em’t
[
sk
->
idx
] = 
r
;

156  
r
;

157 
	}
}

159 *
	$ü—‹IÁeg”Objeù
(cÚ¡ 
»disR—dTask
 *
sk
, 
v®ue
) {

160 
»disR•ly
 *
r
, *
·»Á
;

162 
r
 = 
	`ü—‹R•lyObjeù
(
REDIS_REPLY_INTEGER
);

163 ià(
r
 =ğ
NULL
)

164  
NULL
;

166 
r
->
š‹g”
 = 
v®ue
;

168 ià(
sk
->
·»Á
) {

169 
·»Á
 = 
sk
->·»Á->
obj
;

170 
	`as£¹
(
·»Á
->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

171 
·»Á
->
–em’t
[
sk
->
idx
] = 
r
;

173  
r
;

174 
	}
}

176 *
	$ü—‹NObjeù
(cÚ¡ 
»disR—dTask
 *
sk
) {

177 
»disR•ly
 *
r
, *
·»Á
;

179 
r
 = 
	`ü—‹R•lyObjeù
(
REDIS_REPLY_NIL
);

180 ià(
r
 =ğ
NULL
)

181  
NULL
;

183 ià(
sk
->
·»Á
) {

184 
·»Á
 = 
sk
->·»Á->
obj
;

185 
	`as£¹
(
·»Á
->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

186 
·»Á
->
–em’t
[
sk
->
idx
] = 
r
;

188  
r
;

189 
	}
}

193 
ušt32_t
 
	$couÁDig™s
(
ušt64_t
 
v
) {

194 
ušt32_t
 
»suÉ
 = 1;

196 ià(
v
 < 10è 
»suÉ
;

197 ià(
v
 < 100è 
»suÉ
 + 1;

198 ià(
v
 < 1000è 
»suÉ
 + 2;

199 ià(
v
 < 10000è 
»suÉ
 + 3;

200 
v
 /= 10000U;

201 
»suÉ
 += 4;

203 
	}
}

206 
size_t
 
	$bulkËn
(
size_t
 
Ën
) {

207  1+
	`couÁDig™s
(
Ën
)+2+len+2;

208 
	}
}

210 
	$»disvFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
) {

211 cÚ¡ *
c
 = 
fÜm©
;

212 *
cmd
 = 
NULL
;

213 
pos
;

214 
sds
 
cu¿rg
, 
Ãw¬g
;

215 
touched
 = 0;

216 **
cu¿rgv
 = 
NULL
, **
Ãw¬gv
 = NULL;

217 
¬gc
 = 0;

218 
tÙËn
 = 0;

219 
”rÜ_ty³
 = 0;

220 
j
;

223 ià(
rg‘
 =ğ
NULL
)

227 
cu¿rg
 = 
	`sd£m±y
();

228 ià(
cu¿rg
 =ğ
NULL
)

231 *
c
 != '\0') {

232 ià(*
c
 != '%' || c[1] == '\0') {

233 ià(*
c
 == ' ') {

234 ià(
touched
) {

235 
Ãw¬gv
 = 
	`»®loc
(
cu¿rgv
,(*)*(
¬gc
+1));

236 ià(
Ãw¬gv
 =ğ
NULL
è
memÜy_”r
;

237 
cu¿rgv
 = 
Ãw¬gv
;

238 
cu¿rgv
[
¬gc
++] = 
cu¿rg
;

239 
tÙËn
 +ğ
	`bulkËn
(
	`sd¦’
(
cu¿rg
));

242 
cu¿rg
 = 
	`sd£m±y
();

243 ià(
cu¿rg
 =ğ
NULL
è
memÜy_”r
;

244 
touched
 = 0;

247 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
c
,1);

248 ià(
Ãw¬g
 =ğ
NULL
è
memÜy_”r
;

249 
cu¿rg
 = 
Ãw¬g
;

250 
touched
 = 1;

253 *
¬g
;

254 
size_t
 
size
;

257 
Ãw¬g
 = 
cu¿rg
;

259 
c
[1]) {

261 
¬g
 = 
	`va_¬g
(
­
,*);

262 
size
 = 
	`¡¾’
(
¬g
);

263 ià(
size
 > 0)

264 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
¬g
,
size
);

267 
¬g
 = 
	`va_¬g
(
­
,*);

268 
size
 = 
	`va_¬g
(
­
,
size_t
);

269 ià(
size
 > 0)

270 
Ãw¬g
 = 
	`sdsÿ’
(
cu¿rg
,
¬g
,
size
);

273 
Ãw¬g
 = 
	`sdsÿt
(
cu¿rg
,"%");

278 cÚ¡ 
štfmts
[] = "diouxX";

279 cÚ¡ 
æags
[] = "#0-+ ";

280 
_fÜm©
[16];

281 cÚ¡ *
_p
 = 
c
+1;

282 
size_t
 
_l
 = 0;

283 
va_li¡
 
_ıy
;

286 *
_p
 !ğ'\0' && 
	`¡rchr
(
æags
,*_pè!ğ
NULL
) _p++;

289 *
_p
 !ğ'\0' && 
	`isdig™
(*_p)) _p++;

292 ià(*
_p
 == '.') {

293 
_p
++;

294 *
_p
 !ğ'\0' && 
	`isdig™
(*_p)) _p++;

298 
	`va_cİy
(
_ıy
,
­
);

301 ià(
	`¡rchr
(
štfmts
,*
_p
è!ğ
NULL
) {

302 
	`va_¬g
(
­
,);

303 
fmt_v®id
;

307 ià(
	`¡rchr
("eEfFgGaA",*
_p
è!ğ
NULL
) {

308 
	`va_¬g
(
­
,);

309 
fmt_v®id
;

313 ià(
_p
[0] == 'h' && _p[1] == 'h') {

314 
_p
 += 2;

315 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

316 
	`va_¬g
(
­
,);

317 
fmt_v®id
;

319 
fmt_šv®id
;

323 ià(
_p
[0] == 'h') {

324 
_p
 += 1;

325 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

326 
	`va_¬g
(
­
,);

327 
fmt_v®id
;

329 
fmt_šv®id
;

333 ià(
_p
[0] == 'l' && _p[1] == 'l') {

334 
_p
 += 2;

335 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

336 
	`va_¬g
(
­
,);

337 
fmt_v®id
;

339 
fmt_šv®id
;

343 ià(
_p
[0] == 'l') {

344 
_p
 += 1;

345 ià(*
_p
 !ğ'\0' && 
	`¡rchr
(
štfmts
,*_pè!ğ
NULL
) {

346 
	`va_¬g
(
­
,);

347 
fmt_v®id
;

349 
fmt_šv®id
;

352 
fmt_šv®id
:

353 
	`va_’d
(
_ıy
);

354 
fÜm©_”r
;

356 
fmt_v®id
:

357 
_l
 = (
_p
+1)-
c
;

358 ià(
_l
 < (
_fÜm©
)-2) {

359 
	`memıy
(
_fÜm©
,
c
,
_l
);

360 
_fÜm©
[
_l
] = '\0';

361 
Ãw¬g
 = 
	`sdsÿtv´štf
(
cu¿rg
,
_fÜm©
,
_ıy
);

365 
c
 = 
_p
-1;

368 
	`va_’d
(
_ıy
);

373 ià(
Ãw¬g
 =ğ
NULL
è
memÜy_”r
;

374 
cu¿rg
 = 
Ãw¬g
;

376 
touched
 = 1;

377 
c
++;

379 
c
++;

383 ià(
touched
) {

384 
Ãw¬gv
 = 
	`»®loc
(
cu¿rgv
,(*)*(
¬gc
+1));

385 ià(
Ãw¬gv
 =ğ
NULL
è
memÜy_”r
;

386 
cu¿rgv
 = 
Ãw¬gv
;

387 
cu¿rgv
[
¬gc
++] = 
cu¿rg
;

388 
tÙËn
 +ğ
	`bulkËn
(
	`sd¦’
(
cu¿rg
));

390 
	`sdsä“
(
cu¿rg
);

394 
cu¿rg
 = 
NULL
;

397 
tÙËn
 +ğ1+
	`couÁDig™s
(
¬gc
)+2;

400 
cmd
 = 
	`m®loc
(
tÙËn
+1);

401 ià(
cmd
 =ğ
NULL
è
memÜy_”r
;

403 
pos
 = 
	`¥rštf
(
cmd
,"*%d\r\n",
¬gc
);

404 
j
 = 0; j < 
¬gc
; j++) {

405 
pos
 +ğ
	`¥rštf
(
cmd
+pos,"$%zu\r\n",
	`sd¦’
(
cu¿rgv
[
j
]));

406 
	`memıy
(
cmd
+
pos
,
cu¿rgv
[
j
],
	`sd¦’
(curargv[j]));

407 
pos
 +ğ
	`sd¦’
(
cu¿rgv
[
j
]);

408 
	`sdsä“
(
cu¿rgv
[
j
]);

409 
cmd
[
pos
++] = '\r';

410 
cmd
[
pos
++] = '\n';

412 
	`as£¹
(
pos
 =ğ
tÙËn
);

413 
cmd
[
pos
] = '\0';

415 
	`ä“
(
cu¿rgv
);

416 *
rg‘
 = 
cmd
;

417  
tÙËn
;

419 
fÜm©_”r
:

420 
”rÜ_ty³
 = -2;

421 
ş—nup
;

423 
memÜy_”r
:

424 
”rÜ_ty³
 = -1;

425 
ş—nup
;

427 
ş—nup
:

428 ià(
cu¿rgv
) {

429 
¬gc
--)

430 
	`sdsä“
(
cu¿rgv
[
¬gc
]);

431 
	`ä“
(
cu¿rgv
);

434 
	`sdsä“
(
cu¿rg
);

438 ià(
cmd
 !ğ
NULL
)

439 
	`ä“
(
cmd
);

441  
”rÜ_ty³
;

442 
	}
}

456 
	$»disFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, ...) {

457 
va_li¡
 
­
;

458 
Ën
;

459 
	`va_¡¬t
(
­
,
fÜm©
);

460 
Ën
 = 
	`»disvFÜm©Commªd
(
rg‘
,
fÜm©
,
­
);

461 
	`va_’d
(
­
);

465 ià(
Ën
 < 0)

466 
Ën
 = -1;

468  
Ën
;

469 
	}
}

477 
	$»disFÜm©SdsCommªdArgv
(
sds
 *
rg‘
, 
¬gc
, cÚ¡ **
¬gv
,

478 cÚ¡ 
size_t
 *
¬gvËn
)

480 
sds
 
cmd
;

481 
tÙËn
;

482 
j
;

483 
size_t
 
Ën
;

486 ià(
rg‘
 =ğ
NULL
)

490 
tÙËn
 = 1+
	`couÁDig™s
(
¬gc
)+2;

491 
j
 = 0; j < 
¬gc
; j++) {

492 
Ën
 = 
¬gvËn
 ?‡rgvËn[
j
] : 
	`¡¾’
(
¬gv
[j]);

493 
tÙËn
 +ğ
	`bulkËn
(
Ën
);

497 
cmd
 = 
	`sd£m±y
();

498 ià(
cmd
 =ğ
NULL
)

502 
cmd
 = 
	`sdsMakeRoomFÜ
(cmd, 
tÙËn
);

503 ià(
cmd
 =ğ
NULL
)

507 
cmd
 = 
	`sdsÿtfmt
(cmd, "*%i\r\n", 
¬gc
);

508 
j
=0; j < 
¬gc
; j++) {

509 
Ën
 = 
¬gvËn
 ?‡rgvËn[
j
] : 
	`¡¾’
(
¬gv
[j]);

510 
cmd
 = 
	`sdsÿtfmt
(cmd, "$%u\r\n", 
Ën
);

511 
cmd
 = 
	`sdsÿ’
(cmd, 
¬gv
[
j
], 
Ën
);

512 
cmd
 = 
	`sdsÿ’
(cmd, "\r\n", ("\r\n")-1);

515 
	`as£¹
(
	`sd¦’
(
cmd
)==
tÙËn
);

517 *
rg‘
 = 
cmd
;

518  
tÙËn
;

519 
	}
}

521 
	$»disF»eSdsCommªd
(
sds
 
cmd
) {

522 
	`sdsä“
(
cmd
);

523 
	}
}

530 
	$»disFÜm©CommªdArgv
(**
rg‘
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
) {

531 *
cmd
 = 
NULL
;

532 
pos
;

533 
size_t
 
Ën
;

534 
tÙËn
, 
j
;

537 ià(
rg‘
 =ğ
NULL
)

541 
tÙËn
 = 1+
	`couÁDig™s
(
¬gc
)+2;

542 
j
 = 0; j < 
¬gc
; j++) {

543 
Ën
 = 
¬gvËn
 ?‡rgvËn[
j
] : 
	`¡¾’
(
¬gv
[j]);

544 
tÙËn
 +ğ
	`bulkËn
(
Ën
);

548 
cmd
 = 
	`m®loc
(
tÙËn
+1);

549 ià(
cmd
 =ğ
NULL
)

552 
pos
 = 
	`¥rštf
(
cmd
,"*%d\r\n",
¬gc
);

553 
j
 = 0; j < 
¬gc
; j++) {

554 
Ën
 = 
¬gvËn
 ?‡rgvËn[
j
] : 
	`¡¾’
(
¬gv
[j]);

555 
pos
 +ğ
	`¥rštf
(
cmd
+pos,"$%zu\r\n",
Ën
);

556 
	`memıy
(
cmd
+
pos
,
¬gv
[
j
],
Ën
);

557 
pos
 +ğ
Ën
;

558 
cmd
[
pos
++] = '\r';

559 
cmd
[
pos
++] = '\n';

561 
	`as£¹
(
pos
 =ğ
tÙËn
);

562 
cmd
[
pos
] = '\0';

564 *
rg‘
 = 
cmd
;

565  
tÙËn
;

566 
	}
}

568 
	$»disF»eCommªd
(*
cmd
) {

569 
	`ä“
(
cmd
);

570 
	}
}

572 
	$__»disS‘E¼Ü
(
»disCÚ‹xt
 *
c
, 
ty³
, cÚ¡ *
¡r
) {

573 
size_t
 
Ën
;

575 
c
->
”r
 = 
ty³
;

576 ià(
¡r
 !ğ
NULL
) {

577 
Ën
 = 
	`¡¾’
(
¡r
);

578 
Ën
 =†’ < ((
c
->
”r¡r
)-1) ?†en : ((c->errstr)-1);

579 
	`memıy
(
c
->
”r¡r
,
¡r
,
Ën
);

580 
c
->
”r¡r
[
Ën
] = '\0';

583 
	`as£¹
(
ty³
 =ğ
REDIS_ERR_IO
);

584 
	`__»dis_¡»¼Ü_r
(
”ºo
, 
c
->
”r¡r
, (c->errstr));

586 
	}
}

588 
»disR—d”
 *
	$»disR—d”C»©e
() {

589  
	`»disR—d”C»©eW™hFunùiÚs
(&
deçuÉFunùiÚs
);

590 
	}
}

592 
»disCÚ‹xt
 *
	$»disCÚ‹xtIn™
() {

593 
»disCÚ‹xt
 *
c
;

595 
c
 = 
	`ÿÎoc
(1,(
»disCÚ‹xt
));

596 ià(
c
 =ğ
NULL
)

597  
NULL
;

599 
c
->
”r
 = 0;

600 
c
->
”r¡r
[0] = '\0';

601 
c
->
obuf
 = 
	`sd£m±y
();

602 
c
->
»ad”
 = 
	`»disR—d”C»©e
();

603 
c
->
tı
.
ho¡
 = 
NULL
;

604 
c
->
tı
.
sourû_addr
 = 
NULL
;

605 
c
->
unix_sock
.
·th
 = 
NULL
;

606 
c
->
timeout
 = 
NULL
;

608 ià(
c
->
obuf
 =ğ
NULL
 || c->
»ad”
 == NULL) {

609 
	`»disF»e
(
c
);

610  
NULL
;

613  
c
;

614 
	}
}

616 
	$»disF»e
(
»disCÚ‹xt
 *
c
) {

617 ià(
c
 =ğ
NULL
)

619 ià(
c
->
fd
 > 0)

620 
	`şo£
(
c
->
fd
);

621 ià(
c
->
obuf
 !ğ
NULL
)

622 
	`sdsä“
(
c
->
obuf
);

623 ià(
c
->
»ad”
 !ğ
NULL
)

624 
	`»disR—d”F»e
(
c
->
»ad”
);

625 ià(
c
->
tı
.
ho¡
)

626 
	`ä“
(
c
->
tı
.
ho¡
);

627 ià(
c
->
tı
.
sourû_addr
)

628 
	`ä“
(
c
->
tı
.
sourû_addr
);

629 ià(
c
->
unix_sock
.
·th
)

630 
	`ä“
(
c
->
unix_sock
.
·th
);

631 ià(
c
->
timeout
)

632 
	`ä“
(
c
->
timeout
);

633 
	`ä“
(
c
);

634 
	}
}

636 
	$»disF»eK“pFd
(
»disCÚ‹xt
 *
c
) {

637 
fd
 = 
c
->fd;

638 
c
->
fd
 = -1;

639 
	`»disF»e
(
c
);

640  
fd
;

641 
	}
}

643 
	$»disRecÚÃù
(
»disCÚ‹xt
 *
c
) {

644 
c
->
”r
 = 0;

645 
	`mem£t
(
c
->
”r¡r
, '\0', 
	`¡¾’
(c->errstr));

647 ià(
c
->
fd
 > 0) {

648 
	`şo£
(
c
->
fd
);

651 
	`sdsä“
(
c
->
obuf
);

652 
	`»disR—d”F»e
(
c
->
»ad”
);

654 
c
->
obuf
 = 
	`sd£m±y
();

655 
c
->
»ad”
 = 
	`»disR—d”C»©e
();

657 ià(
c
->
cÚÃùiÚ_ty³
 =ğ
REDIS_CONN_TCP
) {

658  
	`»disCÚ‹xtCÚÃùBšdTı
(
c
, c->
tı
.
ho¡
, c->tı.
pÜt
,

659 
c
->
timeout
, c->
tı
.
sourû_addr
);

660 } ià(
c
->
cÚÃùiÚ_ty³
 =ğ
REDIS_CONN_UNIX
) {

661  
	`»disCÚ‹xtCÚÃùUnix
(
c
, c->
unix_sock
.
·th
, c->
timeout
);

665 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,"Notƒnough informationo„econnect");

668  
REDIS_ERR
;

669 
	}
}

674 
»disCÚ‹xt
 *
	$»disCÚÃù
(cÚ¡ *

, 
pÜt
) {

675 
»disCÚ‹xt
 *
c
;

677 
c
 = 
	`»disCÚ‹xtIn™
();

678 ià(
c
 =ğ
NULL
)

679  
NULL
;

681 
c
->
æags
 |ğ
REDIS_BLOCK
;

682 
	`»disCÚ‹xtCÚÃùTı
(
c
,

,
pÜt
,
NULL
);

683  
c
;

684 
	}
}

686 
»disCÚ‹xt
 *
	$»disCÚÃùW™hTimeout
(cÚ¡ *

, 
pÜt
, cÚ¡ 
timev®
 
tv
) {

687 
»disCÚ‹xt
 *
c
;

689 
c
 = 
	`»disCÚ‹xtIn™
();

690 ià(
c
 =ğ
NULL
)

691  
NULL
;

693 
c
->
æags
 |ğ
REDIS_BLOCK
;

694 
	`»disCÚ‹xtCÚÃùTı
(
c
,

,
pÜt
,&
tv
);

695  
c
;

696 
	}
}

698 
»disCÚ‹xt
 *
	$»disCÚÃùNÚBlock
(cÚ¡ *

, 
pÜt
) {

699 
»disCÚ‹xt
 *
c
;

701 
c
 = 
	`»disCÚ‹xtIn™
();

702 ià(
c
 =ğ
NULL
)

703  
NULL
;

705 
c
->
æags
 &ğ~
REDIS_BLOCK
;

706 
	`»disCÚ‹xtCÚÃùTı
(
c
,

,
pÜt
,
NULL
);

707  
c
;

708 
	}
}

710 
»disCÚ‹xt
 *
	$»disCÚÃùBšdNÚBlock
(cÚ¡ *

, 
pÜt
,

711 cÚ¡ *
sourû_addr
) {

712 
»disCÚ‹xt
 *
c
 = 
	`»disCÚ‹xtIn™
();

713 
c
->
æags
 &ğ~
REDIS_BLOCK
;

714 
	`»disCÚ‹xtCÚÃùBšdTı
(
c
,

,
pÜt
,
NULL
,
sourû_addr
);

715  
c
;

716 
	}
}

718 
»disCÚ‹xt
 *
	$»disCÚÃùBšdNÚBlockW™hReu£
(cÚ¡ *

, 
pÜt
,

719 cÚ¡ *
sourû_addr
) {

720 
»disCÚ‹xt
 *
c
 = 
	`»disCÚ‹xtIn™
();

721 
c
->
æags
 &ğ~
REDIS_BLOCK
;

722 
c
->
æags
 |ğ
REDIS_REUSEADDR
;

723 
	`»disCÚ‹xtCÚÃùBšdTı
(
c
,

,
pÜt
,
NULL
,
sourû_addr
);

724  
c
;

725 
	}
}

727 
»disCÚ‹xt
 *
	$»disCÚÃùUnix
(cÚ¡ *
·th
) {

728 
»disCÚ‹xt
 *
c
;

730 
c
 = 
	`»disCÚ‹xtIn™
();

731 ià(
c
 =ğ
NULL
)

732  
NULL
;

734 
c
->
æags
 |ğ
REDIS_BLOCK
;

735 
	`»disCÚ‹xtCÚÃùUnix
(
c
,
·th
,
NULL
);

736  
c
;

737 
	}
}

739 
»disCÚ‹xt
 *
	$»disCÚÃùUnixW™hTimeout
(cÚ¡ *
·th
, cÚ¡ 
timev®
 
tv
) {

740 
»disCÚ‹xt
 *
c
;

742 
c
 = 
	`»disCÚ‹xtIn™
();

743 ià(
c
 =ğ
NULL
)

744  
NULL
;

746 
c
->
æags
 |ğ
REDIS_BLOCK
;

747 
	`»disCÚ‹xtCÚÃùUnix
(
c
,
·th
,&
tv
);

748  
c
;

749 
	}
}

751 
»disCÚ‹xt
 *
	$»disCÚÃùUnixNÚBlock
(cÚ¡ *
·th
) {

752 
»disCÚ‹xt
 *
c
;

754 
c
 = 
	`»disCÚ‹xtIn™
();

755 ià(
c
 =ğ
NULL
)

756  
NULL
;

758 
c
->
æags
 &ğ~
REDIS_BLOCK
;

759 
	`»disCÚ‹xtCÚÃùUnix
(
c
,
·th
,
NULL
);

760  
c
;

761 
	}
}

763 
»disCÚ‹xt
 *
	$»disCÚÃùFd
(
fd
) {

764 
»disCÚ‹xt
 *
c
;

766 
c
 = 
	`»disCÚ‹xtIn™
();

767 ià(
c
 =ğ
NULL
)

768  
NULL
;

770 
c
->
fd
 = fd;

771 
c
->
æags
 |ğ
REDIS_BLOCK
 | 
REDIS_CONNECTED
;

772  
c
;

773 
	}
}

776 
	$»disS‘Timeout
(
»disCÚ‹xt
 *
c
, cÚ¡ 
timev®
 
tv
) {

777 ià(
c
->
æags
 & 
REDIS_BLOCK
)

778  
	`»disCÚ‹xtS‘Timeout
(
c
,
tv
);

779  
REDIS_ERR
;

780 
	}
}

783 
	$»disEÇbËK“pAlive
(
»disCÚ‹xt
 *
c
) {

784 ià(
	`»disK“pAlive
(
c
, 
REDIS_KEEPALIVE_INTERVAL
è!ğ
REDIS_OK
)

785  
REDIS_ERR
;

786  
REDIS_OK
;

787 
	}
}

794 
	$»disBufãrR—d
(
»disCÚ‹xt
 *
c
) {

795 
buf
[1024*16];

796 
Ä—d
;

799 ià(
c
->
”r
)

800  
REDIS_ERR
;

803 
Ä—d
 = 
	`»ad
(
c
->
fd
,
buf
,(buf));

804 ià(
Ä—d
 == -1) {

805 ià((
”ºo
 =ğ
EAGAIN
 && !(
c
->
æags
 & 
REDIS_BLOCK
)è|| (”ºØ=ğ
EINTR
)) {

808 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_IO
,
NULL
);

809  
REDIS_ERR
;

811 } ià(
Ä—d
 == 0) {

812 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_EOF
,"Server closedhe connection");

813  
REDIS_ERR
;

815 ià(
	`»disR—d”F“d
(
c
->
»ad”
,
buf
,
Ä—d
è!ğ
REDIS_OK
) {

816 
	`__»disS‘E¼Ü
(
c
,c->
»ad”
->
”r
,c->»ad”->
”r¡r
);

817  
REDIS_ERR
;

820  
REDIS_OK
;

821 
	}
}

832 
	$»disBufãrWr™e
(
»disCÚ‹xt
 *
c
, *
dÚe
) {

833 
nwr™‹n
;

836 ià(
c
->
”r
)

837  
REDIS_ERR
;

839 ià(
	`sd¦’
(
c
->
obuf
) > 0) {

840 
nwr™‹n
 = 
	`wr™e
(
c
->
fd
,c->
obuf
,
	`sd¦’
(c->obuf));

841 ià(
nwr™‹n
 == -1) {

842 ià((
”ºo
 =ğ
EAGAIN
 && !(
c
->
æags
 & 
REDIS_BLOCK
)è|| (”ºØ=ğ
EINTR
)) {

845 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_IO
,
NULL
);

846  
REDIS_ERR
;

848 } ià(
nwr™‹n
 > 0) {

849 ià(
nwr™‹n
 =ğ(sigÃd)
	`sd¦’
(
c
->
obuf
)) {

850 
	`sdsä“
(
c
->
obuf
);

851 
c
->
obuf
 = 
	`sd£m±y
();

853 
	`sd¤ªge
(
c
->
obuf
,
nwr™‹n
,-1);

857 ià(
dÚe
 !ğ
NULL
è*dÚğ(
	`sd¦’
(
c
->
obuf
) == 0);

858  
REDIS_OK
;

859 
	}
}

863 
	$»disG‘R•lyFromR—d”
(
»disCÚ‹xt
 *
c
, **
»¶y
) {

864 ià(
	`»disR—d”G‘R•ly
(
c
->
»ad”
,
»¶y
è=ğ
REDIS_ERR
) {

865 
	`__»disS‘E¼Ü
(
c
,c->
»ad”
->
”r
,c->»ad”->
”r¡r
);

866  
REDIS_ERR
;

868  
REDIS_OK
;

869 
	}
}

871 
	$»disG‘R•ly
(
»disCÚ‹xt
 *
c
, **
»¶y
) {

872 
wdÚe
 = 0;

873 *
aux
 = 
NULL
;

876 ià(
	`»disG‘R•lyFromR—d”
(
c
,&
aux
è=ğ
REDIS_ERR
)

877  
REDIS_ERR
;

880 ià(
aux
 =ğ
NULL
 && 
c
->
æags
 & 
REDIS_BLOCK
) {

883 ià(
	`»disBufãrWr™e
(
c
,&
wdÚe
è=ğ
REDIS_ERR
)

884  
REDIS_ERR
;

885 } !
wdÚe
);

889 ià(
	`»disBufãrR—d
(
c
è=ğ
REDIS_ERR
)

890  
REDIS_ERR
;

891 ià(
	`»disG‘R•lyFromR—d”
(
c
,&
aux
è=ğ
REDIS_ERR
)

892  
REDIS_ERR
;

893 } 
aux
 =ğ
NULL
);

897 ià(
»¶y
 !ğ
NULL
è*»¶y = 
aux
;

898  
REDIS_OK
;

899 
	}
}

908 
	$__»disAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
cmd
, 
size_t
 
Ën
) {

909 
sds
 
Ãwbuf
;

911 
Ãwbuf
 = 
	`sdsÿ’
(
c
->
obuf
,
cmd
,
Ën
);

912 ià(
Ãwbuf
 =ğ
NULL
) {

913 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OOM
,"Out of memory");

914  
REDIS_ERR
;

917 
c
->
obuf
 = 
Ãwbuf
;

918  
REDIS_OK
;

919 
	}
}

921 
	$»disAµ’dFÜm©‹dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
cmd
, 
size_t
 
Ën
) {

923 ià(
	`__»disAµ’dCommªd
(
c
, 
cmd
, 
Ën
è!ğ
REDIS_OK
) {

924  
REDIS_ERR
;

927  
REDIS_OK
;

928 
	}
}

930 
	$»disvAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
) {

931 *
cmd
;

932 
Ën
;

934 
Ën
 = 
	`»disvFÜm©Commªd
(&
cmd
,
fÜm©
,
­
);

935 ià(
Ën
 == -1) {

936 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OOM
,"Out of memory");

937  
REDIS_ERR
;

938 } ià(
Ën
 == -2) {

939 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,"Invalid format string");

940  
REDIS_ERR
;

943 ià(
	`__»disAµ’dCommªd
(
c
,
cmd
,
Ën
è!ğ
REDIS_OK
) {

944 
	`ä“
(
cmd
);

945  
REDIS_ERR
;

948 
	`ä“
(
cmd
);

949  
REDIS_OK
;

950 
	}
}

952 
	$»disAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, ...) {

953 
va_li¡
 
­
;

954 
»t
;

956 
	`va_¡¬t
(
­
,
fÜm©
);

957 
»t
 = 
	`»disvAµ’dCommªd
(
c
,
fÜm©
,
­
);

958 
	`va_’d
(
­
);

959  
»t
;

960 
	}
}

962 
	$»disAµ’dCommªdArgv
(
»disCÚ‹xt
 *
c
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
) {

963 
sds
 
cmd
;

964 
Ën
;

966 
Ën
 = 
	`»disFÜm©SdsCommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
¬gvËn
);

967 ià(
Ën
 == -1) {

968 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OOM
,"Out of memory");

969  
REDIS_ERR
;

972 ià(
	`__»disAµ’dCommªd
(
c
,
cmd
,
Ën
è!ğ
REDIS_OK
) {

973 
	`sdsä“
(
cmd
);

974  
REDIS_ERR
;

977 
	`sdsä“
(
cmd
);

978  
REDIS_OK
;

979 
	}
}

992 *
	$__»disBlockFÜR•ly
(
»disCÚ‹xt
 *
c
) {

993 *
»¶y
;

995 ià(
c
->
æags
 & 
REDIS_BLOCK
) {

996 ià(
	`»disG‘R•ly
(
c
,&
»¶y
è!ğ
REDIS_OK
)

997  
NULL
;

998  
»¶y
;

1000  
NULL
;

1001 
	}
}

1003 *
	$»disvCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
) {

1004 ià(
	`»disvAµ’dCommªd
(
c
,
fÜm©
,
­
è!ğ
REDIS_OK
)

1005  
NULL
;

1006  
	`__»disBlockFÜR•ly
(
c
);

1007 
	}
}

1009 *
	$»disCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, ...) {

1010 
va_li¡
 
­
;

1011 *
»¶y
 = 
NULL
;

1012 
	`va_¡¬t
(
­
,
fÜm©
);

1013 
»¶y
 = 
	`»disvCommªd
(
c
,
fÜm©
,
­
);

1014 
	`va_’d
(
­
);

1015  
»¶y
;

1016 
	}
}

1018 *
	$»disCommªdArgv
(
»disCÚ‹xt
 *
c
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
) {

1019 ià(
	`»disAµ’dCommªdArgv
(
c
,
¬gc
,
¬gv
,
¬gvËn
è!ğ
REDIS_OK
)

1020  
NULL
;

1021  
	`__»disBlockFÜR•ly
(
c
);

1022 
	}
}

	@deps/hiredis/hiredis.h

34 #iâdeà
__HIREDIS_H


35 
	#__HIREDIS_H


	)

36 
	~"»ad.h
"

37 
	~<¡d¬g.h
>

38 
	~<sys/time.h
>

39 
	~<¡dšt.h
>

40 
	~"sds.h
"

42 
	#HIREDIS_MAJOR
 0

	)

43 
	#HIREDIS_MINOR
 13

	)

44 
	#HIREDIS_PATCH
 3

	)

45 
	#HIREDIS_SONAME
 0.13

	)

49 
	#REDIS_BLOCK
 0x1

	)

53 
	#REDIS_CONNECTED
 0x2

	)

59 
	#REDIS_DISCONNECTING
 0x4

	)

63 
	#REDIS_FREEING
 0x8

	)

66 
	#REDIS_IN_CALLBACK
 0x10

	)

69 
	#REDIS_SUBSCRIBED
 0x20

	)

72 
	#REDIS_MONITORING
 0x40

	)

75 
	#REDIS_REUSEADDR
 0x80

	)

77 
	#REDIS_KEEPALIVE_INTERVAL
 15

	)

81 
	#REDIS_CONNECT_RETRIES
 10

	)

86 #iâdeà
_GNU_SOURCE


88 
	#__»dis_¡»¼Ü_r
(
”ºo
, 
buf
, 
Ën
) \

90 
	`¡»¼Ü_r
((
”ºo
), (
buf
), (
Ën
)); \

91 } 0)

	)

94 
	#__»dis_¡»¼Ü_r
(
”ºo
, 
buf
, 
Ën
) \

96 *
”r_¡r
 = 
	`¡»¼Ü_r
((
”ºo
), (
buf
), (
Ën
)); \

100 ià(
”r_¡r
 !ğ(
buf
)) { \

101 
	`¡ºıy
((
buf
), 
”r_¡r
, ((
Ën
) - 1)); \

102 
buf
[(
Ën
)-1] = '\0'; \

104 } 0)

	)

107 #ifdeà
__ılu¥lus


112 
	s»disR•ly
 {

113 
ty³
;

114 
š‹g”
;

115 
size_t
 
Ën
;

116 *
¡r
;

117 
size_t
 
–em’ts
;

118 
»disR•ly
 **
–em’t
;

119 } 
	t»disR•ly
;

121 
»disR—d”
 *
»disR—d”C»©e
();

124 
ä“R•lyObjeù
(*
»¶y
);

127 
»disvFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

128 
»disFÜm©Commªd
(**
rg‘
, cÚ¡ *
fÜm©
, ...);

129 
»disFÜm©CommªdArgv
(**
rg‘
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

130 
»disFÜm©SdsCommªdArgv
(
sds
 *
rg‘
, 
¬gc
, cÚ¡ ** 
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

131 
»disF»eCommªd
(*
cmd
);

132 
»disF»eSdsCommªd
(
sds
 
cmd
);

134 
	e»disCÚÃùiÚTy³
 {

135 
REDIS_CONN_TCP
,

136 
REDIS_CONN_UNIX


140 
	s»disCÚ‹xt
 {

141 
”r
;

142 
”r¡r
[128];

143 
fd
;

144 
æags
;

145 *
obuf
;

146 
»disR—d”
 *
»ad”
;

148 
»disCÚÃùiÚTy³
 
cÚÃùiÚ_ty³
;

149 
timev®
 *
timeout
;

152 *
ho¡
;

153 *
sourû_addr
;

154 
pÜt
;

155 } 
tı
;

158 *
·th
;

159 } 
unix_sock
;

161 } 
	t»disCÚ‹xt
;

163 
»disCÚ‹xt
 *
»disCÚÃù
(cÚ¡ *

, 
pÜt
);

164 
»disCÚ‹xt
 *
»disCÚÃùW™hTimeout
(cÚ¡ *

, 
pÜt
, cÚ¡ 
timev®
 
tv
);

165 
»disCÚ‹xt
 *
»disCÚÃùNÚBlock
(cÚ¡ *

, 
pÜt
);

166 
»disCÚ‹xt
 *
»disCÚÃùBšdNÚBlock
(cÚ¡ *

, 
pÜt
,

167 cÚ¡ *
sourû_addr
);

168 
»disCÚ‹xt
 *
»disCÚÃùBšdNÚBlockW™hReu£
(cÚ¡ *

, 
pÜt
,

169 cÚ¡ *
sourû_addr
);

170 
»disCÚ‹xt
 *
»disCÚÃùUnix
(cÚ¡ *
·th
);

171 
»disCÚ‹xt
 *
»disCÚÃùUnixW™hTimeout
(cÚ¡ *
·th
, cÚ¡ 
timev®
 
tv
);

172 
»disCÚ‹xt
 *
»disCÚÃùUnixNÚBlock
(cÚ¡ *
·th
);

173 
»disCÚ‹xt
 *
»disCÚÃùFd
(
fd
);

184 
»disRecÚÃù
(
»disCÚ‹xt
 *
c
);

186 
»disS‘Timeout
(
»disCÚ‹xt
 *
c
, cÚ¡ 
timev®
 
tv
);

187 
»disEÇbËK“pAlive
(
»disCÚ‹xt
 *
c
);

188 
»disF»e
(
»disCÚ‹xt
 *
c
);

189 
»disF»eK“pFd
(
»disCÚ‹xt
 *
c
);

190 
»disBufãrR—d
(
»disCÚ‹xt
 *
c
);

191 
»disBufãrWr™e
(
»disCÚ‹xt
 *
c
, *
dÚe
);

197 
»disG‘R•ly
(
»disCÚ‹xt
 *
c
, **
»¶y
);

198 
»disG‘R•lyFromR—d”
(
»disCÚ‹xt
 *
c
, **
»¶y
);

202 
»disAµ’dFÜm©‹dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
cmd
, 
size_t
 
Ën
);

206 
»disvAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

207 
»disAµ’dCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, ...);

208 
»disAµ’dCommªdArgv
(
»disCÚ‹xt
 *
c
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

215 *
»disvCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

216 *
»disCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fÜm©
, ...);

217 *
»disCommªdArgv
(
»disCÚ‹xt
 *
c
, 
¬gc
, cÚ¡ **
¬gv
, cÚ¡ 
size_t
 *
¬gvËn
);

219 #ifdeà
__ılu¥lus


	@deps/hiredis/net.c

35 
	~"fmaüos.h
"

36 
	~<sys/ty³s.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/£Ëù.h
>

39 
	~<sys/un.h
>

40 
	~<Ãtš‘/š.h
>

41 
	~<Ãtš‘/tı.h
>

42 
	~<¬·/š‘.h
>

43 
	~<uni¡d.h
>

44 
	~<fú.h
>

45 
	~<¡ršg.h
>

46 
	~<Ãtdb.h
>

47 
	~<”ºo.h
>

48 
	~<¡d¬g.h
>

49 
	~<¡dio.h
>

50 
	~<pŞl.h
>

51 
	~<lim™s.h
>

52 
	~<¡dlib.h
>

54 
	~"Ãt.h
"

55 
	~"sds.h
"

58 
__»disS‘E¼Ü
(
»disCÚ‹xt
 *
c
, 
ty³
, cÚ¡ *
¡r
);

60 
	$»disCÚ‹xtClo£Fd
(
»disCÚ‹xt
 *
c
) {

61 ià(
c
 && c->
fd
 >= 0) {

62 
	`şo£
(
c
->
fd
);

63 
c
->
fd
 = -1;

65 
	}
}

67 
	$__»disS‘E¼ÜFromE¼no
(
»disCÚ‹xt
 *
c
, 
ty³
, cÚ¡ *
´efix
) {

68 
buf
[128] = { 0 };

69 
size_t
 
Ën
 = 0;

71 ià(
´efix
 !ğ
NULL
)

72 
Ën
 = 
	`¢´štf
(
buf
,(buf),"%s: ",
´efix
);

73 
	`__»dis_¡»¼Ü_r
(
”ºo
, (*)(
buf
 + 
Ën
), (buf) -†en);

74 
	`__»disS‘E¼Ü
(
c
,
ty³
,
buf
);

75 
	}
}

77 
	$»disS‘Reu£Addr
(
»disCÚ‹xt
 *
c
) {

78 
Ú
 = 1;

79 ià(
	`£tsockİt
(
c
->
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
Ú
, (on)) == -1) {

80 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,
NULL
);

81 
	`»disCÚ‹xtClo£Fd
(
c
);

82  
REDIS_ERR
;

84  
REDIS_OK
;

85 
	}
}

87 
	$»disC»©eSock‘
(
»disCÚ‹xt
 *
c
, 
ty³
) {

88 
s
;

89 ià((
s
 = 
	`sock‘
(
ty³
, 
SOCK_STREAM
, 0)) == -1) {

90 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,
NULL
);

91  
REDIS_ERR
;

93 
c
->
fd
 = 
s
;

94 ià(
ty³
 =ğ
AF_INET
) {

95 ià(
	`»disS‘Reu£Addr
(
c
è=ğ
REDIS_ERR
) {

96  
REDIS_ERR
;

99  
REDIS_OK
;

100 
	}
}

102 
	$»disS‘Blockšg
(
»disCÚ‹xt
 *
c
, 
blockšg
) {

103 
æags
;

108 ià((
æags
 = 
	`fú
(
c
->
fd
, 
F_GETFL
)) == -1) {

109 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"fcntl(F_GETFL)");

110 
	`»disCÚ‹xtClo£Fd
(
c
);

111  
REDIS_ERR
;

114 ià(
blockšg
)

115 
æags
 &ğ~
O_NONBLOCK
;

117 
æags
 |ğ
O_NONBLOCK
;

119 ià(
	`fú
(
c
->
fd
, 
F_SETFL
, 
æags
) == -1) {

120 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"fcntl(F_SETFL)");

121 
	`»disCÚ‹xtClo£Fd
(
c
);

122  
REDIS_ERR
;

124  
REDIS_OK
;

125 
	}
}

127 
	$»disK“pAlive
(
»disCÚ‹xt
 *
c
, 
š‹rv®
) {

128 
v®
 = 1;

129 
fd
 = 
c
->fd;

131 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
v®
, (val)) == -1){

132 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`¡»¼Ü
(
”ºo
));

133  
REDIS_ERR
;

136 
v®
 = 
š‹rv®
;

138 #ifdeà
_OSX


139 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPALIVE
, &
v®
, (val)) < 0) {

140 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`¡»¼Ü
(
”ºo
));

141  
REDIS_ERR
;

144 #ià
	`defšed
(
__GLIBC__
è&& !defšed(
__F»eBSD_k”Ãl__
)

145 
v®
 = 
š‹rv®
;

146 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPIDLE
, &
v®
, (val)) < 0) {

147 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`¡»¼Ü
(
”ºo
));

148  
REDIS_ERR
;

151 
v®
 = 
š‹rv®
/3;

152 ià(
v®
 == 0) val = 1;

153 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPINTVL
, &
v®
, (val)) < 0) {

154 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`¡»¼Ü
(
”ºo
));

155  
REDIS_ERR
;

158 
v®
 = 3;

159 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPCNT
, &
v®
, (val)) < 0) {

160 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`¡»¼Ü
(
”ºo
));

161  
REDIS_ERR
;

166  
REDIS_OK
;

167 
	}
}

169 
	$»disS‘TıNoD–ay
(
»disCÚ‹xt
 *
c
) {

170 
yes
 = 1;

171 ià(
	`£tsockİt
(
c
->
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
yes
, (yes)) == -1) {

172 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"setsockopt(TCP_NODELAY)");

173 
	`»disCÚ‹xtClo£Fd
(
c
);

174  
REDIS_ERR
;

176  
REDIS_OK
;

177 
	}
}

179 
	#__MAX_MSEC
 (((
LONG_MAX
è- 999è/ 1000)

	)

181 
	$»disCÚ‹xtTimeoutM£c
(
»disCÚ‹xt
 *
c
, *
»suÉ
)

183 cÚ¡ 
timev®
 *
timeout
 = 
c
->timeout;

184 
m£c
 = -1;

187 ià(
timeout
 !ğ
NULL
) {

188 ià(
timeout
->
tv_u£c
 > 1000000 ||imeout->
tv_£c
 > 
__MAX_MSEC
) {

189 *
»suÉ
 = 
m£c
;

190  
REDIS_ERR
;

193 
m£c
 = (
timeout
->
tv_£c
 * 1000è+ (Ñimeout->
tv_u£c
 + 999) / 1000);

195 ià(
m£c
 < 0 || m£ø> 
INT_MAX
) {

196 
m£c
 = 
INT_MAX
;

200 *
»suÉ
 = 
m£c
;

201  
REDIS_OK
;

202 
	}
}

204 
	$»disCÚ‹xtWa™R—dy
(
»disCÚ‹xt
 *
c
, 
m£c
) {

205 
pŞlfd
 
wfd
[1];

207 
wfd
[0].
fd
 = 
c
->fd;

208 
wfd
[0].
ev’ts
 = 
POLLOUT
;

210 ià(
”ºo
 =ğ
EINPROGRESS
) {

211 
»s
;

213 ià((
»s
 = 
	`pŞl
(
wfd
, 1, 
m£c
)) == -1) {

214 
	`__»disS‘E¼ÜFromE¼no
(
c
, 
REDIS_ERR_IO
, "poll(2)");

215 
	`»disCÚ‹xtClo£Fd
(
c
);

216  
REDIS_ERR
;

217 } ià(
»s
 == 0) {

218 
”ºo
 = 
ETIMEDOUT
;

219 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,
NULL
);

220 
	`»disCÚ‹xtClo£Fd
(
c
);

221  
REDIS_ERR
;

224 ià(
	`»disCheckSock‘E¼Ü
(
c
è!ğ
REDIS_OK
)

225  
REDIS_ERR
;

227  
REDIS_OK
;

230 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,
NULL
);

231 
	`»disCÚ‹xtClo£Fd
(
c
);

232  
REDIS_ERR
;

233 
	}
}

235 
	$»disCheckSock‘E¼Ü
(
»disCÚ‹xt
 *
c
) {

236 
”r
 = 0;

237 
sockËn_t
 
”¾’
 = (
”r
);

239 ià(
	`g‘sockİt
(
c
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
”r
, &
”¾’
) == -1) {

240 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"getsockopt(SO_ERROR)");

241  
REDIS_ERR
;

244 ià(
”r
) {

245 
”ºo
 = 
”r
;

246 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,
NULL
);

247  
REDIS_ERR
;

250  
REDIS_OK
;

251 
	}
}

253 
	$»disCÚ‹xtS‘Timeout
(
»disCÚ‹xt
 *
c
, cÚ¡ 
timev®
 
tv
) {

254 ià(
	`£tsockİt
(
c
->
fd
,
SOL_SOCKET
,
SO_RCVTIMEO
,&
tv
,(tv)) == -1) {

255 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"setsockopt(SO_RCVTIMEO)");

256  
REDIS_ERR
;

258 ià(
	`£tsockİt
(
c
->
fd
,
SOL_SOCKET
,
SO_SNDTIMEO
,&
tv
,(tv)) == -1) {

259 
	`__»disS‘E¼ÜFromE¼no
(
c
,
REDIS_ERR_IO
,"setsockopt(SO_SNDTIMEO)");

260  
REDIS_ERR
;

262  
REDIS_OK
;

263 
	}
}

265 
	$_»disCÚ‹xtCÚÃùTı
(
»disCÚ‹xt
 *
c
, cÚ¡ *
addr
, 
pÜt
,

266 cÚ¡ 
timev®
 *
timeout
,

267 cÚ¡ *
sourû_addr
) {

268 
s
, 
rv
, 
n
;

269 
_pÜt
[6];

270 
addršfo
 
hšts
, *
£rvšfo
, *
b£rvšfo
, *
p
, *
b
;

271 
blockšg
 = (
c
->
æags
 & 
REDIS_BLOCK
);

272 
»u£addr
 = (
c
->
æags
 & 
REDIS_REUSEADDR
);

273 
»u£s
 = 0;

274 
timeout_m£c
 = -1;

276 
£rvšfo
 = 
NULL
;

277 
c
->
cÚÃùiÚ_ty³
 = 
REDIS_CONN_TCP
;

278 
c
->
tı
.
pÜt
 =…ort;

287 ià(
c
->
tı
.
ho¡
 !ğ
addr
) {

288 ià(
c
->
tı
.
ho¡
)

289 
	`ä“
(
c
->
tı
.
ho¡
);

291 
c
->
tı
.
ho¡
 = 
	`¡rdup
(
addr
);

294 ià(
timeout
) {

295 ià(
c
->
timeout
 !=imeout) {

296 ià(
c
->
timeout
 =ğ
NULL
)

297 
c
->
timeout
 = 
	`m®loc
((
timev®
));

299 
	`memıy
(
c
->
timeout
,imeout, (
timev®
));

302 ià(
c
->
timeout
)

303 
	`ä“
(
c
->
timeout
);

304 
c
->
timeout
 = 
NULL
;

307 ià(
	`»disCÚ‹xtTimeoutM£c
(
c
, &
timeout_m£c
è!ğ
REDIS_OK
) {

308 
	`__»disS‘E¼Ü
(
c
, 
REDIS_ERR_IO
, "Invalidimeout specified");

309 
”rÜ
;

312 ià(
sourû_addr
 =ğ
NULL
) {

313 
	`ä“
(
c
->
tı
.
sourû_addr
);

314 
c
->
tı
.
sourû_addr
 = 
NULL
;

315 } ià(
c
->
tı
.
sourû_addr
 != source_addr) {

316 
	`ä“
(
c
->
tı
.
sourû_addr
);

317 
c
->
tı
.
sourû_addr
 = 
	`¡rdup
(source_addr);

320 
	`¢´štf
(
_pÜt
, 6, "%d", 
pÜt
);

321 
	`mem£t
(&
hšts
,0,(hints));

322 
hšts
.
ai_çmy
 = 
AF_INET
;

323 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

330 ià((
rv
 = 
	`g‘addršfo
(
c
->
tı
.
ho¡
,
_pÜt
,&
hšts
,&
£rvšfo
)) != 0) {

331 
hšts
.
ai_çmy
 = 
AF_INET6
;

332 ià((
rv
 = 
	`g‘addršfo
(
addr
,
_pÜt
,&
hšts
,&
£rvšfo
)) != 0) {

333 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
	`gai_¡»¼Ü
(
rv
));

334  
REDIS_ERR
;

337 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

338 
add¼‘ry
:

339 ià((
s
 = 
	`sock‘
(
p
->
ai_çmy
,p->
ai_sockty³
,p->
ai_´ÙocŞ
)) == -1)

342 
c
->
fd
 = 
s
;

343 ià(
	`»disS‘Blockšg
(
c
,0è!ğ
REDIS_OK
)

344 
”rÜ
;

345 ià(
c
->
tı
.
sourû_addr
) {

346 
bound
 = 0;

348 ià((
rv
 = 
	`g‘addršfo
(
c
->
tı
.
sourû_addr
, 
NULL
, &
hšts
, &
b£rvšfo
)) != 0) {

349 
buf
[128];

350 
	`¢´štf
(
buf
,(buf),"Cª'ˆg‘‡ddr: %s",
	`gai_¡»¼Ü
(
rv
));

351 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
buf
);

352 
”rÜ
;

355 ià(
»u£addr
) {

356 
n
 = 1;

357 ià(
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*è&
n
,

358 (
n
)) < 0) {

359 
”rÜ
;

363 
b
 = 
b£rvšfo
; b !ğ
NULL
; b = b->
ai_Ãxt
) {

364 ià(
	`bšd
(
s
,
b
->
ai_addr
,b->
ai_add¾’
) != -1) {

365 
bound
 = 1;

369 
	`ä“addršfo
(
b£rvšfo
);

370 ià(!
bound
) {

371 
buf
[128];

372 
	`¢´štf
(
buf
,(buf),"Cª'ˆbšd sock‘: %s",
	`¡»¼Ü
(
”ºo
));

373 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
buf
);

374 
”rÜ
;

377 ià(
	`cÚÃù
(
s
,
p
->
ai_addr
,p->
ai_add¾’
) == -1) {

378 ià(
”ºo
 =ğ
EHOSTUNREACH
) {

379 
	`»disCÚ‹xtClo£Fd
(
c
);

381 } ià(
”ºo
 =ğ
EINPROGRESS
 && !
blockšg
) {

383 } ià(
”ºo
 =ğ
EADDRNOTAVAIL
 && 
»u£addr
) {

384 ià(++
»u£s
 >ğ
REDIS_CONNECT_RETRIES
) {

385 
”rÜ
;

387 
	`»disCÚ‹xtClo£Fd
(
c
);

388 
add¼‘ry
;

391 ià(
	`»disCÚ‹xtWa™R—dy
(
c
,
timeout_m£c
è!ğ
REDIS_OK
)

392 
”rÜ
;

395 ià(
blockšg
 && 
	`»disS‘Blockšg
(
c
,1è!ğ
REDIS_OK
)

396 
”rÜ
;

397 ià(
	`»disS‘TıNoD–ay
(
c
è!ğ
REDIS_OK
)

398 
”rÜ
;

400 
c
->
æags
 |ğ
REDIS_CONNECTED
;

401 
rv
 = 
REDIS_OK
;

402 
’d
;

404 ià(
p
 =ğ
NULL
) {

405 
buf
[128];

406 
	`¢´štf
(
buf
,(buf),"Cª'ˆü—‹ sock‘: %s",
	`¡»¼Ü
(
”ºo
));

407 
	`__»disS‘E¼Ü
(
c
,
REDIS_ERR_OTHER
,
buf
);

408 
”rÜ
;

411 
”rÜ
:

412 
rv
 = 
REDIS_ERR
;

413 
’d
:

414 
	`ä“addršfo
(
£rvšfo
);

415  
rv
;

416 
	}
}

418 
	$»disCÚ‹xtCÚÃùTı
(
»disCÚ‹xt
 *
c
, cÚ¡ *
addr
, 
pÜt
,

419 cÚ¡ 
timev®
 *
timeout
) {

420  
	`_»disCÚ‹xtCÚÃùTı
(
c
, 
addr
, 
pÜt
, 
timeout
, 
NULL
);

421 
	}
}

423 
	$»disCÚ‹xtCÚÃùBšdTı
(
»disCÚ‹xt
 *
c
, cÚ¡ *
addr
, 
pÜt
,

424 cÚ¡ 
timev®
 *
timeout
,

425 cÚ¡ *
sourû_addr
) {

426  
	`_»disCÚ‹xtCÚÃùTı
(
c
, 
addr
, 
pÜt
, 
timeout
, 
sourû_addr
);

427 
	}
}

429 
	$»disCÚ‹xtCÚÃùUnix
(
»disCÚ‹xt
 *
c
, cÚ¡ *
·th
, cÚ¡ 
timev®
 *
timeout
) {

430 
blockšg
 = (
c
->
æags
 & 
REDIS_BLOCK
);

431 
sockaddr_un
 
§
;

432 
timeout_m£c
 = -1;

434 ià(
	`»disC»©eSock‘
(
c
,
AF_LOCAL
) < 0)

435  
REDIS_ERR
;

436 ià(
	`»disS‘Blockšg
(
c
,0è!ğ
REDIS_OK
)

437  
REDIS_ERR
;

439 
c
->
cÚÃùiÚ_ty³
 = 
REDIS_CONN_UNIX
;

440 ià(
c
->
unix_sock
.
·th
 !=…ath)

441 
c
->
unix_sock
.
·th
 = 
	`¡rdup
(path);

443 ià(
timeout
) {

444 ià(
c
->
timeout
 !=imeout) {

445 ià(
c
->
timeout
 =ğ
NULL
)

446 
c
->
timeout
 = 
	`m®loc
((
timev®
));

448 
	`memıy
(
c
->
timeout
,imeout, (
timev®
));

451 ià(
c
->
timeout
)

452 
	`ä“
(
c
->
timeout
);

453 
c
->
timeout
 = 
NULL
;

456 ià(
	`»disCÚ‹xtTimeoutM£c
(
c
,&
timeout_m£c
è!ğ
REDIS_OK
)

457  
REDIS_ERR
;

459 
§
.
sun_çmy
 = 
AF_LOCAL
;

460 
	`¡ºıy
(
§
.
sun_·th
,
·th
,(sa.sun_path)-1);

461 ià(
	`cÚÃù
(
c
->
fd
, (
sockaddr
*)&
§
, (sa)) == -1) {

462 ià(
”ºo
 =ğ
EINPROGRESS
 && !
blockšg
) {

465 ià(
	`»disCÚ‹xtWa™R—dy
(
c
,
timeout_m£c
è!ğ
REDIS_OK
)

466  
REDIS_ERR
;

471 ià(
blockšg
 && 
	`»disS‘Blockšg
(
c
,1è!ğ
REDIS_OK
)

472  
REDIS_ERR
;

474 
c
->
æags
 |ğ
REDIS_CONNECTED
;

475  
REDIS_OK
;

476 
	}
}

	@deps/hiredis/net.h

35 #iâdeà
__NET_H


36 
	#__NET_H


	)

38 
	~"hœedis.h
"

40 #ià
defšed
(
__sun
)

41 
	#AF_LOCAL
 
AF_UNIX


	)

44 
»disCheckSock‘E¼Ü
(
»disCÚ‹xt
 *
c
);

45 
»disCÚ‹xtS‘Timeout
(
»disCÚ‹xt
 *
c
, cÚ¡ 
timev®
 
tv
);

46 
»disCÚ‹xtCÚÃùTı
(
»disCÚ‹xt
 *
c
, cÚ¡ *
addr
, 
pÜt
, cÚ¡ 
timev®
 *
timeout
);

47 
»disCÚ‹xtCÚÃùBšdTı
(
»disCÚ‹xt
 *
c
, cÚ¡ *
addr
, 
pÜt
,

48 cÚ¡ 
timev®
 *
timeout
,

49 cÚ¡ *
sourû_addr
);

50 
»disCÚ‹xtCÚÃùUnix
(
»disCÚ‹xt
 *
c
, cÚ¡ *
·th
, cÚ¡ 
timev®
 *
timeout
);

51 
»disK“pAlive
(
»disCÚ‹xt
 *
c
, 
š‹rv®
);

	@deps/hiredis/read.c

33 
	~"fmaüos.h
"

34 
	~<¡ršg.h
>

35 
	~<¡dlib.h
>

36 #iâdeà
_MSC_VER


37 
	~<uni¡d.h
>

39 
	~<as£¹.h
>

40 
	~<”ºo.h
>

41 
	~<ùy³.h
>

43 
	~"»ad.h
"

44 
	~"sds.h
"

46 
	$__»disR—d”S‘E¼Ü
(
»disR—d”
 *
r
, 
ty³
, cÚ¡ *
¡r
) {

47 
size_t
 
Ën
;

49 ià(
r
->
»¶y
 !ğ
NULL
 &&„->
â
 &&„->â->
ä“Objeù
) {

50 
r
->
â
->
	`ä“Objeù
Ô->
»¶y
);

51 
r
->
»¶y
 = 
NULL
;

55 ià(
r
->
buf
 !ğ
NULL
) {

56 
	`sdsä“
(
r
->
buf
);

57 
r
->
buf
 = 
NULL
;

58 
r
->
pos
 =„->
Ën
 = 0;

62 
r
->
ridx
 = -1;

65 
r
->
”r
 = 
ty³
;

66 
Ën
 = 
	`¡¾’
(
¡r
);

67 
Ën
 =†’ < ((
r
->
”r¡r
)-1) ?†en : ((r->errstr)-1);

68 
	`memıy
(
r
->
”r¡r
,
¡r
,
Ën
);

69 
r
->
”r¡r
[
Ën
] = '\0';

70 
	}
}

72 
size_t
 
	$ch¹os
(*
buf
, 
size_t
 
size
, 
by‹
) {

73 
size_t
 
Ën
 = 0;

75 
by‹
) {

78 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\%c\"",
by‹
);

80 '\n': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\n\""); ;

81 '\r': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\r\""); ;

82 '\t': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\t\""); ;

83 '\a': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\a\""); ;

84 '\b': 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\b\""); ;

86 ià(
	`i¥ršt
(
by‹
))

87 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"%c\"",
by‹
);

89 
Ën
 = 
	`¢´štf
(
buf
,
size
,"\"\\x%02x\"",()
by‹
);

93  
Ën
;

94 
	}
}

96 
	$__»disR—d”S‘E¼ÜPrÙocŞBy‹
(
»disR—d”
 *
r
, 
by‹
) {

97 
cbuf
[8], 
sbuf
[128];

99 
	`ch¹os
(
cbuf
,(cbuf),
by‹
);

100 
	`årštf
(
¡d”r
, "%s", "printingƒrror");

101 
	`¢´štf
(
sbuf
,(sbuf),

102 "PrÙocŞƒ¼Ü, gÙ % a »¶yy³ by‹", 
cbuf
);

103 
	`__»disR—d”S‘E¼Ü
(
r
,
REDIS_ERR_PROTOCOL
,
sbuf
);

104 
	}
}

106 
	$__»disR—d”S‘E¼ÜOOM
(
»disR—d”
 *
r
) {

107 
	`__»disR—d”S‘E¼Ü
(
r
,
REDIS_ERR_OOM
,"Out of memory");

108 
	}
}

110 *
	$»adBy‹s
(
»disR—d”
 *
r
, 
by‹s
) {

111 *
p
;

112 ià(
r
->
Ën
-r->
pos
 >ğ
by‹s
) {

113 
p
 = 
r
->
buf
+r->
pos
;

114 
r
->
pos
 +ğ
by‹s
;

115  
p
;

117  
NULL
;

118 
	}
}

121 *
	$£ekNewlše
(*
s
, 
size_t
 
Ën
) {

122 
pos
 = 0;

123 
_Ën
 = 
Ën
-1;

129 
pos
 < 
_Ën
) {

130 
pos
 < 
_Ën
 && 
s
[pos] != '\r')…os++;

131 ià(
pos
==
_Ën
) {

133  
NULL
;

135 ià(
s
[
pos
+1] == '\n') {

137  
s
+
pos
;

140 
pos
++;

144  
NULL
;

145 
	}
}

149 
	$»adLÚgLÚg
(*
s
) {

150 
v
 = 0;

151 
dec
, 
muÉ
 = 1;

152 
c
;

154 ià(*
s
 == '-') {

155 
muÉ
 = -1;

156 
s
++;

157 } ià(*
s
 == '+') {

158 
muÉ
 = 1;

159 
s
++;

162 (
c
 = *(
s
++)) != '\r') {

163 
dec
 = 
c
 - '0';

164 ià(
dec
 >= 0 && dec < 10) {

165 
v
 *= 10;

166 
v
 +ğ
dec
;

173  
muÉ
*
v
;

174 
	}
}

176 *
	$»adLše
(
»disR—d”
 *
r
, *
_Ën
) {

177 *
p
, *
s
;

178 
Ën
;

180 
p
 = 
r
->
buf
+r->
pos
;

181 
s
 = 
	`£ekNewlše
(
p
,(
r
->
Ën
-r->
pos
));

182 ià(
s
 !ğ
NULL
) {

183 
Ën
 = 
s
-(
r
->
buf
+r->
pos
);

184 
r
->
pos
 +ğ
Ën
+2;

185 ià(
_Ën
è*_ËÀğ
Ën
;

186  
p
;

188  
NULL
;

189 
	}
}

191 
	$moveToNextTask
(
»disR—d”
 *
r
) {

192 
»disR—dTask
 *
cur
, *
´v
;

193 
r
->
ridx
 >= 0) {

195 ià(
r
->
ridx
 == 0) {

196 
r
->
ridx
--;

200 
cur
 = &(
r
->
r¡ack
[r->
ridx
]);

201 
´v
 = &(
r
->
r¡ack
[r->
ridx
-1]);

202 
	`as£¹
(
´v
->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

203 ià(
cur
->
idx
 =ğ
´v
->
–em’ts
-1) {

204 
r
->
ridx
--;

207 
	`as£¹
(
cur
->
idx
 < 
´v
->
–em’ts
);

208 
cur
->
ty³
 = -1;

209 
cur
->
–em’ts
 = -1;

210 
cur
->
idx
++;

214 
	}
}

216 
	$´oûssLšeI‹m
(
»disR—d”
 *
r
) {

217 
»disR—dTask
 *
cur
 = &(
r
->
r¡ack
[r->
ridx
]);

218 *
obj
;

219 *
p
;

220 
Ën
;

222 ià((
p
 = 
	`»adLše
(
r
,&
Ën
)è!ğ
NULL
) {

223 ià(
cur
->
ty³
 =ğ
REDIS_REPLY_INTEGER
) {

224 ià(
r
->
â
 &&„->â->
ü—‹IÁeg”
)

225 
obj
 = 
r
->
â
->
	`ü—‹IÁeg”
(
cur
,
	`»adLÚgLÚg
(
p
));

227 
obj
 = (*)
REDIS_REPLY_INTEGER
;

230 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

231 
obj
 = 
r
->
â
->
	`ü—‹SŒšg
(
cur
,
p
,
Ën
);

233 
obj
 = (*)(
size_t
)(
cur
->
ty³
);

236 ià(
obj
 =ğ
NULL
) {

237 
	`__»disR—d”S‘E¼ÜOOM
(
r
);

238  
REDIS_ERR
;

242 ià(
r
->
ridx
 =ğ0èr->
»¶y
 = 
obj
;

243 
	`moveToNextTask
(
r
);

244  
REDIS_OK
;

247  
REDIS_ERR
;

248 
	}
}

250 
	$´oûssBulkI‹m
(
»disR—d”
 *
r
) {

251 
»disR—dTask
 *
cur
 = &(
r
->
r¡ack
[r->
ridx
]);

252 *
obj
 = 
NULL
;

253 *
p
, *
s
;

254 
Ën
;

255 
by‹Ën
;

256 
sucûss
 = 0;

258 
p
 = 
r
->
buf
+r->
pos
;

259 
s
 = 
	`£ekNewlše
(
p
,
r
->
Ën
-r->
pos
);

260 ià(
s
 !ğ
NULL
) {

261 
p
 = 
r
->
buf
+r->
pos
;

262 
by‹Ën
 = 
s
-(
r
->
buf
+r->
pos
)+2;

263 
Ën
 = 
	`»adLÚgLÚg
(
p
);

265 ià(
Ën
 < 0) {

267 ià(
r
->
â
 &&„->â->
ü—‹N
)

268 
obj
 = 
r
->
â
->
	`ü—‹N
(
cur
);

270 
obj
 = (*)
REDIS_REPLY_NIL
;

271 
sucûss
 = 1;

274 
by‹Ën
 +ğ
Ën
+2;

275 ià(
r
->
pos
+
by‹Ën
 <ğr->
Ën
) {

276 ià(
r
->
â
 &&„->â->
ü—‹SŒšg
)

277 
obj
 = 
r
->
â
->
	`ü—‹SŒšg
(
cur
,
s
+2,
Ën
);

279 
obj
 = (*)
REDIS_REPLY_STRING
;

280 
sucûss
 = 1;

285 ià(
sucûss
) {

286 ià(
obj
 =ğ
NULL
) {

287 
	`__»disR—d”S‘E¼ÜOOM
(
r
);

288  
REDIS_ERR
;

291 
r
->
pos
 +ğ
by‹Ën
;

294 ià(
r
->
ridx
 =ğ0èr->
»¶y
 = 
obj
;

295 
	`moveToNextTask
(
r
);

296  
REDIS_OK
;

300  
REDIS_ERR
;

301 
	}
}

303 
	$´oûssMuÉiBulkI‹m
(
»disR—d”
 *
r
) {

304 
»disR—dTask
 *
cur
 = &(
r
->
r¡ack
[r->
ridx
]);

305 *
obj
;

306 *
p
;

307 
–em’ts
;

308 
roÙ
 = 0;

311 ià(
r
->
ridx
 == 8) {

312 
	`__»disR—d”S‘E¼Ü
(
r
,
REDIS_ERR_PROTOCOL
,

314  
REDIS_ERR
;

317 ià((
p
 = 
	`»adLše
(
r
,
NULL
)) != NULL) {

318 
–em’ts
 = 
	`»adLÚgLÚg
(
p
);

319 
roÙ
 = (
r
->
ridx
 == 0);

321 ià(
–em’ts
 == -1) {

322 ià(
r
->
â
 &&„->â->
ü—‹N
)

323 
obj
 = 
r
->
â
->
	`ü—‹N
(
cur
);

325 
obj
 = (*)
REDIS_REPLY_NIL
;

327 ià(
obj
 =ğ
NULL
) {

328 
	`__»disR—d”S‘E¼ÜOOM
(
r
);

329  
REDIS_ERR
;

332 
	`moveToNextTask
(
r
);

334 ià(
r
->
â
 &&„->â->
ü—‹A¼ay
)

335 
obj
 = 
r
->
â
->
	`ü—‹A¼ay
(
cur
,
–em’ts
);

337 
obj
 = (*)
REDIS_REPLY_ARRAY
;

339 ià(
obj
 =ğ
NULL
) {

340 
	`__»disR—d”S‘E¼ÜOOM
(
r
);

341  
REDIS_ERR
;

345 ià(
–em’ts
 > 0) {

346 
cur
->
–em’ts
 =ƒlements;

347 
cur
->
obj
 = obj;

348 
r
->
ridx
++;

349 
r
->
r¡ack
[r->
ridx
].
ty³
 = -1;

350 
r
->
r¡ack
[r->
ridx
].
–em’ts
 = -1;

351 
r
->
r¡ack
[r->
ridx
].
idx
 = 0;

352 
r
->
r¡ack
[r->
ridx
].
obj
 = 
NULL
;

353 
r
->
r¡ack
[r->
ridx
].
·»Á
 = 
cur
;

354 
r
->
r¡ack
[r->
ridx
].
´ivd©a
 =„->privdata;

356 
	`moveToNextTask
(
r
);

361 ià(
roÙ
è
r
->
»¶y
 = 
obj
;

362  
REDIS_OK
;

365  
REDIS_ERR
;

366 
	}
}

368 
	$´oûssI‹m
(
»disR—d”
 *
r
) {

369 
»disR—dTask
 *
cur
 = &(
r
->
r¡ack
[r->
ridx
]);

370 *
p
;

373 ià(
cur
->
ty³
 < 0) {

374 ià((
p
 = 
	`»adBy‹s
(
r
,1)è!ğ
NULL
) {

375 
p
[0]) {

377 
cur
->
ty³
 = 
REDIS_REPLY_ERROR
;

380 
cur
->
ty³
 = 
REDIS_REPLY_STATUS
;

383 
cur
->
ty³
 = 
REDIS_REPLY_INTEGER
;

386 
cur
->
ty³
 = 
REDIS_REPLY_STRING
;

389 
cur
->
ty³
 = 
REDIS_REPLY_ARRAY
;

392 
	`__»disR—d”S‘E¼ÜPrÙocŞBy‹
(
r
,*
p
);

393  
REDIS_ERR
;

397  
REDIS_ERR
;

402 
cur
->
ty³
) {

403 
REDIS_REPLY_ERROR
:

404 
REDIS_REPLY_STATUS
:

405 
REDIS_REPLY_INTEGER
:

406  
	`´oûssLšeI‹m
(
r
);

407 
REDIS_REPLY_STRING
:

408  
	`´oûssBulkI‹m
(
r
);

409 
REDIS_REPLY_ARRAY
:

410  
	`´oûssMuÉiBulkI‹m
(
r
);

412 
	`as£¹
(
NULL
);

413  
REDIS_ERR
;

415 
	}
}

417 
»disR—d”
 *
	$»disR—d”C»©eW™hFunùiÚs
(
»disR•lyObjeùFunùiÚs
 *
â
) {

418 
»disR—d”
 *
r
;

420 
r
 = 
	`ÿÎoc
((
»disR—d”
),1);

421 ià(
r
 =ğ
NULL
)

422  
NULL
;

424 
r
->
”r
 = 0;

425 
r
->
”r¡r
[0] = '\0';

426 
r
->
â
 = fn;

427 
r
->
buf
 = 
	`sd£m±y
();

428 
r
->
maxbuf
 = 
REDIS_READER_MAX_BUF
;

429 ià(
r
->
buf
 =ğ
NULL
) {

430 
	`ä“
(
r
);

431  
NULL
;

434 
r
->
ridx
 = -1;

435  
r
;

436 
	}
}

438 
	$»disR—d”F»e
(
»disR—d”
 *
r
) {

439 ià(
r
->
»¶y
 !ğ
NULL
 &&„->
â
 &&„->â->
ä“Objeù
)

440 
r
->
â
->
	`ä“Objeù
Ô->
»¶y
);

441 ià(
r
->
buf
 !ğ
NULL
)

442 
	`sdsä“
(
r
->
buf
);

443 
	`ä“
(
r
);

444 
	}
}

446 
	$»disR—d”F“d
(
»disR—d”
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

447 
sds
 
Ãwbuf
;

450 ià(
r
->
”r
)

451  
REDIS_ERR
;

454 ià(
buf
 !ğ
NULL
 && 
Ën
 >= 1) {

456 ià(
r
->
Ën
 =ğ0 &&„->
maxbuf
 !ğ0 && 
	`sd§va
Ô->
buf
) >„->maxbuf) {

457 
	`sdsä“
(
r
->
buf
);

458 
r
->
buf
 = 
	`sd£m±y
();

459 
r
->
pos
 = 0;

462 
	`as£¹
(
r
->
buf
 !ğ
NULL
);

465 
Ãwbuf
 = 
	`sdsÿ’
(
r
->
buf
,buf,
Ën
);

466 ià(
Ãwbuf
 =ğ
NULL
) {

467 
	`__»disR—d”S‘E¼ÜOOM
(
r
);

468  
REDIS_ERR
;

471 
r
->
buf
 = 
Ãwbuf
;

472 
r
->
Ën
 = 
	`sd¦’
Ô->
buf
);

475  
REDIS_OK
;

476 
	}
}

478 
	$»disR—d”G‘R•ly
(
»disR—d”
 *
r
, **
»¶y
) {

480 ià(
»¶y
 !ğ
NULL
)

481 *
»¶y
 = 
NULL
;

484 ià(
r
->
”r
)

485  
REDIS_ERR
;

488 ià(
r
->
Ën
 == 0)

489  
REDIS_OK
;

492 ià(
r
->
ridx
 == -1) {

493 
r
->
r¡ack
[0].
ty³
 = -1;

494 
r
->
r¡ack
[0].
–em’ts
 = -1;

495 
r
->
r¡ack
[0].
idx
 = -1;

496 
r
->
r¡ack
[0].
obj
 = 
NULL
;

497 
r
->
r¡ack
[0].
·»Á
 = 
NULL
;

498 
r
->
r¡ack
[0].
´ivd©a
 =„->privdata;

499 
r
->
ridx
 = 0;

503 
r
->
ridx
 >= 0)

504 ià(
	`´oûssI‹m
(
r
è!ğ
REDIS_OK
)

508 ià(
r
->
”r
)

509  
REDIS_ERR
;

513 ià(
r
->
pos
 >= 1024) {

514 
	`sd¤ªge
(
r
->
buf
,r->
pos
,-1);

515 
r
->
pos
 = 0;

516 
r
->
Ën
 = 
	`sd¦’
Ô->
buf
);

520 ià(
r
->
ridx
 == -1) {

521 ià(
»¶y
 !ğ
NULL
)

522 *
»¶y
 = 
r
->reply;

523 
r
->
»¶y
 = 
NULL
;

525  
REDIS_OK
;

526 
	}
}

	@deps/hiredis/read.h

33 #iâdeà
__HIREDIS_READ_H


34 
	#__HIREDIS_READ_H


	)

35 
	~<¡dio.h
>

37 
	#REDIS_ERR
 -1

	)

38 
	#REDIS_OK
 0

	)

44 
	#REDIS_ERR_IO
 1

	)

45 
	#REDIS_ERR_EOF
 3

	)

46 
	#REDIS_ERR_PROTOCOL
 4

	)

47 
	#REDIS_ERR_OOM
 5

	)

48 
	#REDIS_ERR_OTHER
 2

	)

50 
	#REDIS_REPLY_STRING
 1

	)

51 
	#REDIS_REPLY_ARRAY
 2

	)

52 
	#REDIS_REPLY_INTEGER
 3

	)

53 
	#REDIS_REPLY_NIL
 4

	)

54 
	#REDIS_REPLY_STATUS
 5

	)

55 
	#REDIS_REPLY_ERROR
 6

	)

57 
	#REDIS_READER_MAX_BUF
 (1024*16è

	)

59 #ifdeà
__ılu¥lus


63 
	s»disR—dTask
 {

64 
ty³
;

65 
–em’ts
;

66 
idx
;

67 *
obj
;

68 
»disR—dTask
 *
·»Á
;

69 *
´ivd©a
;

70 } 
	t»disR—dTask
;

72 
	s»disR•lyObjeùFunùiÚs
 {

73 *(*
ü—‹SŒšg
)(cÚ¡ 
»disR—dTask
*, *, 
size_t
);

74 *(*
ü—‹A¼ay
)(cÚ¡ 
»disR—dTask
*, );

75 *(*
ü—‹IÁeg”
)(cÚ¡ 
»disR—dTask
*, );

76 *(*
ü—‹N
)(cÚ¡ 
»disR—dTask
*);

77 (*
ä“Objeù
)(*);

78 } 
	t»disR•lyObjeùFunùiÚs
;

80 
	s»disR—d”
 {

81 
”r
;

82 
”r¡r
[128];

84 *
buf
;

85 
size_t
 
pos
;

86 
size_t
 
Ën
;

87 
size_t
 
maxbuf
;

89 
»disR—dTask
 
r¡ack
[9];

90 
ridx
;

91 *
»¶y
;

93 
»disR•lyObjeùFunùiÚs
 *
â
;

94 *
´ivd©a
;

95 } 
	t»disR—d”
;

98 
»disR—d”
 *
»disR—d”C»©eW™hFunùiÚs
(
»disR•lyObjeùFunùiÚs
 *
â
);

99 
»disR—d”F»e
(
»disR—d”
 *
r
);

100 
»disR—d”F“d
(
»disR—d”
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

101 
»disR—d”G‘R•ly
(
»disR—d”
 *
r
, **
»¶y
);

103 
	#»disR—d”S‘Privd©a
(
_r
, 
_p
è()(((
»disR—d”
*)(_r))->
´ivd©a
 = (_p))

	)

104 
	#»disR—d”G‘Objeù
(
_r
è(((
»disR—d”
*)(_r))->
»¶y
)

	)

105 
	#»disR—d”G‘E¼Ü
(
_r
è(((
»disR—d”
*)(_r))->
”r¡r
)

	)

107 #ifdeà
__ılu¥lus


	@deps/hiredis/sds.c

33 
	~<¡dio.h
>

34 
	~<¡dlib.h
>

35 
	~<¡ršg.h
>

36 
	~<ùy³.h
>

37 
	~<as£¹.h
>

38 
	~"sds.h
"

39 
	~"sd§Îoc.h
"

41 
šlše
 
	$sdsHdrSize
(
ty³
) {

42 
ty³
&
SDS_TYPE_MASK
) {

43 
SDS_TYPE_5
:

44  (
sdshdr5
);

45 
SDS_TYPE_8
:

46  (
sdshdr8
);

47 
SDS_TYPE_16
:

48  (
sdshdr16
);

49 
SDS_TYPE_32
:

50  (
sdshdr32
);

51 
SDS_TYPE_64
:

52  (
sdshdr64
);

55 
	}
}

57 
šlše
 
	$sdsReqTy³
(
size_t
 
¡ršg_size
) {

58 ià(
¡ršg_size
 < 32)

59  
SDS_TYPE_5
;

60 ià(
¡ršg_size
 < 0xff)

61  
SDS_TYPE_8
;

62 ià(
¡ršg_size
 < 0xffff)

63  
SDS_TYPE_16
;

64 ià(
¡ršg_size
 < 0xffffffff)

65  
SDS_TYPE_32
;

66  
SDS_TYPE_64
;

67 
	}
}

81 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

82 *
sh
;

83 
sds
 
s
;

84 
ty³
 = 
	`sdsReqTy³
(
š™Ën
);

87 ià(
ty³
 =ğ
SDS_TYPE_5
 && 
š™Ën
 =ğ0èty³ = 
SDS_TYPE_8
;

88 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

89 *
å
;

91 
sh
 = 
	`s_m®loc
(
hd¾’
+
š™Ën
+1);

92 ià(
sh
 =ğ
NULL
)  NULL;

93 ià(!
š™
)

94 
	`mem£t
(
sh
, 0, 
hd¾’
+
š™Ën
+1);

95 
s
 = (*)
sh
+
hd¾’
;

96 
å
 = ((*)
s
)-1;

97 
ty³
) {

98 
SDS_TYPE_5
: {

99 *
å
 = 
ty³
 | (
š™Ën
 << 
SDS_TYPE_BITS
);

102 
SDS_TYPE_8
: {

103 
	`SDS_HDR_VAR
(8,
s
);

104 
sh
->
Ën
 = 
š™Ën
;

105 
sh
->
®loc
 = 
š™Ën
;

106 *
å
 = 
ty³
;

109 
SDS_TYPE_16
: {

110 
	`SDS_HDR_VAR
(16,
s
);

111 
sh
->
Ën
 = 
š™Ën
;

112 
sh
->
®loc
 = 
š™Ën
;

113 *
å
 = 
ty³
;

116 
SDS_TYPE_32
: {

117 
	`SDS_HDR_VAR
(32,
s
);

118 
sh
->
Ën
 = 
š™Ën
;

119 
sh
->
®loc
 = 
š™Ën
;

120 *
å
 = 
ty³
;

123 
SDS_TYPE_64
: {

124 
	`SDS_HDR_VAR
(64,
s
);

125 
sh
->
Ën
 = 
š™Ën
;

126 
sh
->
®loc
 = 
š™Ën
;

127 *
å
 = 
ty³
;

131 ià(
š™Ën
 && 
š™
)

132 
	`memıy
(
s
, 
š™
, 
š™Ën
);

133 
s
[
š™Ën
] = '\0';

134  
s
;

135 
	}
}

139 
sds
 
	$sd£m±y
() {

140  
	`sd¢ewËn
("",0);

141 
	}
}

144 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

145 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

146  
	`sd¢ewËn
(
š™
, 
š™Ën
);

147 
	}
}

150 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

151  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

152 
	}
}

155 
	$sdsä“
(
sds
 
s
) {

156 ià(
s
 =ğ
NULL
) ;

157 
	`s_ä“
((*)
s
-
	`sdsHdrSize
(s[-1]));

158 
	}
}

174 
	$sdsupd©–’
(
sds
 
s
) {

175 
»®Ën
 = 
	`¡¾’
(
s
);

176 
	`sds£’
(
s
, 
»®Ën
);

177 
	}
}

183 
	$sdsş—r
(
sds
 
s
) {

184 
	`sds£’
(
s
, 0);

185 
s
[0] = '\0';

186 
	}
}

194 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

195 *
sh
, *
Ãwsh
;

196 
size_t
 
ava
 = 
	`sd§va
(
s
);

197 
size_t
 
Ën
, 
ÃwËn
;

198 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

199 
hd¾’
;

202 ià(
ava
 >ğ
addËn
è 
s
;

204 
Ën
 = 
	`sd¦’
(
s
);

205 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

206 
ÃwËn
 = (
Ën
+
addËn
);

207 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

208 
ÃwËn
 *= 2;

210 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

212 
ty³
 = 
	`sdsReqTy³
(
ÃwËn
);

217 ià(
ty³
 =ğ
SDS_TYPE_5
èty³ = 
SDS_TYPE_8
;

219 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

220 ià(
Şdty³
==
ty³
) {

221 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
ÃwËn
+1);

222 ià(
Ãwsh
 =ğ
NULL
)  NULL;

223 
s
 = (*)
Ãwsh
+
hd¾’
;

227 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
ÃwËn
+1);

228 ià(
Ãwsh
 =ğ
NULL
)  NULL;

229 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

230 
	`s_ä“
(
sh
);

231 
s
 = (*)
Ãwsh
+
hd¾’
;

232 
s
[-1] = 
ty³
;

233 
	`sds£’
(
s
, 
Ën
);

235 
	`sds£Îoc
(
s
, 
ÃwËn
);

236  
s
;

237 
	}
}

245 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

246 *
sh
, *
Ãwsh
;

247 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

248 
hd¾’
;

249 
size_t
 
Ën
 = 
	`sd¦’
(
s
);

250 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

252 
ty³
 = 
	`sdsReqTy³
(
Ën
);

253 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

254 ià(
Şdty³
==
ty³
) {

255 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
Ën
+1);

256 ià(
Ãwsh
 =ğ
NULL
)  NULL;

257 
s
 = (*)
Ãwsh
+
hd¾’
;

259 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
Ën
+1);

260 ià(
Ãwsh
 =ğ
NULL
)  NULL;

261 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

262 
	`s_ä“
(
sh
);

263 
s
 = (*)
Ãwsh
+
hd¾’
;

264 
s
[-1] = 
ty³
;

265 
	`sds£’
(
s
, 
Ën
);

267 
	`sds£Îoc
(
s
, 
Ën
);

268  
s
;

269 
	}
}

278 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

279 
size_t
 
®loc
 = 
	`sd§Îoc
(
s
);

280  
	`sdsHdrSize
(
s
[-1])+
®loc
+1;

281 
	}
}

285 *
	$sdsAÎocPŒ
(
sds
 
s
) {

286  (*è(
s
-
	`sdsHdrSize
(s[-1]));

287 
	}
}

312 
	$sdsInüL’
(
sds
 
s
, 
šü
) {

313 
æags
 = 
s
[-1];

314 
size_t
 
Ën
;

315 
æags
&
SDS_TYPE_MASK
) {

316 
SDS_TYPE_5
: {

317 *
å
 = ((*)
s
)-1;

318 
ŞdËn
 = 
	`SDS_TYPE_5_LEN
(
æags
);

319 
	`as£¹
((
šü
 > 0 && 
ŞdËn
+incr < 32) || (incr < 0 && oldlen >= ()(-incr)));

320 *
å
 = 
SDS_TYPE_5
 | ((
ŞdËn
+
šü
è<< 
SDS_TYPE_BITS
);

321 
Ën
 = 
ŞdËn
+
šü
;

324 
SDS_TYPE_8
: {

325 
	`SDS_HDR_VAR
(8,
s
);

326 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

327 
Ën
 = (
sh
->ËÀ+ğ
šü
);

330 
SDS_TYPE_16
: {

331 
	`SDS_HDR_VAR
(16,
s
);

332 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

333 
Ën
 = (
sh
->ËÀ+ğ
šü
);

336 
SDS_TYPE_32
: {

337 
	`SDS_HDR_VAR
(32,
s
);

338 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= ()incr) || (incr < 0 && sh->len >= ()(-incr)));

339 
Ën
 = (
sh
->ËÀ+ğ
šü
);

342 
SDS_TYPE_64
: {

343 
	`SDS_HDR_VAR
(64,
s
);

344 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >ğ(
ušt64_t
)incr) || (incr < 0 && sh->len >= (uint64_t)(-incr)));

345 
Ën
 = (
sh
->ËÀ+ğ
šü
);

348 : 
Ën
 = 0;

350 
s
[
Ën
] = '\0';

351 
	}
}

358 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

359 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

361 ià(
Ën
 <ğ
cu¾’
è 
s
;

362 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

363 ià(
s
 =ğ
NULL
)  NULL;

366 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

367 
	`sds£’
(
s
, 
Ën
);

368  
s
;

369 
	}
}

376 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

377 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

379 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

380 ià(
s
 =ğ
NULL
)  NULL;

381 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

382 
	`sds£’
(
s
, 
cu¾’
+
Ën
);

383 
s
[
cu¾’
+
Ën
] = '\0';

384  
s
;

385 
	}
}

391 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

392  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

393 
	}
}

399 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

400  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

401 
	}
}

405 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

406 ià(
	`sd§Îoc
(
s
è< 
Ën
) {

407 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
	`sd¦’
(s));

408 ià(
s
 =ğ
NULL
)  NULL;

410 
	`memıy
(
s
, 
t
, 
Ën
);

411 
s
[
Ën
] = '\0';

412 
	`sds£’
(
s
, 
Ën
);

413  
s
;

414 
	}
}

418 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

419  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

420 
	}
}

428 
	#SDS_LLSTR_SIZE
 21

	)

429 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

430 *
p
, 
aux
;

431 
v
;

432 
size_t
 
l
;

436 
v
 = (
v®ue
 < 0) ? -value : value;

437 
p
 = 
s
;

439 *
p
++ = '0'+(
v
%10);

440 
v
 /= 10;

441 } 
v
);

442 ià(
v®ue
 < 0è*
p
++ = '-';

445 
l
 = 
p
-
s
;

446 *
p
 = '\0';

449 
p
--;

450 
s
 < 
p
) {

451 
aux
 = *
s
;

452 *
s
 = *
p
;

453 *
p
 = 
aux
;

454 
s
++;

455 
p
--;

457  
l
;

458 
	}
}

461 
	$sdsuÎ2¡r
(*
s
, 
v
) {

462 *
p
, 
aux
;

463 
size_t
 
l
;

467 
p
 = 
s
;

469 *
p
++ = '0'+(
v
%10);

470 
v
 /= 10;

471 } 
v
);

474 
l
 = 
p
-
s
;

475 *
p
 = '\0';

478 
p
--;

479 
s
 < 
p
) {

480 
aux
 = *
s
;

481 *
s
 = *
p
;

482 *
p
 = 
aux
;

483 
s
++;

484 
p
--;

486  
l
;

487 
	}
}

493 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

494 
buf
[
SDS_LLSTR_SIZE
];

495 
Ën
 = 
	`sd¦l2¡r
(
buf
,
v®ue
);

497  
	`sd¢ewËn
(
buf
,
Ën
);

498 
	}
}

501 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

502 
va_li¡
 
ıy
;

503 
¡©icbuf
[1024], *
buf
 = sticbuf, *
t
;

504 
size_t
 
buæ’
 = 
	`¡¾’
(
fmt
)*2;

508 ià(
buæ’
 > (
¡©icbuf
)) {

509 
buf
 = 
	`s_m®loc
(
buæ’
);

510 ià(
buf
 =ğ
NULL
)  NULL;

512 
buæ’
 = (
¡©icbuf
);

518 
buf
[
buæ’
-2] = '\0';

519 
	`va_cİy
(
ıy
,
­
);

520 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

521 
	`va_’d
(
ıy
);

522 ià(
buf
[
buæ’
-2] != '\0') {

523 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

524 
buæ’
 *= 2;

525 
buf
 = 
	`s_m®loc
(
buæ’
);

526 ià(
buf
 =ğ
NULL
)  NULL;

533 
t
 = 
	`sdsÿt
(
s
, 
buf
);

534 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

535  
t
;

536 
	}
}

554 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

555 
va_li¡
 
­
;

556 *
t
;

557 
	`va_¡¬t
(
­
, 
fmt
);

558 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

559 
	`va_’d
(
­
);

560  
t
;

561 
	}
}

579 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

580 cÚ¡ *
f
 = 
fmt
;

581 
i
;

582 
va_li¡
 
­
;

584 
	`va_¡¬t
(
­
,
fmt
);

585 
i
 = 
	`sd¦’
(
s
);

586 *
f
) {

587 
Ãxt
, *
¡r
;

588 
size_t
 
l
;

589 
num
;

590 
unum
;

593 ià(
	`sd§va
(
s
)==0) {

594 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

597 *
f
) {

599 
Ãxt
 = *(
f
+1);

600 
f
++;

601 
Ãxt
) {

604 
¡r
 = 
	`va_¬g
(
­
,*);

605 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

606 ià(
	`sd§va
(
s
è< 
l
) {

607 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

609 
	`memıy
(
s
+
i
,
¡r
,
l
);

610 
	`sdsšş’
(
s
,
l
);

611 
i
 +ğ
l
;

615 ià(
Ãxt
 == 'i')

616 
num
 = 
	`va_¬g
(
­
,);

618 
num
 = 
	`va_¬g
(
­
,);

620 
buf
[
SDS_LLSTR_SIZE
];

621 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

622 ià(
	`sd§va
(
s
è< 
l
) {

623 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

625 
	`memıy
(
s
+
i
,
buf
,
l
);

626 
	`sdsšş’
(
s
,
l
);

627 
i
 +ğ
l
;

632 ià(
Ãxt
 == 'u')

633 
unum
 = 
	`va_¬g
(
­
,);

635 
unum
 = 
	`va_¬g
(
­
,);

637 
buf
[
SDS_LLSTR_SIZE
];

638 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

639 ià(
	`sd§va
(
s
è< 
l
) {

640 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

642 
	`memıy
(
s
+
i
,
buf
,
l
);

643 
	`sdsšş’
(
s
,
l
);

644 
i
 +ğ
l
;

648 
s
[
i
++] = 
Ãxt
;

649 
	`sdsšş’
(
s
,1);

654 
s
[
i
++] = *
f
;

655 
	`sdsšş’
(
s
,1);

658 
f
++;

660 
	`va_’d
(
­
);

663 
s
[
i
] = '\0';

664  
s
;

665 
	}
}

681 
sds
 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

682 *
¡¬t
, *
’d
, *
¥
, *
•
;

683 
size_t
 
Ën
;

685 
¥
 = 
¡¬t
 = 
s
;

686 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

687 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

688 
•
 > 
¥
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

689 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

690 ià(
s
 !ğ
¥
è
	`memmove
(s, sp, 
Ën
);

691 
s
[
Ën
] = '\0';

692 
	`sds£’
(
s
,
Ën
);

693  
s
;

694 
	}
}

712 
	$sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
) {

713 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

715 ià(
Ën
 == 0) ;

716 ià(
¡¬t
 < 0) {

717 
¡¬t
 = 
Ën
+start;

718 ià(
¡¬t
 < 0) start = 0;

720 ià(
’d
 < 0) {

721 
’d
 = 
Ën
+end;

722 ià(
’d
 < 0)ƒnd = 0;

724 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

725 ià(
ÃwËn
 != 0) {

726 ià(
¡¬t
 >ğ(sigÃd)
Ën
) {

727 
ÃwËn
 = 0;

728 } ià(
’d
 >ğ(sigÃd)
Ën
) {

729 
’d
 = 
Ën
-1;

730 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

733 
¡¬t
 = 0;

735 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
s
, s+start,‚ewlen);

736 
s
[
ÃwËn
] = 0;

737 
	`sds£’
(
s
,
ÃwËn
);

738 
	}
}

741 
	$sd¡Şow”
(
sds
 
s
) {

742 
Ën
 = 
	`sd¦’
(
s
), 
j
;

744 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

745 
	}
}

748 
	$sd¡ouµ”
(
sds
 
s
) {

749 
Ën
 = 
	`sd¦’
(
s
), 
j
;

751 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

752 
	}
}

765 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

766 
size_t
 
l1
, 
l2
, 
mšËn
;

767 
cmp
;

769 
l1
 = 
	`sd¦’
(
s1
);

770 
l2
 = 
	`sd¦’
(
s2
);

771 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

772 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

773 ià(
cmp
 =ğ0è 
l1
-
l2
;

774  
cmp
;

775 
	}
}

793 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

794 
–em’ts
 = 0, 
¦Ùs
 = 5, 
¡¬t
 = 0, 
j
;

795 
sds
 *
tok’s
;

797 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

799 
tok’s
 = 
	`s_m®loc
((
sds
)*
¦Ùs
);

800 ià(
tok’s
 =ğ
NULL
)  NULL;

802 ià(
Ën
 == 0) {

803 *
couÁ
 = 0;

804  
tok’s
;

806 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

808 ià(
¦Ùs
 < 
–em’ts
+2) {

809 
sds
 *
Ãwtok’s
;

811 
¦Ùs
 *= 2;

812 
Ãwtok’s
 = 
	`s_»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

813 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

814 
tok’s
 = 
Ãwtok’s
;

817 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

818 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

819 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

820 
–em’ts
++;

821 
¡¬t
 = 
j
+
£¶’
;

822 
j
 = j+
£¶’
-1;

826 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

827 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

828 
–em’ts
++;

829 *
couÁ
 = 
–em’ts
;

830  
tok’s
;

832 
ş—nup
:

834 
i
;

835 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

836 
	`s_ä“
(
tok’s
);

837 *
couÁ
 = 0;

838  
NULL
;

840 
	}
}

843 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

844 ià(!
tok’s
) ;

845 
couÁ
--)

846 
	`sdsä“
(
tok’s
[
couÁ
]);

847 
	`s_ä“
(
tok’s
);

848 
	}
}

856 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

857 
s
 = 
	`sdsÿ’
(s,"\"",1);

858 
Ën
--) {

859 *
p
) {

862 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

864 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

865 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

866 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

867 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

868 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

870 ià(
	`i¥ršt
(*
p
))

871 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

873 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

876 
p
++;

878  
	`sdsÿ’
(
s
,"\"",1);

879 
	}
}

883 
	$is_hex_dig™
(
c
) {

884  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

885 (
c
 >= 'A' && c <= 'F');

886 
	}
}

890 
	$hex_dig™_to_št
(
c
) {

891 
c
) {

910 
	}
}

931 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

932 cÚ¡ *
p
 = 
lše
;

933 *
cu¼’t
 = 
NULL
;

934 **
veùÜ
 = 
NULL
;

936 *
¬gc
 = 0;

939 *
p
 && 
	`is¥aû
(*p))…++;

940 ià(*
p
) {

942 
šq
=0;

943 
šsq
=0;

944 
dÚe
=0;

946 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

947 !
dÚe
) {

948 ià(
šq
) {

949 ià(*
p
 == '\\' && *(p+1) == 'x' &&

950 
	`is_hex_dig™
(*(
p
+2)) &&

951 
	`is_hex_dig™
(*(
p
+3)))

953 
by‹
;

955 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

956 
	`hex_dig™_to_št
(*(
p
+3));

957 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

958 
p
 += 3;

959 } ià(*
p
 == '\\' && *(p+1)) {

960 
c
;

962 
p
++;

963 *
p
) {

964 'n': 
c
 = '\n'; ;

965 'r': 
c
 = '\r'; ;

966 't': 
c
 = '\t'; ;

967 'b': 
c
 = '\b'; ;

968 'a': 
c
 = '\a'; ;

969 : 
c
 = *
p
; ;

971 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

972 } ià(*
p
 == '"') {

975 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

976 
dÚe
=1;

977 } ià(!*
p
) {

979 
”r
;

981 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

983 } ià(
šsq
) {

984 ià(*
p
 == '\\' && *(p+1) == '\'') {

985 
p
++;

986 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

987 } ià(*
p
 == '\'') {

990 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

991 
dÚe
=1;

992 } ià(!*
p
) {

994 
”r
;

996 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

999 *
p
) {

1005 
dÚe
=1;

1008 
šq
=1;

1011 
šsq
=1;

1014 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1018 ià(*
p
)…++;

1021 
veùÜ
 = 
	`s_»®loc
(veùÜ,((*
¬gc
)+1)*(*));

1022 
veùÜ
[*
¬gc
] = 
cu¼’t
;

1023 (*
¬gc
)++;

1024 
cu¼’t
 = 
NULL
;

1027 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`s_m®loc
((*));

1028  
veùÜ
;

1032 
”r
:

1033 (*
¬gc
)--)

1034 
	`sdsä“
(
veùÜ
[*
¬gc
]);

1035 
	`s_ä“
(
veùÜ
);

1036 ià(
cu¼’t
è
	`sdsä“
(current);

1037 *
¬gc
 = 0;

1038  
NULL
;

1039 
	}
}

1050 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

1051 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

1053 
j
 = 0; j < 
l
; j++) {

1054 
i
 = 0; i < 
£’
; i++) {

1055 ià(
s
[
j
] =ğ
äom
[
i
]) {

1056 
s
[
j
] = 
to
[
i
];

1061  
s
;

1062 
	}
}

1066 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
) {

1067 
sds
 
još
 = 
	`sd£m±y
();

1068 
j
;

1070 
j
 = 0; j < 
¬gc
; j++) {

1071 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

1072 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿt
(još,
£p
);

1074  
još
;

1075 
	}
}

1078 
sds
 
	$sdsjošsds
(
sds
 *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
) {

1079 
sds
 
još
 = 
	`sd£m±y
();

1080 
j
;

1082 
j
 = 0; j < 
¬gc
; j++) {

1083 
još
 = 
	`sdsÿtsds
(još, 
¬gv
[
j
]);

1084 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

1086  
još
;

1087 
	}
}

1094 *
	$sds_m®loc
(
size_t
 
size
è{  
	`s_m®loc
(size); 
	}
}

1095 *
	$sds_»®loc
(*
±r
, 
size_t
 
size
è{  
	`s_»®loc
ÕŒ,size); 
	}
}

1096 
	$sds_ä“
(*
±r
è{ 
	`s_ä“
ÕŒ); 
	}
}

1098 #ià
defšed
(
SDS_TEST_MAIN
)

1099 
	~<¡dio.h
>

1100 
	~"‹¡h–p.h
"

1101 
	~"lim™s.h
"

1103 
	#UNUSED
(
x
è()(x)

	)

1104 
	$sdsTe¡
() {

1106 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

1108 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

1109 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

1111 
	`sdsä“
(
x
);

1112 
x
 = 
	`sd¢ewËn
("foo",2);

1113 
	`‹¡_cÚd
("Create‡ string with specified†ength",

1114 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

1116 
x
 = 
	`sdsÿt
(x,"bar");

1117 
	`‹¡_cÚd
("Strings concatenation",

1118 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

1120 
x
 = 
	`sdsıy
(x,"a");

1121 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

1122 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

1124 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

1125 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

1126 
	`sd¦’
(
x
) == 33 &&

1127 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

1129 
	`sdsä“
(
x
);

1130 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

1131 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

1132 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) == 0)

1134 
	`sdsä“
(
x
);

1135 
x
 = 
	`sd¢ew
("--");

1136 
x
 = 
	`sdsÿtfmt
(x, "H–lØ% WÜld %I,%I--", "Hi!", 
LLONG_MIN
,
LLONG_MAX
);

1137 
	`‹¡_cÚd
("sdscatfmt() seems working inhe base case",

1138 
	`sd¦’
(
x
) == 60 &&

1139 
	`memcmp
(
x
,"--Hello Hi! World -9223372036854775808,"

1141 
	`´štf
("[%s]\n",
x
);

1143 
	`sdsä“
(
x
);

1144 
x
 = 
	`sd¢ew
("--");

1145 
x
 = 
	`sdsÿtfmt
(x, "%u,%U--", 
UINT_MAX
, 
ULLONG_MAX
);

1146 
	`‹¡_cÚd
("sdscatfmt() seems working with unsigned‚umbers",

1147 
	`sd¦’
(
x
) == 35 &&

1148 
	`memcmp
(
x
,"--4294967295,18446744073709551615--",35) == 0)

1150 
	`sdsä“
(
x
);

1151 
x
 = 
	`sd¢ew
(" x ");

1152 
	`sd¡rim
(
x
," x");

1153 
	`‹¡_cÚd
("sdstrim() works when‡ll chars match",

1154 
	`sd¦’
(
x
) == 0)

1156 
	`sdsä“
(
x
);

1157 
x
 = 
	`sd¢ew
(" x ");

1158 
	`sd¡rim
(
x
," ");

1159 
	`‹¡_cÚd
("sdstrim() works when‡ single char„emains",

1160 
	`sd¦’
(
x
) == 1 && x[0] == 'x')

1162 
	`sdsä“
(
x
);

1163 
x
 = 
	`sd¢ew
("xxciaoyyy");

1164 
	`sd¡rim
(
x
,"xy");

1165 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1166 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1168 
y
 = 
	`sdsdup
(
x
);

1169 
	`sd¤ªge
(
y
,1,1);

1170 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1171 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1173 
	`sdsä“
(
y
);

1174 
y
 = 
	`sdsdup
(
x
);

1175 
	`sd¤ªge
(
y
,1,-1);

1176 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1177 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1179 
	`sdsä“
(
y
);

1180 
y
 = 
	`sdsdup
(
x
);

1181 
	`sd¤ªge
(
y
,-2,-1);

1182 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1183 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1185 
	`sdsä“
(
y
);

1186 
y
 = 
	`sdsdup
(
x
);

1187 
	`sd¤ªge
(
y
,2,1);

1188 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1189 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1191 
	`sdsä“
(
y
);

1192 
y
 = 
	`sdsdup
(
x
);

1193 
	`sd¤ªge
(
y
,1,100);

1194 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1195 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1197 
	`sdsä“
(
y
);

1198 
y
 = 
	`sdsdup
(
x
);

1199 
	`sd¤ªge
(
y
,100,100);

1200 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1201 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1203 
	`sdsä“
(
y
);

1204 
	`sdsä“
(
x
);

1205 
x
 = 
	`sd¢ew
("foo");

1206 
y
 = 
	`sd¢ew
("foa");

1207 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1209 
	`sdsä“
(
y
);

1210 
	`sdsä“
(
x
);

1211 
x
 = 
	`sd¢ew
("bar");

1212 
y
 = 
	`sd¢ew
("bar");

1213 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1215 
	`sdsä“
(
y
);

1216 
	`sdsä“
(
x
);

1217 
x
 = 
	`sd¢ew
("aar");

1218 
y
 = 
	`sd¢ew
("bar");

1219 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1221 
	`sdsä“
(
y
);

1222 
	`sdsä“
(
x
);

1223 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1224 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1225 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1226 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1229 
Şdä“
;

1230 *
p
;

1231 
¡•
 = 10, 
j
, 
i
;

1233 
	`sdsä“
(
x
);

1234 
	`sdsä“
(
y
);

1235 
x
 = 
	`sd¢ew
("0");

1236 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
	`sd¦’
(
x
è=ğ1 && 
	`sd§va
(x) == 0);

1240 
i
 = 0; i < 10; i++) {

1241 
ŞdËn
 = 
	`sd¦’
(
x
);

1242 
x
 = 
	`sdsMakeRoomFÜ
(x,
¡•
);

1243 
ty³
 = 
x
[-1]&
SDS_TYPE_MASK
;

1245 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èËn", 
	`sd¦’
(
x
è=ğ
ŞdËn
);

1246 ià(
ty³
 !ğ
SDS_TYPE_5
) {

1247 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èä“", 
	`sd§va
(
x
è>ğ
¡•
);

1248 
Şdä“
 = 
	`sd§va
(
x
);

1250 
p
 = 
x
+
ŞdËn
;

1251 
j
 = 0; j < 
¡•
; j++) {

1252 
p
[
j
] = 'A'+j;

1254 
	`sdsInüL’
(
x
,
¡•
);

1256 
	`‹¡_cÚd
("sdsMakeRoomFor() content",

1257 
	`memcmp
("0ABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJ",
x
,101) == 0);

1258 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èfš®†’gth",
	`sd¦’
(
x
)==101);

1260 
	`sdsä“
(
x
);

1263 
	`‹¡_»pÜt
()

1265 
	}
}

1268 #ifdeà
SDS_TEST_MAIN


1269 
	$maš
() {

1270  
	`sdsTe¡
();

1271 
	}
}

	@deps/hiredis/sds.h

33 #iâdeà
__SDS_H


34 
	#__SDS_H


	)

36 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

38 
	~<sys/ty³s.h
>

39 
	~<¡d¬g.h
>

40 
	~<¡dšt.h
>

42 *
	tsds
;

46 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr5
 {

47 
	gæags
;

48 
	gbuf
[];

50 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr8
 {

51 
ušt8_t
 
	gËn
;

52 
ušt8_t
 
	g®loc
;

53 
	gæags
;

54 
	gbuf
[];

56 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr16
 {

57 
ušt16_t
 
	gËn
;

58 
ušt16_t
 
	g®loc
;

59 
	gæags
;

60 
	gbuf
[];

62 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr32
 {

63 
ušt32_t
 
	gËn
;

64 
ušt32_t
 
	g®loc
;

65 
	gæags
;

66 
	gbuf
[];

68 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr64
 {

69 
ušt64_t
 
	gËn
;

70 
ušt64_t
 
	g®loc
;

71 
	gæags
;

72 
	gbuf
[];

75 
	#SDS_TYPE_5
 0

	)

76 
	#SDS_TYPE_8
 1

	)

77 
	#SDS_TYPE_16
 2

	)

78 
	#SDS_TYPE_32
 3

	)

79 
	#SDS_TYPE_64
 4

	)

80 
	#SDS_TYPE_MASK
 7

	)

81 
	#SDS_TYPE_BITS
 3

	)

82 
	#SDS_HDR_VAR
(
T
,
s
è
sdshdr
##T *
sh
 = (sdshdr##T *)((s)-((sdshdr##T)));

	)

83 
	#SDS_HDR
(
T
,
s
è((
sdshdr
##T *)((s)-((sdshdr##T))))

	)

84 
	#SDS_TYPE_5_LEN
(
f
è((f)>>
SDS_TYPE_BITS
)

	)

86 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

87 
æags
 = 
s
[-1];

88 
æags
&
SDS_TYPE_MASK
) {

89 
SDS_TYPE_5
:

90  
	`SDS_TYPE_5_LEN
(
æags
);

91 
SDS_TYPE_8
:

92  
	`SDS_HDR
(8,
s
)->
Ën
;

93 
SDS_TYPE_16
:

94  
	`SDS_HDR
(16,
s
)->
Ën
;

95 
SDS_TYPE_32
:

96  
	`SDS_HDR
(32,
s
)->
Ën
;

97 
SDS_TYPE_64
:

98  
	`SDS_HDR
(64,
s
)->
Ën
;

101 
	}
}

103 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

104 
æags
 = 
s
[-1];

105 
æags
&
SDS_TYPE_MASK
) {

106 
SDS_TYPE_5
: {

109 
SDS_TYPE_8
: {

110 
	`SDS_HDR_VAR
(8,
s
);

111  
sh
->
®loc
 - sh->
Ën
;

113 
SDS_TYPE_16
: {

114 
	`SDS_HDR_VAR
(16,
s
);

115  
sh
->
®loc
 - sh->
Ën
;

117 
SDS_TYPE_32
: {

118 
	`SDS_HDR_VAR
(32,
s
);

119  
sh
->
®loc
 - sh->
Ën
;

121 
SDS_TYPE_64
: {

122 
	`SDS_HDR_VAR
(64,
s
);

123  
sh
->
®loc
 - sh->
Ën
;

127 
	}
}

129 
šlše
 
	$sds£’
(
sds
 
s
, 
size_t
 
ÃwËn
) {

130 
æags
 = 
s
[-1];

131 
æags
&
SDS_TYPE_MASK
) {

132 
SDS_TYPE_5
:

134 *
å
 = ((*)
s
)-1;

135 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

138 
SDS_TYPE_8
:

139 
	`SDS_HDR
(8,
s
)->
Ën
 = 
ÃwËn
;

141 
SDS_TYPE_16
:

142 
	`SDS_HDR
(16,
s
)->
Ën
 = 
ÃwËn
;

144 
SDS_TYPE_32
:

145 
	`SDS_HDR
(32,
s
)->
Ën
 = 
ÃwËn
;

147 
SDS_TYPE_64
:

148 
	`SDS_HDR
(64,
s
)->
Ën
 = 
ÃwËn
;

151 
	}
}

153 
šlše
 
	$sdsšş’
(
sds
 
s
, 
size_t
 
šc
) {

154 
æags
 = 
s
[-1];

155 
æags
&
SDS_TYPE_MASK
) {

156 
SDS_TYPE_5
:

158 *
å
 = ((*)
s
)-1;

159 
ÃwËn
 = 
	`SDS_TYPE_5_LEN
(
æags
)+
šc
;

160 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

163 
SDS_TYPE_8
:

164 
	`SDS_HDR
(8,
s
)->
Ën
 +ğ
šc
;

166 
SDS_TYPE_16
:

167 
	`SDS_HDR
(16,
s
)->
Ën
 +ğ
šc
;

169 
SDS_TYPE_32
:

170 
	`SDS_HDR
(32,
s
)->
Ën
 +ğ
šc
;

172 
SDS_TYPE_64
:

173 
	`SDS_HDR
(64,
s
)->
Ën
 +ğ
šc
;

176 
	}
}

179 
šlše
 
size_t
 
	$sd§Îoc
(cÚ¡ 
sds
 
s
) {

180 
æags
 = 
s
[-1];

181 
æags
&
SDS_TYPE_MASK
) {

182 
SDS_TYPE_5
:

183  
	`SDS_TYPE_5_LEN
(
æags
);

184 
SDS_TYPE_8
:

185  
	`SDS_HDR
(8,
s
)->
®loc
;

186 
SDS_TYPE_16
:

187  
	`SDS_HDR
(16,
s
)->
®loc
;

188 
SDS_TYPE_32
:

189  
	`SDS_HDR
(32,
s
)->
®loc
;

190 
SDS_TYPE_64
:

191  
	`SDS_HDR
(64,
s
)->
®loc
;

194 
	}
}

196 
šlše
 
	$sds£Îoc
(
sds
 
s
, 
size_t
 
ÃwËn
) {

197 
æags
 = 
s
[-1];

198 
æags
&
SDS_TYPE_MASK
) {

199 
SDS_TYPE_5
:

202 
SDS_TYPE_8
:

203 
	`SDS_HDR
(8,
s
)->
®loc
 = 
ÃwËn
;

205 
SDS_TYPE_16
:

206 
	`SDS_HDR
(16,
s
)->
®loc
 = 
ÃwËn
;

208 
SDS_TYPE_32
:

209 
	`SDS_HDR
(32,
s
)->
®loc
 = 
ÃwËn
;

211 
SDS_TYPE_64
:

212 
	`SDS_HDR
(64,
s
)->
®loc
 = 
ÃwËn
;

215 
	}
}

217 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

218 
sds
 
sd¢ew
(cÚ¡ *
š™
);

219 
sds
 
sd£m±y
();

220 
sds
 
sdsdup
(cÚ¡ sd 
s
);

221 
sdsä“
(
sds
 
s
);

222 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

223 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

224 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

225 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

226 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

227 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

229 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

230 #ifdeà
__GNUC__


231 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

232 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

234 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

237 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

238 
sds
 
	`sd¡rim
(sd 
s
, cÚ¡ *
c£t
);

239 
	`sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
);

240 
	`sdsupd©–’
(
sds
 
s
);

241 
	`sdsş—r
(
sds
 
s
);

242 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

243 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

244 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

245 
	`sd¡Şow”
(
sds
 
s
);

246 
	`sd¡ouµ”
(
sds
 
s
);

247 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

248 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

249 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

250 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

251 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
);

252 
sds
 
	`sdsjošsds
(sd *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
);

255 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

256 
	`sdsInüL’
(
sds
 
s
, 
šü
);

257 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

258 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

259 *
	`sdsAÎocPŒ
(
sds
 
s
);

265 *
	`sds_m®loc
(
size_t
 
size
);

266 *
	`sds_»®loc
(*
±r
, 
size_t
 
size
);

267 
	`sds_ä“
(*
±r
);

269 #ifdeà
REDIS_TEST


270 
	`sdsTe¡
(
¬gc
, *
¬gv
[]);

	@deps/hiredis/sdsalloc.h

40 
	#s_m®loc
 
m®loc


	)

41 
	#s_»®loc
 
»®loc


	)

42 
	#s_ä“
 
ä“


	)

	@deps/hiredis/test.c

1 
	~"fmaüos.h
"

2 
	~<¡dio.h
>

3 
	~<¡dlib.h
>

4 
	~<¡ršg.h
>

5 
	~<¡ršgs.h
>

6 
	~<sys/time.h
>

7 
	~<as£¹.h
>

8 
	~<uni¡d.h
>

9 
	~<sigÇl.h
>

10 
	~<”ºo.h
>

11 
	~<lim™s.h
>

13 
	~"hœedis.h
"

14 
	~"Ãt.h
"

16 
	ecÚÃùiÚ_ty³
 {

17 
	mCONN_TCP
,

18 
	mCONN_UNIX
,

19 
	mCONN_FD


22 
	scÚfig
 {

23 
cÚÃùiÚ_ty³
 
	mty³
;

26 cÚ¡ *
	mho¡
;

27 
	mpÜt
;

28 
timev®
 
	mtimeout
;

29 } 
	mtı
;

32 cÚ¡ *
	m·th
;

33 } 
	munix_sock
;

37 
	g‹¡s
 = 0, 
	gçs
 = 0;

38 
	#‹¡
(
_s
è{ 
	`´štf
("#%02d ", ++
‹¡s
);…rštf(_s); }

	)

39 
	#‹¡_cÚd
(
_c
èif(_cè
	`´štf
("\033[0;32mPASSED\033[0;0m\n"); {´štf("\033[0;31mFAILED\033[0;0m\n"); 
çs
++;}

	)

41 
	$u£c
() {

42 
timev®
 
tv
;

43 
	`g‘timeofday
(&
tv
,
NULL
);

44  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

45 
	}
}

49 #ifdeà
NDEBUG


50 #undeà
as£¹


51 
	#as£¹
(
e
è()Ó)

	)

54 
»disCÚ‹xt
 *
	$£Ëù_d©aba£
(
»disCÚ‹xt
 *
c
) {

55 
»disR•ly
 *
»¶y
;

58 
»¶y
 = 
	`»disCommªd
(
c
,"SELECT 9");

59 
	`as£¹
(
»¶y
 !ğ
NULL
);

60 
	`ä“R•lyObjeù
(
»¶y
);

63 
»¶y
 = 
	`»disCommªd
(
c
,"DBSIZE");

64 
	`as£¹
(
»¶y
 !ğ
NULL
);

65 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&„•ly->
š‹g”
 == 0) {

67 
	`ä“R•lyObjeù
(
»¶y
);

69 
	`´štf
("Database #9 is‚otƒmpty,est can‚ot continue\n");

70 
	`ex™
(1);

73  
c
;

74 
	}
}

76 
	$discÚÃù
(
»disCÚ‹xt
 *
c
, 
k“p_fd
) {

77 
»disR•ly
 *
»¶y
;

80 
»¶y
 = 
	`»disCommªd
(
c
,"SELECT 9");

81 
	`as£¹
(
»¶y
 !ğ
NULL
);

82 
	`ä“R•lyObjeù
(
»¶y
);

83 
»¶y
 = 
	`»disCommªd
(
c
,"FLUSHDB");

84 
	`as£¹
(
»¶y
 !ğ
NULL
);

85 
	`ä“R•lyObjeù
(
»¶y
);

88 ià(
k“p_fd
)

89  
	`»disF»eK“pFd
(
c
);

90 
	`»disF»e
(
c
);

92 
	}
}

94 
»disCÚ‹xt
 *
	$cÚÃù
(
cÚfig
 config) {

95 
»disCÚ‹xt
 *
c
 = 
NULL
;

97 ià(
cÚfig
.
ty³
 =ğ
CONN_TCP
) {

98 
c
 = 
	`»disCÚÃù
(
cÚfig
.
tı
.
ho¡
, cÚfig.tı.
pÜt
);

99 } ià(
cÚfig
.
ty³
 =ğ
CONN_UNIX
) {

100 
c
 = 
	`»disCÚÃùUnix
(
cÚfig
.
unix_sock
.
·th
);

101 } ià(
cÚfig
.
ty³
 =ğ
CONN_FD
) {

103 
»disCÚ‹xt
 *
dummy_ùx
 = 
	`»disCÚÃùUnix
(
cÚfig
.
unix_sock
.
·th
);

104 ià(
dummy_ùx
) {

105 
fd
 = 
	`discÚÃù
(
dummy_ùx
, 1);

106 
	`´štf
("CÚÃùšgØšh”™ed fd %d\n", 
fd
);

107 
c
 = 
	`»disCÚÃùFd
(
fd
);

110 
	`as£¹
(
NULL
);

113 ià(
c
 =ğ
NULL
) {

114 
	`´štf
("Connectionƒrror: can't‡llocate„edis context\n");

115 
	`ex™
(1);

116 } ià(
c
->
”r
) {

117 
	`´štf
("CÚÃùiÚƒ¼Ü: %s\n", 
c
->
”r¡r
);

118 
	`»disF»e
(
c
);

119 
	`ex™
(1);

122  
	`£Ëù_d©aba£
(
c
);

123 
	}
}

125 
	$‹¡_fÜm©_commªds
() {

126 *
cmd
;

127 
Ën
;

129 
	`‹¡
("Format command without interpolation: ");

130 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET foo bar");

131 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$3\r\nb¬\r\n",
Ën
) == 0 &&

132 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(3+2));

133 
	`ä“
(
cmd
);

135 
	`‹¡
("Format command with %%s string interpolation: ");

136 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %s %s","foo","bar");

137 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$3\r\nb¬\r\n",
Ën
) == 0 &&

138 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(3+2));

139 
	`ä“
(
cmd
);

141 
	`‹¡
("Format command with %%s‡nd‡nƒmpty string: ");

142 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %s %s","foo","");

143 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$0\r\n\r\n",
Ën
) == 0 &&

144 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(0+2));

145 
	`ä“
(
cmd
);

147 
	`‹¡
("Format command with‡nƒmpty string in between…roper interpolations: ");

148 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %s %s","","foo");

149 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$0\r\n\r\n$3\r\nfoo\r\n",
Ën
) == 0 &&

150 
Ën
 == 4+4+(3+2)+4+(0+2)+4+(3+2));

151 
	`ä“
(
cmd
);

153 
	`‹¡
("Format command with %%b string interpolation: ");

154 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %b %b","foo",(
size_t
)3,"b\0r",(size_t)3);

155 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$3\r\nb\0r\r\n",
Ën
) == 0 &&

156 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(3+2));

157 
	`ä“
(
cmd
);

159 
	`‹¡
("Format command with %%b‡nd‡nƒmpty string: ");

160 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %b %b","foo",(
size_t
)3,"",(size_t)0);

161 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$0\r\n\r\n",
Ën
) == 0 &&

162 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(0+2));

163 
	`ä“
(
cmd
);

165 
	`‹¡
("Format command with†iteral %%: ");

166 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET %% %%");

167 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$1\r\n%\r\n$1\r\n%\r\n",
Ën
) == 0 &&

168 
Ën
 == 4+4+(3+2)+4+(1+2)+4+(1+2));

169 
	`ä“
(
cmd
);

174 
	#INTEGER_WIDTH_TEST
(
fmt
, 
ty³
) do { \

175 
ty³
 
v®ue
 = 123; \

176 
	`‹¡
("Format command with…rintf-delegation (" #type "): "); \

177 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"key:%08" 
fmt
 " sŒ:%s", 
v®ue
, "hello"); \

178 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*2\r\n$12\r\nkey:00000123\r\n$9\r\n¡r:h–lo\r\n",
Ën
) == 0 && \

179 
Ën
 == 4+5+(12+2)+4+(9+2)); \

180 
	`ä“
(
cmd
); \

181 } 0)

	)

183 
	#FLOAT_WIDTH_TEST
(
ty³
) do { \

184 
ty³
 
v®ue
 = 123.0; \

185 
	`‹¡
("Format command with…rintf-delegation (" #type "): "); \

186 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"key:%08.3à¡r:%s", 
v®ue
, "hello"); \

187 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*2\r\n$12\r\nkey:0123.000\r\n$9\r\n¡r:h–lo\r\n",
Ën
) == 0 && \

188 
Ën
 == 4+5+(12+2)+4+(9+2)); \

189 
	`ä“
(
cmd
); \

190 } 0)

	)

192 
	`INTEGER_WIDTH_TEST
("d", );

193 
	`INTEGER_WIDTH_TEST
("hhd", );

194 
	`INTEGER_WIDTH_TEST
("hd", );

195 
	`INTEGER_WIDTH_TEST
("ld", );

196 
	`INTEGER_WIDTH_TEST
("lld", );

197 
	`INTEGER_WIDTH_TEST
("u", );

198 
	`INTEGER_WIDTH_TEST
("hhu", );

199 
	`INTEGER_WIDTH_TEST
("hu", );

200 
	`INTEGER_WIDTH_TEST
("lu", );

201 
	`INTEGER_WIDTH_TEST
("llu", );

202 
	`FLOAT_WIDTH_TEST
();

203 
	`FLOAT_WIDTH_TEST
();

205 
	`‹¡
("Format command with invalid…rintf format: ");

206 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"key:%08°%b",(*)1234,"foo",(
size_t
)3);

207 
	`‹¡_cÚd
(
Ën
 == -1);

209 cÚ¡ *
¬gv
[3];

210 
¬gv
[0] = "SET";

211 
¬gv
[1] = "foo\0xxx";

212 
¬gv
[2] = "bar";

213 
size_t
 
Ëns
[3] = { 3, 7, 3 };

214 
¬gc
 = 3;

216 
	`‹¡
("Format command by…assing‡rgc/argv without†engths: ");

217 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

218 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$3\r\nb¬\r\n",
Ën
) == 0 &&

219 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(3+2));

220 
	`ä“
(
cmd
);

222 
	`‹¡
("Format command by…assing‡rgc/argv with†engths: ");

223 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
Ëns
);

224 
	`‹¡_cÚd
(
	`¡ºcmp
(
cmd
,"*3\r\n$3\r\nSET\r\n$7\r\nfoo\0xxx\r\n$3\r\nb¬\r\n",
Ën
) == 0 &&

225 
Ën
 == 4+4+(3+2)+4+(7+2)+4+(3+2));

226 
	`ä“
(
cmd
);

228 
sds
 
sds_cmd
;

230 
sds_cmd
 = 
	`sd£m±y
();

231 
	`‹¡
("Format command into sds by…assing‡rgc/argv without†engths: ");

232 
Ën
 = 
	`»disFÜm©SdsCommªdArgv
(&
sds_cmd
,
¬gc
,
¬gv
,
NULL
);

233 
	`‹¡_cÚd
(
	`¡ºcmp
(
sds_cmd
,"*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$3\r\nb¬\r\n",
Ën
) == 0 &&

234 
Ën
 == 4+4+(3+2)+4+(3+2)+4+(3+2));

235 
	`sdsä“
(
sds_cmd
);

237 
sds_cmd
 = 
	`sd£m±y
();

238 
	`‹¡
("Format command into sds by…assing‡rgc/argv with†engths: ");

239 
Ën
 = 
	`»disFÜm©SdsCommªdArgv
(&
sds_cmd
,
¬gc
,
¬gv
,
Ëns
);

240 
	`‹¡_cÚd
(
	`¡ºcmp
(
sds_cmd
,"*3\r\n$3\r\nSET\r\n$7\r\nfoo\0xxx\r\n$3\r\nb¬\r\n",
Ën
) == 0 &&

241 
Ën
 == 4+4+(3+2)+4+(7+2)+4+(3+2));

242 
	`sdsä“
(
sds_cmd
);

243 
	}
}

245 
	$‹¡_­³nd_fÜm©‹d_commªds
(
cÚfig
 config) {

246 
»disCÚ‹xt
 *
c
;

247 
»disR•ly
 *
»¶y
;

248 *
cmd
;

249 
Ën
;

251 
c
 = 
	`cÚÃù
(
cÚfig
);

253 
	`‹¡
("Append format command: ");

255 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
, "SET foo bar");

257 
	`‹¡_cÚd
(
	`»disAµ’dFÜm©‹dCommªd
(
c
, 
cmd
, 
Ën
è=ğ
REDIS_OK
);

259 
	`as£¹
(
	`»disG‘R•ly
(
c
, (*)&
»¶y
è=ğ
REDIS_OK
);

261 
	`ä“
(
cmd
);

262 
	`ä“R•lyObjeù
(
»¶y
);

264 
	`discÚÃù
(
c
, 0);

265 
	}
}

267 
	$‹¡_»¶y_»ad”
() {

268 
»disR—d”
 *
»ad”
;

269 *
»¶y
;

270 
»t
;

271 
i
;

273 
	`‹¡
("Error handling in„eply…arser: ");

274 
»ad”
 = 
	`»disR—d”C»©e
();

275 
	`»disR—d”F“d
(
»ad”
,(*)"@foo\r\n",6);

276 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,
NULL
);

277 
	`årštf
(
¡d”r
, "%s", "printingƒrror");

278 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_ERR
 &&

279 
	`¡rÿ£cmp
(
»ad”
->
”r¡r
,"Protocolƒrror, got \"@\"‡s„eplyype byte„ohan") == 0);

280 
	`»disR—d”F»e
(
»ad”
);

284 
	`‹¡
("Memory cleanup in„eply…arser: ");

285 
»ad”
 = 
	`»disR—d”C»©e
();

286 
	`»disR—d”F“d
(
»ad”
,(*)"*2\r\n",4);

287 
	`»disR—d”F“d
(
»ad”
,(*)"$5\r\nhello\r\n",11);

288 
	`»disR—d”F“d
(
»ad”
,(*)"@foo\r\n",6);

289 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,
NULL
);

290 
	`årštf
(
¡d”r
, "%s", "printingƒrror");

291 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_ERR
 &&

292 
	`¡rÿ£cmp
(
»ad”
->
”r¡r
,"Protocolƒrror, got \"@\"‡s„eplyype byte") == 0);

293 
	`»disR—d”F»e
(
»ad”
);

295 
	`‹¡
("Setƒrror on‚ested multi bulks with depth > 7: ");

296 
»ad”
 = 
	`»disR—d”C»©e
();

298 
i
 = 0; i < 9; i++) {

299 
	`»disR—d”F“d
(
»ad”
,(*)"*1\r\n",4);

302 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,
NULL
);

303 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_ERR
 &&

304 
	`¡ºÿ£cmp
(
»ad”
->
”r¡r
,"No support for",14) == 0);

305 
	`»disR—d”F»e
(
»ad”
);

307 
	`‹¡
("Works with NULL functions for„eply: ");

308 
»ad”
 = 
	`»disR—d”C»©e
();

309 
»ad”
->
â
 = 
NULL
;

310 
	`»disR—d”F“d
(
»ad”
,(*)"+OK\r\n",5);

311 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

312 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_OK
 && 
»¶y
 =ğ(*)
REDIS_REPLY_STATUS
);

313 
	`»disR—d”F»e
(
»ad”
);

315 
	`‹¡
("Works when‡ single‚ewline (\\r\\n) coverswo callso feed: ");

316 
»ad”
 = 
	`»disR—d”C»©e
();

317 
»ad”
->
â
 = 
NULL
;

318 
	`»disR—d”F“d
(
»ad”
,(*)"+OK\r",4);

319 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

320 
	`as£¹
(
»t
 =ğ
REDIS_OK
 && 
»¶y
 =ğ
NULL
);

321 
	`»disR—d”F“d
(
»ad”
,(*)"\n",1);

322 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

323 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_OK
 && 
»¶y
 =ğ(*)
REDIS_REPLY_STATUS
);

324 
	`»disR—d”F»e
(
»ad”
);

326 
	`‹¡
("Don't„eset state‡fter…rotocolƒrror: ");

327 
»ad”
 = 
	`»disR—d”C»©e
();

328 
»ad”
->
â
 = 
NULL
;

329 
	`»disR—d”F“d
(
»ad”
,(*)"x",1);

330 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

331 
	`as£¹
(
»t
 =ğ
REDIS_ERR
);

332 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

333 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_ERR
 && 
»¶y
 =ğ
NULL
);

334 
	`»disR—d”F»e
(
»ad”
);

337 
	`‹¡
("Don't doƒmpty‡llocation forƒmpty multi bulk: ");

338 
»ad”
 = 
	`»disR—d”C»©e
();

339 
	`»disR—d”F“d
(
»ad”
,(*)"*0\r\n",4);

340 
»t
 = 
	`»disR—d”G‘R•ly
(
»ad”
,&
»¶y
);

341 
	`‹¡_cÚd
(
»t
 =ğ
REDIS_OK
 &&

342 ((
»disR•ly
*)
»¶y
)->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&

343 ((
»disR•ly
*)
»¶y
)->
–em’ts
 == 0);

344 
	`ä“R•lyObjeù
(
»¶y
);

345 
	`»disR—d”F»e
(
»ad”
);

346 
	}
}

348 
	$‹¡_ä“_nuÎ
() {

349 *
»disCtx
 = 
NULL
;

350 *
»¶y
 = 
NULL
;

352 
	`‹¡
("Don't fail when„edisFree is…assed‡ NULL value: ");

353 
	`»disF»e
(
»disCtx
);

354 
	`‹¡_cÚd
(
»disCtx
 =ğ
NULL
);

356 
	`‹¡
("Don't fail when freeReplyObject is…assed‡ NULL value: ");

357 
	`ä“R•lyObjeù
(
»¶y
);

358 
	`‹¡_cÚd
(
»¶y
 =ğ
NULL
);

359 
	}
}

361 
	$‹¡_blockšg_cÚÃùiÚ_”rÜs
() {

362 
»disCÚ‹xt
 *
c
;

364 
	`‹¡
("Returnsƒrror when host cannot be„esolved: ");

365 
c
 = 
	`»disCÚÃù
((*)"idontexist.test", 6379);

366 
	`‹¡_cÚd
(
c
->
”r
 =ğ
REDIS_ERR_OTHER
 &&

367 (
	`¡rcmp
(
c
->
”r¡r
,"Name or service‚ot known") == 0 ||

368 
	`¡rcmp
(
c
->
”r¡r
,"Can't„esolve: idontexist.test") == 0 ||

369 
	`¡rcmp
(
c
->
”r¡r
,"nodename‚or servname…rovided, or‚ot known") == 0 ||

370 
	`¡rcmp
(
c
->
”r¡r
,"No‡ddress‡ssociated with hostname") == 0 ||

371 
	`¡rcmp
(
c
->
”r¡r
,"Temporary failure in‚ame„esolution") == 0 ||

372 
	`¡rcmp
(
c
->
”r¡r
,"hostname‚or servname…rovided, or‚ot known") == 0 ||

373 
	`¡rcmp
(
c
->
”r¡r
,"no‡ddress‡ssociated with‚ame") == 0));

374 
	`»disF»e
(
c
);

376 
	`‹¡
("Returnsƒrror whenhe…ort is‚ot open: ");

377 
c
 = 
	`»disCÚÃù
((*)"localhost", 1);

378 
	`‹¡_cÚd
(
c
->
”r
 =ğ
REDIS_ERR_IO
 &&

379 
	`¡rcmp
(
c
->
”r¡r
,"Connection„efused") == 0);

380 
	`»disF»e
(
c
);

382 
	`‹¡
("Returnsƒrror whenhe unix_sock socket…ath doesn't‡ccept connections: ");

383 
c
 = 
	`»disCÚÃùUnix
((*)"/tmp/idontexist.sock");

384 
	`‹¡_cÚd
(
c
->
”r
 =ğ
REDIS_ERR_IO
);

385 
	`»disF»e
(
c
);

386 
	}
}

388 
	$‹¡_blockšg_cÚÃùiÚ
(
cÚfig
 config) {

389 
»disCÚ‹xt
 *
c
;

390 
»disR•ly
 *
»¶y
;

392 
c
 = 
	`cÚÃù
(
cÚfig
);

394 
	`‹¡
("Is‡bleo deliver commands: ");

395 
»¶y
 = 
	`»disCommªd
(
c
,"PING");

396 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STATUS
 &&

397 
	`¡rÿ£cmp
(
»¶y
->
¡r
,"pong") == 0)

398 
	`ä“R•lyObjeù
(
»¶y
);

400 
	`‹¡
("Is‡‡bleo send commands verbatim: ");

401 
»¶y
 = 
	`»disCommªd
(
c
,"SET foo bar");

402 
	`‹¡_cÚd
 (
»¶y
->
ty³
 =ğ
REDIS_REPLY_STATUS
 &&

403 
	`¡rÿ£cmp
(
»¶y
->
¡r
,"ok") == 0)

404 
	`ä“R•lyObjeù
(
»¶y
);

406 
	`‹¡
("%%s String interpolation works: ");

407 
»¶y
 = 
	`»disCommªd
(
c
,"SET %s %s","foo","hello world");

408 
	`ä“R•lyObjeù
(
»¶y
);

409 
»¶y
 = 
	`»disCommªd
(
c
,"GET foo");

410 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

411 
	`¡rcmp
(
»¶y
->
¡r
,"hello world") == 0);

412 
	`ä“R•lyObjeù
(
»¶y
);

414 
	`‹¡
("%%b String interpolation works: ");

415 
»¶y
 = 
	`»disCommªd
(
c
,"SET %b %b","foo",(
size_t
)3,"hello\x00world",(size_t)11);

416 
	`ä“R•lyObjeù
(
»¶y
);

417 
»¶y
 = 
	`»disCommªd
(
c
,"GET foo");

418 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

419 
	`memcmp
(
»¶y
->
¡r
,"hello\x00world",11) == 0)

421 
	`‹¡
("Binary„eply†ength is correct: ");

422 
	`‹¡_cÚd
(
»¶y
->
Ën
 == 11)

423 
	`ä“R•lyObjeù
(
»¶y
);

425 
	`‹¡
("Can…arse‚il„eplies: ");

426 
»¶y
 = 
	`»disCommªd
(
c
,"GET‚okey");

427 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_NIL
)

428 
	`ä“R•lyObjeù
(
»¶y
);

431 
	`‹¡
("Can…arse integer„eplies: ");

432 
»¶y
 = 
	`»disCommªd
(
c
,"INCR mycounter");

433 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&„•ly->
š‹g”
 == 1)

434 
	`ä“R•lyObjeù
(
»¶y
);

436 
	`‹¡
("Can…arse multi bulk„eplies: ");

437 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"LPUSH mylist foo"));

438 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"LPUSH mylist bar"));

439 
»¶y
 = 
	`»disCommªd
(
c
,"LRANGE mylist 0 -1");

440 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&

441 
»¶y
->
–em’ts
 == 2 &&

442 !
	`memcmp
(
»¶y
->
–em’t
[0]->
¡r
,"bar",3) &&

443 !
	`memcmp
(
»¶y
->
–em’t
[1]->
¡r
,"foo",3))

444 
	`ä“R•lyObjeù
(
»¶y
);

448 
	`‹¡
("Can handle‚ested multi bulk„eplies: ");

449 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"MULTI"));

450 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"LRANGE mylist 0 -1"));

451 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"PING"));

452 
»¶y
 = (
	`»disCommªd
(
c
,"EXEC"));

453 
	`‹¡_cÚd
(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&

454 
»¶y
->
–em’ts
 == 2 &&

455 
»¶y
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&

456 
»¶y
->
–em’t
[0]->
–em’ts
 == 2 &&

457 !
	`memcmp
(
»¶y
->
–em’t
[0]->–em’t[0]->
¡r
,"bar",3) &&

458 !
	`memcmp
(
»¶y
->
–em’t
[0]->–em’t[1]->
¡r
,"foo",3) &&

459 
»¶y
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_STATUS
 &&

460 
	`¡rÿ£cmp
(
»¶y
->
–em’t
[1]->
¡r
,"pong") == 0);

461 
	`ä“R•lyObjeù
(
»¶y
);

463 
	`discÚÃù
(
c
, 0);

464 
	}
}

466 
	$‹¡_blockšg_cÚÃùiÚ_timeouts
(
cÚfig
 config) {

467 
»disCÚ‹xt
 *
c
;

468 
»disR•ly
 *
»¶y
;

469 
ssize_t
 
s
;

470 cÚ¡ *
cmd
 = "DEBUG SLEEP 3\r\n";

471 
timev®
 
tv
;

473 
c
 = 
	`cÚÃù
(
cÚfig
);

474 
	`‹¡
("Successfully completes‡ command whenheimeout is‚otƒxceeded: ");

475 
»¶y
 = 
	`»disCommªd
(
c
,"SET foo fast");

476 
	`ä“R•lyObjeù
(
»¶y
);

477 
tv
.
tv_£c
 = 0;

478 
tv
.
tv_u£c
 = 10000;

479 
	`»disS‘Timeout
(
c
, 
tv
);

480 
»¶y
 = 
	`»disCommªd
(
c
, "GET foo");

481 
	`‹¡_cÚd
(
»¶y
 !ğ
NULL
 &&„•ly->
ty³
 =ğ
REDIS_REPLY_STRING
 && 
	`memcmp
Ô•ly->
¡r
, "fast", 4) == 0);

482 
	`ä“R•lyObjeù
(
»¶y
);

483 
	`discÚÃù
(
c
, 0);

485 
c
 = 
	`cÚÃù
(
cÚfig
);

486 
	`‹¡
("Does‚ot„eturn‡„eply whenhe commandimes out: ");

487 
s
 = 
	`wr™e
(
c
->
fd
, 
cmd
, 
	`¡¾’
(cmd));

488 
tv
.
tv_£c
 = 0;

489 
tv
.
tv_u£c
 = 10000;

490 
	`»disS‘Timeout
(
c
, 
tv
);

491 
»¶y
 = 
	`»disCommªd
(
c
, "GET foo");

492 
	`‹¡_cÚd
(
s
 > 0 && 
»¶y
 =ğ
NULL
 && 
c
->
”r
 =ğ
REDIS_ERR_IO
 && 
	`¡rcmp
(c->
”r¡r
, "Resourceemporarily unavailable") == 0);

493 
	`ä“R•lyObjeù
(
»¶y
);

495 
	`‹¡
("Reconnect…roperly„econnects‡fter‡imeout: ");

496 
	`»disRecÚÃù
(
c
);

497 
»¶y
 = 
	`»disCommªd
(
c
, "PING");

498 
	`‹¡_cÚd
(
»¶y
 !ğ
NULL
 &&„•ly->
ty³
 =ğ
REDIS_REPLY_STATUS
 && 
	`¡rcmp
Ô•ly->
¡r
, "PONG") == 0);

499 
	`ä“R•lyObjeù
(
»¶y
);

501 
	`‹¡
("Reconnect…roperly uses owned…arameters: ");

502 
cÚfig
.
tı
.
ho¡
 = "foo";

503 
cÚfig
.
unix_sock
.
·th
 = "foo";

504 
	`»disRecÚÃù
(
c
);

505 
»¶y
 = 
	`»disCommªd
(
c
, "PING");

506 
	`‹¡_cÚd
(
»¶y
 !ğ
NULL
 &&„•ly->
ty³
 =ğ
REDIS_REPLY_STATUS
 && 
	`¡rcmp
Ô•ly->
¡r
, "PONG") == 0);

507 
	`ä“R•lyObjeù
(
»¶y
);

509 
	`discÚÃù
(
c
, 0);

510 
	}
}

512 
	$‹¡_blockšg_io_”rÜs
(
cÚfig
 config) {

513 
»disCÚ‹xt
 *
c
;

514 
»disR•ly
 *
»¶y
;

515 *
_»¶y
;

516 
majÜ
, 
mšÜ
;

519 
c
 = 
	`cÚÃù
(
cÚfig
);

522 cÚ¡ *
f›ld
 = "redis_version:";

523 *
p
, *
•Œ
;

525 
»¶y
 = 
	`»disCommªd
(
c
,"INFO");

526 
p
 = 
	`¡r¡r
(
»¶y
->
¡r
,
f›ld
);

527 
majÜ
 = 
	`¡¹Ş
(
p
+
	`¡¾’
(
f›ld
),&
•Œ
,10);

528 
p
 = 
•Œ
+1;

529 
mšÜ
 = 
	`¡¹Ş
(
p
,&
•Œ
,10);

530 
	`ä“R•lyObjeù
(
»¶y
);

533 
	`‹¡
("Returns I/Oƒrror whenhe connection is†ost: ");

534 
»¶y
 = 
	`»disCommªd
(
c
,"QUIT");

535 ià(
majÜ
 > 2 || (majÜ =ğ2 && 
mšÜ
 > 0)) {

538 
	`‹¡_cÚd
(
	`¡rÿ£cmp
(
»¶y
->
¡r
,"OK") == 0 &&

539 
	`»disG‘R•ly
(
c
,&
_»¶y
è=ğ
REDIS_ERR
);

540 
	`ä“R•lyObjeù
(
»¶y
);

542 
	`‹¡_cÚd
(
»¶y
 =ğ
NULL
);

550 
	`as£¹
(
c
->
”r
 =ğ
REDIS_ERR_EOF
 &&

551 
	`¡rcmp
(
c
->
”r¡r
,"Server closedhe connection") == 0);

552 
	`»disF»e
(
c
);

554 
c
 = 
	`cÚÃù
(
cÚfig
);

555 
	`‹¡
("Returns I/Oƒrror on socketimeout: ");

556 
timev®
 
tv
 = { 0, 1000 };

557 
	`as£¹
(
	`»disS‘Timeout
(
c
,
tv
è=ğ
REDIS_OK
);

558 
	`‹¡_cÚd
(
	`»disG‘R•ly
(
c
,&
_»¶y
è=ğ
REDIS_ERR
 &&

559 
c
->
”r
 =ğ
REDIS_ERR_IO
 && 
”ºo
 =ğ
EAGAIN
);

560 
	`»disF»e
(
c
);

561 
	}
}

563 
	$‹¡_šv®id_timeout_”rÜs
(
cÚfig
 config) {

564 
»disCÚ‹xt
 *
c
;

566 
	`‹¡
("Setƒrror when‡n invalidimeout usec value is giveno„edisConnectWithTimeout: ");

568 
cÚfig
.
tı
.
timeout
.
tv_£c
 = 0;

569 
cÚfig
.
tı
.
timeout
.
tv_u£c
 = 10000001;

571 
c
 = 
	`»disCÚÃùW™hTimeout
(
cÚfig
.
tı
.
ho¡
, cÚfig.tı.
pÜt
, cÚfig.tı.
timeout
);

573 
	`‹¡_cÚd
(
c
->
”r
 =ğ
REDIS_ERR_IO
 && 
	`¡rcmp
(c->
”r¡r
, "Invalidimeout specified") == 0);

574 
	`»disF»e
(
c
);

576 
	`‹¡
("Setƒrror when‡n invalidimeout sec value is giveno„edisConnectWithTimeout: ");

578 
cÚfig
.
tı
.
timeout
.
tv_£c
 = (((
LONG_MAX
) - 999) / 1000) + 1;

579 
cÚfig
.
tı
.
timeout
.
tv_u£c
 = 0;

581 
c
 = 
	`»disCÚÃùW™hTimeout
(
cÚfig
.
tı
.
ho¡
, cÚfig.tı.
pÜt
, cÚfig.tı.
timeout
);

583 
	`‹¡_cÚd
(
c
->
”r
 =ğ
REDIS_ERR_IO
 && 
	`¡rcmp
(c->
”r¡r
, "Invalidimeout specified") == 0);

584 
	`»disF»e
(
c
);

585 
	}
}

587 
	$‹¡_throughput
(
cÚfig
 config) {

588 
»disCÚ‹xt
 *
c
 = 
	`cÚÃù
(
cÚfig
);

589 
»disR•ly
 **
»¶›s
;

590 
i
, 
num
;

591 
t1
, 
t2
;

593 
	`‹¡
("Throughput:\n");

594 
i
 = 0; i < 500; i++)

595 
	`ä“R•lyObjeù
(
	`»disCommªd
(
c
,"LPUSH mylist foo"));

597 
num
 = 1000;

598 
»¶›s
 = 
	`m®loc
((
»disR•ly
*)*
num
);

599 
t1
 = 
	`u£c
();

600 
i
 = 0; i < 
num
; i++) {

601 
»¶›s
[
i
] = 
	`»disCommªd
(
c
,"PING");

602 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
ty³
 =ğ
REDIS_REPLY_STATUS
);

604 
t2
 = 
	`u£c
();

605 
i
 = 0; i < 
num
; i++è
	`ä“R•lyObjeù
(
»¶›s
[i]);

606 
	`ä“
(
»¶›s
);

607 
	`´štf
("\t(%dx PING: %.3fs)\n", 
num
, (
t2
-
t1
)/1000000.0);

609 
»¶›s
 = 
	`m®loc
((
»disR•ly
*)*
num
);

610 
t1
 = 
	`u£c
();

611 
i
 = 0; i < 
num
; i++) {

612 
»¶›s
[
i
] = 
	`»disCommªd
(
c
,"LRANGE mylist 0 499");

613 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

614 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
–em’ts
 == 500);

616 
t2
 = 
	`u£c
();

617 
i
 = 0; i < 
num
; i++è
	`ä“R•lyObjeù
(
»¶›s
[i]);

618 
	`ä“
(
»¶›s
);

619 
	`´štf
("\t(%dx LRANGE w™h 500ƒËm’ts: %.3fs)\n", 
num
, (
t2
-
t1
)/1000000.0);

621 
num
 = 10000;

622 
»¶›s
 = 
	`m®loc
((
»disR•ly
*)*
num
);

623 
i
 = 0; i < 
num
; i++)

624 
	`»disAµ’dCommªd
(
c
,"PING");

625 
t1
 = 
	`u£c
();

626 
i
 = 0; i < 
num
; i++) {

627 
	`as£¹
(
	`»disG‘R•ly
(
c
, (*)&
»¶›s
[
i
]è=ğ
REDIS_OK
);

628 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
ty³
 =ğ
REDIS_REPLY_STATUS
);

630 
t2
 = 
	`u£c
();

631 
i
 = 0; i < 
num
; i++è
	`ä“R•lyObjeù
(
»¶›s
[i]);

632 
	`ä“
(
»¶›s
);

633 
	`´štf
("\t(%dx PING (p–šed): %.3fs)\n", 
num
, (
t2
-
t1
)/1000000.0);

635 
»¶›s
 = 
	`m®loc
((
»disR•ly
*)*
num
);

636 
i
 = 0; i < 
num
; i++)

637 
	`»disAµ’dCommªd
(
c
,"LRANGE mylist 0 499");

638 
t1
 = 
	`u£c
();

639 
i
 = 0; i < 
num
; i++) {

640 
	`as£¹
(
	`»disG‘R•ly
(
c
, (*)&
»¶›s
[
i
]è=ğ
REDIS_OK
);

641 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

642 
	`as£¹
(
»¶›s
[
i
] !ğ
NULL
 &&„•l›s[i]->
–em’ts
 == 500);

644 
t2
 = 
	`u£c
();

645 
i
 = 0; i < 
num
; i++è
	`ä“R•lyObjeù
(
»¶›s
[i]);

646 
	`ä“
(
»¶›s
);

647 
	`´štf
("\t(%dx LRANGE w™h 500ƒËm’t Õ–šed): %.3fs)\n", 
num
, (
t2
-
t1
)/1000000.0);

649 
	`discÚÃù
(
c
, 0);

650 
	}
}

751 
	$maš
(
¬gc
, **
¬gv
) {

752 
cÚfig
 
cfg
 = {

753 .
tı
 = {

754 .
ho¡
 = "127.0.0.1",

755 .
pÜt
 = 6379

757 .
unix_sock
 = {

758 .
·th
 = "/tmp/redis.sock"

761 
throughput
 = 1;

762 
‹¡_šh”™_fd
 = 1;

765 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

768 
¬gv
++; 
¬gc
--;

769 
¬gc
) {

770 ià(
¬gc
 >ğ2 && !
	`¡rcmp
(
¬gv
[0],"-h")) {

771 
¬gv
++; 
¬gc
--;

772 
cfg
.
tı
.
ho¡
 = 
¬gv
[0];

773 } ià(
¬gc
 >ğ2 && !
	`¡rcmp
(
¬gv
[0],"-p")) {

774 
¬gv
++; 
¬gc
--;

775 
cfg
.
tı
.
pÜt
 = 
	`©oi
(
¬gv
[0]);

776 } ià(
¬gc
 >ğ2 && !
	`¡rcmp
(
¬gv
[0],"-s")) {

777 
¬gv
++; 
¬gc
--;

778 
cfg
.
unix_sock
.
·th
 = 
¬gv
[0];

779 } ià(
¬gc
 >ğ1 && !
	`¡rcmp
(
¬gv
[0],"--skip-throughput")) {

780 
throughput
 = 0;

781 } ià(
¬gc
 >ğ1 && !
	`¡rcmp
(
¬gv
[0],"--skip-inherit-fd")) {

782 
‹¡_šh”™_fd
 = 0;

784 
	`årštf
(
¡d”r
, "Inv®id‡rgum’t: %s\n", 
¬gv
[0]);

785 
	`ex™
(1);

787 
¬gv
++; 
¬gc
--;

790 
	`‹¡_fÜm©_commªds
();

791 
	`‹¡_»¶y_»ad”
();

792 
	`‹¡_blockšg_cÚÃùiÚ_”rÜs
();

793 
	`‹¡_ä“_nuÎ
();

795 
	`´štf
("\nTe¡šg‡gaš¡ TCP cÚÃùiÚ (%s:%d):\n", 
cfg
.
tı
.
ho¡
, cfg.tı.
pÜt
);

796 
cfg
.
ty³
 = 
CONN_TCP
;

797 
	`‹¡_blockšg_cÚÃùiÚ
(
cfg
);

798 
	`‹¡_blockšg_cÚÃùiÚ_timeouts
(
cfg
);

799 
	`‹¡_blockšg_io_”rÜs
(
cfg
);

800 
	`‹¡_šv®id_timeout_”rÜs
(
cfg
);

801 
	`‹¡_­³nd_fÜm©‹d_commªds
(
cfg
);

802 ià(
throughput
è
	`‹¡_throughput
(
cfg
);

804 
	`´štf
("\nTe¡šg‡gaš¡ Unix sock‘ cÚÃùiÚ (%s):\n", 
cfg
.
unix_sock
.
·th
);

805 
cfg
.
ty³
 = 
CONN_UNIX
;

806 
	`‹¡_blockšg_cÚÃùiÚ
(
cfg
);

807 
	`‹¡_blockšg_cÚÃùiÚ_timeouts
(
cfg
);

808 
	`‹¡_blockšg_io_”rÜs
(
cfg
);

809 ià(
throughput
è
	`‹¡_throughput
(
cfg
);

811 ià(
‹¡_šh”™_fd
) {

812 
	`´štf
("\nTe¡šg‡gaš¡ inh”™ed fd (%s):\n", 
cfg
.
unix_sock
.
·th
);

813 
cfg
.
ty³
 = 
CONN_FD
;

814 
	`‹¡_blockšg_cÚÃùiÚ
(
cfg
);

818 ià(
çs
) {

819 
	`´štf
("*** %d TESTS FAILED ***\n", 
çs
);

823 
	`´štf
("ALL TESTS PASSED\n");

825 
	}
}

	@deps/hiredis/win32.h

1 #iâdeà
_WIN32_HELPER_INCLUDE


2 
	#_WIN32_HELPER_INCLUDE


	)

3 #ifdeà
_MSC_VER


5 #iâdeà
šlše


6 
	#šlše
 
__šlše


	)

9 #iâdeà
va_cİy


10 
	#va_cİy
(
d
,
s
è((dèğ(s))

	)

13 #iâdeà
¢´štf


14 
	#¢´štf
 
c99_¢´štf


	)

16 
__šlše
 
	$c99_v¢´štf
(* 
¡r
, 
size_t
 
size
, cÚ¡ * 
fÜm©
, 
va_li¡
 
­
)

18 
couÁ
 = -1;

20 ià(
size
 != 0)

21 
couÁ
 = 
	`_v¢´štf_s
(
¡r
, 
size
, 
_TRUNCATE
, 
fÜm©
, 
­
);

22 ià(
couÁ
 == -1)

23 
couÁ
 = 
	`_vsırštf
(
fÜm©
, 
­
);

25  
couÁ
;

26 
	}
}

28 
__šlše
 
	$c99_¢´štf
(* 
¡r
, 
size_t
 
size
, cÚ¡ * 
fÜm©
, ...)

30 
couÁ
;

31 
va_li¡
 
­
;

33 
	`va_¡¬t
(
­
, 
fÜm©
);

34 
couÁ
 = 
	`c99_v¢´štf
(
¡r
, 
size
, 
fÜm©
, 
­
);

35 
	`va_’d
(
­
);

37  
couÁ
;

38 
	}
}

	@deps/jemalloc/include/jemalloc/internal/arena.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
	#LARGE_MINCLASS
 (
	`ZU
(1è<< 
LG_LARGE_MINCLASS
)

	)

7 
	#LG_RUN_MAXREGS
 (
LG_PAGE
 - 
LG_TINY_MIN
)

	)

8 
	#RUN_MAXREGS
 (1U << 
LG_RUN_MAXREGS
)

	)

14 
	#REDZONE_MINSIZE
 16

	)

24 
	#LG_DIRTY_MULT_DEFAULT
 3

	)

26 
¬’a_runs_dœty_lšk_s
 
	t¬’a_runs_dœty_lšk_t
;

27 
¬’a_run_s
 
	t¬’a_run_t
;

28 
¬’a_chunk_m­_b™s_s
 
	t¬’a_chunk_m­_b™s_t
;

29 
¬’a_chunk_m­_misc_s
 
	t¬’a_chunk_m­_misc_t
;

30 
¬’a_chunk_s
 
	t¬’a_chunk_t
;

31 
¬’a_bš_šfo_s
 
	t¬’a_bš_šfo_t
;

32 
¬’a_bš_s
 
	t¬’a_bš_t
;

33 
¬’a_s
 
	t¬’a_t
;

37 #ifdeà
JEMALLOC_H_STRUCTS


39 #ifdeà
JEMALLOC_ARENA_STRUCTS_A


40 
	s¬’a_run_s
 {

42 
szšd_t
 
	mbššd
;

45 
	mnä“
;

48 
b™m­_t
 
	mb™m­
[
BITMAP_GROUPS_MAX
];

52 
	s¬’a_chunk_m­_b™s_s
 {

111 
size_t
 
	mb™s
;

112 
	#CHUNK_MAP_ALLOCATED
 ((
size_t
)0x01U)

	)

113 
	#CHUNK_MAP_LARGE
 ((
size_t
)0x02U)

	)

114 
	#CHUNK_MAP_STATE_MASK
 ((
size_t
)0x3U)

	)

116 
	#CHUNK_MAP_DECOMMITTED
 ((
size_t
)0x04U)

	)

117 
	#CHUNK_MAP_UNZEROED
 ((
size_t
)0x08U)

	)

118 
	#CHUNK_MAP_DIRTY
 ((
size_t
)0x10U)

	)

119 
	#CHUNK_MAP_FLAGS_MASK
 ((
size_t
)0x1cU)

	)

121 
	#CHUNK_MAP_BININD_SHIFT
 5

	)

122 
	#BININD_INVALID
 ((
size_t
)0xffU)

	)

123 
	#CHUNK_MAP_BININD_MASK
 (
BININD_INVALID
 << 
CHUNK_MAP_BININD_SHIFT
)

	)

124 
	#CHUNK_MAP_BININD_INVALID
 
CHUNK_MAP_BININD_MASK


	)

126 
	#CHUNK_MAP_RUNIND_SHIFT
 (
CHUNK_MAP_BININD_SHIFT
 + 8)

	)

127 
	#CHUNK_MAP_SIZE_SHIFT
 (
CHUNK_MAP_RUNIND_SHIFT
 - 
LG_PAGE
)

	)

128 
	#CHUNK_MAP_SIZE_MASK
 \

129 (~(
CHUNK_MAP_BININD_MASK
 | 
CHUNK_MAP_FLAGS_MASK
 | 
CHUNK_MAP_STATE_MASK
))

	)

132 
	s¬’a_runs_dœty_lšk_s
 {

133 
qr
(
¬’a_runs_dœty_lšk_t
è
	mrd_lšk
;

141 
	s¬’a_chunk_m­_misc_s
 {

149 
rb_node
(
¬’a_chunk_m­_misc_t
è
	mrb_lšk
;

153 
¬’a_runs_dœty_lšk_t
 
	mrd
;

157 *
	m´of_tùx_pun
;

158 
´of_tùx_t
 *
	m´of_tùx
;

162 
¬’a_run_t
 
	mrun
;

165 
	$rb_Œ“
(
	t¬’a_chunk_m­_misc_t
è
	t¬’a_ava_Œ“_t
;

166 
	$rb_Œ“
(
	t¬’a_chunk_m­_misc_t
è
	t¬’a_run_Œ“_t
;

169 #ifdeà
JEMALLOC_ARENA_STRUCTS_B


171 
	s¬’a_chunk_s
 {

177 
ex‹Á_node_t
 
node
;

185 
¬’a_chunk_m­_b™s_t
 
m­_b™s
[1];

221 
	s¬’a_bš_šfo_s
 {

223 
size_t
 
»g_size
;

226 
size_t
 
»dzÚe_size
;

229 
size_t
 
»g_š‹rv®
;

232 
size_t
 
run_size
;

235 
ušt32_t
 
Äegs
;

241 
b™m­_šfo_t
 
b™m­_šfo
;

244 
ušt32_t
 
»g0_off£t
;

247 
	s¬’a_bš_s
 {

254 
m®loc_mu‹x_t
 
lock
;

260 
¬’a_run_t
 *
runcur
;

269 
¬’a_run_Œ“_t
 
runs
;

272 
m®loc_bš_¡©s_t
 
¡©s
;

275 
	s¬’a_s
 {

277 
šd
;

283 
Áh»ads
;

292 
m®loc_mu‹x_t
 
lock
;

294 
¬’a_¡©s_t
 
¡©s
;

300 
	`ql_h—d
(
tÿche_t
è
tÿche_ql
;

302 
ušt64_t
 
´of_accumby‹s
;

308 
ušt64_t
 
off£t_¡©e
;

310 
dss_´ec_t
 
dss_´ec
;

322 
¬’a_chunk_t
 *
¥¬e
;

325 
ssize_t
 
lg_dœty_muÉ
;

328 
boŞ
 
purgšg
;

331 
size_t
 
Çùive
;

339 
size_t
 
ndœty
;

345 
¬’a_ava_Œ“_t
 
runs_ava
;

375 
¬’a_runs_dœty_lšk_t
 
runs_dœty
;

376 
ex‹Á_node_t
 
chunks_ÿche
;

379 
	`ql_h—d
(
ex‹Á_node_t
è
huge
;

381 
m®loc_mu‹x_t
 
huge_mtx
;

390 
ex‹Á_Œ“_t
 
chunks_szad_ÿched
;

391 
ex‹Á_Œ“_t
 
chunks_ad_ÿched
;

392 
ex‹Á_Œ“_t
 
chunks_szad_»šed
;

393 
ex‹Á_Œ“_t
 
chunks_ad_»šed
;

395 
m®loc_mu‹x_t
 
chunks_mtx
;

397 
	`ql_h—d
(
ex‹Á_node_t
è
node_ÿche
;

398 
m®loc_mu‹x_t
 
node_ÿche_mtx
;

401 
chunk_hooks_t
 
chunk_hooks
;

404 
¬’a_bš_t
 
bšs
[
NBINS
];

410 #ifdeà
JEMALLOC_H_EXTERNS


412 cÚ¡ 
size_t
 
Ïrge_·d
 =

413 #ifdeà
JEMALLOC_CACHE_OBLIVIOUS


414 
PAGE


420 
ssize_t
 
İt_lg_dœty_muÉ
;

422 
¬’a_bš_šfo_t
 
¬’a_bš_šfo
[
NBINS
];

424 
size_t
 
m­_bŸs
;

425 
size_t
 
m­_misc_off£t
;

426 
size_t
 
¬’a_maxrun
;

427 
size_t
 
Ïrge_maxşass
;

428 
Æşas£s
;

429 
nhşas£s
;

431 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
,

432 
boŞ
 
ÿche
);

433 
	`¬’a_chunk_ÿche_maybe_»move
(
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
,

434 
boŞ
 
ÿche
);

435 
ex‹Á_node_t
 *
	`¬’a_node_®loc
(
¬’a_t
 *
¬’a
);

436 
	`¬’a_node_d®loc
(
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
);

437 *
	`¬’a_chunk_®loc_huge
(
¬’a_t
 *
¬’a
, 
size_t
 
usize
, size_ˆ
®ignm’t
,

438 
boŞ
 *
z”o
);

439 
	`¬’a_chunk_d®loc_huge
(
¬’a_t
 *
¬’a
, *
chunk
, 
size_t
 
usize
);

440 
	`¬’a_chunk_¿Îoc_huge_sim¬
(
¬’a_t
 *
¬’a
, *
chunk
,

441 
size_t
 
Şdsize
, size_ˆ
usize
);

442 
	`¬’a_chunk_¿Îoc_huge_shršk
(
¬’a_t
 *
¬’a
, *
chunk
,

443 
size_t
 
Şdsize
, size_ˆ
usize
);

444 
boŞ
 
	`¬’a_chunk_¿Îoc_huge_ex·nd
(
¬’a_t
 *
¬’a
, *
chunk
,

445 
size_t
 
Şdsize
, size_ˆ
usize
, 
boŞ
 *
z”o
);

446 
ssize_t
 
	`¬’a_lg_dœty_muÉ_g‘
(
¬’a_t
 *
¬’a
);

447 
boŞ
 
	`¬’a_lg_dœty_muÉ_£t
(
¬’a_t
 *
¬’a
, 
ssize_t
 
lg_dœty_muÉ
);

448 
	`¬’a_maybe_purge
(
¬’a_t
 *
¬’a
);

449 
	`¬’a_purge_®l
(
¬’a_t
 *
¬’a
);

450 
	`¬’a_tÿche_fl_sm®l
(
¬’a_t
 *
¬’a
, 
tÿche_bš_t
 *
tbš
,

451 
szšd_t
 
bššd
, 
ušt64_t
 
´of_accumby‹s
);

452 
	`¬’a_®loc_junk_sm®l
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
,

453 
boŞ
 
z”o
);

454 #ifdeà
JEMALLOC_JET


455 (
	t¬’a_»dzÚe_cÜru±iÚ_t
)(*, 
	tsize_t
, 
	tboŞ
, size_t,

456 
	tušt8_t
);

457 
¬’a_»dzÚe_cÜru±iÚ_t
 *
¬’a_»dzÚe_cÜru±iÚ
;

458 (
	t¬’a_d®loc_junk_sm®l_t
)(*, 
	t¬’a_bš_šfo_t
 *);

459 
¬’a_d®loc_junk_sm®l_t
 *
¬’a_d®loc_junk_sm®l
;

461 
	`¬’a_d®loc_junk_sm®l
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
);

463 
	`¬’a_qu¬ªtše_junk_sm®l
(*
±r
, 
size_t
 
usize
);

464 *
	`¬’a_m®loc_sm®l
(
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
);

465 *
	`¬’a_m®loc_Ïrge
(
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
);

466 *
	`¬’a_·Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
,

467 
size_t
 
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
);

468 
	`¬’a_´of_´omÙed
(cÚ¡ *
±r
, 
size_t
 
size
);

469 
	`¬’a_d®loc_bš_junked_locked
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

470 *
±r
, 
¬’a_chunk_m­_b™s_t
 *
b™£lm
);

471 
	`¬’a_d®loc_bš
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, *
±r
,

472 
size_t
 
·gešd
, 
¬’a_chunk_m­_b™s_t
 *
b™£lm
);

473 
	`¬’a_d®loc_sm®l
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, *
±r
,

474 
size_t
 
·gešd
);

475 #ifdeà
JEMALLOC_JET


476 (
	t¬’a_d®loc_junk_Ïrge_t
)(*, 
	tsize_t
);

477 
¬’a_d®loc_junk_Ïrge_t
 *
¬’a_d®loc_junk_Ïrge
;

479 
	`¬’a_d®loc_junk_Ïrge
(*
±r
, 
size_t
 
usize
);

481 
	`¬’a_d®loc_Ïrge_junked_locked
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

482 *
±r
);

483 
	`¬’a_d®loc_Ïrge
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, *
±r
);

484 #ifdeà
JEMALLOC_JET


485 (
	t¬’a_¿Îoc_junk_Ïrge_t
)(*, 
	tsize_t
, size_t);

486 
¬’a_¿Îoc_junk_Ïrge_t
 *
¬’a_¿Îoc_junk_Ïrge
;

488 
boŞ
 
	`¬’a_¿Îoc_no_move
(*
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

489 
size_t
 
exŒa
, 
boŞ
 
z”o
);

490 *
	`¬’a_¿Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, *
±r
, 
size_t
 
Şdsize
,

491 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
);

492 
dss_´ec_t
 
	`¬’a_dss_´ec_g‘
(
¬’a_t
 *
¬’a
);

493 
boŞ
 
	`¬’a_dss_´ec_£t
(
¬’a_t
 *
¬’a
, 
dss_´ec_t
 
dss_´ec
);

494 
ssize_t
 
	`¬’a_lg_dœty_muÉ_deçuÉ_g‘
();

495 
boŞ
 
	`¬’a_lg_dœty_muÉ_deçuÉ_£t
(
ssize_t
 
lg_dœty_muÉ
);

496 
	`¬’a_¡©s_m”ge
(
¬’a_t
 *
¬’a
, cÚ¡ **
dss
,

497 
ssize_t
 *
lg_dœty_muÉ
, 
size_t
 *
Çùive
, size_ˆ*
ndœty
,

498 
¬’a_¡©s_t
 *
a¡©s
, 
m®loc_bš_¡©s_t
 *
b¡©s
,

499 
m®loc_Ïrge_¡©s_t
 *
l¡©s
, 
m®loc_huge_¡©s_t
 *
h¡©s
);

500 
¬’a_t
 *
	`¬’a_Ãw
(
šd
);

501 
boŞ
 
	`¬’a_boÙ
();

502 
	`¬’a_´efÜk
(
¬’a_t
 *
¬’a
);

503 
	`¬’a_po¡fÜk_·»Á
(
¬’a_t
 *
¬’a
);

504 
	`¬’a_po¡fÜk_chd
(
¬’a_t
 *
¬’a
);

508 #ifdeà
JEMALLOC_H_INLINES


510 #iâdeà
JEMALLOC_ENABLE_INLINE


511 
¬’a_chunk_m­_b™s_t
 *
	`¬’a_b™£lm_g‘
(
¬’a_chunk_t
 *
chunk
,

512 
size_t
 
·gešd
);

513 
¬’a_chunk_m­_misc_t
 *
	`¬’a_misûlm_g‘
(
¬’a_chunk_t
 *
chunk
,

514 
size_t
 
·gešd
);

515 
size_t
 
	`¬’a_misûlm_to_·gešd
(
¬’a_chunk_m­_misc_t
 *
misûlm
);

516 *
	`¬’a_misûlm_to_½ages
(
¬’a_chunk_m­_misc_t
 *
misûlm
);

517 
¬’a_chunk_m­_misc_t
 *
	`¬’a_rd_to_misûlm
(
¬’a_runs_dœty_lšk_t
 *
rd
);

518 
¬’a_chunk_m­_misc_t
 *
	`¬’a_run_to_misûlm
(
¬’a_run_t
 *
run
);

519 
size_t
 *
	`¬’a_m­b™¥_g‘
(
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

520 
size_t
 
	`¬’a_m­b™¥_»ad
(size_ˆ*
m­b™¥
);

521 
size_t
 
	`¬’a_m­b™s_g‘
(
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

522 
size_t
 
	`¬’a_m­b™s_size_decode
(size_ˆ
m­b™s
);

523 
size_t
 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
¬’a_chunk_t
 *
chunk
,

524 
size_t
 
·gešd
);

525 
size_t
 
	`¬’a_m­b™s_Ïrge_size_g‘
(
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

526 
size_t
 
	`¬’a_m­b™s_sm®l_runšd_g‘
(
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

527 
szšd_t
 
	`¬’a_m­b™s_bššd_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
);

528 
size_t
 
	`¬’a_m­b™s_dœty_g‘
(
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

529 
size_t
 
	`¬’a_m­b™s_unz”Ûd_g‘
(
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

530 
size_t
 
	`¬’a_m­b™s_decomm™‹d_g‘
(
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

531 
size_t
 
	`¬’a_m­b™s_Ïrge_g‘
(
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

532 
size_t
 
	`¬’a_m­b™s_®loÿ‹d_g‘
(
¬’a_chunk_t
 *
chunk
, size_ˆ
·gešd
);

533 
	`¬’a_m­b™¥_wr™e
(
size_t
 *
m­b™¥
, size_ˆ
m­b™s
);

534 
size_t
 
	`¬’a_m­b™s_size_’code
(size_ˆ
size
);

535 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

536 
size_t
 
size
, size_ˆ
æags
);

537 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

538 
size_t
 
size
);

539 
	`¬’a_m­b™s_š‹º®_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

540 
size_t
 
æags
);

541 
	`¬’a_m­b™s_Ïrge_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

542 
size_t
 
size
, size_ˆ
æags
);

543 
	`¬’a_m­b™s_Ïrge_bššd_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

544 
szšd_t
 
bššd
);

545 
	`¬’a_m­b™s_sm®l_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

546 
size_t
 
runšd
, 
szšd_t
 
bššd
, size_ˆ
æags
);

547 
	`¬’a_m‘ad©a_®loÿ‹d_add
(
¬’a_t
 *
¬’a
, 
size_t
 
size
);

548 
	`¬’a_m‘ad©a_®loÿ‹d_sub
(
¬’a_t
 *
¬’a
, 
size_t
 
size
);

549 
size_t
 
	`¬’a_m‘ad©a_®loÿ‹d_g‘
(
¬’a_t
 *
¬’a
);

550 
boŞ
 
	`¬’a_´of_accum_im¶
(
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
);

551 
boŞ
 
	`¬’a_´of_accum_locked
(
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
);

552 
boŞ
 
	`¬’a_´of_accum
(
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
);

553 
szšd_t
 
	`¬’a_±r_sm®l_bššd_g‘
(cÚ¡ *
±r
, 
size_t
 
m­b™s
);

554 
szšd_t
 
	`¬’a_bš_šdex
(
¬’a_t
 *
¬’a
, 
¬’a_bš_t
 *
bš
);

555 
	`¬’a_run_»gšd
(
¬’a_run_t
 *
run
, 
¬’a_bš_šfo_t
 *
bš_šfo
,

556 cÚ¡ *
±r
);

557 
´of_tùx_t
 *
	`¬’a_´of_tùx_g‘
(cÚ¡ *
±r
);

558 
	`¬’a_´of_tùx_£t
(cÚ¡ *
±r
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
);

559 
	`¬’a_´of_tùx_»£t
(cÚ¡ *
±r
, 
size_t
 
usize
,

560 cÚ¡ *
Şd_±r
, 
´of_tùx_t
 *
Şd_tùx
);

561 *
	`¬’a_m®loc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
,

562 
tÿche_t
 *
tÿche
);

563 
¬’a_t
 *
	`¬’a_¯Îoc
(cÚ¡ *
±r
);

564 
size_t
 
	`¬’a_§Îoc
(cÚ¡ *
±r
, 
boŞ
 
demÙe
);

565 
	`¬’a_d®loc
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
);

566 
	`¬’a_sd®loc
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
);

569 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_ARENA_C_
))

570 #ifdeà
JEMALLOC_ARENA_INLINE_A


571 
JEMALLOC_ALWAYS_INLINE
 
¬’a_chunk_m­_b™s_t
 *

572 
	$¬’a_b™£lm_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

575 
	`as£¹
(
·gešd
 >ğ
m­_bŸs
);

576 
	`as£¹
(
·gešd
 < 
chunk_Åages
);

578  (&
chunk
->
m­_b™s
[
·gešd
-
m­_bŸs
]);

579 
	}
}

581 
JEMALLOC_ALWAYS_INLINE
 
¬’a_chunk_m­_misc_t
 *

582 
	$¬’a_misûlm_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

585 
	`as£¹
(
·gešd
 >ğ
m­_bŸs
);

586 
	`as£¹
(
·gešd
 < 
chunk_Åages
);

588  ((
¬’a_chunk_m­_misc_t
 *)((
ušŒ_t
)
chunk
 +

589 (
ušŒ_t
)
m­_misc_off£t
è+ 
·gešd
-
m­_bŸs
);

590 
	}
}

592 
JEMALLOC_ALWAYS_INLINE
 
size_t


593 
	$¬’a_misûlm_to_·gešd
(
¬’a_chunk_m­_misc_t
 *
misûlm
)

595 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(
misûlm
);

596 
size_t
 
·gešd
 = ((
ušŒ_t
)
misûlm
 - ((ušŒ_t)
chunk
 +

597 
m­_misc_off£t
)è/ (
¬’a_chunk_m­_misc_t
è+ 
m­_bŸs
;

599 
	`as£¹
(
·gešd
 >ğ
m­_bŸs
);

600 
	`as£¹
(
·gešd
 < 
chunk_Åages
);

602  (
·gešd
);

603 
	}
}

605 
JEMALLOC_ALWAYS_INLINE
 *

606 
	$¬’a_misûlm_to_½ages
(
¬’a_chunk_m­_misc_t
 *
misûlm
)

608 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(
misûlm
);

609 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

611  ((*)((
ušŒ_t
)
chunk
 + (
·gešd
 << 
LG_PAGE
)));

612 
	}
}

614 
JEMALLOC_ALWAYS_INLINE
 
¬’a_chunk_m­_misc_t
 *

615 
	$¬’a_rd_to_misûlm
(
¬’a_runs_dœty_lšk_t
 *
rd
)

617 
¬’a_chunk_m­_misc_t
 *
misûlm
 = (arena_chunk_map_misc_t

618 *)((
ušŒ_t
)
rd
 - 
	`off£tof
(
¬’a_chunk_m­_misc_t
,„d));

620 
	`as£¹
(
	`¬’a_misûlm_to_·gešd
(
misûlm
è>ğ
m­_bŸs
);

621 
	`as£¹
(
	`¬’a_misûlm_to_·gešd
(
misûlm
è< 
chunk_Åages
);

623  (
misûlm
);

624 
	}
}

626 
JEMALLOC_ALWAYS_INLINE
 
¬’a_chunk_m­_misc_t
 *

627 
	$¬’a_run_to_misûlm
(
¬’a_run_t
 *
run
)

629 
¬’a_chunk_m­_misc_t
 *
misûlm
 = (arena_chunk_map_misc_t

630 *)((
ušŒ_t
)
run
 - 
	`off£tof
(
¬’a_chunk_m­_misc_t
,„un));

632 
	`as£¹
(
	`¬’a_misûlm_to_·gešd
(
misûlm
è>ğ
m­_bŸs
);

633 
	`as£¹
(
	`¬’a_misûlm_to_·gešd
(
misûlm
è< 
chunk_Åages
);

635  (
misûlm
);

636 
	}
}

638 
JEMALLOC_ALWAYS_INLINE
 
size_t
 *

639 
	$¬’a_m­b™¥_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

642  (&
	`¬’a_b™£lm_g‘
(
chunk
, 
·gešd
)->
b™s
);

643 
	}
}

645 
JEMALLOC_ALWAYS_INLINE
 
size_t


646 
	$¬’a_m­b™¥_»ad
(
size_t
 *
m­b™¥
)

649  (*
m­b™¥
);

650 
	}
}

652 
JEMALLOC_ALWAYS_INLINE
 
size_t


653 
	$¬’a_m­b™s_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

656  (
	`¬’a_m­b™¥_»ad
(
	`¬’a_m­b™¥_g‘
(
chunk
, 
·gešd
)));

657 
	}
}

659 
JEMALLOC_ALWAYS_INLINE
 
size_t


660 
	$¬’a_m­b™s_size_decode
(
size_t
 
m­b™s
)

662 
size_t
 
size
;

664 #ià
CHUNK_MAP_SIZE_SHIFT
 > 0

665 
size
 = (
m­b™s
 & 
CHUNK_MAP_SIZE_MASK
è>> 
CHUNK_MAP_SIZE_SHIFT
;

666 #–ià
CHUNK_MAP_SIZE_SHIFT
 == 0

667 
size
 = 
m­b™s
 & 
CHUNK_MAP_SIZE_MASK
;

669 
size
 = (
m­b™s
 & 
CHUNK_MAP_SIZE_MASK
è<< -
CHUNK_MAP_SIZE_SHIFT
;

672  (
size
);

673 
	}
}

675 
JEMALLOC_ALWAYS_INLINE
 
size_t


676 
	$¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

678 
size_t
 
m­b™s
;

680 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

681 
	`as£¹
((
m­b™s
 & (
CHUNK_MAP_LARGE
|
CHUNK_MAP_ALLOCATED
)) == 0);

682  (
	`¬’a_m­b™s_size_decode
(
m­b™s
));

683 
	}
}

685 
JEMALLOC_ALWAYS_INLINE
 
size_t


686 
	$¬’a_m­b™s_Ïrge_size_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

688 
size_t
 
m­b™s
;

690 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

691 
	`as£¹
((
m­b™s
 & (
CHUNK_MAP_LARGE
|
CHUNK_MAP_ALLOCATED
)) ==

692 (
CHUNK_MAP_LARGE
|
CHUNK_MAP_ALLOCATED
));

693  (
	`¬’a_m­b™s_size_decode
(
m­b™s
));

694 
	}
}

696 
JEMALLOC_ALWAYS_INLINE
 
size_t


697 
	$¬’a_m­b™s_sm®l_runšd_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

699 
size_t
 
m­b™s
;

701 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

702 
	`as£¹
((
m­b™s
 & (
CHUNK_MAP_LARGE
|
CHUNK_MAP_ALLOCATED
)) ==

703 
CHUNK_MAP_ALLOCATED
);

704  (
m­b™s
 >> 
CHUNK_MAP_RUNIND_SHIFT
);

705 
	}
}

707 
JEMALLOC_ALWAYS_INLINE
 
szšd_t


708 
	$¬’a_m­b™s_bššd_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

710 
size_t
 
m­b™s
;

711 
szšd_t
 
bššd
;

713 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

714 
bššd
 = (
m­b™s
 & 
CHUNK_MAP_BININD_MASK
è>> 
CHUNK_MAP_BININD_SHIFT
;

715 
	`as£¹
(
bššd
 < 
NBINS
 || bššd =ğ
BININD_INVALID
);

716  (
bššd
);

717 
	}
}

719 
JEMALLOC_ALWAYS_INLINE
 
size_t


720 
	$¬’a_m­b™s_dœty_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

722 
size_t
 
m­b™s
;

724 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

725 
	`as£¹
((
m­b™s
 & 
CHUNK_MAP_DECOMMITTED
) == 0 || (mapbits &

726 (
CHUNK_MAP_DIRTY
|
CHUNK_MAP_UNZEROED
)) == 0);

727  (
m­b™s
 & 
CHUNK_MAP_DIRTY
);

728 
	}
}

730 
JEMALLOC_ALWAYS_INLINE
 
size_t


731 
	$¬’a_m­b™s_unz”Ûd_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

733 
size_t
 
m­b™s
;

735 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

736 
	`as£¹
((
m­b™s
 & 
CHUNK_MAP_DECOMMITTED
) == 0 || (mapbits &

737 (
CHUNK_MAP_DIRTY
|
CHUNK_MAP_UNZEROED
)) == 0);

738  (
m­b™s
 & 
CHUNK_MAP_UNZEROED
);

739 
	}
}

741 
JEMALLOC_ALWAYS_INLINE
 
size_t


742 
	$¬’a_m­b™s_decomm™‹d_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

744 
size_t
 
m­b™s
;

746 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

747 
	`as£¹
((
m­b™s
 & 
CHUNK_MAP_DECOMMITTED
) == 0 || (mapbits &

748 (
CHUNK_MAP_DIRTY
|
CHUNK_MAP_UNZEROED
)) == 0);

749  (
m­b™s
 & 
CHUNK_MAP_DECOMMITTED
);

750 
	}
}

752 
JEMALLOC_ALWAYS_INLINE
 
size_t


753 
	$¬’a_m­b™s_Ïrge_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

755 
size_t
 
m­b™s
;

757 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

758  (
m­b™s
 & 
CHUNK_MAP_LARGE
);

759 
	}
}

761 
JEMALLOC_ALWAYS_INLINE
 
size_t


762 
	$¬’a_m­b™s_®loÿ‹d_g‘
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
)

764 
size_t
 
m­b™s
;

766 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

767  (
m­b™s
 & 
CHUNK_MAP_ALLOCATED
);

768 
	}
}

770 
JEMALLOC_ALWAYS_INLINE
 

771 
	$¬’a_m­b™¥_wr™e
(
size_t
 *
m­b™¥
, size_ˆ
m­b™s
)

774 *
m­b™¥
 = 
m­b™s
;

775 
	}
}

777 
JEMALLOC_ALWAYS_INLINE
 
size_t


778 
	$¬’a_m­b™s_size_’code
(
size_t
 
size
)

780 
size_t
 
m­b™s
;

782 #ià
CHUNK_MAP_SIZE_SHIFT
 > 0

783 
m­b™s
 = 
size
 << 
CHUNK_MAP_SIZE_SHIFT
;

784 #–ià
CHUNK_MAP_SIZE_SHIFT
 == 0

785 
m­b™s
 = 
size
;

787 
m­b™s
 = 
size
 >> -
CHUNK_MAP_SIZE_SHIFT
;

790 
	`as£¹
((
m­b™s
 & ~
CHUNK_MAP_SIZE_MASK
) == 0);

791  (
m­b™s
);

792 
	}
}

794 
JEMALLOC_ALWAYS_INLINE
 

795 
	$¬’a_m­b™s_uÇÎoÿ‹d_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
, size_ˆ
size
,

796 
size_t
 
æags
)

798 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘
(
chunk
, 
·gešd
);

800 
	`as£¹
((
size
 & 
PAGE_MASK
) == 0);

801 
	`as£¹
((
æags
 & 
CHUNK_MAP_FLAGS_MASK
) == flags);

802 
	`as£¹
((
æags
 & 
CHUNK_MAP_DECOMMITTED
) == 0 || (flags &

803 (
CHUNK_MAP_DIRTY
|
CHUNK_MAP_UNZEROED
)) == 0);

804 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, 
	`¬’a_m­b™s_size_’code
(
size
) |

805 
CHUNK_MAP_BININD_INVALID
 | 
æags
);

806 
	}
}

808 
JEMALLOC_ALWAYS_INLINE
 

809 
	$¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

810 
size_t
 
size
)

812 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘
(
chunk
, 
·gešd
);

813 
size_t
 
m­b™s
 = 
	`¬’a_m­b™¥_»ad
(
m­b™¥
);

815 
	`as£¹
((
size
 & 
PAGE_MASK
) == 0);

816 
	`as£¹
((
m­b™s
 & (
CHUNK_MAP_LARGE
|
CHUNK_MAP_ALLOCATED
)) == 0);

817 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, 
	`¬’a_m­b™s_size_’code
(
size
) |

818 (
m­b™s
 & ~
CHUNK_MAP_SIZE_MASK
));

819 
	}
}

821 
JEMALLOC_ALWAYS_INLINE
 

822 
	$¬’a_m­b™s_š‹º®_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
, size_ˆ
æags
)

824 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘
(
chunk
, 
·gešd
);

826 
	`as£¹
((
æags
 & 
CHUNK_MAP_UNZEROED
) == flags);

827 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, 
æags
);

828 
	}
}

830 
JEMALLOC_ALWAYS_INLINE
 

831 
	$¬’a_m­b™s_Ïrge_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
, size_ˆ
size
,

832 
size_t
 
æags
)

834 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘
(
chunk
, 
·gešd
);

836 
	`as£¹
((
size
 & 
PAGE_MASK
) == 0);

837 
	`as£¹
((
æags
 & 
CHUNK_MAP_FLAGS_MASK
) == flags);

838 
	`as£¹
((
æags
 & 
CHUNK_MAP_DECOMMITTED
) == 0 || (flags &

839 (
CHUNK_MAP_DIRTY
|
CHUNK_MAP_UNZEROED
)) == 0);

840 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, 
	`¬’a_m­b™s_size_’code
(
size
) |

841 
CHUNK_MAP_BININD_INVALID
 | 
æags
 | 
CHUNK_MAP_LARGE
 |

842 
CHUNK_MAP_ALLOCATED
);

843 
	}
}

845 
JEMALLOC_ALWAYS_INLINE
 

846 
	$¬’a_m­b™s_Ïrge_bššd_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

847 
szšd_t
 
bššd
)

849 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘
(
chunk
, 
·gešd
);

850 
size_t
 
m­b™s
 = 
	`¬’a_m­b™¥_»ad
(
m­b™¥
);

852 
	`as£¹
(
bššd
 <ğ
BININD_INVALID
);

853 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
è=ğ
LARGE_MINCLASS
 +

854 
Ïrge_·d
);

855 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, (
m­b™s
 & ~
CHUNK_MAP_BININD_MASK
) |

856 (
bššd
 << 
CHUNK_MAP_BININD_SHIFT
));

857 
	}
}

859 
JEMALLOC_ALWAYS_INLINE
 

860 
	$¬’a_m­b™s_sm®l_£t
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
, size_ˆ
runšd
,

861 
szšd_t
 
bššd
, 
size_t
 
æags
)

863 
size_t
 *
m­b™¥
 = 
	`¬’a_m­b™¥_g‘
(
chunk
, 
·gešd
);

865 
	`as£¹
(
bššd
 < 
BININD_INVALID
);

866 
	`as£¹
(
·gešd
 - 
runšd
 >ğ
m­_bŸs
);

867 
	`as£¹
((
æags
 & 
CHUNK_MAP_UNZEROED
) == flags);

868 
	`¬’a_m­b™¥_wr™e
(
m­b™¥
, (
runšd
 << 
CHUNK_MAP_RUNIND_SHIFT
) |

869 (
bššd
 << 
CHUNK_MAP_BININD_SHIFT
è| 
æags
 | 
CHUNK_MAP_ALLOCATED
);

870 
	}
}

872 
JEMALLOC_INLINE
 

873 
	$¬’a_m‘ad©a_®loÿ‹d_add
(
¬’a_t
 *
¬’a
, 
size_t
 
size
)

876 
	`©omic_add_z
(&
¬’a
->
¡©s
.
m‘ad©a_®loÿ‹d
, 
size
);

877 
	}
}

879 
JEMALLOC_INLINE
 

880 
	$¬’a_m‘ad©a_®loÿ‹d_sub
(
¬’a_t
 *
¬’a
, 
size_t
 
size
)

883 
	`©omic_sub_z
(&
¬’a
->
¡©s
.
m‘ad©a_®loÿ‹d
, 
size
);

884 
	}
}

886 
JEMALLOC_INLINE
 
size_t


887 
	$¬’a_m‘ad©a_®loÿ‹d_g‘
(
¬’a_t
 *
¬’a
)

890  (
	`©omic_»ad_z
(&
¬’a
->
¡©s
.
m‘ad©a_®loÿ‹d
));

891 
	}
}

893 
JEMALLOC_INLINE
 
boŞ


894 
	$¬’a_´of_accum_im¶
(
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
)

897 
	`ÿs£¹
(
cÚfig_´of
);

898 
	`as£¹
(
´of_š‹rv®
 != 0);

900 
¬’a
->
´of_accumby‹s
 +ğ
accumby‹s
;

901 ià(
¬’a
->
´of_accumby‹s
 >ğ
´of_š‹rv®
) {

902 
¬’a
->
´of_accumby‹s
 -ğ
´of_š‹rv®
;

903  (
Œue
);

905  (
çl£
);

906 
	}
}

908 
JEMALLOC_INLINE
 
boŞ


909 
	$¬’a_´of_accum_locked
(
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
)

912 
	`ÿs£¹
(
cÚfig_´of
);

914 ià(
	`lik–y
(
´of_š‹rv®
 == 0))

915  (
çl£
);

916  (
	`¬’a_´of_accum_im¶
(
¬’a
, 
accumby‹s
));

917 
	}
}

919 
JEMALLOC_INLINE
 
boŞ


920 
	$¬’a_´of_accum
(
¬’a_t
 *
¬’a
, 
ušt64_t
 
accumby‹s
)

923 
	`ÿs£¹
(
cÚfig_´of
);

925 ià(
	`lik–y
(
´of_š‹rv®
 == 0))

926  (
çl£
);

929 
boŞ
 
»t
;

931 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

932 
»t
 = 
	`¬’a_´of_accum_im¶
(
¬’a
, 
accumby‹s
);

933 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

934  (
»t
);

936 
	}
}

938 
JEMALLOC_ALWAYS_INLINE
 
szšd_t


939 
	$¬’a_±r_sm®l_bššd_g‘
(cÚ¡ *
±r
, 
size_t
 
m­b™s
)

941 
szšd_t
 
bššd
;

943 
bššd
 = (
m­b™s
 & 
CHUNK_MAP_BININD_MASK
è>> 
CHUNK_MAP_BININD_SHIFT
;

945 ià(
cÚfig_debug
) {

946 
¬’a_chunk_t
 *
chunk
;

947 
¬’a_t
 *
¬’a
;

948 
size_t
 
·gešd
;

949 
size_t
 
aùu®_m­b™s
;

950 
size_t
 
½ages_šd
;

951 
¬’a_run_t
 *
run
;

952 
¬’a_bš_t
 *
bš
;

953 
szšd_t
 
run_bššd
, 
aùu®_bššd
;

954 
¬’a_bš_šfo_t
 *
bš_šfo
;

955 
¬’a_chunk_m­_misc_t
 *
misûlm
;

956 *
½ages
;

958 
	`as£¹
(
bššd
 !ğ
BININD_INVALID
);

959 
	`as£¹
(
bššd
 < 
NBINS
);

960 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

961 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
);

962 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

963 
aùu®_m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

964 
	`as£¹
(
m­b™s
 =ğ
aùu®_m­b™s
);

965 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) == 0);

966 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) != 0);

967 
½ages_šd
 = 
·gešd
 - 
	`¬’a_m­b™s_sm®l_runšd_g‘
(
chunk
,

968 
·gešd
);

969 
misûlm
 = 
	`¬’a_misûlm_g‘
(
chunk
, 
½ages_šd
);

970 
run
 = &
misûlm
->run;

971 
run_bššd
 = 
run
->
bššd
;

972 
bš
 = &
¬’a
->
bšs
[
run_bššd
];

973 
aùu®_bššd
 = 
bš
 - 
¬’a
->
bšs
;

974 
	`as£¹
(
run_bššd
 =ğ
aùu®_bššd
);

975 
bš_šfo
 = &
¬’a_bš_šfo
[
aùu®_bššd
];

976 
½ages
 = 
	`¬’a_misûlm_to_½ages
(
misûlm
);

977 
	`as£¹
(((
ušŒ_t
)
±r
 - ((ušŒ_t)
½ages
 +

978 (
ušŒ_t
)
bš_šfo
->
»g0_off£t
)è% bš_šfo->
»g_š‹rv®


982  (
bššd
);

983 
	}
}

986 #ifdeà
JEMALLOC_ARENA_INLINE_B


987 
JEMALLOC_INLINE
 
szšd_t


988 
	$¬’a_bš_šdex
(
¬’a_t
 *
¬’a
, 
¬’a_bš_t
 *
bš
)

990 
szšd_t
 
bššd
 = 
bš
 - 
¬’a
->
bšs
;

991 
	`as£¹
(
bššd
 < 
NBINS
);

992  (
bššd
);

993 
	}
}

995 
JEMALLOC_INLINE
 

996 
	$¬’a_run_»gšd
(
¬’a_run_t
 *
run
, 
¬’a_bš_šfo_t
 *
bš_šfo
, cÚ¡ *
±r
)

998 
shiá
, 
diff
, 
»gšd
;

999 
size_t
 
š‹rv®
;

1000 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

1001 *
½ages
 = 
	`¬’a_misûlm_to_½ages
(
misûlm
);

1007 
	`as£¹
((
ušŒ_t
)
±r
 >ğ(ušŒ_t)
½ages
 +

1008 (
ušŒ_t
)
bš_šfo
->
»g0_off£t
);

1014 
diff
 = ()((
ušŒ_t
)
±r
 - (ušŒ_t)
½ages
 -

1015 
bš_šfo
->
»g0_off£t
);

1018 
š‹rv®
 = 
bš_šfo
->
»g_š‹rv®
;

1019 
shiá
 = 
	`jem®loc_ffs
(
š‹rv®
) - 1;

1020 
diff
 >>ğ
shiá
;

1021 
š‹rv®
 >>ğ
shiá
;

1023 ià(
š‹rv®
 == 1) {

1025 
»gšd
 = 
diff
;

1041 
	#SIZE_INV_SHIFT
 (((è<< 3è- 
LG_RUN_MAXREGS
)

	)

1042 
	#SIZE_INV
(
s
è(((1U << 
SIZE_INV_SHIFT
è/ (s)è+ 1)

	)

1043 cÚ¡ 
š‹rv®_švs
[] = {

1044 
	`SIZE_INV
(3),

1045 
	`SIZE_INV
(4), SIZE_INV(5), SIZE_INV(6), SIZE_INV(7),

1046 
	`SIZE_INV
(8), SIZE_INV(9), SIZE_INV(10), SIZE_INV(11),

1047 
	`SIZE_INV
(12), SIZE_INV(13), SIZE_INV(14), SIZE_INV(15),

1048 
	`SIZE_INV
(16), SIZE_INV(17), SIZE_INV(18), SIZE_INV(19),

1049 
	`SIZE_INV
(20), SIZE_INV(21), SIZE_INV(22), SIZE_INV(23),

1050 
	`SIZE_INV
(24), SIZE_INV(25), SIZE_INV(26), SIZE_INV(27),

1051 
	`SIZE_INV
(28), SIZE_INV(29), SIZE_INV(30), SIZE_INV(31)

1054 ià(
	`lik–y
(
š‹rv®
 <ğ(((
š‹rv®_švs
) /

1056 
»gšd
 = (
diff
 * 
š‹rv®_švs
[
š‹rv®
 - 3]) >>

1057 
SIZE_INV_SHIFT
;

1059 
»gšd
 = 
diff
 / 
š‹rv®
;

1060 #undeà
SIZE_INV


1061 #undeà
SIZE_INV_SHIFT


1063 
	`as£¹
(
diff
 =ğ
»gšd
 * 
š‹rv®
);

1064 
	`as£¹
(
»gšd
 < 
bš_šfo
->
Äegs
);

1066  (
»gšd
);

1067 
	}
}

1069 
JEMALLOC_INLINE
 
´of_tùx_t
 *

1070 
	$¬’a_´of_tùx_g‘
(cÚ¡ *
±r
)

1072 
´of_tùx_t
 *
»t
;

1073 
¬’a_chunk_t
 *
chunk
;

1075 
	`ÿs£¹
(
cÚfig_´of
);

1076 
	`as£¹
(
±r
 !ğ
NULL
);

1078 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1079 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1080 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

1081 
size_t
 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

1082 
	`as£¹
((
m­b™s
 & 
CHUNK_MAP_ALLOCATED
) != 0);

1083 ià(
	`lik–y
((
m­b™s
 & 
CHUNK_MAP_LARGE
) == 0))

1084 
»t
 = (
´of_tùx_t
 *)(
ušŒ_t
)1U;

1086 
¬’a_chunk_m­_misc_t
 *
–m
 = 
	`¬’a_misûlm_g‘
(
chunk
,

1087 
·gešd
);

1088 
»t
 = 
	`©omic_»ad_p
(&
–m
->
´of_tùx_pun
);

1091 
»t
 = 
	`huge_´of_tùx_g‘
(
±r
);

1093  (
»t
);

1094 
	}
}

1096 
JEMALLOC_INLINE
 

1097 
	$¬’a_´of_tùx_£t
(cÚ¡ *
±r
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
)

1099 
¬’a_chunk_t
 *
chunk
;

1101 
	`ÿs£¹
(
cÚfig_´of
);

1102 
	`as£¹
(
±r
 !ğ
NULL
);

1104 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1105 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1106 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

1108 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) != 0);

1110 ià(
	`uÆik–y
(
usize
 > 
SMALL_MAXCLASS
 || (
ušŒ_t
)
tùx
 >

1111 (
ušŒ_t
)1U)) {

1112 
¬’a_chunk_m­_misc_t
 *
–m
;

1114 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) != 0);

1116 
–m
 = 
	`¬’a_misûlm_g‘
(
chunk
, 
·gešd
);

1117 
	`©omic_wr™e_p
(&
–m
->
´of_tùx_pun
, 
tùx
);

1125 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) == 0);

1128 
	`huge_´of_tùx_£t
(
±r
, 
tùx
);

1129 
	}
}

1131 
JEMALLOC_INLINE
 

1132 
	$¬’a_´of_tùx_»£t
(cÚ¡ *
±r
, 
size_t
 
usize
, cÚ¡ *
Şd_±r
,

1133 
´of_tùx_t
 *
Şd_tùx
)

1136 
	`ÿs£¹
(
cÚfig_´of
);

1137 
	`as£¹
(
±r
 !ğ
NULL
);

1139 ià(
	`uÆik–y
(
usize
 > 
SMALL_MAXCLASS
 || (
±r
 =ğ
Şd_±r
 &&

1140 (
ušŒ_t
)
Şd_tùx
 > (uintptr_t)1U))) {

1141 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(
±r
);

1142 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1143 
size_t
 
·gešd
;

1144 
¬’a_chunk_m­_misc_t
 *
–m
;

1146 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
) >>

1147 
LG_PAGE
;

1148 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) !=

1150 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) != 0);

1152 
–m
 = 
	`¬’a_misûlm_g‘
(
chunk
, 
·gešd
);

1153 
	`©omic_wr™e_p
(&
–m
->
´of_tùx_pun
,

1154 (
´of_tùx_t
 *)(
ušŒ_t
)1U);

1156 
	`huge_´of_tùx_»£t
(
±r
);

1158 
	}
}

1160 
JEMALLOC_ALWAYS_INLINE
 *

1161 
	$¬’a_m®loc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
,

1162 
tÿche_t
 *
tÿche
)

1165 
	`as£¹
(
size
 != 0);

1167 
¬’a
 = 
	`¬’a_choo£
(
tsd
,‡rena);

1168 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
))

1169  (
NULL
);

1171 ià(
	`lik–y
(
size
 <ğ
SMALL_MAXCLASS
)) {

1172 ià(
	`lik–y
(
tÿche
 !ğ
NULL
)) {

1173  (
	`tÿche_®loc_sm®l
(
tsd
, 
¬’a
, 
tÿche
, 
size
,

1174 
z”o
));

1176  (
	`¬’a_m®loc_sm®l
(
¬’a
, 
size
, 
z”o
));

1177 } ià(
	`lik–y
(
size
 <ğ
Ïrge_maxşass
)) {

1182 ià(
	`lik–y
(
tÿche
 !ğ
NULL
è&& 
size
 <ğ
tÿche_maxşass
) {

1183  (
	`tÿche_®loc_Ïrge
(
tsd
, 
¬’a
, 
tÿche
, 
size
,

1184 
z”o
));

1186  (
	`¬’a_m®loc_Ïrge
(
¬’a
, 
size
, 
z”o
));

1188  (
	`huge_m®loc
(
tsd
, 
¬’a
, 
size
, 
z”o
, 
tÿche
));

1189 
	}
}

1191 
JEMALLOC_ALWAYS_INLINE
 
¬’a_t
 *

1192 
	$¬’a_¯Îoc
(cÚ¡ *
±r
)

1194 
¬’a_chunk_t
 *
chunk
;

1196 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1197 ià(
	`lik–y
(
chunk
 !ğ
±r
))

1198  (
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
));

1200  (
	`huge_¯Îoc
(
±r
));

1201 
	}
}

1204 
JEMALLOC_ALWAYS_INLINE
 
size_t


1205 
	$¬’a_§Îoc
(cÚ¡ *
±r
, 
boŞ
 
demÙe
)

1207 
size_t
 
»t
;

1208 
¬’a_chunk_t
 *
chunk
;

1209 
size_t
 
·gešd
;

1210 
szšd_t
 
bššd
;

1212 
	`as£¹
(
±r
 !ğ
NULL
);

1214 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1215 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1216 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

1217 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) != 0);

1218 
bššd
 = 
	`¬’a_m­b™s_bššd_g‘
(
chunk
, 
·gešd
);

1219 ià(
	`uÆik–y
(
bššd
 =ğ
BININD_INVALID
 || (
cÚfig_´of
 && !
demÙe


1220 && 
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) != 0))) {

1227 
	`as£¹
(
cÚfig_ÿche_oblivious
 || ((
ušŒ_t
)
±r
 &

1228 
PAGE_MASK
) == 0);

1229 
»t
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
) -

1230 
Ïrge_·d
;

1231 
	`as£¹
(
»t
 != 0);

1232 
	`as£¹
(
·gešd
 + ((
»t
+
Ïrge_·d
)>>
LG_PAGE
) <=

1233 
chunk_Åages
);

1234 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
) ==

1235 
	`¬’a_m­b™s_dœty_g‘
(
chunk
,

1236 
·gešd
+((
»t
+
Ïrge_·d
)>>
LG_PAGE
)-1));

1242 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) != 0 ||

1243 
	`¬’a_±r_sm®l_bššd_g‘
(
±r
,

1244 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
)è=ğ
bššd
);

1245 
»t
 = 
	`šdex2size
(
bššd
);

1248 
»t
 = 
	`huge_§Îoc
(
±r
);

1250  (
»t
);

1251 
	}
}

1253 
JEMALLOC_ALWAYS_INLINE
 

1254 
	$¬’a_d®loc
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
)

1256 
¬’a_chunk_t
 *
chunk
;

1257 
size_t
 
·gešd
, 
m­b™s
;

1259 
	`as£¹
(
±r
 !ğ
NULL
);

1261 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1262 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1263 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

1264 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

1265 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) != 0);

1266 ià(
	`lik–y
((
m­b™s
 & 
CHUNK_MAP_LARGE
) == 0)) {

1268 ià(
	`lik–y
(
tÿche
 !ğ
NULL
)) {

1269 
szšd_t
 
bššd
 = 
	`¬’a_±r_sm®l_bššd_g‘
(
±r
,

1270 
m­b™s
);

1271 
	`tÿche_d®loc_sm®l
(
tsd
, 
tÿche
, 
±r
, 
bššd
);

1273 
	`¬’a_d®loc_sm®l
(
	`ex‹Á_node_¬’a_g‘
(

1274 &
chunk
->
node
), chunk, 
±r
, 
·gešd
);

1277 
size_t
 
size
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
,

1278 
·gešd
);

1280 
	`as£¹
(
cÚfig_ÿche_oblivious
 || ((
ušŒ_t
)
±r
 &

1281 
PAGE_MASK
) == 0);

1283 ià(
	`lik–y
(
tÿche
 !ğ
NULL
è&& 
size
 - 
Ïrge_·d
 <=

1284 
tÿche_maxşass
) {

1285 
	`tÿche_d®loc_Ïrge
(
tsd
, 
tÿche
, 
±r
, 
size
 -

1286 
Ïrge_·d
);

1288 
	`¬’a_d®loc_Ïrge
(
	`ex‹Á_node_¬’a_g‘
(

1289 &
chunk
->
node
), chunk, 
±r
);

1293 
	`huge_d®loc
(
tsd
, 
±r
, 
tÿche
);

1294 
	}
}

1296 
JEMALLOC_ALWAYS_INLINE
 

1297 
	$¬’a_sd®loc
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
)

1299 
¬’a_chunk_t
 *
chunk
;

1301 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

1302 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

1303 ià(
cÚfig_´of
 && 
İt_´of
) {

1304 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
) >>

1305 
LG_PAGE
;

1306 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) != 0);

1307 ià(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) != 0) {

1312 
size
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
,

1313 
·gešd
è- 
Ïrge_·d
;

1316 
	`as£¹
(
	`s2u
(
size
è=ğs2u(
	`¬’a_§Îoc
(
±r
, 
çl£
)));

1318 ià(
	`lik–y
(
size
 <ğ
SMALL_MAXCLASS
)) {

1320 ià(
	`lik–y
(
tÿche
 !ğ
NULL
)) {

1321 
szšd_t
 
bššd
 = 
	`size2šdex
(
size
);

1322 
	`tÿche_d®loc_sm®l
(
tsd
, 
tÿche
, 
±r
, 
bššd
);

1324 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 -

1325 (
ušŒ_t
)
chunk
è>> 
LG_PAGE
;

1326 
	`¬’a_d®loc_sm®l
(
	`ex‹Á_node_¬’a_g‘
(

1327 &
chunk
->
node
), chunk, 
±r
, 
·gešd
);

1330 
	`as£¹
(
cÚfig_ÿche_oblivious
 || ((
ušŒ_t
)
±r
 &

1331 
PAGE_MASK
) == 0);

1333 ià(
	`lik–y
(
tÿche
 !ğ
NULL
è&& 
size
 <ğ
tÿche_maxşass
)

1334 
	`tÿche_d®loc_Ïrge
(
tsd
, 
tÿche
, 
±r
, 
size
);

1336 
	`¬’a_d®loc_Ïrge
(
	`ex‹Á_node_¬’a_g‘
(

1337 &
chunk
->
node
), chunk, 
±r
);

1341 
	`huge_d®loc
(
tsd
, 
±r
, 
tÿche
);

1342 
	}
}

	@deps/jemalloc/include/jemalloc/internal/atomic.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


12 
	#©omic_»ad_ušt64
(
p
è
	`©omic_add_ušt64
Õ, 0)

	)

13 
	#©omic_»ad_ušt32
(
p
è
	`©omic_add_ušt32
Õ, 0)

	)

14 
	#©omic_»ad_p
(
p
è
	`©omic_add_p
Õ, 
NULL
)

	)

15 
	#©omic_»ad_z
(
p
è
	`©omic_add_z
Õ, 0)

	)

16 
	#©omic_»ad_u
(
p
è
	`©omic_add_u
Õ, 0)

	)

20 #ifdeà
JEMALLOC_H_INLINES


43 #iâdeà
JEMALLOC_ENABLE_INLINE


44 
ušt64_t
 
©omic_add_ušt64
(ušt64_ˆ*
p
, ušt64_ˆ
x
);

45 
ušt64_t
 
©omic_sub_ušt64
(ušt64_ˆ*
p
, ušt64_ˆ
x
);

46 
boŞ
 
©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
);

47 
©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
);

48 
ušt32_t
 
©omic_add_ušt32
(ušt32_ˆ*
p
, ušt32_ˆ
x
);

49 
ušt32_t
 
©omic_sub_ušt32
(ušt32_ˆ*
p
, ušt32_ˆ
x
);

50 
boŞ
 
©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
);

51 
©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
);

52 *
©omic_add_p
(**
p
, *
x
);

53 *
©omic_sub_p
(**
p
, *
x
);

54 
boŞ
 
©omic_ÿs_p
(**
p
, *
c
, *
s
);

55 
©omic_wr™e_p
(**
p
, cÚ¡ *
x
);

56 
size_t
 
©omic_add_z
(size_ˆ*
p
, size_ˆ
x
);

57 
size_t
 
©omic_sub_z
(size_ˆ*
p
, size_ˆ
x
);

58 
boŞ
 
©omic_ÿs_z
(
size_t
 *
p
, size_ˆ
c
, size_ˆ
s
);

59 
©omic_wr™e_z
(
size_t
 *
p
, size_ˆ
x
);

60 
©omic_add_u
(*
p
, 
x
);

61 
©omic_sub_u
(*
p
, 
x
);

62 
boŞ
 
©omic_ÿs_u
(*
p
, 
c
, 
s
);

63 
©omic_wr™e_u
(*
p
, 
x
);

66 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_ATOMIC_C_
))

69 #ià(
LG_SIZEOF_PTR
 =ğ3 || 
LG_SIZEOF_INT
 == 3)

70 #ià(
defšed
(
__amd64__
è|| defšed(
__x86_64__
))

71 
JEMALLOC_INLINE
 
ušt64_t


72 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

74 
ušt64_t
 
t
 = 
x
;

76 
asm
 volatile (

78 : "+r" (
t
), "=m" (*
p
)

79 : "m" (*
p
)

82  (
t
 + 
x
);

83 
	}
}

85 
JEMALLOC_INLINE
 
ušt64_t


86 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

88 
ušt64_t
 
t
;

90 
x
 = (
ušt64_t
)(-(
št64_t
)x);

91 
t
 = 
x
;

92 
asm
 volatile (

94 : "+r" (
t
), "=m" (*
p
)

95 : "m" (*
p
)

98  (
t
 + 
x
);

99 
	}
}

101 
JEMALLOC_INLINE
 
boŞ


102 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

104 
ušt8_t
 
sucûss
;

106 
asm
 volatile (

109 : "=m" (*
p
), "÷" (
sucûss
)

110 : "m" (*
p
), "a" (
c
), "r" (
s
)

114  (!(
boŞ
)
sucûss
);

115 
	}
}

117 
JEMALLOC_INLINE
 

118 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

121 
asm
 volatile (

123 : "=m" (*
p
), "+r" (
x
)

124 : "m" (*
p
)

127 
	}
}

128 #–ià(
defšed
(
JEMALLOC_C11ATOMICS
))

129 
JEMALLOC_INLINE
 
ušt64_t


130 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

132 vŞ©
©omic_ušt_Ëa¡64_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡64_ˆ*)
p
;

133  (
	`©omic_ãtch_add
(
a
, 
x
) + x);

134 
	}
}

136 
JEMALLOC_INLINE
 
ušt64_t


137 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

139 vŞ©
©omic_ušt_Ëa¡64_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡64_ˆ*)
p
;

140  (
	`©omic_ãtch_sub
(
a
, 
x
) - x);

141 
	}
}

143 
JEMALLOC_INLINE
 
boŞ


144 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

146 vŞ©
©omic_ušt_Ëa¡64_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡64_ˆ*)
p
;

147  (!
	`©omic_com·»_exchªge_¡rÚg
(
a
, &
c
, 
s
));

148 
	}
}

150 
JEMALLOC_INLINE
 

151 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

153 vŞ©
©omic_ušt_Ëa¡64_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡64_ˆ*)
p
;

154 
	`©omic_¡Üe
(
a
, 
x
);

155 
	}
}

156 #–ià(
defšed
(
JEMALLOC_ATOMIC9
))

157 
JEMALLOC_INLINE
 
ušt64_t


158 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

165 
	`as£¹
((
ušt64_t
) == ());

167  (
	`©omic_ãtchadd_lÚg
(
p
, ()
x
) + x);

168 
	}
}

170 
JEMALLOC_INLINE
 
ušt64_t


171 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

174 
	`as£¹
((
ušt64_t
) == ());

176  (
	`©omic_ãtchadd_lÚg
(
p
, ()(-()
x
)) - x);

177 
	}
}

179 
JEMALLOC_INLINE
 
boŞ


180 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

183 
	`as£¹
((
ušt64_t
) == ());

185  (!
	`©omic_cmp£t_lÚg
(
p
, ()
c
, ()
s
));

186 
	}
}

188 
JEMALLOC_INLINE
 

189 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

192 
	`as£¹
((
ušt64_t
) == ());

194 
	`©omic_¡Üe_»l_lÚg
(
p
, 
x
);

195 
	}
}

196 #–ià(
defšed
(
JEMALLOC_OSATOMIC
))

197 
JEMALLOC_INLINE
 
ušt64_t


198 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

201  (
	`OSAtomicAdd64
((
št64_t
)
x
, (št64_ˆ*)
p
));

202 
	}
}

204 
JEMALLOC_INLINE
 
ušt64_t


205 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

208  (
	`OSAtomicAdd64
(-((
št64_t
)
x
), (št64_ˆ*)
p
));

209 
	}
}

211 
JEMALLOC_INLINE
 
boŞ


212 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

215  (!
	`OSAtomicCom·»AndSw­64
(
c
, 
s
, (
št64_t
 *)
p
));

216 
	}
}

218 
JEMALLOC_INLINE
 

219 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

221 
ušt64_t
 
o
;

225 
o
 = 
	`©omic_»ad_ušt64
(
p
);

226 } 
	`©omic_ÿs_ušt64
(
p
, 
o
, 
x
));

227 
	}
}

228 #–ià(
defšed
(
_MSC_VER
))

229 
JEMALLOC_INLINE
 
ušt64_t


230 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

233  (
	`IÁ”lockedExchªgeAdd64
(
p
, 
x
) + x);

234 
	}
}

236 
JEMALLOC_INLINE
 
ušt64_t


237 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

240  (
	`IÁ”lockedExchªgeAdd64
(
p
, -((
št64_t
)
x
)) - x);

241 
	}
}

243 
JEMALLOC_INLINE
 
boŞ


244 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

246 
ušt64_t
 
o
;

248 
o
 = 
	`IÁ”lockedCom·»Exchªge64
(
p
, 
s
, 
c
);

249  (
o
 !ğ
c
);

250 
	}
}

252 
JEMALLOC_INLINE
 

253 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

256 
	`IÁ”lockedExchªge64
(
p
, 
x
);

257 
	}
}

258 #–ià(
defšed
(
__GCC_HAVE_SYNC_COMPARE_AND_SWAP_8
) || \

259 
	$defšed
(
JE_FORCE_SYNC_COMPARE_AND_SWAP_8
))

260 
JEMALLOC_INLINE
 
ušt64_t


261 
	$©omic_add_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

264  (
	`__sync_add_ªd_ãtch
(
p
, 
x
));

265 
	}
}

267 
JEMALLOC_INLINE
 
ušt64_t


268 
	$©omic_sub_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

271  (
	`__sync_sub_ªd_ãtch
(
p
, 
x
));

272 
	}
}

274 
JEMALLOC_INLINE
 
boŞ


275 
	$©omic_ÿs_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
c
, ušt64_ˆ
s
)

278  (!
	`__sync_boŞ_com·»_ªd_sw­
(
p
, 
c
, 
s
));

279 
	}
}

281 
JEMALLOC_INLINE
 

282 
	$©omic_wr™e_ušt64
(
ušt64_t
 *
p
, ušt64_ˆ
x
)

285 
	`__sync_lock_‹¡_ªd_£t
(
p
, 
x
);

286 
	}
}

294 #ià(
defšed
(
__i386__
è|| defšed(
__amd64__
è|| defšed(
__x86_64__
))

295 
JEMALLOC_INLINE
 
ušt32_t


296 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

298 
ušt32_t
 
t
 = 
x
;

300 
asm
 volatile (

302 : "+r" (
t
), "=m" (*
p
)

303 : "m" (*
p
)

306  (
t
 + 
x
);

307 
	}
}

309 
JEMALLOC_INLINE
 
ušt32_t


310 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

312 
ušt32_t
 
t
;

314 
x
 = (
ušt32_t
)(-(
št32_t
)x);

315 
t
 = 
x
;

316 
asm
 volatile (

318 : "+r" (
t
), "=m" (*
p
)

319 : "m" (*
p
)

322  (
t
 + 
x
);

323 
	}
}

325 
JEMALLOC_INLINE
 
boŞ


326 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

328 
ušt8_t
 
sucûss
;

330 
asm
 volatile (

333 : "=m" (*
p
), "÷" (
sucûss
)

334 : "m" (*
p
), "a" (
c
), "r" (
s
)

338  (!(
boŞ
)
sucûss
);

339 
	}
}

341 
JEMALLOC_INLINE
 

342 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

345 
asm
 volatile (

347 : "=m" (*
p
), "+r" (
x
)

348 : "m" (*
p
)

351 
	}
}

352 #–ià(
defšed
(
JEMALLOC_C11ATOMICS
))

353 
JEMALLOC_INLINE
 
ušt32_t


354 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

356 vŞ©
©omic_ušt_Ëa¡32_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡32_ˆ*)
p
;

357  (
	`©omic_ãtch_add
(
a
, 
x
) + x);

358 
	}
}

360 
JEMALLOC_INLINE
 
ušt32_t


361 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

363 vŞ©
©omic_ušt_Ëa¡32_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡32_ˆ*)
p
;

364  (
	`©omic_ãtch_sub
(
a
, 
x
) - x);

365 
	}
}

367 
JEMALLOC_INLINE
 
boŞ


368 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

370 vŞ©
©omic_ušt_Ëa¡32_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡32_ˆ*)
p
;

371  (!
	`©omic_com·»_exchªge_¡rÚg
(
a
, &
c
, 
s
));

372 
	}
}

374 
JEMALLOC_INLINE
 

375 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

377 vŞ©
©omic_ušt_Ëa¡32_t
 *
a
 = (vŞ©©omic_ušt_Ëa¡32_ˆ*)
p
;

378 
	`©omic_¡Üe
(
a
, 
x
);

379 
	}
}

380 #–ià(
defšed
(
JEMALLOC_ATOMIC9
))

381 
JEMALLOC_INLINE
 
ušt32_t


382 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

385  (
	`©omic_ãtchadd_32
(
p
, 
x
) + x);

386 
	}
}

388 
JEMALLOC_INLINE
 
ušt32_t


389 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

392  (
	`©omic_ãtchadd_32
(
p
, (
ušt32_t
)(-(
št32_t
)
x
)) - x);

393 
	}
}

395 
JEMALLOC_INLINE
 
boŞ


396 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

399  (!
	`©omic_cmp£t_32
(
p
, 
c
, 
s
));

400 
	}
}

402 
JEMALLOC_INLINE
 

403 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

406 
	`©omic_¡Üe_»l_32
(
p
, 
x
);

407 
	}
}

408 #–ià(
defšed
(
JEMALLOC_OSATOMIC
))

409 
JEMALLOC_INLINE
 
ušt32_t


410 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

413  (
	`OSAtomicAdd32
((
št32_t
)
x
, (št32_ˆ*)
p
));

414 
	}
}

416 
JEMALLOC_INLINE
 
ušt32_t


417 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

420  (
	`OSAtomicAdd32
(-((
št32_t
)
x
), (št32_ˆ*)
p
));

421 
	}
}

423 
JEMALLOC_INLINE
 
boŞ


424 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

427  (!
	`OSAtomicCom·»AndSw­32
(
c
, 
s
, (
št32_t
 *)
p
));

428 
	}
}

430 
JEMALLOC_INLINE
 

431 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

433 
ušt32_t
 
o
;

437 
o
 = 
	`©omic_»ad_ušt32
(
p
);

438 } 
	`©omic_ÿs_ušt32
(
p
, 
o
, 
x
));

439 
	}
}

440 #–ià(
defšed
(
_MSC_VER
))

441 
JEMALLOC_INLINE
 
ušt32_t


442 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

445  (
	`IÁ”lockedExchªgeAdd
(
p
, 
x
) + x);

446 
	}
}

448 
JEMALLOC_INLINE
 
ušt32_t


449 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

452  (
	`IÁ”lockedExchªgeAdd
(
p
, -((
št32_t
)
x
)) - x);

453 
	}
}

455 
JEMALLOC_INLINE
 
boŞ


456 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

458 
ušt32_t
 
o
;

460 
o
 = 
	`IÁ”lockedCom·»Exchªge
(
p
, 
s
, 
c
);

461  (
o
 !ğ
c
);

462 
	}
}

464 
JEMALLOC_INLINE
 

465 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

468 
	`IÁ”lockedExchªge
(
p
, 
x
);

469 
	}
}

470 #–ià(
defšed
(
__GCC_HAVE_SYNC_COMPARE_AND_SWAP_4
) || \

471 
	$defšed
(
JE_FORCE_SYNC_COMPARE_AND_SWAP_4
))

472 
JEMALLOC_INLINE
 
ušt32_t


473 
	$©omic_add_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

476  (
	`__sync_add_ªd_ãtch
(
p
, 
x
));

477 
	}
}

479 
JEMALLOC_INLINE
 
ušt32_t


480 
	$©omic_sub_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

483  (
	`__sync_sub_ªd_ãtch
(
p
, 
x
));

484 
	}
}

486 
JEMALLOC_INLINE
 
boŞ


487 
	$©omic_ÿs_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
c
, ušt32_ˆ
s
)

490  (!
	`__sync_boŞ_com·»_ªd_sw­
(
p
, 
c
, 
s
));

491 
	}
}

493 
JEMALLOC_INLINE
 

494 
	$©omic_wr™e_ušt32
(
ušt32_t
 *
p
, ušt32_ˆ
x
)

497 
	`__sync_lock_‹¡_ªd_£t
(
p
, 
x
);

498 
	}
}

505 
JEMALLOC_INLINE
 *

506 
	$©omic_add_p
(**
p
, *
x
)

509 #ià(
LG_SIZEOF_PTR
 == 3)

510  ((*)
	`©omic_add_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
));

511 #–ià(
LG_SIZEOF_PTR
 == 2)

512  ((*)
	`©omic_add_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
));

514 
	}
}

516 
JEMALLOC_INLINE
 *

517 
	$©omic_sub_p
(**
p
, *
x
)

520 #ià(
LG_SIZEOF_PTR
 == 3)

521  ((*)
	`©omic_add_ušt64
((
ušt64_t
 *)
p
,

522 (
ušt64_t
)-((
št64_t
)
x
)));

523 #–ià(
LG_SIZEOF_PTR
 == 2)

524  ((*)
	`©omic_add_ušt32
((
ušt32_t
 *)
p
,

525 (
ušt32_t
)-((
št32_t
)
x
)));

527 
	}
}

529 
JEMALLOC_INLINE
 
boŞ


530 
	$©omic_ÿs_p
(**
p
, *
c
, *
s
)

533 #ià(
LG_SIZEOF_PTR
 == 3)

534  (
	`©omic_ÿs_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
c
, (ušt64_t)
s
));

535 #–ià(
LG_SIZEOF_PTR
 == 2)

536  (
	`©omic_ÿs_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
c
, (ušt32_t)
s
));

538 
	}
}

540 
JEMALLOC_INLINE
 

541 
	$©omic_wr™e_p
(**
p
, cÚ¡ *
x
)

544 #ià(
LG_SIZEOF_PTR
 == 3)

545 
	`©omic_wr™e_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
);

546 #–ià(
LG_SIZEOF_PTR
 == 2)

547 
	`©omic_wr™e_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
);

549 
	}
}

553 
JEMALLOC_INLINE
 
size_t


554 
	$©omic_add_z
(
size_t
 *
p
, size_ˆ
x
)

557 #ià(
LG_SIZEOF_PTR
 == 3)

558  ((
size_t
)
	`©omic_add_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
));

559 #–ià(
LG_SIZEOF_PTR
 == 2)

560  ((
size_t
)
	`©omic_add_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
));

562 
	}
}

564 
JEMALLOC_INLINE
 
size_t


565 
	$©omic_sub_z
(
size_t
 *
p
, size_ˆ
x
)

568 #ià(
LG_SIZEOF_PTR
 == 3)

569  ((
size_t
)
	`©omic_add_ušt64
((
ušt64_t
 *)
p
,

570 (
ušt64_t
)-((
št64_t
)
x
)));

571 #–ià(
LG_SIZEOF_PTR
 == 2)

572  ((
size_t
)
	`©omic_add_ušt32
((
ušt32_t
 *)
p
,

573 (
ušt32_t
)-((
št32_t
)
x
)));

575 
	}
}

577 
JEMALLOC_INLINE
 
boŞ


578 
	$©omic_ÿs_z
(
size_t
 *
p
, size_ˆ
c
, size_ˆ
s
)

581 #ià(
LG_SIZEOF_PTR
 == 3)

582  (
	`©omic_ÿs_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
c
, (ušt64_t)
s
));

583 #–ià(
LG_SIZEOF_PTR
 == 2)

584  (
	`©omic_ÿs_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
c
, (ušt32_t)
s
));

586 
	}
}

588 
JEMALLOC_INLINE
 

589 
	$©omic_wr™e_z
(
size_t
 *
p
, size_ˆ
x
)

592 #ià(
LG_SIZEOF_PTR
 == 3)

593 
	`©omic_wr™e_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
);

594 #–ià(
LG_SIZEOF_PTR
 == 2)

595 
	`©omic_wr™e_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
);

597 
	}
}

601 
JEMALLOC_INLINE
 

602 
	$©omic_add_u
(*
p
, 
x
)

605 #ià(
LG_SIZEOF_INT
 == 3)

606  (()
	`©omic_add_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
));

607 #–ià(
LG_SIZEOF_INT
 == 2)

608  (()
	`©omic_add_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
));

610 
	}
}

612 
JEMALLOC_INLINE
 

613 
	$©omic_sub_u
(*
p
, 
x
)

616 #ià(
LG_SIZEOF_INT
 == 3)

617  (()
	`©omic_add_ušt64
((
ušt64_t
 *)
p
,

618 (
ušt64_t
)-((
št64_t
)
x
)));

619 #–ià(
LG_SIZEOF_INT
 == 2)

620  (()
	`©omic_add_ušt32
((
ušt32_t
 *)
p
,

621 (
ušt32_t
)-((
št32_t
)
x
)));

623 
	}
}

625 
JEMALLOC_INLINE
 
boŞ


626 
	$©omic_ÿs_u
(*
p
, 
c
, 
s
)

629 #ià(
LG_SIZEOF_INT
 == 3)

630  (
	`©omic_ÿs_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
c
, (ušt64_t)
s
));

631 #–ià(
LG_SIZEOF_INT
 == 2)

632  (
	`©omic_ÿs_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
c
, (ušt32_t)
s
));

634 
	}
}

636 
JEMALLOC_INLINE
 

637 
	$©omic_wr™e_u
(*
p
, 
x
)

640 #ià(
LG_SIZEOF_INT
 == 3)

641 
	`©omic_wr™e_ušt64
((
ušt64_t
 *)
p
, (ušt64_t)
x
);

642 #–ià(
LG_SIZEOF_INT
 == 2)

643 
	`©omic_wr™e_ušt32
((
ušt32_t
 *)
p
, (ušt32_t)
x
);

645 
	}
}

	@deps/jemalloc/include/jemalloc/internal/base.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


12 *
ba£_®loc
(
size_t
 
size
);

13 
ba£_¡©s_g‘
(
size_t
 *
®loÿ‹d
, size_ˆ*
»sid’t
, size_ˆ*
m­³d
);

14 
boŞ
 
ba£_boÙ
();

15 
ba£_´efÜk
();

16 
ba£_po¡fÜk_·»Á
();

17 
ba£_po¡fÜk_chd
();

21 #ifdeà
JEMALLOC_H_INLINES


	@deps/jemalloc/include/jemalloc/internal/bitmap.h

2 #ifdeà
JEMALLOC_H_TYPES


5 
	#LG_BITMAP_MAXBITS
 
LG_RUN_MAXREGS


	)

6 
	#BITMAP_MAXBITS
 (
	`ZU
(1è<< 
LG_BITMAP_MAXBITS
)

	)

8 
b™m­_Ëv–_s
 
	tb™m­_Ëv–_t
;

9 
b™m­_šfo_s
 
	tb™m­_šfo_t
;

10 
	tb™m­_t
;

11 
	#LG_SIZEOF_BITMAP
 
LG_SIZEOF_LONG


	)

14 
	#LG_BITMAP_GROUP_NBITS
 (
LG_SIZEOF_BITMAP
 + 3)

	)

15 
	#BITMAP_GROUP_NBITS
 (
	`ZU
(1è<< 
LG_BITMAP_GROUP_NBITS
)

	)

16 
	#BITMAP_GROUP_NBITS_MASK
 (
BITMAP_GROUP_NBITS
-1)

	)

19 
	#BITMAP_BITS2GROUPS
(
nb™s
) \

20 ((
nb™s
 + 
BITMAP_GROUP_NBITS_MASK
è>> 
LG_BITMAP_GROUP_NBITS
)

	)

25 
	#BITMAP_GROUPS_L0
(
nb™s
) \

26 
	`BITMAP_BITS2GROUPS
(
nb™s
)

	)

27 
	#BITMAP_GROUPS_L1
(
nb™s
) \

28 
	`BITMAP_BITS2GROUPS
(BITMAP_BITS2GROUPS(
nb™s
))

	)

29 
	#BITMAP_GROUPS_L2
(
nb™s
) \

30 
	`BITMAP_BITS2GROUPS
(BITMAP_BITS2GROUPS(BITMAP_BITS2GROUPS((
nb™s
))))

	)

31 
	#BITMAP_GROUPS_L3
(
nb™s
) \

32 
	`BITMAP_BITS2GROUPS
(BITMAP_BITS2GROUPS(BITMAP_BITS2GROUPS( \

33 
	`BITMAP_BITS2GROUPS
((
nb™s
)))))

	)

39 
	#BITMAP_GROUPS_1_LEVEL
(
nb™s
) \

40 
	`BITMAP_GROUPS_L0
(
nb™s
)

	)

41 
	#BITMAP_GROUPS_2_LEVEL
(
nb™s
) \

42 (
	`BITMAP_GROUPS_1_LEVEL
(
nb™s
è+ 
	`BITMAP_GROUPS_L1
Òb™s))

	)

43 
	#BITMAP_GROUPS_3_LEVEL
(
nb™s
) \

44 (
	`BITMAP_GROUPS_2_LEVEL
(
nb™s
è+ 
	`BITMAP_GROUPS_L2
Òb™s))

	)

45 
	#BITMAP_GROUPS_4_LEVEL
(
nb™s
) \

46 (
	`BITMAP_GROUPS_3_LEVEL
(
nb™s
è+ 
	`BITMAP_GROUPS_L3
Òb™s))

	)

51 #ià
LG_BITMAP_MAXBITS
 <ğ
LG_BITMAP_GROUP_NBITS


52 
	#BITMAP_GROUPS_MAX
 
	`BITMAP_GROUPS_1_LEVEL
(
BITMAP_MAXBITS
)

	)

53 #–ià
LG_BITMAP_MAXBITS
 <ğ
LG_BITMAP_GROUP_NBITS
 * 2

54 
	#BITMAP_GROUPS_MAX
 
	`BITMAP_GROUPS_2_LEVEL
(
BITMAP_MAXBITS
)

	)

55 #–ià
LG_BITMAP_MAXBITS
 <ğ
LG_BITMAP_GROUP_NBITS
 * 3

56 
	#BITMAP_GROUPS_MAX
 
	`BITMAP_GROUPS_3_LEVEL
(
BITMAP_MAXBITS
)

	)

57 #–ià
LG_BITMAP_MAXBITS
 <ğ
LG_BITMAP_GROUP_NBITS
 * 4

58 
	#BITMAP_GROUPS_MAX
 
	`BITMAP_GROUPS_4_LEVEL
(
BITMAP_MAXBITS
)

	)

64 
	#BITMAP_MAX_LEVELS
 \

65 (
LG_BITMAP_MAXBITS
 / 
LG_SIZEOF_BITMAP
) \

66 + !!(
LG_BITMAP_MAXBITS
 % 
LG_SIZEOF_BITMAP
)

	)

70 #ifdeà
JEMALLOC_H_STRUCTS


72 
	sb™m­_Ëv–_s
 {

74 
size_t
 
	mgroup_off£t
;

77 
	sb™m­_šfo_s
 {

79 
size_t
 
	mnb™s
;

82 
	mÆev–s
;

88 
b™m­_Ëv–_t
 
	mËv–s
[
BITMAP_MAX_LEVELS
+1];

93 #ifdeà
JEMALLOC_H_EXTERNS


95 
b™m­_šfo_š™
(
b™m­_šfo_t
 *
bšfo
, 
size_t
 
nb™s
);

96 
size_t
 
b™m­_šfo_ngroups
(cÚ¡ 
b™m­_šfo_t
 *
bšfo
);

97 
size_t
 
b™m­_size
(size_ˆ
nb™s
);

98 
b™m­_š™
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
);

102 #ifdeà
JEMALLOC_H_INLINES


104 #iâdeà
JEMALLOC_ENABLE_INLINE


105 
boŞ
 
b™m­_fuÎ
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
);

106 
boŞ
 
b™m­_g‘
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
);

107 
b™m­_£t
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
);

108 
size_t
 
b™m­_sfu
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
);

109 
b™m­_un£t
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
);

112 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_BITMAP_C_
))

113 
JEMALLOC_INLINE
 
boŞ


114 
	$b™m­_fuÎ
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
)

116 
rgoff
 = 
bšfo
->
Ëv–s
[bšfo->
Æev–s
].
group_off£t
 - 1;

117 
b™m­_t
 
rg
 = 
b™m­
[
rgoff
];

119  (
rg
 == 0);

120 
	}
}

122 
JEMALLOC_INLINE
 
boŞ


123 
	$b™m­_g‘
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
)

125 
size_t
 
goff
;

126 
b™m­_t
 
g
;

128 
	`as£¹
(
b™
 < 
bšfo
->
nb™s
);

129 
goff
 = 
b™
 >> 
LG_BITMAP_GROUP_NBITS
;

130 
g
 = 
b™m­
[
goff
];

131  (!(
g
 & (1LU << (
b™
 & 
BITMAP_GROUP_NBITS_MASK
))));

132 
	}
}

134 
JEMALLOC_INLINE
 

135 
	$b™m­_£t
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
)

137 
size_t
 
goff
;

138 
b™m­_t
 *
gp
;

139 
b™m­_t
 
g
;

141 
	`as£¹
(
b™
 < 
bšfo
->
nb™s
);

142 
	`as£¹
(!
	`b™m­_g‘
(
b™m­
, 
bšfo
, 
b™
));

143 
goff
 = 
b™
 >> 
LG_BITMAP_GROUP_NBITS
;

144 
gp
 = &
b™m­
[
goff
];

145 
g
 = *
gp
;

146 
	`as£¹
(
g
 & (1LU << (
b™
 & 
BITMAP_GROUP_NBITS_MASK
)));

147 
g
 ^ğ1LU << (
b™
 & 
BITMAP_GROUP_NBITS_MASK
);

148 *
gp
 = 
g
;

149 
	`as£¹
(
	`b™m­_g‘
(
b™m­
, 
bšfo
, 
b™
));

151 ià(
g
 == 0) {

152 
i
;

153 
i
 = 1; i < 
bšfo
->
Æev–s
; i++) {

154 
b™
 = 
goff
;

155 
goff
 = 
b™
 >> 
LG_BITMAP_GROUP_NBITS
;

156 
gp
 = &
b™m­
[
bšfo
->
Ëv–s
[
i
].
group_off£t
 + 
goff
];

157 
g
 = *
gp
;

158 
	`as£¹
(
g
 & (1LU << (
b™
 & 
BITMAP_GROUP_NBITS_MASK
)));

159 
g
 ^ğ1LU << (
b™
 & 
BITMAP_GROUP_NBITS_MASK
);

160 *
gp
 = 
g
;

161 ià(
g
 != 0)

165 
	}
}

168 
JEMALLOC_INLINE
 
size_t


169 
	$b™m­_sfu
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
)

171 
size_t
 
b™
;

172 
b™m­_t
 
g
;

173 
i
;

175 
	`as£¹
(!
	`b™m­_fuÎ
(
b™m­
, 
bšfo
));

177 
i
 = 
bšfo
->
Æev–s
 - 1;

178 
g
 = 
b™m­
[
bšfo
->
Ëv–s
[
i
].
group_off£t
];

179 
b™
 = 
	`jem®loc_ff¦
(
g
) - 1;

180 
i
 > 0) {

181 
i
--;

182 
g
 = 
b™m­
[
bšfo
->
Ëv–s
[
i
].
group_off£t
 + 
b™
];

183 
b™
 = (b™ << 
LG_BITMAP_GROUP_NBITS
è+ (
	`jem®loc_ff¦
(
g
) - 1);

186 
	`b™m­_£t
(
b™m­
, 
bšfo
, 
b™
);

187  (
b™
);

188 
	}
}

190 
JEMALLOC_INLINE
 

191 
	$b™m­_un£t
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
, 
size_t
 
b™
)

193 
size_t
 
goff
;

194 
b™m­_t
 *
gp
;

195 
b™m­_t
 
g
;

196 
boŞ
 
´İag©e
;

198 
	`as£¹
(
b™
 < 
bšfo
->
nb™s
);

199 
	`as£¹
(
	`b™m­_g‘
(
b™m­
, 
bšfo
, 
b™
));

200 
goff
 = 
b™
 >> 
LG_BITMAP_GROUP_NBITS
;

201 
gp
 = &
b™m­
[
goff
];

202 
g
 = *
gp
;

203 
´İag©e
 = (
g
 == 0);

204 
	`as£¹
((
g
 & (1LU << (
b™
 & 
BITMAP_GROUP_NBITS_MASK
))) == 0);

205 
g
 ^ğ1LU << (
b™
 & 
BITMAP_GROUP_NBITS_MASK
);

206 *
gp
 = 
g
;

207 
	`as£¹
(!
	`b™m­_g‘
(
b™m­
, 
bšfo
, 
b™
));

209 ià(
´İag©e
) {

210 
i
;

211 
i
 = 1; i < 
bšfo
->
Æev–s
; i++) {

212 
b™
 = 
goff
;

213 
goff
 = 
b™
 >> 
LG_BITMAP_GROUP_NBITS
;

214 
gp
 = &
b™m­
[
bšfo
->
Ëv–s
[
i
].
group_off£t
 + 
goff
];

215 
g
 = *
gp
;

216 
´İag©e
 = (
g
 == 0);

217 
	`as£¹
((
g
 & (1LU << (
b™
 & 
BITMAP_GROUP_NBITS_MASK
)))

219 
g
 ^ğ1LU << (
b™
 & 
BITMAP_GROUP_NBITS_MASK
);

220 *
gp
 = 
g
;

221 ià(!
´İag©e
)

225 
	}
}

	@deps/jemalloc/include/jemalloc/internal/chunk.h

2 #ifdeà
JEMALLOC_H_TYPES


8 
	#LG_CHUNK_DEFAULT
 21

	)

11 
	#CHUNK_ADDR2BASE
(
a
) \

12 ((*)((
ušŒ_t
)(
a
è& ~
chunksize_mask
))

	)

15 
	#CHUNK_ADDR2OFFSET
(
a
) \

16 ((
size_t
)((
ušŒ_t
)(
a
è& 
chunksize_mask
))

	)

19 
	#CHUNK_CEILING
(
s
) \

20 (((
s
è+ 
chunksize_mask
è& ~chunksize_mask)

	)

22 
	#CHUNK_HOOKS_INITIALIZER
 { \

23 
NULL
, \

24 
NULL
, \

25 
NULL
, \

26 
NULL
, \

27 
NULL
, \

28 
NULL
, \

29 
NULL
 \

30 }

	)

34 #ifdeà
JEMALLOC_H_STRUCTS


38 #ifdeà
JEMALLOC_H_EXTERNS


40 
size_t
 
İt_lg_chunk
;

41 cÚ¡ *
İt_dss
;

43 
¹»e_t
 
chunks_¹»e
;

45 
size_t
 
chunksize
;

46 
size_t
 
chunksize_mask
;

47 
size_t
 
chunk_Åages
;

49 cÚ¡ 
chunk_hooks_t
 
chunk_hooks_deçuÉ
;

51 
chunk_hooks_t
 
chunk_hooks_g‘
(
¬’a_t
 *
¬’a
);

52 
chunk_hooks_t
 
chunk_hooks_£t
(
¬’a_t
 *
¬’a
,

53 cÚ¡ 
chunk_hooks_t
 *
chunk_hooks
);

55 
boŞ
 
chunk_»gi¡”
(cÚ¡ *
chunk
, cÚ¡ 
ex‹Á_node_t
 *
node
);

56 
chunk_d”egi¡”
(cÚ¡ *
chunk
, cÚ¡ 
ex‹Á_node_t
 *
node
);

57 *
chunk_®loc_ba£
(
size_t
 
size
);

58 *
chunk_®loc_ÿche
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

59 *
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
,

60 
boŞ
 
d®loc_node
);

61 *
chunk_®loc_w¿µ”
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

62 *
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
);

63 
chunk_d®loc_ÿche
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

64 *
chunk
, 
size_t
 
size
, 
boŞ
 
comm™‹d
);

65 
chunk_d®loc_¬’a
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

66 *
chunk
, 
size_t
 
size
, 
boŞ
 
z”Ûd
, boŞ 
comm™‹d
);

67 
chunk_d®loc_w¿µ”
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

68 *
chunk
, 
size_t
 
size
, 
boŞ
 
comm™‹d
);

69 
boŞ
 
chunk_purge_¬’a
(
¬’a_t
 *
¬’a
, *
chunk
, 
size_t
 
off£t
,

70 
size_t
 
Ëngth
);

71 
boŞ
 
chunk_purge_w¿µ”
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

72 *
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
);

73 
boŞ
 
chunk_boÙ
();

74 
chunk_´efÜk
();

75 
chunk_po¡fÜk_·»Á
();

76 
chunk_po¡fÜk_chd
();

80 #ifdeà
JEMALLOC_H_INLINES


82 #iâdeà
JEMALLOC_ENABLE_INLINE


83 
ex‹Á_node_t
 *
chunk_lookup
(cÚ¡ *
chunk
, 
boŞ
 
d•’d’t
);

86 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_CHUNK_C_
))

87 
JEMALLOC_INLINE
 
ex‹Á_node_t
 *

88 
	$chunk_lookup
(cÚ¡ *
±r
, 
boŞ
 
d•’d’t
)

91  (
	`¹»e_g‘
(&
chunks_¹»e
, (
ušŒ_t
)
±r
, 
d•’d’t
));

92 
	}
}

98 
	~"jem®loc/š‹º®/chunk_dss.h
"

99 
	~"jem®loc/š‹º®/chunk_mm­.h
"

	@deps/jemalloc/include/jemalloc/internal/chunk_dss.h

2 #ifdeà
JEMALLOC_H_TYPES


5 
	mdss_´ec_di§bËd
 = 0,

6 
	mdss_´ec_´im¬y
 = 1,

7 
	mdss_´ec_£cÚd¬y
 = 2,

9 
	mdss_´ec_lim™
 = 3

10 } 
	tdss_´ec_t
;

11 
	#DSS_PREC_DEFAULT
 
dss_´ec_£cÚd¬y


	)

12 
	#DSS_DEFAULT
 "£cÚd¬y"

	)

16 #ifdeà
JEMALLOC_H_STRUCTS


18 cÚ¡ *
dss_´ec_Çmes
[];

22 #ifdeà
JEMALLOC_H_EXTERNS


24 
dss_´ec_t
 
chunk_dss_´ec_g‘
();

25 
boŞ
 
chunk_dss_´ec_£t
(
dss_´ec_t
 
dss_´ec
);

26 *
chunk_®loc_dss
(
¬’a_t
 *
¬’a
, *
Ãw_addr
, 
size_t
 
size
,

27 
size_t
 
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
);

28 
boŞ
 
chunk_š_dss
(*
chunk
);

29 
boŞ
 
chunk_dss_boÙ
();

30 
chunk_dss_´efÜk
();

31 
chunk_dss_po¡fÜk_·»Á
();

32 
chunk_dss_po¡fÜk_chd
();

36 #ifdeà
JEMALLOC_H_INLINES


	@deps/jemalloc/include/jemalloc/internal/chunk_mmap.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


12 *
chunk_®loc_mm­
(
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
,

13 
boŞ
 *
comm™
);

14 
boŞ
 
chunk_d®loc_mm­
(*
chunk
, 
size_t
 
size
);

18 #ifdeà
JEMALLOC_H_INLINES


	@deps/jemalloc/include/jemalloc/internal/ckh.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
ckh_s
 
	tckh_t
;

5 
ckhc_s
 
	tckhc_t
;

8 
	tckh_hash_t
 (cÚ¡ *, 
	tsize_t
[2]);

9 
boŞ
 
	tckh_keycomp_t
 (const *, const *);

20 
	#LG_CKH_BUCKET_CELLS
 (
LG_CACHELINE
 - 
LG_SIZEOF_PTR
 - 1)

	)

24 #ifdeà
JEMALLOC_H_STRUCTS


27 
	sckhc_s
 {

28 cÚ¡ *
	mkey
;

29 cÚ¡ *
	md©a
;

32 
	sckh_s
 {

33 #ifdeà
CKH_COUNT


35 
ušt64_t
 
	mngrows
;

36 
ušt64_t
 
	mnshršks
;

37 
ušt64_t
 
	mnshrškçs
;

38 
ušt64_t
 
	mnš£¹s
;

39 
ušt64_t
 
	mÄ–ocs
;

43 
	#CKH_A
 1103515241

	)

44 
	#CKH_C
 12347

	)

45 
ušt32_t
 
	m´ng_¡©e
;

48 
size_t
 
	mcouÁ
;

54 
	mlg_mšbuck‘s
;

55 
	mlg_curbuck‘s
;

58 
ckh_hash_t
 *
	mhash
;

59 
ckh_keycomp_t
 *
	mkeycomp
;

62 
ckhc_t
 *
	mb
;

67 #ifdeà
JEMALLOC_H_EXTERNS


69 
boŞ
 
ckh_Ãw
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
, 
size_t
 
mš™ems
, 
ckh_hash_t
 *
hash
,

70 
ckh_keycomp_t
 *
keycomp
);

71 
ckh_d–‘e
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
);

72 
size_t
 
ckh_couÁ
(
ckh_t
 *
ckh
);

73 
boŞ
 
ckh_™”
(
ckh_t
 *
ckh
, 
size_t
 *
bšd
, **
key
, **
d©a
);

74 
boŞ
 
ckh_š£¹
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
, cÚ¡ *
key
, cÚ¡ *
d©a
);

75 
boŞ
 
ckh_»move
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
, cÚ¡ *
£¬chkey
, **
key
,

76 **
d©a
);

77 
boŞ
 
ckh_£¬ch
(
ckh_t
 *
ckh
, cÚ¡ *
£achkey
, **
key
, **
d©a
);

78 
ckh_¡ršg_hash
(cÚ¡ *
key
, 
size_t
 
r_hash
[2]);

79 
boŞ
 
ckh_¡ršg_keycomp
(cÚ¡ *
k1
, cÚ¡ *
k2
);

80 
ckh_poš‹r_hash
(cÚ¡ *
key
, 
size_t
 
r_hash
[2]);

81 
boŞ
 
ckh_poš‹r_keycomp
(cÚ¡ *
k1
, cÚ¡ *
k2
);

85 #ifdeà
JEMALLOC_H_INLINES


	@deps/jemalloc/include/jemalloc/internal/ctl.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
ùl_node_s
 
	tùl_node_t
;

5 
ùl_Çmed_node_s
 
	tùl_Çmed_node_t
;

6 
ùl_šdexed_node_s
 
	tùl_šdexed_node_t
;

7 
ùl_¬’a_¡©s_s
 
	tùl_¬’a_¡©s_t
;

8 
ùl_¡©s_s
 
	tùl_¡©s_t
;

12 #ifdeà
JEMALLOC_H_STRUCTS


14 
	sùl_node_s
 {

15 
boŞ
 
	mÇmed
;

18 
	sùl_Çmed_node_s
 {

19 
ùl_node_s
 
	mnode
;

20 cÚ¡ *
	mÇme
;

22 
	mnchd»n
;

23 cÚ¡ 
ùl_node_t
 *
	mchd»n
;

24 (*
	mùl
)(cÚ¡ 
	msize_t
 *, size_t, *, size_t *,

25 *, 
	msize_t
);

28 
	sùl_šdexed_node_s
 {

29 
ùl_node_s
 
	mnode
;

30 cÚ¡ 
	mùl_Çmed_node_t
 *(*
	mšdex
)(cÚ¡ 
	msize_t
 *, size_t, size_t);

33 
	sùl_¬’a_¡©s_s
 {

34 
boŞ
 
	mš™Ÿlized
;

35 
	mÁh»ads
;

36 cÚ¡ *
	mdss
;

37 
ssize_t
 
	mlg_dœty_muÉ
;

38 
size_t
 
	m·ùive
;

39 
size_t
 
	mpdœty
;

40 
¬’a_¡©s_t
 
	ma¡©s
;

43 
size_t
 
	m®loÿ‹d_sm®l
;

44 
ušt64_t
 
	mnm®loc_sm®l
;

45 
ušt64_t
 
	mnd®loc_sm®l
;

46 
ušt64_t
 
	mÄeque¡s_sm®l
;

48 
m®loc_bš_¡©s_t
 
	mb¡©s
[
NBINS
];

49 
m®loc_Ïrge_¡©s_t
 *
	ml¡©s
;

50 
m®loc_huge_¡©s_t
 *
	mh¡©s
;

53 
	sùl_¡©s_s
 {

54 
size_t
 
	m®loÿ‹d
;

55 
size_t
 
	maùive
;

56 
size_t
 
	mm‘ad©a
;

57 
size_t
 
	m»sid’t
;

58 
size_t
 
	mm­³d
;

59 
	mÇ»Çs
;

60 
ùl_¬’a_¡©s_t
 *
	m¬’as
;

65 #ifdeà
JEMALLOC_H_EXTERNS


67 
ùl_byÇme
(cÚ¡ *
Çme
, *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
,

68 
size_t
 
ÃwËn
);

69 
ùl_Çm‘omib
(cÚ¡ *
Çme
, 
size_t
 *
mibp
, size_ˆ*
mibËÅ
);

71 
ùl_bymib
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

72 *
Ãwp
, 
size_t
 
ÃwËn
);

73 
boŞ
 
ùl_boÙ
();

74 
ùl_´efÜk
();

75 
ùl_po¡fÜk_·»Á
();

76 
ùl_po¡fÜk_chd
();

78 
	#xm®lùl
(
Çme
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
) do { \

79 ià(
	`je_m®lùl
(
Çme
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
) \

81 
	`m®loc_´štf
( \

83 
Çme
); \

84 
	`abÜt
(); \

86 } 0)

	)

88 
	#xm®lùÊam‘omib
(
Çme
, 
mibp
, 
mibËÅ
) do { \

89 ià(
	`je_m®lùÊam‘omib
(
Çme
, 
mibp
, 
mibËÅ
) != 0) { \

90 
	`m®loc_´štf
("<jemalloc>: Failure in " \

91 "xm®lùÊam‘omib(\"%s\", ...)\n", 
Çme
); \

92 
	`abÜt
(); \

94 } 0)

	)

96 
	#xm®lùlbymib
(
mib
, 
mibËn
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
) do { \

97 ià(
	`je_m®lùlbymib
(
mib
, 
mibËn
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, \

98 
ÃwËn
) != 0) { \

99 
	`m®loc_wr™e
( \

101 
	`abÜt
(); \

103 } 0)

	)

107 #ifdeà
JEMALLOC_H_INLINES


	@deps/jemalloc/include/jemalloc/internal/extent.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
ex‹Á_node_s
 
	tex‹Á_node_t
;

8 #ifdeà
JEMALLOC_H_STRUCTS


11 
	sex‹Á_node_s
 {

13 
¬’a_t
 *
	m’_¬’a
;

16 *
	m’_addr
;

19 
size_t
 
	m’_size
;

25 
boŞ
 
	m’_z”Ûd
;

32 
boŞ
 
	m’_comm™‹d
;

38 
boŞ
 
	m’_achunk
;

41 
´of_tùx_t
 *
	m’_´of_tùx
;

44 
¬’a_runs_dœty_lšk_t
 
	mrd
;

45 
qr
(
ex‹Á_node_t
è
	mcc_lšk
;

49 
rb_node
(
ex‹Á_node_t
è
	mszad_lšk
;

52 
ql_–m
(
ex‹Á_node_t
è
	mql_lšk
;

56 
rb_node
(
ex‹Á_node_t
è
	mad_lšk
;

58 
	$rb_Œ“
(
	tex‹Á_node_t
è
	tex‹Á_Œ“_t
;

62 #ifdeà
JEMALLOC_H_EXTERNS


64 
	$rb_´Ùo
(, 
ex‹Á_Œ“_szad_
, 
ex‹Á_Œ“_t
, 
ex‹Á_node_t
)

66 
	$rb_´Ùo
(, 
ex‹Á_Œ“_ad_
, 
ex‹Á_Œ“_t
, 
ex‹Á_node_t
)

70 #ifdeà
JEMALLOC_H_INLINES


72 #iâdeà
JEMALLOC_ENABLE_INLINE


73 
¬’a_t
 *
	`ex‹Á_node_¬’a_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

74 *
	`ex‹Á_node_addr_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

75 
size_t
 
	`ex‹Á_node_size_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

76 
boŞ
 
	`ex‹Á_node_z”Ûd_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

77 
boŞ
 
	`ex‹Á_node_comm™‹d_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

78 
boŞ
 
	`ex‹Á_node_achunk_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

79 
´of_tùx_t
 *
	`ex‹Á_node_´of_tùx_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
);

80 
	`ex‹Á_node_¬’a_£t
(
ex‹Á_node_t
 *
node
, 
¬’a_t
 *
¬’a
);

81 
	`ex‹Á_node_addr_£t
(
ex‹Á_node_t
 *
node
, *
addr
);

82 
	`ex‹Á_node_size_£t
(
ex‹Á_node_t
 *
node
, 
size_t
 
size
);

83 
	`ex‹Á_node_z”Ûd_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
z”Ûd
);

84 
	`ex‹Á_node_comm™‹d_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
comm™‹d
);

85 
	`ex‹Á_node_achunk_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
achunk
);

86 
	`ex‹Á_node_´of_tùx_£t
(
ex‹Á_node_t
 *
node
, 
´of_tùx_t
 *
tùx
);

87 
	`ex‹Á_node_š™
(
ex‹Á_node_t
 *
node
, 
¬’a_t
 *
¬’a
, *
addr
,

88 
size_t
 
size
, 
boŞ
 
z”Ûd
, boŞ 
comm™‹d
);

89 
	`ex‹Á_node_dœty_lškage_š™
(
ex‹Á_node_t
 *
node
);

90 
	`ex‹Á_node_dœty_š£¹
(
ex‹Á_node_t
 *
node
,

91 
¬’a_runs_dœty_lšk_t
 *
runs_dœty
, 
ex‹Á_node_t
 *
chunks_dœty
);

92 
	`ex‹Á_node_dœty_»move
(
ex‹Á_node_t
 *
node
);

95 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_EXTENT_C_
))

96 
JEMALLOC_INLINE
 
¬’a_t
 *

97 
	$ex‹Á_node_¬’a_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

100  (
node
->
’_¬’a
);

101 
	}
}

103 
JEMALLOC_INLINE
 *

104 
	$ex‹Á_node_addr_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

107  (
node
->
’_addr
);

108 
	}
}

110 
JEMALLOC_INLINE
 
size_t


111 
	$ex‹Á_node_size_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

114  (
node
->
’_size
);

115 
	}
}

117 
JEMALLOC_INLINE
 
boŞ


118 
	$ex‹Á_node_z”Ûd_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

121  (
node
->
’_z”Ûd
);

122 
	}
}

124 
JEMALLOC_INLINE
 
boŞ


125 
	$ex‹Á_node_comm™‹d_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

128 
	`as£¹
(!
node
->
’_achunk
);

129  (
node
->
’_comm™‹d
);

130 
	}
}

132 
JEMALLOC_INLINE
 
boŞ


133 
	$ex‹Á_node_achunk_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

136  (
node
->
’_achunk
);

137 
	}
}

139 
JEMALLOC_INLINE
 
´of_tùx_t
 *

140 
	$ex‹Á_node_´of_tùx_g‘
(cÚ¡ 
ex‹Á_node_t
 *
node
)

143  (
node
->
’_´of_tùx
);

144 
	}
}

146 
JEMALLOC_INLINE
 

147 
	$ex‹Á_node_¬’a_£t
(
ex‹Á_node_t
 *
node
, 
¬’a_t
 *
¬’a
)

150 
node
->
’_¬’a
 = 
¬’a
;

151 
	}
}

153 
JEMALLOC_INLINE
 

154 
	$ex‹Á_node_addr_£t
(
ex‹Á_node_t
 *
node
, *
addr
)

157 
node
->
’_addr
 = 
addr
;

158 
	}
}

160 
JEMALLOC_INLINE
 

161 
	$ex‹Á_node_size_£t
(
ex‹Á_node_t
 *
node
, 
size_t
 
size
)

164 
node
->
’_size
 = 
size
;

165 
	}
}

167 
JEMALLOC_INLINE
 

168 
	$ex‹Á_node_z”Ûd_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
z”Ûd
)

171 
node
->
’_z”Ûd
 = 
z”Ûd
;

172 
	}
}

174 
JEMALLOC_INLINE
 

175 
	$ex‹Á_node_comm™‹d_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
comm™‹d
)

178 
node
->
’_comm™‹d
 = 
comm™‹d
;

179 
	}
}

181 
JEMALLOC_INLINE
 

182 
	$ex‹Á_node_achunk_£t
(
ex‹Á_node_t
 *
node
, 
boŞ
 
achunk
)

185 
node
->
’_achunk
 = 
achunk
;

186 
	}
}

188 
JEMALLOC_INLINE
 

189 
	$ex‹Á_node_´of_tùx_£t
(
ex‹Á_node_t
 *
node
, 
´of_tùx_t
 *
tùx
)

192 
node
->
’_´of_tùx
 = 
tùx
;

193 
	}
}

195 
JEMALLOC_INLINE
 

196 
	$ex‹Á_node_š™
(
ex‹Á_node_t
 *
node
, 
¬’a_t
 *
¬’a
, *
addr
, 
size_t
 
size
,

197 
boŞ
 
z”Ûd
, boŞ 
comm™‹d
)

200 
	`ex‹Á_node_¬’a_£t
(
node
, 
¬’a
);

201 
	`ex‹Á_node_addr_£t
(
node
, 
addr
);

202 
	`ex‹Á_node_size_£t
(
node
, 
size
);

203 
	`ex‹Á_node_z”Ûd_£t
(
node
, 
z”Ûd
);

204 
	`ex‹Á_node_comm™‹d_£t
(
node
, 
comm™‹d
);

205 
	`ex‹Á_node_achunk_£t
(
node
, 
çl£
);

206 ià(
cÚfig_´of
)

207 
	`ex‹Á_node_´of_tùx_£t
(
node
, 
NULL
);

208 
	}
}

210 
JEMALLOC_INLINE
 

211 
	$ex‹Á_node_dœty_lškage_š™
(
ex‹Á_node_t
 *
node
)

214 
	`qr_Ãw
(&
node
->
rd
, 
rd_lšk
);

215 
	`qr_Ãw
(
node
, 
cc_lšk
);

216 
	}
}

218 
JEMALLOC_INLINE
 

219 
	$ex‹Á_node_dœty_š£¹
(
ex‹Á_node_t
 *
node
,

220 
¬’a_runs_dœty_lšk_t
 *
runs_dœty
, 
ex‹Á_node_t
 *
chunks_dœty
)

223 
	`qr_m–d
(
runs_dœty
, &
node
->
rd
, 
rd_lšk
);

224 
	`qr_m–d
(
chunks_dœty
, 
node
, 
cc_lšk
);

225 
	}
}

227 
JEMALLOC_INLINE
 

228 
	$ex‹Á_node_dœty_»move
(
ex‹Á_node_t
 *
node
)

231 
	`qr_»move
(&
node
->
rd
, 
rd_lšk
);

232 
	`qr_»move
(
node
, 
cc_lšk
);

233 
	}
}

	@deps/jemalloc/include/jemalloc/internal/hash.h

7 #ifdeà
JEMALLOC_H_TYPES


11 #ifdeà
JEMALLOC_H_STRUCTS


15 #ifdeà
JEMALLOC_H_EXTERNS


19 #ifdeà
JEMALLOC_H_INLINES


21 #iâdeà
JEMALLOC_ENABLE_INLINE


22 
ušt32_t
 
hash_x86_32
(cÚ¡ *
key
, 
Ën
, ušt32_ˆ
£ed
);

23 
hash_x86_128
(cÚ¡ *
key
, cÚ¡ 
Ën
, 
ušt32_t
 
£ed
,

24 
ušt64_t
 
r_out
[2]);

25 
hash_x64_128
(cÚ¡ *
key
, cÚ¡ 
Ën
, cÚ¡ 
ušt32_t
 
£ed
,

26 
ušt64_t
 
r_out
[2]);

27 
hash
(cÚ¡ *
key
, 
size_t
 
Ën
, cÚ¡ 
ušt32_t
 
£ed
,

28 
size_t
 
r_hash
[2]);

31 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_HASH_C_
))

34 
JEMALLOC_INLINE
 
ušt32_t


35 
	$hash_rÙl_32
(
ušt32_t
 
x
, 
št8_t
 
r
)

38  ((
x
 << 
r
) | (x >> (32 -„)));

39 
	}
}

41 
JEMALLOC_INLINE
 
ušt64_t


42 
	$hash_rÙl_64
(
ušt64_t
 
x
, 
št8_t
 
r
)

45  ((
x
 << 
r
) | (x >> (64 -„)));

46 
	}
}

48 
JEMALLOC_INLINE
 
ušt32_t


49 
	$hash_g‘_block_32
(cÚ¡ 
ušt32_t
 *
p
, 
i
)

52  (
p
[
i
]);

53 
	}
}

55 
JEMALLOC_INLINE
 
ušt64_t


56 
	$hash_g‘_block_64
(cÚ¡ 
ušt64_t
 *
p
, 
i
)

59  (
p
[
i
]);

60 
	}
}

62 
JEMALLOC_INLINE
 
ušt32_t


63 
	$hash_fmix_32
(
ušt32_t
 
h
)

66 
h
 ^= h >> 16;

67 
h
 *= 0x85ebca6b;

68 
h
 ^= h >> 13;

69 
h
 *= 0xc2b2ae35;

70 
h
 ^= h >> 16;

72  (
h
);

73 
	}
}

75 
JEMALLOC_INLINE
 
ušt64_t


76 
	$hash_fmix_64
(
ušt64_t
 
k
)

79 
k
 ^= k >> 33;

80 
k
 *ğ
	`KQU
(0xff51afd7ed558ccd);

81 
k
 ^= k >> 33;

82 
k
 *ğ
	`KQU
(0xc4ceb9fe1a85ec53);

83 
k
 ^= k >> 33;

85  (
k
);

86 
	}
}

88 
JEMALLOC_INLINE
 
ušt32_t


89 
	$hash_x86_32
(cÚ¡ *
key
, 
Ën
, 
ušt32_t
 
£ed
)

91 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*è
key
;

92 cÚ¡ 
nblocks
 = 
Ën
 / 4;

94 
ušt32_t
 
h1
 = 
£ed
;

96 cÚ¡ 
ušt32_t
 
c1
 = 0xcc9e2d51;

97 cÚ¡ 
ušt32_t
 
c2
 = 0x1b873593;

101 cÚ¡ 
ušt32_t
 *
blocks
 = (cÚ¡ ušt32_ˆ*è(
d©a
 + 
nblocks
*4);

102 
i
;

104 
i
 = -
nblocks
; i; i++) {

105 
ušt32_t
 
k1
 = 
	`hash_g‘_block_32
(
blocks
, 
i
);

107 
k1
 *ğ
c1
;

108 
k1
 = 
	`hash_rÙl_32
(k1, 15);

109 
k1
 *ğ
c2
;

111 
h1
 ^ğ
k1
;

112 
h1
 = 
	`hash_rÙl_32
(h1, 13);

113 
h1
 = h1*5 + 0xe6546b64;

119 cÚ¡ 
ušt8_t
 *

 = (cÚ¡ ušt8_ˆ*è(
d©a
 + 
nblocks
*4);

121 
ušt32_t
 
k1
 = 0;

123 
Ën
 & 3) {

124 3: 
k1
 ^ğ

[2] << 16;

125 2: 
k1
 ^ğ

[1] << 8;

126 1: 
k1
 ^ğ

[0]; k1 *ğ
c1
; k1 = 
	`hash_rÙl_32
(k1, 15);

127 
k1
 *ğ
c2
; 
h1
 ^= k1;

132 
h1
 ^ğ
Ën
;

134 
h1
 = 
	`hash_fmix_32
(h1);

136  (
h1
);

137 
	}
}

139 
UNUSED
 
JEMALLOC_INLINE
 

140 
	$hash_x86_128
(cÚ¡ *
key
, cÚ¡ 
Ën
, 
ušt32_t
 
£ed
,

141 
ušt64_t
 
r_out
[2])

143 cÚ¡ 
ušt8_t
 * 
d©a
 = (cÚ¡ ušt8_ˆ*è
key
;

144 cÚ¡ 
nblocks
 = 
Ën
 / 16;

146 
ušt32_t
 
h1
 = 
£ed
;

147 
ušt32_t
 
h2
 = 
£ed
;

148 
ušt32_t
 
h3
 = 
£ed
;

149 
ušt32_t
 
h4
 = 
£ed
;

151 cÚ¡ 
ušt32_t
 
c1
 = 0x239b961b;

152 cÚ¡ 
ušt32_t
 
c2
 = 0xab0e9789;

153 cÚ¡ 
ušt32_t
 
c3
 = 0x38b34ae5;

154 cÚ¡ 
ušt32_t
 
c4
 = 0xa1e38b93;

158 cÚ¡ 
ušt32_t
 *
blocks
 = (cÚ¡ ušt32_ˆ*è(
d©a
 + 
nblocks
*16);

159 
i
;

161 
i
 = -
nblocks
; i; i++) {

162 
ušt32_t
 
k1
 = 
	`hash_g‘_block_32
(
blocks
, 
i
*4 + 0);

163 
ušt32_t
 
k2
 = 
	`hash_g‘_block_32
(
blocks
, 
i
*4 + 1);

164 
ušt32_t
 
k3
 = 
	`hash_g‘_block_32
(
blocks
, 
i
*4 + 2);

165 
ušt32_t
 
k4
 = 
	`hash_g‘_block_32
(
blocks
, 
i
*4 + 3);

167 
k1
 *ğ
c1
; k1 = 
	`hash_rÙl_32
(k1, 15); k1 *ğ
c2
; 
h1
 ^= k1;

169 
h1
 = 
	`hash_rÙl_32
(h1, 19); h1 +ğ
h2
;

170 
h1
 = h1*5 + 0x561ccd1b;

172 
k2
 *ğ
c2
; k2 = 
	`hash_rÙl_32
(k2, 16); k2 *ğ
c3
; 
h2
 ^= k2;

174 
h2
 = 
	`hash_rÙl_32
(h2, 17); h2 +ğ
h3
;

175 
h2
 = h2*5 + 0x0bcaa747;

177 
k3
 *ğ
c3
; k3 = 
	`hash_rÙl_32
(k3, 17); k3 *ğ
c4
; 
h3
 ^= k3;

179 
h3
 = 
	`hash_rÙl_32
(h3, 15); h3 +ğ
h4
;

180 
h3
 = h3*5 + 0x96cd1c35;

182 
k4
 *ğ
c4
; k4 = 
	`hash_rÙl_32
(k4, 18); k4 *ğ
c1
; 
h4
 ^= k4;

184 
h4
 = 
	`hash_rÙl_32
(h4, 13); h4 +ğ
h1
;

185 
h4
 = h4*5 + 0x32ac3b17;

191 cÚ¡ 
ušt8_t
 *

 = (cÚ¡ ušt8_ˆ*è(
d©a
 + 
nblocks
*16);

192 
ušt32_t
 
k1
 = 0;

193 
ušt32_t
 
k2
 = 0;

194 
ušt32_t
 
k3
 = 0;

195 
ušt32_t
 
k4
 = 0;

197 
Ën
 & 15) {

198 15: 
k4
 ^ğ

[14] << 16;

199 14: 
k4
 ^ğ

[13] << 8;

200 13: 
k4
 ^ğ

[12] << 0;

201 
k4
 *ğ
c4
; k4 = 
	`hash_rÙl_32
(k4, 18); k4 *ğ
c1
; 
h4
 ^= k4;

203 12: 
k3
 ^ğ

[11] << 24;

204 11: 
k3
 ^ğ

[10] << 16;

205 10: 
k3
 ^ğ

[ 9] << 8;

206 9: 
k3
 ^ğ

[ 8] << 0;

207 
k3
 *ğ
c3
; k3 = 
	`hash_rÙl_32
(k3, 17); k3 *ğ
c4
; 
h3
 ^= k3;

209 8: 
k2
 ^ğ

[ 7] << 24;

210 7: 
k2
 ^ğ

[ 6] << 16;

211 6: 
k2
 ^ğ

[ 5] << 8;

212 5: 
k2
 ^ğ

[ 4] << 0;

213 
k2
 *ğ
c2
; k2 = 
	`hash_rÙl_32
(k2, 16); k2 *ğ
c3
; 
h2
 ^= k2;

215 4: 
k1
 ^ğ

[ 3] << 24;

216 3: 
k1
 ^ğ

[ 2] << 16;

217 2: 
k1
 ^ğ

[ 1] << 8;

218 1: 
k1
 ^ğ

[ 0] << 0;

219 
k1
 *ğ
c1
; k1 = 
	`hash_rÙl_32
(k1, 15); k1 *ğ
c2
; 
h1
 ^= k1;

224 
h1
 ^ğ
Ën
; 
h2
 ^ğËn; 
h3
 ^ğËn; 
h4
 ^=†en;

226 
h1
 +ğ
h2
; h1 +ğ
h3
; h1 +ğ
h4
;

227 
h2
 +ğ
h1
; 
h3
 +ğh1; 
h4
 += h1;

229 
h1
 = 
	`hash_fmix_32
(h1);

230 
h2
 = 
	`hash_fmix_32
(h2);

231 
h3
 = 
	`hash_fmix_32
(h3);

232 
h4
 = 
	`hash_fmix_32
(h4);

234 
h1
 +ğ
h2
; h1 +ğ
h3
; h1 +ğ
h4
;

235 
h2
 +ğ
h1
; 
h3
 +ğh1; 
h4
 += h1;

237 
r_out
[0] = (((
ušt64_t
è
h2
è<< 32è| 
h1
;

238 
r_out
[1] = (((
ušt64_t
è
h4
è<< 32è| 
h3
;

239 
	}
}

241 
UNUSED
 
JEMALLOC_INLINE
 

242 
	$hash_x64_128
(cÚ¡ *
key
, cÚ¡ 
Ën
, cÚ¡ 
ušt32_t
 
£ed
,

243 
ušt64_t
 
r_out
[2])

245 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*è
key
;

246 cÚ¡ 
nblocks
 = 
Ën
 / 16;

248 
ušt64_t
 
h1
 = 
£ed
;

249 
ušt64_t
 
h2
 = 
£ed
;

251 cÚ¡ 
ušt64_t
 
c1
 = 
	`KQU
(0x87c37b91114253d5);

252 cÚ¡ 
ušt64_t
 
c2
 = 
	`KQU
(0x4cf5ad432745937f);

256 cÚ¡ 
ušt64_t
 *
blocks
 = (cÚ¡ ušt64_ˆ*è(
d©a
);

257 
i
;

259 
i
 = 0; i < 
nblocks
; i++) {

260 
ušt64_t
 
k1
 = 
	`hash_g‘_block_64
(
blocks
, 
i
*2 + 0);

261 
ušt64_t
 
k2
 = 
	`hash_g‘_block_64
(
blocks
, 
i
*2 + 1);

263 
k1
 *ğ
c1
; k1 = 
	`hash_rÙl_64
(k1, 31); k1 *ğ
c2
; 
h1
 ^= k1;

265 
h1
 = 
	`hash_rÙl_64
(h1, 27); h1 +ğ
h2
;

266 
h1
 = h1*5 + 0x52dce729;

268 
k2
 *ğ
c2
; k2 = 
	`hash_rÙl_64
(k2, 33); k2 *ğ
c1
; 
h2
 ^= k2;

270 
h2
 = 
	`hash_rÙl_64
(h2, 31); h2 +ğ
h1
;

271 
h2
 = h2*5 + 0x38495ab5;

277 cÚ¡ 
ušt8_t
 *

 = (cÚ¡ ušt8_t*)(
d©a
 + 
nblocks
*16);

278 
ušt64_t
 
k1
 = 0;

279 
ušt64_t
 
k2
 = 0;

281 
Ën
 & 15) {

282 15: 
k2
 ^ğ((
ušt64_t
)(

[14])) << 48;

283 14: 
k2
 ^ğ((
ušt64_t
)(

[13])) << 40;

284 13: 
k2
 ^ğ((
ušt64_t
)(

[12])) << 32;

285 12: 
k2
 ^ğ((
ušt64_t
)(

[11])) << 24;

286 11: 
k2
 ^ğ((
ušt64_t
)(

[10])) << 16;

287 10: 
k2
 ^ğ((
ušt64_t
)(

[ 9])) << 8;

288 9: 
k2
 ^ğ((
ušt64_t
)(

[ 8])) << 0;

289 
k2
 *ğ
c2
; k2 = 
	`hash_rÙl_64
(k2, 33); k2 *ğ
c1
; 
h2
 ^= k2;

291 8: 
k1
 ^ğ((
ušt64_t
)(

[ 7])) << 56;

292 7: 
k1
 ^ğ((
ušt64_t
)(

[ 6])) << 48;

293 6: 
k1
 ^ğ((
ušt64_t
)(

[ 5])) << 40;

294 5: 
k1
 ^ğ((
ušt64_t
)(

[ 4])) << 32;

295 4: 
k1
 ^ğ((
ušt64_t
)(

[ 3])) << 24;

296 3: 
k1
 ^ğ((
ušt64_t
)(

[ 2])) << 16;

297 2: 
k1
 ^ğ((
ušt64_t
)(

[ 1])) << 8;

298 1: 
k1
 ^ğ((
ušt64_t
)(

[ 0])) << 0;

299 
k1
 *ğ
c1
; k1 = 
	`hash_rÙl_64
(k1, 31); k1 *ğ
c2
; 
h1
 ^= k1;

304 
h1
 ^ğ
Ën
; 
h2
 ^=†en;

306 
h1
 +ğ
h2
;

307 
h2
 +ğ
h1
;

309 
h1
 = 
	`hash_fmix_64
(h1);

310 
h2
 = 
	`hash_fmix_64
(h2);

312 
h1
 +ğ
h2
;

313 
h2
 +ğ
h1
;

315 
r_out
[0] = 
h1
;

316 
r_out
[1] = 
h2
;

317 
	}
}

321 
JEMALLOC_INLINE
 

322 
	$hash
(cÚ¡ *
key
, 
size_t
 
Ën
, cÚ¡ 
ušt32_t
 
£ed
, size_ˆ
r_hash
[2])

324 #ià(
LG_SIZEOF_PTR
 =ğ3 && !
	`defšed
(
JEMALLOC_BIG_ENDIAN
))

325 
	`hash_x64_128
(
key
, 
Ën
, 
£ed
, (
ušt64_t
 *)
r_hash
);

327 
ušt64_t
 
hashes
[2];

328 
	`hash_x86_128
(
key
, 
Ën
, 
£ed
, 
hashes
);

329 
r_hash
[0] = (
size_t
)
hashes
[0];

330 
r_hash
[1] = (
size_t
)
hashes
[1];

332 
	}
}

	@deps/jemalloc/include/jemalloc/internal/huge.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


12 *
huge_m®loc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
,

13 
tÿche_t
 *
tÿche
);

14 *
huge_·Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
, size_ˆ
®ignm’t
,

15 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
);

16 
boŞ
 
huge_¿Îoc_no_move
(*
±r
, 
size_t
 
Şdsize
, size_ˆ
usize_mš
,

17 
size_t
 
usize_max
, 
boŞ
 
z”o
);

18 *
huge_¿Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, *
±r
, 
size_t
 
Şdsize
,

19 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
);

20 #ifdeà
JEMALLOC_JET


21 (
	thuge_d®loc_junk_t
)(*, 
	tsize_t
);

22 
huge_d®loc_junk_t
 *
huge_d®loc_junk
;

24 
	`huge_d®loc
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
);

25 
¬’a_t
 *
	`huge_¯Îoc
(cÚ¡ *
±r
);

26 
size_t
 
	`huge_§Îoc
(cÚ¡ *
±r
);

27 
´of_tùx_t
 *
	`huge_´of_tùx_g‘
(cÚ¡ *
±r
);

28 
	`huge_´of_tùx_£t
(cÚ¡ *
±r
, 
´of_tùx_t
 *
tùx
);

29 
	`huge_´of_tùx_»£t
(cÚ¡ *
±r
);

33 #ifdeà
JEMALLOC_H_INLINES


	@deps/jemalloc/include/jemalloc/internal/jemalloc_internal.h

1 #iâdeà
JEMALLOC_INTERNAL_H


2 
	#JEMALLOC_INTERNAL_H


	)

4 
	~"jem®loc_š‹º®_defs.h
"

5 
	~"jem®loc/š‹º®/jem®loc_š‹º®_deşs.h
"

7 #ifdeà
JEMALLOC_UTRACE


8 
	~<sys/kŒaû.h
>

11 
	#JEMALLOC_NO_DEMANGLE


	)

12 #ifdeà
JEMALLOC_JET


13 
	#JEMALLOC_N
(
n
è
j‘_
##
	)
n

14 
	~"jem®loc/š‹º®/public_Çme¥aû.h
"

15 
	#JEMALLOC_NO_RENAME


	)

16 
	~"../jem®loc.h
"

17 #undeà
JEMALLOC_NO_RENAME


19 
	#JEMALLOC_N
(
n
è
je_
##
	)
n

20 
	~"../jem®loc.h
"

22 
	~"jem®loc/š‹º®/´iv©e_Çme¥aû.h
"

24 cÚ¡ 
boŞ
 
	gcÚfig_debug
 =

25 #ifdeà
JEMALLOC_DEBUG


26 
Œue


28 
çl£


31 cÚ¡ 
boŞ
 
	ghave_dss
 =

32 #ifdeà
JEMALLOC_DSS


33 
Œue


35 
çl£


38 cÚ¡ 
boŞ
 
	gcÚfig_fl
 =

39 #ifdeà
JEMALLOC_FILL


40 
Œue


42 
çl£


45 cÚ¡ 
boŞ
 
	gcÚfig_Ïzy_lock
 =

46 #ifdeà
JEMALLOC_LAZY_LOCK


47 
Œue


49 
çl£


52 cÚ¡ 
boŞ
 
	gcÚfig_´of
 =

53 #ifdeà
JEMALLOC_PROF


54 
Œue


56 
çl£


59 cÚ¡ 
boŞ
 
	gcÚfig_´of_libgcc
 =

60 #ifdeà
JEMALLOC_PROF_LIBGCC


61 
Œue


63 
çl£


66 cÚ¡ 
boŞ
 
	gcÚfig_´of_libunwšd
 =

67 #ifdeà
JEMALLOC_PROF_LIBUNWIND


68 
Œue


70 
çl£


73 cÚ¡ 
boŞ
 
	gm­s_cßËsû
 =

74 #ifdeà
JEMALLOC_MAPS_COALESCE


75 
Œue


77 
çl£


80 cÚ¡ 
boŞ
 
	gcÚfig_munm­
 =

81 #ifdeà
JEMALLOC_MUNMAP


82 
Œue


84 
çl£


87 cÚ¡ 
boŞ
 
	gcÚfig_¡©s
 =

88 #ifdeà
JEMALLOC_STATS


89 
Œue


91 
çl£


94 cÚ¡ 
boŞ
 
	gcÚfig_tÿche
 =

95 #ifdeà
JEMALLOC_TCACHE


96 
Œue


98 
çl£


101 cÚ¡ 
boŞ
 
	gcÚfig_s
 =

102 #ifdeà
JEMALLOC_TLS


103 
Œue


105 
çl£


108 cÚ¡ 
boŞ
 
	gcÚfig_uŒaû
 =

109 #ifdeà
JEMALLOC_UTRACE


110 
Œue


112 
çl£


115 cÚ¡ 
boŞ
 
	gcÚfig_v®gršd
 =

116 #ifdeà
JEMALLOC_VALGRIND


117 
Œue


119 
çl£


122 cÚ¡ 
boŞ
 
	gcÚfig_xm®loc
 =

123 #ifdeà
JEMALLOC_XMALLOC


124 
Œue


126 
çl£


129 cÚ¡ 
boŞ
 
	gcÚfig_iv§Îoc
 =

130 #ifdeà
JEMALLOC_IVSALLOC


131 
Œue


133 
çl£


136 cÚ¡ 
boŞ
 
	gcÚfig_ÿche_oblivious
 =

137 #ifdeà
JEMALLOC_CACHE_OBLIVIOUS


138 
Œue


140 
çl£


144 #ifdeà
JEMALLOC_C11ATOMICS


145 
	~<¡d©omic.h
>

148 #ifdeà
JEMALLOC_ATOMIC9


149 
	~<machše/©omic.h
>

152 #ià(
defšed
(
JEMALLOC_OSATOMIC
è|| defšed(
JEMALLOC_OSSPIN
))

153 
	~<libk”n/OSAtomic.h
>

156 #ifdeà
JEMALLOC_ZONE


157 
	~<mach/mach_”rÜ.h
>

158 
	~<mach/mach_š™.h
>

159 
	~<mach/vm_m­.h
>

160 
	~<m®loc/m®loc.h
>

163 
	#RB_COMPACT


	)

164 
	~"jem®loc/š‹º®/rb.h
"

165 
	~"jem®loc/š‹º®/qr.h
"

166 
	~"jem®loc/š‹º®/ql.h
"

182 
	#JEMALLOC_H_TYPES


	)

184 
	~"jem®loc/š‹º®/jem®loc_š‹º®_maüos.h
"

187 
	tszšd_t
;

200 
	#MALLOCX_ARENA_MASK
 (()~0xfffff)

	)

201 
	#MALLOCX_ARENA_MAX
 0xfã

	)

202 
	#MALLOCX_TCACHE_MASK
 (()~0xfff000ffU)

	)

203 
	#MALLOCX_TCACHE_MAX
 0xffd

	)

204 
	#MALLOCX_LG_ALIGN_MASK
 (()0x3f)

	)

206 
	#MALLOCX_ALIGN_GET_SPECIFIED
(
æags
) \

207 (
	`ZU
(1è<< (
æags
 & 
MALLOCX_LG_ALIGN_MASK
))

	)

208 
	#MALLOCX_ALIGN_GET
(
æags
) \

209 (
	`MALLOCX_ALIGN_GET_SPECIFIED
(
æags
è& (
SIZE_T_MAX
-1))

	)

210 
	#MALLOCX_ZERO_GET
(
æags
) \

211 ((
boŞ
)(
æags
 & 
MALLOCX_ZERO
))

	)

213 
	#MALLOCX_TCACHE_GET
(
æags
) \

214 ((()((
æags
 & 
MALLOCX_TCACHE_MASK
è>> 8)è- 2)

	)

215 
	#MALLOCX_ARENA_GET
(
æags
) \

216 ((()((()
æags
è>> 20)è- 1)

	)

219 
	#TINY_MIN
 (1U << 
LG_TINY_MIN
)

	)

225 #iâdeà
LG_QUANTUM


226 #ià(
defšed
(
__i386__
è|| defšed(
_M_IX86
))

227 
	#LG_QUANTUM
 4

	)

229 #ifdeà
__Ÿ64__


230 
	#LG_QUANTUM
 4

	)

232 #ifdeà
__®pha__


233 
	#LG_QUANTUM
 4

	)

235 #ià(
defšed
(
__¥¬c64__
è|| defšed(
__¥¬cv9
))

236 
	#LG_QUANTUM
 4

	)

238 #ià(
defšed
(
__amd64__
è|| defšed(
__x86_64__
è|| defšed(
_M_X64
))

239 
	#LG_QUANTUM
 4

	)

241 #ifdeà
__¬m__


242 
	#LG_QUANTUM
 3

	)

244 #ifdeà
__¯rch64__


245 
	#LG_QUANTUM
 4

	)

247 #ifdeà
__hµa__


248 
	#LG_QUANTUM
 4

	)

250 #ifdeà
__ms__


251 
	#LG_QUANTUM
 3

	)

253 #ifdeà
__Ü1k__


254 
	#LG_QUANTUM
 3

	)

256 #ifdeà
__pow”pc__


257 
	#LG_QUANTUM
 4

	)

259 #ifdeà
__s390__


260 
	#LG_QUANTUM
 4

	)

262 #ifdeà
__SH4__


263 
	#LG_QUANTUM
 4

	)

265 #ifdeà
__te__


266 
	#LG_QUANTUM
 4

	)

268 #ifdeà
__Ë32__


269 
	#LG_QUANTUM
 4

	)

271 #iâdeà
LG_QUANTUM


277 
	#QUANTUM
 ((
size_t
)(1U << 
LG_QUANTUM
))

	)

278 
	#QUANTUM_MASK
 (
QUANTUM
 - 1)

	)

281 
	#QUANTUM_CEILING
(
a
) \

282 (((
a
è+ 
QUANTUM_MASK
è& ~QUANTUM_MASK)

	)

284 
	#LONG
 ((
size_t
)(1U << 
LG_SIZEOF_LONG
))

	)

285 
	#LONG_MASK
 (
LONG
 - 1)

	)

288 
	#LONG_CEILING
(
a
) \

289 (((
a
è+ 
LONG_MASK
è& ~LONG_MASK)

	)

291 
	#SIZEOF_PTR
 (1U << 
LG_SIZEOF_PTR
)

	)

292 
	#PTR_MASK
 (
SIZEOF_PTR
 - 1)

	)

295 
	#PTR_CEILING
(
a
) \

296 (((
a
è+ 
PTR_MASK
è& ~PTR_MASK)

	)

305 
	#LG_CACHELINE
 6

	)

306 
	#CACHELINE
 64

	)

307 
	#CACHELINE_MASK
 (
CACHELINE
 - 1)

	)

310 
	#CACHELINE_CEILING
(
s
) \

311 (((
s
è+ 
CACHELINE_MASK
è& ~CACHELINE_MASK)

	)

314 #ifdeà
PAGE_MASK


315 #undeà
PAGE_MASK


317 
	#PAGE
 ((
size_t
)(1U << 
LG_PAGE
))

	)

318 
	#PAGE_MASK
 ((
size_t
)(
PAGE
 - 1))

	)

321 
	#PAGE_CEILING
(
s
) \

322 (((
s
è+ 
PAGE_MASK
è& ~PAGE_MASK)

	)

325 
	#ALIGNMENT_ADDR2BASE
(
a
, 
®ignm’t
) \

326 ((*)((
ušŒ_t
)(
a
è& (-(
®ignm’t
))))

	)

329 
	#ALIGNMENT_ADDR2OFFSET
(
a
, 
®ignm’t
) \

330 ((
size_t
)((
ušŒ_t
)(
a
è& (
®ignm’t
 - 1)))

	)

333 
	#ALIGNMENT_CEILING
(
s
, 
®ignm’t
) \

334 (((
s
è+ (
®ignm’t
 - 1)è& (-×lignm’t)))

	)

337 #ià
__STDC_VERSION__
 < 199901L

338 #ifdeà
_MSC_VER


339 
	~<m®loc.h
>

340 
	#®loÿ
 
_®loÿ


	)

342 #ifdeà
JEMALLOC_HAS_ALLOCA_H


343 
	~<®loÿ.h
>

345 
	~<¡dlib.h
>

348 
	#VARIABLE_ARRAY
(
ty³
, 
Çme
, 
couÁ
) \

349 
ty³
 *
Çme
 = 
	`®loÿ
(Ñy³è* (
couÁ
))

	)

351 
	#VARIABLE_ARRAY
(
ty³
, 
Çme
, 
couÁ
èty³‚ame[(couÁ)]

	)

354 
	~"jem®loc/š‹º®/v®gršd.h
"

355 
	~"jem®loc/š‹º®/ut.h
"

356 
	~"jem®loc/š‹º®/©omic.h
"

357 
	~"jem®loc/š‹º®/´ng.h
"

358 
	~"jem®loc/š‹º®/ckh.h
"

359 
	~"jem®loc/š‹º®/size_şas£s.h
"

360 
	~"jem®loc/š‹º®/¡©s.h
"

361 
	~"jem®loc/š‹º®/ùl.h
"

362 
	~"jem®loc/š‹º®/mu‹x.h
"

363 
	~"jem®loc/š‹º®/tsd.h
"

364 
	~"jem®loc/š‹º®/mb.h
"

365 
	~"jem®loc/š‹º®/ex‹Á.h
"

366 
	~"jem®loc/š‹º®/¬’a.h
"

367 
	~"jem®loc/š‹º®/b™m­.h
"

368 
	~"jem®loc/š‹º®/ba£.h
"

369 
	~"jem®loc/š‹º®/¹»e.h
"

370 
	~"jem®loc/š‹º®/·ges.h
"

371 
	~"jem®loc/š‹º®/chunk.h
"

372 
	~"jem®loc/š‹º®/huge.h
"

373 
	~"jem®loc/š‹º®/tÿche.h
"

374 
	~"jem®loc/š‹º®/hash.h
"

375 
	~"jem®loc/š‹º®/qu¬ªtše.h
"

376 
	~"jem®loc/š‹º®/´of.h
"

378 #undeà
JEMALLOC_H_TYPES


380 
	#JEMALLOC_H_STRUCTS


	)

382 
	~"jem®loc/š‹º®/v®gršd.h
"

383 
	~"jem®loc/š‹º®/ut.h
"

384 
	~"jem®loc/š‹º®/©omic.h
"

385 
	~"jem®loc/š‹º®/´ng.h
"

386 
	~"jem®loc/š‹º®/ckh.h
"

387 
	~"jem®loc/š‹º®/size_şas£s.h
"

388 
	~"jem®loc/š‹º®/¡©s.h
"

389 
	~"jem®loc/š‹º®/ùl.h
"

390 
	~"jem®loc/š‹º®/mu‹x.h
"

391 
	~"jem®loc/š‹º®/mb.h
"

392 
	~"jem®loc/š‹º®/b™m­.h
"

393 
	#JEMALLOC_ARENA_STRUCTS_A


	)

394 
	~"jem®loc/š‹º®/¬’a.h
"

395 #undeà
JEMALLOC_ARENA_STRUCTS_A


396 
	~"jem®loc/š‹º®/ex‹Á.h
"

397 
	#JEMALLOC_ARENA_STRUCTS_B


	)

398 
	~"jem®loc/š‹º®/¬’a.h
"

399 #undeà
JEMALLOC_ARENA_STRUCTS_B


400 
	~"jem®loc/š‹º®/ba£.h
"

401 
	~"jem®loc/š‹º®/¹»e.h
"

402 
	~"jem®loc/š‹º®/·ges.h
"

403 
	~"jem®loc/š‹º®/chunk.h
"

404 
	~"jem®loc/š‹º®/huge.h
"

405 
	~"jem®loc/š‹º®/tÿche.h
"

406 
	~"jem®loc/š‹º®/hash.h
"

407 
	~"jem®loc/š‹º®/qu¬ªtše.h
"

408 
	~"jem®loc/š‹º®/´of.h
"

410 
	~"jem®loc/š‹º®/tsd.h
"

412 #undeà
JEMALLOC_H_STRUCTS


414 
	#JEMALLOC_H_EXTERNS


	)

416 
boŞ
 
İt_abÜt
;

417 cÚ¡ *
İt_junk
;

418 
boŞ
 
İt_junk_®loc
;

419 
boŞ
 
İt_junk_ä“
;

420 
size_t
 
İt_qu¬ªtše
;

421 
boŞ
 
İt_»dzÚe
;

422 
boŞ
 
İt_uŒaû
;

423 
boŞ
 
İt_xm®loc
;

424 
boŞ
 
İt_z”o
;

425 
size_t
 
İt_Ç»Çs
;

427 
boŞ
 
š_v®gršd
;

430 
nıus
;

436 
size_t
 cÚ¡ 
šdex2size_b
[
NSIZES
];

442 
ušt8_t
 cÚ¡ 
size2šdex_b
[];

444 
¬’a_t
 *
a0g‘
();

445 *
a0m®loc
(
size_t
 
size
);

446 
a0d®loc
(*
±r
);

447 *
boÙ¡¿p_m®loc
(
size_t
 
size
);

448 *
boÙ¡¿p_ÿÎoc
(
size_t
 
num
, size_ˆ
size
);

449 
boÙ¡¿p_ä“
(*
±r
);

450 
¬’a_t
 *
¬’as_ex‹nd
(
šd
);

451 
¬’a_t
 *
¬’a_š™
(
šd
);

452 
Ç»Çs_tÙ®_g‘
();

453 
¬’a_t
 *
¬’a_g‘_h¬d
(
tsd_t
 *
tsd
, 
šd
, 
boŞ
 
š™_if_missšg
);

454 
¬’a_t
 *
¬’a_choo£_h¬d
(
tsd_t
 *
tsd
);

455 
¬’a_mig¿‹
(
tsd_t
 *
tsd
, 
Şdšd
, 
Ãwšd
);

456 
¬’a_nbound
(
šd
);

457 
th»ad_®loÿ‹d_ş—nup
(
tsd_t
 *
tsd
);

458 
th»ad_d—Îoÿ‹d_ş—nup
(
tsd_t
 *
tsd
);

459 
¬’a_ş—nup
(
tsd_t
 *
tsd
);

460 
¬’as_ÿche_ş—nup
(
tsd_t
 *
tsd
);

461 
Ç»Çs_ÿche_ş—nup
(
tsd_t
 *
tsd
);

462 
¬’as_ÿche_by·ss_ş—nup
(
tsd_t
 *
tsd
);

463 
jem®loc_´efÜk
();

464 
jem®loc_po¡fÜk_·»Á
();

465 
jem®loc_po¡fÜk_chd
();

467 
	~"jem®loc/š‹º®/v®gršd.h
"

468 
	~"jem®loc/š‹º®/ut.h
"

469 
	~"jem®loc/š‹º®/©omic.h
"

470 
	~"jem®loc/š‹º®/´ng.h
"

471 
	~"jem®loc/š‹º®/ckh.h
"

472 
	~"jem®loc/š‹º®/size_şas£s.h
"

473 
	~"jem®loc/š‹º®/¡©s.h
"

474 
	~"jem®loc/š‹º®/ùl.h
"

475 
	~"jem®loc/š‹º®/mu‹x.h
"

476 
	~"jem®loc/š‹º®/mb.h
"

477 
	~"jem®loc/š‹º®/b™m­.h
"

478 
	~"jem®loc/š‹º®/ex‹Á.h
"

479 
	~"jem®loc/š‹º®/¬’a.h
"

480 
	~"jem®loc/š‹º®/ba£.h
"

481 
	~"jem®loc/š‹º®/¹»e.h
"

482 
	~"jem®loc/š‹º®/·ges.h
"

483 
	~"jem®loc/š‹º®/chunk.h
"

484 
	~"jem®loc/š‹º®/huge.h
"

485 
	~"jem®loc/š‹º®/tÿche.h
"

486 
	~"jem®loc/š‹º®/hash.h
"

487 
	~"jem®loc/š‹º®/qu¬ªtše.h
"

488 
	~"jem®loc/š‹º®/´of.h
"

489 
	~"jem®loc/š‹º®/tsd.h
"

491 #undeà
JEMALLOC_H_EXTERNS


493 
	#JEMALLOC_H_INLINES


	)

495 
	~"jem®loc/š‹º®/v®gršd.h
"

496 
	~"jem®loc/š‹º®/ut.h
"

497 
	~"jem®loc/š‹º®/©omic.h
"

498 
	~"jem®loc/š‹º®/´ng.h
"

499 
	~"jem®loc/š‹º®/ckh.h
"

500 
	~"jem®loc/š‹º®/size_şas£s.h
"

501 
	~"jem®loc/š‹º®/¡©s.h
"

502 
	~"jem®loc/š‹º®/ùl.h
"

503 
	~"jem®loc/š‹º®/mu‹x.h
"

504 
	~"jem®loc/š‹º®/tsd.h
"

505 
	~"jem®loc/š‹º®/mb.h
"

506 
	~"jem®loc/š‹º®/ex‹Á.h
"

507 
	~"jem®loc/š‹º®/ba£.h
"

508 
	~"jem®loc/š‹º®/¹»e.h
"

509 
	~"jem®loc/š‹º®/·ges.h
"

510 
	~"jem®loc/š‹º®/chunk.h
"

511 
	~"jem®loc/š‹º®/huge.h
"

513 #iâdeà
JEMALLOC_ENABLE_INLINE


514 
szšd_t
 
size2šdex_compu‹
(
size_t
 
size
);

515 
szšd_t
 
size2šdex_lookup
(
size_t
 
size
);

516 
szšd_t
 
size2šdex
(
size_t
 
size
);

517 
size_t
 
šdex2size_compu‹
(
szšd_t
 
šdex
);

518 
size_t
 
šdex2size_lookup
(
szšd_t
 
šdex
);

519 
size_t
 
šdex2size
(
szšd_t
 
šdex
);

520 
size_t
 
s2u_compu‹
(size_ˆ
size
);

521 
size_t
 
s2u_lookup
(size_ˆ
size
);

522 
size_t
 
s2u
(size_ˆ
size
);

523 
size_t
 
§2u
(size_ˆ
size
, size_ˆ
®ignm’t
);

524 
¬’a_t
 *
¬’a_choo£
(
tsd_t
 *
tsd
,‡»Ç_ˆ*
¬’a
);

525 
¬’a_t
 *
¬’a_g‘
(
tsd_t
 *
tsd
, 
šd
, 
boŞ
 
š™_if_missšg
,

526 
boŞ
 
»äesh_if_missšg
);

529 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_C_
))

530 
JEMALLOC_INLINE
 
szšd_t


531 
	$size2šdex_compu‹
(
size_t
 
size
)

534 #ià(
NTBINS
 != 0)

535 ià(
size
 <ğ(
	`ZU
(1è<< 
LG_TINY_MAXCLASS
)) {

536 
size_t
 
lg_tmš
 = 
LG_TINY_MAXCLASS
 - 
NTBINS
 + 1;

537 
size_t
 
lg_û
 = 
	`lg_æoÜ
(
	`pow2_û
(
size
));

538  (
lg_û
 < 
lg_tmš
 ? 0 :†g_ceil -†g_tmin);

542 
size_t
 
x
 = 
	`uÆik–y
(
	`ZI
(
size
) < 0) ? ((size<<1) ?

543 (
	`ZU
(1)<<(
LG_SIZEOF_PTR
+3)) : ((ZU(1)<<(LG_SIZEOF_PTR+3))-1))

544 : 
	`lg_æoÜ
((
size
<<1)-1);

545 
size_t
 
shiá
 = (
x
 < 
LG_SIZE_CLASS_GROUP
 + 
LG_QUANTUM
) ? 0 :

546 
x
 - (
LG_SIZE_CLASS_GROUP
 + 
LG_QUANTUM
);

547 
size_t
 
g½
 = 
shiá
 << 
LG_SIZE_CLASS_GROUP
;

549 
size_t
 
lg_d–
 = (
x
 < 
LG_SIZE_CLASS_GROUP
 + 
LG_QUANTUM
 + 1)

550 ? 
LG_QUANTUM
 : 
x
 - 
LG_SIZE_CLASS_GROUP
 - 1;

552 
size_t
 
d–_šv”£_mask
 = 
	`ZI
(-1è<< 
lg_d–
;

553 
size_t
 
mod
 = ((((
size
-1è& 
d–_šv”£_mask
è>> 
lg_d–
)) &

554 ((
	`ZU
(1è<< 
LG_SIZE_CLASS_GROUP
) - 1);

556 
size_t
 
šdex
 = 
NTBINS
 + 
g½
 + 
mod
;

557  (
šdex
);

559 
	}
}

561 
JEMALLOC_ALWAYS_INLINE
 
szšd_t


562 
	$size2šdex_lookup
(
size_t
 
size
)

565 
	`as£¹
(
size
 <ğ
LOOKUP_MAXCLASS
);

567 
size_t
 
»t
 = ((size_t)(
size2šdex_b
[(
size
-1) >>

568 
LG_TINY_MIN
]));

569 
	`as£¹
(
»t
 =ğ
	`size2šdex_compu‹
(
size
));

570  (
»t
);

572 
	}
}

574 
JEMALLOC_ALWAYS_INLINE
 
szšd_t


575 
	$size2šdex
(
size_t
 
size
)

578 
	`as£¹
(
size
 > 0);

579 ià(
	`lik–y
(
size
 <ğ
LOOKUP_MAXCLASS
))

580  (
	`size2šdex_lookup
(
size
));

581  (
	`size2šdex_compu‹
(
size
));

582 
	}
}

584 
JEMALLOC_INLINE
 
size_t


585 
	$šdex2size_compu‹
(
szšd_t
 
šdex
)

588 #ià(
NTBINS
 > 0)

589 ià(
šdex
 < 
NTBINS
)

590  (
	`ZU
(1è<< (
LG_TINY_MAXCLASS
 - 
NTBINS
 + 1 + 
šdex
));

593 
size_t
 
»duûd_šdex
 = 
šdex
 - 
NTBINS
;

594 
size_t
 
g½
 = 
»duûd_šdex
 >> 
LG_SIZE_CLASS_GROUP
;

595 
size_t
 
mod
 = 
»duûd_šdex
 & ((
	`ZU
(1è<< 
LG_SIZE_CLASS_GROUP
) -

598 
size_t
 
g½_size_mask
 = ~((!!
g½
)-1);

599 
size_t
 
g½_size
 = ((
	`ZU
(1è<< (
LG_QUANTUM
 +

600 (
LG_SIZE_CLASS_GROUP
-1))è<< 
g½
è& 
g½_size_mask
;

602 
size_t
 
shiá
 = (
g½
 == 0) ? 1 : grp;

603 
size_t
 
lg_d–
 = 
shiá
 + (
LG_QUANTUM
-1);

604 
size_t
 
mod_size
 = (
mod
+1è<< 
lg_d–
;

606 
size_t
 
usize
 = 
g½_size
 + 
mod_size
;

607  (
usize
);

609 
	}
}

611 
JEMALLOC_ALWAYS_INLINE
 
size_t


612 
	$šdex2size_lookup
(
szšd_t
 
šdex
)

614 
size_t
 
»t
 = (size_t)
šdex2size_b
[
šdex
];

615 
	`as£¹
(
»t
 =ğ
	`šdex2size_compu‹
(
šdex
));

616  (
»t
);

617 
	}
}

619 
JEMALLOC_ALWAYS_INLINE
 
size_t


620 
	$šdex2size
(
szšd_t
 
šdex
)

623 
	`as£¹
(
šdex
 < 
NSIZES
);

624  (
	`šdex2size_lookup
(
šdex
));

625 
	}
}

627 
JEMALLOC_ALWAYS_INLINE
 
size_t


628 
	$s2u_compu‹
(
size_t
 
size
)

631 #ià(
NTBINS
 > 0)

632 ià(
size
 <ğ(
	`ZU
(1è<< 
LG_TINY_MAXCLASS
)) {

633 
size_t
 
lg_tmš
 = 
LG_TINY_MAXCLASS
 - 
NTBINS
 + 1;

634 
size_t
 
lg_û
 = 
	`lg_æoÜ
(
	`pow2_û
(
size
));

635  (
lg_û
 < 
lg_tmš
 ? (
	`ZU
(1) <<†g_tmin) :

636 (
	`ZU
(1è<< 
lg_û
));

640 
size_t
 
x
 = 
	`uÆik–y
(
	`ZI
(
size
) < 0) ? ((size<<1) ?

641 (
	`ZU
(1)<<(
LG_SIZEOF_PTR
+3)) : ((ZU(1)<<(LG_SIZEOF_PTR+3))-1))

642 : 
	`lg_æoÜ
((
size
<<1)-1);

643 
size_t
 
lg_d–
 = (
x
 < 
LG_SIZE_CLASS_GROUP
 + 
LG_QUANTUM
 + 1)

644 ? 
LG_QUANTUM
 : 
x
 - 
LG_SIZE_CLASS_GROUP
 - 1;

645 
size_t
 
d–
 = 
	`ZU
(1è<< 
lg_d–
;

646 
size_t
 
d–_mask
 = 
d–
 - 1;

647 
size_t
 
usize
 = (
size
 + 
d–_mask
) & ~delta_mask;

648  (
usize
);

650 
	}
}

652 
JEMALLOC_ALWAYS_INLINE
 
size_t


653 
	$s2u_lookup
(
size_t
 
size
)

655 
size_t
 
»t
 = 
	`šdex2size_lookup
(
	`size2šdex_lookup
(
size
));

657 
	`as£¹
(
»t
 =ğ
	`s2u_compu‹
(
size
));

658  (
»t
);

659 
	}
}

665 
JEMALLOC_ALWAYS_INLINE
 
size_t


666 
	$s2u
(
size_t
 
size
)

669 
	`as£¹
(
size
 > 0);

670 ià(
	`lik–y
(
size
 <ğ
LOOKUP_MAXCLASS
))

671  (
	`s2u_lookup
(
size
));

672  (
	`s2u_compu‹
(
size
));

673 
	}
}

679 
JEMALLOC_ALWAYS_INLINE
 
size_t


680 
	$§2u
(
size_t
 
size
, size_ˆ
®ignm’t
)

682 
size_t
 
usize
;

684 
	`as£¹
(
®ignm’t
 != 0 && ((alignment - 1) &‡lignment) == 0);

687 ià(
size
 <ğ
SMALL_MAXCLASS
 && 
®ignm’t
 < 
PAGE
) {

702 
usize
 = 
	`s2u
(
	`ALIGNMENT_CEILING
(
size
, 
®ignm’t
));

703 ià(
usize
 < 
LARGE_MINCLASS
)

704  (
usize
);

708 ià(
	`lik–y
(
size
 <ğ
Ïrge_maxşass
è&&†ik–y(
®ignm’t
 < 
chunksize
)) {

713 
®ignm’t
 = 
	`PAGE_CEILING
(alignment);

716 
usize
 = (
size
 <ğ
LARGE_MINCLASS
è? LARGE_MINCLASS : 
	`s2u
(size);

722 ià(
usize
 + 
Ïrge_·d
 + 
®ignm’t
 - 
PAGE
 <ğ
¬’a_maxrun
)

723  (
usize
);

732 
®ignm’t
 = 
	`CHUNK_CEILING
(alignment);

733 ià(
®ignm’t
 == 0) {

739 ià(
size
 <ğ
chunksize
)

740 
usize
 = 
chunksize
;

742 
usize
 = 
	`s2u
(
size
);

743 ià(
usize
 < 
size
) {

753 ià(
usize
 + 
®ignm’t
 - 
PAGE
 < usize) {

757  (
usize
);

758 
	}
}

761 
JEMALLOC_INLINE
 
¬’a_t
 *

762 
	$¬’a_choo£
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
)

764 
¬’a_t
 *
»t
;

766 ià(
¬’a
 !ğ
NULL
)

767  (
¬’a
);

769 ià(
	`uÆik–y
((
»t
 = 
	`tsd_¬’a_g‘
(
tsd
)è=ğ
NULL
))

770 
»t
 = 
	`¬’a_choo£_h¬d
(
tsd
);

772  (
»t
);

773 
	}
}

775 
JEMALLOC_INLINE
 
¬’a_t
 *

776 
	$¬’a_g‘
(
tsd_t
 *
tsd
, 
šd
, 
boŞ
 
š™_if_missšg
,

777 
boŞ
 
»äesh_if_missšg
)

779 
¬’a_t
 *
¬’a
;

780 
¬’a_t
 **
¬’as_ÿche
 = 
	`tsd_¬’as_ÿche_g‘
(
tsd
);

783 
	`as£¹
(!
š™_if_missšg
 || 
»äesh_if_missšg
);

785 ià(
	`uÆik–y
(
¬’as_ÿche
 =ğ
NULL
)) {

787  (
	`¬’a_g‘_h¬d
(
tsd
, 
šd
, 
š™_if_missšg
));

789 ià(
	`uÆik–y
(
šd
 >ğ
	`tsd_Ç»Çs_ÿche_g‘
(
tsd
))) {

794  (
»äesh_if_missšg
 ? 
	`¬’a_g‘_h¬d
(
tsd
, 
šd
,

795 
š™_if_missšg
è: 
NULL
);

797 
¬’a
 = 
¬’as_ÿche
[
šd
];

798 ià(
	`lik–y
(
¬’a
 !ğ
NULL
è|| !
»äesh_if_missšg
)

799  (
¬’a
);

800  (
	`¬’a_g‘_h¬d
(
tsd
, 
šd
, 
š™_if_missšg
));

801 
	}
}

804 
	~"jem®loc/š‹º®/b™m­.h
"

809 
	#JEMALLOC_ARENA_INLINE_A


	)

810 
	~"jem®loc/š‹º®/¬’a.h
"

811 #undeà
JEMALLOC_ARENA_INLINE_A


812 
	~"jem®loc/š‹º®/tÿche.h
"

813 
	#JEMALLOC_ARENA_INLINE_B


	)

814 
	~"jem®loc/š‹º®/¬’a.h
"

815 #undeà
JEMALLOC_ARENA_INLINE_B


816 
	~"jem®loc/š‹º®/hash.h
"

817 
	~"jem®loc/š‹º®/qu¬ªtše.h
"

819 #iâdeà
JEMALLOC_ENABLE_INLINE


820 
¬’a_t
 *
Ÿ®loc
(cÚ¡ *
±r
);

821 
size_t
 
i§Îoc
(cÚ¡ *
±r
, 
boŞ
 
demÙe
);

822 *
ŸÎocztm
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
,

823 
boŞ
 
is_m‘ad©a
, 
¬’a_t
 *
¬’a
);

824 *
im®loù
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
);

825 *
im®loc
(
tsd_t
 *
tsd
, 
size_t
 
size
);

826 *
iÿÎoù
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
);

827 *
iÿÎoc
(
tsd_t
 *
tsd
, 
size_t
 
size
);

828 *
®locztm
(
tsd_t
 *
tsd
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

829 
tÿche_t
 *
tÿche
, 
boŞ
 
is_m‘ad©a
, 
¬’a_t
 *
¬’a
);

830 *
®loù
(
tsd_t
 *
tsd
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

831 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
);

832 *
®loc
(
tsd_t
 *
tsd
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
);

833 
size_t
 
iv§Îoc
(cÚ¡ *
±r
, 
boŞ
 
demÙe
);

834 
size_t
 
u2rz
(size_ˆ
usize
);

835 
size_t
 
p2rz
(cÚ¡ *
±r
);

836 
id®loùm
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
, 
boŞ
 
is_m‘ad©a
);

837 
id®loù
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
);

838 
id®loc
(
tsd_t
 *
tsd
, *
±r
);

839 
iq®loc
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
);

840 
isd®loù
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
);

841 
isq®loc
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
);

842 *
œ®loù_»®ign
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

843 
size_t
 
exŒa
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
,

844 
¬’a_t
 *
¬’a
);

845 *
œ®loù
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

846 
size_t
 
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
);

847 *
œ®loc
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

848 
size_t
 
®ignm’t
, 
boŞ
 
z”o
);

849 
boŞ
 
ix®loc
(*
±r
, 
size_t
 
Şdsize
, size_ˆ
size
, size_ˆ
exŒa
,

850 
size_t
 
®ignm’t
, 
boŞ
 
z”o
);

853 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_C_
))

854 
JEMALLOC_ALWAYS_INLINE
 
¬’a_t
 *

855 
	$Ÿ®loc
(cÚ¡ *
±r
)

858 
	`as£¹
(
±r
 !ğ
NULL
);

860  (
	`¬’a_¯Îoc
(
±r
));

861 
	}
}

868 
JEMALLOC_ALWAYS_INLINE
 
size_t


869 
	$i§Îoc
(cÚ¡ *
±r
, 
boŞ
 
demÙe
)

872 
	`as£¹
(
±r
 !ğ
NULL
);

874 
	`as£¹
(
cÚfig_´of
 || !
demÙe
);

876  (
	`¬’a_§Îoc
(
±r
, 
demÙe
));

877 
	}
}

879 
JEMALLOC_ALWAYS_INLINE
 *

880 
	$ŸÎocztm
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
, boŞ 
is_m‘ad©a
,

881 
¬’a_t
 *
¬’a
)

883 *
»t
;

885 
	`as£¹
(
size
 != 0);

887 
»t
 = 
	`¬’a_m®loc
(
tsd
, 
¬’a
, 
size
, 
z”o
, 
tÿche
);

888 ià(
cÚfig_¡©s
 && 
is_m‘ad©a
 && 
	`lik–y
(
»t
 !ğ
NULL
)) {

889 
	`¬’a_m‘ad©a_®loÿ‹d_add
(
	`Ÿ®loc
(
»t
), 
	`i§Îoc
(ret,

890 
cÚfig_´of
));

892  (
»t
);

893 
	}
}

895 
JEMALLOC_ALWAYS_INLINE
 *

896 
	$im®loù
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

899  (
	`ŸÎocztm
(
tsd
, 
size
, 
çl£
, 
tÿche
, f®£, 
¬’a
));

900 
	}
}

902 
JEMALLOC_ALWAYS_INLINE
 *

903 
	$im®loc
(
tsd_t
 *
tsd
, 
size_t
 
size
)

906  (
	`ŸÎocztm
(
tsd
, 
size
, 
çl£
, 
	`tÿche_g‘
Ñsd, 
Œue
), f®£, 
NULL
));

907 
	}
}

909 
JEMALLOC_ALWAYS_INLINE
 *

910 
	$iÿÎoù
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

913  (
	`ŸÎocztm
(
tsd
, 
size
, 
Œue
, 
tÿche
, 
çl£
, 
¬’a
));

914 
	}
}

916 
JEMALLOC_ALWAYS_INLINE
 *

917 
	$iÿÎoc
(
tsd_t
 *
tsd
, 
size_t
 
size
)

920  (
	`ŸÎocztm
(
tsd
, 
size
, 
Œue
, 
	`tÿche_g‘
Ñsd,rue), 
çl£
, 
NULL
));

921 
	}
}

923 
JEMALLOC_ALWAYS_INLINE
 *

924 
	$®locztm
(
tsd_t
 *
tsd
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

925 
tÿche_t
 *
tÿche
, 
boŞ
 
is_m‘ad©a
, 
¬’a_t
 *
¬’a
)

927 *
»t
;

929 
	`as£¹
(
usize
 != 0);

930 
	`as£¹
(
usize
 =ğ
	`§2u
(usize, 
®ignm’t
));

932 
»t
 = 
	`¬’a_·Îoc
(
tsd
, 
¬’a
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
);

933 
	`as£¹
(
	`ALIGNMENT_ADDR2BASE
(
»t
, 
®ignm’t
) ==„et);

934 ià(
cÚfig_¡©s
 && 
is_m‘ad©a
 && 
	`lik–y
(
»t
 !ğ
NULL
)) {

935 
	`¬’a_m‘ad©a_®loÿ‹d_add
(
	`Ÿ®loc
(
»t
), 
	`i§Îoc
(ret,

936 
cÚfig_´of
));

938  (
»t
);

939 
	}
}

941 
JEMALLOC_ALWAYS_INLINE
 *

942 
	$®loù
(
tsd_t
 *
tsd
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

943 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

946  (
	`®locztm
(
tsd
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
çl£
, 
¬’a
));

947 
	}
}

949 
JEMALLOC_ALWAYS_INLINE
 *

950 
	$®loc
(
tsd_t
 *
tsd
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
)

953  (
	`®locztm
(
tsd
, 
usize
, 
®ignm’t
, 
z”o
, 
	`tÿche_g‘
(tsd,

954 
NULL
), 
çl£
, NULL));

955 
	}
}

957 
JEMALLOC_ALWAYS_INLINE
 
size_t


958 
	$iv§Îoc
(cÚ¡ *
±r
, 
boŞ
 
demÙe
)

960 
ex‹Á_node_t
 *
node
;

963 
node
 = 
	`chunk_lookup
(
±r
, 
çl£
);

964 ià(
node
 =ğ
NULL
)

967 
	`as£¹
(
	`ex‹Á_node_addr_g‘
(
node
è=ğ
±r
 ||

968 
	`ex‹Á_node_achunk_g‘
(
node
));

970  (
	`i§Îoc
(
±r
, 
demÙe
));

971 
	}
}

973 
JEMALLOC_INLINE
 
size_t


974 
	$u2rz
(
size_t
 
usize
)

976 
size_t
 
»t
;

978 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

979 
szšd_t
 
bššd
 = 
	`size2šdex
(
usize
);

980 
»t
 = 
¬’a_bš_šfo
[
bššd
].
»dzÚe_size
;

982 
»t
 = 0;

984  (
»t
);

985 
	}
}

987 
JEMALLOC_INLINE
 
size_t


988 
	$p2rz
(cÚ¡ *
±r
)

990 
size_t
 
usize
 = 
	`i§Îoc
(
±r
, 
çl£
);

992  (
	`u2rz
(
usize
));

993 
	}
}

995 
JEMALLOC_ALWAYS_INLINE
 

996 
	$id®loùm
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
, 
boŞ
 
is_m‘ad©a
)

999 
	`as£¹
(
±r
 !ğ
NULL
);

1000 ià(
cÚfig_¡©s
 && 
is_m‘ad©a
) {

1001 
	`¬’a_m‘ad©a_®loÿ‹d_sub
(
	`Ÿ®loc
(
±r
), 
	`i§Îoc
(ptr,

1002 
cÚfig_´of
));

1005 
	`¬’a_d®loc
(
tsd
, 
±r
, 
tÿche
);

1006 
	}
}

1008 
JEMALLOC_ALWAYS_INLINE
 

1009 
	$id®loù
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
)

1012 
	`id®loùm
(
tsd
, 
±r
, 
tÿche
, 
çl£
);

1013 
	}
}

1015 
JEMALLOC_ALWAYS_INLINE
 

1016 
	$id®loc
(
tsd_t
 *
tsd
, *
±r
)

1019 
	`id®loùm
(
tsd
, 
±r
, 
	`tÿche_g‘
Ñsd, 
çl£
), false);

1020 
	}
}

1022 
JEMALLOC_ALWAYS_INLINE
 

1023 
	$iq®loc
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
)

1026 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_qu¬ªtše
))

1027 
	`qu¬ªtše
(
tsd
, 
±r
);

1029 
	`id®loùm
(
tsd
, 
±r
, 
tÿche
, 
çl£
);

1030 
	}
}

1032 
JEMALLOC_ALWAYS_INLINE
 

1033 
	$isd®loù
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
)

1036 
	`¬’a_sd®loc
(
tsd
, 
±r
, 
size
, 
tÿche
);

1037 
	}
}

1039 
JEMALLOC_ALWAYS_INLINE
 

1040 
	$isq®loc
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
size
, 
tÿche_t
 *
tÿche
)

1043 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_qu¬ªtše
))

1044 
	`qu¬ªtše
(
tsd
, 
±r
);

1046 
	`isd®loù
(
tsd
, 
±r
, 
size
, 
tÿche
);

1047 
	}
}

1049 
JEMALLOC_ALWAYS_INLINE
 *

1050 
	$œ®loù_»®ign
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

1051 
size_t
 
exŒa
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

1053 *
p
;

1054 
size_t
 
usize
, 
cİysize
;

1056 
usize
 = 
	`§2u
(
size
 + 
exŒa
, 
®ignm’t
);

1057 ià(
usize
 == 0)

1058  (
NULL
);

1059 
p
 = 
	`®loù
(
tsd
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
);

1060 ià(
p
 =ğ
NULL
) {

1061 ià(
exŒa
 == 0)

1062  (
NULL
);

1064 
usize
 = 
	`§2u
(
size
, 
®ignm’t
);

1065 ià(
usize
 == 0)

1066  (
NULL
);

1067 
p
 = 
	`®loù
(
tsd
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
);

1068 ià(
p
 =ğ
NULL
)

1069  (
NULL
);

1075 
cİysize
 = (
size
 < 
Şdsize
) ? size : oldsize;

1076 
	`memıy
(
p
, 
±r
, 
cİysize
);

1077 
	`isq®loc
(
tsd
, 
±r
, 
Şdsize
, 
tÿche
);

1078  (
p
);

1079 
	}
}

1081 
JEMALLOC_ALWAYS_INLINE
 *

1082 
	$œ®loù
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
, size_ˆ
®ignm’t
,

1083 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

1086 
	`as£¹
(
±r
 !ğ
NULL
);

1087 
	`as£¹
(
size
 != 0);

1089 ià(
®ignm’t
 !ğ0 && ((
ušŒ_t
)
±r
 & ((uintptr_t)alignment-1))

1095  (
	`œ®loù_»®ign
(
tsd
, 
±r
, 
Şdsize
, 
size
, 0, 
®ignm’t
,

1096 
z”o
, 
tÿche
, 
¬’a
));

1099  (
	`¬’a_¿Îoc
(
tsd
, 
¬’a
, 
±r
, 
Şdsize
, 
size
, 
®ignm’t
, 
z”o
,

1100 
tÿche
));

1101 
	}
}

1103 
JEMALLOC_ALWAYS_INLINE
 *

1104 
	$œ®loc
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
, size_ˆ
®ignm’t
,

1105 
boŞ
 
z”o
)

1108  (
	`œ®loù
(
tsd
, 
±r
, 
Şdsize
, 
size
, 
®ignm’t
, 
z”o
,

1109 
	`tÿche_g‘
(
tsd
, 
Œue
), 
NULL
));

1110 
	}
}

1112 
JEMALLOC_ALWAYS_INLINE
 
boŞ


1113 
	$ix®loc
(*
±r
, 
size_t
 
Şdsize
, size_ˆ
size
, size_ˆ
exŒa
, size_ˆ
®ignm’t
,

1114 
boŞ
 
z”o
)

1117 
	`as£¹
(
±r
 !ğ
NULL
);

1118 
	`as£¹
(
size
 != 0);

1120 ià(
®ignm’t
 !ğ0 && ((
ušŒ_t
)
±r
 & ((uintptr_t)alignment-1))

1123  (
Œue
);

1126  (
	`¬’a_¿Îoc_no_move
(
±r
, 
Şdsize
, 
size
, 
exŒa
, 
z”o
));

1127 
	}
}

1130 
	~"jem®loc/š‹º®/´of.h
"

1132 #undeà
JEMALLOC_H_INLINES


	@deps/jemalloc/include/jemalloc/internal/jemalloc_internal_decls.h

1 #iâdeà
JEMALLOC_INTERNAL_DECLS_H


2 
	#JEMALLOC_INTERNAL_DECLS_H


	)

4 
	~<m©h.h
>

5 #ifdeà
_WIN32


6 
	~<wšdows.h
>

7 
	~"msvc_com·t/wšdows_exŒa.h
"

10 
	~<sys/·¿m.h
>

11 
	~<sys/mmª.h
>

12 #ià!
defšed
(
__²aş__
è&& !defšed(
__Çtive_ş›Á__
)

13 
	~<sys/sysÿÎ.h
>

14 #ià!
defšed
(
SYS_wr™e
è&& defšed(
__NR_wr™e
)

15 
	#SYS_wr™e
 
__NR_wr™e


	)

17 
	~<sys/uio.h
>

19 
	~<±h»ad.h
>

20 
	~<”ºo.h
>

22 
	~<sys/ty³s.h
>

24 
	~<lim™s.h
>

25 #iâdeà
SIZE_T_MAX


26 
	#SIZE_T_MAX
 
SIZE_MAX


	)

28 
	~<¡d¬g.h
>

29 
	~<¡dboŞ.h
>

30 
	~<¡dio.h
>

31 
	~<¡dlib.h
>

32 
	~<¡dšt.h
>

33 
	~<¡ddef.h
>

34 #iâdeà
off£tof


35 
	#off£tof
(
ty³
, 
memb”
è((
size_t
)&((Ñy³ *)
NULL
)->memb”))

	)

37 
	~<¡ršg.h
>

38 
	~<¡ršgs.h
>

39 
	~<ùy³.h
>

40 #ifdeà
_MSC_VER


41 
	~<io.h
>

42 
šŒ_t
 
	tssize_t
;

43 
	#PATH_MAX
 1024

	)

44 
	#STDERR_FILENO
 2

	)

45 
	#__func__
 
__FUNCTION__


	)

46 #ifdeà
JEMALLOC_HAS_RESTRICT


47 
	#»¡riù
 
__»¡riù


	)

50 #´agm¨
w¬nšg
(
di§bË
: 4996)

51 #ià
_MSC_VER
 < 1800

53 
	$isbÏnk
(
c
)

56  (
c
 == '\t' || c == ' ');

57 
	}
}

60 
	~<uni¡d.h
>

62 
	~<fú.h
>

	@deps/jemalloc/include/jemalloc/internal/jemalloc_internal_defs.h

2 #iâdeà
JEMALLOC_INTERNAL_DEFS_H_


3 
	#JEMALLOC_INTERNAL_DEFS_H_


	)

9 
	#JEMALLOC_PREFIX
 "je_"

	)

10 
	#JEMALLOC_CPREFIX
 "JE_"

	)

18 
	#JEMALLOC_PRIVATE_NAMESPACE
 
je_


	)

24 
	#CPU_SPINWAIT
 
__asm__
 vŞ©e("·u£")

	)

57 
	#JEMALLOC_HAVE_BUILTIN_CLZ


	)

62 
	#JEMALLOC_HAVE_MADVISE


	)

73 
	#JEMALLOC_HAVE_SECURE_GETENV


	)

94 
	#JEMALLOC_THREADED_INIT


	)

104 
	#JEMALLOC_TLS_MODEL
 
	`__©Œibu‹__
((
	`s_mod–
("š™Ÿl-exec")))

	)

107 
	#JEMALLOC_CC_SILENCE


	)

119 
	#JEMALLOC_STATS


	)

138 
	#JEMALLOC_TCACHE


	)

144 
	#JEMALLOC_DSS


	)

147 
	#JEMALLOC_FILL


	)

162 
	#LG_TINY_MIN
 3

	)

168 
	#LG_QUANTUM
 3

	)

171 
	#LG_PAGE
 12

	)

180 
	#JEMALLOC_MAPS_COALESCE


	)

190 
	#JEMALLOC_TLS


	)

196 
	#JEMALLOC_INTERNAL_FFSL
 
__butš_ff¦


	)

197 
	#JEMALLOC_INTERNAL_FFS
 
__butš_ffs


	)

209 
	#JEMALLOC_CACHE_OBLIVIOUS


	)

227 
	#JEMALLOC_PURGE_MADVISE_DONTNEED


	)

231 
	#JEMALLOC_HAS_ALLOCA_H
 1

	)

240 
	#LG_SIZEOF_INT
 2

	)

243 
	#LG_SIZEOF_LONG
 3

	)

246 
	#LG_SIZEOF_INTMAX_T
 3

	)

249 
	#JEMALLOC_GLIBC_MALLOC_HOOK


	)

252 
	#JEMALLOC_GLIBC_MEMALIGN_HOOK


	)

255 
	#JEMALLOC_HAVE_PTHREAD_MUTEX_ADAPTIVE_NP


	)

	@deps/jemalloc/include/jemalloc/internal/jemalloc_internal_macros.h

10 #ià
defšed
(
JEMALLOC_DEBUG
è|| defšed(
JEMALLOC_CODE_COVERAGE
)

12 
	#JEMALLOC_ALWAYS_INLINE


	)

13 
	#JEMALLOC_ALWAYS_INLINE_C
 

	)

14 
	#JEMALLOC_INLINE


	)

15 
	#JEMALLOC_INLINE_C
 

	)

16 
	#šlše


	)

18 
	#JEMALLOC_ENABLE_INLINE


	)

19 #ifdeà
JEMALLOC_HAVE_ATTR


20 
	#JEMALLOC_ALWAYS_INLINE
 \

21 
šlše
 
	`JEMALLOC_ATTR
(
unu£d
èJEMALLOC_ATTR(
®ways_šlše
)

	)

22 
	#JEMALLOC_ALWAYS_INLINE_C
 \

23 
šlše
 
	`JEMALLOC_ATTR
(
®ways_šlše
)

	)

25 
	#JEMALLOC_ALWAYS_INLINE
 
šlše


	)

26 
	#JEMALLOC_ALWAYS_INLINE_C
 
šlše


	)

28 
	#JEMALLOC_INLINE
 
šlše


	)

29 
	#JEMALLOC_INLINE_C
 
šlše


	)

30 #ifdeà
_MSC_VER


31 
	#šlše
 
_šlše


	)

35 #ifdeà
JEMALLOC_CC_SILENCE


36 
	#UNUSED
 
	`JEMALLOC_ATTR
(
unu£d
)

	)

38 
	#UNUSED


	)

41 
	#ZU
(
z
è((
size_t
)z)

	)

42 
	#ZI
(
z
è((
ssize_t
)z)

	)

43 
	#QU
(
q
è((
ušt64_t
)q)

	)

44 
	#QI
(
q
è((
št64_t
)q)

	)

46 
	#KZU
(
z
è
	`ZU
(z##
ULL
)

	)

47 
	#KZI
(
z
è
	`ZI
(z##
LL
)

	)

48 
	#KQU
(
q
è
	`QU
(q##
ULL
)

	)

49 
	#KQI
(
q
è
	`QI
(q##
LL
)

	)

51 #iâdeà
__DECONST


52 
	#__DECONST
(
ty³
, 
v¬
è(Ñy³)(
ušŒ_t
)(cÚ¡ *)(v¬))

	)

55 #iâdeà
JEMALLOC_HAS_RESTRICT


56 
	#»¡riù


	)

	@deps/jemalloc/include/jemalloc/internal/mb.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


14 #ifdeà
JEMALLOC_H_INLINES


16 #iâdeà
JEMALLOC_ENABLE_INLINE


17 
mb_wr™e
();

20 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_MB_C_
))

21 #ifdeà
__i386__


31 
JEMALLOC_INLINE
 

32 
	$mb_wr™e
()

37 
asm
 volatile ("pusha;"

50 
asm
 volatile ("nop;"

56 
	}
}

57 #–ià(
defšed
(
__amd64__
è|| defšed(
__x86_64__
))

58 
JEMALLOC_INLINE
 

59 
	$mb_wr™e
()

62 
asm
 volatile ("sfence"

67 
	}
}

68 #–ià
defšed
(
__pow”pc__
)

69 
JEMALLOC_INLINE
 

70 
	$mb_wr™e
()

73 
asm
 volatile ("eieio"

78 
	}
}

79 #–ià
defšed
(
__¥¬c64__
)

80 
JEMALLOC_INLINE
 

81 
	$mb_wr™e
()

84 
asm
 volatile ("membar #StoreStore"

89 
	}
}

90 #–ià
defšed
(
__te__
)

91 
JEMALLOC_INLINE
 

92 
	$mb_wr™e
()

95 
	`__sync_synchrÚize
();

96 
	}
}

102 
JEMALLOC_INLINE
 

103 
	$mb_wr™e
()

105 
m®loc_mu‹x_t
 
mtx
;

107 
	`m®loc_mu‹x_š™
(&
mtx
);

108 
	`m®loc_mu‹x_lock
(&
mtx
);

109 
	`m®loc_mu‹x_uÆock
(&
mtx
);

110 
	}
}

	@deps/jemalloc/include/jemalloc/internal/mutex.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
m®loc_mu‹x_s
 
	tm®loc_mu‹x_t
;

6 #ifdeà
_WIN32


7 
	#MALLOC_MUTEX_INITIALIZER


	)

8 #–ià(
defšed
(
JEMALLOC_OSSPIN
))

9 
	#MALLOC_MUTEX_INITIALIZER
 {0}

	)

10 #–ià(
defšed
(
JEMALLOC_MUTEX_INIT_CB
))

11 
	#MALLOC_MUTEX_INITIALIZER
 {
PTHREAD_MUTEX_INITIALIZER
, 
NULL
}

	)

13 #ià(
defšed
(
JEMALLOC_HAVE_PTHREAD_MUTEX_ADAPTIVE_NP
) && \

14 
	$defšed
(
PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
))

15 
	#MALLOC_MUTEX_TYPE
 
PTHREAD_MUTEX_ADAPTIVE_NP


	)

16 
	#MALLOC_MUTEX_INITIALIZER
 {
PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
}

18 
	#MALLOC_MUTEX_TYPE
 
PTHREAD_MUTEX_DEFAULT


	)

19 
	#MALLOC_MUTEX_INITIALIZER
 {
PTHREAD_MUTEX_INITIALIZER
}

	)

25 #ifdeà
JEMALLOC_H_STRUCTS


27 
	sm®loc_mu‹x_s
 {

28 #ifdeà
_WIN32


29 #ià
_WIN32_WINNT
 >= 0x0600

30 
SRWLOCK
 
	mlock
;

32 
CRITICAL_SECTION
 
	mlock
;

34 #–ià(
defšed
(
JEMALLOC_OSSPIN
))

35 
OSSpšLock
 
	mlock
;

36 #–ià(
defšed
(
JEMALLOC_MUTEX_INIT_CB
))

37 
±h»ad_mu‹x_t
 
	mlock
;

38 
m®loc_mu‹x_t
 *
	mpo¡pÚed_Ãxt
;

40 
±h»ad_mu‹x_t
 
	mlock
;

46 #ifdeà
JEMALLOC_H_EXTERNS


48 #ifdeà
JEMALLOC_LAZY_LOCK


49 
boŞ
 
i¡h»aded
;

51 #undeà
i¡h»aded


52 
	#i¡h»aded
 
Œue


	)

55 
boŞ
 
m®loc_mu‹x_š™
(
m®loc_mu‹x_t
 *
mu‹x
);

56 
m®loc_mu‹x_´efÜk
(
m®loc_mu‹x_t
 *
mu‹x
);

57 
m®loc_mu‹x_po¡fÜk_·»Á
(
m®loc_mu‹x_t
 *
mu‹x
);

58 
m®loc_mu‹x_po¡fÜk_chd
(
m®loc_mu‹x_t
 *
mu‹x
);

59 
boŞ
 
mu‹x_boÙ
();

63 #ifdeà
JEMALLOC_H_INLINES


65 #iâdeà
JEMALLOC_ENABLE_INLINE


66 
m®loc_mu‹x_lock
(
m®loc_mu‹x_t
 *
mu‹x
);

67 
m®loc_mu‹x_uÆock
(
m®loc_mu‹x_t
 *
mu‹x
);

70 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_MUTEX_C_
))

71 
JEMALLOC_INLINE
 

72 
	$m®loc_mu‹x_lock
(
m®loc_mu‹x_t
 *
mu‹x
)

75 ià(
i¡h»aded
) {

76 #ifdeà
_WIN32


77 #ià
_WIN32_WINNT
 >= 0x0600

78 
	`AcquœeSRWLockExşusive
(&
mu‹x
->
lock
);

80 
	`EÁ”Cr™iÿlSeùiÚ
(&
mu‹x
->
lock
);

82 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

83 
	`OSSpšLockLock
(&
mu‹x
->
lock
);

85 
	`±h»ad_mu‹x_lock
(&
mu‹x
->
lock
);

88 
	}
}

90 
JEMALLOC_INLINE
 

91 
	$m®loc_mu‹x_uÆock
(
m®loc_mu‹x_t
 *
mu‹x
)

94 ià(
i¡h»aded
) {

95 #ifdeà
_WIN32


96 #ià
_WIN32_WINNT
 >= 0x0600

97 
	`R–—£SRWLockExşusive
(&
mu‹x
->
lock
);

99 
	`L—veCr™iÿlSeùiÚ
(&
mu‹x
->
lock
);

101 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

102 
	`OSSpšLockUÆock
(&
mu‹x
->
lock
);

104 
	`±h»ad_mu‹x_uÆock
(&
mu‹x
->
lock
);

107 
	}
}

	@deps/jemalloc/include/jemalloc/internal/pages.h

2 #ifdeà
JEMALLOC_H_TYPES


6 #ifdeà
JEMALLOC_H_STRUCTS


10 #ifdeà
JEMALLOC_H_EXTERNS


12 *
·ges_m­
(*
addr
, 
size_t
 
size
);

13 
·ges_unm­
(*
addr
, 
size_t
 
size
);

14 *
·ges_Œim
(*
addr
, 
size_t
 
®loc_size
, size_ˆ
Ëadsize
,

15 
size_t
 
size
);

16 
boŞ
 
·ges_comm™
(*
addr
, 
size_t
 
size
);

17 
boŞ
 
·ges_decomm™
(*
addr
, 
size_t
 
size
);

18 
boŞ
 
·ges_purge
(*
addr
, 
size_t
 
size
);

22 #ifdeà
JEMALLOC_H_INLINES


	@deps/jemalloc/include/jemalloc/internal/private_namespace.h

1 
	#a0d®loc
 
	`JEMALLOC_N
(
a0d®loc
)

	)

2 
	#a0g‘
 
	`JEMALLOC_N
(
a0g‘
)

	)

3 
	#a0m®loc
 
	`JEMALLOC_N
(
a0m®loc
)

	)

4 
	#¬’a_¯Îoc
 
	`JEMALLOC_N
(
¬’a_¯Îoc
)

	)

5 
	#¬’a_®loc_junk_sm®l
 
	`JEMALLOC_N
(
¬’a_®loc_junk_sm®l
)

	)

6 
	#¬’a_bš_šdex
 
	`JEMALLOC_N
(
¬’a_bš_šdex
)

	)

7 
	#¬’a_bš_šfo
 
	`JEMALLOC_N
(
¬’a_bš_šfo
)

	)

8 
	#¬’a_b™£lm_g‘
 
	`JEMALLOC_N
(
¬’a_b™£lm_g‘
)

	)

9 
	#¬’a_boÙ
 
	`JEMALLOC_N
(
¬’a_boÙ
)

	)

10 
	#¬’a_choo£
 
	`JEMALLOC_N
(
¬’a_choo£
)

	)

11 
	#¬’a_choo£_h¬d
 
	`JEMALLOC_N
(
¬’a_choo£_h¬d
)

	)

12 
	#¬’a_chunk_®loc_huge
 
	`JEMALLOC_N
(
¬’a_chunk_®loc_huge
)

	)

13 
	#¬’a_chunk_ÿche_maybe_š£¹
 
	`JEMALLOC_N
(
¬’a_chunk_ÿche_maybe_š£¹
)

	)

14 
	#¬’a_chunk_ÿche_maybe_»move
 
	`JEMALLOC_N
(
¬’a_chunk_ÿche_maybe_»move
)

	)

15 
	#¬’a_chunk_d®loc_huge
 
	`JEMALLOC_N
(
¬’a_chunk_d®loc_huge
)

	)

16 
	#¬’a_chunk_¿Îoc_huge_ex·nd
 
	`JEMALLOC_N
(
¬’a_chunk_¿Îoc_huge_ex·nd
)

	)

17 
	#¬’a_chunk_¿Îoc_huge_shršk
 
	`JEMALLOC_N
(
¬’a_chunk_¿Îoc_huge_shršk
)

	)

18 
	#¬’a_chunk_¿Îoc_huge_sim¬
 
	`JEMALLOC_N
(
¬’a_chunk_¿Îoc_huge_sim¬
)

	)

19 
	#¬’a_ş—nup
 
	`JEMALLOC_N
(
¬’a_ş—nup
)

	)

20 
	#¬’a_d®loc
 
	`JEMALLOC_N
(
¬’a_d®loc
)

	)

21 
	#¬’a_d®loc_bš
 
	`JEMALLOC_N
(
¬’a_d®loc_bš
)

	)

22 
	#¬’a_d®loc_bš_junked_locked
 
	`JEMALLOC_N
(
¬’a_d®loc_bš_junked_locked
)

	)

23 
	#¬’a_d®loc_junk_Ïrge
 
	`JEMALLOC_N
(
¬’a_d®loc_junk_Ïrge
)

	)

24 
	#¬’a_d®loc_junk_sm®l
 
	`JEMALLOC_N
(
¬’a_d®loc_junk_sm®l
)

	)

25 
	#¬’a_d®loc_Ïrge
 
	`JEMALLOC_N
(
¬’a_d®loc_Ïrge
)

	)

26 
	#¬’a_d®loc_Ïrge_junked_locked
 
	`JEMALLOC_N
(
¬’a_d®loc_Ïrge_junked_locked
)

	)

27 
	#¬’a_d®loc_sm®l
 
	`JEMALLOC_N
(
¬’a_d®loc_sm®l
)

	)

28 
	#¬’a_dss_´ec_g‘
 
	`JEMALLOC_N
(
¬’a_dss_´ec_g‘
)

	)

29 
	#¬’a_dss_´ec_£t
 
	`JEMALLOC_N
(
¬’a_dss_´ec_£t
)

	)

30 
	#¬’a_g‘
 
	`JEMALLOC_N
(
¬’a_g‘
)

	)

31 
	#¬’a_g‘_h¬d
 
	`JEMALLOC_N
(
¬’a_g‘_h¬d
)

	)

32 
	#¬’a_š™
 
	`JEMALLOC_N
(
¬’a_š™
)

	)

33 
	#¬’a_lg_dœty_muÉ_deçuÉ_g‘
 
	`JEMALLOC_N
(
¬’a_lg_dœty_muÉ_deçuÉ_g‘
)

	)

34 
	#¬’a_lg_dœty_muÉ_deçuÉ_£t
 
	`JEMALLOC_N
(
¬’a_lg_dœty_muÉ_deçuÉ_£t
)

	)

35 
	#¬’a_lg_dœty_muÉ_g‘
 
	`JEMALLOC_N
(
¬’a_lg_dœty_muÉ_g‘
)

	)

36 
	#¬’a_lg_dœty_muÉ_£t
 
	`JEMALLOC_N
(
¬’a_lg_dœty_muÉ_£t
)

	)

37 
	#¬’a_m®loc
 
	`JEMALLOC_N
(
¬’a_m®loc
)

	)

38 
	#¬’a_m®loc_Ïrge
 
	`JEMALLOC_N
(
¬’a_m®loc_Ïrge
)

	)

39 
	#¬’a_m®loc_sm®l
 
	`JEMALLOC_N
(
¬’a_m®loc_sm®l
)

	)

40 
	#¬’a_m­b™s_®loÿ‹d_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_®loÿ‹d_g‘
)

	)

41 
	#¬’a_m­b™s_bššd_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_bššd_g‘
)

	)

42 
	#¬’a_m­b™s_decomm™‹d_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_decomm™‹d_g‘
)

	)

43 
	#¬’a_m­b™s_dœty_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_dœty_g‘
)

	)

44 
	#¬’a_m­b™s_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_g‘
)

	)

45 
	#¬’a_m­b™s_š‹º®_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_š‹º®_£t
)

	)

46 
	#¬’a_m­b™s_Ïrge_bššd_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_Ïrge_bššd_£t
)

	)

47 
	#¬’a_m­b™s_Ïrge_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_Ïrge_g‘
)

	)

48 
	#¬’a_m­b™s_Ïrge_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_Ïrge_£t
)

	)

49 
	#¬’a_m­b™s_Ïrge_size_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_Ïrge_size_g‘
)

	)

50 
	#¬’a_m­b™¥_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™¥_g‘
)

	)

51 
	#¬’a_m­b™¥_»ad
 
	`JEMALLOC_N
(
¬’a_m­b™¥_»ad
)

	)

52 
	#¬’a_m­b™¥_wr™e
 
	`JEMALLOC_N
(
¬’a_m­b™¥_wr™e
)

	)

53 
	#¬’a_m­b™s_size_decode
 
	`JEMALLOC_N
(
¬’a_m­b™s_size_decode
)

	)

54 
	#¬’a_m­b™s_size_’code
 
	`JEMALLOC_N
(
¬’a_m­b™s_size_’code
)

	)

55 
	#¬’a_m­b™s_sm®l_runšd_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_sm®l_runšd_g‘
)

	)

56 
	#¬’a_m­b™s_sm®l_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_sm®l_£t
)

	)

57 
	#¬’a_m­b™s_uÇÎoÿ‹d_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_uÇÎoÿ‹d_£t
)

	)

58 
	#¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
)

	)

59 
	#¬’a_m­b™s_uÇÎoÿ‹d_size_£t
 
	`JEMALLOC_N
(
¬’a_m­b™s_uÇÎoÿ‹d_size_£t
)

	)

60 
	#¬’a_m­b™s_unz”Ûd_g‘
 
	`JEMALLOC_N
(
¬’a_m­b™s_unz”Ûd_g‘
)

	)

61 
	#¬’a_maxrun
 
	`JEMALLOC_N
(
¬’a_maxrun
)

	)

62 
	#¬’a_maybe_purge
 
	`JEMALLOC_N
(
¬’a_maybe_purge
)

	)

63 
	#¬’a_m‘ad©a_®loÿ‹d_add
 
	`JEMALLOC_N
(
¬’a_m‘ad©a_®loÿ‹d_add
)

	)

64 
	#¬’a_m‘ad©a_®loÿ‹d_g‘
 
	`JEMALLOC_N
(
¬’a_m‘ad©a_®loÿ‹d_g‘
)

	)

65 
	#¬’a_m‘ad©a_®loÿ‹d_sub
 
	`JEMALLOC_N
(
¬’a_m‘ad©a_®loÿ‹d_sub
)

	)

66 
	#¬’a_mig¿‹
 
	`JEMALLOC_N
(
¬’a_mig¿‹
)

	)

67 
	#¬’a_misûlm_g‘
 
	`JEMALLOC_N
(
¬’a_misûlm_g‘
)

	)

68 
	#¬’a_misûlm_to_·gešd
 
	`JEMALLOC_N
(
¬’a_misûlm_to_·gešd
)

	)

69 
	#¬’a_misûlm_to_½ages
 
	`JEMALLOC_N
(
¬’a_misûlm_to_½ages
)

	)

70 
	#¬’a_nbound
 
	`JEMALLOC_N
(
¬’a_nbound
)

	)

71 
	#¬’a_Ãw
 
	`JEMALLOC_N
(
¬’a_Ãw
)

	)

72 
	#¬’a_node_®loc
 
	`JEMALLOC_N
(
¬’a_node_®loc
)

	)

73 
	#¬’a_node_d®loc
 
	`JEMALLOC_N
(
¬’a_node_d®loc
)

	)

74 
	#¬’a_·Îoc
 
	`JEMALLOC_N
(
¬’a_·Îoc
)

	)

75 
	#¬’a_po¡fÜk_chd
 
	`JEMALLOC_N
(
¬’a_po¡fÜk_chd
)

	)

76 
	#¬’a_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
¬’a_po¡fÜk_·»Á
)

	)

77 
	#¬’a_´efÜk
 
	`JEMALLOC_N
(
¬’a_´efÜk
)

	)

78 
	#¬’a_´of_accum
 
	`JEMALLOC_N
(
¬’a_´of_accum
)

	)

79 
	#¬’a_´of_accum_im¶
 
	`JEMALLOC_N
(
¬’a_´of_accum_im¶
)

	)

80 
	#¬’a_´of_accum_locked
 
	`JEMALLOC_N
(
¬’a_´of_accum_locked
)

	)

81 
	#¬’a_´of_´omÙed
 
	`JEMALLOC_N
(
¬’a_´of_´omÙed
)

	)

82 
	#¬’a_´of_tùx_g‘
 
	`JEMALLOC_N
(
¬’a_´of_tùx_g‘
)

	)

83 
	#¬’a_´of_tùx_»£t
 
	`JEMALLOC_N
(
¬’a_´of_tùx_»£t
)

	)

84 
	#¬’a_´of_tùx_£t
 
	`JEMALLOC_N
(
¬’a_´of_tùx_£t
)

	)

85 
	#¬’a_±r_sm®l_bššd_g‘
 
	`JEMALLOC_N
(
¬’a_±r_sm®l_bššd_g‘
)

	)

86 
	#¬’a_purge_®l
 
	`JEMALLOC_N
(
¬’a_purge_®l
)

	)

87 
	#¬’a_qu¬ªtše_junk_sm®l
 
	`JEMALLOC_N
(
¬’a_qu¬ªtše_junk_sm®l
)

	)

88 
	#¬’a_¿Îoc
 
	`JEMALLOC_N
(
¬’a_¿Îoc
)

	)

89 
	#¬’a_¿Îoc_junk_Ïrge
 
	`JEMALLOC_N
(
¬’a_¿Îoc_junk_Ïrge
)

	)

90 
	#¬’a_¿Îoc_no_move
 
	`JEMALLOC_N
(
¬’a_¿Îoc_no_move
)

	)

91 
	#¬’a_rd_to_misûlm
 
	`JEMALLOC_N
(
¬’a_rd_to_misûlm
)

	)

92 
	#¬’a_»dzÚe_cÜru±iÚ
 
	`JEMALLOC_N
(
¬’a_»dzÚe_cÜru±iÚ
)

	)

93 
	#¬’a_run_»gšd
 
	`JEMALLOC_N
(
¬’a_run_»gšd
)

	)

94 
	#¬’a_run_to_misûlm
 
	`JEMALLOC_N
(
¬’a_run_to_misûlm
)

	)

95 
	#¬’a_§Îoc
 
	`JEMALLOC_N
(
¬’a_§Îoc
)

	)

96 
	#¬’as_ÿche_by·ss_ş—nup
 
	`JEMALLOC_N
(
¬’as_ÿche_by·ss_ş—nup
)

	)

97 
	#¬’as_ÿche_ş—nup
 
	`JEMALLOC_N
(
¬’as_ÿche_ş—nup
)

	)

98 
	#¬’a_sd®loc
 
	`JEMALLOC_N
(
¬’a_sd®loc
)

	)

99 
	#¬’a_¡©s_m”ge
 
	`JEMALLOC_N
(
¬’a_¡©s_m”ge
)

	)

100 
	#¬’a_tÿche_fl_sm®l
 
	`JEMALLOC_N
(
¬’a_tÿche_fl_sm®l
)

	)

101 
	#©omic_add_p
 
	`JEMALLOC_N
(
©omic_add_p
)

	)

102 
	#©omic_add_u
 
	`JEMALLOC_N
(
©omic_add_u
)

	)

103 
	#©omic_add_ušt32
 
	`JEMALLOC_N
(
©omic_add_ušt32
)

	)

104 
	#©omic_add_ušt64
 
	`JEMALLOC_N
(
©omic_add_ušt64
)

	)

105 
	#©omic_add_z
 
	`JEMALLOC_N
(
©omic_add_z
)

	)

106 
	#©omic_ÿs_p
 
	`JEMALLOC_N
(
©omic_ÿs_p
)

	)

107 
	#©omic_ÿs_u
 
	`JEMALLOC_N
(
©omic_ÿs_u
)

	)

108 
	#©omic_ÿs_ušt32
 
	`JEMALLOC_N
(
©omic_ÿs_ušt32
)

	)

109 
	#©omic_ÿs_ušt64
 
	`JEMALLOC_N
(
©omic_ÿs_ušt64
)

	)

110 
	#©omic_ÿs_z
 
	`JEMALLOC_N
(
©omic_ÿs_z
)

	)

111 
	#©omic_sub_p
 
	`JEMALLOC_N
(
©omic_sub_p
)

	)

112 
	#©omic_sub_u
 
	`JEMALLOC_N
(
©omic_sub_u
)

	)

113 
	#©omic_sub_ušt32
 
	`JEMALLOC_N
(
©omic_sub_ušt32
)

	)

114 
	#©omic_sub_ušt64
 
	`JEMALLOC_N
(
©omic_sub_ušt64
)

	)

115 
	#©omic_sub_z
 
	`JEMALLOC_N
(
©omic_sub_z
)

	)

116 
	#ba£_®loc
 
	`JEMALLOC_N
(
ba£_®loc
)

	)

117 
	#ba£_boÙ
 
	`JEMALLOC_N
(
ba£_boÙ
)

	)

118 
	#ba£_po¡fÜk_chd
 
	`JEMALLOC_N
(
ba£_po¡fÜk_chd
)

	)

119 
	#ba£_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
ba£_po¡fÜk_·»Á
)

	)

120 
	#ba£_´efÜk
 
	`JEMALLOC_N
(
ba£_´efÜk
)

	)

121 
	#ba£_¡©s_g‘
 
	`JEMALLOC_N
(
ba£_¡©s_g‘
)

	)

122 
	#b™m­_fuÎ
 
	`JEMALLOC_N
(
b™m­_fuÎ
)

	)

123 
	#b™m­_g‘
 
	`JEMALLOC_N
(
b™m­_g‘
)

	)

124 
	#b™m­_šfo_š™
 
	`JEMALLOC_N
(
b™m­_šfo_š™
)

	)

125 
	#b™m­_šfo_ngroups
 
	`JEMALLOC_N
(
b™m­_šfo_ngroups
)

	)

126 
	#b™m­_š™
 
	`JEMALLOC_N
(
b™m­_š™
)

	)

127 
	#b™m­_£t
 
	`JEMALLOC_N
(
b™m­_£t
)

	)

128 
	#b™m­_sfu
 
	`JEMALLOC_N
(
b™m­_sfu
)

	)

129 
	#b™m­_size
 
	`JEMALLOC_N
(
b™m­_size
)

	)

130 
	#b™m­_un£t
 
	`JEMALLOC_N
(
b™m­_un£t
)

	)

131 
	#boÙ¡¿p_ÿÎoc
 
	`JEMALLOC_N
(
boÙ¡¿p_ÿÎoc
)

	)

132 
	#boÙ¡¿p_ä“
 
	`JEMALLOC_N
(
boÙ¡¿p_ä“
)

	)

133 
	#boÙ¡¿p_m®loc
 
	`JEMALLOC_N
(
boÙ¡¿p_m®loc
)

	)

134 
	#bt_š™
 
	`JEMALLOC_N
(
bt_š™
)

	)

135 
	#buã¼Ü
 
	`JEMALLOC_N
(
buã¼Ü
)

	)

136 
	#chunk_®loc_ba£
 
	`JEMALLOC_N
(
chunk_®loc_ba£
)

	)

137 
	#chunk_®loc_ÿche
 
	`JEMALLOC_N
(
chunk_®loc_ÿche
)

	)

138 
	#chunk_®loc_dss
 
	`JEMALLOC_N
(
chunk_®loc_dss
)

	)

139 
	#chunk_®loc_mm­
 
	`JEMALLOC_N
(
chunk_®loc_mm­
)

	)

140 
	#chunk_®loc_w¿µ”
 
	`JEMALLOC_N
(
chunk_®loc_w¿µ”
)

	)

141 
	#chunk_boÙ
 
	`JEMALLOC_N
(
chunk_boÙ
)

	)

142 
	#chunk_d®loc_¬’a
 
	`JEMALLOC_N
(
chunk_d®loc_¬’a
)

	)

143 
	#chunk_d®loc_ÿche
 
	`JEMALLOC_N
(
chunk_d®loc_ÿche
)

	)

144 
	#chunk_d®loc_mm­
 
	`JEMALLOC_N
(
chunk_d®loc_mm­
)

	)

145 
	#chunk_d®loc_w¿µ”
 
	`JEMALLOC_N
(
chunk_d®loc_w¿µ”
)

	)

146 
	#chunk_d”egi¡”
 
	`JEMALLOC_N
(
chunk_d”egi¡”
)

	)

147 
	#chunk_dss_boÙ
 
	`JEMALLOC_N
(
chunk_dss_boÙ
)

	)

148 
	#chunk_dss_po¡fÜk_chd
 
	`JEMALLOC_N
(
chunk_dss_po¡fÜk_chd
)

	)

149 
	#chunk_dss_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
chunk_dss_po¡fÜk_·»Á
)

	)

150 
	#chunk_dss_´ec_g‘
 
	`JEMALLOC_N
(
chunk_dss_´ec_g‘
)

	)

151 
	#chunk_dss_´ec_£t
 
	`JEMALLOC_N
(
chunk_dss_´ec_£t
)

	)

152 
	#chunk_dss_´efÜk
 
	`JEMALLOC_N
(
chunk_dss_´efÜk
)

	)

153 
	#chunk_hooks_deçuÉ
 
	`JEMALLOC_N
(
chunk_hooks_deçuÉ
)

	)

154 
	#chunk_hooks_g‘
 
	`JEMALLOC_N
(
chunk_hooks_g‘
)

	)

155 
	#chunk_hooks_£t
 
	`JEMALLOC_N
(
chunk_hooks_£t
)

	)

156 
	#chunk_š_dss
 
	`JEMALLOC_N
(
chunk_š_dss
)

	)

157 
	#chunk_lookup
 
	`JEMALLOC_N
(
chunk_lookup
)

	)

158 
	#chunk_Åages
 
	`JEMALLOC_N
(
chunk_Åages
)

	)

159 
	#chunk_po¡fÜk_chd
 
	`JEMALLOC_N
(
chunk_po¡fÜk_chd
)

	)

160 
	#chunk_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
chunk_po¡fÜk_·»Á
)

	)

161 
	#chunk_´efÜk
 
	`JEMALLOC_N
(
chunk_´efÜk
)

	)

162 
	#chunk_purge_¬’a
 
	`JEMALLOC_N
(
chunk_purge_¬’a
)

	)

163 
	#chunk_purge_w¿µ”
 
	`JEMALLOC_N
(
chunk_purge_w¿µ”
)

	)

164 
	#chunk_»gi¡”
 
	`JEMALLOC_N
(
chunk_»gi¡”
)

	)

165 
	#chunksize
 
	`JEMALLOC_N
(
chunksize
)

	)

166 
	#chunksize_mask
 
	`JEMALLOC_N
(
chunksize_mask
)

	)

167 
	#chunks_¹»e
 
	`JEMALLOC_N
(
chunks_¹»e
)

	)

168 
	#ckh_couÁ
 
	`JEMALLOC_N
(
ckh_couÁ
)

	)

169 
	#ckh_d–‘e
 
	`JEMALLOC_N
(
ckh_d–‘e
)

	)

170 
	#ckh_š£¹
 
	`JEMALLOC_N
(
ckh_š£¹
)

	)

171 
	#ckh_™”
 
	`JEMALLOC_N
(
ckh_™”
)

	)

172 
	#ckh_Ãw
 
	`JEMALLOC_N
(
ckh_Ãw
)

	)

173 
	#ckh_poš‹r_hash
 
	`JEMALLOC_N
(
ckh_poš‹r_hash
)

	)

174 
	#ckh_poš‹r_keycomp
 
	`JEMALLOC_N
(
ckh_poš‹r_keycomp
)

	)

175 
	#ckh_»move
 
	`JEMALLOC_N
(
ckh_»move
)

	)

176 
	#ckh_£¬ch
 
	`JEMALLOC_N
(
ckh_£¬ch
)

	)

177 
	#ckh_¡ršg_hash
 
	`JEMALLOC_N
(
ckh_¡ršg_hash
)

	)

178 
	#ckh_¡ršg_keycomp
 
	`JEMALLOC_N
(
ckh_¡ršg_keycomp
)

	)

179 
	#ùl_boÙ
 
	`JEMALLOC_N
(
ùl_boÙ
)

	)

180 
	#ùl_bymib
 
	`JEMALLOC_N
(
ùl_bymib
)

	)

181 
	#ùl_byÇme
 
	`JEMALLOC_N
(
ùl_byÇme
)

	)

182 
	#ùl_Çm‘omib
 
	`JEMALLOC_N
(
ùl_Çm‘omib
)

	)

183 
	#ùl_po¡fÜk_chd
 
	`JEMALLOC_N
(
ùl_po¡fÜk_chd
)

	)

184 
	#ùl_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
ùl_po¡fÜk_·»Á
)

	)

185 
	#ùl_´efÜk
 
	`JEMALLOC_N
(
ùl_´efÜk
)

	)

186 
	#dss_´ec_Çmes
 
	`JEMALLOC_N
(
dss_´ec_Çmes
)

	)

187 
	#ex‹Á_node_achunk_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_achunk_g‘
)

	)

188 
	#ex‹Á_node_achunk_£t
 
	`JEMALLOC_N
(
ex‹Á_node_achunk_£t
)

	)

189 
	#ex‹Á_node_addr_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_addr_g‘
)

	)

190 
	#ex‹Á_node_addr_£t
 
	`JEMALLOC_N
(
ex‹Á_node_addr_£t
)

	)

191 
	#ex‹Á_node_¬’a_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_¬’a_g‘
)

	)

192 
	#ex‹Á_node_¬’a_£t
 
	`JEMALLOC_N
(
ex‹Á_node_¬’a_£t
)

	)

193 
	#ex‹Á_node_dœty_š£¹
 
	`JEMALLOC_N
(
ex‹Á_node_dœty_š£¹
)

	)

194 
	#ex‹Á_node_dœty_lškage_š™
 
	`JEMALLOC_N
(
ex‹Á_node_dœty_lškage_š™
)

	)

195 
	#ex‹Á_node_dœty_»move
 
	`JEMALLOC_N
(
ex‹Á_node_dœty_»move
)

	)

196 
	#ex‹Á_node_š™
 
	`JEMALLOC_N
(
ex‹Á_node_š™
)

	)

197 
	#ex‹Á_node_´of_tùx_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_´of_tùx_g‘
)

	)

198 
	#ex‹Á_node_´of_tùx_£t
 
	`JEMALLOC_N
(
ex‹Á_node_´of_tùx_£t
)

	)

199 
	#ex‹Á_node_size_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_size_g‘
)

	)

200 
	#ex‹Á_node_size_£t
 
	`JEMALLOC_N
(
ex‹Á_node_size_£t
)

	)

201 
	#ex‹Á_node_z”Ûd_g‘
 
	`JEMALLOC_N
(
ex‹Á_node_z”Ûd_g‘
)

	)

202 
	#ex‹Á_node_z”Ûd_£t
 
	`JEMALLOC_N
(
ex‹Á_node_z”Ûd_£t
)

	)

203 
	#ex‹Á_Œ“_ad_em±y
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_em±y
)

	)

204 
	#ex‹Á_Œ“_ad_fœ¡
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_fœ¡
)

	)

205 
	#ex‹Á_Œ“_ad_š£¹
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_š£¹
)

	)

206 
	#ex‹Á_Œ“_ad_™”
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_™”
)

	)

207 
	#ex‹Á_Œ“_ad_™”_»cur£
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_™”_»cur£
)

	)

208 
	#ex‹Á_Œ“_ad_™”_¡¬t
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_™”_¡¬t
)

	)

209 
	#ex‹Á_Œ“_ad_Ï¡
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_Ï¡
)

	)

210 
	#ex‹Á_Œ“_ad_Ãw
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_Ãw
)

	)

211 
	#ex‹Á_Œ“_ad_Ãxt
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_Ãxt
)

	)

212 
	#ex‹Á_Œ“_ad_n£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_n£¬ch
)

	)

213 
	#ex‹Á_Œ“_ad_´ev
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_´ev
)

	)

214 
	#ex‹Á_Œ“_ad_p£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_p£¬ch
)

	)

215 
	#ex‹Á_Œ“_ad_»move
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_»move
)

	)

216 
	#ex‹Á_Œ“_ad_»v”£_™”
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_»v”£_™”
)

	)

217 
	#ex‹Á_Œ“_ad_»v”£_™”_»cur£
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_»v”£_™”_»cur£
)

	)

218 
	#ex‹Á_Œ“_ad_»v”£_™”_¡¬t
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_»v”£_™”_¡¬t
)

	)

219 
	#ex‹Á_Œ“_ad_£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_ad_£¬ch
)

	)

220 
	#ex‹Á_Œ“_szad_em±y
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_em±y
)

	)

221 
	#ex‹Á_Œ“_szad_fœ¡
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_fœ¡
)

	)

222 
	#ex‹Á_Œ“_szad_š£¹
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_š£¹
)

	)

223 
	#ex‹Á_Œ“_szad_™”
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_™”
)

	)

224 
	#ex‹Á_Œ“_szad_™”_»cur£
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_™”_»cur£
)

	)

225 
	#ex‹Á_Œ“_szad_™”_¡¬t
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_™”_¡¬t
)

	)

226 
	#ex‹Á_Œ“_szad_Ï¡
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_Ï¡
)

	)

227 
	#ex‹Á_Œ“_szad_Ãw
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_Ãw
)

	)

228 
	#ex‹Á_Œ“_szad_Ãxt
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_Ãxt
)

	)

229 
	#ex‹Á_Œ“_szad_n£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_n£¬ch
)

	)

230 
	#ex‹Á_Œ“_szad_´ev
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_´ev
)

	)

231 
	#ex‹Á_Œ“_szad_p£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_p£¬ch
)

	)

232 
	#ex‹Á_Œ“_szad_»move
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_»move
)

	)

233 
	#ex‹Á_Œ“_szad_»v”£_™”
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_»v”£_™”
)

	)

234 
	#ex‹Á_Œ“_szad_»v”£_™”_»cur£
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_»v”£_™”_»cur£
)

	)

235 
	#ex‹Á_Œ“_szad_»v”£_™”_¡¬t
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_»v”£_™”_¡¬t
)

	)

236 
	#ex‹Á_Œ“_szad_£¬ch
 
	`JEMALLOC_N
(
ex‹Á_Œ“_szad_£¬ch
)

	)

237 
	#g‘_”ºo
 
	`JEMALLOC_N
(
g‘_”ºo
)

	)

238 
	#hash
 
	`JEMALLOC_N
(
hash
)

	)

239 
	#hash_fmix_32
 
	`JEMALLOC_N
(
hash_fmix_32
)

	)

240 
	#hash_fmix_64
 
	`JEMALLOC_N
(
hash_fmix_64
)

	)

241 
	#hash_g‘_block_32
 
	`JEMALLOC_N
(
hash_g‘_block_32
)

	)

242 
	#hash_g‘_block_64
 
	`JEMALLOC_N
(
hash_g‘_block_64
)

	)

243 
	#hash_rÙl_32
 
	`JEMALLOC_N
(
hash_rÙl_32
)

	)

244 
	#hash_rÙl_64
 
	`JEMALLOC_N
(
hash_rÙl_64
)

	)

245 
	#hash_x64_128
 
	`JEMALLOC_N
(
hash_x64_128
)

	)

246 
	#hash_x86_128
 
	`JEMALLOC_N
(
hash_x86_128
)

	)

247 
	#hash_x86_32
 
	`JEMALLOC_N
(
hash_x86_32
)

	)

248 
	#huge_¯Îoc
 
	`JEMALLOC_N
(
huge_¯Îoc
)

	)

249 
	#huge_d®loc
 
	`JEMALLOC_N
(
huge_d®loc
)

	)

250 
	#huge_d®loc_junk
 
	`JEMALLOC_N
(
huge_d®loc_junk
)

	)

251 
	#huge_m®loc
 
	`JEMALLOC_N
(
huge_m®loc
)

	)

252 
	#huge_·Îoc
 
	`JEMALLOC_N
(
huge_·Îoc
)

	)

253 
	#huge_´of_tùx_g‘
 
	`JEMALLOC_N
(
huge_´of_tùx_g‘
)

	)

254 
	#huge_´of_tùx_»£t
 
	`JEMALLOC_N
(
huge_´of_tùx_»£t
)

	)

255 
	#huge_´of_tùx_£t
 
	`JEMALLOC_N
(
huge_´of_tùx_£t
)

	)

256 
	#huge_¿Îoc
 
	`JEMALLOC_N
(
huge_¿Îoc
)

	)

257 
	#huge_¿Îoc_no_move
 
	`JEMALLOC_N
(
huge_¿Îoc_no_move
)

	)

258 
	#huge_§Îoc
 
	`JEMALLOC_N
(
huge_§Îoc
)

	)

259 
	#Ÿ®loc
 
	`JEMALLOC_N
(
Ÿ®loc
)

	)

260 
	#ŸÎocztm
 
	`JEMALLOC_N
(
ŸÎocztm
)

	)

261 
	#iÿÎoc
 
	`JEMALLOC_N
(
iÿÎoc
)

	)

262 
	#iÿÎoù
 
	`JEMALLOC_N
(
iÿÎoù
)

	)

263 
	#id®loc
 
	`JEMALLOC_N
(
id®loc
)

	)

264 
	#id®loù
 
	`JEMALLOC_N
(
id®loù
)

	)

265 
	#id®loùm
 
	`JEMALLOC_N
(
id®loùm
)

	)

266 
	#im®loc
 
	`JEMALLOC_N
(
im®loc
)

	)

267 
	#im®loù
 
	`JEMALLOC_N
(
im®loù
)

	)

268 
	#šdex2size
 
	`JEMALLOC_N
(
šdex2size
)

	)

269 
	#šdex2size_compu‹
 
	`JEMALLOC_N
(
šdex2size_compu‹
)

	)

270 
	#šdex2size_lookup
 
	`JEMALLOC_N
(
šdex2size_lookup
)

	)

271 
	#šdex2size_b
 
	`JEMALLOC_N
(
šdex2size_b
)

	)

272 
	#š_v®gršd
 
	`JEMALLOC_N
(
š_v®gršd
)

	)

273 
	#®loc
 
	`JEMALLOC_N
(
®loc
)

	)

274 
	#®loù
 
	`JEMALLOC_N
(
®loù
)

	)

275 
	#®locztm
 
	`JEMALLOC_N
(
®locztm
)

	)

276 
	#iq®loc
 
	`JEMALLOC_N
(
iq®loc
)

	)

277 
	#œ®loc
 
	`JEMALLOC_N
(
œ®loc
)

	)

278 
	#œ®loù
 
	`JEMALLOC_N
(
œ®loù
)

	)

279 
	#œ®loù_»®ign
 
	`JEMALLOC_N
(
œ®loù_»®ign
)

	)

280 
	#i§Îoc
 
	`JEMALLOC_N
(
i§Îoc
)

	)

281 
	#isd®loù
 
	`JEMALLOC_N
(
isd®loù
)

	)

282 
	#isq®loc
 
	`JEMALLOC_N
(
isq®loc
)

	)

283 
	#i¡h»aded
 
	`JEMALLOC_N
(
i¡h»aded
)

	)

284 
	#iv§Îoc
 
	`JEMALLOC_N
(
iv§Îoc
)

	)

285 
	#ix®loc
 
	`JEMALLOC_N
(
ix®loc
)

	)

286 
	#jem®loc_po¡fÜk_chd
 
	`JEMALLOC_N
(
jem®loc_po¡fÜk_chd
)

	)

287 
	#jem®loc_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
jem®loc_po¡fÜk_·»Á
)

	)

288 
	#jem®loc_´efÜk
 
	`JEMALLOC_N
(
jem®loc_´efÜk
)

	)

289 
	#Ïrge_maxşass
 
	`JEMALLOC_N
(
Ïrge_maxşass
)

	)

290 
	#lg_æoÜ
 
	`JEMALLOC_N
(
lg_æoÜ
)

	)

291 
	#m®loc_ırštf
 
	`JEMALLOC_N
(
m®loc_ırštf
)

	)

292 
	#m®loc_mu‹x_š™
 
	`JEMALLOC_N
(
m®loc_mu‹x_š™
)

	)

293 
	#m®loc_mu‹x_lock
 
	`JEMALLOC_N
(
m®loc_mu‹x_lock
)

	)

294 
	#m®loc_mu‹x_po¡fÜk_chd
 
	`JEMALLOC_N
(
m®loc_mu‹x_po¡fÜk_chd
)

	)

295 
	#m®loc_mu‹x_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
m®loc_mu‹x_po¡fÜk_·»Á
)

	)

296 
	#m®loc_mu‹x_´efÜk
 
	`JEMALLOC_N
(
m®loc_mu‹x_´efÜk
)

	)

297 
	#m®loc_mu‹x_uÆock
 
	`JEMALLOC_N
(
m®loc_mu‹x_uÆock
)

	)

298 
	#m®loc_´štf
 
	`JEMALLOC_N
(
m®loc_´štf
)

	)

299 
	#m®loc_¢´štf
 
	`JEMALLOC_N
(
m®loc_¢´štf
)

	)

300 
	#m®loc_¡¹oumax
 
	`JEMALLOC_N
(
m®loc_¡¹oumax
)

	)

301 
	#m®loc_tsd_boÙ0
 
	`JEMALLOC_N
(
m®loc_tsd_boÙ0
)

	)

302 
	#m®loc_tsd_boÙ1
 
	`JEMALLOC_N
(
m®loc_tsd_boÙ1
)

	)

303 
	#m®loc_tsd_ş—nup_»gi¡”
 
	`JEMALLOC_N
(
m®loc_tsd_ş—nup_»gi¡”
)

	)

304 
	#m®loc_tsd_d®loc
 
	`JEMALLOC_N
(
m®loc_tsd_d®loc
)

	)

305 
	#m®loc_tsd_m®loc
 
	`JEMALLOC_N
(
m®loc_tsd_m®loc
)

	)

306 
	#m®loc_tsd_no_ş—nup
 
	`JEMALLOC_N
(
m®loc_tsd_no_ş—nup
)

	)

307 
	#m®loc_vırštf
 
	`JEMALLOC_N
(
m®loc_vırštf
)

	)

308 
	#m®loc_v¢´štf
 
	`JEMALLOC_N
(
m®loc_v¢´štf
)

	)

309 
	#m®loc_wr™e
 
	`JEMALLOC_N
(
m®loc_wr™e
)

	)

310 
	#m­_bŸs
 
	`JEMALLOC_N
(
m­_bŸs
)

	)

311 
	#m­_misc_off£t
 
	`JEMALLOC_N
(
m­_misc_off£t
)

	)

312 
	#mb_wr™e
 
	`JEMALLOC_N
(
mb_wr™e
)

	)

313 
	#mu‹x_boÙ
 
	`JEMALLOC_N
(
mu‹x_boÙ
)

	)

314 
	#Ç»Çs_ÿche_ş—nup
 
	`JEMALLOC_N
(
Ç»Çs_ÿche_ş—nup
)

	)

315 
	#Ç»Çs_tÙ®_g‘
 
	`JEMALLOC_N
(
Ç»Çs_tÙ®_g‘
)

	)

316 
	#nıus
 
	`JEMALLOC_N
(
nıus
)

	)

317 
	#nhbšs
 
	`JEMALLOC_N
(
nhbšs
)

	)

318 
	#İt_abÜt
 
	`JEMALLOC_N
(
İt_abÜt
)

	)

319 
	#İt_dss
 
	`JEMALLOC_N
(
İt_dss
)

	)

320 
	#İt_junk
 
	`JEMALLOC_N
(
İt_junk
)

	)

321 
	#İt_junk_®loc
 
	`JEMALLOC_N
(
İt_junk_®loc
)

	)

322 
	#İt_junk_ä“
 
	`JEMALLOC_N
(
İt_junk_ä“
)

	)

323 
	#İt_lg_chunk
 
	`JEMALLOC_N
(
İt_lg_chunk
)

	)

324 
	#İt_lg_dœty_muÉ
 
	`JEMALLOC_N
(
İt_lg_dœty_muÉ
)

	)

325 
	#İt_lg_´of_š‹rv®
 
	`JEMALLOC_N
(
İt_lg_´of_š‹rv®
)

	)

326 
	#İt_lg_´of_§m¶e
 
	`JEMALLOC_N
(
İt_lg_´of_§m¶e
)

	)

327 
	#İt_lg_tÿche_max
 
	`JEMALLOC_N
(
İt_lg_tÿche_max
)

	)

328 
	#İt_Ç»Çs
 
	`JEMALLOC_N
(
İt_Ç»Çs
)

	)

329 
	#İt_´of
 
	`JEMALLOC_N
(
İt_´of
)

	)

330 
	#İt_´of_accum
 
	`JEMALLOC_N
(
İt_´of_accum
)

	)

331 
	#İt_´of_aùive
 
	`JEMALLOC_N
(
İt_´of_aùive
)

	)

332 
	#İt_´of_fš®
 
	`JEMALLOC_N
(
İt_´of_fš®
)

	)

333 
	#İt_´of_gdump
 
	`JEMALLOC_N
(
İt_´of_gdump
)

	)

334 
	#İt_´of_Ëak
 
	`JEMALLOC_N
(
İt_´of_Ëak
)

	)

335 
	#İt_´of_´efix
 
	`JEMALLOC_N
(
İt_´of_´efix
)

	)

336 
	#İt_´of_th»ad_aùive_š™
 
	`JEMALLOC_N
(
İt_´of_th»ad_aùive_š™
)

	)

337 
	#İt_qu¬ªtše
 
	`JEMALLOC_N
(
İt_qu¬ªtše
)

	)

338 
	#İt_»dzÚe
 
	`JEMALLOC_N
(
İt_»dzÚe
)

	)

339 
	#İt_¡©s_´št
 
	`JEMALLOC_N
(
İt_¡©s_´št
)

	)

340 
	#İt_tÿche
 
	`JEMALLOC_N
(
İt_tÿche
)

	)

341 
	#İt_uŒaû
 
	`JEMALLOC_N
(
İt_uŒaû
)

	)

342 
	#İt_xm®loc
 
	`JEMALLOC_N
(
İt_xm®loc
)

	)

343 
	#İt_z”o
 
	`JEMALLOC_N
(
İt_z”o
)

	)

344 
	#p2rz
 
	`JEMALLOC_N
(
p2rz
)

	)

345 
	#·ges_comm™
 
	`JEMALLOC_N
(
·ges_comm™
)

	)

346 
	#·ges_decomm™
 
	`JEMALLOC_N
(
·ges_decomm™
)

	)

347 
	#·ges_m­
 
	`JEMALLOC_N
(
·ges_m­
)

	)

348 
	#·ges_purge
 
	`JEMALLOC_N
(
·ges_purge
)

	)

349 
	#·ges_Œim
 
	`JEMALLOC_N
(
·ges_Œim
)

	)

350 
	#·ges_unm­
 
	`JEMALLOC_N
(
·ges_unm­
)

	)

351 
	#pow2_û
 
	`JEMALLOC_N
(
pow2_û
)

	)

352 
	#´of_aùive_g‘
 
	`JEMALLOC_N
(
´of_aùive_g‘
)

	)

353 
	#´of_aùive_g‘_uÆocked
 
	`JEMALLOC_N
(
´of_aùive_g‘_uÆocked
)

	)

354 
	#´of_aùive_£t
 
	`JEMALLOC_N
(
´of_aùive_£t
)

	)

355 
	#´of_®loc_´•
 
	`JEMALLOC_N
(
´of_®loc_´•
)

	)

356 
	#´of_®loc_rŞlback
 
	`JEMALLOC_N
(
´of_®loc_rŞlback
)

	)

357 
	#´of_backŒaû
 
	`JEMALLOC_N
(
´of_backŒaû
)

	)

358 
	#´of_boÙ0
 
	`JEMALLOC_N
(
´of_boÙ0
)

	)

359 
	#´of_boÙ1
 
	`JEMALLOC_N
(
´of_boÙ1
)

	)

360 
	#´of_boÙ2
 
	`JEMALLOC_N
(
´of_boÙ2
)

	)

361 
	#´of_dump_h—d”
 
	`JEMALLOC_N
(
´of_dump_h—d”
)

	)

362 
	#´of_dump_İ’
 
	`JEMALLOC_N
(
´of_dump_İ’
)

	)

363 
	#´of_ä“
 
	`JEMALLOC_N
(
´of_ä“
)

	)

364 
	#´of_ä“_§m¶ed_objeù
 
	`JEMALLOC_N
(
´of_ä“_§m¶ed_objeù
)

	)

365 
	#´of_gdump
 
	`JEMALLOC_N
(
´of_gdump
)

	)

366 
	#´of_gdump_g‘
 
	`JEMALLOC_N
(
´of_gdump_g‘
)

	)

367 
	#´of_gdump_g‘_uÆocked
 
	`JEMALLOC_N
(
´of_gdump_g‘_uÆocked
)

	)

368 
	#´of_gdump_£t
 
	`JEMALLOC_N
(
´of_gdump_£t
)

	)

369 
	#´of_gdump_v®
 
	`JEMALLOC_N
(
´of_gdump_v®
)

	)

370 
	#´of_idump
 
	`JEMALLOC_N
(
´of_idump
)

	)

371 
	#´of_š‹rv®
 
	`JEMALLOC_N
(
´of_š‹rv®
)

	)

372 
	#´of_lookup
 
	`JEMALLOC_N
(
´of_lookup
)

	)

373 
	#´of_m®loc
 
	`JEMALLOC_N
(
´of_m®loc
)

	)

374 
	#´of_m®loc_§m¶e_objeù
 
	`JEMALLOC_N
(
´of_m®loc_§m¶e_objeù
)

	)

375 
	#´of_mdump
 
	`JEMALLOC_N
(
´of_mdump
)

	)

376 
	#´of_po¡fÜk_chd
 
	`JEMALLOC_N
(
´of_po¡fÜk_chd
)

	)

377 
	#´of_po¡fÜk_·»Á
 
	`JEMALLOC_N
(
´of_po¡fÜk_·»Á
)

	)

378 
	#´of_´efÜk
 
	`JEMALLOC_N
(
´of_´efÜk
)

	)

379 
	#´of_»®loc
 
	`JEMALLOC_N
(
´of_»®loc
)

	)

380 
	#´of_»£t
 
	`JEMALLOC_N
(
´of_»£t
)

	)

381 
	#´of_§m¶e_accum_upd©e
 
	`JEMALLOC_N
(
´of_§m¶e_accum_upd©e
)

	)

382 
	#´of_§m¶e_th»shŞd_upd©e
 
	`JEMALLOC_N
(
´of_§m¶e_th»shŞd_upd©e
)

	)

383 
	#´of_tùx_g‘
 
	`JEMALLOC_N
(
´of_tùx_g‘
)

	)

384 
	#´of_tùx_»£t
 
	`JEMALLOC_N
(
´of_tùx_»£t
)

	)

385 
	#´of_tùx_£t
 
	`JEMALLOC_N
(
´of_tùx_£t
)

	)

386 
	#´of_td©a_ş—nup
 
	`JEMALLOC_N
(
´of_td©a_ş—nup
)

	)

387 
	#´of_td©a_g‘
 
	`JEMALLOC_N
(
´of_td©a_g‘
)

	)

388 
	#´of_td©a_š™
 
	`JEMALLOC_N
(
´of_td©a_š™
)

	)

389 
	#´of_td©a_»š™
 
	`JEMALLOC_N
(
´of_td©a_»š™
)

	)

390 
	#´of_th»ad_aùive_g‘
 
	`JEMALLOC_N
(
´of_th»ad_aùive_g‘
)

	)

391 
	#´of_th»ad_aùive_š™_g‘
 
	`JEMALLOC_N
(
´of_th»ad_aùive_š™_g‘
)

	)

392 
	#´of_th»ad_aùive_š™_£t
 
	`JEMALLOC_N
(
´of_th»ad_aùive_š™_£t
)

	)

393 
	#´of_th»ad_aùive_£t
 
	`JEMALLOC_N
(
´of_th»ad_aùive_£t
)

	)

394 
	#´of_th»ad_Çme_g‘
 
	`JEMALLOC_N
(
´of_th»ad_Çme_g‘
)

	)

395 
	#´of_th»ad_Çme_£t
 
	`JEMALLOC_N
(
´of_th»ad_Çme_£t
)

	)

396 
	#qu¬ªtše
 
	`JEMALLOC_N
(
qu¬ªtše
)

	)

397 
	#qu¬ªtše_®loc_hook
 
	`JEMALLOC_N
(
qu¬ªtše_®loc_hook
)

	)

398 
	#qu¬ªtše_®loc_hook_wÜk
 
	`JEMALLOC_N
(
qu¬ªtše_®loc_hook_wÜk
)

	)

399 
	#qu¬ªtše_ş—nup
 
	`JEMALLOC_N
(
qu¬ªtše_ş—nup
)

	)

400 
	#»gi¡”_zÚe
 
	`JEMALLOC_N
(
»gi¡”_zÚe
)

	)

401 
	#¹»e_chd_»ad
 
	`JEMALLOC_N
(
¹»e_chd_»ad
)

	)

402 
	#¹»e_chd_»ad_h¬d
 
	`JEMALLOC_N
(
¹»e_chd_»ad_h¬d
)

	)

403 
	#¹»e_chd_Œy»ad
 
	`JEMALLOC_N
(
¹»e_chd_Œy»ad
)

	)

404 
	#¹»e_d–‘e
 
	`JEMALLOC_N
(
¹»e_d–‘e
)

	)

405 
	#¹»e_g‘
 
	`JEMALLOC_N
(
¹»e_g‘
)

	)

406 
	#¹»e_Ãw
 
	`JEMALLOC_N
(
¹»e_Ãw
)

	)

407 
	#¹»e_node_v®id
 
	`JEMALLOC_N
(
¹»e_node_v®id
)

	)

408 
	#¹»e_£t
 
	`JEMALLOC_N
(
¹»e_£t
)

	)

409 
	#¹»e_¡¬t_Ëv–
 
	`JEMALLOC_N
(
¹»e_¡¬t_Ëv–
)

	)

410 
	#¹»e_subkey
 
	`JEMALLOC_N
(
¹»e_subkey
)

	)

411 
	#¹»e_subŒ“_»ad
 
	`JEMALLOC_N
(
¹»e_subŒ“_»ad
)

	)

412 
	#¹»e_subŒ“_»ad_h¬d
 
	`JEMALLOC_N
(
¹»e_subŒ“_»ad_h¬d
)

	)

413 
	#¹»e_subŒ“_Œy»ad
 
	`JEMALLOC_N
(
¹»e_subŒ“_Œy»ad
)

	)

414 
	#¹»e_v®_»ad
 
	`JEMALLOC_N
(
¹»e_v®_»ad
)

	)

415 
	#¹»e_v®_wr™e
 
	`JEMALLOC_N
(
¹»e_v®_wr™e
)

	)

416 
	#s2u
 
	`JEMALLOC_N
(
s2u
)

	)

417 
	#s2u_compu‹
 
	`JEMALLOC_N
(
s2u_compu‹
)

	)

418 
	#s2u_lookup
 
	`JEMALLOC_N
(
s2u_lookup
)

	)

419 
	#§2u
 
	`JEMALLOC_N
(
§2u
)

	)

420 
	#£t_”ºo
 
	`JEMALLOC_N
(
£t_”ºo
)

	)

421 
	#size2šdex
 
	`JEMALLOC_N
(
size2šdex
)

	)

422 
	#size2šdex_compu‹
 
	`JEMALLOC_N
(
size2šdex_compu‹
)

	)

423 
	#size2šdex_lookup
 
	`JEMALLOC_N
(
size2šdex_lookup
)

	)

424 
	#size2šdex_b
 
	`JEMALLOC_N
(
size2šdex_b
)

	)

425 
	#¡©s_ÿùive
 
	`JEMALLOC_N
(
¡©s_ÿùive
)

	)

426 
	#¡©s_ÿùive_add
 
	`JEMALLOC_N
(
¡©s_ÿùive_add
)

	)

427 
	#¡©s_ÿùive_g‘
 
	`JEMALLOC_N
(
¡©s_ÿùive_g‘
)

	)

428 
	#¡©s_ÿùive_sub
 
	`JEMALLOC_N
(
¡©s_ÿùive_sub
)

	)

429 
	#¡©s_´št
 
	`JEMALLOC_N
(
¡©s_´št
)

	)

430 
	#tÿche_®loc_—sy
 
	`JEMALLOC_N
(
tÿche_®loc_—sy
)

	)

431 
	#tÿche_®loc_Ïrge
 
	`JEMALLOC_N
(
tÿche_®loc_Ïrge
)

	)

432 
	#tÿche_®loc_sm®l
 
	`JEMALLOC_N
(
tÿche_®loc_sm®l
)

	)

433 
	#tÿche_®loc_sm®l_h¬d
 
	`JEMALLOC_N
(
tÿche_®loc_sm®l_h¬d
)

	)

434 
	#tÿche_¬’a_assocŸ‹
 
	`JEMALLOC_N
(
tÿche_¬’a_assocŸ‹
)

	)

435 
	#tÿche_¬’a_dissocŸ‹
 
	`JEMALLOC_N
(
tÿche_¬’a_dissocŸ‹
)

	)

436 
	#tÿche_¬’a_»assocŸ‹
 
	`JEMALLOC_N
(
tÿche_¬’a_»assocŸ‹
)

	)

437 
	#tÿche_bš_æush_Ïrge
 
	`JEMALLOC_N
(
tÿche_bš_æush_Ïrge
)

	)

438 
	#tÿche_bš_æush_sm®l
 
	`JEMALLOC_N
(
tÿche_bš_æush_sm®l
)

	)

439 
	#tÿche_bš_šfo
 
	`JEMALLOC_N
(
tÿche_bš_šfo
)

	)

440 
	#tÿche_boÙ
 
	`JEMALLOC_N
(
tÿche_boÙ
)

	)

441 
	#tÿche_ş—nup
 
	`JEMALLOC_N
(
tÿche_ş—nup
)

	)

442 
	#tÿche_ü—‹
 
	`JEMALLOC_N
(
tÿche_ü—‹
)

	)

443 
	#tÿche_d®loc_Ïrge
 
	`JEMALLOC_N
(
tÿche_d®loc_Ïrge
)

	)

444 
	#tÿche_d®loc_sm®l
 
	`JEMALLOC_N
(
tÿche_d®loc_sm®l
)

	)

445 
	#tÿche_’abËd_ş—nup
 
	`JEMALLOC_N
(
tÿche_’abËd_ş—nup
)

	)

446 
	#tÿche_’abËd_g‘
 
	`JEMALLOC_N
(
tÿche_’abËd_g‘
)

	)

447 
	#tÿche_’abËd_£t
 
	`JEMALLOC_N
(
tÿche_’abËd_£t
)

	)

448 
	#tÿche_ev’t
 
	`JEMALLOC_N
(
tÿche_ev’t
)

	)

449 
	#tÿche_ev’t_h¬d
 
	`JEMALLOC_N
(
tÿche_ev’t_h¬d
)

	)

450 
	#tÿche_æush
 
	`JEMALLOC_N
(
tÿche_æush
)

	)

451 
	#tÿche_g‘
 
	`JEMALLOC_N
(
tÿche_g‘
)

	)

452 
	#tÿche_g‘_h¬d
 
	`JEMALLOC_N
(
tÿche_g‘_h¬d
)

	)

453 
	#tÿche_maxşass
 
	`JEMALLOC_N
(
tÿche_maxşass
)

	)

454 
	#tÿches
 
	`JEMALLOC_N
(
tÿches
)

	)

455 
	#tÿche_§Îoc
 
	`JEMALLOC_N
(
tÿche_§Îoc
)

	)

456 
	#tÿches_ü—‹
 
	`JEMALLOC_N
(
tÿches_ü—‹
)

	)

457 
	#tÿches_de¡roy
 
	`JEMALLOC_N
(
tÿches_de¡roy
)

	)

458 
	#tÿches_æush
 
	`JEMALLOC_N
(
tÿches_æush
)

	)

459 
	#tÿches_g‘
 
	`JEMALLOC_N
(
tÿches_g‘
)

	)

460 
	#tÿche_¡©s_m”ge
 
	`JEMALLOC_N
(
tÿche_¡©s_m”ge
)

	)

461 
	#th»ad_®loÿ‹d_ş—nup
 
	`JEMALLOC_N
(
th»ad_®loÿ‹d_ş—nup
)

	)

462 
	#th»ad_d—Îoÿ‹d_ş—nup
 
	`JEMALLOC_N
(
th»ad_d—Îoÿ‹d_ş—nup
)

	)

463 
	#tsd_¬’a_g‘
 
	`JEMALLOC_N
(
tsd_¬’a_g‘
)

	)

464 
	#tsd_¬’a_£t
 
	`JEMALLOC_N
(
tsd_¬’a_£t
)

	)

465 
	#tsd_boÙ
 
	`JEMALLOC_N
(
tsd_boÙ
)

	)

466 
	#tsd_boÙ0
 
	`JEMALLOC_N
(
tsd_boÙ0
)

	)

467 
	#tsd_boÙ1
 
	`JEMALLOC_N
(
tsd_boÙ1
)

	)

468 
	#tsd_boÙed
 
	`JEMALLOC_N
(
tsd_boÙed
)

	)

469 
	#tsd_ş—nup
 
	`JEMALLOC_N
(
tsd_ş—nup
)

	)

470 
	#tsd_ş—nup_w¿µ”
 
	`JEMALLOC_N
(
tsd_ş—nup_w¿µ”
)

	)

471 
	#tsd_ãtch
 
	`JEMALLOC_N
(
tsd_ãtch
)

	)

472 
	#tsd_g‘
 
	`JEMALLOC_N
(
tsd_g‘
)

	)

473 
	#tsd_w¿µ”_g‘
 
	`JEMALLOC_N
(
tsd_w¿µ”_g‘
)

	)

474 
	#tsd_w¿µ”_£t
 
	`JEMALLOC_N
(
tsd_w¿µ”_£t
)

	)

475 
	#tsd_š™Ÿlized
 
	`JEMALLOC_N
(
tsd_š™Ÿlized
)

	)

476 
	#tsd_š™_check_»cursiÚ
 
	`JEMALLOC_N
(
tsd_š™_check_»cursiÚ
)

	)

477 
	#tsd_š™_fšish
 
	`JEMALLOC_N
(
tsd_š™_fšish
)

	)

478 
	#tsd_š™_h—d
 
	`JEMALLOC_N
(
tsd_š™_h—d
)

	)

479 
	#tsd_nomš®
 
	`JEMALLOC_N
(
tsd_nomš®
)

	)

480 
	#tsd_qu¬ªtše_g‘
 
	`JEMALLOC_N
(
tsd_qu¬ªtše_g‘
)

	)

481 
	#tsd_qu¬ªtše_£t
 
	`JEMALLOC_N
(
tsd_qu¬ªtše_£t
)

	)

482 
	#tsd_£t
 
	`JEMALLOC_N
(
tsd_£t
)

	)

483 
	#tsd_tÿche_’abËd_g‘
 
	`JEMALLOC_N
(
tsd_tÿche_’abËd_g‘
)

	)

484 
	#tsd_tÿche_’abËd_£t
 
	`JEMALLOC_N
(
tsd_tÿche_’abËd_£t
)

	)

485 
	#tsd_tÿche_g‘
 
	`JEMALLOC_N
(
tsd_tÿche_g‘
)

	)

486 
	#tsd_tÿche_£t
 
	`JEMALLOC_N
(
tsd_tÿche_£t
)

	)

487 
	#tsd_s
 
	`JEMALLOC_N
(
tsd_s
)

	)

488 
	#tsd_tsd
 
	`JEMALLOC_N
(
tsd_tsd
)

	)

489 
	#tsd_´of_td©a_g‘
 
	`JEMALLOC_N
(
tsd_´of_td©a_g‘
)

	)

490 
	#tsd_´of_td©a_£t
 
	`JEMALLOC_N
(
tsd_´of_td©a_£t
)

	)

491 
	#tsd_th»ad_®loÿ‹d_g‘
 
	`JEMALLOC_N
(
tsd_th»ad_®loÿ‹d_g‘
)

	)

492 
	#tsd_th»ad_®loÿ‹d_£t
 
	`JEMALLOC_N
(
tsd_th»ad_®loÿ‹d_£t
)

	)

493 
	#tsd_th»ad_d—Îoÿ‹d_g‘
 
	`JEMALLOC_N
(
tsd_th»ad_d—Îoÿ‹d_g‘
)

	)

494 
	#tsd_th»ad_d—Îoÿ‹d_£t
 
	`JEMALLOC_N
(
tsd_th»ad_d—Îoÿ‹d_£t
)

	)

495 
	#u2rz
 
	`JEMALLOC_N
(
u2rz
)

	)

496 
	#v®gršd_ä“like_block
 
	`JEMALLOC_N
(
v®gršd_ä“like_block
)

	)

497 
	#v®gršd_make_mem_defšed
 
	`JEMALLOC_N
(
v®gršd_make_mem_defšed
)

	)

498 
	#v®gršd_make_mem_nßcûss
 
	`JEMALLOC_N
(
v®gršd_make_mem_nßcûss
)

	)

499 
	#v®gršd_make_mem_undefšed
 
	`JEMALLOC_N
(
v®gršd_make_mem_undefšed
)

	)

	@deps/jemalloc/include/jemalloc/internal/private_unnamespace.h

1 #undeà
a0d®loc


2 #undeà
a0g‘


3 #undeà
a0m®loc


4 #undeà
¬’a_¯Îoc


5 #undeà
¬’a_®loc_junk_sm®l


6 #undeà
¬’a_bš_šdex


7 #undeà
¬’a_bš_šfo


8 #undeà
¬’a_b™£lm_g‘


9 #undeà
¬’a_boÙ


10 #undeà
¬’a_choo£


11 #undeà
¬’a_choo£_h¬d


12 #undeà
¬’a_chunk_®loc_huge


13 #undeà
¬’a_chunk_ÿche_maybe_š£¹


14 #undeà
¬’a_chunk_ÿche_maybe_»move


15 #undeà
¬’a_chunk_d®loc_huge


16 #undeà
¬’a_chunk_¿Îoc_huge_ex·nd


17 #undeà
¬’a_chunk_¿Îoc_huge_shršk


18 #undeà
¬’a_chunk_¿Îoc_huge_sim¬


19 #undeà
¬’a_ş—nup


20 #undeà
¬’a_d®loc


21 #undeà
¬’a_d®loc_bš


22 #undeà
¬’a_d®loc_bš_junked_locked


23 #undeà
¬’a_d®loc_junk_Ïrge


24 #undeà
¬’a_d®loc_junk_sm®l


25 #undeà
¬’a_d®loc_Ïrge


26 #undeà
¬’a_d®loc_Ïrge_junked_locked


27 #undeà
¬’a_d®loc_sm®l


28 #undeà
¬’a_dss_´ec_g‘


29 #undeà
¬’a_dss_´ec_£t


30 #undeà
¬’a_g‘


31 #undeà
¬’a_g‘_h¬d


32 #undeà
¬’a_š™


33 #undeà
¬’a_lg_dœty_muÉ_deçuÉ_g‘


34 #undeà
¬’a_lg_dœty_muÉ_deçuÉ_£t


35 #undeà
¬’a_lg_dœty_muÉ_g‘


36 #undeà
¬’a_lg_dœty_muÉ_£t


37 #undeà
¬’a_m®loc


38 #undeà
¬’a_m®loc_Ïrge


39 #undeà
¬’a_m®loc_sm®l


40 #undeà
¬’a_m­b™s_®loÿ‹d_g‘


41 #undeà
¬’a_m­b™s_bššd_g‘


42 #undeà
¬’a_m­b™s_decomm™‹d_g‘


43 #undeà
¬’a_m­b™s_dœty_g‘


44 #undeà
¬’a_m­b™s_g‘


45 #undeà
¬’a_m­b™s_š‹º®_£t


46 #undeà
¬’a_m­b™s_Ïrge_bššd_£t


47 #undeà
¬’a_m­b™s_Ïrge_g‘


48 #undeà
¬’a_m­b™s_Ïrge_£t


49 #undeà
¬’a_m­b™s_Ïrge_size_g‘


50 #undeà
¬’a_m­b™¥_g‘


51 #undeà
¬’a_m­b™¥_»ad


52 #undeà
¬’a_m­b™¥_wr™e


53 #undeà
¬’a_m­b™s_size_decode


54 #undeà
¬’a_m­b™s_size_’code


55 #undeà
¬’a_m­b™s_sm®l_runšd_g‘


56 #undeà
¬’a_m­b™s_sm®l_£t


57 #undeà
¬’a_m­b™s_uÇÎoÿ‹d_£t


58 #undeà
¬’a_m­b™s_uÇÎoÿ‹d_size_g‘


59 #undeà
¬’a_m­b™s_uÇÎoÿ‹d_size_£t


60 #undeà
¬’a_m­b™s_unz”Ûd_g‘


61 #undeà
¬’a_maxrun


62 #undeà
¬’a_maybe_purge


63 #undeà
¬’a_m‘ad©a_®loÿ‹d_add


64 #undeà
¬’a_m‘ad©a_®loÿ‹d_g‘


65 #undeà
¬’a_m‘ad©a_®loÿ‹d_sub


66 #undeà
¬’a_mig¿‹


67 #undeà
¬’a_misûlm_g‘


68 #undeà
¬’a_misûlm_to_·gešd


69 #undeà
¬’a_misûlm_to_½ages


70 #undeà
¬’a_nbound


71 #undeà
¬’a_Ãw


72 #undeà
¬’a_node_®loc


73 #undeà
¬’a_node_d®loc


74 #undeà
¬’a_·Îoc


75 #undeà
¬’a_po¡fÜk_chd


76 #undeà
¬’a_po¡fÜk_·»Á


77 #undeà
¬’a_´efÜk


78 #undeà
¬’a_´of_accum


79 #undeà
¬’a_´of_accum_im¶


80 #undeà
¬’a_´of_accum_locked


81 #undeà
¬’a_´of_´omÙed


82 #undeà
¬’a_´of_tùx_g‘


83 #undeà
¬’a_´of_tùx_»£t


84 #undeà
¬’a_´of_tùx_£t


85 #undeà
¬’a_±r_sm®l_bššd_g‘


86 #undeà
¬’a_purge_®l


87 #undeà
¬’a_qu¬ªtše_junk_sm®l


88 #undeà
¬’a_¿Îoc


89 #undeà
¬’a_¿Îoc_junk_Ïrge


90 #undeà
¬’a_¿Îoc_no_move


91 #undeà
¬’a_rd_to_misûlm


92 #undeà
¬’a_»dzÚe_cÜru±iÚ


93 #undeà
¬’a_run_»gšd


94 #undeà
¬’a_run_to_misûlm


95 #undeà
¬’a_§Îoc


96 #undeà
¬’as_ÿche_by·ss_ş—nup


97 #undeà
¬’as_ÿche_ş—nup


98 #undeà
¬’a_sd®loc


99 #undeà
¬’a_¡©s_m”ge


100 #undeà
¬’a_tÿche_fl_sm®l


101 #undeà
©omic_add_p


102 #undeà
©omic_add_u


103 #undeà
©omic_add_ušt32


104 #undeà
©omic_add_ušt64


105 #undeà
©omic_add_z


106 #undeà
©omic_ÿs_p


107 #undeà
©omic_ÿs_u


108 #undeà
©omic_ÿs_ušt32


109 #undeà
©omic_ÿs_ušt64


110 #undeà
©omic_ÿs_z


111 #undeà
©omic_sub_p


112 #undeà
©omic_sub_u


113 #undeà
©omic_sub_ušt32


114 #undeà
©omic_sub_ušt64


115 #undeà
©omic_sub_z


116 #undeà
ba£_®loc


117 #undeà
ba£_boÙ


118 #undeà
ba£_po¡fÜk_chd


119 #undeà
ba£_po¡fÜk_·»Á


120 #undeà
ba£_´efÜk


121 #undeà
ba£_¡©s_g‘


122 #undeà
b™m­_fuÎ


123 #undeà
b™m­_g‘


124 #undeà
b™m­_šfo_š™


125 #undeà
b™m­_šfo_ngroups


126 #undeà
b™m­_š™


127 #undeà
b™m­_£t


128 #undeà
b™m­_sfu


129 #undeà
b™m­_size


130 #undeà
b™m­_un£t


131 #undeà
boÙ¡¿p_ÿÎoc


132 #undeà
boÙ¡¿p_ä“


133 #undeà
boÙ¡¿p_m®loc


134 #undeà
bt_š™


135 #undeà
buã¼Ü


136 #undeà
chunk_®loc_ba£


137 #undeà
chunk_®loc_ÿche


138 #undeà
chunk_®loc_dss


139 #undeà
chunk_®loc_mm­


140 #undeà
chunk_®loc_w¿µ”


141 #undeà
chunk_boÙ


142 #undeà
chunk_d®loc_¬’a


143 #undeà
chunk_d®loc_ÿche


144 #undeà
chunk_d®loc_mm­


145 #undeà
chunk_d®loc_w¿µ”


146 #undeà
chunk_d”egi¡”


147 #undeà
chunk_dss_boÙ


148 #undeà
chunk_dss_po¡fÜk_chd


149 #undeà
chunk_dss_po¡fÜk_·»Á


150 #undeà
chunk_dss_´ec_g‘


151 #undeà
chunk_dss_´ec_£t


152 #undeà
chunk_dss_´efÜk


153 #undeà
chunk_hooks_deçuÉ


154 #undeà
chunk_hooks_g‘


155 #undeà
chunk_hooks_£t


156 #undeà
chunk_š_dss


157 #undeà
chunk_lookup


158 #undeà
chunk_Åages


159 #undeà
chunk_po¡fÜk_chd


160 #undeà
chunk_po¡fÜk_·»Á


161 #undeà
chunk_´efÜk


162 #undeà
chunk_purge_¬’a


163 #undeà
chunk_purge_w¿µ”


164 #undeà
chunk_»gi¡”


165 #undeà
chunksize


166 #undeà
chunksize_mask


167 #undeà
chunks_¹»e


168 #undeà
ckh_couÁ


169 #undeà
ckh_d–‘e


170 #undeà
ckh_š£¹


171 #undeà
ckh_™”


172 #undeà
ckh_Ãw


173 #undeà
ckh_poš‹r_hash


174 #undeà
ckh_poš‹r_keycomp


175 #undeà
ckh_»move


176 #undeà
ckh_£¬ch


177 #undeà
ckh_¡ršg_hash


178 #undeà
ckh_¡ršg_keycomp


179 #undeà
ùl_boÙ


180 #undeà
ùl_bymib


181 #undeà
ùl_byÇme


182 #undeà
ùl_Çm‘omib


183 #undeà
ùl_po¡fÜk_chd


184 #undeà
ùl_po¡fÜk_·»Á


185 #undeà
ùl_´efÜk


186 #undeà
dss_´ec_Çmes


187 #undeà
ex‹Á_node_achunk_g‘


188 #undeà
ex‹Á_node_achunk_£t


189 #undeà
ex‹Á_node_addr_g‘


190 #undeà
ex‹Á_node_addr_£t


191 #undeà
ex‹Á_node_¬’a_g‘


192 #undeà
ex‹Á_node_¬’a_£t


193 #undeà
ex‹Á_node_dœty_š£¹


194 #undeà
ex‹Á_node_dœty_lškage_š™


195 #undeà
ex‹Á_node_dœty_»move


196 #undeà
ex‹Á_node_š™


197 #undeà
ex‹Á_node_´of_tùx_g‘


198 #undeà
ex‹Á_node_´of_tùx_£t


199 #undeà
ex‹Á_node_size_g‘


200 #undeà
ex‹Á_node_size_£t


201 #undeà
ex‹Á_node_z”Ûd_g‘


202 #undeà
ex‹Á_node_z”Ûd_£t


203 #undeà
ex‹Á_Œ“_ad_em±y


204 #undeà
ex‹Á_Œ“_ad_fœ¡


205 #undeà
ex‹Á_Œ“_ad_š£¹


206 #undeà
ex‹Á_Œ“_ad_™”


207 #undeà
ex‹Á_Œ“_ad_™”_»cur£


208 #undeà
ex‹Á_Œ“_ad_™”_¡¬t


209 #undeà
ex‹Á_Œ“_ad_Ï¡


210 #undeà
ex‹Á_Œ“_ad_Ãw


211 #undeà
ex‹Á_Œ“_ad_Ãxt


212 #undeà
ex‹Á_Œ“_ad_n£¬ch


213 #undeà
ex‹Á_Œ“_ad_´ev


214 #undeà
ex‹Á_Œ“_ad_p£¬ch


215 #undeà
ex‹Á_Œ“_ad_»move


216 #undeà
ex‹Á_Œ“_ad_»v”£_™”


217 #undeà
ex‹Á_Œ“_ad_»v”£_™”_»cur£


218 #undeà
ex‹Á_Œ“_ad_»v”£_™”_¡¬t


219 #undeà
ex‹Á_Œ“_ad_£¬ch


220 #undeà
ex‹Á_Œ“_szad_em±y


221 #undeà
ex‹Á_Œ“_szad_fœ¡


222 #undeà
ex‹Á_Œ“_szad_š£¹


223 #undeà
ex‹Á_Œ“_szad_™”


224 #undeà
ex‹Á_Œ“_szad_™”_»cur£


225 #undeà
ex‹Á_Œ“_szad_™”_¡¬t


226 #undeà
ex‹Á_Œ“_szad_Ï¡


227 #undeà
ex‹Á_Œ“_szad_Ãw


228 #undeà
ex‹Á_Œ“_szad_Ãxt


229 #undeà
ex‹Á_Œ“_szad_n£¬ch


230 #undeà
ex‹Á_Œ“_szad_´ev


231 #undeà
ex‹Á_Œ“_szad_p£¬ch


232 #undeà
ex‹Á_Œ“_szad_»move


233 #undeà
ex‹Á_Œ“_szad_»v”£_™”


234 #undeà
ex‹Á_Œ“_szad_»v”£_™”_»cur£


235 #undeà
ex‹Á_Œ“_szad_»v”£_™”_¡¬t


236 #undeà
ex‹Á_Œ“_szad_£¬ch


237 #undeà
g‘_”ºo


238 #undeà
hash


239 #undeà
hash_fmix_32


240 #undeà
hash_fmix_64


241 #undeà
hash_g‘_block_32


242 #undeà
hash_g‘_block_64


243 #undeà
hash_rÙl_32


244 #undeà
hash_rÙl_64


245 #undeà
hash_x64_128


246 #undeà
hash_x86_128


247 #undeà
hash_x86_32


248 #undeà
huge_¯Îoc


249 #undeà
huge_d®loc


250 #undeà
huge_d®loc_junk


251 #undeà
huge_m®loc


252 #undeà
huge_·Îoc


253 #undeà
huge_´of_tùx_g‘


254 #undeà
huge_´of_tùx_»£t


255 #undeà
huge_´of_tùx_£t


256 #undeà
huge_¿Îoc


257 #undeà
huge_¿Îoc_no_move


258 #undeà
huge_§Îoc


259 #undeà
Ÿ®loc


260 #undeà
ŸÎocztm


261 #undeà
iÿÎoc


262 #undeà
iÿÎoù


263 #undeà
id®loc


264 #undeà
id®loù


265 #undeà
id®loùm


266 #undeà
im®loc


267 #undeà
im®loù


268 #undeà
šdex2size


269 #undeà
šdex2size_compu‹


270 #undeà
šdex2size_lookup


271 #undeà
šdex2size_b


272 #undeà
š_v®gršd


273 #undeà
®loc


274 #undeà
®loù


275 #undeà
®locztm


276 #undeà
iq®loc


277 #undeà
œ®loc


278 #undeà
œ®loù


279 #undeà
œ®loù_»®ign


280 #undeà
i§Îoc


281 #undeà
isd®loù


282 #undeà
isq®loc


283 #undeà
i¡h»aded


284 #undeà
iv§Îoc


285 #undeà
ix®loc


286 #undeà
jem®loc_po¡fÜk_chd


287 #undeà
jem®loc_po¡fÜk_·»Á


288 #undeà
jem®loc_´efÜk


289 #undeà
Ïrge_maxşass


290 #undeà
lg_æoÜ


291 #undeà
m®loc_ırštf


292 #undeà
m®loc_mu‹x_š™


293 #undeà
m®loc_mu‹x_lock


294 #undeà
m®loc_mu‹x_po¡fÜk_chd


295 #undeà
m®loc_mu‹x_po¡fÜk_·»Á


296 #undeà
m®loc_mu‹x_´efÜk


297 #undeà
m®loc_mu‹x_uÆock


298 #undeà
m®loc_´štf


299 #undeà
m®loc_¢´štf


300 #undeà
m®loc_¡¹oumax


301 #undeà
m®loc_tsd_boÙ0


302 #undeà
m®loc_tsd_boÙ1


303 #undeà
m®loc_tsd_ş—nup_»gi¡”


304 #undeà
m®loc_tsd_d®loc


305 #undeà
m®loc_tsd_m®loc


306 #undeà
m®loc_tsd_no_ş—nup


307 #undeà
m®loc_vırštf


308 #undeà
m®loc_v¢´štf


309 #undeà
m®loc_wr™e


310 #undeà
m­_bŸs


311 #undeà
m­_misc_off£t


312 #undeà
mb_wr™e


313 #undeà
mu‹x_boÙ


314 #undeà
Ç»Çs_ÿche_ş—nup


315 #undeà
Ç»Çs_tÙ®_g‘


316 #undeà
nıus


317 #undeà
nhbšs


318 #undeà
İt_abÜt


319 #undeà
İt_dss


320 #undeà
İt_junk


321 #undeà
İt_junk_®loc


322 #undeà
İt_junk_ä“


323 #undeà
İt_lg_chunk


324 #undeà
İt_lg_dœty_muÉ


325 #undeà
İt_lg_´of_š‹rv®


326 #undeà
İt_lg_´of_§m¶e


327 #undeà
İt_lg_tÿche_max


328 #undeà
İt_Ç»Çs


329 #undeà
İt_´of


330 #undeà
İt_´of_accum


331 #undeà
İt_´of_aùive


332 #undeà
İt_´of_fš®


333 #undeà
İt_´of_gdump


334 #undeà
İt_´of_Ëak


335 #undeà
İt_´of_´efix


336 #undeà
İt_´of_th»ad_aùive_š™


337 #undeà
İt_qu¬ªtše


338 #undeà
İt_»dzÚe


339 #undeà
İt_¡©s_´št


340 #undeà
İt_tÿche


341 #undeà
İt_uŒaû


342 #undeà
İt_xm®loc


343 #undeà
İt_z”o


344 #undeà
p2rz


345 #undeà
·ges_comm™


346 #undeà
·ges_decomm™


347 #undeà
·ges_m­


348 #undeà
·ges_purge


349 #undeà
·ges_Œim


350 #undeà
·ges_unm­


351 #undeà
pow2_û


352 #undeà
´of_aùive_g‘


353 #undeà
´of_aùive_g‘_uÆocked


354 #undeà
´of_aùive_£t


355 #undeà
´of_®loc_´•


356 #undeà
´of_®loc_rŞlback


357 #undeà
´of_backŒaû


358 #undeà
´of_boÙ0


359 #undeà
´of_boÙ1


360 #undeà
´of_boÙ2


361 #undeà
´of_dump_h—d”


362 #undeà
´of_dump_İ’


363 #undeà
´of_ä“


364 #undeà
´of_ä“_§m¶ed_objeù


365 #undeà
´of_gdump


366 #undeà
´of_gdump_g‘


367 #undeà
´of_gdump_g‘_uÆocked


368 #undeà
´of_gdump_£t


369 #undeà
´of_gdump_v®


370 #undeà
´of_idump


371 #undeà
´of_š‹rv®


372 #undeà
´of_lookup


373 #undeà
´of_m®loc


374 #undeà
´of_m®loc_§m¶e_objeù


375 #undeà
´of_mdump


376 #undeà
´of_po¡fÜk_chd


377 #undeà
´of_po¡fÜk_·»Á


378 #undeà
´of_´efÜk


379 #undeà
´of_»®loc


380 #undeà
´of_»£t


381 #undeà
´of_§m¶e_accum_upd©e


382 #undeà
´of_§m¶e_th»shŞd_upd©e


383 #undeà
´of_tùx_g‘


384 #undeà
´of_tùx_»£t


385 #undeà
´of_tùx_£t


386 #undeà
´of_td©a_ş—nup


387 #undeà
´of_td©a_g‘


388 #undeà
´of_td©a_š™


389 #undeà
´of_td©a_»š™


390 #undeà
´of_th»ad_aùive_g‘


391 #undeà
´of_th»ad_aùive_š™_g‘


392 #undeà
´of_th»ad_aùive_š™_£t


393 #undeà
´of_th»ad_aùive_£t


394 #undeà
´of_th»ad_Çme_g‘


395 #undeà
´of_th»ad_Çme_£t


396 #undeà
qu¬ªtše


397 #undeà
qu¬ªtše_®loc_hook


398 #undeà
qu¬ªtše_®loc_hook_wÜk


399 #undeà
qu¬ªtše_ş—nup


400 #undeà
»gi¡”_zÚe


401 #undeà
¹»e_chd_»ad


402 #undeà
¹»e_chd_»ad_h¬d


403 #undeà
¹»e_chd_Œy»ad


404 #undeà
¹»e_d–‘e


405 #undeà
¹»e_g‘


406 #undeà
¹»e_Ãw


407 #undeà
¹»e_node_v®id


408 #undeà
¹»e_£t


409 #undeà
¹»e_¡¬t_Ëv–


410 #undeà
¹»e_subkey


411 #undeà
¹»e_subŒ“_»ad


412 #undeà
¹»e_subŒ“_»ad_h¬d


413 #undeà
¹»e_subŒ“_Œy»ad


414 #undeà
¹»e_v®_»ad


415 #undeà
¹»e_v®_wr™e


416 #undeà
s2u


417 #undeà
s2u_compu‹


418 #undeà
s2u_lookup


419 #undeà
§2u


420 #undeà
£t_”ºo


421 #undeà
size2šdex


422 #undeà
size2šdex_compu‹


423 #undeà
size2šdex_lookup


424 #undeà
size2šdex_b


425 #undeà
¡©s_ÿùive


426 #undeà
¡©s_ÿùive_add


427 #undeà
¡©s_ÿùive_g‘


428 #undeà
¡©s_ÿùive_sub


429 #undeà
¡©s_´št


430 #undeà
tÿche_®loc_—sy


431 #undeà
tÿche_®loc_Ïrge


432 #undeà
tÿche_®loc_sm®l


433 #undeà
tÿche_®loc_sm®l_h¬d


434 #undeà
tÿche_¬’a_assocŸ‹


435 #undeà
tÿche_¬’a_dissocŸ‹


436 #undeà
tÿche_¬’a_»assocŸ‹


437 #undeà
tÿche_bš_æush_Ïrge


438 #undeà
tÿche_bš_æush_sm®l


439 #undeà
tÿche_bš_šfo


440 #undeà
tÿche_boÙ


441 #undeà
tÿche_ş—nup


442 #undeà
tÿche_ü—‹


443 #undeà
tÿche_d®loc_Ïrge


444 #undeà
tÿche_d®loc_sm®l


445 #undeà
tÿche_’abËd_ş—nup


446 #undeà
tÿche_’abËd_g‘


447 #undeà
tÿche_’abËd_£t


448 #undeà
tÿche_ev’t


449 #undeà
tÿche_ev’t_h¬d


450 #undeà
tÿche_æush


451 #undeà
tÿche_g‘


452 #undeà
tÿche_g‘_h¬d


453 #undeà
tÿche_maxşass


454 #undeà
tÿches


455 #undeà
tÿche_§Îoc


456 #undeà
tÿches_ü—‹


457 #undeà
tÿches_de¡roy


458 #undeà
tÿches_æush


459 #undeà
tÿches_g‘


460 #undeà
tÿche_¡©s_m”ge


461 #undeà
th»ad_®loÿ‹d_ş—nup


462 #undeà
th»ad_d—Îoÿ‹d_ş—nup


463 #undeà
tsd_¬’a_g‘


464 #undeà
tsd_¬’a_£t


465 #undeà
tsd_boÙ


466 #undeà
tsd_boÙ0


467 #undeà
tsd_boÙ1


468 #undeà
tsd_boÙed


469 #undeà
tsd_ş—nup


470 #undeà
tsd_ş—nup_w¿µ”


471 #undeà
tsd_ãtch


472 #undeà
tsd_g‘


473 #undeà
tsd_w¿µ”_g‘


474 #undeà
tsd_w¿µ”_£t


475 #undeà
tsd_š™Ÿlized


476 #undeà
tsd_š™_check_»cursiÚ


477 #undeà
tsd_š™_fšish


478 #undeà
tsd_š™_h—d


479 #undeà
tsd_nomš®


480 #undeà
tsd_qu¬ªtše_g‘


481 #undeà
tsd_qu¬ªtše_£t


482 #undeà
tsd_£t


483 #undeà
tsd_tÿche_’abËd_g‘


484 #undeà
tsd_tÿche_’abËd_£t


485 #undeà
tsd_tÿche_g‘


486 #undeà
tsd_tÿche_£t


487 #undeà
tsd_s


488 #undeà
tsd_tsd


489 #undeà
tsd_´of_td©a_g‘


490 #undeà
tsd_´of_td©a_£t


491 #undeà
tsd_th»ad_®loÿ‹d_g‘


492 #undeà
tsd_th»ad_®loÿ‹d_£t


493 #undeà
tsd_th»ad_d—Îoÿ‹d_g‘


494 #undeà
tsd_th»ad_d—Îoÿ‹d_£t


495 #undeà
u2rz


496 #undeà
v®gršd_ä“like_block


497 #undeà
v®gršd_make_mem_defšed


498 #undeà
v®gršd_make_mem_nßcûss


499 #undeà
v®gršd_make_mem_undefšed


	@deps/jemalloc/include/jemalloc/internal/prng.h

2 #ifdeà
JEMALLOC_H_TYPES


28 
	#´ng32
(
r
, 
lg_¿nge
, 
¡©e
, 
a
, 
c
) do { \

29 
	`as£¹
((
lg_¿nge
) > 0); \

30 
	`as£¹
((
lg_¿nge
) <= 32); \

32 
r
 = (
¡©e
 * (
a
)è+ (
c
); \

33 
¡©e
 = 
r
; \

34 
r
 >>ğ(32 - (
lg_¿nge
)); \

35 } 
çl£
)

	)

38 
	#´ng64
(
r
, 
lg_¿nge
, 
¡©e
, 
a
, 
c
) do { \

39 
	`as£¹
((
lg_¿nge
) > 0); \

40 
	`as£¹
((
lg_¿nge
) <= 64); \

42 
r
 = (
¡©e
 * (
a
)è+ (
c
); \

43 
¡©e
 = 
r
; \

44 
r
 >>ğ(64 - (
lg_¿nge
)); \

45 } 
çl£
)

	)

49 #ifdeà
JEMALLOC_H_STRUCTS


53 #ifdeà
JEMALLOC_H_EXTERNS


57 #ifdeà
JEMALLOC_H_INLINES


	@deps/jemalloc/include/jemalloc/internal/prof.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
´of_bt_s
 
	t´of_bt_t
;

5 
´of_út_s
 
	t´of_út_t
;

6 
´of_tùx_s
 
	t´of_tùx_t
;

7 
´of_gùx_s
 
	t´of_gùx_t
;

8 
´of_td©a_s
 
	t´of_td©a_t
;

11 #ifdeà
JEMALLOC_PROF


12 
	#PROF_PREFIX_DEFAULT
 "j•rof"

	)

14 
	#PROF_PREFIX_DEFAULT
 ""

	)

16 
	#LG_PROF_SAMPLE_DEFAULT
 19

	)

17 
	#LG_PROF_INTERVAL_DEFAULT
 -1

	)

24 
	#PROF_BT_MAX
 128

	)

27 
	#PROF_CKH_MINITEMS
 64

	)

30 
	#PROF_DUMP_BUFSIZE
 65536

	)

33 
	#PROF_PRINTF_BUFSIZE
 128

	)

39 
	#PROF_NCTX_LOCKS
 1024

	)

45 
	#PROF_NTDATA_LOCKS
 256

	)

51 
	#PROF_TDATA_STATE_REINCARNATED
 ((
´of_td©a_t
 *)(
ušŒ_t
)1)

	)

52 
	#PROF_TDATA_STATE_PURGATORY
 ((
´of_td©a_t
 *)(
ušŒ_t
)2)

	)

53 
	#PROF_TDATA_STATE_MAX
 
PROF_TDATA_STATE_PURGATORY


	)

57 #ifdeà
JEMALLOC_H_STRUCTS


59 
	s´of_bt_s
 {

61 **
	mvec
;

62 
	mËn
;

65 #ifdeà
JEMALLOC_PROF_LIBGCC


68 
´of_bt_t
 *
	mbt
;

69 
	mmax
;

70 } 
	t´of_unwšd_d©a_t
;

73 
	s´of_út_s
 {

75 
ušt64_t
 
	mcurobjs
;

76 
ušt64_t
 
	mcurby‹s
;

77 
ušt64_t
 
	maccumobjs
;

78 
ušt64_t
 
	maccumby‹s
;

82 
	m´of_tùx_¡©e_š™Ÿlizšg
,

83 
	m´of_tùx_¡©e_nomš®
,

84 
	m´of_tùx_¡©e_dumpšg
,

85 
	m´of_tùx_¡©e_purg©Üy


86 } 
	t´of_tùx_¡©e_t
;

88 
	s´of_tùx_s
 {

90 
´of_td©a_t
 *
	mtd©a
;

96 
ušt64_t
 
	mthr_uid
;

97 
ušt64_t
 
	mthr_disüim
;

100 
´of_út_t
 
	múts
;

103 
´of_gùx_t
 *
	mgùx
;

118 
ušt64_t
 
	mtùx_uid
;

121 
rb_node
(
´of_tùx_t
è
	mtùx_lšk
;

127 
boŞ
 
	m´•¬ed
;

130 
´of_tùx_¡©e_t
 
	m¡©e
;

136 
´of_út_t
 
	mdump_úts
;

138 
	$rb_Œ“
(
	t´of_tùx_t
è
	t´of_tùx_Œ“_t
;

140 
	s´of_gùx_s
 {

142 
m®loc_mu‹x_t
 *
lock
;

154 
Æimbo
;

160 
´of_tùx_Œ“_t
 
tùxs
;

163 
	`rb_node
(
´of_gùx_t
è
dump_lšk
;

166 
´of_út_t
 
út_summed
;

169 
´of_bt_t
 
bt
;

172 *
vec
[1];

174 
	$rb_Œ“
(
	t´of_gùx_t
è
	t´of_gùx_Œ“_t
;

176 
	s´of_td©a_s
 {

177 
m®loc_mu‹x_t
 *
lock
;

180 
ušt64_t
 
thr_uid
;

186 
ušt64_t
 
thr_disüim
;

189 *
th»ad_Çme
;

191 
boŞ
 
©ched
;

192 
boŞ
 
expœed
;

194 
	`rb_node
(
´of_td©a_t
è
td©a_lšk
;

201 
ušt64_t
 
tùx_uid_Ãxt
;

209 
ckh_t
 
bt2tùx
;

212 
ušt64_t
 
´ng_¡©e
;

213 
ušt64_t
 
by‹s_uÁ_§m¶e
;

216 
boŞ
 
’q
;

217 
boŞ
 
’q_idump
;

218 
boŞ
 
’q_gdump
;

226 
boŞ
 
dumpšg
;

232 
boŞ
 
aùive
;

235 
´of_út_t
 
út_summed
;

238 *
vec
[
PROF_BT_MAX
];

240 
	$rb_Œ“
(
	t´of_td©a_t
è
	t´of_td©a_Œ“_t
;

244 #ifdeà
JEMALLOC_H_EXTERNS


246 
boŞ
 
İt_´of
;

247 
boŞ
 
İt_´of_aùive
;

248 
boŞ
 
İt_´of_th»ad_aùive_š™
;

249 
size_t
 
İt_lg_´of_§m¶e
;

250 
ssize_t
 
İt_lg_´of_š‹rv®
;

251 
boŞ
 
İt_´of_gdump
;

252 
boŞ
 
İt_´of_fš®
;

253 
boŞ
 
İt_´of_Ëak
;

254 
boŞ
 
İt_´of_accum
;

255 
İt_´of_´efix
[

257 #ifdeà
JEMALLOC_PROF


258 
PATH_MAX
 +

263 
boŞ
 
´of_aùive
;

266 
boŞ
 
´of_gdump_v®
;

275 
ušt64_t
 
´of_š‹rv®
;

281 
size_t
 
lg_´of_§m¶e
;

283 
	`´of_®loc_rŞlback
(
tsd_t
 *
tsd
, 
´of_tùx_t
 *
tùx
, 
boŞ
 
upd©ed
);

284 
	`´of_m®loc_§m¶e_objeù
(cÚ¡ *
±r
, 
size_t
 
usize
,

285 
´of_tùx_t
 *
tùx
);

286 
	`´of_ä“_§m¶ed_objeù
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
);

287 
	`bt_š™
(
´of_bt_t
 *
bt
, **
vec
);

288 
	`´of_backŒaû
(
´of_bt_t
 *
bt
);

289 
´of_tùx_t
 *
	`´of_lookup
(
tsd_t
 *
tsd
, 
´of_bt_t
 *
bt
);

290 #ifdeà
JEMALLOC_JET


291 
size_t
 
	`´of_td©a_couÁ
();

292 
size_t
 
	`´of_bt_couÁ
();

293 cÚ¡ 
´of_út_t
 *
	`´of_út_®l
();

294 (
	t´of_dump_İ’_t
)(
	tboŞ
, const *);

295 
´of_dump_İ’_t
 *
´of_dump_İ’
;

296 
	$boŞ
 (
	t´of_dump_h—d”_t
)(
	tboŞ
, cÚ¡ 
	t´of_út_t
 *);

297 
´of_dump_h—d”_t
 *
´of_dump_h—d”
;

299 
	`´of_idump
();

300 
boŞ
 
	`´of_mdump
(cÚ¡ *
f’ame
);

301 
	`´of_gdump
();

302 
´of_td©a_t
 *
	`´of_td©a_š™
(
tsd_t
 *
tsd
);

303 
´of_td©a_t
 *
	`´of_td©a_»š™
(
tsd_t
 *
tsd
,…rof_td©a_ˆ*
td©a
);

304 
	`´of_»£t
(
tsd_t
 *
tsd
, 
size_t
 
lg_§m¶e
);

305 
	`´of_td©a_ş—nup
(
tsd_t
 *
tsd
);

306 cÚ¡ *
	`´of_th»ad_Çme_g‘
();

307 
boŞ
 
	`´of_aùive_g‘
();

308 
boŞ
 
	`´of_aùive_£t
(boŞ 
aùive
);

309 
	`´of_th»ad_Çme_£t
(
tsd_t
 *
tsd
, cÚ¡ *
th»ad_Çme
);

310 
boŞ
 
	`´of_th»ad_aùive_g‘
();

311 
boŞ
 
	`´of_th»ad_aùive_£t
(boŞ 
aùive
);

312 
boŞ
 
	`´of_th»ad_aùive_š™_g‘
();

313 
boŞ
 
	`´of_th»ad_aùive_š™_£t
(boŞ 
aùive_š™
);

314 
boŞ
 
	`´of_gdump_g‘
();

315 
boŞ
 
	`´of_gdump_£t
(boŞ 
aùive
);

316 
	`´of_boÙ0
();

317 
	`´of_boÙ1
();

318 
boŞ
 
	`´of_boÙ2
();

319 
	`´of_´efÜk
();

320 
	`´of_po¡fÜk_·»Á
();

321 
	`´of_po¡fÜk_chd
();

322 
	`´of_§m¶e_th»shŞd_upd©e
(
´of_td©a_t
 *
td©a
);

326 #ifdeà
JEMALLOC_H_INLINES


328 #iâdeà
JEMALLOC_ENABLE_INLINE


329 
boŞ
 
	`´of_aùive_g‘_uÆocked
();

330 
boŞ
 
	`´of_gdump_g‘_uÆocked
();

331 
´of_td©a_t
 *
	`´of_td©a_g‘
(
tsd_t
 *
tsd
, 
boŞ
 
ü—‹
);

332 
boŞ
 
	`´of_§m¶e_accum_upd©e
(
tsd_t
 *
tsd
, 
size_t
 
usize
, boŞ 
comm™
,

333 
´of_td©a_t
 **
td©a_out
);

334 
´of_tùx_t
 *
	`´of_®loc_´•
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
boŞ
 
´of_aùive
,

335 
boŞ
 
upd©e
);

336 
´of_tùx_t
 *
	`´of_tùx_g‘
(cÚ¡ *
±r
);

337 
	`´of_tùx_£t
(cÚ¡ *
±r
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
);

338 
	`´of_tùx_»£t
(cÚ¡ *
±r
, 
size_t
 
usize
, cÚ¡ *
Şd_±r
,

339 
´of_tùx_t
 *
tùx
);

340 
	`´of_m®loc_§m¶e_objeù
(cÚ¡ *
±r
, 
size_t
 
usize
,

341 
´of_tùx_t
 *
tùx
);

342 
	`´of_m®loc
(cÚ¡ *
±r
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
);

343 
	`´of_»®loc
(
tsd_t
 *
tsd
, cÚ¡ *
±r
, 
size_t
 
usize
,

344 
´of_tùx_t
 *
tùx
, 
boŞ
 
´of_aùive
, boŞ 
upd©ed
, cÚ¡ *
Şd_±r
,

345 
size_t
 
Şd_usize
, 
´of_tùx_t
 *
Şd_tùx
);

346 
	`´of_ä“
(
tsd_t
 *
tsd
, cÚ¡ *
±r
, 
size_t
 
usize
);

349 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_PROF_C_
))

350 
JEMALLOC_ALWAYS_INLINE
 
boŞ


351 
	$´of_aùive_g‘_uÆocked
()

360  (
´of_aùive
);

361 
	}
}

363 
JEMALLOC_ALWAYS_INLINE
 
boŞ


364 
	$´of_gdump_g‘_uÆocked
()

372  (
´of_gdump_v®
);

373 
	}
}

375 
JEMALLOC_ALWAYS_INLINE
 
´of_td©a_t
 *

376 
	$´of_td©a_g‘
(
tsd_t
 *
tsd
, 
boŞ
 
ü—‹
)

378 
´of_td©a_t
 *
td©a
;

380 
	`ÿs£¹
(
cÚfig_´of
);

382 
td©a
 = 
	`tsd_´of_td©a_g‘
(
tsd
);

383 ià(
ü—‹
) {

384 ià(
	`uÆik–y
(
td©a
 =ğ
NULL
)) {

385 ià(
	`tsd_nomš®
(
tsd
)) {

386 
td©a
 = 
	`´of_td©a_š™
(
tsd
);

387 
	`tsd_´of_td©a_£t
(
tsd
, 
td©a
);

389 } ià(
	`uÆik–y
(
td©a
->
expœed
)) {

390 
td©a
 = 
	`´of_td©a_»š™
(
tsd
,data);

391 
	`tsd_´of_td©a_£t
(
tsd
, 
td©a
);

393 
	`as£¹
(
td©a
 =ğ
NULL
 ||d©a->
©ched
);

396  (
td©a
);

397 
	}
}

399 
JEMALLOC_ALWAYS_INLINE
 
´of_tùx_t
 *

400 
	$´of_tùx_g‘
(cÚ¡ *
±r
)

403 
	`ÿs£¹
(
cÚfig_´of
);

404 
	`as£¹
(
±r
 !ğ
NULL
);

406  (
	`¬’a_´of_tùx_g‘
(
±r
));

407 
	}
}

409 
JEMALLOC_ALWAYS_INLINE
 

410 
	$´of_tùx_£t
(cÚ¡ *
±r
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
)

413 
	`ÿs£¹
(
cÚfig_´of
);

414 
	`as£¹
(
±r
 !ğ
NULL
);

416 
	`¬’a_´of_tùx_£t
(
±r
, 
usize
, 
tùx
);

417 
	}
}

419 
JEMALLOC_ALWAYS_INLINE
 

420 
	$´of_tùx_»£t
(cÚ¡ *
±r
, 
size_t
 
usize
, cÚ¡ *
Şd_±r
,

421 
´of_tùx_t
 *
Şd_tùx
)

424 
	`ÿs£¹
(
cÚfig_´of
);

425 
	`as£¹
(
±r
 !ğ
NULL
);

427 
	`¬’a_´of_tùx_»£t
(
±r
, 
usize
, 
Şd_±r
, 
Şd_tùx
);

428 
	}
}

430 
JEMALLOC_ALWAYS_INLINE
 
boŞ


431 
	$´of_§m¶e_accum_upd©e
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
boŞ
 
upd©e
,

432 
´of_td©a_t
 **
td©a_out
)

434 
´of_td©a_t
 *
td©a
;

436 
	`ÿs£¹
(
cÚfig_´of
);

438 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

439 ià((
ušŒ_t
)
td©a
 <ğ(ušŒ_t)
PROF_TDATA_STATE_MAX
)

440 
td©a
 = 
NULL
;

442 ià(
td©a_out
 !ğ
NULL
)

443 *
td©a_out
 = 
td©a
;

445 ià(
td©a
 =ğ
NULL
)

446  (
Œue
);

448 ià(
td©a
->
by‹s_uÁ_§m¶e
 >ğ
usize
) {

449 ià(
upd©e
)

450 
td©a
->
by‹s_uÁ_§m¶e
 -ğ
usize
;

451  (
Œue
);

454 ià(
upd©e
)

455 
	`´of_§m¶e_th»shŞd_upd©e
(
td©a
);

456  (!
td©a
->
aùive
);

458 
	}
}

460 
JEMALLOC_ALWAYS_INLINE
 
´of_tùx_t
 *

461 
	$´of_®loc_´•
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
boŞ
 
´of_aùive
, boŞ 
upd©e
)

463 
´of_tùx_t
 *
»t
;

464 
´of_td©a_t
 *
td©a
;

465 
´of_bt_t
 
bt
;

467 
	`as£¹
(
usize
 =ğ
	`s2u
(usize));

469 ià(!
´of_aùive
 || 
	`lik–y
(
	`´of_§m¶e_accum_upd©e
(
tsd
, 
usize
, 
upd©e
,

470 &
td©a
)))

471 
»t
 = (
´of_tùx_t
 *)(
ušŒ_t
)1U;

473 
	`bt_š™
(&
bt
, 
td©a
->
vec
);

474 
	`´of_backŒaû
(&
bt
);

475 
»t
 = 
	`´of_lookup
(
tsd
, &
bt
);

478  (
»t
);

479 
	}
}

481 
JEMALLOC_ALWAYS_INLINE
 

482 
	$´of_m®loc
(cÚ¡ *
±r
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
)

485 
	`ÿs£¹
(
cÚfig_´of
);

486 
	`as£¹
(
±r
 !ğ
NULL
);

487 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
±r
, 
Œue
));

489 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 > (uintptr_t)1U))

490 
	`´of_m®loc_§m¶e_objeù
(
±r
, 
usize
, 
tùx
);

492 
	`´of_tùx_£t
(
±r
, 
usize
, (
´of_tùx_t
 *)(
ušŒ_t
)1U);

493 
	}
}

495 
JEMALLOC_ALWAYS_INLINE
 

496 
	$´of_»®loc
(
tsd_t
 *
tsd
, cÚ¡ *
±r
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
,

497 
boŞ
 
´of_aùive
, boŞ 
upd©ed
, cÚ¡ *
Şd_±r
, 
size_t
 
Şd_usize
,

498 
´of_tùx_t
 *
Şd_tùx
)

500 
boŞ
 
§m¶ed
, 
Şd_§m¶ed
;

502 
	`ÿs£¹
(
cÚfig_´of
);

503 
	`as£¹
(
±r
 !ğ
NULL
 || (
ušŒ_t
)
tùx
 <= (uintptr_t)1U);

505 ià(
´of_aùive
 && !
upd©ed
 && 
±r
 !ğ
NULL
) {

506 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
±r
, 
Œue
));

507 ià(
	`´of_§m¶e_accum_upd©e
(
tsd
, 
usize
, 
Œue
, 
NULL
)) {

515 
tùx
 = (
´of_tùx_t
 *)(
ušŒ_t
)1U;

519 
§m¶ed
 = ((
ušŒ_t
)
tùx
 > (uintptr_t)1U);

520 
Şd_§m¶ed
 = ((
ušŒ_t
)
Şd_tùx
 > (uintptr_t)1U);

522 ià(
	`uÆik–y
(
§m¶ed
))

523 
	`´of_m®loc_§m¶e_objeù
(
±r
, 
usize
, 
tùx
);

525 
	`´of_tùx_»£t
(
±r
, 
usize
, 
Şd_±r
, 
Şd_tùx
);

527 ià(
	`uÆik–y
(
Şd_§m¶ed
))

528 
	`´of_ä“_§m¶ed_objeù
(
tsd
, 
Şd_usize
, 
Şd_tùx
);

529 
	}
}

531 
JEMALLOC_ALWAYS_INLINE
 

532 
	$´of_ä“
(
tsd_t
 *
tsd
, cÚ¡ *
±r
, 
size_t
 
usize
)

534 
´of_tùx_t
 *
tùx
 = 
	`´of_tùx_g‘
(
±r
);

536 
	`ÿs£¹
(
cÚfig_´of
);

537 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
±r
, 
Œue
));

539 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 > (uintptr_t)1U))

540 
	`´of_ä“_§m¶ed_objeù
(
tsd
, 
usize
, 
tùx
);

541 
	}
}

	@deps/jemalloc/include/jemalloc/internal/public_namespace.h

1 
	#je_m®loc_cÚf
 
	`JEMALLOC_N
(
m®loc_cÚf
)

	)

2 
	#je_m®loc_mes§ge
 
	`JEMALLOC_N
(
m®loc_mes§ge
)

	)

3 
	#je_m®loc
 
	`JEMALLOC_N
(
m®loc
)

	)

4 
	#je_ÿÎoc
 
	`JEMALLOC_N
(
ÿÎoc
)

	)

5 
	#je_posix_mem®ign
 
	`JEMALLOC_N
(
posix_mem®ign
)

	)

6 
	#je_®igÃd_®loc
 
	`JEMALLOC_N
(
®igÃd_®loc
)

	)

7 
	#je_»®loc
 
	`JEMALLOC_N
(
»®loc
)

	)

8 
	#je_ä“
 
	`JEMALLOC_N
(
ä“
)

	)

9 
	#je_m®locx
 
	`JEMALLOC_N
(
m®locx
)

	)

10 
	#je_¿Îocx
 
	`JEMALLOC_N
(
¿Îocx
)

	)

11 
	#je_x®locx
 
	`JEMALLOC_N
(
x®locx
)

	)

12 
	#je_§Îocx
 
	`JEMALLOC_N
(
§Îocx
)

	)

13 
	#je_d®locx
 
	`JEMALLOC_N
(
d®locx
)

	)

14 
	#je_sd®locx
 
	`JEMALLOC_N
(
sd®locx
)

	)

15 
	#je_ÇÎocx
 
	`JEMALLOC_N
(
ÇÎocx
)

	)

16 
	#je_m®lùl
 
	`JEMALLOC_N
(
m®lùl
)

	)

17 
	#je_m®lùÊam‘omib
 
	`JEMALLOC_N
(
m®lùÊam‘omib
)

	)

18 
	#je_m®lùlbymib
 
	`JEMALLOC_N
(
m®lùlbymib
)

	)

19 
	#je_m®loc_¡©s_´št
 
	`JEMALLOC_N
(
m®loc_¡©s_´št
)

	)

20 
	#je_m®loc_u§bË_size
 
	`JEMALLOC_N
(
m®loc_u§bË_size
)

	)

21 
	#je_mem®ign
 
	`JEMALLOC_N
(
mem®ign
)

	)

22 
	#je_v®loc
 
	`JEMALLOC_N
(
v®loc
)

	)

	@deps/jemalloc/include/jemalloc/internal/public_unnamespace.h

1 #undeà
je_m®loc_cÚf


2 #undeà
je_m®loc_mes§ge


3 #undeà
je_m®loc


4 #undeà
je_ÿÎoc


5 #undeà
je_posix_mem®ign


6 #undeà
je_®igÃd_®loc


7 #undeà
je_»®loc


8 #undeà
je_ä“


9 #undeà
je_m®locx


10 #undeà
je_¿Îocx


11 #undeà
je_x®locx


12 #undeà
je_§Îocx


13 #undeà
je_d®locx


14 #undeà
je_sd®locx


15 #undeà
je_ÇÎocx


16 #undeà
je_m®lùl


17 #undeà
je_m®lùÊam‘omib


18 #undeà
je_m®lùlbymib


19 #undeà
je_m®loc_¡©s_´št


20 #undeà
je_m®loc_u§bË_size


21 #undeà
je_mem®ign


22 #undeà
je_v®loc


	@deps/jemalloc/include/jemalloc/internal/ql.h

2 
	#ql_h—d
(
a_ty³
) \

4 
a_ty³
 *
qlh_fœ¡
; \

5 }

	)

7 
	#ql_h—d_š™Ÿliz”
(
a_h—d
è{
NULL
}

	)

9 
	#ql_–m
(
a_ty³
è
	`qr
×_ty³)

	)

12 
	#ql_Ãw
(
a_h—d
) do { \

13 (
a_h—d
)->
qlh_fœ¡
 = 
NULL
; \

14 } 0)

	)

16 
	#ql_–m_Ãw
(
a_–m
, 
a_f›ld
è
	`qr_Ãw
(×_–m),‡_f›ld)

	)

18 
	#ql_fœ¡
(
a_h—d
è(×_h—d)->
qlh_fœ¡
)

	)

20 
	#ql_Ï¡
(
a_h—d
, 
a_f›ld
) \

21 ((
	`ql_fœ¡
(
a_h—d
è!ğ
NULL
) \

22 ? 
	`qr_´ev
(
	`ql_fœ¡
(
a_h—d
), 
a_f›ld
è: 
NULL
)

	)

24 
	#ql_Ãxt
(
a_h—d
, 
a_–m
, 
a_f›ld
) \

25 ((
	`ql_Ï¡
(
a_h—d
, 
a_f›ld
è!ğ(
a_–m
)) \

26 ? 
	`qr_Ãxt
((
a_–m
), 
a_f›ld
è: 
NULL
)

	)

28 
	#ql_´ev
(
a_h—d
, 
a_–m
, 
a_f›ld
) \

29 ((
	`ql_fœ¡
(
a_h—d
è!ğ(
a_–m
)è? 
	`qr_´ev
(×_–m), 
a_f›ld
) \

30 : 
NULL
)

	)

32 
	#ql_befÜe_š£¹
(
a_h—d
, 
a_qËlm
, 
a_–m
, 
a_f›ld
) do { \

33 
	`qr_befÜe_š£¹
((
a_qËlm
), (
a_–m
), 
a_f›ld
); \

34 ià(
	`ql_fœ¡
(
a_h—d
è=ğ(
a_qËlm
)) { \

35 
	`ql_fœ¡
(
a_h—d
èğ(
a_–m
); \

37 } 0)

	)

39 
	#ql_aá”_š£¹
(
a_qËlm
, 
a_–m
, 
a_f›ld
) \

40 
	`qr_aá”_š£¹
((
a_qËlm
), (
a_–m
), 
a_f›ld
)

	)

42 
	#ql_h—d_š£¹
(
a_h—d
, 
a_–m
, 
a_f›ld
) do { \

43 ià(
	`ql_fœ¡
(
a_h—d
è!ğ
NULL
) { \

44 
	`qr_befÜe_š£¹
(
	`ql_fœ¡
(
a_h—d
), (
a_–m
), 
a_f›ld
); \

46 
	`ql_fœ¡
(
a_h—d
èğ(
a_–m
); \

47 } 0)

	)

49 
	#ql__š£¹
(
a_h—d
, 
a_–m
, 
a_f›ld
) do { \

50 ià(
	`ql_fœ¡
(
a_h—d
è!ğ
NULL
) { \

51 
	`qr_befÜe_š£¹
(
	`ql_fœ¡
(
a_h—d
), (
a_–m
), 
a_f›ld
); \

53 
	`ql_fœ¡
(
a_h—d
èğ
	`qr_Ãxt
((
a_–m
), 
a_f›ld
); \

54 } 0)

	)

56 
	#ql_»move
(
a_h—d
, 
a_–m
, 
a_f›ld
) do { \

57 ià(
	`ql_fœ¡
(
a_h—d
è=ğ(
a_–m
)) { \

58 
	`ql_fœ¡
(
a_h—d
èğ
	`qr_Ãxt
(ql_fœ¡×_h—d), 
a_f›ld
); \

60 ià(
	`ql_fœ¡
(
a_h—d
è!ğ(
a_–m
)) { \

61 
	`qr_»move
((
a_–m
), 
a_f›ld
); \

63 
	`ql_fœ¡
(
a_h—d
èğ
NULL
; \

65 } 0)

	)

67 
	#ql_h—d_»move
(
a_h—d
, 
a_ty³
, 
a_f›ld
) do { \

68 
a_ty³
 *
t
 = 
	`ql_fœ¡
(
a_h—d
); \

69 
	`ql_»move
((
a_h—d
), 
t
, 
a_f›ld
); \

70 } 0)

	)

72 
	#ql__»move
(
a_h—d
, 
a_ty³
, 
a_f›ld
) do { \

73 
a_ty³
 *
t
 = 
	`ql_Ï¡
(
a_h—d
, 
a_f›ld
); \

74 
	`ql_»move
((
a_h—d
), 
t
, 
a_f›ld
); \

75 } 0)

	)

77 
	#ql_fÜ—ch
(
a_v¬
, 
a_h—d
, 
a_f›ld
) \

78 
	`qr_fÜ—ch
((
a_v¬
), 
	`ql_fœ¡
(
a_h—d
), 
a_f›ld
)

	)

80 
	#ql_»v”£_fÜ—ch
(
a_v¬
, 
a_h—d
, 
a_f›ld
) \

81 
	`qr_»v”£_fÜ—ch
((
a_v¬
), 
	`ql_fœ¡
(
a_h—d
), 
a_f›ld
)

	)

	@deps/jemalloc/include/jemalloc/internal/qr.h

2 
	#qr
(
a_ty³
) \

4 
a_ty³
 *
q»_Ãxt
; \

5 
a_ty³
 *
q»_´ev
; \

6 }

	)

9 
	#qr_Ãw
(
a_qr
, 
a_f›ld
) do { \

10 (
a_qr
)->
a_f›ld
.
q»_Ãxt
 = (a_qr); \

11 (
a_qr
)->
a_f›ld
.
q»_´ev
 = (a_qr); \

12 } 0)

	)

14 
	#qr_Ãxt
(
a_qr
, 
a_f›ld
è(×_qr)->a_f›ld.
q»_Ãxt
)

	)

16 
	#qr_´ev
(
a_qr
, 
a_f›ld
è(×_qr)->a_f›ld.
q»_´ev
)

	)

18 
	#qr_befÜe_š£¹
(
a_q»lm
, 
a_qr
, 
a_f›ld
) do { \

19 (
a_qr
)->
a_f›ld
.
q»_´ev
 = (
a_q»lm
)->a_field.qre_prev; \

20 (
a_qr
)->
a_f›ld
.
q»_Ãxt
 = (
a_q»lm
); \

21 (
a_qr
)->
a_f›ld
.
q»_´ev
->a_f›ld.
q»_Ãxt
 = (a_qr); \

22 (
a_q»lm
)->
a_f›ld
.
q»_´ev
 = (
a_qr
); \

23 } 0)

	)

25 
	#qr_aá”_š£¹
(
a_q»lm
, 
a_qr
, 
a_f›ld
) \

28 (
a_qr
)->
a_f›ld
.
q»_Ãxt
 = (
a_q»lm
)->a_field.qre_next; \

29 (
a_qr
)->
a_f›ld
.
q»_´ev
 = (
a_q»lm
); \

30 (
a_qr
)->
a_f›ld
.
q»_Ãxt
->a_f›ld.
q»_´ev
 = (a_qr); \

31 (
a_q»lm
)->
a_f›ld
.
q»_Ãxt
 = (
a_qr
); \

32 } 0)

	)

34 
	#qr_m–d
(
a_qr_a
, 
a_qr_b
, 
a_f›ld
) do { \

35 *
t
; \

36 (
a_qr_a
)->
a_f›ld
.
q»_´ev
->a_f›ld.
q»_Ãxt
 = (
a_qr_b
); \

37 (
a_qr_b
)->
a_f›ld
.
q»_´ev
->a_f›ld.
q»_Ãxt
 = (
a_qr_a
); \

38 
t
 = (
a_qr_a
)->
a_f›ld
.
q»_´ev
; \

39 (
a_qr_a
)->
a_f›ld
.
q»_´ev
 = (
a_qr_b
)->a_field.qre_prev; \

40 (
a_qr_b
)->
a_f›ld
.
q»_´ev
 = 
t
; \

41 } 0)

	)

47 
	#qr_¥l™
(
a_qr_a
, 
a_qr_b
, 
a_f›ld
) \

48 
	`qr_m–d
((
a_qr_a
), (
a_qr_b
), 
a_f›ld
)

	)

50 
	#qr_»move
(
a_qr
, 
a_f›ld
) do { \

51 (
a_qr
)->
a_f›ld
.
q»_´ev
->a_f›ld.
q»_Ãxt
 \

52 ğ(
a_qr
)->
a_f›ld
.
q»_Ãxt
; \

53 (
a_qr
)->
a_f›ld
.
q»_Ãxt
->a_f›ld.
q»_´ev
 \

54 ğ(
a_qr
)->
a_f›ld
.
q»_´ev
; \

55 (
a_qr
)->
a_f›ld
.
q»_Ãxt
 = (a_qr); \

56 (
a_qr
)->
a_f›ld
.
q»_´ev
 = (a_qr); \

57 } 0)

	)

59 
	#qr_fÜ—ch
(
v¬
, 
a_qr
, 
a_f›ld
) \

60 (
v¬
èğ(
a_qr
); \

61 (
v¬
è!ğ
NULL
; \

62 (
v¬
èğ(((v¬)->
a_f›ld
.
q»_Ãxt
 !ğ(
a_qr
)) \

63 ? (
v¬
)->
a_f›ld
.
q»_Ãxt
 : 
NULL
))

	)

65 
	#qr_»v”£_fÜ—ch
(
v¬
, 
a_qr
, 
a_f›ld
) \

66 (
v¬
èğ((
a_qr
è!ğ
NULL
è? 
	`qr_´ev
×_qr, 
a_f›ld
) : NULL; \

67 (
v¬
è!ğ
NULL
; \

68 (
v¬
èğ(((v¬è!ğ(
a_qr
)) \

69 ? (
v¬
)->
a_f›ld
.
q»_´ev
 : 
NULL
))

	)

	@deps/jemalloc/include/jemalloc/internal/quarantine.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
qu¬ªtše_obj_s
 
	tqu¬ªtše_obj_t
;

5 
qu¬ªtše_s
 
	tqu¬ªtše_t
;

8 
	#JEMALLOC_VALGRIND_QUARANTINE_DEFAULT
 (
	`ZU
(1è<< 24)

	)

12 #ifdeà
JEMALLOC_H_STRUCTS


14 
	squ¬ªtše_obj_s
 {

15 *
	m±r
;

16 
size_t
 
	musize
;

19 
	squ¬ªtše_s
 {

20 
size_t
 
	mcurby‹s
;

21 
size_t
 
	mcurobjs
;

22 
size_t
 
	mfœ¡
;

23 
	#LG_MAXOBJS_INIT
 10

	)

24 
size_t
 
	mlg_maxobjs
;

25 
qu¬ªtše_obj_t
 
	mobjs
[1];

30 #ifdeà
JEMALLOC_H_EXTERNS


32 
qu¬ªtše_®loc_hook_wÜk
(
tsd_t
 *
tsd
);

33 
qu¬ªtše
(
tsd_t
 *
tsd
, *
±r
);

34 
qu¬ªtše_ş—nup
(
tsd_t
 *
tsd
);

38 #ifdeà
JEMALLOC_H_INLINES


40 #iâdeà
JEMALLOC_ENABLE_INLINE


41 
qu¬ªtše_®loc_hook
();

44 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_QUARANTINE_C_
))

45 
JEMALLOC_ALWAYS_INLINE
 

46 
	$qu¬ªtše_®loc_hook
()

48 
tsd_t
 *
tsd
;

50 
	`as£¹
(
cÚfig_fl
 && 
İt_qu¬ªtše
);

52 
tsd
 = 
	`tsd_ãtch
();

53 ià(
	`tsd_qu¬ªtše_g‘
(
tsd
è=ğ
NULL
)

54 
	`qu¬ªtše_®loc_hook_wÜk
(
tsd
);

55 
	}
}

	@deps/jemalloc/include/jemalloc/internal/rb.h

22 #iâdeà
RB_H_


23 
	#RB_H_


	)

25 #ifdeà
RB_COMPACT


27 
	#rb_node
(
a_ty³
) \

29 
a_ty³
 *
rbn_Ëá
; \

30 
a_ty³
 *
rbn_right_»d
; \

31 }

	)

33 
	#rb_node
(
a_ty³
) \

35 
a_ty³
 *
rbn_Ëá
; \

36 
a_ty³
 *
rbn_right
; \

37 
boŞ
 
rbn_»d
; \

38 }

	)

42 
	#rb_Œ“
(
a_ty³
) \

44 
a_ty³
 *
rbt_roÙ
; \

45 
a_ty³
 
rbt_n
; \

46 }

	)

49 
	#rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
a_node
) \

50 ((
a_node
)->
a_f›ld
.
rbn_Ëá
)

	)

51 
	#rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
a_node
, 
a_Ëá
) do { \

52 (
a_node
)->
a_f›ld
.
rbn_Ëá
 = 
a_Ëá
; \

53 } 0)

	)

55 #ifdeà
RB_COMPACT


57 
	#rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
a_node
) \

58 ((
a_ty³
 *è(((
šŒ_t
è(
a_node
)->
a_f›ld
.
rbn_right_»d
) \

59 & ((
ssize_t
)-2)))

	)

60 
	#rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
a_node
, 
a_right
) do { \

61 (
a_node
)->
a_f›ld
.
rbn_right_»d
 = (
a_ty³
 *è(((
ušŒ_t
è
a_right
) \

62 | (((
ušŒ_t
è(
a_node
)->
a_f›ld
.
rbn_right_»d
è& ((
size_t
)1))); \

63 } 0)

	)

66 
	#rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
a_node
) \

67 ((
boŞ
è(((
ušŒ_t
è(
a_node
)->
a_f›ld
.
rbn_right_»d
) \

68 & ((
size_t
)1)))

	)

69 
	#rbŠ_cŞÜ_£t
(
a_ty³
, 
a_f›ld
, 
a_node
, 
a_»d
) do { \

70 (
a_node
)->
a_f›ld
.
rbn_right_»d
 = (
a_ty³
 *è((((
šŒ_t
) \

71 (
a_node
)->
a_f›ld
.
rbn_right_»d
è& ((
ssize_t
)-2)) \

72 | ((
ssize_t
)
a_»d
)); \

73 } 0)

	)

74 
	#rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
a_node
) do { \

75 (
a_node
)->
a_f›ld
.
rbn_right_»d
 = (
a_ty³
 *è(((
ušŒ_t
) \

76 (
a_node
)->
a_f›ld
.
rbn_right_»d
è| ((
size_t
)1)); \

77 } 0)

	)

78 
	#rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
a_node
) do { \

79 (
a_node
)->
a_f›ld
.
rbn_right_»d
 = (
a_ty³
 *è(((
šŒ_t
) \

80 (
a_node
)->
a_f›ld
.
rbn_right_»d
è& ((
ssize_t
)-2)); \

81 } 0)

	)

84 
	#rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
a_node
) \

85 ((
a_node
)->
a_f›ld
.
rbn_right
)

	)

86 
	#rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
a_node
, 
a_right
) do { \

87 (
a_node
)->
a_f›ld
.
rbn_right
 = 
a_right
; \

88 } 0)

	)

91 
	#rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
a_node
) \

92 ((
a_node
)->
a_f›ld
.
rbn_»d
)

	)

93 
	#rbŠ_cŞÜ_£t
(
a_ty³
, 
a_f›ld
, 
a_node
, 
a_»d
) do { \

94 (
a_node
)->
a_f›ld
.
rbn_»d
 = (
a_»d
); \

95 } 0)

	)

96 
	#rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
a_node
) do { \

97 (
a_node
)->
a_f›ld
.
rbn_»d
 = 
Œue
; \

98 } 0)

	)

99 
	#rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
a_node
) do { \

100 (
a_node
)->
a_f›ld
.
rbn_»d
 = 
çl£
; \

101 } 0)

	)

105 
	#rbt_node_Ãw
(
a_ty³
, 
a_f›ld
, 
a_rbt
, 
a_node
) do { \

106 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, (
a_node
), &(
a_rbt
)->
rbt_n
); \

107 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, (
a_node
), &(
a_rbt
)->
rbt_n
); \

108 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, (
a_node
)); \

109 } 0)

	)

112 
	#rb_Ãw
(
a_ty³
, 
a_f›ld
, 
a_rbt
) do { \

113 (
a_rbt
)->
rbt_roÙ
 = &×_rbt)->
rbt_n
; \

114 
	`rbt_node_Ãw
(
a_ty³
, 
a_f›ld
, 
a_rbt
, &×_rbt)->
rbt_n
); \

115 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, &(
a_rbt
)->
rbt_n
); \

116 } 0)

	)

119 
	#rbŠ_fœ¡
(
a_ty³
, 
a_f›ld
, 
a_rbt
, 
a_roÙ
, 
r_node
) do { \

120 (
r_node
èğ(
a_roÙ
); \

121 ià((
r_node
è!ğ&(
a_rbt
)->
rbt_n
) { \

123 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, (
r_node
)è!ğ&(
a_rbt
)->
rbt_n
;\

124 (
r_node
èğ
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, (r_node))) { \

127 } 0)

	)

129 
	#rbŠ_Ï¡
(
a_ty³
, 
a_f›ld
, 
a_rbt
, 
a_roÙ
, 
r_node
) do { \

130 (
r_node
èğ(
a_roÙ
); \

131 ià((
r_node
è!ğ&(
a_rbt
)->
rbt_n
) { \

132 ; 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, (
r_node
)) != \

133 &(
a_rbt
)->
rbt_n
; (
r_node
èğ
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, \

134 (
r_node
))) { \

137 } 0)

	)

139 
	#rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
a_node
, 
r_node
) do { \

140 (
r_node
èğ
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, (
a_node
)); \

141 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, (
a_node
), \

142 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, (
r_node
))); \

143 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, (
r_node
), (
a_node
)); \

144 } 0)

	)

146 
	#rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
a_node
, 
r_node
) do { \

147 (
r_node
èğ
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, (
a_node
)); \

148 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, (
a_node
), \

149 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, (
r_node
))); \

150 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, (
r_node
), (
a_node
)); \

151 } 0)

	)

158 
	#rb_´Ùo
(
a_©Œ
, 
a_´efix
, 
a_rbt_ty³
, 
a_ty³
) \

159 
a_©Œ
 \

160 
a_´efix
##
	`Ãw
(
a_rbt_ty³
 *
rbŒ“
); \

161 
a_©Œ
 
boŞ
 \

162 
a_´efix
##
	`em±y
(
a_rbt_ty³
 *
rbŒ“
); \

163 
a_©Œ
 
a_ty³
 * \

164 
a_´efix
##
	`fœ¡
(
a_rbt_ty³
 *
rbŒ“
); \

165 
a_©Œ
 
a_ty³
 * \

166 
a_´efix
##
	`Ï¡
(
a_rbt_ty³
 *
rbŒ“
); \

167 
a_©Œ
 
a_ty³
 * \

168 
a_´efix
##
	`Ãxt
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
); \

169 
a_©Œ
 
a_ty³
 * \

170 
a_´efix
##
	`´ev
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
); \

171 
a_©Œ
 
a_ty³
 * \

172 
a_´efix
##
	`£¬ch
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
key
); \

173 
a_©Œ
 
a_ty³
 * \

174 
a_´efix
##
	`n£¬ch
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
key
); \

175 
a_©Œ
 
a_ty³
 * \

176 
a_´efix
##
	`p£¬ch
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
key
); \

177 
a_©Œ
 \

178 
a_´efix
##
	`š£¹
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
); \

179 
a_©Œ
 \

180 
a_´efix
##
	`»move
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
); \

181 
a_©Œ
 
a_ty³
 * \

182 
a_´efix
##
	`™”
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
,‡_ty³ *(*
cb
)( \

183 
a_rbt_ty³
 *, 
a_ty³
 *, *), *
¬g
); \

184 
a_©Œ
 
a_ty³
 * \

185 
a_´efix
##
	`»v”£_™”
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
, \

186 
a_ty³
 *(*
cb
)(
a_rbt_ty³
 *,‡_ty³ *, *), *
¬g
);

	)

316 
	#rb_g’
(
a_©Œ
, 
a_´efix
, 
a_rbt_ty³
, 
a_ty³
, 
a_f›ld
, 
a_cmp
) \

317 
a_©Œ
 \

318 
a_´efix
##
	`Ãw
(
a_rbt_ty³
 *
rbŒ“
) { \

319 
	`rb_Ãw
(
a_ty³
, 
a_f›ld
, 
rbŒ“
); \

321 
a_©Œ
 
boŞ
 \

322 
a_´efix
##
	`em±y
(
a_rbt_ty³
 *
rbŒ“
) { \

323  (
rbŒ“
->
rbt_roÙ
 =ğ&rbŒ“->
rbt_n
); \

325 
a_©Œ
 
a_ty³
 * \

326 
a_´efix
##
	`fœ¡
(
a_rbt_ty³
 *
rbŒ“
) { \

327 
a_ty³
 *
»t
; \

328 
	`rbŠ_fœ¡
(
a_ty³
, 
a_f›ld
, 
rbŒ“
,„bŒ“->
rbt_roÙ
, 
»t
); \

329 ià(
»t
 =ğ&
rbŒ“
->
rbt_n
) { \

330 
»t
 = 
NULL
; \

332  (
»t
); \

334 
a_©Œ
 
a_ty³
 * \

335 
a_´efix
##
	`Ï¡
(
a_rbt_ty³
 *
rbŒ“
) { \

336 
a_ty³
 *
»t
; \

337 
	`rbŠ_Ï¡
(
a_ty³
, 
a_f›ld
, 
rbŒ“
,„bŒ“->
rbt_roÙ
, 
»t
); \

338 ià(
»t
 =ğ&
rbŒ“
->
rbt_n
) { \

339 
»t
 = 
NULL
; \

341  (
»t
); \

343 
a_©Œ
 
a_ty³
 * \

344 
a_´efix
##
	`Ãxt
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
) { \

345 
a_ty³
 *
»t
; \

346 ià(
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
node
è!ğ&
rbŒ“
->
rbt_n
) { \

347 
	`rbŠ_fœ¡
(
a_ty³
, 
a_f›ld
, 
rbŒ“
, 
	`rbŠ_right_g‘
(a_type, \

348 
a_f›ld
, 
node
), 
»t
); \

350 
a_ty³
 *
Šode
 = 
rbŒ“
->
rbt_roÙ
; \

351 
	`as£¹
(
Šode
 !ğ&
rbŒ“
->
rbt_n
); \

352 
»t
 = &
rbŒ“
->
rbt_n
; \

353 
Œue
) { \

354 
cmp
 = (
a_cmp
)(
node
, 
Šode
); \

355 ià(
cmp
 < 0) { \

356 
»t
 = 
Šode
; \

357 
Šode
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,node); \

358 } ià(
cmp
 > 0) { \

359 
Šode
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
,node); \

363 
	`as£¹
(
Šode
 !ğ&
rbŒ“
->
rbt_n
); \

366 ià(
»t
 =ğ&
rbŒ“
->
rbt_n
) { \

367 
»t
 = (
NULL
); \

369  (
»t
); \

371 
a_©Œ
 
a_ty³
 * \

372 
a_´efix
##
	`´ev
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
) { \

373 
a_ty³
 *
»t
; \

374 ià(
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
è!ğ&
rbŒ“
->
rbt_n
) { \

375 
	`rbŠ_Ï¡
(
a_ty³
, 
a_f›ld
, 
rbŒ“
, 
	`rbŠ_Ëá_g‘
(a_type, \

376 
a_f›ld
, 
node
), 
»t
); \

378 
a_ty³
 *
Šode
 = 
rbŒ“
->
rbt_roÙ
; \

379 
	`as£¹
(
Šode
 !ğ&
rbŒ“
->
rbt_n
); \

380 
»t
 = &
rbŒ“
->
rbt_n
; \

381 
Œue
) { \

382 
cmp
 = (
a_cmp
)(
node
, 
Šode
); \

383 ià(
cmp
 < 0) { \

384 
Šode
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,node); \

385 } ià(
cmp
 > 0) { \

386 
»t
 = 
Šode
; \

387 
Šode
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
,node); \

391 
	`as£¹
(
Šode
 !ğ&
rbŒ“
->
rbt_n
); \

394 ià(
»t
 =ğ&
rbŒ“
->
rbt_n
) { \

395 
»t
 = (
NULL
); \

397  (
»t
); \

399 
a_©Œ
 
a_ty³
 * \

400 
a_´efix
##
	`£¬ch
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
key
) { \

401 
a_ty³
 *
»t
; \

402 
cmp
; \

403 
»t
 = 
rbŒ“
->
rbt_roÙ
; \

404 
»t
 !ğ&
rbŒ“
->
rbt_n
 \

405 && (
cmp
 = (
a_cmp
)(
key
, 
»t
)) != 0) { \

406 ià(
cmp
 < 0) { \

407 
»t
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,„et); \

409 
»t
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
,„et); \

412 ià(
»t
 =ğ&
rbŒ“
->
rbt_n
) { \

413 
»t
 = (
NULL
); \

415  (
»t
); \

417 
a_©Œ
 
a_ty³
 * \

418 
a_´efix
##
	`n£¬ch
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
key
) { \

419 
a_ty³
 *
»t
; \

420 
a_ty³
 *
Šode
 = 
rbŒ“
->
rbt_roÙ
; \

421 
»t
 = &
rbŒ“
->
rbt_n
; \

422 
Šode
 !ğ&
rbŒ“
->
rbt_n
) { \

423 
cmp
 = (
a_cmp
)(
key
, 
Šode
); \

424 ià(
cmp
 < 0) { \

425 
»t
 = 
Šode
; \

426 
Šode
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,node); \

427 } ià(
cmp
 > 0) { \

428 
Šode
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
,node); \

430 
»t
 = 
Šode
; \

434 ià(
»t
 =ğ&
rbŒ“
->
rbt_n
) { \

435 
»t
 = (
NULL
); \

437  (
»t
); \

439 
a_©Œ
 
a_ty³
 * \

440 
a_´efix
##
	`p£¬ch
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
key
) { \

441 
a_ty³
 *
»t
; \

442 
a_ty³
 *
Šode
 = 
rbŒ“
->
rbt_roÙ
; \

443 
»t
 = &
rbŒ“
->
rbt_n
; \

444 
Šode
 !ğ&
rbŒ“
->
rbt_n
) { \

445 
cmp
 = (
a_cmp
)(
key
, 
Šode
); \

446 ià(
cmp
 < 0) { \

447 
Šode
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,node); \

448 } ià(
cmp
 > 0) { \

449 
»t
 = 
Šode
; \

450 
Šode
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
,node); \

452 
»t
 = 
Šode
; \

456 ià(
»t
 =ğ&
rbŒ“
->
rbt_n
) { \

457 
»t
 = (
NULL
); \

459  (
»t
); \

461 
a_©Œ
 \

462 
a_´efix
##
	`š£¹
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
) { \

464 
a_ty³
 *
node
; \

465 
cmp
; \

466 } 
·th
[(*è<< 4], *
·thp
; \

467 
	`rbt_node_Ãw
(
a_ty³
, 
a_f›ld
, 
rbŒ“
, 
node
); \

469 
·th
->
node
 = 
rbŒ“
->
rbt_roÙ
; \

470 
·thp
 = 
·th
;…©hp->
node
 !ğ&
rbŒ“
->
rbt_n
;…athp++) { \

471 
cmp
 = 
·thp
->cm°ğ
	`a_cmp
(
node
,…athp->node); \

472 
	`as£¹
(
cmp
 != 0); \

473 ià(
cmp
 < 0) { \

474 
·thp
[1].
node
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, \

475 
·thp
->
node
); \

477 
·thp
[1].
node
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, \

478 
·thp
->
node
); \

481 
·thp
->
node
 =‚ode; \

483 
·thp
--; (
ušŒ_t
í©h°>ğ(ušŒ_t)
·th
;…athp--) { \

484 
a_ty³
 *
úode
 = 
·thp
->
node
; \

485 ià(
·thp
->
cmp
 < 0) { \

486 
a_ty³
 *
Ëá
 = 
·thp
[1].
node
; \

487 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
úode
, 
Ëá
); \

488 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
Ëá
)) { \

489 
a_ty³
 *
ËáËá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, 
Ëá
);\

490 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
ËáËá
)) { \

492 
a_ty³
 *
Šode
; \

493 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
ËáËá
); \

494 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
úode
, 
Šode
); \

495 
úode
 = 
Šode
; \

501 
a_ty³
 *
right
 = 
·thp
[1].
node
; \

502 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
úode
, 
right
); \

503 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
right
)) { \

504 
a_ty³
 *
Ëá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, 
úode
); \

505 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
Ëá
)) { \

507 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
Ëá
); \

508 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
right
); \

509 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
úode
); \

512 
a_ty³
 *
Šode
; \

513 
boŞ
 
Œed
 = 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
úode
); \

514 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
úode
, 
Šode
); \

515 
	`rbŠ_cŞÜ_£t
(
a_ty³
, 
a_f›ld
, 
Šode
, 
Œed
); \

516 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
úode
); \

517 
úode
 = 
Šode
; \

523 
·thp
->
node
 = 
úode
; \

526 
rbŒ“
->
rbt_roÙ
 = 
·th
->
node
; \

527 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
rbŒ“
->
rbt_roÙ
); \

529 
a_©Œ
 \

530 
a_´efix
##
	`»move
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
) { \

532 
a_ty³
 *
node
; \

533 
cmp
; \

534 } *
·thp
, *
nod•
, 
·th
[(*) << 4]; \

536 
nod•
 = 
NULL
; \

537 
·th
->
node
 = 
rbŒ“
->
rbt_roÙ
; \

538 
·thp
 = 
·th
;…©hp->
node
 !ğ&
rbŒ“
->
rbt_n
;…athp++) { \

539 
cmp
 = 
·thp
->cm°ğ
	`a_cmp
(
node
,…athp->node); \

540 ià(
cmp
 < 0) { \

541 
·thp
[1].
node
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, \

542 
·thp
->
node
); \

544 
·thp
[1].
node
 = 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, \

545 
·thp
->
node
); \

546 ià(
cmp
 == 0) { \

548 
·thp
->
cmp
 = 1; \

549 
nod•
 = 
·thp
; \

550 
·thp
++;…©hp->
node
 !ğ&
rbŒ“
->
rbt_n
; \

551 
·thp
++) { \

552 
·thp
->
cmp
 = -1; \

553 
·thp
[1].
node
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, \

554 
·thp
->
node
); \

560 
	`as£¹
(
nod•
->
node
 ==‚ode); \

561 
·thp
--; \

562 ià(
·thp
->
node
 !=‚ode) { \

564 
boŞ
 
Œed
 = 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

565 
	`rbŠ_cŞÜ_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

566 
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
node
)); \

567 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

568 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
)); \

573 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

574 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
node
)); \

575 
	`rbŠ_cŞÜ_£t
(
a_ty³
, 
a_f›ld
, 
node
, 
Œed
); \

578 
nod•
->
node
 = 
·thp
->node; \

579 
·thp
->
node
 =‚ode; \

580 ià(
nod•
 =ğ
·th
) { \

581 
rbŒ“
->
rbt_roÙ
 = 
nod•
->
node
; \

583 ià(
nod•
[-1].
cmp
 < 0) { \

584 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
nod•
[-1].
node
, \

585 
nod•
->
node
); \

587 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
nod•
[-1].
node
, \

588 
nod•
->
node
); \

592 
a_ty³
 *
Ëá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, 
node
); \

593 ià(
Ëá
 !ğ&
rbŒ“
->
rbt_n
) { \

596 
	`as£¹
(!
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
node
)); \

597 
	`as£¹
(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
Ëá
)); \

598 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
Ëá
); \

599 ià(
·thp
 =ğ
·th
) { \

600 
rbŒ“
->
rbt_roÙ
 = 
Ëá
; \

602 ià(
·thp
[-1].
cmp
 < 0) { \

603 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

604 
Ëá
); \

606 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

607 
Ëá
); \

611 } ià(
·thp
 =ğ
·th
) { \

613 
rbŒ“
->
rbt_roÙ
 = &rbŒ“->
rbt_n
; \

617 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
)) { \

619 
	`as£¹
(
·thp
[-1].
cmp
 < 0); \

620 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

621 &
rbŒ“
->
rbt_n
); \

626 
·thp
->
node
 = &
rbŒ“
->
rbt_n
; \

627 
·thp
--; (
ušŒ_t
í©h°>ğ(ušŒ_t)
·th
;…athp--) { \

628 
	`as£¹
(
·thp
->
cmp
 != 0); \

629 ià(
·thp
->
cmp
 < 0) { \

630 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

631 
·thp
[1].
node
); \

632 
	`as£¹
(!
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
·thp
[1].
node
)); \

633 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
)) { \

634 
a_ty³
 *
right
 = 
	`rbŠ_right_g‘
×_ty³, 
a_f›ld
, \

635 
·thp
->
node
); \

636 
a_ty³
 *
righeá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, \

637 
right
); \

638 
a_ty³
 *
Šode
; \

639 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
righeá
)) { \

650 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

651 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
right
, 
Šode
); \

652 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, 
Šode
);\

653 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

654 
Šode
); \

663 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

664 
Šode
); \

668 
	`as£¹
((
ušŒ_t
)
·thp
 > (ušŒ_t)
·th
); \

669 ià(
·thp
[-1].
cmp
 < 0) { \

670 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

671 
Šode
); \

673 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

674 
Šode
); \

678 
a_ty³
 *
right
 = 
	`rbŠ_right_g‘
×_ty³, 
a_f›ld
, \

679 
·thp
->
node
); \

680 
a_ty³
 *
righeá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, \

681 
right
); \

682 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
righeá
)) { \

689 
a_ty³
 *
Šode
; \

690 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
righeá
); \

691 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
right
, 
Šode
); \

692 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, 
Šode
);\

693 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

694 
Šode
); \

698 ià(
·thp
 =ğ
·th
) { \

700 
rbŒ“
->
rbt_roÙ
 = 
Šode
; \

702 ià(
·thp
[-1].
cmp
 < 0) { \

703 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, \

704 
·thp
[-1].
node
, 
Šode
); \

706 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, \

707 
·thp
[-1].
node
, 
Šode
); \

718 
a_ty³
 *
Šode
; \

719 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

720 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

721 
Šode
); \

722 
·thp
->
node
 = 
Šode
; \

726 
a_ty³
 *
Ëá
; \

727 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

728 
·thp
[1].
node
); \

729 
Ëá
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

730 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
Ëá
)) { \

731 
a_ty³
 *
Šode
; \

732 
a_ty³
 *
Ëáright
 = 
	`rbŠ_right_g‘
×_ty³, 
a_f›ld
, \

733 
Ëá
); \

734 
a_ty³
 *
Ëárigheá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, \

735 
Ëáright
); \

736 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
Ëárigheá
)) { \

745 
a_ty³
 *
unode
; \

746 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
Ëárigheá
); \

747 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

748 
unode
); \

749 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

750 
Šode
); \

751 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
unode
, 
Šode
); \

752 
	`rbŠ_rÙ©e_Ëá
(
a_ty³
, 
a_f›ld
, 
unode
, 
Šode
); \

762 
	`as£¹
(
Ëáright
 !ğ&
rbŒ“
->
rbt_n
); \

763 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
Ëáright
); \

764 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

765 
Šode
); \

766 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
Šode
); \

770 ià(
·thp
 =ğ
·th
) { \

772 
rbŒ“
->
rbt_roÙ
 = 
Šode
; \

774 ià(
·thp
[-1].
cmp
 < 0) { \

775 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

776 
Šode
); \

778 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

779 
Šode
); \

783 } ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
)) { \

784 
a_ty³
 *
ËáËá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, 
Ëá
);\

785 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
ËáËá
)) { \

792 
a_ty³
 *
Šode
; \

793 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

794 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
Ëá
); \

795 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
ËáËá
); \

796 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

797 
Šode
); \

800 
	`as£¹
((
ušŒ_t
)
·thp
 > (ušŒ_t)
·th
); \

801 ià(
·thp
[-1].
cmp
 < 0) { \

802 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

803 
Šode
); \

805 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, 
·thp
[-1].
node
, \

806 
Šode
); \

816 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
Ëá
); \

817 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
); \

822 
a_ty³
 *
ËáËá
 = 
	`rbŠ_Ëá_g‘
×_ty³, 
a_f›ld
, 
Ëá
);\

823 ià(
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
ËáËá
)) { \

830 
a_ty³
 *
Šode
; \

831 
	`rbŠ_bÏck_£t
(
a_ty³
, 
a_f›ld
, 
ËáËá
); \

832 
	`rbŠ_rÙ©e_right
(
a_ty³
, 
a_f›ld
, 
·thp
->
node
, \

833 
Šode
); \

837 ià(
·thp
 =ğ
·th
) { \

839 
rbŒ“
->
rbt_roÙ
 = 
Šode
; \

841 ià(
·thp
[-1].
cmp
 < 0) { \

842 
	`rbŠ_Ëá_£t
(
a_ty³
, 
a_f›ld
, \

843 
·thp
[-1].
node
, 
Šode
); \

845 
	`rbŠ_right_£t
(
a_ty³
, 
a_f›ld
, \

846 
·thp
[-1].
node
, 
Šode
); \

857 
	`rbŠ_»d_£t
(
a_ty³
, 
a_f›ld
, 
Ëá
); \

863 
rbŒ“
->
rbt_roÙ
 = 
·th
->
node
; \

864 
	`as£¹
(!
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
rbŒ“
->
rbt_roÙ
)); \

866 
a_©Œ
 
a_ty³
 * \

867 
a_´efix
##
	`™”_»cur£
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
, \

868 
a_ty³
 *(*
cb
)(
a_rbt_ty³
 *,‡_ty³ *, *), *
¬g
) { \

869 ià(
node
 =ğ&
rbŒ“
->
rbt_n
) { \

870  (&
rbŒ“
->
rbt_n
); \

872 
a_ty³
 *
»t
; \

873 ià((
»t
 = 
a_´efix
##
	`™”_»cur£
(
rbŒ“
, 
	`rbŠ_Ëá_g‘
(
a_ty³
, \

874 
a_f›ld
, 
node
), 
cb
, 
¬g
)è!ğ&
rbŒ“
->
rbt_n
 \

875 || (
»t
 = 
	`cb
(
rbŒ“
, 
node
, 
¬g
)è!ğ
NULL
) { \

876  (
»t
); \

878  (
a_´efix
##
	`™”_»cur£
(
rbŒ“
, 
	`rbŠ_right_g‘
(
a_ty³
, \

879 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

882 
a_©Œ
 
a_ty³
 * \

883 
a_´efix
##
	`™”_¡¬t
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
,‡_ty³ *
node
, \

884 
a_ty³
 *(*
cb
)(
a_rbt_ty³
 *,‡_ty³ *, *), *
¬g
) { \

885 
cmp
 = 
	`a_cmp
(
¡¬t
, 
node
); \

886 ià(
cmp
 < 0) { \

887 
a_ty³
 *
»t
; \

888 ià((
»t
 = 
a_´efix
##
	`™”_¡¬t
(
rbŒ“
, 
¡¬t
, \

889 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)) != \

890 &
rbŒ“
->
rbt_n
 || (
»t
 = 
	`cb
ÔbŒ“, 
node
, 
¬g
)è!ğ
NULL
) { \

891  (
»t
); \

893  (
a_´efix
##
	`™”_»cur£
(
rbŒ“
, 
	`rbŠ_right_g‘
(
a_ty³
, \

894 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

895 } ià(
cmp
 > 0) { \

896  (
a_´efix
##
	`™”_¡¬t
(
rbŒ“
, 
¡¬t
, \

897 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

899 
a_ty³
 *
»t
; \

900 ià((
»t
 = 
	`cb
(
rbŒ“
, 
node
, 
¬g
)è!ğ
NULL
) { \

901  (
»t
); \

903  (
a_´efix
##
	`™”_»cur£
(
rbŒ“
, 
	`rbŠ_right_g‘
(
a_ty³
, \

904 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

907 
a_©Œ
 
a_ty³
 * \

908 
a_´efix
##
	`™”
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
,‡_ty³ *(*
cb
)( \

909 
a_rbt_ty³
 *, 
a_ty³
 *, *), *
¬g
) { \

910 
a_ty³
 *
»t
; \

911 ià(
¡¬t
 !ğ
NULL
) { \

912 
»t
 = 
a_´efix
##
	`™”_¡¬t
(
rbŒ“
, 
¡¬t
,„bŒ“->
rbt_roÙ
, \

913 
cb
, 
¬g
); \

915 
»t
 = 
a_´efix
##
	`™”_»cur£
(
rbŒ“
,„bŒ“->
rbt_roÙ
, 
cb
, 
¬g
);\

917 ià(
»t
 =ğ&
rbŒ“
->
rbt_n
) { \

918 
»t
 = 
NULL
; \

920  (
»t
); \

922 
a_©Œ
 
a_ty³
 * \

923 
a_´efix
##
	`»v”£_™”_»cur£
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
node
, \

924 
a_ty³
 *(*
cb
)(
a_rbt_ty³
 *,‡_ty³ *, *), *
¬g
) { \

925 ià(
node
 =ğ&
rbŒ“
->
rbt_n
) { \

926  (&
rbŒ“
->
rbt_n
); \

928 
a_ty³
 *
»t
; \

929 ià((
»t
 = 
a_´efix
##
	`»v”£_™”_»cur£
(
rbŒ“
, \

930 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)) != \

931 &
rbŒ“
->
rbt_n
 || (
»t
 = 
	`cb
ÔbŒ“, 
node
, 
¬g
)è!ğ
NULL
) { \

932  (
»t
); \

934  (
a_´efix
##
	`»v”£_™”_»cur£
(
rbŒ“
, \

935 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

938 
a_©Œ
 
a_ty³
 * \

939 
a_´efix
##
	`»v”£_™”_¡¬t
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
, \

940 
a_ty³
 *
node
,‡_ty³ *(*
cb
)(
a_rbt_ty³
 *,‡_type *, *), \

941 *
¬g
) { \

942 
cmp
 = 
	`a_cmp
(
¡¬t
, 
node
); \

943 ià(
cmp
 > 0) { \

944 
a_ty³
 *
»t
; \

945 ià((
»t
 = 
a_´efix
##
	`»v”£_™”_¡¬t
(
rbŒ“
, 
¡¬t
, \

946 
	`rbŠ_right_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)) != \

947 &
rbŒ“
->
rbt_n
 || (
»t
 = 
	`cb
ÔbŒ“, 
node
, 
¬g
)è!ğ
NULL
) { \

948  (
»t
); \

950  (
a_´efix
##
	`»v”£_™”_»cur£
(
rbŒ“
, \

951 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

952 } ià(
cmp
 < 0) { \

953  (
a_´efix
##
	`»v”£_™”_¡¬t
(
rbŒ“
, 
¡¬t
, \

954 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

956 
a_ty³
 *
»t
; \

957 ià((
»t
 = 
	`cb
(
rbŒ“
, 
node
, 
¬g
)è!ğ
NULL
) { \

958  (
»t
); \

960  (
a_´efix
##
	`»v”£_™”_»cur£
(
rbŒ“
, \

961 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
, 
node
), 
cb
, 
¬g
)); \

964 
a_©Œ
 
a_ty³
 * \

965 
a_´efix
##
	`»v”£_™”
(
a_rbt_ty³
 *
rbŒ“
, 
a_ty³
 *
¡¬t
, \

966 
a_ty³
 *(*
cb
)(
a_rbt_ty³
 *,‡_ty³ *, *), *
¬g
) { \

967 
a_ty³
 *
»t
; \

968 ià(
¡¬t
 !ğ
NULL
) { \

969 
»t
 = 
a_´efix
##
	`»v”£_™”_¡¬t
(
rbŒ“
, 
¡¬t
, \

970 
rbŒ“
->
rbt_roÙ
, 
cb
, 
¬g
); \

972 
»t
 = 
a_´efix
##
	`»v”£_™”_»cur£
(
rbŒ“
,„bŒ“->
rbt_roÙ
, \

973 
cb
, 
¬g
); \

975 ià(
»t
 =ğ&
rbŒ“
->
rbt_n
) { \

976 
»t
 = 
NULL
; \

978  (
»t
); \

979 }

	)

	@deps/jemalloc/include/jemalloc/internal/rtree.h

7 #ifdeà
JEMALLOC_H_TYPES


9 
¹»e_node_–m_s
 
	t¹»e_node_–m_t
;

10 
¹»e_Ëv–_s
 
	t¹»e_Ëv–_t
;

11 
¹»e_s
 
	t¹»e_t
;

17 
	#LG_RTREE_BITS_PER_LEVEL
 4

	)

18 
	#RTREE_BITS_PER_LEVEL
 (
	`ZU
(1è<< 
LG_RTREE_BITS_PER_LEVEL
)

	)

19 
	#RTREE_HEIGHT_MAX
 \

20 ((
	`ZU
(1è<< (
LG_SIZEOF_PTR
+3)è/ 
RTREE_BITS_PER_LEVEL
)

	)

23 
	#RTREE_NODE_INITIALIZING
 ((
¹»e_node_–m_t
 *)0x1)

	)

30 
	g¹»e_node_–m_t
 *(
	t¹»e_node_®loc_t
)(
	tsize_t
);

31 (
	t¹»e_node_d®loc_t
)(
	t¹»e_node_–m_t
 *);

35 #ifdeà
JEMALLOC_H_STRUCTS


37 
	s¹»e_node_–m_s
 {

39 *
pun
;

40 
¹»e_node_–m_t
 *
chd
;

41 
ex‹Á_node_t
 *
v®
;

45 
	s¹»e_Ëv–_s
 {

69 *
subŒ“_pun
;

70 
¹»e_node_–m_t
 *
subŒ“
;

73 
b™s
;

78 
cumb™s
;

81 
	s¹»e_s
 {

82 
¹»e_node_®loc_t
 *
®loc
;

83 
¹»e_node_d®loc_t
 *
d®loc
;

84 
height
;

89 
¡¬t_Ëv–
[
RTREE_HEIGHT_MAX
];

90 
¹»e_Ëv–_t
 
Ëv–s
[
RTREE_HEIGHT_MAX
];

95 #ifdeà
JEMALLOC_H_EXTERNS


97 
boŞ
 
	`¹»e_Ãw
(
¹»e_t
 *
¹»e
, 
b™s
, 
¹»e_node_®loc_t
 *
®loc
,

98 
¹»e_node_d®loc_t
 *
d®loc
);

99 
	`¹»e_d–‘e
(
¹»e_t
 *
¹»e
);

100 
¹»e_node_–m_t
 *
	`¹»e_subŒ“_»ad_h¬d
(
¹»e_t
 *
¹»e
,

101 
Ëv–
);

102 
¹»e_node_–m_t
 *
	`¹»e_chd_»ad_h¬d
(
¹»e_t
 *
¹»e
,

103 
¹»e_node_–m_t
 *
–m
, 
Ëv–
);

107 #ifdeà
JEMALLOC_H_INLINES


109 #iâdeà
JEMALLOC_ENABLE_INLINE


110 
	`¹»e_¡¬t_Ëv–
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
);

111 
ušŒ_t
 
	`¹»e_subkey
(
¹»e_t
 *
¹»e
, ušŒ_ˆ
key
, 
Ëv–
);

113 
boŞ
 
	`¹»e_node_v®id
(
¹»e_node_–m_t
 *
node
);

114 
¹»e_node_–m_t
 *
	`¹»e_chd_Œy»ad
ÔŒ“_node_–m_ˆ*
–m
);

115 
¹»e_node_–m_t
 *
	`¹»e_chd_»ad
(
¹»e_t
 *
¹»e
,„Œ“_node_–m_ˆ*
–m
,

116 
Ëv–
);

117 
ex‹Á_node_t
 *
	`¹»e_v®_»ad
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
,

118 
boŞ
 
d•’d’t
);

119 
	`¹»e_v®_wr™e
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
,

120 cÚ¡ 
ex‹Á_node_t
 *
v®
);

121 
¹»e_node_–m_t
 *
	`¹»e_subŒ“_Œy»ad
(
¹»e_t
 *
¹»e
, 
Ëv–
);

122 
¹»e_node_–m_t
 *
	`¹»e_subŒ“_»ad
(
¹»e_t
 *
¹»e
, 
Ëv–
);

124 
ex‹Á_node_t
 *
	`¹»e_g‘
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
, 
boŞ
 
d•’d’t
);

125 
boŞ
 
	`¹»e_£t
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
, cÚ¡ 
ex‹Á_node_t
 *
v®
);

128 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_RTREE_C_
))

129 
JEMALLOC_INLINE
 

130 
	$¹»e_¡¬t_Ëv–
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
)

132 
¡¬t_Ëv–
;

134 ià(
	`uÆik–y
(
key
 == 0))

135  (
¹»e
->
height
 - 1);

137 
¡¬t_Ëv–
 = 
¹»e
->¡¬t_Ëv–[
	`lg_æoÜ
(
key
) >>

138 
LG_RTREE_BITS_PER_LEVEL
];

139 
	`as£¹
(
¡¬t_Ëv–
 < 
¹»e
->
height
);

140  (
¡¬t_Ëv–
);

141 
	}
}

143 
JEMALLOC_INLINE
 
ušŒ_t


144 
	$¹»e_subkey
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
, 
Ëv–
)

147  ((
key
 >> ((
	`ZU
(1è<< (
LG_SIZEOF_PTR
+3)) -

148 
¹»e
->
Ëv–s
[
Ëv–
].
cumb™s
)è& ((
	`ZU
(1) <<

149 
¹»e
->
Ëv–s
[
Ëv–
].
b™s
) - 1));

150 
	}
}

152 
JEMALLOC_INLINE
 
boŞ


153 
	$¹»e_node_v®id
(
¹»e_node_–m_t
 *
node
)

156  ((
ušŒ_t
)
node
 > (ušŒ_t)
RTREE_NODE_INITIALIZING
);

157 
	}
}

159 
JEMALLOC_INLINE
 
¹»e_node_–m_t
 *

160 
	$¹»e_chd_Œy»ad
(
¹»e_node_–m_t
 *
–m
)

162 
¹»e_node_–m_t
 *
chd
;

165 
chd
 = 
–m
->child;

166 ià(!
	`¹»e_node_v®id
(
chd
))

167 
chd
 = 
	`©omic_»ad_p
(&
–m
->
pun
);

168  (
chd
);

169 
	}
}

171 
JEMALLOC_INLINE
 
¹»e_node_–m_t
 *

172 
	$¹»e_chd_»ad
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
, 
Ëv–
)

174 
¹»e_node_–m_t
 *
chd
;

176 
chd
 = 
	`¹»e_chd_Œy»ad
(
–m
);

177 ià(
	`uÆik–y
(!
	`¹»e_node_v®id
(
chd
)))

178 
chd
 = 
	`¹»e_chd_»ad_h¬d
(
¹»e
, 
–m
, 
Ëv–
);

179  (
chd
);

180 
	}
}

182 
JEMALLOC_INLINE
 
ex‹Á_node_t
 *

183 
	$¹»e_v®_»ad
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
, 
boŞ
 
d•’d’t
)

186 ià(
d•’d’t
) {

193  (
–m
->
v®
);

200  (
	`©omic_»ad_p
(&
–m
->
pun
));

202 
	}
}

204 
JEMALLOC_INLINE
 

205 
	$¹»e_v®_wr™e
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
, cÚ¡ 
ex‹Á_node_t
 *
v®
)

208 
	`©omic_wr™e_p
(&
–m
->
pun
, 
v®
);

209 
	}
}

211 
JEMALLOC_INLINE
 
¹»e_node_–m_t
 *

212 
	$¹»e_subŒ“_Œy»ad
(
¹»e_t
 *
¹»e
, 
Ëv–
)

214 
¹»e_node_–m_t
 *
subŒ“
;

217 
subŒ“
 = 
¹»e
->
Ëv–s
[
Ëv–
].subtree;

218 ià(!
	`¹»e_node_v®id
(
subŒ“
))

219 
subŒ“
 = 
	`©omic_»ad_p
(&
¹»e
->
Ëv–s
[
Ëv–
].
subŒ“_pun
);

220  (
subŒ“
);

221 
	}
}

223 
JEMALLOC_INLINE
 
¹»e_node_–m_t
 *

224 
	$¹»e_subŒ“_»ad
(
¹»e_t
 *
¹»e
, 
Ëv–
)

226 
¹»e_node_–m_t
 *
subŒ“
;

228 
subŒ“
 = 
	`¹»e_subŒ“_Œy»ad
(
¹»e
, 
Ëv–
);

229 ià(
	`uÆik–y
(!
	`¹»e_node_v®id
(
subŒ“
)))

230 
subŒ“
 = 
	`¹»e_subŒ“_»ad_h¬d
(
¹»e
, 
Ëv–
);

231  (
subŒ“
);

232 
	}
}

234 
JEMALLOC_INLINE
 
ex‹Á_node_t
 *

235 
	$¹»e_g‘
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
, 
boŞ
 
d•’d’t
)

237 
ušŒ_t
 
subkey
;

238 
i
, 
¡¬t_Ëv–
;

239 
¹»e_node_–m_t
 *
node
, *
chd
;

241 
¡¬t_Ëv–
 = 
	`¹»e_¡¬t_Ëv–
(
¹»e
, 
key
);

243 
i
 = 
¡¬t_Ëv–
, 
node
 = 
	`¹»e_subŒ“_Œy»ad
(
¹»e
, start_level);

244  ; 
i
++, 
node
 = 
chd
) {

245 ià(!
d•’d’t
 && 
	`uÆik–y
(!
	`¹»e_node_v®id
(
node
)))

246  (
NULL
);

247 
subkey
 = 
	`¹»e_subkey
(
¹»e
, 
key
, 
i
);

248 ià(
i
 =ğ
¹»e
->
height
 - 1) {

253  (
	`¹»e_v®_»ad
(
¹»e
, &
node
[
subkey
],

254 
d•’d’t
));

256 
	`as£¹
(
i
 < 
¹»e
->
height
 - 1);

257 
chd
 = 
	`¹»e_chd_Œy»ad
(&
node
[
subkey
]);

259 
	`nÙ_»ached
();

260 
	}
}

262 
JEMALLOC_INLINE
 
boŞ


263 
	$¹»e_£t
(
¹»e_t
 *
¹»e
, 
ušŒ_t
 
key
, cÚ¡ 
ex‹Á_node_t
 *
v®
)

265 
ušŒ_t
 
subkey
;

266 
i
, 
¡¬t_Ëv–
;

267 
¹»e_node_–m_t
 *
node
, *
chd
;

269 
¡¬t_Ëv–
 = 
	`¹»e_¡¬t_Ëv–
(
¹»e
, 
key
);

271 
node
 = 
	`¹»e_subŒ“_»ad
(
¹»e
, 
¡¬t_Ëv–
);

272 ià(
node
 =ğ
NULL
)

273  (
Œue
);

274 
i
 = 
¡¬t_Ëv–
; ; i++, 
node
 = 
chd
) {

275 
subkey
 = 
	`¹»e_subkey
(
¹»e
, 
key
, 
i
);

276 ià(
i
 =ğ
¹»e
->
height
 - 1) {

281 
	`¹»e_v®_wr™e
(
¹»e
, &
node
[
subkey
], 
v®
);

282  (
çl£
);

284 
	`as£¹
(
i
 + 1 < 
¹»e
->
height
);

285 
chd
 = 
	`¹»e_chd_»ad
(
¹»e
, &
node
[
subkey
], 
i
);

286 ià(
chd
 =ğ
NULL
)

287  (
Œue
);

289 
	`nÙ_»ached
();

290 
	}
}

	@deps/jemalloc/include/jemalloc/internal/size_classes.h

3 #ifdeà
JEMALLOC_H_TYPES


31 
	#LG_SIZE_CLASS_GROUP
 2

	)

33 #ià(
LG_SIZEOF_PTR
 =ğ2 && 
LG_TINY_MIN
 =ğ3 && 
LG_QUANTUM
 =ğ3 && 
LG_PAGE
 == 12)

34 
	#SIZE_CLASSES
 \

36 
	`SC
Ğ0, 3, 3, 0, 
yes
, 3) \

37 
	`SC
Ğ1, 3, 3, 1, 
yes
, 3) \

38 
	`SC
Ğ2, 3, 3, 2, 
yes
, 3) \

39 
	`SC
Ğ3, 3, 3, 3, 
yes
, 3) \

41 
	`SC
Ğ4, 5, 3, 1, 
yes
, 3) \

42 
	`SC
Ğ5, 5, 3, 2, 
yes
, 3) \

43 
	`SC
Ğ6, 5, 3, 3, 
yes
, 3) \

44 
	`SC
Ğ7, 5, 3, 4, 
yes
, 3) \

46 
	`SC
Ğ8, 6, 4, 1, 
yes
, 4) \

47 
	`SC
Ğ9, 6, 4, 2, 
yes
, 4) \

48 
	`SC
Ğ10, 6, 4, 3, 
yes
, 4) \

49 
	`SC
Ğ11, 6, 4, 4, 
yes
, 4) \

51 
	`SC
Ğ12, 7, 5, 1, 
yes
, 5) \

52 
	`SC
Ğ13, 7, 5, 2, 
yes
, 5) \

53 
	`SC
Ğ14, 7, 5, 3, 
yes
, 5) \

54 
	`SC
Ğ15, 7, 5, 4, 
yes
, 5) \

56 
	`SC
Ğ16, 8, 6, 1, 
yes
, 6) \

57 
	`SC
Ğ17, 8, 6, 2, 
yes
, 6) \

58 
	`SC
Ğ18, 8, 6, 3, 
yes
, 6) \

59 
	`SC
Ğ19, 8, 6, 4, 
yes
, 6) \

61 
	`SC
Ğ20, 9, 7, 1, 
yes
, 7) \

62 
	`SC
Ğ21, 9, 7, 2, 
yes
, 7) \

63 
	`SC
Ğ22, 9, 7, 3, 
yes
, 7) \

64 
	`SC
Ğ23, 9, 7, 4, 
yes
, 7) \

66 
	`SC
Ğ24, 10, 8, 1, 
yes
, 8) \

67 
	`SC
Ğ25, 10, 8, 2, 
yes
, 8) \

68 
	`SC
Ğ26, 10, 8, 3, 
yes
, 8) \

69 
	`SC
Ğ27, 10, 8, 4, 
yes
, 8) \

71 
	`SC
Ğ28, 11, 9, 1, 
yes
, 9) \

72 
	`SC
Ğ29, 11, 9, 2, 
yes
, 9) \

73 
	`SC
Ğ30, 11, 9, 3, 
yes
, 9) \

74 
	`SC
Ğ31, 11, 9, 4, 
yes
, 9) \

76 
	`SC
Ğ32, 12, 10, 1, 
yes
, 
no
) \

77 
	`SC
Ğ33, 12, 10, 2, 
yes
, 
no
) \

78 
	`SC
Ğ34, 12, 10, 3, 
yes
, 
no
) \

79 
	`SC
Ğ35, 12, 10, 4, 
yes
, 
no
) \

81 
	`SC
Ğ36, 13, 11, 1, 
yes
, 
no
) \

82 
	`SC
Ğ37, 13, 11, 2, 
yes
, 
no
) \

83 
	`SC
Ğ38, 13, 11, 3, 
yes
, 
no
) \

84 
	`SC
Ğ39, 13, 11, 4, 
no
,‚o) \

86 
	`SC
Ğ40, 14, 12, 1, 
no
,‚o) \

87 
	`SC
Ğ41, 14, 12, 2, 
no
,‚o) \

88 
	`SC
Ğ42, 14, 12, 3, 
no
,‚o) \

89 
	`SC
Ğ43, 14, 12, 4, 
no
,‚o) \

91 
	`SC
Ğ44, 15, 13, 1, 
no
,‚o) \

92 
	`SC
Ğ45, 15, 13, 2, 
no
,‚o) \

93 
	`SC
Ğ46, 15, 13, 3, 
no
,‚o) \

94 
	`SC
Ğ47, 15, 13, 4, 
no
,‚o) \

96 
	`SC
Ğ48, 16, 14, 1, 
no
,‚o) \

97 
	`SC
Ğ49, 16, 14, 2, 
no
,‚o) \

98 
	`SC
Ğ50, 16, 14, 3, 
no
,‚o) \

99 
	`SC
Ğ51, 16, 14, 4, 
no
,‚o) \

101 
	`SC
Ğ52, 17, 15, 1, 
no
,‚o) \

102 
	`SC
Ğ53, 17, 15, 2, 
no
,‚o) \

103 
	`SC
Ğ54, 17, 15, 3, 
no
,‚o) \

104 
	`SC
Ğ55, 17, 15, 4, 
no
,‚o) \

106 
	`SC
Ğ56, 18, 16, 1, 
no
,‚o) \

107 
	`SC
Ğ57, 18, 16, 2, 
no
,‚o) \

108 
	`SC
Ğ58, 18, 16, 3, 
no
,‚o) \

109 
	`SC
Ğ59, 18, 16, 4, 
no
,‚o) \

111 
	`SC
Ğ60, 19, 17, 1, 
no
,‚o) \

112 
	`SC
Ğ61, 19, 17, 2, 
no
,‚o) \

113 
	`SC
Ğ62, 19, 17, 3, 
no
,‚o) \

114 
	`SC
Ğ63, 19, 17, 4, 
no
,‚o) \

116 
	`SC
Ğ64, 20, 18, 1, 
no
,‚o) \

117 
	`SC
Ğ65, 20, 18, 2, 
no
,‚o) \

118 
	`SC
Ğ66, 20, 18, 3, 
no
,‚o) \

119 
	`SC
Ğ67, 20, 18, 4, 
no
,‚o) \

121 
	`SC
Ğ68, 21, 19, 1, 
no
,‚o) \

122 
	`SC
Ğ69, 21, 19, 2, 
no
,‚o) \

123 
	`SC
Ğ70, 21, 19, 3, 
no
,‚o) \

124 
	`SC
Ğ71, 21, 19, 4, 
no
,‚o) \

126 
	`SC
Ğ72, 22, 20, 1, 
no
,‚o) \

127 
	`SC
Ğ73, 22, 20, 2, 
no
,‚o) \

128 
	`SC
Ğ74, 22, 20, 3, 
no
,‚o) \

129 
	`SC
Ğ75, 22, 20, 4, 
no
,‚o) \

131 
	`SC
Ğ76, 23, 21, 1, 
no
,‚o) \

132 
	`SC
Ğ77, 23, 21, 2, 
no
,‚o) \

133 
	`SC
Ğ78, 23, 21, 3, 
no
,‚o) \

134 
	`SC
Ğ79, 23, 21, 4, 
no
,‚o) \

136 
	`SC
Ğ80, 24, 22, 1, 
no
,‚o) \

137 
	`SC
Ğ81, 24, 22, 2, 
no
,‚o) \

138 
	`SC
Ğ82, 24, 22, 3, 
no
,‚o) \

139 
	`SC
Ğ83, 24, 22, 4, 
no
,‚o) \

141 
	`SC
Ğ84, 25, 23, 1, 
no
,‚o) \

142 
	`SC
Ğ85, 25, 23, 2, 
no
,‚o) \

143 
	`SC
Ğ86, 25, 23, 3, 
no
,‚o) \

144 
	`SC
Ğ87, 25, 23, 4, 
no
,‚o) \

146 
	`SC
Ğ88, 26, 24, 1, 
no
,‚o) \

147 
	`SC
Ğ89, 26, 24, 2, 
no
,‚o) \

148 
	`SC
Ğ90, 26, 24, 3, 
no
,‚o) \

149 
	`SC
Ğ91, 26, 24, 4, 
no
,‚o) \

151 
	`SC
Ğ92, 27, 25, 1, 
no
,‚o) \

152 
	`SC
Ğ93, 27, 25, 2, 
no
,‚o) \

153 
	`SC
Ğ94, 27, 25, 3, 
no
,‚o) \

154 
	`SC
Ğ95, 27, 25, 4, 
no
,‚o) \

156 
	`SC
Ğ96, 28, 26, 1, 
no
,‚o) \

157 
	`SC
Ğ97, 28, 26, 2, 
no
,‚o) \

158 
	`SC
Ğ98, 28, 26, 3, 
no
,‚o) \

159 
	`SC
Ğ99, 28, 26, 4, 
no
,‚o) \

161 
	`SC
(100, 29, 27, 1, 
no
,‚o) \

162 
	`SC
(101, 29, 27, 2, 
no
,‚o) \

163 
	`SC
(102, 29, 27, 3, 
no
,‚o) \

164 
	`SC
(103, 29, 27, 4, 
no
,‚o) \

166 
	`SC
(104, 30, 28, 1, 
no
,‚o) \

167 
	`SC
(105, 30, 28, 2, 
no
,‚o) \

168 
	`SC
(106, 30, 28, 3, 
no
,‚o) \

169 
	`SC
(107, 30, 28, 4, 
no
,‚o) \

171 
	`SC
(108, 31, 29, 1, 
no
,‚o) \

172 
	`SC
(109, 31, 29, 2, 
no
,‚o) \

173 
	`SC
(110, 31, 29, 3, 
no
,‚o) \

174 

	)

175 
	#SIZE_CLASSES_DEFINED


	)

176 
	#NTBINS
 0

	)

177 
	#NLBINS
 32

	)

178 
	#NBINS
 39

	)

179 
	#NSIZES
 111

	)

180 
	#LG_TINY_MAXCLASS
 "NA"

	)

181 
	#LOOKUP_MAXCLASS
 ((((
size_t
)1è<< 11è+ (((size_t)4è<< 9))

	)

182 
	#SMALL_MAXCLASS
 ((((
size_t
)1è<< 13è+ (((size_t)3è<< 11))

	)

183 
	#LG_LARGE_MINCLASS
 14

	)

184 
	#HUGE_MAXCLASS
 ((((
size_t
)1è<< 31è+ (((size_t)3è<< 29))

	)

187 #ià(
LG_SIZEOF_PTR
 =ğ3 && 
LG_TINY_MIN
 =ğ3 && 
LG_QUANTUM
 =ğ3 && 
LG_PAGE
 == 12)

188 
	#SIZE_CLASSES
 \

190 
	`SC
Ğ0, 3, 3, 0, 
yes
, 3) \

191 
	`SC
Ğ1, 3, 3, 1, 
yes
, 3) \

192 
	`SC
Ğ2, 3, 3, 2, 
yes
, 3) \

193 
	`SC
Ğ3, 3, 3, 3, 
yes
, 3) \

195 
	`SC
Ğ4, 5, 3, 1, 
yes
, 3) \

196 
	`SC
Ğ5, 5, 3, 2, 
yes
, 3) \

197 
	`SC
Ğ6, 5, 3, 3, 
yes
, 3) \

198 
	`SC
Ğ7, 5, 3, 4, 
yes
, 3) \

200 
	`SC
Ğ8, 6, 4, 1, 
yes
, 4) \

201 
	`SC
Ğ9, 6, 4, 2, 
yes
, 4) \

202 
	`SC
Ğ10, 6, 4, 3, 
yes
, 4) \

203 
	`SC
Ğ11, 6, 4, 4, 
yes
, 4) \

205 
	`SC
Ğ12, 7, 5, 1, 
yes
, 5) \

206 
	`SC
Ğ13, 7, 5, 2, 
yes
, 5) \

207 
	`SC
Ğ14, 7, 5, 3, 
yes
, 5) \

208 
	`SC
Ğ15, 7, 5, 4, 
yes
, 5) \

210 
	`SC
Ğ16, 8, 6, 1, 
yes
, 6) \

211 
	`SC
Ğ17, 8, 6, 2, 
yes
, 6) \

212 
	`SC
Ğ18, 8, 6, 3, 
yes
, 6) \

213 
	`SC
Ğ19, 8, 6, 4, 
yes
, 6) \

215 
	`SC
Ğ20, 9, 7, 1, 
yes
, 7) \

216 
	`SC
Ğ21, 9, 7, 2, 
yes
, 7) \

217 
	`SC
Ğ22, 9, 7, 3, 
yes
, 7) \

218 
	`SC
Ğ23, 9, 7, 4, 
yes
, 7) \

220 
	`SC
Ğ24, 10, 8, 1, 
yes
, 8) \

221 
	`SC
Ğ25, 10, 8, 2, 
yes
, 8) \

222 
	`SC
Ğ26, 10, 8, 3, 
yes
, 8) \

223 
	`SC
Ğ27, 10, 8, 4, 
yes
, 8) \

225 
	`SC
Ğ28, 11, 9, 1, 
yes
, 9) \

226 
	`SC
Ğ29, 11, 9, 2, 
yes
, 9) \

227 
	`SC
Ğ30, 11, 9, 3, 
yes
, 9) \

228 
	`SC
Ğ31, 11, 9, 4, 
yes
, 9) \

230 
	`SC
Ğ32, 12, 10, 1, 
yes
, 
no
) \

231 
	`SC
Ğ33, 12, 10, 2, 
yes
, 
no
) \

232 
	`SC
Ğ34, 12, 10, 3, 
yes
, 
no
) \

233 
	`SC
Ğ35, 12, 10, 4, 
yes
, 
no
) \

235 
	`SC
Ğ36, 13, 11, 1, 
yes
, 
no
) \

236 
	`SC
Ğ37, 13, 11, 2, 
yes
, 
no
) \

237 
	`SC
Ğ38, 13, 11, 3, 
yes
, 
no
) \

238 
	`SC
Ğ39, 13, 11, 4, 
no
,‚o) \

240 
	`SC
Ğ40, 14, 12, 1, 
no
,‚o) \

241 
	`SC
Ğ41, 14, 12, 2, 
no
,‚o) \

242 
	`SC
Ğ42, 14, 12, 3, 
no
,‚o) \

243 
	`SC
Ğ43, 14, 12, 4, 
no
,‚o) \

245 
	`SC
Ğ44, 15, 13, 1, 
no
,‚o) \

246 
	`SC
Ğ45, 15, 13, 2, 
no
,‚o) \

247 
	`SC
Ğ46, 15, 13, 3, 
no
,‚o) \

248 
	`SC
Ğ47, 15, 13, 4, 
no
,‚o) \

250 
	`SC
Ğ48, 16, 14, 1, 
no
,‚o) \

251 
	`SC
Ğ49, 16, 14, 2, 
no
,‚o) \

252 
	`SC
Ğ50, 16, 14, 3, 
no
,‚o) \

253 
	`SC
Ğ51, 16, 14, 4, 
no
,‚o) \

255 
	`SC
Ğ52, 17, 15, 1, 
no
,‚o) \

256 
	`SC
Ğ53, 17, 15, 2, 
no
,‚o) \

257 
	`SC
Ğ54, 17, 15, 3, 
no
,‚o) \

258 
	`SC
Ğ55, 17, 15, 4, 
no
,‚o) \

260 
	`SC
Ğ56, 18, 16, 1, 
no
,‚o) \

261 
	`SC
Ğ57, 18, 16, 2, 
no
,‚o) \

262 
	`SC
Ğ58, 18, 16, 3, 
no
,‚o) \

263 
	`SC
Ğ59, 18, 16, 4, 
no
,‚o) \

265 
	`SC
Ğ60, 19, 17, 1, 
no
,‚o) \

266 
	`SC
Ğ61, 19, 17, 2, 
no
,‚o) \

267 
	`SC
Ğ62, 19, 17, 3, 
no
,‚o) \

268 
	`SC
Ğ63, 19, 17, 4, 
no
,‚o) \

270 
	`SC
Ğ64, 20, 18, 1, 
no
,‚o) \

271 
	`SC
Ğ65, 20, 18, 2, 
no
,‚o) \

272 
	`SC
Ğ66, 20, 18, 3, 
no
,‚o) \

273 
	`SC
Ğ67, 20, 18, 4, 
no
,‚o) \

275 
	`SC
Ğ68, 21, 19, 1, 
no
,‚o) \

276 
	`SC
Ğ69, 21, 19, 2, 
no
,‚o) \

277 
	`SC
Ğ70, 21, 19, 3, 
no
,‚o) \

278 
	`SC
Ğ71, 21, 19, 4, 
no
,‚o) \

280 
	`SC
Ğ72, 22, 20, 1, 
no
,‚o) \

281 
	`SC
Ğ73, 22, 20, 2, 
no
,‚o) \

282 
	`SC
Ğ74, 22, 20, 3, 
no
,‚o) \

283 
	`SC
Ğ75, 22, 20, 4, 
no
,‚o) \

285 
	`SC
Ğ76, 23, 21, 1, 
no
,‚o) \

286 
	`SC
Ğ77, 23, 21, 2, 
no
,‚o) \

287 
	`SC
Ğ78, 23, 21, 3, 
no
,‚o) \

288 
	`SC
Ğ79, 23, 21, 4, 
no
,‚o) \

290 
	`SC
Ğ80, 24, 22, 1, 
no
,‚o) \

291 
	`SC
Ğ81, 24, 22, 2, 
no
,‚o) \

292 
	`SC
Ğ82, 24, 22, 3, 
no
,‚o) \

293 
	`SC
Ğ83, 24, 22, 4, 
no
,‚o) \

295 
	`SC
Ğ84, 25, 23, 1, 
no
,‚o) \

296 
	`SC
Ğ85, 25, 23, 2, 
no
,‚o) \

297 
	`SC
Ğ86, 25, 23, 3, 
no
,‚o) \

298 
	`SC
Ğ87, 25, 23, 4, 
no
,‚o) \

300 
	`SC
Ğ88, 26, 24, 1, 
no
,‚o) \

301 
	`SC
Ğ89, 26, 24, 2, 
no
,‚o) \

302 
	`SC
Ğ90, 26, 24, 3, 
no
,‚o) \

303 
	`SC
Ğ91, 26, 24, 4, 
no
,‚o) \

305 
	`SC
Ğ92, 27, 25, 1, 
no
,‚o) \

306 
	`SC
Ğ93, 27, 25, 2, 
no
,‚o) \

307 
	`SC
Ğ94, 27, 25, 3, 
no
,‚o) \

308 
	`SC
Ğ95, 27, 25, 4, 
no
,‚o) \

310 
	`SC
Ğ96, 28, 26, 1, 
no
,‚o) \

311 
	`SC
Ğ97, 28, 26, 2, 
no
,‚o) \

312 
	`SC
Ğ98, 28, 26, 3, 
no
,‚o) \

313 
	`SC
Ğ99, 28, 26, 4, 
no
,‚o) \

315 
	`SC
(100, 29, 27, 1, 
no
,‚o) \

316 
	`SC
(101, 29, 27, 2, 
no
,‚o) \

317 
	`SC
(102, 29, 27, 3, 
no
,‚o) \

318 
	`SC
(103, 29, 27, 4, 
no
,‚o) \

320 
	`SC
(104, 30, 28, 1, 
no
,‚o) \

321 
	`SC
(105, 30, 28, 2, 
no
,‚o) \

322 
	`SC
(106, 30, 28, 3, 
no
,‚o) \

323 
	`SC
(107, 30, 28, 4, 
no
,‚o) \

325 
	`SC
(108, 31, 29, 1, 
no
,‚o) \

326 
	`SC
(109, 31, 29, 2, 
no
,‚o) \

327 
	`SC
(110, 31, 29, 3, 
no
,‚o) \

328 
	`SC
(111, 31, 29, 4, 
no
,‚o) \

330 
	`SC
(112, 32, 30, 1, 
no
,‚o) \

331 
	`SC
(113, 32, 30, 2, 
no
,‚o) \

332 
	`SC
(114, 32, 30, 3, 
no
,‚o) \

333 
	`SC
(115, 32, 30, 4, 
no
,‚o) \

335 
	`SC
(116, 33, 31, 1, 
no
,‚o) \

336 
	`SC
(117, 33, 31, 2, 
no
,‚o) \

337 
	`SC
(118, 33, 31, 3, 
no
,‚o) \

338 
	`SC
(119, 33, 31, 4, 
no
,‚o) \

340 
	`SC
(120, 34, 32, 1, 
no
,‚o) \

341 
	`SC
(121, 34, 32, 2, 
no
,‚o) \

342 
	`SC
(122, 34, 32, 3, 
no
,‚o) \

343 
	`SC
(123, 34, 32, 4, 
no
,‚o) \

345 
	`SC
(124, 35, 33, 1, 
no
,‚o) \

346 
	`SC
(125, 35, 33, 2, 
no
,‚o) \

347 
	`SC
(126, 35, 33, 3, 
no
,‚o) \

348 
	`SC
(127, 35, 33, 4, 
no
,‚o) \

350 
	`SC
(128, 36, 34, 1, 
no
,‚o) \

351 
	`SC
(129, 36, 34, 2, 
no
,‚o) \

352 
	`SC
(130, 36, 34, 3, 
no
,‚o) \

353 
	`SC
(131, 36, 34, 4, 
no
,‚o) \

355 
	`SC
(132, 37, 35, 1, 
no
,‚o) \

356 
	`SC
(133, 37, 35, 2, 
no
,‚o) \

357 
	`SC
(134, 37, 35, 3, 
no
,‚o) \

358 
	`SC
(135, 37, 35, 4, 
no
,‚o) \

360 
	`SC
(136, 38, 36, 1, 
no
,‚o) \

361 
	`SC
(137, 38, 36, 2, 
no
,‚o) \

362 
	`SC
(138, 38, 36, 3, 
no
,‚o) \

363 
	`SC
(139, 38, 36, 4, 
no
,‚o) \

365 
	`SC
(140, 39, 37, 1, 
no
,‚o) \

366 
	`SC
(141, 39, 37, 2, 
no
,‚o) \

367 
	`SC
(142, 39, 37, 3, 
no
,‚o) \

368 
	`SC
(143, 39, 37, 4, 
no
,‚o) \

370 
	`SC
(144, 40, 38, 1, 
no
,‚o) \

371 
	`SC
(145, 40, 38, 2, 
no
,‚o) \

372 
	`SC
(146, 40, 38, 3, 
no
,‚o) \

373 
	`SC
(147, 40, 38, 4, 
no
,‚o) \

375 
	`SC
(148, 41, 39, 1, 
no
,‚o) \

376 
	`SC
(149, 41, 39, 2, 
no
,‚o) \

377 
	`SC
(150, 41, 39, 3, 
no
,‚o) \

378 
	`SC
(151, 41, 39, 4, 
no
,‚o) \

380 
	`SC
(152, 42, 40, 1, 
no
,‚o) \

381 
	`SC
(153, 42, 40, 2, 
no
,‚o) \

382 
	`SC
(154, 42, 40, 3, 
no
,‚o) \

383 
	`SC
(155, 42, 40, 4, 
no
,‚o) \

385 
	`SC
(156, 43, 41, 1, 
no
,‚o) \

386 
	`SC
(157, 43, 41, 2, 
no
,‚o) \

387 
	`SC
(158, 43, 41, 3, 
no
,‚o) \

388 
	`SC
(159, 43, 41, 4, 
no
,‚o) \

390 
	`SC
(160, 44, 42, 1, 
no
,‚o) \

391 
	`SC
(161, 44, 42, 2, 
no
,‚o) \

392 
	`SC
(162, 44, 42, 3, 
no
,‚o) \

393 
	`SC
(163, 44, 42, 4, 
no
,‚o) \

395 
	`SC
(164, 45, 43, 1, 
no
,‚o) \

396 
	`SC
(165, 45, 43, 2, 
no
,‚o) \

397 
	`SC
(166, 45, 43, 3, 
no
,‚o) \

398 
	`SC
(167, 45, 43, 4, 
no
,‚o) \

400 
	`SC
(168, 46, 44, 1, 
no
,‚o) \

401 
	`SC
(169, 46, 44, 2, 
no
,‚o) \

402 
	`SC
(170, 46, 44, 3, 
no
,‚o) \

403 
	`SC
(171, 46, 44, 4, 
no
,‚o) \

405 
	`SC
(172, 47, 45, 1, 
no
,‚o) \

406 
	`SC
(173, 47, 45, 2, 
no
,‚o) \

407 
	`SC
(174, 47, 45, 3, 
no
,‚o) \

408 
	`SC
(175, 47, 45, 4, 
no
,‚o) \

410 
	`SC
(176, 48, 46, 1, 
no
,‚o) \

411 
	`SC
(177, 48, 46, 2, 
no
,‚o) \

412 
	`SC
(178, 48, 46, 3, 
no
,‚o) \

413 
	`SC
(179, 48, 46, 4, 
no
,‚o) \

415 
	`SC
(180, 49, 47, 1, 
no
,‚o) \

416 
	`SC
(181, 49, 47, 2, 
no
,‚o) \

417 
	`SC
(182, 49, 47, 3, 
no
,‚o) \

418 
	`SC
(183, 49, 47, 4, 
no
,‚o) \

420 
	`SC
(184, 50, 48, 1, 
no
,‚o) \

421 
	`SC
(185, 50, 48, 2, 
no
,‚o) \

422 
	`SC
(186, 50, 48, 3, 
no
,‚o) \

423 
	`SC
(187, 50, 48, 4, 
no
,‚o) \

425 
	`SC
(188, 51, 49, 1, 
no
,‚o) \

426 
	`SC
(189, 51, 49, 2, 
no
,‚o) \

427 
	`SC
(190, 51, 49, 3, 
no
,‚o) \

428 
	`SC
(191, 51, 49, 4, 
no
,‚o) \

430 
	`SC
(192, 52, 50, 1, 
no
,‚o) \

431 
	`SC
(193, 52, 50, 2, 
no
,‚o) \

432 
	`SC
(194, 52, 50, 3, 
no
,‚o) \

433 
	`SC
(195, 52, 50, 4, 
no
,‚o) \

435 
	`SC
(196, 53, 51, 1, 
no
,‚o) \

436 
	`SC
(197, 53, 51, 2, 
no
,‚o) \

437 
	`SC
(198, 53, 51, 3, 
no
,‚o) \

438 
	`SC
(199, 53, 51, 4, 
no
,‚o) \

440 
	`SC
(200, 54, 52, 1, 
no
,‚o) \

441 
	`SC
(201, 54, 52, 2, 
no
,‚o) \

442 
	`SC
(202, 54, 52, 3, 
no
,‚o) \

443 
	`SC
(203, 54, 52, 4, 
no
,‚o) \

445 
	`SC
(204, 55, 53, 1, 
no
,‚o) \

446 
	`SC
(205, 55, 53, 2, 
no
,‚o) \

447 
	`SC
(206, 55, 53, 3, 
no
,‚o) \

448 
	`SC
(207, 55, 53, 4, 
no
,‚o) \

450 
	`SC
(208, 56, 54, 1, 
no
,‚o) \

451 
	`SC
(209, 56, 54, 2, 
no
,‚o) \

452 
	`SC
(210, 56, 54, 3, 
no
,‚o) \

453 
	`SC
(211, 56, 54, 4, 
no
,‚o) \

455 
	`SC
(212, 57, 55, 1, 
no
,‚o) \

456 
	`SC
(213, 57, 55, 2, 
no
,‚o) \

457 
	`SC
(214, 57, 55, 3, 
no
,‚o) \

458 
	`SC
(215, 57, 55, 4, 
no
,‚o) \

460 
	`SC
(216, 58, 56, 1, 
no
,‚o) \

461 
	`SC
(217, 58, 56, 2, 
no
,‚o) \

462 
	`SC
(218, 58, 56, 3, 
no
,‚o) \

463 
	`SC
(219, 58, 56, 4, 
no
,‚o) \

465 
	`SC
(220, 59, 57, 1, 
no
,‚o) \

466 
	`SC
(221, 59, 57, 2, 
no
,‚o) \

467 
	`SC
(222, 59, 57, 3, 
no
,‚o) \

468 
	`SC
(223, 59, 57, 4, 
no
,‚o) \

470 
	`SC
(224, 60, 58, 1, 
no
,‚o) \

471 
	`SC
(225, 60, 58, 2, 
no
,‚o) \

472 
	`SC
(226, 60, 58, 3, 
no
,‚o) \

473 
	`SC
(227, 60, 58, 4, 
no
,‚o) \

475 
	`SC
(228, 61, 59, 1, 
no
,‚o) \

476 
	`SC
(229, 61, 59, 2, 
no
,‚o) \

477 
	`SC
(230, 61, 59, 3, 
no
,‚o) \

478 
	`SC
(231, 61, 59, 4, 
no
,‚o) \

480 
	`SC
(232, 62, 60, 1, 
no
,‚o) \

481 
	`SC
(233, 62, 60, 2, 
no
,‚o) \

482 
	`SC
(234, 62, 60, 3, 
no
,‚o) \

483 
	`SC
(235, 62, 60, 4, 
no
,‚o) \

485 
	`SC
(236, 63, 61, 1, 
no
,‚o) \

486 
	`SC
(237, 63, 61, 2, 
no
,‚o) \

487 
	`SC
(238, 63, 61, 3, 
no
,‚o) \

488 

	)

489 
	#SIZE_CLASSES_DEFINED


	)

490 
	#NTBINS
 0

	)

491 
	#NLBINS
 32

	)

492 
	#NBINS
 39

	)

493 
	#NSIZES
 239

	)

494 
	#LG_TINY_MAXCLASS
 "NA"

	)

495 
	#LOOKUP_MAXCLASS
 ((((
size_t
)1è<< 11è+ (((size_t)4è<< 9))

	)

496 
	#SMALL_MAXCLASS
 ((((
size_t
)1è<< 13è+ (((size_t)3è<< 11))

	)

497 
	#LG_LARGE_MINCLASS
 14

	)

498 
	#HUGE_MAXCLASS
 ((((
size_t
)1è<< 63è+ (((size_t)3è<< 61))

	)

501 #iâdeà
SIZE_CLASSES_DEFINED


504 #undeà
SIZE_CLASSES_DEFINED


511 #ià(
NBINS
 > 255)

517 #ifdeà
JEMALLOC_H_STRUCTS


522 #ifdeà
JEMALLOC_H_EXTERNS


527 #ifdeà
JEMALLOC_H_INLINES


	@deps/jemalloc/include/jemalloc/internal/stats.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
tÿche_bš_¡©s_s
 
	ttÿche_bš_¡©s_t
;

5 
m®loc_bš_¡©s_s
 
	tm®loc_bš_¡©s_t
;

6 
m®loc_Ïrge_¡©s_s
 
	tm®loc_Ïrge_¡©s_t
;

7 
m®loc_huge_¡©s_s
 
	tm®loc_huge_¡©s_t
;

8 
¬’a_¡©s_s
 
	t¬’a_¡©s_t
;

9 
chunk_¡©s_s
 
	tchunk_¡©s_t
;

13 #ifdeà
JEMALLOC_H_STRUCTS


15 
	stÿche_bš_¡©s_s
 {

20 
ušt64_t
 
	mÄeque¡s
;

23 
	sm®loc_bš_¡©s_s
 {

30 
ušt64_t
 
	mnm®loc
;

31 
ušt64_t
 
	mnd®loc
;

38 
ušt64_t
 
	mÄeque¡s
;

44 
size_t
 
	mcu¼egs
;

47 
ušt64_t
 
	mnfls
;

50 
ušt64_t
 
	mnæushes
;

53 
ušt64_t
 
	mÄuns
;

59 
ušt64_t
 
	m»runs
;

62 
size_t
 
	mcu¼uns
;

65 
	sm®loc_Ïrge_¡©s_s
 {

72 
ušt64_t
 
	mnm®loc
;

73 
ušt64_t
 
	mnd®loc
;

80 
ušt64_t
 
	mÄeque¡s
;

86 
size_t
 
	mcu¼uns
;

89 
	sm®loc_huge_¡©s_s
 {

94 
ušt64_t
 
	mnm®loc
;

95 
ušt64_t
 
	mnd®loc
;

98 
size_t
 
	mcurhchunks
;

101 
	s¬’a_¡©s_s
 {

103 
size_t
 
	mm­³d
;

110 
ušt64_t
 
	mÅurge
;

111 
ušt64_t
 
	mnmadvi£
;

112 
ušt64_t
 
	mpurged
;

118 
size_t
 
	mm‘ad©a_m­³d
;

119 
size_t
 
	mm‘ad©a_®loÿ‹d
;

122 
size_t
 
	m®loÿ‹d_Ïrge
;

123 
ušt64_t
 
	mnm®loc_Ïrge
;

124 
ušt64_t
 
	mnd®loc_Ïrge
;

125 
ušt64_t
 
	mÄeque¡s_Ïrge
;

127 
size_t
 
	m®loÿ‹d_huge
;

128 
ušt64_t
 
	mnm®loc_huge
;

129 
ušt64_t
 
	mnd®loc_huge
;

132 
m®loc_Ïrge_¡©s_t
 *
	ml¡©s
;

135 
m®loc_huge_¡©s_t
 *
	mh¡©s
;

140 #ifdeà
JEMALLOC_H_EXTERNS


142 
boŞ
 
İt_¡©s_´št
;

144 
size_t
 
¡©s_ÿùive
;

146 
¡©s_´št
((*
wr™e
)(*, cÚ¡ *), *
cbİaque
,

147 cÚ¡ *
İts
);

151 #ifdeà
JEMALLOC_H_INLINES


153 #iâdeà
JEMALLOC_ENABLE_INLINE


154 
size_t
 
	`¡©s_ÿùive_g‘
();

155 
	`¡©s_ÿùive_add
(
size_t
 
size
);

156 
	`¡©s_ÿùive_sub
(
size_t
 
size
);

159 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_STATS_C_
))

160 
JEMALLOC_INLINE
 
size_t


161 
	$¡©s_ÿùive_g‘
()

164  (
	`©omic_»ad_z
(&
¡©s_ÿùive
));

165 
	}
}

167 
JEMALLOC_INLINE
 

168 
	$¡©s_ÿùive_add
(
size_t
 
size
)

171 
	`©omic_add_z
(&
¡©s_ÿùive
, 
size
);

172 
	}
}

174 
JEMALLOC_INLINE
 

175 
	$¡©s_ÿùive_sub
(
size_t
 
size
)

178 
	`©omic_sub_z
(&
¡©s_ÿùive
, 
size
);

179 
	}
}

	@deps/jemalloc/include/jemalloc/internal/tcache.h

2 #ifdeà
JEMALLOC_H_TYPES


4 
tÿche_bš_šfo_s
 
	ttÿche_bš_šfo_t
;

5 
tÿche_bš_s
 
	ttÿche_bš_t
;

6 
tÿche_s
 
	ttÿche_t
;

7 
tÿches_s
 
	ttÿches_t
;

14 
	#TCACHE_STATE_DISABLED
 ((
tÿche_t
 *)(
ušŒ_t
)1)

	)

15 
	#TCACHE_STATE_REINCARNATED
 ((
tÿche_t
 *)(
ušŒ_t
)2)

	)

16 
	#TCACHE_STATE_PURGATORY
 ((
tÿche_t
 *)(
ušŒ_t
)3)

	)

17 
	#TCACHE_STATE_MAX
 
TCACHE_STATE_PURGATORY


	)

22 
	#TCACHE_NSLOTS_SMALL_MIN
 20

	)

31 
	#TCACHE_NSLOTS_SMALL_MAX
 200

	)

34 
	#TCACHE_NSLOTS_LARGE
 20

	)

37 
	#LG_TCACHE_MAXCLASS_DEFAULT
 15

	)

44 
	#TCACHE_GC_SWEEP
 8192

	)

47 
	#TCACHE_GC_INCR
 \

48 ((
TCACHE_GC_SWEEP
 / 
NBINS
è+ ((TCACHE_GC_SWEEP / NBINS =ğ0è? 0 : 1))

	)

52 #ifdeà
JEMALLOC_H_STRUCTS


55 
	mtÿche_’abËd_çl£
 = 0,

56 
	mtÿche_’abËd_Œue
 = 1,

57 
	mtÿche_’abËd_deçuÉ
 = 2

58 } 
	ttÿche_’abËd_t
;

64 
	stÿche_bš_šfo_s
 {

65 
	mnÿched_max
;

68 
	stÿche_bš_s
 {

69 
tÿche_bš_¡©s_t
 
	mt¡©s
;

70 
	mlow_w©”
;

71 
	mlg_fl_div
;

72 
	mnÿched
;

73 **
	mava
;

76 
	stÿche_s
 {

77 
ql_–m
(
tÿche_t
è
	mlšk
;

78 
ušt64_t
 
	m´of_accumby‹s
;

79 
	mev_út
;

80 
szšd_t
 
	mÃxt_gc_bš
;

81 
tÿche_bš_t
 
	mtbšs
[1];

91 
	stÿches_s
 {

93 
tÿche_t
 *
	mtÿche
;

94 
tÿches_t
 *
	mÃxt
;

100 #ifdeà
JEMALLOC_H_EXTERNS


102 
boŞ
 
İt_tÿche
;

103 
ssize_t
 
İt_lg_tÿche_max
;

105 
tÿche_bš_šfo_t
 *
tÿche_bš_šfo
;

111 
size_t
 
nhbšs
;

114 
size_t
 
tÿche_maxşass
;

124 
tÿches_t
 *
tÿches
;

126 
size_t
 
tÿche_§Îoc
(cÚ¡ *
±r
);

127 
tÿche_ev’t_h¬d
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
);

128 *
tÿche_®loc_sm®l_h¬d
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
,

129 
tÿche_bš_t
 *
tbš
, 
szšd_t
 
bššd
);

130 
tÿche_bš_æush_sm®l
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, 
tÿche_bš_t
 *
tbš
,

131 
szšd_t
 
bššd
, 
»m
);

132 
tÿche_bš_æush_Ïrge
(
tsd_t
 *
tsd
, 
tÿche_bš_t
 *
tbš
, 
szšd_t
 
bššd
,

133 
»m
, 
tÿche_t
 *
tÿche
);

134 
tÿche_¬’a_assocŸ‹
(
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
);

135 
tÿche_¬’a_»assocŸ‹
(
tÿche_t
 *
tÿche
, 
¬’a_t
 *
Şd¬’a
,

136 
¬’a_t
 *
Ãw¬’a
);

137 
tÿche_¬’a_dissocŸ‹
(
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
);

138 
tÿche_t
 *
tÿche_g‘_h¬d
(
tsd_t
 *
tsd
);

139 
tÿche_t
 *
tÿche_ü—‹
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
);

140 
tÿche_ş—nup
(
tsd_t
 *
tsd
);

141 
tÿche_’abËd_ş—nup
(
tsd_t
 *
tsd
);

142 
tÿche_¡©s_m”ge
(
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
);

143 
boŞ
 
tÿches_ü—‹
(
tsd_t
 *
tsd
, *
r_šd
);

144 
tÿches_æush
(
tsd_t
 *
tsd
, 
šd
);

145 
tÿches_de¡roy
(
tsd_t
 *
tsd
, 
šd
);

146 
boŞ
 
tÿche_boÙ
();

150 #ifdeà
JEMALLOC_H_INLINES


152 #iâdeà
JEMALLOC_ENABLE_INLINE


153 
tÿche_ev’t
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
);

154 
tÿche_æush
();

155 
boŞ
 
tÿche_’abËd_g‘
();

156 
tÿche_t
 *
tÿche_g‘
(
tsd_t
 *
tsd
, 
boŞ
 
ü—‹
);

157 
tÿche_’abËd_£t
(
boŞ
 
’abËd
);

158 *
tÿche_®loc_—sy
(
tÿche_bš_t
 *
tbš
);

159 *
tÿche_®loc_sm®l
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
,

160 
size_t
 
size
, 
boŞ
 
z”o
);

161 *
tÿche_®loc_Ïrge
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
,

162 
size_t
 
size
, 
boŞ
 
z”o
);

163 
tÿche_d®loc_sm®l
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, *
±r
,

164 
szšd_t
 
bššd
);

165 
tÿche_d®loc_Ïrge
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, *
±r
,

166 
size_t
 
size
);

167 
tÿche_t
 *
tÿches_g‘
(
tsd_t
 *
tsd
, 
šd
);

170 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_TCACHE_C_
))

171 
JEMALLOC_INLINE
 

172 
	$tÿche_æush
()

174 
tsd_t
 *
tsd
;

176 
	`ÿs£¹
(
cÚfig_tÿche
);

178 
tsd
 = 
	`tsd_ãtch
();

179 
	`tÿche_ş—nup
(
tsd
);

180 
	}
}

182 
JEMALLOC_INLINE
 
boŞ


183 
	$tÿche_’abËd_g‘
()

185 
tsd_t
 *
tsd
;

186 
tÿche_’abËd_t
 
tÿche_’abËd
;

188 
	`ÿs£¹
(
cÚfig_tÿche
);

190 
tsd
 = 
	`tsd_ãtch
();

191 
tÿche_’abËd
 = 
	`tsd_tÿche_’abËd_g‘
(
tsd
);

192 ià(
tÿche_’abËd
 =ğ
tÿche_’abËd_deçuÉ
) {

193 
tÿche_’abËd
 = (
tÿche_’abËd_t
)
İt_tÿche
;

194 
	`tsd_tÿche_’abËd_£t
(
tsd
, 
tÿche_’abËd
);

197  ((
boŞ
)
tÿche_’abËd
);

198 
	}
}

200 
JEMALLOC_INLINE
 

201 
	$tÿche_’abËd_£t
(
boŞ
 
’abËd
)

203 
tsd_t
 *
tsd
;

204 
tÿche_’abËd_t
 
tÿche_’abËd
;

206 
	`ÿs£¹
(
cÚfig_tÿche
);

208 
tsd
 = 
	`tsd_ãtch
();

210 
tÿche_’abËd
 = (
tÿche_’abËd_t
)
’abËd
;

211 
	`tsd_tÿche_’abËd_£t
(
tsd
, 
tÿche_’abËd
);

213 ià(!
’abËd
)

214 
	`tÿche_ş—nup
(
tsd
);

215 
	}
}

217 
JEMALLOC_ALWAYS_INLINE
 
tÿche_t
 *

218 
	$tÿche_g‘
(
tsd_t
 *
tsd
, 
boŞ
 
ü—‹
)

220 
tÿche_t
 *
tÿche
;

222 ià(!
cÚfig_tÿche
)

223  (
NULL
);

225 
tÿche
 = 
	`tsd_tÿche_g‘
(
tsd
);

226 ià(!
ü—‹
)

227  (
tÿche
);

228 ià(
	`uÆik–y
(
tÿche
 =ğ
NULL
è&& 
	`tsd_nomš®
(
tsd
)) {

229 
tÿche
 = 
	`tÿche_g‘_h¬d
(
tsd
);

230 
	`tsd_tÿche_£t
(
tsd
, 
tÿche
);

233  (
tÿche
);

234 
	}
}

236 
JEMALLOC_ALWAYS_INLINE
 

237 
	$tÿche_ev’t
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
)

240 ià(
TCACHE_GC_INCR
 == 0)

243 
tÿche
->
ev_út
++;

244 
	`as£¹
(
tÿche
->
ev_út
 <ğ
TCACHE_GC_INCR
);

245 ià(
	`uÆik–y
(
tÿche
->
ev_út
 =ğ
TCACHE_GC_INCR
))

246 
	`tÿche_ev’t_h¬d
(
tsd
, 
tÿche
);

247 
	}
}

249 
JEMALLOC_ALWAYS_INLINE
 *

250 
	$tÿche_®loc_—sy
(
tÿche_bš_t
 *
tbš
)

252 *
»t
;

254 ià(
	`uÆik–y
(
tbš
->
nÿched
 == 0)) {

255 
tbš
->
low_w©”
 = -1;

256  (
NULL
);

258 
tbš
->
nÿched
--;

259 ià(
	`uÆik–y
(()
tbš
->
nÿched
 <bš->
low_w©”
))

260 
tbš
->
low_w©”
 =bš->
nÿched
;

261 
»t
 = 
tbš
->
ava
[tbš->
nÿched
];

262  (
»t
);

263 
	}
}

265 
JEMALLOC_ALWAYS_INLINE
 *

266 
	$tÿche_®loc_sm®l
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
, 
size_t
 
size
,

267 
boŞ
 
z”o
)

269 *
»t
;

270 
szšd_t
 
bššd
;

271 
size_t
 
usize
;

272 
tÿche_bš_t
 *
tbš
;

274 
bššd
 = 
	`size2šdex
(
size
);

275 
	`as£¹
(
bššd
 < 
NBINS
);

276 
tbš
 = &
tÿche
->
tbšs
[
bššd
];

277 
usize
 = 
	`šdex2size
(
bššd
);

278 
»t
 = 
	`tÿche_®loc_—sy
(
tbš
);

279 ià(
	`uÆik–y
(
»t
 =ğ
NULL
)) {

280 
»t
 = 
	`tÿche_®loc_sm®l_h¬d
(
tsd
, 
¬’a
, 
tÿche
, 
tbš
, 
bššd
);

281 ià(
»t
 =ğ
NULL
)

282  (
NULL
);

284 
	`as£¹
(
	`tÿche_§Îoc
(
»t
è=ğ
usize
);

286 ià(
	`lik–y
(!
z”o
)) {

287 ià(
cÚfig_fl
) {

288 ià(
	`uÆik–y
(
İt_junk_®loc
)) {

289 
	`¬’a_®loc_junk_sm®l
(
»t
,

290 &
¬’a_bš_šfo
[
bššd
], 
çl£
);

291 } ià(
	`uÆik–y
(
İt_z”o
))

292 
	`mem£t
(
»t
, 0, 
usize
);

295 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
)) {

296 
	`¬’a_®loc_junk_sm®l
(
»t
, &
¬’a_bš_šfo
[
bššd
],

297 
Œue
);

299 
	`mem£t
(
»t
, 0, 
usize
);

302 ià(
cÚfig_¡©s
)

303 
tbš
->
t¡©s
.
Äeque¡s
++;

304 ià(
cÚfig_´of
)

305 
tÿche
->
´of_accumby‹s
 +ğ
usize
;

306 
	`tÿche_ev’t
(
tsd
, 
tÿche
);

307  (
»t
);

308 
	}
}

310 
JEMALLOC_ALWAYS_INLINE
 *

311 
	$tÿche_®loc_Ïrge
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
, 
size_t
 
size
,

312 
boŞ
 
z”o
)

314 *
»t
;

315 
szšd_t
 
bššd
;

316 
size_t
 
usize
;

317 
tÿche_bš_t
 *
tbš
;

319 
bššd
 = 
	`size2šdex
(
size
);

320 
usize
 = 
	`šdex2size
(
bššd
);

321 
	`as£¹
(
usize
 <ğ
tÿche_maxşass
);

322 
	`as£¹
(
bššd
 < 
nhbšs
);

323 
tbš
 = &
tÿche
->
tbšs
[
bššd
];

324 
»t
 = 
	`tÿche_®loc_—sy
(
tbš
);

325 ià(
	`uÆik–y
(
»t
 =ğ
NULL
)) {

330 
»t
 = 
	`¬’a_m®loc_Ïrge
(
¬’a
, 
usize
, 
z”o
);

331 ià(
»t
 =ğ
NULL
)

332  (
NULL
);

334 ià(
cÚfig_´of
 && 
usize
 =ğ
LARGE_MINCLASS
) {

335 
¬’a_chunk_t
 *
chunk
 =

336 (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
»t
);

337 
size_t
 
·gešd
 = (((
ušŒ_t
)
»t
 - (ušŒ_t)
chunk
) >>

338 
LG_PAGE
);

339 
	`¬’a_m­b™s_Ïrge_bššd_£t
(
chunk
, 
·gešd
,

340 
BININD_INVALID
);

342 ià(
	`lik–y
(!
z”o
)) {

343 ià(
cÚfig_fl
) {

344 ià(
	`uÆik–y
(
İt_junk_®loc
))

345 
	`mem£t
(
»t
, 0xa5, 
usize
);

346 ià(
	`uÆik–y
(
İt_z”o
))

347 
	`mem£t
(
»t
, 0, 
usize
);

350 
	`mem£t
(
»t
, 0, 
usize
);

352 ià(
cÚfig_¡©s
)

353 
tbš
->
t¡©s
.
Äeque¡s
++;

354 ià(
cÚfig_´of
)

355 
tÿche
->
´of_accumby‹s
 +ğ
usize
;

358 
	`tÿche_ev’t
(
tsd
, 
tÿche
);

359  (
»t
);

360 
	}
}

362 
JEMALLOC_ALWAYS_INLINE
 

363 
	$tÿche_d®loc_sm®l
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, *
±r
, 
szšd_t
 
bššd
)

365 
tÿche_bš_t
 *
tbš
;

366 
tÿche_bš_šfo_t
 *
tbš_šfo
;

368 
	`as£¹
(
	`tÿche_§Îoc
(
±r
è<ğ
SMALL_MAXCLASS
);

370 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
))

371 
	`¬’a_d®loc_junk_sm®l
(
±r
, &
¬’a_bš_šfo
[
bššd
]);

373 
tbš
 = &
tÿche
->
tbšs
[
bššd
];

374 
tbš_šfo
 = &
tÿche_bš_šfo
[
bššd
];

375 ià(
	`uÆik–y
(
tbš
->
nÿched
 =ğ
tbš_šfo
->
nÿched_max
)) {

376 
	`tÿche_bš_æush_sm®l
(
tsd
, 
tÿche
, 
tbš
, 
bššd
,

377 (
tbš_šfo
->
nÿched_max
 >> 1));

379 
	`as£¹
(
tbš
->
nÿched
 < 
tbš_šfo
->
nÿched_max
);

380 
tbš
->
ava
[tbš->
nÿched
] = 
±r
;

381 
tbš
->
nÿched
++;

383 
	`tÿche_ev’t
(
tsd
, 
tÿche
);

384 
	}
}

386 
JEMALLOC_ALWAYS_INLINE
 

387 
	$tÿche_d®loc_Ïrge
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, *
±r
, 
size_t
 
size
)

389 
szšd_t
 
bššd
;

390 
tÿche_bš_t
 *
tbš
;

391 
tÿche_bš_šfo_t
 *
tbš_šfo
;

393 
	`as£¹
((
size
 & 
PAGE_MASK
) == 0);

394 
	`as£¹
(
	`tÿche_§Îoc
(
±r
è> 
SMALL_MAXCLASS
);

395 
	`as£¹
(
	`tÿche_§Îoc
(
±r
è<ğ
tÿche_maxşass
);

397 
bššd
 = 
	`size2šdex
(
size
);

399 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
))

400 
	`¬’a_d®loc_junk_Ïrge
(
±r
, 
size
);

402 
tbš
 = &
tÿche
->
tbšs
[
bššd
];

403 
tbš_šfo
 = &
tÿche_bš_šfo
[
bššd
];

404 ià(
	`uÆik–y
(
tbš
->
nÿched
 =ğ
tbš_šfo
->
nÿched_max
)) {

405 
	`tÿche_bš_æush_Ïrge
(
tsd
, 
tbš
, 
bššd
,

406 (
tbš_šfo
->
nÿched_max
 >> 1), 
tÿche
);

408 
	`as£¹
(
tbš
->
nÿched
 < 
tbš_šfo
->
nÿched_max
);

409 
tbš
->
ava
[tbš->
nÿched
] = 
±r
;

410 
tbš
->
nÿched
++;

412 
	`tÿche_ev’t
(
tsd
, 
tÿche
);

413 
	}
}

415 
JEMALLOC_ALWAYS_INLINE
 
tÿche_t
 *

416 
	$tÿches_g‘
(
tsd_t
 *
tsd
, 
šd
)

418 
tÿches_t
 *
–m
 = &
tÿches
[
šd
];

419 ià(
	`uÆik–y
(
–m
->
tÿche
 =ğ
NULL
))

420 
–m
->
tÿche
 = 
	`tÿche_ü—‹
(
tsd
, 
	`¬’a_choo£
Ñsd, 
NULL
));

421  (
–m
->
tÿche
);

422 
	}
}

	@deps/jemalloc/include/jemalloc/internal/tsd.h

2 #ifdeà
JEMALLOC_H_TYPES


5 
	#MALLOC_TSD_CLEANUPS_MAX
 2

	)

7 
	$boŞ
 (*
	tm®loc_tsd_ş—nup_t
)();

9 #ià(!
	`defšed
(
JEMALLOC_MALLOC_THREAD_CLEANUP
è&& !defšed(
JEMALLOC_TLS
) && \

10 !
	$defšed
(
_WIN32
))

11 
tsd_š™_block_s
 
	ttsd_š™_block_t
;

12 
tsd_š™_h—d_s
 
	ttsd_š™_h—d_t
;

15 
tsd_s
 
	ttsd_t
;

18 
tsd_¡©e_unš™Ÿlized
,

19 
tsd_¡©e_nomš®
,

20 
tsd_¡©e_purg©Üy
,

21 
tsd_¡©e_»šÿº©ed


22 } 
	ttsd_¡©e_t
;

75 #ifdeà
JEMALLOC_MALLOC_THREAD_CLEANUP


76 
	#m®loc_tsd_ty³s
(
a_Çme
, 
a_ty³
)

	)

77 #–ià(
	`defšed
(
JEMALLOC_TLS
))

78 
	#m®loc_tsd_ty³s
(
a_Çme
, 
a_ty³
)

	)

79 #–ià(
	`defšed
(
_WIN32
))

80 
	#m®loc_tsd_ty³s
(
a_Çme
, 
a_ty³
) \

82 
boŞ
 
š™Ÿlized
; \

83 
a_ty³
 
v®
; \

84 } 
	ta_Çme
##
	ttsd_w¿µ”_t
;

	)

86 
	#m®loc_tsd_ty³s
(
a_Çme
, 
a_ty³
) \

88 
boŞ
 
š™Ÿlized
; \

89 
a_ty³
 
v®
; \

90 } 
	ta_Çme
##
	ttsd_w¿µ”_t
;

	)

94 
	#m®loc_tsd_´Ùos
(
a_©Œ
, 
a_Çme
, 
a_ty³
) \

95 
a_©Œ
 
boŞ
 \

96 
a_Çme
##
	`tsd_boÙ0
(); \

97 
a_©Œ
 \

98 
a_Çme
##
	`tsd_boÙ1
(); \

99 
a_©Œ
 
boŞ
 \

100 
a_Çme
##
	`tsd_boÙ
(); \

101 
a_©Œ
 
a_ty³
 * \

102 
a_Çme
##
	`tsd_g‘
(); \

103 
a_©Œ
 \

104 
a_Çme
##
	`tsd_£t
(
a_ty³
 *
v®
);

	)

107 #ifdeà
JEMALLOC_MALLOC_THREAD_CLEANUP


108 
	#m®loc_tsd_ex‹ºs
(
a_Çme
, 
a_ty³
) \

109 
__th»ad
 
a_ty³
 
a_Çme
##
tsd_s
; \

110 
__th»ad
 
boŞ
 
a_Çme
##
tsd_š™Ÿlized
; \

111 
boŞ
 
a_Çme
##
tsd_boÙed
;

	)

112 #–ià(
	`defšed
(
JEMALLOC_TLS
))

113 
	#m®loc_tsd_ex‹ºs
(
a_Çme
, 
a_ty³
) \

114 
__th»ad
 
a_ty³
 
a_Çme
##
tsd_s
; \

115 
±h»ad_key_t
 
a_Çme
##
tsd_tsd
; \

116 
boŞ
 
a_Çme
##
tsd_boÙed
;

	)

117 #–ià(
	`defšed
(
_WIN32
))

118 
	#m®loc_tsd_ex‹ºs
(
a_Çme
, 
a_ty³
) \

119 
DWORD
 
a_Çme
##
tsd_tsd
; \

120 
a_Çme
##
tsd_w¿µ”_t
‡_Çme##
tsd_boÙ_w¿µ”
; \

121 
boŞ
 
a_Çme
##
tsd_boÙed
;

	)

123 
	#m®loc_tsd_ex‹ºs
(
a_Çme
, 
a_ty³
) \

124 
±h»ad_key_t
 
a_Çme
##
tsd_tsd
; \

125 
tsd_š™_h—d_t
 
a_Çme
##
tsd_š™_h—d
; \

126 
a_Çme
##
tsd_w¿µ”_t
‡_Çme##
tsd_boÙ_w¿µ”
; \

127 
boŞ
 
a_Çme
##
tsd_boÙed
;

	)

131 #ifdeà
JEMALLOC_MALLOC_THREAD_CLEANUP


132 
	#m®loc_tsd_d©a
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
) \

133 
a_©Œ
 
__th»ad
 
a_ty³
 
JEMALLOC_TLS_MODEL
 \

134 
a_Çme
##
tsd_s
 = 
a_š™Ÿliz”
; \

135 
a_©Œ
 
__th»ad
 
boŞ
 
JEMALLOC_TLS_MODEL
 \

136 
a_Çme
##
tsd_š™Ÿlized
 = 
çl£
; \

137 
a_©Œ
 
boŞ
 
a_Çme
##
tsd_boÙed
 = 
çl£
;

	)

138 #–ià(
	`defšed
(
JEMALLOC_TLS
))

139 
	#m®loc_tsd_d©a
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
) \

140 
a_©Œ
 
__th»ad
 
a_ty³
 
JEMALLOC_TLS_MODEL
 \

141 
a_Çme
##
tsd_s
 = 
a_š™Ÿliz”
; \

142 
a_©Œ
 
±h»ad_key_t
 
a_Çme
##
tsd_tsd
; \

143 
a_©Œ
 
boŞ
 
a_Çme
##
tsd_boÙed
 = 
çl£
;

	)

144 #–ià(
	`defšed
(
_WIN32
))

145 
	#m®loc_tsd_d©a
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
) \

146 
a_©Œ
 
DWORD
 
a_Çme
##
tsd_tsd
; \

147 
a_©Œ
 
a_Çme
##
tsd_w¿µ”_t
‡_Çme##
tsd_boÙ_w¿µ”
 = { \

148 
çl£
, \

149 
a_š™Ÿliz”
 \

150 
	}
}; \

151 
a_©Œ
 
boŞ
 
a_Çme
##
tsd_boÙed
 = 
çl£
;

	)

153 
	#m®loc_tsd_d©a
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
) \

154 
a_©Œ
 
±h»ad_key_t
 
a_Çme
##
tsd_tsd
; \

155 
a_©Œ
 
tsd_š™_h—d_t
 
a_Çme
##
tsd_š™_h—d
 = { \

156 
	`ql_h—d_š™Ÿliz”
(
blocks
), \

157 
MALLOC_MUTEX_INITIALIZER
 \

159 
a_©Œ
 
a_Çme
##
tsd_w¿µ”_t
‡_Çme##
tsd_boÙ_w¿µ”
 = { \

160 
çl£
, \

161 
a_š™Ÿliz”
 \

163 
a_©Œ
 
boŞ
 
a_Çme
##
tsd_boÙed
 = 
çl£
;

	)

167 #ifdeà
JEMALLOC_MALLOC_THREAD_CLEANUP


168 
	#m®loc_tsd_funcs
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
, \

169 
a_ş—nup
) \

171 
a_©Œ
 
boŞ
 \

172 
a_Çme
##
	`tsd_ş—nup_w¿µ”
() \

175 ià(
a_Çme
##
tsd_š™Ÿlized
) { \

176 
a_Çme
##
tsd_š™Ÿlized
 = 
çl£
; \

177 
	`a_ş—nup
(&
a_Çme
##
tsd_s
); \

179  (
a_Çme
##
tsd_š™Ÿlized
); \

181 
a_©Œ
 
boŞ
 \

182 
a_Çme
##
	`tsd_boÙ0
() \

185 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) { \

186 
	`m®loc_tsd_ş—nup_»gi¡”
( \

187 &
a_Çme
##
tsd_ş—nup_w¿µ”
); \

189 
a_Çme
##
tsd_boÙed
 = 
Œue
; \

190  (
çl£
); \

192 
a_©Œ
 \

193 
a_Çme
##
	`tsd_boÙ1
() \

198 
a_©Œ
 
boŞ
 \

199 
a_Çme
##
	`tsd_boÙ
() \

202  (
a_Çme
##
	`tsd_boÙ0
()); \

205 
a_©Œ
 
a_ty³
 * \

206 
a_Çme
##
	`tsd_g‘
() \

209 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

210  (&
a_Çme
##
tsd_s
); \

212 
a_©Œ
 \

213 
a_Çme
##
	`tsd_£t
(
a_ty³
 *
v®
) \

216 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

217 
a_Çme
##
tsd_s
 = (*
v®
); \

218 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) \

219 
a_Çme
##
tsd_š™Ÿlized
 = 
Œue
; \

220 }

	)

221 #–ià(
defšed
(
JEMALLOC_TLS
))

222 
	#m®loc_tsd_funcs
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
, \

223 
a_ş—nup
) \

225 
a_©Œ
 
boŞ
 \

226 
a_Çme
##
	`tsd_boÙ0
() \

229 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) { \

230 ià(
	`±h»ad_key_ü—‹
(&
a_Çme
##
tsd_tsd
, 
a_ş—nup
) != \

232  (
Œue
); \

234 
a_Çme
##
tsd_boÙed
 = 
Œue
; \

235  (
çl£
); \

237 
a_©Œ
 \

238 
a_Çme
##
	`tsd_boÙ1
() \

243 
a_©Œ
 
boŞ
 \

244 
a_Çme
##
	`tsd_boÙ
() \

247  (
a_Çme
##
	`tsd_boÙ0
()); \

250 
a_©Œ
 
a_ty³
 * \

251 
a_Çme
##
	`tsd_g‘
() \

254 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

255  (&
a_Çme
##
tsd_s
); \

257 
a_©Œ
 \

258 
a_Çme
##
	`tsd_£t
(
a_ty³
 *
v®
) \

261 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

262 
a_Çme
##
tsd_s
 = (*
v®
); \

263 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) { \

264 ià(
	`±h»ad_£t¥ecific
(
a_Çme
##
tsd_tsd
, \

265 (*)(&
a_Çme
##
tsd_s
))) { \

266 
	`m®loc_wr™e
("<jemalloc>: Error" \

268 ià(
İt_abÜt
) \

269 
	`abÜt
(); \

272 }

	)

273 #–ià(
defšed
(
_WIN32
))

274 
	#m®loc_tsd_funcs
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
, \

275 
a_ş—nup
) \

277 
a_©Œ
 
boŞ
 \

278 
a_Çme
##
	`tsd_ş—nup_w¿µ”
() \

280 
DWORD
 
”rÜ
 = 
	`G‘La¡E¼Ü
(); \

281 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
 = (a_name##tsd_wrapper_t *) \

282 
	`TlsG‘V®ue
(
a_Çme
##
tsd_tsd
); \

283 
	`S‘La¡E¼Ü
(
”rÜ
); \

285 ià(
w¿µ”
 =ğ
NULL
) \

286  (
çl£
); \

287 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
 && \

288 
w¿µ”
->
š™Ÿlized
) { \

289 
w¿µ”
->
š™Ÿlized
 = 
çl£
; \

290 
	`a_ş—nup
(&
w¿µ”
->
v®
); \

291 ià(
w¿µ”
->
š™Ÿlized
) { \

293  (
Œue
); \

296 
	`m®loc_tsd_d®loc
(
w¿µ”
); \

297  (
çl£
); \

299 
a_©Œ
 \

300 
a_Çme
##
	`tsd_w¿µ”_£t
×_Çme##
tsd_w¿µ”_t
 *
w¿µ”
) \

303 ià(!
	`TlsS‘V®ue
(
a_Çme
##
tsd_tsd
, (*)
w¿µ”
)) { \

304 
	`m®loc_wr™e
("<jemalloc>: Error setting" \

306 
	`abÜt
(); \

309 
a_©Œ
 
a_Çme
##
tsd_w¿µ”_t
 * \

310 
a_Çme
##
	`tsd_w¿µ”_g‘
() \

312 
DWORD
 
”rÜ
 = 
	`G‘La¡E¼Ü
(); \

313 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
 = (a_name##tsd_wrapper_t *) \

314 
	`TlsG‘V®ue
(
a_Çme
##
tsd_tsd
); \

315 
	`S‘La¡E¼Ü
(
”rÜ
); \

317 ià(
	`uÆik–y
(
w¿µ”
 =ğ
NULL
)) { \

318 
w¿µ”
 = (
a_Çme
##
tsd_w¿µ”_t
 *) \

319 
	`m®loc_tsd_m®loc
((
a_Çme
##
tsd_w¿µ”_t
)); \

320 ià(
w¿µ”
 =ğ
NULL
) { \

321 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating" \

323 
	`abÜt
(); \

325 
w¿µ”
->
š™Ÿlized
 = 
çl£
; \

326 
w¿µ”
->
v®
 = 
a_š™Ÿliz”
; \

328 
a_Çme
##
	`tsd_w¿µ”_£t
(
w¿µ”
); \

330  (
w¿µ”
); \

332 
a_©Œ
 
boŞ
 \

333 
a_Çme
##
	`tsd_boÙ0
() \

336 
a_Çme
##
tsd_tsd
 = 
	`TlsAÎoc
(); \

337 ià(
a_Çme
##
tsd_tsd
 =ğ
TLS_OUT_OF_INDEXES
) \

338  (
Œue
); \

339 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) { \

340 
	`m®loc_tsd_ş—nup_»gi¡”
( \

341 &
a_Çme
##
tsd_ş—nup_w¿µ”
); \

343 
a_Çme
##
	`tsd_w¿µ”_£t
(&a_Çme##
tsd_boÙ_w¿µ”
); \

344 
a_Çme
##
tsd_boÙed
 = 
Œue
; \

345  (
çl£
); \

347 
a_©Œ
 \

348 
a_Çme
##
	`tsd_boÙ1
() \

350 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

351 
w¿µ”
 = (
a_Çme
##
tsd_w¿µ”_t
 *) \

352 
	`m®loc_tsd_m®loc
((
a_Çme
##
tsd_w¿µ”_t
)); \

353 ià(
w¿µ”
 =ğ
NULL
) { \

354 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating" \

356 
	`abÜt
(); \

358 
	`memıy
(
w¿µ”
, &
a_Çme
##
tsd_boÙ_w¿µ”
, \

359 (
a_Çme
##
tsd_w¿µ”_t
)); \

360 
a_Çme
##
	`tsd_w¿µ”_£t
(
w¿µ”
); \

362 
a_©Œ
 
boŞ
 \

363 
a_Çme
##
	`tsd_boÙ
() \

366 ià(
a_Çme
##
	`tsd_boÙ0
()) \

367  (
Œue
); \

368 
a_Çme
##
	`tsd_boÙ1
(); \

369  (
çl£
); \

372 
a_©Œ
 
a_ty³
 * \

373 
a_Çme
##
	`tsd_g‘
() \

375 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

377 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

378 
w¿µ”
 = 
a_Çme
##
	`tsd_w¿µ”_g‘
(); \

379  (&
w¿µ”
->
v®
); \

381 
a_©Œ
 \

382 
a_Çme
##
	`tsd_£t
(
a_ty³
 *
v®
) \

384 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

386 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

387 
w¿µ”
 = 
a_Çme
##
	`tsd_w¿µ”_g‘
(); \

388 
w¿µ”
->
v®
 = *(val); \

389 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) \

390 
w¿µ”
->
š™Ÿlized
 = 
Œue
; \

391 }

	)

393 
	#m®loc_tsd_funcs
(
a_©Œ
, 
a_Çme
, 
a_ty³
, 
a_š™Ÿliz”
, \

394 
a_ş—nup
) \

396 
a_©Œ
 \

397 
a_Çme
##
	`tsd_ş—nup_w¿µ”
(*
¬g
) \

399 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
 = (a_Çme##tsd_w¿µ”_ˆ*)
¬g
; \

401 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
 && \

402 
w¿µ”
->
š™Ÿlized
) { \

403 
w¿µ”
->
š™Ÿlized
 = 
çl£
; \

404 
	`a_ş—nup
(&
w¿µ”
->
v®
); \

405 ià(
w¿µ”
->
š™Ÿlized
) { \

407 ià(
	`±h»ad_£t¥ecific
(
a_Çme
##
tsd_tsd
, \

408 (*)
w¿µ”
)) { \

409 
	`m®loc_wr™e
("<jemalloc>: Error" \

411 ià(
İt_abÜt
) \

412 
	`abÜt
(); \

417 
	`m®loc_tsd_d®loc
(
w¿µ”
); \

419 
a_©Œ
 \

420 
a_Çme
##
	`tsd_w¿µ”_£t
×_Çme##
tsd_w¿µ”_t
 *
w¿µ”
) \

423 ià(
	`±h»ad_£t¥ecific
(
a_Çme
##
tsd_tsd
, \

424 (*)
w¿µ”
)) { \

425 
	`m®loc_wr™e
("<jemalloc>: Error setting" \

427 
	`abÜt
(); \

430 
a_©Œ
 
a_Çme
##
tsd_w¿µ”_t
 * \

431 
a_Çme
##
	`tsd_w¿µ”_g‘
() \

433 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
 = (a_name##tsd_wrapper_t *) \

434 
	`±h»ad_g‘¥ecific
(
a_Çme
##
tsd_tsd
); \

436 ià(
	`uÆik–y
(
w¿µ”
 =ğ
NULL
)) { \

437 
tsd_š™_block_t
 
block
; \

438 
w¿µ”
 = 
	`tsd_š™_check_»cursiÚ
( \

439 &
a_Çme
##
tsd_š™_h—d
, &
block
); \

440 ià(
w¿µ”
) \

441  (
w¿µ”
); \

442 
w¿µ”
 = (
a_Çme
##
tsd_w¿µ”_t
 *) \

443 
	`m®loc_tsd_m®loc
((
a_Çme
##
tsd_w¿µ”_t
)); \

444 
block
.
d©a
 = 
w¿µ”
; \

445 ià(
w¿µ”
 =ğ
NULL
) { \

446 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating" \

448 
	`abÜt
(); \

450 
w¿µ”
->
š™Ÿlized
 = 
çl£
; \

451 
w¿µ”
->
v®
 = 
a_š™Ÿliz”
; \

453 
a_Çme
##
	`tsd_w¿µ”_£t
(
w¿µ”
); \

454 
	`tsd_š™_fšish
(&
a_Çme
##
tsd_š™_h—d
, &
block
); \

456  (
w¿µ”
); \

458 
a_©Œ
 
boŞ
 \

459 
a_Çme
##
	`tsd_boÙ0
() \

462 ià(
	`±h»ad_key_ü—‹
(&
a_Çme
##
tsd_tsd
, \

463 
a_Çme
##
tsd_ş—nup_w¿µ”
) != 0) \

464  (
Œue
); \

465 
a_Çme
##
	`tsd_w¿µ”_£t
(&a_Çme##
tsd_boÙ_w¿µ”
); \

466 
a_Çme
##
tsd_boÙed
 = 
Œue
; \

467  (
çl£
); \

469 
a_©Œ
 \

470 
a_Çme
##
	`tsd_boÙ1
() \

472 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

473 
w¿µ”
 = (
a_Çme
##
tsd_w¿µ”_t
 *) \

474 
	`m®loc_tsd_m®loc
((
a_Çme
##
tsd_w¿µ”_t
)); \

475 ià(
w¿µ”
 =ğ
NULL
) { \

476 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating" \

478 
	`abÜt
(); \

480 
	`memıy
(
w¿µ”
, &
a_Çme
##
tsd_boÙ_w¿µ”
, \

481 (
a_Çme
##
tsd_w¿µ”_t
)); \

482 
a_Çme
##
	`tsd_w¿µ”_£t
(
w¿µ”
); \

484 
a_©Œ
 
boŞ
 \

485 
a_Çme
##
	`tsd_boÙ
() \

488 ià(
a_Çme
##
	`tsd_boÙ0
()) \

489  (
Œue
); \

490 
a_Çme
##
	`tsd_boÙ1
(); \

491  (
çl£
); \

494 
a_©Œ
 
a_ty³
 * \

495 
a_Çme
##
	`tsd_g‘
() \

497 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

499 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

500 
w¿µ”
 = 
a_Çme
##
	`tsd_w¿µ”_g‘
(); \

501  (&
w¿µ”
->
v®
); \

503 
a_©Œ
 \

504 
a_Çme
##
	`tsd_£t
(
a_ty³
 *
v®
) \

506 
a_Çme
##
tsd_w¿µ”_t
 *
w¿µ”
; \

508 
	`as£¹
(
a_Çme
##
tsd_boÙed
); \

509 
w¿µ”
 = 
a_Çme
##
	`tsd_w¿µ”_g‘
(); \

510 
w¿µ”
->
v®
 = *(val); \

511 ià(
a_ş—nup
 !ğ
m®loc_tsd_no_ş—nup
) \

512 
w¿µ”
->
š™Ÿlized
 = 
Œue
; \

513 }

	)

518 #ifdeà
JEMALLOC_H_STRUCTS


520 #ià(!
defšed
(
JEMALLOC_MALLOC_THREAD_CLEANUP
è&& !defšed(
JEMALLOC_TLS
) && \

521 !
	$defšed
(
_WIN32
))

522 
	stsd_š™_block_s
 {

523 
	`ql_–m
(
tsd_š™_block_t
è
lšk
;

524 
±h»ad_t
 
th»ad
;

525 *
d©a
;

527 
	stsd_š™_h—d_s
 {

528 
	`ql_h—d
(
tsd_š™_block_t
è
blocks
;

529 
m®loc_mu‹x_t
 
lock
;

533 
	#MALLOC_TSD
 \

535 
	`O
(
tÿche
, 
tÿche_t
 *) \

536 
	`O
(
th»ad_®loÿ‹d
, 
ušt64_t
) \

537 
	`O
(
th»ad_d—Îoÿ‹d
, 
ušt64_t
) \

538 
	`O
(
´of_td©a
, 
´of_td©a_t
 *) \

539 
	`O
(
¬’a
, 
¬’a_t
 *) \

540 
	`O
(
¬’as_ÿche
, 
¬’a_t
 **) \

541 
	`O
(
Ç»Çs_ÿche
, ) \

542 
	`O
(
¬’as_ÿche_by·ss
, 
boŞ
) \

543 
	`O
(
tÿche_’abËd
, 
tÿche_’abËd_t
) \

544 
	`O
(
qu¬ªtše
, 
qu¬ªtše_t
 *) \

545 

	)

546 
	#TSD_INITIALIZER
 { \

547 
tsd_¡©e_unš™Ÿlized
, \

548 
NULL
, \

551 
NULL
, \

552 
NULL
, \

553 
NULL
, \

555 
çl£
, \

556 
tÿche_’abËd_deçuÉ
, \

557 
NULL
 \

558 
	}

	)
}

560 
	stsd_s
 {

561 
tsd_¡©e_t
 
	m¡©e
;

562 
	#O
(
n
, 
t
) \

563 
t
 
n
;

	)

564 
	mMALLOC_TSD


565 #undeà
O


568 cÚ¡ 
tsd_t
 
	gtsd_š™Ÿliz”
 = 
TSD_INITIALIZER
;

570 
	$m®loc_tsd_ty³s
(, 
tsd_t
)

574 #ifdeà
JEMALLOC_H_EXTERNS


576 *
	`m®loc_tsd_m®loc
(
size_t
 
size
);

577 
	`m®loc_tsd_d®loc
(*
w¿µ”
);

578 
	`m®loc_tsd_no_ş—nup
(*
¬g
);

579 
	`m®loc_tsd_ş—nup_»gi¡”
(
	$boŞ
 (*
f
)());

580 
boŞ
 
	`m®loc_tsd_boÙ0
();

581 
	`m®loc_tsd_boÙ1
();

582 #ià(!
	`defšed
(
JEMALLOC_MALLOC_THREAD_CLEANUP
è&& !defšed(
JEMALLOC_TLS
) && \

583 !
	$defšed
(
_WIN32
))

584 *
	`tsd_š™_check_»cursiÚ
(
tsd_š™_h—d_t
 *
h—d
,

585 
tsd_š™_block_t
 *
block
);

586 
	`tsd_š™_fšish
(
tsd_š™_h—d_t
 *
h—d
, 
tsd_š™_block_t
 *
block
);

588 
	`tsd_ş—nup
(*
¬g
);

592 #ifdeà
JEMALLOC_H_INLINES


594 #iâdeà
JEMALLOC_ENABLE_INLINE


595 
	`m®loc_tsd_´Ùos
(
	`JEMALLOC_ATTR
(
unu£d
), , 
tsd_t
)

597 
tsd_t
 *
	`tsd_ãtch
();

598 
boŞ
 
	`tsd_nomš®
(
tsd_t
 *
tsd
);

599 
	#O
(
n
, 
t
) \

600 
t
 *
tsd_
##
n
##
	`p_g‘
(
tsd_t
 *
tsd
); \

601 
t
 
tsd_
##
n
##
	`_g‘
(
tsd_t
 *
tsd
); \

602 
tsd_
##
n
##
	`_£t
(
tsd_t
 *
tsd
, 
t
‚);

	)

603 
MALLOC_TSD


604 #undeà
O


607 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_TSD_C_
))

608 
	$m®loc_tsd_ex‹ºs
(, 
tsd_t
)

609 
	$m®loc_tsd_funcs
(
JEMALLOC_ALWAYS_INLINE
, , 
tsd_t
, 
tsd_š™Ÿliz”
, 
tsd_ş—nup
)

611 
JEMALLOC_ALWAYS_INLINE
 
tsd_t
 *

612 
	$tsd_ãtch
()

614 
tsd_t
 *
tsd
 = 
	`tsd_g‘
();

616 ià(
	`uÆik–y
(
tsd
->
¡©e
 !ğ
tsd_¡©e_nomš®
)) {

617 ià(
tsd
->
¡©e
 =ğ
tsd_¡©e_unš™Ÿlized
) {

618 
tsd
->
¡©e
 = 
tsd_¡©e_nomš®
;

620 
	`tsd_£t
(
tsd
);

621 } ià(
tsd
->
¡©e
 =ğ
tsd_¡©e_purg©Üy
) {

622 
tsd
->
¡©e
 = 
tsd_¡©e_»šÿº©ed
;

623 
	`tsd_£t
(
tsd
);

625 
	`as£¹
(
tsd
->
¡©e
 =ğ
tsd_¡©e_»šÿº©ed
);

628  (
tsd
);

629 
	}
}

631 
JEMALLOC_INLINE
 
boŞ


632 
	$tsd_nomš®
(
tsd_t
 *
tsd
)

635  (
tsd
->
¡©e
 =ğ
tsd_¡©e_nomš®
);

636 
	}
}

638 
	#O
(
n
, 
t
) \

639 
JEMALLOC_ALWAYS_INLINE
 
t
 * \

640 
tsd_
##
n
##
	`p_g‘
(
tsd_t
 *
tsd
) \

643  (&
tsd
->
n
); \

646 
JEMALLOC_ALWAYS_INLINE
 
t
 \

647 
tsd_
##
n
##
	`_g‘
(
tsd_t
 *
tsd
) \

650  (*
tsd_
##
n
##
	`p_g‘
(
tsd
)); \

653 
JEMALLOC_ALWAYS_INLINE
 \

654 
tsd_
##
n
##
	`_£t
(
tsd_t
 *
tsd
, 
t
‚) \

657 
	`as£¹
(
tsd
->
¡©e
 =ğ
tsd_¡©e_nomš®
); \

658 
tsd
->
n
 =‚; \

659 }

	)

660 
	gMALLOC_TSD


661 #undeà
O


	@deps/jemalloc/include/jemalloc/internal/util.h

2 #ifdeà
JEMALLOC_H_TYPES


4 #ifdeà
_WIN32


5 #ifdeà
_WIN64


6 
	#FMT64_PREFIX
 "Î"

	)

7 
	#FMTPTR_PREFIX
 "Î"

	)

9 
	#FMT64_PREFIX
 "Î"

	)

10 
	#FMTPTR_PREFIX
 ""

	)

12 
	#FMTd32
 "d"

	)

13 
	#FMTu32
 "u"

	)

14 
	#FMTx32
 "x"

	)

15 
	#FMTd64
 
FMT64_PREFIX
 "d"

	)

16 
	#FMTu64
 
FMT64_PREFIX
 "u"

	)

17 
	#FMTx64
 
FMT64_PREFIX
 "x"

	)

18 
	#FMTdPTR
 
FMTPTR_PREFIX
 "d"

	)

19 
	#FMTuPTR
 
FMTPTR_PREFIX
 "u"

	)

20 
	#FMTxPTR
 
FMTPTR_PREFIX
 "x"

	)

22 
	~<š‰y³s.h
>

23 
	#FMTd32
 
PRId32


	)

24 
	#FMTu32
 
PRIu32


	)

25 
	#FMTx32
 
PRIx32


	)

26 
	#FMTd64
 
PRId64


	)

27 
	#FMTu64
 
PRIu64


	)

28 
	#FMTx64
 
PRIx64


	)

29 
	#FMTdPTR
 
PRIdPTR


	)

30 
	#FMTuPTR
 
PRIuPTR


	)

31 
	#FMTxPTR
 
PRIxPTR


	)

35 
	#BUFERROR_BUF
 64

	)

41 
	#MALLOC_PRINTF_BUFSIZE
 4096

	)

47 
	#JEMALLOC_ARG_CONCAT
(...è
__VA_ARGS__


	)

54 #ifdeà
JEMALLOC_CC_SILENCE


55 
	#JEMALLOC_CC_SILENCE_INIT
(
v
èğ
	)
v

57 
	#JEMALLOC_CC_SILENCE_INIT
(
v
)

	)

60 
	#JEMALLOC_GNUC_PREREQ
(
majÜ
, 
mšÜ
) \

61 (!
	`defšed
(
__şªg__
) && \

62 (
__GNUC__
 > (
majÜ
è|| (__GNUC__ =ğ(majÜè&& 
__GNUC_MINOR__
 >ğ(
mšÜ
))))

	)

63 #iâdeà
__has_butš


64 
	#__has_butš
(
butš
è(0)

	)

66 
	#JEMALLOC_CLANG_HAS_BUILTIN
(
butš
) \

67 (
	`defšed
(
__şªg__
è&& 
	`__has_butš
(
butš
))

	)

69 #ifdeà
__GNUC__


70 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

71 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

72 #ià
JEMALLOC_GNUC_PREREQ
(4, 6) || \

73 
	$JEMALLOC_CLANG_HAS_BUILTIN
(
__butš_uÄ—chabË
)

74 
	#uÄ—chabË
(è
	`__butš_uÄ—chabË
()

	)

76 
	#uÄ—chabË
()

	)

79 
	#lik–y
(
x
è!!(x)

	)

80 
	#uÆik–y
(
x
è!!(x)

	)

81 
	#uÄ—chabË
()

	)

88 #iâdeà
as£¹


89 
	#as£¹
(
e
) do { \

90 ià(
	`uÆik–y
(
cÚfig_debug
 && !(
e
))) { \

91 
	`m®loc_´štf
( \

93 
__FILE__
, 
__LINE__
, #e); \

94 
	`abÜt
(); \

96 
	}
} 0)

	)

99 #iâdeà
nÙ_»ached


100 
	#nÙ_»ached
() do { \

101 ià(
cÚfig_debug
) { \

102 
	`m®loc_´štf
( \

104 
__FILE__
, 
__LINE__
); \

105 
	`abÜt
(); \

107 
	`uÄ—chabË
(); \

108 } 0)

	)

111 #iâdeà
nÙ_im¶em’‹d


112 
	#nÙ_im¶em’‹d
() do { \

113 ià(
cÚfig_debug
) { \

114 
	`m®loc_´štf
("<jemalloc>: %s:%d: Not implemented\n", \

115 
__FILE__
, 
__LINE__
); \

116 
	`abÜt
(); \

118 } 0)

	)

121 #iâdeà
as£¹_nÙ_im¶em’‹d


122 
	#as£¹_nÙ_im¶em’‹d
(
e
) do { \

123 ià(
	`uÆik–y
(
cÚfig_debug
 && !(
e
))) \

124 
	`nÙ_im¶em’‹d
(); \

125 } 0)

	)

129 
	#ÿs£¹
(
c
) do { \

130 ià(
	`uÆik–y
(!(
c
))) \

131 
	`nÙ_»ached
(); \

132 } 0)

	)

136 #ifdeà
JEMALLOC_H_STRUCTS


140 #ifdeà
JEMALLOC_H_EXTERNS


142 
buã¼Ü
(
”r
, *
buf
, 
size_t
 
buæ’
);

143 
uštmax_t
 
m®loc_¡¹oumax
(cÚ¡ *
»¡riù
 
ÅŒ
,

144 **
»¡riù
 
’d±r
, 
ba£
);

145 
m®loc_wr™e
(cÚ¡ *
s
);

151 
m®loc_v¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fÜm©
,

152 
va_li¡
 
­
);

153 
	$m®loc_¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fÜm©
, ...)

154 
	`JEMALLOC_FORMAT_PRINTF
(3, 4);

155 
	`m®loc_vırštf
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

156 cÚ¡ *
fÜm©
, 
va_li¡
 
­
);

157 
	$m®loc_ırštf
((*
wr™e
)(*, cÚ¡ *), *
cbİaque
,

158 cÚ¡ *
fÜm©
, ...è
	`JEMALLOC_FORMAT_PRINTF
(3, 4);

159 
	$m®loc_´štf
(cÚ¡ *
fÜm©
, ...è
	`JEMALLOC_FORMAT_PRINTF
(1, 2);

163 #ifdeà
JEMALLOC_H_INLINES


165 #iâdeà
JEMALLOC_ENABLE_INLINE


166 
	`jem®loc_ff¦
(
b™m­
);

167 
	`jem®loc_ffs
(
b™m­
);

168 
size_t
 
	`pow2_û
(size_ˆ
x
);

169 
size_t
 
	`lg_æoÜ
(size_ˆ
x
);

170 
	`£t_”ºo
(
”ºum
);

171 
	`g‘_”ºo
();

174 #ià(
	`defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
JEMALLOC_UTIL_C_
))

177 #ià!
	`defšed
(
JEMALLOC_INTERNAL_FFSL
è|| !defšed(
JEMALLOC_INTERNAL_FFS
)

178 #”rÜ 
BÙh
 
JEMALLOC_INTERNAL_FFSL
 && 
JEMALLOC_INTERNAL_FFS
 
should
 
have
 
b“n
 
defšed
 
by
 
cÚfigu»


181 
JEMALLOC_ALWAYS_INLINE
 

182 
	$jem®loc_ff¦
(
b™m­
)

185  (
	`JEMALLOC_INTERNAL_FFSL
(
b™m­
));

186 
	}
}

188 
JEMALLOC_ALWAYS_INLINE
 

189 
	$jem®loc_ffs
(
b™m­
)

192  (
	`JEMALLOC_INTERNAL_FFS
(
b™m­
));

193 
	}
}

196 
JEMALLOC_INLINE
 
size_t


197 
	$pow2_û
(
size_t
 
x
)

200 
x
--;

201 
x
 |= x >> 1;

202 
x
 |= x >> 2;

203 
x
 |= x >> 4;

204 
x
 |= x >> 8;

205 
x
 |= x >> 16;

206 #ià(
LG_SIZEOF_PTR
 == 3)

207 
x
 |= x >> 32;

209 
x
++;

210  (
x
);

211 
	}
}

213 #ià(
defšed
(
__i386__
è|| defšed(
__amd64__
è|| defšed(
__x86_64__
))

214 
JEMALLOC_INLINE
 
size_t


215 
	$lg_æoÜ
(
size_t
 
x
)

217 
size_t
 
»t
;

219 
	`as£¹
(
x
 != 0);

221 
	`asm
 ("bsr %1, %0"

222 : "ô"(
»t
)

223 : "r"(
x
)

225  (
»t
);

226 
	}
}

227 #–ià(
defšed
(
_MSC_VER
))

228 
JEMALLOC_INLINE
 
size_t


229 
	$lg_æoÜ
(
size_t
 
x
)

231 
»t
;

233 
	`as£¹
(
x
 != 0);

235 #ià(
LG_SIZEOF_PTR
 == 3)

236 
	`_B™SÿnRev”£64
(&
»t
, 
x
);

237 #–ià(
LG_SIZEOF_PTR
 == 2)

238 
	`_B™SÿnRev”£
(&
»t
, 
x
);

242  (
»t
);

243 
	}
}

244 #–ià(
defšed
(
JEMALLOC_HAVE_BUILTIN_CLZ
))

245 
JEMALLOC_INLINE
 
size_t


246 
	$lg_æoÜ
(
size_t
 
x
)

249 
	`as£¹
(
x
 != 0);

251 #ià(
LG_SIZEOF_PTR
 =ğ
LG_SIZEOF_INT
)

252  (((8 << 
LG_SIZEOF_PTR
è- 1è- 
	`__butš_şz
(
x
));

253 #–ià(
LG_SIZEOF_PTR
 =ğ
LG_SIZEOF_LONG
)

254  (((8 << 
LG_SIZEOF_PTR
è- 1è- 
	`__butš_şzl
(
x
));

258 
	}
}

260 
JEMALLOC_INLINE
 
size_t


261 
	$lg_æoÜ
(
size_t
 
x
)

264 
	`as£¹
(
x
 != 0);

266 
x
 |= (x >> 1);

267 
x
 |= (x >> 2);

268 
x
 |= (x >> 4);

269 
x
 |= (x >> 8);

270 
x
 |= (x >> 16);

271 #ià(
LG_SIZEOF_PTR
 =ğ3 && LG_SIZEOF_PTR =ğ
LG_SIZEOF_LONG
)

272 
x
 |= (x >> 32);

273 ià(
x
 =ğ
	`KZU
(0xffffffffffffffff))

275 
x
++;

276  (
	`jem®loc_ff¦
(
x
) - 2);

277 #–ià(
LG_SIZEOF_PTR
 == 2)

278 ià(
x
 =ğ
	`KZU
(0xffffffff))

280 
x
++;

281  (
	`jem®loc_ffs
(
x
) - 2);

285 
	}
}

289 
JEMALLOC_INLINE
 

290 
	$£t_”ºo
(
”ºum
)

293 #ifdeà
_WIN32


294 
	`S‘La¡E¼Ü
(
”ºum
);

296 
”ºo
 = 
”ºum
;

298 
	}
}

301 
JEMALLOC_INLINE
 

302 
	$g‘_”ºo
()

305 #ifdeà
_WIN32


306  (
	`G‘La¡E¼Ü
());

308  (
”ºo
);

310 
	}
}

	@deps/jemalloc/include/jemalloc/internal/valgrind.h

2 #ifdeà
JEMALLOC_H_TYPES


4 #ifdeà
JEMALLOC_VALGRIND


5 
	~<v®gršd/v®gršd.h
>

16 
	#JEMALLOC_VALGRIND_MAKE_MEM_NOACCESS
(
±r
, 
usize
) do { \

17 ià(
	`uÆik–y
(
š_v®gršd
)) \

18 
	`v®gršd_make_mem_nßcûss
(
±r
, 
usize
); \

19 } 0)

	)

20 
	#JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
±r
, 
usize
) do { \

21 ià(
	`uÆik–y
(
š_v®gršd
)) \

22 
	`v®gršd_make_mem_undefšed
(
±r
, 
usize
); \

23 } 0)

	)

24 
	#JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
(
±r
, 
usize
) do { \

25 ià(
	`uÆik–y
(
š_v®gršd
)) \

26 
	`v®gršd_make_mem_defšed
(
±r
, 
usize
); \

27 } 0)

	)

33 
	#JEMALLOC_VALGRIND_MALLOC
(
cÚd
, 
±r
, 
usize
, 
z”o
) do { \

34 ià(
	`uÆik–y
(
š_v®gršd
 && 
cÚd
)) \

35 
	`VALGRIND_MALLOCLIKE_BLOCK
(
±r
, 
usize
, 
	`p2rz
ÕŒ), 
z”o
); \

36 } 0)

	)

37 
	#JEMALLOC_VALGRIND_REALLOC
(
maybe_moved
, 
±r
, 
usize
, \

38 
±r_maybe_nuÎ
, 
Şd_±r
, 
Şd_usize
, 
Şd_rzsize
, 
Şd_±r_maybe_nuÎ
, \

39 
z”o
) do { \

40 ià(
	`uÆik–y
(
š_v®gršd
)) { \

41 
size_t
 
rzsize
 = 
	`p2rz
(
±r
); \

43 ià(!
maybe_moved
 || 
±r
 =ğ
Şd_±r
) { \

44 
	`VALGRIND_RESIZEINPLACE_BLOCK
(
±r
, 
Şd_usize
, \

45 
usize
, 
rzsize
); \

46 ià(
z”o
 && 
Şd_usize
 < 
usize
) { \

47 
	`v®gršd_make_mem_defšed
( \

48 (*)((
ušŒ_t
)
±r
 + \

49 
Şd_usize
), 
usize
 - old_usize); \

52 ià(!
Şd_±r_maybe_nuÎ
 || 
Şd_±r
 !ğ
NULL
) { \

53 
	`v®gršd_ä“like_block
(
Şd_±r
, \

54 
Şd_rzsize
); \

56 ià(!
±r_maybe_nuÎ
 || 
±r
 !ğ
NULL
) { \

57 
size_t
 
cİy_size
 = (
Şd_usize
 < 
usize
) \

58 ? 
Şd_usize
 : 
usize
; \

59 
size_t
 
_size
 = 
usize
 - 
cİy_size
; \

60 
	`VALGRIND_MALLOCLIKE_BLOCK
(
±r
, 
usize
, \

61 
rzsize
, 
çl£
); \

62 ià(
cİy_size
 > 0) { \

63 
	`v®gršd_make_mem_defšed
(
±r
, \

64 
cİy_size
); \

66 ià(
z”o
 && 
_size
 > 0) { \

67 
	`v®gršd_make_mem_defšed
( \

68 (*)((
ušŒ_t
)
±r
 + \

69 
cİy_size
), 
_size
); \

74 } 0)

	)

75 
	#JEMALLOC_VALGRIND_FREE
(
±r
, 
rzsize
) do { \

76 ià(
	`uÆik–y
(
š_v®gršd
)) \

77 
	`v®gršd_ä“like_block
(
±r
, 
rzsize
); \

78 } 0)

	)

80 
	#RUNNING_ON_VALGRIND
 (()0)

	)

81 
	#JEMALLOC_VALGRIND_MAKE_MEM_NOACCESS
(
±r
, 
usize
èdØ{} 0)

	)

82 
	#JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
±r
, 
usize
èdØ{} 0)

	)

83 
	#JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
(
±r
, 
usize
èdØ{} 0)

	)

84 
	#JEMALLOC_VALGRIND_MALLOC
(
cÚd
, 
±r
, 
usize
, 
z”o
èdØ{} 0)

	)

85 
	#JEMALLOC_VALGRIND_REALLOC
(
maybe_moved
, 
±r
, 
usize
, \

86 
±r_maybe_nuÎ
, 
Şd_±r
, 
Şd_usize
, 
Şd_rzsize
, 
Şd_±r_maybe_nuÎ
, \

87 
z”o
èdØ{} 0)

	)

88 
	#JEMALLOC_VALGRIND_FREE
(
±r
, 
rzsize
èdØ{} 0)

	)

93 #ifdeà
JEMALLOC_H_STRUCTS


97 #ifdeà
JEMALLOC_H_EXTERNS


99 #ifdeà
JEMALLOC_VALGRIND


100 
v®gršd_make_mem_nßcûss
(*
±r
, 
size_t
 
usize
);

101 
v®gršd_make_mem_undefšed
(*
±r
, 
size_t
 
usize
);

102 
v®gršd_make_mem_defšed
(*
±r
, 
size_t
 
usize
);

103 
v®gršd_ä“like_block
(*
±r
, 
size_t
 
usize
);

108 #ifdeà
JEMALLOC_H_INLINES


	@deps/jemalloc/include/jemalloc/jemalloc.h

1 #iâdeà
JEMALLOC_H_


2 
	#JEMALLOC_H_


	)

3 #ifdeà
__ılu¥lus


8 
	#JEMALLOC_HAVE_ATTR


	)

11 
	#JEMALLOC_HAVE_ATTR_ALLOC_SIZE


	)

14 
	#JEMALLOC_HAVE_ATTR_FORMAT_GNU_PRINTF


	)

17 
	#JEMALLOC_HAVE_ATTR_FORMAT_PRINTF


	)

23 
	#JEMALLOC_OVERRIDE_MEMALIGN


	)

24 
	#JEMALLOC_OVERRIDE_VALLOC


	)

33 
	#JEMALLOC_USABLE_SIZE_CONST


	)

40 
	#JEMALLOC_USE_CXX_THROW


	)

43 
	#LG_SIZEOF_PTR
 3

	)

50 #iâdeà
JEMALLOC_NO_RENAME


51 
	#je_m®loc_cÚf
 
je_m®loc_cÚf


	)

52 
	#je_m®loc_mes§ge
 
je_m®loc_mes§ge


	)

53 
	#je_m®loc
 
je_m®loc


	)

54 
	#je_ÿÎoc
 
je_ÿÎoc


	)

55 
	#je_posix_mem®ign
 
je_posix_mem®ign


	)

56 
	#je_®igÃd_®loc
 
je_®igÃd_®loc


	)

57 
	#je_»®loc
 
je_»®loc


	)

58 
	#je_ä“
 
je_ä“


	)

59 
	#je_m®locx
 
je_m®locx


	)

60 
	#je_¿Îocx
 
je_¿Îocx


	)

61 
	#je_x®locx
 
je_x®locx


	)

62 
	#je_§Îocx
 
je_§Îocx


	)

63 
	#je_d®locx
 
je_d®locx


	)

64 
	#je_sd®locx
 
je_sd®locx


	)

65 
	#je_ÇÎocx
 
je_ÇÎocx


	)

66 
	#je_m®lùl
 
je_m®lùl


	)

67 
	#je_m®lùÊam‘omib
 
je_m®lùÊam‘omib


	)

68 
	#je_m®lùlbymib
 
je_m®lùlbymib


	)

69 
	#je_m®loc_¡©s_´št
 
je_m®loc_¡©s_´št


	)

70 
	#je_m®loc_u§bË_size
 
je_m®loc_u§bË_size


	)

71 
	#je_mem®ign
 
je_mem®ign


	)

72 
	#je_v®loc
 
je_v®loc


	)

75 
	~<¡dlib.h
>

76 
	~<¡dboŞ.h
>

77 
	~<¡dšt.h
>

78 
	~<lim™s.h
>

79 
	~<¡ršgs.h
>

81 
	#JEMALLOC_VERSION
 "4.0.3-0-ge9192—cf8935e29fc62fddc2701f7942b1cc02c"

	)

82 
	#JEMALLOC_VERSION_MAJOR
 4

	)

83 
	#JEMALLOC_VERSION_MINOR
 0

	)

84 
	#JEMALLOC_VERSION_BUGFIX
 3

	)

85 
	#JEMALLOC_VERSION_NREV
 0

	)

86 
	#JEMALLOC_VERSION_GID
 "e9192—cf8935e29fc62fddc2701f7942b1cc02c"

	)

88 
	#MALLOCX_LG_ALIGN
(
Ï
èÖa)

	)

89 #ià
LG_SIZEOF_PTR
 == 2

90 
	#MALLOCX_ALIGN
(
a
è(
	`ffs
×)-1)

	)

92 
	#MALLOCX_ALIGN
(
a
) \

93 ((
a
 < (
size_t
)
INT_MAX
è? 
	`ffs
×)-1 : ffs×>>32)+31)

	)

95 
	#MALLOCX_ZERO
 (()0x40)

	)

100 
	#MALLOCX_TCACHE
(
tc
è(()((Ñc)+2è<< 8))

	)

101 
	#MALLOCX_TCACHE_NONE
 
	`MALLOCX_TCACHE
(-1)

	)

105 
	#MALLOCX_ARENA
(
a
è(()((×)+1è<< 20))

	)

107 #ià
defšed
(
__ılu¥lus
è&& defšed(
JEMALLOC_USE_CXX_THROW
)

108 
	#JEMALLOC_CXX_THROW
 
	`throw
()

	)

110 
	#JEMALLOC_CXX_THROW


	)

113 #ifdeà
JEMALLOC_HAVE_ATTR


114 
	#JEMALLOC_ATTR
(
s
è
	`__©Œibu‹__
((s))

	)

115 
	#JEMALLOC_ALIGNED
(
s
è
	`JEMALLOC_ATTR
(
	`®igÃd
(s))

	)

116 #ifdeà
JEMALLOC_HAVE_ATTR_ALLOC_SIZE


117 
	#JEMALLOC_ALLOC_SIZE
(
s
è
	`JEMALLOC_ATTR
(
	`®loc_size
(s))

	)

118 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
è
	`JEMALLOC_ATTR
(
	`®loc_size
(s1, s2))

	)

120 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

121 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

123 #iâdeà
JEMALLOC_EXPORT


124 
	#JEMALLOC_EXPORT
 
	`JEMALLOC_ATTR
(
	`visib™y
("deçuÉ"))

	)

126 #ifdeà
JEMALLOC_HAVE_ATTR_FORMAT_GNU_PRINTF


127 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
è
	`JEMALLOC_ATTR
(
	`fÜm©
(
gnu_´štf
, s, i))

	)

128 #–ià
defšed
(
JEMALLOC_HAVE_ATTR_FORMAT_PRINTF
)

129 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
è
	`JEMALLOC_ATTR
(
	`fÜm©
(
´štf
, s, i))

	)

131 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

133 
	#JEMALLOC_NOINLINE
 
	`JEMALLOC_ATTR
(
nošlše
)

	)

134 
	#JEMALLOC_NOTHROW
 
	`JEMALLOC_ATTR
(
nÙhrow
)

	)

135 
	#JEMALLOC_SECTION
(
s
è
	`JEMALLOC_ATTR
(
	`£ùiÚ
(s))

	)

136 
	#JEMALLOC_RESTRICT_RETURN


	)

137 
	#JEMALLOC_ALLOCATOR


	)

138 #–ià
_MSC_VER


139 
	#JEMALLOC_ATTR
(
s
)

	)

140 
	#JEMALLOC_ALIGNED
(
s
è
	`__deş¥ec
(
	`®ign
(s))

	)

141 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

142 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

143 #iâdeà
JEMALLOC_EXPORT


144 #ifdeà
DLLEXPORT


145 
	#JEMALLOC_EXPORT
 
	`__deş¥ec
(
dÎexpÜt
)

	)

147 
	#JEMALLOC_EXPORT
 
	`__deş¥ec
(
dÎimpÜt
)

	)

150 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

151 
	#JEMALLOC_NOINLINE
 
	`__deş¥ec
(
nošlše
)

	)

152 #ifdeà
__ılu¥lus


153 
	#JEMALLOC_NOTHROW
 
	`__deş¥ec
(
nÙhrow
)

	)

155 
	#JEMALLOC_NOTHROW


	)

157 
	#JEMALLOC_SECTION
(
s
è
	`__deş¥ec
(
	`®loÿ‹
(s))

	)

158 
	#JEMALLOC_RESTRICT_RETURN
 
	`__deş¥ec
(
»¡riù
)

	)

159 #ià
_MSC_VER
 >ğ1900 && !
defšed
(
__EDG__
)

160 
	#JEMALLOC_ALLOCATOR
 
	`__deş¥ec
(
®loÿtÜ
)

	)

162 
	#JEMALLOC_ALLOCATOR


	)

165 
	#JEMALLOC_ATTR
(
s
)

	)

166 
	#JEMALLOC_ALIGNED
(
s
)

	)

167 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

168 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

169 
	#JEMALLOC_EXPORT


	)

170 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

171 
	#JEMALLOC_NOINLINE


	)

172 
	#JEMALLOC_NOTHROW


	)

173 
	#JEMALLOC_SECTION
(
s
)

	)

174 
	#JEMALLOC_RESTRICT_RETURN


	)

175 
	#JEMALLOC_ALLOCATOR


	)

180 
	#JEMALLOC_FRAG_HINT


	)

187 
JEMALLOC_EXPORT
 cÚ¡ *
je_m®loc_cÚf
;

188 
JEMALLOC_EXPORT
 (*
je_m®loc_mes§ge
)(*
cbİaque
,

189 cÚ¡ *
s
);

191 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


192 
JEMALLOC_NOTHROW
 *
je_m®loc
(
size_t
 
size
)

193 
JEMALLOC_CXX_THROW
 
JEMALLOC_ATTR
(
m®loc
è
JEMALLOC_ALLOC_SIZE
(1);

194 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


195 
JEMALLOC_NOTHROW
 *
je_ÿÎoc
(
size_t
 
num
, size_ˆ
size
)

196 
JEMALLOC_CXX_THROW
 
JEMALLOC_ATTR
(
m®loc
è
JEMALLOC_ALLOC_SIZE2
(1, 2);

197 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_posix_mem®ign
(**
mem±r
,

198 
size_t
 
®ignm’t
, size_ˆ
size
è
JEMALLOC_CXX_THROW
 
JEMALLOC_ATTR
(
nÚnuÎ
(1));

199 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


200 
JEMALLOC_NOTHROW
 *
je_®igÃd_®loc
(
size_t
 
®ignm’t
,

201 
size_t
 
size
è
JEMALLOC_CXX_THROW
 
JEMALLOC_ATTR
(
m®loc
)

202 
JEMALLOC_ALLOC_SIZE
(2);

203 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


204 
JEMALLOC_NOTHROW
 *
je_»®loc
(*
±r
, 
size_t
 
size
)

205 
JEMALLOC_CXX_THROW
 
JEMALLOC_ALLOC_SIZE
(2);

206 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_ä“
(*
±r
)

207 
	gJEMALLOC_CXX_THROW
;

209 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


210 
JEMALLOC_NOTHROW
 *
je_m®locx
(
size_t
 
size
, 
æags
)

211 
JEMALLOC_ATTR
(
m®loc
è
JEMALLOC_ALLOC_SIZE
(1);

212 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


213 
JEMALLOC_NOTHROW
 *
je_¿Îocx
(*
±r
, 
size_t
 
size
,

214 
æags
è
JEMALLOC_ALLOC_SIZE
(2);

215 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
je_x®locx
(*
±r
, size_ˆ
size
,

216 
size_t
 
exŒa
, 
æags
);

217 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
je_§Îocx
(cÚ¡ *
±r
,

218 
æags
è
JEMALLOC_ATTR
(
pu»
);

219 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_d®locx
(*
±r
, 
æags
);

220 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_sd®locx
(*
±r
, 
size_t
 
size
,

221 
æags
);

222 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
je_ÇÎocx
(size_ˆ
size
, 
æags
)

223 
JEMALLOC_ATTR
(
pu»
);

225 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_m®lùl
(cÚ¡ *
Çme
,

226 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

227 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_m®lùÊam‘omib
(cÚ¡ *
Çme
,

228 
size_t
 *
mibp
, size_ˆ*
mibËÅ
);

229 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_m®lùlbymib
(cÚ¡ 
size_t
 *
mib
,

230 
size_t
 
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

231 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
je_m®loc_¡©s_´št
(

232 (*
wr™e_cb
)(*, cÚ¡ *), *
je_cbİaque
,

233 cÚ¡ *
İts
);

234 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
je_m®loc_u§bË_size
(

235 
JEMALLOC_USABLE_SIZE_CONST
 *
±r
è
	gJEMALLOC_CXX_THROW
;

237 #ifdeà
JEMALLOC_OVERRIDE_MEMALIGN


238 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


239 
JEMALLOC_NOTHROW
 *
je_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
)

240 
JEMALLOC_CXX_THROW
 
JEMALLOC_ATTR
(
m®loc
);

243 #ifdeà
JEMALLOC_OVERRIDE_VALLOC


244 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


245 
JEMALLOC_NOTHROW
 *
je_v®loc
(
size_t
 
size
è
JEMALLOC_CXX_THROW


246 
JEMALLOC_ATTR
(
m®loc
);

254 *(
	tchunk_®loc_t
)(*, 
	tsize_t
, size_t, 
	tboŞ
 *, bool *, );

260 
boŞ
 (
	tchunk_d®loc_t
)(*, 
	tsize_t
, 
	tboŞ
, );

267 
boŞ
 (
	tchunk_comm™_t
)(*, 
	tsize_t
, size_t, size_t, );

274 
boŞ
 (
	tchunk_decomm™_t
)(*, 
	tsize_t
, size_t, size_t, );

281 
boŞ
 (
	tchunk_purge_t
)(*, 
	tsize_t
, size_t, size_t, );

288 
boŞ
 (
	tchunk_¥l™_t
)(*, 
	tsize_t
, size_t, size_t, 
	tboŞ
, );

295 
boŞ
 (
	tchunk_m”ge_t
)(*, 
	tsize_t
, *, size_t, 
	tboŞ
, );

298 
chunk_®loc_t
 *
	g®loc
;

299 
chunk_d®loc_t
 *
	gd®loc
;

300 
chunk_comm™_t
 *
	gcomm™
;

301 
chunk_decomm™_t
 *
	gdecomm™
;

302 
chunk_purge_t
 *
	gpurge
;

303 
chunk_¥l™_t
 *
	g¥l™
;

304 
chunk_m”ge_t
 *
	gm”ge
;

305 } 
	tchunk_hooks_t
;

314 #ifdeà
JEMALLOC_MANGLE


315 #iâdeà
JEMALLOC_NO_DEMANGLE


316 
	#JEMALLOC_NO_DEMANGLE


	)

318 
	#m®loc_cÚf
 
je_m®loc_cÚf


	)

319 
	#m®loc_mes§ge
 
je_m®loc_mes§ge


	)

320 
	#m®loc
 
je_m®loc


	)

321 
	#ÿÎoc
 
je_ÿÎoc


	)

322 
	#posix_mem®ign
 
je_posix_mem®ign


	)

323 
	#®igÃd_®loc
 
je_®igÃd_®loc


	)

324 
	#»®loc
 
je_»®loc


	)

325 
	#ä“
 
je_ä“


	)

326 
	#m®locx
 
je_m®locx


	)

327 
	#¿Îocx
 
je_¿Îocx


	)

328 
	#x®locx
 
je_x®locx


	)

329 
	#§Îocx
 
je_§Îocx


	)

330 
	#d®locx
 
je_d®locx


	)

331 
	#sd®locx
 
je_sd®locx


	)

332 
	#ÇÎocx
 
je_ÇÎocx


	)

333 
	#m®lùl
 
je_m®lùl


	)

334 
	#m®lùÊam‘omib
 
je_m®lùÊam‘omib


	)

335 
	#m®lùlbymib
 
je_m®lùlbymib


	)

336 
	#m®loc_¡©s_´št
 
je_m®loc_¡©s_´št


	)

337 
	#m®loc_u§bË_size
 
je_m®loc_u§bË_size


	)

338 
	#mem®ign
 
je_mem®ign


	)

339 
	#v®loc
 
je_v®loc


	)

349 #iâdeà
JEMALLOC_NO_DEMANGLE


350 #undeà
je_m®loc_cÚf


351 #undeà
je_m®loc_mes§ge


352 #undeà
je_m®loc


353 #undeà
je_ÿÎoc


354 #undeà
je_posix_mem®ign


355 #undeà
je_®igÃd_®loc


356 #undeà
je_»®loc


357 #undeà
je_ä“


358 #undeà
je_m®locx


359 #undeà
je_¿Îocx


360 #undeà
je_x®locx


361 #undeà
je_§Îocx


362 #undeà
je_d®locx


363 #undeà
je_sd®locx


364 #undeà
je_ÇÎocx


365 #undeà
je_m®lùl


366 #undeà
je_m®lùÊam‘omib


367 #undeà
je_m®lùlbymib


368 #undeà
je_m®loc_¡©s_´št


369 #undeà
je_m®loc_u§bË_size


370 #undeà
je_mem®ign


371 #undeà
je_v®loc


374 #ifdeà
__ılu¥lus


	@deps/jemalloc/include/jemalloc/jemalloc_defs.h

3 
	#JEMALLOC_HAVE_ATTR


	)

6 
	#JEMALLOC_HAVE_ATTR_ALLOC_SIZE


	)

9 
	#JEMALLOC_HAVE_ATTR_FORMAT_GNU_PRINTF


	)

12 
	#JEMALLOC_HAVE_ATTR_FORMAT_PRINTF


	)

18 
	#JEMALLOC_OVERRIDE_MEMALIGN


	)

19 
	#JEMALLOC_OVERRIDE_VALLOC


	)

28 
	#JEMALLOC_USABLE_SIZE_CONST


	)

35 
	#JEMALLOC_USE_CXX_THROW


	)

38 
	#LG_SIZEOF_PTR
 3

	)

	@deps/jemalloc/include/jemalloc/jemalloc_macros.h

1 
	~<¡dlib.h
>

2 
	~<¡dboŞ.h
>

3 
	~<¡dšt.h
>

4 
	~<lim™s.h
>

5 
	~<¡ršgs.h
>

7 
	#JEMALLOC_VERSION
 "4.0.3-0-ge9192—cf8935e29fc62fddc2701f7942b1cc02c"

	)

8 
	#JEMALLOC_VERSION_MAJOR
 4

	)

9 
	#JEMALLOC_VERSION_MINOR
 0

	)

10 
	#JEMALLOC_VERSION_BUGFIX
 3

	)

11 
	#JEMALLOC_VERSION_NREV
 0

	)

12 
	#JEMALLOC_VERSION_GID
 "e9192—cf8935e29fc62fddc2701f7942b1cc02c"

	)

14 
	#MALLOCX_LG_ALIGN
(
Ï
èÖa)

	)

15 #ià
LG_SIZEOF_PTR
 == 2

16 
	#MALLOCX_ALIGN
(
a
è(
	`ffs
×)-1)

	)

18 
	#MALLOCX_ALIGN
(
a
) \

19 ((
a
 < (
size_t
)
INT_MAX
è? 
	`ffs
×)-1 : ffs×>>32)+31)

	)

21 
	#MALLOCX_ZERO
 (()0x40)

	)

26 
	#MALLOCX_TCACHE
(
tc
è(()((Ñc)+2è<< 8))

	)

27 
	#MALLOCX_TCACHE_NONE
 
	`MALLOCX_TCACHE
(-1)

	)

31 
	#MALLOCX_ARENA
(
a
è(()((×)+1è<< 20))

	)

33 #ià
defšed
(
__ılu¥lus
è&& defšed(
JEMALLOC_USE_CXX_THROW
)

34 
	#JEMALLOC_CXX_THROW
 
	`throw
()

	)

36 
	#JEMALLOC_CXX_THROW


	)

39 #ifdeà
JEMALLOC_HAVE_ATTR


40 
	#JEMALLOC_ATTR
(
s
è
	`__©Œibu‹__
((s))

	)

41 
	#JEMALLOC_ALIGNED
(
s
è
	`JEMALLOC_ATTR
(
	`®igÃd
(s))

	)

42 #ifdeà
JEMALLOC_HAVE_ATTR_ALLOC_SIZE


43 
	#JEMALLOC_ALLOC_SIZE
(
s
è
	`JEMALLOC_ATTR
(
	`®loc_size
(s))

	)

44 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
è
	`JEMALLOC_ATTR
(
	`®loc_size
(s1, s2))

	)

46 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

47 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

49 #iâdeà
JEMALLOC_EXPORT


50 
	#JEMALLOC_EXPORT
 
	`JEMALLOC_ATTR
(
	`visib™y
("deçuÉ"))

	)

52 #ifdeà
JEMALLOC_HAVE_ATTR_FORMAT_GNU_PRINTF


53 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
è
	`JEMALLOC_ATTR
(
	`fÜm©
(
gnu_´štf
, s, i))

	)

54 #–ià
defšed
(
JEMALLOC_HAVE_ATTR_FORMAT_PRINTF
)

55 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
è
	`JEMALLOC_ATTR
(
	`fÜm©
(
´štf
, s, i))

	)

57 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

59 
	#JEMALLOC_NOINLINE
 
	`JEMALLOC_ATTR
(
nošlše
)

	)

60 
	#JEMALLOC_NOTHROW
 
	`JEMALLOC_ATTR
(
nÙhrow
)

	)

61 
	#JEMALLOC_SECTION
(
s
è
	`JEMALLOC_ATTR
(
	`£ùiÚ
(s))

	)

62 
	#JEMALLOC_RESTRICT_RETURN


	)

63 
	#JEMALLOC_ALLOCATOR


	)

64 #–ià
_MSC_VER


65 
	#JEMALLOC_ATTR
(
s
)

	)

66 
	#JEMALLOC_ALIGNED
(
s
è
	`__deş¥ec
(
	`®ign
(s))

	)

67 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

68 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

69 #iâdeà
JEMALLOC_EXPORT


70 #ifdeà
DLLEXPORT


71 
	#JEMALLOC_EXPORT
 
	`__deş¥ec
(
dÎexpÜt
)

	)

73 
	#JEMALLOC_EXPORT
 
	`__deş¥ec
(
dÎimpÜt
)

	)

76 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

77 
	#JEMALLOC_NOINLINE
 
	`__deş¥ec
(
nošlše
)

	)

78 #ifdeà
__ılu¥lus


79 
	#JEMALLOC_NOTHROW
 
	`__deş¥ec
(
nÙhrow
)

	)

81 
	#JEMALLOC_NOTHROW


	)

83 
	#JEMALLOC_SECTION
(
s
è
	`__deş¥ec
(
	`®loÿ‹
(s))

	)

84 
	#JEMALLOC_RESTRICT_RETURN
 
	`__deş¥ec
(
»¡riù
)

	)

85 #ià
_MSC_VER
 >ğ1900 && !
defšed
(
__EDG__
)

86 
	#JEMALLOC_ALLOCATOR
 
	`__deş¥ec
(
®loÿtÜ
)

	)

88 
	#JEMALLOC_ALLOCATOR


	)

91 
	#JEMALLOC_ATTR
(
s
)

	)

92 
	#JEMALLOC_ALIGNED
(
s
)

	)

93 
	#JEMALLOC_ALLOC_SIZE
(
s
)

	)

94 
	#JEMALLOC_ALLOC_SIZE2
(
s1
, 
s2
)

	)

95 
	#JEMALLOC_EXPORT


	)

96 
	#JEMALLOC_FORMAT_PRINTF
(
s
, 
i
)

	)

97 
	#JEMALLOC_NOINLINE


	)

98 
	#JEMALLOC_NOTHROW


	)

99 
	#JEMALLOC_SECTION
(
s
)

	)

100 
	#JEMALLOC_RESTRICT_RETURN


	)

101 
	#JEMALLOC_ALLOCATOR


	)

106 
	#JEMALLOC_FRAG_HINT


	)

	@deps/jemalloc/include/jemalloc/jemalloc_mangle.h

8 #ifdeà
JEMALLOC_MANGLE


9 #iâdeà
JEMALLOC_NO_DEMANGLE


10 
	#JEMALLOC_NO_DEMANGLE


	)

12 
	#m®loc_cÚf
 
je_m®loc_cÚf


	)

13 
	#m®loc_mes§ge
 
je_m®loc_mes§ge


	)

14 
	#m®loc
 
je_m®loc


	)

15 
	#ÿÎoc
 
je_ÿÎoc


	)

16 
	#posix_mem®ign
 
je_posix_mem®ign


	)

17 
	#®igÃd_®loc
 
je_®igÃd_®loc


	)

18 
	#»®loc
 
je_»®loc


	)

19 
	#ä“
 
je_ä“


	)

20 
	#m®locx
 
je_m®locx


	)

21 
	#¿Îocx
 
je_¿Îocx


	)

22 
	#x®locx
 
je_x®locx


	)

23 
	#§Îocx
 
je_§Îocx


	)

24 
	#d®locx
 
je_d®locx


	)

25 
	#sd®locx
 
je_sd®locx


	)

26 
	#ÇÎocx
 
je_ÇÎocx


	)

27 
	#m®lùl
 
je_m®lùl


	)

28 
	#m®lùÊam‘omib
 
je_m®lùÊam‘omib


	)

29 
	#m®lùlbymib
 
je_m®lùlbymib


	)

30 
	#m®loc_¡©s_´št
 
je_m®loc_¡©s_´št


	)

31 
	#m®loc_u§bË_size
 
je_m®loc_u§bË_size


	)

32 
	#mem®ign
 
je_mem®ign


	)

33 
	#v®loc
 
je_v®loc


	)

43 #iâdeà
JEMALLOC_NO_DEMANGLE


44 #undeà
je_m®loc_cÚf


45 #undeà
je_m®loc_mes§ge


46 #undeà
je_m®loc


47 #undeà
je_ÿÎoc


48 #undeà
je_posix_mem®ign


49 #undeà
je_®igÃd_®loc


50 #undeà
je_»®loc


51 #undeà
je_ä“


52 #undeà
je_m®locx


53 #undeà
je_¿Îocx


54 #undeà
je_x®locx


55 #undeà
je_§Îocx


56 #undeà
je_d®locx


57 #undeà
je_sd®locx


58 #undeà
je_ÇÎocx


59 #undeà
je_m®lùl


60 #undeà
je_m®lùÊam‘omib


61 #undeà
je_m®lùlbymib


62 #undeà
je_m®loc_¡©s_´št


63 #undeà
je_m®loc_u§bË_size


64 #undeà
je_mem®ign


65 #undeà
je_v®loc


	@deps/jemalloc/include/jemalloc/jemalloc_mangle_jet.h

8 #ifdeà
JEMALLOC_MANGLE


9 #iâdeà
JEMALLOC_NO_DEMANGLE


10 
	#JEMALLOC_NO_DEMANGLE


	)

12 
	#m®loc_cÚf
 
j‘_m®loc_cÚf


	)

13 
	#m®loc_mes§ge
 
j‘_m®loc_mes§ge


	)

14 
	#m®loc
 
j‘_m®loc


	)

15 
	#ÿÎoc
 
j‘_ÿÎoc


	)

16 
	#posix_mem®ign
 
j‘_posix_mem®ign


	)

17 
	#®igÃd_®loc
 
j‘_®igÃd_®loc


	)

18 
	#»®loc
 
j‘_»®loc


	)

19 
	#ä“
 
j‘_ä“


	)

20 
	#m®locx
 
j‘_m®locx


	)

21 
	#¿Îocx
 
j‘_¿Îocx


	)

22 
	#x®locx
 
j‘_x®locx


	)

23 
	#§Îocx
 
j‘_§Îocx


	)

24 
	#d®locx
 
j‘_d®locx


	)

25 
	#sd®locx
 
j‘_sd®locx


	)

26 
	#ÇÎocx
 
j‘_ÇÎocx


	)

27 
	#m®lùl
 
j‘_m®lùl


	)

28 
	#m®lùÊam‘omib
 
j‘_m®lùÊam‘omib


	)

29 
	#m®lùlbymib
 
j‘_m®lùlbymib


	)

30 
	#m®loc_¡©s_´št
 
j‘_m®loc_¡©s_´št


	)

31 
	#m®loc_u§bË_size
 
j‘_m®loc_u§bË_size


	)

32 
	#mem®ign
 
j‘_mem®ign


	)

33 
	#v®loc
 
j‘_v®loc


	)

43 #iâdeà
JEMALLOC_NO_DEMANGLE


44 #undeà
j‘_m®loc_cÚf


45 #undeà
j‘_m®loc_mes§ge


46 #undeà
j‘_m®loc


47 #undeà
j‘_ÿÎoc


48 #undeà
j‘_posix_mem®ign


49 #undeà
j‘_®igÃd_®loc


50 #undeà
j‘_»®loc


51 #undeà
j‘_ä“


52 #undeà
j‘_m®locx


53 #undeà
j‘_¿Îocx


54 #undeà
j‘_x®locx


55 #undeà
j‘_§Îocx


56 #undeà
j‘_d®locx


57 #undeà
j‘_sd®locx


58 #undeà
j‘_ÇÎocx


59 #undeà
j‘_m®lùl


60 #undeà
j‘_m®lùÊam‘omib


61 #undeà
j‘_m®lùlbymib


62 #undeà
j‘_m®loc_¡©s_´št


63 #undeà
j‘_m®loc_u§bË_size


64 #undeà
j‘_mem®ign


65 #undeà
j‘_v®loc


	@deps/jemalloc/include/jemalloc/jemalloc_protos.h

6 
JEMALLOC_EXPORT
 cÚ¡ *
je_m®loc_cÚf
;

7 
JEMALLOC_EXPORT
 (*
je_m®loc_mes§ge
)(*
cbİaque
,

8 cÚ¡ *
s
);

10 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


11 
JEMALLOC_NOTHROW
 *
	$je_m®loc
(
size_t
 
size
)

12 
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE
(1);

13 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


14 
JEMALLOC_NOTHROW
 *
	$je_ÿÎoc
(
size_t
 
num
, size_ˆ
size
)

15 
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE2
(1, 2);

16 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	$je_posix_mem®ign
(**
mem±r
,

17 
size_t
 
®ignm’t
, size_ˆ
size
è
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ATTR
(
	`nÚnuÎ
(1));

18 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


19 
JEMALLOC_NOTHROW
 *
	$je_®igÃd_®loc
(
size_t
 
®ignm’t
,

20 
size_t
 
size
è
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
)

21 
	`JEMALLOC_ALLOC_SIZE
(2);

22 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


23 
JEMALLOC_NOTHROW
 *
	$je_»®loc
(*
±r
, 
size_t
 
size
)

24 
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ALLOC_SIZE
(2);

25 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	$je_ä“
(*
±r
)

26 
JEMALLOC_CXX_THROW
;

28 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


29 
JEMALLOC_NOTHROW
 *
	$je_m®locx
(
size_t
 
size
, 
æags
)

30 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE
(1);

31 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


32 
JEMALLOC_NOTHROW
 *
	$je_¿Îocx
(*
±r
, 
size_t
 
size
,

33 
æags
è
	`JEMALLOC_ALLOC_SIZE
(2);

34 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	`je_x®locx
(*
±r
, size_ˆ
size
,

35 
size_t
 
exŒa
, 
æags
);

36 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$je_§Îocx
(cÚ¡ *
±r
,

37 
æags
è
	`JEMALLOC_ATTR
(
pu»
);

38 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_d®locx
(*
±r
, 
æags
);

39 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_sd®locx
(*
±r
, 
size_t
 
size
,

40 
æags
);

41 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$je_ÇÎocx
(
size_t
 
size
, 
æags
)

42 
	`JEMALLOC_ATTR
(
pu»
);

44 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_m®lùl
(cÚ¡ *
Çme
,

45 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

46 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_m®lùÊam‘omib
(cÚ¡ *
Çme
,

47 
size_t
 *
mibp
, size_ˆ*
mibËÅ
);

48 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_m®lùlbymib
(cÚ¡ 
size_t
 *
mib
,

49 
size_t
 
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

50 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`je_m®loc_¡©s_´št
(

51 (*
wr™e_cb
)(*, cÚ¡ *), *
je_cbİaque
,

52 cÚ¡ *
İts
);

53 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$je_m®loc_u§bË_size
(

54 
JEMALLOC_USABLE_SIZE_CONST
 *
±r
è
JEMALLOC_CXX_THROW
;

56 #ifdeà
JEMALLOC_OVERRIDE_MEMALIGN


57 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


58 
JEMALLOC_NOTHROW
 *
	$je_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
)

59 
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ATTR
(
m®loc
);

62 #ifdeà
JEMALLOC_OVERRIDE_VALLOC


63 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


64 
JEMALLOC_NOTHROW
 *
	$je_v®loc
(
size_t
 
size
è
JEMALLOC_CXX_THROW


65 
	`JEMALLOC_ATTR
(
m®loc
);

	@deps/jemalloc/include/jemalloc/jemalloc_protos_jet.h

6 
JEMALLOC_EXPORT
 cÚ¡ *
j‘_m®loc_cÚf
;

7 
JEMALLOC_EXPORT
 (*
j‘_m®loc_mes§ge
)(*
cbİaque
,

8 cÚ¡ *
s
);

10 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


11 
JEMALLOC_NOTHROW
 *
	$j‘_m®loc
(
size_t
 
size
)

12 
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE
(1);

13 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


14 
JEMALLOC_NOTHROW
 *
	$j‘_ÿÎoc
(
size_t
 
num
, size_ˆ
size
)

15 
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE2
(1, 2);

16 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	$j‘_posix_mem®ign
(**
mem±r
,

17 
size_t
 
®ignm’t
, size_ˆ
size
è
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ATTR
(
	`nÚnuÎ
(1));

18 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


19 
JEMALLOC_NOTHROW
 *
	$j‘_®igÃd_®loc
(
size_t
 
®ignm’t
,

20 
size_t
 
size
è
JEMALLOC_CXX_THROW
 
	$JEMALLOC_ATTR
(
m®loc
)

21 
	`JEMALLOC_ALLOC_SIZE
(2);

22 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


23 
JEMALLOC_NOTHROW
 *
	$j‘_»®loc
(*
±r
, 
size_t
 
size
)

24 
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ALLOC_SIZE
(2);

25 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	$j‘_ä“
(*
±r
)

26 
JEMALLOC_CXX_THROW
;

28 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


29 
JEMALLOC_NOTHROW
 *
	$j‘_m®locx
(
size_t
 
size
, 
æags
)

30 
	$JEMALLOC_ATTR
(
m®loc
è
	`JEMALLOC_ALLOC_SIZE
(1);

31 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


32 
JEMALLOC_NOTHROW
 *
	$j‘_¿Îocx
(*
±r
, 
size_t
 
size
,

33 
æags
è
	`JEMALLOC_ALLOC_SIZE
(2);

34 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	`j‘_x®locx
(*
±r
, size_ˆ
size
,

35 
size_t
 
exŒa
, 
æags
);

36 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$j‘_§Îocx
(cÚ¡ *
±r
,

37 
æags
è
	`JEMALLOC_ATTR
(
pu»
);

38 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_d®locx
(*
±r
, 
æags
);

39 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_sd®locx
(*
±r
, 
size_t
 
size
,

40 
æags
);

41 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$j‘_ÇÎocx
(
size_t
 
size
, 
æags
)

42 
	`JEMALLOC_ATTR
(
pu»
);

44 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_m®lùl
(cÚ¡ *
Çme
,

45 *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

46 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_m®lùÊam‘omib
(cÚ¡ *
Çme
,

47 
size_t
 *
mibp
, size_ˆ*
mibËÅ
);

48 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_m®lùlbymib
(cÚ¡ 
size_t
 *
mib
,

49 
size_t
 
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

50 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW
 
	`j‘_m®loc_¡©s_´št
(

51 (*
wr™e_cb
)(*, cÚ¡ *), *
j‘_cbİaque
,

52 cÚ¡ *
İts
);

53 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW
 
	$j‘_m®loc_u§bË_size
(

54 
JEMALLOC_USABLE_SIZE_CONST
 *
±r
è
JEMALLOC_CXX_THROW
;

56 #ifdeà
JEMALLOC_OVERRIDE_MEMALIGN


57 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


58 
JEMALLOC_NOTHROW
 *
	$j‘_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
)

59 
JEMALLOC_CXX_THROW
 
	`JEMALLOC_ATTR
(
m®loc
);

62 #ifdeà
JEMALLOC_OVERRIDE_VALLOC


63 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


64 
JEMALLOC_NOTHROW
 *
	$j‘_v®loc
(
size_t
 
size
è
JEMALLOC_CXX_THROW


65 
	`JEMALLOC_ATTR
(
m®loc
);

	@deps/jemalloc/include/jemalloc/jemalloc_rename.h

6 #iâdeà
JEMALLOC_NO_RENAME


7 
	#je_m®loc_cÚf
 
je_m®loc_cÚf


	)

8 
	#je_m®loc_mes§ge
 
je_m®loc_mes§ge


	)

9 
	#je_m®loc
 
je_m®loc


	)

10 
	#je_ÿÎoc
 
je_ÿÎoc


	)

11 
	#je_posix_mem®ign
 
je_posix_mem®ign


	)

12 
	#je_®igÃd_®loc
 
je_®igÃd_®loc


	)

13 
	#je_»®loc
 
je_»®loc


	)

14 
	#je_ä“
 
je_ä“


	)

15 
	#je_m®locx
 
je_m®locx


	)

16 
	#je_¿Îocx
 
je_¿Îocx


	)

17 
	#je_x®locx
 
je_x®locx


	)

18 
	#je_§Îocx
 
je_§Îocx


	)

19 
	#je_d®locx
 
je_d®locx


	)

20 
	#je_sd®locx
 
je_sd®locx


	)

21 
	#je_ÇÎocx
 
je_ÇÎocx


	)

22 
	#je_m®lùl
 
je_m®lùl


	)

23 
	#je_m®lùÊam‘omib
 
je_m®lùÊam‘omib


	)

24 
	#je_m®lùlbymib
 
je_m®lùlbymib


	)

25 
	#je_m®loc_¡©s_´št
 
je_m®loc_¡©s_´št


	)

26 
	#je_m®loc_u§bË_size
 
je_m®loc_u§bË_size


	)

27 
	#je_mem®ign
 
je_mem®ign


	)

28 
	#je_v®loc
 
je_v®loc


	)

	@deps/jemalloc/include/jemalloc/jemalloc_typedefs.h

6 *(
	tchunk_®loc_t
)(*, 
	tsize_t
, size_t, 
	tboŞ
 *, bool *, );

12 
	$boŞ
 (
	tchunk_d®loc_t
)(*, 
	tsize_t
, 
	tboŞ
, );

19 
	$boŞ
 (
	tchunk_comm™_t
)(*, 
	tsize_t
, size_t, size_t, );

26 
	$boŞ
 (
	tchunk_decomm™_t
)(*, 
	tsize_t
, size_t, size_t, );

33 
	$boŞ
 (
	tchunk_purge_t
)(*, 
	tsize_t
, size_t, size_t, );

40 
	$boŞ
 (
	tchunk_¥l™_t
)(*, 
	tsize_t
, size_t, size_t, 
	tboŞ
, );

47 
	$boŞ
 (
	tchunk_m”ge_t
)(*, 
	tsize_t
, *, size_t, 
	tboŞ
, );

50 
chunk_®loc_t
 *
®loc
;

51 
chunk_d®loc_t
 *
d®loc
;

52 
chunk_comm™_t
 *
comm™
;

53 
chunk_decomm™_t
 *
decomm™
;

54 
chunk_purge_t
 *
purge
;

55 
chunk_¥l™_t
 *
¥l™
;

56 
chunk_m”ge_t
 *
m”ge
;

57 } 
	tchunk_hooks_t
;

	@deps/jemalloc/include/msvc_compat/C99/stdbool.h

1 #iâdeà
¡dboŞ_h


2 
	#¡dboŞ_h


	)

4 
	~<wty³s.h
>

10 #iâdeà
__şªg__


11 
BOOL
 
	t_BoŞ
;

14 
	#boŞ
 
_BoŞ


	)

15 
	#Œue
 1

	)

16 
	#çl£
 0

	)

18 
	#__boŞ_Œue_çl£_¬e_defšed
 1

	)

	@deps/jemalloc/include/msvc_compat/C99/stdint.h

32 #iâdeà
_MSC_VER


36 #iâdeà
_MSC_STDINT_H_


37 
	#_MSC_STDINT_H_


	)

39 #ià
_MSC_VER
 > 1000

40 #´agm¨
Úû


43 
	~<lim™s.h
>

49 #ifdeà
__ılu¥lus


52 
	~<wch¬.h
>

53 #ifdeà
__ılu¥lus


58 #iâdeà
_W64


59 #ià!
defšed
(
__midl
è&& (defšed(
_X86_
è|| defšed(
_M_IX86
)è&& 
_MSC_VER
 >= 1300

60 
	#_W64
 
__w64


	)

62 
	#_W64


	)

74 #ià(
_MSC_VER
 < 1300)

75 sigÃd 
	tšt8_t
;

76 sigÃd 
	tšt16_t
;

77 sigÃd 
	tšt32_t
;

78 
	tušt8_t
;

79 
	tušt16_t
;

80 
	tušt32_t
;

82 sigÃd 
	t__št8
 
	tšt8_t
;

83 sigÃd 
	t__št16
 
	tšt16_t
;

84 sigÃd 
	t__št32
 
	tšt32_t
;

85 
	t__št8
 
	tušt8_t
;

86 
	t__št16
 
	tušt16_t
;

87 
	t__št32
 
	tušt32_t
;

89 sigÃd 
	t__št64
 
	tšt64_t
;

90 
	t__št64
 
	tušt64_t
;

94 
št8_t
 
	tšt_Ëa¡8_t
;

95 
št16_t
 
	tšt_Ëa¡16_t
;

96 
št32_t
 
	tšt_Ëa¡32_t
;

97 
št64_t
 
	tšt_Ëa¡64_t
;

98 
ušt8_t
 
	tušt_Ëa¡8_t
;

99 
ušt16_t
 
	tušt_Ëa¡16_t
;

100 
ušt32_t
 
	tušt_Ëa¡32_t
;

101 
ušt64_t
 
	tušt_Ëa¡64_t
;

104 
št8_t
 
	tšt_ç¡8_t
;

105 
št16_t
 
	tšt_ç¡16_t
;

106 
št32_t
 
	tšt_ç¡32_t
;

107 
št64_t
 
	tšt_ç¡64_t
;

108 
ušt8_t
 
	tušt_ç¡8_t
;

109 
ušt16_t
 
	tušt_ç¡16_t
;

110 
ušt32_t
 
	tušt_ç¡32_t
;

111 
ušt64_t
 
	tušt_ç¡64_t
;

114 #ifdeà
_WIN64


115 sigÃd 
	t__št64
 
	tšŒ_t
;

116 
	t__št64
 
	tušŒ_t
;

118 
_W64
 sigÃd 
	tšŒ_t
;

119 
_W64
 
	tušŒ_t
;

123 
št64_t
 
	tštmax_t
;

124 
ušt64_t
 
	tuštmax_t
;

129 #ià!
defšed
(
__ılu¥lus
è|| defšed(
__STDC_LIMIT_MACROS
)

132 
	#INT8_MIN
 ((
št8_t
)
_I8_MIN
)

	)

133 
	#INT8_MAX
 
_I8_MAX


	)

134 
	#INT16_MIN
 ((
št16_t
)
_I16_MIN
)

	)

135 
	#INT16_MAX
 
_I16_MAX


	)

136 
	#INT32_MIN
 ((
št32_t
)
_I32_MIN
)

	)

137 
	#INT32_MAX
 
_I32_MAX


	)

138 
	#INT64_MIN
 ((
št64_t
)
_I64_MIN
)

	)

139 
	#INT64_MAX
 
_I64_MAX


	)

140 
	#UINT8_MAX
 
_UI8_MAX


	)

141 
	#UINT16_MAX
 
_UI16_MAX


	)

142 
	#UINT32_MAX
 
_UI32_MAX


	)

143 
	#UINT64_MAX
 
_UI64_MAX


	)

146 
	#INT_LEAST8_MIN
 
INT8_MIN


	)

147 
	#INT_LEAST8_MAX
 
INT8_MAX


	)

148 
	#INT_LEAST16_MIN
 
INT16_MIN


	)

149 
	#INT_LEAST16_MAX
 
INT16_MAX


	)

150 
	#INT_LEAST32_MIN
 
INT32_MIN


	)

151 
	#INT_LEAST32_MAX
 
INT32_MAX


	)

152 
	#INT_LEAST64_MIN
 
INT64_MIN


	)

153 
	#INT_LEAST64_MAX
 
INT64_MAX


	)

154 
	#UINT_LEAST8_MAX
 
UINT8_MAX


	)

155 
	#UINT_LEAST16_MAX
 
UINT16_MAX


	)

156 
	#UINT_LEAST32_MAX
 
UINT32_MAX


	)

157 
	#UINT_LEAST64_MAX
 
UINT64_MAX


	)

160 
	#INT_FAST8_MIN
 
INT8_MIN


	)

161 
	#INT_FAST8_MAX
 
INT8_MAX


	)

162 
	#INT_FAST16_MIN
 
INT16_MIN


	)

163 
	#INT_FAST16_MAX
 
INT16_MAX


	)

164 
	#INT_FAST32_MIN
 
INT32_MIN


	)

165 
	#INT_FAST32_MAX
 
INT32_MAX


	)

166 
	#INT_FAST64_MIN
 
INT64_MIN


	)

167 
	#INT_FAST64_MAX
 
INT64_MAX


	)

168 
	#UINT_FAST8_MAX
 
UINT8_MAX


	)

169 
	#UINT_FAST16_MAX
 
UINT16_MAX


	)

170 
	#UINT_FAST32_MAX
 
UINT32_MAX


	)

171 
	#UINT_FAST64_MAX
 
UINT64_MAX


	)

174 #ifdeà
_WIN64


175 
	#INTPTR_MIN
 
INT64_MIN


	)

176 
	#INTPTR_MAX
 
INT64_MAX


	)

177 
	#UINTPTR_MAX
 
UINT64_MAX


	)

179 
	#INTPTR_MIN
 
INT32_MIN


	)

180 
	#INTPTR_MAX
 
INT32_MAX


	)

181 
	#UINTPTR_MAX
 
UINT32_MAX


	)

185 
	#INTMAX_MIN
 
INT64_MIN


	)

186 
	#INTMAX_MAX
 
INT64_MAX


	)

187 
	#UINTMAX_MAX
 
UINT64_MAX


	)

191 #ifdeà
_WIN64


192 
	#PTRDIFF_MIN
 
_I64_MIN


	)

193 
	#PTRDIFF_MAX
 
_I64_MAX


	)

195 
	#PTRDIFF_MIN
 
_I32_MIN


	)

196 
	#PTRDIFF_MAX
 
_I32_MAX


	)

199 
	#SIG_ATOMIC_MIN
 
INT_MIN


	)

200 
	#SIG_ATOMIC_MAX
 
INT_MAX


	)

202 #iâdeà
SIZE_MAX


203 #ifdeà
_WIN64


204 
	#SIZE_MAX
 
_UI64_MAX


	)

206 
	#SIZE_MAX
 
_UI32_MAX


	)

211 #iâdeà
WCHAR_MIN


212 
	#WCHAR_MIN
 0

	)

214 #iâdeà
WCHAR_MAX


215 
	#WCHAR_MAX
 
_UI16_MAX


	)

218 
	#WINT_MIN
 0

	)

219 
	#WINT_MAX
 
_UI16_MAX


	)

226 #ià!
defšed
(
__ılu¥lus
è|| defšed(
__STDC_CONSTANT_MACROS
)

230 
	#INT8_C
(
v®
èv®##
i8


	)

231 
	#INT16_C
(
v®
èv®##
i16


	)

232 
	#INT32_C
(
v®
èv®##
i32


	)

233 
	#INT64_C
(
v®
èv®##
i64


	)

235 
	#UINT8_C
(
v®
èv®##
ui8


	)

236 
	#UINT16_C
(
v®
èv®##
ui16


	)

237 
	#UINT32_C
(
v®
èv®##
ui32


	)

238 
	#UINT64_C
(
v®
èv®##
ui64


	)

241 
	#INTMAX_C
 
INT64_C


	)

242 
	#UINTMAX_C
 
UINT64_C


	)

	@deps/jemalloc/include/msvc_compat/strings.h

1 #iâdeà
¡ršgs_h


2 
	#¡ršgs_h


	)

6 #ifdeà
_MSC_VER


7 
	~<šŒš.h
>

8 #´agm¨
šŒšsic
(
_B™SÿnFÜw¬d
)

9 
__fÜûšlše
 
	$ff¦
(
x
)

11 
i
;

13 ià(
	`_B™SÿnFÜw¬d
(&
i
, 
x
))

14  (
i
 + 1);

16 
	}
}

18 
__fÜûšlše
 
	$ffs
(
x
)

21  (
	`ff¦
(
x
));

22 
	}
}

25 
	#ff¦
(
x
è
	`__butš_ff¦
(x)

	)

26 
	#ffs
(
x
è
	`__butš_ffs
(x)

	)

	@deps/jemalloc/include/msvc_compat/windows_extra.h

1 #iâdeà
MSVC_COMPAT_WINDOWS_EXTRA_H


2 
	#MSVC_COMPAT_WINDOWS_EXTRA_H


	)

4 #iâdeà
ENOENT


5 
	#ENOENT
 
ERROR_PATH_NOT_FOUND


	)

7 #iâdeà
EINVAL


8 
	#EINVAL
 
ERROR_BAD_ARGUMENTS


	)

10 #iâdeà
EAGAIN


11 
	#EAGAIN
 
ERROR_OUTOFMEMORY


	)

13 #iâdeà
EPERM


14 
	#EPERM
 
ERROR_WRITE_FAULT


	)

16 #iâdeà
EFAULT


17 
	#EFAULT
 
ERROR_INVALID_ADDRESS


	)

19 #iâdeà
ENOMEM


20 
	#ENOMEM
 
ERROR_NOT_ENOUGH_MEMORY


	)

22 #iâdeà
ERANGE


23 
	#ERANGE
 
ERROR_INVALID_DATA


	)

	@deps/jemalloc/src/arena.c

1 
	#JEMALLOC_ARENA_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
ssize_t
 
	gİt_lg_dœty_muÉ
 = 
LG_DIRTY_MULT_DEFAULT
;

8 
ssize_t
 
	glg_dœty_muÉ_deçuÉ
;

9 
¬’a_bš_šfo_t
 
	g¬’a_bš_šfo
[
NBINS
];

11 
size_t
 
	gm­_bŸs
;

12 
size_t
 
	gm­_misc_off£t
;

13 
size_t
 
	g¬’a_maxrun
;

14 
size_t
 
	gÏrge_maxşass
;

15 
size_t
 
	gsm®l_maxrun
;

16 
boŞ
 *
	gsm®l_run_b
;

17 
	gÆşas£s
;

18 
	gnhşas£s
;

26 
¬’a_purge
(
¬’a_t
 *
¬’a
, 
boŞ
 
®l
);

27 
¬’a_run_d®loc
(
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
, 
boŞ
 
dœty
,

28 
boŞ
 
ş—Ãd
, boŞ 
decomm™‹d
);

29 
¬’a_d®loc_bš_run
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

30 
¬’a_run_t
 *
run
, 
¬’a_bš_t
 *
bš
);

31 
¬’a_bš_low”_run
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

32 
¬’a_run_t
 *
run
, 
¬’a_bš_t
 *
bš
);

36 
	#CHUNK_MAP_KEY
 ((
ušŒ_t
)0x1U)

	)

38 
JEMALLOC_INLINE_C
 
¬’a_chunk_m­_misc_t
 *

39 
	$¬’a_misûlm_key_ü—‹
(
size_t
 
size
)

42  ((
¬’a_chunk_m­_misc_t
 *)(
	`¬’a_m­b™s_size_’code
(
size
) |

43 
CHUNK_MAP_KEY
));

44 
	}
}

46 
JEMALLOC_INLINE_C
 
boŞ


47 
	$¬’a_misûlm_is_key
(cÚ¡ 
¬’a_chunk_m­_misc_t
 *
misûlm
)

50  (((
ušŒ_t
)
misûlm
 & 
CHUNK_MAP_KEY
) != 0);

51 
	}
}

53 #undeà
CHUNK_MAP_KEY


55 
JEMALLOC_INLINE_C
 
size_t


56 
	$¬’a_misûlm_key_size_g‘
(cÚ¡ 
¬’a_chunk_m­_misc_t
 *
misûlm
)

59 
	`as£¹
(
	`¬’a_misûlm_is_key
(
misûlm
));

61  (
	`¬’a_m­b™s_size_decode
((
ušŒ_t
)
misûlm
));

62 
	}
}

64 
JEMALLOC_INLINE_C
 
size_t


65 
	$¬’a_misûlm_size_g‘
(
¬’a_chunk_m­_misc_t
 *
misûlm
)

67 
¬’a_chunk_t
 *
chunk
;

68 
size_t
 
·gešd
, 
m­b™s
;

70 
	`as£¹
(!
	`¬’a_misûlm_is_key
(
misûlm
));

72 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
misûlm
);

73 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

74 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

75  (
	`¬’a_m­b™s_size_decode
(
m­b™s
));

76 
	}
}

78 
JEMALLOC_INLINE_C
 

79 
	$¬’a_run_comp
(
¬’a_chunk_m­_misc_t
 *
a
,‡»Ç_chunk_m­_misc_ˆ*
b
)

81 
ušŒ_t
 
a_misûlm
 = (ušŒ_t)
a
;

82 
ušŒ_t
 
b_misûlm
 = (ušŒ_t)
b
;

84 
	`as£¹
(
a
 !ğ
NULL
);

85 
	`as£¹
(
b
 !ğ
NULL
);

87  ((
a_misûlm
 > 
b_misûlm
) - (a_miscelm < b_miscelm));

88 
	}
}

91 
	$rb_g’
(
UNUSED
, 
¬’a_run_Œ“_
, 
¬’a_run_Œ“_t
, 
¬’a_chunk_m­_misc_t
,

92 
rb_lšk
, 
¬’a_run_comp
)

94 
size_t


95 
	$run_quªtize
(
size_t
 
size
)

97 
size_t
 
qsize
;

99 
	`as£¹
(
size
 != 0);

100 
	`as£¹
(
size
 =ğ
	`PAGE_CEILING
(size));

103 ià(
size
 <ğ
sm®l_maxrun
 && 
sm®l_run_b
[siz>> 
LG_PAGE
])

104  (
size
);

111 
qsize
 = 
	`šdex2size
(
	`size2šdex
(
size
 - 
Ïrge_·d
 + 1) - 1) +†arge_pad;

112 ià(
qsize
 <ğ
SMALL_MAXCLASS
 + 
Ïrge_·d
)

113  (
	`run_quªtize
(
size
 - 
Ïrge_·d
));

114 
	`as£¹
(
qsize
 <ğ
size
);

115  (
qsize
);

116 
	}
}

118 
size_t


119 
	$run_quªtize_Ãxt
(
size_t
 
size
)

121 
size_t
 
Ïrge_run_size_Ãxt
;

123 
	`as£¹
(
size
 != 0);

124 
	`as£¹
(
size
 =ğ
	`PAGE_CEILING
(size));

133 ià(
size
 > 
SMALL_MAXCLASS
) {

134 
Ïrge_run_size_Ãxt
 = 
	`PAGE_CEILING
(
	`šdex2size
(
	`size2šdex
(
size
 -

135 
Ïrge_·d
) + 1) +†arge_pad);

137 
Ïrge_run_size_Ãxt
 = 
SIZE_T_MAX
;

138 ià(
size
 >ğ
sm®l_maxrun
)

139  (
Ïrge_run_size_Ãxt
);

141 
Œue
) {

142 
size
 +ğ
PAGE
;

143 
	`as£¹
(
size
 <ğ
sm®l_maxrun
);

144 ià(
sm®l_run_b
[
size
 >> 
LG_PAGE
]) {

145 ià(
Ïrge_run_size_Ãxt
 < 
size
)

146  (
Ïrge_run_size_Ãxt
);

147  (
size
);

150 
	}
}

152 
size_t


153 
	$run_quªtize_fœ¡
(
size_t
 
size
)

155 
size_t
 
qsize
 = 
	`run_quªtize
(
size
);

157 ià(
qsize
 < 
size
) {

166 
qsize
 = 
	`run_quªtize_Ãxt
(
size
);

168  (
qsize
);

169 
	}
}

171 
JEMALLOC_INLINE_C
 

172 
	$¬’a_ava_comp
(
¬’a_chunk_m­_misc_t
 *
a
,‡»Ç_chunk_m­_misc_ˆ*
b
)

174 
»t
;

175 
ušŒ_t
 
a_misûlm
 = (ušŒ_t)
a
;

176 
size_t
 
a_qsize
 = 
	`run_quªtize
(
	`¬’a_misûlm_is_key
(
a
) ?

177 
	`¬’a_misûlm_key_size_g‘
(
a
è: 
	`¬’a_misûlm_size_g‘
(a));

178 
size_t
 
b_qsize
 = 
	`run_quªtize
(
	`¬’a_misûlm_size_g‘
(
b
));

184 
»t
 = (
a_qsize
 > 
b_qsize
) - (a_qsize < b_qsize);

185 ià(
»t
 == 0) {

186 ià(!
	`¬’a_misûlm_is_key
(
a
)) {

187 
ušŒ_t
 
b_misûlm
 = (ušŒ_t)
b
;

189 
»t
 = (
a_misûlm
 > 
b_misûlm
) - (a_miscelm < b_miscelm);

194 
»t
 = -1;

198  (
»t
);

199 
	}
}

202 
	$rb_g’
(
UNUSED
, 
¬’a_ava_Œ“_
, 
¬’a_ava_Œ“_t
,

203 
¬’a_chunk_m­_misc_t
, 
rb_lšk
, 
¬’a_ava_comp
)

206 
	$¬’a_ava_š£¹
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

207 
size_t
 
Åages
)

210 
	`as£¹
(
Åages
 =ğ(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
) >>

211 
LG_PAGE
));

212 
	`¬’a_ava_Œ“_š£¹
(&
¬’a
->
runs_ava
, 
	`¬’a_misûlm_g‘
(
chunk
,

213 
·gešd
));

214 
	}
}

217 
	$¬’a_ava_»move
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

218 
size_t
 
Åages
)

221 
	`as£¹
(
Åages
 =ğ(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
) >>

222 
LG_PAGE
));

223 
	`¬’a_ava_Œ“_»move
(&
¬’a
->
runs_ava
, 
	`¬’a_misûlm_g‘
(
chunk
,

224 
·gešd
));

225 
	}
}

228 
	$¬’a_run_dœty_š£¹
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

229 
size_t
 
Åages
)

231 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_misûlm_g‘
(
chunk
, 
·gešd
);

233 
	`as£¹
(
Åages
 =ğ(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
) >>

234 
LG_PAGE
));

235 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
è=ğ
CHUNK_MAP_DIRTY
);

236 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
+
Åages
-1) ==

237 
CHUNK_MAP_DIRTY
);

239 
	`qr_Ãw
(&
misûlm
->
rd
, 
rd_lšk
);

240 
	`qr_m–d
(&
¬’a
->
runs_dœty
, &
misûlm
->
rd
, 
rd_lšk
);

241 
¬’a
->
ndœty
 +ğ
Åages
;

242 
	}
}

245 
	$¬’a_run_dœty_»move
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 
·gešd
,

246 
size_t
 
Åages
)

248 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_misûlm_g‘
(
chunk
, 
·gešd
);

250 
	`as£¹
(
Åages
 =ğ(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
) >>

251 
LG_PAGE
));

252 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
è=ğ
CHUNK_MAP_DIRTY
);

253 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
+
Åages
-1) ==

254 
CHUNK_MAP_DIRTY
);

256 
	`qr_»move
(&
misûlm
->
rd
, 
rd_lšk
);

257 
	`as£¹
(
¬’a
->
ndœty
 >ğ
Åages
);

258 
¬’a
->
ndœty
 -ğ
Åages
;

259 
	}
}

261 
size_t


262 
	$¬’a_chunk_dœty_Åages
(cÚ¡ 
ex‹Á_node_t
 *
node
)

265  (
	`ex‹Á_node_size_g‘
(
node
è>> 
LG_PAGE
);

266 
	}
}

269 
	$¬’a_chunk_ÿche_maybe_š£¹
(
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
, 
boŞ
 
ÿche
)

272 ià(
ÿche
) {

273 
	`ex‹Á_node_dœty_lškage_š™
(
node
);

274 
	`ex‹Á_node_dœty_š£¹
(
node
, &
¬’a
->
runs_dœty
,

275 &
¬’a
->
chunks_ÿche
);

276 
¬’a
->
ndœty
 +ğ
	`¬’a_chunk_dœty_Åages
(
node
);

278 
	}
}

281 
	$¬’a_chunk_ÿche_maybe_»move
(
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
, 
boŞ
 
dœty
)

284 ià(
dœty
) {

285 
	`ex‹Á_node_dœty_»move
(
node
);

286 
	`as£¹
(
¬’a
->
ndœty
 >ğ
	`¬’a_chunk_dœty_Åages
(
node
));

287 
¬’a
->
ndœty
 -ğ
	`¬’a_chunk_dœty_Åages
(
node
);

289 
	}
}

291 
JEMALLOC_INLINE_C
 *

292 
	$¬’a_run_»g_®loc
(
¬’a_run_t
 *
run
, 
¬’a_bš_šfo_t
 *
bš_šfo
)

294 *
»t
;

295 
»gšd
;

296 
¬’a_chunk_m­_misc_t
 *
misûlm
;

297 *
½ages
;

299 
	`as£¹
(
run
->
nä“
 > 0);

300 
	`as£¹
(!
	`b™m­_fuÎ
(
run
->
b™m­
, &
bš_šfo
->
b™m­_šfo
));

302 
»gšd
 = 
	`b™m­_sfu
(
run
->
b™m­
, &
bš_šfo
->
b™m­_šfo
);

303 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

304 
½ages
 = 
	`¬’a_misûlm_to_½ages
(
misûlm
);

305 
»t
 = (*)((
ušŒ_t
)
½ages
 + (ušŒ_t)
bš_šfo
->
»g0_off£t
 +

306 (
ušŒ_t
)(
bš_šfo
->
»g_š‹rv®
 * 
»gšd
));

307 
run
->
nä“
--;

308  (
»t
);

309 
	}
}

311 
JEMALLOC_INLINE_C
 

312 
	$¬’a_run_»g_d®loc
(
¬’a_run_t
 *
run
, *
±r
)

314 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(
run
);

315 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

316 
size_t
 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

317 
szšd_t
 
bššd
 = 
	`¬’a_±r_sm®l_bššd_g‘
(
±r
, 
m­b™s
);

318 
¬’a_bš_šfo_t
 *
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

319 
»gšd
 = 
	`¬’a_run_»gšd
(
run
, 
bš_šfo
, 
±r
);

321 
	`as£¹
(
run
->
nä“
 < 
bš_šfo
->
Äegs
);

323 
	`as£¹
(((
ušŒ_t
)
±r
 -

324 ((
ušŒ_t
)
	`¬’a_misûlm_to_½ages
(
	`¬’a_run_to_misûlm
(
run
)) +

325 (
ušŒ_t
)
bš_šfo
->
»g0_off£t
)) %

326 (
ušŒ_t
)
bš_šfo
->
»g_š‹rv®
 == 0);

327 
	`as£¹
((
ušŒ_t
)
±r
 >=

328 (
ušŒ_t
)
	`¬’a_misûlm_to_½ages
(
	`¬’a_run_to_misûlm
(
run
)) +

329 (
ušŒ_t
)
bš_šfo
->
»g0_off£t
);

331 
	`as£¹
(
	`b™m­_g‘
(
run
->
b™m­
, &
bš_šfo
->
b™m­_šfo
, 
»gšd
));

333 
	`b™m­_un£t
(
run
->
b™m­
, &
bš_šfo
->
b™m­_šfo
, 
»gšd
);

334 
run
->
nä“
++;

335 
	}
}

337 
JEMALLOC_INLINE_C
 

338 
	$¬’a_run_z”o
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
run_šd
, size_ˆ
Åages
)

341 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
((*)((
ušŒ_t
)
chunk
 +

342 (
run_šd
 << 
LG_PAGE
)), (
Åages
 << LG_PAGE));

343 
	`mem£t
((*)((
ušŒ_t
)
chunk
 + (
run_šd
 << 
LG_PAGE
)), 0,

344 (
Åages
 << 
LG_PAGE
));

345 
	}
}

347 
JEMALLOC_INLINE_C
 

348 
	$¬’a_run_·ge_m¬k_z”Ûd
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
run_šd
)

351 
	`JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
((*)((
ušŒ_t
)
chunk
 + (
run_šd


352 << 
LG_PAGE
)), 
PAGE
);

353 
	}
}

355 
JEMALLOC_INLINE_C
 

356 
	$¬’a_run_·ge_v®id©e_z”Ûd
(
¬’a_chunk_t
 *
chunk
, 
size_t
 
run_šd
)

358 
size_t
 
i
;

359 
UNUSED
 
size_t
 *
p
 = (size_ˆ*)((
ušŒ_t
)
chunk
 + (
run_šd
 << 
LG_PAGE
));

361 
	`¬’a_run_·ge_m¬k_z”Ûd
(
chunk
, 
run_šd
);

362 
i
 = 0; i < 
PAGE
 / (
size_t
); i++)

363 
	`as£¹
(
p
[
i
] == 0);

364 
	}
}

367 
	$¬’a_ÿùive_upd©e
(
¬’a_t
 *
¬’a
, 
size_t
 
add_·ges
, size_ˆ
sub_·ges
)

370 ià(
cÚfig_¡©s
) {

371 
ssize_t
 
ÿùive_diff
 = 
	`CHUNK_CEILING
((
¬’a
->
Çùive
 + 
add_·ges


372 - 
sub_·ges
è<< 
LG_PAGE
è- 
	`CHUNK_CEILING
(
¬’a
->
Çùive
 <<

373 
LG_PAGE
);

374 ià(
ÿùive_diff
 != 0)

375 
	`¡©s_ÿùive_add
(
ÿùive_diff
);

377 
	}
}

380 
	$¬’a_run_¥l™_»move
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 
run_šd
,

381 
size_t
 
æag_dœty
, size_ˆ
æag_decomm™‹d
, size_ˆ
Ãed_·ges
)

383 
size_t
 
tÙ®_·ges
, 
»m_·ges
;

385 
	`as£¹
(
æag_dœty
 =ğ0 || 
æag_decomm™‹d
 == 0);

387 
tÙ®_·ges
 = 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
run_šd
) >>

388 
LG_PAGE
;

389 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
+
tÙ®_·ges
-1) ==

390 
æag_dœty
);

391 
	`as£¹
(
Ãed_·ges
 <ğ
tÙ®_·ges
);

392 
»m_·ges
 = 
tÙ®_·ges
 - 
Ãed_·ges
;

394 
	`¬’a_ava_»move
(
¬’a
, 
chunk
, 
run_šd
, 
tÙ®_·ges
);

395 ià(
æag_dœty
 != 0)

396 
	`¬’a_run_dœty_»move
(
¬’a
, 
chunk
, 
run_šd
, 
tÙ®_·ges
);

397 
	`¬’a_ÿùive_upd©e
(
¬’a
, 
Ãed_·ges
, 0);

398 
¬’a
->
Çùive
 +ğ
Ãed_·ges
;

401 ià(
»m_·ges
 > 0) {

402 
size_t
 
æags
 = 
æag_dœty
 | 
æag_decomm™‹d
;

403 
size_t
 
æag_unz”Ûd_mask
 = (
æags
 =ğ0è? 
CHUNK_MAP_UNZEROED
 :

406 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
+
Ãed_·ges
,

407 (
»m_·ges
 << 
LG_PAGE
), 
æags
 |

408 (
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
+
Ãed_·ges
) &

409 
æag_unz”Ûd_mask
));

410 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
+
tÙ®_·ges
-1,

411 (
»m_·ges
 << 
LG_PAGE
), 
æags
 |

412 (
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
+
tÙ®_·ges
-1) &

413 
æag_unz”Ûd_mask
));

414 ià(
æag_dœty
 != 0) {

415 
	`¬’a_run_dœty_š£¹
(
¬’a
, 
chunk
, 
run_šd
+
Ãed_·ges
,

416 
»m_·ges
);

418 
	`¬’a_ava_š£¹
(
¬’a
, 
chunk
, 
run_šd
+
Ãed_·ges
, 
»m_·ges
);

420 
	}
}

422 
boŞ


423 
	$¬’a_run_¥l™_Ïrge_h–³r
(
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
, 
size_t
 
size
,

424 
boŞ
 
»move
, boŞ 
z”o
)

426 
¬’a_chunk_t
 *
chunk
;

427 
¬’a_chunk_m­_misc_t
 *
misûlm
;

428 
size_t
 
æag_dœty
, 
æag_decomm™‹d
, 
run_šd
, 
Ãed_·ges
;

429 
size_t
 
æag_unz”Ûd_mask
;

431 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
run
);

432 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

433 
run_šd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

434 
æag_dœty
 = 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
);

435 
æag_decomm™‹d
 = 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
);

436 
Ãed_·ges
 = (
size
 >> 
LG_PAGE
);

437 
	`as£¹
(
Ãed_·ges
 > 0);

439 ià(
æag_decomm™‹d
 !ğ0 && 
¬’a
->
chunk_hooks
.
	`comm™
(
chunk
, 
chunksize
,

440 
run_šd
 << 
LG_PAGE
, 
size
, 
¬’a
->
šd
))

441  (
Œue
);

443 ià(
»move
) {

444 
	`¬’a_run_¥l™_»move
(
¬’a
, 
chunk
, 
run_šd
, 
æag_dœty
,

445 
æag_decomm™‹d
, 
Ãed_·ges
);

448 ià(
z”o
) {

449 ià(
æag_decomm™‹d
 != 0) {

451 
	`JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
((

452 *)((
ušŒ_t
)
chunk
 + (
run_šd
 << 
LG_PAGE
)),

453 (
Ãed_·ges
 << 
LG_PAGE
));

454 } ià(
æag_dœty
 != 0) {

456 
	`¬’a_run_z”o
(
chunk
, 
run_šd
, 
Ãed_·ges
);

462 
size_t
 
i
;

463 
i
 = 0; i < 
Ãed_·ges
; i++) {

464 ià(
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
+
i
)

466 
	`¬’a_run_z”o
(
chunk
, 
run_šd
+
i
, 1);

467 ià(
cÚfig_debug
) {

468 
	`¬’a_run_·ge_v®id©e_z”Ûd
(
chunk
,

469 
run_šd
+
i
);

471 
	`¬’a_run_·ge_m¬k_z”Ûd
(
chunk
,

472 
run_šd
+
i
);

477 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
((*)((
ušŒ_t
)
chunk
 +

478 (
run_šd
 << 
LG_PAGE
)), (
Ãed_·ges
 << LG_PAGE));

485 
æag_unz”Ûd_mask
 = (
æag_dœty
 | 
æag_decomm™‹d
) == 0 ?

486 
CHUNK_MAP_UNZEROED
 : 0;

487 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
run_šd
+
Ãed_·ges
-1, 0, 
æag_dœty
 |

488 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

489 
run_šd
+
Ãed_·ges
-1)));

490 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
run_šd
, 
size
, 
æag_dœty
 |

491 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
)));

492  (
çl£
);

493 
	}
}

495 
boŞ


496 
	$¬’a_run_¥l™_Ïrge
(
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
, 
size_t
 
size
, 
boŞ
 
z”o
)

499  (
	`¬’a_run_¥l™_Ïrge_h–³r
(
¬’a
, 
run
, 
size
, 
Œue
, 
z”o
));

500 
	}
}

502 
boŞ


503 
	$¬’a_run_š™_Ïrge
(
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
, 
size_t
 
size
, 
boŞ
 
z”o
)

506  (
	`¬’a_run_¥l™_Ïrge_h–³r
(
¬’a
, 
run
, 
size
, 
çl£
, 
z”o
));

507 
	}
}

509 
boŞ


510 
	$¬’a_run_¥l™_sm®l
(
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
, 
size_t
 
size
,

511 
szšd_t
 
bššd
)

513 
¬’a_chunk_t
 *
chunk
;

514 
¬’a_chunk_m­_misc_t
 *
misûlm
;

515 
size_t
 
æag_dœty
, 
æag_decomm™‹d
, 
run_šd
, 
Ãed_·ges
, 
i
;

517 
	`as£¹
(
bššd
 !ğ
BININD_INVALID
);

519 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
run
);

520 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

521 
run_šd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

522 
æag_dœty
 = 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
);

523 
æag_decomm™‹d
 = 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
);

524 
Ãed_·ges
 = (
size
 >> 
LG_PAGE
);

525 
	`as£¹
(
Ãed_·ges
 > 0);

527 ià(
æag_decomm™‹d
 !ğ0 && 
¬’a
->
chunk_hooks
.
	`comm™
(
chunk
, 
chunksize
,

528 
run_šd
 << 
LG_PAGE
, 
size
, 
¬’a
->
šd
))

529  (
Œue
);

531 
	`¬’a_run_¥l™_»move
(
¬’a
, 
chunk
, 
run_šd
, 
æag_dœty
,

532 
æag_decomm™‹d
, 
Ãed_·ges
);

534 
i
 = 0; i < 
Ãed_·ges
; i++) {

535 
size_t
 
æag_unz”Ûd
 = 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

536 
run_šd
+
i
);

537 
	`¬’a_m­b™s_sm®l_£t
(
chunk
, 
run_šd
+
i
, i, 
bššd
,

538 
æag_unz”Ûd
);

539 ià(
cÚfig_debug
 && 
æag_dœty
 =ğ0 && 
æag_unz”Ûd
 == 0)

540 
	`¬’a_run_·ge_v®id©e_z”Ûd
(
chunk
, 
run_šd
+
i
);

542 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
((*)((
ušŒ_t
)
chunk
 +

543 (
run_šd
 << 
LG_PAGE
)), (
Ãed_·ges
 << LG_PAGE));

544  (
çl£
);

545 
	}
}

547 
¬’a_chunk_t
 *

548 
	$¬’a_chunk_š™_¥¬e
(
¬’a_t
 *
¬’a
)

550 
¬’a_chunk_t
 *
chunk
;

552 
	`as£¹
(
¬’a
->
¥¬e
 !ğ
NULL
);

554 
chunk
 = 
¬’a
->
¥¬e
;

555 
¬’a
->
¥¬e
 = 
NULL
;

557 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
m­_bŸs
) == 0);

558 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
chunk_Åages
-1) == 0);

559 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
m­_bŸs
) ==

560 
¬’a_maxrun
);

561 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
chunk_Åages
-1) ==

562 
¬’a_maxrun
);

563 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
m­_bŸs
) ==

564 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
chunk_Åages
-1));

566  (
chunk
);

567 
	}
}

569 
boŞ


570 
	$¬’a_chunk_»gi¡”
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
boŞ
 
z”o
)

579 
	`ex‹Á_node_š™
(&
chunk
->
node
, 
¬’a
, chunk, 
chunksize
, 
z”o
, 
Œue
);

580 
	`ex‹Á_node_achunk_£t
(&
chunk
->
node
, 
Œue
);

581  (
	`chunk_»gi¡”
(
chunk
, &chunk->
node
));

582 
	}
}

584 
¬’a_chunk_t
 *

585 
	$¬’a_chunk_®loc_š‹º®_h¬d
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

586 
boŞ
 *
z”o
, boŞ *
comm™
)

588 
¬’a_chunk_t
 *
chunk
;

590 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

592 
chunk
 = (
¬’a_chunk_t
 *)
	`chunk_®loc_w¿µ”
(
¬’a
, 
chunk_hooks
, 
NULL
,

593 
chunksize
, chunksize, 
z”o
, 
comm™
);

594 ià(
chunk
 !ğ
NULL
 && !*
comm™
) {

596 ià(
chunk_hooks
->
	`comm™
(
chunk
, 
chunksize
, 0, 
m­_bŸs
 <<

597 
LG_PAGE
, 
¬’a
->
šd
)) {

598 
	`chunk_d®loc_w¿µ”
(
¬’a
, 
chunk_hooks
,

599 (*)
chunk
, 
chunksize
, *
comm™
);

600 
chunk
 = 
NULL
;

603 ià(
chunk
 !ğ
NULL
 && 
	`¬’a_chunk_»gi¡”
(
¬’a
, chunk, *
z”o
)) {

604 ià(!*
comm™
) {

606 
chunk_hooks
->
	`decomm™
(
chunk
, 
chunksize
, 0, 
m­_bŸs
 <<

607 
LG_PAGE
, 
¬’a
->
šd
);

609 
	`chunk_d®loc_w¿µ”
(
¬’a
, 
chunk_hooks
, (*)
chunk
,

610 
chunksize
, *
comm™
);

611 
chunk
 = 
NULL
;

614 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

615  (
chunk
);

616 
	}
}

618 
¬’a_chunk_t
 *

619 
	$¬’a_chunk_®loc_š‹º®
(
¬’a_t
 *
¬’a
, 
boŞ
 *
z”o
, boŞ *
comm™
)

621 
¬’a_chunk_t
 *
chunk
;

622 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

624 
chunk
 = 
	`chunk_®loc_ÿche
(
¬’a
, &
chunk_hooks
, 
NULL
, 
chunksize
,

625 
chunksize
, 
z”o
, 
Œue
);

626 ià(
chunk
 !ğ
NULL
) {

627 ià(
	`¬’a_chunk_»gi¡”
(
¬’a
, 
chunk
, *
z”o
)) {

628 
	`chunk_d®loc_ÿche
(
¬’a
, &
chunk_hooks
, 
chunk
,

629 
chunksize
, 
Œue
);

630  (
NULL
);

632 *
comm™
 = 
Œue
;

634 ià(
chunk
 =ğ
NULL
) {

635 
chunk
 = 
	`¬’a_chunk_®loc_š‹º®_h¬d
(
¬’a
, &
chunk_hooks
,

636 
z”o
, 
comm™
);

639 ià(
cÚfig_¡©s
 && 
chunk
 !ğ
NULL
) {

640 
¬’a
->
¡©s
.
m­³d
 +ğ
chunksize
;

641 
¬’a
->
¡©s
.
m‘ad©a_m­³d
 +ğ(
m­_bŸs
 << 
LG_PAGE
);

644  (
chunk
);

645 
	}
}

647 
¬’a_chunk_t
 *

648 
	$¬’a_chunk_š™_h¬d
(
¬’a_t
 *
¬’a
)

650 
¬’a_chunk_t
 *
chunk
;

651 
boŞ
 
z”o
, 
comm™
;

652 
size_t
 
æag_unz”Ûd
, 
æag_decomm™‹d
, 
i
;

654 
	`as£¹
(
¬’a
->
¥¬e
 =ğ
NULL
);

656 
z”o
 = 
çl£
;

657 
comm™
 = 
çl£
;

658 
chunk
 = 
	`¬’a_chunk_®loc_š‹º®
(
¬’a
, &
z”o
, &
comm™
);

659 ià(
chunk
 =ğ
NULL
)

660  (
NULL
);

667 
æag_unz”Ûd
 = (
z”o
 || !
comm™
è? 0 : 
CHUNK_MAP_UNZEROED
;

668 
æag_decomm™‹d
 = 
comm™
 ? 0 : 
CHUNK_MAP_DECOMMITTED
;

669 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
m­_bŸs
, 
¬’a_maxrun
,

670 
æag_unz”Ûd
 | 
æag_decomm™‹d
);

675 ià(!
z”o
) {

676 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(

677 (*)
	`¬’a_b™£lm_g‘
(
chunk
, 
m­_bŸs
+1),

678 (
size_t
)((
ušŒ_t
è
	`¬’a_b™£lm_g‘
(
chunk
,

679 
chunk_Åages
-1è- (
ušŒ_t
)
	`¬’a_b™£lm_g‘
(
chunk
,

680 
m­_bŸs
+1)));

681 
i
 = 
m­_bŸs
+1; i < 
chunk_Åages
-1; i++)

682 
	`¬’a_m­b™s_š‹º®_£t
(
chunk
, 
i
, 
æag_unz”Ûd
);

684 
	`JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
((

685 *)
	`¬’a_b™£lm_g‘
(
chunk
, 
m­_bŸs
+1), (
size_t
)((
ušŒ_t
)

686 
	`¬’a_b™£lm_g‘
(
chunk
, 
chunk_Åages
-1) -

687 (
ušŒ_t
)
	`¬’a_b™£lm_g‘
(
chunk
, 
m­_bŸs
+1)));

688 ià(
cÚfig_debug
) {

689 
i
 = 
m­_bŸs
+1; i < 
chunk_Åages
-1; i++) {

690 
	`as£¹
(
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
i
) ==

691 
æag_unz”Ûd
);

695 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
chunk_Åages
-1, 
¬’a_maxrun
,

696 
æag_unz”Ûd
);

698  (
chunk
);

699 
	}
}

701 
¬’a_chunk_t
 *

702 
	$¬’a_chunk_®loc
(
¬’a_t
 *
¬’a
)

704 
¬’a_chunk_t
 *
chunk
;

706 ià(
¬’a
->
¥¬e
 !ğ
NULL
)

707 
chunk
 = 
	`¬’a_chunk_š™_¥¬e
(
¬’a
);

709 
chunk
 = 
	`¬’a_chunk_š™_h¬d
(
¬’a
);

710 ià(
chunk
 =ğ
NULL
)

711  (
NULL
);

715 
	`¬’a_ava_š£¹
(
¬’a
, 
chunk
, 
m­_bŸs
, 
chunk_Åages
-map_bias);

717  (
chunk
);

718 
	}
}

721 
	$¬’a_chunk_d®loc
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
)

724 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
m­_bŸs
) == 0);

725 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
chunk_Åages
-1) == 0);

726 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
m­_bŸs
) ==

727 
¬’a_maxrun
);

728 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
chunk_Åages
-1) ==

729 
¬’a_maxrun
);

730 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
m­_bŸs
) ==

731 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
chunk_Åages
-1));

732 
	`as£¹
(
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
m­_bŸs
) ==

733 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
chunk_Åages
-1));

739 
	`¬’a_ava_»move
(
¬’a
, 
chunk
, 
m­_bŸs
, 
chunk_Åages
-map_bias);

741 ià(
¬’a
->
¥¬e
 !ğ
NULL
) {

742 
¬’a_chunk_t
 *
¥¬e
 = 
¬’a
->spare;

743 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

744 
boŞ
 
comm™‹d
;

746 
¬’a
->
¥¬e
 = 
chunk
;

747 ià(
	`¬’a_m­b™s_dœty_g‘
(
¥¬e
, 
m­_bŸs
) != 0) {

748 
	`¬’a_run_dœty_»move
(
¬’a
, 
¥¬e
, 
m­_bŸs
,

749 
chunk_Åages
-
m­_bŸs
);

752 
	`chunk_d”egi¡”
(
¥¬e
, &¥¬e->
node
);

754 
comm™‹d
 = (
	`¬’a_m­b™s_decomm™‹d_g‘
(
¥¬e
, 
m­_bŸs
) ==

756 ià(!
comm™‹d
) {

764 
chunk_hooks
 = 
	`chunk_hooks_g‘
(
¬’a
);

765 
chunk_hooks
.
	`decomm™
(
¥¬e
, 
chunksize
, 0, 
m­_bŸs
 <<

766 
LG_PAGE
, 
¬’a
->
šd
);

769 
	`chunk_d®loc_ÿche
(
¬’a
, &
chunk_hooks
, (*)
¥¬e
,

770 
chunksize
, 
comm™‹d
);

772 ià(
cÚfig_¡©s
) {

773 
¬’a
->
¡©s
.
m­³d
 -ğ
chunksize
;

774 
¬’a
->
¡©s
.
m‘ad©a_m­³d
 -ğ(
m­_bŸs
 << 
LG_PAGE
);

777 
¬’a
->
¥¬e
 = 
chunk
;

778 
	}
}

781 
	$¬’a_huge_m®loc_¡©s_upd©e
(
¬’a_t
 *
¬’a
, 
size_t
 
usize
)

783 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
Æşas£s
 - 
NBINS
;

785 
	`ÿs£¹
(
cÚfig_¡©s
);

787 
¬’a
->
¡©s
.
nm®loc_huge
++;

788 
¬’a
->
¡©s
.
®loÿ‹d_huge
 +ğ
usize
;

789 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
nm®loc
++;

790 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
curhchunks
++;

791 
	}
}

794 
	$¬’a_huge_m®loc_¡©s_upd©e_undo
(
¬’a_t
 *
¬’a
, 
size_t
 
usize
)

796 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
Æşas£s
 - 
NBINS
;

798 
	`ÿs£¹
(
cÚfig_¡©s
);

800 
¬’a
->
¡©s
.
nm®loc_huge
--;

801 
¬’a
->
¡©s
.
®loÿ‹d_huge
 -ğ
usize
;

802 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
nm®loc
--;

803 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
curhchunks
--;

804 
	}
}

807 
	$¬’a_huge_d®loc_¡©s_upd©e
(
¬’a_t
 *
¬’a
, 
size_t
 
usize
)

809 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
Æşas£s
 - 
NBINS
;

811 
	`ÿs£¹
(
cÚfig_¡©s
);

813 
¬’a
->
¡©s
.
nd®loc_huge
++;

814 
¬’a
->
¡©s
.
®loÿ‹d_huge
 -ğ
usize
;

815 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
nd®loc
++;

816 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
curhchunks
--;

817 
	}
}

820 
	$¬’a_huge_d®loc_¡©s_upd©e_undo
(
¬’a_t
 *
¬’a
, 
size_t
 
usize
)

822 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
Æşas£s
 - 
NBINS
;

824 
	`ÿs£¹
(
cÚfig_¡©s
);

826 
¬’a
->
¡©s
.
nd®loc_huge
--;

827 
¬’a
->
¡©s
.
®loÿ‹d_huge
 +ğ
usize
;

828 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
nd®loc
--;

829 
¬’a
->
¡©s
.
h¡©s
[
šdex
].
curhchunks
++;

830 
	}
}

833 
	$¬’a_huge_¿Îoc_¡©s_upd©e
(
¬’a_t
 *
¬’a
, 
size_t
 
Şdsize
, size_ˆ
usize
)

836 
	`¬’a_huge_d®loc_¡©s_upd©e
(
¬’a
, 
Şdsize
);

837 
	`¬’a_huge_m®loc_¡©s_upd©e
(
¬’a
, 
usize
);

838 
	}
}

841 
	$¬’a_huge_¿Îoc_¡©s_upd©e_undo
(
¬’a_t
 *
¬’a
, 
size_t
 
Şdsize
,

842 
size_t
 
usize
)

845 
	`¬’a_huge_d®loc_¡©s_upd©e_undo
(
¬’a
, 
Şdsize
);

846 
	`¬’a_huge_m®loc_¡©s_upd©e_undo
(
¬’a
, 
usize
);

847 
	}
}

849 
ex‹Á_node_t
 *

850 
	$¬’a_node_®loc
(
¬’a_t
 *
¬’a
)

852 
ex‹Á_node_t
 *
node
;

854 
	`m®loc_mu‹x_lock
(&
¬’a
->
node_ÿche_mtx
);

855 
node
 = 
	`ql_Ï¡
(&
¬’a
->
node_ÿche
, 
ql_lšk
);

856 ià(
node
 =ğ
NULL
) {

857 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
node_ÿche_mtx
);

858  (
	`ba£_®loc
((
ex‹Á_node_t
)));

860 
	`ql__»move
(&
¬’a
->
node_ÿche
, 
ex‹Á_node_t
, 
ql_lšk
);

861 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
node_ÿche_mtx
);

862  (
node
);

863 
	}
}

866 
	$¬’a_node_d®loc
(
¬’a_t
 *
¬’a
, 
ex‹Á_node_t
 *
node
)

869 
	`m®loc_mu‹x_lock
(&
¬’a
->
node_ÿche_mtx
);

870 
	`ql_–m_Ãw
(
node
, 
ql_lšk
);

871 
	`ql__š£¹
(&
¬’a
->
node_ÿche
, 
node
, 
ql_lšk
);

872 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
node_ÿche_mtx
);

873 
	}
}

876 
	$¬’a_chunk_®loc_huge_h¬d
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

877 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, size_ˆ
csize
)

879 *
»t
;

880 
boŞ
 
comm™
 = 
Œue
;

882 
»t
 = 
	`chunk_®loc_w¿µ”
(
¬’a
, 
chunk_hooks
, 
NULL
, 
csize
, 
®ignm’t
,

883 
z”o
, &
comm™
);

884 ià(
»t
 =ğ
NULL
) {

886 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

887 ià(
cÚfig_¡©s
) {

888 
	`¬’a_huge_m®loc_¡©s_upd©e_undo
(
¬’a
, 
usize
);

889 
¬’a
->
¡©s
.
m­³d
 -ğ
usize
;

891 
¬’a
->
Çùive
 -ğ(
usize
 >> 
LG_PAGE
);

892 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

895  (
»t
);

896 
	}
}

899 
	$¬’a_chunk_®loc_huge
(
¬’a_t
 *
¬’a
, 
size_t
 
usize
, size_ˆ
®ignm’t
,

900 
boŞ
 *
z”o
)

902 *
»t
;

903 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

904 
size_t
 
csize
 = 
	`CHUNK_CEILING
(
usize
);

906 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

909 ià(
cÚfig_¡©s
) {

910 
	`¬’a_huge_m®loc_¡©s_upd©e
(
¬’a
, 
usize
);

911 
¬’a
->
¡©s
.
m­³d
 +ğ
usize
;

913 
¬’a
->
Çùive
 +ğ(
usize
 >> 
LG_PAGE
);

915 
»t
 = 
	`chunk_®loc_ÿche
(
¬’a
, &
chunk_hooks
, 
NULL
, 
csize
, 
®ignm’t
,

916 
z”o
, 
Œue
);

917 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

918 ià(
»t
 =ğ
NULL
) {

919 
»t
 = 
	`¬’a_chunk_®loc_huge_h¬d
(
¬’a
, &
chunk_hooks
, 
usize
,

920 
®ignm’t
, 
z”o
, 
csize
);

923 ià(
cÚfig_¡©s
 && 
»t
 !ğ
NULL
)

924 
	`¡©s_ÿùive_add
(
usize
);

925  (
»t
);

926 
	}
}

929 
	$¬’a_chunk_d®loc_huge
(
¬’a_t
 *
¬’a
, *
chunk
, 
size_t
 
usize
)

931 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

932 
size_t
 
csize
;

934 
csize
 = 
	`CHUNK_CEILING
(
usize
);

935 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

936 ià(
cÚfig_¡©s
) {

937 
	`¬’a_huge_d®loc_¡©s_upd©e
(
¬’a
, 
usize
);

938 
¬’a
->
¡©s
.
m­³d
 -ğ
usize
;

939 
	`¡©s_ÿùive_sub
(
usize
);

941 
¬’a
->
Çùive
 -ğ(
usize
 >> 
LG_PAGE
);

943 
	`chunk_d®loc_ÿche
(
¬’a
, &
chunk_hooks
, 
chunk
, 
csize
, 
Œue
);

944 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

945 
	}
}

948 
	$¬’a_chunk_¿Îoc_huge_sim¬
(
¬’a_t
 *
¬’a
, *
chunk
, 
size_t
 
Şdsize
,

949 
size_t
 
usize
)

952 
	`as£¹
(
	`CHUNK_CEILING
(
Şdsize
è=ğCHUNK_CEILING(
usize
));

953 
	`as£¹
(
Şdsize
 !ğ
usize
);

955 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

956 ià(
cÚfig_¡©s
)

957 
	`¬’a_huge_¿Îoc_¡©s_upd©e
(
¬’a
, 
Şdsize
, 
usize
);

958 ià(
Şdsize
 < 
usize
) {

959 
size_t
 
udiff
 = 
usize
 - 
Şdsize
;

960 
¬’a
->
Çùive
 +ğ
udiff
 >> 
LG_PAGE
;

961 ià(
cÚfig_¡©s
)

962 
	`¡©s_ÿùive_add
(
udiff
);

964 
size_t
 
udiff
 = 
Şdsize
 - 
usize
;

965 
¬’a
->
Çùive
 -ğ
udiff
 >> 
LG_PAGE
;

966 ià(
cÚfig_¡©s
)

967 
	`¡©s_ÿùive_sub
(
udiff
);

969 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

970 
	}
}

973 
	$¬’a_chunk_¿Îoc_huge_shršk
(
¬’a_t
 *
¬’a
, *
chunk
, 
size_t
 
Şdsize
,

974 
size_t
 
usize
)

976 
size_t
 
udiff
 = 
Şdsize
 - 
usize
;

977 
size_t
 
cdiff
 = 
	`CHUNK_CEILING
(
Şdsize
è- CHUNK_CEILING(
usize
);

979 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

980 ià(
cÚfig_¡©s
) {

981 
	`¬’a_huge_¿Îoc_¡©s_upd©e
(
¬’a
, 
Şdsize
, 
usize
);

982 ià(
cdiff
 != 0) {

983 
¬’a
->
¡©s
.
m­³d
 -ğ
cdiff
;

984 
	`¡©s_ÿùive_sub
(
udiff
);

987 
¬’a
->
Çùive
 -ğ
udiff
 >> 
LG_PAGE
;

989 ià(
cdiff
 != 0) {

990 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

991 *
nchunk
 = (*)((
ušŒ_t
)
chunk
 +

992 
	`CHUNK_CEILING
(
usize
));

994 
	`chunk_d®loc_ÿche
(
¬’a
, &
chunk_hooks
, 
nchunk
, 
cdiff
, 
Œue
);

996 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

997 
	}
}

999 
boŞ


1000 
	$¬’a_chunk_¿Îoc_huge_ex·nd_h¬d
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

1001 *
chunk
, 
size_t
 
Şdsize
, size_ˆ
usize
, 
boŞ
 *
z”o
, *
nchunk
,

1002 
size_t
 
udiff
, size_ˆ
cdiff
)

1004 
boŞ
 
”r
;

1005 
boŞ
 
comm™
 = 
Œue
;

1007 
”r
 = (
	`chunk_®loc_w¿µ”
(
¬’a
, 
chunk_hooks
, 
nchunk
, 
cdiff
, 
chunksize
,

1008 
z”o
, &
comm™
è=ğ
NULL
);

1009 ià(
”r
) {

1011 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

1012 ià(
cÚfig_¡©s
) {

1013 
	`¬’a_huge_¿Îoc_¡©s_upd©e_undo
(
¬’a
, 
Şdsize
,

1014 
usize
);

1015 
¬’a
->
¡©s
.
m­³d
 -ğ
cdiff
;

1017 
¬’a
->
Çùive
 -ğ(
udiff
 >> 
LG_PAGE
);

1018 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

1019 } ià(
chunk_hooks
->
	`m”ge
(
chunk
, 
	`CHUNK_CEILING
(
Şdsize
), 
nchunk
,

1020 
cdiff
, 
Œue
, 
¬’a
->
šd
)) {

1021 
	`chunk_d®loc_¬’a
(
¬’a
, 
chunk_hooks
, 
nchunk
, 
cdiff
, *
z”o
,

1022 
Œue
);

1023 
”r
 = 
Œue
;

1025  (
”r
);

1026 
	}
}

1028 
boŞ


1029 
	$¬’a_chunk_¿Îoc_huge_ex·nd
(
¬’a_t
 *
¬’a
, *
chunk
, 
size_t
 
Şdsize
,

1030 
size_t
 
usize
, 
boŞ
 *
z”o
)

1032 
boŞ
 
”r
;

1033 
chunk_hooks_t
 
chunk_hooks
 = 
	`chunk_hooks_g‘
(
¬’a
);

1034 *
nchunk
 = (*)((
ušŒ_t
)
chunk
 + 
	`CHUNK_CEILING
(
Şdsize
));

1035 
size_t
 
udiff
 = 
usize
 - 
Şdsize
;

1036 
size_t
 
cdiff
 = 
	`CHUNK_CEILING
(
usize
è- CHUNK_CEILING(
Şdsize
);

1038 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

1041 ià(
cÚfig_¡©s
) {

1042 
	`¬’a_huge_¿Îoc_¡©s_upd©e
(
¬’a
, 
Şdsize
, 
usize
);

1043 
¬’a
->
¡©s
.
m­³d
 +ğ
cdiff
;

1045 
¬’a
->
Çùive
 +ğ(
udiff
 >> 
LG_PAGE
);

1047 
”r
 = (
	`chunk_®loc_ÿche
(
¬’a
, &¬’a->
chunk_hooks
, 
nchunk
, 
cdiff
,

1048 
chunksize
, 
z”o
, 
Œue
è=ğ
NULL
);

1049 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

1050 ià(
”r
) {

1051 
”r
 = 
	`¬’a_chunk_¿Îoc_huge_ex·nd_h¬d
(
¬’a
, &
chunk_hooks
,

1052 
chunk
, 
Şdsize
, 
usize
, 
z”o
, 
nchunk
, 
udiff
,

1053 
cdiff
);

1054 } ià(
chunk_hooks
.
	`m”ge
(
chunk
, 
	`CHUNK_CEILING
(
Şdsize
), 
nchunk
,

1055 
cdiff
, 
Œue
, 
¬’a
->
šd
)) {

1056 
	`chunk_d®loc_¬’a
(
¬’a
, &
chunk_hooks
, 
nchunk
, 
cdiff
, *
z”o
,

1057 
Œue
);

1058 
”r
 = 
Œue
;

1061 ià(
cÚfig_¡©s
 && !
”r
)

1062 
	`¡©s_ÿùive_add
(
udiff
);

1063  (
”r
);

1064 
	}
}

1071 
¬’a_run_t
 *

1072 
	$¬’a_run_fœ¡_be¡_f™
(
¬’a_t
 *
¬’a
, 
size_t
 
size
)

1074 
size_t
 
£¬ch_size
 = 
	`run_quªtize_fœ¡
(
size
);

1075 
¬’a_chunk_m­_misc_t
 *
key
 = 
	`¬’a_misûlm_key_ü—‹
(
£¬ch_size
);

1076 
¬’a_chunk_m­_misc_t
 *
misûlm
 =

1077 
	`¬’a_ava_Œ“_n£¬ch
(&
¬’a
->
runs_ava
, 
key
);

1078 ià(
misûlm
 =ğ
NULL
)

1079  (
NULL
);

1080  (&
misûlm
->
run
);

1081 
	}
}

1083 
¬’a_run_t
 *

1084 
	$¬’a_run_®loc_Ïrge_h–³r
(
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
)

1086 
¬’a_run_t
 *
run
 = 
	`¬’a_run_fœ¡_be¡_f™
(
¬’a
, 
	`s2u
(
size
));

1087 ià(
run
 !ğ
NULL
) {

1088 ià(
	`¬’a_run_¥l™_Ïrge
(
¬’a
, 
run
, 
size
, 
z”o
))

1089 
run
 = 
NULL
;

1091  (
run
);

1092 
	}
}

1094 
¬’a_run_t
 *

1095 
	$¬’a_run_®loc_Ïrge
(
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
)

1097 
¬’a_chunk_t
 *
chunk
;

1098 
¬’a_run_t
 *
run
;

1100 
	`as£¹
(
size
 <ğ
¬’a_maxrun
);

1101 
	`as£¹
(
size
 =ğ
	`PAGE_CEILING
(size));

1104 
run
 = 
	`¬’a_run_®loc_Ïrge_h–³r
(
¬’a
, 
size
, 
z”o
);

1105 ià(
run
 !ğ
NULL
)

1106  (
run
);

1111 
chunk
 = 
	`¬’a_chunk_®loc
(
¬’a
);

1112 ià(
chunk
 !ğ
NULL
) {

1113 
run
 = &
	`¬’a_misûlm_g‘
(
chunk
, 
m­_bŸs
)->run;

1114 ià(
	`¬’a_run_¥l™_Ïrge
(
¬’a
, 
run
, 
size
, 
z”o
))

1115 
run
 = 
NULL
;

1116  (
run
);

1124  (
	`¬’a_run_®loc_Ïrge_h–³r
(
¬’a
, 
size
, 
z”o
));

1125 
	}
}

1127 
¬’a_run_t
 *

1128 
	$¬’a_run_®loc_sm®l_h–³r
(
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
szšd_t
 
bššd
)

1130 
¬’a_run_t
 *
run
 = 
	`¬’a_run_fœ¡_be¡_f™
(
¬’a
, 
size
);

1131 ià(
run
 !ğ
NULL
) {

1132 ià(
	`¬’a_run_¥l™_sm®l
(
¬’a
, 
run
, 
size
, 
bššd
))

1133 
run
 = 
NULL
;

1135  (
run
);

1136 
	}
}

1138 
¬’a_run_t
 *

1139 
	$¬’a_run_®loc_sm®l
(
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
szšd_t
 
bššd
)

1141 
¬’a_chunk_t
 *
chunk
;

1142 
¬’a_run_t
 *
run
;

1144 
	`as£¹
(
size
 <ğ
¬’a_maxrun
);

1145 
	`as£¹
(
size
 =ğ
	`PAGE_CEILING
(size));

1146 
	`as£¹
(
bššd
 !ğ
BININD_INVALID
);

1149 
run
 = 
	`¬’a_run_®loc_sm®l_h–³r
(
¬’a
, 
size
, 
bššd
);

1150 ià(
run
 !ğ
NULL
)

1151  (
run
);

1156 
chunk
 = 
	`¬’a_chunk_®loc
(
¬’a
);

1157 ià(
chunk
 !ğ
NULL
) {

1158 
run
 = &
	`¬’a_misûlm_g‘
(
chunk
, 
m­_bŸs
)->run;

1159 ià(
	`¬’a_run_¥l™_sm®l
(
¬’a
, 
run
, 
size
, 
bššd
))

1160 
run
 = 
NULL
;

1161  (
run
);

1169  (
	`¬’a_run_®loc_sm®l_h–³r
(
¬’a
, 
size
, 
bššd
));

1170 
	}
}

1172 
boŞ


1173 
	$¬’a_lg_dœty_muÉ_v®id
(
ssize_t
 
lg_dœty_muÉ
)

1176  (
lg_dœty_muÉ
 >ğ-1 &&†g_dœty_muÉ < (
ssize_t
)((
size_t
)

1178 
	}
}

1180 
ssize_t


1181 
	$¬’a_lg_dœty_muÉ_g‘
(
¬’a_t
 *
¬’a
)

1183 
ssize_t
 
lg_dœty_muÉ
;

1185 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

1186 
lg_dœty_muÉ
 = 
¬’a
->lg_dirty_mult;

1187 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

1189  (
lg_dœty_muÉ
);

1190 
	}
}

1192 
boŞ


1193 
	$¬’a_lg_dœty_muÉ_£t
(
¬’a_t
 *
¬’a
, 
ssize_t
 
lg_dœty_muÉ
)

1196 ià(!
	`¬’a_lg_dœty_muÉ_v®id
(
lg_dœty_muÉ
))

1197  (
Œue
);

1199 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

1200 
¬’a
->
lg_dœty_muÉ
 =†g_dirty_mult;

1201 
	`¬’a_maybe_purge
(
¬’a
);

1202 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

1204  (
çl£
);

1205 
	}
}

1208 
	$¬’a_maybe_purge
(
¬’a_t
 *
¬’a
)

1212 ià(
¬’a
->
lg_dœty_muÉ
 < 0)

1215 ià(
¬’a
->
purgšg
)

1221 
Œue
) {

1222 
size_t
 
th»shŞd
 = (
¬’a
->
Çùive
 >>‡»Ç->
lg_dœty_muÉ
);

1223 ià(
th»shŞd
 < 
chunk_Åages
)

1224 
th»shŞd
 = 
chunk_Åages
;

1229 ià(
¬’a
->
ndœty
 <ğ
th»shŞd
)

1231 
	`¬’a_purge
(
¬’a
, 
çl£
);

1233 
	}
}

1235 
size_t


1236 
	$¬’a_dœty_couÁ
(
¬’a_t
 *
¬’a
)

1238 
size_t
 
ndœty
 = 0;

1239 
¬’a_runs_dœty_lšk_t
 *
rd–m
;

1240 
ex‹Á_node_t
 *
chunk£lm
;

1242 
rd–m
 = 
	`qr_Ãxt
(&
¬’a
->
runs_dœty
, 
rd_lšk
),

1243 
chunk£lm
 = 
	`qr_Ãxt
(&
¬’a
->
chunks_ÿche
, 
cc_lšk
);

1244 
rd–m
 !ğ&
¬’a
->
runs_dœty
;„d–m = 
	`qr_Ãxt
Ôd–m, 
rd_lšk
)) {

1245 
size_t
 
Åages
;

1247 ià(
rd–m
 =ğ&
chunk£lm
->
rd
) {

1248 
Åages
 = 
	`ex‹Á_node_size_g‘
(
chunk£lm
è>> 
LG_PAGE
;

1249 
chunk£lm
 = 
	`qr_Ãxt
(chunk£lm, 
cc_lšk
);

1251 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(

1252 
rd–m
);

1253 
¬’a_chunk_m­_misc_t
 *
misûlm
 =

1254 
	`¬’a_rd_to_misûlm
(
rd–m
);

1255 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1256 
	`as£¹
(
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
·gešd
) ==

1258 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
·gešd
) == 0);

1259 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
) != 0);

1260 
Åages
 = 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
,

1261 
·gešd
è>> 
LG_PAGE
;

1263 
ndœty
 +ğ
Åages
;

1266  (
ndœty
);

1267 
	}
}

1269 
size_t


1270 
	$¬’a_compu‹_Åurge
(
¬’a_t
 *
¬’a
, 
boŞ
 
®l
)

1272 
size_t
 
Åurge
;

1278 ià(!
®l
) {

1279 
size_t
 
th»shŞd
 = (
¬’a
->
Çùive
 >>‡»Ç->
lg_dœty_muÉ
);

1280 
th»shŞd
 =h»shŞd < 
chunk_Åages
 ? chunk_npages :hreshold;

1282 
Åurge
 = 
¬’a
->
ndœty
 - 
th»shŞd
;

1284 
Åurge
 = 
¬’a
->
ndœty
;

1286  (
Åurge
);

1287 
	}
}

1289 
size_t


1290 
	$¬’a_¡ash_dœty
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
, 
boŞ
 
®l
,

1291 
size_t
 
Åurge
, 
¬’a_runs_dœty_lšk_t
 *
purge_runs_£Áš–
,

1292 
ex‹Á_node_t
 *
purge_chunks_£Áš–
)

1294 
¬’a_runs_dœty_lšk_t
 *
rd–m
, *
rd–m_Ãxt
;

1295 
ex‹Á_node_t
 *
chunk£lm
;

1296 
size_t
 
n¡ashed
 = 0;

1299 
rd–m
 = 
	`qr_Ãxt
(&
¬’a
->
runs_dœty
, 
rd_lšk
),

1300 
chunk£lm
 = 
	`qr_Ãxt
(&
¬’a
->
chunks_ÿche
, 
cc_lšk
);

1301 
rd–m
 !ğ&
¬’a
->
runs_dœty
;„d–m = 
rd–m_Ãxt
) {

1302 
size_t
 
Åages
;

1303 
rd–m_Ãxt
 = 
	`qr_Ãxt
(
rd–m
, 
rd_lšk
);

1305 ià(
rd–m
 =ğ&
chunk£lm
->
rd
) {

1306 
ex‹Á_node_t
 *
chunk£lm_Ãxt
;

1307 
boŞ
 
z”o
;

1308 
UNUSED
 *
chunk
;

1310 
chunk£lm_Ãxt
 = 
	`qr_Ãxt
(
chunk£lm
, 
cc_lšk
);

1315 
z”o
 = 
çl£
;

1316 
chunk
 = 
	`chunk_®loc_ÿche
(
¬’a
, 
chunk_hooks
,

1317 
	`ex‹Á_node_addr_g‘
(
chunk£lm
),

1318 
	`ex‹Á_node_size_g‘
(
chunk£lm
), 
chunksize
, &
z”o
,

1319 
çl£
);

1320 
	`as£¹
(
chunk
 =ğ
	`ex‹Á_node_addr_g‘
(
chunk£lm
));

1321 
	`as£¹
(
z”o
 =ğ
	`ex‹Á_node_z”Ûd_g‘
(
chunk£lm
));

1322 
	`ex‹Á_node_dœty_š£¹
(
chunk£lm
, 
purge_runs_£Áš–
,

1323 
purge_chunks_£Áš–
);

1324 
Åages
 = 
	`ex‹Á_node_size_g‘
(
chunk£lm
è>> 
LG_PAGE
;

1325 
chunk£lm
 = 
chunk£lm_Ãxt
;

1327 
¬’a_chunk_t
 *
chunk
 =

1328 (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
rd–m
);

1329 
¬’a_chunk_m­_misc_t
 *
misûlm
 =

1330 
	`¬’a_rd_to_misûlm
(
rd–m
);

1331 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1332 
¬’a_run_t
 *
run
 = &
misûlm
->run;

1333 
size_t
 
run_size
 =

1334 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
);

1336 
Åages
 = 
run_size
 >> 
LG_PAGE
;

1338 
	`as£¹
(
·gešd
 + 
Åages
 <ğ
chunk_Åages
);

1339 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
) ==

1340 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
+
Åages
-1));

1346 ià(
chunk
 =ğ
¬’a
->
¥¬e
)

1347 
	`¬’a_chunk_®loc
(
¬’a
);

1350 
	`¬’a_run_¥l™_Ïrge
(
¬’a
, 
run
, 
run_size
, 
çl£
);

1352 ià(
çl£
)

1353 
	`qr_Ãw
(
rd–m
, 
rd_lšk
);

1355 
	`as£¹
(
	`qr_Ãxt
(
rd–m
, 
rd_lšk
) ==„delm);

1356 
	`as£¹
(
	`qr_´ev
(
rd–m
, 
rd_lšk
) ==„delm);

1358 
	`qr_m–d
(
purge_runs_£Áš–
, 
rd–m
, 
rd_lšk
);

1361 
n¡ashed
 +ğ
Åages
;

1362 ià(!
®l
 && 
n¡ashed
 >ğ
Åurge
)

1366  (
n¡ashed
);

1367 
	}
}

1369 
size_t


1370 
	$¬’a_purge_¡ashed
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

1371 
¬’a_runs_dœty_lšk_t
 *
purge_runs_£Áš–
,

1372 
ex‹Á_node_t
 *
purge_chunks_£Áš–
)

1374 
size_t
 
Åurged
, 
nmadvi£
;

1375 
¬’a_runs_dœty_lšk_t
 *
rd–m
;

1376 
ex‹Á_node_t
 *
chunk£lm
;

1378 ià(
cÚfig_¡©s
)

1379 
nmadvi£
 = 0;

1380 
Åurged
 = 0;

1382 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

1383 
rd–m
 = 
	`qr_Ãxt
(
purge_runs_£Áš–
, 
rd_lšk
),

1384 
chunk£lm
 = 
	`qr_Ãxt
(
purge_chunks_£Áš–
, 
cc_lšk
);

1385 
rd–m
 !ğ
purge_runs_£Áš–
;„d–m = 
	`qr_Ãxt
Ôd–m, 
rd_lšk
)) {

1386 
size_t
 
Åages
;

1388 ià(
rd–m
 =ğ&
chunk£lm
->
rd
) {

1397 
size_t
 
size
 = 
	`ex‹Á_node_size_g‘
(
chunk£lm
);

1398 
Åages
 = 
size
 >> 
LG_PAGE
;

1399 
chunk£lm
 = 
	`qr_Ãxt
(chunk£lm, 
cc_lšk
);

1401 
size_t
 
·gešd
, 
run_size
, 
æag_unz”Ûd
, 
æags
, 
i
;

1402 
boŞ
 
decomm™‹d
;

1403 
¬’a_chunk_t
 *
chunk
 =

1404 (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
rd–m
);

1405 
¬’a_chunk_m­_misc_t
 *
misûlm
 =

1406 
	`¬’a_rd_to_misûlm
(
rd–m
);

1407 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1408 
run_size
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
);

1409 
Åages
 = 
run_size
 >> 
LG_PAGE
;

1411 
	`as£¹
(
·gešd
 + 
Åages
 <ğ
chunk_Åages
);

1412 
	`as£¹
(!
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
·gešd
));

1413 
	`as£¹
(!
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
,

1414 
·gešd
+
Åages
-1));

1415 
decomm™‹d
 = !
chunk_hooks
->
	`decomm™
(
chunk
, 
chunksize
,

1416 
·gešd
 << 
LG_PAGE
, 
Åages
 << LG_PAGE, 
¬’a
->
šd
);

1417 ià(
decomm™‹d
) {

1418 
æag_unz”Ûd
 = 0;

1419 
æags
 = 
CHUNK_MAP_DECOMMITTED
;

1421 
æag_unz”Ûd
 = 
	`chunk_purge_w¿µ”
(
¬’a
,

1422 
chunk_hooks
, 
chunk
, 
chunksize
, 
·gešd
 <<

1423 
LG_PAGE
, 
run_size
è? 
CHUNK_MAP_UNZEROED
 : 0;

1424 
æags
 = 
æag_unz”Ûd
;

1426 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
Åages
-1, 0,

1427 
æags
);

1428 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
, 
run_size
,

1429 
æags
);

1442 
i
 = 1; i < 
Åages
-1; i++) {

1443 
	`¬’a_m­b™s_š‹º®_£t
(
chunk
, 
·gešd
+
i
,

1444 
æag_unz”Ûd
);

1448 
Åurged
 +ğ
Åages
;

1449 ià(
cÚfig_¡©s
)

1450 
nmadvi£
++;

1452 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

1454 ià(
cÚfig_¡©s
) {

1455 
¬’a
->
¡©s
.
nmadvi£
 +=‚madvise;

1456 
¬’a
->
¡©s
.
purged
 +ğ
Åurged
;

1459  (
Åurged
);

1460 
	}
}

1463 
	$¬’a_un¡ash_purged
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

1464 
¬’a_runs_dœty_lšk_t
 *
purge_runs_£Áš–
,

1465 
ex‹Á_node_t
 *
purge_chunks_£Áš–
)

1467 
¬’a_runs_dœty_lšk_t
 *
rd–m
, *
rd–m_Ãxt
;

1468 
ex‹Á_node_t
 *
chunk£lm
;

1471 
rd–m
 = 
	`qr_Ãxt
(
purge_runs_£Áš–
, 
rd_lšk
),

1472 
chunk£lm
 = 
	`qr_Ãxt
(
purge_chunks_£Áš–
, 
cc_lšk
);

1473 
rd–m
 !ğ
purge_runs_£Áš–
;„d–m = 
rd–m_Ãxt
) {

1474 
rd–m_Ãxt
 = 
	`qr_Ãxt
(
rd–m
, 
rd_lšk
);

1475 ià(
rd–m
 =ğ&
chunk£lm
->
rd
) {

1476 
ex‹Á_node_t
 *
chunk£lm_Ãxt
 = 
	`qr_Ãxt
(
chunk£lm
,

1477 
cc_lšk
);

1478 *
addr
 = 
	`ex‹Á_node_addr_g‘
(
chunk£lm
);

1479 
size_t
 
size
 = 
	`ex‹Á_node_size_g‘
(
chunk£lm
);

1480 
boŞ
 
z”Ûd
 = 
	`ex‹Á_node_z”Ûd_g‘
(
chunk£lm
);

1481 
boŞ
 
comm™‹d
 = 
	`ex‹Á_node_comm™‹d_g‘
(
chunk£lm
);

1482 
	`ex‹Á_node_dœty_»move
(
chunk£lm
);

1483 
	`¬’a_node_d®loc
(
¬’a
, 
chunk£lm
);

1484 
chunk£lm
 = 
chunk£lm_Ãxt
;

1485 
	`chunk_d®loc_¬’a
(
¬’a
, 
chunk_hooks
, 
addr
, 
size
,

1486 
z”Ûd
, 
comm™‹d
);

1488 
¬’a_chunk_t
 *
chunk
 =

1489 (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
rd–m
);

1490 
¬’a_chunk_m­_misc_t
 *
misûlm
 =

1491 
	`¬’a_rd_to_misûlm
(
rd–m
);

1492 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1493 
boŞ
 
decomm™‹d
 = (
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
,

1494 
·gešd
) != 0);

1495 
¬’a_run_t
 *
run
 = &
misûlm
->run;

1496 
	`qr_»move
(
rd–m
, 
rd_lšk
);

1497 
	`¬’a_run_d®loc
(
¬’a
, 
run
, 
çl£
, 
Œue
, 
decomm™‹d
);

1500 
	}
}

1503 
	$¬’a_purge
(
¬’a_t
 *
¬’a
, 
boŞ
 
®l
)

1505 
chunk_hooks_t
 
chunk_hooks
 = 
	`chunk_hooks_g‘
(
¬’a
);

1506 
size_t
 
Åurge
, 
Åurg—bË
, 
Åurged
;

1507 
¬’a_runs_dœty_lšk_t
 
purge_runs_£Áš–
;

1508 
ex‹Á_node_t
 
purge_chunks_£Áš–
;

1510 
¬’a
->
purgšg
 = 
Œue
;

1516 ià(
çl£
 && 
cÚfig_debug
) {

1517 
size_t
 
ndœty
 = 
	`¬’a_dœty_couÁ
(
¬’a
);

1518 
	`as£¹
(
ndœty
 =ğ
¬’a
->ndirty);

1520 
	`as£¹
((
¬’a
->
Çùive
 >>‡»Ç->
lg_dœty_muÉ
è<‡»Ç->
ndœty
 || 
®l
);

1522 ià(
cÚfig_¡©s
)

1523 
¬’a
->
¡©s
.
Åurge
++;

1525 
Åurge
 = 
	`¬’a_compu‹_Åurge
(
¬’a
, 
®l
);

1526 
	`qr_Ãw
(&
purge_runs_£Áš–
, 
rd_lšk
);

1527 
	`ex‹Á_node_dœty_lškage_š™
(&
purge_chunks_£Áš–
);

1529 
Åurg—bË
 = 
	`¬’a_¡ash_dœty
(
¬’a
, &
chunk_hooks
, 
®l
, 
Åurge
,

1530 &
purge_runs_£Áš–
, &
purge_chunks_£Áš–
);

1531 
	`as£¹
(
Åurg—bË
 >ğ
Åurge
);

1532 
Åurged
 = 
	`¬’a_purge_¡ashed
(
¬’a
, &
chunk_hooks
, &
purge_runs_£Áš–
,

1533 &
purge_chunks_£Áš–
);

1534 
	`as£¹
(
Åurged
 =ğ
Åurg—bË
);

1535 
	`¬’a_un¡ash_purged
(
¬’a
, &
chunk_hooks
, &
purge_runs_£Áš–
,

1536 &
purge_chunks_£Áš–
);

1538 
¬’a
->
purgšg
 = 
çl£
;

1539 
	}
}

1542 
	$¬’a_purge_®l
(
¬’a_t
 *
¬’a
)

1545 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

1546 
	`¬’a_purge
(
¬’a
, 
Œue
);

1547 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

1548 
	}
}

1551 
	$¬’a_run_cßËsû
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
size_t
 *
p_size
,

1552 
size_t
 *
p_run_šd
, size_ˆ*
p_run_·ges
, size_ˆ
æag_dœty
,

1553 
size_t
 
æag_decomm™‹d
)

1555 
size_t
 
size
 = *
p_size
;

1556 
size_t
 
run_šd
 = *
p_run_šd
;

1557 
size_t
 
run_·ges
 = *
p_run_·ges
;

1560 ià(
run_šd
 + 
run_·ges
 < 
chunk_Åages
 &&

1561 
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
, 
run_šd
+
run_·ges
) == 0 &&

1562 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
+
run_·ges
è=ğ
æag_dœty
 &&

1563 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
+
run_·ges
) ==

1564 
æag_decomm™‹d
) {

1565 
size_t
 
Äun_size
 = 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
,

1566 
run_šd
+
run_·ges
);

1567 
size_t
 
Äun_·ges
 = 
Äun_size
 >> 
LG_PAGE
;

1573 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
,

1574 
run_šd
+
run_·ges
+
Äun_·ges
-1è=ğ
Äun_size
);

1575 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
,

1576 
run_šd
+
run_·ges
+
Äun_·ges
-1è=ğ
æag_dœty
);

1577 
	`as£¹
(
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
,

1578 
run_šd
+
run_·ges
+
Äun_·ges
-1è=ğ
æag_decomm™‹d
);

1579 
	`¬’a_ava_»move
(
¬’a
, 
chunk
, 
run_šd
+
run_·ges
, 
Äun_·ges
);

1585 ià(
æag_dœty
 != 0) {

1586 
	`¬’a_run_dœty_»move
(
¬’a
, 
chunk
, 
run_šd
+
run_·ges
,

1587 
Äun_·ges
);

1590 
size
 +ğ
Äun_size
;

1591 
run_·ges
 +ğ
Äun_·ges
;

1593 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
chunk
, 
run_šd
, 
size
);

1594 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
chunk
, 
run_šd
+
run_·ges
-1,

1595 
size
);

1599 ià(
run_šd
 > 
m­_bŸs
 && 
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
,

1600 
run_šd
-1è=ğ0 && 
	`¬’a_m­b™s_dœty_g‘
(
chunk
,„un_ind-1) ==

1601 
æag_dœty
 && 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
-1) ==

1602 
æag_decomm™‹d
) {

1603 
size_t
 
´un_size
 = 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
,

1604 
run_šd
-1);

1605 
size_t
 
´un_·ges
 = 
´un_size
 >> 
LG_PAGE
;

1607 
run_šd
 -ğ
´un_·ges
;

1613 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
run_šd
) ==

1614 
´un_size
);

1615 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
è=ğ
æag_dœty
);

1616 
	`as£¹
(
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
) ==

1617 
æag_decomm™‹d
);

1618 
	`¬’a_ava_»move
(
¬’a
, 
chunk
, 
run_šd
, 
´un_·ges
);

1624 ià(
æag_dœty
 != 0) {

1625 
	`¬’a_run_dœty_»move
(
¬’a
, 
chunk
, 
run_šd
,

1626 
´un_·ges
);

1629 
size
 +ğ
´un_size
;

1630 
run_·ges
 +ğ
´un_·ges
;

1632 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
chunk
, 
run_šd
, 
size
);

1633 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_£t
(
chunk
, 
run_šd
+
run_·ges
-1,

1634 
size
);

1637 *
p_size
 = 
size
;

1638 *
p_run_šd
 = 
run_šd
;

1639 *
p_run_·ges
 = 
run_·ges
;

1640 
	}
}

1642 
size_t


1643 
	$¬’a_run_size_g‘
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
¬’a_run_t
 *
run
,

1644 
size_t
 
run_šd
)

1646 
size_t
 
size
;

1648 
	`as£¹
(
run_šd
 >ğ
m­_bŸs
);

1649 
	`as£¹
(
run_šd
 < 
chunk_Åages
);

1651 ià(
	`¬’a_m­b™s_Ïrge_g‘
(
chunk
, 
run_šd
) != 0) {

1652 
size
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
run_šd
);

1653 
	`as£¹
(
size
 =ğ
PAGE
 || 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
,

1654 
run_šd
+(
size
>>
LG_PAGE
)-1) == 0);

1656 
¬’a_bš_šfo_t
 *
bš_šfo
 = &
¬’a_bš_šfo
[
run
->
bššd
];

1657 
size
 = 
bš_šfo
->
run_size
;

1660  (
size
);

1661 
	}
}

1663 
boŞ


1664 
	$¬’a_run_decomm™
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
¬’a_run_t
 *
run
)

1666 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

1667 
size_t
 
run_šd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1668 
size_t
 
off£t
 = 
run_šd
 << 
LG_PAGE
;

1669 
size_t
 
Ëngth
 = 
	`¬’a_run_size_g‘
(
¬’a
, 
chunk
, 
run
, 
run_šd
);

1671  (
¬’a
->
chunk_hooks
.
	`decomm™
(
chunk
, 
chunksize
, 
off£t
, 
Ëngth
,

1672 
¬’a
->
šd
));

1673 
	}
}

1676 
	$¬’a_run_d®loc
(
¬’a_t
 *
¬’a
, 
¬’a_run_t
 *
run
, 
boŞ
 
dœty
, boŞ 
ş—Ãd
,

1677 
boŞ
 
decomm™‹d
)

1679 
¬’a_chunk_t
 *
chunk
;

1680 
¬’a_chunk_m­_misc_t
 *
misûlm
;

1681 
size_t
 
size
, 
run_šd
, 
run_·ges
, 
æag_dœty
, 
æag_decomm™‹d
;

1683 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
run
);

1684 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

1685 
run_šd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1686 
	`as£¹
(
run_šd
 >ğ
m­_bŸs
);

1687 
	`as£¹
(
run_šd
 < 
chunk_Åages
);

1688 
size
 = 
	`¬’a_run_size_g‘
(
¬’a
, 
chunk
, 
run
, 
run_šd
);

1689 
run_·ges
 = (
size
 >> 
LG_PAGE
);

1690 
	`¬’a_ÿùive_upd©e
(
¬’a
, 0, 
run_·ges
);

1691 
¬’a
->
Çùive
 -ğ
run_·ges
;

1698 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
) ==

1699 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
+
run_·ges
-1));

1700 ià(!
ş—Ãd
 && !
decomm™‹d
 && 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
)

1702 
dœty
 = 
Œue
;

1703 
æag_dœty
 = 
dœty
 ? 
CHUNK_MAP_DIRTY
 : 0;

1704 
æag_decomm™‹d
 = 
decomm™‹d
 ? 
CHUNK_MAP_DECOMMITTED
 : 0;

1707 ià(
dœty
 || 
decomm™‹d
) {

1708 
size_t
 
æags
 = 
æag_dœty
 | 
æag_decomm™‹d
;

1709 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
, 
size
, 
æags
);

1710 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
+
run_·ges
-1, 
size
,

1711 
æags
);

1713 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
, 
size
,

1714 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
));

1715 
	`¬’a_m­b™s_uÇÎoÿ‹d_£t
(
chunk
, 
run_šd
+
run_·ges
-1, 
size
,

1716 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
run_šd
+
run_·ges
-1));

1719 
	`¬’a_run_cßËsû
(
¬’a
, 
chunk
, &
size
, &
run_šd
, &
run_·ges
,

1720 
æag_dœty
, 
æag_decomm™‹d
);

1723 
	`as£¹
(
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
run_šd
) ==

1724 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
run_šd
+
run_·ges
-1));

1725 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
) ==

1726 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
+
run_·ges
-1));

1727 
	`as£¹
(
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
) ==

1728 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
run_šd
+
run_·ges
-1));

1729 
	`¬’a_ava_š£¹
(
¬’a
, 
chunk
, 
run_šd
, 
run_·ges
);

1731 ià(
dœty
)

1732 
	`¬’a_run_dœty_š£¹
(
¬’a
, 
chunk
, 
run_šd
, 
run_·ges
);

1735 ià(
size
 =ğ
¬’a_maxrun
) {

1736 
	`as£¹
(
run_šd
 =ğ
m­_bŸs
);

1737 
	`as£¹
(
run_·ges
 =ğ(
¬’a_maxrun
 >> 
LG_PAGE
));

1738 
	`¬’a_chunk_d®loc
(
¬’a
, 
chunk
);

1748 ià(
dœty
)

1749 
	`¬’a_maybe_purge
(
¬’a
);

1750 
	}
}

1753 
	$¬’a_run_d®loc_decomm™
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

1754 
¬’a_run_t
 *
run
)

1756 
boŞ
 
comm™‹d
 = 
	`¬’a_run_decomm™
(
¬’a
, 
chunk
, 
run
);

1758 
	`¬’a_run_d®loc
(
¬’a
, 
run
, 
comm™‹d
, 
çl£
, !committed);

1759 
	}
}

1762 
	$¬’a_run_Œim_h—d
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
¬’a_run_t
 *
run
,

1763 
size_t
 
Şdsize
, size_ˆ
Ãwsize
)

1765 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

1766 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1767 
size_t
 
h—d_Åages
 = (
Şdsize
 - 
Ãwsize
è>> 
LG_PAGE
;

1768 
size_t
 
æag_dœty
 = 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
);

1769 
size_t
 
æag_decomm™‹d
 = 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
·gešd
);

1770 
size_t
 
æag_unz”Ûd_mask
 = (
æag_dœty
 | 
æag_decomm™‹d
) == 0 ?

1771 
CHUNK_MAP_UNZEROED
 : 0;

1773 
	`as£¹
(
Şdsize
 > 
Ãwsize
);

1780 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
è=ğ
Şdsize
);

1781 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
h—d_Åages
-1, 0, 
æag_dœty
 |

1782 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

1783 
·gešd
+
h—d_Åages
-1)));

1784 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
, 
Şdsize
-
Ãwsize
, 
æag_dœty
 |

1785 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
·gešd
)));

1787 ià(
cÚfig_debug
) {

1788 
UNUSED
 
size_t
 
_Åages
 = 
Ãwsize
 >> 
LG_PAGE
;

1789 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
,

1790 
·gešd
+
h—d_Åages
+
_Åages
-1) == 0);

1791 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
,

1792 
·gešd
+
h—d_Åages
+
_Åages
-1è=ğ
æag_dœty
);

1794 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
h—d_Åages
, 
Ãwsize
,

1795 
æag_dœty
 | (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

1796 
·gešd
+
h—d_Åages
)));

1798 
	`¬’a_run_d®loc
(
¬’a
, 
run
, 
çl£
, f®£, (
æag_decomm™‹d
 != 0));

1799 
	}
}

1802 
	$¬’a_run_Œim_
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
¬’a_run_t
 *
run
,

1803 
size_t
 
Şdsize
, size_ˆ
Ãwsize
, 
boŞ
 
dœty
)

1805 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

1806 
size_t
 
·gešd
 = 
	`¬’a_misûlm_to_·gešd
(
misûlm
);

1807 
size_t
 
h—d_Åages
 = 
Ãwsize
 >> 
LG_PAGE
;

1808 
size_t
 
æag_dœty
 = 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
);

1809 
size_t
 
æag_decomm™‹d
 = 
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
, 
·gešd
);

1810 
size_t
 
æag_unz”Ûd_mask
 = (
æag_dœty
 | 
æag_decomm™‹d
) == 0 ?

1811 
CHUNK_MAP_UNZEROED
 : 0;

1812 
¬’a_chunk_m­_misc_t
 *
_misûlm
;

1813 
¬’a_run_t
 *
_run
;

1815 
	`as£¹
(
Şdsize
 > 
Ãwsize
);

1822 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
è=ğ
Şdsize
);

1823 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
h—d_Åages
-1, 0, 
æag_dœty
 |

1824 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

1825 
·gešd
+
h—d_Åages
-1)));

1826 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
, 
Ãwsize
, 
æag_dœty
 |

1827 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
·gešd
)));

1829 ià(
cÚfig_debug
) {

1830 
UNUSED
 
size_t
 
_Åages
 = (
Şdsize
 - 
Ãwsize
è>> 
LG_PAGE
;

1831 
	`as£¹
(
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
,

1832 
·gešd
+
h—d_Åages
+
_Åages
-1) == 0);

1833 
	`as£¹
(
	`¬’a_m­b™s_dœty_g‘
(
chunk
,

1834 
·gešd
+
h—d_Åages
+
_Åages
-1è=ğ
æag_dœty
);

1836 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
h—d_Åages
, 
Şdsize
-
Ãwsize
,

1837 
æag_dœty
 | (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

1838 
·gešd
+
h—d_Åages
)));

1840 
_misûlm
 = 
	`¬’a_misûlm_g‘
(
chunk
, 
·gešd
 + 
h—d_Åages
);

1841 
_run
 = &
_misûlm
->
run
;

1842 
	`¬’a_run_d®loc
(
¬’a
, 
_run
, 
dœty
, 
çl£
, (
æag_decomm™‹d
 !=

1844 
	}
}

1846 
¬’a_run_t
 *

1847 
	$¬’a_bš_runs_fœ¡
(
¬’a_bš_t
 *
bš
)

1849 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_Œ“_fœ¡
(&
bš
->
runs
);

1850 ià(
misûlm
 !ğ
NULL
)

1851  (&
misûlm
->
run
);

1853  (
NULL
);

1854 
	}
}

1857 
	$¬’a_bš_runs_š£¹
(
¬’a_bš_t
 *
bš
, 
¬’a_run_t
 *
run
)

1859 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

1861 
	`as£¹
(
	`¬’a_run_Œ“_£¬ch
(&
bš
->
runs
, 
misûlm
è=ğ
NULL
);

1863 
	`¬’a_run_Œ“_š£¹
(&
bš
->
runs
, 
misûlm
);

1864 
	}
}

1867 
	$¬’a_bš_runs_»move
(
¬’a_bš_t
 *
bš
, 
¬’a_run_t
 *
run
)

1869 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

1871 
	`as£¹
(
	`¬’a_run_Œ“_£¬ch
(&
bš
->
runs
, 
misûlm
è!ğ
NULL
);

1873 
	`¬’a_run_Œ“_»move
(&
bš
->
runs
, 
misûlm
);

1874 
	}
}

1876 
¬’a_run_t
 *

1877 
	$¬’a_bš_nÚfuÎ_run_Œyg‘
(
¬’a_bš_t
 *
bš
)

1879 
¬’a_run_t
 *
run
 = 
	`¬’a_bš_runs_fœ¡
(
bš
);

1880 ià(
run
 !ğ
NULL
) {

1881 
	`¬’a_bš_runs_»move
(
bš
, 
run
);

1882 ià(
cÚfig_¡©s
)

1883 
bš
->
¡©s
.
»runs
++;

1885  (
run
);

1886 
	}
}

1888 
¬’a_run_t
 *

1889 
	$¬’a_bš_nÚfuÎ_run_g‘
(
¬’a_t
 *
¬’a
, 
¬’a_bš_t
 *
bš
)

1891 
¬’a_run_t
 *
run
;

1892 
szšd_t
 
bššd
;

1893 
¬’a_bš_šfo_t
 *
bš_šfo
;

1896 
run
 = 
	`¬’a_bš_nÚfuÎ_run_Œyg‘
(
bš
);

1897 ià(
run
 !ğ
NULL
)

1898  (
run
);

1901 
bššd
 = 
	`¬’a_bš_šdex
(
¬’a
, 
bš
);

1902 
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

1905 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

1907 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

1908 
run
 = 
	`¬’a_run_®loc_sm®l
(
¬’a
, 
bš_šfo
->
run_size
, 
bššd
);

1909 ià(
run
 !ğ
NULL
) {

1911 
run
->
bššd
 = binind;

1912 
run
->
nä“
 = 
bš_šfo
->
Äegs
;

1913 
	`b™m­_š™
(
run
->
b™m­
, &
bš_šfo
->
b™m­_šfo
);

1915 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

1917 
	`m®loc_mu‹x_lock
(&
bš
->
lock
);

1918 ià(
run
 !ğ
NULL
) {

1919 ià(
cÚfig_¡©s
) {

1920 
bš
->
¡©s
.
Äuns
++;

1921 
bš
->
¡©s
.
cu¼uns
++;

1923  (
run
);

1931 
run
 = 
	`¬’a_bš_nÚfuÎ_run_Œyg‘
(
bš
);

1932 ià(
run
 !ğ
NULL
)

1933  (
run
);

1935  (
NULL
);

1936 
	}
}

1940 
	$¬’a_bš_m®loc_h¬d
(
¬’a_t
 *
¬’a
, 
¬’a_bš_t
 *
bš
)

1942 
szšd_t
 
bššd
;

1943 
¬’a_bš_šfo_t
 *
bš_šfo
;

1944 
¬’a_run_t
 *
run
;

1946 
bššd
 = 
	`¬’a_bš_šdex
(
¬’a
, 
bš
);

1947 
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

1948 
bš
->
runcur
 = 
NULL
;

1949 
run
 = 
	`¬’a_bš_nÚfuÎ_run_g‘
(
¬’a
, 
bš
);

1950 ià(
bš
->
runcur
 !ğ
NULL
 && bš->runcur->
nä“
 > 0) {

1955 *
»t
;

1956 
	`as£¹
(
bš
->
runcur
->
nä“
 > 0);

1957 
»t
 = 
	`¬’a_run_»g_®loc
(
bš
->
runcur
, 
bš_šfo
);

1958 ià(
run
 !ğ
NULL
) {

1959 
¬’a_chunk_t
 *
chunk
;

1969 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
run
);

1970 ià(
run
->
nä“
 =ğ
bš_šfo
->
Äegs
)

1971 
	`¬’a_d®loc_bš_run
(
¬’a
, 
chunk
, 
run
, 
bš
);

1973 
	`¬’a_bš_low”_run
(
¬’a
, 
chunk
, 
run
, 
bš
);

1975  (
»t
);

1978 ià(
run
 =ğ
NULL
)

1979  (
NULL
);

1981 
bš
->
runcur
 = 
run
;

1983 
	`as£¹
(
bš
->
runcur
->
nä“
 > 0);

1985  (
	`¬’a_run_»g_®loc
(
bš
->
runcur
, 
bš_šfo
));

1986 
	}
}

1989 
	$¬’a_tÿche_fl_sm®l
(
¬’a_t
 *
¬’a
, 
tÿche_bš_t
 *
tbš
, 
szšd_t
 
bššd
,

1990 
ušt64_t
 
´of_accumby‹s
)

1992 
i
, 
nfl
;

1993 
¬’a_bš_t
 *
bš
;

1995 
	`as£¹
(
tbš
->
nÿched
 == 0);

1997 ià(
cÚfig_´of
 && 
	`¬’a_´of_accum
(
¬’a
, 
´of_accumby‹s
))

1998 
	`´of_idump
();

1999 
bš
 = &
¬’a
->
bšs
[
bššd
];

2000 
	`m®loc_mu‹x_lock
(&
bš
->
lock
);

2001 
i
 = 0, 
nfl
 = (
tÿche_bš_šfo
[
bššd
].
nÿched_max
 >>

2002 
tbš
->
lg_fl_div
); 
i
 < 
nfl
; i++) {

2003 
¬’a_run_t
 *
run
;

2004 *
±r
;

2005 ià((
run
 = 
bš
->
runcur
è!ğ
NULL
 &&„un->
nä“
 > 0)

2006 
±r
 = 
	`¬’a_run_»g_®loc
(
run
, &
¬’a_bš_šfo
[
bššd
]);

2008 
±r
 = 
	`¬’a_bš_m®loc_h¬d
(
¬’a
, 
bš
);

2009 ià(
±r
 =ğ
NULL
) {

2016 ià(
i
 > 0) {

2017 
	`memmove
(
tbš
->
ava
, &tbš->ava[
nfl
 - 
i
],

2018 
i
 * (*));

2022 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
)) {

2023 
	`¬’a_®loc_junk_sm®l
(
±r
, &
¬’a_bš_šfo
[
bššd
],

2024 
Œue
);

2027 
tbš
->
ava
[
nfl
 - 1 - 
i
] = 
±r
;

2029 ià(
cÚfig_¡©s
) {

2030 
bš
->
¡©s
.
nm®loc
 +ğ
i
;

2031 
bš
->
¡©s
.
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

2032 
bš
->
¡©s
.
cu¼egs
 +ğ
i
;

2033 
bš
->
¡©s
.
nfls
++;

2034 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

2036 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

2037 
tbš
->
nÿched
 = 
i
;

2038 
	}
}

2041 
	$¬’a_®loc_junk_sm®l
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
, 
boŞ
 
z”o
)

2044 ià(
z”o
) {

2045 
size_t
 
»dzÚe_size
 = 
bš_šfo
->redzone_size;

2046 
	`mem£t
((*)((
ušŒ_t
)
±r
 - 
»dzÚe_size
), 0xa5,

2047 
»dzÚe_size
);

2048 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
bš_šfo
->
»g_size
), 0xa5,

2049 
»dzÚe_size
);

2051 
	`mem£t
((*)((
ušŒ_t
)
±r
 - 
bš_šfo
->
»dzÚe_size
), 0xa5,

2052 
bš_šfo
->
»g_š‹rv®
);

2054 
	}
}

2056 #ifdeà
JEMALLOC_JET


2057 #undeà
¬’a_»dzÚe_cÜru±iÚ


2058 
	#¬’a_»dzÚe_cÜru±iÚ
 
	`JEMALLOC_N
(
¬’a_»dzÚe_cÜru±iÚ_im¶
)

	)

2061 
	$¬’a_»dzÚe_cÜru±iÚ
(*
±r
, 
size_t
 
usize
, 
boŞ
 
aá”
,

2062 
size_t
 
off£t
, 
ušt8_t
 
by‹
)

2065 
	`m®loc_´štf
("<jemalloc>: Corrupt„edzone %zu byte%s %s %p "

2066 "(siz%zu), by‹=%#x\n", 
off£t
, (offset == 1) ? "" : "s",

2067 
aá”
 ? "aá”" : "befÜe", 
±r
, 
usize
, 
by‹
);

2068 
	}
}

2069 #ifdeà
JEMALLOC_JET


2070 #undeà
¬’a_»dzÚe_cÜru±iÚ


2071 
	#¬’a_»dzÚe_cÜru±iÚ
 
	`JEMALLOC_N
(
¬’a_»dzÚe_cÜru±iÚ
)

	)

2072 
¬’a_»dzÚe_cÜru±iÚ_t
 *
	g¬’a_»dzÚe_cÜru±iÚ
 =

2073 
JEMALLOC_N
(
¬’a_»dzÚe_cÜru±iÚ_im¶
);

2077 
	$¬’a_»dzÚes_v®id©e
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
, 
boŞ
 
»£t
)

2079 
boŞ
 
”rÜ
 = 
çl£
;

2081 ià(
İt_junk_®loc
) {

2082 
size_t
 
size
 = 
bš_šfo
->
»g_size
;

2083 
size_t
 
»dzÚe_size
 = 
bš_šfo
->redzone_size;

2084 
size_t
 
i
;

2086 
i
 = 1; i <ğ
»dzÚe_size
; i++) {

2087 
ušt8_t
 *
by‹
 = (ušt8_ˆ*)((
ušŒ_t
)
±r
 - 
i
);

2088 ià(*
by‹
 != 0xa5) {

2089 
”rÜ
 = 
Œue
;

2090 
	`¬’a_»dzÚe_cÜru±iÚ
(
±r
, 
size
, 
çl£
, 
i
,

2091 *
by‹
);

2092 ià(
»£t
)

2093 *
by‹
 = 0xa5;

2096 
i
 = 0; i < 
»dzÚe_size
; i++) {

2097 
ušt8_t
 *
by‹
 = (ušt8_ˆ*)((
ušŒ_t
)
±r
 + 
size
 + 
i
);

2098 ià(*
by‹
 != 0xa5) {

2099 
”rÜ
 = 
Œue
;

2100 
	`¬’a_»dzÚe_cÜru±iÚ
(
±r
, 
size
, 
Œue
, 
i
,

2101 *
by‹
);

2102 ià(
»£t
)

2103 *
by‹
 = 0xa5;

2108 ià(
İt_abÜt
 && 
”rÜ
)

2109 
	`abÜt
();

2110 
	}
}

2112 #ifdeà
JEMALLOC_JET


2113 #undeà
¬’a_d®loc_junk_sm®l


2114 
	#¬’a_d®loc_junk_sm®l
 
	`JEMALLOC_N
(
¬’a_d®loc_junk_sm®l_im¶
)

	)

2117 
	$¬’a_d®loc_junk_sm®l
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
)

2119 
size_t
 
»dzÚe_size
 = 
bš_šfo
->redzone_size;

2121 
	`¬’a_»dzÚes_v®id©e
(
±r
, 
bš_šfo
, 
çl£
);

2122 
	`mem£t
((*)((
ušŒ_t
)
±r
 - 
»dzÚe_size
), 0x5a,

2123 
bš_šfo
->
»g_š‹rv®
);

2124 
	}
}

2125 #ifdeà
JEMALLOC_JET


2126 #undeà
¬’a_d®loc_junk_sm®l


2127 
	#¬’a_d®loc_junk_sm®l
 
	`JEMALLOC_N
(
¬’a_d®loc_junk_sm®l
)

	)

2128 
¬’a_d®loc_junk_sm®l_t
 *
	g¬’a_d®loc_junk_sm®l
 =

2129 
JEMALLOC_N
(
¬’a_d®loc_junk_sm®l_im¶
);

2133 
	$¬’a_qu¬ªtše_junk_sm®l
(*
±r
, 
size_t
 
usize
)

2135 
szšd_t
 
bššd
;

2136 
¬’a_bš_šfo_t
 *
bš_šfo
;

2137 
	`ÿs£¹
(
cÚfig_fl
);

2138 
	`as£¹
(
İt_junk_ä“
);

2139 
	`as£¹
(
İt_qu¬ªtše
);

2140 
	`as£¹
(
usize
 <ğ
SMALL_MAXCLASS
);

2142 
bššd
 = 
	`size2šdex
(
usize
);

2143 
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

2144 
	`¬’a_»dzÚes_v®id©e
(
±r
, 
bš_šfo
, 
Œue
);

2145 
	}
}

2148 
	$¬’a_m®loc_sm®l
(
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
)

2150 *
»t
;

2151 
¬’a_bš_t
 *
bš
;

2152 
¬’a_run_t
 *
run
;

2153 
szšd_t
 
bššd
;

2155 
bššd
 = 
	`size2šdex
(
size
);

2156 
	`as£¹
(
bššd
 < 
NBINS
);

2157 
bš
 = &
¬’a
->
bšs
[
bššd
];

2158 
size
 = 
	`šdex2size
(
bššd
);

2160 
	`m®loc_mu‹x_lock
(&
bš
->
lock
);

2161 ià((
run
 = 
bš
->
runcur
è!ğ
NULL
 &&„un->
nä“
 > 0)

2162 
»t
 = 
	`¬’a_run_»g_®loc
(
run
, &
¬’a_bš_šfo
[
bššd
]);

2164 
»t
 = 
	`¬’a_bš_m®loc_h¬d
(
¬’a
, 
bš
);

2166 ià(
»t
 =ğ
NULL
) {

2167 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

2168  (
NULL
);

2171 ià(
cÚfig_¡©s
) {

2172 
bš
->
¡©s
.
nm®loc
++;

2173 
bš
->
¡©s
.
Äeque¡s
++;

2174 
bš
->
¡©s
.
cu¼egs
++;

2176 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

2177 ià(
cÚfig_´of
 && !
i¡h»aded
 && 
	`¬’a_´of_accum
(
¬’a
, 
size
))

2178 
	`´of_idump
();

2180 ià(!
z”o
) {

2181 ià(
cÚfig_fl
) {

2182 ià(
	`uÆik–y
(
İt_junk_®loc
)) {

2183 
	`¬’a_®loc_junk_sm®l
(
»t
,

2184 &
¬’a_bš_šfo
[
bššd
], 
çl£
);

2185 } ià(
	`uÆik–y
(
İt_z”o
))

2186 
	`mem£t
(
»t
, 0, 
size
);

2188 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
size
);

2190 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
)) {

2191 
	`¬’a_®loc_junk_sm®l
(
»t
, &
¬’a_bš_šfo
[
bššd
],

2192 
Œue
);

2194 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
size
);

2195 
	`mem£t
(
»t
, 0, 
size
);

2198  (
»t
);

2199 
	}
}

2202 
	$¬’a_m®loc_Ïrge
(
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
)

2204 *
»t
;

2205 
size_t
 
usize
;

2206 
ušŒ_t
 
¿ndom_off£t
;

2207 
¬’a_run_t
 *
run
;

2208 
¬’a_chunk_m­_misc_t
 *
misûlm
;

2209 
UNUSED
 
boŞ
 
idump
;

2212 
usize
 = 
	`s2u
(
size
);

2213 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

2214 ià(
cÚfig_ÿche_oblivious
) {

2215 
ušt64_t
 
r
;

2222 
	`´ng64
(
r
, 
LG_PAGE
 - 
LG_CACHELINE
, 
¬’a
->
off£t_¡©e
,

2223 
	`UINT64_C
(6364136223846793009),

2224 
	`UINT64_C
(1442695040888963409));

2225 
¿ndom_off£t
 = ((
ušŒ_t
)
r
è<< 
LG_CACHELINE
;

2227 
¿ndom_off£t
 = 0;

2228 
run
 = 
	`¬’a_run_®loc_Ïrge
(
¬’a
, 
usize
 + 
Ïrge_·d
, 
z”o
);

2229 ià(
run
 =ğ
NULL
) {

2230 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2231  (
NULL
);

2233 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

2234 
»t
 = (*)((
ušŒ_t
)
	`¬’a_misûlm_to_½ages
(
misûlm
) +

2235 
¿ndom_off£t
);

2236 ià(
cÚfig_¡©s
) {

2237 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
NBINS
;

2239 
¬’a
->
¡©s
.
nm®loc_Ïrge
++;

2240 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
++;

2241 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 +ğ
usize
;

2242 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
nm®loc
++;

2243 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
Äeque¡s
++;

2244 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
cu¼uns
++;

2246 ià(
cÚfig_´of
)

2247 
idump
 = 
	`¬’a_´of_accum_locked
(
¬’a
, 
usize
);

2248 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2249 ià(
cÚfig_´of
 && 
idump
)

2250 
	`´of_idump
();

2252 ià(!
z”o
) {

2253 ià(
cÚfig_fl
) {

2254 ià(
	`uÆik–y
(
İt_junk_®loc
))

2255 
	`mem£t
(
»t
, 0xa5, 
usize
);

2256 ià(
	`uÆik–y
(
İt_z”o
))

2257 
	`mem£t
(
»t
, 0, 
usize
);

2261  (
»t
);

2262 
	}
}

2266 
	$¬’a_·Îoc_Ïrge
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
, size_ˆ
®ignm’t
,

2267 
boŞ
 
z”o
)

2269 *
»t
;

2270 
size_t
 
®loc_size
, 
Ëadsize
, 
Œasize
;

2271 
¬’a_run_t
 *
run
;

2272 
¬’a_chunk_t
 *
chunk
;

2273 
¬’a_chunk_m­_misc_t
 *
misûlm
;

2274 *
½ages
;

2276 
	`as£¹
(
usize
 =ğ
	`PAGE_CEILING
(usize));

2278 
¬’a
 = 
	`¬’a_choo£
(
tsd
,‡rena);

2279 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
))

2280  (
NULL
);

2282 
®ignm’t
 = 
	`PAGE_CEILING
(alignment);

2283 
®loc_size
 = 
usize
 + 
Ïrge_·d
 + 
®ignm’t
 - 
PAGE
;

2285 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

2286 
run
 = 
	`¬’a_run_®loc_Ïrge
(
¬’a
, 
®loc_size
, 
çl£
);

2287 ià(
run
 =ğ
NULL
) {

2288 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2289  (
NULL
);

2291 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
run
);

2292 
misûlm
 = 
	`¬’a_run_to_misûlm
(
run
);

2293 
½ages
 = 
	`¬’a_misûlm_to_½ages
(
misûlm
);

2295 
Ëadsize
 = 
	`ALIGNMENT_CEILING
((
ušŒ_t
)
½ages
, 
®ignm’t
) -

2296 (
ušŒ_t
)
½ages
;

2297 
	`as£¹
(
®loc_size
 >ğ
Ëadsize
 + 
usize
);

2298 
Œasize
 = 
®loc_size
 - 
Ëadsize
 - 
usize
 - 
Ïrge_·d
;

2299 ià(
Ëadsize
 != 0) {

2300 
¬’a_chunk_m­_misc_t
 *
h—d_misûlm
 = 
misûlm
;

2301 
¬’a_run_t
 *
h—d_run
 = 
run
;

2303 
misûlm
 = 
	`¬’a_misûlm_g‘
(
chunk
,

2304 
	`¬’a_misûlm_to_·gešd
(
h—d_misûlm
è+ (
Ëadsize
 >>

2305 
LG_PAGE
));

2306 
run
 = &
misûlm
->run;

2308 
	`¬’a_run_Œim_h—d
(
¬’a
, 
chunk
, 
h—d_run
, 
®loc_size
,

2309 
®loc_size
 - 
Ëadsize
);

2311 ià(
Œasize
 != 0) {

2312 
	`¬’a_run_Œim_
(
¬’a
, 
chunk
, 
run
, 
usize
 + 
Ïrge_·d
 +

2313 
Œasize
, 
usize
 + 
Ïrge_·d
, 
çl£
);

2315 ià(
	`¬’a_run_š™_Ïrge
(
¬’a
, 
run
, 
usize
 + 
Ïrge_·d
, 
z”o
)) {

2316 
size_t
 
run_šd
 =

2317 
	`¬’a_misûlm_to_·gešd
(
	`¬’a_run_to_misûlm
(
run
));

2318 
boŞ
 
dœty
 = (
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
run_šd
) != 0);

2319 
boŞ
 
decomm™‹d
 = (
	`¬’a_m­b™s_decomm™‹d_g‘
(
chunk
,

2320 
run_šd
) != 0);

2322 
	`as£¹
(
decomm™‹d
);

2323 
	`¬’a_run_d®loc
(
¬’a
, 
run
, 
dœty
, 
çl£
, 
decomm™‹d
);

2324 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2325  (
NULL
);

2327 
»t
 = 
	`¬’a_misûlm_to_½ages
(
misûlm
);

2329 ià(
cÚfig_¡©s
) {

2330 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
NBINS
;

2332 
¬’a
->
¡©s
.
nm®loc_Ïrge
++;

2333 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
++;

2334 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 +ğ
usize
;

2335 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
nm®loc
++;

2336 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
Äeque¡s
++;

2337 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
cu¼uns
++;

2339 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2341 ià(
cÚfig_fl
 && !
z”o
) {

2342 ià(
	`uÆik–y
(
İt_junk_®loc
))

2343 
	`mem£t
(
»t
, 0xa5, 
usize
);

2344 ià(
	`uÆik–y
(
İt_z”o
))

2345 
	`mem£t
(
»t
, 0, 
usize
);

2347  (
»t
);

2348 
	}
}

2351 
	$¬’a_·Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
, size_ˆ
®ignm’t
,

2352 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
)

2354 *
»t
;

2356 ià(
usize
 <ğ
SMALL_MAXCLASS
 && (
®ignm’t
 < 
PAGE
 || (alignment == PAGE

2357 && (
usize
 & 
PAGE_MASK
) == 0))) {

2359 
»t
 = 
	`¬’a_m®loc
(
tsd
, 
¬’a
, 
usize
, 
z”o
, 
tÿche
);

2360 } ià(
usize
 <ğ
Ïrge_maxşass
 && 
®ignm’t
 <ğ
PAGE
) {

2367 
»t
 = 
	`¬’a_m®loc
(
tsd
, 
¬’a
, 
usize
, 
z”o
, 
tÿche
);

2368 ià(
cÚfig_ÿche_oblivious
)

2369 
»t
 = (*)((
ušŒ_t
ì‘ & ~
PAGE_MASK
);

2371 ià(
	`lik–y
(
usize
 <ğ
Ïrge_maxşass
)) {

2372 
»t
 = 
	`¬’a_·Îoc_Ïrge
(
tsd
, 
¬’a
, 
usize
, 
®ignm’t
,

2373 
z”o
);

2374 } ià(
	`lik–y
(
®ignm’t
 <ğ
chunksize
))

2375 
»t
 = 
	`huge_m®loc
(
tsd
, 
¬’a
, 
usize
, 
z”o
, 
tÿche
);

2377 
»t
 = 
	`huge_·Îoc
(
tsd
, 
¬’a
, 
usize
, 
®ignm’t
, 
z”o
,

2378 
tÿche
);

2381  (
»t
);

2382 
	}
}

2385 
	$¬’a_´of_´omÙed
(cÚ¡ *
±r
, 
size_t
 
size
)

2387 
¬’a_chunk_t
 *
chunk
;

2388 
size_t
 
·gešd
;

2389 
szšd_t
 
bššd
;

2391 
	`ÿs£¹
(
cÚfig_´of
);

2392 
	`as£¹
(
±r
 !ğ
NULL
);

2393 
	`as£¹
(
	`CHUNK_ADDR2BASE
(
±r
) !=…tr);

2394 
	`as£¹
(
	`i§Îoc
(
±r
, 
çl£
è=ğ
LARGE_MINCLASS
);

2395 
	`as£¹
(
	`i§Îoc
(
±r
, 
Œue
è=ğ
LARGE_MINCLASS
);

2396 
	`as£¹
(
size
 <ğ
SMALL_MAXCLASS
);

2398 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

2399 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

2400 
bššd
 = 
	`size2šdex
(
size
);

2401 
	`as£¹
(
bššd
 < 
NBINS
);

2402 
	`¬’a_m­b™s_Ïrge_bššd_£t
(
chunk
, 
·gešd
, 
bššd
);

2404 
	`as£¹
(
	`i§Îoc
(
±r
, 
çl£
è=ğ
LARGE_MINCLASS
);

2405 
	`as£¹
(
	`i§Îoc
(
±r
, 
Œue
è=ğ
size
);

2406 
	}
}

2409 
	$¬’a_dissocŸ‹_bš_run
(
¬’a_chunk_t
 *
chunk
, 
¬’a_run_t
 *
run
,

2410 
¬’a_bš_t
 *
bš
)

2414 ià(
run
 =ğ
bš
->
runcur
)

2415 
bš
->
runcur
 = 
NULL
;

2417 
szšd_t
 
bššd
 = 
	`¬’a_bš_šdex
(
	`ex‹Á_node_¬’a_g‘
(

2418 &
chunk
->
node
), 
bš
);

2419 
¬’a_bš_šfo_t
 *
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

2421 ià(
bš_šfo
->
Äegs
 != 1) {

2427 
	`¬’a_bš_runs_»move
(
bš
, 
run
);

2430 
	}
}

2433 
	$¬’a_d®loc_bš_run
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
¬’a_run_t
 *
run
,

2434 
¬’a_bš_t
 *
bš
)

2437 
	`as£¹
(
run
 !ğ
bš
->
runcur
);

2438 
	`as£¹
(
	`¬’a_run_Œ“_£¬ch
(&
bš
->
runs
, 
	`¬’a_run_to_misûlm
(
run
)) ==

2439 
NULL
);

2441 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

2443 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

2444 
	`¬’a_run_d®loc_decomm™
(
¬’a
, 
chunk
, 
run
);

2445 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2447 
	`m®loc_mu‹x_lock
(&
bš
->
lock
);

2448 ià(
cÚfig_¡©s
)

2449 
bš
->
¡©s
.
cu¼uns
--;

2450 
	}
}

2453 
	$¬’a_bš_low”_run
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, 
¬’a_run_t
 *
run
,

2454 
¬’a_bš_t
 *
bš
)

2462 ià((
ušŒ_t
)
run
 < (ušŒ_t)
bš
->
runcur
) {

2464 ià(
bš
->
runcur
->
nä“
 > 0)

2465 
	`¬’a_bš_runs_š£¹
(
bš
, bš->
runcur
);

2466 
bš
->
runcur
 = 
run
;

2467 ià(
cÚfig_¡©s
)

2468 
bš
->
¡©s
.
»runs
++;

2470 
	`¬’a_bš_runs_š£¹
(
bš
, 
run
);

2471 
	}
}

2474 
	$¬’a_d®loc_bš_locked_im¶
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, *
±r
,

2475 
¬’a_chunk_m­_b™s_t
 *
b™£lm
, 
boŞ
 
junked
)

2477 
size_t
 
·gešd
, 
½ages_šd
;

2478 
¬’a_run_t
 *
run
;

2479 
¬’a_bš_t
 *
bš
;

2480 
¬’a_bš_šfo_t
 *
bš_šfo
;

2481 
szšd_t
 
bššd
;

2483 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

2484 
½ages_šd
 = 
·gešd
 - 
	`¬’a_m­b™s_sm®l_runšd_g‘
(
chunk
,…ageind);

2485 
run
 = &
	`¬’a_misûlm_g‘
(
chunk
, 
½ages_šd
)->run;

2486 
bššd
 = 
run
->binind;

2487 
bš
 = &
¬’a
->
bšs
[
bššd
];

2488 
bš_šfo
 = &
¬’a_bš_šfo
[
bššd
];

2490 ià(!
junked
 && 
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
))

2491 
	`¬’a_d®loc_junk_sm®l
(
±r
, 
bš_šfo
);

2493 
	`¬’a_run_»g_d®loc
(
run
, 
±r
);

2494 ià(
run
->
nä“
 =ğ
bš_šfo
->
Äegs
) {

2495 
	`¬’a_dissocŸ‹_bš_run
(
chunk
, 
run
, 
bš
);

2496 
	`¬’a_d®loc_bš_run
(
¬’a
, 
chunk
, 
run
, 
bš
);

2497 } ià(
run
->
nä“
 =ğ1 &&„uÀ!ğ
bš
->
runcur
)

2498 
	`¬’a_bš_low”_run
(
¬’a
, 
chunk
, 
run
, 
bš
);

2500 ià(
cÚfig_¡©s
) {

2501 
bš
->
¡©s
.
nd®loc
++;

2502 
bš
->
¡©s
.
cu¼egs
--;

2504 
	}
}

2507 
	$¬’a_d®loc_bš_junked_locked
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, *
±r
,

2508 
¬’a_chunk_m­_b™s_t
 *
b™£lm
)

2511 
	`¬’a_d®loc_bš_locked_im¶
(
¬’a
, 
chunk
, 
±r
, 
b™£lm
, 
Œue
);

2512 
	}
}

2515 
	$¬’a_d®loc_bš
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, *
±r
,

2516 
size_t
 
·gešd
, 
¬’a_chunk_m­_b™s_t
 *
b™£lm
)

2518 
¬’a_run_t
 *
run
;

2519 
¬’a_bš_t
 *
bš
;

2520 
size_t
 
½ages_šd
;

2522 
½ages_šd
 = 
·gešd
 - 
	`¬’a_m­b™s_sm®l_runšd_g‘
(
chunk
,…ageind);

2523 
run
 = &
	`¬’a_misûlm_g‘
(
chunk
, 
½ages_šd
)->run;

2524 
bš
 = &
¬’a
->
bšs
[
run
->
bššd
];

2525 
	`m®loc_mu‹x_lock
(&
bš
->
lock
);

2526 
	`¬’a_d®loc_bš_locked_im¶
(
¬’a
, 
chunk
, 
±r
, 
b™£lm
, 
çl£
);

2527 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

2528 
	}
}

2531 
	$¬’a_d®loc_sm®l
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, *
±r
,

2532 
size_t
 
·gešd
)

2534 
¬’a_chunk_m­_b™s_t
 *
b™£lm
;

2536 ià(
cÚfig_debug
) {

2538 
	`as£¹
(
	`¬’a_±r_sm®l_bššd_g‘
(
±r
, 
	`¬’a_m­b™s_g‘
(
chunk
,

2539 
·gešd
)è!ğ
BININD_INVALID
);

2541 
b™£lm
 = 
	`¬’a_b™£lm_g‘
(
chunk
, 
·gešd
);

2542 
	`¬’a_d®loc_bš
(
¬’a
, 
chunk
, 
±r
, 
·gešd
, 
b™£lm
);

2543 
	}
}

2545 #ifdeà
JEMALLOC_JET


2546 #undeà
¬’a_d®loc_junk_Ïrge


2547 
	#¬’a_d®loc_junk_Ïrge
 
	`JEMALLOC_N
(
¬’a_d®loc_junk_Ïrge_im¶
)

	)

2550 
	$¬’a_d®loc_junk_Ïrge
(*
±r
, 
size_t
 
usize
)

2553 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
))

2554 
	`mem£t
(
±r
, 0x5a, 
usize
);

2555 
	}
}

2556 #ifdeà
JEMALLOC_JET


2557 #undeà
¬’a_d®loc_junk_Ïrge


2558 
	#¬’a_d®loc_junk_Ïrge
 
	`JEMALLOC_N
(
¬’a_d®loc_junk_Ïrge
)

	)

2559 
¬’a_d®loc_junk_Ïrge_t
 *
	g¬’a_d®loc_junk_Ïrge
 =

2560 
JEMALLOC_N
(
¬’a_d®loc_junk_Ïrge_im¶
);

2564 
	$¬’a_d®loc_Ïrge_locked_im¶
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

2565 *
±r
, 
boŞ
 
junked
)

2567 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

2568 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_misûlm_g‘
(
chunk
, 
·gešd
);

2569 
¬’a_run_t
 *
run
 = &
misûlm
->run;

2571 ià(
cÚfig_fl
 || 
cÚfig_¡©s
) {

2572 
size_t
 
usize
 = 
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
) -

2573 
Ïrge_·d
;

2575 ià(!
junked
)

2576 
	`¬’a_d®loc_junk_Ïrge
(
±r
, 
usize
);

2577 ià(
cÚfig_¡©s
) {

2578 
szšd_t
 
šdex
 = 
	`size2šdex
(
usize
è- 
NBINS
;

2580 
¬’a
->
¡©s
.
nd®loc_Ïrge
++;

2581 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 -ğ
usize
;

2582 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
nd®loc
++;

2583 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
cu¼uns
--;

2587 
	`¬’a_run_d®loc_decomm™
(
¬’a
, 
chunk
, 
run
);

2588 
	}
}

2591 
	$¬’a_d®loc_Ïrge_junked_locked
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
,

2592 *
±r
)

2595 
	`¬’a_d®loc_Ïrge_locked_im¶
(
¬’a
, 
chunk
, 
±r
, 
Œue
);

2596 
	}
}

2599 
	$¬’a_d®loc_Ïrge
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, *
±r
)

2602 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

2603 
	`¬’a_d®loc_Ïrge_locked_im¶
(
¬’a
, 
chunk
, 
±r
, 
çl£
);

2604 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2605 
	}
}

2608 
	$¬’a_¿Îoc_Ïrge_shršk
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, *
±r
,

2609 
size_t
 
Şdsize
, size_ˆ
size
)

2611 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

2612 
¬’a_chunk_m­_misc_t
 *
misûlm
 = 
	`¬’a_misûlm_g‘
(
chunk
, 
·gešd
);

2613 
¬’a_run_t
 *
run
 = &
misûlm
->run;

2615 
	`as£¹
(
size
 < 
Şdsize
);

2621 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

2622 
	`¬’a_run_Œim_
(
¬’a
, 
chunk
, 
run
, 
Şdsize
 + 
Ïrge_·d
, 
size
 +

2623 
Ïrge_·d
, 
Œue
);

2624 ià(
cÚfig_¡©s
) {

2625 
szšd_t
 
Şdšdex
 = 
	`size2šdex
(
Şdsize
è- 
NBINS
;

2626 
szšd_t
 
šdex
 = 
	`size2šdex
(
size
è- 
NBINS
;

2628 
¬’a
->
¡©s
.
nd®loc_Ïrge
++;

2629 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 -ğ
Şdsize
;

2630 
¬’a
->
¡©s
.
l¡©s
[
Şdšdex
].
nd®loc
++;

2631 
¬’a
->
¡©s
.
l¡©s
[
Şdšdex
].
cu¼uns
--;

2633 
¬’a
->
¡©s
.
nm®loc_Ïrge
++;

2634 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
++;

2635 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 +ğ
size
;

2636 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
nm®loc
++;

2637 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
Äeque¡s
++;

2638 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
cu¼uns
++;

2640 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2641 
	}
}

2643 
boŞ


2644 
	$¬’a_¿Îoc_Ïrge_grow
(
¬’a_t
 *
¬’a
, 
¬’a_chunk_t
 *
chunk
, *
±r
,

2645 
size_t
 
Şdsize
, size_ˆ
usize_mš
, size_ˆ
usize_max
, 
boŞ
 
z”o
)

2647 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

2648 
size_t
 
Åages
 = (
Şdsize
 + 
Ïrge_·d
è>> 
LG_PAGE
;

2649 
size_t
 
fŞlowsize
;

2651 
	`as£¹
(
Şdsize
 =ğ
	`¬’a_m­b™s_Ïrge_size_g‘
(
chunk
, 
·gešd
) -

2652 
Ïrge_·d
);

2655 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

2656 ià(
·gešd
+
Åages
 >ğ
chunk_Åages
 || 
	`¬’a_m­b™s_®loÿ‹d_g‘
(
chunk
,

2657 
·gešd
+
Åages
) != 0)

2658 
Ïb–_ç
;

2659 
fŞlowsize
 = 
	`¬’a_m­b™s_uÇÎoÿ‹d_size_g‘
(
chunk
, 
·gešd
+
Åages
);

2660 ià(
Şdsize
 + 
fŞlowsize
 >ğ
usize_mš
) {

2666 
¬’a_run_t
 *
run
;

2667 
size_t
 
usize
, 
¥l™size
, 
size
, 
æag_dœty
, 
æag_unz”Ûd_mask
;

2669 
usize
 = 
usize_max
;

2670 
Şdsize
 + 
fŞlowsize
 < 
usize
)

2671 
usize
 = 
	`šdex2size
(
	`size2šdex
(usize)-1);

2672 
	`as£¹
(
usize
 >ğ
usize_mš
);

2673 
	`as£¹
(
usize
 >ğ
Şdsize
);

2674 
¥l™size
 = 
usize
 - 
Şdsize
;

2675 ià(
¥l™size
 == 0)

2676 
Ïb–_ç
;

2678 
run
 = &
	`¬’a_misûlm_g‘
(
chunk
, 
·gešd
+
Åages
)->run;

2679 ià(
	`¬’a_run_¥l™_Ïrge
(
¬’a
, 
run
, 
¥l™size
, 
z”o
))

2680 
Ïb–_ç
;

2682 ià(
cÚfig_ÿche_oblivious
 && 
z”o
) {

2687 
	`as£¹
(
	`PAGE_CEILING
(
Şdsize
) == oldsize);

2688 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
), 0,

2689 
	`PAGE_CEILING
((
ušŒ_t
)
±r
) - (uintptr_t)ptr);

2692 
size
 = 
Şdsize
 + 
¥l™size
;

2693 
Åages
 = (
size
 + 
Ïrge_·d
è>> 
LG_PAGE
;

2703 
æag_dœty
 = 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
) |

2704 
	`¬’a_m­b™s_dœty_g‘
(
chunk
, 
·gešd
+
Åages
-1);

2705 
æag_unz”Ûd_mask
 = 
æag_dœty
 =ğ0 ? 
CHUNK_MAP_UNZEROED
 : 0;

2706 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
, 
size
 + 
Ïrge_·d
,

2707 
æag_dœty
 | (
æag_unz”Ûd_mask
 &

2708 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
, 
·gešd
)));

2709 
	`¬’a_m­b™s_Ïrge_£t
(
chunk
, 
·gešd
+
Åages
-1, 0, 
æag_dœty
 |

2710 (
æag_unz”Ûd_mask
 & 
	`¬’a_m­b™s_unz”Ûd_g‘
(
chunk
,

2711 
·gešd
+
Åages
-1)));

2713 ià(
cÚfig_¡©s
) {

2714 
szšd_t
 
Şdšdex
 = 
	`size2šdex
(
Şdsize
è- 
NBINS
;

2715 
szšd_t
 
šdex
 = 
	`size2šdex
(
size
è- 
NBINS
;

2717 
¬’a
->
¡©s
.
nd®loc_Ïrge
++;

2718 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 -ğ
Şdsize
;

2719 
¬’a
->
¡©s
.
l¡©s
[
Şdšdex
].
nd®loc
++;

2720 
¬’a
->
¡©s
.
l¡©s
[
Şdšdex
].
cu¼uns
--;

2722 
¬’a
->
¡©s
.
nm®loc_Ïrge
++;

2723 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
++;

2724 
¬’a
->
¡©s
.
®loÿ‹d_Ïrge
 +ğ
size
;

2725 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
nm®loc
++;

2726 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
Äeque¡s
++;

2727 
¬’a
->
¡©s
.
l¡©s
[
šdex
].
cu¼uns
++;

2729 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2730  (
çl£
);

2732 
Ïb–_ç
:

2733 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2734  (
Œue
);

2735 
	}
}

2737 #ifdeà
JEMALLOC_JET


2738 #undeà
¬’a_¿Îoc_junk_Ïrge


2739 
	#¬’a_¿Îoc_junk_Ïrge
 
	`JEMALLOC_N
(
¬’a_¿Îoc_junk_Ïrge_im¶
)

	)

2742 
	$¬’a_¿Îoc_junk_Ïrge
(*
±r
, 
size_t
 
Şd_usize
, size_ˆ
usize
)

2745 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
)) {

2746 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
usize
), 0x5a,

2747 
Şd_usize
 - 
usize
);

2749 
	}
}

2750 #ifdeà
JEMALLOC_JET


2751 #undeà
¬’a_¿Îoc_junk_Ïrge


2752 
	#¬’a_¿Îoc_junk_Ïrge
 
	`JEMALLOC_N
(
¬’a_¿Îoc_junk_Ïrge
)

	)

2753 
¬’a_¿Îoc_junk_Ïrge_t
 *
	g¬’a_¿Îoc_junk_Ïrge
 =

2754 
JEMALLOC_N
(
¬’a_¿Îoc_junk_Ïrge_im¶
);

2761 
boŞ


2762 
	$¬’a_¿Îoc_Ïrge
(*
±r
, 
size_t
 
Şdsize
, size_ˆ
usize_mš
,

2763 
size_t
 
usize_max
, 
boŞ
 
z”o
)

2765 
¬’a_chunk_t
 *
chunk
;

2766 
¬’a_t
 *
¬’a
;

2768 ià(
Şdsize
 =ğ
usize_max
) {

2770  (
çl£
);

2773 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

2774 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
);

2776 ià(
Şdsize
 < 
usize_max
) {

2777 
boŞ
 
»t
 = 
	`¬’a_¿Îoc_Ïrge_grow
(
¬’a
, 
chunk
, 
±r
, 
Şdsize
,

2778 
usize_mš
, 
usize_max
, 
z”o
);

2779 ià(
cÚfig_fl
 && !
»t
 && !
z”o
) {

2780 ià(
	`uÆik–y
(
İt_junk_®loc
)) {

2781 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
), 0xa5,

2782 
	`i§Îoc
(
±r
, 
cÚfig_´of
è- 
Şdsize
);

2783 } ià(
	`uÆik–y
(
İt_z”o
)) {

2784 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
), 0,

2785 
	`i§Îoc
(
±r
, 
cÚfig_´of
è- 
Şdsize
);

2788  (
»t
);

2791 
	`as£¹
(
Şdsize
 > 
usize_max
);

2793 
	`¬’a_¿Îoc_junk_Ïrge
(
±r
, 
Şdsize
, 
usize_max
);

2794 
	`¬’a_¿Îoc_Ïrge_shršk
(
¬’a
, 
chunk
, 
±r
, 
Şdsize
, 
usize_max
);

2795  (
çl£
);

2796 
	}
}

2798 
boŞ


2799 
	$¬’a_¿Îoc_no_move
(*
±r
, 
size_t
 
Şdsize
, size_ˆ
size
, size_ˆ
exŒa
,

2800 
boŞ
 
z”o
)

2802 
size_t
 
usize_mš
, 
usize_max
;

2804 
usize_mš
 = 
	`s2u
(
size
);

2805 
usize_max
 = 
	`s2u
(
size
 + 
exŒa
);

2806 ià(
	`lik–y
(
Şdsize
 <ğ
Ïrge_maxşass
 && 
usize_mš
 <=†arge_maxclass)) {

2811 ià(
Şdsize
 <ğ
SMALL_MAXCLASS
) {

2812 
	`as£¹
(
¬’a_bš_šfo
[
	`size2šdex
(
Şdsize
)].
»g_size
 ==

2813 
Şdsize
);

2814 ià((
usize_max
 <ğ
SMALL_MAXCLASS
 &&

2815 
	`size2šdex
(
usize_max
è=ğsize2šdex(
Şdsize
)) ||

2816 (
size
 <ğ
Şdsize
 && 
usize_max
 >= oldsize))

2817  (
çl£
);

2819 ià(
usize_max
 > 
SMALL_MAXCLASS
) {

2820 ià(!
	`¬’a_¿Îoc_Ïrge
(
±r
, 
Şdsize
, 
usize_mš
,

2821 
usize_max
, 
z”o
))

2822  (
çl£
);

2827  (
Œue
);

2829  (
	`huge_¿Îoc_no_move
(
±r
, 
Şdsize
, 
usize_mš
, 
usize_max
,

2830 
z”o
));

2832 
	}
}

2835 
	$¬’a_¿Îoc_move_h–³r
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
,

2836 
size_t
 
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
)

2839 ià(
®ignm’t
 == 0)

2840  (
	`¬’a_m®loc
(
tsd
, 
¬’a
, 
usize
, 
z”o
, 
tÿche
));

2841 
usize
 = 
	`§2u
(usize, 
®ignm’t
);

2842 ià(
usize
 == 0)

2843  (
NULL
);

2844  (
	`®loù
(
tsd
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
));

2845 
	}
}

2848 
	$¬’a_¿Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
size
,

2849 
size_t
 
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
)

2851 *
»t
;

2852 
size_t
 
usize
;

2854 
usize
 = 
	`s2u
(
size
);

2855 ià(
usize
 == 0)

2856  (
NULL
);

2858 ià(
	`lik–y
(
usize
 <ğ
Ïrge_maxşass
)) {

2859 
size_t
 
cİysize
;

2862 ià(!
	`¬’a_¿Îoc_no_move
(
±r
, 
Şdsize
, 
usize
, 0, 
z”o
))

2863  (
±r
);

2870 
»t
 = 
	`¬’a_¿Îoc_move_h–³r
(
tsd
, 
¬’a
, 
usize
, 
®ignm’t
,

2871 
z”o
, 
tÿche
);

2872 ià(
»t
 =ğ
NULL
)

2873  (
NULL
);

2880 
cİysize
 = (
usize
 < 
Şdsize
) ? usize : oldsize;

2881 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
cİysize
);

2882 
	`memıy
(
»t
, 
±r
, 
cİysize
);

2883 
	`isq®loc
(
tsd
, 
±r
, 
Şdsize
, 
tÿche
);

2885 
»t
 = 
	`huge_¿Îoc
(
tsd
, 
¬’a
, 
±r
, 
Şdsize
, 
usize
, 
®ignm’t
,

2886 
z”o
, 
tÿche
);

2888  (
»t
);

2889 
	}
}

2891 
dss_´ec_t


2892 
	$¬’a_dss_´ec_g‘
(
¬’a_t
 *
¬’a
)

2894 
dss_´ec_t
 
»t
;

2896 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

2897 
»t
 = 
¬’a
->
dss_´ec
;

2898 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2899  (
»t
);

2900 
	}
}

2902 
boŞ


2903 
	$¬’a_dss_´ec_£t
(
¬’a_t
 *
¬’a
, 
dss_´ec_t
 
dss_´ec
)

2906 ià(!
have_dss
)

2907  (
dss_´ec
 !ğ
dss_´ec_di§bËd
);

2908 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

2909 
¬’a
->
dss_´ec
 = dss_prec;

2910 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2911  (
çl£
);

2912 
	}
}

2914 
ssize_t


2915 
	$¬’a_lg_dœty_muÉ_deçuÉ_g‘
()

2918  ((
ssize_t
)
	`©omic_»ad_z
((
size_t
 *)&
lg_dœty_muÉ_deçuÉ
));

2919 
	}
}

2921 
boŞ


2922 
	$¬’a_lg_dœty_muÉ_deçuÉ_£t
(
ssize_t
 
lg_dœty_muÉ
)

2925 ià(!
	`¬’a_lg_dœty_muÉ_v®id
(
lg_dœty_muÉ
))

2926  (
Œue
);

2927 
	`©omic_wr™e_z
((
size_t
 *)&
lg_dœty_muÉ_deçuÉ
, (size_t)
lg_dœty_muÉ
);

2928  (
çl£
);

2929 
	}
}

2932 
	$¬’a_¡©s_m”ge
(
¬’a_t
 *
¬’a
, cÚ¡ **
dss
, 
ssize_t
 *
lg_dœty_muÉ
,

2933 
size_t
 *
Çùive
, size_ˆ*
ndœty
, 
¬’a_¡©s_t
 *
a¡©s
,

2934 
m®loc_bš_¡©s_t
 *
b¡©s
, 
m®loc_Ïrge_¡©s_t
 *
l¡©s
,

2935 
m®loc_huge_¡©s_t
 *
h¡©s
)

2937 
i
;

2939 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

2940 *
dss
 = 
dss_´ec_Çmes
[
¬’a
->
dss_´ec
];

2941 *
lg_dœty_muÉ
 = 
¬’a
->lg_dirty_mult;

2942 *
Çùive
 +ğ
¬’a
->nactive;

2943 *
ndœty
 +ğ
¬’a
->ndirty;

2945 
a¡©s
->
m­³d
 +ğ
¬’a
->
¡©s
.mapped;

2946 
a¡©s
->
Åurge
 +ğ
¬’a
->
¡©s
.npurge;

2947 
a¡©s
->
nmadvi£
 +ğ
¬’a
->
¡©s
.nmadvise;

2948 
a¡©s
->
purged
 +ğ
¬’a
->
¡©s
.purged;

2949 
a¡©s
->
m‘ad©a_m­³d
 +ğ
¬’a
->
¡©s
.metadata_mapped;

2950 
a¡©s
->
m‘ad©a_®loÿ‹d
 +ğ
	`¬’a_m‘ad©a_®loÿ‹d_g‘
(
¬’a
);

2951 
a¡©s
->
®loÿ‹d_Ïrge
 +ğ
¬’a
->
¡©s
.allocated_large;

2952 
a¡©s
->
nm®loc_Ïrge
 +ğ
¬’a
->
¡©s
.nmalloc_large;

2953 
a¡©s
->
nd®loc_Ïrge
 +ğ
¬’a
->
¡©s
.ndalloc_large;

2954 
a¡©s
->
Äeque¡s_Ïrge
 +ğ
¬’a
->
¡©s
.nrequests_large;

2955 
a¡©s
->
®loÿ‹d_huge
 +ğ
¬’a
->
¡©s
.allocated_huge;

2956 
a¡©s
->
nm®loc_huge
 +ğ
¬’a
->
¡©s
.nmalloc_huge;

2957 
a¡©s
->
nd®loc_huge
 +ğ
¬’a
->
¡©s
.ndalloc_huge;

2959 
i
 = 0; i < 
Æşas£s
; i++) {

2960 
l¡©s
[
i
].
nm®loc
 +ğ
¬’a
->
¡©s
.lstats[i].nmalloc;

2961 
l¡©s
[
i
].
nd®loc
 +ğ
¬’a
->
¡©s
.lstats[i].ndalloc;

2962 
l¡©s
[
i
].
Äeque¡s
 +ğ
¬’a
->
¡©s
.lstats[i].nrequests;

2963 
l¡©s
[
i
].
cu¼uns
 +ğ
¬’a
->
¡©s
.lstats[i].curruns;

2966 
i
 = 0; i < 
nhşas£s
; i++) {

2967 
h¡©s
[
i
].
nm®loc
 +ğ
¬’a
->
¡©s
.hstats[i].nmalloc;

2968 
h¡©s
[
i
].
nd®loc
 +ğ
¬’a
->
¡©s
.hstats[i].ndalloc;

2969 
h¡©s
[
i
].
curhchunks
 +ğ
¬’a
->
¡©s
.hstats[i].curhchunks;

2971 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

2973 
i
 = 0; i < 
NBINS
; i++) {

2974 
¬’a_bš_t
 *
bš
 = &
¬’a
->
bšs
[
i
];

2976 
	`m®loc_mu‹x_lock
(&
bš
->
lock
);

2977 
b¡©s
[
i
].
nm®loc
 +ğ
bš
->
¡©s
.nmalloc;

2978 
b¡©s
[
i
].
nd®loc
 +ğ
bš
->
¡©s
.ndalloc;

2979 
b¡©s
[
i
].
Äeque¡s
 +ğ
bš
->
¡©s
.nrequests;

2980 
b¡©s
[
i
].
cu¼egs
 +ğ
bš
->
¡©s
.curregs;

2981 ià(
cÚfig_tÿche
) {

2982 
b¡©s
[
i
].
nfls
 +ğ
bš
->
¡©s
.nfills;

2983 
b¡©s
[
i
].
næushes
 +ğ
bš
->
¡©s
.nflushes;

2985 
b¡©s
[
i
].
Äuns
 +ğ
bš
->
¡©s
.nruns;

2986 
b¡©s
[
i
].
»runs
 +ğ
bš
->
¡©s
.reruns;

2987 
b¡©s
[
i
].
cu¼uns
 +ğ
bš
->
¡©s
.curruns;

2988 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

2990 
	}
}

2992 
¬’a_t
 *

2993 
	$¬’a_Ãw
(
šd
)

2995 
¬’a_t
 *
¬’a
;

2996 
i
;

2997 
¬’a_bš_t
 *
bš
;

3003 ià(
cÚfig_¡©s
) {

3004 
¬’a
 = (
¬’a_t
 *)
	`ba£_®loc
(
	`CACHELINE_CEILING
((arena_t))

3005 + 
	`QUANTUM_CEILING
(
Æşas£s
 * (
m®loc_Ïrge_¡©s_t
) +

3006 
nhşas£s
è* (
m®loc_huge_¡©s_t
));

3008 
¬’a
 = (
¬’a_t
 *)
	`ba£_®loc
((arena_t));

3009 ià(
¬’a
 =ğ
NULL
)

3010  (
NULL
);

3012 
¬’a
->
šd
 = ind;

3013 
¬’a
->
Áh»ads
 = 0;

3014 ià(
	`m®loc_mu‹x_š™
(&
¬’a
->
lock
))

3015  (
NULL
);

3017 ià(
cÚfig_¡©s
) {

3018 
	`mem£t
(&
¬’a
->
¡©s
, 0, (
¬’a_¡©s_t
));

3019 
¬’a
->
¡©s
.
l¡©s
 = (
m®loc_Ïrge_¡©s_t
 *)((
ušŒ_t
)arena

3020 + 
	`CACHELINE_CEILING
((
¬’a_t
)));

3021 
	`mem£t
(
¬’a
->
¡©s
.
l¡©s
, 0, 
Æşas£s
 *

3022 (
m®loc_Ïrge_¡©s_t
));

3023 
¬’a
->
¡©s
.
h¡©s
 = (
m®loc_huge_¡©s_t
 *)((
ušŒ_t
)arena

3024 + 
	`CACHELINE_CEILING
((
¬’a_t
)) +

3025 
	`QUANTUM_CEILING
(
Æşas£s
 * (
m®loc_Ïrge_¡©s_t
)));

3026 
	`mem£t
(
¬’a
->
¡©s
.
h¡©s
, 0, 
nhşas£s
 *

3027 (
m®loc_huge_¡©s_t
));

3028 ià(
cÚfig_tÿche
)

3029 
	`ql_Ãw
(&
¬’a
->
tÿche_ql
);

3032 ià(
cÚfig_´of
)

3033 
¬’a
->
´of_accumby‹s
 = 0;

3035 ià(
cÚfig_ÿche_oblivious
) {

3043 
¬’a
->
off£t_¡©e
 = 
cÚfig_debug
 ? 
šd
 :

3044 (
ušt64_t
)(
ušŒ_t
)
¬’a
;

3047 
¬’a
->
dss_´ec
 = 
	`chunk_dss_´ec_g‘
();

3049 
¬’a
->
¥¬e
 = 
NULL
;

3051 
¬’a
->
lg_dœty_muÉ
 = 
	`¬’a_lg_dœty_muÉ_deçuÉ_g‘
();

3052 
¬’a
->
purgšg
 = 
çl£
;

3053 
¬’a
->
Çùive
 = 0;

3054 
¬’a
->
ndœty
 = 0;

3056 
	`¬’a_ava_Œ“_Ãw
(&
¬’a
->
runs_ava
);

3057 
	`qr_Ãw
(&
¬’a
->
runs_dœty
, 
rd_lšk
);

3058 
	`qr_Ãw
(&
¬’a
->
chunks_ÿche
, 
cc_lšk
);

3060 
	`ql_Ãw
(&
¬’a
->
huge
);

3061 ià(
	`m®loc_mu‹x_š™
(&
¬’a
->
huge_mtx
))

3062  (
NULL
);

3064 
	`ex‹Á_Œ“_szad_Ãw
(&
¬’a
->
chunks_szad_ÿched
);

3065 
	`ex‹Á_Œ“_ad_Ãw
(&
¬’a
->
chunks_ad_ÿched
);

3066 
	`ex‹Á_Œ“_szad_Ãw
(&
¬’a
->
chunks_szad_»šed
);

3067 
	`ex‹Á_Œ“_ad_Ãw
(&
¬’a
->
chunks_ad_»šed
);

3068 ià(
	`m®loc_mu‹x_š™
(&
¬’a
->
chunks_mtx
))

3069  (
NULL
);

3070 
	`ql_Ãw
(&
¬’a
->
node_ÿche
);

3071 ià(
	`m®loc_mu‹x_š™
(&
¬’a
->
node_ÿche_mtx
))

3072  (
NULL
);

3074 
¬’a
->
chunk_hooks
 = 
chunk_hooks_deçuÉ
;

3077 
i
 = 0; i < 
NBINS
; i++) {

3078 
bš
 = &
¬’a
->
bšs
[
i
];

3079 ià(
	`m®loc_mu‹x_š™
(&
bš
->
lock
))

3080  (
NULL
);

3081 
bš
->
runcur
 = 
NULL
;

3082 
	`¬’a_run_Œ“_Ãw
(&
bš
->
runs
);

3083 ià(
cÚfig_¡©s
)

3084 
	`mem£t
(&
bš
->
¡©s
, 0, (
m®loc_bš_¡©s_t
));

3087  (
¬’a
);

3088 
	}
}

3100 
	$bš_šfo_run_size_ÿlc
(
¬’a_bš_šfo_t
 *
bš_šfo
)

3102 
size_t
 
·d_size
;

3103 
size_t
 
Œy_run_size
, 
³rãù_run_size
, 
aùu®_run_size
;

3104 
ušt32_t
 
Œy_Äegs
, 
³rãù_Äegs
, 
aùu®_Äegs
;

3113 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_»dzÚe
)) {

3114 
size_t
 
®ign_mš
 = 
	`ZU
(1è<< (
	`jem®loc_ffs
(
bš_šfo
->
»g_size
) -

3116 ià(
®ign_mš
 <ğ
REDZONE_MINSIZE
) {

3117 
bš_šfo
->
»dzÚe_size
 = 
REDZONE_MINSIZE
;

3118 
·d_size
 = 0;

3120 
bš_šfo
->
»dzÚe_size
 = 
®ign_mš
 >> 1;

3121 
·d_size
 = 
bš_šfo
->
»dzÚe_size
;

3124 
bš_šfo
->
»dzÚe_size
 = 0;

3125 
·d_size
 = 0;

3127 
bš_šfo
->
»g_š‹rv®
 = bš_šfo->
»g_size
 +

3128 (
bš_šfo
->
»dzÚe_size
 << 1);

3134 
Œy_run_size
 = 
PAGE
;

3135 
Œy_Äegs
 = 
Œy_run_size
 / 
bš_šfo
->
»g_size
;

3137 
³rãù_run_size
 = 
Œy_run_size
;

3138 
³rãù_Äegs
 = 
Œy_Äegs
;

3140 
Œy_run_size
 +ğ
PAGE
;

3141 
Œy_Äegs
 = 
Œy_run_size
 / 
bš_šfo
->
»g_size
;

3142 } 
³rãù_run_size
 !ğ
³rãù_Äegs
 * 
bš_šfo
->
»g_size
);

3143 
	`as£¹
(
³rãù_Äegs
 <ğ
RUN_MAXREGS
);

3145 
aùu®_run_size
 = 
³rãù_run_size
;

3146 
aùu®_Äegs
 = (
aùu®_run_size
 - 
·d_size
è/ 
bš_šfo
->
»g_š‹rv®
;

3154 
aùu®_Äegs
 == 0) {

3155 
	`as£¹
(
cÚfig_fl
 && 
	`uÆik–y
(
İt_»dzÚe
));

3157 
aùu®_run_size
 +ğ
PAGE
;

3158 
aùu®_Äegs
 = (
aùu®_run_size
 - 
·d_size
) /

3159 
bš_šfo
->
»g_š‹rv®
;

3165 
aùu®_run_size
 > 
¬’a_maxrun
) {

3166 
aùu®_run_size
 -ğ
PAGE
;

3167 
aùu®_Äegs
 = (
aùu®_run_size
 - 
·d_size
) /

3168 
bš_šfo
->
»g_š‹rv®
;

3170 
	`as£¹
(
aùu®_Äegs
 > 0);

3171 
	`as£¹
(
aùu®_run_size
 =ğ
	`s2u
(actual_run_size));

3174 
bš_šfo
->
run_size
 = 
aùu®_run_size
;

3175 
bš_šfo
->
Äegs
 = 
aùu®_Äegs
;

3176 
bš_šfo
->
»g0_off£t
 = 
aùu®_run_size
 - (
aùu®_Äegs
 *

3177 
bš_šfo
->
»g_š‹rv®
è- 
·d_size
 + bš_šfo->
»dzÚe_size
;

3179 ià(
aùu®_run_size
 > 
sm®l_maxrun
)

3180 
sm®l_maxrun
 = 
aùu®_run_size
;

3182 
	`as£¹
(
bš_šfo
->
»g0_off£t
 - bš_šfo->
»dzÚe_size
 + (bš_šfo->
Äegs


3183 * 
bš_šfo
->
»g_š‹rv®
è+ 
·d_size
 =ğbš_šfo->
run_size
);

3184 
	}
}

3187 
	$bš_šfo_š™
()

3189 
¬’a_bš_šfo_t
 *
bš_šfo
;

3191 
	#BIN_INFO_INIT_bš_yes
(
šdex
, 
size
) \

3192 
bš_šfo
 = &
¬’a_bš_šfo
[
šdex
]; \

3193 
bš_šfo
->
»g_size
 = 
size
; \

3194 
	`bš_šfo_run_size_ÿlc
(
bš_šfo
); \

3195 
	`b™m­_šfo_š™
(&
bš_šfo
->
b™m­_šfo
, bš_šfo->
Äegs
);

	)

3196 
	#BIN_INFO_INIT_bš_no
(
šdex
, 
size
)

	)

3197 
	#SC
(
šdex
, 
lg_g½
, 
lg_d–
, 
nd–
, 
bš
, 
lg_d–_lookup
) \

3198 
BIN_INFO_INIT_bš_
##
	`bš
(
šdex
, (
	`ZU
(1)<<
lg_g½
è+ (ZU(
nd–
)<<
lg_d–
))

	)

3199 
SIZE_CLASSES


3200 #undeà
BIN_INFO_INIT_bš_yes


3201 #undeà
BIN_INFO_INIT_bš_no


3202 #undeà
SC


3203 
	}
}

3205 
boŞ


3206 
	$sm®l_run_size_š™
()

3209 
	`as£¹
(
sm®l_maxrun
 != 0);

3211 
sm®l_run_b
 = (
boŞ
 *)
	`ba£_®loc
((boŞè* (
sm®l_maxrun
 >>

3212 
LG_PAGE
));

3213 ià(
sm®l_run_b
 =ğ
NULL
)

3214  (
Œue
);

3216 
	#TAB_INIT_bš_yes
(
šdex
, 
size
) { \

3217 
¬’a_bš_šfo_t
 *
bš_šfo
 = &
¬’a_bš_šfo
[
šdex
]; \

3218 
sm®l_run_b
[
bš_šfo
->
run_size
 >> 
LG_PAGE
] = 
Œue
; \

3219 }

	)

3220 
	#TAB_INIT_bš_no
(
šdex
, 
size
)

	)

3221 
	#SC
(
šdex
, 
lg_g½
, 
lg_d–
, 
nd–
, 
bš
, 
lg_d–_lookup
) \

3222 
TAB_INIT_bš_
##
	`bš
(
šdex
, (
	`ZU
(1)<<
lg_g½
è+ (ZU(
nd–
)<<
lg_d–
))

	)

3223 
SIZE_CLASSES


3224 #undeà
TAB_INIT_bš_yes


3225 #undeà
TAB_INIT_bš_no


3226 #undeà
SC


3228  (
çl£
);

3229 
	}
}

3231 
boŞ


3232 
	$¬’a_boÙ
()

3234 
i
;

3236 
	`¬’a_lg_dœty_muÉ_deçuÉ_£t
(
İt_lg_dœty_muÉ
);

3250 
m­_bŸs
 = 0;

3251 
i
 = 0; i < 3; i++) {

3252 
size_t
 
h—d”_size
 = 
	`off£tof
(
¬’a_chunk_t
, 
m­_b™s
) +

3253 (((
¬’a_chunk_m­_b™s_t
) +

3254 (
¬’a_chunk_m­_misc_t
)è* (
chunk_Åages
-
m­_bŸs
));

3255 
m­_bŸs
 = (
h—d”_size
 + 
PAGE_MASK
è>> 
LG_PAGE
;

3257 
	`as£¹
(
m­_bŸs
 > 0);

3259 
m­_misc_off£t
 = 
	`off£tof
(
¬’a_chunk_t
, 
m­_b™s
) +

3260 (
¬’a_chunk_m­_b™s_t
è* (
chunk_Åages
-
m­_bŸs
);

3262 
¬’a_maxrun
 = 
chunksize
 - (
m­_bŸs
 << 
LG_PAGE
);

3263 
	`as£¹
(
¬’a_maxrun
 > 0);

3264 
Ïrge_maxşass
 = 
	`šdex2size
(
	`size2šdex
(
chunksize
)-1);

3265 ià(
Ïrge_maxşass
 > 
¬’a_maxrun
) {

3271 
Ïrge_maxşass
 = 
¬’a_maxrun
;

3273 
	`as£¹
(
Ïrge_maxşass
 > 0);

3274 
Æşas£s
 = 
	`size2šdex
(
Ïrge_maxşass
è- size2šdex(
SMALL_MAXCLASS
);

3275 
nhşas£s
 = 
NSIZES
 - 
Æşas£s
 - 
NBINS
;

3277 
	`bš_šfo_š™
();

3278  (
	`sm®l_run_size_š™
());

3279 
	}
}

3282 
	$¬’a_´efÜk
(
¬’a_t
 *
¬’a
)

3284 
i
;

3286 
	`m®loc_mu‹x_´efÜk
(&
¬’a
->
lock
);

3287 
	`m®loc_mu‹x_´efÜk
(&
¬’a
->
huge_mtx
);

3288 
	`m®loc_mu‹x_´efÜk
(&
¬’a
->
chunks_mtx
);

3289 
	`m®loc_mu‹x_´efÜk
(&
¬’a
->
node_ÿche_mtx
);

3290 
i
 = 0; i < 
NBINS
; i++)

3291 
	`m®loc_mu‹x_´efÜk
(&
¬’a
->
bšs
[
i
].
lock
);

3292 
	}
}

3295 
	$¬’a_po¡fÜk_·»Á
(
¬’a_t
 *
¬’a
)

3297 
i
;

3299 
i
 = 0; i < 
NBINS
; i++)

3300 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
¬’a
->
bšs
[
i
].
lock
);

3301 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
¬’a
->
node_ÿche_mtx
);

3302 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
¬’a
->
chunks_mtx
);

3303 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
¬’a
->
huge_mtx
);

3304 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
¬’a
->
lock
);

3305 
	}
}

3308 
	$¬’a_po¡fÜk_chd
(
¬’a_t
 *
¬’a
)

3310 
i
;

3312 
i
 = 0; i < 
NBINS
; i++)

3313 
	`m®loc_mu‹x_po¡fÜk_chd
(&
¬’a
->
bšs
[
i
].
lock
);

3314 
	`m®loc_mu‹x_po¡fÜk_chd
(&
¬’a
->
node_ÿche_mtx
);

3315 
	`m®loc_mu‹x_po¡fÜk_chd
(&
¬’a
->
chunks_mtx
);

3316 
	`m®loc_mu‹x_po¡fÜk_chd
(&
¬’a
->
huge_mtx
);

3317 
	`m®loc_mu‹x_po¡fÜk_chd
(&
¬’a
->
lock
);

3318 
	}
}

	@deps/jemalloc/src/atomic.c

1 
	#JEMALLOC_ATOMIC_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

	@deps/jemalloc/src/base.c

1 
	#JEMALLOC_BASE_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
m®loc_mu‹x_t
 
	gba£_mtx
;

8 
ex‹Á_Œ“_t
 
	gba£_ava_szad
;

9 
ex‹Á_node_t
 *
	gba£_nodes
;

10 
size_t
 
	gba£_®loÿ‹d
;

11 
size_t
 
	gba£_»sid’t
;

12 
size_t
 
	gba£_m­³d
;

17 
ex‹Á_node_t
 *

18 
	$ba£_node_Œy_®loc
()

20 
ex‹Á_node_t
 *
node
;

22 ià(
ba£_nodes
 =ğ
NULL
)

23  (
NULL
);

24 
node
 = 
ba£_nodes
;

25 
ba£_nodes
 = *(
ex‹Á_node_t
 **)
node
;

26 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
node
, (
ex‹Á_node_t
));

27  (
node
);

28 
	}
}

32 
	$ba£_node_d®loc
(
ex‹Á_node_t
 *
node
)

35 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
node
, (
ex‹Á_node_t
));

36 *(
ex‹Á_node_t
 **)
node
 = 
ba£_nodes
;

37 
ba£_nodes
 = 
node
;

38 
	}
}

41 
ex‹Á_node_t
 *

42 
	$ba£_chunk_®loc
(
size_t
 
mšsize
)

44 
ex‹Á_node_t
 *
node
;

45 
size_t
 
csize
, 
nsize
;

46 *
addr
;

48 
	`as£¹
(
mšsize
 != 0);

49 
node
 = 
	`ba£_node_Œy_®loc
();

51 
nsize
 = (
node
 =ğ
NULL
è? 
	`CACHELINE_CEILING
((
ex‹Á_node_t
)) : 0;

52 
csize
 = 
	`CHUNK_CEILING
(
mšsize
 + 
nsize
);

53 
addr
 = 
	`chunk_®loc_ba£
(
csize
);

54 ià(
addr
 =ğ
NULL
) {

55 ià(
node
 !ğ
NULL
)

56 
	`ba£_node_d®loc
(
node
);

57  (
NULL
);

59 
ba£_m­³d
 +ğ
csize
;

60 ià(
node
 =ğ
NULL
) {

61 
node
 = (
ex‹Á_node_t
 *)
addr
;

62 
addr
 = (*)((
ušŒ_t
ïdd¸+ 
nsize
);

63 
csize
 -ğ
nsize
;

64 ià(
cÚfig_¡©s
) {

65 
ba£_®loÿ‹d
 +ğ
nsize
;

66 
ba£_»sid’t
 +ğ
	`PAGE_CEILING
(
nsize
);

69 
	`ex‹Á_node_š™
(
node
, 
NULL
, 
addr
, 
csize
, 
Œue
,rue);

70  (
node
);

71 
	}
}

79 
	$ba£_®loc
(
size_t
 
size
)

81 *
»t
;

82 
size_t
 
csize
, 
usize
;

83 
ex‹Á_node_t
 *
node
;

84 
ex‹Á_node_t
 
key
;

90 
csize
 = 
	`CACHELINE_CEILING
(
size
);

92 
usize
 = 
	`s2u
(
csize
);

93 
	`ex‹Á_node_š™
(&
key
, 
NULL
, NULL, 
usize
, 
çl£
, false);

94 
	`m®loc_mu‹x_lock
(&
ba£_mtx
);

95 
node
 = 
	`ex‹Á_Œ“_szad_n£¬ch
(&
ba£_ava_szad
, &
key
);

96 ià(
node
 !ğ
NULL
) {

98 
	`ex‹Á_Œ“_szad_»move
(&
ba£_ava_szad
, 
node
);

101 
node
 = 
	`ba£_chunk_®loc
(
csize
);

103 ià(
node
 =ğ
NULL
) {

104 
»t
 = 
NULL
;

105 
Ïb–_»tuº
;

108 
»t
 = 
	`ex‹Á_node_addr_g‘
(
node
);

109 ià(
	`ex‹Á_node_size_g‘
(
node
è> 
csize
) {

110 
	`ex‹Á_node_addr_£t
(
node
, (*)((
ušŒ_t
)
»t
 + 
csize
));

111 
	`ex‹Á_node_size_£t
(
node
, 
	`ex‹Á_node_size_g‘
Òodeè- 
csize
);

112 
	`ex‹Á_Œ“_szad_š£¹
(&
ba£_ava_szad
, 
node
);

114 
	`ba£_node_d®loc
(
node
);

115 ià(
cÚfig_¡©s
) {

116 
ba£_®loÿ‹d
 +ğ
csize
;

121 
ba£_»sid’t
 +ğ
	`PAGE_CEILING
((
ušŒ_t
)
»t
 + 
csize
) -

122 
	`PAGE_CEILING
((
ušŒ_t
)
»t
);

124 
	`JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
(
»t
, 
csize
);

125 
Ïb–_»tuº
:

126 
	`m®loc_mu‹x_uÆock
(&
ba£_mtx
);

127  (
»t
);

128 
	}
}

131 
	$ba£_¡©s_g‘
(
size_t
 *
®loÿ‹d
, size_ˆ*
»sid’t
, size_ˆ*
m­³d
)

134 
	`m®loc_mu‹x_lock
(&
ba£_mtx
);

135 
	`as£¹
(
ba£_®loÿ‹d
 <ğ
ba£_»sid’t
);

136 
	`as£¹
(
ba£_»sid’t
 <ğ
ba£_m­³d
);

137 *
®loÿ‹d
 = 
ba£_®loÿ‹d
;

138 *
»sid’t
 = 
ba£_»sid’t
;

139 *
m­³d
 = 
ba£_m­³d
;

140 
	`m®loc_mu‹x_uÆock
(&
ba£_mtx
);

141 
	}
}

143 
boŞ


144 
	$ba£_boÙ
()

147 ià(
	`m®loc_mu‹x_š™
(&
ba£_mtx
))

148  (
Œue
);

149 
	`ex‹Á_Œ“_szad_Ãw
(&
ba£_ava_szad
);

150 
ba£_nodes
 = 
NULL
;

152  (
çl£
);

153 
	}
}

156 
	$ba£_´efÜk
()

159 
	`m®loc_mu‹x_´efÜk
(&
ba£_mtx
);

160 
	}
}

163 
	$ba£_po¡fÜk_·»Á
()

166 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
ba£_mtx
);

167 
	}
}

170 
	$ba£_po¡fÜk_chd
()

173 
	`m®loc_mu‹x_po¡fÜk_chd
(&
ba£_mtx
);

174 
	}
}

	@deps/jemalloc/src/bitmap.c

1 
	#JEMALLOC_BITMAP_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
	$b™m­_šfo_š™
(
b™m­_šfo_t
 *
bšfo
, 
size_t
 
nb™s
)

9 
i
;

10 
size_t
 
group_couÁ
;

12 
	`as£¹
(
nb™s
 > 0);

13 
	`as£¹
(
nb™s
 <ğ(
	`ZU
(1è<< 
LG_BITMAP_MAXBITS
));

20 
bšfo
->
Ëv–s
[0].
group_off£t
 = 0;

21 
group_couÁ
 = 
	`BITMAP_BITS2GROUPS
(
nb™s
);

22 
i
 = 1; 
group_couÁ
 > 1; i++) {

23 
	`as£¹
(
i
 < 
BITMAP_MAX_LEVELS
);

24 
bšfo
->
Ëv–s
[
i
].
group_off£t
 = binfo->levels[i-1].group_offset

25 + 
group_couÁ
;

26 
group_couÁ
 = 
	`BITMAP_BITS2GROUPS
(group_count);

28 
bšfo
->
Ëv–s
[
i
].
group_off£t
 = binfo->levels[i-1].group_offset

29 + 
group_couÁ
;

30 
	`as£¹
(
bšfo
->
Ëv–s
[
i
].
group_off£t
 <ğ
BITMAP_GROUPS_MAX
);

31 
bšfo
->
Æev–s
 = 
i
;

32 
bšfo
->
nb™s
 =‚bits;

33 
	}
}

35 
size_t


36 
	$b™m­_šfo_ngroups
(cÚ¡ 
b™m­_šfo_t
 *
bšfo
)

39  (
bšfo
->
Ëv–s
[bšfo->
Æev–s
].
group_off£t
 << 
LG_SIZEOF_BITMAP
);

40 
	}
}

42 
size_t


43 
	$b™m­_size
(
size_t
 
nb™s
)

45 
b™m­_šfo_t
 
bšfo
;

47 
	`b™m­_šfo_š™
(&
bšfo
, 
nb™s
);

48  (
	`b™m­_šfo_ngroups
(&
bšfo
));

49 
	}
}

52 
	$b™m­_š™
(
b™m­_t
 *
b™m­
, cÚ¡ 
b™m­_šfo_t
 *
bšfo
)

54 
size_t
 
exŒa
;

55 
i
;

64 
	`mem£t
(
b™m­
, 0xffU, 
bšfo
->
Ëv–s
[bšfo->
Æev–s
].
group_off£t
 <<

65 
LG_SIZEOF_BITMAP
);

66 
exŒa
 = (
BITMAP_GROUP_NBITS
 - (
bšfo
->
nb™s
 & 
BITMAP_GROUP_NBITS_MASK
))

67 & 
BITMAP_GROUP_NBITS_MASK
;

68 ià(
exŒa
 != 0)

69 
b™m­
[
bšfo
->
Ëv–s
[1].
group_off£t
 - 1] >>ğ
exŒa
;

70 
i
 = 1; i < 
bšfo
->
Æev–s
; i++) {

71 
size_t
 
group_couÁ
 = 
bšfo
->
Ëv–s
[
i
].
group_off£t
 -

72 
bšfo
->
Ëv–s
[
i
-1].
group_off£t
;

73 
exŒa
 = (
BITMAP_GROUP_NBITS
 - (
group_couÁ
 &

74 
BITMAP_GROUP_NBITS_MASK
)) & BITMAP_GROUP_NBITS_MASK;

75 ià(
exŒa
 != 0)

76 
b™m­
[
bšfo
->
Ëv–s
[
i
+1].
group_off£t
 - 1] >>ğ
exŒa
;

78 
	}
}

	@deps/jemalloc/src/chunk.c

1 
	#JEMALLOC_CHUNK_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 cÚ¡ *
	gİt_dss
 = 
DSS_DEFAULT
;

8 
size_t
 
	gİt_lg_chunk
 = 0;

11 
size_t
 
	gcurchunks
;

12 
size_t
 
	ghighchunks
;

14 
¹»e_t
 
	gchunks_¹»e
;

17 
size_t
 
	gchunksize
;

18 
size_t
 
	gchunksize_mask
;

19 
size_t
 
	gchunk_Åages
;

21 *
chunk_®loc_deçuÉ
(*
Ãw_addr
, 
size_t
 
size
,

22 
size_t
 
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
, 
¬’a_šd
);

23 
boŞ
 
chunk_d®loc_deçuÉ
(*
chunk
, 
size_t
 
size
, boŞ 
comm™‹d
,

24 
¬’a_šd
);

25 
boŞ
 
chunk_comm™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
,

26 
size_t
 
Ëngth
, 
¬’a_šd
);

27 
boŞ
 
chunk_decomm™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
,

28 
size_t
 
Ëngth
, 
¬’a_šd
);

29 
boŞ
 
chunk_purge_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
,

30 
size_t
 
Ëngth
, 
¬’a_šd
);

31 
boŞ
 
chunk_¥l™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
size_a
,

32 
size_t
 
size_b
, 
boŞ
 
comm™‹d
, 
¬’a_šd
);

33 
boŞ
 
chunk_m”ge_deçuÉ
(*
chunk_a
, 
size_t
 
size_a
, *
chunk_b
,

34 
size_t
 
size_b
, 
boŞ
 
comm™‹d
, 
¬’a_šd
);

36 cÚ¡ 
chunk_hooks_t
 
	gchunk_hooks_deçuÉ
 = {

37 
chunk_®loc_deçuÉ
,

38 
chunk_d®loc_deçuÉ
,

39 
chunk_comm™_deçuÉ
,

40 
chunk_decomm™_deçuÉ
,

41 
chunk_purge_deçuÉ
,

42 
chunk_¥l™_deçuÉ
,

43 
chunk_m”ge_deçuÉ


52 
chunk_»cÜd
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

53 
ex‹Á_Œ“_t
 *
chunks_szad
,ƒx‹Á_Œ“_ˆ*
chunks_ad
, 
boŞ
 
ÿche
,

54 *
chunk
, 
size_t
 
size
, 
boŞ
 
z”Ûd
, boŞ 
comm™‹d
);

58 
chunk_hooks_t


59 
	$chunk_hooks_g‘_locked
(
¬’a_t
 *
¬’a
)

62  (
¬’a
->
chunk_hooks
);

63 
	}
}

65 
chunk_hooks_t


66 
	$chunk_hooks_g‘
(
¬’a_t
 *
¬’a
)

68 
chunk_hooks_t
 
chunk_hooks
;

70 
	`m®loc_mu‹x_lock
(&
¬’a
->
chunks_mtx
);

71 
chunk_hooks
 = 
	`chunk_hooks_g‘_locked
(
¬’a
);

72 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
chunks_mtx
);

74  (
chunk_hooks
);

75 
	}
}

77 
chunk_hooks_t


78 
	$chunk_hooks_£t
(
¬’a_t
 *
¬’a
, cÚ¡ 
chunk_hooks_t
 *
chunk_hooks
)

80 
chunk_hooks_t
 
Şd_chunk_hooks
;

82 
	`m®loc_mu‹x_lock
(&
¬’a
->
chunks_mtx
);

83 
Şd_chunk_hooks
 = 
¬’a
->
chunk_hooks
;

91 
	#ATOMIC_COPY_HOOK
(
n
) do { \

93 
chunk_
##
n
##
_t
 **n; \

94 **
v
; \

95 } 
u
; \

96 
u
.
n
 = &
¬’a
->
chunk_hooks
.n; \

97 
	`©omic_wr™e_p
(
u
.
v
, 
chunk_hooks
->
n
); \

98 } 0)

	)

99 
	`ATOMIC_COPY_HOOK
(
®loc
);

100 
	`ATOMIC_COPY_HOOK
(
d®loc
);

101 
	`ATOMIC_COPY_HOOK
(
comm™
);

102 
	`ATOMIC_COPY_HOOK
(
decomm™
);

103 
	`ATOMIC_COPY_HOOK
(
purge
);

104 
	`ATOMIC_COPY_HOOK
(
¥l™
);

105 
	`ATOMIC_COPY_HOOK
(
m”ge
);

106 #undeà
ATOMIC_COPY_HOOK


107 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
chunks_mtx
);

109  (
Şd_chunk_hooks
);

110 
	}
}

113 
	$chunk_hooks_assu»_š™Ÿlized_im¶
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

114 
boŞ
 
locked
)

116 cÚ¡ 
chunk_hooks_t
 
unš™Ÿlized_hooks
 =

117 
CHUNK_HOOKS_INITIALIZER
;

119 ià(
	`memcmp
(
chunk_hooks
, &
unš™Ÿlized_hooks
, (
chunk_hooks_t
)) ==

121 *
chunk_hooks
 = 
locked
 ? 
	`chunk_hooks_g‘_locked
(
¬’a
) :

122 
	`chunk_hooks_g‘
(
¬’a
);

124 
	}
}

127 
	$chunk_hooks_assu»_š™Ÿlized_locked
(
¬’a_t
 *
¬’a
,

128 
chunk_hooks_t
 *
chunk_hooks
)

131 
	`chunk_hooks_assu»_š™Ÿlized_im¶
(
¬’a
, 
chunk_hooks
, 
Œue
);

132 
	}
}

135 
	$chunk_hooks_assu»_š™Ÿlized
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
)

138 
	`chunk_hooks_assu»_š™Ÿlized_im¶
(
¬’a
, 
chunk_hooks
, 
çl£
);

139 
	}
}

141 
boŞ


142 
	$chunk_»gi¡”
(cÚ¡ *
chunk
, cÚ¡ 
ex‹Á_node_t
 *
node
)

145 
	`as£¹
(
	`ex‹Á_node_addr_g‘
(
node
è=ğ
chunk
);

147 ià(
	`¹»e_£t
(&
chunks_¹»e
, (
ušŒ_t
)
chunk
, 
node
))

148  (
Œue
);

149 ià(
cÚfig_´of
 && 
İt_´of
) {

150 
size_t
 
size
 = 
	`ex‹Á_node_size_g‘
(
node
);

151 
size_t
 
Çdd
 = (
size
 =ğ0è? 1 : siz/ 
chunksize
;

152 
size_t
 
cur
 = 
	`©omic_add_z
(&
curchunks
, 
Çdd
);

153 
size_t
 
high
 = 
	`©omic_»ad_z
(&
highchunks
);

154 
cur
 > 
high
 && 
	`©omic_ÿs_z
(&
highchunks
, high, cur)) {

159 
high
 = 
	`©omic_»ad_z
(&
highchunks
);

161 ià(
cur
 > 
high
 && 
	`´of_gdump_g‘_uÆocked
())

162 
	`´of_gdump
();

165  (
çl£
);

166 
	}
}

169 
	$chunk_d”egi¡”
(cÚ¡ *
chunk
, cÚ¡ 
ex‹Á_node_t
 *
node
)

171 
boŞ
 
”r
;

173 
”r
 = 
	`¹»e_£t
(&
chunks_¹»e
, (
ušŒ_t
)
chunk
, 
NULL
);

174 
	`as£¹
(!
”r
);

175 ià(
cÚfig_´of
 && 
İt_´of
) {

176 
size_t
 
size
 = 
	`ex‹Á_node_size_g‘
(
node
);

177 
size_t
 
nsub
 = (
size
 =ğ0è? 1 : siz/ 
chunksize
;

178 
	`as£¹
(
	`©omic_»ad_z
(&
curchunks
è>ğ
nsub
);

179 
	`©omic_sub_z
(&
curchunks
, 
nsub
);

181 
	}
}

187 
ex‹Á_node_t
 *

188 
	$chunk_fœ¡_be¡_f™
(
¬’a_t
 *
¬’a
, 
ex‹Á_Œ“_t
 *
chunks_szad
,

189 
ex‹Á_Œ“_t
 *
chunks_ad
, 
size_t
 
size
)

191 
ex‹Á_node_t
 
key
;

193 
	`as£¹
(
size
 =ğ
	`CHUNK_CEILING
(size));

195 
	`ex‹Á_node_š™
(&
key
, 
¬’a
, 
NULL
, 
size
, 
çl£
, false);

196  (
	`ex‹Á_Œ“_szad_n£¬ch
(
chunks_szad
, &
key
));

197 
	}
}

200 
	$chunk_»cyşe
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

201 
ex‹Á_Œ“_t
 *
chunks_szad
,ƒx‹Á_Œ“_ˆ*
chunks_ad
, 
boŞ
 
ÿche
,

202 *
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
,

203 
boŞ
 
d®loc_node
)

205 *
»t
;

206 
ex‹Á_node_t
 *
node
;

207 
size_t
 
®loc_size
, 
Ëadsize
, 
Œasize
;

208 
boŞ
 
z”Ûd
, 
comm™‹d
;

210 
	`as£¹
(
Ãw_addr
 =ğ
NULL
 || 
®ignm’t
 =ğ
chunksize
);

216 
	`as£¹
(
d®loc_node
 || 
Ãw_addr
 !ğ
NULL
);

218 
®loc_size
 = 
	`CHUNK_CEILING
(
	`s2u
(
size
 + 
®ignm’t
 - 
chunksize
));

220 ià(
®loc_size
 < 
size
)

221  (
NULL
);

222 
	`m®loc_mu‹x_lock
(&
¬’a
->
chunks_mtx
);

223 
	`chunk_hooks_assu»_š™Ÿlized_locked
(
¬’a
, 
chunk_hooks
);

224 ià(
Ãw_addr
 !ğ
NULL
) {

225 
ex‹Á_node_t
 
key
;

226 
	`ex‹Á_node_š™
(&
key
, 
¬’a
, 
Ãw_addr
, 
®loc_size
, 
çl£
,

227 
çl£
);

228 
node
 = 
	`ex‹Á_Œ“_ad_£¬ch
(
chunks_ad
, &
key
);

230 
node
 = 
	`chunk_fœ¡_be¡_f™
(
¬’a
, 
chunks_szad
, 
chunks_ad
,

231 
®loc_size
);

233 ià(
node
 =ğ
NULL
 || (
Ãw_addr
 !ğNULL && 
	`ex‹Á_node_size_g‘
(node) <

234 
size
)) {

235 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
chunks_mtx
);

236  (
NULL
);

238 
Ëadsize
 = 
	`ALIGNMENT_CEILING
((
ušŒ_t
)
	`ex‹Á_node_addr_g‘
(
node
),

239 
®ignm’t
è- (
ušŒ_t
)
	`ex‹Á_node_addr_g‘
(
node
);

240 
	`as£¹
(
Ãw_addr
 =ğ
NULL
 || 
Ëadsize
 == 0);

241 
	`as£¹
(
	`ex‹Á_node_size_g‘
(
node
è>ğ
Ëadsize
 + 
size
);

242 
Œasize
 = 
	`ex‹Á_node_size_g‘
(
node
è- 
Ëadsize
 - 
size
;

243 
»t
 = (*)((
ušŒ_t
)
	`ex‹Á_node_addr_g‘
(
node
è+ 
Ëadsize
);

244 
z”Ûd
 = 
	`ex‹Á_node_z”Ûd_g‘
(
node
);

245 ià(
z”Ûd
)

246 *
z”o
 = 
Œue
;

247 
comm™‹d
 = 
	`ex‹Á_node_comm™‹d_g‘
(
node
);

248 ià(
comm™‹d
)

249 *
comm™
 = 
Œue
;

251 ià(
Ëadsize
 != 0 &&

252 
chunk_hooks
->
	`¥l™
(
	`ex‹Á_node_addr_g‘
(
node
),

253 
	`ex‹Á_node_size_g‘
(
node
), 
Ëadsize
, 
size
, 
çl£
, 
¬’a
->
šd
)) {

254 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
chunks_mtx
);

255  (
NULL
);

258 
	`ex‹Á_Œ“_szad_»move
(
chunks_szad
, 
node
);

259 
	`ex‹Á_Œ“_ad_»move
(
chunks_ad
, 
node
);

260 
	`¬’a_chunk_ÿche_maybe_»move
(
¬’a
, 
node
, 
ÿche
);

261 ià(
Ëadsize
 != 0) {

263 
	`ex‹Á_node_size_£t
(
node
, 
Ëadsize
);

264 
	`ex‹Á_Œ“_szad_š£¹
(
chunks_szad
, 
node
);

265 
	`ex‹Á_Œ“_ad_š£¹
(
chunks_ad
, 
node
);

266 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a
, 
node
, 
ÿche
);

267 
node
 = 
NULL
;

269 ià(
Œasize
 != 0) {

271 ià(
chunk_hooks
->
	`¥l™
(
»t
, 
size
 + 
Œasize
, size,

272 
Œasize
, 
çl£
, 
¬’a
->
šd
)) {

273 ià(
d®loc_node
 && 
node
 !ğ
NULL
)

274 
	`¬’a_node_d®loc
(
¬’a
, 
node
);

275 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
chunks_mtx
);

276 
	`chunk_»cÜd
(
¬’a
, 
chunk_hooks
, 
chunks_szad
, 
chunks_ad
,

277 
ÿche
, 
»t
, 
size
 + 
Œasize
, 
z”Ûd
, 
comm™‹d
);

278  (
NULL
);

281 ià(
node
 =ğ
NULL
) {

282 
node
 = 
	`¬’a_node_®loc
(
¬’a
);

283 ià(
node
 =ğ
NULL
) {

284 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
chunks_mtx
);

285 
	`chunk_»cÜd
(
¬’a
, 
chunk_hooks
, 
chunks_szad
,

286 
chunks_ad
, 
ÿche
, 
»t
, 
size
 + 
Œasize
,

287 
z”Ûd
, 
comm™‹d
);

288  (
NULL
);

291 
	`ex‹Á_node_š™
(
node
, 
¬’a
, (*)((
ušŒ_t
)(
»t
è+ 
size
),

292 
Œasize
, 
z”Ûd
, 
comm™‹d
);

293 
	`ex‹Á_Œ“_szad_š£¹
(
chunks_szad
, 
node
);

294 
	`ex‹Á_Œ“_ad_š£¹
(
chunks_ad
, 
node
);

295 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a
, 
node
, 
ÿche
);

296 
node
 = 
NULL
;

298 ià(!
comm™‹d
 && 
chunk_hooks
->
	`comm™
(
»t
, 
size
, 0, size, 
¬’a
->
šd
)) {

299 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
chunks_mtx
);

300 
	`chunk_»cÜd
(
¬’a
, 
chunk_hooks
, 
chunks_szad
, 
chunks_ad
, 
ÿche
,

301 
»t
, 
size
, 
z”Ûd
, 
comm™‹d
);

302  (
NULL
);

304 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
chunks_mtx
);

306 
	`as£¹
(
d®loc_node
 || 
node
 !ğ
NULL
);

307 ià(
d®loc_node
 && 
node
 !ğ
NULL
)

308 
	`¬’a_node_d®loc
(
¬’a
, 
node
);

309 ià(*
z”o
) {

310 ià(!
z”Ûd
)

311 
	`mem£t
(
»t
, 0, 
size
);

312 ià(
cÚfig_debug
) {

313 
size_t
 
i
;

314 
size_t
 *
p
 = (size_ˆ*)(
ušŒ_t
)
»t
;

316 
	`JEMALLOC_VALGRIND_MAKE_MEM_DEFINED
(
»t
, 
size
);

317 
i
 = 0; i < 
size
 / (
size_t
); i++)

318 
	`as£¹
(
p
[
i
] == 0);

321  (
»t
);

322 
	}
}

331 
	$chunk_®loc_cÜe
(
¬’a_t
 *
¬’a
, *
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
,

332 
boŞ
 *
z”o
, boŞ *
comm™
, 
dss_´ec_t
 
dss_´ec
)

334 *
»t
;

335 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

337 
	`as£¹
(
size
 != 0);

338 
	`as£¹
((
size
 & 
chunksize_mask
) == 0);

339 
	`as£¹
(
®ignm’t
 != 0);

340 
	`as£¹
((
®ignm’t
 & 
chunksize_mask
) == 0);

343 ià((
»t
 = 
	`chunk_»cyşe
(
¬’a
, &
chunk_hooks
,

344 &
¬’a
->
chunks_szad_»šed
, &¬’a->
chunks_ad_»šed
, 
çl£
,

345 
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
, 
comm™
, 
Œue
)è!ğ
NULL
)

346  (
»t
);

349 ià(
have_dss
 && 
dss_´ec
 =ğ
dss_´ec_´im¬y
 && (
»t
 =

350 
	`chunk_®loc_dss
(
¬’a
, 
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
, 
comm™
)) !=

351 
NULL
)

352  (
»t
);

357 ià(
Ãw_addr
 =ğ
NULL
 && (
»t
 = 
	`chunk_®loc_mm­
(
size
, 
®ignm’t
, 
z”o
,

358 
comm™
)è!ğ
NULL
)

359  (
»t
);

361 ià(
have_dss
 && 
dss_´ec
 =ğ
dss_´ec_£cÚd¬y
 && (
»t
 =

362 
	`chunk_®loc_dss
(
¬’a
, 
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
, 
comm™
)) !=

363 
NULL
)

364  (
»t
);

367  (
NULL
);

368 
	}
}

371 
	$chunk_®loc_ba£
(
size_t
 
size
)

373 *
»t
;

374 
boŞ
 
z”o
, 
comm™
;

381 
z”o
 = 
Œue
;

382 
comm™
 = 
Œue
;

383 
»t
 = 
	`chunk_®loc_mm­
(
size
, 
chunksize
, &
z”o
, &
comm™
);

384 ià(
»t
 =ğ
NULL
)

385  (
NULL
);

386 ià(
cÚfig_v®gršd
)

387 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
size
);

389  (
»t
);

390 
	}
}

393 
	$chunk_®loc_ÿche
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
, *
Ãw_addr
,

394 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ 
d®loc_node
)

396 *
»t
;

397 
boŞ
 
comm™
;

399 
	`as£¹
(
size
 != 0);

400 
	`as£¹
((
size
 & 
chunksize_mask
) == 0);

401 
	`as£¹
(
®ignm’t
 != 0);

402 
	`as£¹
((
®ignm’t
 & 
chunksize_mask
) == 0);

404 
comm™
 = 
Œue
;

405 
»t
 = 
	`chunk_»cyşe
(
¬’a
, 
chunk_hooks
, &¬’a->
chunks_szad_ÿched
,

406 &
¬’a
->
chunks_ad_ÿched
, 
Œue
, 
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
,

407 &
comm™
, 
d®loc_node
);

408 ià(
»t
 =ğ
NULL
)

409  (
NULL
);

410 
	`as£¹
(
comm™
);

411 ià(
cÚfig_v®gršd
)

412 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
size
);

413  (
»t
);

414 
	}
}

416 
¬’a_t
 *

417 
	$chunk_¬’a_g‘
(
¬’a_šd
)

419 
¬’a_t
 *
¬’a
;

422 
¬’a
 = (
¬’a_šd
 =ğ0è? 
	`a0g‘
(è: 
	`¬’a_g‘
(
	`tsd_ãtch
(),‡rena_ind,

423 
çl£
, 
Œue
);

428 
	`as£¹
(
¬’a
 !ğ
NULL
);

429  (
¬’a
);

430 
	}
}

433 
	$chunk_®loc_deçuÉ
(*
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
,

434 
boŞ
 *
comm™
, 
¬’a_šd
)

436 *
»t
;

437 
¬’a_t
 *
¬’a
;

439 
¬’a
 = 
	`chunk_¬’a_g‘
(
¬’a_šd
);

440 
»t
 = 
	`chunk_®loc_cÜe
(
¬’a
, 
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
,

441 
comm™
, 
¬’a
->
dss_´ec
);

442 ià(
»t
 =ğ
NULL
)

443  (
NULL
);

444 ià(
cÚfig_v®gršd
)

445 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
size
);

447  (
»t
);

448 
	}
}

451 
	$chunk_®loc_w¿µ”
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
, *
Ãw_addr
,

452 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
)

454 *
»t
;

456 
	`chunk_hooks_assu»_š™Ÿlized
(
¬’a
, 
chunk_hooks
);

457 
»t
 = 
chunk_hooks
->
	`®loc
(
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
, 
comm™
,

458 
¬’a
->
šd
);

459 ià(
»t
 =ğ
NULL
)

460  (
NULL
);

461 ià(
cÚfig_v®gršd
 && 
chunk_hooks
->
®loc
 !ğ
chunk_®loc_deçuÉ
)

462 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(
»t
, 
chunksize
);

463  (
»t
);

464 
	}
}

467 
	$chunk_»cÜd
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
,

468 
ex‹Á_Œ“_t
 *
chunks_szad
,ƒx‹Á_Œ“_ˆ*
chunks_ad
, 
boŞ
 
ÿche
,

469 *
chunk
, 
size_t
 
size
, 
boŞ
 
z”Ûd
, boŞ 
comm™‹d
)

471 
boŞ
 
unz”Ûd
;

472 
ex‹Á_node_t
 *
node
, *
´ev
;

473 
ex‹Á_node_t
 
key
;

475 
	`as£¹
(!
ÿche
 || !
z”Ûd
);

476 
unz”Ûd
 = 
ÿche
 || !
z”Ûd
;

477 
	`JEMALLOC_VALGRIND_MAKE_MEM_NOACCESS
(
chunk
, 
size
);

479 
	`m®loc_mu‹x_lock
(&
¬’a
->
chunks_mtx
);

480 
	`chunk_hooks_assu»_š™Ÿlized_locked
(
¬’a
, 
chunk_hooks
);

481 
	`ex‹Á_node_š™
(&
key
, 
¬’a
, (*)((
ušŒ_t
)
chunk
 + 
size
), 0,

482 
çl£
, false);

483 
node
 = 
	`ex‹Á_Œ“_ad_n£¬ch
(
chunks_ad
, &
key
);

485 ià(
node
 !ğ
NULL
 && 
	`ex‹Á_node_addr_g‘
(node) ==

486 
	`ex‹Á_node_addr_g‘
(&
key
è&& 
	`ex‹Á_node_comm™‹d_g‘
(
node
) ==

487 
comm™‹d
 && !
chunk_hooks
->
	`m”ge
(
chunk
, 
size
,

488 
	`ex‹Á_node_addr_g‘
(
node
), 
	`ex‹Á_node_size_g‘
Òode), 
çl£
,

489 
¬’a
->
šd
)) {

495 
	`ex‹Á_Œ“_szad_»move
(
chunks_szad
, 
node
);

496 
	`¬’a_chunk_ÿche_maybe_»move
(
¬’a
, 
node
, 
ÿche
);

497 
	`ex‹Á_node_addr_£t
(
node
, 
chunk
);

498 
	`ex‹Á_node_size_£t
(
node
, 
size
 + 
	`ex‹Á_node_size_g‘
(node));

499 
	`ex‹Á_node_z”Ûd_£t
(
node
, 
	`ex‹Á_node_z”Ûd_g‘
(node) &&

500 !
unz”Ûd
);

501 
	`ex‹Á_Œ“_szad_š£¹
(
chunks_szad
, 
node
);

502 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a
, 
node
, 
ÿche
);

505 
node
 = 
	`¬’a_node_®loc
(
¬’a
);

506 ià(
node
 =ğ
NULL
) {

513 ià(
ÿche
) {

514 
	`chunk_purge_w¿µ”
(
¬’a
, 
chunk_hooks
, 
chunk
,

515 
size
, 0, size);

517 
Ïb–_»tuº
;

519 
	`ex‹Á_node_š™
(
node
, 
¬’a
, 
chunk
, 
size
, !
unz”Ûd
,

520 
comm™‹d
);

521 
	`ex‹Á_Œ“_ad_š£¹
(
chunks_ad
, 
node
);

522 
	`ex‹Á_Œ“_szad_š£¹
(
chunks_szad
, 
node
);

523 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a
, 
node
, 
ÿche
);

527 
´ev
 = 
	`ex‹Á_Œ“_ad_´ev
(
chunks_ad
, 
node
);

528 ià(
´ev
 !ğ
NULL
 && (*)((
ušŒ_t
)
	`ex‹Á_node_addr_g‘
(prev) +

529 
	`ex‹Á_node_size_g‘
(
´ev
)è=ğ
chunk
 &&

530 
	`ex‹Á_node_comm™‹d_g‘
(
´ev
è=ğ
comm™‹d
 &&

531 !
chunk_hooks
->
	`m”ge
(
	`ex‹Á_node_addr_g‘
(
´ev
),

532 
	`ex‹Á_node_size_g‘
(
´ev
), 
chunk
, 
size
, 
çl£
, 
¬’a
->
šd
)) {

538 
	`ex‹Á_Œ“_szad_»move
(
chunks_szad
, 
´ev
);

539 
	`ex‹Á_Œ“_ad_»move
(
chunks_ad
, 
´ev
);

540 
	`¬’a_chunk_ÿche_maybe_»move
(
¬’a
, 
´ev
, 
ÿche
);

541 
	`ex‹Á_Œ“_szad_»move
(
chunks_szad
, 
node
);

542 
	`¬’a_chunk_ÿche_maybe_»move
(
¬’a
, 
node
, 
ÿche
);

543 
	`ex‹Á_node_addr_£t
(
node
, 
	`ex‹Á_node_addr_g‘
(
´ev
));

544 
	`ex‹Á_node_size_£t
(
node
, 
	`ex‹Á_node_size_g‘
(
´ev
) +

545 
	`ex‹Á_node_size_g‘
(
node
));

546 
	`ex‹Á_node_z”Ûd_£t
(
node
, 
	`ex‹Á_node_z”Ûd_g‘
(
´ev
) &&

547 
	`ex‹Á_node_z”Ûd_g‘
(
node
));

548 
	`ex‹Á_Œ“_szad_š£¹
(
chunks_szad
, 
node
);

549 
	`¬’a_chunk_ÿche_maybe_š£¹
(
¬’a
, 
node
, 
ÿche
);

551 
	`¬’a_node_d®loc
(
¬’a
, 
´ev
);

554 
Ïb–_»tuº
:

555 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
chunks_mtx
);

556 
	}
}

559 
	$chunk_d®loc_ÿche
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
, *
chunk
,

560 
size_t
 
size
, 
boŞ
 
comm™‹d
)

563 
	`as£¹
(
chunk
 !ğ
NULL
);

564 
	`as£¹
(
	`CHUNK_ADDR2BASE
(
chunk
) == chunk);

565 
	`as£¹
(
size
 != 0);

566 
	`as£¹
((
size
 & 
chunksize_mask
) == 0);

568 
	`chunk_»cÜd
(
¬’a
, 
chunk_hooks
, &¬’a->
chunks_szad_ÿched
,

569 &
¬’a
->
chunks_ad_ÿched
, 
Œue
, 
chunk
, 
size
, 
çl£
, 
comm™‹d
);

570 
	`¬’a_maybe_purge
(
¬’a
);

571 
	}
}

574 
	$chunk_d®loc_¬’a
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
, *
chunk
,

575 
size_t
 
size
, 
boŞ
 
z”Ûd
, boŞ 
comm™‹d
)

578 
	`as£¹
(
chunk
 !ğ
NULL
);

579 
	`as£¹
(
	`CHUNK_ADDR2BASE
(
chunk
) == chunk);

580 
	`as£¹
(
size
 != 0);

581 
	`as£¹
((
size
 & 
chunksize_mask
) == 0);

583 
	`chunk_hooks_assu»_š™Ÿlized
(
¬’a
, 
chunk_hooks
);

585 ià(!
chunk_hooks
->
	`d®loc
(
chunk
, 
size
, 
comm™‹d
, 
¬’a
->
šd
))

588 ià(
comm™‹d
) {

589 
comm™‹d
 = 
chunk_hooks
->
	`decomm™
(
chunk
, 
size
, 0, size,

590 
¬’a
->
šd
);

592 
z”Ûd
 = !
comm™‹d
 || !
chunk_hooks
->
	`purge
(
chunk
, 
size
, 0, size,

593 
¬’a
->
šd
);

594 
	`chunk_»cÜd
(
¬’a
, 
chunk_hooks
, &¬’a->
chunks_szad_»šed
,

595 &
¬’a
->
chunks_ad_»šed
, 
çl£
, 
chunk
, 
size
, 
z”Ûd
, 
comm™‹d
);

596 
	}
}

598 
boŞ


599 
	$chunk_d®loc_deçuÉ
(*
chunk
, 
size_t
 
size
, 
boŞ
 
comm™‹d
,

600 
¬’a_šd
)

603 ià(!
have_dss
 || !
	`chunk_š_dss
(
chunk
))

604  (
	`chunk_d®loc_mm­
(
chunk
, 
size
));

605  (
Œue
);

606 
	}
}

609 
	$chunk_d®loc_w¿µ”
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
, *
chunk
,

610 
size_t
 
size
, 
boŞ
 
comm™‹d
)

613 
	`chunk_hooks_assu»_š™Ÿlized
(
¬’a
, 
chunk_hooks
);

614 
chunk_hooks
->
	`d®loc
(
chunk
, 
size
, 
comm™‹d
, 
¬’a
->
šd
);

615 ià(
cÚfig_v®gršd
 && 
chunk_hooks
->
d®loc
 !ğ
chunk_d®loc_deçuÉ
)

616 
	`JEMALLOC_VALGRIND_MAKE_MEM_NOACCESS
(
chunk
, 
size
);

617 
	}
}

619 
boŞ


620 
	$chunk_comm™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

621 
¬’a_šd
)

624  (
	`·ges_comm™
((*)((
ušŒ_t
)
chunk
 + (ušŒ_t)
off£t
),

625 
Ëngth
));

626 
	}
}

628 
boŞ


629 
	$chunk_decomm™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

630 
¬’a_šd
)

633  (
	`·ges_decomm™
((*)((
ušŒ_t
)
chunk
 + (ušŒ_t)
off£t
),

634 
Ëngth
));

635 
	}
}

637 
boŞ


638 
	$chunk_purge_¬’a
(
¬’a_t
 *
¬’a
, *
chunk
, 
size_t
 
off£t
, size_ˆ
Ëngth
)

641 
	`as£¹
(
chunk
 !ğ
NULL
);

642 
	`as£¹
(
	`CHUNK_ADDR2BASE
(
chunk
) == chunk);

643 
	`as£¹
((
off£t
 & 
PAGE_MASK
) == 0);

644 
	`as£¹
(
Ëngth
 != 0);

645 
	`as£¹
((
Ëngth
 & 
PAGE_MASK
) == 0);

647  (
	`·ges_purge
((*)((
ušŒ_t
)
chunk
 + (ušŒ_t)
off£t
),

648 
Ëngth
));

649 
	}
}

651 
boŞ


652 
	$chunk_purge_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

653 
¬’a_šd
)

656  (
	`chunk_purge_¬’a
(
	`chunk_¬’a_g‘
(
¬’a_šd
), 
chunk
, 
off£t
,

657 
Ëngth
));

658 
	}
}

660 
boŞ


661 
	$chunk_purge_w¿µ”
(
¬’a_t
 *
¬’a
, 
chunk_hooks_t
 *
chunk_hooks
, *
chunk
,

662 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
)

665 
	`chunk_hooks_assu»_š™Ÿlized
(
¬’a
, 
chunk_hooks
);

666  (
chunk_hooks
->
	`purge
(
chunk
, 
size
, 
off£t
, 
Ëngth
, 
¬’a
->
šd
));

667 
	}
}

669 
boŞ


670 
	$chunk_¥l™_deçuÉ
(*
chunk
, 
size_t
 
size
, size_ˆ
size_a
, size_ˆ
size_b
,

671 
boŞ
 
comm™‹d
, 
¬’a_šd
)

674 ià(!
m­s_cßËsû
)

675  (
Œue
);

676  (
çl£
);

677 
	}
}

679 
boŞ


680 
	$chunk_m”ge_deçuÉ
(*
chunk_a
, 
size_t
 
size_a
, *
chunk_b
, size_ˆ
size_b
,

681 
boŞ
 
comm™‹d
, 
¬’a_šd
)

684 ià(!
m­s_cßËsû
)

685  (
Œue
);

686 ià(
have_dss
 && 
	`chunk_š_dss
(
chunk_a
è!ğchunk_š_dss(
chunk_b
))

687  (
Œue
);

689  (
çl£
);

690 
	}
}

692 
¹»e_node_–m_t
 *

693 
	$chunks_¹»e_node_®loc
(
size_t
 
Ãlms
)

696  ((
¹»e_node_–m_t
 *)
	`ba£_®loc
(
Ãlms
 *

697 (
¹»e_node_–m_t
)));

698 
	}
}

700 
boŞ


701 
	$chunk_boÙ
()

703 #ifdeà
_WIN32


704 
SYSTEM_INFO
 
šfo
;

705 
	`G‘Sy¡emInfo
(&
šfo
);

711 ià(
šfo
.
dwPageSize
 & ((1U << 
LG_PAGE
) - 1))

712  (
Œue
);

718 ià(!
İt_lg_chunk
) {

719 
İt_lg_chunk
 = 
	`jem®loc_ffs
(()
šfo
.
dwAÎoÿtiÚG¿nuÏr™y
)

723 ià(!
İt_lg_chunk
)

724 
İt_lg_chunk
 = 
LG_CHUNK_DEFAULT
;

728 
chunksize
 = (
	`ZU
(1è<< 
İt_lg_chunk
);

729 
	`as£¹
(
chunksize
 >ğ
PAGE
);

730 
chunksize_mask
 = 
chunksize
 - 1;

731 
chunk_Åages
 = (
chunksize
 >> 
LG_PAGE
);

733 ià(
have_dss
 && 
	`chunk_dss_boÙ
())

734  (
Œue
);

735 ià(
	`¹»e_Ãw
(&
chunks_¹»e
, (
	`ZU
(1è<< (
LG_SIZEOF_PTR
+3)) -

736 
İt_lg_chunk
, 
chunks_¹»e_node_®loc
, 
NULL
))

737  (
Œue
);

739  (
çl£
);

740 
	}
}

743 
	$chunk_´efÜk
()

746 
	`chunk_dss_´efÜk
();

747 
	}
}

750 
	$chunk_po¡fÜk_·»Á
()

753 
	`chunk_dss_po¡fÜk_·»Á
();

754 
	}
}

757 
	$chunk_po¡fÜk_chd
()

760 
	`chunk_dss_po¡fÜk_chd
();

761 
	}
}

	@deps/jemalloc/src/chunk_dss.c

1 
	#JEMALLOC_CHUNK_DSS_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

6 cÚ¡ *
	gdss_´ec_Çmes
[] = {

14 
dss_´ec_t
 
	gdss_´ec_deçuÉ
 = 
DSS_PREC_DEFAULT
;

20 
m®loc_mu‹x_t
 
	gdss_mtx
;

23 *
	gdss_ba£
;

25 *
	gdss_´ev
;

27 *
	gdss_max
;

32 
	$chunk_dss_sbrk
(
šŒ_t
 
šüem’t
)

35 #ifdeà
JEMALLOC_DSS


36  (
	`sbrk
(
šüem’t
));

38 
	`nÙ_im¶em’‹d
();

39  (
NULL
);

41 
	}
}

43 
dss_´ec_t


44 
	$chunk_dss_´ec_g‘
()

46 
dss_´ec_t
 
»t
;

48 ià(!
have_dss
)

49  (
dss_´ec_di§bËd
);

50 
	`m®loc_mu‹x_lock
(&
dss_mtx
);

51 
»t
 = 
dss_´ec_deçuÉ
;

52 
	`m®loc_mu‹x_uÆock
(&
dss_mtx
);

53  (
»t
);

54 
	}
}

56 
boŞ


57 
	$chunk_dss_´ec_£t
(
dss_´ec_t
 
dss_´ec
)

60 ià(!
have_dss
)

61  (
dss_´ec
 !ğ
dss_´ec_di§bËd
);

62 
	`m®loc_mu‹x_lock
(&
dss_mtx
);

63 
dss_´ec_deçuÉ
 = 
dss_´ec
;

64 
	`m®loc_mu‹x_uÆock
(&
dss_mtx
);

65  (
çl£
);

66 
	}
}

69 
	$chunk_®loc_dss
(
¬’a_t
 *
¬’a
, *
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
,

70 
boŞ
 *
z”o
, boŞ *
comm™
)

72 
	`ÿs£¹
(
have_dss
);

73 
	`as£¹
(
size
 > 0 && (siz& 
chunksize_mask
) == 0);

74 
	`as£¹
(
®ignm’t
 > 0 && (®ignm’ˆ& 
chunksize_mask
) == 0);

80 ià((
šŒ_t
)
size
 < 0)

81  (
NULL
);

83 
	`m®loc_mu‹x_lock
(&
dss_mtx
);

84 ià(
dss_´ev
 != (*)-1) {

92 *
»t
, *
ıad
, *
dss_Ãxt
;

93 
size_t
 
g­_size
, 
ıad_size
;

94 
šŒ_t
 
šü
;

96 ià(
Ãw_addr
 !ğ
NULL
 && 
dss_max
 !=‚ew_addr)

100 
dss_max
 = 
	`chunk_dss_sbrk
(0);

103 ià(
Ãw_addr
 !ğ
NULL
 && 
dss_max
 !=‚ew_addr)

110 
g­_size
 = (
chunksize
 - 
	`CHUNK_ADDR2OFFSET
(
dss_max
)) &

111 
chunksize_mask
;

117 
ıad
 = (*)((
ušŒ_t
)
dss_max
 + 
g­_size
);

118 
»t
 = (*)
	`ALIGNMENT_CEILING
((
ušŒ_t
)
dss_max
,

119 
®ignm’t
);

120 
ıad_size
 = (
ušŒ_t
)
»t
 - (ušŒ_t)
ıad
;

121 
dss_Ãxt
 = (*)((
ušŒ_t
)
»t
 + 
size
);

122 ià((
ušŒ_t
)
»t
 < (ušŒ_t)
dss_max
 ||

123 (
ušŒ_t
)
dss_Ãxt
 < (ušŒ_t)
dss_max
) {

125 
	`m®loc_mu‹x_uÆock
(&
dss_mtx
);

126  (
NULL
);

128 
šü
 = 
g­_size
 + 
ıad_size
 + 
size
;

129 
dss_´ev
 = 
	`chunk_dss_sbrk
(
šü
);

130 ià(
dss_´ev
 =ğ
dss_max
) {

132 
dss_max
 = 
dss_Ãxt
;

133 
	`m®loc_mu‹x_uÆock
(&
dss_mtx
);

134 ià(
ıad_size
 != 0) {

135 
chunk_hooks_t
 
chunk_hooks
 =

136 
CHUNK_HOOKS_INITIALIZER
;

137 
	`chunk_d®loc_w¿µ”
(
¬’a
,

138 &
chunk_hooks
, 
ıad
, 
ıad_size
,

139 
Œue
);

141 ià(*
z”o
) {

142 
	`JEMALLOC_VALGRIND_MAKE_MEM_UNDEFINED
(

143 
»t
, 
size
);

144 
	`mem£t
(
»t
, 0, 
size
);

146 ià(!*
comm™
)

147 *
comm™
 = 
	`·ges_decomm™
(
»t
, 
size
);

148  (
»t
);

150 } 
dss_´ev
 != (*)-1);

152 
	`m®loc_mu‹x_uÆock
(&
dss_mtx
);

154  (
NULL
);

155 
	}
}

157 
boŞ


158 
	$chunk_š_dss
(*
chunk
)

160 
boŞ
 
»t
;

162 
	`ÿs£¹
(
have_dss
);

164 
	`m®loc_mu‹x_lock
(&
dss_mtx
);

165 ià((
ušŒ_t
)
chunk
 >ğ(ušŒ_t)
dss_ba£


166 && (
ušŒ_t
)
chunk
 < (ušŒ_t)
dss_max
)

167 
»t
 = 
Œue
;

169 
»t
 = 
çl£
;

170 
	`m®loc_mu‹x_uÆock
(&
dss_mtx
);

172  (
»t
);

173 
	}
}

175 
boŞ


176 
	$chunk_dss_boÙ
()

179 
	`ÿs£¹
(
have_dss
);

181 ià(
	`m®loc_mu‹x_š™
(&
dss_mtx
))

182  (
Œue
);

183 
dss_ba£
 = 
	`chunk_dss_sbrk
(0);

184 
dss_´ev
 = 
dss_ba£
;

185 
dss_max
 = 
dss_ba£
;

187  (
çl£
);

188 
	}
}

191 
	$chunk_dss_´efÜk
()

194 ià(
have_dss
)

195 
	`m®loc_mu‹x_´efÜk
(&
dss_mtx
);

196 
	}
}

199 
	$chunk_dss_po¡fÜk_·»Á
()

202 ià(
have_dss
)

203 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
dss_mtx
);

204 
	}
}

207 
	$chunk_dss_po¡fÜk_chd
()

210 ià(
have_dss
)

211 
	`m®loc_mu‹x_po¡fÜk_chd
(&
dss_mtx
);

212 
	}
}

	@deps/jemalloc/src/chunk_mmap.c

1 
	#JEMALLOC_CHUNK_MMAP_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
	$chunk_®loc_mm­_¦ow
(
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
)

9 *
»t
;

10 
size_t
 
®loc_size
;

12 
®loc_size
 = 
size
 + 
®ignm’t
 - 
PAGE
;

14 ià(
®loc_size
 < 
size
)

15  (
NULL
);

17 *
·ges
;

18 
size_t
 
Ëadsize
;

19 
·ges
 = 
	`·ges_m­
(
NULL
, 
®loc_size
);

20 ià(
·ges
 =ğ
NULL
)

21  (
NULL
);

22 
Ëadsize
 = 
	`ALIGNMENT_CEILING
((
ušŒ_t
)
·ges
, 
®ignm’t
) -

23 (
ušŒ_t
)
·ges
;

24 
»t
 = 
	`·ges_Œim
(
·ges
, 
®loc_size
, 
Ëadsize
, 
size
);

25 } 
»t
 =ğ
NULL
);

27 
	`as£¹
(
»t
 !ğ
NULL
);

28 *
z”o
 = 
Œue
;

29 ià(!*
comm™
)

30 *
comm™
 = 
	`·ges_decomm™
(
»t
, 
size
);

31  (
»t
);

32 
	}
}

35 
	$chunk_®loc_mm­
(
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
, boŞ *
comm™
)

37 *
»t
;

38 
size_t
 
off£t
;

53 
	`as£¹
(
®ignm’t
 != 0);

54 
	`as£¹
((
®ignm’t
 & 
chunksize_mask
) == 0);

56 
»t
 = 
	`·ges_m­
(
NULL
, 
size
);

57 ià(
»t
 =ğ
NULL
)

58  (
NULL
);

59 
off£t
 = 
	`ALIGNMENT_ADDR2OFFSET
(
»t
, 
®ignm’t
);

60 ià(
off£t
 != 0) {

61 
	`·ges_unm­
(
»t
, 
size
);

62  (
	`chunk_®loc_mm­_¦ow
(
size
, 
®ignm’t
, 
z”o
, 
comm™
));

65 
	`as£¹
(
»t
 !ğ
NULL
);

66 *
z”o
 = 
Œue
;

67 ià(!*
comm™
)

68 *
comm™
 = 
	`·ges_decomm™
(
»t
, 
size
);

69  (
»t
);

70 
	}
}

72 
boŞ


73 
	$chunk_d®loc_mm­
(*
chunk
, 
size_t
 
size
)

76 ià(
cÚfig_munm­
)

77 
	`·ges_unm­
(
chunk
, 
size
);

79  (!
cÚfig_munm­
);

80 
	}
}

	@deps/jemalloc/src/ckh.c

37 
	#JEMALLOC_CKH_C_


	)

38 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

43 
boŞ
 
ckh_grow
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
);

44 
ckh_shršk
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
);

52 
JEMALLOC_INLINE_C
 
size_t


53 
	$ckh_buck‘_£¬ch
(
ckh_t
 *
ckh
, 
size_t
 
buck‘
, cÚ¡ *
key
)

55 
ckhc_t
 *
ûÎ
;

56 
i
;

58 
i
 = 0; i < (
	`ZU
(1è<< 
LG_CKH_BUCKET_CELLS
); i++) {

59 
ûÎ
 = &
ckh
->
b
[(
buck‘
 << 
LG_CKH_BUCKET_CELLS
è+ 
i
];

60 ià(
ûÎ
->
key
 !ğ
NULL
 && 
ckh
->
	`keycomp
(key, cell->key))

61  ((
buck‘
 << 
LG_CKH_BUCKET_CELLS
è+ 
i
);

64  (
SIZE_T_MAX
);

65 
	}
}

70 
JEMALLOC_INLINE_C
 
size_t


71 
	$ckh_i£¬ch
(
ckh_t
 *
ckh
, cÚ¡ *
key
)

73 
size_t
 
hashes
[2], 
buck‘
, 
ûÎ
;

75 
	`as£¹
(
ckh
 !ğ
NULL
);

77 
ckh
->
	`hash
(
key
, 
hashes
);

80 
buck‘
 = 
hashes
[0] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
) - 1);

81 
ûÎ
 = 
	`ckh_buck‘_£¬ch
(
ckh
, 
buck‘
, 
key
);

82 ià(
ûÎ
 !ğ
SIZE_T_MAX
)

83  (
ûÎ
);

86 
buck‘
 = 
hashes
[1] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
) - 1);

87 
ûÎ
 = 
	`ckh_buck‘_£¬ch
(
ckh
, 
buck‘
, 
key
);

88  (
ûÎ
);

89 
	}
}

91 
JEMALLOC_INLINE_C
 
boŞ


92 
	$ckh_Œy_buck‘_š£¹
(
ckh_t
 *
ckh
, 
size_t
 
buck‘
, cÚ¡ *
key
,

93 cÚ¡ *
d©a
)

95 
ckhc_t
 *
ûÎ
;

96 
off£t
, 
i
;

102 
	`´ng32
(
off£t
, 
LG_CKH_BUCKET_CELLS
, 
ckh
->
´ng_¡©e
, 
CKH_A
, 
CKH_C
);

103 
i
 = 0; i < (
	`ZU
(1è<< 
LG_CKH_BUCKET_CELLS
); i++) {

104 
ûÎ
 = &
ckh
->
b
[(
buck‘
 << 
LG_CKH_BUCKET_CELLS
) +

105 ((
i
 + 
off£t
è& ((
	`ZU
(1è<< 
LG_CKH_BUCKET_CELLS
) - 1))];

106 ià(
ûÎ
->
key
 =ğ
NULL
) {

107 
ûÎ
->
key
 = key;

108 
ûÎ
->
d©a
 = data;

109 
ckh
->
couÁ
++;

110  (
çl£
);

114  (
Œue
);

115 
	}
}

123 
JEMALLOC_INLINE_C
 
boŞ


124 
	$ckh_eviù_»loc_š£¹
(
ckh_t
 *
ckh
, 
size_t
 
¬gbuck‘
, cÚ¡ **
¬gkey
,

125 cÚ¡ **
¬gd©a
)

127 cÚ¡ *
key
, *
d©a
, *
tkey
, *
td©a
;

128 
ckhc_t
 *
ûÎ
;

129 
size_t
 
hashes
[2], 
buck‘
, 
tbuck‘
;

130 
i
;

132 
buck‘
 = 
¬gbuck‘
;

133 
key
 = *
¬gkey
;

134 
d©a
 = *
¬gd©a
;

135 
Œue
) {

144 
	`´ng32
(
i
, 
LG_CKH_BUCKET_CELLS
, 
ckh
->
´ng_¡©e
, 
CKH_A
, 
CKH_C
);

145 
ûÎ
 = &
ckh
->
b
[(
buck‘
 << 
LG_CKH_BUCKET_CELLS
è+ 
i
];

146 
	`as£¹
(
ûÎ
->
key
 !ğ
NULL
);

149 
tkey
 = 
ûÎ
->
key
; 
td©a
 = c–l->
d©a
;

150 
ûÎ
->
key
 = key; c–l->
d©a
 = data;

151 
key
 = 
tkey
; 
d©a
 = 
td©a
;

153 #ifdeà
CKH_COUNT


154 
ckh
->
Ä–ocs
++;

158 
ckh
->
	`hash
(
key
, 
hashes
);

159 
tbuck‘
 = 
hashes
[1] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
) - 1);

160 ià(
tbuck‘
 =ğ
buck‘
) {

161 
tbuck‘
 = 
hashes
[0] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
)

181 ià(
tbuck‘
 =ğ
¬gbuck‘
) {

182 *
¬gkey
 = 
key
;

183 *
¬gd©a
 = 
d©a
;

184  (
Œue
);

187 
buck‘
 = 
tbuck‘
;

188 ià(!
	`ckh_Œy_buck‘_š£¹
(
ckh
, 
buck‘
, 
key
, 
d©a
))

189  (
çl£
);

191 
	}
}

193 
JEMALLOC_INLINE_C
 
boŞ


194 
	$ckh_Œy_š£¹
(
ckh_t
 *
ckh
, cÚ¡**
¬gkey
, cÚ¡**
¬gd©a
)

196 
size_t
 
hashes
[2], 
buck‘
;

197 cÚ¡ *
key
 = *
¬gkey
;

198 cÚ¡ *
d©a
 = *
¬gd©a
;

200 
ckh
->
	`hash
(
key
, 
hashes
);

203 
buck‘
 = 
hashes
[0] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
) - 1);

204 ià(!
	`ckh_Œy_buck‘_š£¹
(
ckh
, 
buck‘
, 
key
, 
d©a
))

205  (
çl£
);

208 
buck‘
 = 
hashes
[1] & ((
	`ZU
(1è<< 
ckh
->
lg_curbuck‘s
) - 1);

209 ià(!
	`ckh_Œy_buck‘_š£¹
(
ckh
, 
buck‘
, 
key
, 
d©a
))

210  (
çl£
);

215  (
	`ckh_eviù_»loc_š£¹
(
ckh
, 
buck‘
, 
¬gkey
, 
¬gd©a
));

216 
	}
}

222 
JEMALLOC_INLINE_C
 
boŞ


223 
	$ckh_»bud
(
ckh_t
 *
ckh
, 
ckhc_t
 *
aTab
)

225 
size_t
 
couÁ
, 
i
, 
nšs
;

226 cÚ¡ *
key
, *
d©a
;

228 
couÁ
 = 
ckh
->count;

229 
ckh
->
couÁ
 = 0;

230 
i
 = 
nšs
 = 0;‚š < 
couÁ
; i++) {

231 ià(
aTab
[
i
].
key
 !ğ
NULL
) {

232 
key
 = 
aTab
[
i
].key;

233 
d©a
 = 
aTab
[
i
].data;

234 ià(
	`ckh_Œy_š£¹
(
ckh
, &
key
, &
d©a
)) {

235 
ckh
->
couÁ
 = count;

236  (
Œue
);

238 
nšs
++;

242  (
çl£
);

243 
	}
}

245 
boŞ


246 
	$ckh_grow
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
)

248 
boŞ
 
»t
;

249 
ckhc_t
 *
b
, *
‰ab
;

250 
size_t
 
lg_curûÎs
;

251 
lg_´evbuck‘s
;

253 #ifdeà
CKH_COUNT


254 
ckh
->
ngrows
++;

262 
lg_´evbuck‘s
 = 
ckh
->
lg_curbuck‘s
;

263 
lg_curûÎs
 = 
ckh
->
lg_curbuck‘s
 + 
LG_CKH_BUCKET_CELLS
;

264 
Œue
) {

265 
size_t
 
usize
;

267 
lg_curûÎs
++;

268 
usize
 = 
	`§2u
((
ckhc_t
è<< 
lg_curûÎs
, 
CACHELINE
);

269 ià(
usize
 == 0) {

270 
»t
 = 
Œue
;

271 
Ïb–_»tuº
;

273 
b
 = (
ckhc_t
 *)
	`®locztm
(
tsd
, 
usize
, 
CACHELINE
, 
Œue
, 
NULL
,

274 
Œue
, 
NULL
);

275 ià(
b
 =ğ
NULL
) {

276 
»t
 = 
Œue
;

277 
Ïb–_»tuº
;

280 
‰ab
 = 
ckh
->
b
;

281 
ckh
->
b
 =ab;

282 
b
 = 
‰ab
;

283 
ckh
->
lg_curbuck‘s
 = 
lg_curûÎs
 - 
LG_CKH_BUCKET_CELLS
;

285 ià(!
	`ckh_»bud
(
ckh
, 
b
)) {

286 
	`id®loùm
(
tsd
, 
b
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

291 
	`id®loùm
(
tsd
, 
ckh
->
b
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

292 
ckh
->
b
 =ab;

293 
ckh
->
lg_curbuck‘s
 = 
lg_´evbuck‘s
;

296 
»t
 = 
çl£
;

297 
Ïb–_»tuº
:

298  (
»t
);

299 
	}
}

302 
	$ckh_shršk
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
)

304 
ckhc_t
 *
b
, *
‰ab
;

305 
size_t
 
lg_curûÎs
, 
usize
;

306 
lg_´evbuck‘s
;

312 
lg_´evbuck‘s
 = 
ckh
->
lg_curbuck‘s
;

313 
lg_curûÎs
 = 
ckh
->
lg_curbuck‘s
 + 
LG_CKH_BUCKET_CELLS
 - 1;

314 
usize
 = 
	`§2u
((
ckhc_t
è<< 
lg_curûÎs
, 
CACHELINE
);

315 ià(
usize
 == 0)

317 
b
 = (
ckhc_t
 *)
	`®locztm
(
tsd
, 
usize
, 
CACHELINE
, 
Œue
, 
NULL
,rue,

318 
NULL
);

319 ià(
b
 =ğ
NULL
) {

327 
‰ab
 = 
ckh
->
b
;

328 
ckh
->
b
 =ab;

329 
b
 = 
‰ab
;

330 
ckh
->
lg_curbuck‘s
 = 
lg_curûÎs
 - 
LG_CKH_BUCKET_CELLS
;

332 ià(!
	`ckh_»bud
(
ckh
, 
b
)) {

333 
	`id®loùm
(
tsd
, 
b
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

334 #ifdeà
CKH_COUNT


335 
ckh
->
nshršks
++;

341 
	`id®loùm
(
tsd
, 
ckh
->
b
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

342 
ckh
->
b
 =ab;

343 
ckh
->
lg_curbuck‘s
 = 
lg_´evbuck‘s
;

344 #ifdeà
CKH_COUNT


345 
ckh
->
nshrškçs
++;

347 
	}
}

349 
boŞ


350 
	$ckh_Ãw
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
, 
size_t
 
mš™ems
, 
ckh_hash_t
 *
hash
,

351 
ckh_keycomp_t
 *
keycomp
)

353 
boŞ
 
»t
;

354 
size_t
 
mšûÎs
, 
usize
;

355 
lg_mšûÎs
;

357 
	`as£¹
(
mš™ems
 > 0);

358 
	`as£¹
(
hash
 !ğ
NULL
);

359 
	`as£¹
(
keycomp
 !ğ
NULL
);

361 #ifdeà
CKH_COUNT


362 
ckh
->
ngrows
 = 0;

363 
ckh
->
nshršks
 = 0;

364 
ckh
->
nshrškçs
 = 0;

365 
ckh
->
nš£¹s
 = 0;

366 
ckh
->
Ä–ocs
 = 0;

368 
ckh
->
´ng_¡©e
 = 42;

369 
ckh
->
couÁ
 = 0;

378 
	`as£¹
(
LG_CKH_BUCKET_CELLS
 > 0);

379 
mšûÎs
 = ((
mš™ems
 + (3 - (minitems % 3))) / 3) << 2;

380 
lg_mšûÎs
 = 
LG_CKH_BUCKET_CELLS
;

381 (
	`ZU
(1è<< 
lg_mšûÎs
è< 
mšûÎs
;

382 
lg_mšûÎs
++)

384 
ckh
->
lg_mšbuck‘s
 = 
lg_mšûÎs
 - 
LG_CKH_BUCKET_CELLS
;

385 
ckh
->
lg_curbuck‘s
 = 
lg_mšûÎs
 - 
LG_CKH_BUCKET_CELLS
;

386 
ckh
->
hash
 = hash;

387 
ckh
->
keycomp
 = keycomp;

389 
usize
 = 
	`§2u
((
ckhc_t
è<< 
lg_mšûÎs
, 
CACHELINE
);

390 ià(
usize
 == 0) {

391 
»t
 = 
Œue
;

392 
Ïb–_»tuº
;

394 
ckh
->
b
 = (
ckhc_t
 *)
	`®locztm
(
tsd
, 
usize
, 
CACHELINE
, 
Œue
, 
NULL
,rue,

395 
NULL
);

396 ià(
ckh
->
b
 =ğ
NULL
) {

397 
»t
 = 
Œue
;

398 
Ïb–_»tuº
;

401 
»t
 = 
çl£
;

402 
Ïb–_»tuº
:

403  (
»t
);

404 
	}
}

407 
	$ckh_d–‘e
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
)

410 
	`as£¹
(
ckh
 !ğ
NULL
);

412 #ifdeà
CKH_VERBOSE


413 
	`m®loc_´štf
(

414 "%s(%p):‚grows: %"
FMTu64
",‚shrinks: %"FMTu64","

415 "‚shrškçs: %"
FMTu64
",‚inserts: %"FMTu64","

416 "‚»locs: %"
FMTu64
"\n", 
__func__
, 
ckh
,

417 ()
ckh
->
ngrows
,

418 ()
ckh
->
nshršks
,

419 ()
ckh
->
nshrškçs
,

420 ()
ckh
->
nš£¹s
,

421 ()
ckh
->
Ä–ocs
);

424 
	`id®loùm
(
tsd
, 
ckh
->
b
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

425 ià(
cÚfig_debug
)

426 
	`mem£t
(
ckh
, 0x5a, (
ckh_t
));

427 
	}
}

429 
size_t


430 
	$ckh_couÁ
(
ckh_t
 *
ckh
)

433 
	`as£¹
(
ckh
 !ğ
NULL
);

435  (
ckh
->
couÁ
);

436 
	}
}

438 
boŞ


439 
	$ckh_™”
(
ckh_t
 *
ckh
, 
size_t
 *
bšd
, **
key
, **
d©a
)

441 
size_t
 
i
, 
nûÎs
;

443 
i
 = *
bšd
, 
nûÎs
 = (
	`ZU
(1è<< (
ckh
->
lg_curbuck‘s
 +

444 
LG_CKH_BUCKET_CELLS
)); 
i
 < 
nûÎs
; i++) {

445 ià(
ckh
->
b
[
i
].
key
 !ğ
NULL
) {

446 ià(
key
 !ğ
NULL
)

447 *
key
 = (*)
ckh
->
b
[
i
].key;

448 ià(
d©a
 !ğ
NULL
)

449 *
d©a
 = (*)
ckh
->
b
[
i
].data;

450 *
bšd
 = 
i
 + 1;

451  (
çl£
);

455  (
Œue
);

456 
	}
}

458 
boŞ


459 
	$ckh_š£¹
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
, cÚ¡ *
key
, cÚ¡ *
d©a
)

461 
boŞ
 
»t
;

463 
	`as£¹
(
ckh
 !ğ
NULL
);

464 
	`as£¹
(
	`ckh_£¬ch
(
ckh
, 
key
, 
NULL
, NULL));

466 #ifdeà
CKH_COUNT


467 
ckh
->
nš£¹s
++;

470 
	`ckh_Œy_š£¹
(
ckh
, &
key
, &
d©a
)) {

471 ià(
	`ckh_grow
(
tsd
, 
ckh
)) {

472 
»t
 = 
Œue
;

473 
Ïb–_»tuº
;

477 
»t
 = 
çl£
;

478 
Ïb–_»tuº
:

479  (
»t
);

480 
	}
}

482 
boŞ


483 
	$ckh_»move
(
tsd_t
 *
tsd
, 
ckh_t
 *
ckh
, cÚ¡ *
£¬chkey
, **
key
,

484 **
d©a
)

486 
size_t
 
ûÎ
;

488 
	`as£¹
(
ckh
 !ğ
NULL
);

490 
ûÎ
 = 
	`ckh_i£¬ch
(
ckh
, 
£¬chkey
);

491 ià(
ûÎ
 !ğ
SIZE_T_MAX
) {

492 ià(
key
 !ğ
NULL
)

493 *
key
 = (*)
ckh
->
b
[
ûÎ
].key;

494 ià(
d©a
 !ğ
NULL
)

495 *
d©a
 = (*)
ckh
->
b
[
ûÎ
].data;

496 
ckh
->
b
[
ûÎ
].
key
 = 
NULL
;

497 
ckh
->
b
[
ûÎ
].
d©a
 = 
NULL
;

499 
ckh
->
couÁ
--;

501 ià(
ckh
->
couÁ
 < (
	`ZU
(1è<< (ckh->
lg_curbuck‘s


502 + 
LG_CKH_BUCKET_CELLS
 - 2)è&& 
ckh
->
lg_curbuck‘s


503 > 
ckh
->
lg_mšbuck‘s
) {

505 
	`ckh_shršk
(
tsd
, 
ckh
);

508  (
çl£
);

511  (
Œue
);

512 
	}
}

514 
boŞ


515 
	$ckh_£¬ch
(
ckh_t
 *
ckh
, cÚ¡ *
£¬chkey
, **
key
, **
d©a
)

517 
size_t
 
ûÎ
;

519 
	`as£¹
(
ckh
 !ğ
NULL
);

521 
ûÎ
 = 
	`ckh_i£¬ch
(
ckh
, 
£¬chkey
);

522 ià(
ûÎ
 !ğ
SIZE_T_MAX
) {

523 ià(
key
 !ğ
NULL
)

524 *
key
 = (*)
ckh
->
b
[
ûÎ
].key;

525 ià(
d©a
 !ğ
NULL
)

526 *
d©a
 = (*)
ckh
->
b
[
ûÎ
].data;

527  (
çl£
);

530  (
Œue
);

531 
	}
}

534 
	$ckh_¡ršg_hash
(cÚ¡ *
key
, 
size_t
 
r_hash
[2])

537 
	`hash
(
key
, 
	`¡¾’
((cÚ¡ *)key), 0x94122f33U, 
r_hash
);

538 
	}
}

540 
boŞ


541 
	$ckh_¡ršg_keycomp
(cÚ¡ *
k1
, cÚ¡ *
k2
)

544 
	`as£¹
(
k1
 !ğ
NULL
);

545 
	`as£¹
(
k2
 !ğ
NULL
);

547  (
	`¡rcmp
((*)
k1
, (*)
k2
è? 
çl£
 : 
Œue
);

548 
	}
}

551 
	$ckh_poš‹r_hash
(cÚ¡ *
key
, 
size_t
 
r_hash
[2])

554 cÚ¡ *
v
;

555 
size_t
 
i
;

556 } 
u
;

558 
	`as£¹
((
u
.
v
è=ğ(u.
i
));

559 
u
.
v
 = 
key
;

560 
	`hash
(&
u
.
i
, (u.i), 0xd983396eU, 
r_hash
);

561 
	}
}

563 
boŞ


564 
	$ckh_poš‹r_keycomp
(cÚ¡ *
k1
, cÚ¡ *
k2
)

567  ((
k1
 =ğ
k2
è? 
Œue
 : 
çl£
);

568 
	}
}

	@deps/jemalloc/src/ctl.c

1 
	#JEMALLOC_CTL_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

11 
m®loc_mu‹x_t
 
	gùl_mtx
;

12 
boŞ
 
	gùl_š™Ÿlized
;

13 
ušt64_t
 
	gùl_•och
;

14 
ùl_¡©s_t
 
	gùl_¡©s
;

19 
JEMALLOC_INLINE_C
 cÚ¡ 
ùl_Çmed_node_t
 *

20 
	$ùl_Çmed_node
(cÚ¡ 
ùl_node_t
 *
node
)

23  ((
node
->
Çmed
è? (cÚ¡ 
ùl_Çmed_node_t
 *êod: 
NULL
);

24 
	}
}

26 
JEMALLOC_INLINE_C
 cÚ¡ 
ùl_Çmed_node_t
 *

27 
	$ùl_Çmed_chd»n
(cÚ¡ 
ùl_Çmed_node_t
 *
node
, 
šdex
)

29 cÚ¡ 
ùl_Çmed_node_t
 *
chd»n
 = 
	`ùl_Çmed_node
(
node
->children);

31  (
chd»n
 ? &chd»n[
šdex
] : 
NULL
);

32 
	}
}

34 
JEMALLOC_INLINE_C
 cÚ¡ 
ùl_šdexed_node_t
 *

35 
	$ùl_šdexed_node
(cÚ¡ 
ùl_node_t
 *
node
)

38  (!
node
->
Çmed
 ? (cÚ¡ 
ùl_šdexed_node_t
 *êod: 
NULL
);

39 
	}
}

44 
	#CTL_PROTO
(
n
) \

45 
n
##
	`_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, \

46 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
);

	)

48 
	#INDEX_PROTO
(
n
) \

49 cÚ¡ 
ùl_Çmed_node_t
 *
n
##
	`_šdex
(cÚ¡ 
size_t
 *
mib
, \

50 
size_t
 
mibËn
, size_ˆ
i
);

	)

52 
boŞ
 
ùl_¬’a_š™
(
ùl_¬’a_¡©s_t
 *
a¡©s
);

53 
ùl_¬’a_ş—r
(
ùl_¬’a_¡©s_t
 *
a¡©s
);

54 
ùl_¬’a_¡©s_am”ge
(
ùl_¬’a_¡©s_t
 *
c¡©s
,

55 
¬’a_t
 *
¬’a
);

56 
ùl_¬’a_¡©s_sm”ge
(
ùl_¬’a_¡©s_t
 *
s¡©s
,

57 
ùl_¬’a_¡©s_t
 *
a¡©s
);

58 
ùl_¬’a_»äesh
(
¬’a_t
 *
¬’a
, 
i
);

59 
boŞ
 
ùl_grow
();

60 
ùl_»äesh
();

61 
boŞ
 
ùl_š™
();

62 
ùl_lookup
(cÚ¡ *
Çme
, 
ùl_node_t
 cÚ¡ **
node¥
,

63 
size_t
 *
mibp
, size_ˆ*
d•thp
);

65 
	$CTL_PROTO
(
v”siÚ
)

66 
	$CTL_PROTO
(
•och
)

67 
	$CTL_PROTO
(
th»ad_tÿche_’abËd
)

68 
	$CTL_PROTO
(
th»ad_tÿche_æush
)

69 
	$CTL_PROTO
(
th»ad_´of_Çme
)

70 
	$CTL_PROTO
(
th»ad_´of_aùive
)

71 
	$CTL_PROTO
(
th»ad_¬’a
)

72 
	$CTL_PROTO
(
th»ad_®loÿ‹d
)

73 
	$CTL_PROTO
(
th»ad_®loÿ‹dp
)

74 
	$CTL_PROTO
(
th»ad_d—Îoÿ‹d
)

75 
	$CTL_PROTO
(
th»ad_d—Îoÿ‹dp
)

76 
	$CTL_PROTO
(
cÚfig_ÿche_oblivious
)

77 
	$CTL_PROTO
(
cÚfig_debug
)

78 
	$CTL_PROTO
(
cÚfig_fl
)

79 
	$CTL_PROTO
(
cÚfig_Ïzy_lock
)

80 
	$CTL_PROTO
(
cÚfig_munm­
)

81 
	$CTL_PROTO
(
cÚfig_´of
)

82 
	$CTL_PROTO
(
cÚfig_´of_libgcc
)

83 
	$CTL_PROTO
(
cÚfig_´of_libunwšd
)

84 
	$CTL_PROTO
(
cÚfig_¡©s
)

85 
	$CTL_PROTO
(
cÚfig_tÿche
)

86 
	$CTL_PROTO
(
cÚfig_s
)

87 
	$CTL_PROTO
(
cÚfig_uŒaû
)

88 
	$CTL_PROTO
(
cÚfig_v®gršd
)

89 
	$CTL_PROTO
(
cÚfig_xm®loc
)

90 
	$CTL_PROTO
(
İt_abÜt
)

91 
	$CTL_PROTO
(
İt_dss
)

92 
	$CTL_PROTO
(
İt_lg_chunk
)

93 
	$CTL_PROTO
(
İt_Ç»Çs
)

94 
	$CTL_PROTO
(
İt_lg_dœty_muÉ
)

95 
	$CTL_PROTO
(
İt_¡©s_´št
)

96 
	$CTL_PROTO
(
İt_junk
)

97 
	$CTL_PROTO
(
İt_z”o
)

98 
	$CTL_PROTO
(
İt_qu¬ªtše
)

99 
	$CTL_PROTO
(
İt_»dzÚe
)

100 
	$CTL_PROTO
(
İt_uŒaû
)

101 
	$CTL_PROTO
(
İt_xm®loc
)

102 
	$CTL_PROTO
(
İt_tÿche
)

103 
	$CTL_PROTO
(
İt_lg_tÿche_max
)

104 
	$CTL_PROTO
(
İt_´of
)

105 
	$CTL_PROTO
(
İt_´of_´efix
)

106 
	$CTL_PROTO
(
İt_´of_aùive
)

107 
	$CTL_PROTO
(
İt_´of_th»ad_aùive_š™
)

108 
	$CTL_PROTO
(
İt_lg_´of_§m¶e
)

109 
	$CTL_PROTO
(
İt_lg_´of_š‹rv®
)

110 
	$CTL_PROTO
(
İt_´of_gdump
)

111 
	$CTL_PROTO
(
İt_´of_fš®
)

112 
	$CTL_PROTO
(
İt_´of_Ëak
)

113 
	$CTL_PROTO
(
İt_´of_accum
)

114 
	$CTL_PROTO
(
tÿche_ü—‹
)

115 
	$CTL_PROTO
(
tÿche_æush
)

116 
	$CTL_PROTO
(
tÿche_de¡roy
)

117 
	$CTL_PROTO
(
¬’a_i_purge
)

118 
	`¬’a_purge
(
¬’a_šd
);

119 
	$CTL_PROTO
(
¬’a_i_dss
)

120 
	$CTL_PROTO
(
¬’a_i_lg_dœty_muÉ
)

121 
	$CTL_PROTO
(
¬’a_i_chunk_hooks
)

122 
	$INDEX_PROTO
(
¬’a_i
)

123 
	$CTL_PROTO
(
¬’as_bš_i_size
)

124 
	$CTL_PROTO
(
¬’as_bš_i_Äegs
)

125 
	$CTL_PROTO
(
¬’as_bš_i_run_size
)

126 
	$INDEX_PROTO
(
¬’as_bš_i
)

127 
	$CTL_PROTO
(
¬’as_Ìun_i_size
)

128 
	$INDEX_PROTO
(
¬’as_Ìun_i
)

129 
	$CTL_PROTO
(
¬’as_hchunk_i_size
)

130 
	$INDEX_PROTO
(
¬’as_hchunk_i
)

131 
	$CTL_PROTO
(
¬’as_Ç»Çs
)

132 
	$CTL_PROTO
(
¬’as_š™Ÿlized
)

133 
	$CTL_PROTO
(
¬’as_lg_dœty_muÉ
)

134 
	$CTL_PROTO
(
¬’as_quªtum
)

135 
	$CTL_PROTO
(
¬’as_·ge
)

136 
	$CTL_PROTO
(
¬’as_tÿche_max
)

137 
	$CTL_PROTO
(
¬’as_nbšs
)

138 
	$CTL_PROTO
(
¬’as_nhbšs
)

139 
	$CTL_PROTO
(
¬’as_Æruns
)

140 
	$CTL_PROTO
(
¬’as_nhchunks
)

141 
	$CTL_PROTO
(
¬’as_ex‹nd
)

142 
	$CTL_PROTO
(
´of_th»ad_aùive_š™
)

143 
	$CTL_PROTO
(
´of_aùive
)

144 
	$CTL_PROTO
(
´of_dump
)

145 
	$CTL_PROTO
(
´of_gdump
)

146 
	$CTL_PROTO
(
´of_»£t
)

147 
	$CTL_PROTO
(
´of_š‹rv®
)

148 
	$CTL_PROTO
(
lg_´of_§m¶e
)

149 
	$CTL_PROTO
(
¡©s_¬’as_i_sm®l_®loÿ‹d
)

150 
	$CTL_PROTO
(
¡©s_¬’as_i_sm®l_nm®loc
)

151 
	$CTL_PROTO
(
¡©s_¬’as_i_sm®l_nd®loc
)

152 
	$CTL_PROTO
(
¡©s_¬’as_i_sm®l_Äeque¡s
)

153 
	$CTL_PROTO
(
¡©s_¬’as_i_Ïrge_®loÿ‹d
)

154 
	$CTL_PROTO
(
¡©s_¬’as_i_Ïrge_nm®loc
)

155 
	$CTL_PROTO
(
¡©s_¬’as_i_Ïrge_nd®loc
)

156 
	$CTL_PROTO
(
¡©s_¬’as_i_Ïrge_Äeque¡s
)

157 
	$CTL_PROTO
(
¡©s_¬’as_i_huge_®loÿ‹d
)

158 
	$CTL_PROTO
(
¡©s_¬’as_i_huge_nm®loc
)

159 
	$CTL_PROTO
(
¡©s_¬’as_i_huge_nd®loc
)

160 
	$CTL_PROTO
(
¡©s_¬’as_i_huge_Äeque¡s
)

161 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_nm®loc
)

162 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_nd®loc
)

163 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_Äeque¡s
)

164 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_cu¼egs
)

165 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_nfls
)

166 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_næushes
)

167 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_Äuns
)

168 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_Ä”uns
)

169 
	$CTL_PROTO
(
¡©s_¬’as_i_bšs_j_cu¼uns
)

170 
	$INDEX_PROTO
(
¡©s_¬’as_i_bšs_j
)

171 
	$CTL_PROTO
(
¡©s_¬’as_i_Ìuns_j_nm®loc
)

172 
	$CTL_PROTO
(
¡©s_¬’as_i_Ìuns_j_nd®loc
)

173 
	$CTL_PROTO
(
¡©s_¬’as_i_Ìuns_j_Äeque¡s
)

174 
	$CTL_PROTO
(
¡©s_¬’as_i_Ìuns_j_cu¼uns
)

175 
	$INDEX_PROTO
(
¡©s_¬’as_i_Ìuns_j
)

176 
	$CTL_PROTO
(
¡©s_¬’as_i_hchunks_j_nm®loc
)

177 
	$CTL_PROTO
(
¡©s_¬’as_i_hchunks_j_nd®loc
)

178 
	$CTL_PROTO
(
¡©s_¬’as_i_hchunks_j_Äeque¡s
)

179 
	$CTL_PROTO
(
¡©s_¬’as_i_hchunks_j_curhchunks
)

180 
	$INDEX_PROTO
(
¡©s_¬’as_i_hchunks_j
)

181 
	$CTL_PROTO
(
¡©s_¬’as_i_Áh»ads
)

182 
	$CTL_PROTO
(
¡©s_¬’as_i_dss
)

183 
	$CTL_PROTO
(
¡©s_¬’as_i_lg_dœty_muÉ
)

184 
	$CTL_PROTO
(
¡©s_¬’as_i_·ùive
)

185 
	$CTL_PROTO
(
¡©s_¬’as_i_pdœty
)

186 
	$CTL_PROTO
(
¡©s_¬’as_i_m­³d
)

187 
	$CTL_PROTO
(
¡©s_¬’as_i_Åurge
)

188 
	$CTL_PROTO
(
¡©s_¬’as_i_nmadvi£
)

189 
	$CTL_PROTO
(
¡©s_¬’as_i_purged
)

190 
	$CTL_PROTO
(
¡©s_¬’as_i_m‘ad©a_m­³d
)

191 
	$CTL_PROTO
(
¡©s_¬’as_i_m‘ad©a_®loÿ‹d
)

192 
	$INDEX_PROTO
(
¡©s_¬’as_i
)

193 
	$CTL_PROTO
(
¡©s_ÿùive
)

194 
	$CTL_PROTO
(
¡©s_®loÿ‹d
)

195 
	$CTL_PROTO
(
¡©s_aùive
)

196 
	$CTL_PROTO
(
¡©s_m‘ad©a
)

197 
	$CTL_PROTO
(
¡©s_»sid’t
)

198 
	$CTL_PROTO
(
¡©s_m­³d
)

204 
	#CTL_MAX_DEPTH
 6

	)

206 
	#NAME
(
n
è{
Œue
},‚

207 
	#CHILD
(
t
, 
c
) \

208 (
c
##
_node
è/ (
ùl_
##
t
##
_node_t
), \

209 (
ùl_node_t
 *)
c
##
_node
, \

210 
NULL


	)

211 
	#CTL
(
c
è0, 
NULL
, c##
_ùl


	)

217 
	#INDEX
(
i
è{
çl£
}, i##
_šdex


	)

219 cÚ¡ 
ùl_Çmed_node_t
 
	gth»ad_tÿche_node
[] = {

220 {
NAME
("’abËd"), 
CTL
(
th»ad_tÿche_’abËd
)},

221 {
NAME
("æush"), 
CTL
(
th»ad_tÿche_æush
)}

224 cÚ¡ 
ùl_Çmed_node_t
 
	gth»ad_´of_node
[] = {

225 {
NAME
("Çme"), 
CTL
(
th»ad_´of_Çme
)},

226 {
NAME
("aùive"), 
CTL
(
th»ad_´of_aùive
)}

229 cÚ¡ 
ùl_Çmed_node_t
 
	gth»ad_node
[] = {

230 {
NAME
("¬’a"), 
CTL
(
th»ad_¬’a
)},

231 {
NAME
("®loÿ‹d"), 
CTL
(
th»ad_®loÿ‹d
)},

232 {
NAME
("®loÿ‹dp"), 
CTL
(
th»ad_®loÿ‹dp
)},

233 {
NAME
("d—Îoÿ‹d"), 
CTL
(
th»ad_d—Îoÿ‹d
)},

234 {
NAME
("d—Îoÿ‹dp"), 
CTL
(
th»ad_d—Îoÿ‹dp
)},

235 {
NAME
("tÿche"), 
CHILD
(
Çmed
, 
th»ad_tÿche
)},

236 {
NAME
("´of"), 
CHILD
(
Çmed
, 
th»ad_´of
)}

239 cÚ¡ 
ùl_Çmed_node_t
 
	gcÚfig_node
[] = {

240 {
NAME
("ÿche_oblivious"), 
CTL
(
cÚfig_ÿche_oblivious
)},

241 {
NAME
("debug"), 
CTL
(
cÚfig_debug
)},

242 {
NAME
("fl"), 
CTL
(
cÚfig_fl
)},

243 {
NAME
("Ïzy_lock"), 
CTL
(
cÚfig_Ïzy_lock
)},

244 {
NAME
("munm­"), 
CTL
(
cÚfig_munm­
)},

245 {
NAME
("´of"), 
CTL
(
cÚfig_´of
)},

246 {
NAME
("´of_libgcc"), 
CTL
(
cÚfig_´of_libgcc
)},

247 {
NAME
("´of_libunwšd"), 
CTL
(
cÚfig_´of_libunwšd
)},

248 {
NAME
("¡©s"), 
CTL
(
cÚfig_¡©s
)},

249 {
NAME
("tÿche"), 
CTL
(
cÚfig_tÿche
)},

250 {
NAME
("s"), 
CTL
(
cÚfig_s
)},

251 {
NAME
("uŒaû"), 
CTL
(
cÚfig_uŒaû
)},

252 {
NAME
("v®gršd"), 
CTL
(
cÚfig_v®gršd
)},

253 {
NAME
("xm®loc"), 
CTL
(
cÚfig_xm®loc
)}

256 cÚ¡ 
ùl_Çmed_node_t
 
	gİt_node
[] = {

257 {
NAME
("abÜt"), 
CTL
(
İt_abÜt
)},

258 {
NAME
("dss"), 
CTL
(
İt_dss
)},

259 {
NAME
("lg_chunk"), 
CTL
(
İt_lg_chunk
)},

260 {
NAME
("Ç»Çs"), 
CTL
(
İt_Ç»Çs
)},

261 {
NAME
("lg_dœty_muÉ"), 
CTL
(
İt_lg_dœty_muÉ
)},

262 {
NAME
("¡©s_´št"), 
CTL
(
İt_¡©s_´št
)},

263 {
NAME
("junk"), 
CTL
(
İt_junk
)},

264 {
NAME
("z”o"), 
CTL
(
İt_z”o
)},

265 {
NAME
("qu¬ªtše"), 
CTL
(
İt_qu¬ªtše
)},

266 {
NAME
("»dzÚe"), 
CTL
(
İt_»dzÚe
)},

267 {
NAME
("uŒaû"), 
CTL
(
İt_uŒaû
)},

268 {
NAME
("xm®loc"), 
CTL
(
İt_xm®loc
)},

269 {
NAME
("tÿche"), 
CTL
(
İt_tÿche
)},

270 {
NAME
("lg_tÿche_max"), 
CTL
(
İt_lg_tÿche_max
)},

271 {
NAME
("´of"), 
CTL
(
İt_´of
)},

272 {
NAME
("´of_´efix"), 
CTL
(
İt_´of_´efix
)},

273 {
NAME
("´of_aùive"), 
CTL
(
İt_´of_aùive
)},

274 {
NAME
("´of_th»ad_aùive_š™"), 
CTL
(
İt_´of_th»ad_aùive_š™
)},

275 {
NAME
("lg_´of_§m¶e"), 
CTL
(
İt_lg_´of_§m¶e
)},

276 {
NAME
("lg_´of_š‹rv®"), 
CTL
(
İt_lg_´of_š‹rv®
)},

277 {
NAME
("´of_gdump"), 
CTL
(
İt_´of_gdump
)},

278 {
NAME
("´of_fš®"), 
CTL
(
İt_´of_fš®
)},

279 {
NAME
("´of_Ëak"), 
CTL
(
İt_´of_Ëak
)},

280 {
NAME
("´of_accum"), 
CTL
(
İt_´of_accum
)}

283 cÚ¡ 
ùl_Çmed_node_t
 
	gtÿche_node
[] = {

284 {
NAME
("ü—‹"), 
CTL
(
tÿche_ü—‹
)},

285 {
NAME
("æush"), 
CTL
(
tÿche_æush
)},

286 {
NAME
("de¡roy"), 
CTL
(
tÿche_de¡roy
)}

289 cÚ¡ 
ùl_Çmed_node_t
 
	g¬’a_i_node
[] = {

290 {
NAME
("purge"), 
CTL
(
¬’a_i_purge
)},

291 {
NAME
("dss"), 
CTL
(
¬’a_i_dss
)},

292 {
NAME
("lg_dœty_muÉ"), 
CTL
(
¬’a_i_lg_dœty_muÉ
)},

293 {
NAME
("chunk_hooks"), 
CTL
(
¬’a_i_chunk_hooks
)}

295 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¬’a_i_node
[] = {

296 {
NAME
(""), 
CHILD
(
Çmed
, 
¬’a_i
)}

299 cÚ¡ 
ùl_šdexed_node_t
 
	g¬’a_node
[] = {

300 {
INDEX
(
¬’a_i
)}

303 cÚ¡ 
ùl_Çmed_node_t
 
	g¬’as_bš_i_node
[] = {

304 {
NAME
("size"), 
CTL
(
¬’as_bš_i_size
)},

305 {
NAME
("Äegs"), 
CTL
(
¬’as_bš_i_Äegs
)},

306 {
NAME
("run_size"), 
CTL
(
¬’as_bš_i_run_size
)}

308 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¬’as_bš_i_node
[] = {

309 {
NAME
(""), 
CHILD
(
Çmed
, 
¬’as_bš_i
)}

312 cÚ¡ 
ùl_šdexed_node_t
 
	g¬’as_bš_node
[] = {

313 {
INDEX
(
¬’as_bš_i
)}

316 cÚ¡ 
ùl_Çmed_node_t
 
	g¬’as_Ìun_i_node
[] = {

317 {
NAME
("size"), 
CTL
(
¬’as_Ìun_i_size
)}

319 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¬’as_Ìun_i_node
[] = {

320 {
NAME
(""), 
CHILD
(
Çmed
, 
¬’as_Ìun_i
)}

323 cÚ¡ 
ùl_šdexed_node_t
 
	g¬’as_Ìun_node
[] = {

324 {
INDEX
(
¬’as_Ìun_i
)}

327 cÚ¡ 
ùl_Çmed_node_t
 
	g¬’as_hchunk_i_node
[] = {

328 {
NAME
("size"), 
CTL
(
¬’as_hchunk_i_size
)}

330 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¬’as_hchunk_i_node
[] = {

331 {
NAME
(""), 
CHILD
(
Çmed
, 
¬’as_hchunk_i
)}

334 cÚ¡ 
ùl_šdexed_node_t
 
	g¬’as_hchunk_node
[] = {

335 {
INDEX
(
¬’as_hchunk_i
)}

338 cÚ¡ 
ùl_Çmed_node_t
 
	g¬’as_node
[] = {

339 {
NAME
("Ç»Çs"), 
CTL
(
¬’as_Ç»Çs
)},

340 {
NAME
("š™Ÿlized"), 
CTL
(
¬’as_š™Ÿlized
)},

341 {
NAME
("lg_dœty_muÉ"), 
CTL
(
¬’as_lg_dœty_muÉ
)},

342 {
NAME
("quªtum"), 
CTL
(
¬’as_quªtum
)},

343 {
NAME
("·ge"), 
CTL
(
¬’as_·ge
)},

344 {
NAME
("tÿche_max"), 
CTL
(
¬’as_tÿche_max
)},

345 {
NAME
("nbšs"), 
CTL
(
¬’as_nbšs
)},

346 {
NAME
("nhbšs"), 
CTL
(
¬’as_nhbšs
)},

347 {
NAME
("bš"), 
CHILD
(
šdexed
, 
¬’as_bš
)},

348 {
NAME
("Æruns"), 
CTL
(
¬’as_Æruns
)},

349 {
NAME
("Ìun"), 
CHILD
(
šdexed
, 
¬’as_Ìun
)},

350 {
NAME
("nhchunks"), 
CTL
(
¬’as_nhchunks
)},

351 {
NAME
("hchunk"), 
CHILD
(
šdexed
, 
¬’as_hchunk
)},

352 {
NAME
("ex‹nd"), 
CTL
(
¬’as_ex‹nd
)}

355 cÚ¡ 
ùl_Çmed_node_t
 
	g´of_node
[] = {

356 {
NAME
("th»ad_aùive_š™"), 
CTL
(
´of_th»ad_aùive_š™
)},

357 {
NAME
("aùive"), 
CTL
(
´of_aùive
)},

358 {
NAME
("dump"), 
CTL
(
´of_dump
)},

359 {
NAME
("gdump"), 
CTL
(
´of_gdump
)},

360 {
NAME
("»£t"), 
CTL
(
´of_»£t
)},

361 {
NAME
("š‹rv®"), 
CTL
(
´of_š‹rv®
)},

362 {
NAME
("lg_§m¶e"), 
CTL
(
lg_´of_§m¶e
)}

365 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_m‘ad©a_node
[] = {

366 {
NAME
("m­³d"), 
CTL
(
¡©s_¬’as_i_m‘ad©a_m­³d
)},

367 {
NAME
("®loÿ‹d"), 
CTL
(
¡©s_¬’as_i_m‘ad©a_®loÿ‹d
)}

370 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_sm®l_node
[] = {

371 {
NAME
("®loÿ‹d"), 
CTL
(
¡©s_¬’as_i_sm®l_®loÿ‹d
)},

372 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_sm®l_nm®loc
)},

373 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_sm®l_nd®loc
)},

374 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_sm®l_Äeque¡s
)}

377 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_Ïrge_node
[] = {

378 {
NAME
("®loÿ‹d"), 
CTL
(
¡©s_¬’as_i_Ïrge_®loÿ‹d
)},

379 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_Ïrge_nm®loc
)},

380 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_Ïrge_nd®loc
)},

381 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_Ïrge_Äeque¡s
)}

384 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_huge_node
[] = {

385 {
NAME
("®loÿ‹d"), 
CTL
(
¡©s_¬’as_i_huge_®loÿ‹d
)},

386 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_huge_nm®loc
)},

387 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_huge_nd®loc
)},

388 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_huge_Äeque¡s
)}

391 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_bšs_j_node
[] = {

392 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_bšs_j_nm®loc
)},

393 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_bšs_j_nd®loc
)},

394 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_bšs_j_Äeque¡s
)},

395 {
NAME
("cu¼egs"), 
CTL
(
¡©s_¬’as_i_bšs_j_cu¼egs
)},

396 {
NAME
("nfls"), 
CTL
(
¡©s_¬’as_i_bšs_j_nfls
)},

397 {
NAME
("næushes"), 
CTL
(
¡©s_¬’as_i_bšs_j_næushes
)},

398 {
NAME
("Äuns"), 
CTL
(
¡©s_¬’as_i_bšs_j_Äuns
)},

399 {
NAME
("Ä”uns"), 
CTL
(
¡©s_¬’as_i_bšs_j_Ä”uns
)},

400 {
NAME
("cu¼uns"), 
CTL
(
¡©s_¬’as_i_bšs_j_cu¼uns
)}

402 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¡©s_¬’as_i_bšs_j_node
[] = {

403 {
NAME
(""), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_bšs_j
)}

406 cÚ¡ 
ùl_šdexed_node_t
 
	g¡©s_¬’as_i_bšs_node
[] = {

407 {
INDEX
(
¡©s_¬’as_i_bšs_j
)}

410 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_Ìuns_j_node
[] = {

411 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_Ìuns_j_nm®loc
)},

412 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_Ìuns_j_nd®loc
)},

413 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_Ìuns_j_Äeque¡s
)},

414 {
NAME
("cu¼uns"), 
CTL
(
¡©s_¬’as_i_Ìuns_j_cu¼uns
)}

416 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¡©s_¬’as_i_Ìuns_j_node
[] = {

417 {
NAME
(""), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_Ìuns_j
)}

420 cÚ¡ 
ùl_šdexed_node_t
 
	g¡©s_¬’as_i_Ìuns_node
[] = {

421 {
INDEX
(
¡©s_¬’as_i_Ìuns_j
)}

424 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_hchunks_j_node
[] = {

425 {
NAME
("nm®loc"), 
CTL
(
¡©s_¬’as_i_hchunks_j_nm®loc
)},

426 {
NAME
("nd®loc"), 
CTL
(
¡©s_¬’as_i_hchunks_j_nd®loc
)},

427 {
NAME
("Äeque¡s"), 
CTL
(
¡©s_¬’as_i_hchunks_j_Äeque¡s
)},

428 {
NAME
("curhchunks"), 
CTL
(
¡©s_¬’as_i_hchunks_j_curhchunks
)}

430 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¡©s_¬’as_i_hchunks_j_node
[] = {

431 {
NAME
(""), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_hchunks_j
)}

434 cÚ¡ 
ùl_šdexed_node_t
 
	g¡©s_¬’as_i_hchunks_node
[] = {

435 {
INDEX
(
¡©s_¬’as_i_hchunks_j
)}

438 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_¬’as_i_node
[] = {

439 {
NAME
("Áh»ads"), 
CTL
(
¡©s_¬’as_i_Áh»ads
)},

440 {
NAME
("dss"), 
CTL
(
¡©s_¬’as_i_dss
)},

441 {
NAME
("lg_dœty_muÉ"), 
CTL
(
¡©s_¬’as_i_lg_dœty_muÉ
)},

442 {
NAME
("·ùive"), 
CTL
(
¡©s_¬’as_i_·ùive
)},

443 {
NAME
("pdœty"), 
CTL
(
¡©s_¬’as_i_pdœty
)},

444 {
NAME
("m­³d"), 
CTL
(
¡©s_¬’as_i_m­³d
)},

445 {
NAME
("Åurge"), 
CTL
(
¡©s_¬’as_i_Åurge
)},

446 {
NAME
("nmadvi£"), 
CTL
(
¡©s_¬’as_i_nmadvi£
)},

447 {
NAME
("purged"), 
CTL
(
¡©s_¬’as_i_purged
)},

448 {
NAME
("m‘ad©a"), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_m‘ad©a
)},

449 {
NAME
("sm®l"), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_sm®l
)},

450 {
NAME
("Ïrge"), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_Ïrge
)},

451 {
NAME
("huge"), 
CHILD
(
Çmed
, 
¡©s_¬’as_i_huge
)},

452 {
NAME
("bšs"), 
CHILD
(
šdexed
, 
¡©s_¬’as_i_bšs
)},

453 {
NAME
("Ìuns"), 
CHILD
(
šdexed
, 
¡©s_¬’as_i_Ìuns
)},

454 {
NAME
("hchunks"), 
CHILD
(
šdexed
, 
¡©s_¬’as_i_hchunks
)}

456 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_¡©s_¬’as_i_node
[] = {

457 {
NAME
(""), 
CHILD
(
Çmed
, 
¡©s_¬’as_i
)}

460 cÚ¡ 
ùl_šdexed_node_t
 
	g¡©s_¬’as_node
[] = {

461 {
INDEX
(
¡©s_¬’as_i
)}

464 cÚ¡ 
ùl_Çmed_node_t
 
	g¡©s_node
[] = {

465 {
NAME
("ÿùive"), 
CTL
(
¡©s_ÿùive
)},

466 {
NAME
("®loÿ‹d"), 
CTL
(
¡©s_®loÿ‹d
)},

467 {
NAME
("aùive"), 
CTL
(
¡©s_aùive
)},

468 {
NAME
("m‘ad©a"), 
CTL
(
¡©s_m‘ad©a
)},

469 {
NAME
("»sid’t"), 
CTL
(
¡©s_»sid’t
)},

470 {
NAME
("m­³d"), 
CTL
(
¡©s_m­³d
)},

471 {
NAME
("¬’as"), 
CHILD
(
šdexed
, 
¡©s_¬’as
)}

474 cÚ¡ 
ùl_Çmed_node_t
 
	groÙ_node
[] = {

475 {
NAME
("v”siÚ"), 
CTL
(
v”siÚ
)},

476 {
NAME
("•och"), 
CTL
(
•och
)},

477 {
NAME
("th»ad"), 
CHILD
(
Çmed
, 
th»ad
)},

478 {
NAME
("cÚfig"), 
CHILD
(
Çmed
, 
cÚfig
)},

479 {
NAME
("İt"), 
CHILD
(
Çmed
, 
İt
)},

480 {
NAME
("tÿche"), 
CHILD
(
Çmed
, 
tÿche
)},

481 {
NAME
("¬’a"), 
CHILD
(
šdexed
, 
¬’a
)},

482 {
NAME
("¬’as"), 
CHILD
(
Çmed
, 
¬’as
)},

483 {
NAME
("´of"), 
CHILD
(
Çmed
, 
´of
)},

484 {
NAME
("¡©s"), 
CHILD
(
Çmed
, 
¡©s
)}

486 cÚ¡ 
ùl_Çmed_node_t
 
	gsu³r_roÙ_node
[] = {

487 {
NAME
(""), 
CHILD
(
Çmed
, 
roÙ
)}

490 #undeà
NAME


491 #undeà
CHILD


492 #undeà
CTL


493 #undeà
INDEX


497 
boŞ


498 
	$ùl_¬’a_š™
(
ùl_¬’a_¡©s_t
 *
a¡©s
)

501 ià(
a¡©s
->
l¡©s
 =ğ
NULL
) {

502 
a¡©s
->
l¡©s
 = (
m®loc_Ïrge_¡©s_t
 *)
	`a0m®loc
(
Æşas£s
 *

503 (
m®loc_Ïrge_¡©s_t
));

504 ià(
a¡©s
->
l¡©s
 =ğ
NULL
)

505  (
Œue
);

508 ià(
a¡©s
->
h¡©s
 =ğ
NULL
) {

509 
a¡©s
->
h¡©s
 = (
m®loc_huge_¡©s_t
 *)
	`a0m®loc
(
nhşas£s
 *

510 (
m®loc_huge_¡©s_t
));

511 ià(
a¡©s
->
h¡©s
 =ğ
NULL
)

512  (
Œue
);

515  (
çl£
);

516 
	}
}

519 
	$ùl_¬’a_ş—r
(
ùl_¬’a_¡©s_t
 *
a¡©s
)

522 
a¡©s
->
dss
 = 
dss_´ec_Çmes
[
dss_´ec_lim™
];

523 
a¡©s
->
lg_dœty_muÉ
 = -1;

524 
a¡©s
->
·ùive
 = 0;

525 
a¡©s
->
pdœty
 = 0;

526 ià(
cÚfig_¡©s
) {

527 
	`mem£t
(&
a¡©s
->a¡©s, 0, (
¬’a_¡©s_t
));

528 
a¡©s
->
®loÿ‹d_sm®l
 = 0;

529 
a¡©s
->
nm®loc_sm®l
 = 0;

530 
a¡©s
->
nd®loc_sm®l
 = 0;

531 
a¡©s
->
Äeque¡s_sm®l
 = 0;

532 
	`mem£t
(
a¡©s
->
b¡©s
, 0, 
NBINS
 * (
m®loc_bš_¡©s_t
));

533 
	`mem£t
(
a¡©s
->
l¡©s
, 0, 
Æşas£s
 *

534 (
m®loc_Ïrge_¡©s_t
));

535 
	`mem£t
(
a¡©s
->
h¡©s
, 0, 
nhşas£s
 *

536 (
m®loc_huge_¡©s_t
));

538 
	}
}

541 
	$ùl_¬’a_¡©s_am”ge
(
ùl_¬’a_¡©s_t
 *
c¡©s
, 
¬’a_t
 *
¬’a
)

543 
i
;

545 
	`¬’a_¡©s_m”ge
(
¬’a
, &
c¡©s
->
dss
, &c¡©s->
lg_dœty_muÉ
,

546 &
c¡©s
->
·ùive
, &c¡©s->
pdœty
, &c¡©s->
a¡©s
, c¡©s->
b¡©s
,

547 
c¡©s
->
l¡©s
, c¡©s->
h¡©s
);

549 
i
 = 0; i < 
NBINS
; i++) {

550 
c¡©s
->
®loÿ‹d_sm®l
 +ğc¡©s->
b¡©s
[
i
].
cu¼egs
 *

551 
	`šdex2size
(
i
);

552 
c¡©s
->
nm®loc_sm®l
 +ğc¡©s->
b¡©s
[
i
].
nm®loc
;

553 
c¡©s
->
nd®loc_sm®l
 +ğc¡©s->
b¡©s
[
i
].
nd®loc
;

554 
c¡©s
->
Äeque¡s_sm®l
 +ğc¡©s->
b¡©s
[
i
].
Äeque¡s
;

556 
	}
}

559 
	$ùl_¬’a_¡©s_sm”ge
(
ùl_¬’a_¡©s_t
 *
s¡©s
, c_¬’a_¡©s_ˆ*
a¡©s
)

561 
i
;

563 
s¡©s
->
·ùive
 +ğ
a¡©s
->pactive;

564 
s¡©s
->
pdœty
 +ğ
a¡©s
->pdirty;

566 
s¡©s
->
a¡©s
.
m­³d
 +=‡stats->astats.mapped;

567 
s¡©s
->
a¡©s
.
Åurge
 +=‡stats->astats.npurge;

568 
s¡©s
->
a¡©s
.
nmadvi£
 +=‡stats->astats.nmadvise;

569 
s¡©s
->
a¡©s
.
purged
 +=‡stats->astats.purged;

571 
s¡©s
->
a¡©s
.
m‘ad©a_m­³d
 +=‡stats->astats.metadata_mapped;

572 
s¡©s
->
a¡©s
.
m‘ad©a_®loÿ‹d
 +=‡stats->astats.metadata_allocated;

574 
s¡©s
->
®loÿ‹d_sm®l
 +ğ
a¡©s
->allocated_small;

575 
s¡©s
->
nm®loc_sm®l
 +ğ
a¡©s
->nmalloc_small;

576 
s¡©s
->
nd®loc_sm®l
 +ğ
a¡©s
->ndalloc_small;

577 
s¡©s
->
Äeque¡s_sm®l
 +ğ
a¡©s
->nrequests_small;

579 
s¡©s
->
a¡©s
.
®loÿ‹d_Ïrge
 +=‡stats->astats.allocated_large;

580 
s¡©s
->
a¡©s
.
nm®loc_Ïrge
 +=‡stats->astats.nmalloc_large;

581 
s¡©s
->
a¡©s
.
nd®loc_Ïrge
 +=‡stats->astats.ndalloc_large;

582 
s¡©s
->
a¡©s
.
Äeque¡s_Ïrge
 +=‡stats->astats.nrequests_large;

584 
s¡©s
->
a¡©s
.
®loÿ‹d_huge
 +=‡stats->astats.allocated_huge;

585 
s¡©s
->
a¡©s
.
nm®loc_huge
 +=‡stats->astats.nmalloc_huge;

586 
s¡©s
->
a¡©s
.
nd®loc_huge
 +=‡stats->astats.ndalloc_huge;

588 
i
 = 0; i < 
NBINS
; i++) {

589 
s¡©s
->
b¡©s
[
i
].
nm®loc
 +ğ
a¡©s
->bstats[i].nmalloc;

590 
s¡©s
->
b¡©s
[
i
].
nd®loc
 +ğ
a¡©s
->bstats[i].ndalloc;

591 
s¡©s
->
b¡©s
[
i
].
Äeque¡s
 +ğ
a¡©s
->bstats[i].nrequests;

592 
s¡©s
->
b¡©s
[
i
].
cu¼egs
 +ğ
a¡©s
->bstats[i].curregs;

593 ià(
cÚfig_tÿche
) {

594 
s¡©s
->
b¡©s
[
i
].
nfls
 +ğ
a¡©s
->bstats[i].nfills;

595 
s¡©s
->
b¡©s
[
i
].
næushes
 +=

596 
a¡©s
->
b¡©s
[
i
].
næushes
;

598 
s¡©s
->
b¡©s
[
i
].
Äuns
 +ğ
a¡©s
->bstats[i].nruns;

599 
s¡©s
->
b¡©s
[
i
].
»runs
 +ğ
a¡©s
->bstats[i].reruns;

600 
s¡©s
->
b¡©s
[
i
].
cu¼uns
 +ğ
a¡©s
->bstats[i].curruns;

603 
i
 = 0; i < 
Æşas£s
; i++) {

604 
s¡©s
->
l¡©s
[
i
].
nm®loc
 +ğ
a¡©s
->lstats[i].nmalloc;

605 
s¡©s
->
l¡©s
[
i
].
nd®loc
 +ğ
a¡©s
->lstats[i].ndalloc;

606 
s¡©s
->
l¡©s
[
i
].
Äeque¡s
 +ğ
a¡©s
->lstats[i].nrequests;

607 
s¡©s
->
l¡©s
[
i
].
cu¼uns
 +ğ
a¡©s
->lstats[i].curruns;

610 
i
 = 0; i < 
nhşas£s
; i++) {

611 
s¡©s
->
h¡©s
[
i
].
nm®loc
 +ğ
a¡©s
->hstats[i].nmalloc;

612 
s¡©s
->
h¡©s
[
i
].
nd®loc
 +ğ
a¡©s
->hstats[i].ndalloc;

613 
s¡©s
->
h¡©s
[
i
].
curhchunks
 +ğ
a¡©s
->hstats[i].curhchunks;

615 
	}
}

618 
	$ùl_¬’a_»äesh
(
¬’a_t
 *
¬’a
, 
i
)

620 
ùl_¬’a_¡©s_t
 *
a¡©s
 = &
ùl_¡©s
.
¬’as
[
i
];

621 
ùl_¬’a_¡©s_t
 *
s¡©s
 = &
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
];

623 
	`ùl_¬’a_ş—r
(
a¡©s
);

625 
s¡©s
->
Áh»ads
 +ğ
a¡©s
->nthreads;

626 ià(
cÚfig_¡©s
) {

627 
	`ùl_¬’a_¡©s_am”ge
(
a¡©s
, 
¬’a
);

629 
	`ùl_¬’a_¡©s_sm”ge
(
s¡©s
, 
a¡©s
);

631 
a¡©s
->
·ùive
 +ğ
¬’a
->
Çùive
;

632 
a¡©s
->
pdœty
 +ğ
¬’a
->
ndœty
;

634 
s¡©s
->
·ùive
 +ğ
¬’a
->
Çùive
;

635 
s¡©s
->
pdœty
 +ğ
¬’a
->
ndœty
;

637 
	}
}

639 
boŞ


640 
	$ùl_grow
()

642 
ùl_¬’a_¡©s_t
 *
a¡©s
;

645 ià(
	`¬’a_š™
(
ùl_¡©s
.
Ç»Çs
è=ğ
NULL
)

646  (
Œue
);

649 
a¡©s
 = (
ùl_¬’a_¡©s_t
 *)
	`a0m®loc
((
ùl_¡©s
.
Ç»Çs
 + 2) *

650 (
ùl_¬’a_¡©s_t
));

651 ià(
a¡©s
 =ğ
NULL
)

652  (
Œue
);

655 
	`memıy
(
a¡©s
, 
ùl_¡©s
.
¬’as
, (ùl_¡©s.
Ç»Çs
 + 1) *

656 (
ùl_¬’a_¡©s_t
));

657 
	`mem£t
(&
a¡©s
[
ùl_¡©s
.
Ç»Çs
 + 1], 0, (
ùl_¬’a_¡©s_t
));

658 ià(
	`ùl_¬’a_š™
(&
a¡©s
[
ùl_¡©s
.
Ç»Çs
 + 1])) {

659 
	`a0d®loc
(
a¡©s
);

660  (
Œue
);

664 
ùl_¬’a_¡©s_t
 
t¡©s
;

665 
	`memıy
(&
t¡©s
, &
a¡©s
[
ùl_¡©s
.
Ç»Çs
],

666 (
ùl_¬’a_¡©s_t
));

667 
	`memıy
(&
a¡©s
[
ùl_¡©s
.
Ç»Çs
],

668 &
a¡©s
[
ùl_¡©s
.
Ç»Çs
 + 1], (
ùl_¬’a_¡©s_t
));

669 
	`memıy
(&
a¡©s
[
ùl_¡©s
.
Ç»Çs
 + 1], &
t¡©s
,

670 (
ùl_¬’a_¡©s_t
));

672 
	`a0d®loc
(
ùl_¡©s
.
¬’as
);

673 
ùl_¡©s
.
¬’as
 = 
a¡©s
;

674 
ùl_¡©s
.
Ç»Çs
++;

676  (
çl£
);

677 
	}
}

680 
	$ùl_»äesh
()

682 
tsd_t
 *
tsd
;

683 
i
;

684 
boŞ
 
»äeshed
;

685 
	`VARIABLE_ARRAY
(
¬’a_t
 *, 
»Çs
, 
ùl_¡©s
.
Ç»Çs
);

691 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
Áh»ads
 = 0;

692 
	`ùl_¬’a_ş—r
(&
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
]);

694 
tsd
 = 
	`tsd_ãtch
();

695 
i
 = 0, 
»äeshed
 = 
çl£
; i < 
ùl_¡©s
.
Ç»Çs
; i++) {

696 
»Çs
[
i
] = 
	`¬’a_g‘
(
tsd
, i, 
çl£
, false);

697 ià(
»Çs
[
i
] =ğ
NULL
 && !
»äeshed
) {

698 
»Çs
[
i
] = 
	`¬’a_g‘
(
tsd
, i, 
çl£
, 
Œue
);

699 
»äeshed
 = 
Œue
;

703 
i
 = 0; i < 
ùl_¡©s
.
Ç»Çs
; i++) {

704 ià(
»Çs
[
i
] !ğ
NULL
)

705 
ùl_¡©s
.
¬’as
[
i
].
Áh»ads
 = 
	`¬’a_nbound
(i);

707 
ùl_¡©s
.
¬’as
[
i
].
Áh»ads
 = 0;

710 
i
 = 0; i < 
ùl_¡©s
.
Ç»Çs
; i++) {

711 
boŞ
 
š™Ÿlized
 = (
»Çs
[
i
] !ğ
NULL
);

713 
ùl_¡©s
.
¬’as
[
i
].
š™Ÿlized
 = initialized;

714 ià(
š™Ÿlized
)

715 
	`ùl_¬’a_»äesh
(
»Çs
[
i
], i);

718 ià(
cÚfig_¡©s
) {

719 
size_t
 
ba£_®loÿ‹d
, 
ba£_»sid’t
, 
ba£_m­³d
;

720 
	`ba£_¡©s_g‘
(&
ba£_®loÿ‹d
, &
ba£_»sid’t
, &
ba£_m­³d
);

721 
ùl_¡©s
.
®loÿ‹d
 =

722 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
®loÿ‹d_sm®l
 +

723 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s
.
®loÿ‹d_Ïrge
 +

724 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s
.
®loÿ‹d_huge
;

725 
ùl_¡©s
.
aùive
 =

726 (
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
·ùive
 << 
LG_PAGE
);

727 
ùl_¡©s
.
m‘ad©a
 = 
ba£_®loÿ‹d
 +

728 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s
.
m‘ad©a_m­³d
 +

729 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s


730 .
m‘ad©a_®loÿ‹d
;

731 
ùl_¡©s
.
»sid’t
 = 
ba£_»sid’t
 +

732 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s
.
m‘ad©a_m­³d
 +

733 ((
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
·ùive
 +

734 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
pdœty
è<< 
LG_PAGE
);

735 
ùl_¡©s
.
m­³d
 = 
ba£_m­³d
 +

736 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
a¡©s
.
m­³d
;

739 
ùl_•och
++;

740 
	}
}

742 
boŞ


743 
	$ùl_š™
()

745 
boŞ
 
»t
;

747 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

748 ià(!
ùl_š™Ÿlized
) {

753 
ùl_¡©s
.
Ç»Çs
 = 
	`Ç»Çs_tÙ®_g‘
();

754 
ùl_¡©s
.
¬’as
 = (
ùl_¬’a_¡©s_t
 *)
	`a0m®loc
(

755 (
ùl_¡©s
.
Ç»Çs
 + 1è* (
ùl_¬’a_¡©s_t
));

756 ià(
ùl_¡©s
.
¬’as
 =ğ
NULL
) {

757 
»t
 = 
Œue
;

758 
Ïb–_»tuº
;

760 
	`mem£t
(
ùl_¡©s
.
¬’as
, 0, (ùl_¡©s.
Ç»Çs
 + 1) *

761 (
ùl_¬’a_¡©s_t
));

768 ià(
cÚfig_¡©s
) {

769 
i
;

770 
i
 = 0; i <ğ
ùl_¡©s
.
Ç»Çs
; i++) {

771 ià(
	`ùl_¬’a_š™
(&
ùl_¡©s
.
¬’as
[
i
])) {

772 
j
;

773 
j
 = 0; j < 
i
; j++) {

774 
	`a0d®loc
(

775 
ùl_¡©s
.
¬’as
[
j
].
l¡©s
);

776 
	`a0d®loc
(

777 
ùl_¡©s
.
¬’as
[
j
].
h¡©s
);

779 
	`a0d®loc
(
ùl_¡©s
.
¬’as
);

780 
ùl_¡©s
.
¬’as
 = 
NULL
;

781 
»t
 = 
Œue
;

782 
Ïb–_»tuº
;

786 
ùl_¡©s
.
¬’as
[ùl_¡©s.
Ç»Çs
].
š™Ÿlized
 = 
Œue
;

788 
ùl_•och
 = 0;

789 
	`ùl_»äesh
();

790 
ùl_š™Ÿlized
 = 
Œue
;

793 
»t
 = 
çl£
;

794 
Ïb–_»tuº
:

795 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

796  (
»t
);

797 
	}
}

800 
	$ùl_lookup
(cÚ¡ *
Çme
, 
ùl_node_t
 cÚ¡ **
node¥
, 
size_t
 *
mibp
,

801 
size_t
 *
d•thp
)

803 
»t
;

804 cÚ¡ *
–m
, *
tdÙ
, *
dÙ
;

805 
size_t
 
–’
, 
i
, 
j
;

806 cÚ¡ 
ùl_Çmed_node_t
 *
node
;

808 
–m
 = 
Çme
;

810 
dÙ
 = ((
tdÙ
 = 
	`¡rchr
(
–m
, '.')è!ğ
NULL
) ?dot : strchr(elm, '\0');

811 
–’
 = (
size_t
)((
ušŒ_t
)
dÙ
 - (ušŒ_t)
–m
);

812 ià(
–’
 == 0) {

813 
»t
 = 
ENOENT
;

814 
Ïb–_»tuº
;

816 
node
 = 
su³r_roÙ_node
;

817 
i
 = 0; i < *
d•thp
; i++) {

818 
	`as£¹
(
node
);

819 
	`as£¹
(
node
->
nchd»n
 > 0);

820 ià(
	`ùl_Çmed_node
(
node
->
chd»n
è!ğ
NULL
) {

821 cÚ¡ 
ùl_Çmed_node_t
 *
²ode
 = 
node
;

824 
j
 = 0; j < 
node
->
nchd»n
; j++) {

825 cÚ¡ 
ùl_Çmed_node_t
 *
chd
 =

826 
	`ùl_Çmed_chd»n
(
node
, 
j
);

827 ià(
	`¡¾’
(
chd
->
Çme
è=ğ
–’
 &&

828 
	`¡ºcmp
(
–m
, 
chd
->
Çme
, 
–’
) == 0) {

829 
node
 = 
chd
;

830 ià(
node¥
 !ğ
NULL
)

831 
node¥
[
i
] =

832 (cÚ¡ 
ùl_node_t
 *)
node
;

833 
mibp
[
i
] = 
j
;

837 ià(
node
 =ğ
²ode
) {

838 
»t
 = 
ENOENT
;

839 
Ïb–_»tuº
;

842 
uštmax_t
 
šdex
;

843 cÚ¡ 
ùl_šdexed_node_t
 *
šode
;

846 
šdex
 = 
	`m®loc_¡¹oumax
(
–m
, 
NULL
, 10);

847 ià(
šdex
 =ğ
UINTMAX_MAX
 || index > 
SIZE_T_MAX
) {

848 
»t
 = 
ENOENT
;

849 
Ïb–_»tuº
;

852 
šode
 = 
	`ùl_šdexed_node
(
node
->
chd»n
);

853 
node
 = 
šode
->
	`šdex
(
mibp
, *
d•thp
, (
size_t
)
šdex
);

854 ià(
node
 =ğ
NULL
) {

855 
»t
 = 
ENOENT
;

856 
Ïb–_»tuº
;

859 ià(
node¥
 !ğ
NULL
)

860 
node¥
[
i
] = (cÚ¡ 
ùl_node_t
 *)
node
;

861 
mibp
[
i
] = (
size_t
)
šdex
;

864 ià(
node
->
ùl
 !ğ
NULL
) {

866 ià(*
dÙ
 != '\0') {

871 
»t
 = 
ENOENT
;

872 
Ïb–_»tuº
;

875 *
d•thp
 = 
i
 + 1;

880 ià(*
dÙ
 == '\0') {

882 
»t
 = 
ENOENT
;

883 
Ïb–_»tuº
;

885 
–m
 = &
dÙ
[1];

886 
dÙ
 = ((
tdÙ
 = 
	`¡rchr
(
–m
, '.')è!ğ
NULL
) ?dot :

887 
	`¡rchr
(
–m
, '\0');

888 
–’
 = (
size_t
)((
ušŒ_t
)
dÙ
 - (ušŒ_t)
–m
);

891 
»t
 = 0;

892 
Ïb–_»tuº
:

893  (
»t
);

894 
	}
}

897 
	$ùl_byÇme
(cÚ¡ *
Çme
, *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
,

898 
size_t
 
ÃwËn
)

900 
»t
;

901 
size_t
 
d•th
;

902 
ùl_node_t
 cÚ¡ *
nodes
[
CTL_MAX_DEPTH
];

903 
size_t
 
mib
[
CTL_MAX_DEPTH
];

904 cÚ¡ 
ùl_Çmed_node_t
 *
node
;

906 ià(!
ùl_š™Ÿlized
 && 
	`ùl_š™
()) {

907 
»t
 = 
EAGAIN
;

908 
Ïb–_»tuº
;

911 
d•th
 = 
CTL_MAX_DEPTH
;

912 
»t
 = 
	`ùl_lookup
(
Çme
, 
nodes
, 
mib
, &
d•th
);

913 ià(
»t
 != 0)

914 
Ïb–_»tuº
;

916 
node
 = 
	`ùl_Çmed_node
(
nodes
[
d•th
-1]);

917 ià(
node
 !ğ
NULL
 &&‚ode->
ùl
)

918 
»t
 = 
node
->
	`ùl
(
mib
, 
d•th
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
);

921 
»t
 = 
ENOENT
;

924 
Ïb–_»tuº
:

925 (
»t
);

926 
	}
}

929 
	$ùl_Çm‘omib
(cÚ¡ *
Çme
, 
size_t
 *
mibp
, size_ˆ*
mibËÅ
)

931 
»t
;

933 ià(!
ùl_š™Ÿlized
 && 
	`ùl_š™
()) {

934 
»t
 = 
EAGAIN
;

935 
Ïb–_»tuº
;

938 
»t
 = 
	`ùl_lookup
(
Çme
, 
NULL
, 
mibp
, 
mibËÅ
);

939 
Ïb–_»tuº
:

940 (
»t
);

941 
	}
}

944 
	$ùl_bymib
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

945 *
Ãwp
, 
size_t
 
ÃwËn
)

947 
»t
;

948 cÚ¡ 
ùl_Çmed_node_t
 *
node
;

949 
size_t
 
i
;

951 ià(!
ùl_š™Ÿlized
 && 
	`ùl_š™
()) {

952 
»t
 = 
EAGAIN
;

953 
Ïb–_»tuº
;

957 
node
 = 
su³r_roÙ_node
;

958 
i
 = 0; i < 
mibËn
; i++) {

959 
	`as£¹
(
node
);

960 
	`as£¹
(
node
->
nchd»n
 > 0);

961 ià(
	`ùl_Çmed_node
(
node
->
chd»n
è!ğ
NULL
) {

963 ià(
node
->
nchd»n
 <ğ
mib
[
i
]) {

964 
»t
 = 
ENOENT
;

965 
Ïb–_»tuº
;

967 
node
 = 
	`ùl_Çmed_chd»n
Òode, 
mib
[
i
]);

969 cÚ¡ 
ùl_šdexed_node_t
 *
šode
;

972 
šode
 = 
	`ùl_šdexed_node
(
node
->
chd»n
);

973 
node
 = 
šode
->
	`šdex
(
mib
, 
mibËn
, mib[
i
]);

974 ià(
node
 =ğ
NULL
) {

975 
»t
 = 
ENOENT
;

976 
Ïb–_»tuº
;

982 ià(
node
 &&‚ode->
ùl
)

983 
»t
 = 
node
->
	`ùl
(
mib
, 
mibËn
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
);

986 
»t
 = 
ENOENT
;

989 
Ïb–_»tuº
:

990 (
»t
);

991 
	}
}

993 
boŞ


994 
	$ùl_boÙ
()

997 ià(
	`m®loc_mu‹x_š™
(&
ùl_mtx
))

998  (
Œue
);

1000 
ùl_š™Ÿlized
 = 
çl£
;

1002  (
çl£
);

1003 
	}
}

1006 
	$ùl_´efÜk
()

1009 
	`m®loc_mu‹x_´efÜk
(&
ùl_mtx
);

1010 
	}
}

1013 
	$ùl_po¡fÜk_·»Á
()

1016 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
ùl_mtx
);

1017 
	}
}

1020 
	$ùl_po¡fÜk_chd
()

1023 
	`m®loc_mu‹x_po¡fÜk_chd
(&
ùl_mtx
);

1024 
	}
}

1029 
	#READONLY
() do { \

1030 ià(
Ãwp
 !ğ
NULL
 || 
ÃwËn
 != 0) { \

1031 
»t
 = 
EPERM
; \

1032 
Ïb–_»tuº
; \

1034 } 0)

	)

1036 
	#WRITEONLY
() do { \

1037 ià(
Şdp
 !ğ
NULL
 || 
ŞdËÅ
 != NULL) { \

1038 
»t
 = 
EPERM
; \

1039 
Ïb–_»tuº
; \

1041 } 0)

	)

1043 
	#READ_XOR_WRITE
() do { \

1044 ià((
Şdp
 !ğ
NULL
 && 
ŞdËÅ
 !ğNULLè&& (
Ãwp
 != NULL || \

1045 
ÃwËn
 != 0)) { \

1046 
»t
 = 
EPERM
; \

1047 
Ïb–_»tuº
; \

1049 } 0)

	)

1051 
	#READ
(
v
, 
t
) do { \

1052 ià(
Şdp
 !ğ
NULL
 && 
ŞdËÅ
 != NULL) { \

1053 ià(*
ŞdËÅ
 !ğ(
t
)) { \

1054 
size_t
 
cİyËn
 = ((
t
è<ğ*
ŞdËÅ
) \

1055 ? (
t
è: *
ŞdËÅ
; \

1056 
	`memıy
(
Şdp
, (*)&(
v
), 
cİyËn
); \

1057 
»t
 = 
EINVAL
; \

1058 
Ïb–_»tuº
; \

1060 *(
t
 *)
Şdp
 = (
v
); \

1062 } 0)

	)

1064 
	#WRITE
(
v
, 
t
) do { \

1065 ià(
Ãwp
 !ğ
NULL
) { \

1066 ià(
ÃwËn
 !ğ(
t
)) { \

1067 
»t
 = 
EINVAL
; \

1068 
Ïb–_»tuº
; \

1070 (
v
èğ*(
t
 *)
Ãwp
; \

1072 } 0)

	)

1078 
	#CTL_RO_CLGEN
(
c
, 
l
, 
n
, 
v
, 
t
) \

1080 
n
##
	`_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, \

1081 *
Ãwp
, 
size_t
 
ÃwËn
) \

1083 
»t
; \

1084 
t
 
Şdv®
; \

1086 ià(!(
c
)) \

1087  (
ENOENT
); \

1088 ià(
l
) \

1089 
	`m®loc_mu‹x_lock
(&
ùl_mtx
); \

1090 
	`READONLY
(); \

1091 
Şdv®
 = (
v
); \

1092 
	`READ
(
Şdv®
, 
t
); \

1094 
»t
 = 0; \

1095 
Ïb–_»tuº
: \

1096 ià(
l
) \

1097 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
); \

1098  (
»t
); \

1099 }

	)

1101 
	#CTL_RO_CGEN
(
c
, 
n
, 
v
, 
t
) \

1103 
n
##
	`_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, \

1104 *
Ãwp
, 
size_t
 
ÃwËn
) \

1106 
»t
; \

1107 
t
 
Şdv®
; \

1109 ià(!(
c
)) \

1110  (
ENOENT
); \

1111 
	`m®loc_mu‹x_lock
(&
ùl_mtx
); \

1112 
	`READONLY
(); \

1113 
Şdv®
 = (
v
); \

1114 
	`READ
(
Şdv®
, 
t
); \

1116 
»t
 = 0; \

1117 
Ïb–_»tuº
: \

1118 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
); \

1119  (
»t
); \

1120 }

	)

1122 
	#CTL_RO_GEN
(
n
, 
v
, 
t
) \

1124 
n
##
	`_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, \

1125 *
Ãwp
, 
size_t
 
ÃwËn
) \

1127 
»t
; \

1128 
t
 
Şdv®
; \

1130 
	`m®loc_mu‹x_lock
(&
ùl_mtx
); \

1131 
	`READONLY
(); \

1132 
Şdv®
 = (
v
); \

1133 
	`READ
(
Şdv®
, 
t
); \

1135 
»t
 = 0; \

1136 
Ïb–_»tuº
: \

1137 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
); \

1138  (
»t
); \

1139 }

	)

1145 
	#CTL_RO_NL_CGEN
(
c
, 
n
, 
v
, 
t
) \

1147 
n
##
	`_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, \

1148 *
Ãwp
, 
size_t
 
ÃwËn
) \

1150 
»t
; \

1151 
t
 
Şdv®
; \

1153 ià(!(
c
)) \

1154  (
ENOENT
); \

1155 
	`READONLY
(); \

1156 
Şdv®
 = (
v
); \

1157 
	`READ
(
Şdv®
, 
t
); \

1159 
»t
 = 0; \

1160 
Ïb–_»tuº
: \

1161  (
»t
); \

1162 }

	)

1164 
	#CTL_RO_NL_GEN
(
n
, 
v
, 
t
) \

1166 
n
##
	`_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, \

1167 *
Ãwp
, 
size_t
 
ÃwËn
) \

1169 
»t
; \

1170 
t
 
Şdv®
; \

1172 
	`READONLY
(); \

1173 
Şdv®
 = (
v
); \

1174 
	`READ
(
Şdv®
, 
t
); \

1176 
»t
 = 0; \

1177 
Ïb–_»tuº
: \

1178  (
»t
); \

1179 }

	)

1181 
	#CTL_TSD_RO_NL_CGEN
(
c
, 
n
, 
m
, 
t
) \

1183 
n
##
	`_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, \

1184 *
Ãwp
, 
size_t
 
ÃwËn
) \

1186 
»t
; \

1187 
t
 
Şdv®
; \

1188 
tsd_t
 *
tsd
; \

1190 ià(!(
c
)) \

1191  (
ENOENT
); \

1192 
	`READONLY
(); \

1193 
tsd
 = 
	`tsd_ãtch
(); \

1194 
Şdv®
 = (
	`m
(
tsd
)); \

1195 
	`READ
(
Şdv®
, 
t
); \

1197 
»t
 = 0; \

1198 
Ïb–_»tuº
: \

1199  (
»t
); \

1200 }

	)

1202 
	#CTL_RO_BOOL_CONFIG_GEN
(
n
) \

1204 
n
##
	`_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
, \

1205 *
Ãwp
, 
size_t
 
ÃwËn
) \

1207 
»t
; \

1208 
boŞ
 
Şdv®
; \

1210 
	`READONLY
(); \

1211 
Şdv®
 = 
n
; \

1212 
	`READ
(
Şdv®
, 
boŞ
); \

1214 
»t
 = 0; \

1215 
Ïb–_»tuº
: \

1216  (
»t
); \

1217 }

	)

1221 
	$CTL_RO_NL_GEN
(
v”siÚ
, 
JEMALLOC_VERSION
, const *)

1224 
	$•och_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

1225 *
Ãwp
, 
size_t
 
ÃwËn
)

1227 
»t
;

1228 
UNUSED
 
ušt64_t
 
Ãwv®
;

1230 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

1231 
	`WRITE
(
Ãwv®
, 
ušt64_t
);

1232 ià(
Ãwp
 !ğ
NULL
)

1233 
	`ùl_»äesh
();

1234 
	`READ
(
ùl_•och
, 
ušt64_t
);

1236 
»t
 = 0;

1237 
Ïb–_»tuº
:

1238 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

1239  (
»t
);

1240 
	}
}

1244 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_ÿche_oblivious
)

1245 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_debug
)

1246 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_fl
)

1247 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_Ïzy_lock
)

1248 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_munm­
)

1249 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_´of
)

1250 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_´of_libgcc
)

1251 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_´of_libunwšd
)

1252 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_¡©s
)

1253 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_tÿche
)

1254 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_s
)

1255 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_uŒaû
)

1256 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_v®gršd
)

1257 
	$CTL_RO_BOOL_CONFIG_GEN
(
cÚfig_xm®loc
)

1261 
	$CTL_RO_NL_GEN
(
İt_abÜt
, o±_abÜt, 
boŞ
)

1262 
	$CTL_RO_NL_GEN
(
İt_dss
, opt_dss, const *)

1263 
	$CTL_RO_NL_GEN
(
İt_lg_chunk
, o±_lg_chunk, 
size_t
)

1264 
	$CTL_RO_NL_GEN
(
İt_Ç»Çs
, o±_Ç»Çs, 
size_t
)

1265 
	$CTL_RO_NL_GEN
(
İt_lg_dœty_muÉ
, o±_lg_dœty_muÉ, 
ssize_t
)

1266 
	$CTL_RO_NL_GEN
(
İt_¡©s_´št
, o±_¡©s_´št, 
boŞ
)

1267 
	$CTL_RO_NL_CGEN
(
cÚfig_fl
, 
İt_junk
, opt_junk, const *)

1268 
	$CTL_RO_NL_CGEN
(
cÚfig_fl
, 
İt_qu¬ªtše
, o±_qu¬ªtše, 
size_t
)

1269 
	$CTL_RO_NL_CGEN
(
cÚfig_fl
, 
İt_»dzÚe
, o±_»dzÚe, 
boŞ
)

1270 
	$CTL_RO_NL_CGEN
(
cÚfig_fl
, 
İt_z”o
, o±_z”o, 
boŞ
)

1271 
	$CTL_RO_NL_CGEN
(
cÚfig_uŒaû
, 
İt_uŒaû
, o±_uŒaû, 
boŞ
)

1272 
	$CTL_RO_NL_CGEN
(
cÚfig_xm®loc
, 
İt_xm®loc
, o±_xm®loc, 
boŞ
)

1273 
	$CTL_RO_NL_CGEN
(
cÚfig_tÿche
, 
İt_tÿche
, o±_tÿche, 
boŞ
)

1274 
	$CTL_RO_NL_CGEN
(
cÚfig_tÿche
, 
İt_lg_tÿche_max
, o±_lg_tÿche_max, 
ssize_t
)

1275 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of
, o±_´of, 
boŞ
)

1276 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_´efix
, opt_prof_prefix, const *)

1277 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_aùive
, o±_´of_aùive, 
boŞ
)

1278 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_th»ad_aùive_š™
,

1279 
İt_´of_th»ad_aùive_š™
, 
boŞ
)

1280 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_lg_´of_§m¶e
, o±_lg_´of_§m¶e, 
size_t
)

1281 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_accum
, o±_´of_accum, 
boŞ
)

1282 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_lg_´of_š‹rv®
, o±_lg_´of_š‹rv®, 
ssize_t
)

1283 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_gdump
, o±_´of_gdump, 
boŞ
)

1284 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_fš®
, o±_´of_fš®, 
boŞ
)

1285 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
İt_´of_Ëak
, o±_´of_Ëak, 
boŞ
)

1290 
	$th»ad_¬’a_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

1291 *
Ãwp
, 
size_t
 
ÃwËn
)

1293 
»t
;

1294 
tsd_t
 *
tsd
;

1295 
¬’a_t
 *
Şd¬’a
;

1296 
Ãwšd
, 
Şdšd
;

1298 
tsd
 = 
	`tsd_ãtch
();

1299 
Şd¬’a
 = 
	`¬’a_choo£
(
tsd
, 
NULL
);

1300 ià(
Şd¬’a
 =ğ
NULL
)

1301  (
EAGAIN
);

1303 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

1304 
Ãwšd
 = 
Şdšd
 = 
Şd¬’a
->
šd
;

1305 
	`WRITE
(
Ãwšd
, );

1306 
	`READ
(
Şdšd
, );

1307 ià(
Ãwšd
 !ğ
Şdšd
) {

1308 
¬’a_t
 *
Ãw¬’a
;

1310 ià(
Ãwšd
 >ğ
ùl_¡©s
.
Ç»Çs
) {

1312 
»t
 = 
EFAULT
;

1313 
Ïb–_»tuº
;

1317 
Ãw¬’a
 = 
	`¬’a_g‘
(
tsd
, 
Ãwšd
, 
Œue
,rue);

1318 ià(
Ãw¬’a
 =ğ
NULL
) {

1319 
»t
 = 
EAGAIN
;

1320 
Ïb–_»tuº
;

1323 
	`¬’a_mig¿‹
(
tsd
, 
Şdšd
, 
Ãwšd
);

1324 ià(
cÚfig_tÿche
) {

1325 
tÿche_t
 *
tÿche
 = 
	`tsd_tÿche_g‘
(
tsd
);

1326 ià(
tÿche
 !ğ
NULL
) {

1327 
	`tÿche_¬’a_»assocŸ‹
(
tÿche
, 
Şd¬’a
,

1328 
Ãw¬’a
);

1333 
»t
 = 0;

1334 
Ïb–_»tuº
:

1335 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

1336  (
»t
);

1337 
	}
}

1339 
	$CTL_TSD_RO_NL_CGEN
(
cÚfig_¡©s
, 
th»ad_®loÿ‹d
, 
tsd_th»ad_®loÿ‹d_g‘
,

1340 
ušt64_t
)

1341 
	$CTL_TSD_RO_NL_CGEN
(
cÚfig_¡©s
, 
th»ad_®loÿ‹dp
, 
tsd_th»ad_®loÿ‹dp_g‘
,

1342 
ušt64_t
 *)

1343 
	$CTL_TSD_RO_NL_CGEN
(
cÚfig_¡©s
, 
th»ad_d—Îoÿ‹d
, 
tsd_th»ad_d—Îoÿ‹d_g‘
,

1344 
ušt64_t
)

1345 
	$CTL_TSD_RO_NL_CGEN
(
cÚfig_¡©s
, 
th»ad_d—Îoÿ‹dp
,

1346 
tsd_th»ad_d—Îoÿ‹dp_g‘
, 
ušt64_t
 *)

1349 
	$th»ad_tÿche_’abËd_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1350 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1352 
»t
;

1353 
boŞ
 
Şdv®
;

1355 ià(!
cÚfig_tÿche
)

1356  (
ENOENT
);

1358 
Şdv®
 = 
	`tÿche_’abËd_g‘
();

1359 ià(
Ãwp
 !ğ
NULL
) {

1360 ià(
ÃwËn
 !ğ(
boŞ
)) {

1361 
»t
 = 
EINVAL
;

1362 
Ïb–_»tuº
;

1364 
	`tÿche_’abËd_£t
(*(
boŞ
 *)
Ãwp
);

1366 
	`READ
(
Şdv®
, 
boŞ
);

1368 
»t
 = 0;

1369 
Ïb–_»tuº
:

1370  (
»t
);

1371 
	}
}

1374 
	$th»ad_tÿche_æush_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1375 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1377 
»t
;

1379 ià(!
cÚfig_tÿche
)

1380  (
ENOENT
);

1382 
	`READONLY
();

1383 
	`WRITEONLY
();

1385 
	`tÿche_æush
();

1387 
»t
 = 0;

1388 
Ïb–_»tuº
:

1389  (
»t
);

1390 
	}
}

1393 
	$th»ad_´of_Çme_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1394 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1396 
»t
;

1398 ià(!
cÚfig_´of
)

1399  (
ENOENT
);

1401 
	`READ_XOR_WRITE
();

1403 ià(
Ãwp
 !ğ
NULL
) {

1404 
tsd_t
 *
tsd
;

1406 ià(
ÃwËn
 != (const *)) {

1407 
»t
 = 
EINVAL
;

1408 
Ïb–_»tuº
;

1411 
tsd
 = 
	`tsd_ãtch
();

1413 ià((
»t
 = 
	`´of_th»ad_Çme_£t
(
tsd
, *(cÚ¡ **)
Ãwp
)) !=

1415 
Ïb–_»tuº
;

1417 cÚ¡ *
ŞdÇme
 = 
	`´of_th»ad_Çme_g‘
();

1418 
	`READ
(
ŞdÇme
, const *);

1421 
»t
 = 0;

1422 
Ïb–_»tuº
:

1423  (
»t
);

1424 
	}
}

1427 
	$th»ad_´of_aùive_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1428 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1430 
»t
;

1431 
boŞ
 
Şdv®
;

1433 ià(!
cÚfig_´of
)

1434  (
ENOENT
);

1436 
Şdv®
 = 
	`´of_th»ad_aùive_g‘
();

1437 ià(
Ãwp
 !ğ
NULL
) {

1438 ià(
ÃwËn
 !ğ(
boŞ
)) {

1439 
»t
 = 
EINVAL
;

1440 
Ïb–_»tuº
;

1442 ià(
	`´of_th»ad_aùive_£t
(*(
boŞ
 *)
Ãwp
)) {

1443 
»t
 = 
EAGAIN
;

1444 
Ïb–_»tuº
;

1447 
	`READ
(
Şdv®
, 
boŞ
);

1449 
»t
 = 0;

1450 
Ïb–_»tuº
:

1451  (
»t
);

1452 
	}
}

1457 
	$tÿche_ü—‹_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

1458 *
Ãwp
, 
size_t
 
ÃwËn
)

1460 
»t
;

1461 
tsd_t
 *
tsd
;

1462 
tÿche_šd
;

1464 ià(!
cÚfig_tÿche
)

1465  (
ENOENT
);

1467 
tsd
 = 
	`tsd_ãtch
();

1469 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

1470 
	`READONLY
();

1471 ià(
	`tÿches_ü—‹
(
tsd
, &
tÿche_šd
)) {

1472 
»t
 = 
EFAULT
;

1473 
Ïb–_»tuº
;

1475 
	`READ
(
tÿche_šd
, );

1477 
»t
 = 0;

1478 
Ïb–_»tuº
:

1479 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

1480  (
»t
);

1481 
	}
}

1484 
	$tÿche_æush_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

1485 *
Ãwp
, 
size_t
 
ÃwËn
)

1487 
»t
;

1488 
tsd_t
 *
tsd
;

1489 
tÿche_šd
;

1491 ià(!
cÚfig_tÿche
)

1492  (
ENOENT
);

1494 
tsd
 = 
	`tsd_ãtch
();

1496 
	`WRITEONLY
();

1497 
tÿche_šd
 = 
UINT_MAX
;

1498 
	`WRITE
(
tÿche_šd
, );

1499 ià(
tÿche_šd
 =ğ
UINT_MAX
) {

1500 
»t
 = 
EFAULT
;

1501 
Ïb–_»tuº
;

1503 
	`tÿches_æush
(
tsd
, 
tÿche_šd
);

1505 
»t
 = 0;

1506 
Ïb–_»tuº
:

1507  (
»t
);

1508 
	}
}

1511 
	$tÿche_de¡roy_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1512 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1514 
»t
;

1515 
tsd_t
 *
tsd
;

1516 
tÿche_šd
;

1518 ià(!
cÚfig_tÿche
)

1519  (
ENOENT
);

1521 
tsd
 = 
	`tsd_ãtch
();

1523 
	`WRITEONLY
();

1524 
tÿche_šd
 = 
UINT_MAX
;

1525 
	`WRITE
(
tÿche_šd
, );

1526 ià(
tÿche_šd
 =ğ
UINT_MAX
) {

1527 
»t
 = 
EFAULT
;

1528 
Ïb–_»tuº
;

1530 
	`tÿches_de¡roy
(
tsd
, 
tÿche_šd
);

1532 
»t
 = 0;

1533 
Ïb–_»tuº
:

1534  (
»t
);

1535 
	}
}

1541 
	$¬’a_purge
(
¬’a_šd
)

1543 
tsd_t
 *
tsd
;

1544 
i
;

1545 
boŞ
 
»äeshed
;

1546 
	`VARIABLE_ARRAY
(
¬’a_t
 *, 
»Çs
, 
ùl_¡©s
.
Ç»Çs
);

1548 
tsd
 = 
	`tsd_ãtch
();

1549 
i
 = 0, 
»äeshed
 = 
çl£
; i < 
ùl_¡©s
.
Ç»Çs
; i++) {

1550 
»Çs
[
i
] = 
	`¬’a_g‘
(
tsd
, i, 
çl£
, false);

1551 ià(
»Çs
[
i
] =ğ
NULL
 && !
»äeshed
) {

1552 
»Çs
[
i
] = 
	`¬’a_g‘
(
tsd
, i, 
çl£
, 
Œue
);

1553 
»äeshed
 = 
Œue
;

1557 ià(
¬’a_šd
 =ğ
ùl_¡©s
.
Ç»Çs
) {

1558 
i
;

1559 
i
 = 0; i < 
ùl_¡©s
.
Ç»Çs
; i++) {

1560 ià(
»Çs
[
i
] !ğ
NULL
)

1561 
	`¬’a_purge_®l
(
»Çs
[
i
]);

1564 
	`as£¹
(
¬’a_šd
 < 
ùl_¡©s
.
Ç»Çs
);

1565 ià(
»Çs
[
¬’a_šd
] !ğ
NULL
)

1566 
	`¬’a_purge_®l
(
»Çs
[
¬’a_šd
]);

1568 
	}
}

1571 
	$¬’a_i_purge_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

1572 *
Ãwp
, 
size_t
 
ÃwËn
)

1574 
»t
;

1576 
	`READONLY
();

1577 
	`WRITEONLY
();

1578 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

1579 
	`¬’a_purge
(
mib
[1]);

1580 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

1582 
»t
 = 0;

1583 
Ïb–_»tuº
:

1584  (
»t
);

1585 
	}
}

1588 
	$¬’a_i_dss_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

1589 *
Ãwp
, 
size_t
 
ÃwËn
)

1591 
»t
;

1592 cÚ¡ *
dss
 = 
NULL
;

1593 
¬’a_šd
 = 
mib
[1];

1594 
dss_´ec_t
 
dss_´ec_Şd
 = 
dss_´ec_lim™
;

1595 
dss_´ec_t
 
dss_´ec
 = 
dss_´ec_lim™
;

1597 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

1598 
	`WRITE
(
dss
, const *);

1599 ià(
dss
 !ğ
NULL
) {

1600 
i
;

1601 
boŞ
 
m©ch
 = 
çl£
;

1603 
i
 = 0; i < 
dss_´ec_lim™
; i++) {

1604 ià(
	`¡rcmp
(
dss_´ec_Çmes
[
i
], 
dss
) == 0) {

1605 
dss_´ec
 = 
i
;

1606 
m©ch
 = 
Œue
;

1611 ià(!
m©ch
) {

1612 
»t
 = 
EINVAL
;

1613 
Ïb–_»tuº
;

1617 ià(
¬’a_šd
 < 
ùl_¡©s
.
Ç»Çs
) {

1618 
¬’a_t
 *
¬’a
 = 
	`¬’a_g‘
(
	`tsd_ãtch
(), 
¬’a_šd
, 
çl£
, 
Œue
);

1619 ià(
¬’a
 =ğ
NULL
 || (
dss_´ec
 !ğ
dss_´ec_lim™
 &&

1620 
	`¬’a_dss_´ec_£t
(
¬’a
, 
dss_´ec
))) {

1621 
»t
 = 
EFAULT
;

1622 
Ïb–_»tuº
;

1624 
dss_´ec_Şd
 = 
	`¬’a_dss_´ec_g‘
(
¬’a
);

1626 ià(
dss_´ec
 !ğ
dss_´ec_lim™
 &&

1627 
	`chunk_dss_´ec_£t
(
dss_´ec
)) {

1628 
»t
 = 
EFAULT
;

1629 
Ïb–_»tuº
;

1631 
dss_´ec_Şd
 = 
	`chunk_dss_´ec_g‘
();

1634 
dss
 = 
dss_´ec_Çmes
[
dss_´ec_Şd
];

1635 
	`READ
(
dss
, const *);

1637 
»t
 = 0;

1638 
Ïb–_»tuº
:

1639 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

1640  (
»t
);

1641 
	}
}

1644 
	$¬’a_i_lg_dœty_muÉ_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1645 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1647 
»t
;

1648 
¬’a_šd
 = 
mib
[1];

1649 
¬’a_t
 *
¬’a
;

1651 
¬’a
 = 
	`¬’a_g‘
(
	`tsd_ãtch
(), 
¬’a_šd
, 
çl£
, 
Œue
);

1652 ià(
¬’a
 =ğ
NULL
) {

1653 
»t
 = 
EFAULT
;

1654 
Ïb–_»tuº
;

1657 ià(
Şdp
 !ğ
NULL
 && 
ŞdËÅ
 != NULL) {

1658 
size_t
 
Şdv®
 = 
	`¬’a_lg_dœty_muÉ_g‘
(
¬’a
);

1659 
	`READ
(
Şdv®
, 
ssize_t
);

1661 ià(
Ãwp
 !ğ
NULL
) {

1662 ià(
ÃwËn
 !ğ(
ssize_t
)) {

1663 
»t
 = 
EINVAL
;

1664 
Ïb–_»tuº
;

1666 ià(
	`¬’a_lg_dœty_muÉ_£t
(
¬’a
, *(
ssize_t
 *)
Ãwp
)) {

1667 
»t
 = 
EFAULT
;

1668 
Ïb–_»tuº
;

1672 
»t
 = 0;

1673 
Ïb–_»tuº
:

1674  (
»t
);

1675 
	}
}

1678 
	$¬’a_i_chunk_hooks_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1679 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1681 
»t
;

1682 
¬’a_šd
 = 
mib
[1];

1683 
¬’a_t
 *
¬’a
;

1685 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

1686 ià(
¬’a_šd
 < 
	`Ç»Çs_tÙ®_g‘
(è&& (
¬’a
 =

1687 
	`¬’a_g‘
(
	`tsd_ãtch
(), 
¬’a_šd
, 
çl£
, 
Œue
)è!ğ
NULL
) {

1688 ià(
Ãwp
 !ğ
NULL
) {

1689 
chunk_hooks_t
 
Şd_chunk_hooks
, 
Ãw_chunk_hooks
;

1690 
	`WRITE
(
Ãw_chunk_hooks
, 
chunk_hooks_t
);

1691 
Şd_chunk_hooks
 = 
	`chunk_hooks_£t
(
¬’a
,

1692 &
Ãw_chunk_hooks
);

1693 
	`READ
(
Şd_chunk_hooks
, 
chunk_hooks_t
);

1695 
chunk_hooks_t
 
Şd_chunk_hooks
 = 
	`chunk_hooks_g‘
(
¬’a
);

1696 
	`READ
(
Şd_chunk_hooks
, 
chunk_hooks_t
);

1699 
»t
 = 
EFAULT
;

1700 
Ïb–_»tuº
;

1702 
»t
 = 0;

1703 
Ïb–_»tuº
:

1704 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

1705  (
»t
);

1706 
	}
}

1708 cÚ¡ 
ùl_Çmed_node_t
 *

1709 
	$¬’a_i_šdex
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
i
)

1711 cÚ¡ 
ùl_Çmed_node_t
 * 
»t
;

1713 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

1714 ià(
i
 > 
ùl_¡©s
.
Ç»Çs
) {

1715 
»t
 = 
NULL
;

1716 
Ïb–_»tuº
;

1719 
»t
 = 
su³r_¬’a_i_node
;

1720 
Ïb–_»tuº
:

1721 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

1722  (
»t
);

1723 
	}
}

1728 
	$¬’as_Ç»Çs_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1729 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1731 
»t
;

1732 
Ç»Çs
;

1734 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

1735 
	`READONLY
();

1736 ià(*
ŞdËÅ
 != ()) {

1737 
»t
 = 
EINVAL
;

1738 
Ïb–_»tuº
;

1740 
Ç»Çs
 = 
ùl_¡©s
.narenas;

1741 
	`READ
(
Ç»Çs
, );

1743 
»t
 = 0;

1744 
Ïb–_»tuº
:

1745 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

1746  (
»t
);

1747 
	}
}

1750 
	$¬’as_š™Ÿlized_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1751 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1753 
»t
;

1754 
Ä—d
, 
i
;

1756 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

1757 
	`READONLY
();

1758 ià(*
ŞdËÅ
 !ğ
ùl_¡©s
.
Ç»Çs
 * (
boŞ
)) {

1759 
»t
 = 
EINVAL
;

1760 
Ä—d
 = (*
ŞdËÅ
 < 
ùl_¡©s
.
Ç»Çs
 * (
boŞ
))

1761 ? (*
ŞdËÅ
 / (
boŞ
)è: 
ùl_¡©s
.
Ç»Çs
;

1763 
»t
 = 0;

1764 
Ä—d
 = 
ùl_¡©s
.
Ç»Çs
;

1767 
i
 = 0; i < 
Ä—d
; i++)

1768 ((
boŞ
 *)
Şdp
)[
i
] = 
ùl_¡©s
.
¬’as
[i].
š™Ÿlized
;

1770 
Ïb–_»tuº
:

1771 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

1772  (
»t
);

1773 
	}
}

1776 
	$¬’as_lg_dœty_muÉ_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1777 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1779 
»t
;

1781 ià(
Şdp
 !ğ
NULL
 && 
ŞdËÅ
 != NULL) {

1782 
size_t
 
Şdv®
 = 
	`¬’a_lg_dœty_muÉ_deçuÉ_g‘
();

1783 
	`READ
(
Şdv®
, 
ssize_t
);

1785 ià(
Ãwp
 !ğ
NULL
) {

1786 ià(
ÃwËn
 !ğ(
ssize_t
)) {

1787 
»t
 = 
EINVAL
;

1788 
Ïb–_»tuº
;

1790 ià(
	`¬’a_lg_dœty_muÉ_deçuÉ_£t
(*(
ssize_t
 *)
Ãwp
)) {

1791 
»t
 = 
EFAULT
;

1792 
Ïb–_»tuº
;

1796 
»t
 = 0;

1797 
Ïb–_»tuº
:

1798  (
»t
);

1799 
	}
}

1801 
	$CTL_RO_NL_GEN
(
¬’as_quªtum
, 
QUANTUM
, 
size_t
)

1802 
	$CTL_RO_NL_GEN
(
¬’as_·ge
, 
PAGE
, 
size_t
)

1803 
	$CTL_RO_NL_CGEN
(
cÚfig_tÿche
, 
¬’as_tÿche_max
, 
tÿche_maxşass
, 
size_t
)

1804 
	$CTL_RO_NL_GEN
(
¬’as_nbšs
, 
NBINS
, )

1805 
	$CTL_RO_NL_CGEN
(
cÚfig_tÿche
, 
¬’as_nhbšs
, 
nhbšs
, )

1806 
	$CTL_RO_NL_GEN
(
¬’as_bš_i_size
, 
¬’a_bš_šfo
[
mib
[2]].
»g_size
, 
size_t
)

1807 
	$CTL_RO_NL_GEN
(
¬’as_bš_i_Äegs
, 
¬’a_bš_šfo
[
mib
[2]].
Äegs
, 
ušt32_t
)

1808 
	$CTL_RO_NL_GEN
(
¬’as_bš_i_run_size
, 
¬’a_bš_šfo
[
mib
[2]].
run_size
, 
size_t
)

1809 cÚ¡ 
ùl_Çmed_node_t
 *

1810 
	$¬’as_bš_i_šdex
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
i
)

1813 ià(
i
 > 
NBINS
)

1814  (
NULL
);

1815  (
su³r_¬’as_bš_i_node
);

1816 
	}
}

1818 
	$CTL_RO_NL_GEN
(
¬’as_Æruns
, 
Æşas£s
, )

1819 
	`CTL_RO_NL_GEN
(
¬’as_Ìun_i_size
, 
	`šdex2size
(
NBINS
+
mib
[2]), 
size_t
)

1820 cÚ¡ 
ùl_Çmed_node_t
 *

1821 
	$¬’as_Ìun_i_šdex
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
i
)

1824 ià(
i
 > 
Æşas£s
)

1825  (
NULL
);

1826  (
su³r_¬’as_Ìun_i_node
);

1827 
	}
}

1829 
	$CTL_RO_NL_GEN
(
¬’as_nhchunks
, 
nhşas£s
, )

1830 
	`CTL_RO_NL_GEN
(
¬’as_hchunk_i_size
, 
	`šdex2size
(
NBINS
+
Æşas£s
+
mib
[2]), 
size_t
)

1831 cÚ¡ 
ùl_Çmed_node_t
 *

1832 
	$¬’as_hchunk_i_šdex
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
i
)

1835 ià(
i
 > 
nhşas£s
)

1836  (
NULL
);

1837  (
su³r_¬’as_hchunk_i_node
);

1838 
	}
}

1841 
	$¬’as_ex‹nd_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

1842 *
Ãwp
, 
size_t
 
ÃwËn
)

1844 
»t
;

1845 
Ç»Çs
;

1847 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

1848 
	`READONLY
();

1849 ià(
	`ùl_grow
()) {

1850 
»t
 = 
EAGAIN
;

1851 
Ïb–_»tuº
;

1853 
Ç»Çs
 = 
ùl_¡©s
.narenas - 1;

1854 
	`READ
(
Ç»Çs
, );

1856 
»t
 = 0;

1857 
Ïb–_»tuº
:

1858 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

1859  (
»t
);

1860 
	}
}

1865 
	$´of_th»ad_aùive_š™_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
,

1866 
size_t
 *
ŞdËÅ
, *
Ãwp
, size_ˆ
ÃwËn
)

1868 
»t
;

1869 
boŞ
 
Şdv®
;

1871 ià(!
cÚfig_´of
)

1872  (
ENOENT
);

1874 ià(
Ãwp
 !ğ
NULL
) {

1875 ià(
ÃwËn
 !ğ(
boŞ
)) {

1876 
»t
 = 
EINVAL
;

1877 
Ïb–_»tuº
;

1879 
Şdv®
 = 
	`´of_th»ad_aùive_š™_£t
(*(
boŞ
 *)
Ãwp
);

1881 
Şdv®
 = 
	`´of_th»ad_aùive_š™_g‘
();

1882 
	`READ
(
Şdv®
, 
boŞ
);

1884 
»t
 = 0;

1885 
Ïb–_»tuº
:

1886  (
»t
);

1887 
	}
}

1890 
	$´of_aùive_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

1891 *
Ãwp
, 
size_t
 
ÃwËn
)

1893 
»t
;

1894 
boŞ
 
Şdv®
;

1896 ià(!
cÚfig_´of
)

1897  (
ENOENT
);

1899 ià(
Ãwp
 !ğ
NULL
) {

1900 ià(
ÃwËn
 !ğ(
boŞ
)) {

1901 
»t
 = 
EINVAL
;

1902 
Ïb–_»tuº
;

1904 
Şdv®
 = 
	`´of_aùive_£t
(*(
boŞ
 *)
Ãwp
);

1906 
Şdv®
 = 
	`´of_aùive_g‘
();

1907 
	`READ
(
Şdv®
, 
boŞ
);

1909 
»t
 = 0;

1910 
Ïb–_»tuº
:

1911  (
»t
);

1912 
	}
}

1915 
	$´of_dump_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

1916 *
Ãwp
, 
size_t
 
ÃwËn
)

1918 
»t
;

1919 cÚ¡ *
f’ame
 = 
NULL
;

1921 ià(!
cÚfig_´of
)

1922  (
ENOENT
);

1924 
	`WRITEONLY
();

1925 
	`WRITE
(
f’ame
, const *);

1927 ià(
	`´of_mdump
(
f’ame
)) {

1928 
»t
 = 
EFAULT
;

1929 
Ïb–_»tuº
;

1932 
»t
 = 0;

1933 
Ïb–_»tuº
:

1934  (
»t
);

1935 
	}
}

1938 
	$´of_gdump_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

1939 *
Ãwp
, 
size_t
 
ÃwËn
)

1941 
»t
;

1942 
boŞ
 
Şdv®
;

1944 ià(!
cÚfig_´of
)

1945  (
ENOENT
);

1947 ià(
Ãwp
 !ğ
NULL
) {

1948 ià(
ÃwËn
 !ğ(
boŞ
)) {

1949 
»t
 = 
EINVAL
;

1950 
Ïb–_»tuº
;

1952 
Şdv®
 = 
	`´of_gdump_£t
(*(
boŞ
 *)
Ãwp
);

1954 
Şdv®
 = 
	`´of_gdump_g‘
();

1955 
	`READ
(
Şdv®
, 
boŞ
);

1957 
»t
 = 0;

1958 
Ïb–_»tuº
:

1959  (
»t
);

1960 
	}
}

1963 
	$´of_»£t_ùl
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

1964 *
Ãwp
, 
size_t
 
ÃwËn
)

1966 
»t
;

1967 
size_t
 
lg_§m¶e
 = 
lg_´of_§m¶e
;

1968 
tsd_t
 *
tsd
;

1970 ià(!
cÚfig_´of
)

1971  (
ENOENT
);

1973 
	`WRITEONLY
();

1974 
	`WRITE
(
lg_§m¶e
, 
size_t
);

1975 ià(
lg_§m¶e
 >ğ((
ušt64_t
) << 3))

1976 
lg_§m¶e
 = ((
ušt64_t
) << 3) - 1;

1978 
tsd
 = 
	`tsd_ãtch
();

1980 
	`´of_»£t
(
tsd
, 
lg_§m¶e
);

1982 
»t
 = 0;

1983 
Ïb–_»tuº
:

1984  (
»t
);

1985 
	}
}

1987 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
´of_š‹rv®
,…rof_š‹rv®, 
ušt64_t
)

1988 
	$CTL_RO_NL_CGEN
(
cÚfig_´of
, 
lg_´of_§m¶e
,†g_´of_§m¶e, 
size_t
)

1992 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_ÿùive
, &¡©s_ÿùive, 
size_t
 *)

1993 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_®loÿ‹d
, 
ùl_¡©s
.
®loÿ‹d
, 
size_t
)

1994 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_aùive
, 
ùl_¡©s
.
aùive
, 
size_t
)

1995 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_m‘ad©a
, 
ùl_¡©s
.
m‘ad©a
, 
size_t
)

1996 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_»sid’t
, 
ùl_¡©s
.
»sid’t
, 
size_t
)

1997 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_m­³d
, 
ùl_¡©s
.
m­³d
, 
size_t
)

1999 
	$CTL_RO_GEN
(
¡©s_¬’as_i_dss
, 
ùl_¡©s
.
¬’as
[
mib
[2]].
dss
, const *)

2000 
	$CTL_RO_GEN
(
¡©s_¬’as_i_lg_dœty_muÉ
, 
ùl_¡©s
.
¬’as
[
mib
[2]].
lg_dœty_muÉ
,

2001 
ssize_t
)

2002 
	$CTL_RO_GEN
(
¡©s_¬’as_i_Áh»ads
, 
ùl_¡©s
.
¬’as
[
mib
[2]].
Áh»ads
, )

2003 
	$CTL_RO_GEN
(
¡©s_¬’as_i_·ùive
, 
ùl_¡©s
.
¬’as
[
mib
[2]].
·ùive
, 
size_t
)

2004 
	$CTL_RO_GEN
(
¡©s_¬’as_i_pdœty
, 
ùl_¡©s
.
¬’as
[
mib
[2]].
pdœty
, 
size_t
)

2005 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_m­³d
,

2006 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
m­³d
, 
size_t
)

2007 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Åurge
,

2008 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
Åurge
, 
ušt64_t
)

2009 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_nmadvi£
,

2010 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nmadvi£
, 
ušt64_t
)

2011 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_purged
,

2012 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
purged
, 
ušt64_t
)

2013 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_m‘ad©a_m­³d
,

2014 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
m‘ad©a_m­³d
, 
size_t
)

2015 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_m‘ad©a_®loÿ‹d
,

2016 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
m‘ad©a_®loÿ‹d
, 
size_t
)

2018 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_sm®l_®loÿ‹d
,

2019 
ùl_¡©s
.
¬’as
[
mib
[2]].
®loÿ‹d_sm®l
, 
size_t
)

2020 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_sm®l_nm®loc
,

2021 
ùl_¡©s
.
¬’as
[
mib
[2]].
nm®loc_sm®l
, 
ušt64_t
)

2022 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_sm®l_nd®loc
,

2023 
ùl_¡©s
.
¬’as
[
mib
[2]].
nd®loc_sm®l
, 
ušt64_t
)

2024 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_sm®l_Äeque¡s
,

2025 
ùl_¡©s
.
¬’as
[
mib
[2]].
Äeque¡s_sm®l
, 
ušt64_t
)

2026 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ïrge_®loÿ‹d
,

2027 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
®loÿ‹d_Ïrge
, 
size_t
)

2028 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ïrge_nm®loc
,

2029 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nm®loc_Ïrge
, 
ušt64_t
)

2030 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ïrge_nd®loc
,

2031 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nd®loc_Ïrge
, 
ušt64_t
)

2032 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ïrge_Äeque¡s
,

2033 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
Äeque¡s_Ïrge
, 
ušt64_t
)

2034 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_huge_®loÿ‹d
,

2035 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
®loÿ‹d_huge
, 
size_t
)

2036 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_huge_nm®loc
,

2037 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nm®loc_huge
, 
ušt64_t
)

2038 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_huge_nd®loc
,

2039 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nd®loc_huge
, 
ušt64_t
)

2040 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_huge_Äeque¡s
,

2041 
ùl_¡©s
.
¬’as
[
mib
[2]].
a¡©s
.
nm®loc_huge
, 
ušt64_t
)

2043 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_nm®loc
,

2044 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
nm®loc
, 
ušt64_t
)

2045 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_nd®loc
,

2046 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
nd®loc
, 
ušt64_t
)

2047 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_Äeque¡s
,

2048 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
Äeque¡s
, 
ušt64_t
)

2049 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_cu¼egs
,

2050 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
cu¼egs
, 
size_t
)

2051 
	$CTL_RO_CGEN
(
cÚfig_¡©s
 && 
cÚfig_tÿche
, 
¡©s_¬’as_i_bšs_j_nfls
,

2052 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
nfls
, 
ušt64_t
)

2053 
	$CTL_RO_CGEN
(
cÚfig_¡©s
 && 
cÚfig_tÿche
, 
¡©s_¬’as_i_bšs_j_næushes
,

2054 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
næushes
, 
ušt64_t
)

2055 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_Äuns
,

2056 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
Äuns
, 
ušt64_t
)

2057 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_Ä”uns
,

2058 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
»runs
, 
ušt64_t
)

2059 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_bšs_j_cu¼uns
,

2060 
ùl_¡©s
.
¬’as
[
mib
[2]].
b¡©s
[mib[4]].
cu¼uns
, 
size_t
)

2062 cÚ¡ 
ùl_Çmed_node_t
 *

2063 
	$¡©s_¬’as_i_bšs_j_šdex
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
j
)

2066 ià(
j
 > 
NBINS
)

2067  (
NULL
);

2068  (
su³r_¡©s_¬’as_i_bšs_j_node
);

2069 
	}
}

2071 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ìuns_j_nm®loc
,

2072 
ùl_¡©s
.
¬’as
[
mib
[2]].
l¡©s
[mib[4]].
nm®loc
, 
ušt64_t
)

2073 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ìuns_j_nd®loc
,

2074 
ùl_¡©s
.
¬’as
[
mib
[2]].
l¡©s
[mib[4]].
nd®loc
, 
ušt64_t
)

2075 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ìuns_j_Äeque¡s
,

2076 
ùl_¡©s
.
¬’as
[
mib
[2]].
l¡©s
[mib[4]].
Äeque¡s
, 
ušt64_t
)

2077 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_Ìuns_j_cu¼uns
,

2078 
ùl_¡©s
.
¬’as
[
mib
[2]].
l¡©s
[mib[4]].
cu¼uns
, 
size_t
)

2080 cÚ¡ 
ùl_Çmed_node_t
 *

2081 
	$¡©s_¬’as_i_Ìuns_j_šdex
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
j
)

2084 ià(
j
 > 
Æşas£s
)

2085  (
NULL
);

2086  (
su³r_¡©s_¬’as_i_Ìuns_j_node
);

2087 
	}
}

2089 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_hchunks_j_nm®loc
,

2090 
ùl_¡©s
.
¬’as
[
mib
[2]].
h¡©s
[mib[4]].
nm®loc
, 
ušt64_t
)

2091 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_hchunks_j_nd®loc
,

2092 
ùl_¡©s
.
¬’as
[
mib
[2]].
h¡©s
[mib[4]].
nd®loc
, 
ušt64_t
)

2093 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_hchunks_j_Äeque¡s
,

2094 
ùl_¡©s
.
¬’as
[
mib
[2]].
h¡©s
[mib[4]].
nm®loc
,

2095 
ušt64_t
)

2096 
	$CTL_RO_CGEN
(
cÚfig_¡©s
, 
¡©s_¬’as_i_hchunks_j_curhchunks
,

2097 
ùl_¡©s
.
¬’as
[
mib
[2]].
h¡©s
[mib[4]].
curhchunks
, 
size_t
)

2099 cÚ¡ 
ùl_Çmed_node_t
 *

2100 
	$¡©s_¬’as_i_hchunks_j_šdex
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
j
)

2103 ià(
j
 > 
nhşas£s
)

2104  (
NULL
);

2105  (
su³r_¡©s_¬’as_i_hchunks_j_node
);

2106 
	}
}

2108 cÚ¡ 
ùl_Çmed_node_t
 *

2109 
	$¡©s_¬’as_i_šdex
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, size_ˆ
i
)

2111 cÚ¡ 
ùl_Çmed_node_t
 * 
»t
;

2113 
	`m®loc_mu‹x_lock
(&
ùl_mtx
);

2114 ià(
i
 > 
ùl_¡©s
.
Ç»Çs
 || !ùl_¡©s.
¬’as
[i].
š™Ÿlized
) {

2115 
»t
 = 
NULL
;

2116 
Ïb–_»tuº
;

2119 
»t
 = 
su³r_¡©s_¬’as_i_node
;

2120 
Ïb–_»tuº
:

2121 
	`m®loc_mu‹x_uÆock
(&
ùl_mtx
);

2122  (
»t
);

2123 
	}
}

	@deps/jemalloc/src/extent.c

1 
	#JEMALLOC_EXTENT_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

6 
JEMALLOC_INLINE_C
 
size_t


7 
	$ex‹Á_quªtize
(
size_t
 
size
)

14  (
	`šdex2size
(
	`size2šdex
(
size
 + 1) - 1));

15 
	}
}

17 
JEMALLOC_INLINE_C
 

18 
	$ex‹Á_szad_comp
(
ex‹Á_node_t
 *
a
,ƒx‹Á_node_ˆ*
b
)

20 
»t
;

21 
size_t
 
a_qsize
 = 
	`ex‹Á_quªtize
(
	`ex‹Á_node_size_g‘
(
a
));

22 
size_t
 
b_qsize
 = 
	`ex‹Á_quªtize
(
	`ex‹Á_node_size_g‘
(
b
));

28 
»t
 = (
a_qsize
 > 
b_qsize
) - (a_qsize < b_qsize);

29 ià(
»t
 == 0) {

30 
ušŒ_t
 
a_addr
 = (ušŒ_t)
	`ex‹Á_node_addr_g‘
(
a
);

31 
ušŒ_t
 
b_addr
 = (ušŒ_t)
	`ex‹Á_node_addr_g‘
(
b
);

33 
»t
 = (
a_addr
 > 
b_addr
) - (a_addr < b_addr);

36  (
»t
);

37 
	}
}

40 
	$rb_g’
(, 
ex‹Á_Œ“_szad_
, 
ex‹Á_Œ“_t
, 
ex‹Á_node_t
, 
szad_lšk
,

41 
ex‹Á_szad_comp
)

43 
JEMALLOC_INLINE_C
 

44 
	$ex‹Á_ad_comp
(
ex‹Á_node_t
 *
a
,ƒx‹Á_node_ˆ*
b
)

46 
ušŒ_t
 
a_addr
 = (ušŒ_t)
	`ex‹Á_node_addr_g‘
(
a
);

47 
ušŒ_t
 
b_addr
 = (ušŒ_t)
	`ex‹Á_node_addr_g‘
(
b
);

49  ((
a_addr
 > 
b_addr
) - (a_addr < b_addr));

50 
	}
}

53 
rb_g’
(, 
ex‹Á_Œ“_ad_
, 
ex‹Á_Œ“_t
, 
ex‹Á_node_t
, 
ad_lšk
, 
ex‹Á_ad_comp
)

	@deps/jemalloc/src/hash.c

1 
	#JEMALLOC_HASH_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

	@deps/jemalloc/src/huge.c

1 
	#JEMALLOC_HUGE_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

6 
ex‹Á_node_t
 *

7 
	$huge_node_g‘
(cÚ¡ *
±r
)

9 
ex‹Á_node_t
 *
node
;

11 
node
 = 
	`chunk_lookup
(
±r
, 
Œue
);

12 
	`as£¹
(!
	`ex‹Á_node_achunk_g‘
(
node
));

14  (
node
);

15 
	}
}

17 
boŞ


18 
	$huge_node_£t
(cÚ¡ *
±r
, 
ex‹Á_node_t
 *
node
)

21 
	`as£¹
(
	`ex‹Á_node_addr_g‘
(
node
è=ğ
±r
);

22 
	`as£¹
(!
	`ex‹Á_node_achunk_g‘
(
node
));

23  (
	`chunk_»gi¡”
(
±r
, 
node
));

24 
	}
}

27 
	$huge_node_un£t
(cÚ¡ *
±r
, cÚ¡ 
ex‹Á_node_t
 *
node
)

30 
	`chunk_d”egi¡”
(
±r
, 
node
);

31 
	}
}

34 
	$huge_m®loc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
, 
boŞ
 
z”o
,

35 
tÿche_t
 *
tÿche
)

37 
size_t
 
usize
;

39 
usize
 = 
	`s2u
(
size
);

40 ià(
usize
 == 0) {

42  (
NULL
);

45  (
	`huge_·Îoc
(
tsd
, 
¬’a
, 
usize
, 
chunksize
, 
z”o
, 
tÿche
));

46 
	}
}

49 
	$huge_·Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
size_t
 
size
, size_ˆ
®ignm’t
,

50 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
)

52 *
»t
;

53 
size_t
 
usize
;

54 
ex‹Á_node_t
 *
node
;

55 
boŞ
 
is_z”Ûd
;

59 
usize
 = 
	`§2u
(
size
, 
®ignm’t
);

60 ià(
	`uÆik–y
(
usize
 == 0))

61  (
NULL
);

62 
	`as£¹
(
usize
 >ğ
chunksize
);

65 
node
 = 
	`®locztm
(
tsd
, 
	`CACHELINE_CEILING
((
ex‹Á_node_t
)),

66 
CACHELINE
, 
çl£
, 
tÿche
, 
Œue
, 
¬’a
);

67 ià(
node
 =ğ
NULL
)

68  (
NULL
);

74 
is_z”Ûd
 = 
z”o
;

75 
¬’a
 = 
	`¬’a_choo£
(
tsd
,‡rena);

76 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
è|| (
»t
 = 
	`¬’a_chunk_®loc_huge
(arena,

77 
size
, 
®ignm’t
, &
is_z”Ûd
)è=ğ
NULL
) {

78 
	`id®loùm
(
tsd
, 
node
, 
tÿche
, 
Œue
);

79  (
NULL
);

82 
	`ex‹Á_node_š™
(
node
, 
¬’a
, 
»t
, 
size
, 
is_z”Ûd
, 
Œue
);

84 ià(
	`huge_node_£t
(
»t
, 
node
)) {

85 
	`¬’a_chunk_d®loc_huge
(
¬’a
, 
»t
, 
size
);

86 
	`id®loùm
(
tsd
, 
node
, 
tÿche
, 
Œue
);

87  (
NULL
);

91 
	`m®loc_mu‹x_lock
(&
¬’a
->
huge_mtx
);

92 
	`ql_–m_Ãw
(
node
, 
ql_lšk
);

93 
	`ql__š£¹
(&
¬’a
->
huge
, 
node
, 
ql_lšk
);

94 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
huge_mtx
);

96 ià(
z”o
 || (
cÚfig_fl
 && 
	`uÆik–y
(
İt_z”o
))) {

97 ià(!
is_z”Ûd
)

98 
	`mem£t
(
»t
, 0, 
size
);

99 } ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
))

100 
	`mem£t
(
»t
, 0xa5, 
size
);

102  (
»t
);

103 
	}
}

105 #ifdeà
JEMALLOC_JET


106 #undeà
huge_d®loc_junk


107 
	#huge_d®loc_junk
 
	`JEMALLOC_N
(
huge_d®loc_junk_im¶
)

	)

110 
	$huge_d®loc_junk
(*
±r
, 
size_t
 
usize
)

113 ià(
cÚfig_fl
 && 
have_dss
 && 
	`uÆik–y
(
İt_junk_ä“
)) {

118 ià(!
cÚfig_munm­
 || (
have_dss
 && 
	`chunk_š_dss
(
±r
)))

119 
	`mem£t
(
±r
, 0x5a, 
usize
);

121 
	}
}

122 #ifdeà
JEMALLOC_JET


123 #undeà
huge_d®loc_junk


124 
	#huge_d®loc_junk
 
	`JEMALLOC_N
(
huge_d®loc_junk
)

	)

125 
huge_d®loc_junk_t
 *
	ghuge_d®loc_junk
 = 
JEMALLOC_N
(
huge_d®loc_junk_im¶
);

129 
	$huge_¿Îoc_no_move_sim¬
(*
±r
, 
size_t
 
Şdsize
, size_ˆ
usize_mš
,

130 
size_t
 
usize_max
, 
boŞ
 
z”o
)

132 
size_t
 
usize
, 
usize_Ãxt
;

133 
ex‹Á_node_t
 *
node
;

134 
¬’a_t
 *
¬’a
;

135 
chunk_hooks_t
 
chunk_hooks
 = 
CHUNK_HOOKS_INITIALIZER
;

136 
boŞ
 
´e_z”Ûd
, 
po¡_z”Ûd
;

139 
usize
 = 
usize_mš
; usiz< 
usize_max
 && (
usize_Ãxt
 = 
	`s2u
(usize+1))

140 <ğ
Şdsize
; 
usize
 = 
usize_Ãxt
)

143 ià(
Şdsize
 =ğ
usize
)

146 
node
 = 
	`huge_node_g‘
(
±r
);

147 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

148 
´e_z”Ûd
 = 
	`ex‹Á_node_z”Ûd_g‘
(
node
);

151 ià(
Şdsize
 > 
usize
) {

152 
size_t
 
sdiff
 = 
Şdsize
 - 
usize
;

153 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
)) {

154 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
usize
), 0x5a, 
sdiff
);

155 
po¡_z”Ûd
 = 
çl£
;

157 
po¡_z”Ûd
 = !
	`chunk_purge_w¿µ”
(
¬’a
, &
chunk_hooks
,

158 
±r
, 
	`CHUNK_CEILING
(
Şdsize
), 
usize
, 
sdiff
);

161 
po¡_z”Ûd
 = 
´e_z”Ûd
;

163 
	`m®loc_mu‹x_lock
(&
¬’a
->
huge_mtx
);

165 
	`as£¹
(
	`ex‹Á_node_size_g‘
(
node
è!ğ
usize
);

166 
	`ex‹Á_node_size_£t
(
node
, 
usize
);

168 
	`ex‹Á_node_z”Ûd_£t
(
node
, 
po¡_z”Ûd
);

169 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
huge_mtx
);

171 
	`¬’a_chunk_¿Îoc_huge_sim¬
(
¬’a
, 
±r
, 
Şdsize
, 
usize
);

174 ià(
Şdsize
 < 
usize
) {

175 ià(
z”o
 || (
cÚfig_fl
 && 
	`uÆik–y
(
İt_z”o
))) {

176 ià(!
´e_z”Ûd
) {

177 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
), 0,

178 
usize
 - 
Şdsize
);

180 } ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
)) {

181 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
), 0xa5, 
usize
 -

182 
Şdsize
);

185 
	}
}

187 
boŞ


188 
	$huge_¿Îoc_no_move_shršk
(*
±r
, 
size_t
 
Şdsize
, size_ˆ
usize
)

190 
ex‹Á_node_t
 *
node
;

191 
¬’a_t
 *
¬’a
;

192 
chunk_hooks_t
 
chunk_hooks
;

193 
size_t
 
cdiff
;

194 
boŞ
 
´e_z”Ûd
, 
po¡_z”Ûd
;

196 
node
 = 
	`huge_node_g‘
(
±r
);

197 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

198 
´e_z”Ûd
 = 
	`ex‹Á_node_z”Ûd_g‘
(
node
);

199 
chunk_hooks
 = 
	`chunk_hooks_g‘
(
¬’a
);

201 
	`as£¹
(
Şdsize
 > 
usize
);

204 
cdiff
 = 
	`CHUNK_CEILING
(
Şdsize
è- CHUNK_CEILING(
usize
);

205 ià(
cdiff
 !ğ0 && 
chunk_hooks
.
	`¥l™
(
±r
, 
	`CHUNK_CEILING
(
Şdsize
),

206 
	`CHUNK_CEILING
(
usize
), 
cdiff
, 
Œue
, 
¬’a
->
šd
))

207  (
Œue
);

209 ià(
Şdsize
 > 
usize
) {

210 
size_t
 
sdiff
 = 
Şdsize
 - 
usize
;

211 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
)) {

212 
	`huge_d®loc_junk
((*)((
ušŒ_t
)
±r
 + 
usize
),

213 
sdiff
);

214 
po¡_z”Ûd
 = 
çl£
;

216 
po¡_z”Ûd
 = !
	`chunk_purge_w¿µ”
(
¬’a
, &
chunk_hooks
,

217 
	`CHUNK_ADDR2BASE
((
ušŒ_t
)
±r
 + 
usize
),

218 
	`CHUNK_CEILING
(
Şdsize
),

219 
	`CHUNK_ADDR2OFFSET
((
ušŒ_t
)
±r
 + 
usize
), 
sdiff
);

222 
po¡_z”Ûd
 = 
´e_z”Ûd
;

224 
	`m®loc_mu‹x_lock
(&
¬’a
->
huge_mtx
);

226 
	`ex‹Á_node_size_£t
(
node
, 
usize
);

228 
	`ex‹Á_node_z”Ûd_£t
(
node
, 
po¡_z”Ûd
);

229 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
huge_mtx
);

232 
	`¬’a_chunk_¿Îoc_huge_shršk
(
¬’a
, 
±r
, 
Şdsize
, 
usize
);

234  (
çl£
);

235 
	}
}

237 
boŞ


238 
	$huge_¿Îoc_no_move_ex·nd
(*
±r
, 
size_t
 
Şdsize
, size_ˆ
usize
, 
boŞ
 
z”o
) {

239 
ex‹Á_node_t
 *
node
;

240 
¬’a_t
 *
¬’a
;

241 
boŞ
 
is_z”Ûd_subchunk
, 
is_z”Ûd_chunk
;

243 
node
 = 
	`huge_node_g‘
(
±r
);

244 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

245 
	`m®loc_mu‹x_lock
(&
¬’a
->
huge_mtx
);

246 
is_z”Ûd_subchunk
 = 
	`ex‹Á_node_z”Ûd_g‘
(
node
);

247 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
huge_mtx
);

253 
is_z”Ûd_chunk
 = 
z”o
;

255 ià(
	`¬’a_chunk_¿Îoc_huge_ex·nd
(
¬’a
, 
±r
, 
Şdsize
, 
usize
,

256 &
is_z”Ûd_chunk
))

257  (
Œue
);

259 
	`m®loc_mu‹x_lock
(&
¬’a
->
huge_mtx
);

261 
	`ex‹Á_node_size_£t
(
node
, 
usize
);

262 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
huge_mtx
);

264 ià(
z”o
 || (
cÚfig_fl
 && 
	`uÆik–y
(
İt_z”o
))) {

265 ià(!
is_z”Ûd_subchunk
) {

266 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
), 0,

267 
	`CHUNK_CEILING
(
Şdsize
) - oldsize);

269 ià(!
is_z”Ûd_chunk
) {

270 
	`mem£t
((*)((
ušŒ_t
)
±r
 +

271 
	`CHUNK_CEILING
(
Şdsize
)), 0, 
usize
 -

272 
	`CHUNK_CEILING
(
Şdsize
));

274 } ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_®loc
)) {

275 
	`mem£t
((*)((
ušŒ_t
)
±r
 + 
Şdsize
), 0xa5, 
usize
 -

276 
Şdsize
);

279  (
çl£
);

280 
	}
}

282 
boŞ


283 
	$huge_¿Îoc_no_move
(*
±r
, 
size_t
 
Şdsize
, size_ˆ
usize_mš
,

284 
size_t
 
usize_max
, 
boŞ
 
z”o
)

287 
	`as£¹
(
	`s2u
(
Şdsize
) == oldsize);

290 ià(
Şdsize
 < 
chunksize
 || 
usize_max
 < chunksize)

291  (
Œue
);

293 ià(
	`CHUNK_CEILING
(
usize_max
è> CHUNK_CEILING(
Şdsize
)) {

295 ià(!
	`huge_¿Îoc_no_move_ex·nd
(
±r
, 
Şdsize
, 
usize_max
, 
z”o
))

296  (
çl£
);

298 ià(
usize_mš
 < 
usize_max
 && 
	`CHUNK_CEILING
(usize_min) >

299 
	`CHUNK_CEILING
(
Şdsize
è&& 
	`huge_¿Îoc_no_move_ex·nd
(
±r
,

300 
Şdsize
, 
usize_mš
, 
z”o
))

301  (
çl£
);

308 ià(
	`CHUNK_CEILING
(
Şdsize
è>ğCHUNK_CEILING(
usize_mš
)

309 && 
	`CHUNK_CEILING
(
Şdsize
è<ğCHUNK_CEILING(
usize_max
)) {

310 
	`huge_¿Îoc_no_move_sim¬
(
±r
, 
Şdsize
, 
usize_mš
, 
usize_max
,

311 
z”o
);

312  (
çl£
);

316 ià(
	`CHUNK_CEILING
(
Şdsize
è> CHUNK_CEILING(
usize_max
))

317  (
	`huge_¿Îoc_no_move_shršk
(
±r
, 
Şdsize
, 
usize_max
));

318  (
Œue
);

319 
	}
}

322 
	$huge_¿Îoc_move_h–³r
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
size_t
 
usize
,

323 
size_t
 
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
)

326 ià(
®ignm’t
 <ğ
chunksize
)

327  (
	`huge_m®loc
(
tsd
, 
¬’a
, 
usize
, 
z”o
, 
tÿche
));

328  (
	`huge_·Îoc
(
tsd
, 
¬’a
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
));

329 
	}
}

332 
	$huge_¿Îoc
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, *
±r
, 
size_t
 
Şdsize
, size_ˆ
usize
,

333 
size_t
 
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
)

335 *
»t
;

336 
size_t
 
cİysize
;

339 ià(!
	`huge_¿Îoc_no_move
(
±r
, 
Şdsize
, 
usize
, usize, 
z”o
))

340  (
±r
);

347 
»t
 = 
	`huge_¿Îoc_move_h–³r
(
tsd
, 
¬’a
, 
usize
, 
®ignm’t
, 
z”o
,

348 
tÿche
);

349 ià(
»t
 =ğ
NULL
)

350  (
NULL
);

352 
cİysize
 = (
usize
 < 
Şdsize
) ? usize : oldsize;

353 
	`memıy
(
»t
, 
±r
, 
cİysize
);

354 
	`isq®loc
(
tsd
, 
±r
, 
Şdsize
, 
tÿche
);

355  (
»t
);

356 
	}
}

359 
	$huge_d®loc
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
)

361 
ex‹Á_node_t
 *
node
;

362 
¬’a_t
 *
¬’a
;

364 
node
 = 
	`huge_node_g‘
(
±r
);

365 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

366 
	`huge_node_un£t
(
±r
, 
node
);

367 
	`m®loc_mu‹x_lock
(&
¬’a
->
huge_mtx
);

368 
	`ql_»move
(&
¬’a
->
huge
, 
node
, 
ql_lšk
);

369 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
huge_mtx
);

371 
	`huge_d®loc_junk
(
	`ex‹Á_node_addr_g‘
(
node
),

372 
	`ex‹Á_node_size_g‘
(
node
));

373 
	`¬’a_chunk_d®loc_huge
(
	`ex‹Á_node_¬’a_g‘
(
node
),

374 
	`ex‹Á_node_addr_g‘
(
node
), 
	`ex‹Á_node_size_g‘
(node));

375 
	`id®loùm
(
tsd
, 
node
, 
tÿche
, 
Œue
);

376 
	}
}

378 
¬’a_t
 *

379 
	$huge_¯Îoc
(cÚ¡ *
±r
)

382  (
	`ex‹Á_node_¬’a_g‘
(
	`huge_node_g‘
(
±r
)));

383 
	}
}

385 
size_t


386 
	$huge_§Îoc
(cÚ¡ *
±r
)

388 
size_t
 
size
;

389 
ex‹Á_node_t
 *
node
;

390 
¬’a_t
 *
¬’a
;

392 
node
 = 
	`huge_node_g‘
(
±r
);

393 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

394 
	`m®loc_mu‹x_lock
(&
¬’a
->
huge_mtx
);

395 
size
 = 
	`ex‹Á_node_size_g‘
(
node
);

396 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
huge_mtx
);

398  (
size
);

399 
	}
}

401 
´of_tùx_t
 *

402 
	$huge_´of_tùx_g‘
(cÚ¡ *
±r
)

404 
´of_tùx_t
 *
tùx
;

405 
ex‹Á_node_t
 *
node
;

406 
¬’a_t
 *
¬’a
;

408 
node
 = 
	`huge_node_g‘
(
±r
);

409 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

410 
	`m®loc_mu‹x_lock
(&
¬’a
->
huge_mtx
);

411 
tùx
 = 
	`ex‹Á_node_´of_tùx_g‘
(
node
);

412 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
huge_mtx
);

414  (
tùx
);

415 
	}
}

418 
	$huge_´of_tùx_£t
(cÚ¡ *
±r
, 
´of_tùx_t
 *
tùx
)

420 
ex‹Á_node_t
 *
node
;

421 
¬’a_t
 *
¬’a
;

423 
node
 = 
	`huge_node_g‘
(
±r
);

424 
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(
node
);

425 
	`m®loc_mu‹x_lock
(&
¬’a
->
huge_mtx
);

426 
	`ex‹Á_node_´of_tùx_£t
(
node
, 
tùx
);

427 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
huge_mtx
);

428 
	}
}

431 
	$huge_´of_tùx_»£t
(cÚ¡ *
±r
)

434 
	`huge_´of_tùx_£t
(
±r
, (
´of_tùx_t
 *)(
ušŒ_t
)1U);

435 
	}
}

	@deps/jemalloc/src/jemalloc.c

1 
	#JEMALLOC_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

8 cÚ¡ *
je_m®loc_cÚf
 
JEMALLOC_ATTR
(
w—k
);

9 
boŞ
 
	gİt_abÜt
 =

10 #ifdeà
JEMALLOC_DEBUG


11 
Œue


13 
çl£


16 cÚ¡ *
	gİt_junk
 =

17 #ià(
defšed
(
JEMALLOC_DEBUG
è&& defšed(
JEMALLOC_FILL
))

23 
boŞ
 
	gİt_junk_®loc
 =

24 #ià(
defšed
(
JEMALLOC_DEBUG
è&& defšed(
JEMALLOC_FILL
))

25 
Œue


27 
çl£


30 
boŞ
 
	gİt_junk_ä“
 =

31 #ià(
defšed
(
JEMALLOC_DEBUG
è&& defšed(
JEMALLOC_FILL
))

32 
Œue


34 
çl£


38 
size_t
 
	gİt_qu¬ªtše
 = 
ZU
(0);

39 
boŞ
 
	gİt_»dzÚe
 = 
çl£
;

40 
boŞ
 
	gİt_uŒaû
 = 
çl£
;

41 
boŞ
 
	gİt_xm®loc
 = 
çl£
;

42 
boŞ
 
	gİt_z”o
 = 
çl£
;

43 
size_t
 
	gİt_Ç»Çs
 = 0;

46 
boŞ
 
	gš_v®gršd
;

48 
	gnıus
;

51 
m®loc_mu‹x_t
 
	g¬’as_lock
;

60 
¬’a_t
 **
	g¬’as
;

61 
	gÇ»Çs_tÙ®
;

62 
¬’a_t
 *
	ga0
;

63 
	gÇ»Çs_auto
;

66 
	mm®loc_š™_unš™Ÿlized
 = 3,

67 
	mm®loc_š™_a0_š™Ÿlized
 = 2,

68 
	mm®loc_š™_»cursibË
 = 1,

69 
	mm®loc_š™_š™Ÿlized
 = 0

70 } 
	tm®loc_š™_t
;

71 
m®loc_š™_t
 
	gm®loc_š™_¡©e
 = 
m®loc_š™_unš™Ÿlized
;

73 
	$JEMALLOC_ALIGNED
(
CACHELINE
)

74 cÚ¡ 
size_t
 
šdex2size_b
[
NSIZES
] = {

75 
	#SC
(
šdex
, 
lg_g½
, 
lg_d–
, 
nd–
, 
bš
, 
lg_d–_lookup
) \

76 ((
	`ZU
(1)<<
lg_g½
è+ (ZU(
nd–
)<<
lg_d–
)),

	)

77 
SIZE_CLASSES


78 #undeà
SC


79 
	}
};

81 
	$JEMALLOC_ALIGNED
(
CACHELINE
)

82 cÚ¡ 
ušt8_t
 
size2šdex_b
[] = {

83 #ià
LG_TINY_MIN
 == 0

85 
	#S2B_0
(
i
èi,

	)

86 #–ià
LG_TINY_MIN
 == 1

88 
	#S2B_1
(
i
èi,

	)

89 #–ià
LG_TINY_MIN
 == 2

91 
	#S2B_2
(
i
èi,

	)

92 #–ià
LG_TINY_MIN
 == 3

93 
	#S2B_3
(
i
èi,

	)

94 #–ià
LG_TINY_MIN
 == 4

95 
	#S2B_4
(
i
èi,

	)

96 #–ià
LG_TINY_MIN
 == 5

97 
	#S2B_5
(
i
èi,

	)

98 #–ià
LG_TINY_MIN
 == 6

99 
	#S2B_6
(
i
èi,

	)

100 #–ià
LG_TINY_MIN
 == 7

101 
	#S2B_7
(
i
èi,

	)

102 #–ià
LG_TINY_MIN
 == 8

103 
	#S2B_8
(
i
èi,

	)

104 #–ià
LG_TINY_MIN
 == 9

105 
	#S2B_9
(
i
èi,

	)

106 #–ià
LG_TINY_MIN
 == 10

107 
	#S2B_10
(
i
èi,

	)

108 #–ià
LG_TINY_MIN
 == 11

109 
	#S2B_11
(
i
èi,

	)

113 #ià
LG_TINY_MIN
 < 1

114 
	#S2B_1
(
i
è
	`S2B_0
(ièS2B_0(i)

	)

116 #ià
LG_TINY_MIN
 < 2

117 
	#S2B_2
(
i
è
	`S2B_1
(ièS2B_1(i)

	)

119 #ià
LG_TINY_MIN
 < 3

120 
	#S2B_3
(
i
è
	`S2B_2
(ièS2B_2(i)

	)

122 #ià
LG_TINY_MIN
 < 4

123 
	#S2B_4
(
i
è
	`S2B_3
(ièS2B_3(i)

	)

125 #ià
LG_TINY_MIN
 < 5

126 
	#S2B_5
(
i
è
	`S2B_4
(ièS2B_4(i)

	)

128 #ià
LG_TINY_MIN
 < 6

129 
	#S2B_6
(
i
è
	`S2B_5
(ièS2B_5(i)

	)

131 #ià
LG_TINY_MIN
 < 7

132 
	#S2B_7
(
i
è
	`S2B_6
(ièS2B_6(i)

	)

134 #ià
LG_TINY_MIN
 < 8

135 
	#S2B_8
(
i
è
	`S2B_7
(ièS2B_7(i)

	)

137 #ià
LG_TINY_MIN
 < 9

138 
	#S2B_9
(
i
è
	`S2B_8
(ièS2B_8(i)

	)

140 #ià
LG_TINY_MIN
 < 10

141 
	#S2B_10
(
i
è
	`S2B_9
(ièS2B_9(i)

	)

143 #ià
LG_TINY_MIN
 < 11

144 
	#S2B_11
(
i
è
	`S2B_10
(ièS2B_10(i)

	)

146 
	#S2B_no
(
i
)

	)

147 
	#SC
(
šdex
, 
lg_g½
, 
lg_d–
, 
nd–
, 
bš
, 
lg_d–_lookup
) \

148 
S2B_
##
	`lg_d–_lookup
(
šdex
)

	)

149 
SIZE_CLASSES


150 #undeà
S2B_3


151 #undeà
S2B_4


152 #undeà
S2B_5


153 #undeà
S2B_6


154 #undeà
S2B_7


155 #undeà
S2B_8


156 #undeà
S2B_9


157 #undeà
S2B_10


158 #undeà
S2B_11


159 #undeà
S2B_no


160 #undeà
SC


161 
	}
};

163 #ifdeà
JEMALLOC_THREADED_INIT


165 
	#NO_INITIALIZER
 (()0)

	)

166 
	#INITIALIZER
 
	`±h»ad_£lf
()

	)

167 
	#IS_INITIALIZER
 (
m®loc_š™Ÿliz”
 =ğ
	`±h»ad_£lf
())

	)

168 
±h»ad_t
 
	gm®loc_š™Ÿliz”
 = 
NO_INITIALIZER
;

170 
	#NO_INITIALIZER
 
çl£


	)

171 
	#INITIALIZER
 
Œue


	)

172 
	#IS_INITIALIZER
 
m®loc_š™Ÿliz”


	)

173 
boŞ
 
	gm®loc_š™Ÿliz”
 = 
NO_INITIALIZER
;

177 #ifdeà
_WIN32


178 #ià
_WIN32_WINNT
 >= 0x0600

179 
m®loc_mu‹x_t
 
	gš™_lock
 = 
SRWLOCK_INIT
;

181 
m®loc_mu‹x_t
 
	gš™_lock
;

182 
boŞ
 
	gš™_lock_š™Ÿlized
 = 
çl£
;

184 
	$JEMALLOC_ATTR
(
cÚ¡ruùÜ
)

185 
WINAPI


186 
	$_š™_š™_lock
()

197 ià(!
š™_lock_š™Ÿlized
)

198 
	`m®loc_mu‹x_š™
(&
š™_lock
);

199 
š™_lock_š™Ÿlized
 = 
Œue
;

200 
	}
}

202 #ifdeà
_MSC_VER


203 #´agm¨
£ùiÚ
(".CRT$XCU", 
»ad
)

204 
JEMALLOC_SECTION
(".CRT$XCU"è
	$JEMALLOC_ATTR
(
u£d
)

205 cÚ¡ (
WINAPI
 *
š™_š™_lock
)(èğ
_š™_š™_lock
;

209 
m®loc_mu‹x_t
 
š™_lock
 = 
MALLOC_MUTEX_INITIALIZER
;

213 *
p
;

214 
size_t
 
s
;

215 *
r
;

216 } 
	tm®loc_uŒaû_t
;

218 #ifdeà
JEMALLOC_UTRACE


219 
	#UTRACE
(
a
, 
b
, 
c
) do { \

220 ià(
	`uÆik–y
(
İt_uŒaû
)) { \

221 
uŒaû_£¼no
 = 
”ºo
; \

222 
m®loc_uŒaû_t
 
ut
; \

223 
ut
.
p
 = (
a
); \

224 
ut
.
s
 = (
b
); \

225 
ut
.
r
 = (
c
); \

226 
	`uŒaû
(&
ut
, (ut)); \

227 
”ºo
 = 
uŒaû_£¼no
; \

229 
	}
} 0)

	)

231 
	#UTRACE
(
a
, 
b
, 
c
)

	)

240 
boŞ
 
m®loc_š™_h¬d_a0
();

241 
boŞ
 
m®loc_š™_h¬d
();

248 
JEMALLOC_ALWAYS_INLINE_C
 
boŞ


249 
	$m®loc_š™Ÿlized
()

252  (
m®loc_š™_¡©e
 =ğ
m®loc_š™_š™Ÿlized
);

253 
	}
}

255 
JEMALLOC_ALWAYS_INLINE_C
 

256 
	$m®loc_th»ad_š™
()

268 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_qu¬ªtše
))

269 
	`qu¬ªtše_®loc_hook
();

270 
	}
}

272 
JEMALLOC_ALWAYS_INLINE_C
 
boŞ


273 
	$m®loc_š™_a0
()

276 ià(
	`uÆik–y
(
m®loc_š™_¡©e
 =ğ
m®loc_š™_unš™Ÿlized
))

277  (
	`m®loc_š™_h¬d_a0
());

278  (
çl£
);

279 
	}
}

281 
JEMALLOC_ALWAYS_INLINE_C
 
boŞ


282 
	$m®loc_š™
()

285 ià(
	`uÆik–y
(!
	`m®loc_š™Ÿlized
()è&& 
	`m®loc_š™_h¬d
())

286  (
Œue
);

287 
	`m®loc_th»ad_š™
();

289  (
çl£
);

290 
	}
}

297 
¬’a_t
 *

298 
	$a0g‘
()

301 
	`as£¹
(
a0
 !ğ
NULL
);

302  (
a0
);

303 
	}
}

306 
	$a0ŸÎoc
(
size_t
 
size
, 
boŞ
 
z”o
, boŞ 
is_m‘ad©a
)

309 ià(
	`uÆik–y
(
	`m®loc_š™_a0
()))

310  (
NULL
);

312  (
	`ŸÎocztm
(
NULL
, 
size
, 
z”o
, 
çl£
, 
is_m‘ad©a
, 
	`a0g‘
()));

313 
	}
}

316 
	$a0id®loc
(*
±r
, 
boŞ
 
is_m‘ad©a
)

319 
	`id®loùm
(
NULL
, 
±r
, 
çl£
, 
is_m‘ad©a
);

320 
	}
}

323 
	$a0m®loc
(
size_t
 
size
)

326  (
	`a0ŸÎoc
(
size
, 
çl£
, 
Œue
));

327 
	}
}

330 
	$a0d®loc
(*
±r
)

333 
	`a0id®loc
(
±r
, 
Œue
);

334 
	}
}

343 
	$boÙ¡¿p_m®loc
(
size_t
 
size
)

346 ià(
	`uÆik–y
(
size
 == 0))

347 
size
 = 1;

349  (
	`a0ŸÎoc
(
size
, 
çl£
, false));

350 
	}
}

353 
	$boÙ¡¿p_ÿÎoc
(
size_t
 
num
, size_ˆ
size
)

355 
size_t
 
num_size
;

357 
num_size
 = 
num
 * 
size
;

358 ià(
	`uÆik–y
(
num_size
 == 0)) {

359 
	`as£¹
(
num
 =ğ0 || 
size
 == 0);

360 
num_size
 = 1;

363  (
	`a0ŸÎoc
(
num_size
, 
Œue
, 
çl£
));

364 
	}
}

367 
	$boÙ¡¿p_ä“
(*
±r
)

370 ià(
	`uÆik–y
(
±r
 =ğ
NULL
))

373 
	`a0id®loc
(
±r
, 
çl£
);

374 
	}
}

377 
¬’a_t
 *

378 
	$¬’a_š™_locked
(
šd
)

380 
¬’a_t
 *
¬’a
;

383 
	`as£¹
(
šd
 <ğ
Ç»Çs_tÙ®
);

384 ià(
šd
 > 
MALLOCX_ARENA_MAX
)

385  (
NULL
);

386 ià(
šd
 =ğ
Ç»Çs_tÙ®
) {

387 
Ç»Çs_Ãw
 = 
Ç»Çs_tÙ®
 + 1;

388 
¬’a_t
 **
¬’as_Ãw
 =

389 (
¬’a_t
 **)
	`a0m®loc
(
	`CACHELINE_CEILING
(
Ç»Çs_Ãw
 *

390 (
¬’a_t
 *)));

391 ià(
¬’as_Ãw
 =ğ
NULL
)

392  (
NULL
);

393 
	`memıy
(
¬’as_Ãw
, 
¬’as
, 
Ç»Çs_tÙ®
 * (
¬’a_t
 *));

394 
¬’as_Ãw
[
šd
] = 
NULL
;

399 ià(
Ç»Çs_tÙ®
 !ğ
Ç»Çs_auto
)

400 
	`a0d®loc
(
¬’as
);

401 
¬’as
 = 
¬’as_Ãw
;

402 
Ç»Çs_tÙ®
 = 
Ç»Çs_Ãw
;

409 
¬’a
 = 
¬’as
[
šd
];

410 ià(
¬’a
 !ğ
NULL
) {

411 
	`as£¹
(
šd
 < 
Ç»Çs_auto
);

412  (
¬’a
);

416 
¬’a
 = 
¬’as
[
šd
] = 
	`¬’a_Ãw
(ind);

417  (
¬’a
);

418 
	}
}

420 
¬’a_t
 *

421 
	$¬’a_š™
(
šd
)

423 
¬’a_t
 *
¬’a
;

425 
	`m®loc_mu‹x_lock
(&
¬’as_lock
);

426 
¬’a
 = 
	`¬’a_š™_locked
(
šd
);

427 
	`m®loc_mu‹x_uÆock
(&
¬’as_lock
);

428  (
¬’a
);

429 
	}
}

432 
	$Ç»Çs_tÙ®_g‘
()

434 
Ç»Çs
;

436 
	`m®loc_mu‹x_lock
(&
¬’as_lock
);

437 
Ç»Çs
 = 
Ç»Çs_tÙ®
;

438 
	`m®loc_mu‹x_uÆock
(&
¬’as_lock
);

440  (
Ç»Çs
);

441 
	}
}

444 
	$¬’a_bšd_locked
(
tsd_t
 *
tsd
, 
šd
)

446 
¬’a_t
 *
¬’a
;

448 
¬’a
 = 
¬’as
[
šd
];

449 
¬’a
->
Áh»ads
++;

451 ià(
	`tsd_nomš®
(
tsd
))

452 
	`tsd_¬’a_£t
(
tsd
, 
¬’a
);

453 
	}
}

456 
	$¬’a_bšd
(
tsd_t
 *
tsd
, 
šd
)

459 
	`m®loc_mu‹x_lock
(&
¬’as_lock
);

460 
	`¬’a_bšd_locked
(
tsd
, 
šd
);

461 
	`m®loc_mu‹x_uÆock
(&
¬’as_lock
);

462 
	}
}

465 
	$¬’a_mig¿‹
(
tsd_t
 *
tsd
, 
Şdšd
, 
Ãwšd
)

467 
¬’a_t
 *
Şd¬’a
, *
Ãw¬’a
;

469 
	`m®loc_mu‹x_lock
(&
¬’as_lock
);

470 
Şd¬’a
 = 
¬’as
[
Şdšd
];

471 
Ãw¬’a
 = 
¬’as
[
Ãwšd
];

472 
Şd¬’a
->
Áh»ads
--;

473 
Ãw¬’a
->
Áh»ads
++;

474 
	`m®loc_mu‹x_uÆock
(&
¬’as_lock
);

475 
	`tsd_¬’a_£t
(
tsd
, 
Ãw¬’a
);

476 
	}
}

479 
	$¬’a_nbound
(
šd
)

481 
Áh»ads
;

483 
	`m®loc_mu‹x_lock
(&
¬’as_lock
);

484 
Áh»ads
 = 
¬’as
[
šd
]->nthreads;

485 
	`m®loc_mu‹x_uÆock
(&
¬’as_lock
);

486  (
Áh»ads
);

487 
	}
}

490 
	$¬’a_unbšd
(
tsd_t
 *
tsd
, 
šd
)

492 
¬’a_t
 *
¬’a
;

494 
	`m®loc_mu‹x_lock
(&
¬’as_lock
);

495 
¬’a
 = 
¬’as
[
šd
];

496 
¬’a
->
Áh»ads
--;

497 
	`m®loc_mu‹x_uÆock
(&
¬’as_lock
);

498 
	`tsd_¬’a_£t
(
tsd
, 
NULL
);

499 
	}
}

501 
¬’a_t
 *

502 
	$¬’a_g‘_h¬d
(
tsd_t
 *
tsd
, 
šd
, 
boŞ
 
š™_if_missšg
)

504 
¬’a_t
 *
¬’a
;

505 
¬’a_t
 **
¬’as_ÿche
 = 
	`tsd_¬’as_ÿche_g‘
(
tsd
);

506 
Ç»Çs_ÿche
 = 
	`tsd_Ç»Çs_ÿche_g‘
(
tsd
);

507 
Ç»Çs_aùu®
 = 
	`Ç»Çs_tÙ®_g‘
();

510 ià(
¬’as_ÿche
 !ğ
NULL
 && 
Ç»Çs_ÿche
 < 
Ç»Çs_aùu®
) {

511 
	`a0d®loc
(
¬’as_ÿche
);

512 
¬’as_ÿche
 = 
NULL
;

513 
Ç»Çs_ÿche
 = 0;

514 
	`tsd_¬’as_ÿche_£t
(
tsd
, 
¬’as_ÿche
);

515 
	`tsd_Ç»Çs_ÿche_£t
(
tsd
, 
Ç»Çs_ÿche
);

519 ià(
¬’as_ÿche
 =ğ
NULL
) {

520 
boŞ
 *
¬’as_ÿche_by·s¥
 = 
	`tsd_¬’as_ÿche_by·s¥_g‘
(
tsd
);

521 
	`as£¹
(
šd
 < 
Ç»Çs_aùu®
 || !
š™_if_missšg
);

522 
Ç»Çs_ÿche
 = (
šd
 < 
Ç»Çs_aùu®
) ?‚arenas_actual : ind+1;

524 ià(
	`tsd_nomš®
(
tsd
è&& !*
¬’as_ÿche_by·s¥
) {

525 *
¬’as_ÿche_by·s¥
 = 
Œue
;

526 
¬’as_ÿche
 = (
¬’a_t
 **)
	`a0m®loc
((arena_t *) *

527 
Ç»Çs_ÿche
);

528 *
¬’as_ÿche_by·s¥
 = 
çl£
;

530 ià(
¬’as_ÿche
 =ğ
NULL
) {

538 ià(
šd
 >ğ
Ç»Çs_aùu®
)

539  (
NULL
);

540 
	`m®loc_mu‹x_lock
(&
¬’as_lock
);

541 
¬’a
 = 
¬’as
[
šd
];

542 
	`m®loc_mu‹x_uÆock
(&
¬’as_lock
);

543  (
¬’a
);

545 
	`as£¹
(
	`tsd_nomš®
(
tsd
è&& !*
¬’as_ÿche_by·s¥
);

546 
	`tsd_¬’as_ÿche_£t
(
tsd
, 
¬’as_ÿche
);

547 
	`tsd_Ç»Çs_ÿche_£t
(
tsd
, 
Ç»Çs_ÿche
);

557 
	`m®loc_mu‹x_lock
(&
¬’as_lock
);

558 
	`memıy
(
¬’as_ÿche
, 
¬’as
, (
¬’a_t
 *è* 
Ç»Çs_aùu®
);

559 
	`m®loc_mu‹x_uÆock
(&
¬’as_lock
);

560 ià(
Ç»Çs_ÿche
 > 
Ç»Çs_aùu®
) {

561 
	`mem£t
(&
¬’as_ÿche
[
Ç»Çs_aùu®
], 0, (
¬’a_t
 *) *

562 (
Ç»Çs_ÿche
 - 
Ç»Çs_aùu®
));

566 
¬’a
 = 
¬’as_ÿche
[
šd
];

567 ià(
š™_if_missšg
 && 
¬’a
 =ğ
NULL
)

568 
¬’a
 = 
¬’as_ÿche
[
šd
] = 
	`¬’a_š™
(ind);

569  (
¬’a
);

570 
	}
}

573 
¬’a_t
 *

574 
	$¬’a_choo£_h¬d
(
tsd_t
 *
tsd
)

576 
¬’a_t
 *
»t
;

578 ià(
Ç»Çs_auto
 > 1) {

579 
i
, 
choo£
, 
fœ¡_nuÎ
;

581 
choo£
 = 0;

582 
fœ¡_nuÎ
 = 
Ç»Çs_auto
;

583 
	`m®loc_mu‹x_lock
(&
¬’as_lock
);

584 
	`as£¹
(
	`a0g‘
(è!ğ
NULL
);

585 
i
 = 1; i < 
Ç»Çs_auto
; i++) {

586 ià(
¬’as
[
i
] !ğ
NULL
) {

591 ià(
¬’as
[
i
]->
Áh»ads
 <

592 
¬’as
[
choo£
]->
Áh»ads
)

593 
choo£
 = 
i
;

594 } ià(
fœ¡_nuÎ
 =ğ
Ç»Çs_auto
) {

604 
fœ¡_nuÎ
 = 
i
;

608 ià(
¬’as
[
choo£
]->
Áh»ads
 == 0

609 || 
fœ¡_nuÎ
 =ğ
Ç»Çs_auto
) {

614 
»t
 = 
¬’as
[
choo£
];

617 
choo£
 = 
fœ¡_nuÎ
;

618 
»t
 = 
	`¬’a_š™_locked
(
choo£
);

619 ià(
»t
 =ğ
NULL
) {

620 
	`m®loc_mu‹x_uÆock
(&
¬’as_lock
);

621  (
NULL
);

624 
	`¬’a_bšd_locked
(
tsd
, 
choo£
);

625 
	`m®loc_mu‹x_uÆock
(&
¬’as_lock
);

627 
»t
 = 
	`a0g‘
();

628 
	`¬’a_bšd
(
tsd
, 0);

631  (
»t
);

632 
	}
}

635 
	$th»ad_®loÿ‹d_ş—nup
(
tsd_t
 *
tsd
)

639 
	}
}

642 
	$th»ad_d—Îoÿ‹d_ş—nup
(
tsd_t
 *
tsd
)

646 
	}
}

649 
	$¬’a_ş—nup
(
tsd_t
 *
tsd
)

651 
¬’a_t
 *
¬’a
;

653 
¬’a
 = 
	`tsd_¬’a_g‘
(
tsd
);

654 ià(
¬’a
 !ğ
NULL
)

655 
	`¬’a_unbšd
(
tsd
, 
¬’a
->
šd
);

656 
	}
}

659 
	$¬’as_ÿche_ş—nup
(
tsd_t
 *
tsd
)

661 
¬’a_t
 **
¬’as_ÿche
;

663 
¬’as_ÿche
 = 
	`tsd_¬’as_ÿche_g‘
(
tsd
);

664 ià(
¬’as_ÿche
 !ğ
NULL
) {

665 
	`tsd_¬’as_ÿche_£t
(
tsd
, 
NULL
);

666 
	`a0d®loc
(
¬’as_ÿche
);

668 
	}
}

671 
	$Ç»Çs_ÿche_ş—nup
(
tsd_t
 *
tsd
)

675 
	}
}

678 
	$¬’as_ÿche_by·ss_ş—nup
(
tsd_t
 *
tsd
)

682 
	}
}

685 
	$¡©s_´št_©ex™
()

688 ià(
cÚfig_tÿche
 && 
cÚfig_¡©s
) {

689 
Ç»Çs
, 
i
;

698 
i
 = 0, 
Ç»Çs
 = 
	`Ç»Çs_tÙ®_g‘
(); i <‚arenas; i++) {

699 
¬’a_t
 *
¬’a
 = 
¬’as
[
i
];

700 ià(
¬’a
 !ğ
NULL
) {

701 
tÿche_t
 *
tÿche
;

709 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

710 
	`ql_fÜ—ch
(
tÿche
, &
¬’a
->
tÿche_ql
, 
lšk
) {

711 
	`tÿche_¡©s_m”ge
(
tÿche
, 
¬’a
);

713 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

717 
	`je_m®loc_¡©s_´št
(
NULL
, NULL, NULL);

718 
	}
}

728 #iâdeà
JEMALLOC_HAVE_SECURE_GETENV


730 
	$£cu»_g‘’v
(cÚ¡ *
Çme
)

733 #ifdeà
JEMALLOC_HAVE_ISSETUGID


734 ià(
	`is£tugid
() != 0)

735  (
NULL
);

737  (
	`g‘’v
(
Çme
));

738 
	}
}

742 
	$m®loc_nıus
()

744 
»suÉ
;

746 #ifdeà
_WIN32


747 
SYSTEM_INFO
 
si
;

748 
	`G‘Sy¡emInfo
(&
si
);

749 
»suÉ
 = 
si
.
dwNumb”OfProûssÜs
;

751 
»suÉ
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

753  ((
»suÉ
 == -1) ? 1 : ()result);

754 
	}
}

756 
boŞ


757 
	$m®loc_cÚf_Ãxt
(cÚ¡ **
İts_p
, cÚ¡ **
k_p
, 
size_t
 *
kËn_p
,

758 cÚ¡ **
v_p
, 
size_t
 *
vËn_p
)

760 
boŞ
 
acû±
;

761 cÚ¡ *
İts
 = *
İts_p
;

763 *
k_p
 = 
İts
;

765 
acû±
 = 
çl£
; !accept;) {

766 *
İts
) {

780 
İts
++;

783 
İts
++;

784 *
kËn_p
 = (
ušŒ_t
)
İts
 - 1 - (ušŒ_t)*
k_p
;

785 *
v_p
 = 
İts
;

786 
acû±
 = 
Œue
;

789 ià(
İts
 !ğ*
İts_p
) {

790 
	`m®loc_wr™e
("<jemalloc>: Conf stringƒnds "

793  (
Œue
);

795 
	`m®loc_wr™e
("<jemalloc>: Malformed conf string\n");

796  (
Œue
);

800 
acû±
 = 
çl£
; !accept;) {

801 *
İts
) {

803 
İts
++;

811 ià(*
İts
 == '\0') {

812 
	`m®loc_wr™e
("<jemalloc>: Conf stringƒnds "

815 *
vËn_p
 = (
ušŒ_t
)
İts
 - 1 - (ušŒ_t)*
v_p
;

816 
acû±
 = 
Œue
;

819 *
vËn_p
 = (
ušŒ_t
)
İts
 - (ušŒ_t)*
v_p
;

820 
acû±
 = 
Œue
;

823 
İts
++;

828 *
İts_p
 = 
İts
;

829  (
çl£
);

830 
	}
}

833 
	$m®loc_cÚf_”rÜ
(cÚ¡ *
msg
, cÚ¡ *
k
, 
size_t
 
kËn
, cÚ¡ *
v
,

834 
size_t
 
vËn
)

837 
	`m®loc_´štf
("<jem®loc>: %s: %.*s:%.*s\n", 
msg
, ()
kËn
, 
k
,

838 ()
vËn
, 
v
);

839 
	}
}

842 
	$m®loc_cÚf_š™
()

844 
i
;

845 
buf
[
PATH_MAX
 + 1];

846 cÚ¡ *
İts
, *
k
, *
v
;

847 
size_t
 
kËn
, 
vËn
;

853 ià(
cÚfig_v®gršd
) {

854 
š_v®gršd
 = (
RUNNING_ON_VALGRIND
 !ğ0è? 
Œue
 : 
çl£
;

855 ià(
cÚfig_fl
 && 
	`uÆik–y
(
š_v®gršd
)) {

856 
İt_junk
 = "false";

857 
İt_junk_®loc
 = 
çl£
;

858 
İt_junk_ä“
 = 
çl£
;

859 
	`as£¹
(!
İt_z”o
);

860 
İt_qu¬ªtše
 = 
JEMALLOC_VALGRIND_QUARANTINE_DEFAULT
;

861 
İt_»dzÚe
 = 
Œue
;

863 ià(
cÚfig_tÿche
 && 
	`uÆik–y
(
š_v®gršd
))

864 
İt_tÿche
 = 
çl£
;

867 
i
 = 0; i < 3; i++) {

869 
i
) {

871 ià(
je_m®loc_cÚf
 !ğ
NULL
) {

876 
İts
 = 
je_m®loc_cÚf
;

879 
buf
[0] = '\0';

880 
İts
 = 
buf
;

884 
lškËn
 = 0;

885 #iâdeà
_WIN32


886 
§ved_”ºo
 = 
”ºo
;

887 cÚ¡ *
lškÇme
 =

888 #ifdeà
JEMALLOC_PREFIX


889 "/‘c/"
JEMALLOC_PREFIX
"malloc.conf"

899 
lškËn
 = 
	`»adlšk
(
lškÇme
, 
buf
, (buf) - 1);

900 ià(
lškËn
 == -1) {

902 
lškËn
 = 0;

904 
	`£t_”ºo
(
§ved_”ºo
);

907 
buf
[
lškËn
] = '\0';

908 
İts
 = 
buf
;

911 cÚ¡ *
’vÇme
 =

912 #ifdeà
JEMALLOC_PREFIX


913 
JEMALLOC_CPREFIX
"MALLOC_CONF"

919 ià((
İts
 = 
	`£cu»_g‘’v
(
’vÇme
)è!ğ
NULL
) {

927 
buf
[0] = '\0';

928 
İts
 = 
buf
;

932 
	`nÙ_»ached
();

933 
buf
[0] = '\0';

934 
İts
 = 
buf
;

937 *
İts
 !ğ'\0' && !
	`m®loc_cÚf_Ãxt
(&İts, &
k
, &
kËn
, &
v
,

938 &
vËn
)) {

939 
	#CONF_MATCH
(
n
) \

940 ((
n
)-1 =ğ
kËn
 && 
	`¡ºcmp
Ò, 
k
, kËnè=ğ0)

	)

941 
	#CONF_MATCH_VALUE
(
n
) \

942 ((
n
)-1 =ğ
vËn
 && 
	`¡ºcmp
Ò, 
v
, vËnè=ğ0)

	)

943 
	#CONF_HANDLE_BOOL
(
o
, 
n
, 
cÚt
) \

944 ià(
	`CONF_MATCH
(
n
)) { \

945 ià(
	`CONF_MATCH_VALUE
("true")) \

946 
o
 = 
Œue
; \

947 ià(
	`CONF_MATCH_VALUE
("false")) \

948 
o
 = 
çl£
; \

950 
	`m®loc_cÚf_”rÜ
( \

952 
k
, 
kËn
, 
v
, 
vËn
); \

954 ià(
cÚt
) \

956 }

	)

957 
	#CONF_HANDLE_SIZE_T
(
o
, 
n
, 
mš
, 
max
, 
ş
) \

958 ià(
	`CONF_MATCH
(
n
)) { \

959 
uštmax_t
 
um
; \

960 *
’d
; \

962 
	`£t_”ºo
(0); \

963 
um
 = 
	`m®loc_¡¹oumax
(
v
, &
’d
, 0); \

964 ià(
	`g‘_”ºo
(è!ğ0 || (
ušŒ_t
)
’d
 -\

965 (
ušŒ_t
)
v
 !ğ
vËn
) { \

966 
	`m®loc_cÚf_”rÜ
( \

968 
k
, 
kËn
, 
v
, 
vËn
); \

969 } ià(
ş
) { \

970 ià((
mš
è!ğ0 && 
um
 < (min)) \

971 
o
 = (
mš
); \

972 ià(
um
 > (
max
)) \

973 
o
 = (
max
); \

975 
o
 = 
um
; \

977 ià(((
mš
è!ğ0 && 
um
 < (min)) \

978 || 
um
 > (
max
)) { \

979 
	`m®loc_cÚf_”rÜ
( \

982 
k
, 
kËn
, 
v
, 
vËn
); \

984 
o
 = 
um
; \

987 }

	)

988 
	#CONF_HANDLE_SSIZE_T
(
o
, 
n
, 
mš
, 
max
) \

989 ià(
	`CONF_MATCH
(
n
)) { \

990 
l
; \

991 *
’d
; \

993 
	`£t_”ºo
(0); \

994 
l
 = 
	`¡¹Ş
(
v
, &
’d
, 0); \

995 ià(
	`g‘_”ºo
(è!ğ0 || (
ušŒ_t
)
’d
 -\

996 (
ušŒ_t
)
v
 !ğ
vËn
) { \

997 
	`m®loc_cÚf_”rÜ
( \

999 
k
, 
kËn
, 
v
, 
vËn
); \

1000 } ià(
l
 < (
ssize_t
)(
mš
) ||† > \

1001 (
ssize_t
)(
max
)) { \

1002 
	`m®loc_cÚf_”rÜ
( \

1004 
k
, 
kËn
, 
v
, 
vËn
); \

1006 
o
 = 
l
; \

1008 }

	)

1009 
	#CONF_HANDLE_CHAR_P
(
o
, 
n
, 
d
) \

1010 ià(
	`CONF_MATCH
(
n
)) { \

1011 
size_t
 
ıyËn
 = (
vËn
 <= \

1012 (
o
)-1è? 
vËn
 : \

1013 (
o
)-1; \

1014 
	`¡ºıy
(
o
, 
v
, 
ıyËn
); \

1015 
o
[
ıyËn
] = '\0'; \

1017 }

	)

1019 
	`CONF_HANDLE_BOOL
(
İt_abÜt
, "abÜt", 
Œue
)

1028 
	`CONF_HANDLE_SIZE_T
(
İt_lg_chunk
, "lg_chunk", 
LG_PAGE
 +

1029 
LG_SIZE_CLASS_GROUP
 + (
cÚfig_fl
 ? 2 : 1),

1030 ((
size_t
è<< 3è- 1, 
Œue
)

1031 ià(
	`¡ºcmp
("dss", 
k
, 
kËn
) == 0) {

1032 
i
;

1033 
boŞ
 
m©ch
 = 
çl£
;

1034 
i
 = 0; i < 
dss_´ec_lim™
; i++) {

1035 ià(
	`¡ºcmp
(
dss_´ec_Çmes
[
i
], 
v
, 
vËn
)

1037 ià(
	`chunk_dss_´ec_£t
(
i
)) {

1038 
	`m®loc_cÚf_”rÜ
(

1040 
k
, 
kËn
, 
v
, 
vËn
);

1042 
İt_dss
 =

1043 
dss_´ec_Çmes
[
i
];

1044 
m©ch
 = 
Œue
;

1049 ià(!
m©ch
) {

1050 
	`m®loc_cÚf_”rÜ
("Invalid conf value",

1051 
k
, 
kËn
, 
v
, 
vËn
);

1055 
	`CONF_HANDLE_SIZE_T
(
İt_Ç»Çs
, "narenas", 1,

1056 
SIZE_T_MAX
, 
çl£
)

1057 
	`CONF_HANDLE_SSIZE_T
(
İt_lg_dœty_muÉ
, "lg_dirty_mult",

1058 -1, ((
size_t
) << 3) - 1)

1059 
	`CONF_HANDLE_BOOL
(
İt_¡©s_´št
, "¡©s_´št", 
Œue
)

1060 ià(
cÚfig_fl
) {

1061 ià(
	`CONF_MATCH
("junk")) {

1062 ià(
	`CONF_MATCH_VALUE
("true")) {

1063 
İt_junk
 = "true";

1064 
İt_junk_®loc
 = 
İt_junk_ä“
 =

1065 
Œue
;

1066 } ià(
	`CONF_MATCH_VALUE
("false")) {

1067 
İt_junk
 = "false";

1068 
İt_junk_®loc
 = 
İt_junk_ä“
 =

1069 
çl£
;

1070 } ià(
	`CONF_MATCH_VALUE
("alloc")) {

1071 
İt_junk
 = "alloc";

1072 
İt_junk_®loc
 = 
Œue
;

1073 
İt_junk_ä“
 = 
çl£
;

1074 } ià(
	`CONF_MATCH_VALUE
("free")) {

1075 
İt_junk
 = "free";

1076 
İt_junk_®loc
 = 
çl£
;

1077 
İt_junk_ä“
 = 
Œue
;

1079 
	`m®loc_cÚf_”rÜ
(

1080 "Inv®id cÚàv®ue", 
k
,

1081 
kËn
, 
v
, 
vËn
);

1085 
	`CONF_HANDLE_SIZE_T
(
İt_qu¬ªtše
, "quarantine",

1086 0, 
SIZE_T_MAX
, 
çl£
)

1087 
	`CONF_HANDLE_BOOL
(
İt_»dzÚe
, "»dzÚe", 
Œue
)

1088 
	`CONF_HANDLE_BOOL
(
İt_z”o
, "z”o", 
Œue
)

1090 ià(
cÚfig_uŒaû
) {

1091 
	`CONF_HANDLE_BOOL
(
İt_uŒaû
, "uŒaû", 
Œue
)

1093 ià(
cÚfig_xm®loc
) {

1094 
	`CONF_HANDLE_BOOL
(
İt_xm®loc
, "xm®loc", 
Œue
)

1096 ià(
cÚfig_tÿche
) {

1097 
	`CONF_HANDLE_BOOL
(
İt_tÿche
, "tcache",

1098 !
cÚfig_v®gršd
 || !
š_v®gršd
)

1099 ià(
	`CONF_MATCH
("tcache")) {

1100 
	`as£¹
(
cÚfig_v®gršd
 && 
š_v®gršd
);

1101 ià(
İt_tÿche
) {

1102 
İt_tÿche
 = 
çl£
;

1103 
	`m®loc_cÚf_”rÜ
(

1106 
k
, 
kËn
, 
v
, 
vËn
);

1110 
	`CONF_HANDLE_SSIZE_T
(
İt_lg_tÿche_max
,

1112 ((
size_t
) << 3) - 1)

1114 ià(
cÚfig_´of
) {

1115 
	`CONF_HANDLE_BOOL
(
İt_´of
, "´of", 
Œue
)

1116 
	`CONF_HANDLE_CHAR_P
(
İt_´of_´efix
,

1118 
	`CONF_HANDLE_BOOL
(
İt_´of_aùive
, "prof_active",

1119 
Œue
)

1120 
	`CONF_HANDLE_BOOL
(
İt_´of_th»ad_aùive_š™
,

1121 "´of_th»ad_aùive_š™", 
Œue
)

1122 
	`CONF_HANDLE_SIZE_T
(
İt_lg_´of_§m¶e
,

1124 ((
ušt64_t
è<< 3è- 1, 
Œue
)

1125 
	`CONF_HANDLE_BOOL
(
İt_´of_accum
, "prof_accum",

1126 
Œue
)

1127 
	`CONF_HANDLE_SSIZE_T
(
İt_lg_´of_š‹rv®
,

1129 ((
ušt64_t
) << 3) - 1)

1130 
	`CONF_HANDLE_BOOL
(
İt_´of_gdump
, "prof_gdump",

1131 
Œue
)

1132 
	`CONF_HANDLE_BOOL
(
İt_´of_fš®
, "prof_final",

1133 
Œue
)

1134 
	`CONF_HANDLE_BOOL
(
İt_´of_Ëak
, "prof_leak",

1135 
Œue
)

1137 
	`m®loc_cÚf_”rÜ
("Inv®id cÚà·œ", 
k
, 
kËn
, 
v
,

1138 
vËn
);

1139 #undeà
CONF_MATCH


1140 #undeà
CONF_HANDLE_BOOL


1141 #undeà
CONF_HANDLE_SIZE_T


1142 #undeà
CONF_HANDLE_SSIZE_T


1143 #undeà
CONF_HANDLE_CHAR_P


1146 
	}
}

1149 
boŞ


1150 
	$m®loc_š™_h¬d_Ãeded
()

1153 ià(
	`m®loc_š™Ÿlized
(è|| (
IS_INITIALIZER
 && 
m®loc_š™_¡©e
 ==

1154 
m®loc_š™_»cursibË
)) {

1160  (
çl£
);

1162 #ifdeà
JEMALLOC_THREADED_INIT


1163 ià(
m®loc_š™Ÿliz”
 !ğ
NO_INITIALIZER
 && !
IS_INITIALIZER
) {

1166 
	`m®loc_mu‹x_uÆock
(&
š™_lock
);

1167 
CPU_SPINWAIT
;

1168 
	`m®loc_mu‹x_lock
(&
š™_lock
);

1169 } !
	`m®loc_š™Ÿlized
());

1170  (
çl£
);

1173  (
Œue
);

1174 
	}
}

1177 
boŞ


1178 
	$m®loc_š™_h¬d_a0_locked
()

1181 
m®loc_š™Ÿliz”
 = 
INITIALIZER
;

1183 ià(
cÚfig_´of
)

1184 
	`´of_boÙ0
();

1185 
	`m®loc_cÚf_š™
();

1186 ià(
İt_¡©s_´št
) {

1188 ià(
	`©ex™
(
¡©s_´št_©ex™
) != 0) {

1189 
	`m®loc_wr™e
("<jemalloc>: Error in‡texit()\n");

1190 ià(
İt_abÜt
)

1191 
	`abÜt
();

1194 ià(
	`ba£_boÙ
())

1195  (
Œue
);

1196 ià(
	`chunk_boÙ
())

1197  (
Œue
);

1198 ià(
	`ùl_boÙ
())

1199  (
Œue
);

1200 ià(
cÚfig_´of
)

1201 
	`´of_boÙ1
();

1202 ià(
	`¬’a_boÙ
())

1203  (
Œue
);

1204 ià(
cÚfig_tÿche
 && 
	`tÿche_boÙ
())

1205  (
Œue
);

1206 ià(
	`m®loc_mu‹x_š™
(&
¬’as_lock
))

1207  (
Œue
);

1212 
Ç»Çs_tÙ®
 = 
Ç»Çs_auto
 = 1;

1213 
¬’as
 = &
a0
;

1214 
	`mem£t
(
¬’as
, 0, (
¬’a_t
 *è* 
Ç»Çs_auto
);

1219 ià(
	`¬’a_š™
(0è=ğ
NULL
)

1220  (
Œue
);

1221 
m®loc_š™_¡©e
 = 
m®loc_š™_a0_š™Ÿlized
;

1222  (
çl£
);

1223 
	}
}

1225 
boŞ


1226 
	$m®loc_š™_h¬d_a0
()

1228 
boŞ
 
»t
;

1230 
	`m®loc_mu‹x_lock
(&
š™_lock
);

1231 
»t
 = 
	`m®loc_š™_h¬d_a0_locked
();

1232 
	`m®loc_mu‹x_uÆock
(&
š™_lock
);

1233  (
»t
);

1234 
	}
}

1242 
	$m®loc_š™_h¬d_»cursibË
()

1245 
m®loc_š™_¡©e
 = 
m®loc_š™_»cursibË
;

1246 
	`m®loc_mu‹x_uÆock
(&
š™_lock
);

1248 
nıus
 = 
	`m®loc_nıus
();

1250 #ià(!
	`defšed
(
JEMALLOC_MUTEX_INIT_CB
è&& !defšed(
JEMALLOC_ZONE
) \

1251 && !
	`defšed
(
_WIN32
è&& !defšed(
__Çtive_ş›Á__
))

1253 ià(
	`±h»ad_©fÜk
(
jem®loc_´efÜk
, 
jem®loc_po¡fÜk_·»Á
,

1254 
jem®loc_po¡fÜk_chd
) != 0) {

1255 
	`m®loc_wr™e
("<jemalloc>: Error in…thread_atfork()\n");

1256 ià(
İt_abÜt
)

1257 
	`abÜt
();

1260 
	`m®loc_mu‹x_lock
(&
š™_lock
);

1261 
	}
}

1264 
boŞ


1265 
	$m®loc_š™_h¬d_fšish
()

1268 ià(
	`mu‹x_boÙ
())

1269  (
Œue
);

1271 ià(
İt_Ç»Çs
 == 0) {

1276 ià(
nıus
 > 1)

1277 
İt_Ç»Çs
 = 
nıus
 << 2;

1279 
İt_Ç»Çs
 = 1;

1281 
Ç»Çs_auto
 = 
İt_Ç»Çs
;

1287 ià(
Ç»Çs_auto
 > 
chunksize
 / (
¬’a_t
 *)) {

1288 
Ç»Çs_auto
 = 
chunksize
 / (
¬’a_t
 *);

1289 
	`m®loc_´štf
("<jemalloc>: Reducing‚arenaso†imit (%d)\n",

1290 
Ç»Çs_auto
);

1292 
Ç»Çs_tÙ®
 = 
Ç»Çs_auto
;

1295 
¬’as
 = (
¬’a_t
 **)
	`ba£_®loc
(×»Ç_ˆ*è* 
Ç»Çs_tÙ®
);

1296 ià(
¬’as
 =ğ
NULL
)

1297  (
Œue
);

1302 
	`mem£t
(
¬’as
, 0, (
¬’a_t
 *è* 
Ç»Çs_tÙ®
);

1304 
¬’as
[0] = 
a0
;

1306 
m®loc_š™_¡©e
 = 
m®loc_š™_š™Ÿlized
;

1307  (
çl£
);

1308 
	}
}

1310 
boŞ


1311 
	$m®loc_š™_h¬d
()

1314 #ià
	`defšed
(
_WIN32
è&& 
_WIN32_WINNT
 < 0x0600

1315 
	`_š™_š™_lock
();

1317 
	`m®loc_mu‹x_lock
(&
š™_lock
);

1318 ià(!
	`m®loc_š™_h¬d_Ãeded
()) {

1319 
	`m®loc_mu‹x_uÆock
(&
š™_lock
);

1320  (
çl£
);

1323 ià(
m®loc_š™_¡©e
 !ğ
m®loc_š™_a0_š™Ÿlized
 &&

1324 
	`m®loc_š™_h¬d_a0_locked
()) {

1325 
	`m®loc_mu‹x_uÆock
(&
š™_lock
);

1326  (
Œue
);

1328 ià(
	`m®loc_tsd_boÙ0
()) {

1329 
	`m®loc_mu‹x_uÆock
(&
š™_lock
);

1330  (
Œue
);

1332 ià(
cÚfig_´of
 && 
	`´of_boÙ2
()) {

1333 
	`m®loc_mu‹x_uÆock
(&
š™_lock
);

1334  (
Œue
);

1337 
	`m®loc_š™_h¬d_»cursibË
();

1339 ià(
	`m®loc_š™_h¬d_fšish
()) {

1340 
	`m®loc_mu‹x_uÆock
(&
š™_lock
);

1341  (
Œue
);

1344 
	`m®loc_mu‹x_uÆock
(&
š™_lock
);

1345 
	`m®loc_tsd_boÙ1
();

1346  (
çl£
);

1347 
	}
}

1358 
	$im®loc_´of_§m¶e
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
)

1360 *
p
;

1362 ià(
tùx
 =ğ
NULL
)

1363  (
NULL
);

1364 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

1365 
p
 = 
	`im®loc
(
tsd
, 
LARGE_MINCLASS
);

1366 ià(
p
 =ğ
NULL
)

1367  (
NULL
);

1368 
	`¬’a_´of_´omÙed
(
p
, 
usize
);

1370 
p
 = 
	`im®loc
(
tsd
, 
usize
);

1372  (
p
);

1373 
	}
}

1375 
JEMALLOC_ALWAYS_INLINE_C
 *

1376 
	$im®loc_´of
(
tsd_t
 *
tsd
, 
size_t
 
usize
)

1378 *
p
;

1379 
´of_tùx_t
 *
tùx
;

1381 
tùx
 = 
	`´of_®loc_´•
(
tsd
, 
usize
, 
	`´of_aùive_g‘_uÆocked
(), 
Œue
);

1382 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 != (uintptr_t)1U))

1383 
p
 = 
	`im®loc_´of_§m¶e
(
tsd
, 
usize
, 
tùx
);

1385 
p
 = 
	`im®loc
(
tsd
, 
usize
);

1386 ià(
	`uÆik–y
(
p
 =ğ
NULL
)) {

1387 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
Œue
);

1388  (
NULL
);

1390 
	`´of_m®loc
(
p
, 
usize
, 
tùx
);

1392  (
p
);

1393 
	}
}

1395 
JEMALLOC_ALWAYS_INLINE_C
 *

1396 
	$im®loc_body
(
size_t
 
size
, 
tsd_t
 **
tsd
, size_ˆ*
usize
)

1399 ià(
	`uÆik–y
(
	`m®loc_š™
()))

1400  (
NULL
);

1401 *
tsd
 = 
	`tsd_ãtch
();

1403 ià(
cÚfig_´of
 && 
İt_´of
) {

1404 *
usize
 = 
	`s2u
(
size
);

1405 ià(
	`uÆik–y
(*
usize
 == 0))

1406  (
NULL
);

1407  (
	`im®loc_´of
(*
tsd
, *
usize
));

1410 ià(
cÚfig_¡©s
 || (
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
)))

1411 *
usize
 = 
	`s2u
(
size
);

1412  (
	`im®loc
(*
tsd
, 
size
));

1413 
	}
}

1415 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1416 
JEMALLOC_NOTHROW
 *

1417 
	$JEMALLOC_ATTR
(
m®loc
è
	$JEMALLOC_ALLOC_SIZE
(1)

1418 
	$je_m®loc
(
size_t
 
size
)

1420 *
»t
;

1421 
tsd_t
 *
tsd
;

1422 
size_t
 
usize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1424 ià(
size
 == 0)

1425 
size
 = 1;

1427 
»t
 = 
	`im®loc_body
(
size
, &
tsd
, &
usize
);

1428 ià(
	`uÆik–y
(
»t
 =ğ
NULL
)) {

1429 ià(
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

1430 
	`m®loc_wr™e
("<jemalloc>: Error in malloc(): "

1432 
	`abÜt
();

1434 
	`£t_”ºo
(
ENOMEM
);

1436 ià(
cÚfig_¡©s
 && 
	`lik–y
(
»t
 !ğ
NULL
)) {

1437 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
»t
, 
cÚfig_´of
));

1438 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
tsd
è+ğ
usize
;

1440 
	`UTRACE
(0, 
size
, 
»t
);

1441 
	`JEMALLOC_VALGRIND_MALLOC
(
»t
 !ğ
NULL
,„‘, 
usize
, 
çl£
);

1442  (
»t
);

1443 
	}
}

1446 
	$imem®ign_´of_§m¶e
(
tsd_t
 *
tsd
, 
size_t
 
®ignm’t
, size_ˆ
usize
,

1447 
´of_tùx_t
 *
tùx
)

1449 *
p
;

1451 ià(
tùx
 =ğ
NULL
)

1452  (
NULL
);

1453 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

1454 
	`as£¹
(
	`§2u
(
LARGE_MINCLASS
, 
®ignm’t
) == LARGE_MINCLASS);

1455 
p
 = 
	`®loc
(
tsd
, 
LARGE_MINCLASS
, 
®ignm’t
, 
çl£
);

1456 ià(
p
 =ğ
NULL
)

1457  (
NULL
);

1458 
	`¬’a_´of_´omÙed
(
p
, 
usize
);

1460 
p
 = 
	`®loc
(
tsd
, 
usize
, 
®ignm’t
, 
çl£
);

1462  (
p
);

1463 
	}
}

1465 
JEMALLOC_ALWAYS_INLINE_C
 *

1466 
	$imem®ign_´of
(
tsd_t
 *
tsd
, 
size_t
 
®ignm’t
, size_ˆ
usize
)

1468 *
p
;

1469 
´of_tùx_t
 *
tùx
;

1471 
tùx
 = 
	`´of_®loc_´•
(
tsd
, 
usize
, 
	`´of_aùive_g‘_uÆocked
(), 
Œue
);

1472 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 != (uintptr_t)1U))

1473 
p
 = 
	`imem®ign_´of_§m¶e
(
tsd
, 
®ignm’t
, 
usize
, 
tùx
);

1475 
p
 = 
	`®loc
(
tsd
, 
usize
, 
®ignm’t
, 
çl£
);

1476 ià(
	`uÆik–y
(
p
 =ğ
NULL
)) {

1477 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
Œue
);

1478  (
NULL
);

1480 
	`´of_m®loc
(
p
, 
usize
, 
tùx
);

1482  (
p
);

1483 
	}
}

1485 
JEMALLOC_ATTR
(
	$nÚnuÎ
(1))

1487 
	$imem®ign
(**
mem±r
, 
size_t
 
®ignm’t
, size_ˆ
size
, size_ˆ
mš_®ignm’t
)

1489 
»t
;

1490 
tsd_t
 *
tsd
;

1491 
size_t
 
usize
;

1492 *
»suÉ
;

1494 
	`as£¹
(
mš_®ignm’t
 != 0);

1496 ià(
	`uÆik–y
(
	`m®loc_š™
())) {

1497 
»suÉ
 = 
NULL
;

1498 
Ïb–_oom
;

1500 
tsd
 = 
	`tsd_ãtch
();

1501 ià(
size
 == 0)

1502 
size
 = 1;

1505 ià(
	`uÆik–y
(((
®ignm’t
 - 1) &‡lignment) != 0

1506 || (
®ignm’t
 < 
mš_®ignm’t
))) {

1507 ià(
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

1508 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating "

1510 
	`abÜt
();

1512 
»suÉ
 = 
NULL
;

1513 
»t
 = 
EINVAL
;

1514 
Ïb–_»tuº
;

1517 
usize
 = 
	`§2u
(
size
, 
®ignm’t
);

1518 ià(
	`uÆik–y
(
usize
 == 0)) {

1519 
»suÉ
 = 
NULL
;

1520 
Ïb–_oom
;

1523 ià(
cÚfig_´of
 && 
İt_´of
)

1524 
»suÉ
 = 
	`imem®ign_´of
(
tsd
, 
®ignm’t
, 
usize
);

1526 
»suÉ
 = 
	`®loc
(
tsd
, 
usize
, 
®ignm’t
, 
çl£
);

1527 ià(
	`uÆik–y
(
»suÉ
 =ğ
NULL
))

1528 
Ïb–_oom
;

1529 
	`as£¹
(((
ušŒ_t
)
»suÉ
 & (
®ignm’t
 - 1)è=ğ
	`ZU
(0));

1531 *
mem±r
 = 
»suÉ
;

1532 
»t
 = 0;

1533 
Ïb–_»tuº
:

1534 ià(
cÚfig_¡©s
 && 
	`lik–y
(
»suÉ
 !ğ
NULL
)) {

1535 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
»suÉ
, 
cÚfig_´of
));

1536 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
tsd
è+ğ
usize
;

1538 
	`UTRACE
(0, 
size
, 
»suÉ
);

1539  (
»t
);

1540 
Ïb–_oom
:

1541 
	`as£¹
(
»suÉ
 =ğ
NULL
);

1542 ià(
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

1543 
	`m®loc_wr™e
("<jemalloc>: Error‡llocating‡ligned memory: "

1545 
	`abÜt
();

1547 
»t
 = 
ENOMEM
;

1548 
Ïb–_»tuº
;

1549 
	}
}

1551 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


1552 
JEMALLOC_ATTR
(
	$nÚnuÎ
(1))

1553 
	$je_posix_mem®ign
(**
mem±r
, 
size_t
 
®ignm’t
, size_ˆ
size
)

1555 
»t
 = 
	`imem®ign
(
mem±r
, 
®ignm’t
, 
size
, (*));

1556 
	`JEMALLOC_VALGRIND_MALLOC
(
»t
 =ğ0, *
mem±r
, 
	`i§Îoc
(*memptr,

1557 
cÚfig_´of
), 
çl£
);

1558  (
»t
);

1559 
	}
}

1561 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1562 
JEMALLOC_NOTHROW
 *

1563 
	$JEMALLOC_ATTR
(
m®loc
è
	$JEMALLOC_ALLOC_SIZE
(2)

1564 
	$je_®igÃd_®loc
(
size_t
 
®ignm’t
, size_ˆ
size
)

1566 *
»t
;

1567 
”r
;

1569 ià(
	`uÆik–y
((
”r
 = 
	`imem®ign
(&
»t
, 
®ignm’t
, 
size
, 1)) != 0)) {

1570 
»t
 = 
NULL
;

1571 
	`£t_”ºo
(
”r
);

1573 
	`JEMALLOC_VALGRIND_MALLOC
(
”r
 =ğ0, 
»t
, 
	`i§Îoc
Ô‘, 
cÚfig_´of
),

1574 
çl£
);

1575  (
»t
);

1576 
	}
}

1579 
	$iÿÎoc_´of_§m¶e
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
)

1581 *
p
;

1583 ià(
tùx
 =ğ
NULL
)

1584  (
NULL
);

1585 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

1586 
p
 = 
	`iÿÎoc
(
tsd
, 
LARGE_MINCLASS
);

1587 ià(
p
 =ğ
NULL
)

1588  (
NULL
);

1589 
	`¬’a_´of_´omÙed
(
p
, 
usize
);

1591 
p
 = 
	`iÿÎoc
(
tsd
, 
usize
);

1593  (
p
);

1594 
	}
}

1596 
JEMALLOC_ALWAYS_INLINE_C
 *

1597 
	$iÿÎoc_´of
(
tsd_t
 *
tsd
, 
size_t
 
usize
)

1599 *
p
;

1600 
´of_tùx_t
 *
tùx
;

1602 
tùx
 = 
	`´of_®loc_´•
(
tsd
, 
usize
, 
	`´of_aùive_g‘_uÆocked
(), 
Œue
);

1603 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 != (uintptr_t)1U))

1604 
p
 = 
	`iÿÎoc_´of_§m¶e
(
tsd
, 
usize
, 
tùx
);

1606 
p
 = 
	`iÿÎoc
(
tsd
, 
usize
);

1607 ià(
	`uÆik–y
(
p
 =ğ
NULL
)) {

1608 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
Œue
);

1609  (
NULL
);

1611 
	`´of_m®loc
(
p
, 
usize
, 
tùx
);

1613  (
p
);

1614 
	}
}

1616 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1617 
JEMALLOC_NOTHROW
 *

1618 
	$JEMALLOC_ATTR
(
m®loc
è
	$JEMALLOC_ALLOC_SIZE2
(1, 2)

1619 
	$je_ÿÎoc
(
size_t
 
num
, size_ˆ
size
)

1621 *
»t
;

1622 
tsd_t
 *
tsd
;

1623 
size_t
 
num_size
;

1624 
size_t
 
usize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1626 ià(
	`uÆik–y
(
	`m®loc_š™
())) {

1627 
num_size
 = 0;

1628 
»t
 = 
NULL
;

1629 
Ïb–_»tuº
;

1631 
tsd
 = 
	`tsd_ãtch
();

1633 
num_size
 = 
num
 * 
size
;

1634 ià(
	`uÆik–y
(
num_size
 == 0)) {

1635 ià(
num
 =ğ0 || 
size
 == 0)

1636 
num_size
 = 1;

1638 
»t
 = 
NULL
;

1639 
Ïb–_»tuº
;

1646 } ià(
	`uÆik–y
(((
num
 | 
size
è& (
SIZE_T_MAX
 << ((
size_t
) <<

1647 2))è&& (
num_size
 / 
size
 !ğ
num
))) {

1649 
»t
 = 
NULL
;

1650 
Ïb–_»tuº
;

1653 ià(
cÚfig_´of
 && 
İt_´of
) {

1654 
usize
 = 
	`s2u
(
num_size
);

1655 ià(
	`uÆik–y
(
usize
 == 0)) {

1656 
»t
 = 
NULL
;

1657 
Ïb–_»tuº
;

1659 
»t
 = 
	`iÿÎoc_´of
(
tsd
, 
usize
);

1661 ià(
cÚfig_¡©s
 || (
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
)))

1662 
usize
 = 
	`s2u
(
num_size
);

1663 
»t
 = 
	`iÿÎoc
(
tsd
, 
num_size
);

1666 
Ïb–_»tuº
:

1667 ià(
	`uÆik–y
(
»t
 =ğ
NULL
)) {

1668 ià(
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

1669 
	`m®loc_wr™e
("<jemalloc>: Error in calloc(): out of "

1671 
	`abÜt
();

1673 
	`£t_”ºo
(
ENOMEM
);

1675 ià(
cÚfig_¡©s
 && 
	`lik–y
(
»t
 !ğ
NULL
)) {

1676 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
»t
, 
cÚfig_´of
));

1677 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
tsd
è+ğ
usize
;

1679 
	`UTRACE
(0, 
num_size
, 
»t
);

1680 
	`JEMALLOC_VALGRIND_MALLOC
(
»t
 !ğ
NULL
,„‘, 
usize
, 
Œue
);

1681  (
»t
);

1682 
	}
}

1685 
	$œ—Îoc_´of_§m¶e
(
tsd_t
 *
tsd
, *
Şd_±r
, 
size_t
 
Şd_usize
, size_ˆ
usize
,

1686 
´of_tùx_t
 *
tùx
)

1688 *
p
;

1690 ià(
tùx
 =ğ
NULL
)

1691  (
NULL
);

1692 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

1693 
p
 = 
	`œ®loc
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
LARGE_MINCLASS
, 0, 
çl£
);

1694 ià(
p
 =ğ
NULL
)

1695  (
NULL
);

1696 
	`¬’a_´of_´omÙed
(
p
, 
usize
);

1698 
p
 = 
	`œ®loc
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
usize
, 0, 
çl£
);

1700  (
p
);

1701 
	}
}

1703 
JEMALLOC_ALWAYS_INLINE_C
 *

1704 
	$œ—Îoc_´of
(
tsd_t
 *
tsd
, *
Şd_±r
, 
size_t
 
Şd_usize
, size_ˆ
usize
)

1706 *
p
;

1707 
boŞ
 
´of_aùive
;

1708 
´of_tùx_t
 *
Şd_tùx
, *
tùx
;

1710 
´of_aùive
 = 
	`´of_aùive_g‘_uÆocked
();

1711 
Şd_tùx
 = 
	`´of_tùx_g‘
(
Şd_±r
);

1712 
tùx
 = 
	`´of_®loc_´•
(
tsd
, 
usize
, 
´of_aùive
, 
Œue
);

1713 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 != (uintptr_t)1U))

1714 
p
 = 
	`œ—Îoc_´of_§m¶e
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
usize
, 
tùx
);

1716 
p
 = 
	`œ®loc
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
usize
, 0, 
çl£
);

1717 ià(
	`uÆik–y
(
p
 =ğ
NULL
)) {

1718 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
Œue
);

1719  (
NULL
);

1721 
	`´of_»®loc
(
tsd
, 
p
, 
usize
, 
tùx
, 
´of_aùive
, 
Œue
, 
Şd_±r
, 
Şd_usize
,

1722 
Şd_tùx
);

1724  (
p
);

1725 
	}
}

1727 
JEMALLOC_INLINE_C
 

1728 
	$iä“
(
tsd_t
 *
tsd
, *
±r
, 
tÿche_t
 *
tÿche
)

1730 
size_t
 
usize
;

1731 
UNUSED
 
size_t
 
rzsize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1733 
	`as£¹
(
±r
 !ğ
NULL
);

1734 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

1736 ià(
cÚfig_´of
 && 
İt_´of
) {

1737 
usize
 = 
	`i§Îoc
(
±r
, 
cÚfig_´of
);

1738 
	`´of_ä“
(
tsd
, 
±r
, 
usize
);

1739 } ià(
cÚfig_¡©s
 || 
cÚfig_v®gršd
)

1740 
usize
 = 
	`i§Îoc
(
±r
, 
cÚfig_´of
);

1741 ià(
cÚfig_¡©s
)

1742 *
	`tsd_th»ad_d—Îoÿ‹dp_g‘
(
tsd
è+ğ
usize
;

1743 ià(
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
))

1744 
rzsize
 = 
	`p2rz
(
±r
);

1745 
	`iq®loc
(
tsd
, 
±r
, 
tÿche
);

1746 
	`JEMALLOC_VALGRIND_FREE
(
±r
, 
rzsize
);

1747 
	}
}

1749 
JEMALLOC_INLINE_C
 

1750 
	$isä“
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
usize
, 
tÿche_t
 *
tÿche
)

1752 
UNUSED
 
size_t
 
rzsize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1754 
	`as£¹
(
±r
 !ğ
NULL
);

1755 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

1757 ià(
cÚfig_´of
 && 
İt_´of
)

1758 
	`´of_ä“
(
tsd
, 
±r
, 
usize
);

1759 ià(
cÚfig_¡©s
)

1760 *
	`tsd_th»ad_d—Îoÿ‹dp_g‘
(
tsd
è+ğ
usize
;

1761 ià(
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
))

1762 
rzsize
 = 
	`p2rz
(
±r
);

1763 
	`isq®loc
(
tsd
, 
±r
, 
usize
, 
tÿche
);

1764 
	`JEMALLOC_VALGRIND_FREE
(
±r
, 
rzsize
);

1765 
	}
}

1767 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1768 
JEMALLOC_NOTHROW
 *

1769 
	$JEMALLOC_ALLOC_SIZE
(2)

1770 
	$je_»®loc
(*
±r
, 
size_t
 
size
)

1772 *
»t
;

1773 
tsd_t
 *
tsd
 
	`JEMALLOC_CC_SILENCE_INIT
(
NULL
);

1774 
size_t
 
usize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1775 
size_t
 
Şd_usize
 = 0;

1776 
UNUSED
 
size_t
 
Şd_rzsize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

1778 ià(
	`uÆik–y
(
size
 == 0)) {

1779 ià(
±r
 !ğ
NULL
) {

1781 
	`UTRACE
(
±r
, 0, 0);

1782 
tsd
 = 
	`tsd_ãtch
();

1783 
	`iä“
(
tsd
, 
±r
, 
	`tÿche_g‘
Ñsd, 
çl£
));

1784  (
NULL
);

1786 
size
 = 1;

1789 ià(
	`lik–y
(
±r
 !ğ
NULL
)) {

1790 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

1791 
	`m®loc_th»ad_š™
();

1792 
tsd
 = 
	`tsd_ãtch
();

1794 
Şd_usize
 = 
	`i§Îoc
(
±r
, 
cÚfig_´of
);

1795 ià(
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
))

1796 
Şd_rzsize
 = 
cÚfig_´of
 ? 
	`p2rz
(
±r
è: 
	`u2rz
(
Şd_usize
);

1798 ià(
cÚfig_´of
 && 
İt_´of
) {

1799 
usize
 = 
	`s2u
(
size
);

1800 
»t
 = 
	`uÆik–y
(
usize
 =ğ0è? 
NULL
 : 
	`œ—Îoc_´of
(
tsd
,

1801 
±r
, 
Şd_usize
, 
usize
);

1803 ià(
cÚfig_¡©s
 || (
cÚfig_v®gršd
 &&

1804 
	`uÆik–y
(
š_v®gršd
)))

1805 
usize
 = 
	`s2u
(
size
);

1806 
»t
 = 
	`œ®loc
(
tsd
, 
±r
, 
Şd_usize
, 
size
, 0, 
çl£
);

1810 
»t
 = 
	`im®loc_body
(
size
, &
tsd
, &
usize
);

1813 ià(
	`uÆik–y
(
»t
 =ğ
NULL
)) {

1814 ià(
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

1815 
	`m®loc_wr™e
("<jemalloc>: Error in„ealloc(): "

1817 
	`abÜt
();

1819 
	`£t_”ºo
(
ENOMEM
);

1821 ià(
cÚfig_¡©s
 && 
	`lik–y
(
»t
 !ğ
NULL
)) {

1822 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
»t
, 
cÚfig_´of
));

1823 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
tsd
è+ğ
usize
;

1824 *
	`tsd_th»ad_d—Îoÿ‹dp_g‘
(
tsd
è+ğ
Şd_usize
;

1826 
	`UTRACE
(
±r
, 
size
, 
»t
);

1827 
	`JEMALLOC_VALGRIND_REALLOC
(
Œue
, 
»t
, 
usize
,rue, 
±r
, 
Şd_usize
,

1828 
Şd_rzsize
, 
Œue
, 
çl£
);

1829  (
»t
);

1830 
	}
}

1832 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


1833 
	$je_ä“
(*
±r
)

1836 
	`UTRACE
(
±r
, 0, 0);

1837 ià(
	`lik–y
(
±r
 !ğ
NULL
)) {

1838 
tsd_t
 *
tsd
 = 
	`tsd_ãtch
();

1839 
	`iä“
(
tsd
, 
±r
, 
	`tÿche_g‘
Ñsd, 
çl£
));

1841 
	}
}

1851 #ifdeà
JEMALLOC_OVERRIDE_MEMALIGN


1852 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1853 
JEMALLOC_NOTHROW
 *

1854 
	$JEMALLOC_ATTR
(
m®loc
)

1855 
	$je_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
)

1857 *
»t
 
	`JEMALLOC_CC_SILENCE_INIT
(
NULL
);

1858 ià(
	`uÆik–y
(
	`imem®ign
(&
»t
, 
®ignm’t
, 
size
, 1) != 0))

1859 
»t
 = 
NULL
;

1860 
	`JEMALLOC_VALGRIND_MALLOC
(
»t
 !ğ
NULL
,„‘, 
size
, 
çl£
);

1861  (
»t
);

1862 
	}
}

1865 #ifdeà
JEMALLOC_OVERRIDE_VALLOC


1866 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


1867 
JEMALLOC_NOTHROW
 *

1868 
	$JEMALLOC_ATTR
(
m®loc
)

1869 
	$je_v®loc
(
size_t
 
size
)

1871 *
»t
 
	`JEMALLOC_CC_SILENCE_INIT
(
NULL
);

1872 ià(
	`uÆik–y
(
	`imem®ign
(&
»t
, 
PAGE
, 
size
, 1) != 0))

1873 
»t
 = 
NULL
;

1874 
	`JEMALLOC_VALGRIND_MALLOC
(
»t
 !ğ
NULL
,„‘, 
size
, 
çl£
);

1875  (
»t
);

1876 
	}
}

1883 
	#m®loc_is_m®loc
 1

	)

1884 
	#is_m®loc_
(
a
è
m®loc_is_
 ## 
	)
a

1885 
	#is_m®loc
(
a
è
	`is_m®loc_
×)

	)

1887 #ià((
is_m®loc
(
je_m®loc
è=ğ1è&& 
defšed
(
JEMALLOC_GLIBC_MALLOC_HOOK
))

1897 
JEMALLOC_EXPORT
 (*
__ä“_hook
)(*
±r
èğ
je_ä“
;

1898 
JEMALLOC_EXPORT
 *(*
__m®loc_hook
)(
size_t
 
size
èğ
je_m®loc
;

1899 
JEMALLOC_EXPORT
 *(*
__»®loc_hook
)(*
±r
, 
size_t
 
size
èğ
je_»®loc
;

1900 #ifdeà
JEMALLOC_GLIBC_MEMALIGN_HOOK


1901 
JEMALLOC_EXPORT
 *(*
__mem®ign_hook
)(
size_t
 
®ignm’t
, size_ˆ
size
) =

1902 
je_mem®ign
;

1914 
JEMALLOC_ALWAYS_INLINE_C
 
boŞ


1915 
	$im®locx_æags_decode_h¬d
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
æags
, size_ˆ*
usize
,

1916 
size_t
 *
®ignm’t
, 
boŞ
 *
z”o
, 
tÿche_t
 **
tÿche
, 
¬’a_t
 **
¬’a
)

1919 ià((
æags
 & 
MALLOCX_LG_ALIGN_MASK
) == 0) {

1920 *
®ignm’t
 = 0;

1921 *
usize
 = 
	`s2u
(
size
);

1923 *
®ignm’t
 = 
	`MALLOCX_ALIGN_GET_SPECIFIED
(
æags
);

1924 *
usize
 = 
	`§2u
(
size
, *
®ignm’t
);

1926 
	`as£¹
(*
usize
 != 0);

1927 *
z”o
 = 
	`MALLOCX_ZERO_GET
(
æags
);

1928 ià((
æags
 & 
MALLOCX_TCACHE_MASK
) != 0) {

1929 ià((
æags
 & 
MALLOCX_TCACHE_MASK
è=ğ
MALLOCX_TCACHE_NONE
)

1930 *
tÿche
 = 
NULL
;

1932 *
tÿche
 = 
	`tÿches_g‘
(
tsd
, 
	`MALLOCX_TCACHE_GET
(
æags
));

1934 *
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
Œue
);

1935 ià((
æags
 & 
MALLOCX_ARENA_MASK
) != 0) {

1936 
¬’a_šd
 = 
	`MALLOCX_ARENA_GET
(
æags
);

1937 *
¬’a
 = 
	`¬’a_g‘
(
tsd
, 
¬’a_šd
, 
Œue
,rue);

1938 ià(
	`uÆik–y
(*
¬’a
 =ğ
NULL
))

1939  (
Œue
);

1941 *
¬’a
 = 
NULL
;

1942  (
çl£
);

1943 
	}
}

1945 
JEMALLOC_ALWAYS_INLINE_C
 
boŞ


1946 
	$im®locx_æags_decode
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
æags
, size_ˆ*
usize
,

1947 
size_t
 *
®ignm’t
, 
boŞ
 *
z”o
, 
tÿche_t
 **
tÿche
, 
¬’a_t
 **
¬’a
)

1950 ià(
	`lik–y
(
æags
 == 0)) {

1951 *
usize
 = 
	`s2u
(
size
);

1952 
	`as£¹
(*
usize
 != 0);

1953 *
®ignm’t
 = 0;

1954 *
z”o
 = 
çl£
;

1955 *
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
Œue
);

1956 *
¬’a
 = 
NULL
;

1957  (
çl£
);

1959  (
	`im®locx_æags_decode_h¬d
(
tsd
, 
size
, 
æags
, 
usize
,

1960 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
));

1962 
	}
}

1964 
JEMALLOC_ALWAYS_INLINE_C
 *

1965 
	$im®locx_æags
(
tsd_t
 *
tsd
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

1966 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

1969 ià(
	`uÆik–y
(
®ignm’t
 != 0))

1970  (
	`®loù
(
tsd
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
));

1971 ià(
	`uÆik–y
(
z”o
))

1972  (
	`iÿÎoù
(
tsd
, 
usize
, 
tÿche
, 
¬’a
));

1973  (
	`im®loù
(
tsd
, 
usize
, 
tÿche
, 
¬’a
));

1974 
	}
}

1977 
	$im®locx_´of_§m¶e
(
tsd_t
 *
tsd
, 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
,

1978 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

1980 *
p
;

1982 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

1983 
	`as£¹
(((
®ignm’t
 =ğ0è? 
	`s2u
(
LARGE_MINCLASS
) :

1984 
	`§2u
(
LARGE_MINCLASS
, 
®ignm’t
)) == LARGE_MINCLASS);

1985 
p
 = 
	`im®locx_æags
(
tsd
, 
LARGE_MINCLASS
, 
®ignm’t
, 
z”o
, 
tÿche
,

1986 
¬’a
);

1987 ià(
p
 =ğ
NULL
)

1988  (
NULL
);

1989 
	`¬’a_´of_´omÙed
(
p
, 
usize
);

1991 
p
 = 
	`im®locx_æags
(
tsd
, 
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
);

1993  (
p
);

1994 
	}
}

1996 
JEMALLOC_ALWAYS_INLINE_C
 *

1997 
	$im®locx_´of
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
æags
, size_ˆ*
usize
)

1999 *
p
;

2000 
size_t
 
®ignm’t
;

2001 
boŞ
 
z”o
;

2002 
tÿche_t
 *
tÿche
;

2003 
¬’a_t
 *
¬’a
;

2004 
´of_tùx_t
 *
tùx
;

2006 ià(
	`uÆik–y
(
	`im®locx_æags_decode
(
tsd
, 
size
, 
æags
, 
usize
, &
®ignm’t
,

2007 &
z”o
, &
tÿche
, &
¬’a
)))

2008  (
NULL
);

2009 
tùx
 = 
	`´of_®loc_´•
(
tsd
, *
usize
, 
	`´of_aùive_g‘_uÆocked
(), 
Œue
);

2010 ià(
	`lik–y
((
ušŒ_t
)
tùx
 == (uintptr_t)1U))

2011 
p
 = 
	`im®locx_æags
(
tsd
, *
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
);

2012 ià((
ušŒ_t
)
tùx
 > (uintptr_t)1U) {

2013 
p
 = 
	`im®locx_´of_§m¶e
(
tsd
, *
usize
, 
®ignm’t
, 
z”o
, 
tÿche
,

2014 
¬’a
);

2016 
p
 = 
NULL
;

2017 ià(
	`uÆik–y
(
p
 =ğ
NULL
)) {

2018 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
Œue
);

2019  (
NULL
);

2021 
	`´of_m®loc
(
p
, *
usize
, 
tùx
);

2023 
	`as£¹
(
®ignm’t
 =ğ0 || ((
ušŒ_t
)
p
 & (®ignm’ˆ- 1)è=ğ
	`ZU
(0));

2024  (
p
);

2025 
	}
}

2027 
JEMALLOC_ALWAYS_INLINE_C
 *

2028 
	$im®locx_no_´of
(
tsd_t
 *
tsd
, 
size_t
 
size
, 
æags
, size_ˆ*
usize
)

2030 *
p
;

2031 
size_t
 
®ignm’t
;

2032 
boŞ
 
z”o
;

2033 
tÿche_t
 *
tÿche
;

2034 
¬’a_t
 *
¬’a
;

2036 ià(
	`lik–y
(
æags
 == 0)) {

2037 ià(
cÚfig_¡©s
 || (
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
)))

2038 *
usize
 = 
	`s2u
(
size
);

2039  (
	`im®loc
(
tsd
, 
size
));

2042 ià(
	`uÆik–y
(
	`im®locx_æags_decode_h¬d
(
tsd
, 
size
, 
æags
, 
usize
,

2043 &
®ignm’t
, &
z”o
, &
tÿche
, &
¬’a
)))

2044  (
NULL
);

2045 
p
 = 
	`im®locx_æags
(
tsd
, *
usize
, 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
);

2046 
	`as£¹
(
®ignm’t
 =ğ0 || ((
ušŒ_t
)
p
 & (®ignm’ˆ- 1)è=ğ
	`ZU
(0));

2047  (
p
);

2048 
	}
}

2050 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


2051 
JEMALLOC_NOTHROW
 *

2052 
	$JEMALLOC_ATTR
(
m®loc
è
	$JEMALLOC_ALLOC_SIZE
(1)

2053 
	$je_m®locx
(
size_t
 
size
, 
æags
)

2055 
tsd_t
 *
tsd
;

2056 *
p
;

2057 
size_t
 
usize
;

2059 
	`as£¹
(
size
 != 0);

2061 ià(
	`uÆik–y
(
	`m®loc_š™
()))

2062 
Ïb–_oom
;

2063 
tsd
 = 
	`tsd_ãtch
();

2065 ià(
cÚfig_´of
 && 
İt_´of
)

2066 
p
 = 
	`im®locx_´of
(
tsd
, 
size
, 
æags
, &
usize
);

2068 
p
 = 
	`im®locx_no_´of
(
tsd
, 
size
, 
æags
, &
usize
);

2069 ià(
	`uÆik–y
(
p
 =ğ
NULL
))

2070 
Ïb–_oom
;

2072 ià(
cÚfig_¡©s
) {

2073 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
p
, 
cÚfig_´of
));

2074 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
tsd
è+ğ
usize
;

2076 
	`UTRACE
(0, 
size
, 
p
);

2077 
	`JEMALLOC_VALGRIND_MALLOC
(
Œue
, 
p
, 
usize
, 
	`MALLOCX_ZERO_GET
(
æags
));

2078  (
p
);

2079 
Ïb–_oom
:

2080 ià(
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

2081 
	`m®loc_wr™e
("<jemalloc>: Error in mallocx(): out of memory\n");

2082 
	`abÜt
();

2084 
	`UTRACE
(0, 
size
, 0);

2085  (
NULL
);

2086 
	}
}

2089 
	$œ®locx_´of_§m¶e
(
tsd_t
 *
tsd
, *
Şd_±r
, 
size_t
 
Şd_usize
,

2090 
size_t
 
usize
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
,

2091 
´of_tùx_t
 *
tùx
)

2093 *
p
;

2095 ià(
tùx
 =ğ
NULL
)

2096  (
NULL
);

2097 ià(
usize
 <ğ
SMALL_MAXCLASS
) {

2098 
p
 = 
	`œ®loù
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
LARGE_MINCLASS
, 
®ignm’t
,

2099 
z”o
, 
tÿche
, 
¬’a
);

2100 ià(
p
 =ğ
NULL
)

2101  (
NULL
);

2102 
	`¬’a_´of_´omÙed
(
p
, 
usize
);

2104 
p
 = 
	`œ®loù
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
usize
, 
®ignm’t
, 
z”o
,

2105 
tÿche
, 
¬’a
);

2108  (
p
);

2109 
	}
}

2111 
JEMALLOC_ALWAYS_INLINE_C
 *

2112 
	$œ®locx_´of
(
tsd_t
 *
tsd
, *
Şd_±r
, 
size_t
 
Şd_usize
, size_ˆ
size
,

2113 
size_t
 
®ignm’t
, size_ˆ*
usize
, 
boŞ
 
z”o
, 
tÿche_t
 *
tÿche
,

2114 
¬’a_t
 *
¬’a
)

2116 *
p
;

2117 
boŞ
 
´of_aùive
;

2118 
´of_tùx_t
 *
Şd_tùx
, *
tùx
;

2120 
´of_aùive
 = 
	`´of_aùive_g‘_uÆocked
();

2121 
Şd_tùx
 = 
	`´of_tùx_g‘
(
Şd_±r
);

2122 
tùx
 = 
	`´of_®loc_´•
(
tsd
, *
usize
, 
´of_aùive
, 
Œue
);

2123 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 != (uintptr_t)1U)) {

2124 
p
 = 
	`œ®locx_´of_§m¶e
(
tsd
, 
Şd_±r
, 
Şd_usize
, *
usize
,

2125 
®ignm’t
, 
z”o
, 
tÿche
, 
¬’a
, 
tùx
);

2127 
p
 = 
	`œ®loù
(
tsd
, 
Şd_±r
, 
Şd_usize
, 
size
, 
®ignm’t
, 
z”o
,

2128 
tÿche
, 
¬’a
);

2130 ià(
	`uÆik–y
(
p
 =ğ
NULL
)) {

2131 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
Œue
);

2132  (
NULL
);

2135 ià(
p
 =ğ
Şd_±r
 && 
®ignm’t
 != 0) {

2144 *
usize
 = 
	`i§Îoc
(
p
, 
cÚfig_´of
);

2146 
	`´of_»®loc
(
tsd
, 
p
, *
usize
, 
tùx
, 
´of_aùive
, 
Œue
, 
Şd_±r
,

2147 
Şd_usize
, 
Şd_tùx
);

2149  (
p
);

2150 
	}
}

2152 
JEMALLOC_EXPORT
 
JEMALLOC_ALLOCATOR
 
JEMALLOC_RESTRICT_RETURN


2153 
JEMALLOC_NOTHROW
 *

2154 
	$JEMALLOC_ALLOC_SIZE
(2)

2155 
	$je_¿Îocx
(*
±r
, 
size_t
 
size
, 
æags
)

2157 *
p
;

2158 
tsd_t
 *
tsd
;

2159 
size_t
 
usize
;

2160 
size_t
 
Şd_usize
;

2161 
UNUSED
 
size_t
 
Şd_rzsize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

2162 
size_t
 
®ignm’t
 = 
	`MALLOCX_ALIGN_GET
(
æags
);

2163 
boŞ
 
z”o
 = 
æags
 & 
MALLOCX_ZERO
;

2164 
¬’a_t
 *
¬’a
;

2165 
tÿche_t
 *
tÿche
;

2167 
	`as£¹
(
±r
 !ğ
NULL
);

2168 
	`as£¹
(
size
 != 0);

2169 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2170 
	`m®loc_th»ad_š™
();

2171 
tsd
 = 
	`tsd_ãtch
();

2173 ià(
	`uÆik–y
((
æags
 & 
MALLOCX_ARENA_MASK
) != 0)) {

2174 
¬’a_šd
 = 
	`MALLOCX_ARENA_GET
(
æags
);

2175 
¬’a
 = 
	`¬’a_g‘
(
tsd
, 
¬’a_šd
, 
Œue
,rue);

2176 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
))

2177 
Ïb–_oom
;

2179 
¬’a
 = 
NULL
;

2181 ià(
	`uÆik–y
((
æags
 & 
MALLOCX_TCACHE_MASK
) != 0)) {

2182 ià((
æags
 & 
MALLOCX_TCACHE_MASK
è=ğ
MALLOCX_TCACHE_NONE
)

2183 
tÿche
 = 
NULL
;

2185 
tÿche
 = 
	`tÿches_g‘
(
tsd
, 
	`MALLOCX_TCACHE_GET
(
æags
));

2187 
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
Œue
);

2189 
Şd_usize
 = 
	`i§Îoc
(
±r
, 
cÚfig_´of
);

2190 ià(
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
))

2191 
Şd_rzsize
 = 
	`u2rz
(
Şd_usize
);

2193 ià(
cÚfig_´of
 && 
İt_´of
) {

2194 
usize
 = (
®ignm’t
 =ğ0è? 
	`s2u
(
size
è: 
	`§2u
(size,‡lignment);

2195 
	`as£¹
(
usize
 != 0);

2196 
p
 = 
	`œ®locx_´of
(
tsd
, 
±r
, 
Şd_usize
, 
size
, 
®ignm’t
, &
usize
,

2197 
z”o
, 
tÿche
, 
¬’a
);

2198 ià(
	`uÆik–y
(
p
 =ğ
NULL
))

2199 
Ïb–_oom
;

2201 
p
 = 
	`œ®loù
(
tsd
, 
±r
, 
Şd_usize
, 
size
, 
®ignm’t
, 
z”o
,

2202 
tÿche
, 
¬’a
);

2203 ià(
	`uÆik–y
(
p
 =ğ
NULL
))

2204 
Ïb–_oom
;

2205 ià(
cÚfig_¡©s
 || (
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
)))

2206 
usize
 = 
	`i§Îoc
(
p
, 
cÚfig_´of
);

2208 
	`as£¹
(
®ignm’t
 =ğ0 || ((
ušŒ_t
)
p
 & (®ignm’ˆ- 1)è=ğ
	`ZU
(0));

2210 ià(
cÚfig_¡©s
) {

2211 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
tsd
è+ğ
usize
;

2212 *
	`tsd_th»ad_d—Îoÿ‹dp_g‘
(
tsd
è+ğ
Şd_usize
;

2214 
	`UTRACE
(
±r
, 
size
, 
p
);

2215 
	`JEMALLOC_VALGRIND_REALLOC
(
Œue
, 
p
, 
usize
, 
çl£
, 
±r
, 
Şd_usize
,

2216 
Şd_rzsize
, 
çl£
, 
z”o
);

2217  (
p
);

2218 
Ïb–_oom
:

2219 ià(
cÚfig_xm®loc
 && 
	`uÆik–y
(
İt_xm®loc
)) {

2220 
	`m®loc_wr™e
("<jemalloc>: Error in„allocx(): out of memory\n");

2221 
	`abÜt
();

2223 
	`UTRACE
(
±r
, 
size
, 0);

2224  (
NULL
);

2225 
	}
}

2227 
JEMALLOC_ALWAYS_INLINE_C
 
size_t


2228 
	$ix®locx_h–³r
(*
±r
, 
size_t
 
Şd_usize
, size_ˆ
size
, size_ˆ
exŒa
,

2229 
size_t
 
®ignm’t
, 
boŞ
 
z”o
)

2231 
size_t
 
usize
;

2233 ià(
	`ix®loc
(
±r
, 
Şd_usize
, 
size
, 
exŒa
, 
®ignm’t
, 
z”o
))

2234  (
Şd_usize
);

2235 
usize
 = 
	`i§Îoc
(
±r
, 
cÚfig_´of
);

2237  (
usize
);

2238 
	}
}

2240 
size_t


2241 
	$ix®locx_´of_§m¶e
(*
±r
, 
size_t
 
Şd_usize
, size_ˆ
size
, size_ˆ
exŒa
,

2242 
size_t
 
®ignm’t
, 
boŞ
 
z”o
, 
´of_tùx_t
 *
tùx
)

2244 
size_t
 
usize
;

2246 ià(
tùx
 =ğ
NULL
)

2247  (
Şd_usize
);

2248 
usize
 = 
	`ix®locx_h–³r
(
±r
, 
Şd_usize
, 
size
, 
exŒa
, 
®ignm’t
, 
z”o
);

2250  (
usize
);

2251 
	}
}

2253 
JEMALLOC_ALWAYS_INLINE_C
 
size_t


2254 
	$ix®locx_´of
(
tsd_t
 *
tsd
, *
±r
, 
size_t
 
Şd_usize
, size_ˆ
size
,

2255 
size_t
 
exŒa
, size_ˆ
®ignm’t
, 
boŞ
 
z”o
)

2257 
size_t
 
usize_max
, 
usize
;

2258 
boŞ
 
´of_aùive
;

2259 
´of_tùx_t
 *
Şd_tùx
, *
tùx
;

2261 
´of_aùive
 = 
	`´of_aùive_g‘_uÆocked
();

2262 
Şd_tùx
 = 
	`´of_tùx_g‘
(
±r
);

2269 
usize_max
 = (
®ignm’t
 =ğ0è? 
	`s2u
(
size
+
exŒa
è: 
	`§2u
(size+extra,

2270 
®ignm’t
);

2271 
	`as£¹
(
usize_max
 != 0);

2272 
tùx
 = 
	`´of_®loc_´•
(
tsd
, 
usize_max
, 
´of_aùive
, 
çl£
);

2273 ià(
	`uÆik–y
((
ušŒ_t
)
tùx
 != (uintptr_t)1U)) {

2274 
usize
 = 
	`ix®locx_´of_§m¶e
(
±r
, 
Şd_usize
, 
size
, 
exŒa
,

2275 
®ignm’t
, 
z”o
, 
tùx
);

2277 
usize
 = 
	`ix®locx_h–³r
(
±r
, 
Şd_usize
, 
size
, 
exŒa
, 
®ignm’t
,

2278 
z”o
);

2280 ià(
usize
 =ğ
Şd_usize
) {

2281 
	`´of_®loc_rŞlback
(
tsd
, 
tùx
, 
çl£
);

2282  (
usize
);

2284 
	`´of_»®loc
(
tsd
, 
±r
, 
usize
, 
tùx
, 
´of_aùive
, 
çl£
,…Œ, 
Şd_usize
,

2285 
Şd_tùx
);

2287  (
usize
);

2288 
	}
}

2290 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW


2291 
	$je_x®locx
(*
±r
, 
size_t
 
size
, size_ˆ
exŒa
, 
æags
)

2293 
tsd_t
 *
tsd
;

2294 
size_t
 
usize
, 
Şd_usize
;

2295 
UNUSED
 
size_t
 
Şd_rzsize
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

2296 
size_t
 
®ignm’t
 = 
	`MALLOCX_ALIGN_GET
(
æags
);

2297 
boŞ
 
z”o
 = 
æags
 & 
MALLOCX_ZERO
;

2299 
	`as£¹
(
±r
 !ğ
NULL
);

2300 
	`as£¹
(
size
 != 0);

2301 
	`as£¹
(
SIZE_T_MAX
 - 
size
 >ğ
exŒa
);

2302 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2303 
	`m®loc_th»ad_š™
();

2304 
tsd
 = 
	`tsd_ãtch
();

2306 
Şd_usize
 = 
	`i§Îoc
(
±r
, 
cÚfig_´of
);

2309 ià(
	`uÆik–y
(
size
 + 
exŒa
 > 
HUGE_MAXCLASS
)) {

2311 ià(
	`uÆik–y
(
size
 > 
HUGE_MAXCLASS
)) {

2312 
usize
 = 
Şd_usize
;

2313 
Ïb–_nÙ_»sized
;

2315 
exŒa
 = 
HUGE_MAXCLASS
 - 
size
;

2318 ià(
cÚfig_v®gršd
 && 
	`uÆik–y
(
š_v®gršd
))

2319 
Şd_rzsize
 = 
	`u2rz
(
Şd_usize
);

2321 ià(
cÚfig_´of
 && 
İt_´of
) {

2322 
usize
 = 
	`ix®locx_´of
(
tsd
, 
±r
, 
Şd_usize
, 
size
, 
exŒa
,

2323 
®ignm’t
, 
z”o
);

2325 
usize
 = 
	`ix®locx_h–³r
(
±r
, 
Şd_usize
, 
size
, 
exŒa
, 
®ignm’t
,

2326 
z”o
);

2328 ià(
	`uÆik–y
(
usize
 =ğ
Şd_usize
))

2329 
Ïb–_nÙ_»sized
;

2331 ià(
cÚfig_¡©s
) {

2332 *
	`tsd_th»ad_®loÿ‹dp_g‘
(
tsd
è+ğ
usize
;

2333 *
	`tsd_th»ad_d—Îoÿ‹dp_g‘
(
tsd
è+ğ
Şd_usize
;

2335 
	`JEMALLOC_VALGRIND_REALLOC
(
çl£
, 
±r
, 
usize
, f®£,…Œ, 
Şd_usize
,

2336 
Şd_rzsize
, 
çl£
, 
z”o
);

2337 
Ïb–_nÙ_»sized
:

2338 
	`UTRACE
(
±r
, 
size
,…tr);

2339  (
usize
);

2340 
	}
}

2342 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW


2343 
	$JEMALLOC_ATTR
(
pu»
)

2344 
	$je_§Îocx
(cÚ¡ *
±r
, 
æags
)

2346 
size_t
 
usize
;

2348 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2349 
	`m®loc_th»ad_š™
();

2351 ià(
cÚfig_iv§Îoc
)

2352 
usize
 = 
	`iv§Îoc
(
±r
, 
cÚfig_´of
);

2354 
usize
 = 
	`i§Îoc
(
±r
, 
cÚfig_´of
);

2356  (
usize
);

2357 
	}
}

2359 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2360 
	$je_d®locx
(*
±r
, 
æags
)

2362 
tsd_t
 *
tsd
;

2363 
tÿche_t
 *
tÿche
;

2365 
	`as£¹
(
±r
 !ğ
NULL
);

2366 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2368 
tsd
 = 
	`tsd_ãtch
();

2369 ià(
	`uÆik–y
((
æags
 & 
MALLOCX_TCACHE_MASK
) != 0)) {

2370 ià((
æags
 & 
MALLOCX_TCACHE_MASK
è=ğ
MALLOCX_TCACHE_NONE
)

2371 
tÿche
 = 
NULL
;

2373 
tÿche
 = 
	`tÿches_g‘
(
tsd
, 
	`MALLOCX_TCACHE_GET
(
æags
));

2375 
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
çl£
);

2377 
	`UTRACE
(
±r
, 0, 0);

2378 
	`iä“
(
	`tsd_ãtch
(), 
±r
, 
tÿche
);

2379 
	}
}

2381 
JEMALLOC_ALWAYS_INLINE_C
 
size_t


2382 
	$š®locx
(
size_t
 
size
, 
æags
)

2384 
size_t
 
usize
;

2386 ià(
	`lik–y
((
æags
 & 
MALLOCX_LG_ALIGN_MASK
) == 0))

2387 
usize
 = 
	`s2u
(
size
);

2389 
usize
 = 
	`§2u
(
size
, 
	`MALLOCX_ALIGN_GET_SPECIFIED
(
æags
));

2390 
	`as£¹
(
usize
 != 0);

2391  (
usize
);

2392 
	}
}

2394 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2395 
	$je_sd®locx
(*
±r
, 
size_t
 
size
, 
æags
)

2397 
tsd_t
 *
tsd
;

2398 
tÿche_t
 *
tÿche
;

2399 
size_t
 
usize
;

2401 
	`as£¹
(
±r
 !ğ
NULL
);

2402 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2403 
usize
 = 
	`š®locx
(
size
, 
æags
);

2404 
	`as£¹
(
usize
 =ğ
	`i§Îoc
(
±r
, 
cÚfig_´of
));

2406 
tsd
 = 
	`tsd_ãtch
();

2407 ià(
	`uÆik–y
((
æags
 & 
MALLOCX_TCACHE_MASK
) != 0)) {

2408 ià((
æags
 & 
MALLOCX_TCACHE_MASK
è=ğ
MALLOCX_TCACHE_NONE
)

2409 
tÿche
 = 
NULL
;

2411 
tÿche
 = 
	`tÿches_g‘
(
tsd
, 
	`MALLOCX_TCACHE_GET
(
æags
));

2413 
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
çl£
);

2415 
	`UTRACE
(
±r
, 0, 0);

2416 
	`isä“
(
tsd
, 
±r
, 
usize
, 
tÿche
);

2417 
	}
}

2419 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW


2420 
	$JEMALLOC_ATTR
(
pu»
)

2421 
	$je_ÇÎocx
(
size_t
 
size
, 
æags
)

2424 
	`as£¹
(
size
 != 0);

2426 ià(
	`uÆik–y
(
	`m®loc_š™
()))

2429  (
	`š®locx
(
size
, 
æags
));

2430 
	}
}

2432 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2433 
	$je_m®lùl
(cÚ¡ *
Çme
, *
Şdp
, 
size_t
 *
ŞdËÅ
, *
Ãwp
,

2434 
size_t
 
ÃwËn
)

2437 ià(
	`uÆik–y
(
	`m®loc_š™
()))

2438  (
EAGAIN
);

2440  (
	`ùl_byÇme
(
Çme
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
));

2441 
	}
}

2443 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2444 
	$je_m®lùÊam‘omib
(cÚ¡ *
Çme
, 
size_t
 *
mibp
, size_ˆ*
mibËÅ
)

2447 ià(
	`uÆik–y
(
	`m®loc_š™
()))

2448  (
EAGAIN
);

2450  (
	`ùl_Çm‘omib
(
Çme
, 
mibp
, 
mibËÅ
));

2451 
	}
}

2453 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2454 
	$je_m®lùlbymib
(cÚ¡ 
size_t
 *
mib
, size_ˆ
mibËn
, *
Şdp
, size_ˆ*
ŞdËÅ
,

2455 *
Ãwp
, 
size_t
 
ÃwËn
)

2458 ià(
	`uÆik–y
(
	`m®loc_š™
()))

2459  (
EAGAIN
);

2461  (
	`ùl_bymib
(
mib
, 
mibËn
, 
Şdp
, 
ŞdËÅ
, 
Ãwp
, 
ÃwËn
));

2462 
	}
}

2464 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2465 
	$je_m®loc_¡©s_´št
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

2466 cÚ¡ *
İts
)

2469 
	`¡©s_´št
(
wr™e_cb
, 
cbİaque
, 
İts
);

2470 
	}
}

2472 
JEMALLOC_EXPORT
 
size_t
 
JEMALLOC_NOTHROW


2473 
	$je_m®loc_u§bË_size
(
JEMALLOC_USABLE_SIZE_CONST
 *
±r
)

2475 
size_t
 
»t
;

2477 
	`as£¹
(
	`m®loc_š™Ÿlized
(è|| 
IS_INITIALIZER
);

2478 
	`m®loc_th»ad_š™
();

2480 ià(
cÚfig_iv§Îoc
)

2481 
»t
 = 
	`iv§Îoc
(
±r
, 
cÚfig_´of
);

2483 
»t
 = (
±r
 =ğ
NULL
è? 0 : 
	`i§Îoc
ÕŒ, 
cÚfig_´of
);

2485  (
»t
);

2486 
	}
}

2510 
	$JEMALLOC_ATTR
(
cÚ¡ruùÜ
)

2512 
	$jem®loc_cÚ¡ruùÜ
()

2515 
	`m®loc_š™
();

2516 
	}
}

2518 #iâdeà
JEMALLOC_MUTEX_INIT_CB


2520 
	$jem®loc_´efÜk
()

2522 
JEMALLOC_EXPORT
 

2523 
	$_m®loc_´efÜk
()

2526 
i
;

2528 #ifdeà
JEMALLOC_MUTEX_INIT_CB


2529 ià(!
	`m®loc_š™Ÿlized
())

2532 
	`as£¹
(
	`m®loc_š™Ÿlized
());

2535 
	`ùl_´efÜk
();

2536 
	`´of_´efÜk
();

2537 
	`m®loc_mu‹x_´efÜk
(&
¬’as_lock
);

2538 
i
 = 0; i < 
Ç»Çs_tÙ®
; i++) {

2539 ià(
¬’as
[
i
] !ğ
NULL
)

2540 
	`¬’a_´efÜk
(
¬’as
[
i
]);

2542 
	`chunk_´efÜk
();

2543 
	`ba£_´efÜk
();

2544 
	}
}

2546 #iâdeà
JEMALLOC_MUTEX_INIT_CB


2548 
	$jem®loc_po¡fÜk_·»Á
()

2550 
JEMALLOC_EXPORT
 

2551 
	$_m®loc_po¡fÜk
()

2554 
i
;

2556 #ifdeà
JEMALLOC_MUTEX_INIT_CB


2557 ià(!
	`m®loc_š™Ÿlized
())

2560 
	`as£¹
(
	`m®loc_š™Ÿlized
());

2563 
	`ba£_po¡fÜk_·»Á
();

2564 
	`chunk_po¡fÜk_·»Á
();

2565 
i
 = 0; i < 
Ç»Çs_tÙ®
; i++) {

2566 ià(
¬’as
[
i
] !ğ
NULL
)

2567 
	`¬’a_po¡fÜk_·»Á
(
¬’as
[
i
]);

2569 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
¬’as_lock
);

2570 
	`´of_po¡fÜk_·»Á
();

2571 
	`ùl_po¡fÜk_·»Á
();

2572 
	}
}

2575 
	$jem®loc_po¡fÜk_chd
()

2577 
i
;

2579 
	`as£¹
(
	`m®loc_š™Ÿlized
());

2582 
	`ba£_po¡fÜk_chd
();

2583 
	`chunk_po¡fÜk_chd
();

2584 
i
 = 0; i < 
Ç»Çs_tÙ®
; i++) {

2585 ià(
¬’as
[
i
] !ğ
NULL
)

2586 
	`¬’a_po¡fÜk_chd
(
¬’as
[
i
]);

2588 
	`m®loc_mu‹x_po¡fÜk_chd
(&
¬’as_lock
);

2589 
	`´of_po¡fÜk_chd
();

2590 
	`ùl_po¡fÜk_chd
();

2591 
	}
}

2600 
JEMALLOC_EXPORT
 
JEMALLOC_NOTHROW


2601 
	$je_g‘_deäag_hšt
(* 
±r
, *
bš_ut
, *
run_ut
) {

2602 
deäag
 = 0;

2603 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(
±r
);

2604 ià(
	`lik–y
(
chunk
 !ğ
±r
)) {

2605 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 - (ušŒ_t)
chunk
è>> 
LG_PAGE
;

2606 
size_t
 
m­b™s
 = 
	`¬’a_m­b™s_g‘
(
chunk
, 
·gešd
);

2607 ià(
	`lik–y
((
m­b™s
 & 
CHUNK_MAP_LARGE
) == 0)) {

2608 
¬’a_t
 *
¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
);

2609 
size_t
 
½ages_šd
 = 
·gešd
 - 
	`¬’a_m­b™s_sm®l_runšd_g‘
(
chunk
,…ageind);

2610 
¬’a_run_t
 *
run
 = &
	`¬’a_misûlm_g‘
(
chunk
, 
½ages_šd
)->run;

2611 
¬’a_bš_t
 *
bš
 = &
¬’a
->
bšs
[
run
->
bššd
];

2612 
	`m®loc_mu‹x_lock
(&
bš
->
lock
);

2614 ià(
chunk
 !ğ(
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
bš
->
runcur
)) {

2615 
¬’a_bš_šfo_t
 *
bš_šfo
 = &
¬’a_bš_šfo
[
run
->
bššd
];

2616 
size_t
 
ava»gs
 = 
bš_šfo
->
Äegs
 * 
bš
->
¡©s
.
cu¼uns
;

2617 *
bš_ut
 = (
bš
->
¡©s
.
cu¼egs
<<16è/ 
ava»gs
;

2618 *
run_ut
 = ((
bš_šfo
->
Äegs
 - 
run
->
nä“
)<<16) / bin_info->nregs;

2619 
deäag
 = 1;

2621 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

2624  
deäag
;

2625 
	}
}

	@deps/jemalloc/src/mb.c

1 
	#JEMALLOC_MB_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

	@deps/jemalloc/src/mutex.c

1 
	#JEMALLOC_MUTEX_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

4 #ià
defšed
(
JEMALLOC_LAZY_LOCK
è&& !defšed(
_WIN32
)

5 
	~<dlfú.h
>

8 #iâdeà
_CRT_SPINCOUNT


9 
	#_CRT_SPINCOUNT
 4000

	)

15 #ifdeà
JEMALLOC_LAZY_LOCK


16 
boŞ
 
	gi¡h»aded
 = 
çl£
;

18 #ifdeà
JEMALLOC_MUTEX_INIT_CB


19 
boŞ
 
	gpo¡pÚe_š™
 = 
Œue
;

20 
m®loc_mu‹x_t
 *
	gpo¡pÚed_mu‹xes
 = 
NULL
;

23 #ià
defšed
(
JEMALLOC_LAZY_LOCK
è&& !defšed(
_WIN32
)

24 
±h»ad_ü—‹_Úû
();

33 #ià
defšed
(
JEMALLOC_LAZY_LOCK
è&& !defšed(
_WIN32
)

34 (*
±h»ad_ü—‹_åŒ
)(
±h»ad_t
 *
__»¡riù
, cÚ¡ 
±h»ad_©Œ_t
 *,

35 *(*)(*), *
__»¡riù
);

38 
	$±h»ad_ü—‹_Úû
()

41 
±h»ad_ü—‹_åŒ
 = 
	`dlsym
(
RTLD_NEXT
, "pthread_create");

42 ià(
±h»ad_ü—‹_åŒ
 =ğ
NULL
) {

43 
	`m®loc_wr™e
("<jemalloc>: Error in dlsym(RTLD_NEXT, "

45 
	`abÜt
();

48 
i¡h»aded
 = 
Œue
;

49 
	}
}

51 
JEMALLOC_EXPORT
 

52 
	$±h»ad_ü—‹
(
±h»ad_t
 *
__»¡riù
 
th»ad
,

53 cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
©Œ
, *(*
¡¬t_routše
)(*),

54 *
__»¡riù
 
¬g
)

56 
±h»ad_Úû_t
 
Úû_cÚŒŞ
 = 
PTHREAD_ONCE_INIT
;

58 
	`±h»ad_Úû
(&
Úû_cÚŒŞ
, 
±h»ad_ü—‹_Úû
);

60  (
	`±h»ad_ü—‹_åŒ
(
th»ad
, 
©Œ
, 
¡¬t_routše
, 
¬g
));

61 
	}
}

66 #ifdeà
JEMALLOC_MUTEX_INIT_CB


67 
JEMALLOC_EXPORT
 
_±h»ad_mu‹x_š™_ÿÎoc_cb
(
±h»ad_mu‹x_t
 *
mu‹x
,

68 *(
ÿÎoc_cb
)(
size_t
, size_t));

71 
boŞ


72 
	$m®loc_mu‹x_š™
(
m®loc_mu‹x_t
 *
mu‹x
)

75 #ifdeà
_WIN32


76 #ià
_WIN32_WINNT
 >= 0x0600

77 
	`In™ŸlizeSRWLock
(&
mu‹x
->
lock
);

79 ià(!
	`In™ŸlizeCr™iÿlSeùiÚAndSpšCouÁ
(&
mu‹x
->
lock
,

80 
_CRT_SPINCOUNT
))

81  (
Œue
);

83 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

84 
mu‹x
->
lock
 = 0;

85 #–ià(
	`defšed
(
JEMALLOC_MUTEX_INIT_CB
))

86 ià(
po¡pÚe_š™
) {

87 
mu‹x
->
po¡pÚed_Ãxt
 = 
po¡pÚed_mu‹xes
;

88 
po¡pÚed_mu‹xes
 = 
mu‹x
;

90 ià(
	`_±h»ad_mu‹x_š™_ÿÎoc_cb
(&
mu‹x
->
lock
,

91 
boÙ¡¿p_ÿÎoc
) != 0)

92  (
Œue
);

95 
±h»ad_mu‹x©Œ_t
 
©Œ
;

97 ià(
	`±h»ad_mu‹x©Œ_š™
(&
©Œ
) != 0)

98  (
Œue
);

99 
	`±h»ad_mu‹x©Œ_£‰y³
(&
©Œ
, 
MALLOC_MUTEX_TYPE
);

100 ià(
	`±h»ad_mu‹x_š™
(&
mu‹x
->
lock
, &
©Œ
) != 0) {

101 
	`±h»ad_mu‹x©Œ_de¡roy
(&
©Œ
);

102  (
Œue
);

104 
	`±h»ad_mu‹x©Œ_de¡roy
(&
©Œ
);

106  (
çl£
);

107 
	}
}

110 
	$m®loc_mu‹x_´efÜk
(
m®loc_mu‹x_t
 *
mu‹x
)

113 
	`m®loc_mu‹x_lock
(
mu‹x
);

114 
	}
}

117 
	$m®loc_mu‹x_po¡fÜk_·»Á
(
m®loc_mu‹x_t
 *
mu‹x
)

120 
	`m®loc_mu‹x_uÆock
(
mu‹x
);

121 
	}
}

124 
	$m®loc_mu‹x_po¡fÜk_chd
(
m®loc_mu‹x_t
 *
mu‹x
)

127 #ifdeà
JEMALLOC_MUTEX_INIT_CB


128 
	`m®loc_mu‹x_uÆock
(
mu‹x
);

130 ià(
	`m®loc_mu‹x_š™
(
mu‹x
)) {

131 
	`m®loc_´štf
("<jemalloc>: Error„e-initializing mutex in "

133 ià(
İt_abÜt
)

134 
	`abÜt
();

137 
	}
}

139 
boŞ


140 
	$mu‹x_boÙ
()

143 #ifdeà
JEMALLOC_MUTEX_INIT_CB


144 
po¡pÚe_š™
 = 
çl£
;

145 
po¡pÚed_mu‹xes
 !ğ
NULL
) {

146 ià(
	`_±h»ad_mu‹x_š™_ÿÎoc_cb
(&
po¡pÚed_mu‹xes
->
lock
,

147 
boÙ¡¿p_ÿÎoc
) != 0)

148  (
Œue
);

149 
po¡pÚed_mu‹xes
 =…o¡pÚed_mu‹xes->
po¡pÚed_Ãxt
;

152  (
çl£
);

153 
	}
}

	@deps/jemalloc/src/pages.c

1 
	#JEMALLOC_PAGES_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
	$·ges_m­
(*
addr
, 
size_t
 
size
)

9 *
»t
;

11 
	`as£¹
(
size
 != 0);

13 #ifdeà
_WIN32


18 
»t
 = 
	`Vœtu®AÎoc
(
addr
, 
size
, 
MEM_COMMIT
 | 
MEM_RESERVE
,

19 
PAGE_READWRITE
);

25 
»t
 = 
	`mm­
(
addr
, 
size
, 
PROT_READ
 | 
PROT_WRITE
, 
MAP_PRIVATE
 | 
MAP_ANON
,

27 
	`as£¹
(
»t
 !ğ
NULL
);

29 ià(
»t
 =ğ
MAP_FAILED
)

30 
»t
 = 
NULL
;

31 ià(
addr
 !ğ
NULL
 && 
»t
 !=‡ddr) {

35 
	`·ges_unm­
(
»t
, 
size
);

36 
»t
 = 
NULL
;

39 
	`as£¹
(
»t
 =ğ
NULL
 || (
addr
 == NULL &&„et !=‡ddr)

40 || (
addr
 !ğ
NULL
 && 
»t
 ==‡ddr));

41  (
»t
);

42 
	}
}

45 
	$·ges_unm­
(*
addr
, 
size_t
 
size
)

48 #ifdeà
_WIN32


49 ià(
	`Vœtu®F»e
(
addr
, 0, 
MEM_RELEASE
) == 0)

51 ià(
	`munm­
(
addr
, 
size
) == -1)

54 
buf
[
BUFERROR_BUF
];

56 
	`buã¼Ü
(
	`g‘_”ºo
(), 
buf
, (buf));

57 
	`m®loc_´štf
("<jemalloc>: Error in "

58 #ifdeà
_WIN32


63 "(): %s\n", 
buf
);

64 ià(
İt_abÜt
)

65 
	`abÜt
();

67 
	}
}

70 
	$·ges_Œim
(*
addr
, 
size_t
 
®loc_size
, size_ˆ
Ëadsize
, size_ˆ
size
)

72 *
»t
 = (*)((
ušŒ_t
)
addr
 + 
Ëadsize
);

74 
	`as£¹
(
®loc_size
 >ğ
Ëadsize
 + 
size
);

75 #ifdeà
_WIN32


77 *
Ãw_addr
;

79 
	`·ges_unm­
(
addr
, 
®loc_size
);

80 
Ãw_addr
 = 
	`·ges_m­
(
»t
, 
size
);

81 ià(
Ãw_addr
 =ğ
»t
)

82  (
»t
);

83 ià(
Ãw_addr
)

84 
	`·ges_unm­
(
Ãw_addr
, 
size
);

85  (
NULL
);

89 
size_t
 
Œasize
 = 
®loc_size
 - 
Ëadsize
 - 
size
;

91 ià(
Ëadsize
 != 0)

92 
	`·ges_unm­
(
addr
, 
Ëadsize
);

93 ià(
Œasize
 != 0)

94 
	`·ges_unm­
((*)((
ušŒ_t
)
»t
 + 
size
), 
Œasize
);

95  (
»t
);

98 
	}
}

100 
boŞ


101 
	$·ges_comm™_im¶
(*
addr
, 
size_t
 
size
, 
boŞ
 
comm™
)

104 #iâdeà
_WIN32


111 ià(
çl£
) {

112 
´Ù
 = 
comm™
 ? (
PROT_READ
 | 
PROT_WRITE
è: 
PROT_NONE
;

113 *
»suÉ
 = 
	`mm­
(
addr
, 
size
, 
´Ù
, 
MAP_PRIVATE
 | 
MAP_ANON
 |

114 
MAP_FIXED
, -1, 0);

115 ià(
»suÉ
 =ğ
MAP_FAILED
)

116  (
Œue
);

117 ià(
»suÉ
 !ğ
addr
) {

122 
	`·ges_unm­
(
»suÉ
, 
size
);

123  (
Œue
);

125  (
çl£
);

128  (
Œue
);

129 
	}
}

131 
boŞ


132 
	$·ges_comm™
(*
addr
, 
size_t
 
size
)

135  (
	`·ges_comm™_im¶
(
addr
, 
size
, 
Œue
));

136 
	}
}

138 
boŞ


139 
	$·ges_decomm™
(*
addr
, 
size_t
 
size
)

142  (
	`·ges_comm™_im¶
(
addr
, 
size
, 
çl£
));

143 
	}
}

145 
boŞ


146 
	$·ges_purge
(*
addr
, 
size_t
 
size
)

148 
boŞ
 
unz”Ûd
;

150 #ifdeà
_WIN32


151 
	`Vœtu®AÎoc
(
addr
, 
size
, 
MEM_RESET
, 
PAGE_READWRITE
);

152 
unz”Ûd
 = 
Œue
;

153 #–ià
	`defšed
(
JEMALLOC_HAVE_MADVISE
)

154 #ifdeà
JEMALLOC_PURGE_MADVISE_DONTNEED


155 
	#JEMALLOC_MADV_PURGE
 
MADV_DONTNEED


	)

156 
	#JEMALLOC_MADV_ZEROS
 
Œue


	)

157 #–ià
	`defšed
(
JEMALLOC_PURGE_MADVISE_FREE
)

158 
	#JEMALLOC_MADV_PURGE
 
MADV_FREE


	)

159 
	#JEMALLOC_MADV_ZEROS
 
çl£


	)

163 
”r
 = 
	`madvi£
(
addr
, 
size
, 
JEMALLOC_MADV_PURGE
);

164 
unz”Ûd
 = (!
JEMALLOC_MADV_ZEROS
 || 
”r
 != 0);

165 #undeà
JEMALLOC_MADV_PURGE


166 #undeà
JEMALLOC_MADV_ZEROS


169 
unz”Ûd
 = 
Œue
;

171  (
unz”Ûd
);

172 
	}
}

	@deps/jemalloc/src/prof.c

1 
	#JEMALLOC_PROF_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

5 #ifdeà
JEMALLOC_PROF_LIBUNWIND


6 
	#UNW_LOCAL_ONLY


	)

7 
	~<libunwšd.h
>

10 #ifdeà
JEMALLOC_PROF_LIBGCC


11 
	~<unwšd.h
>

17 
boŞ
 
	gİt_´of
 = 
çl£
;

18 
boŞ
 
	gİt_´of_aùive
 = 
Œue
;

19 
boŞ
 
	gİt_´of_th»ad_aùive_š™
 = 
Œue
;

20 
size_t
 
	gİt_lg_´of_§m¶e
 = 
LG_PROF_SAMPLE_DEFAULT
;

21 
ssize_t
 
	gİt_lg_´of_š‹rv®
 = 
LG_PROF_INTERVAL_DEFAULT
;

22 
boŞ
 
	gİt_´of_gdump
 = 
çl£
;

23 
boŞ
 
	gİt_´of_fš®
 = 
çl£
;

24 
boŞ
 
	gİt_´of_Ëak
 = 
çl£
;

25 
boŞ
 
	gİt_´of_accum
 = 
çl£
;

26 
	gİt_´of_´efix
[

28 #ifdeà
JEMALLOC_PROF


29 
PATH_MAX
 +

37 
boŞ
 
	g´of_aùive
;

38 
m®loc_mu‹x_t
 
	g´of_aùive_mtx
;

44 
boŞ
 
	g´of_th»ad_aùive_š™
;

45 
m®loc_mu‹x_t
 
	g´of_th»ad_aùive_š™_mtx
;

51 
boŞ
 
	g´of_gdump_v®
;

52 
m®loc_mu‹x_t
 
	g´of_gdump_mtx
;

54 
ušt64_t
 
	g´of_š‹rv®
 = 0;

56 
size_t
 
	glg_´of_§m¶e
;

65 
m®loc_mu‹x_t
 *
	ggùx_locks
;

66 
	gcum_gùxs
;

74 
m®loc_mu‹x_t
 *
	gtd©a_locks
;

80 
ckh_t
 
	gbt2gùx
;

81 
m®loc_mu‹x_t
 
	gbt2gùx_mtx
;

87 
´of_td©a_Œ“_t
 
	gtd©as
;

88 
m®loc_mu‹x_t
 
	gtd©as_mtx
;

90 
ušt64_t
 
	gÃxt_thr_uid
;

91 
m®loc_mu‹x_t
 
	gÃxt_thr_uid_mtx
;

93 
m®loc_mu‹x_t
 
	g´of_dump_£q_mtx
;

94 
ušt64_t
 
	g´of_dump_£q
;

95 
ušt64_t
 
	g´of_dump_i£q
;

96 
ušt64_t
 
	g´of_dump_m£q
;

97 
ušt64_t
 
	g´of_dump_u£q
;

103 
m®loc_mu‹x_t
 
	g´of_dump_mtx
;

104 
	g´of_dump_buf
[

106 #ifdeà
JEMALLOC_PROF


107 
PROF_DUMP_BUFSIZE


112 
	g´of_dump_buf_’d
;

113 
	g´of_dump_fd
;

116 
boŞ
 
	g´of_boÙed
 = 
çl£
;

124 
boŞ
 
´of_tùx_should_de¡roy
(
´of_tùx_t
 *
tùx
);

125 
´of_tùx_de¡roy
(
tsd_t
 *
tsd
, 
´of_tùx_t
 *
tùx
);

126 
boŞ
 
´of_td©a_should_de¡roy
(
´of_td©a_t
 *
td©a
,

127 
boŞ
 
ev’_if_©ched
);

128 
´of_td©a_de¡roy
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a
,

129 
boŞ
 
ev’_if_©ched
);

130 *
´of_th»ad_Çme_®loc
(
tsd_t
 *
tsd
, cÚ¡ *
th»ad_Çme
);

135 
JEMALLOC_INLINE_C
 

136 
	$´of_tùx_comp
(cÚ¡ 
´of_tùx_t
 *
a
, cÚ¡…rof_tùx_ˆ*
b
)

138 
ušt64_t
 
a_thr_uid
 = 
a
->
thr_uid
;

139 
ušt64_t
 
b_thr_uid
 = 
b
->
thr_uid
;

140 
»t
 = (
a_thr_uid
 > 
b_thr_uid
) - (a_thr_uid < b_thr_uid);

141 ià(
»t
 == 0) {

142 
ušt64_t
 
a_thr_disüim
 = 
a
->
thr_disüim
;

143 
ušt64_t
 
b_thr_disüim
 = 
b
->
thr_disüim
;

144 
»t
 = (
a_thr_disüim
 > 
b_thr_disüim
) - (a_thr_discrim <

145 
b_thr_disüim
);

146 ià(
»t
 == 0) {

147 
ušt64_t
 
a_tùx_uid
 = 
a
->
tùx_uid
;

148 
ušt64_t
 
b_tùx_uid
 = 
b
->
tùx_uid
;

149 
»t
 = (
a_tùx_uid
 > 
b_tùx_uid
) - (a_tctx_uid <

150 
b_tùx_uid
);

153  (
»t
);

154 
	}
}

156 
	$rb_g’
(
UNUSED
, 
tùx_Œ“_
, 
´of_tùx_Œ“_t
, 
´of_tùx_t
,

157 
tùx_lšk
, 
´of_tùx_comp
)

159 
JEMALLOC_INLINE_C
 

160 
	$´of_gùx_comp
(cÚ¡ 
´of_gùx_t
 *
a
, cÚ¡…rof_gùx_ˆ*
b
)

162 
a_Ën
 = 
a
->
bt
.
Ën
;

163 
b_Ën
 = 
b
->
bt
.
Ën
;

164 
comp_Ën
 = (
a_Ën
 < 
b_Ën
) ?‡_len : b_len;

165 
»t
 = 
	`memcmp
(
a
->
bt
.
vec
, 
b
->bt.vec, 
comp_Ën
 * (*));

166 ià(
»t
 == 0)

167 
»t
 = (
a_Ën
 > 
b_Ën
) - (a_len < b_len);

168  (
»t
);

169 
	}
}

171 
	$rb_g’
(
UNUSED
, 
gùx_Œ“_
, 
´of_gùx_Œ“_t
, 
´of_gùx_t
, 
dump_lšk
,

172 
´of_gùx_comp
)

174 
JEMALLOC_INLINE_C
 

175 
	$´of_td©a_comp
(cÚ¡ 
´of_td©a_t
 *
a
, cÚ¡…rof_td©a_ˆ*
b
)

177 
»t
;

178 
ušt64_t
 
a_uid
 = 
a
->
thr_uid
;

179 
ušt64_t
 
b_uid
 = 
b
->
thr_uid
;

181 
»t
 = ((
a_uid
 > 
b_uid
) - (a_uid < b_uid));

182 ià(
»t
 == 0) {

183 
ušt64_t
 
a_disüim
 = 
a
->
thr_disüim
;

184 
ušt64_t
 
b_disüim
 = 
b
->
thr_disüim
;

186 
»t
 = ((
a_disüim
 > 
b_disüim
) - (a_discrim < b_discrim));

188  (
»t
);

189 
	}
}

191 
	$rb_g’
(
UNUSED
, 
td©a_Œ“_
, 
´of_td©a_Œ“_t
, 
´of_td©a_t
, 
td©a_lšk
,

192 
´of_td©a_comp
)

197 
	$´of_®loc_rŞlback
(
tsd_t
 *
tsd
, 
´of_tùx_t
 *
tùx
, 
boŞ
 
upd©ed
)

199 
´of_td©a_t
 *
td©a
;

201 
	`ÿs£¹
(
cÚfig_´of
);

203 ià(
upd©ed
) {

210 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

211 ià(
td©a
 !ğ
NULL
)

212 
	`´of_§m¶e_th»shŞd_upd©e
(
td©a
);

215 ià((
ušŒ_t
)
tùx
 > (uintptr_t)1U) {

216 
	`m®loc_mu‹x_lock
(
tùx
->
td©a
->
lock
);

217 
tùx
->
´•¬ed
 = 
çl£
;

218 ià(
	`´of_tùx_should_de¡roy
(
tùx
))

219 
	`´of_tùx_de¡roy
(
tsd
, 
tùx
);

221 
	`m®loc_mu‹x_uÆock
(
tùx
->
td©a
->
lock
);

223 
	}
}

226 
	$´of_m®loc_§m¶e_objeù
(cÚ¡ *
±r
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
)

229 
	`´of_tùx_£t
(
±r
, 
usize
, 
tùx
);

231 
	`m®loc_mu‹x_lock
(
tùx
->
td©a
->
lock
);

232 
tùx
->
úts
.
curobjs
++;

233 
tùx
->
úts
.
curby‹s
 +ğ
usize
;

234 ià(
İt_´of_accum
) {

235 
tùx
->
úts
.
accumobjs
++;

236 
tùx
->
úts
.
accumby‹s
 +ğ
usize
;

238 
tùx
->
´•¬ed
 = 
çl£
;

239 
	`m®loc_mu‹x_uÆock
(
tùx
->
td©a
->
lock
);

240 
	}
}

243 
	$´of_ä“_§m¶ed_objeù
(
tsd_t
 *
tsd
, 
size_t
 
usize
, 
´of_tùx_t
 *
tùx
)

246 
	`m®loc_mu‹x_lock
(
tùx
->
td©a
->
lock
);

247 
	`as£¹
(
tùx
->
úts
.
curobjs
 > 0);

248 
	`as£¹
(
tùx
->
úts
.
curby‹s
 >ğ
usize
);

249 
tùx
->
úts
.
curobjs
--;

250 
tùx
->
úts
.
curby‹s
 -ğ
usize
;

252 ià(
	`´of_tùx_should_de¡roy
(
tùx
))

253 
	`´of_tùx_de¡roy
(
tsd
, 
tùx
);

255 
	`m®loc_mu‹x_uÆock
(
tùx
->
td©a
->
lock
);

256 
	}
}

259 
	$bt_š™
(
´of_bt_t
 *
bt
, **
vec
)

262 
	`ÿs£¹
(
cÚfig_´of
);

264 
bt
->
vec
 = vec;

265 
bt
->
Ën
 = 0;

266 
	}
}

268 
JEMALLOC_INLINE_C
 

269 
	$´of_’‹r
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a
)

272 
	`ÿs£¹
(
cÚfig_´of
);

273 
	`as£¹
(
td©a
 =ğ
	`´of_td©a_g‘
(
tsd
, 
çl£
));

275 ià(
td©a
 !ğ
NULL
) {

276 
	`as£¹
(!
td©a
->
’q
);

277 
td©a
->
’q
 = 
Œue
;

280 
	`m®loc_mu‹x_lock
(&
bt2gùx_mtx
);

281 
	}
}

283 
JEMALLOC_INLINE_C
 

284 
	$´of_Ëave
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a
)

287 
	`ÿs£¹
(
cÚfig_´of
);

288 
	`as£¹
(
td©a
 =ğ
	`´of_td©a_g‘
(
tsd
, 
çl£
));

290 
	`m®loc_mu‹x_uÆock
(&
bt2gùx_mtx
);

292 ià(
td©a
 !ğ
NULL
) {

293 
boŞ
 
idump
, 
gdump
;

295 
	`as£¹
(
td©a
->
’q
);

296 
td©a
->
’q
 = 
çl£
;

297 
idump
 = 
td©a
->
’q_idump
;

298 
td©a
->
’q_idump
 = 
çl£
;

299 
gdump
 = 
td©a
->
’q_gdump
;

300 
td©a
->
’q_gdump
 = 
çl£
;

302 ià(
idump
)

303 
	`´of_idump
();

304 ià(
gdump
)

305 
	`´of_gdump
();

307 
	}
}

309 #ifdeà
JEMALLOC_PROF_LIBUNWIND


311 
	$´of_backŒaû
(
´of_bt_t
 *
bt
)

313 
näames
;

315 
	`ÿs£¹
(
cÚfig_´of
);

316 
	`as£¹
(
bt
->
Ën
 == 0);

317 
	`as£¹
(
bt
->
vec
 !ğ
NULL
);

319 
näames
 = 
	`unw_backŒaû
(
bt
->
vec
, 
PROF_BT_MAX
);

320 ià(
näames
 <= 0)

322 
bt
->
Ën
 = 
näames
;

323 
	}
}

324 #–ià(
defšed
(
JEMALLOC_PROF_LIBGCC
))

325 
_Unwšd_R—sÚ_Code


326 
	$´of_unwšd_š™_ÿÎback
(
_Unwšd_CÚ‹xt
 *
cÚ‹xt
, *
¬g
)

329 
	`ÿs£¹
(
cÚfig_´of
);

331  (
_URC_NO_REASON
);

332 
	}
}

334 
_Unwšd_R—sÚ_Code


335 
	$´of_unwšd_ÿÎback
(
_Unwšd_CÚ‹xt
 *
cÚ‹xt
, *
¬g
)

337 
´of_unwšd_d©a_t
 *
d©a
 = (´of_unwšd_d©a_ˆ*)
¬g
;

338 *

;

340 
	`ÿs£¹
(
cÚfig_´of
);

342 

 = (*)
	`_Unwšd_G‘IP
(
cÚ‹xt
);

343 ià(

 =ğ
NULL
)

344  (
_URC_END_OF_STACK
);

345 
d©a
->
bt
->
vec
[d©a->bt->
Ën
] = 

;

346 
d©a
->
bt
->
Ën
++;

347 ià(
d©a
->
bt
->
Ën
 =ğd©a->
max
)

348  (
_URC_END_OF_STACK
);

350  (
_URC_NO_REASON
);

351 
	}
}

354 
	$´of_backŒaû
(
´of_bt_t
 *
bt
)

356 
´of_unwšd_d©a_t
 
d©a
 = {
bt
, 
PROF_BT_MAX
};

358 
	`ÿs£¹
(
cÚfig_´of
);

360 
	`_Unwšd_BackŒaû
(
´of_unwšd_ÿÎback
, &
d©a
);

361 
	}
}

362 #–ià(
defšed
(
JEMALLOC_PROF_GCC
))

364 
	$´of_backŒaû
(
´of_bt_t
 *
bt
)

366 
	#BT_FRAME
(
i
) \

367 ià((
i
è< 
PROF_BT_MAX
) { \

368 *
p
; \

369 ià(
	`__butš_äame_add»ss
(
i
) == 0) \

371 
p
 = 
	`__butš_»tuº_add»ss
(
i
); \

372 ià(
p
 =ğ
NULL
) \

374 
bt
->
vec
[(
i
)] = 
p
; \

375 
bt
->
Ën
 = (
i
) + 1; \

377 ;

	)

379 
	`ÿs£¹
(
cÚfig_´of
);

381 
	`BT_FRAME
(0)

382 
	`BT_FRAME
(1)

383 
	`BT_FRAME
(2)

384 
	`BT_FRAME
(3)

385 
	`BT_FRAME
(4)

386 
	`BT_FRAME
(5)

387 
	`BT_FRAME
(6)

388 
	`BT_FRAME
(7)

389 
	`BT_FRAME
(8)

390 
	`BT_FRAME
(9)

392 
	`BT_FRAME
(10)

393 
	`BT_FRAME
(11)

394 
	`BT_FRAME
(12)

395 
	`BT_FRAME
(13)

396 
	`BT_FRAME
(14)

397 
	`BT_FRAME
(15)

398 
	`BT_FRAME
(16)

399 
	`BT_FRAME
(17)

400 
	`BT_FRAME
(18)

401 
	`BT_FRAME
(19)

403 
	`BT_FRAME
(20)

404 
	`BT_FRAME
(21)

405 
	`BT_FRAME
(22)

406 
	`BT_FRAME
(23)

407 
	`BT_FRAME
(24)

408 
	`BT_FRAME
(25)

409 
	`BT_FRAME
(26)

410 
	`BT_FRAME
(27)

411 
	`BT_FRAME
(28)

412 
	`BT_FRAME
(29)

414 
	`BT_FRAME
(30)

415 
	`BT_FRAME
(31)

416 
	`BT_FRAME
(32)

417 
	`BT_FRAME
(33)

418 
	`BT_FRAME
(34)

419 
	`BT_FRAME
(35)

420 
	`BT_FRAME
(36)

421 
	`BT_FRAME
(37)

422 
	`BT_FRAME
(38)

423 
	`BT_FRAME
(39)

425 
	`BT_FRAME
(40)

426 
	`BT_FRAME
(41)

427 
	`BT_FRAME
(42)

428 
	`BT_FRAME
(43)

429 
	`BT_FRAME
(44)

430 
	`BT_FRAME
(45)

431 
	`BT_FRAME
(46)

432 
	`BT_FRAME
(47)

433 
	`BT_FRAME
(48)

434 
	`BT_FRAME
(49)

436 
	`BT_FRAME
(50)

437 
	`BT_FRAME
(51)

438 
	`BT_FRAME
(52)

439 
	`BT_FRAME
(53)

440 
	`BT_FRAME
(54)

441 
	`BT_FRAME
(55)

442 
	`BT_FRAME
(56)

443 
	`BT_FRAME
(57)

444 
	`BT_FRAME
(58)

445 
	`BT_FRAME
(59)

447 
	`BT_FRAME
(60)

448 
	`BT_FRAME
(61)

449 
	`BT_FRAME
(62)

450 
	`BT_FRAME
(63)

451 
	`BT_FRAME
(64)

452 
	`BT_FRAME
(65)

453 
	`BT_FRAME
(66)

454 
	`BT_FRAME
(67)

455 
	`BT_FRAME
(68)

456 
	`BT_FRAME
(69)

458 
	`BT_FRAME
(70)

459 
	`BT_FRAME
(71)

460 
	`BT_FRAME
(72)

461 
	`BT_FRAME
(73)

462 
	`BT_FRAME
(74)

463 
	`BT_FRAME
(75)

464 
	`BT_FRAME
(76)

465 
	`BT_FRAME
(77)

466 
	`BT_FRAME
(78)

467 
	`BT_FRAME
(79)

469 
	`BT_FRAME
(80)

470 
	`BT_FRAME
(81)

471 
	`BT_FRAME
(82)

472 
	`BT_FRAME
(83)

473 
	`BT_FRAME
(84)

474 
	`BT_FRAME
(85)

475 
	`BT_FRAME
(86)

476 
	`BT_FRAME
(87)

477 
	`BT_FRAME
(88)

478 
	`BT_FRAME
(89)

480 
	`BT_FRAME
(90)

481 
	`BT_FRAME
(91)

482 
	`BT_FRAME
(92)

483 
	`BT_FRAME
(93)

484 
	`BT_FRAME
(94)

485 
	`BT_FRAME
(95)

486 
	`BT_FRAME
(96)

487 
	`BT_FRAME
(97)

488 
	`BT_FRAME
(98)

489 
	`BT_FRAME
(99)

491 
	`BT_FRAME
(100)

492 
	`BT_FRAME
(101)

493 
	`BT_FRAME
(102)

494 
	`BT_FRAME
(103)

495 
	`BT_FRAME
(104)

496 
	`BT_FRAME
(105)

497 
	`BT_FRAME
(106)

498 
	`BT_FRAME
(107)

499 
	`BT_FRAME
(108)

500 
	`BT_FRAME
(109)

502 
	`BT_FRAME
(110)

503 
	`BT_FRAME
(111)

504 
	`BT_FRAME
(112)

505 
	`BT_FRAME
(113)

506 
	`BT_FRAME
(114)

507 
	`BT_FRAME
(115)

508 
	`BT_FRAME
(116)

509 
	`BT_FRAME
(117)

510 
	`BT_FRAME
(118)

511 
	`BT_FRAME
(119)

513 
	`BT_FRAME
(120)

514 
	`BT_FRAME
(121)

515 
	`BT_FRAME
(122)

516 
	`BT_FRAME
(123)

517 
	`BT_FRAME
(124)

518 
	`BT_FRAME
(125)

519 
	`BT_FRAME
(126)

520 
	`BT_FRAME
(127)

521 #undeà
BT_FRAME


522 
	}
}

525 
	$´of_backŒaû
(
´of_bt_t
 *
bt
)

528 
	`ÿs£¹
(
cÚfig_´of
);

529 
	`nÙ_»ached
();

530 
	}
}

533 
m®loc_mu‹x_t
 *

534 
	$´of_gùx_mu‹x_choo£
()

536 
ngùxs
 = 
	`©omic_add_u
(&
cum_gùxs
, 1);

538  (&
gùx_locks
[(
ngùxs
 - 1è% 
PROF_NCTX_LOCKS
]);

539 
	}
}

541 
m®loc_mu‹x_t
 *

542 
	$´of_td©a_mu‹x_choo£
(
ušt64_t
 
thr_uid
)

545  (&
td©a_locks
[
thr_uid
 % 
PROF_NTDATA_LOCKS
]);

546 
	}
}

548 
´of_gùx_t
 *

549 
	$´of_gùx_ü—‹
(
tsd_t
 *
tsd
, 
´of_bt_t
 *
bt
)

554 
´of_gùx_t
 *
gùx
 = (´of_gùx_ˆ*)
	`ŸÎocztm
(
tsd
, 
	`off£tof
(prof_gctx_t,

555 
vec
è+ (
bt
->
Ën
 * (*)), 
çl£
, 
	`tÿche_g‘
(
tsd
, 
Œue
),

556 
Œue
, 
NULL
);

557 ià(
gùx
 =ğ
NULL
)

558  (
NULL
);

559 
gùx
->
lock
 = 
	`´of_gùx_mu‹x_choo£
();

564 
gùx
->
Æimbo
 = 1;

565 
	`tùx_Œ“_Ãw
(&
gùx
->
tùxs
);

567 
	`memıy
(
gùx
->
vec
, 
bt
->vec, bt->
Ën
 * (*));

568 
gùx
->
bt
.
vec
 = gctx->vec;

569 
gùx
->
bt
.
Ën
 = bt->len;

570  (
gùx
);

571 
	}
}

574 
	$´of_gùx_Œy_de¡roy
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a_£lf
, 
´of_gùx_t
 *
gùx
,

575 
´of_td©a_t
 *
td©a
)

578 
	`ÿs£¹
(
cÚfig_´of
);

587 
	`´of_’‹r
(
tsd
, 
td©a_£lf
);

588 
	`m®loc_mu‹x_lock
(
gùx
->
lock
);

589 
	`as£¹
(
gùx
->
Æimbo
 != 0);

590 ià(
	`tùx_Œ“_em±y
(&
gùx
->
tùxs
è&& gùx->
Æimbo
 == 1) {

592 ià(
	`ckh_»move
(
tsd
, &
bt2gùx
, &
gùx
->
bt
, 
NULL
, NULL))

593 
	`nÙ_»ached
();

594 
	`´of_Ëave
(
tsd
, 
td©a_£lf
);

596 
	`m®loc_mu‹x_uÆock
(
gùx
->
lock
);

597 
	`id®loùm
(
tsd
, 
gùx
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

603 
gùx
->
Æimbo
--;

604 
	`m®loc_mu‹x_uÆock
(
gùx
->
lock
);

605 
	`´of_Ëave
(
tsd
, 
td©a_£lf
);

607 
	}
}

610 
boŞ


611 
	$´of_tùx_should_de¡roy
(
´of_tùx_t
 *
tùx
)

614 ià(
İt_´of_accum
)

615  (
çl£
);

616 ià(
tùx
->
úts
.
curobjs
 != 0)

617  (
çl£
);

618 ià(
tùx
->
´•¬ed
)

619  (
çl£
);

620  (
Œue
);

621 
	}
}

623 
boŞ


624 
	$´of_gùx_should_de¡roy
(
´of_gùx_t
 *
gùx
)

627 ià(
İt_´of_accum
)

628  (
çl£
);

629 ià(!
	`tùx_Œ“_em±y
(&
gùx
->
tùxs
))

630  (
çl£
);

631 ià(
gùx
->
Æimbo
 != 0)

632  (
çl£
);

633  (
Œue
);

634 
	}
}

638 
	$´of_tùx_de¡roy
(
tsd_t
 *
tsd
, 
´of_tùx_t
 *
tùx
)

640 
´of_td©a_t
 *
td©a
 = 
tùx
->tdata;

641 
´of_gùx_t
 *
gùx
 = 
tùx
->gctx;

642 
boŞ
 
de¡roy_td©a
, 
de¡roy_tùx
, 
de¡roy_gùx
;

644 
	`as£¹
(
tùx
->
úts
.
curobjs
 == 0);

645 
	`as£¹
(
tùx
->
úts
.
curby‹s
 == 0);

646 
	`as£¹
(!
İt_´of_accum
);

647 
	`as£¹
(
tùx
->
úts
.
accumobjs
 == 0);

648 
	`as£¹
(
tùx
->
úts
.
accumby‹s
 == 0);

650 
	`ckh_»move
(
tsd
, &
td©a
->
bt2tùx
, &
gùx
->
bt
, 
NULL
, NULL);

651 
de¡roy_td©a
 = 
	`´of_td©a_should_de¡roy
(
td©a
, 
çl£
);

652 
	`m®loc_mu‹x_uÆock
(
td©a
->
lock
);

654 
	`m®loc_mu‹x_lock
(
gùx
->
lock
);

655 
tùx
->
¡©e
) {

656 
´of_tùx_¡©e_nomš®
:

657 
	`tùx_Œ“_»move
(&
gùx
->
tùxs
, 
tùx
);

658 
de¡roy_tùx
 = 
Œue
;

659 ià(
	`´of_gùx_should_de¡roy
(
gùx
)) {

674 
gùx
->
Æimbo
++;

675 
de¡roy_gùx
 = 
Œue
;

677 
de¡roy_gùx
 = 
çl£
;

679 
´of_tùx_¡©e_dumpšg
:

685 
tùx
->
¡©e
 = 
´of_tùx_¡©e_purg©Üy
;

686 
de¡roy_tùx
 = 
çl£
;

687 
de¡roy_gùx
 = 
çl£
;

690 
	`nÙ_»ached
();

691 
de¡roy_tùx
 = 
çl£
;

692 
de¡roy_gùx
 = 
çl£
;

694 
	`m®loc_mu‹x_uÆock
(
gùx
->
lock
);

695 ià(
de¡roy_gùx
) {

696 
	`´of_gùx_Œy_de¡roy
(
tsd
, 
	`´of_td©a_g‘
Ñsd, 
çl£
), 
gùx
,

697 
td©a
);

700 ià(
de¡roy_td©a
)

701 
	`´of_td©a_de¡roy
(
tsd
, 
td©a
, 
çl£
);

703 ià(
de¡roy_tùx
)

704 
	`id®loùm
(
tsd
, 
tùx
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

705 
	}
}

707 
boŞ


708 
	$´of_lookup_glob®
(
tsd_t
 *
tsd
, 
´of_bt_t
 *
bt
, 
´of_td©a_t
 *
td©a
,

709 **
p_btkey
, 
´of_gùx_t
 **
p_gùx
, 
boŞ
 *
p_Ãw_gùx
)

712 
´of_gùx_t
 *
p
;

713 *
v
;

714 } 
gùx
;

716 
´of_bt_t
 *
p
;

717 *
v
;

718 } 
btkey
;

719 
boŞ
 
Ãw_gùx
;

721 
	`´of_’‹r
(
tsd
, 
td©a
);

722 ià(
	`ckh_£¬ch
(&
bt2gùx
, 
bt
, &
btkey
.
v
, &
gùx
.v)) {

724 
gùx
.
p
 = 
	`´of_gùx_ü—‹
(
tsd
, 
bt
);

725 ià(
gùx
.
v
 =ğ
NULL
) {

726 
	`´of_Ëave
(
tsd
, 
td©a
);

727  (
Œue
);

729 
btkey
.
p
 = &
gùx
.p->
bt
;

730 ià(
	`ckh_š£¹
(
tsd
, &
bt2gùx
, 
btkey
.
v
, 
gùx
.v)) {

732 
	`´of_Ëave
(
tsd
, 
td©a
);

733 
	`id®loùm
(
tsd
, 
gùx
.
v
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

734  (
Œue
);

736 
Ãw_gùx
 = 
Œue
;

742 
	`m®loc_mu‹x_lock
(
gùx
.
p
->
lock
);

743 
gùx
.
p
->
Æimbo
++;

744 
	`m®loc_mu‹x_uÆock
(
gùx
.
p
->
lock
);

745 
Ãw_gùx
 = 
çl£
;

747 
	`´of_Ëave
(
tsd
, 
td©a
);

749 *
p_btkey
 = 
btkey
.
v
;

750 *
p_gùx
 = 
gùx
.
p
;

751 *
p_Ãw_gùx
 = 
Ãw_gùx
;

752  (
çl£
);

753 
	}
}

755 
´of_tùx_t
 *

756 
	$´of_lookup
(
tsd_t
 *
tsd
, 
´of_bt_t
 *
bt
)

759 
´of_tùx_t
 *
p
;

760 *
v
;

761 } 
»t
;

762 
´of_td©a_t
 *
td©a
;

763 
boŞ
 
nÙ_found
;

765 
	`ÿs£¹
(
cÚfig_´of
);

767 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
çl£
);

768 ià(
td©a
 =ğ
NULL
)

769  (
NULL
);

771 
	`m®loc_mu‹x_lock
(
td©a
->
lock
);

772 
nÙ_found
 = 
	`ckh_£¬ch
(&
td©a
->
bt2tùx
, 
bt
, 
NULL
, &
»t
.
v
);

773 ià(!
nÙ_found
)

774 
»t
.
p
->
´•¬ed
 = 
Œue
;

775 
	`m®loc_mu‹x_uÆock
(
td©a
->
lock
);

776 ià(
nÙ_found
) {

777 
tÿche_t
 *
tÿche
;

778 *
btkey
;

779 
´of_gùx_t
 *
gùx
;

780 
boŞ
 
Ãw_gùx
, 
”rÜ
;

786 ià(
	`´of_lookup_glob®
(
tsd
, 
bt
, 
td©a
, &
btkey
, &
gùx
,

787 &
Ãw_gùx
))

788  (
NULL
);

791 
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
Œue
);

792 
»t
.
v
 = 
	`ŸÎocztm
(
tsd
, (
´of_tùx_t
), 
çl£
, 
tÿche
, 
Œue
,

793 
NULL
);

794 ià(
»t
.
p
 =ğ
NULL
) {

795 ià(
Ãw_gùx
)

796 
	`´of_gùx_Œy_de¡roy
(
tsd
, 
td©a
, 
gùx
,data);

797  (
NULL
);

799 
»t
.
p
->
td©a
 =data;

800 
»t
.
p
->
thr_uid
 = 
td©a
->thr_uid;

801 
»t
.
p
->
thr_disüim
 = 
td©a
->thr_discrim;

802 
	`mem£t
(&
»t
.
p
->
úts
, 0, (
´of_út_t
));

803 
»t
.
p
->
gùx
 = gctx;

804 
»t
.
p
->
tùx_uid
 = 
td©a
->
tùx_uid_Ãxt
++;

805 
»t
.
p
->
´•¬ed
 = 
Œue
;

806 
»t
.
p
->
¡©e
 = 
´of_tùx_¡©e_š™Ÿlizšg
;

807 
	`m®loc_mu‹x_lock
(
td©a
->
lock
);

808 
”rÜ
 = 
	`ckh_š£¹
(
tsd
, &
td©a
->
bt2tùx
, 
btkey
, 
»t
.
v
);

809 
	`m®loc_mu‹x_uÆock
(
td©a
->
lock
);

810 ià(
”rÜ
) {

811 ià(
Ãw_gùx
)

812 
	`´of_gùx_Œy_de¡roy
(
tsd
, 
td©a
, 
gùx
,data);

813 
	`id®loùm
(
tsd
, 
»t
.
v
, 
tÿche
, 
Œue
);

814  (
NULL
);

816 
	`m®loc_mu‹x_lock
(
gùx
->
lock
);

817 
»t
.
p
->
¡©e
 = 
´of_tùx_¡©e_nomš®
;

818 
	`tùx_Œ“_š£¹
(&
gùx
->
tùxs
, 
»t
.
p
);

819 
gùx
->
Æimbo
--;

820 
	`m®loc_mu‹x_uÆock
(
gùx
->
lock
);

823  (
»t
.
p
);

824 
	}
}

827 
	$´of_§m¶e_th»shŞd_upd©e
(
´of_td©a_t
 *
td©a
)

842 #ifdeà
JEMALLOC_PROF


843 
ušt64_t
 
r
;

844 
u
;

846 ià(!
cÚfig_´of
)

849 ià(
lg_´of_§m¶e
 == 0) {

850 
td©a
->
by‹s_uÁ_§m¶e
 = 0;

872 
	`´ng64
(
r
, 53, 
td©a
->
´ng_¡©e
, 
	`UINT64_C
(6364136223846793005),

873 
	`UINT64_C
(1442695040888963407));

874 
u
 = ()
r
 * (1.0/9007199254740992.0L);

875 
td©a
->
by‹s_uÁ_§m¶e
 = (
ušt64_t
)(
	`log
(
u
) /

876 
	`log
(1.0 - (1.0 / ()((
ušt64_t
)1U << 
lg_´of_§m¶e
))))

877 + (
ušt64_t
)1U;

879 
	}
}

881 #ifdeà
JEMALLOC_JET


882 
´of_td©a_t
 *

883 
	$´of_td©a_couÁ_™”
(
´of_td©a_Œ“_t
 *
td©as
, 
´of_td©a_t
 *
td©a
, *
¬g
)

885 
size_t
 *
td©a_couÁ
 = (size_ˆ*)
¬g
;

887 (*
td©a_couÁ
)++;

889  (
NULL
);

890 
	}
}

892 
size_t


893 
	$´of_td©a_couÁ
()

895 
size_t
 
td©a_couÁ
 = 0;

897 
	`m®loc_mu‹x_lock
(&
td©as_mtx
);

898 
	`td©a_Œ“_™”
(&
td©as
, 
NULL
, 
´of_td©a_couÁ_™”
,

899 (*)&
td©a_couÁ
);

900 
	`m®loc_mu‹x_uÆock
(&
td©as_mtx
);

902  (
td©a_couÁ
);

903 
	}
}

906 #ifdeà
JEMALLOC_JET


907 
size_t


908 
	$´of_bt_couÁ
()

910 
size_t
 
bt_couÁ
;

911 
tsd_t
 *
tsd
;

912 
´of_td©a_t
 *
td©a
;

914 
tsd
 = 
	`tsd_ãtch
();

915 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
çl£
);

916 ià(
td©a
 =ğ
NULL
)

919 
	`m®loc_mu‹x_lock
(&
bt2gùx_mtx
);

920 
bt_couÁ
 = 
	`ckh_couÁ
(&
bt2gùx
);

921 
	`m®loc_mu‹x_uÆock
(&
bt2gùx_mtx
);

923  (
bt_couÁ
);

924 
	}
}

927 #ifdeà
JEMALLOC_JET


928 #undeà
´of_dump_İ’


929 
	#´of_dump_İ’
 
	`JEMALLOC_N
(
´of_dump_İ’_im¶
)

	)

932 
	$´of_dump_İ’
(
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
)

934 
fd
;

936 
fd
 = 
	`ü—t
(
f’ame
, 0644);

937 ià(
fd
 =ğ-1 && !
´İag©e_”r
) {

938 
	`m®loc_´štf
("<jemalloc>: creat(\"%s\"), 0644) failed\n",

939 
f’ame
);

940 ià(
İt_abÜt
)

941 
	`abÜt
();

944  (
fd
);

945 
	}
}

946 #ifdeà
JEMALLOC_JET


947 #undeà
´of_dump_İ’


948 
	#´of_dump_İ’
 
	`JEMALLOC_N
(
´of_dump_İ’
)

	)

949 
´of_dump_İ’_t
 *
	g´of_dump_İ’
 = 
JEMALLOC_N
(
´of_dump_İ’_im¶
);

952 
boŞ


953 
	$´of_dump_æush
(
boŞ
 
´İag©e_”r
)

955 
boŞ
 
»t
 = 
çl£
;

956 
ssize_t
 
”r
;

958 
	`ÿs£¹
(
cÚfig_´of
);

960 
”r
 = 
	`wr™e
(
´of_dump_fd
, 
´of_dump_buf
, 
´of_dump_buf_’d
);

961 ià(
”r
 == -1) {

962 ià(!
´İag©e_”r
) {

963 
	`m®loc_wr™e
("<jemalloc>: write() failed during heap "

965 ià(
İt_abÜt
)

966 
	`abÜt
();

968 
»t
 = 
Œue
;

970 
´of_dump_buf_’d
 = 0;

972  (
»t
);

973 
	}
}

975 
boŞ


976 
	$´of_dump_şo£
(
boŞ
 
´İag©e_”r
)

978 
boŞ
 
»t
;

980 
	`as£¹
(
´of_dump_fd
 != -1);

981 
»t
 = 
	`´of_dump_æush
(
´İag©e_”r
);

982 
	`şo£
(
´of_dump_fd
);

983 
´of_dump_fd
 = -1;

985  (
»t
);

986 
	}
}

988 
boŞ


989 
	$´of_dump_wr™e
(
boŞ
 
´İag©e_”r
, cÚ¡ *
s
)

991 
i
, 
¦’
, 
n
;

993 
	`ÿs£¹
(
cÚfig_´of
);

995 
i
 = 0;

996 
¦’
 = 
	`¡¾’
(
s
);

997 
i
 < 
¦’
) {

999 ià(
´of_dump_buf_’d
 =ğ
PROF_DUMP_BUFSIZE
)

1000 ià(
	`´of_dump_æush
(
´İag©e_”r
) &&…ropagate_err)

1001  (
Œue
);

1003 ià(
´of_dump_buf_’d
 + 
¦’
 <ğ
PROF_DUMP_BUFSIZE
) {

1005 
n
 = 
¦’
 - 
i
;

1008 
n
 = 
PROF_DUMP_BUFSIZE
 - 
´of_dump_buf_’d
;

1010 
	`memıy
(&
´of_dump_buf
[
´of_dump_buf_’d
], &
s
[
i
], 
n
);

1011 
´of_dump_buf_’d
 +ğ
n
;

1012 
i
 +ğ
n
;

1015  (
çl£
);

1016 
	}
}

1018 
	$JEMALLOC_FORMAT_PRINTF
(2, 3)

1019 
boŞ


1020 
	$´of_dump_´štf
(
boŞ
 
´İag©e_”r
, cÚ¡ *
fÜm©
, ...)

1022 
boŞ
 
»t
;

1023 
va_li¡
 
­
;

1024 
buf
[
PROF_PRINTF_BUFSIZE
];

1026 
	`va_¡¬t
(
­
, 
fÜm©
);

1027 
	`m®loc_v¢´štf
(
buf
, (buf), 
fÜm©
, 
­
);

1028 
	`va_’d
(
­
);

1029 
»t
 = 
	`´of_dump_wr™e
(
´İag©e_”r
, 
buf
);

1031  (
»t
);

1032 
	}
}

1036 
	$´of_tùx_m”ge_td©a
(
´of_tùx_t
 *
tùx
, 
´of_td©a_t
 *
td©a
)

1039 
	`m®loc_mu‹x_lock
(
tùx
->
gùx
->
lock
);

1041 
tùx
->
¡©e
) {

1042 
´of_tùx_¡©e_š™Ÿlizšg
:

1043 
	`m®loc_mu‹x_uÆock
(
tùx
->
gùx
->
lock
);

1045 
´of_tùx_¡©e_nomš®
:

1046 
tùx
->
¡©e
 = 
´of_tùx_¡©e_dumpšg
;

1047 
	`m®loc_mu‹x_uÆock
(
tùx
->
gùx
->
lock
);

1049 
	`memıy
(&
tùx
->
dump_úts
, &tùx->
úts
, (
´of_út_t
));

1051 
td©a
->
út_summed
.
curobjs
 +ğ
tùx
->
dump_úts
.curobjs;

1052 
td©a
->
út_summed
.
curby‹s
 +ğ
tùx
->
dump_úts
.curbytes;

1053 ià(
İt_´of_accum
) {

1054 
td©a
->
út_summed
.
accumobjs
 +=

1055 
tùx
->
dump_úts
.
accumobjs
;

1056 
td©a
->
út_summed
.
accumby‹s
 +=

1057 
tùx
->
dump_úts
.
accumby‹s
;

1060 
´of_tùx_¡©e_dumpšg
:

1061 
´of_tùx_¡©e_purg©Üy
:

1062 
	`nÙ_»ached
();

1064 
	}
}

1068 
	$´of_tùx_m”ge_gùx
(
´of_tùx_t
 *
tùx
, 
´of_gùx_t
 *
gùx
)

1071 
gùx
->
út_summed
.
curobjs
 +ğ
tùx
->
dump_úts
.curobjs;

1072 
gùx
->
út_summed
.
curby‹s
 +ğ
tùx
->
dump_úts
.curbytes;

1073 ià(
İt_´of_accum
) {

1074 
gùx
->
út_summed
.
accumobjs
 +ğ
tùx
->
dump_úts
.accumobjs;

1075 
gùx
->
út_summed
.
accumby‹s
 +ğ
tùx
->
dump_úts
.accumbytes;

1077 
	}
}

1080 
´of_tùx_t
 *

1081 
	$´of_tùx_m”ge_™”
(
´of_tùx_Œ“_t
 *
tùxs
, 
´of_tùx_t
 *
tùx
, *
¬g
)

1084 
tùx
->
¡©e
) {

1085 
´of_tùx_¡©e_nomš®
:

1088 
´of_tùx_¡©e_dumpšg
:

1089 
´of_tùx_¡©e_purg©Üy
:

1090 
	`´of_tùx_m”ge_gùx
(
tùx
,ùx->
gùx
);

1093 
	`nÙ_»ached
();

1096  (
NULL
);

1097 
	}
}

1100 
´of_tùx_t
 *

1101 
	$´of_tùx_dump_™”
(
´of_tùx_Œ“_t
 *
tùxs
, 
´of_tùx_t
 *
tùx
, *
¬g
)

1103 
boŞ
 
´İag©e_”r
 = *(boŞ *)
¬g
;

1105 
tùx
->
¡©e
) {

1106 
´of_tùx_¡©e_š™Ÿlizšg
:

1107 
´of_tùx_¡©e_nomš®
:

1110 
´of_tùx_¡©e_dumpšg
:

1111 
´of_tùx_¡©e_purg©Üy
:

1112 ià(
	`´of_dump_´štf
(
´İag©e_”r
,

1113 "%"
FMTu64
": %"FMTu64": %"FMTu64" [%"FMTu64": "

1114 "%"
FMTu64
"]\n", 
tùx
->
thr_uid
,ùx->
dump_úts
.
curobjs
,

1115 
tùx
->
dump_úts
.
curby‹s
,ùx->dump_úts.
accumobjs
,

1116 
tùx
->
dump_úts
.
accumby‹s
))

1117  (
tùx
);

1120 
	`nÙ_»ached
();

1122  (
NULL
);

1123 
	}
}

1126 
´of_tùx_t
 *

1127 
	$´of_tùx_fšish_™”
(
´of_tùx_Œ“_t
 *
tùxs
, 
´of_tùx_t
 *
tùx
, *
¬g
)

1129 
´of_tùx_t
 *
»t
;

1131 
tùx
->
¡©e
) {

1132 
´of_tùx_¡©e_nomš®
:

1135 
´of_tùx_¡©e_dumpšg
:

1136 
tùx
->
¡©e
 = 
´of_tùx_¡©e_nomš®
;

1138 
´of_tùx_¡©e_purg©Üy
:

1139 
»t
 = 
tùx
;

1140 
Ïb–_»tuº
;

1142 
	`nÙ_»ached
();

1145 
»t
 = 
NULL
;

1146 
Ïb–_»tuº
:

1147  (
»t
);

1148 
	}
}

1151 
	$´of_dump_gùx_´•
(
´of_gùx_t
 *
gùx
, 
´of_gùx_Œ“_t
 *
gùxs
)

1154 
	`ÿs£¹
(
cÚfig_´of
);

1156 
	`m®loc_mu‹x_lock
(
gùx
->
lock
);

1163 
gùx
->
Æimbo
++;

1164 
	`gùx_Œ“_š£¹
(
gùxs
, 
gùx
);

1166 
	`mem£t
(&
gùx
->
út_summed
, 0, (
´of_út_t
));

1168 
	`m®loc_mu‹x_uÆock
(
gùx
->
lock
);

1169 
	}
}

1171 
´of_gùx_t
 *

1172 
	$´of_gùx_m”ge_™”
(
´of_gùx_Œ“_t
 *
gùxs
, 
´of_gùx_t
 *
gùx
, *
¬g
)

1174 
size_t
 *
Ëak_ngùx
 = (size_ˆ*)
¬g
;

1176 
	`m®loc_mu‹x_lock
(
gùx
->
lock
);

1177 
	`tùx_Œ“_™”
(&
gùx
->
tùxs
, 
NULL
, 
´of_tùx_m”ge_™”
, NULL);

1178 ià(
gùx
->
út_summed
.
curobjs
 != 0)

1179 (*
Ëak_ngùx
)++;

1180 
	`m®loc_mu‹x_uÆock
(
gùx
->
lock
);

1182  (
NULL
);

1183 
	}
}

1186 
	$´of_gùx_fšish
(
tsd_t
 *
tsd
, 
´of_gùx_Œ“_t
 *
gùxs
)

1188 
´of_td©a_t
 *
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
çl£
);

1189 
´of_gùx_t
 *
gùx
;

1197 (
gùx
 = 
	`gùx_Œ“_fœ¡
(
gùxs
)è!ğ
NULL
) {

1198 
	`gùx_Œ“_»move
(
gùxs
, 
gùx
);

1199 
	`m®loc_mu‹x_lock
(
gùx
->
lock
);

1201 
´of_tùx_t
 *
Ãxt
;

1203 
Ãxt
 = 
NULL
;

1205 
´of_tùx_t
 *
to_de¡roy
 =

1206 
	`tùx_Œ“_™”
(&
gùx
->
tùxs
, 
Ãxt
,

1207 
´of_tùx_fšish_™”
, 
NULL
);

1208 ià(
to_de¡roy
 !ğ
NULL
) {

1209 
Ãxt
 = 
	`tùx_Œ“_Ãxt
(&
gùx
->
tùxs
,

1210 
to_de¡roy
);

1211 
	`tùx_Œ“_»move
(&
gùx
->
tùxs
,

1212 
to_de¡roy
);

1213 
	`id®loùm
(
tsd
, 
to_de¡roy
,

1214 
	`tÿche_g‘
(
tsd
, 
çl£
), 
Œue
);

1216 
Ãxt
 = 
NULL
;

1217 } 
Ãxt
 !ğ
NULL
);

1219 
gùx
->
Æimbo
--;

1220 ià(
	`´of_gùx_should_de¡roy
(
gùx
)) {

1221 
gùx
->
Æimbo
++;

1222 
	`m®loc_mu‹x_uÆock
(
gùx
->
lock
);

1223 
	`´of_gùx_Œy_de¡roy
(
tsd
, 
td©a
, 
gùx
,data);

1225 
	`m®loc_mu‹x_uÆock
(
gùx
->
lock
);

1227 
	}
}

1229 
´of_td©a_t
 *

1230 
	$´of_td©a_m”ge_™”
(
´of_td©a_Œ“_t
 *
td©as
, 
´of_td©a_t
 *
td©a
, *
¬g
)

1232 
´of_út_t
 *
út_®l
 = (´of_út_ˆ*)
¬g
;

1234 
	`m®loc_mu‹x_lock
(
td©a
->
lock
);

1235 ià(!
td©a
->
expœed
) {

1236 
size_t
 
bšd
;

1238 
´of_tùx_t
 *
p
;

1239 *
v
;

1240 } 
tùx
;

1242 
td©a
->
dumpšg
 = 
Œue
;

1243 
	`mem£t
(&
td©a
->
út_summed
, 0, (
´of_út_t
));

1244 
bšd
 = 0; !
	`ckh_™”
(&
td©a
->
bt2tùx
, &bšd, 
NULL
,

1245 &
tùx
.
v
);)

1246 
	`´of_tùx_m”ge_td©a
(
tùx
.
p
, 
td©a
);

1248 
út_®l
->
curobjs
 +ğ
td©a
->
út_summed
.curobjs;

1249 
út_®l
->
curby‹s
 +ğ
td©a
->
út_summed
.curbytes;

1250 ià(
İt_´of_accum
) {

1251 
út_®l
->
accumobjs
 +ğ
td©a
->
út_summed
.accumobjs;

1252 
út_®l
->
accumby‹s
 +ğ
td©a
->
út_summed
.accumbytes;

1255 
td©a
->
dumpšg
 = 
çl£
;

1256 
	`m®loc_mu‹x_uÆock
(
td©a
->
lock
);

1258  (
NULL
);

1259 
	}
}

1261 
´of_td©a_t
 *

1262 
	$´of_td©a_dump_™”
(
´of_td©a_Œ“_t
 *
td©as
, 
´of_td©a_t
 *
td©a
, *
¬g
)

1264 
boŞ
 
´İag©e_”r
 = *(boŞ *)
¬g
;

1266 ià(!
td©a
->
dumpšg
)

1267  (
NULL
);

1269 ià(
	`´of_dump_´štf
(
´İag©e_”r
,

1270 "%"
FMTu64
": %"FMTu64": %"FMTu64" [%"FMTu64": %"FMTu64"]%s%s\n",

1271 
td©a
->
thr_uid
,d©a->
út_summed
.
curobjs
,

1272 
td©a
->
út_summed
.
curby‹s
,d©a->út_summed.
accumobjs
,

1273 
td©a
->
út_summed
.
accumby‹s
,

1274 (
td©a
->
th»ad_Çme
 !ğ
NULL
) ? " " : "",

1275 (
td©a
->
th»ad_Çme
 !ğ
NULL
) ?data->thread_name : ""))

1276  (
td©a
);

1277  (
NULL
);

1278 
	}
}

1280 #ifdeà
JEMALLOC_JET


1281 #undeà
´of_dump_h—d”


1282 
	#´of_dump_h—d”
 
	`JEMALLOC_N
(
´of_dump_h—d”_im¶
)

	)

1284 
boŞ


1285 
	$´of_dump_h—d”
(
boŞ
 
´İag©e_”r
, cÚ¡ 
´of_út_t
 *
út_®l
)

1287 
boŞ
 
»t
;

1289 ià(
	`´of_dump_´štf
(
´İag©e_”r
,

1290 "h—p_v2/%"
FMTu64
"\n"

1291 "*: %"
FMTu64
": %"FMTu64" [%"FMTu64": %"FMTu64"]\n",

1292 ((
ušt64_t
)1U << 
lg_´of_§m¶e
), 
út_®l
->
curobjs
,

1293 
út_®l
->
curby‹s
, cÁ_®l->
accumobjs
, cÁ_®l->
accumby‹s
))

1294  (
Œue
);

1296 
	`m®loc_mu‹x_lock
(&
td©as_mtx
);

1297 
»t
 = (
	`td©a_Œ“_™”
(&
td©as
, 
NULL
, 
´of_td©a_dump_™”
,

1298 (*)&
´İag©e_”r
è!ğ
NULL
);

1299 
	`m®loc_mu‹x_uÆock
(&
td©as_mtx
);

1300  (
»t
);

1301 
	}
}

1302 #ifdeà
JEMALLOC_JET


1303 #undeà
´of_dump_h—d”


1304 
	#´of_dump_h—d”
 
	`JEMALLOC_N
(
´of_dump_h—d”
)

	)

1305 
´of_dump_h—d”_t
 *
	g´of_dump_h—d”
 = 
JEMALLOC_N
(
´of_dump_h—d”_im¶
);

1309 
boŞ


1310 
	$´of_dump_gùx
(
boŞ
 
´İag©e_”r
, 
´of_gùx_t
 *
gùx
, cÚ¡ 
´of_bt_t
 *
bt
,

1311 
´of_gùx_Œ“_t
 *
gùxs
)

1313 
boŞ
 
»t
;

1314 
i
;

1316 
	`ÿs£¹
(
cÚfig_´of
);

1319 ià((!
İt_´of_accum
 && 
gùx
->
út_summed
.
curobjs
 == 0) ||

1320 (
İt_´of_accum
 && 
gùx
->
út_summed
.
accumobjs
 == 0)) {

1321 
	`as£¹
(
gùx
->
út_summed
.
curobjs
 == 0);

1322 
	`as£¹
(
gùx
->
út_summed
.
curby‹s
 == 0);

1323 
	`as£¹
(
gùx
->
út_summed
.
accumobjs
 == 0);

1324 
	`as£¹
(
gùx
->
út_summed
.
accumby‹s
 == 0);

1325 
»t
 = 
çl£
;

1326 
Ïb–_»tuº
;

1329 ià(
	`´of_dump_´štf
(
´İag©e_”r
, "@")) {

1330 
»t
 = 
Œue
;

1331 
Ïb–_»tuº
;

1333 
i
 = 0; i < 
bt
->
Ën
; i++) {

1334 ià(
	`´of_dump_´štf
(
´İag©e_”r
, " %#"
FMTxPTR
,

1335 (
ušŒ_t
)
bt
->
vec
[
i
])) {

1336 
»t
 = 
Œue
;

1337 
Ïb–_»tuº
;

1341 ià(
	`´of_dump_´štf
(
´İag©e_”r
,

1343 "*: %"
FMTu64
": %"FMTu64" [%"FMTu64": %"FMTu64"]\n",

1344 
gùx
->
út_summed
.
curobjs
, gùx->út_summed.
curby‹s
,

1345 
gùx
->
út_summed
.
accumobjs
, gùx->út_summed.
accumby‹s
)) {

1346 
»t
 = 
Œue
;

1347 
Ïb–_»tuº
;

1350 ià(
	`tùx_Œ“_™”
(&
gùx
->
tùxs
, 
NULL
, 
´of_tùx_dump_™”
,

1351 (*)&
´İag©e_”r
è!ğ
NULL
) {

1352 
»t
 = 
Œue
;

1353 
Ïb–_»tuº
;

1356 
»t
 = 
çl£
;

1357 
Ïb–_»tuº
:

1358  (
»t
);

1359 
	}
}

1361 
	$JEMALLOC_FORMAT_PRINTF
(1, 2)

1363 
	$´of_İ’_m­s
(cÚ¡ *
fÜm©
, ...)

1365 
mfd
;

1366 
va_li¡
 
­
;

1367 
f’ame
[
PATH_MAX
 + 1];

1369 
	`va_¡¬t
(
­
, 
fÜm©
);

1370 
	`m®loc_v¢´štf
(
f’ame
, (f’ame), 
fÜm©
, 
­
);

1371 
	`va_’d
(
­
);

1372 
mfd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

1374  (
mfd
);

1375 
	}
}

1377 
boŞ


1378 
	$´of_dump_m­s
(
boŞ
 
´İag©e_”r
)

1380 
boŞ
 
»t
;

1381 
mfd
;

1383 
	`ÿs£¹
(
cÚfig_´of
);

1384 #ifdeà
__F»eBSD__


1385 
mfd
 = 
	`´of_İ’_m­s
("/proc/curproc/map");

1388 
pid
 = 
	`g‘pid
();

1390 
mfd
 = 
	`´of_İ’_m­s
("/´oc/%d/sk/%d/m­s", 
pid
,…id);

1391 ià(
mfd
 == -1)

1392 
mfd
 = 
	`´of_İ’_m­s
("/´oc/%d/m­s", 
pid
);

1395 ià(
mfd
 != -1) {

1396 
ssize_t
 
Ä—d
;

1398 ià(
	`´of_dump_wr™e
(
´İag©e_”r
, "\nMAPPED_LIBRARIES:\n") &&

1399 
´İag©e_”r
) {

1400 
»t
 = 
Œue
;

1401 
Ïb–_»tuº
;

1403 
Ä—d
 = 0;

1405 
´of_dump_buf_’d
 +ğ
Ä—d
;

1406 ià(
´of_dump_buf_’d
 =ğ
PROF_DUMP_BUFSIZE
) {

1408 ià(
	`´of_dump_æush
(
´İag©e_”r
) &&

1409 
´İag©e_”r
) {

1410 
»t
 = 
Œue
;

1411 
Ïb–_»tuº
;

1414 
Ä—d
 = 
	`»ad
(
mfd
, &
´of_dump_buf
[
´of_dump_buf_’d
],

1415 
PROF_DUMP_BUFSIZE
 - 
´of_dump_buf_’d
);

1416 } 
Ä—d
 > 0);

1418 
»t
 = 
Œue
;

1419 
Ïb–_»tuº
;

1422 
»t
 = 
çl£
;

1423 
Ïb–_»tuº
:

1424 ià(
mfd
 != -1)

1425 
	`şo£
(
mfd
);

1426  (
»t
);

1427 
	}
}

1430 
	$´of_Ëakcheck
(cÚ¡ 
´of_út_t
 *
út_®l
, 
size_t
 
Ëak_ngùx
,

1431 cÚ¡ *
f’ame
)

1434 ià(
út_®l
->
curby‹s
 != 0) {

1435 
	`m®loc_´štf
("<jem®loc>: L—k summ¬y: %"
FMTu64
" byte%s, %"

1436 
FMTu64
" object%s, %zu context%s\n",

1437 
út_®l
->
curby‹s
, (cnt_all->curbytes != 1) ? "s" : "",

1438 
út_®l
->
curobjs
, (cnt_all->curobjs != 1) ? "s" : "",

1439 
Ëak_ngùx
, (leak_ngctx != 1) ? "s" : "");

1440 
	`m®loc_´štf
(

1442 
f’ame
);

1444 
	}
}

1446 
´of_gùx_t
 *

1447 
	$´of_gùx_dump_™”
(
´of_gùx_Œ“_t
 *
gùxs
, 
´of_gùx_t
 *
gùx
, *
¬g
)

1449 
´of_gùx_t
 *
»t
;

1450 
boŞ
 
´İag©e_”r
 = *(boŞ *)
¬g
;

1452 
	`m®loc_mu‹x_lock
(
gùx
->
lock
);

1454 ià(
	`´of_dump_gùx
(
´İag©e_”r
, 
gùx
, &gùx->
bt
, 
gùxs
)) {

1455 
»t
 = 
gùx
;

1456 
Ïb–_»tuº
;

1459 
»t
 = 
NULL
;

1460 
Ïb–_»tuº
:

1461 
	`m®loc_mu‹x_uÆock
(
gùx
->
lock
);

1462  (
»t
);

1463 
	}
}

1465 
boŞ


1466 
	$´of_dump
(
tsd_t
 *
tsd
, 
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
, boŞ 
Ëakcheck
)

1468 
´of_td©a_t
 *
td©a
;

1469 
´of_út_t
 
út_®l
;

1470 
size_t
 
bšd
;

1472 
´of_gùx_t
 *
p
;

1473 *
v
;

1474 } 
gùx
;

1475 
size_t
 
Ëak_ngùx
;

1476 
´of_gùx_Œ“_t
 
gùxs
;

1478 
	`ÿs£¹
(
cÚfig_´of
);

1480 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

1481 ià(
td©a
 =ğ
NULL
)

1482  (
Œue
);

1484 
	`m®loc_mu‹x_lock
(&
´of_dump_mtx
);

1485 
	`´of_’‹r
(
tsd
, 
td©a
);

1491 
	`gùx_Œ“_Ãw
(&
gùxs
);

1492 
bšd
 = 0; !
	`ckh_™”
(&
bt2gùx
, &bšd, 
NULL
, &
gùx
.
v
);)

1493 
	`´of_dump_gùx_´•
(
gùx
.
p
, &
gùxs
);

1499 
	`mem£t
(&
út_®l
, 0, (
´of_út_t
));

1500 
	`m®loc_mu‹x_lock
(&
td©as_mtx
);

1501 
	`td©a_Œ“_™”
(&
td©as
, 
NULL
, 
´of_td©a_m”ge_™”
, (*)&
út_®l
);

1502 
	`m®loc_mu‹x_uÆock
(&
td©as_mtx
);

1505 
Ëak_ngùx
 = 0;

1506 
	`gùx_Œ“_™”
(&
gùxs
, 
NULL
, 
´of_gùx_m”ge_™”
, (*)&
Ëak_ngùx
);

1508 
	`´of_Ëave
(
tsd
, 
td©a
);

1511 ià((
´of_dump_fd
 = 
	`´of_dump_İ’
(
´İag©e_”r
, 
f’ame
)) == -1)

1512 
Ïb–_İ’_şo£_”rÜ
;

1515 ià(
	`´of_dump_h—d”
(
´İag©e_”r
, &
út_®l
))

1516 
Ïb–_wr™e_”rÜ
;

1519 ià(
	`gùx_Œ“_™”
(&
gùxs
, 
NULL
, 
´of_gùx_dump_™”
,

1520 (*)&
´İag©e_”r
è!ğ
NULL
)

1521 
Ïb–_wr™e_”rÜ
;

1524 ià(
	`´of_dump_m­s
(
´İag©e_”r
))

1525 
Ïb–_wr™e_”rÜ
;

1527 ià(
	`´of_dump_şo£
(
´İag©e_”r
))

1528 
Ïb–_İ’_şo£_”rÜ
;

1530 
	`´of_gùx_fšish
(
tsd
, &
gùxs
);

1531 
	`m®loc_mu‹x_uÆock
(&
´of_dump_mtx
);

1533 ià(
Ëakcheck
)

1534 
	`´of_Ëakcheck
(&
út_®l
, 
Ëak_ngùx
, 
f’ame
);

1536  (
çl£
);

1537 
Ïb–_wr™e_”rÜ
:

1538 
	`´of_dump_şo£
(
´İag©e_”r
);

1539 
Ïb–_İ’_şo£_”rÜ
:

1540 
	`´of_gùx_fšish
(
tsd
, &
gùxs
);

1541 
	`m®loc_mu‹x_uÆock
(&
´of_dump_mtx
);

1542  (
Œue
);

1543 
	}
}

1545 
	#DUMP_FILENAME_BUFSIZE
 (
PATH_MAX
 + 1)

	)

1546 
	#VSEQ_INVALID
 
	`UINT64_C
(0xffffffffffffffff)

	)

1548 
	$´of_dump_f’ame
(*
f’ame
, 
v
, 
ušt64_t
 
v£q
)

1551 
	`ÿs£¹
(
cÚfig_´of
);

1553 ià(
v£q
 !ğ
VSEQ_INVALID
) {

1555 
	`m®loc_¢´štf
(
f’ame
, 
DUMP_FILENAME_BUFSIZE
,

1556 "%s.%d.%"
FMTu64
".%c%"FMTu64".heap",

1557 
İt_´of_´efix
, ()
	`g‘pid
(), 
´of_dump_£q
, 
v
, 
v£q
);

1560 
	`m®loc_¢´štf
(
f’ame
, 
DUMP_FILENAME_BUFSIZE
,

1561 "%s.%d.%"
FMTu64
".%c.heap",

1562 
İt_´of_´efix
, ()
	`g‘pid
(), 
´of_dump_£q
, 
v
);

1564 
´of_dump_£q
++;

1565 
	}
}

1568 
	$´of_fdump
()

1570 
tsd_t
 *
tsd
;

1571 
f’ame
[
DUMP_FILENAME_BUFSIZE
];

1573 
	`ÿs£¹
(
cÚfig_´of
);

1574 
	`as£¹
(
İt_´of_fš®
);

1575 
	`as£¹
(
İt_´of_´efix
[0] != '\0');

1577 ià(!
´of_boÙed
)

1579 
tsd
 = 
	`tsd_ãtch
();

1581 
	`m®loc_mu‹x_lock
(&
´of_dump_£q_mtx
);

1582 
	`´of_dump_f’ame
(
f’ame
, 'f', 
VSEQ_INVALID
);

1583 
	`m®loc_mu‹x_uÆock
(&
´of_dump_£q_mtx
);

1584 
	`´of_dump
(
tsd
, 
çl£
, 
f’ame
, 
İt_´of_Ëak
);

1585 
	}
}

1588 
	$´of_idump
()

1590 
tsd_t
 *
tsd
;

1591 
´of_td©a_t
 *
td©a
;

1593 
	`ÿs£¹
(
cÚfig_´of
);

1595 ià(!
´of_boÙed
)

1597 
tsd
 = 
	`tsd_ãtch
();

1598 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
çl£
);

1599 ià(
td©a
 =ğ
NULL
)

1601 ià(
td©a
->
’q
) {

1602 
td©a
->
’q_idump
 = 
Œue
;

1606 ià(
İt_´of_´efix
[0] != '\0') {

1607 
f’ame
[
PATH_MAX
 + 1];

1608 
	`m®loc_mu‹x_lock
(&
´of_dump_£q_mtx
);

1609 
	`´of_dump_f’ame
(
f’ame
, 'i', 
´of_dump_i£q
);

1610 
´of_dump_i£q
++;

1611 
	`m®loc_mu‹x_uÆock
(&
´of_dump_£q_mtx
);

1612 
	`´of_dump
(
tsd
, 
çl£
, 
f’ame
, false);

1614 
	}
}

1616 
boŞ


1617 
	$´of_mdump
(cÚ¡ *
f’ame
)

1619 
tsd_t
 *
tsd
;

1620 
f’ame_buf
[
DUMP_FILENAME_BUFSIZE
];

1622 
	`ÿs£¹
(
cÚfig_´of
);

1624 ià(!
İt_´of
 || !
´of_boÙed
)

1625  (
Œue
);

1626 
tsd
 = 
	`tsd_ãtch
();

1628 ià(
f’ame
 =ğ
NULL
) {

1630 ià(
İt_´of_´efix
[0] == '\0')

1631  (
Œue
);

1632 
	`m®loc_mu‹x_lock
(&
´of_dump_£q_mtx
);

1633 
	`´of_dump_f’ame
(
f’ame_buf
, 'm', 
´of_dump_m£q
);

1634 
´of_dump_m£q
++;

1635 
	`m®loc_mu‹x_uÆock
(&
´of_dump_£q_mtx
);

1636 
f’ame
 = 
f’ame_buf
;

1638  (
	`´of_dump
(
tsd
, 
Œue
, 
f’ame
, 
çl£
));

1639 
	}
}

1642 
	$´of_gdump
()

1644 
tsd_t
 *
tsd
;

1645 
´of_td©a_t
 *
td©a
;

1647 
	`ÿs£¹
(
cÚfig_´of
);

1649 ià(!
´of_boÙed
)

1651 
tsd
 = 
	`tsd_ãtch
();

1652 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
çl£
);

1653 ià(
td©a
 =ğ
NULL
)

1655 ià(
td©a
->
’q
) {

1656 
td©a
->
’q_gdump
 = 
Œue
;

1660 ià(
İt_´of_´efix
[0] != '\0') {

1661 
f’ame
[
DUMP_FILENAME_BUFSIZE
];

1662 
	`m®loc_mu‹x_lock
(&
´of_dump_£q_mtx
);

1663 
	`´of_dump_f’ame
(
f’ame
, 'u', 
´of_dump_u£q
);

1664 
´of_dump_u£q
++;

1665 
	`m®loc_mu‹x_uÆock
(&
´of_dump_£q_mtx
);

1666 
	`´of_dump
(
tsd
, 
çl£
, 
f’ame
, false);

1668 
	}
}

1671 
	$´of_bt_hash
(cÚ¡ *
key
, 
size_t
 
r_hash
[2])

1673 
´of_bt_t
 *
bt
 = (´of_bt_ˆ*)
key
;

1675 
	`ÿs£¹
(
cÚfig_´of
);

1677 
	`hash
(
bt
->
vec
, bt->
Ën
 * (*), 0x94122f33U, 
r_hash
);

1678 
	}
}

1680 
boŞ


1681 
	$´of_bt_keycomp
(cÚ¡ *
k1
, cÚ¡ *
k2
)

1683 cÚ¡ 
´of_bt_t
 *
bt1
 = (´of_bt_ˆ*)
k1
;

1684 cÚ¡ 
´of_bt_t
 *
bt2
 = (´of_bt_ˆ*)
k2
;

1686 
	`ÿs£¹
(
cÚfig_´of
);

1688 ià(
bt1
->
Ën
 !ğ
bt2
->len)

1689  (
çl£
);

1690  (
	`memcmp
(
bt1
->
vec
, 
bt2
->vec, bt1->
Ën
 * (*)) == 0);

1691 
	}
}

1693 
JEMALLOC_INLINE_C
 
ušt64_t


1694 
	$´of_thr_uid_®loc
()

1696 
ušt64_t
 
thr_uid
;

1698 
	`m®loc_mu‹x_lock
(&
Ãxt_thr_uid_mtx
);

1699 
thr_uid
 = 
Ãxt_thr_uid
;

1700 
Ãxt_thr_uid
++;

1701 
	`m®loc_mu‹x_uÆock
(&
Ãxt_thr_uid_mtx
);

1703  (
thr_uid
);

1704 
	}
}

1706 
´of_td©a_t
 *

1707 
	$´of_td©a_š™_im¶
(
tsd_t
 *
tsd
, 
ušt64_t
 
thr_uid
, ušt64_ˆ
thr_disüim
,

1708 *
th»ad_Çme
, 
boŞ
 
aùive
)

1710 
´of_td©a_t
 *
td©a
;

1711 
tÿche_t
 *
tÿche
;

1713 
	`ÿs£¹
(
cÚfig_´of
);

1716 
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
Œue
);

1717 
td©a
 = (
´of_td©a_t
 *)
	`ŸÎocztm
(
tsd
, Õrof_td©a_t), 
çl£
,

1718 
tÿche
, 
Œue
, 
NULL
);

1719 ià(
td©a
 =ğ
NULL
)

1720  (
NULL
);

1722 
td©a
->
lock
 = 
	`´of_td©a_mu‹x_choo£
(
thr_uid
);

1723 
td©a
->
thr_uid
 =hr_uid;

1724 
td©a
->
thr_disüim
 =hr_discrim;

1725 
td©a
->
th»ad_Çme
 =hread_name;

1726 
td©a
->
©ched
 = 
Œue
;

1727 
td©a
->
expœed
 = 
çl£
;

1728 
td©a
->
tùx_uid_Ãxt
 = 0;

1730 ià(
	`ckh_Ãw
(
tsd
, &
td©a
->
bt2tùx
, 
PROF_CKH_MINITEMS
,

1731 
´of_bt_hash
, 
´of_bt_keycomp
)) {

1732 
	`id®loùm
(
tsd
, 
td©a
, 
tÿche
, 
Œue
);

1733  (
NULL
);

1736 
td©a
->
´ng_¡©e
 = (
ušt64_t
)(
ušŒ_t
)tdata;

1737 
	`´of_§m¶e_th»shŞd_upd©e
(
td©a
);

1739 
td©a
->
’q
 = 
çl£
;

1740 
td©a
->
’q_idump
 = 
çl£
;

1741 
td©a
->
’q_gdump
 = 
çl£
;

1743 
td©a
->
dumpšg
 = 
çl£
;

1744 
td©a
->
aùive
 =‡ctive;

1746 
	`m®loc_mu‹x_lock
(&
td©as_mtx
);

1747 
	`td©a_Œ“_š£¹
(&
td©as
, 
td©a
);

1748 
	`m®loc_mu‹x_uÆock
(&
td©as_mtx
);

1750  (
td©a
);

1751 
	}
}

1753 
´of_td©a_t
 *

1754 
	$´of_td©a_š™
(
tsd_t
 *
tsd
)

1757  (
	`´of_td©a_š™_im¶
(
tsd
, 
	`´of_thr_uid_®loc
(), 0, 
NULL
,

1758 
	`´of_th»ad_aùive_š™_g‘
()));

1759 
	}
}

1762 
boŞ


1763 
	$´of_td©a_should_de¡roy
(
´of_td©a_t
 *
td©a
, 
boŞ
 
ev’_if_©ched
)

1766 ià(
td©a
->
©ched
 && !
ev’_if_©ched
)

1767  (
çl£
);

1768 ià(
	`ckh_couÁ
(&
td©a
->
bt2tùx
) != 0)

1769  (
çl£
);

1770  (
Œue
);

1771 
	}
}

1775 
	$´of_td©a_de¡roy_locked
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a
,

1776 
boŞ
 
ev’_if_©ched
)

1778 
tÿche_t
 *
tÿche
;

1780 
	`as£¹
(
	`´of_td©a_should_de¡roy
(
td©a
, 
ev’_if_©ched
));

1781 
	`as£¹
(
	`tsd_´of_td©a_g‘
(
tsd
è!ğ
td©a
);

1783 
	`td©a_Œ“_»move
(&
td©as
, 
td©a
);

1785 
tÿche
 = 
	`tÿche_g‘
(
tsd
, 
çl£
);

1786 ià(
td©a
->
th»ad_Çme
 !ğ
NULL
)

1787 
	`id®loùm
(
tsd
, 
td©a
->
th»ad_Çme
, 
tÿche
, 
Œue
);

1788 
	`ckh_d–‘e
(
tsd
, &
td©a
->
bt2tùx
);

1789 
	`id®loùm
(
tsd
, 
td©a
, 
tÿche
, 
Œue
);

1790 
	}
}

1793 
	$´of_td©a_de¡roy
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a
, 
boŞ
 
ev’_if_©ched
)

1796 
	`m®loc_mu‹x_lock
(&
td©as_mtx
);

1797 
	`´of_td©a_de¡roy_locked
(
tsd
, 
td©a
, 
ev’_if_©ched
);

1798 
	`m®loc_mu‹x_uÆock
(&
td©as_mtx
);

1799 
	}
}

1802 
	$´of_td©a_d‘ach
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a
)

1804 
boŞ
 
de¡roy_td©a
;

1806 
	`m®loc_mu‹x_lock
(
td©a
->
lock
);

1807 ià(
td©a
->
©ched
) {

1808 
de¡roy_td©a
 = 
	`´of_td©a_should_de¡roy
(
td©a
, 
Œue
);

1813 ià(!
de¡roy_td©a
)

1814 
td©a
->
©ched
 = 
çl£
;

1815 
	`tsd_´of_td©a_£t
(
tsd
, 
NULL
);

1817 
de¡roy_td©a
 = 
çl£
;

1818 
	`m®loc_mu‹x_uÆock
(
td©a
->
lock
);

1819 ià(
de¡roy_td©a
)

1820 
	`´of_td©a_de¡roy
(
tsd
, 
td©a
, 
Œue
);

1821 
	}
}

1823 
´of_td©a_t
 *

1824 
	$´of_td©a_»š™
(
tsd_t
 *
tsd
, 
´of_td©a_t
 *
td©a
)

1826 
ušt64_t
 
thr_uid
 = 
td©a
->thr_uid;

1827 
ušt64_t
 
thr_disüim
 = 
td©a
->thr_discrim + 1;

1828 *
th»ad_Çme
 = (
td©a
->th»ad_Çm!ğ
NULL
) ?

1829 
	`´of_th»ad_Çme_®loc
(
tsd
, 
td©a
->
th»ad_Çme
è: 
NULL
;

1830 
boŞ
 
aùive
 = 
td©a
->active;

1832 
	`´of_td©a_d‘ach
(
tsd
, 
td©a
);

1833  (
	`´of_td©a_š™_im¶
(
tsd
, 
thr_uid
, 
thr_disüim
, 
th»ad_Çme
,

1834 
aùive
));

1835 
	}
}

1837 
boŞ


1838 
	$´of_td©a_expœe
(
´of_td©a_t
 *
td©a
)

1840 
boŞ
 
de¡roy_td©a
;

1842 
	`m®loc_mu‹x_lock
(
td©a
->
lock
);

1843 ià(!
td©a
->
expœed
) {

1844 
td©a
->
expœed
 = 
Œue
;

1845 
de¡roy_td©a
 = 
td©a
->
©ched
 ? 
çl£
 :

1846 
	`´of_td©a_should_de¡roy
(
td©a
, 
çl£
);

1848 
de¡roy_td©a
 = 
çl£
;

1849 
	`m®loc_mu‹x_uÆock
(
td©a
->
lock
);

1851  (
de¡roy_td©a
);

1852 
	}
}

1854 
´of_td©a_t
 *

1855 
	$´of_td©a_»£t_™”
(
´of_td©a_Œ“_t
 *
td©as
, 
´of_td©a_t
 *
td©a
, *
¬g
)

1858  (
	`´of_td©a_expœe
(
td©a
è?d©¨: 
NULL
);

1859 
	}
}

1862 
	$´of_»£t
(
tsd_t
 *
tsd
, 
size_t
 
lg_§m¶e
)

1864 
´of_td©a_t
 *
Ãxt
;

1866 
	`as£¹
(
lg_§m¶e
 < ((
ušt64_t
) << 3));

1868 
	`m®loc_mu‹x_lock
(&
´of_dump_mtx
);

1869 
	`m®loc_mu‹x_lock
(&
td©as_mtx
);

1871 
lg_´of_§m¶e
 = 
lg_§m¶e
;

1873 
Ãxt
 = 
NULL
;

1875 
´of_td©a_t
 *
to_de¡roy
 = 
	`td©a_Œ“_™”
(&
td©as
, 
Ãxt
,

1876 
´of_td©a_»£t_™”
, 
NULL
);

1877 ià(
to_de¡roy
 !ğ
NULL
) {

1878 
Ãxt
 = 
	`td©a_Œ“_Ãxt
(&
td©as
, 
to_de¡roy
);

1879 
	`´of_td©a_de¡roy_locked
(
tsd
, 
to_de¡roy
, 
çl£
);

1881 
Ãxt
 = 
NULL
;

1882 } 
Ãxt
 !ğ
NULL
);

1884 
	`m®loc_mu‹x_uÆock
(&
td©as_mtx
);

1885 
	`m®loc_mu‹x_uÆock
(&
´of_dump_mtx
);

1886 
	}
}

1889 
	$´of_td©a_ş—nup
(
tsd_t
 *
tsd
)

1891 
´of_td©a_t
 *
td©a
;

1893 ià(!
cÚfig_´of
)

1896 
td©a
 = 
	`tsd_´of_td©a_g‘
(
tsd
);

1897 ià(
td©a
 !ğ
NULL
)

1898 
	`´of_td©a_d‘ach
(
tsd
, 
td©a
);

1899 
	}
}

1901 
boŞ


1902 
	$´of_aùive_g‘
()

1904 
boŞ
 
´of_aùive_cu¼’t
;

1906 
	`m®loc_mu‹x_lock
(&
´of_aùive_mtx
);

1907 
´of_aùive_cu¼’t
 = 
´of_aùive
;

1908 
	`m®loc_mu‹x_uÆock
(&
´of_aùive_mtx
);

1909  (
´of_aùive_cu¼’t
);

1910 
	}
}

1912 
boŞ


1913 
	$´of_aùive_£t
(
boŞ
 
aùive
)

1915 
boŞ
 
´of_aùive_Şd
;

1917 
	`m®loc_mu‹x_lock
(&
´of_aùive_mtx
);

1918 
´of_aùive_Şd
 = 
´of_aùive
;

1919 
´of_aùive
 = 
aùive
;

1920 
	`m®loc_mu‹x_uÆock
(&
´of_aùive_mtx
);

1921  (
´of_aùive_Şd
);

1922 
	}
}

1925 
	$´of_th»ad_Çme_g‘
()

1927 
tsd_t
 *
tsd
;

1928 
´of_td©a_t
 *
td©a
;

1930 
tsd
 = 
	`tsd_ãtch
();

1931 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

1932 ià(
td©a
 =ğ
NULL
)

1934  (
td©a
->
th»ad_Çme
 !ğ
NULL
 ?data->thread_name : "");

1935 
	}
}

1938 
	$´of_th»ad_Çme_®loc
(
tsd_t
 *
tsd
, cÚ¡ *
th»ad_Çme
)

1940 *
»t
;

1941 
size_t
 
size
;

1943 ià(
th»ad_Çme
 =ğ
NULL
)

1944  (
NULL
);

1946 
size
 = 
	`¡¾’
(
th»ad_Çme
) + 1;

1947 ià(
size
 == 1)

1950 
»t
 = 
	`ŸÎocztm
(
tsd
, 
size
, 
çl£
, 
	`tÿche_g‘
Ñsd, 
Œue
),rue, 
NULL
);

1951 ià(
»t
 =ğ
NULL
)

1952  (
NULL
);

1953 
	`memıy
(
»t
, 
th»ad_Çme
, 
size
);

1954  (
»t
);

1955 
	}
}

1958 
	$´of_th»ad_Çme_£t
(
tsd_t
 *
tsd
, cÚ¡ *
th»ad_Çme
)

1960 
´of_td©a_t
 *
td©a
;

1961 
i
;

1962 *
s
;

1964 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

1965 ià(
td©a
 =ğ
NULL
)

1966  (
EAGAIN
);

1969 ià(
th»ad_Çme
 =ğ
NULL
)

1970  (
EFAULT
);

1971 
i
 = 0; 
th»ad_Çme
[i] != '\0'; i++) {

1972 
c
 = 
th»ad_Çme
[
i
];

1973 ià(!
	`isg¿ph
(
c
è&& !
	`isbÏnk
(c))

1974  (
EFAULT
);

1977 
s
 = 
	`´of_th»ad_Çme_®loc
(
tsd
, 
th»ad_Çme
);

1978 ià(
s
 =ğ
NULL
)

1979  (
EAGAIN
);

1981 ià(
td©a
->
th»ad_Çme
 !ğ
NULL
) {

1982 
	`id®loùm
(
tsd
, 
td©a
->
th»ad_Çme
, 
	`tÿche_g‘
Ñsd, 
çl£
),

1983 
Œue
);

1984 
td©a
->
th»ad_Çme
 = 
NULL
;

1986 ià(
	`¡¾’
(
s
) > 0)

1987 
td©a
->
th»ad_Çme
 = 
s
;

1989 
	}
}

1991 
boŞ


1992 
	$´of_th»ad_aùive_g‘
()

1994 
tsd_t
 *
tsd
;

1995 
´of_td©a_t
 *
td©a
;

1997 
tsd
 = 
	`tsd_ãtch
();

1998 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

1999 ià(
td©a
 =ğ
NULL
)

2000  (
çl£
);

2001  (
td©a
->
aùive
);

2002 
	}
}

2004 
boŞ


2005 
	$´of_th»ad_aùive_£t
(
boŞ
 
aùive
)

2007 
tsd_t
 *
tsd
;

2008 
´of_td©a_t
 *
td©a
;

2010 
tsd
 = 
	`tsd_ãtch
();

2011 
td©a
 = 
	`´of_td©a_g‘
(
tsd
, 
Œue
);

2012 ià(
td©a
 =ğ
NULL
)

2013  (
Œue
);

2014 
td©a
->
aùive
 =‡ctive;

2015  (
çl£
);

2016 
	}
}

2018 
boŞ


2019 
	$´of_th»ad_aùive_š™_g‘
()

2021 
boŞ
 
aùive_š™
;

2023 
	`m®loc_mu‹x_lock
(&
´of_th»ad_aùive_š™_mtx
);

2024 
aùive_š™
 = 
´of_th»ad_aùive_š™
;

2025 
	`m®loc_mu‹x_uÆock
(&
´of_th»ad_aùive_š™_mtx
);

2026  (
aùive_š™
);

2027 
	}
}

2029 
boŞ


2030 
	$´of_th»ad_aùive_š™_£t
(
boŞ
 
aùive_š™
)

2032 
boŞ
 
aùive_š™_Şd
;

2034 
	`m®loc_mu‹x_lock
(&
´of_th»ad_aùive_š™_mtx
);

2035 
aùive_š™_Şd
 = 
´of_th»ad_aùive_š™
;

2036 
´of_th»ad_aùive_š™
 = 
aùive_š™
;

2037 
	`m®loc_mu‹x_uÆock
(&
´of_th»ad_aùive_š™_mtx
);

2038  (
aùive_š™_Şd
);

2039 
	}
}

2041 
boŞ


2042 
	$´of_gdump_g‘
()

2044 
boŞ
 
´of_gdump_cu¼’t
;

2046 
	`m®loc_mu‹x_lock
(&
´of_gdump_mtx
);

2047 
´of_gdump_cu¼’t
 = 
´of_gdump_v®
;

2048 
	`m®loc_mu‹x_uÆock
(&
´of_gdump_mtx
);

2049  (
´of_gdump_cu¼’t
);

2050 
	}
}

2052 
boŞ


2053 
	$´of_gdump_£t
(
boŞ
 
gdump
)

2055 
boŞ
 
´of_gdump_Şd
;

2057 
	`m®loc_mu‹x_lock
(&
´of_gdump_mtx
);

2058 
´of_gdump_Şd
 = 
´of_gdump_v®
;

2059 
´of_gdump_v®
 = 
gdump
;

2060 
	`m®loc_mu‹x_uÆock
(&
´of_gdump_mtx
);

2061  (
´of_gdump_Şd
);

2062 
	}
}

2065 
	$´of_boÙ0
()

2068 
	`ÿs£¹
(
cÚfig_´of
);

2070 
	`memıy
(
İt_´of_´efix
, 
PROF_PREFIX_DEFAULT
,

2071 (
PROF_PREFIX_DEFAULT
));

2072 
	}
}

2075 
	$´of_boÙ1
()

2078 
	`ÿs£¹
(
cÚfig_´of
);

2085 ià(
İt_´of_Ëak
 && !
İt_´of
) {

2090 
İt_´of
 = 
Œue
;

2091 
İt_´of_gdump
 = 
çl£
;

2092 } ià(
İt_´of
) {

2093 ià(
İt_lg_´of_š‹rv®
 >= 0) {

2094 
´of_š‹rv®
 = (((
ušt64_t
)1U) <<

2095 
İt_lg_´of_š‹rv®
);

2098 
	}
}

2100 
boŞ


2101 
	$´of_boÙ2
()

2104 
	`ÿs£¹
(
cÚfig_´of
);

2106 ià(
İt_´of
) {

2107 
tsd_t
 *
tsd
;

2108 
i
;

2110 
lg_´of_§m¶e
 = 
İt_lg_´of_§m¶e
;

2112 
´of_aùive
 = 
İt_´of_aùive
;

2113 ià(
	`m®loc_mu‹x_š™
(&
´of_aùive_mtx
))

2114  (
Œue
);

2116 
´of_gdump_v®
 = 
İt_´of_gdump
;

2117 ià(
	`m®loc_mu‹x_š™
(&
´of_gdump_mtx
))

2118  (
Œue
);

2120 
´of_th»ad_aùive_š™
 = 
İt_´of_th»ad_aùive_š™
;

2121 ià(
	`m®loc_mu‹x_š™
(&
´of_th»ad_aùive_š™_mtx
))

2122  (
Œue
);

2124 
tsd
 = 
	`tsd_ãtch
();

2125 ià(
	`ckh_Ãw
(
tsd
, &
bt2gùx
, 
PROF_CKH_MINITEMS
, 
´of_bt_hash
,

2126 
´of_bt_keycomp
))

2127  (
Œue
);

2128 ià(
	`m®loc_mu‹x_š™
(&
bt2gùx_mtx
))

2129  (
Œue
);

2131 
	`td©a_Œ“_Ãw
(&
td©as
);

2132 ià(
	`m®loc_mu‹x_š™
(&
td©as_mtx
))

2133  (
Œue
);

2135 
Ãxt_thr_uid
 = 0;

2136 ià(
	`m®loc_mu‹x_š™
(&
Ãxt_thr_uid_mtx
))

2137  (
Œue
);

2139 ià(
	`m®loc_mu‹x_š™
(&
´of_dump_£q_mtx
))

2140  (
Œue
);

2141 ià(
	`m®loc_mu‹x_š™
(&
´of_dump_mtx
))

2142  (
Œue
);

2144 ià(
İt_´of_fš®
 && 
İt_´of_´efix
[0] != '\0' &&

2145 
	`©ex™
(
´of_fdump
) != 0) {

2146 
	`m®loc_wr™e
("<jemalloc>: Error in‡texit()\n");

2147 ià(
İt_abÜt
)

2148 
	`abÜt
();

2151 
gùx_locks
 = (
m®loc_mu‹x_t
 *)
	`ba£_®loc
(
PROF_NCTX_LOCKS
 *

2152 (
m®loc_mu‹x_t
));

2153 ià(
gùx_locks
 =ğ
NULL
)

2154  (
Œue
);

2155 
i
 = 0; i < 
PROF_NCTX_LOCKS
; i++) {

2156 ià(
	`m®loc_mu‹x_š™
(&
gùx_locks
[
i
]))

2157  (
Œue
);

2160 
td©a_locks
 = (
m®loc_mu‹x_t
 *)
	`ba£_®loc
(
PROF_NTDATA_LOCKS
 *

2161 (
m®loc_mu‹x_t
));

2162 ià(
td©a_locks
 =ğ
NULL
)

2163  (
Œue
);

2164 
i
 = 0; i < 
PROF_NTDATA_LOCKS
; i++) {

2165 ià(
	`m®loc_mu‹x_š™
(&
td©a_locks
[
i
]))

2166  (
Œue
);

2170 #ifdeà
JEMALLOC_PROF_LIBGCC


2175 
	`_Unwšd_BackŒaû
(
´of_unwšd_š™_ÿÎback
, 
NULL
);

2178 
´of_boÙed
 = 
Œue
;

2180  (
çl£
);

2181 
	}
}

2184 
	$´of_´efÜk
()

2187 ià(
İt_´of
) {

2188 
i
;

2190 
	`m®loc_mu‹x_´efÜk
(&
td©as_mtx
);

2191 
	`m®loc_mu‹x_´efÜk
(&
bt2gùx_mtx
);

2192 
	`m®loc_mu‹x_´efÜk
(&
Ãxt_thr_uid_mtx
);

2193 
	`m®loc_mu‹x_´efÜk
(&
´of_dump_£q_mtx
);

2194 
i
 = 0; i < 
PROF_NCTX_LOCKS
; i++)

2195 
	`m®loc_mu‹x_´efÜk
(&
gùx_locks
[
i
]);

2196 
i
 = 0; i < 
PROF_NTDATA_LOCKS
; i++)

2197 
	`m®loc_mu‹x_´efÜk
(&
td©a_locks
[
i
]);

2199 
	}
}

2202 
	$´of_po¡fÜk_·»Á
()

2205 ià(
İt_´of
) {

2206 
i
;

2208 
i
 = 0; i < 
PROF_NTDATA_LOCKS
; i++)

2209 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
td©a_locks
[
i
]);

2210 
i
 = 0; i < 
PROF_NCTX_LOCKS
; i++)

2211 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
gùx_locks
[
i
]);

2212 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
´of_dump_£q_mtx
);

2213 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
Ãxt_thr_uid_mtx
);

2214 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
bt2gùx_mtx
);

2215 
	`m®loc_mu‹x_po¡fÜk_·»Á
(&
td©as_mtx
);

2217 
	}
}

2220 
	$´of_po¡fÜk_chd
()

2223 ià(
İt_´of
) {

2224 
i
;

2226 
i
 = 0; i < 
PROF_NTDATA_LOCKS
; i++)

2227 
	`m®loc_mu‹x_po¡fÜk_chd
(&
td©a_locks
[
i
]);

2228 
i
 = 0; i < 
PROF_NCTX_LOCKS
; i++)

2229 
	`m®loc_mu‹x_po¡fÜk_chd
(&
gùx_locks
[
i
]);

2230 
	`m®loc_mu‹x_po¡fÜk_chd
(&
´of_dump_£q_mtx
);

2231 
	`m®loc_mu‹x_po¡fÜk_chd
(&
Ãxt_thr_uid_mtx
);

2232 
	`m®loc_mu‹x_po¡fÜk_chd
(&
bt2gùx_mtx
);

2233 
	`m®loc_mu‹x_po¡fÜk_chd
(&
td©as_mtx
);

2235 
	}
}

	@deps/jemalloc/src/quarantine.c

1 
	#JEMALLOC_QUARANTINE_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

8 
	#QUARANTINE_STATE_REINCARNATED
 ((
qu¬ªtše_t
 *)(
ušŒ_t
)1)

	)

9 
	#QUARANTINE_STATE_PURGATORY
 ((
qu¬ªtše_t
 *)(
ušŒ_t
)2)

	)

10 
	#QUARANTINE_STATE_MAX
 
QUARANTINE_STATE_PURGATORY


	)

15 
qu¬ªtše_t
 *
qu¬ªtše_grow
(
tsd_t
 *
tsd
, qu¬ªtše_ˆ*
qu¬ªtše
);

16 
qu¬ªtše_d¿š_Úe
(
tsd_t
 *
tsd
, 
qu¬ªtše_t
 *
qu¬ªtše
);

17 
qu¬ªtše_d¿š
(
tsd_t
 *
tsd
, 
qu¬ªtše_t
 *
qu¬ªtše
,

18 
size_t
 
uµ”_bound
);

22 
qu¬ªtše_t
 *

23 
	$qu¬ªtše_š™
(
tsd_t
 *
tsd
, 
size_t
 
lg_maxobjs
)

25 
qu¬ªtše_t
 *
qu¬ªtše
;

27 
	`as£¹
(
	`tsd_nomš®
(
tsd
));

29 
qu¬ªtše
 = (
qu¬ªtše_t
 *)
	`ŸÎocztm
(
tsd
, 
	`off£tof
(qu¬ªtše_t, 
objs
)

30 + ((
	`ZU
(1è<< 
lg_maxobjs
è* (
qu¬ªtše_obj_t
)), 
çl£
,

31 
	`tÿche_g‘
(
tsd
, 
Œue
),rue, 
NULL
);

32 ià(
qu¬ªtše
 =ğ
NULL
)

33  (
NULL
);

34 
qu¬ªtše
->
curby‹s
 = 0;

35 
qu¬ªtše
->
curobjs
 = 0;

36 
qu¬ªtše
->
fœ¡
 = 0;

37 
qu¬ªtše
->
lg_maxobjs
 =†g_maxobjs;

39  (
qu¬ªtše
);

40 
	}
}

43 
	$qu¬ªtše_®loc_hook_wÜk
(
tsd_t
 *
tsd
)

45 
qu¬ªtše_t
 *
qu¬ªtše
;

47 ià(!
	`tsd_nomš®
(
tsd
))

50 
qu¬ªtše
 = 
	`qu¬ªtše_š™
(
tsd
, 
LG_MAXOBJS_INIT
);

55 ià(
	`tsd_qu¬ªtše_g‘
(
tsd
è=ğ
NULL
)

56 
	`tsd_qu¬ªtše_£t
(
tsd
, 
qu¬ªtše
);

58 
	`id®loùm
(
tsd
, 
qu¬ªtše
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

59 
	}
}

61 
qu¬ªtše_t
 *

62 
	$qu¬ªtše_grow
(
tsd_t
 *
tsd
, 
qu¬ªtše_t
 *
qu¬ªtše
)

64 
qu¬ªtše_t
 *
»t
;

66 
»t
 = 
	`qu¬ªtše_š™
(
tsd
, 
qu¬ªtše
->
lg_maxobjs
 + 1);

67 ià(
»t
 =ğ
NULL
) {

68 
	`qu¬ªtše_d¿š_Úe
(
tsd
, 
qu¬ªtše
);

69  (
qu¬ªtše
);

72 
»t
->
curby‹s
 = 
qu¬ªtše
->curbytes;

73 
»t
->
curobjs
 = 
qu¬ªtše
->curobjs;

74 ià(
qu¬ªtše
->
fœ¡
 + qu¬ªtše->
curobjs
 <ğ(
	`ZU
(1) <<

75 
qu¬ªtše
->
lg_maxobjs
)) {

77 
	`memıy
(
»t
->
objs
, &
qu¬ªtše
->objs[qu¬ªtše->
fœ¡
],

78 
qu¬ªtše
->
curobjs
 * (
qu¬ªtše_obj_t
));

81 
size_t
 
ncİy_a
 = (
	`ZU
(1è<< 
qu¬ªtše
->
lg_maxobjs
) -

82 
qu¬ªtše
->
fœ¡
;

83 
size_t
 
ncİy_b
 = 
qu¬ªtše
->
curobjs
 - 
ncİy_a
;

85 
	`memıy
(
»t
->
objs
, &
qu¬ªtše
->objs[qu¬ªtše->
fœ¡
], 
ncİy_a


86 * (
qu¬ªtše_obj_t
));

87 
	`memıy
(&
»t
->
objs
[
ncİy_a
], 
qu¬ªtše
->objs, 
ncİy_b
 *

88 (
qu¬ªtše_obj_t
));

90 
	`id®loùm
(
tsd
, 
qu¬ªtše
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

92 
	`tsd_qu¬ªtše_£t
(
tsd
, 
»t
);

93  (
»t
);

94 
	}
}

97 
	$qu¬ªtše_d¿š_Úe
(
tsd_t
 *
tsd
, 
qu¬ªtše_t
 *
qu¬ªtše
)

99 
qu¬ªtše_obj_t
 *
obj
 = &
qu¬ªtše
->
objs
[qu¬ªtše->
fœ¡
];

100 
	`as£¹
(
obj
->
usize
 =ğ
	`i§Îoc
(obj->
±r
, 
cÚfig_´of
));

101 
	`id®loùm
(
tsd
, 
obj
->
±r
, 
NULL
, 
çl£
);

102 
qu¬ªtše
->
curby‹s
 -ğ
obj
->
usize
;

103 
qu¬ªtše
->
curobjs
--;

104 
qu¬ªtše
->
fœ¡
 = (qu¬ªtše->fœ¡ + 1è& ((
	`ZU
(1) <<

105 
qu¬ªtše
->
lg_maxobjs
) - 1);

106 
	}
}

109 
	$qu¬ªtše_d¿š
(
tsd_t
 *
tsd
, 
qu¬ªtše_t
 *
qu¬ªtše
, 
size_t
 
uµ”_bound
)

112 
qu¬ªtše
->
curby‹s
 > 
uµ”_bound
 && qu¬ªtše->
curobjs
 > 0)

113 
	`qu¬ªtše_d¿š_Úe
(
tsd
, 
qu¬ªtše
);

114 
	}
}

117 
	$qu¬ªtše
(
tsd_t
 *
tsd
, *
±r
)

119 
qu¬ªtše_t
 *
qu¬ªtše
;

120 
size_t
 
usize
 = 
	`i§Îoc
(
±r
, 
cÚfig_´of
);

122 
	`ÿs£¹
(
cÚfig_fl
);

123 
	`as£¹
(
İt_qu¬ªtše
);

125 ià((
qu¬ªtše
 = 
	`tsd_qu¬ªtše_g‘
(
tsd
)è=ğ
NULL
) {

126 
	`id®loùm
(
tsd
, 
±r
, 
NULL
, 
çl£
);

133 ià(
qu¬ªtše
->
curby‹s
 + 
usize
 > 
İt_qu¬ªtše
) {

134 
size_t
 
uµ”_bound
 = (
İt_qu¬ªtše
 >ğ
usize
) ? opt_quarantine

135 - 
usize
 : 0;

136 
	`qu¬ªtše_d¿š
(
tsd
, 
qu¬ªtše
, 
uµ”_bound
);

139 ià(
qu¬ªtše
->
curobjs
 =ğ(
	`ZU
(1è<< qu¬ªtše->
lg_maxobjs
))

140 
qu¬ªtše
 = 
	`qu¬ªtše_grow
(
tsd
, quarantine);

142 
	`as£¹
(
qu¬ªtše
->
curobjs
 < (
	`ZU
(1è<< qu¬ªtše->
lg_maxobjs
));

144 ià(
qu¬ªtše
->
curby‹s
 + 
usize
 <ğ
İt_qu¬ªtše
) {

145 
size_t
 
off£t
 = (
qu¬ªtše
->
fœ¡
 + qu¬ªtše->
curobjs
) &

146 ((
	`ZU
(1è<< 
qu¬ªtše
->
lg_maxobjs
) - 1);

147 
qu¬ªtše_obj_t
 *
obj
 = &
qu¬ªtše
->
objs
[
off£t
];

148 
obj
->
±r
 =…tr;

149 
obj
->
usize
 = usize;

150 
qu¬ªtše
->
curby‹s
 +ğ
usize
;

151 
qu¬ªtše
->
curobjs
++;

152 ià(
cÚfig_fl
 && 
	`uÆik–y
(
İt_junk_ä“
)) {

157 ià((!
cÚfig_v®gršd
 || 
	`lik–y
(!
š_v®gršd
))

158 && 
usize
 <ğ
SMALL_MAXCLASS
)

159 
	`¬’a_qu¬ªtše_junk_sm®l
(
±r
, 
usize
);

161 
	`mem£t
(
±r
, 0x5a, 
usize
);

164 
	`as£¹
(
qu¬ªtše
->
curby‹s
 == 0);

165 
	`id®loùm
(
tsd
, 
±r
, 
NULL
, 
çl£
);

167 
	}
}

170 
	$qu¬ªtše_ş—nup
(
tsd_t
 *
tsd
)

172 
qu¬ªtše_t
 *
qu¬ªtše
;

174 ià(!
cÚfig_fl
)

177 
qu¬ªtše
 = 
	`tsd_qu¬ªtše_g‘
(
tsd
);

178 ià(
qu¬ªtše
 !ğ
NULL
) {

179 
	`qu¬ªtše_d¿š
(
tsd
, 
qu¬ªtše
, 0);

180 
	`id®loùm
(
tsd
, 
qu¬ªtše
, 
	`tÿche_g‘
Ñsd, 
çl£
), 
Œue
);

181 
	`tsd_qu¬ªtše_£t
(
tsd
, 
NULL
);

183 
	}
}

	@deps/jemalloc/src/rtree.c

1 
	#JEMALLOC_RTREE_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

5 
	$hmš
(
ha
, 
hb
)

8  (
ha
 < 
hb
 ? ha : hb);

9 
	}
}

12 
boŞ


13 
	$¹»e_Ãw
(
¹»e_t
 *
¹»e
, 
b™s
, 
¹»e_node_®loc_t
 *
®loc
,

14 
¹»e_node_d®loc_t
 *
d®loc
)

16 
b™s_š_Ëaf
, 
height
, 
i
;

18 
	`as£¹
(
b™s
 > 0 && b™ <ğ((
ušŒ_t
) << 3));

20 
b™s_š_Ëaf
 = (
b™s
 % 
RTREE_BITS_PER_LEVEL
) == 0 ? RTREE_BITS_PER_LEVEL

21 : (
b™s
 % 
RTREE_BITS_PER_LEVEL
);

22 ià(
b™s
 > 
b™s_š_Ëaf
) {

23 
height
 = 1 + (
b™s
 - 
b™s_š_Ëaf
è/ 
RTREE_BITS_PER_LEVEL
;

24 ià((
height
-1è* 
RTREE_BITS_PER_LEVEL
 + 
b™s_š_Ëaf
 !ğ
b™s
)

25 
height
++;

27 
height
 = 1;

28 
	`as£¹
((
height
-1è* 
RTREE_BITS_PER_LEVEL
 + 
b™s_š_Ëaf
 =ğ
b™s
);

30 
¹»e
->
®loc
 =‡lloc;

31 
¹»e
->
d®loc
 = dalloc;

32 
¹»e
->
height
 = height;

35 
¹»e
->
Ëv–s
[0].
subŒ“
 = 
NULL
;

36 
¹»e
->
Ëv–s
[0].
b™s
 = (
height
 > 1è? 
RTREE_BITS_PER_LEVEL
 :

37 
b™s_š_Ëaf
;

38 
¹»e
->
Ëv–s
[0].
cumb™s
 =„Œ“->Ëv–s[0].
b™s
;

40 
i
 = 1; i < 
height
-1; i++) {

41 
¹»e
->
Ëv–s
[
i
].
subŒ“
 = 
NULL
;

42 
¹»e
->
Ëv–s
[
i
].
b™s
 = 
RTREE_BITS_PER_LEVEL
;

43 
¹»e
->
Ëv–s
[
i
].
cumb™s
 =„tree->levels[i-1].cumbits +

44 
RTREE_BITS_PER_LEVEL
;

47 ià(
height
 > 1) {

48 
¹»e
->
Ëv–s
[
height
-1].
subŒ“
 = 
NULL
;

49 
¹»e
->
Ëv–s
[
height
-1].
b™s
 = 
b™s_š_Ëaf
;

50 
¹»e
->
Ëv–s
[
height
-1].
cumb™s
 = 
b™s
;

54 
i
 = 0; i < 
RTREE_HEIGHT_MAX
; i++) {

55 
¹»e
->
¡¬t_Ëv–
[
i
] = 
	`hmš
(
RTREE_HEIGHT_MAX
 - 1 - i, 
height
 -

59  (
çl£
);

60 
	}
}

63 
	$¹»e_d–‘e_subŒ“
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
node
, 
Ëv–
)

66 ià(
Ëv–
 + 1 < 
¹»e
->
height
) {

67 
size_t
 
nchd»n
, 
i
;

69 
nchd»n
 = 
	`ZU
(1è<< 
¹»e
->
Ëv–s
[
Ëv–
].
b™s
;

70 
i
 = 0; i < 
nchd»n
; i++) {

71 
¹»e_node_–m_t
 *
chd
 = 
node
[
i
].child;

72 ià(
chd
 !ğ
NULL
)

73 
	`¹»e_d–‘e_subŒ“
(
¹»e
, 
chd
, 
Ëv–
 + 1);

76 
¹»e
->
	`d®loc
(
node
);

77 
	}
}

80 
	$¹»e_d–‘e
(
¹»e_t
 *
¹»e
)

82 
i
;

84 
i
 = 0; i < 
¹»e
->
height
; i++) {

85 
¹»e_node_–m_t
 *
subŒ“
 = 
¹»e
->
Ëv–s
[
i
].subtree;

86 ià(
subŒ“
 !ğ
NULL
)

87 
	`¹»e_d–‘e_subŒ“
(
¹»e
, 
subŒ“
, 
i
);

89 
	}
}

91 
¹»e_node_–m_t
 *

92 
	$¹»e_node_š™
(
¹»e_t
 *
¹»e
, 
Ëv–
, 
¹»e_node_–m_t
 **
–mp
)

94 
¹»e_node_–m_t
 *
node
;

96 ià(
	`©omic_ÿs_p
((**)
–mp
, 
NULL
, 
RTREE_NODE_INITIALIZING
)) {

102 
CPU_SPINWAIT
;

103 
node
 = 
	`©omic_»ad_p
((**)
–mp
);

104 } 
node
 =ğ
RTREE_NODE_INITIALIZING
);

106 
node
 = 
¹»e
->
	`®loc
(
	`ZU
(1è<<„Œ“->
Ëv–s
[
Ëv–
].
b™s
);

107 ià(
node
 =ğ
NULL
)

108  (
NULL
);

109 
	`©omic_wr™e_p
((**)
–mp
, 
node
);

112  (
node
);

113 
	}
}

115 
¹»e_node_–m_t
 *

116 
	$¹»e_subŒ“_»ad_h¬d
(
¹»e_t
 *
¹»e
, 
Ëv–
)

119  (
	`¹»e_node_š™
(
¹»e
, 
Ëv–
, &¹»e->
Ëv–s
[Ëv–].
subŒ“
));

120 
	}
}

122 
¹»e_node_–m_t
 *

123 
	$¹»e_chd_»ad_h¬d
(
¹»e_t
 *
¹»e
, 
¹»e_node_–m_t
 *
–m
, 
Ëv–
)

126  (
	`¹»e_node_š™
(
¹»e
, 
Ëv–
, &
–m
->
chd
));

127 
	}
}

	@deps/jemalloc/src/stats.c

1 
	#JEMALLOC_STATS_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

4 
	#CTL_GET
(
n
, 
v
, 
t
) do { \

5 
size_t
 
sz
 = (
t
); \

6 
	`xm®lùl
(
n
, 
v
, &
sz
, 
NULL
, 0); \

7 } 0)

	)

9 
	#CTL_M2_GET
(
n
, 
i
, 
v
, 
t
) do { \

10 
size_t
 
mib
[6]; \

11 
size_t
 
mibËn
 = (
mib
) / (size_t); \

12 
size_t
 
sz
 = (
t
); \

13 
	`xm®lùÊam‘omib
(
n
, 
mib
, &
mibËn
); \

14 
mib
[2] = (
i
); \

15 
	`xm®lùlbymib
(
mib
, 
mibËn
, 
v
, &
sz
, 
NULL
, 0); \

16 } 0)

	)

18 
	#CTL_M2_M4_GET
(
n
, 
i
, 
j
, 
v
, 
t
) do { \

19 
size_t
 
mib
[6]; \

20 
size_t
 
mibËn
 = (
mib
) / (size_t); \

21 
size_t
 
sz
 = (
t
); \

22 
	`xm®lùÊam‘omib
(
n
, 
mib
, &
mibËn
); \

23 
mib
[2] = (
i
); \

24 
mib
[4] = (
j
); \

25 
	`xm®lùlbymib
(
mib
, 
mibËn
, 
v
, &
sz
, 
NULL
, 0); \

26 } 0)

	)

31 
boŞ
 
	gİt_¡©s_´št
 = 
çl£
;

33 
size_t
 
	g¡©s_ÿùive
 = 0;

38 
¡©s_¬’a_bšs_´št
((*
wr™e_cb
)(*, const *),

39 *
cbİaque
, 
i
);

40 
	`¡©s_¬’a_Ìuns_´št
((*
wr™e_cb
)(*, const *),

41 *
cbİaque
, 
i
);

42 
	`¡©s_¬’a_hchunks_´št
(

43 (*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
, 
i
);

44 
	`¡©s_¬’a_´št
((*
wr™e_cb
)(*, const *),

45 *
cbİaque
, 
i
, 
boŞ
 
bšs
, boŞ 
Ïrge
, boŞ 
huge
);

50 
	$¡©s_¬’a_bšs_´št
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

51 
i
)

53 
size_t
 
·ge
;

54 
boŞ
 
cÚfig_tÿche
, 
š_g­
;

55 
nbšs
, 
j
;

57 
	`CTL_GET
("¬’as.·ge", &
·ge
, 
size_t
);

59 
	`CTL_GET
("cÚfig.tÿche", &
cÚfig_tÿche
, 
boŞ
);

60 ià(
cÚfig_tÿche
) {

61 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

67 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

72 
	`CTL_GET
("¬’as.nbšs", &
nbšs
, );

73 
j
 = 0, 
š_g­
 = 
çl£
; j < 
nbšs
; j++) {

74 
ušt64_t
 
Äuns
;

76 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.Äuns", 
i
, 
j
, &
Äuns
,

77 
ušt64_t
);

78 ià(
Äuns
 == 0)

79 
š_g­
 = 
Œue
;

81 
size_t
 
»g_size
, 
run_size
, 
cu¼egs
, 
ava»gs
, 
mli
;

82 
size_t
 
cu¼uns
;

83 
ušt32_t
 
Äegs
;

84 
ušt64_t
 
nm®loc
, 
nd®loc
, 
Äeque¡s
, 
nfls
, 
næushes
;

85 
ušt64_t
 
»runs
;

86 
ut
[6];

88 ià(
š_g­
) {

89 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

91 
š_g­
 = 
çl£
;

93 
	`CTL_M2_GET
("¬’as.bš.0.size", 
j
, &
»g_size
, 
size_t
);

94 
	`CTL_M2_GET
("¬’as.bš.0.Äegs", 
j
, &
Äegs
, 
ušt32_t
);

95 
	`CTL_M2_GET
("¬’as.bš.0.run_size", 
j
, &
run_size
,

96 
size_t
);

97 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.nm®loc", 
i
, 
j
,

98 &
nm®loc
, 
ušt64_t
);

99 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.nd®loc", 
i
, 
j
,

100 &
nd®loc
, 
ušt64_t
);

101 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.cu¼egs", 
i
, 
j
,

102 &
cu¼egs
, 
size_t
);

103 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.Äeque¡s", 
i
, 
j
,

104 &
Äeque¡s
, 
ušt64_t
);

105 ià(
cÚfig_tÿche
) {

106 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.nfls", 
i
,

107 
j
, &
nfls
, 
ušt64_t
);

108 
	`CTL_M2_M4_GET
("stats.arenas.0.bins.0.nflushes",

109 
i
, 
j
, &
næushes
, 
ušt64_t
);

111 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.Ä”uns", 
i
, 
j
,

112 &
»runs
, 
ušt64_t
);

113 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.bšs.0.cu¼uns", 
i
, 
j
,

114 &
cu¼uns
, 
size_t
);

116 
ava»gs
 = 
Äegs
 * 
cu¼uns
;

117 
mli
 = (
ava»gs
 !ğ0è? (1000 * 
cu¼egs
) /‡vailregs

119 
	`as£¹
(
mli
 <= 1000);

120 ià(
mli
 < 10) {

121 
	`m®loc_¢´štf
(
ut
, (util),

122 "0.00%zu", 
mli
);

123 } ià(
mli
 < 100) {

124 
	`m®loc_¢´štf
(
ut
, (util), "0.0%zu",

125 
mli
);

126 } ià(
mli
 < 1000) {

127 
	`m®loc_¢´štf
(
ut
, (util), "0.%zu",

128 
mli
);

130 
	`m®loc_¢´štf
(
ut
, (util), "1");

132 ià(
cÚfig_tÿche
) {

133 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

134 "%20zu %3u %12zu %12"
FMTu64


135 " %12"
FMTu64
" %12"FMTu64" %12zu"

136 " %12zu %4u %3zu %-5 %12"
FMTu64


137 " %12"
FMTu64
" %12"FMTu64" %12"FMTu64"\n",

138 
»g_size
, 
j
, 
cu¼egs
 *„eg_size, 
nm®loc
,

139 
nd®loc
, 
Äeque¡s
, 
cu¼egs
, 
cu¼uns
, 
Äegs
,

140 
run_size
 / 
·ge
, 
ut
, 
nfls
, 
næushes
,

141 
Äuns
, 
»runs
);

143 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

144 "%20zu %3u %12zu %12"
FMTu64


145 " %12"
FMTu64
" %12"FMTu64" %12zu"

146 " %12zu %4u %3zu %-5 %12"
FMTu64


147 " %12"
FMTu64
"\n",

148 
»g_size
, 
j
, 
cu¼egs
 *„eg_size, 
nm®loc
,

149 
nd®loc
, 
Äeque¡s
, 
cu¼egs
, 
cu¼uns
, 
Äegs
,

150 
run_size
 / 
·ge
, 
ut
, 
Äuns
, 
»runs
);

154 ià(
š_g­
) {

155 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

158 
	}
}

161 
	$¡©s_¬’a_Ìuns_´št
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

162 
i
)

164 
nbšs
, 
Æruns
, 
j
;

165 
boŞ
 
š_g­
;

167 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

170 
	`CTL_GET
("¬’as.nbšs", &
nbšs
, );

171 
	`CTL_GET
("¬’as.Æruns", &
Æruns
, );

172 
j
 = 0, 
š_g­
 = 
çl£
; j < 
Æruns
; j++) {

173 
ušt64_t
 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

174 
size_t
 
run_size
, 
cu¼uns
;

176 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.Ìuns.0.nm®loc", 
i
, 
j
, &
nm®loc
,

177 
ušt64_t
);

178 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.Ìuns.0.nd®loc", 
i
, 
j
, &
nd®loc
,

179 
ušt64_t
);

180 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.Ìuns.0.Äeque¡s", 
i
, 
j
,

181 &
Äeque¡s
, 
ušt64_t
);

182 ià(
Äeque¡s
 == 0)

183 
š_g­
 = 
Œue
;

185 
	`CTL_M2_GET
("¬’as.Ìun.0.size", 
j
, &
run_size
, 
size_t
);

186 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.Ìuns.0.cu¼uns", 
i
, 
j
,

187 &
cu¼uns
, 
size_t
);

188 ià(
š_g­
) {

189 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

191 
š_g­
 = 
çl£
;

193 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

194 "%20zu %3u %12zu %12"
FMTu64
" %12"FMTu64

195 " %12"
FMTu64
" %12zu\n",

196 
run_size
, 
nbšs
 + 
j
, 
cu¼uns
 *„un_size, 
nm®loc
,

197 
nd®loc
, 
Äeque¡s
, 
cu¼uns
);

200 ià(
š_g­
) {

201 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

204 
	}
}

207 
	$¡©s_¬’a_hchunks_´št
((*
wr™e_cb
)(*, const *),

208 *
cbİaque
, 
i
)

210 
nbšs
, 
Æruns
, 
nhchunks
, 
j
;

211 
boŞ
 
š_g­
;

213 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

216 
	`CTL_GET
("¬’as.nbšs", &
nbšs
, );

217 
	`CTL_GET
("¬’as.Æruns", &
Æruns
, );

218 
	`CTL_GET
("¬’as.nhchunks", &
nhchunks
, );

219 
j
 = 0, 
š_g­
 = 
çl£
; j < 
nhchunks
; j++) {

220 
ušt64_t
 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

221 
size_t
 
hchunk_size
, 
curhchunks
;

223 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.hchunks.0.nm®loc", 
i
, 
j
,

224 &
nm®loc
, 
ušt64_t
);

225 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.hchunks.0.nd®loc", 
i
, 
j
,

226 &
nd®loc
, 
ušt64_t
);

227 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.hchunks.0.Äeque¡s", 
i
, 
j
,

228 &
Äeque¡s
, 
ušt64_t
);

229 ià(
Äeque¡s
 == 0)

230 
š_g­
 = 
Œue
;

232 
	`CTL_M2_GET
("¬’as.hchunk.0.size", 
j
, &
hchunk_size
,

233 
size_t
);

234 
	`CTL_M2_M4_GET
("¡©s.¬’as.0.hchunks.0.curhchunks", 
i
,

235 
j
, &
curhchunks
, 
size_t
);

236 ià(
š_g­
) {

237 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

239 
š_g­
 = 
çl£
;

241 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

242 "%20zu %3u %12zu %12"
FMTu64
" %12"FMTu64

243 " %12"
FMTu64
" %12zu\n",

244 
hchunk_size
, 
nbšs
 + 
Æruns
 + 
j
,

245 
curhchunks
 * 
hchunk_size
, 
nm®loc
, 
nd®loc
,

246 
Äeque¡s
, 
curhchunks
);

249 ià(
š_g­
) {

250 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

253 
	}
}

256 
	$¡©s_¬’a_´št
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

257 
i
, 
boŞ
 
bšs
, boŞ 
Ïrge
, boŞ 
huge
)

259 
Áh»ads
;

260 cÚ¡ *
dss
;

261 
ssize_t
 
lg_dœty_muÉ
;

262 
size_t
 
·ge
, 
·ùive
, 
pdœty
, 
m­³d
;

263 
size_t
 
m‘ad©a_m­³d
, 
m‘ad©a_®loÿ‹d
;

264 
ušt64_t
 
Åurge
, 
nmadvi£
, 
purged
;

265 
size_t
 
sm®l_®loÿ‹d
;

266 
ušt64_t
 
sm®l_nm®loc
, 
sm®l_nd®loc
, 
sm®l_Äeque¡s
;

267 
size_t
 
Ïrge_®loÿ‹d
;

268 
ušt64_t
 
Ïrge_nm®loc
, 
Ïrge_nd®loc
, 
Ïrge_Äeque¡s
;

269 
size_t
 
huge_®loÿ‹d
;

270 
ušt64_t
 
huge_nm®loc
, 
huge_nd®loc
, 
huge_Äeque¡s
;

272 
	`CTL_GET
("¬’as.·ge", &
·ge
, 
size_t
);

274 
	`CTL_M2_GET
("¡©s.¬’as.0.Áh»ads", 
i
, &
Áh»ads
, );

275 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

276 "assigÃdh»ads: %u\n", 
Áh»ads
);

277 
	`CTL_M2_GET
("¡©s.¬’as.0.dss", 
i
, &
dss
, const *);

278 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "dss‡llocation…recedence: %s\n",

279 
dss
);

280 
	`CTL_M2_GET
("¡©s.¬’as.0.lg_dœty_muÉ", 
i
, &
lg_dœty_muÉ
, 
ssize_t
);

281 ià(
lg_dœty_muÉ
 >= 0) {

282 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

284 (1U << 
lg_dœty_muÉ
));

286 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

289 
	`CTL_M2_GET
("¡©s.¬’as.0.·ùive", 
i
, &
·ùive
, 
size_t
);

290 
	`CTL_M2_GET
("¡©s.¬’as.0.pdœty", 
i
, &
pdœty
, 
size_t
);

291 
	`CTL_M2_GET
("¡©s.¬’as.0.Åurge", 
i
, &
Åurge
, 
ušt64_t
);

292 
	`CTL_M2_GET
("¡©s.¬’as.0.nmadvi£", 
i
, &
nmadvi£
, 
ušt64_t
);

293 
	`CTL_M2_GET
("¡©s.¬’as.0.purged", 
i
, &
purged
, 
ušt64_t
);

294 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

295 "dœty…ages: %zu:%zu‡ùive:dœty, %"
FMTu64
" sweep%s, %"FMTu64

296 " madvi£%s, %"
FMTu64
"…urged\n", 
·ùive
, 
pdœty
, 
Åurge
,‚purge ==

297 1 ? "" : "s", 
nmadvi£
,‚madvi£ =ğ1 ? "" : "s", 
purged
);

299 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

302 
	`CTL_M2_GET
("¡©s.¬’as.0.sm®l.®loÿ‹d", 
i
, &
sm®l_®loÿ‹d
,

303 
size_t
);

304 
	`CTL_M2_GET
("¡©s.¬’as.0.sm®l.nm®loc", 
i
, &
sm®l_nm®loc
, 
ušt64_t
);

305 
	`CTL_M2_GET
("¡©s.¬’as.0.sm®l.nd®loc", 
i
, &
sm®l_nd®loc
, 
ušt64_t
);

306 
	`CTL_M2_GET
("¡©s.¬’as.0.sm®l.Äeque¡s", 
i
, &
sm®l_Äeque¡s
,

307 
ušt64_t
);

308 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

309 "sm®l: %12zu %12"
FMTu64
" %12"FMTu64

310 " %12"
FMTu64
"\n",

311 
sm®l_®loÿ‹d
, 
sm®l_nm®loc
, 
sm®l_nd®loc
, 
sm®l_Äeque¡s
);

312 
	`CTL_M2_GET
("¡©s.¬’as.0.Ïrge.®loÿ‹d", 
i
, &
Ïrge_®loÿ‹d
,

313 
size_t
);

314 
	`CTL_M2_GET
("¡©s.¬’as.0.Ïrge.nm®loc", 
i
, &
Ïrge_nm®loc
, 
ušt64_t
);

315 
	`CTL_M2_GET
("¡©s.¬’as.0.Ïrge.nd®loc", 
i
, &
Ïrge_nd®loc
, 
ušt64_t
);

316 
	`CTL_M2_GET
("¡©s.¬’as.0.Ïrge.Äeque¡s", 
i
, &
Ïrge_Äeque¡s
,

317 
ušt64_t
);

318 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

319 "Ïrge: %12zu %12"
FMTu64
" %12"FMTu64

320 " %12"
FMTu64
"\n",

321 
Ïrge_®loÿ‹d
, 
Ïrge_nm®loc
, 
Ïrge_nd®loc
, 
Ïrge_Äeque¡s
);

322 
	`CTL_M2_GET
("¡©s.¬’as.0.huge.®loÿ‹d", 
i
, &
huge_®loÿ‹d
, 
size_t
);

323 
	`CTL_M2_GET
("¡©s.¬’as.0.huge.nm®loc", 
i
, &
huge_nm®loc
, 
ušt64_t
);

324 
	`CTL_M2_GET
("¡©s.¬’as.0.huge.nd®loc", 
i
, &
huge_nd®loc
, 
ušt64_t
);

325 
	`CTL_M2_GET
("¡©s.¬’as.0.huge.Äeque¡s", 
i
, &
huge_Äeque¡s
,

326 
ušt64_t
);

327 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

328 "huge: %12zu %12"
FMTu64
" %12"FMTu64

329 " %12"
FMTu64
"\n",

330 
huge_®loÿ‹d
, 
huge_nm®loc
, 
huge_nd®loc
, 
huge_Äeque¡s
);

331 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

332 "tÙ®: %12zu %12"
FMTu64
" %12"FMTu64

333 " %12"
FMTu64
"\n",

334 
sm®l_®loÿ‹d
 + 
Ïrge_®loÿ‹d
 + 
huge_®loÿ‹d
,

335 
sm®l_nm®loc
 + 
Ïrge_nm®loc
 + 
huge_nm®loc
,

336 
sm®l_nd®loc
 + 
Ïrge_nd®loc
 + 
huge_nd®loc
,

337 
sm®l_Äeque¡s
 + 
Ïrge_Äeque¡s
 + 
huge_Äeque¡s
);

338 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

339 "aùive: %12zu\n", 
·ùive
 * 
·ge
);

340 
	`CTL_M2_GET
("¡©s.¬’as.0.m­³d", 
i
, &
m­³d
, 
size_t
);

341 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

342 "m­³d: %12zu\n", 
m­³d
);

343 
	`CTL_M2_GET
("¡©s.¬’as.0.m‘ad©a.m­³d", 
i
, &
m‘ad©a_m­³d
,

344 
size_t
);

345 
	`CTL_M2_GET
("¡©s.¬’as.0.m‘ad©a.®loÿ‹d", 
i
, &
m‘ad©a_®loÿ‹d
,

346 
size_t
);

347 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

349 
m‘ad©a_m­³d
, 
m‘ad©a_®loÿ‹d
);

351 ià(
bšs
)

352 
	`¡©s_¬’a_bšs_´št
(
wr™e_cb
, 
cbİaque
, 
i
);

353 ià(
Ïrge
)

354 
	`¡©s_¬’a_Ìuns_´št
(
wr™e_cb
, 
cbİaque
, 
i
);

355 ià(
huge
)

356 
	`¡©s_¬’a_hchunks_´št
(
wr™e_cb
, 
cbİaque
, 
i
);

357 
	}
}

360 
	$¡©s_´št
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

361 cÚ¡ *
İts
)

363 
”r
;

364 
ušt64_t
 
•och
;

365 
size_t
 
u64sz
;

366 
boŞ
 
g’”®
 = 
Œue
;

367 
boŞ
 
m”ged
 = 
Œue
;

368 
boŞ
 
unm”ged
 = 
Œue
;

369 
boŞ
 
bšs
 = 
Œue
;

370 
boŞ
 
Ïrge
 = 
Œue
;

371 
boŞ
 
huge
 = 
Œue
;

380 
•och
 = 1;

381 
u64sz
 = (
ušt64_t
);

382 
”r
 = 
	`je_m®lùl
("•och", &
•och
, &
u64sz
, &•och, (
ušt64_t
));

383 ià(
”r
 != 0) {

384 ià(
”r
 =ğ
EAGAIN
) {

385 
	`m®loc_wr™e
("<jemalloc>: Memory‡llocation failure in "

389 
	`m®loc_wr™e
("<jemalloc>: Failure in mallctl(\"epoch\", "

391 
	`abÜt
();

394 ià(
İts
 !ğ
NULL
) {

395 
i
;

397 
i
 = 0; 
İts
[i] != '\0'; i++) {

398 
İts
[
i
]) {

400 
g’”®
 = 
çl£
;

403 
m”ged
 = 
çl£
;

406 
unm”ged
 = 
çl£
;

409 
bšs
 = 
çl£
;

412 
Ïrge
 = 
çl£
;

415 
huge
 = 
çl£
;

422 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

424 ià(
g’”®
) {

425 cÚ¡ *
ıv
;

426 
boŞ
 
bv
;

427 
uv
;

428 
ssize_t
 
ssv
;

429 
size_t
 
sv
, 
bsz
, 
ssz
, 
sssz
, 
ısz
;

431 
bsz
 = (
boŞ
);

432 
ssz
 = (
size_t
);

433 
sssz
 = (
ssize_t
);

434 
ısz
 = (const *);

436 
	`CTL_GET
("v”siÚ", &
ıv
, const *);

437 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "V”siÚ: %s\n", 
ıv
);

438 
	`CTL_GET
("cÚfig.debug", &
bv
, 
boŞ
);

439 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "Assertions %s\n",

440 
bv
 ? "enabled" : "disabled");

442 
	#OPT_WRITE_BOOL
(
n
) \

443 ià(
	`je_m®lùl
("İt."#n, &
bv
, &
bsz
, 
NULL
, 0) == 0) { \

444 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

445 " o±."#n": %s\n", 
bv
 ? "true" : "false"); \

446 }

	)

447 
	#OPT_WRITE_BOOL_MUTABLE
(
n
, 
m
) { \

448 
boŞ
 
bv2
; \

449 ià(
	`je_m®lùl
("İt."#n, &
bv
, &
bsz
, 
NULL
, 0) == 0 && \

450 
	`je_m®lùl
(#m, &
bv2
, &
bsz
, 
NULL
, 0) == 0) { \

451 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

452 " o±."#n": % ("#m": %s)\n", 
bv
 ? "true" \

453 : "çl£", 
bv2
 ? "true" : "false"); \

455 }

	)

456 
	#OPT_WRITE_SIZE_T
(
n
) \

457 ià(
	`je_m®lùl
("İt."#n, &
sv
, &
ssz
, 
NULL
, 0) == 0) { \

458 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

459 " o±."#n": %zu\n", 
sv
); \

460 }

	)

461 
	#OPT_WRITE_SSIZE_T
(
n
) \

462 ià(
	`je_m®lùl
("İt."#n, &
ssv
, &
sssz
, 
NULL
, 0) == 0) { \

463 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

464 " o±."#n": %zd\n", 
ssv
); \

465 }

	)

466 
	#OPT_WRITE_SSIZE_T_MUTABLE
(
n
, 
m
) { \

467 
ssize_t
 
ssv2
; \

468 ià(
	`je_m®lùl
("İt."#n, &
ssv
, &
sssz
, 
NULL
, 0) == 0 && \

469 
	`je_m®lùl
(#m, &
ssv2
, &
sssz
, 
NULL
, 0) == 0) { \

470 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

472 
ssv
, 
ssv2
); \

474 }

	)

475 
	#OPT_WRITE_CHAR_P
(
n
) \

476 ià(
	`je_m®lùl
("İt."#n, &
ıv
, &
ısz
, 
NULL
, 0) == 0) { \

477 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, \

478 " o±."#n": \"%s\"\n", 
ıv
); \

479 }

	)

481 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

483 
	`OPT_WRITE_BOOL
(
abÜt
)

484 
	`OPT_WRITE_SIZE_T
(
lg_chunk
)

485 
	`OPT_WRITE_CHAR_P
(
dss
)

486 
	`OPT_WRITE_SIZE_T
(
Ç»Çs
)

487 
	`OPT_WRITE_SSIZE_T_MUTABLE
(
lg_dœty_muÉ
, 
¬’as
.lg_dirty_mult)

488 
	`OPT_WRITE_BOOL
(
¡©s_´št
)

489 
	`OPT_WRITE_CHAR_P
(
junk
)

490 
	`OPT_WRITE_SIZE_T
(
qu¬ªtše
)

491 
	`OPT_WRITE_BOOL
(
»dzÚe
)

492 
	`OPT_WRITE_BOOL
(
z”o
)

493 
	`OPT_WRITE_BOOL
(
uŒaû
)

494 
	`OPT_WRITE_BOOL
(
v®gršd
)

495 
	`OPT_WRITE_BOOL
(
xm®loc
)

496 
	`OPT_WRITE_BOOL
(
tÿche
)

497 
	`OPT_WRITE_SSIZE_T
(
lg_tÿche_max
)

498 
	`OPT_WRITE_BOOL
(
´of
)

499 
	`OPT_WRITE_CHAR_P
(
´of_´efix
)

500 
	`OPT_WRITE_BOOL_MUTABLE
(
´of_aùive
, 
´of
.
aùive
)

501 
	`OPT_WRITE_BOOL_MUTABLE
(
´of_th»ad_aùive_š™
,

502 
´of
.
th»ad_aùive_š™
)

503 
	`OPT_WRITE_SSIZE_T
(
lg_´of_§m¶e
)

504 
	`OPT_WRITE_BOOL
(
´of_accum
)

505 
	`OPT_WRITE_SSIZE_T
(
lg_´of_š‹rv®
)

506 
	`OPT_WRITE_BOOL
(
´of_gdump
)

507 
	`OPT_WRITE_BOOL
(
´of_fš®
)

508 
	`OPT_WRITE_BOOL
(
´of_Ëak
)

510 #undeà
OPT_WRITE_BOOL


511 #undeà
OPT_WRITE_BOOL_MUTABLE


512 #undeà
OPT_WRITE_SIZE_T


513 #undeà
OPT_WRITE_SSIZE_T


514 #undeà
OPT_WRITE_CHAR_P


516 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "CPUs: %u\n", 
nıus
);

518 
	`CTL_GET
("¬’as.Ç»Çs", &
uv
, );

519 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "A»Çs: %u\n", 
uv
);

521 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "Pointer size: %zu\n",

524 
	`CTL_GET
("¬’as.quªtum", &
sv
, 
size_t
);

525 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "Quantum size: %zu\n",

526 
sv
);

528 
	`CTL_GET
("¬’as.·ge", &
sv
, 
size_t
);

529 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "Pagsize: %zu\n", 
sv
);

531 
	`CTL_GET
("¬’as.lg_dœty_muÉ", &
ssv
, 
ssize_t
);

532 ià(
ssv
 >= 0) {

533 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

535 (1U << 
ssv
));

537 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

540 ià(
	`je_m®lùl
("¬’as.tÿche_max", &
sv
, &
ssz
, 
NULL
, 0) == 0) {

541 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

542 "Maximumh»ad-ÿched sizşass: %zu\n", 
sv
);

544 ià(
	`je_m®lùl
("İt.´of", &
bv
, &
bsz
, 
NULL
, 0) == 0 && bv) {

545 
	`CTL_GET
("´of.lg_§m¶e", &
sv
, 
size_t
);

546 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

547 "Av”ag´of§m¶š‹rv®: %"
FMTu64


548 " (2^%zu)\n", (((
ušt64_t
)1Uè<< 
sv
), sv);

550 
	`CTL_GET
("İt.lg_´of_š‹rv®", &
ssv
, 
ssize_t
);

551 ià(
ssv
 >= 0) {

552 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

553 "Av”ag´ofdum°š‹rv®: %"
FMTu64


555 (((
ušt64_t
)1Uè<< 
ssv
), ssv);

557 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

561 
	`CTL_GET
("İt.lg_chunk", &
sv
, 
size_t
);

562 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

563 "Chunk size: %zu (2^%zu)\n", (
	`ZU
(1è<< 
sv
), sv);

566 ià(
cÚfig_¡©s
) {

567 
size_t
 *
ÿùive
;

568 
size_t
 
®loÿ‹d
, 
aùive
, 
m‘ad©a
, 
»sid’t
, 
m­³d
;

570 
	`CTL_GET
("¡©s.ÿùive", &
ÿùive
, 
size_t
 *);

571 
	`CTL_GET
("¡©s.®loÿ‹d", &
®loÿ‹d
, 
size_t
);

572 
	`CTL_GET
("¡©s.aùive", &
aùive
, 
size_t
);

573 
	`CTL_GET
("¡©s.m‘ad©a", &
m‘ad©a
, 
size_t
);

574 
	`CTL_GET
("¡©s.»sid’t", &
»sid’t
, 
size_t
);

575 
	`CTL_GET
("¡©s.m­³d", &
m­³d
, 
size_t
);

576 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

579 
®loÿ‹d
, 
aùive
, 
m‘ad©a
, 
»sid’t
, 
m­³d
);

580 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

582 
	`©omic_»ad_z
(
ÿùive
));

584 ià(
m”ged
) {

585 
Ç»Çs
;

587 
	`CTL_GET
("¬’as.Ç»Çs", &
Ç»Çs
, );

589 
	`VARIABLE_ARRAY
(
boŞ
, 
š™Ÿlized
, 
Ç»Çs
);

590 
size_t
 
isz
;

591 
i
, 
nš™Ÿlized
;

593 
isz
 = (
boŞ
è* 
Ç»Çs
;

594 
	`xm®lùl
("¬’as.š™Ÿlized", 
š™Ÿlized
,

595 &
isz
, 
NULL
, 0);

596 
i
 = 
nš™Ÿlized
 = 0; i < 
Ç»Çs
; i++) {

597 ià(
š™Ÿlized
[
i
])

598 
nš™Ÿlized
++;

601 ià(
nš™Ÿlized
 > 1 || !
unm”ged
) {

603 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
,

605 
	`¡©s_¬’a_´št
(
wr™e_cb
, 
cbİaque
,

606 
Ç»Çs
, 
bšs
, 
Ïrge
, 
huge
);

611 ià(
unm”ged
) {

612 
Ç»Çs
;

616 
	`CTL_GET
("¬’as.Ç»Çs", &
Ç»Çs
, );

618 
	`VARIABLE_ARRAY
(
boŞ
, 
š™Ÿlized
, 
Ç»Çs
);

619 
size_t
 
isz
;

620 
i
;

622 
isz
 = (
boŞ
è* 
Ç»Çs
;

623 
	`xm®lùl
("¬’as.š™Ÿlized", 
š™Ÿlized
,

624 &
isz
, 
NULL
, 0);

626 
i
 = 0; i < 
Ç»Çs
; i++) {

627 ià(
š™Ÿlized
[
i
]) {

628 
	`m®loc_ırštf
(
wr™e_cb
,

629 
cbİaque
,

630 "\Ç»Çs[%u]:\n", 
i
);

631 
	`¡©s_¬’a_´št
(
wr™e_cb
,

632 
cbİaque
, 
i
, 
bšs
, 
Ïrge
,

633 
huge
);

639 
	`m®loc_ırštf
(
wr™e_cb
, 
cbİaque
, "--- End jemalloc statistics ---\n");

640 
	}
}

	@deps/jemalloc/src/tcache.c

1 
	#JEMALLOC_TCACHE_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
boŞ
 
	gİt_tÿche
 = 
Œue
;

8 
ssize_t
 
	gİt_lg_tÿche_max
 = 
LG_TCACHE_MAXCLASS_DEFAULT
;

10 
tÿche_bš_šfo_t
 *
	gtÿche_bš_šfo
;

11 
	g¡ack_Ãlms
;

13 
size_t
 
	gnhbšs
;

14 
size_t
 
	gtÿche_maxşass
;

16 
tÿches_t
 *
	gtÿches
;

19 
	gtÿches_·¡
;

22 
tÿches_t
 *
	gtÿches_ava
;

26 
size_t
 
	$tÿche_§Îoc
(cÚ¡ *
±r
)

29  (
	`¬’a_§Îoc
(
±r
, 
çl£
));

30 
	}
}

33 
	$tÿche_ev’t_h¬d
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
)

35 
szšd_t
 
bššd
 = 
tÿche
->
Ãxt_gc_bš
;

36 
tÿche_bš_t
 *
tbš
 = &
tÿche
->
tbšs
[
bššd
];

37 
tÿche_bš_šfo_t
 *
tbš_šfo
 = &
tÿche_bš_šfo
[
bššd
];

39 ià(
tbš
->
low_w©”
 > 0) {

43 ià(
bššd
 < 
NBINS
) {

44 
	`tÿche_bš_æush_sm®l
(
tsd
, 
tÿche
, 
tbš
, 
bššd
,

45 
tbš
->
nÿched
 -bš->
low_w©”
 + (tbin->low_water

48 
	`tÿche_bš_æush_Ïrge
(
tsd
, 
tbš
, 
bššd
,bš->
nÿched


49 - 
tbš
->
low_w©”
 + (tbš->low_w©” >> 2), 
tÿche
);

55 ià((
tbš_šfo
->
nÿched_max
 >> (
tbš
->
lg_fl_div
+1)) >= 1)

56 
tbš
->
lg_fl_div
++;

57 } ià(
tbš
->
low_w©”
 < 0) {

62 ià(
tbš
->
lg_fl_div
 > 1)

63 
tbš
->
lg_fl_div
--;

65 
tbš
->
low_w©”
 =bš->
nÿched
;

67 
tÿche
->
Ãxt_gc_bš
++;

68 ià(
tÿche
->
Ãxt_gc_bš
 =ğ
nhbšs
)

69 
tÿche
->
Ãxt_gc_bš
 = 0;

70 
tÿche
->
ev_út
 = 0;

71 
	}
}

74 
	$tÿche_®loc_sm®l_h¬d
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
, 
tÿche_t
 *
tÿche
,

75 
tÿche_bš_t
 *
tbš
, 
szšd_t
 
bššd
)

77 *
»t
;

79 
	`¬’a_tÿche_fl_sm®l
(
¬’a
, 
tbš
, 
bššd
, 
cÚfig_´of
 ?

80 
tÿche
->
´of_accumby‹s
 : 0);

81 ià(
cÚfig_´of
)

82 
tÿche
->
´of_accumby‹s
 = 0;

83 
»t
 = 
	`tÿche_®loc_—sy
(
tbš
);

85  (
»t
);

86 
	}
}

89 
	$tÿche_bš_æush_sm®l
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
, 
tÿche_bš_t
 *
tbš
,

90 
szšd_t
 
bššd
, 
»m
)

92 
¬’a_t
 *
¬’a
;

93 *
±r
;

94 
i
, 
næush
, 
ndeã¼ed
;

95 
boŞ
 
m”ged_¡©s
 = 
çl£
;

97 
	`as£¹
(
bššd
 < 
NBINS
);

98 
	`as£¹
(
»m
 <ğ
tbš
->
nÿched
);

100 
¬’a
 = 
	`¬’a_choo£
(
tsd
, 
NULL
);

101 
	`as£¹
(
¬’a
 !ğ
NULL
);

102 
næush
 = 
tbš
->
nÿched
 - 
»m
;‚æush > 0;‚æush = 
ndeã¼ed
) {

104 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(

105 
tbš
->
ava
[0]);

106 
¬’a_t
 *
bš_¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
);

107 
¬’a_bš_t
 *
bš
 = &
bš_¬’a
->
bšs
[
bššd
];

109 ià(
cÚfig_´of
 && 
bš_¬’a
 =ğ
¬’a
) {

110 ià(
	`¬’a_´of_accum
(
¬’a
, 
tÿche
->
´of_accumby‹s
))

111 
	`´of_idump
();

112 
tÿche
->
´of_accumby‹s
 = 0;

115 
	`m®loc_mu‹x_lock
(&
bš
->
lock
);

116 ià(
cÚfig_¡©s
 && 
bš_¬’a
 =ğ
¬’a
) {

117 
	`as£¹
(!
m”ged_¡©s
);

118 
m”ged_¡©s
 = 
Œue
;

119 
bš
->
¡©s
.
næushes
++;

120 
bš
->
¡©s
.
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

121 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

123 
ndeã¼ed
 = 0;

124 
i
 = 0; i < 
næush
; i++) {

125 
±r
 = 
tbš
->
ava
[
i
];

126 
	`as£¹
(
±r
 !ğ
NULL
);

127 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

128 ià(
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
è=ğ
bš_¬’a
) {

129 
size_t
 
·gešd
 = ((
ušŒ_t
)
±r
 -

130 (
ušŒ_t
)
chunk
è>> 
LG_PAGE
;

131 
¬’a_chunk_m­_b™s_t
 *
b™£lm
 =

132 
	`¬’a_b™£lm_g‘
(
chunk
, 
·gešd
);

133 
	`¬’a_d®loc_bš_junked_locked
(
bš_¬’a
, 
chunk
,

134 
±r
, 
b™£lm
);

142 
tbš
->
ava
[
ndeã¼ed
] = 
±r
;

143 
ndeã¼ed
++;

146 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

148 ià(
cÚfig_¡©s
 && !
m”ged_¡©s
) {

153 
¬’a_bš_t
 *
bš
 = &
¬’a
->
bšs
[
bššd
];

154 
	`m®loc_mu‹x_lock
(&
bš
->
lock
);

155 
bš
->
¡©s
.
næushes
++;

156 
bš
->
¡©s
.
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

157 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

158 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

161 
	`memmove
(
tbš
->
ava
, &tbš->ava[tbš->
nÿched
 - 
»m
],

162 
»m
 * (*));

163 
tbš
->
nÿched
 = 
»m
;

164 ià(()
tbš
->
nÿched
 <bš->
low_w©”
)

165 
tbš
->
low_w©”
 =bš->
nÿched
;

166 
	}
}

169 
	$tÿche_bš_æush_Ïrge
(
tsd_t
 *
tsd
, 
tÿche_bš_t
 *
tbš
, 
szšd_t
 
bššd
,

170 
»m
, 
tÿche_t
 *
tÿche
)

172 
¬’a_t
 *
¬’a
;

173 *
±r
;

174 
i
, 
næush
, 
ndeã¼ed
;

175 
boŞ
 
m”ged_¡©s
 = 
çl£
;

177 
	`as£¹
(
bššd
 < 
nhbšs
);

178 
	`as£¹
(
»m
 <ğ
tbš
->
nÿched
);

180 
¬’a
 = 
	`¬’a_choo£
(
tsd
, 
NULL
);

181 
	`as£¹
(
¬’a
 !ğ
NULL
);

182 
næush
 = 
tbš
->
nÿched
 - 
»m
;‚æush > 0;‚æush = 
ndeã¼ed
) {

184 
¬’a_chunk_t
 *
chunk
 = (¬’a_chunk_ˆ*)
	`CHUNK_ADDR2BASE
(

185 
tbš
->
ava
[0]);

186 
¬’a_t
 *
locked_¬’a
 = 
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
);

187 
UNUSED
 
boŞ
 
idump
;

189 ià(
cÚfig_´of
)

190 
idump
 = 
çl£
;

191 
	`m®loc_mu‹x_lock
(&
locked_¬’a
->
lock
);

192 ià((
cÚfig_´of
 || 
cÚfig_¡©s
è&& 
locked_¬’a
 =ğ
¬’a
) {

193 ià(
cÚfig_´of
) {

194 
idump
 = 
	`¬’a_´of_accum_locked
(
¬’a
,

195 
tÿche
->
´of_accumby‹s
);

196 
tÿche
->
´of_accumby‹s
 = 0;

198 ià(
cÚfig_¡©s
) {

199 
m”ged_¡©s
 = 
Œue
;

200 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
 +=

201 
tbš
->
t¡©s
.
Äeque¡s
;

202 
¬’a
->
¡©s
.
l¡©s
[
bššd
 - 
NBINS
].
Äeque¡s
 +=

203 
tbš
->
t¡©s
.
Äeque¡s
;

204 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

207 
ndeã¼ed
 = 0;

208 
i
 = 0; i < 
næush
; i++) {

209 
±r
 = 
tbš
->
ava
[
i
];

210 
	`as£¹
(
±r
 !ğ
NULL
);

211 
chunk
 = (
¬’a_chunk_t
 *)
	`CHUNK_ADDR2BASE
(
±r
);

212 ià(
	`ex‹Á_node_¬’a_g‘
(&
chunk
->
node
) ==

213 
locked_¬’a
) {

214 
	`¬’a_d®loc_Ïrge_junked_locked
(
locked_¬’a
,

215 
chunk
, 
±r
);

223 
tbš
->
ava
[
ndeã¼ed
] = 
±r
;

224 
ndeã¼ed
++;

227 
	`m®loc_mu‹x_uÆock
(&
locked_¬’a
->
lock
);

228 ià(
cÚfig_´of
 && 
idump
)

229 
	`´of_idump
();

231 ià(
cÚfig_¡©s
 && !
m”ged_¡©s
) {

236 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

237 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
 +ğ
tbš
->
t¡©s
.
Äeque¡s
;

238 
¬’a
->
¡©s
.
l¡©s
[
bššd
 - 
NBINS
].
Äeque¡s
 +=

239 
tbš
->
t¡©s
.
Äeque¡s
;

240 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

241 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

244 
	`memmove
(
tbš
->
ava
, &tbš->ava[tbš->
nÿched
 - 
»m
],

245 
»m
 * (*));

246 
tbš
->
nÿched
 = 
»m
;

247 ià(()
tbš
->
nÿched
 <bš->
low_w©”
)

248 
tbš
->
low_w©”
 =bš->
nÿched
;

249 
	}
}

252 
	$tÿche_¬’a_assocŸ‹
(
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

255 ià(
cÚfig_¡©s
) {

257 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

258 
	`ql_–m_Ãw
(
tÿche
, 
lšk
);

259 
	`ql__š£¹
(&
¬’a
->
tÿche_ql
, 
tÿche
, 
lšk
);

260 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

262 
	}
}

265 
	$tÿche_¬’a_»assocŸ‹
(
tÿche_t
 *
tÿche
, 
¬’a_t
 *
Şd¬’a
,‡»Ç_ˆ*
Ãw¬’a
)

268 
	`tÿche_¬’a_dissocŸ‹
(
tÿche
, 
Şd¬’a
);

269 
	`tÿche_¬’a_assocŸ‹
(
tÿche
, 
Ãw¬’a
);

270 
	}
}

273 
	$tÿche_¬’a_dissocŸ‹
(
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

276 ià(
cÚfig_¡©s
) {

278 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

279 ià(
cÚfig_debug
) {

280 
boŞ
 
š_ql
 = 
çl£
;

281 
tÿche_t
 *
™”
;

282 
	`ql_fÜ—ch
(
™”
, &
¬’a
->
tÿche_ql
, 
lšk
) {

283 ià(
™”
 =ğ
tÿche
) {

284 
š_ql
 = 
Œue
;

288 
	`as£¹
(
š_ql
);

290 
	`ql_»move
(&
¬’a
->
tÿche_ql
, 
tÿche
, 
lšk
);

291 
	`tÿche_¡©s_m”ge
(
tÿche
, 
¬’a
);

292 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

294 
	}
}

296 
tÿche_t
 *

297 
	$tÿche_g‘_h¬d
(
tsd_t
 *
tsd
)

299 
¬’a_t
 *
¬’a
;

301 ià(!
	`tÿche_’abËd_g‘
()) {

302 ià(
	`tsd_nomš®
(
tsd
))

303 
	`tÿche_’abËd_£t
(
çl£
);

304  (
NULL
);

306 
¬’a
 = 
	`¬’a_choo£
(
tsd
, 
NULL
);

307 ià(
	`uÆik–y
(
¬’a
 =ğ
NULL
))

308  (
NULL
);

309  (
	`tÿche_ü—‹
(
tsd
, 
¬’a
));

310 
	}
}

312 
tÿche_t
 *

313 
	$tÿche_ü—‹
(
tsd_t
 *
tsd
, 
¬’a_t
 *
¬’a
)

315 
tÿche_t
 *
tÿche
;

316 
size_t
 
size
, 
¡ack_off£t
;

317 
i
;

319 
size
 = 
	`off£tof
(
tÿche_t
, 
tbšs
è+ ((
tÿche_bš_t
è* 
nhbšs
);

321 
size
 = 
	`PTR_CEILING
(size);

322 
¡ack_off£t
 = 
size
;

323 
size
 +ğ
¡ack_Ãlms
 * (*);

325 
size
 = 
	`§2u
(size, 
CACHELINE
);

327 
tÿche
 = 
	`®locztm
(
tsd
, 
size
, 
CACHELINE
, 
Œue
, 
çl£
,rue, 
	`a0g‘
());

328 ià(
tÿche
 =ğ
NULL
)

329  (
NULL
);

331 
	`tÿche_¬’a_assocŸ‹
(
tÿche
, 
¬’a
);

333 
	`as£¹
((
TCACHE_NSLOTS_SMALL_MAX
 & 1U) == 0);

334 
i
 = 0; i < 
nhbšs
; i++) {

335 
tÿche
->
tbšs
[
i
].
lg_fl_div
 = 1;

336 
tÿche
->
tbšs
[
i
].
ava
 = (**)((
ušŒ_t
)tcache +

337 (
ušŒ_t
)
¡ack_off£t
);

338 
¡ack_off£t
 +ğ
tÿche_bš_šfo
[
i
].
nÿched_max
 * (*);

341  (
tÿche
);

342 
	}
}

345 
	$tÿche_de¡roy
(
tsd_t
 *
tsd
, 
tÿche_t
 *
tÿche
)

347 
¬’a_t
 *
¬’a
;

348 
i
;

350 
¬’a
 = 
	`¬’a_choo£
(
tsd
, 
NULL
);

351 
	`tÿche_¬’a_dissocŸ‹
(
tÿche
, 
¬’a
);

353 
i
 = 0; i < 
NBINS
; i++) {

354 
tÿche_bš_t
 *
tbš
 = &
tÿche
->
tbšs
[
i
];

355 
	`tÿche_bš_æush_sm®l
(
tsd
, 
tÿche
, 
tbš
, 
i
, 0);

357 ià(
cÚfig_¡©s
 && 
tbš
->
t¡©s
.
Äeque¡s
 != 0) {

358 
¬’a_bš_t
 *
bš
 = &
¬’a
->
bšs
[
i
];

359 
	`m®loc_mu‹x_lock
(&
bš
->
lock
);

360 
bš
->
¡©s
.
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

361 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

365 ; 
i
 < 
nhbšs
; i++) {

366 
tÿche_bš_t
 *
tbš
 = &
tÿche
->
tbšs
[
i
];

367 
	`tÿche_bš_æush_Ïrge
(
tsd
, 
tbš
, 
i
, 0, 
tÿche
);

369 ià(
cÚfig_¡©s
 && 
tbš
->
t¡©s
.
Äeque¡s
 != 0) {

370 
	`m®loc_mu‹x_lock
(&
¬’a
->
lock
);

371 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
 +ğ
tbš
->
t¡©s
.
Äeque¡s
;

372 
¬’a
->
¡©s
.
l¡©s
[
i
 - 
NBINS
].
Äeque¡s
 +=

373 
tbš
->
t¡©s
.
Äeque¡s
;

374 
	`m®loc_mu‹x_uÆock
(&
¬’a
->
lock
);

378 ià(
cÚfig_´of
 && 
tÿche
->
´of_accumby‹s
 > 0 &&

379 
	`¬’a_´of_accum
(
¬’a
, 
tÿche
->
´of_accumby‹s
))

380 
	`´of_idump
();

382 
	`id®loùm
(
tsd
, 
tÿche
, 
çl£
, 
Œue
);

383 
	}
}

386 
	$tÿche_ş—nup
(
tsd_t
 *
tsd
)

388 
tÿche_t
 *
tÿche
;

390 ià(!
cÚfig_tÿche
)

393 ià((
tÿche
 = 
	`tsd_tÿche_g‘
(
tsd
)è!ğ
NULL
) {

394 
	`tÿche_de¡roy
(
tsd
, 
tÿche
);

395 
	`tsd_tÿche_£t
(
tsd
, 
NULL
);

397 
	}
}

400 
	$tÿche_’abËd_ş—nup
(
tsd_t
 *
tsd
)

404 
	}
}

408 
	$tÿche_¡©s_m”ge
(
tÿche_t
 *
tÿche
, 
¬’a_t
 *
¬’a
)

410 
i
;

412 
	`ÿs£¹
(
cÚfig_¡©s
);

415 
i
 = 0; i < 
NBINS
; i++) {

416 
¬’a_bš_t
 *
bš
 = &
¬’a
->
bšs
[
i
];

417 
tÿche_bš_t
 *
tbš
 = &
tÿche
->
tbšs
[
i
];

418 
	`m®loc_mu‹x_lock
(&
bš
->
lock
);

419 
bš
->
¡©s
.
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

420 
	`m®loc_mu‹x_uÆock
(&
bš
->
lock
);

421 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

424 ; 
i
 < 
nhbšs
; i++) {

425 
m®loc_Ïrge_¡©s_t
 *
l¡©s
 = &
¬’a
->
¡©s
.l¡©s[
i
 - 
NBINS
];

426 
tÿche_bš_t
 *
tbš
 = &
tÿche
->
tbšs
[
i
];

427 
¬’a
->
¡©s
.
Äeque¡s_Ïrge
 +ğ
tbš
->
t¡©s
.
Äeque¡s
;

428 
l¡©s
->
Äeque¡s
 +ğ
tbš
->
t¡©s
.nrequests;

429 
tbš
->
t¡©s
.
Äeque¡s
 = 0;

431 
	}
}

433 
boŞ


434 
	$tÿches_ü—‹
(
tsd_t
 *
tsd
, *
r_šd
)

436 
tÿche_t
 *
tÿche
;

437 
tÿches_t
 *
–m
;

439 ià(
tÿches
 =ğ
NULL
) {

440 
tÿches
 = 
	`ba£_®loc
((
tÿche_t
 *) *

441 (
MALLOCX_TCACHE_MAX
+1));

442 ià(
tÿches
 =ğ
NULL
)

443  (
Œue
);

446 ià(
tÿches_ava
 =ğ
NULL
 && 
tÿches_·¡
 > 
MALLOCX_TCACHE_MAX
)

447  (
Œue
);

448 
tÿche
 = 
	`tÿche_ü—‹
(
tsd
, 
	`a0g‘
());

449 ià(
tÿche
 =ğ
NULL
)

450  (
Œue
);

452 ià(
tÿches_ava
 !ğ
NULL
) {

453 
–m
 = 
tÿches_ava
;

454 
tÿches_ava
 =ÿches_ava->
Ãxt
;

455 
–m
->
tÿche
 =cache;

456 *
r_šd
 = 
–m
 - 
tÿches
;

458 
–m
 = &
tÿches
[
tÿches_·¡
];

459 
–m
->
tÿche
 =cache;

460 *
r_šd
 = 
tÿches_·¡
;

461 
tÿches_·¡
++;

464  (
çl£
);

465 
	}
}

468 
	$tÿches_–m_æush
(
tsd_t
 *
tsd
, 
tÿches_t
 *
–m
)

471 ià(
–m
->
tÿche
 =ğ
NULL
)

473 
	`tÿche_de¡roy
(
tsd
, 
–m
->
tÿche
);

474 
–m
->
tÿche
 = 
NULL
;

475 
	}
}

478 
	$tÿches_æush
(
tsd_t
 *
tsd
, 
šd
)

481 
	`tÿches_–m_æush
(
tsd
, &
tÿches
[
šd
]);

482 
	}
}

485 
	$tÿches_de¡roy
(
tsd_t
 *
tsd
, 
šd
)

487 
tÿches_t
 *
–m
 = &
tÿches
[
šd
];

488 
	`tÿches_–m_æush
(
tsd
, 
–m
);

489 
–m
->
Ãxt
 = 
tÿches_ava
;

490 
tÿches_ava
 = 
–m
;

491 
	}
}

493 
boŞ


494 
	$tÿche_boÙ
()

496 
i
;

502 ià(
İt_lg_tÿche_max
 < 0 || (1U << o±_lg_tÿche_maxè< 
SMALL_MAXCLASS
)

503 
tÿche_maxşass
 = 
SMALL_MAXCLASS
;

504 ià((1U << 
İt_lg_tÿche_max
è> 
Ïrge_maxşass
)

505 
tÿche_maxşass
 = 
Ïrge_maxşass
;

507 
tÿche_maxşass
 = (1U << 
İt_lg_tÿche_max
);

509 
nhbšs
 = 
	`size2šdex
(
tÿche_maxşass
) + 1;

512 
tÿche_bš_šfo
 = (
tÿche_bš_šfo_t
 *)
	`ba£_®loc
(
nhbšs
 *

513 (
tÿche_bš_šfo_t
));

514 ià(
tÿche_bš_šfo
 =ğ
NULL
)

515  (
Œue
);

516 
¡ack_Ãlms
 = 0;

517 
i
 = 0; i < 
NBINS
; i++) {

518 ià((
¬’a_bš_šfo
[
i
].
Äegs
 << 1è<ğ
TCACHE_NSLOTS_SMALL_MIN
) {

519 
tÿche_bš_šfo
[
i
].
nÿched_max
 =

520 
TCACHE_NSLOTS_SMALL_MIN
;

521 } ià((
¬’a_bš_šfo
[
i
].
Äegs
 << 1) <=

522 
TCACHE_NSLOTS_SMALL_MAX
) {

523 
tÿche_bš_šfo
[
i
].
nÿched_max
 =

524 (
¬’a_bš_šfo
[
i
].
Äegs
 << 1);

526 
tÿche_bš_šfo
[
i
].
nÿched_max
 =

527 
TCACHE_NSLOTS_SMALL_MAX
;

529 
¡ack_Ãlms
 +ğ
tÿche_bš_šfo
[
i
].
nÿched_max
;

531 ; 
i
 < 
nhbšs
; i++) {

532 
tÿche_bš_šfo
[
i
].
nÿched_max
 = 
TCACHE_NSLOTS_LARGE
;

533 
¡ack_Ãlms
 +ğ
tÿche_bš_šfo
[
i
].
nÿched_max
;

536  (
çl£
);

537 
	}
}

	@deps/jemalloc/src/tsd.c

1 
	#JEMALLOC_TSD_C_


	)

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

7 
	gnş—nups
;

8 
m®loc_tsd_ş—nup_t
 
	gş—nups
[
MALLOC_TSD_CLEANUPS_MAX
];

10 
	$m®loc_tsd_d©a
(, , 
tsd_t
, 
TSD_INITIALIZER
)

15 
	$m®loc_tsd_m®loc
(
size_t
 
size
)

18  (
	`a0m®loc
(
	`CACHELINE_CEILING
(
size
)));

19 
	}
}

22 
	$m®loc_tsd_d®loc
(*
w¿µ”
)

25 
	`a0d®loc
(
w¿µ”
);

26 
	}
}

29 
	$m®loc_tsd_no_ş—nup
(*
¬g
)

32 
	`nÙ_»ached
();

33 
	}
}

35 #ià
defšed
(
JEMALLOC_MALLOC_THREAD_CLEANUP
è|| defšed(
_WIN32
)

36 #iâdeà
_WIN32


37 
	gJEMALLOC_EXPORT


40 
	$_m®loc_th»ad_ş—nup
()

42 
boŞ
 
³ndšg
[
MALLOC_TSD_CLEANUPS_MAX
], 
agaš
;

43 
i
;

45 
i
 = 0; i < 
nş—nups
; i++)

46 
³ndšg
[
i
] = 
Œue
;

49 
agaš
 = 
çl£
;

50 
i
 = 0; i < 
nş—nups
; i++) {

51 ià(
³ndšg
[
i
]) {

52 
³ndšg
[
i
] = 
ş—nups
[i]();

53 ià(
³ndšg
[
i
])

54 
agaš
 = 
Œue
;

57 } 
agaš
);

58 
	}
}

62 
	$m®loc_tsd_ş—nup_»gi¡”
(
	$boŞ
 (*
f
)())

65 
	`as£¹
(
nş—nups
 < 
MALLOC_TSD_CLEANUPS_MAX
);

66 
ş—nups
[
nş—nups
] = 
f
;

67 
nş—nups
++;

68 
	}
}

71 
	$tsd_ş—nup
(*
¬g
)

73 
tsd_t
 *
tsd
 = (tsd_ˆ*)
¬g
;

75 
tsd
->
¡©e
) {

76 
tsd_¡©e_unš™Ÿlized
:

79 
tsd_¡©e_nomš®
:

80 
	#O
(
n
, 
t
) \

81 
n
##
	`_ş—nup
(
tsd
);

	)

82 
MALLOC_TSD


83 #undeà
O


84 
tsd
->
¡©e
 = 
tsd_¡©e_purg©Üy
;

85 
	`tsd_£t
(
tsd
);

87 
tsd_¡©e_purg©Üy
:

95 
tsd_¡©e_»šÿº©ed
:

101 
tsd
->
¡©e
 = 
tsd_¡©e_purg©Üy
;

102 
	`tsd_£t
(
tsd
);

105 
	`nÙ_»ached
();

107 
	}
}

109 
boŞ


110 
	$m®loc_tsd_boÙ0
()

113 
nş—nups
 = 0;

114 ià(
	`tsd_boÙ0
())

115  (
Œue
);

116 *
	`tsd_¬’as_ÿche_by·s¥_g‘
(
	`tsd_ãtch
()èğ
Œue
;

117  (
çl£
);

118 
	}
}

121 
	$m®loc_tsd_boÙ1
()

124 
	`tsd_boÙ1
();

125 *
	`tsd_¬’as_ÿche_by·s¥_g‘
(
	`tsd_ãtch
()èğ
çl£
;

126 
	}
}

128 #ifdeà
_WIN32


129 
BOOL
 
WINAPI


130 
	$_s_ÿÎback
(
HINSTANCE
 
hš¡DLL
, 
DWORD
 
fdwR—sÚ
, 
LPVOID
 
ÍvRe£rved
)

133 
fdwR—sÚ
) {

134 #ifdeà
JEMALLOC_LAZY_LOCK


135 
DLL_THREAD_ATTACH
:

136 
i¡h»aded
 = 
Œue
;

139 
DLL_THREAD_DETACH
:

140 
	`_m®loc_th»ad_ş—nup
();

145  (
Œue
);

146 
	}
}

148 #ifdeà
_MSC_VER


149 #ifdeà
_M_IX86


150 #´agm¨
comm’t
(
lšk”
, "/INCLUDE:__tls_used")

152 #´agm¨
comm’t
(
lšk”
, "/INCLUDE:_tls_used")

154 #´agm¨
£ùiÚ
(".CRT$XLY",,
»ad
)

156 
JEMALLOC_SECTION
(".CRT$XLY"è
	$JEMALLOC_ATTR
(
u£d
)

157 
	$BOOL
 (
WINAPI
 *cÚ¡ 
s_ÿÎback
)(
HINSTANCE
 
hš¡DLL
,

158 
DWORD
 
fdwR—sÚ
, 
LPVOID
 
ÍvRe£rved
èğ
_s_ÿÎback
;

161 #ià(!
	`defšed
(
JEMALLOC_MALLOC_THREAD_CLEANUP
è&& !defšed(
JEMALLOC_TLS
) && \

162 !
	$defšed
(
_WIN32
))

164 
	$tsd_š™_check_»cursiÚ
(
tsd_š™_h—d_t
 *
h—d
, 
tsd_š™_block_t
 *
block
)

166 
±h»ad_t
 
£lf
 = 
	`±h»ad_£lf
();

167 
tsd_š™_block_t
 *
™”
;

170 
	`m®loc_mu‹x_lock
(&
h—d
->
lock
);

171 
	`ql_fÜ—ch
(
™”
, &
h—d
->
blocks
, 
lšk
) {

172 ià(
™”
->
th»ad
 =ğ
£lf
) {

173 
	`m®loc_mu‹x_uÆock
(&
h—d
->
lock
);

174  (
™”
->
d©a
);

178 
	`ql_–m_Ãw
(
block
, 
lšk
);

179 
block
->
th»ad
 = 
£lf
;

180 
	`ql__š£¹
(&
h—d
->
blocks
, 
block
, 
lšk
);

181 
	`m®loc_mu‹x_uÆock
(&
h—d
->
lock
);

182  (
NULL
);

183 
	}
}

186 
	$tsd_š™_fšish
(
tsd_š™_h—d_t
 *
h—d
, 
tsd_š™_block_t
 *
block
)

189 
	`m®loc_mu‹x_lock
(&
h—d
->
lock
);

190 
	`ql_»move
(&
h—d
->
blocks
, 
block
, 
lšk
);

191 
	`m®loc_mu‹x_uÆock
(&
h—d
->
lock
);

192 
	}
}

	@deps/jemalloc/src/util.c

1 
	#as£¹
(
e
) do { \

2 ià(
cÚfig_debug
 && !(
e
)) { \

3 
	`m®loc_wr™e
("<jemalloc>: Failed‡ssertion\n"); \

4 
	`abÜt
(); \

6 } 0)

	)

8 
	#nÙ_»ached
() do { \

9 ià(
cÚfig_debug
) { \

10 
	`m®loc_wr™e
("<jemalloc>: Unreachable code„eached\n"); \

11 
	`abÜt
(); \

13 } 0)

	)

15 
	#nÙ_im¶em’‹d
() do { \

16 ià(
cÚfig_debug
) { \

17 
	`m®loc_wr™e
("<jemalloc>: Not implemented\n"); \

18 
	`abÜt
(); \

20 } 0)

	)

22 
	#JEMALLOC_UTIL_C_


	)

23 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

28 
w¹mes§ge
(*
cbİaque
, cÚ¡ *
s
);

29 
	#U2S_BUFSIZE
 ((1U << (
LG_SIZEOF_INTMAX_T
 + 3)è+ 1)

	)

30 *
u2s
(
uštmax_t
 
x
, 
ba£
, 
boŞ
 
uµ”ÿ£
, *
s
,

31 
size_t
 *
¦’_p
);

32 
	#D2S_BUFSIZE
 (1 + 
U2S_BUFSIZE
)

	)

33 *
d2s
(
štmax_t
 
x
, 
sign
, *
s
, 
size_t
 *
¦’_p
);

34 
	#O2S_BUFSIZE
 (1 + 
U2S_BUFSIZE
)

	)

35 *
o2s
(
uštmax_t
 
x
, 
boŞ
 
®t_fÜm
, *
s
, 
size_t
 *
¦’_p
);

36 
	#X2S_BUFSIZE
 (2 + 
U2S_BUFSIZE
)

	)

37 *
x2s
(
uštmax_t
 
x
, 
boŞ
 
®t_fÜm
, boŞ 
uµ”ÿ£
, *
s
,

38 
size_t
 *
¦’_p
);

44 
	$w¹mes§ge
(*
cbİaque
, cÚ¡ *
s
)

47 #ifdeà
SYS_wr™e


53 
UNUSED
 
»suÉ
 = 
	`sysÿÎ
(
SYS_wr™e
, 
STDERR_FILENO
, 
s
, 
	`¡¾’
(s));

55 
UNUSED
 
»suÉ
 = 
	`wr™e
(
STDERR_FILENO
, 
s
, 
	`¡¾’
(s));

57 
	}
}

59 
JEMALLOC_EXPORT
 (*
je_m®loc_mes§ge
)(*, cÚ¡ *
s
);

66 
	$m®loc_wr™e
(cÚ¡ *
s
)

69 ià(
je_m®loc_mes§ge
 !ğ
NULL
)

70 
	`je_m®loc_mes§ge
(
NULL
, 
s
);

72 
	`w¹mes§ge
(
NULL
, 
s
);

73 
	}
}

80 
	$buã¼Ü
(
”r
, *
buf
, 
size_t
 
buæ’
)

83 #ifdeà
_WIN32


84 
	`FÜm©Mes§geA
(
FORMAT_MESSAGE_FROM_SYSTEM
, 
NULL
, 
”r
, 0,

85 (
LPSTR
)
buf
, 
buæ’
, 
NULL
);

87 #–ià
	`defšed
(
__GLIBC__
è&& defšed(
_GNU_SOURCE
)

88 *
b
 = 
	`¡»¼Ü_r
(
”r
, 
buf
, 
buæ’
);

89 ià(
b
 !ğ
buf
) {

90 
	`¡ºıy
(
buf
, 
b
, 
buæ’
);

91 
buf
[
buæ’
-1] = '\0';

95  (
	`¡»¼Ü_r
(
”r
, 
buf
, 
buæ’
));

97 
	}
}

99 
uštmax_t


100 
	$m®loc_¡¹oumax
(cÚ¡ *
»¡riù
 
ÅŒ
, **»¡riù 
’d±r
, 
ba£
)

102 
uštmax_t
 
»t
, 
dig™
;

103 
b
;

104 
boŞ
 
Ãg
;

105 cÚ¡ *
p
, *
ns
;

107 
p
 = 
ÅŒ
;

108 ià(
ba£
 < 0 || base == 1 || base > 36) {

109 
ns
 = 
p
;

110 
	`£t_”ºo
(
EINVAL
);

111 
»t
 = 
UINTMAX_MAX
;

112 
Ïb–_»tuº
;

114 
b
 = 
ba£
;

117 
Ãg
 = 
çl£
;

118 
Œue
) {

119 *
p
) {

121 
p
++;

124 
Ãg
 = 
Œue
;

127 
p
++;

130 
Ïb–_´efix
;

135 
Ïb–_´efix
:

141 
ns
 = 
p
;

142 ià(*
p
 == '0') {

143 
p
[1]) {

146 ià(
b
 == 0)

147 
b
 = 8;

148 ià(
b
 == 8)

149 
p
++;

152 
p
[2]) {

159 ià(
b
 == 0)

160 
b
 = 16;

161 ià(
b
 == 16)

162 
p
 += 2;

169 
p
++;

170 
»t
 = 0;

171 
Ïb–_»tuº
;

174 ià(
b
 == 0)

175 
b
 = 10;

178 
»t
 = 0;

179 (*
p
 >ğ'0' && *°<ğ'9' && (
dig™
 = *°- '0'è< 
b
)

180 || (*
p
 >ğ'A' && *°<ğ'Z' && (
dig™
 = 10 + *°- 'A'è< 
b
)

181 || (*
p
 >ğ'a' && *°<ğ'z' && (
dig™
 = 10 + *°- 'a'è< 
b
)) {

182 
uštmax_t
 
´‘
 = 
»t
;

183 
»t
 *ğ
b
;

184 
»t
 +ğ
dig™
;

185 ià(
»t
 < 
´‘
) {

187 
	`£t_”ºo
(
ERANGE
);

188 
»t
 = 
UINTMAX_MAX
;

189 
Ïb–_»tuº
;

191 
p
++;

193 ià(
Ãg
)

194 
»t
 = -ret;

196 ià(
p
 =ğ
ns
) {

198 
	`£t_”ºo
(
EINVAL
);

199 
»t
 = 
UINTMAX_MAX
;

200 
Ïb–_»tuº
;

203 
Ïb–_»tuº
:

204 ià(
’d±r
 !ğ
NULL
) {

205 ià(
p
 =ğ
ns
) {

207 *
’d±r
 = (*)
ÅŒ
;

209 *
’d±r
 = (*)
p
;

211  (
»t
);

212 
	}
}

215 
	$u2s
(
uštmax_t
 
x
, 
ba£
, 
boŞ
 
uµ”ÿ£
, *
s
, 
size_t
 *
¦’_p
)

217 
i
;

219 
i
 = 
U2S_BUFSIZE
 - 1;

220 
s
[
i
] = '\0';

221 
ba£
) {

224 
i
--;

225 
s
[
i
] = "0123456789"[
x
 % (
ušt64_t
)10];

226 
x
 /ğ(
ušt64_t
)10;

227 } 
x
 > 0);

230 cÚ¡ *
dig™s
 = (
uµ”ÿ£
)

235 
i
--;

236 
s
[
i
] = 
dig™s
[
x
 & 0xf];

237 
x
 >>= 4;

238 } 
x
 > 0);

241 cÚ¡ *
dig™s
 = (
uµ”ÿ£
)

245 
	`as£¹
(
ba£
 >= 2 && base <= 36);

247 
i
--;

248 
s
[
i
] = 
dig™s
[
x
 % (
ušt64_t
)
ba£
];

249 
x
 /ğ(
ušt64_t
)
ba£
;

250 } 
x
 > 0);

253 *
¦’_p
 = 
U2S_BUFSIZE
 - 1 - 
i
;

254  (&
s
[
i
]);

255 
	}
}

258 
	$d2s
(
štmax_t
 
x
, 
sign
, *
s
, 
size_t
 *
¦’_p
)

260 
boŞ
 
Ãg
;

262 ià((
Ãg
 = (
x
 < 0)))

263 
x
 = -x;

264 
s
 = 
	`u2s
(
x
, 10, 
çl£
, s, 
¦’_p
);

265 ià(
Ãg
)

266 
sign
 = '-';

267 
sign
) {

269 ià(!
Ãg
)

274 
s
--;

275 (*
¦’_p
)++;

276 *
s
 = 
sign
;

278 : 
	`nÙ_»ached
();

280  (
s
);

281 
	}
}

284 
	$o2s
(
uštmax_t
 
x
, 
boŞ
 
®t_fÜm
, *
s
, 
size_t
 *
¦’_p
)

287 
s
 = 
	`u2s
(
x
, 8, 
çl£
, s, 
¦’_p
);

288 ià(
®t_fÜm
 && *
s
 != '0') {

289 
s
--;

290 (*
¦’_p
)++;

291 *
s
 = '0';

293  (
s
);

294 
	}
}

297 
	$x2s
(
uštmax_t
 
x
, 
boŞ
 
®t_fÜm
, boŞ 
uµ”ÿ£
, *
s
, 
size_t
 *
¦’_p
)

300 
s
 = 
	`u2s
(
x
, 16, 
uµ”ÿ£
, s, 
¦’_p
);

301 ià(
®t_fÜm
) {

302 
s
 -= 2;

303 (*
¦’_p
) += 2;

304 
	`memıy
(
s
, 
uµ”ÿ£
 ? "0X" : "0x", 2);

306  (
s
);

307 
	}
}

310 
	$m®loc_v¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

312 
»t
;

313 
size_t
 
i
;

314 cÚ¡ *
f
;

316 
	#APPEND_C
(
c
) do { \

317 ià(
i
 < 
size
) \

318 
¡r
[
i
] = (
c
); \

319 
i
++; \

320 } 0)

	)

321 
	#APPEND_S
(
s
, 
¦’
) do { \

322 ià(
i
 < 
size
) { \

323 
size_t
 
ıyËn
 = (
¦’
 <ğ
size
 - 
i
) ? slen : size - i; \

324 
	`memıy
(&
¡r
[
i
], 
s
, 
ıyËn
); \

326 
i
 +ğ
¦’
; \

327 } 0)

	)

328 
	#APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
) do { \

330 
size_t
 
·d_Ën
 = (
width
 =ğ-1è? 0 : ((
¦’
 < (size_t)width) ? \

331 (
size_t
)
width
 - 
¦’
 : 0); \

332 ià(!
Ëá_ju¡ify
 && 
·d_Ën
 != 0) { \

333 
size_t
 
j
; \

334 
j
 = 0; j < 
·d_Ën
; j++) \

335 
	`APPEND_C
(' '); \

338 
	`APPEND_S
(
s
, 
¦’
); \

340 ià(
Ëá_ju¡ify
 && 
·d_Ën
 != 0) { \

341 
size_t
 
j
; \

342 
j
 = 0; j < 
·d_Ën
; j++) \

343 
	`APPEND_C
(' '); \

345 } 0)

	)

346 
	#GET_ARG_NUMERIC
(
v®
, 
Ën
) do { \

347 
Ën
) { \

349 
v®
 = 
	`va_¬g
(
­
, ); \

352 
v®
 = 
	`va_¬g
(
­
, ); \

355 
v®
 = 
	`va_¬g
(
­
, ); \

358 
v®
 = 
	`va_¬g
(
­
, ); \

361 
v®
 = 
	`va_¬g
(
­
, ); \

364 
v®
 = 
	`va_¬g
(
­
, ); \

367 
v®
 = 
	`va_¬g
(
­
, 
štmax_t
); \

370 
v®
 = 
	`va_¬g
(
­
, 
uštmax_t
); \

373 
v®
 = 
	`va_¬g
(
­
, 
±rdiff_t
); \

376 
v®
 = 
	`va_¬g
(
­
, 
ssize_t
); \

379 
v®
 = 
	`va_¬g
(
­
, 
size_t
); \

382 
v®
 = 
	`va_¬g
(
­
, 
ušŒ_t
); \

385 
	`nÙ_»ached
(); \

386 
v®
 = 0; \

388 } 0)

	)

390 
i
 = 0;

391 
f
 = 
fÜm©
;

392 
Œue
) {

393 *
f
) {

394 '\0': 
Ïb–_out
;

396 
boŞ
 
®t_fÜm
 = 
çl£
;

397 
boŞ
 
Ëá_ju¡ify
 = 
çl£
;

398 
boŞ
 
¶us_¥aû
 = 
çl£
;

399 
boŞ
 
¶us_¶us
 = 
çl£
;

400 
´ec
 = -1;

401 
width
 = -1;

402 
Ën
 = '?';

404 
f
++;

406 
Œue
) {

407 *
f
) {

409 
	`as£¹
(!
®t_fÜm
);

410 
®t_fÜm
 = 
Œue
;

413 
	`as£¹
(!
Ëá_ju¡ify
);

414 
Ëá_ju¡ify
 = 
Œue
;

417 
	`as£¹
(!
¶us_¥aû
);

418 
¶us_¥aû
 = 
Œue
;

421 
	`as£¹
(!
¶us_¶us
);

422 
¶us_¶us
 = 
Œue
;

424 : 
Ïb–_width
;

426 
f
++;

429 
Ïb–_width
:

430 *
f
) {

432 
width
 = 
	`va_¬g
(
­
, );

433 
f
++;

434 ià(
width
 < 0) {

435 
Ëá_ju¡ify
 = 
Œue
;

436 
width
 = -width;

441 
uštmax_t
 
uwidth
;

442 
	`£t_”ºo
(0);

443 
uwidth
 = 
	`m®loc_¡¹oumax
(
f
, (**)&f, 10);

444 
	`as£¹
(
uwidth
 !ğ
UINTMAX_MAX
 || 
	`g‘_”ºo
() !=

445 
ERANGE
);

446 
width
 = ()
uwidth
;

452 ià(*
f
 == '.')

453 
f
++;

455 
Ïb–_Ëngth
;

457 *
f
) {

459 
´ec
 = 
	`va_¬g
(
­
, );

460 
f
++;

464 
uštmax_t
 
u´ec
;

465 
	`£t_”ºo
(0);

466 
u´ec
 = 
	`m®loc_¡¹oumax
(
f
, (**)&f, 10);

467 
	`as£¹
(
u´ec
 !ğ
UINTMAX_MAX
 || 
	`g‘_”ºo
() !=

468 
ERANGE
);

469 
´ec
 = ()
u´ec
;

475 
Ïb–_Ëngth
:

476 *
f
) {

478 
f
++;

479 ià(*
f
 == 'l') {

480 
Ën
 = 'q';

481 
f
++;

483 
Ën
 = 'l';

486 
Ën
 = *
f
;

487 
f
++;

492 *
f
) {

493 *
s
;

494 
size_t
 
¦’
;

497 
	`APPEND_C
(*
f
);

498 
f
++;

501 
štmax_t
 
v®
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

502 
buf
[
D2S_BUFSIZE
];

504 
	`GET_ARG_NUMERIC
(
v®
, 
Ën
);

505 
s
 = 
	`d2s
(
v®
, (
¶us_¶us
 ? '+' : (
¶us_¥aû
 ?

506 ' ' : '-')), 
buf
, &
¦’
);

507 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

508 
f
++;

511 
uštmax_t
 
v®
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

512 
buf
[
O2S_BUFSIZE
];

514 
	`GET_ARG_NUMERIC
(
v®
, 
Ën
 | 0x80);

515 
s
 = 
	`o2s
(
v®
, 
®t_fÜm
, 
buf
, &
¦’
);

516 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

517 
f
++;

520 
uštmax_t
 
v®
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

521 
buf
[
U2S_BUFSIZE
];

523 
	`GET_ARG_NUMERIC
(
v®
, 
Ën
 | 0x80);

524 
s
 = 
	`u2s
(
v®
, 10, 
çl£
, 
buf
, &
¦’
);

525 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

526 
f
++;

529 
uštmax_t
 
v®
 
	`JEMALLOC_CC_SILENCE_INIT
(0);

530 
buf
[
X2S_BUFSIZE
];

532 
	`GET_ARG_NUMERIC
(
v®
, 
Ën
 | 0x80);

533 
s
 = 
	`x2s
(
v®
, 
®t_fÜm
, *
f
 =ğ'X', 
buf
, &
¦’
);

534 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

535 
f
++;

538 
v®
;

539 
buf
[2];

541 
	`as£¹
(
Ën
 == '?' ||†en == 'l');

542 
	`as£¹_nÙ_im¶em’‹d
(
Ën
 != 'l');

543 
v®
 = 
	`va_¬g
(
­
, );

544 
buf
[0] = 
v®
;

545 
buf
[1] = '\0';

546 
	`APPEND_PADDED_S
(
buf
, 1, 
width
, 
Ëá_ju¡ify
);

547 
f
++;

550 
	`as£¹
(
Ën
 == '?' ||†en == 'l');

551 
	`as£¹_nÙ_im¶em’‹d
(
Ën
 != 'l');

552 
s
 = 
	`va_¬g
(
­
, *);

553 
¦’
 = (
´ec
 < 0è? 
	`¡¾’
(
s
è: (
size_t
)prec;

554 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

555 
f
++;

558 
uštmax_t
 
v®
;

559 
buf
[
X2S_BUFSIZE
];

561 
	`GET_ARG_NUMERIC
(
v®
, 'p');

562 
s
 = 
	`x2s
(
v®
, 
Œue
, 
çl£
, 
buf
, &
¦’
);

563 
	`APPEND_PADDED_S
(
s
, 
¦’
, 
width
, 
Ëá_ju¡ify
);

564 
f
++;

566 } : 
	`nÙ_»ached
();

570 
	`APPEND_C
(*
f
);

571 
f
++;

575 
Ïb–_out
:

576 ià(
i
 < 
size
)

577 
¡r
[
i
] = '\0';

579 
¡r
[
size
 - 1] = '\0';

580 
»t
 = 
i
;

582 #undeà
APPEND_C


583 #undeà
APPEND_S


584 #undeà
APPEND_PADDED_S


585 #undeà
GET_ARG_NUMERIC


586  (
»t
);

587 
	}
}

589 
	$JEMALLOC_FORMAT_PRINTF
(3, 4)

591 
	$m®loc_¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fÜm©
, ...)

593 
»t
;

594 
va_li¡
 
­
;

596 
	`va_¡¬t
(
­
, 
fÜm©
);

597 
»t
 = 
	`m®loc_v¢´štf
(
¡r
, 
size
, 
fÜm©
, 
­
);

598 
	`va_’d
(
­
);

600  (
»t
);

601 
	}
}

604 
	$m®loc_vırštf
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

605 cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

607 
buf
[
MALLOC_PRINTF_BUFSIZE
];

609 ià(
wr™e_cb
 =ğ
NULL
) {

615 
wr™e_cb
 = (
je_m®loc_mes§ge
 !ğ
NULL
) ? je_malloc_message :

616 
w¹mes§ge
;

617 
cbİaque
 = 
NULL
;

620 
	`m®loc_v¢´štf
(
buf
, (buf), 
fÜm©
, 
­
);

621 
	`wr™e_cb
(
cbİaque
, 
buf
);

622 
	}
}

628 
	$JEMALLOC_FORMAT_PRINTF
(3, 4)

630 
	$m®loc_ırštf
((*
wr™e_cb
)(*, cÚ¡ *), *
cbİaque
,

631 cÚ¡ *
fÜm©
, ...)

633 
va_li¡
 
­
;

635 
	`va_¡¬t
(
­
, 
fÜm©
);

636 
	`m®loc_vırštf
(
wr™e_cb
, 
cbİaque
, 
fÜm©
, 
­
);

637 
	`va_’d
(
­
);

638 
	}
}

641 
	$JEMALLOC_FORMAT_PRINTF
(1, 2)

643 
	$m®loc_´štf
(cÚ¡ *
fÜm©
, ...)

645 
va_li¡
 
­
;

647 
	`va_¡¬t
(
­
, 
fÜm©
);

648 
	`m®loc_vırštf
(
NULL
, NULL, 
fÜm©
, 
­
);

649 
	`va_’d
(
­
);

650 
	}
}

	@deps/jemalloc/src/valgrind.c

1 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

2 #iâdeà
JEMALLOC_VALGRIND


6 
	~<v®gršd/memcheck.h
>

9 
	$v®gršd_make_mem_nßcûss
(*
±r
, 
size_t
 
usize
)

12 
	`VALGRIND_MAKE_MEM_NOACCESS
(
±r
, 
usize
);

13 
	}
}

16 
	$v®gršd_make_mem_undefšed
(*
±r
, 
size_t
 
usize
)

19 
	`VALGRIND_MAKE_MEM_UNDEFINED
(
±r
, 
usize
);

20 
	}
}

23 
	$v®gršd_make_mem_defšed
(*
±r
, 
size_t
 
usize
)

26 
	`VALGRIND_MAKE_MEM_DEFINED
(
±r
, 
usize
);

27 
	}
}

30 
	$v®gršd_ä“like_block
(*
±r
, 
size_t
 
usize
)

33 
	`VALGRIND_FREELIKE_BLOCK
(
±r
, 
usize
);

34 
	}
}

	@deps/jemalloc/src/zone.c

1 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

2 #iâdeà
JEMALLOC_ZONE


10 
m®loc_zÚe_t
 *
	$m®loc_deçuÉ_purg—bË_zÚe
()

11 
	`JEMALLOC_ATTR
(
w—k_impÜt
);

16 
m®loc_zÚe_t
 
zÚe
;

17 
m®loc_šŒo¥eùiÚ_t
 
zÚe_šŒo¥eù
;

22 
size_t
 
	`zÚe_size
(
m®loc_zÚe_t
 *
zÚe
, *
±r
);

23 *
	`zÚe_m®loc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
size
);

24 *
	`zÚe_ÿÎoc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
num
, size_ˆ
size
);

25 *
	`zÚe_v®loc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
size
);

26 
	`zÚe_ä“
(
m®loc_zÚe_t
 *
zÚe
, *
±r
);

27 *
	`zÚe_»®loc
(
m®loc_zÚe_t
 *
zÚe
, *
±r
, 
size_t
 
size
);

28 #ià(
JEMALLOC_ZONE_VERSION
 >= 5)

29 *
	`zÚe_mem®ign
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
®ignm’t
,

31 #ià(
JEMALLOC_ZONE_VERSION
 >= 6)

32 
size_t
 
size
);

33 
	`zÚe_ä“_defš™e_size
(
m®loc_zÚe_t
 *
zÚe
, *
±r
,

34 
size_t
 
size
);

36 *
	`zÚe_de¡roy
(
m®loc_zÚe_t
 *
zÚe
);

37 
size_t
 
	`zÚe_good_size
(
m®loc_zÚe_t
 *
zÚe
, size_ˆ
size
);

38 
	`zÚe_fÜû_lock
(
m®loc_zÚe_t
 *
zÚe
);

39 
	`zÚe_fÜû_uÆock
(
m®loc_zÚe_t
 *
zÚe
);

46 
size_t


47 
	$zÚe_size
(
m®loc_zÚe_t
 *
zÚe
, *
±r
)

59  (
	`iv§Îoc
(
±r
, 
cÚfig_´of
));

60 
	}
}

63 
	$zÚe_m®loc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
size
)

66  (
	`je_m®loc
(
size
));

67 
	}
}

70 
	$zÚe_ÿÎoc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
num
, size_ˆ
size
)

73  (
	`je_ÿÎoc
(
num
, 
size
));

74 
	}
}

77 
	$zÚe_v®loc
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
size
)

79 *
»t
 = 
NULL
;

81 
	`je_posix_mem®ign
(&
»t
, 
PAGE
, 
size
);

83  (
»t
);

84 
	}
}

87 
	$zÚe_ä“
(
m®loc_zÚe_t
 *
zÚe
, *
±r
)

90 ià(
	`iv§Îoc
(
±r
, 
cÚfig_´of
) != 0) {

91 
	`je_ä“
(
±r
);

95 
	`ä“
(
±r
);

96 
	}
}

99 
	$zÚe_»®loc
(
m®loc_zÚe_t
 *
zÚe
, *
±r
, 
size_t
 
size
)

102 ià(
	`iv§Îoc
(
±r
, 
cÚfig_´of
) != 0)

103  (
	`je_»®loc
(
±r
, 
size
));

105  (
	`»®loc
(
±r
, 
size
));

106 
	}
}

108 #ià(
JEMALLOC_ZONE_VERSION
 >= 5)

110 
	$zÚe_mem®ign
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
®ignm’t
, size_ˆ
size
)

112 *
»t
 = 
NULL
;

114 
	`je_posix_mem®ign
(&
»t
, 
®ignm’t
, 
size
);

116  (
»t
);

117 
	}
}

120 #ià(
JEMALLOC_ZONE_VERSION
 >= 6)

122 
	$zÚe_ä“_defš™e_size
(
m®loc_zÚe_t
 *
zÚe
, *
±r
, 
size_t
 
size
)

125 ià(
	`iv§Îoc
(
±r
, 
cÚfig_´of
) != 0) {

126 
	`as£¹
(
	`iv§Îoc
(
±r
, 
cÚfig_´of
è=ğ
size
);

127 
	`je_ä“
(
±r
);

131 
	`ä“
(
±r
);

132 
	}
}

136 
	$zÚe_de¡roy
(
m®loc_zÚe_t
 *
zÚe
)

140 
	`nÙ_»ached
();

141  (
NULL
);

142 
	}
}

144 
size_t


145 
	$zÚe_good_size
(
m®loc_zÚe_t
 *
zÚe
, 
size_t
 
size
)

148 ià(
size
 == 0)

149 
size
 = 1;

150  (
	`s2u
(
size
));

151 
	}
}

154 
	$zÚe_fÜû_lock
(
m®loc_zÚe_t
 *
zÚe
)

157 ià(
i¡h»aded
)

158 
	`jem®loc_´efÜk
();

159 
	}
}

162 
	$zÚe_fÜû_uÆock
(
m®loc_zÚe_t
 *
zÚe
)

165 ià(
i¡h»aded
)

166 
	`jem®loc_po¡fÜk_·»Á
();

167 
	}
}

169 
	$JEMALLOC_ATTR
(
cÚ¡ruùÜ
)

171 
	$»gi¡”_zÚe
()

178 
m®loc_zÚe_t
 *
deçuÉ_zÚe
 = 
	`m®loc_deçuÉ_zÚe
();

179 
m®loc_zÚe_t
 *
purg—bË_zÚe
 = 
NULL
;

180 ià(!
deçuÉ_zÚe
->
zÚe_Çme
 ||

181 
	`¡rcmp
(
deçuÉ_zÚe
->
zÚe_Çme
, "DefaultMallocZone") != 0) {

185 
zÚe
.
size
 = (*)
zÚe_size
;

186 
zÚe
.
m®loc
 = (*)
zÚe_m®loc
;

187 
zÚe
.
ÿÎoc
 = (*)
zÚe_ÿÎoc
;

188 
zÚe
.
v®loc
 = (*)
zÚe_v®loc
;

189 
zÚe
.
ä“
 = (*)
zÚe_ä“
;

190 
zÚe
.
»®loc
 = (*)
zÚe_»®loc
;

191 
zÚe
.
de¡roy
 = (*)
zÚe_de¡roy
;

192 
zÚe
.
zÚe_Çme
 = "jemalloc_zone";

193 
zÚe
.
b©ch_m®loc
 = 
NULL
;

194 
zÚe
.
b©ch_ä“
 = 
NULL
;

195 
zÚe
.
šŒo¥eù
 = &
zÚe_šŒo¥eù
;

196 
zÚe
.
v”siÚ
 = 
JEMALLOC_ZONE_VERSION
;

197 #ià(
JEMALLOC_ZONE_VERSION
 >= 5)

198 
zÚe
.
mem®ign
 = 
zÚe_mem®ign
;

200 #ià(
JEMALLOC_ZONE_VERSION
 >= 6)

201 
zÚe
.
ä“_defš™e_size
 = 
zÚe_ä“_defš™e_size
;

203 #ià(
JEMALLOC_ZONE_VERSION
 >= 8)

204 
zÚe
.
´essu»_»l›f
 = 
NULL
;

207 
zÚe_šŒo¥eù
.
’um”©Ü
 = 
NULL
;

208 
zÚe_šŒo¥eù
.
good_size
 = (*)
zÚe_good_size
;

209 
zÚe_šŒo¥eù
.
check
 = 
NULL
;

210 
zÚe_šŒo¥eù
.
´št
 = 
NULL
;

211 
zÚe_šŒo¥eù
.
log
 = 
NULL
;

212 
zÚe_šŒo¥eù
.
fÜû_lock
 = (*)
zÚe_fÜû_lock
;

213 
zÚe_šŒo¥eù
.
fÜû_uÆock
 = (*)
zÚe_fÜû_uÆock
;

214 
zÚe_šŒo¥eù
.
¡©i¡ics
 = 
NULL
;

215 #ià(
JEMALLOC_ZONE_VERSION
 >= 6)

216 
zÚe_šŒo¥eù
.
zÚe_locked
 = 
NULL
;

218 #ià(
JEMALLOC_ZONE_VERSION
 >= 7)

219 
zÚe_šŒo¥eù
.
’abË_disch¬ge_checkšg
 = 
NULL
;

220 
zÚe_šŒo¥eù
.
di§bË_disch¬ge_checkšg
 = 
NULL
;

221 
zÚe_šŒo¥eù
.
disch¬ge
 = 
NULL
;

222 #ifdeà
__BLOCKS__


223 
zÚe_šŒo¥eù
.
’um”©e_disch¬ged_poš‹rs
 = 
NULL
;

225 
zÚe_šŒo¥eù
.
’um”©e_uÇvaabË_w™hout_blocks
 = 
NULL
;

240 ià(
m®loc_deçuÉ_purg—bË_zÚe
 !ğ
NULL
)

241 
purg—bË_zÚe
 = 
	`m®loc_deçuÉ_purg—bË_zÚe
();

244 
	`m®loc_zÚe_»gi¡”
(&
zÚe
);

247 
deçuÉ_zÚe
 = 
	`m®loc_deçuÉ_zÚe
();

256 
	`m®loc_zÚe_uÄegi¡”
(
deçuÉ_zÚe
);

257 
	`m®loc_zÚe_»gi¡”
(
deçuÉ_zÚe
);

269 ià(
purg—bË_zÚe
) {

270 
	`m®loc_zÚe_uÄegi¡”
(
purg—bË_zÚe
);

271 
	`m®loc_zÚe_»gi¡”
(
purg—bË_zÚe
);

273 } 
	`m®loc_deçuÉ_zÚe
(è!ğ&
zÚe
);

274 
	}
}

	@deps/jemalloc/test/include/test/SFMT-alti.h

52 #iâdeà
SFMT_ALTI_H


53 
	#SFMT_ALTI_H


	)

63 
JEMALLOC_ALWAYS_INLINE


64 
veùÜ
 
	$vec_»cursiÚ
(
veùÜ
 
a
,

65 
veùÜ
 
b
,

66 
veùÜ
 
c
,

67 
veùÜ
 
d
) {

69 cÚ¡ 
veùÜ
 
¦1
 = 
ALTI_SL1
;

70 cÚ¡ 
veùÜ
 
¤1
 = 
ALTI_SR1
;

71 #ifdeà
ONLY64


72 cÚ¡ 
veùÜ
 
mask
 = 
ALTI_MSK64
;

73 cÚ¡ 
veùÜ
 
³rm_¦
 = 
ALTI_SL2_PERM64
;

74 cÚ¡ 
veùÜ
 
³rm_¤
 = 
ALTI_SR2_PERM64
;

76 cÚ¡ 
veùÜ
 
mask
 = 
ALTI_MSK
;

77 cÚ¡ 
veùÜ
 
³rm_¦
 = 
ALTI_SL2_PERM
;

78 cÚ¡ 
veùÜ
 
³rm_¤
 = 
ALTI_SR2_PERM
;

80 
veùÜ
 
v
, 
w
, 
x
, 
y
, 
z
;

81 
x
 = 
	`vec_³rm
(
a
, (
veùÜ
 )
³rm_¦
,…erm_sl);

82 
v
 = 
a
;

83 
y
 = 
	`vec_¤
(
b
, 
¤1
);

84 
z
 = 
	`vec_³rm
(
c
, (
veùÜ
 )
³rm_¤
,…erm_sr);

85 
w
 = 
	`vec_¦
(
d
, 
¦1
);

86 
z
 = 
	`vec_xÜ
(z, 
w
);

87 
y
 = 
	`vec_ªd
(y, 
mask
);

88 
v
 = 
	`vec_xÜ
(v, 
x
);

89 
z
 = 
	`vec_xÜ
(z, 
y
);

90 
z
 = 
	`vec_xÜ
(z, 
v
);

91  
z
;

92 
	}
}

98 
JEMALLOC_INLINE
 
	$g’_¿nd_®l
(
sfmt_t
 *
ùx
) {

99 
i
;

100 
veùÜ
 
r
, 
r1
, 
r2
;

102 
r1
 = 
ùx
->
sfmt
[
N
 - 2].
s
;

103 
r2
 = 
ùx
->
sfmt
[
N
 - 1].
s
;

104 
i
 = 0; i < 
N
 - 
POS1
; i++) {

105 
r
 = 
	`vec_»cursiÚ
(
ùx
->
sfmt
[
i
].
s
, ctx->sfmt[˜+ 
POS1
].s, 
r1
, 
r2
);

106 
ùx
->
sfmt
[
i
].
s
 = 
r
;

107 
r1
 = 
r2
;

108 
r2
 = 
r
;

110 ; 
i
 < 
N
; i++) {

111 
r
 = 
	`vec_»cursiÚ
(
ùx
->
sfmt
[
i
].
s
, ctx->sfmt[˜+ 
POS1
 - 
N
].s, 
r1
, 
r2
);

112 
ùx
->
sfmt
[
i
].
s
 = 
r
;

113 
r1
 = 
r2
;

114 
r2
 = 
r
;

116 
	}
}

125 
JEMALLOC_INLINE
 
	$g’_¿nd_¬¿y
(
sfmt_t
 *
ùx
, 
w128_t
 *
¬¿y
, 
size
) {

126 
i
, 
j
;

127 
veùÜ
 
r
, 
r1
, 
r2
;

129 
r1
 = 
ùx
->
sfmt
[
N
 - 2].
s
;

130 
r2
 = 
ùx
->
sfmt
[
N
 - 1].
s
;

131 
i
 = 0; i < 
N
 - 
POS1
; i++) {

132 
r
 = 
	`vec_»cursiÚ
(
ùx
->
sfmt
[
i
].
s
, ctx->sfmt[˜+ 
POS1
].s, 
r1
, 
r2
);

133 
¬¿y
[
i
].
s
 = 
r
;

134 
r1
 = 
r2
;

135 
r2
 = 
r
;

137 ; 
i
 < 
N
; i++) {

138 
r
 = 
	`vec_»cursiÚ
(
ùx
->
sfmt
[
i
].
s
, 
¬¿y
[˜+ 
POS1
 - 
N
].s, 
r1
, 
r2
);

139 
¬¿y
[
i
].
s
 = 
r
;

140 
r1
 = 
r2
;

141 
r2
 = 
r
;

144 ; 
i
 < 
size
 - 
N
; i++) {

145 
r
 = 
	`vec_»cursiÚ
(
¬¿y
[
i
 - 
N
].
s
,‡¼ay[˜+ 
POS1
 - N].s, 
r1
, 
r2
);

146 
¬¿y
[
i
].
s
 = 
r
;

147 
r1
 = 
r2
;

148 
r2
 = 
r
;

150 
j
 = 0; j < 2 * 
N
 - 
size
; j++) {

151 
ùx
->
sfmt
[
j
].
s
 = 
¬¿y
[j + 
size
 - 
N
].s;

153 ; 
i
 < 
size
; i++) {

154 
r
 = 
	`vec_»cursiÚ
(
¬¿y
[
i
 - 
N
].
s
,‡¼ay[˜+ 
POS1
 - N].s, 
r1
, 
r2
);

155 
¬¿y
[
i
].
s
 = 
r
;

156 
ùx
->
sfmt
[
j
++].
s
 = 
r
;

157 
r1
 = 
r2
;

158 
r2
 = 
r
;

160 
	}
}

162 #iâdeà
ONLY64


163 #ià
defšed
(
__APPLE__
)

164 
	#ALTI_SWAP
 (
veùÜ
 ) \

165 (4, 5, 6, 7, 0, 1, 2, 3, 12, 13, 14, 15, 8, 9, 10, 11)

	)

167 
	#ALTI_SWAP
 {4, 5, 6, 7, 0, 1, 2, 3, 12, 13, 14, 15, 8, 9, 10, 11}

	)

176 
JEMALLOC_INLINE
 
	$sw­
(
w128_t
 *
¬¿y
, 
size
) {

177 
i
;

178 cÚ¡ 
veùÜ
 
³rm
 = 
ALTI_SWAP
;

180 
i
 = 0; i < 
size
; i++) {

181 
¬¿y
[
i
].
s
 = 
	`vec_³rm
×¼ay[i].s, (
veùÜ
 )
³rm
,…erm);

183 
	}
}

	@deps/jemalloc/test/include/test/SFMT-params.h

36 #iâdeà
SFMT_PARAMS_H


37 
	#SFMT_PARAMS_H


	)

39 #ià!
defšed
(
MEXP
)

40 #ifdeà
__GNUC__


43 
	#MEXP
 19937

	)

53 
	#N
 (
MEXP
 / 128 + 1)

	)

56 
	#N32
 (
N
 * 4)

	)

59 
	#N64
 (
N
 * 2)

	)

102 #ià
MEXP
 == 607

103 
	~"‹¡/SFMT-·¿ms607.h
"

104 #–ià
MEXP
 == 1279

105 
	~"‹¡/SFMT-·¿ms1279.h
"

106 #–ià
MEXP
 == 2281

107 
	~"‹¡/SFMT-·¿ms2281.h
"

108 #–ià
MEXP
 == 4253

109 
	~"‹¡/SFMT-·¿ms4253.h
"

110 #–ià
MEXP
 == 11213

111 
	~"‹¡/SFMT-·¿ms11213.h
"

112 #–ià
MEXP
 == 19937

113 
	~"‹¡/SFMT-·¿ms19937.h
"

114 #–ià
MEXP
 == 44497

115 
	~"‹¡/SFMT-·¿ms44497.h
"

116 #–ià
MEXP
 == 86243

117 
	~"‹¡/SFMT-·¿ms86243.h
"

118 #–ià
MEXP
 == 132049

119 
	~"‹¡/SFMT-·¿ms132049.h
"

120 #–ià
MEXP
 == 216091

121 
	~"‹¡/SFMT-·¿ms216091.h
"

123 #ifdeà
__GNUC__


125 #undeà
MEXP


127 #undeà
MEXP


	@deps/jemalloc/test/include/test/SFMT-params11213.h

36 #iâdeà
SFMT_PARAMS11213_H


37 
	#SFMT_PARAMS11213_H


	)

39 
	#POS1
 68

	)

40 
	#SL1
 14

	)

41 
	#SL2
 3

	)

42 
	#SR1
 7

	)

43 
	#SR2
 3

	)

44 
	#MSK1
 0xeffff7fbU

	)

45 
	#MSK2
 0xfffffãfU

	)

46 
	#MSK3
 0xdfdfbfffU

	)

47 
	#MSK4
 0x7fffdbfdU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0xe8148000U

	)

51 
	#PARITY4
 0xd0c7aç3U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10}

	)

75 
	#ALTI_SL2_PERM64
 {3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2}

	)

76 
	#ALTI_SR2_PERM
 {5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12}

	)

77 
	#ALTI_SR2_PERM64
 {13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12}

	)

79 
	#IDSTR
 "SFMT-11213:68-14-3-7-3:effff7fb-fffffãf-dfdfbfff-7fffdbfd"

	)

	@deps/jemalloc/test/include/test/SFMT-params1279.h

36 #iâdeà
SFMT_PARAMS1279_H


37 
	#SFMT_PARAMS1279_H


	)

39 
	#POS1
 7

	)

40 
	#SL1
 14

	)

41 
	#SL2
 3

	)

42 
	#SR1
 5

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xf7ãfffdU

	)

45 
	#MSK2
 0x7ãfcfffU

	)

46 
	#MSK3
 0xaff3ef3fU

	)

47 
	#MSK4
 0xb5ffff7fU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0x00000000U

	)

51 
	#PARITY4
 0x20000000U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10}

	)

75 
	#ALTI_SL2_PERM64
 {3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-1279:7-14-3-5-1:f7ãfffd-7ãfcfff-aff3ef3f-b5ffff7f"

	)

	@deps/jemalloc/test/include/test/SFMT-params132049.h

36 #iâdeà
SFMT_PARAMS132049_H


37 
	#SFMT_PARAMS132049_H


	)

39 
	#POS1
 110

	)

40 
	#SL1
 19

	)

41 
	#SL2
 1

	)

42 
	#SR1
 21

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xffffbb5fU

	)

45 
	#MSK2
 0xfb6ebf95U

	)

46 
	#MSK3
 0xffãffçU

	)

47 
	#MSK4
 0xcff77fffU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0xcb520000U

	)

51 
	#PARITY4
 0xc7e91c7dU

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8}

	)

75 
	#ALTI_SL2_PERM64
 {1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-132049:110-19-1-21-1:ffffbb5f-fb6ebf95-ffãffç-cff77fff"

	)

	@deps/jemalloc/test/include/test/SFMT-params19937.h

36 #iâdeà
SFMT_PARAMS19937_H


37 
	#SFMT_PARAMS19937_H


	)

39 
	#POS1
 122

	)

40 
	#SL1
 18

	)

41 
	#SL2
 1

	)

42 
	#SR1
 11

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xdffffãfU

	)

45 
	#MSK2
 0xddãcb7fU

	)

46 
	#MSK3
 0xbfçffffU

	)

47 
	#MSK4
 0xbffffff6U

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0x00000000U

	)

51 
	#PARITY4
 0x13c9e684U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8}

	)

75 
	#ALTI_SL2_PERM64
 {1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-19937:122-18-1-11-1:dffffãf-ddãcb7f-bfçffff-bffffff6"

	)

	@deps/jemalloc/test/include/test/SFMT-params216091.h

36 #iâdeà
SFMT_PARAMS216091_H


37 
	#SFMT_PARAMS216091_H


	)

39 
	#POS1
 627

	)

40 
	#SL1
 11

	)

41 
	#SL2
 3

	)

42 
	#SR1
 10

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xbff7bff7U

	)

45 
	#MSK2
 0xbfffffffU

	)

46 
	#MSK3
 0xbfffç7fU

	)

47 
	#MSK4
 0xffddfbfbU

	)

48 
	#PARITY1
 0xf8000001U

	)

49 
	#PARITY2
 0x89e80709U

	)

50 
	#PARITY3
 0x3bd2b64bU

	)

51 
	#PARITY4
 0x0c64b1e4U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10}

	)

75 
	#ALTI_SL2_PERM64
 {3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-216091:627-11-3-10-1:bff7bff7-bfffffff-bfffç7f-ffddfbfb"

	)

	@deps/jemalloc/test/include/test/SFMT-params2281.h

36 #iâdeà
SFMT_PARAMS2281_H


37 
	#SFMT_PARAMS2281_H


	)

39 
	#POS1
 12

	)

40 
	#SL1
 19

	)

41 
	#SL2
 1

	)

42 
	#SR1
 5

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xbff7ffbfU

	)

45 
	#MSK2
 0xfdffffãU

	)

46 
	#MSK3
 0xf7fãf7fU

	)

47 
	#MSK4
 0xf2f7cbbfU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0x00000000U

	)

51 
	#PARITY4
 0x41dç600U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8}

	)

75 
	#ALTI_SL2_PERM64
 {1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-2281:12-19-1-5-1:bff7ffbf-fdffffã-f7fãf7f-f2f7cbbf"

	)

	@deps/jemalloc/test/include/test/SFMT-params4253.h

36 #iâdeà
SFMT_PARAMS4253_H


37 
	#SFMT_PARAMS4253_H


	)

39 
	#POS1
 17

	)

40 
	#SL1
 20

	)

41 
	#SL2
 1

	)

42 
	#SR1
 7

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0x9f7bffffU

	)

45 
	#MSK2
 0x9fffff5fU

	)

46 
	#MSK3
 0x3efffffbU

	)

47 
	#MSK4
 0xfffff7bbU

	)

48 
	#PARITY1
 0xa8000001U

	)

49 
	#PARITY2
 0xaf5390a3U

	)

50 
	#PARITY3
 0xb740b3f8U

	)

51 
	#PARITY4
 0x6c11486dU

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {1,2,3,23,5,6,7,0,9,10,11,4,13,14,15,8}

	)

75 
	#ALTI_SL2_PERM64
 {1,2,3,4,5,6,7,31,9,10,11,12,13,14,15,0}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-4253:17-20-1-7-1:9f7bffff-9fffff5f-3efffffb-fffff7bb"

	)

	@deps/jemalloc/test/include/test/SFMT-params44497.h

36 #iâdeà
SFMT_PARAMS44497_H


37 
	#SFMT_PARAMS44497_H


	)

39 
	#POS1
 330

	)

40 
	#SL1
 5

	)

41 
	#SL2
 3

	)

42 
	#SR1
 9

	)

43 
	#SR2
 3

	)

44 
	#MSK1
 0xeffffffbU

	)

45 
	#MSK2
 0xdfbebfffU

	)

46 
	#MSK3
 0xbfbf7befU

	)

47 
	#MSK4
 0x9ffd7bffU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0xa3ac4000U

	)

51 
	#PARITY4
 0xecc1327aU

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10}

	)

75 
	#ALTI_SL2_PERM64
 {3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2}

	)

76 
	#ALTI_SR2_PERM
 {5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12}

	)

77 
	#ALTI_SR2_PERM64
 {13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12}

	)

79 
	#IDSTR
 "SFMT-44497:330-5-3-9-3:effffffb-dfbebfff-bfbf7bef-9ffd7bff"

	)

	@deps/jemalloc/test/include/test/SFMT-params607.h

36 #iâdeà
SFMT_PARAMS607_H


37 
	#SFMT_PARAMS607_H


	)

39 
	#POS1
 2

	)

40 
	#SL1
 15

	)

41 
	#SL2
 3

	)

42 
	#SR1
 13

	)

43 
	#SR2
 3

	)

44 
	#MSK1
 0xfdff37ffU

	)

45 
	#MSK2
 0xef7f3f7dU

	)

46 
	#MSK3
 0xff777b7dU

	)

47 
	#MSK4
 0x7ff7fb2fU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0x00000000U

	)

51 
	#PARITY4
 0x5986f054U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {3,21,21,21,7,0,1,2,11,4,5,6,15,8,9,10}

	)

75 
	#ALTI_SL2_PERM64
 {3,4,5,6,7,29,29,29,11,12,13,14,15,0,1,2}

	)

76 
	#ALTI_SR2_PERM
 {5,6,7,0,9,10,11,4,13,14,15,8,19,19,19,12}

	)

77 
	#ALTI_SR2_PERM64
 {13,14,15,0,1,2,3,4,19,19,19,8,9,10,11,12}

	)

79 
	#IDSTR
 "SFMT-607:2-15-3-13-3:fdff37ff-ef7f3f7d-ff777b7d-7ff7fb2f"

	)

	@deps/jemalloc/test/include/test/SFMT-params86243.h

36 #iâdeà
SFMT_PARAMS86243_H


37 
	#SFMT_PARAMS86243_H


	)

39 
	#POS1
 366

	)

40 
	#SL1
 6

	)

41 
	#SL2
 7

	)

42 
	#SR1
 19

	)

43 
	#SR2
 1

	)

44 
	#MSK1
 0xfdbffbffU

	)

45 
	#MSK2
 0xbff7ff3fU

	)

46 
	#MSK3
 0xfd77efffU

	)

47 
	#MSK4
 0xbf9ff3ffU

	)

48 
	#PARITY1
 0x00000001U

	)

49 
	#PARITY2
 0x00000000U

	)

50 
	#PARITY3
 0x00000000U

	)

51 
	#PARITY4
 0xe9528d85U

	)

55 #ià
defšed
(
__APPLE__
)

56 
	#ALTI_SL1
 (
veùÜ
 )(
SL1
, SL1, SL1, SL1)

	)

57 
	#ALTI_SR1
 (
veùÜ
 )(
SR1
, SR1, SR1, SR1)

	)

58 
	#ALTI_MSK
 (
veùÜ
 )(
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
)

	)

59 
	#ALTI_MSK64
 \

60 (
veùÜ
 )(
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
)

	)

61 
	#ALTI_SL2_PERM
 \

62 (
veùÜ
 )(25,25,25,25,3,25,25,25,7,0,1,2,11,4,5,6)

	)

63 
	#ALTI_SL2_PERM64
 \

64 (
veùÜ
 )(7,25,25,25,25,25,25,25,15,0,1,2,3,4,5,6)

	)

65 
	#ALTI_SR2_PERM
 \

66 (
veùÜ
 )(7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14)

	)

67 
	#ALTI_SR2_PERM64
 \

68 (
veùÜ
 )(15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14)

	)

70 
	#ALTI_SL1
 {
SL1
, SL1, SL1, SL1}

	)

71 
	#ALTI_SR1
 {
SR1
, SR1, SR1, SR1}

	)

72 
	#ALTI_MSK
 {
MSK1
, 
MSK2
, 
MSK3
, 
MSK4
}

	)

73 
	#ALTI_MSK64
 {
MSK2
, 
MSK1
, 
MSK4
, 
MSK3
}

	)

74 
	#ALTI_SL2_PERM
 {25,25,25,25,3,25,25,25,7,0,1,2,11,4,5,6}

	)

75 
	#ALTI_SL2_PERM64
 {7,25,25,25,25,25,25,25,15,0,1,2,3,4,5,6}

	)

76 
	#ALTI_SR2_PERM
 {7,0,1,2,11,4,5,6,15,8,9,10,17,12,13,14}

	)

77 
	#ALTI_SR2_PERM64
 {15,0,1,2,3,4,5,6,17,8,9,10,11,12,13,14}

	)

79 
	#IDSTR
 "SFMT-86243:366-6-7-19-1:fdbffbff-bff7ff3f-fd77efff-bf9ff3ff"

	)

	@deps/jemalloc/test/include/test/SFMT-sse2.h

51 #iâdeà
SFMT_SSE2_H


52 
	#SFMT_SSE2_H


	)

63 
JEMALLOC_ALWAYS_INLINE
 
__m128i
 
	$mm_»cursiÚ
(
__m128i
 *
a
, __m128˜*
b
,

64 
__m128i
 
c
, __m128˜
d
, __m128˜
mask
) {

65 
__m128i
 
v
, 
x
, 
y
, 
z
;

67 
x
 = 
	`_mm_lßd_si128
(
a
);

68 
y
 = 
	`_mm_¤li_•i32
(*
b
, 
SR1
);

69 
z
 = 
	`_mm_¤li_si128
(
c
, 
SR2
);

70 
v
 = 
	`_mm_¦li_•i32
(
d
, 
SL1
);

71 
z
 = 
	`_mm_xÜ_si128
(z, 
x
);

72 
z
 = 
	`_mm_xÜ_si128
(z, 
v
);

73 
x
 = 
	`_mm_¦li_si128
(x, 
SL2
);

74 
y
 = 
	`_mm_ªd_si128
(y, 
mask
);

75 
z
 = 
	`_mm_xÜ_si128
(z, 
x
);

76 
z
 = 
	`_mm_xÜ_si128
(z, 
y
);

77  
z
;

78 
	}
}

84 
JEMALLOC_INLINE
 
	$g’_¿nd_®l
(
sfmt_t
 *
ùx
) {

85 
i
;

86 
__m128i
 
r
, 
r1
, 
r2
, 
mask
;

87 
mask
 = 
	`_mm_£t_•i32
(
MSK4
, 
MSK3
, 
MSK2
, 
MSK1
);

89 
r1
 = 
	`_mm_lßd_si128
(&
ùx
->
sfmt
[
N
 - 2].
si
);

90 
r2
 = 
	`_mm_lßd_si128
(&
ùx
->
sfmt
[
N
 - 1].
si
);

91 
i
 = 0; i < 
N
 - 
POS1
; i++) {

92 
r
 = 
	`mm_»cursiÚ
(&
ùx
->
sfmt
[
i
].
si
, &ùx->sfmt[˜+ 
POS1
].si, 
r1
, 
r2
,

93 
mask
);

94 
	`_mm_¡Üe_si128
(&
ùx
->
sfmt
[
i
].
si
, 
r
);

95 
r1
 = 
r2
;

96 
r2
 = 
r
;

98 ; 
i
 < 
N
; i++) {

99 
r
 = 
	`mm_»cursiÚ
(&
ùx
->
sfmt
[
i
].
si
, &ùx->sfmt[˜+ 
POS1
 - 
N
].si, 
r1
, 
r2
,

100 
mask
);

101 
	`_mm_¡Üe_si128
(&
ùx
->
sfmt
[
i
].
si
, 
r
);

102 
r1
 = 
r2
;

103 
r2
 = 
r
;

105 
	}
}

114 
JEMALLOC_INLINE
 
	$g’_¿nd_¬¿y
(
sfmt_t
 *
ùx
, 
w128_t
 *
¬¿y
, 
size
) {

115 
i
, 
j
;

116 
__m128i
 
r
, 
r1
, 
r2
, 
mask
;

117 
mask
 = 
	`_mm_£t_•i32
(
MSK4
, 
MSK3
, 
MSK2
, 
MSK1
);

119 
r1
 = 
	`_mm_lßd_si128
(&
ùx
->
sfmt
[
N
 - 2].
si
);

120 
r2
 = 
	`_mm_lßd_si128
(&
ùx
->
sfmt
[
N
 - 1].
si
);

121 
i
 = 0; i < 
N
 - 
POS1
; i++) {

122 
r
 = 
	`mm_»cursiÚ
(&
ùx
->
sfmt
[
i
].
si
, &ùx->sfmt[˜+ 
POS1
].si, 
r1
, 
r2
,

123 
mask
);

124 
	`_mm_¡Üe_si128
(&
¬¿y
[
i
].
si
, 
r
);

125 
r1
 = 
r2
;

126 
r2
 = 
r
;

128 ; 
i
 < 
N
; i++) {

129 
r
 = 
	`mm_»cursiÚ
(&
ùx
->
sfmt
[
i
].
si
, &
¬¿y
[˜+ 
POS1
 - 
N
].si, 
r1
, 
r2
,

130 
mask
);

131 
	`_mm_¡Üe_si128
(&
¬¿y
[
i
].
si
, 
r
);

132 
r1
 = 
r2
;

133 
r2
 = 
r
;

136 ; 
i
 < 
size
 - 
N
; i++) {

137 
r
 = 
	`mm_»cursiÚ
(&
¬¿y
[
i
 - 
N
].
si
, &¬¿y[˜+ 
POS1
 - N].si, 
r1
, 
r2
,

138 
mask
);

139 
	`_mm_¡Üe_si128
(&
¬¿y
[
i
].
si
, 
r
);

140 
r1
 = 
r2
;

141 
r2
 = 
r
;

143 
j
 = 0; j < 2 * 
N
 - 
size
; j++) {

144 
r
 = 
	`_mm_lßd_si128
(&
¬¿y
[
j
 + 
size
 - 
N
].
si
);

145 
	`_mm_¡Üe_si128
(&
ùx
->
sfmt
[
j
].
si
, 
r
);

147 ; 
i
 < 
size
; i++) {

148 
r
 = 
	`mm_»cursiÚ
(&
¬¿y
[
i
 - 
N
].
si
, &¬¿y[˜+ 
POS1
 - N].si, 
r1
, 
r2
,

149 
mask
);

150 
	`_mm_¡Üe_si128
(&
¬¿y
[
i
].
si
, 
r
);

151 
	`_mm_¡Üe_si128
(&
ùx
->
sfmt
[
j
++].
si
, 
r
);

152 
r1
 = 
r2
;

153 
r2
 = 
r
;

155 
	}
}

	@deps/jemalloc/test/include/test/SFMT.h

66 #iâdeà
SFMT_H


67 
	#SFMT_H


	)

69 
sfmt_s
 
	tsfmt_t
;

71 
ušt32_t
 
g’_¿nd32
(
sfmt_t
 *
ùx
);

72 
ušt32_t
 
g’_¿nd32_¿nge
(
sfmt_t
 *
ùx
, ušt32_ˆ
lim™
);

73 
ušt64_t
 
g’_¿nd64
(
sfmt_t
 *
ùx
);

74 
ušt64_t
 
g’_¿nd64_¿nge
(
sfmt_t
 *
ùx
, ušt64_ˆ
lim™
);

75 
fl_¬¿y32
(
sfmt_t
 *
ùx
, 
ušt32_t
 *
¬¿y
, 
size
);

76 
fl_¬¿y64
(
sfmt_t
 *
ùx
, 
ušt64_t
 *
¬¿y
, 
size
);

77 
sfmt_t
 *
š™_g’_¿nd
(
ušt32_t
 
£ed
);

78 
sfmt_t
 *
š™_by_¬¿y
(
ušt32_t
 *
š™_key
, 
key_Ëngth
);

79 
fši_g’_¿nd
(
sfmt_t
 *
ùx
);

80 cÚ¡ *
g‘_id¡ršg
();

81 
g‘_mš_¬¿y_size32
();

82 
g‘_mš_¬¿y_size64
();

84 #iâdeà
JEMALLOC_ENABLE_INLINE


85 
to_»®1
(
ušt32_t
 
v
);

86 
g’¿nd_»®1
(
sfmt_t
 *
ùx
);

87 
to_»®2
(
ušt32_t
 
v
);

88 
g’¿nd_»®2
(
sfmt_t
 *
ùx
);

89 
to_»®3
(
ušt32_t
 
v
);

90 
g’¿nd_»®3
(
sfmt_t
 *
ùx
);

91 
to_»s53
(
ušt64_t
 
v
);

92 
to_»s53_mix
(
ušt32_t
 
x
, ušt32_ˆ
y
);

93 
g’¿nd_»s53
(
sfmt_t
 *
ùx
);

94 
g’¿nd_»s53_mix
(
sfmt_t
 *
ùx
);

97 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
SFMT_C_
))

100 
JEMALLOC_INLINE
 
	$to_»®1
(
ušt32_t
 
v
)

102  
v
 * (1.0/4294967295.0);

104 
	}
}

107 
JEMALLOC_INLINE
 
	$g’¿nd_»®1
(
sfmt_t
 *
ùx
)

109  
	`to_»®1
(
	`g’_¿nd32
(
ùx
));

110 
	}
}

113 
JEMALLOC_INLINE
 
	$to_»®2
(
ušt32_t
 
v
)

115  
v
 * (1.0/4294967296.0);

117 
	}
}

120 
JEMALLOC_INLINE
 
	$g’¿nd_»®2
(
sfmt_t
 *
ùx
)

122  
	`to_»®2
(
	`g’_¿nd32
(
ùx
));

123 
	}
}

126 
JEMALLOC_INLINE
 
	$to_»®3
(
ušt32_t
 
v
)

128  ((()
v
) + 0.5)*(1.0/4294967296.0);

130 
	}
}

133 
JEMALLOC_INLINE
 
	$g’¿nd_»®3
(
sfmt_t
 *
ùx
)

135  
	`to_»®3
(
	`g’_¿nd32
(
ùx
));

136 
	}
}

140 
JEMALLOC_INLINE
 
	$to_»s53
(
ušt64_t
 
v
)

142  
v
 * (1.0/18446744073709551616.0L);

143 
	}
}

147 
JEMALLOC_INLINE
 
	$to_»s53_mix
(
ušt32_t
 
x
, ušt32_ˆ
y
)

149  
	`to_»s53
(
x
 | ((
ušt64_t
)
y
 << 32));

150 
	}
}

154 
JEMALLOC_INLINE
 
	$g’¿nd_»s53
(
sfmt_t
 *
ùx
)

156  
	`to_»s53
(
	`g’_¿nd64
(
ùx
));

157 
	}
}

162 
JEMALLOC_INLINE
 
	$g’¿nd_»s53_mix
(
sfmt_t
 *
ùx
)

164 
ušt32_t
 
x
, 
y
;

166 
x
 = 
	`g’_¿nd32
(
ùx
);

167 
y
 = 
	`g’_¿nd32
(
ùx
);

168  
	`to_»s53_mix
(
x
, 
y
);

169 
	}
}

	@deps/jemalloc/test/include/test/btalloc.h

2 *
bÎoc
(
size_t
 
size
, 
b™s
);

4 
	#bÎoc_n_´Ùo
(
n
) \

5 *
bÎoc_
##
	`n
(
size_t
 
size
, 
b™s
);

	)

6 
	$bÎoc_n_´Ùo
(0)

7 
	$bÎoc_n_´Ùo
(1)

9 
	#bÎoc_n_g’
(
n
) \

11 
bÎoc_
##
	`n
(
size_t
 
size
, 
b™s
) \

13 *
p
; \

15 ià(
b™s
 == 0) \

16 
p
 = 
	`m®locx
(
size
, 0); \

18 
b™s
 & 0x1U) { \

20 
p
 = (
	`bÎoc_0
(
size
, 
b™s
 >> 1)); \

23 
p
 = (
	`bÎoc_1
(
size
, 
b™s
 >> 1)); \

25 : 
	`nÙ_»ached
(); \

29 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure"); \

30  (
p
); \

31 
	}

	)
}

	@deps/jemalloc/test/include/test/jemalloc_test.h

1 
	~<lim™s.h
>

2 #iâdeà
SIZE_T_MAX


3 
	#SIZE_T_MAX
 
SIZE_MAX


	)

5 
	~<¡dlib.h
>

6 
	~<¡d¬g.h
>

7 
	~<¡dboŞ.h
>

8 
	~<”ºo.h
>

9 
	~<m©h.h
>

10 
	~<¡ršg.h
>

11 #ifdeà
_WIN32


12 
	~"msvc_com·t/¡ršgs.h
"

14 
	~<sys/time.h
>

16 #ifdeà
_WIN32


17 
	~<wšdows.h
>

18 
	~"msvc_com·t/wšdows_exŒa.h
"

20 
	~<±h»ad.h
>

29 
	#as£¹
(
e
) do { \

30 ià(!(
e
)) { \

31 
	`m®loc_´štf
( \

33 
__FILE__
, 
__LINE__
, #e); \

34 
	`abÜt
(); \

36 } 0)

	)

38 
	#nÙ_»ached
() do { \

39 
	`m®loc_´štf
( \

41 
__FILE__
, 
__LINE__
); \

42 
	`abÜt
(); \

43 } 0)

	)

45 
	#nÙ_im¶em’‹d
() do { \

46 
	`m®loc_´štf
("<jemalloc>: %s:%d: Not implemented\n", \

47 
__FILE__
, 
__LINE__
); \

48 
	`abÜt
(); \

49 } 0)

	)

51 
	#as£¹_nÙ_im¶em’‹d
(
e
) do { \

52 ià(!(
e
)) \

53 
	`nÙ_im¶em’‹d
(); \

54 } 0)

	)

56 
	~"‹¡/jem®loc_‹¡_defs.h
"

58 #ifdeà
JEMALLOC_OSSPIN


59 
	~<libk”n/OSAtomic.h
>

62 #ià
defšed
(
HAVE_ALTIVEC
è&& !defšed(
__APPLE__
)

63 
	~<®tivec.h
>

65 #ifdeà
HAVE_SSE2


66 
	~<emmšŒš.h
>

73 #ifdeà
JEMALLOC_UNIT_TEST


74 
	#JEMALLOC_JET


	)

75 
	#JEMALLOC_MANGLE


	)

76 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

84 #–ià
defšed
(
JEMALLOC_INTEGRATION_TEST
)

85 
	#JEMALLOC_MANGLE


	)

86 
	~"jem®loc/jem®loc.h
"

87 
	~"jem®loc/š‹º®/jem®loc_š‹º®_defs.h
"

88 
	~"jem®loc/š‹º®/jem®loc_š‹º®_maüos.h
"

90 
	#JEMALLOC_N
(
n
è
je_
##
	)
n

91 
	~"jem®loc/š‹º®/´iv©e_Çme¥aû.h
"

93 
	#JEMALLOC_H_TYPES


	)

94 
	#JEMALLOC_H_STRUCTS


	)

95 
	#JEMALLOC_H_EXTERNS


	)

96 
	#JEMALLOC_H_INLINES


	)

97 
	~"jem®loc/š‹º®/ut.h
"

98 
	~"jem®loc/š‹º®/qr.h
"

99 
	~"jem®loc/š‹º®/ql.h
"

100 #undeà
JEMALLOC_H_TYPES


101 #undeà
JEMALLOC_H_STRUCTS


102 #undeà
JEMALLOC_H_EXTERNS


103 #undeà
JEMALLOC_H_INLINES


112 #–ià
defšed
(
JEMALLOC_STRESS_TEST
)

113 
	~"jem®loc/jem®loc.h
"

115 
	~"jem®loc/jem®loc_´Ùos_j‘.h
"

117 
	#JEMALLOC_JET


	)

118 
	~"jem®loc/š‹º®/jem®loc_š‹º®.h
"

119 
	~"jem®loc/š‹º®/public_uÂame¥aû.h
"

120 #undeà
JEMALLOC_JET


122 
	~"jem®loc/jem®loc_»Çme.h
"

123 
	#JEMALLOC_MANGLE


	)

124 #ifdeà
JEMALLOC_STRESS_TESTLIB


125 
	~"jem®loc/jem®loc_mªgË_j‘.h
"

127 
	~"jem®loc/jem®loc_mªgË.h
"

143 
	~"‹¡/bÎoc.h
"

144 
	~"‹¡/m©h.h
"

145 
	~"‹¡/mtx.h
"

146 
	~"‹¡/mq.h
"

147 
	~"‹¡/‹¡.h
"

148 
	~"‹¡/tim”.h
"

149 
	~"‹¡/thd.h
"

150 
	#MEXP
 19937

	)

151 
	~"‹¡/SFMT.h
"

	@deps/jemalloc/test/include/test/jemalloc_test_defs.h

2 
	~"jem®loc/š‹º®/jem®loc_š‹º®_defs.h
"

3 
	~"jem®loc/š‹º®/jem®loc_š‹º®_deşs.h
"

	@deps/jemalloc/test/include/test/math.h

1 #iâdeà
JEMALLOC_ENABLE_INLINE


2 
Ê_gamma
(
x
);

3 
i_gamma
(
x
, 
p
, 
Ê_gamma_p
);

4 
±_nÜm
(
p
);

5 
±_chi2
(
p
, 
df
, 
Ê_gamma_df_2
);

6 
±_gamma
(
p
, 
sh­e
, 
sÿË
, 
Ê_gamma_sh­e
);

9 #ià(
defšed
(
JEMALLOC_ENABLE_INLINE
è|| defšed(
MATH_C_
))

18 
JEMALLOC_INLINE
 

19 
	$Ê_gamma
(
x
)

21 
f
, 
z
;

23 
	`as£¹
(
x
 > 0.0);

25 ià(
x
 < 7.0) {

26 
f
 = 1.0;

27 
z
 = 
x
;

28 
z
 < 7.0) {

29 
f
 *ğ
z
;

30 
z
 += 1.0;

32 
x
 = 
z
;

33 
f
 = -
	`log
(f);

35 
f
 = 0.0;

37 
z
 = 1.0 / (
x
 * x);

39  (
f
 + (
x
-0.5è* 
	`log
(x) - x + 0.918938533204673 +

40 (((-0.000595238095238 * 
z
 + 0.000793650793651) * z -

41 0.002777777777778è* 
z
 + 0.083333333333333è/ 
x
);

42 
	}
}

53 
JEMALLOC_INLINE
 

54 
	$i_gamma
(
x
, 
p
, 
Ê_gamma_p
)

56 
acu
, 
çùÜ
, 
oæo
, 
gš
, 
‹rm
, 
º
, 
a
, 
b
, 
ª
, 
dif
;

57 
²
[6];

58 
i
;

60 
	`as£¹
(
p
 > 0.0);

61 
	`as£¹
(
x
 >= 0.0);

63 ià(
x
 == 0.0)

66 
acu
 = 1.0e-10;

67 
oæo
 = 1.0e30;

68 
gš
 = 0.0;

69 
çùÜ
 = 
	`exp
(
p
 * 
	`log
(
x
è- x - 
Ê_gamma_p
);

71 ià(
x
 <ğ1.0 || x < 
p
) {

73 
gš
 = 1.0;

74 
‹rm
 = 1.0;

75 
º
 = 
p
;

77 
Œue
) {

78 
º
 += 1.0;

79 
‹rm
 *ğ
x
 / 
º
;

80 
gš
 +ğ
‹rm
;

81 ià(
‹rm
 <ğ
acu
) {

82 
gš
 *ğ
çùÜ
 / 
p
;

83  (
gš
);

88 
a
 = 1.0 - 
p
;

89 
b
 = 
a
 + 
x
 + 1.0;

90 
‹rm
 = 0.0;

91 
²
[0] = 1.0;

92 
²
[1] = 
x
;

93 
²
[2] = 
x
 + 1.0;

94 
²
[3] = 
x
 * 
b
;

95 
gš
 = 
²
[2] /…n[3];

97 
Œue
) {

98 
a
 += 1.0;

99 
b
 += 2.0;

100 
‹rm
 += 1.0;

101 
ª
 = 
a
 * 
‹rm
;

102 
i
 = 0; i < 2; i++)

103 
²
[
i
+4] = 
b
 *…n[i+2] - 
ª
 *…n[i];

104 ià(
²
[5] != 0.0) {

105 
º
 = 
²
[4] /…n[5];

106 
dif
 = 
	`çbs
(
gš
 - 
º
);

107 ià(
dif
 <ğ
acu
 && dià<ğacu * 
º
) {

108 
gš
 = 1.0 - 
çùÜ
 * gin;

109  (
gš
);

111 
gš
 = 
º
;

113 
i
 = 0; i < 4; i++)

114 
²
[
i
] =…n[i+2];

116 ià(
	`çbs
(
²
[4]è>ğ
oæo
) {

117 
i
 = 0; i < 4; i++)

118 
²
[
i
] /ğ
oæo
;

122 
	}
}

134 
JEMALLOC_INLINE
 

135 
	$±_nÜm
(
p
)

137 
q
, 
r
, 
»t
;

139 
	`as£¹
(
p
 > 0.0 &&… < 1.0);

141 
q
 = 
p
 - 0.5;

142 ià(
	`çbs
(
q
) <= 0.425) {

144 
r
 = 0.180625 - 
q
 * q;

145  (
q
 * (((((((2.5090809287301226727e3 * 
r
 +

146 3.3430575583588128105e4è* 
r
 + 6.7265770927008700853e4) *„

147 + 4.5921953931549871457e4è* 
r
 + 1.3731693765509461125e4) *

148 
r
 + 1.9715909503065514427e3) *„ + 1.3314166789178437745e2)

149 * 
r
 + 3.3871328727963666080e0) /

150 (((((((5.2264952788528545610e3 * 
r
 +

151 2.8729085735721942674e4è* 
r
 + 3.9307895800092710610e4) *„

152 + 2.1213794301586595867e4è* 
r
 + 5.3941960214247511077e3) *

153 
r
 + 6.8718700749205790830e2) *„ + 4.2313330701600911252e1)

154 * 
r
 + 1.0));

156 ià(
q
 < 0.0)

157 
r
 = 
p
;

159 
r
 = 1.0 - 
p
;

160 
	`as£¹
(
r
 > 0.0);

162 
r
 = 
	`sq¹
(-
	`log
(r));

163 ià(
r
 <= 5.0) {

165 
r
 -= 1.6;

166 
»t
 = ((((((((7.74545014278341407640e-4 * 
r
 +

167 2.27238449892691845833e-2è* 
r
 +

168 2.41780725177450611770e-1è* 
r
 +

169 1.27045825245236838258e0è* 
r
 +

170 3.64784832476320460504e0è* 
r
 +

171 5.76949722146069140550e0è* 
r
 +

172 4.63033784615654529590e0è* 
r
 +

174 (((((((1.05075007164441684324e-9 * 
r
 +

175 5.47593808499534494600e-4è* 
r
 +

177 * 
r
 + 1.48103976427480074590e-1) *„ +

178 6.89767334985100004550e-1è* 
r
 +

179 1.67638483018380384940e0è* 
r
 +

180 2.05319162663775882187e0è* 
r
 + 1.0));

183 
r
 -= 5.0;

184 
»t
 = ((((((((2.01033439929228813265e-7 * 
r
 +

185 2.71155556874348757815e-5è* 
r
 +

186 1.24266094738807843860e-3è* 
r
 +

187 2.65321895265761230930e-2è* 
r
 +

188 2.96560571828504891230e-1è* 
r
 +

189 1.78482653991729133580e0è* 
r
 +

190 5.46378491116411436990e0è* 
r
 +

192 (((((((2.04426310338993978564e-15 * 
r
 +

193 1.42151175831644588870e-7è* 
r
 +

194 1.84631831751005468180e-5è* 
r
 +

195 7.86869131145613259100e-4è* 
r
 +

196 1.48753612908506148525e-2è* 
r
 +

197 1.36929880922735805310e-1è* 
r
 +

199 * 
r
 + 1.0));

201 ià(
q
 < 0.0)

202 
»t
 = -ret;

203  (
»t
);

205 
	}
}

221 
JEMALLOC_INLINE
 

222 
	$±_chi2
(
p
, 
df
, 
Ê_gamma_df_2
)

224 
e
, 
¯
, 
xx
, 
c
, 
ch
, 
a
, 
q
, 
p1
, 
p2
, 
t
, 
x
, 
b
, 
s1
, 
s2
, 
s3
, 
s4
, 
s5
, 
s6
;

225 
i
;

227 
	`as£¹
(
p
 >= 0.0 &&… < 1.0);

228 
	`as£¹
(
df
 > 0.0);

230 
e
 = 5.0e-7;

231 
¯
 = 0.6931471805;

233 
xx
 = 0.5 * 
df
;

234 
c
 = 
xx
 - 1.0;

236 ià(
df
 < -1.24 * 
	`log
(
p
)) {

238 
ch
 = 
	`pow
(
p
 * 
xx
 * 
	`exp
(
Ê_gamma_df_2
 + xx * 
¯
), 1.0 / xx);

239 ià(
ch
 - 
e
 < 0.0)

240  (
ch
);

242 ià(
df
 > 0.32) {

243 
x
 = 
	`±_nÜm
(
p
);

248 
p1
 = 0.222222 / 
df
;

249 
ch
 = 
df
 * 
	`pow
(
x
 * 
	`sq¹
(
p1
) + 1.0 -…1, 3.0);

251 ià(
ch
 > 2.2 * 
df
 + 6.0) {

252 
ch
 = -2.0 * (
	`log
(1.0 - 
p
è- 
c
 *†og(0.5 * ch) +

253 
Ê_gamma_df_2
);

256 
ch
 = 0.4;

257 
a
 = 
	`log
(1.0 - 
p
);

258 
Œue
) {

259 
q
 = 
ch
;

260 
p1
 = 1.0 + 
ch
 * (4.67 + ch);

261 
p2
 = 
ch
 * (6.73 + ch * (6.66 + ch));

262 
t
 = -0.5 + (4.67 + 2.0 * 
ch
è/ 
p1
 - (6.73 + ch

263 * (13.32 + 3.0 * 
ch
)è/ 
p2
;

264 
ch
 -ğ(1.0 - 
	`exp
(
a
 + 
Ê_gamma_df_2
 + 0.5 * ch +

265 
c
 * 
¯
è* 
p2
 / 
p1
è/ 
t
;

266 ià(
	`çbs
(
q
 / 
ch
 - 1.0) - 0.01 <= 0.0)

272 
i
 = 0; i < 20; i++) {

274 
q
 = 
ch
;

275 
p1
 = 0.5 * 
ch
;

276 ià(
p1
 < 0.0)

278 
p2
 = 
p
 - 
	`i_gamma
(
p1
, 
xx
, 
Ê_gamma_df_2
);

279 
t
 = 
p2
 * 
	`exp
(
xx
 * 
¯
 + 
Ê_gamma_df_2
 + 
p1
 - 
c
 * 
	`log
(
ch
));

280 
b
 = 
t
 / 
ch
;

281 
a
 = 0.5 * 
t
 - 
b
 * 
c
;

282 
s1
 = (210.0 + 
a
 * (140.0 +‡ * (105.0 +‡ * (84.0 +‡ * (70.0 +

283 60.0 * 
a
))))) / 420.0;

284 
s2
 = (420.0 + 
a
 * (735.0 +‡ * (966.0 +‡ * (1141.0 + 1278.0 *

285 
a
)))) / 2520.0;

286 
s3
 = (210.0 + 
a
 * (462.0 +‡ * (707.0 + 932.0 *‡))) / 2520.0;

287 
s4
 = (252.0 + 
a
 * (672.0 + 1182.0 *‡è+ 
c
 * (294.0 +‡ *

288 (889.0 + 1740.0 * 
a
))) / 5040.0;

289 
s5
 = (84.0 + 264.0 * 
a
 + 
c
 * (175.0 + 606.0 *‡)) / 2520.0;

290 
s6
 = (120.0 + 
c
 * (346.0 + 127.0 * c)) / 5040.0;

291 
ch
 +ğ
t
 * (1.0 + 0.5 * * 
s1
 - 
b
 * 
c
 * (s1 - b * (
s2
 - b * (
s3


292 - 
b
 * (
s4
 - b * (
s5
 - b * 
s6
))))));

293 ià(
	`çbs
(
q
 / 
ch
 - 1.0è<ğ
e
)

297  (
ch
);

298 
	}
}

305 
JEMALLOC_INLINE
 

306 
	$±_gamma
(
p
, 
sh­e
, 
sÿË
, 
Ê_gamma_sh­e
)

309  (
	`±_chi2
(
p
, 
sh­e
 * 2.0, 
Ê_gamma_sh­e
è* 0.5 * 
sÿË
);

310 
	}
}

	@deps/jemalloc/test/include/test/mq.h

1 
mq_Çno¦“p
(
ns
);

29 
	#mq_msg
(
a_mq_msg_ty³
è
	`ql_–m
×_mq_msg_ty³)

	)

31 
	#mq_g’
(
a_©Œ
, 
a_´efix
, 
a_mq_ty³
, 
a_mq_msg_ty³
, 
a_f›ld
) \

33 
mtx_t
 
lock
; \

34 
	`ql_h—d
(
a_mq_msg_ty³
è
msgs
; \

35 
couÁ
; \

36 } 
	ta_mq_ty³
; \

37 
a_©Œ
 
boŞ
 \

38 
a_´efix
##
	`š™
(
a_mq_ty³
 *
mq
) { \

40 ià(
	`mtx_š™
(&
mq
->
lock
)) \

41  (
Œue
); \

42 
	`ql_Ãw
(&
mq
->
msgs
); \

43 
mq
->
couÁ
 = 0; \

44  (
çl£
); \

46 
a_©Œ
 \

47 
a_´efix
##
	`fši
(
a_mq_ty³
 *
mq
) \

50 
	`mtx_fši
(&
mq
->
lock
); \

52 
a_©Œ
 \

53 
a_´efix
##
	`couÁ
(
a_mq_ty³
 *
mq
) \

55 
couÁ
; \

57 
	`mtx_lock
(&
mq
->
lock
); \

58 
couÁ
 = 
mq
->count; \

59 
	`mtx_uÆock
(&
mq
->
lock
); \

60  (
couÁ
); \

62 
a_©Œ
 
a_mq_msg_ty³
 * \

63 
a_´efix
##
	`Œyg‘
(
a_mq_ty³
 *
mq
) \

65 
a_mq_msg_ty³
 *
msg
; \

67 
	`mtx_lock
(&
mq
->
lock
); \

68 
msg
 = 
	`ql_fœ¡
(&
mq
->
msgs
); \

69 ià(
msg
 !ğ
NULL
) { \

70 
	`ql_h—d_»move
(&
mq
->
msgs
, 
a_mq_msg_ty³
, 
a_f›ld
); \

71 
mq
->
couÁ
--; \

73 
	`mtx_uÆock
(&
mq
->
lock
); \

74  (
msg
); \

76 
a_©Œ
 
a_mq_msg_ty³
 * \

77 
a_´efix
##
	`g‘
(
a_mq_ty³
 *
mq
) \

79 
a_mq_msg_ty³
 *
msg
; \

80 
ns
; \

82 
msg
 = 
a_´efix
##
	`Œyg‘
(
mq
); \

83 ià(
msg
 !ğ
NULL
) \

84  (
msg
); \

86 
ns
 = 1; \

87 
Œue
) { \

88 
	`mq_Çno¦“p
(
ns
); \

89 
msg
 = 
a_´efix
##
	`Œyg‘
(
mq
); \

90 ià(
msg
 !ğ
NULL
) \

91  (
msg
); \

92 ià(
ns
 < 1000*1000*1000) { \

94 
ns
 <<= 1; \

95 ià(
ns
 > 1000*1000*1000) \

96 
ns
 = 1000*1000*1000; \

100 
a_©Œ
 \

101 
a_´efix
##
	`put
(
a_mq_ty³
 *
mq
, 
a_mq_msg_ty³
 *
msg
) \

104 
	`mtx_lock
(&
mq
->
lock
); \

105 
	`ql_–m_Ãw
(
msg
, 
a_f›ld
); \

106 
	`ql__š£¹
(&
mq
->
msgs
, 
msg
, 
a_f›ld
); \

107 
mq
->
couÁ
++; \

108 
	`mtx_uÆock
(&
mq
->
lock
); \

109 }

	)

	@deps/jemalloc/test/include/test/mtx.h

9 #ifdeà
_WIN32


10 
CRITICAL_SECTION
 
	mlock
;

11 #–ià(
defšed
(
JEMALLOC_OSSPIN
))

12 
OSSpšLock
 
	mlock
;

14 
±h»ad_mu‹x_t
 
	mlock
;

16 } 
	tmtx_t
;

18 
boŞ
 
mtx_š™
(
mtx_t
 *
mtx
);

19 
mtx_fši
(
mtx_t
 *
mtx
);

20 
mtx_lock
(
mtx_t
 *
mtx
);

21 
mtx_uÆock
(
mtx_t
 *
mtx
);

	@deps/jemalloc/test/include/test/test.h

1 
	#ASSERT_BUFSIZE
 256

	)

3 
	#as£¹_cmp
(
t
, 
a
, 
b
, 
cmp
, 
Ãg_cmp
, 
´i
, ...) do { \

4 
t
 
a_
 = (
a
); \

5 
t
 
b_
 = (
b
); \

6 ià(!(
a_
 
cmp
 
b_
)) { \

7 
´efix
[
ASSERT_BUFSIZE
]; \

8 
mes§ge
[
ASSERT_BUFSIZE
]; \

9 
	`m®loc_¢´štf
(
´efix
, (prefix), \

12 "%"
´i
" "#neg_cmp" %"pri": ", \

13 
__func__
, 
__FILE__
, 
__LINE__
, \

14 #a, #b, 
a_
, 
b_
); \

15 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

16 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

18 } 0)

	)

20 
	#as£¹_±r_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(*,‡, b, ==, \

21 !=, "p", 
__VA_ARGS__
)

	)

22 
	#as£¹_±r_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(*,‡, b, !=, \

23 ==, "p", 
__VA_ARGS__
)

	)

24 
	#as£¹_±r_nuÎ
(
a
, ...è
	`as£¹_cmp
(*,‡, 
NULL
, ==, \

25 !=, "p", 
__VA_ARGS__
)

	)

26 
	#as£¹_±r_nÙ_nuÎ
(
a
, ...è
	`as£¹_cmp
(*,‡, 
NULL
, !=, \

27 ==, "p", 
__VA_ARGS__
)

	)

29 
	#as£¹_c_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, !=, "c", 
__VA_ARGS__
)

	)

30 
	#as£¹_c_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, ==, "c", 
__VA_ARGS__
)

	)

31 
	#as£¹_c_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, >=, "c", 
__VA_ARGS__
)

	)

32 
	#as£¹_c_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, >, "c", 
__VA_ARGS__
)

	)

33 
	#as£¹_c_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, <, "c", 
__VA_ARGS__
)

	)

34 
	#as£¹_c_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, <=, "c", 
__VA_ARGS__
)

	)

36 
	#as£¹_x_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, !=, "#x", 
__VA_ARGS__
)

	)

37 
	#as£¹_x_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, ==, "#x", 
__VA_ARGS__
)

	)

38 
	#as£¹_x_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, >=, "#x", 
__VA_ARGS__
)

	)

39 
	#as£¹_x_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, >, "#x", 
__VA_ARGS__
)

	)

40 
	#as£¹_x_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, <, "#x", 
__VA_ARGS__
)

	)

41 
	#as£¹_x_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, <=, "#x", 
__VA_ARGS__
)

	)

43 
	#as£¹_d_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, !=, "d", 
__VA_ARGS__
)

	)

44 
	#as£¹_d_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, ==, "d", 
__VA_ARGS__
)

	)

45 
	#as£¹_d_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, >=, "d", 
__VA_ARGS__
)

	)

46 
	#as£¹_d_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, >, "d", 
__VA_ARGS__
)

	)

47 
	#as£¹_d_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, <, "d", 
__VA_ARGS__
)

	)

48 
	#as£¹_d_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, <=, "d", 
__VA_ARGS__
)

	)

50 
	#as£¹_u_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, !=, "u", 
__VA_ARGS__
)

	)

51 
	#as£¹_u_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, ==, "u", 
__VA_ARGS__
)

	)

52 
	#as£¹_u_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, >=, "u", 
__VA_ARGS__
)

	)

53 
	#as£¹_u_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, >, "u", 
__VA_ARGS__
)

	)

54 
	#as£¹_u_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, <, "u", 
__VA_ARGS__
)

	)

55 
	#as£¹_u_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, <=, "u", 
__VA_ARGS__
)

	)

57 
	#as£¹_ld_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, \

58 !=, "ld", 
__VA_ARGS__
)

	)

59 
	#as£¹_ld_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, \

60 ==, "ld", 
__VA_ARGS__
)

	)

61 
	#as£¹_ld_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, \

62 >=, "ld", 
__VA_ARGS__
)

	)

63 
	#as£¹_ld_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, \

64 >, "ld", 
__VA_ARGS__
)

	)

65 
	#as£¹_ld_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, \

66 <, "ld", 
__VA_ARGS__
)

	)

67 
	#as£¹_ld_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, \

68 <=, "ld", 
__VA_ARGS__
)

	)

70 
	#as£¹_lu_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

71 
a
, 
b
, ==, !=, "lu", 
__VA_ARGS__
)

	)

72 
	#as£¹_lu_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

73 
a
, 
b
, !=, ==, "lu", 
__VA_ARGS__
)

	)

74 
	#as£¹_lu_É
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

75 
a
, 
b
, <, >=, "lu", 
__VA_ARGS__
)

	)

76 
	#as£¹_lu_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

77 
a
, 
b
, <=, >, "lu", 
__VA_ARGS__
)

	)

78 
	#as£¹_lu_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

79 
a
, 
b
, >=, <, "lu", 
__VA_ARGS__
)

	)

80 
	#as£¹_lu_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

81 
a
, 
b
, >, <=, "lu", 
__VA_ARGS__
)

	)

83 
	#as£¹_qd_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, ==, \

84 !=, "qd", 
__VA_ARGS__
)

	)

85 
	#as£¹_qd_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, !=, \

86 ==, "qd", 
__VA_ARGS__
)

	)

87 
	#as£¹_qd_É
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <, \

88 >=, "qd", 
__VA_ARGS__
)

	)

89 
	#as£¹_qd_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, <=, \

90 >, "qd", 
__VA_ARGS__
)

	)

91 
	#as£¹_qd_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >=, \

92 <, "qd", 
__VA_ARGS__
)

	)

93 
	#as£¹_qd_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(,‡, b, >, \

94 <=, "qd", 
__VA_ARGS__
)

	)

96 
	#as£¹_qu_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

97 
a
, 
b
, ==, !=, "qu", 
__VA_ARGS__
)

	)

98 
	#as£¹_qu_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

99 
a
, 
b
, !=, ==, "qu", 
__VA_ARGS__
)

	)

100 
	#as£¹_qu_É
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

101 
a
, 
b
, <, >=, "qu", 
__VA_ARGS__
)

	)

102 
	#as£¹_qu_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

103 
a
, 
b
, <=, >, "qu", 
__VA_ARGS__
)

	)

104 
	#as£¹_qu_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

105 
a
, 
b
, >=, <, "qu", 
__VA_ARGS__
)

	)

106 
	#as£¹_qu_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(, \

107 
a
, 
b
, >, <=, "qu", 
__VA_ARGS__
)

	)

109 
	#as£¹_jd_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, ==, \

110 !=, "jd", 
__VA_ARGS__
)

	)

111 
	#as£¹_jd_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, !=, \

112 ==, "jd", 
__VA_ARGS__
)

	)

113 
	#as£¹_jd_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, <, \

114 >=, "jd", 
__VA_ARGS__
)

	)

115 
	#as£¹_jd_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, <=, \

116 >, "jd", 
__VA_ARGS__
)

	)

117 
	#as£¹_jd_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, >=, \

118 <, "jd", 
__VA_ARGS__
)

	)

119 
	#as£¹_jd_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
štmax_t
,‡, b, >, \

120 <=, "jd", 
__VA_ARGS__
)

	)

122 
	#as£¹_ju_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, ==, \

123 !=, "ju", 
__VA_ARGS__
)

	)

124 
	#as£¹_ju_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, !=, \

125 ==, "ju", 
__VA_ARGS__
)

	)

126 
	#as£¹_ju_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, <, \

127 >=, "ju", 
__VA_ARGS__
)

	)

128 
	#as£¹_ju_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, <=, \

129 >, "ju", 
__VA_ARGS__
)

	)

130 
	#as£¹_ju_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, >=, \

131 <, "ju", 
__VA_ARGS__
)

	)

132 
	#as£¹_ju_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
uštmax_t
,‡, b, >, \

133 <=, "ju", 
__VA_ARGS__
)

	)

135 
	#as£¹_zd_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, ==, \

136 !=, "zd", 
__VA_ARGS__
)

	)

137 
	#as£¹_zd_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, !=, \

138 ==, "zd", 
__VA_ARGS__
)

	)

139 
	#as£¹_zd_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, <, \

140 >=, "zd", 
__VA_ARGS__
)

	)

141 
	#as£¹_zd_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, <=, \

142 >, "zd", 
__VA_ARGS__
)

	)

143 
	#as£¹_zd_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, >=, \

144 <, "zd", 
__VA_ARGS__
)

	)

145 
	#as£¹_zd_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
ssize_t
,‡, b, >, \

146 <=, "zd", 
__VA_ARGS__
)

	)

148 
	#as£¹_zu_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, ==, \

149 !=, "zu", 
__VA_ARGS__
)

	)

150 
	#as£¹_zu_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, !=, \

151 ==, "zu", 
__VA_ARGS__
)

	)

152 
	#as£¹_zu_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, <, \

153 >=, "zu", 
__VA_ARGS__
)

	)

154 
	#as£¹_zu_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, <=, \

155 >, "zu", 
__VA_ARGS__
)

	)

156 
	#as£¹_zu_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, >=, \

157 <, "zu", 
__VA_ARGS__
)

	)

158 
	#as£¹_zu_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
size_t
,‡, b, >, \

159 <=, "zu", 
__VA_ARGS__
)

	)

161 
	#as£¹_d32_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, ==, \

162 !=, 
FMTd32
, 
__VA_ARGS__
)

	)

163 
	#as£¹_d32_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, !=, \

164 ==, 
FMTd32
, 
__VA_ARGS__
)

	)

165 
	#as£¹_d32_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, <, \

166 >=, 
FMTd32
, 
__VA_ARGS__
)

	)

167 
	#as£¹_d32_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, <=, \

168 >, 
FMTd32
, 
__VA_ARGS__
)

	)

169 
	#as£¹_d32_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, >=, \

170 <, 
FMTd32
, 
__VA_ARGS__
)

	)

171 
	#as£¹_d32_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
št32_t
,‡, b, >, \

172 <=, 
FMTd32
, 
__VA_ARGS__
)

	)

174 
	#as£¹_u32_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, ==, \

175 !=, 
FMTu32
, 
__VA_ARGS__
)

	)

176 
	#as£¹_u32_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, !=, \

177 ==, 
FMTu32
, 
__VA_ARGS__
)

	)

178 
	#as£¹_u32_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, <, \

179 >=, 
FMTu32
, 
__VA_ARGS__
)

	)

180 
	#as£¹_u32_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, <=, \

181 >, 
FMTu32
, 
__VA_ARGS__
)

	)

182 
	#as£¹_u32_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, >=, \

183 <, 
FMTu32
, 
__VA_ARGS__
)

	)

184 
	#as£¹_u32_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt32_t
,‡, b, >, \

185 <=, 
FMTu32
, 
__VA_ARGS__
)

	)

187 
	#as£¹_d64_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, ==, \

188 !=, 
FMTd64
, 
__VA_ARGS__
)

	)

189 
	#as£¹_d64_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, !=, \

190 ==, 
FMTd64
, 
__VA_ARGS__
)

	)

191 
	#as£¹_d64_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, <, \

192 >=, 
FMTd64
, 
__VA_ARGS__
)

	)

193 
	#as£¹_d64_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, <=, \

194 >, 
FMTd64
, 
__VA_ARGS__
)

	)

195 
	#as£¹_d64_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, >=, \

196 <, 
FMTd64
, 
__VA_ARGS__
)

	)

197 
	#as£¹_d64_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
št64_t
,‡, b, >, \

198 <=, 
FMTd64
, 
__VA_ARGS__
)

	)

200 
	#as£¹_u64_eq
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, ==, \

201 !=, 
FMTu64
, 
__VA_ARGS__
)

	)

202 
	#as£¹_u64_Ã
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, !=, \

203 ==, 
FMTu64
, 
__VA_ARGS__
)

	)

204 
	#as£¹_u64_É
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, <, \

205 >=, 
FMTu64
, 
__VA_ARGS__
)

	)

206 
	#as£¹_u64_Ë
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, <=, \

207 >, 
FMTu64
, 
__VA_ARGS__
)

	)

208 
	#as£¹_u64_ge
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, >=, \

209 <, 
FMTu64
, 
__VA_ARGS__
)

	)

210 
	#as£¹_u64_gt
(
a
, 
b
, ...è
	`as£¹_cmp
(
ušt64_t
,‡, b, >, \

211 <=, 
FMTu64
, 
__VA_ARGS__
)

	)

213 
	#as£¹_b_eq
(
a
, 
b
, ...) do { \

214 
boŞ
 
a_
 = (
a
); \

215 
boŞ
 
b_
 = (
b
); \

216 ià(!(
a_
 =ğ
b_
)) { \

217 
´efix
[
ASSERT_BUFSIZE
]; \

218 
mes§ge
[
ASSERT_BUFSIZE
]; \

219 
	`m®loc_¢´štf
(
´efix
, (prefix), \

222 
__func__
, 
__FILE__
, 
__LINE__
, \

223 #a, #b, 
a_
 ? "true" : "false", \

224 
b_
 ? "true" : "false"); \

225 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

226 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

228 } 0)

	)

229 
	#as£¹_b_Ã
(
a
, 
b
, ...) do { \

230 
boŞ
 
a_
 = (
a
); \

231 
boŞ
 
b_
 = (
b
); \

232 ià(!(
a_
 !ğ
b_
)) { \

233 
´efix
[
ASSERT_BUFSIZE
]; \

234 
mes§ge
[
ASSERT_BUFSIZE
]; \

235 
	`m®loc_¢´štf
(
´efix
, (prefix), \

238 
__func__
, 
__FILE__
, 
__LINE__
, \

239 #a, #b, 
a_
 ? "true" : "false", \

240 
b_
 ? "true" : "false"); \

241 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

242 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

244 } 0)

	)

245 
	#as£¹_Œue
(
a
, ...è
	`as£¹_b_eq
×, 
Œue
, 
__VA_ARGS__
)

	)

246 
	#as£¹_çl£
(
a
, ...è
	`as£¹_b_eq
×, 
çl£
, 
__VA_ARGS__
)

	)

248 
	#as£¹_¡r_eq
(
a
, 
b
, ...) do { \

249 ià(
	`¡rcmp
((
a
), (
b
))) { \

250 
´efix
[
ASSERT_BUFSIZE
]; \

251 
mes§ge
[
ASSERT_BUFSIZE
]; \

252 
	`m®loc_¢´štf
(
´efix
, (prefix), \

256 
__func__
, 
__FILE__
, 
__LINE__
, #a, #b, 
a
, 
b
); \

257 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

258 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

260 } 0)

	)

261 
	#as£¹_¡r_Ã
(
a
, 
b
, ...) do { \

262 ià(!
	`¡rcmp
((
a
), (
b
))) { \

263 
´efix
[
ASSERT_BUFSIZE
]; \

264 
mes§ge
[
ASSERT_BUFSIZE
]; \

265 
	`m®loc_¢´štf
(
´efix
, (prefix), \

269 
__func__
, 
__FILE__
, 
__LINE__
, #a, #b, 
a
, 
b
); \

270 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

271 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

273 } 0)

	)

275 
	#as£¹_nÙ_»ached
(...) do { \

276 
´efix
[
ASSERT_BUFSIZE
]; \

277 
mes§ge
[
ASSERT_BUFSIZE
]; \

278 
	`m®loc_¢´štf
(
´efix
, (prefix), \

280 
__func__
, 
__FILE__
, 
__LINE__
); \

281 
	`m®loc_¢´štf
(
mes§ge
, (mes§ge), 
__VA_ARGS__
); \

282 
	`p_‹¡_ç
(
´efix
, 
mes§ge
); \

283 } 0)

	)

290 
	m‹¡_¡©us_·ss
 = 0,

291 
	m‹¡_¡©us_sk
 = 1,

292 
	m‹¡_¡©us_ç
 = 2,

294 
	m‹¡_¡©us_couÁ
 = 3

295 } 
	t‹¡_¡©us_t
;

297 (
	t‹¡_t
)();

299 
	#TEST_BEGIN
(
f
) \

301 
	`f
() \

303 
	`p_‹¡_š™
(#f);

	)

305 
	#TEST_END
 \

306 
Ïb–_‹¡_’d
; \

307 
Ïb–_‹¡_’d
: \

308 
	`p_‹¡_fši
(); \

309 
	}

	)
}

311 
	#‹¡
(...) \

312 
	`p_‹¡
(
__VA_ARGS__
, 
NULL
)

	)

314 
	#‹¡_sk_if
(
e
) do { \

315 ià(
e
) { \

316 
	`‹¡_sk
("%s:%s:%d: Test skipped: (%s)", \

317 
__func__
, 
__FILE__
, 
__LINE__
, #e); \

318 
Ïb–_‹¡_’d
; \

320 } 0)

	)

322 
	$‹¡_sk
(cÚ¡ *
fÜm©
, ...è
	`JEMALLOC_FORMAT_PRINTF
(1, 2);

323 
	$‹¡_ç
(cÚ¡ *
fÜm©
, ...è
	`JEMALLOC_FORMAT_PRINTF
(1, 2);

326 
‹¡_¡©us_t
 
	`p_‹¡
(
‹¡_t
 *
t
, ...);

327 
	`p_‹¡_š™
(cÚ¡ *
Çme
);

328 
	`p_‹¡_fši
();

329 
	`p_‹¡_ç
(cÚ¡ *
´efix
, cÚ¡ *
mes§ge
);

	@deps/jemalloc/test/include/test/thd.h

2 #ifdeà
_WIN32


3 
HANDLE
 
	tthd_t
;

5 
±h»ad_t
 
	tthd_t
;

8 
thd_ü—‹
(
thd_t
 *
thd
, *(*
´oc
)(*), *
¬g
);

9 
thd_još
(
thd_t
 
thd
, **
»t
);

	@deps/jemalloc/test/include/test/timer.h

3 
	~<uni¡d.h
>

4 
	~<sys/time.h
>

6 
	#JEMALLOC_CLOCK_GETTIME
 
	`defšed
(
_POSIX_MONOTONIC_CLOCK
) \

7 && 
_POSIX_MONOTONIC_CLOCK
 >ğ0

	)

10 #ifdeà
_WIN32


11 
FILETIME
 
	má0
;

12 
FILETIME
 
	má1
;

13 #–ià
JEMALLOC_CLOCK_GETTIME


14 
time¥ec
 
	mts0
;

15 
time¥ec
 
	mts1
;

16 
	mşock_id
;

18 
timev®
 
	mtv0
;

19 
timev®
 
	mtv1
;

21 } 
	ttimed–_t
;

23 
tim”_¡¬t
(
timed–_t
 *
tim”
);

24 
tim”_¡İ
(
timed–_t
 *
tim”
);

25 
ušt64_t
 
tim”_u£c
(cÚ¡ 
timed–_t
 *
tim”
);

26 
tim”_¿tio
(
timed–_t
 *
a
,imed–_ˆ*
b
, *
buf
, 
size_t
 
buæ’
);

	@deps/jemalloc/test/integration/MALLOCX_ARENA.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#NTHREADS
 10

	)

5 
boŞ
 
	ghave_dss
 =

6 #ifdeà
JEMALLOC_DSS


7 
Œue


9 
çl£


14 
	$thd_¡¬t
(*
¬g
)

16 
th»ad_šd
 = ()(
ušŒ_t
)
¬g
;

17 
¬’a_šd
;

18 *
p
;

19 
size_t
 
sz
;

21 
sz
 = (
¬’a_šd
);

22 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.ex‹nd", &
¬’a_šd
, &
sz
, 
NULL
, 0), 0,

25 ià(
th»ad_šd
 % 4 != 3) {

26 
size_t
 
mib
[3];

27 
size_t
 
mibËn
 = (
mib
) / (size_t);

28 cÚ¡ *
dss_´ecs
[] = {"disabled", "primary", "secondary"};

29 
´ec_šd
 = 
th»ad_šd
 %

30 ((
dss_´ecs
)/(*));

31 cÚ¡ *
dss
 = 
dss_´ecs
[
´ec_šd
];

32 
ex³ùed_”r
 = (
have_dss
 || 
´ec_šd
 =ğ0è? 0 : 
EFAULT
;

33 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’a.0.dss", 
mib
, &
mibËn
), 0,

35 
mib
[1] = 
¬’a_šd
;

36 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, (*)&
dss
,

37 (cÚ¡ *)), 
ex³ùed_”r
,

41 
p
 = 
	`m®locx
(1, 
	`MALLOCX_ARENA
(
¬’a_šd
));

42 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

43 
	`d®locx
(
p
, 0);

45  (
NULL
);

46 
	}
}

48 
	$TEST_BEGIN
(
‹¡_MALLOCX_ARENA
)

50 
thd_t
 
thds
[
NTHREADS
];

51 
i
;

53 
i
 = 0; i < 
NTHREADS
; i++) {

54 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
,

55 (*)(
ušŒ_t
)
i
);

58 
i
 = 0; i < 
NTHREADS
; i++)

59 
	`thd_još
(
thds
[
i
], 
NULL
);

60 
	}
}

61 
TEST_END


64 
	$maš
()

67  (
	`‹¡
(

68 
‹¡_MALLOCX_ARENA
));

69 
	}
}

	@deps/jemalloc/test/integration/aligned_alloc.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#CHUNK
 0x400000

	)

5 
	#MAXALIGN
 ((
size_t
)0x2000000LU)

	)

6 
	#NITER
 4

	)

8 
	$TEST_BEGIN
(
‹¡_®ignm’t_”rÜs
)

10 
size_t
 
®ignm’t
;

11 *
p
;

13 
®ignm’t
 = 0;

14 
	`£t_”ºo
(0);

15 
p
 = 
	`®igÃd_®loc
(
®ignm’t
, 1);

16 
	`as£¹_çl£
(
p
 !ğ
NULL
 || 
	`g‘_”ºo
(è!ğ
EINVAL
,

17 "Ex³ùedƒ¼Ü fÜ inv®id‡lignm’ˆ%zu", 
®ignm’t
);

19 
®ignm’t
 = (
size_t
);‡lignm’ˆ< 
MAXALIGN
;

20 
®ignm’t
 <<= 1) {

21 
	`£t_”ºo
(0);

22 
p
 = 
	`®igÃd_®loc
(
®ignm’t
 + 1, 1);

23 
	`as£¹_çl£
(
p
 !ğ
NULL
 || 
	`g‘_”ºo
(è!ğ
EINVAL
,

25 
®ignm’t
 + 1);

27 
	}
}

28 
TEST_END


30 
	$TEST_BEGIN
(
‹¡_oom_”rÜs
)

32 
size_t
 
®ignm’t
, 
size
;

33 *
p
;

35 #ià
LG_SIZEOF_PTR
 == 3

36 
®ignm’t
 = 
	`UINT64_C
(0x8000000000000000);

37 
size
 = 
	`UINT64_C
(0x8000000000000000);

39 
®ignm’t
 = 0x80000000LU;

40 
size
 = 0x80000000LU;

42 
	`£t_”ºo
(0);

43 
p
 = 
	`®igÃd_®loc
(
®ignm’t
, 
size
);

44 
	`as£¹_çl£
(
p
 !ğ
NULL
 || 
	`g‘_”ºo
(è!ğ
ENOMEM
,

46 
®ignm’t
, 
size
);

48 #ià
LG_SIZEOF_PTR
 == 3

49 
®ignm’t
 = 
	`UINT64_C
(0x4000000000000000);

50 
size
 = 
	`UINT64_C
(0xc000000000000001);

52 
®ignm’t
 = 0x40000000LU;

53 
size
 = 0xc0000001LU;

55 
	`£t_”ºo
(0);

56 
p
 = 
	`®igÃd_®loc
(
®ignm’t
, 
size
);

57 
	`as£¹_çl£
(
p
 !ğ
NULL
 || 
	`g‘_”ºo
(è!ğ
ENOMEM
,

59 
®ignm’t
, 
size
);

61 
®ignm’t
 = 0x10LU;

62 #ià
LG_SIZEOF_PTR
 == 3

63 
size
 = 
	`UINT64_C
(0xfffffffffffffff0);

65 
size
 = 0xfffffff0LU;

67 
	`£t_”ºo
(0);

68 
p
 = 
	`®igÃd_®loc
(
®ignm’t
, 
size
);

69 
	`as£¹_çl£
(
p
 !ğ
NULL
 || 
	`g‘_”ºo
(è!ğ
ENOMEM
,

71 
®ignm’t
, 
size
);

72 
	}
}

73 
TEST_END


75 
	$TEST_BEGIN
(
‹¡_®ignm’t_ªd_size
)

77 
size_t
 
®ignm’t
, 
size
, 
tÙ®
;

78 
i
;

79 *
ps
[
NITER
];

81 
i
 = 0; i < 
NITER
; i++)

82 
ps
[
i
] = 
NULL
;

84 
®ignm’t
 = 8;

85 
®ignm’t
 <ğ
MAXALIGN
;

86 
®ignm’t
 <<= 1) {

87 
tÙ®
 = 0;

88 
size
 = 1;

89 
size
 < 3 * 
®ignm’t
 && size < (1U << 31);

90 
size
 +ğ(
®ignm’t
 >> (
LG_SIZEOF_PTR
-1)) - 1) {

91 
i
 = 0; i < 
NITER
; i++) {

92 
ps
[
i
] = 
	`®igÃd_®loc
(
®ignm’t
, 
size
);

93 ià(
ps
[
i
] =ğ
NULL
) {

94 
buf
[
BUFERROR_BUF
];

96 
	`buã¼Ü
(
	`g‘_”ºo
(), 
buf
, (buf));

97 
	`‹¡_ç
(

100 
®ignm’t
, 
size
, size, 
buf
);

102 
tÙ®
 +ğ
	`m®loc_u§bË_size
(
ps
[
i
]);

103 ià(
tÙ®
 >ğ(
MAXALIGN
 << 1))

106 
i
 = 0; i < 
NITER
; i++) {

107 ià(
ps
[
i
] !ğ
NULL
) {

108 
	`ä“
(
ps
[
i
]);

109 
ps
[
i
] = 
NULL
;

114 
	}
}

115 
TEST_END


118 
	$maš
()

121  (
	`‹¡
(

122 
‹¡_®ignm’t_”rÜs
,

123 
‹¡_oom_”rÜs
,

124 
‹¡_®ignm’t_ªd_size
));

125 
	}
}

	@deps/jemalloc/test/integration/allocated.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 cÚ¡ 
boŞ
 
	gcÚfig_¡©s
 =

4 #ifdeà
JEMALLOC_STATS


5 
Œue


7 
çl£


12 
	$thd_¡¬t
(*
¬g
)

14 
”r
;

15 *
p
;

16 
ušt64_t
 
a0
, 
a1
, 
d0
, 
d1
;

17 
ušt64_t
 *
­0
, *
­1
, *
dp0
, *
dp1
;

18 
size_t
 
sz
, 
usize
;

20 
sz
 = (
a0
);

21 ià((
”r
 = 
	`m®lùl
("th»ad.®loÿ‹d", &
a0
, &
sz
, 
NULL
, 0))) {

22 ià(
”r
 =ğ
ENOENT
)

23 
Ïb–_ENOENT
;

24 
	`‹¡_ç
("%s(): E¼Ü iÀm®lùl(): %s", 
__func__
,

25 
	`¡»¼Ü
(
”r
));

27 
sz
 = (
­0
);

28 ià((
”r
 = 
	`m®lùl
("th»ad.®loÿ‹dp", &
­0
, &
sz
, 
NULL
, 0))) {

29 ià(
”r
 =ğ
ENOENT
)

30 
Ïb–_ENOENT
;

31 
	`‹¡_ç
("%s(): E¼Ü iÀm®lùl(): %s", 
__func__
,

32 
	`¡»¼Ü
(
”r
));

34 
	`as£¹_u64_eq
(*
­0
, 
a0
,

38 
sz
 = (
d0
);

39 ià((
”r
 = 
	`m®lùl
("th»ad.d—Îoÿ‹d", &
d0
, &
sz
, 
NULL
, 0))) {

40 ià(
”r
 =ğ
ENOENT
)

41 
Ïb–_ENOENT
;

42 
	`‹¡_ç
("%s(): E¼Ü iÀm®lùl(): %s", 
__func__
,

43 
	`¡»¼Ü
(
”r
));

45 
sz
 = (
dp0
);

46 ià((
”r
 = 
	`m®lùl
("th»ad.d—Îoÿ‹dp", &
dp0
, &
sz
, 
NULL
, 0))) {

47 ià(
”r
 =ğ
ENOENT
)

48 
Ïb–_ENOENT
;

49 
	`‹¡_ç
("%s(): E¼Ü iÀm®lùl(): %s", 
__func__
,

50 
	`¡»¼Ü
(
”r
));

52 
	`as£¹_u64_eq
(*
dp0
, 
d0
,

56 
p
 = 
	`m®loc
(1);

57 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected malloc()ƒrror");

59 
sz
 = (
a1
);

60 
	`m®lùl
("th»ad.®loÿ‹d", &
a1
, &
sz
, 
NULL
, 0);

61 
sz
 = (
­1
);

62 
	`m®lùl
("th»ad.®loÿ‹dp", &
­1
, &
sz
, 
NULL
, 0);

63 
	`as£¹_u64_eq
(*
­1
, 
a1
,

66 
	`as£¹_±r_eq
(
­0
, 
­1
,

69 
usize
 = 
	`m®loc_u§bË_size
(
p
);

70 
	`as£¹_u64_Ë
(
a0
 + 
usize
, 
a1
,

74 
	`ä“
(
p
);

76 
sz
 = (
d1
);

77 
	`m®lùl
("th»ad.d—Îoÿ‹d", &
d1
, &
sz
, 
NULL
, 0);

78 
sz
 = (
dp1
);

79 
	`m®lùl
("th»ad.d—Îoÿ‹dp", &
dp1
, &
sz
, 
NULL
, 0);

80 
	`as£¹_u64_eq
(*
dp1
, 
d1
,

83 
	`as£¹_±r_eq
(
dp0
, 
dp1
,

86 
	`as£¹_u64_Ë
(
d0
 + 
usize
, 
d1
,

90  (
NULL
);

91 
Ïb–_ENOENT
:

92 
	`as£¹_çl£
(
cÚfig_¡©s
,

94 
	`‹¡_sk
("\"thread.allocated\" mallctl‚ot‡vailable");

95  (
NULL
);

96 
	}
}

98 
	$TEST_BEGIN
(
‹¡_maš_th»ad
)

101 
	`thd_¡¬t
(
NULL
);

102 
	}
}

103 
TEST_END


105 
	$TEST_BEGIN
(
‹¡_subth»ad
)

107 
thd_t
 
thd
;

109 
	`thd_ü—‹
(&
thd
, 
thd_¡¬t
, 
NULL
);

110 
	`thd_još
(
thd
, 
NULL
);

111 
	}
}

112 
TEST_END


115 
	$maš
()

119  (
	`‹¡
(

120 
‹¡_maš_th»ad
,

121 
‹¡_subth»ad
,

122 
‹¡_maš_th»ad
,

123 
‹¡_subth»ad
,

124 
‹¡_maš_th»ad
));

125 
	}
}

	@deps/jemalloc/test/integration/chunk.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_FILL


4 cÚ¡ *
	gm®loc_cÚf
 = "junk:false";

7 
chunk_hooks_t
 
	gÜig_hooks
;

8 
chunk_hooks_t
 
	gŞd_hooks
;

10 
boŞ
 
	gdo_d®loc
 = 
Œue
;

11 
boŞ
 
	gdo_decomm™
;

13 
boŞ
 
	gdid_®loc
;

14 
boŞ
 
	gdid_d®loc
;

15 
boŞ
 
	gdid_comm™
;

16 
boŞ
 
	gdid_decomm™
;

17 
boŞ
 
	gdid_purge
;

18 
boŞ
 
	gdid_¥l™
;

19 
boŞ
 
	gdid_m”ge
;

22 
	#TRACE_HOOK
(
fmt
, ...è
	`m®loc_´štf
(fmt, 
__VA_ARGS__
)

	)

24 
	#TRACE_HOOK
(
fmt
, ...)

	)

28 
	$chunk_®loc
(*
Ãw_addr
, 
size_t
 
size
, size_ˆ
®ignm’t
, 
boŞ
 *
z”o
,

29 
boŞ
 *
comm™
, 
¬’a_šd
)

32 
	`TRACE_HOOK
("%s(new_addr=%p, size=%zu,‡lignment=%zu, *zero=%s, "

33 "*comm™=%s,‡»Ç_šd=%u)\n", 
__func__
, 
Ãw_addr
, 
size
, 
®ignm’t
,

34 *
z”o
 ? "Œue" : "çl£", *
comm™
 ? "Œue" : "çl£", 
¬’a_šd
);

35 
did_®loc
 = 
Œue
;

36  (
Şd_hooks
.
	`®loc
(
Ãw_addr
, 
size
, 
®ignm’t
, 
z”o
, 
comm™
,

37 
¬’a_šd
));

38 
	}
}

40 
boŞ


41 
	$chunk_d®loc
(*
chunk
, 
size_t
 
size
, 
boŞ
 
comm™‹d
, 
¬’a_šd
)

44 
	`TRACE_HOOK
("%s(chunk=%p, size=%zu, committed=%s,‡rena_ind=%u)\n",

45 
__func__
, 
chunk
, 
size
, 
comm™‹d
 ? "Œue" : "çl£", 
¬’a_šd
);

46 
did_d®loc
 = 
Œue
;

47 ià(!
do_d®loc
)

48  (
Œue
);

49  (
Şd_hooks
.
	`d®loc
(
chunk
, 
size
, 
comm™‹d
, 
¬’a_šd
));

50 
	}
}

52 
boŞ


53 
	$chunk_comm™
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

54 
¬’a_šd
)

56 
boŞ
 
”r
;

58 
	`TRACE_HOOK
("%s(chunk=%p, size=%zu, offset=%zu,†ength=%zu, "

59 "¬’a_šd=%u)\n", 
__func__
, 
chunk
, 
size
, 
off£t
, 
Ëngth
,

60 
¬’a_šd
);

61 
”r
 = 
Şd_hooks
.
	`comm™
(
chunk
, 
size
, 
off£t
, 
Ëngth
, 
¬’a_šd
);

62 
did_comm™
 = !
”r
;

63  (
”r
);

64 
	}
}

66 
boŞ


67 
	$chunk_decomm™
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

68 
¬’a_šd
)

70 
boŞ
 
”r
;

72 
	`TRACE_HOOK
("%s(chunk=%p, size=%zu, offset=%zu,†ength=%zu, "

73 "¬’a_šd=%u)\n", 
__func__
, 
chunk
, 
size
, 
off£t
, 
Ëngth
,

74 
¬’a_šd
);

75 ià(!
do_decomm™
)

76  (
Œue
);

77 
”r
 = 
Şd_hooks
.
	`decomm™
(
chunk
, 
size
, 
off£t
, 
Ëngth
, 
¬’a_šd
);

78 
did_decomm™
 = !
”r
;

79  (
”r
);

80 
	}
}

82 
boŞ


83 
	$chunk_purge
(*
chunk
, 
size_t
 
size
, size_ˆ
off£t
, size_ˆ
Ëngth
,

84 
¬’a_šd
)

87 
	`TRACE_HOOK
("%s(chunk=%p, size=%zu, offset=%zu,†ength=%zu "

88 "¬’a_šd=%u)\n", 
__func__
, 
chunk
, 
size
, 
off£t
, 
Ëngth
,

89 
¬’a_šd
);

90 
did_purge
 = 
Œue
;

91  (
Şd_hooks
.
	`purge
(
chunk
, 
size
, 
off£t
, 
Ëngth
, 
¬’a_šd
));

92 
	}
}

94 
boŞ


95 
	$chunk_¥l™
(*
chunk
, 
size_t
 
size
, size_ˆ
size_a
, size_ˆ
size_b
,

96 
boŞ
 
comm™‹d
, 
¬’a_šd
)

99 
	`TRACE_HOOK
("%s(chunk=%p, size=%zu, size_a=%zu, size_b=%zu, "

100 "comm™‹d=%s,‡»Ç_šd=%u)\n", 
__func__
, 
chunk
, 
size
, 
size_a
,

101 
size_b
, 
comm™‹d
 ? "Œue" : "çl£", 
¬’a_šd
);

102 
did_¥l™
 = 
Œue
;

103  (
Şd_hooks
.
	`¥l™
(
chunk
, 
size
, 
size_a
, 
size_b
, 
comm™‹d
,

104 
¬’a_šd
));

105 
	}
}

107 
boŞ


108 
	$chunk_m”ge
(*
chunk_a
, 
size_t
 
size_a
, *
chunk_b
, size_ˆ
size_b
,

109 
boŞ
 
comm™‹d
, 
¬’a_šd
)

112 
	`TRACE_HOOK
("%s(chunk_a=%p, size_a=%zu, chunk_b=%p size_b=%zu, "

113 "comm™‹d=%s,‡»Ç_šd=%u)\n", 
__func__
, 
chunk_a
, 
size_a
, 
chunk_b
,

114 
size_b
, 
comm™‹d
 ? "Œue" : "çl£", 
¬’a_šd
);

115 
did_m”ge
 = 
Œue
;

116  (
Şd_hooks
.
	`m”ge
(
chunk_a
, 
size_a
, 
chunk_b
, 
size_b
,

117 
comm™‹d
, 
¬’a_šd
));

118 
	}
}

120 
	$TEST_BEGIN
(
‹¡_chunk
)

122 *
p
;

123 
size_t
 
Şd_size
, 
Ãw_size
, 
Ïrge0
, 
Ïrge1
, 
huge0
, 
huge1
, 
huge2
, 
sz
;

124 
chunk_hooks_t
 
Ãw_hooks
 = {

125 
chunk_®loc
,

126 
chunk_d®loc
,

127 
chunk_comm™
,

128 
chunk_decomm™
,

129 
chunk_purge
,

130 
chunk_¥l™
,

131 
chunk_m”ge


133 
boŞ
 
x®locx_sucûss_a
, 
x®locx_sucûss_b
, 
x®locx_sucûss_c
;

136 
Şd_size
 = (
chunk_hooks_t
);

137 
Ãw_size
 = (
chunk_hooks_t
);

138 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.chunk_hooks", &
Şd_hooks
, &
Şd_size
,

139 &
Ãw_hooks
, 
Ãw_size
), 0, "Unexpected chunk_hooksƒrror");

140 
Üig_hooks
 = 
Şd_hooks
;

141 
	`as£¹_±r_Ã
(
Şd_hooks
.
®loc
, 
chunk_®loc
, "Unexpected‡llocƒrror");

142 
	`as£¹_±r_Ã
(
Şd_hooks
.
d®loc
, 
chunk_d®loc
,

144 
	`as£¹_±r_Ã
(
Şd_hooks
.
comm™
, 
chunk_comm™
,

146 
	`as£¹_±r_Ã
(
Şd_hooks
.
decomm™
, 
chunk_decomm™
,

148 
	`as£¹_±r_Ã
(
Şd_hooks
.
purge
, 
chunk_purge
, "Unexpected…urgeƒrror");

149 
	`as£¹_±r_Ã
(
Şd_hooks
.
¥l™
, 
chunk_¥l™
, "Unexpected splitƒrror");

150 
	`as£¹_±r_Ã
(
Şd_hooks
.
m”ge
, 
chunk_m”ge
, "Unexpected mergeƒrror");

153 
sz
 = (
size_t
);

154 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ìun.0.size", &
Ïrge0
, &
sz
, 
NULL
, 0), 0,

156 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ìun.1.size", &
Ïrge1
, &
sz
, 
NULL
, 0), 0,

160 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.hchunk.0.size", &
huge0
, &
sz
, 
NULL
, 0), 0,

162 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.hchunk.1.size", &
huge1
, &
sz
, 
NULL
, 0), 0,

164 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.hchunk.2.size", &
huge2
, &
sz
, 
NULL
, 0), 0,

168 
do_d®loc
 = 
çl£
;

169 
do_decomm™
 = 
çl£
;

170 
p
 = 
	`m®locx
(
huge0
 * 2, 0);

171 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

172 
did_d®loc
 = 
çl£
;

173 
did_decomm™
 = 
çl£
;

174 
did_purge
 = 
çl£
;

175 
did_¥l™
 = 
çl£
;

176 
x®locx_sucûss_a
 = (
	`x®locx
(
p
, 
huge0
, 0, 0) == huge0);

177 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.purge", 
NULL
, NULL, NULL, 0), 0,

179 ià(
x®locx_sucûss_a
) {

180 
	`as£¹_Œue
(
did_d®loc
, "Expected dalloc");

181 
	`as£¹_çl£
(
did_decomm™
, "Unexpected decommit");

182 
	`as£¹_Œue
(
did_purge
, "Expected…urge");

184 
	`as£¹_Œue
(
did_¥l™
, "Expected split");

185 
	`d®locx
(
p
, 0);

186 
do_d®loc
 = 
Œue
;

189 
do_d®loc
 = 
çl£
;

190 
do_decomm™
 = 
Œue
;

191 
p
 = 
	`m®locx
(
huge0
 * 2, 0);

192 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

193 
did_decomm™
 = 
çl£
;

194 
did_comm™
 = 
çl£
;

195 
did_¥l™
 = 
çl£
;

196 
did_m”ge
 = 
çl£
;

197 
x®locx_sucûss_b
 = (
	`x®locx
(
p
, 
huge0
, 0, 0) == huge0);

198 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.purge", 
NULL
, NULL, NULL, 0), 0,

200 ià(
x®locx_sucûss_b
)

201 
	`as£¹_Œue
(
did_¥l™
, "Expected split");

202 
x®locx_sucûss_c
 = (
	`x®locx
(
p
, 
huge0
 * 2, 0, 0) == huge0 * 2);

203 
	`as£¹_b_eq
(
did_decomm™
, 
did_comm™
, "Expected decommit/commit match");

204 ià(
x®locx_sucûss_b
 && 
x®locx_sucûss_c
)

205 
	`as£¹_Œue
(
did_m”ge
, "Expected merge");

206 
	`d®locx
(
p
, 0);

207 
do_d®loc
 = 
Œue
;

208 
do_decomm™
 = 
çl£
;

211 ià(
huge0
 * 2 > 
huge2
) {

217 
p
 = 
	`m®locx
(
huge2
, 0);

218 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

219 
did_purge
 = 
çl£
;

220 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge1
, 0, 0), huge1,

222 
	`as£¹_Œue
(
did_purge
, "Expected…urge");

223 
	`d®locx
(
p
, 0);

227 
do_decomm™
 = 
Œue
;

228 
p
 = 
	`m®locx
(
Ïrge1
, 0);

229 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

230 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.purge", 
NULL
, NULL, NULL, 0), 0,

232 
did_decomm™
 = 
çl£
;

233 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 0, 0),†arge0,

235 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.purge", 
NULL
, NULL, NULL, 0), 0,

237 
did_comm™
 = 
çl£
;

238 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge1
, 0, 0),†arge1,

240 
	`as£¹_b_eq
(
did_decomm™
, 
did_comm™
, "Expected decommit/commit match");

241 
	`d®locx
(
p
, 0);

242 
do_decomm™
 = 
çl£
;

245 
p
 = 
	`m®locx
(42, 0);

246 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

247 
	`d®locx
(
p
, 0);

250 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.chunk_hooks", 
NULL
, NULL, &
Şd_hooks
,

251 
Ãw_size
), 0, "Unexpected chunk_hooksƒrror");

252 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.chunk_hooks", &
Şd_hooks
, &
Şd_size
,

253 
NULL
, 0), 0, "Unexpected chunk_hooksƒrror");

254 
	`as£¹_±r_eq
(
Şd_hooks
.
®loc
, 
Üig_hooks
.alloc,

256 
	`as£¹_±r_eq
(
Şd_hooks
.
d®loc
, 
Üig_hooks
.dalloc,

258 
	`as£¹_±r_eq
(
Şd_hooks
.
comm™
, 
Üig_hooks
.commit,

260 
	`as£¹_±r_eq
(
Şd_hooks
.
decomm™
, 
Üig_hooks
.decommit,

262 
	`as£¹_±r_eq
(
Şd_hooks
.
purge
, 
Üig_hooks
.purge,

264 
	`as£¹_±r_eq
(
Şd_hooks
.
¥l™
, 
Üig_hooks
.split,

266 
	`as£¹_±r_eq
(
Şd_hooks
.
m”ge
, 
Üig_hooks
.merge,

268 
	}
}

269 
TEST_END


272 
	$maš
()

275  (
	`‹¡
(
‹¡_chunk
));

276 
	}
}

	@deps/jemalloc/test/integration/mallocx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

4 
	$g‘_nsizes_im¶
(cÚ¡ *
cmd
)

6 
»t
;

7 
size_t
 
z
;

9 
z
 = ();

10 
	`as£¹_d_eq
(
	`m®lùl
(
cmd
, &
»t
, &
z
, 
NULL
, 0), 0,

11 "UÃx³ùed m®lùl(\"%s\", ...èçu»", 
cmd
);

13  (
»t
);

14 
	}
}

17 
	$g‘_nhuge
()

20  (
	`g‘_nsizes_im¶
("arenas.nhchunks"));

21 
	}
}

23 
size_t


24 
	$g‘_size_im¶
(cÚ¡ *
cmd
, 
size_t
 
šd
)

26 
size_t
 
»t
;

27 
size_t
 
z
;

28 
size_t
 
mib
[4];

29 
size_t
 
mibËn
 = 4;

31 
z
 = (
size_t
);

32 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
(
cmd
, 
mib
, &
mibËn
),

33 0, "UÃx³ùed m®lùÊam‘omib(\"%s\", ...èçu»", 
cmd
);

34 
mib
[2] = 
šd
;

35 
z
 = (
size_t
);

36 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
»t
, &
z
, 
NULL
, 0),

37 0, "UÃx³ùed m®lùlbymib([\"%s\", %zu], ...èçu»", 
cmd
, 
šd
);

39  (
»t
);

40 
	}
}

42 
size_t


43 
	$g‘_huge_size
(
size_t
 
šd
)

46  (
	`g‘_size_im¶
("¬’as.hchunk.0.size", 
šd
));

47 
	}
}

49 
	$TEST_BEGIN
(
‹¡_oom
)

51 
size_t
 
hugemax
, 
size
, 
®ignm’t
;

53 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

60 *
p
;

62 
p
 = 
	`m®locx
(
hugemax
, 0);

63 ià(
p
 !ğ
NULL
) {

64 
	`as£¹_±r_nuÎ
(
	`m®locx
(
hugemax
, 0),

65 "Ex³ùed OOM fÜ m®locx(size=%#zx, 0)", 
hugemax
);

66 
	`d®locx
(
p
, 0);

70 #ià
LG_SIZEOF_PTR
 == 3

71 
size
 = 
	`ZU
(0x8000000000000000);

72 
®ignm’t
 = 
	`ZU
(0x8000000000000000);

74 
size
 = 
	`ZU
(0x80000000);

75 
®ignm’t
 = 
	`ZU
(0x80000000);

77 
	`as£¹_±r_nuÎ
(
	`m®locx
(
size
, 
	`MALLOCX_ALIGN
(
®ignm’t
)),

78 "Ex³ùed OOM fÜ m®locx(size=%#zx, MALLOCX_ALIGN(%#zx)", 
size
,

79 
®ignm’t
);

80 
	}
}

81 
TEST_END


83 
	$TEST_BEGIN
(
‹¡_basic
)

85 
	#MAXSZ
 (((
size_t
)1è<< 26)

	)

86 
size_t
 
sz
;

88 
sz
 = 1; sz < 
MAXSZ
; sz = 
	`ÇÎocx
(sz, 0) + 1) {

89 
size_t
 
nsz
, 
rsz
;

90 *
p
;

91 
nsz
 = 
	`ÇÎocx
(
sz
, 0);

92 
	`as£¹_zu_Ã
(
nsz
, 0, "Unexpected‚allocx()ƒrror");

93 
p
 = 
	`m®locx
(
sz
, 0);

94 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

95 
rsz
 = 
	`§Îocx
(
p
, 0);

96 
	`as£¹_zu_ge
(
rsz
, 
sz
, "Real size smallerhanƒxpected");

97 
	`as£¹_zu_eq
(
nsz
, 
rsz
, "nallocx()/sallocx() size mismatch");

98 
	`d®locx
(
p
, 0);

100 
p
 = 
	`m®locx
(
sz
, 0);

101 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

102 
	`d®locx
(
p
, 0);

104 
nsz
 = 
	`ÇÎocx
(
sz
, 
MALLOCX_ZERO
);

105 
	`as£¹_zu_Ã
(
nsz
, 0, "Unexpected‚allocx()ƒrror");

106 
p
 = 
	`m®locx
(
sz
, 
MALLOCX_ZERO
);

107 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

108 
rsz
 = 
	`§Îocx
(
p
, 0);

109 
	`as£¹_zu_eq
(
nsz
, 
rsz
, "nallocx()/sallocx()„size mismatch");

110 
	`d®locx
(
p
, 0);

112 #undeà
MAXSZ


113 
	}
}

114 
TEST_END


116 
	$TEST_BEGIN
(
‹¡_®ignm’t_ªd_size
)

118 
	#MAXALIGN
 (((
size_t
)1è<< 25)

	)

119 
	#NITER
 4

	)

120 
size_t
 
nsz
, 
rsz
, 
sz
, 
®ignm’t
, 
tÙ®
;

121 
i
;

122 *
ps
[
NITER
];

124 
i
 = 0; i < 
NITER
; i++)

125 
ps
[
i
] = 
NULL
;

127 
®ignm’t
 = 8;

128 
®ignm’t
 <ğ
MAXALIGN
;

129 
®ignm’t
 <<= 1) {

130 
tÙ®
 = 0;

131 
sz
 = 1;

132 
sz
 < 3 * 
®ignm’t
 && sz < (1U << 31);

133 
sz
 +ğ(
®ignm’t
 >> (
LG_SIZEOF_PTR
-1)) - 1) {

134 
i
 = 0; i < 
NITER
; i++) {

135 
nsz
 = 
	`ÇÎocx
(
sz
, 
	`MALLOCX_ALIGN
(
®ignm’t
) |

136 
MALLOCX_ZERO
);

137 
	`as£¹_zu_Ã
(
nsz
, 0,

139 "size=%zu (%#zx)", 
®ignm’t
, 
sz
, sz);

140 
ps
[
i
] = 
	`m®locx
(
sz
, 
	`MALLOCX_ALIGN
(
®ignm’t
) |

141 
MALLOCX_ZERO
);

142 
	`as£¹_±r_nÙ_nuÎ
(
ps
[
i
],

144 "size=%zu (%#zx)", 
®ignm’t
, 
sz
, sz);

145 
rsz
 = 
	`§Îocx
(
ps
[
i
], 0);

146 
	`as£¹_zu_ge
(
rsz
, 
sz
,

148 "®ignm’t=%zu, size=%zu", 
®ignm’t
, 
sz
);

149 
	`as£¹_zu_eq
(
nsz
, 
rsz
,

151 "®ignm’t=%zu, size=%zu", 
®ignm’t
, 
sz
);

152 
	`as£¹_±r_nuÎ
(

153 (*)((
ušŒ_t
)
ps
[
i
] & (
®ignm’t
-1)),

155 "‡lignm’t=%zu, size=%zu", 
ps
[
i
],

156 
®ignm’t
, 
sz
);

157 
tÙ®
 +ğ
rsz
;

158 ià(
tÙ®
 >ğ(
MAXALIGN
 << 1))

161 
i
 = 0; i < 
NITER
; i++) {

162 ià(
ps
[
i
] !ğ
NULL
) {

163 
	`d®locx
(
ps
[
i
], 0);

164 
ps
[
i
] = 
NULL
;

169 #undeà
MAXALIGN


170 #undeà
NITER


171 
	}
}

172 
TEST_END


175 
	$maš
()

178  (
	`‹¡
(

179 
‹¡_oom
,

180 
‹¡_basic
,

181 
‹¡_®ignm’t_ªd_size
));

182 
	}
}

	@deps/jemalloc/test/integration/overflow.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_ov”æow
)

5 
nhchunks
;

6 
size_t
 
mib
[4];

7 
size_t
 
sz
, 
mibËn
, 
max_size_şass
;

8 *
p
;

10 
sz
 = ();

11 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.nhchunks", &
nhchunks
, &
sz
, 
NULL
, 0), 0,

14 
mibËn
 = (
mib
è/ (
size_t
);

15 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’as.hchunk.0.size", 
mib
, &
mibËn
), 0,

17 
mib
[2] = 
nhchunks
 - 1;

19 
sz
 = (
size_t
);

20 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
max_size_şass
, &
sz
, 
NULL
, 0), 0,

23 
	`as£¹_±r_nuÎ
(
	`m®loc
(
max_size_şass
 + 1),

25 
	`as£¹_±r_nuÎ
(
	`m®loc
(
SIZE_T_MAX
),

28 
	`as£¹_±r_nuÎ
(
	`ÿÎoc
(1, 
max_size_şass
 + 1),

30 
	`as£¹_±r_nuÎ
(
	`ÿÎoc
(1, 
SIZE_T_MAX
),

33 
p
 = 
	`m®loc
(1);

34 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected malloc() OOM");

35 
	`as£¹_±r_nuÎ
(
	`»®loc
(
p
, 
max_size_şass
 + 1),

37 
	`as£¹_±r_nuÎ
(
	`»®loc
(
p
, 
SIZE_T_MAX
),

39 
	`ä“
(
p
);

40 
	}
}

41 
TEST_END


44 
	$maš
()

47  (
	`‹¡
(

48 
‹¡_ov”æow
));

49 
	}
}

	@deps/jemalloc/test/integration/posix_memalign.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#CHUNK
 0x400000

	)

5 
	#MAXALIGN
 ((
size_t
)0x2000000LU)

	)

6 
	#NITER
 4

	)

8 
	$TEST_BEGIN
(
‹¡_®ignm’t_”rÜs
)

10 
size_t
 
®ignm’t
;

11 *
p
;

13 
®ignm’t
 = 0;‡lignment < (*);‡lignment++) {

14 
	`as£¹_d_eq
(
	`posix_mem®ign
(&
p
, 
®ignm’t
, 1), 
EINVAL
,

16 
®ignm’t
);

19 
®ignm’t
 = (
size_t
);‡lignm’ˆ< 
MAXALIGN
;

20 
®ignm’t
 <<= 1) {

21 
	`as£¹_d_Ã
(
	`posix_mem®ign
(&
p
, 
®ignm’t
 + 1, 1), 0,

23 
®ignm’t
 + 1);

25 
	}
}

26 
TEST_END


28 
	$TEST_BEGIN
(
‹¡_oom_”rÜs
)

30 
size_t
 
®ignm’t
, 
size
;

31 *
p
;

33 #ià
LG_SIZEOF_PTR
 == 3

34 
®ignm’t
 = 
	`UINT64_C
(0x8000000000000000);

35 
size
 = 
	`UINT64_C
(0x8000000000000000);

37 
®ignm’t
 = 0x80000000LU;

38 
size
 = 0x80000000LU;

40 
	`as£¹_d_Ã
(
	`posix_mem®ign
(&
p
, 
®ignm’t
, 
size
), 0,

42 
®ignm’t
, 
size
);

44 #ià
LG_SIZEOF_PTR
 == 3

45 
®ignm’t
 = 
	`UINT64_C
(0x4000000000000000);

46 
size
 = 
	`UINT64_C
(0xc000000000000001);

48 
®ignm’t
 = 0x40000000LU;

49 
size
 = 0xc0000001LU;

51 
	`as£¹_d_Ã
(
	`posix_mem®ign
(&
p
, 
®ignm’t
, 
size
), 0,

53 
®ignm’t
, 
size
);

55 
®ignm’t
 = 0x10LU;

56 #ià
LG_SIZEOF_PTR
 == 3

57 
size
 = 
	`UINT64_C
(0xfffffffffffffff0);

59 
size
 = 0xfffffff0LU;

61 
	`as£¹_d_Ã
(
	`posix_mem®ign
(&
p
, 
®ignm’t
, 
size
), 0,

63 
®ignm’t
, 
size
);

64 
	}
}

65 
TEST_END


67 
	$TEST_BEGIN
(
‹¡_®ignm’t_ªd_size
)

69 
size_t
 
®ignm’t
, 
size
, 
tÙ®
;

70 
i
;

71 
”r
;

72 *
ps
[
NITER
];

74 
i
 = 0; i < 
NITER
; i++)

75 
ps
[
i
] = 
NULL
;

77 
®ignm’t
 = 8;

78 
®ignm’t
 <ğ
MAXALIGN
;

79 
®ignm’t
 <<= 1) {

80 
tÙ®
 = 0;

81 
size
 = 1;

82 
size
 < 3 * 
®ignm’t
 && size < (1U << 31);

83 
size
 +ğ(
®ignm’t
 >> (
LG_SIZEOF_PTR
-1)) - 1) {

84 
i
 = 0; i < 
NITER
; i++) {

85 
”r
 = 
	`posix_mem®ign
(&
ps
[
i
],

86 
®ignm’t
, 
size
);

87 ià(
”r
) {

88 
buf
[
BUFERROR_BUF
];

90 
	`buã¼Ü
(
	`g‘_”ºo
(), 
buf
, (buf));

91 
	`‹¡_ç
(

94 
®ignm’t
, 
size
, size, 
buf
);

96 
tÙ®
 +ğ
	`m®loc_u§bË_size
(
ps
[
i
]);

97 ià(
tÙ®
 >ğ(
MAXALIGN
 << 1))

100 
i
 = 0; i < 
NITER
; i++) {

101 ià(
ps
[
i
] !ğ
NULL
) {

102 
	`ä“
(
ps
[
i
]);

103 
ps
[
i
] = 
NULL
;

108 
	}
}

109 
TEST_END


112 
	$maš
()

115  (
	`‹¡
(

116 
‹¡_®ignm’t_”rÜs
,

117 
‹¡_oom_”rÜs
,

118 
‹¡_®ignm’t_ªd_size
));

119 
	}
}

	@deps/jemalloc/test/integration/rallocx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_grow_ªd_shršk
)

5 *
p
, *
q
;

6 
size_t
 
tsz
;

7 
	#NCYCLES
 3

	)

8 
i
, 
j
;

9 
	#NSZS
 2500

	)

10 
size_t
 
szs
[
NSZS
];

11 
	#MAXSZ
 
	`ZU
(12 * 1024 * 1024)

	)

13 
p
 = 
	`m®locx
(1, 0);

14 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

15 
szs
[0] = 
	`§Îocx
(
p
, 0);

17 
i
 = 0; i < 
NCYCLES
; i++) {

18 
j
 = 1; j < 
NSZS
 && 
szs
[j-1] < 
MAXSZ
; j++) {

19 
q
 = 
	`¿Îocx
(
p
, 
szs
[
j
-1]+1, 0);

20 
	`as£¹_±r_nÙ_nuÎ
(
q
,

22 
szs
[
j
-1], szs[j-1]+1);

23 
szs
[
j
] = 
	`§Îocx
(
q
, 0);

24 
	`as£¹_zu_Ã
(
szs
[
j
], szs[j-1]+1,

25 "Ex³ùed siztØb©†—¡: %zu", 
szs
[
j
-1]+1);

26 
p
 = 
q
;

29 
j
--; j > 0; j--) {

30 
q
 = 
	`¿Îocx
(
p
, 
szs
[
j
-1], 0);

31 
	`as£¹_±r_nÙ_nuÎ
(
q
,

33 
szs
[
j
], szs[j-1]);

34 
tsz
 = 
	`§Îocx
(
q
, 0);

35 
	`as£¹_zu_eq
(
tsz
, 
szs
[
j
-1],

36 "Ex³ùed size=%zu, gÙ size=%zu", 
szs
[
j
-1], 
tsz
);

37 
p
 = 
q
;

41 
	`d®locx
(
p
, 0);

42 #undeà
MAXSZ


43 #undeà
NSZS


44 #undeà
NCYCLES


45 
	}
}

46 
TEST_END


48 
boŞ


49 
	$v®id©e_fl
(cÚ¡ *
p
, 
ušt8_t
 
c
, 
size_t
 
off£t
, size_ˆ
Ën
)

51 
boŞ
 
»t
 = 
çl£
;

52 cÚ¡ 
ušt8_t
 *
buf
 = (cÚ¡ ušt8_ˆ*)
p
;

53 
size_t
 
i
;

55 
i
 = 0; i < 
Ën
; i++) {

56 
ušt8_t
 
b
 = 
buf
[
off£t
+
i
];

57 ià(
b
 !ğ
c
) {

58 
	`‹¡_ç
("Allocation‡t %p (len=%zu) contains %#x "

59 "¿th”hª %#x‡ˆoff£ˆ%zu", 
p
, 
Ën
, 
b
, 
c
,

60 
off£t
+
i
);

61 
»t
 = 
Œue
;

65  (
»t
);

66 
	}
}

68 
	$TEST_BEGIN
(
‹¡_z”o
)

70 *
p
, *
q
;

71 
size_t
 
psz
, 
qsz
, 
i
, 
j
;

72 
size_t
 
¡¬t_sizes
[] = {1, 3*1024, 63*1024, 4095*1024};

73 
	#FILL_BYTE
 0x¯U

	)

74 
	#RANGE
 2048

	)

76 
i
 = 0; i < (
¡¬t_sizes
)/(
size_t
); i++) {

77 
size_t
 
¡¬t_size
 = 
¡¬t_sizes
[
i
];

78 
p
 = 
	`m®locx
(
¡¬t_size
, 
MALLOCX_ZERO
);

79 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

80 
psz
 = 
	`§Îocx
(
p
, 0);

82 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 0, 0, 
psz
),

84 
	`mem£t
(
p
, 
FILL_BYTE
, 
psz
);

85 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
psz
),

88 
j
 = 1; j < 
RANGE
; j++) {

89 
q
 = 
	`¿Îocx
(
p
, 
¡¬t_size
+
j
, 
MALLOCX_ZERO
);

90 
	`as£¹_±r_nÙ_nuÎ
(
q
, "Unexpected„allocx()ƒrror");

91 
qsz
 = 
	`§Îocx
(
q
, 0);

92 ià(
q
 !ğ
p
 || 
qsz
 !ğ
psz
) {

93 
	`as£¹_çl£
(
	`v®id©e_fl
(
q
, 
FILL_BYTE
, 0,

94 
psz
), "Expected filled memory");

95 
	`as£¹_çl£
(
	`v®id©e_fl
(
q
, 0, 
psz
, 
qsz
-psz),

98 ià(
psz
 !ğ
qsz
) {

99 
	`mem£t
((*)((
ušŒ_t
)
q
+
psz
), 
FILL_BYTE
,

100 
qsz
-
psz
);

101 
psz
 = 
qsz
;

103 
p
 = 
q
;

105 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
psz
),

107 
	`d®locx
(
p
, 0);

109 #undeà
FILL_BYTE


110 
	}
}

111 
TEST_END


113 
	$TEST_BEGIN
(
‹¡_®ign
)

115 *
p
, *
q
;

116 
size_t
 
®ign
;

117 
	#MAX_ALIGN
 (
	`ZU
(1è<< 25)

	)

119 
®ign
 = 
	`ZU
(1);

120 
p
 = 
	`m®locx
(1, 
	`MALLOCX_ALIGN
(
®ign
));

121 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

123 
®ign
 <<ğ1;‡ligÀ<ğ
MAX_ALIGN
;‡lign <<= 1) {

124 
q
 = 
	`¿Îocx
(
p
, 1, 
	`MALLOCX_ALIGN
(
®ign
));

125 
	`as£¹_±r_nÙ_nuÎ
(
q
,

126 "UÃx³ùed„®locx(è”rÜ fÜ‡lign=%zu", 
®ign
);

127 
	`as£¹_±r_nuÎ
(

128 (*)((
ušŒ_t
)
q
 & (
®ign
-1)),

130 
q
, 
®ign
);

131 
p
 = 
q
;

133 
	`d®locx
(
p
, 0);

134 #undeà
MAX_ALIGN


135 
	}
}

136 
TEST_END


138 
	$TEST_BEGIN
(
‹¡_lg_®ign_ªd_z”o
)

140 *
p
, *
q
;

141 
size_t
 
lg_®ign
, 
sz
;

142 
	#MAX_LG_ALIGN
 25

	)

143 
	#MAX_VALIDATE
 (
	`ZU
(1è<< 22)

	)

145 
lg_®ign
 = 
	`ZU
(0);

146 
p
 = 
	`m®locx
(1, 
	`MALLOCX_LG_ALIGN
(
lg_®ign
)|
MALLOCX_ZERO
);

147 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

149 
lg_®ign
++;†g_®igÀ<ğ
MAX_LG_ALIGN
;†g_align++) {

150 
q
 = 
	`¿Îocx
(
p
, 1, 
	`MALLOCX_LG_ALIGN
(
lg_®ign
)|
MALLOCX_ZERO
);

151 
	`as£¹_±r_nÙ_nuÎ
(
q
,

152 "UÃx³ùed„®locx(è”rÜ fÜ†g_®ign=%zu", 
lg_®ign
);

153 
	`as£¹_±r_nuÎ
(

154 (*)((
ušŒ_t
)
q
 & ((
	`ZU
(1è<< 
lg_®ign
)-1)),

156 
q
, 
lg_®ign
);

157 
sz
 = 
	`§Îocx
(
q
, 0);

158 ià((
sz
 << 1è<ğ
MAX_VALIDATE
) {

159 
	`as£¹_çl£
(
	`v®id©e_fl
(
q
, 0, 0, 
sz
),

162 
	`as£¹_çl£
(
	`v®id©e_fl
(
q
, 0, 0, 
MAX_VALIDATE
),

164 
	`as£¹_çl£
(
	`v®id©e_fl
(

165 (*)((
ušŒ_t
)
q
+
sz
-
MAX_VALIDATE
),

166 0, 0, 
MAX_VALIDATE
), "Expected zeroed memory");

168 
p
 = 
q
;

170 
	`d®locx
(
p
, 0);

171 #undeà
MAX_VALIDATE


172 #undeà
MAX_LG_ALIGN


173 
	}
}

174 
TEST_END


177 
	$maš
()

180  (
	`‹¡
(

181 
‹¡_grow_ªd_shršk
,

182 
‹¡_z”o
,

183 
‹¡_®ign
,

184 
‹¡_lg_®ign_ªd_z”o
));

185 
	}
}

	@deps/jemalloc/test/integration/sdallocx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#MAXALIGN
 (((
size_t
)1è<< 25)

	)

4 
	#NITER
 4

	)

6 
	$TEST_BEGIN
(
‹¡_basic
)

8 *
±r
 = 
	`m®locx
(64, 0);

9 
	`sd®locx
(
±r
, 64, 0);

10 
	}
}

11 
TEST_END


13 
	$TEST_BEGIN
(
‹¡_®ignm’t_ªd_size
)

15 
size_t
 
nsz
, 
sz
, 
®ignm’t
, 
tÙ®
;

16 
i
;

17 *
ps
[
NITER
];

19 
i
 = 0; i < 
NITER
; i++)

20 
ps
[
i
] = 
NULL
;

22 
®ignm’t
 = 8;

23 
®ignm’t
 <ğ
MAXALIGN
;

24 
®ignm’t
 <<= 1) {

25 
tÙ®
 = 0;

26 
sz
 = 1;

27 
sz
 < 3 * 
®ignm’t
 && sz < (1U << 31);

28 
sz
 +ğ(
®ignm’t
 >> (
LG_SIZEOF_PTR
-1)) - 1) {

29 
i
 = 0; i < 
NITER
; i++) {

30 
nsz
 = 
	`ÇÎocx
(
sz
, 
	`MALLOCX_ALIGN
(
®ignm’t
) |

31 
MALLOCX_ZERO
);

32 
ps
[
i
] = 
	`m®locx
(
sz
, 
	`MALLOCX_ALIGN
(
®ignm’t
) |

33 
MALLOCX_ZERO
);

34 
tÙ®
 +ğ
nsz
;

35 ià(
tÙ®
 >ğ(
MAXALIGN
 << 1))

38 
i
 = 0; i < 
NITER
; i++) {

39 ià(
ps
[
i
] !ğ
NULL
) {

40 
	`sd®locx
(
ps
[
i
], 
sz
,

41 
	`MALLOCX_ALIGN
(
®ignm’t
));

42 
ps
[
i
] = 
NULL
;

47 
	}
}

48 
TEST_END


51 
	$maš
()

54  (
	`‹¡
(

55 
‹¡_basic
,

56 
‹¡_®ignm’t_ªd_size
));

57 
	}
}

	@deps/jemalloc/test/integration/thread_arena.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#NTHREADS
 10

	)

6 
	$thd_¡¬t
(*
¬g
)

8 
maš_¬’a_šd
 = *(*)
¬g
;

9 *
p
;

10 
¬’a_šd
;

11 
size_t
 
size
;

12 
”r
;

14 
p
 = 
	`m®loc
(1);

15 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Error in malloc()");

16 
	`ä“
(
p
);

18 
size
 = (
¬’a_šd
);

19 ià((
”r
 = 
	`m®lùl
("th»ad.¬’a", &
¬’a_šd
, &
size
, &
maš_¬’a_šd
,

20 (
maš_¬’a_šd
)))) {

21 
buf
[
BUFERROR_BUF
];

23 
	`buã¼Ü
(
”r
, 
buf
, (buf));

24 
	`‹¡_ç
("E¼Ü iÀm®lùl(): %s", 
buf
);

27 
size
 = (
¬’a_šd
);

28 ià((
”r
 = 
	`m®lùl
("th»ad.¬’a", &
¬’a_šd
, &
size
, 
NULL
, 0))) {

29 
buf
[
BUFERROR_BUF
];

31 
	`buã¼Ü
(
”r
, 
buf
, (buf));

32 
	`‹¡_ç
("E¼Ü iÀm®lùl(): %s", 
buf
);

34 
	`as£¹_u_eq
(
¬’a_šd
, 
maš_¬’a_šd
,

37  (
NULL
);

38 
	}
}

40 
	$TEST_BEGIN
(
‹¡_th»ad_¬’a
)

42 *
p
;

43 
¬’a_šd
;

44 
size_t
 
size
;

45 
”r
;

46 
thd_t
 
thds
[
NTHREADS
];

47 
i
;

49 
p
 = 
	`m®loc
(1);

50 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Error in malloc()");

52 
size
 = (
¬’a_šd
);

53 ià((
”r
 = 
	`m®lùl
("th»ad.¬’a", &
¬’a_šd
, &
size
, 
NULL
, 0))) {

54 
buf
[
BUFERROR_BUF
];

56 
	`buã¼Ü
(
”r
, 
buf
, (buf));

57 
	`‹¡_ç
("E¼Ü iÀm®lùl(): %s", 
buf
);

60 
i
 = 0; i < 
NTHREADS
; i++) {

61 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
,

62 (*)&
¬’a_šd
);

65 
i
 = 0; i < 
NTHREADS
; i++) {

66 
šŒ_t
 
još_»t
;

67 
	`thd_još
(
thds
[
i
], (*)&
još_»t
);

68 
	`as£¹_zd_eq
(
još_»t
, 0, "Unexpectedhread joinƒrror");

70 
	}
}

71 
TEST_END


74 
	$maš
()

77  (
	`‹¡
(

78 
‹¡_th»ad_¬’a
));

79 
	}
}

	@deps/jemalloc/test/integration/thread_tcache_enabled.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 cÚ¡ 
boŞ
 
	gcÚfig_tÿche
 =

4 #ifdeà
JEMALLOC_TCACHE


5 
Œue


7 
çl£


12 
	$thd_¡¬t
(*
¬g
)

14 
”r
;

15 
size_t
 
sz
;

16 
boŞ
 
e0
, 
e1
;

18 
sz
 = (
boŞ
);

19 ià((
”r
 = 
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, 
NULL
, 0))) {

20 ià(
”r
 =ğ
ENOENT
) {

21 
	`as£¹_çl£
(
cÚfig_tÿche
,

25 
Ïb–_ENOENT
;

28 ià(
e0
) {

29 
e1
 = 
çl£
;

30 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz),

32 
	`as£¹_Œue
(
e0
, "tcache should beƒnabled");

35 
e1
 = 
Œue
;

36 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

38 
	`as£¹_çl£
(
e0
, "tcache should be disabled");

40 
e1
 = 
Œue
;

41 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

43 
	`as£¹_Œue
(
e0
, "tcache should beƒnabled");

45 
e1
 = 
çl£
;

46 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

48 
	`as£¹_Œue
(
e0
, "tcache should beƒnabled");

50 
e1
 = 
çl£
;

51 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

53 
	`as£¹_çl£
(
e0
, "tcache should be disabled");

55 
	`ä“
(
	`m®loc
(1));

56 
e1
 = 
Œue
;

57 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

59 
	`as£¹_çl£
(
e0
, "tcache should be disabled");

61 
	`ä“
(
	`m®loc
(1));

62 
e1
 = 
Œue
;

63 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

65 
	`as£¹_Œue
(
e0
, "tcache should beƒnabled");

67 
	`ä“
(
	`m®loc
(1));

68 
e1
 = 
çl£
;

69 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

71 
	`as£¹_Œue
(
e0
, "tcache should beƒnabled");

73 
	`ä“
(
	`m®loc
(1));

74 
e1
 = 
çl£
;

75 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.’abËd", &
e0
, &
sz
, &
e1
, sz), 0,

77 
	`as£¹_çl£
(
e0
, "tcache should be disabled");

79 
	`ä“
(
	`m®loc
(1));

80  (
NULL
);

81 
Ïb–_ENOENT
:

82 
	`‹¡_sk
("\"thread.tcache.enabled\" mallctl‚ot‡vailable");

83  (
NULL
);

84 
	}
}

86 
	$TEST_BEGIN
(
‹¡_maš_th»ad
)

89 
	`thd_¡¬t
(
NULL
);

90 
	}
}

91 
TEST_END


93 
	$TEST_BEGIN
(
‹¡_subth»ad
)

95 
thd_t
 
thd
;

97 
	`thd_ü—‹
(&
thd
, 
thd_¡¬t
, 
NULL
);

98 
	`thd_još
(
thd
, 
NULL
);

99 
	}
}

100 
TEST_END


103 
	$maš
()

107  (
	`‹¡
(

108 
‹¡_maš_th»ad
,

109 
‹¡_subth»ad
,

110 
‹¡_maš_th»ad
,

111 
‹¡_subth»ad
,

112 
‹¡_maš_th»ad
));

113 
	}
}

	@deps/jemalloc/test/integration/xallocx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_§me_size
)

5 *
p
;

6 
size_t
 
sz
, 
tsz
;

8 
p
 = 
	`m®locx
(42, 0);

9 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

10 
sz
 = 
	`§Îocx
(
p
, 0);

12 
tsz
 = 
	`x®locx
(
p
, 
sz
, 0, 0);

13 
	`as£¹_zu_eq
(
tsz
, 
sz
, "Unexpected size change: %zu --> %zu", sz,sz);

15 
	`d®locx
(
p
, 0);

16 
	}
}

17 
TEST_END


19 
	$TEST_BEGIN
(
‹¡_exŒa_no_move
)

21 *
p
;

22 
size_t
 
sz
, 
tsz
;

24 
p
 = 
	`m®locx
(42, 0);

25 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

26 
sz
 = 
	`§Îocx
(
p
, 0);

28 
tsz
 = 
	`x®locx
(
p
, 
sz
, sz-42, 0);

29 
	`as£¹_zu_eq
(
tsz
, 
sz
, "Unexpected size change: %zu --> %zu", sz,sz);

31 
	`d®locx
(
p
, 0);

32 
	}
}

33 
TEST_END


35 
	$TEST_BEGIN
(
‹¡_no_move_ç
)

37 *
p
;

38 
size_t
 
sz
, 
tsz
;

40 
p
 = 
	`m®locx
(42, 0);

41 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

42 
sz
 = 
	`§Îocx
(
p
, 0);

44 
tsz
 = 
	`x®locx
(
p
, 
sz
 + 5, 0, 0);

45 
	`as£¹_zu_eq
(
tsz
, 
sz
, "Unexpected size change: %zu --> %zu", sz,sz);

47 
	`d®locx
(
p
, 0);

48 
	}
}

49 
TEST_END


52 
	$g‘_nsizes_im¶
(cÚ¡ *
cmd
)

54 
»t
;

55 
size_t
 
z
;

57 
z
 = ();

58 
	`as£¹_d_eq
(
	`m®lùl
(
cmd
, &
»t
, &
z
, 
NULL
, 0), 0,

59 "UÃx³ùed m®lùl(\"%s\", ...èçu»", 
cmd
);

61  (
»t
);

62 
	}
}

65 
	$g‘_nsm®l
()

68  (
	`g‘_nsizes_im¶
("arenas.nbins"));

69 
	}
}

72 
	$g‘_Æ¬ge
()

75  (
	`g‘_nsizes_im¶
("arenas.nlruns"));

76 
	}
}

79 
	$g‘_nhuge
()

82  (
	`g‘_nsizes_im¶
("arenas.nhchunks"));

83 
	}
}

85 
size_t


86 
	$g‘_size_im¶
(cÚ¡ *
cmd
, 
size_t
 
šd
)

88 
size_t
 
»t
;

89 
size_t
 
z
;

90 
size_t
 
mib
[4];

91 
size_t
 
mibËn
 = 4;

93 
z
 = (
size_t
);

94 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
(
cmd
, 
mib
, &
mibËn
),

95 0, "UÃx³ùed m®lùÊam‘omib(\"%s\", ...èçu»", 
cmd
);

96 
mib
[2] = 
šd
;

97 
z
 = (
size_t
);

98 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
»t
, &
z
, 
NULL
, 0),

99 0, "UÃx³ùed m®lùlbymib([\"%s\", %zu], ...èçu»", 
cmd
, 
šd
);

101  (
»t
);

102 
	}
}

104 
size_t


105 
	$g‘_sm®l_size
(
size_t
 
šd
)

108  (
	`g‘_size_im¶
("¬’as.bš.0.size", 
šd
));

109 
	}
}

111 
size_t


112 
	$g‘_Ïrge_size
(
size_t
 
šd
)

115  (
	`g‘_size_im¶
("¬’as.Ìun.0.size", 
šd
));

116 
	}
}

118 
size_t


119 
	$g‘_huge_size
(
size_t
 
šd
)

122  (
	`g‘_size_im¶
("¬’as.hchunk.0.size", 
šd
));

123 
	}
}

125 
	$TEST_BEGIN
(
‹¡_size
)

127 
size_t
 
sm®l0
, 
hugemax
;

128 *
p
;

131 
sm®l0
 = 
	`g‘_sm®l_size
(0);

132 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

134 
p
 = 
	`m®locx
(
sm®l0
, 0);

135 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

138 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 1, 0, 0), 
sm®l0
,

142 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
, 0, 0), hugemax,

146 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
+1, 0, 0), hugemax,

148 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
SIZE_T_MAX
, 0, 0), 
hugemax
,

151 
	`d®locx
(
p
, 0);

152 
	}
}

153 
TEST_END


155 
	$TEST_BEGIN
(
‹¡_size_exŒa_ov”æow
)

157 
size_t
 
sm®l0
, 
hugemax
;

158 *
p
;

161 
sm®l0
 = 
	`g‘_sm®l_size
(0);

162 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

164 
p
 = 
	`m®locx
(
sm®l0
, 0);

165 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

168 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
-1, 2, 0), hugemax,

170 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
, 1, 0), hugemax,

174 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
+1, 2, 0), hugemax,

176 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
+2, 3, 0), hugemax,

178 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
SIZE_T_MAX
-2, 2, 0), 
hugemax
,

180 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
SIZE_T_MAX
-1, 1, 0), 
hugemax
,

183 
	`d®locx
(
p
, 0);

184 
	}
}

185 
TEST_END


187 
	$TEST_BEGIN
(
‹¡_exŒa_sm®l
)

189 
size_t
 
sm®l0
, 
sm®l1
, 
hugemax
;

190 *
p
;

193 
sm®l0
 = 
	`g‘_sm®l_size
(0);

194 
sm®l1
 = 
	`g‘_sm®l_size
(1);

195 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

197 
p
 = 
	`m®locx
(
sm®l0
, 0);

198 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

200 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®l1
, 0, 0), 
sm®l0
,

203 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®l1
, 0, 0), 
sm®l0
,

206 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®l0
, 
sm®l1
 - small0, 0), small0,

210 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®l0
, 
hugemax
 - small0 + 1, 0), small0,

212 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®l0
, 
SIZE_T_MAX
 - small0, 0), small0,

215 
	`d®locx
(
p
, 0);

216 
	}
}

217 
TEST_END


219 
	$TEST_BEGIN
(
‹¡_exŒa_Ïrge
)

221 
size_t
 
sm®lmax
, 
Ïrge0
, 
Ïrge1
, 
Ïrge2
, 
huge0
, 
hugemax
;

222 *
p
;

225 
sm®lmax
 = 
	`g‘_sm®l_size
(
	`g‘_nsm®l
()-1);

226 
Ïrge0
 = 
	`g‘_Ïrge_size
(0);

227 
Ïrge1
 = 
	`g‘_Ïrge_size
(1);

228 
Ïrge2
 = 
	`g‘_Ïrge_size
(2);

229 
huge0
 = 
	`g‘_huge_size
(0);

230 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

232 
p
 = 
	`m®locx
(
Ïrge2
, 0);

233 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

235 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge2
, 0, 0),†arge2,

238 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 0, 0),†arge0,

240 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®lmax
, 0, 0), 
Ïrge0
,

243 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge2
, 0, 0),†arge2,

246 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 
Ïrge2
 -†arge0, 0),†arge2,

248 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge1
, 
Ïrge2
 -†arge1, 0),†arge2,

250 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 
Ïrge1
 -†arge0, 0),†arge1,

252 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sm®lmax
, 
Ïrge0
 - smallmax, 0),†arge0,

255 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 0, 0),†arge0,

258 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge2
, 0, 0),†arge2,

260 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge0
, 0, 0), 
Ïrge2
,

263 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 0, 0),†arge0,

266 
	`as£¹_zu_É
(
	`x®locx
(
p
, 
Ïrge0
, 
huge0
 -†arge0, 0), huge0,

269 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 0, 0),†arge0,

272 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge0
, 
Ïrge2
 -†arge0, 0),†arge2,

275 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
Ïrge2
, 0, 0),†arge2,

278 
	`as£¹_zu_É
(
	`x®locx
(
p
, 
Ïrge2
, 
hugemax
 -†¬ge2 + 1, 0), 
huge0
,

281 
	`d®locx
(
p
, 0);

282 
	}
}

283 
TEST_END


285 
	$TEST_BEGIN
(
‹¡_exŒa_huge
)

287 
size_t
 
Ïrgemax
, 
huge0
, 
huge1
, 
huge2
, 
hugemax
;

288 *
p
;

291 
Ïrgemax
 = 
	`g‘_Ïrge_size
(
	`g‘_Æ¬ge
()-1);

292 
huge0
 = 
	`g‘_huge_size
(0);

293 
huge1
 = 
	`g‘_huge_size
(1);

294 
huge2
 = 
	`g‘_huge_size
(2);

295 
hugemax
 = 
	`g‘_huge_size
(
	`g‘_nhuge
()-1);

297 
p
 = 
	`m®locx
(
huge2
, 0);

298 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

300 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge2
, 0, 0), huge2,

303 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
huge0
, 0, 0), huge0,

305 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
Ïrgemax
, 0, 0), 
huge0
,

308 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge2
, 0, 0), huge2,

311 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge0
, 
huge2
 - huge0, 0), huge2,

313 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge1
, 
huge2
 - huge1, 0), huge2,

315 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge0
, 
huge1
 - huge0, 0), huge1,

317 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
Ïrgemax
, 
huge0
 -†argemax, 0), huge0,

320 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
huge0
, 0, 0), huge0,

323 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
huge2
, 0, 0), huge2,

325 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
hugemax
+1, 0, 0), 
huge2
,

328 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
huge0
, 0, 0), huge0,

331 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
huge0
, 
SIZE_T_MAX
 - huge0, 0), 
hugemax
,

334 
	`as£¹_zu_ge
(
	`x®locx
(
p
, 
huge0
, 0, 0), huge0,

337 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
huge0
, 
huge2
 - huge0, 0), huge2,

340 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
huge2
, 0, 0), huge2,

343 
	`as£¹_zu_Ë
(
	`x®locx
(
p
, 
huge2
, 
hugemax
 - huge2 + 1, 0), hugemax,

346 
	`d®locx
(
p
, 0);

347 
	}
}

348 
TEST_END


351 
	$´št_fËd_ex‹Ás
(cÚ¡ *
p
, 
ušt8_t
 
c
, 
size_t
 
Ën
)

353 cÚ¡ 
ušt8_t
 *
pc
 = (cÚ¡ ušt8_ˆ*)
p
;

354 
size_t
 
i
, 
¿nge0
;

355 
ušt8_t
 
c0
;

357 
	`m®loc_´štf
("…=%p, c=%#x,†’=%zu:", 
p
, 
c
, 
Ën
);

358 
¿nge0
 = 0;

359 
c0
 = 
pc
[0];

360 
i
 = 0; i < 
Ën
; i++) {

361 ià(
pc
[
i
] !ğ
c0
) {

362 
	`m®loc_´štf
(" %#x[%zu..%zu)", 
c0
, 
¿nge0
, 
i
);

363 
¿nge0
 = 
i
;

364 
c0
 = 
pc
[
i
];

367 
	`m®loc_´štf
(" %#x[%zu..%zu)\n", 
c0
, 
¿nge0
, 
i
);

368 
	}
}

370 
boŞ


371 
	$v®id©e_fl
(cÚ¡ *
p
, 
ušt8_t
 
c
, 
size_t
 
off£t
, size_ˆ
Ën
)

373 cÚ¡ 
ušt8_t
 *
pc
 = (cÚ¡ ušt8_ˆ*)
p
;

374 
boŞ
 
”r
;

375 
size_t
 
i
;

377 
i
 = 
off£t
, 
”r
 = 
çl£
; i < off£t+
Ën
; i++) {

378 ià(
pc
[
i
] !ğ
c
)

379 
”r
 = 
Œue
;

382 ià(
”r
)

383 
	`´št_fËd_ex‹Ás
(
p
, 
c
, 
off£t
 + 
Ën
);

385  (
”r
);

386 
	}
}

389 
	$‹¡_z”o
(
size_t
 
szmš
, size_ˆ
szmax
)

391 
size_t
 
sz
, 
nsz
;

392 *
p
;

393 
	#FILL_BYTE
 0x7aU

	)

395 
sz
 = 
szmax
;

396 
p
 = 
	`m®locx
(
sz
, 
MALLOCX_ZERO
);

397 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx()ƒrror");

398 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 0x00, 0, 
sz
), "Memory‚ot filled: sz=%zu",

399 
sz
);

405 
	`mem£t
(
p
, 
FILL_BYTE
, 
sz
);

406 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
sz
),

407 "MemÜy‚Ù fËd: sz=%zu", 
sz
);

410 
sz
 = 
szmš
;

411 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sz
, 0, 
MALLOCX_ZERO
), sz,

413 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
sz
),

414 "MemÜy‚Ù fËd: sz=%zu", 
sz
);

416 
sz
 = 
szmš
; sz < 
szmax
; sz = 
nsz
) {

417 
nsz
 = 
	`ÇÎocx
(
sz
+1, 
MALLOCX_ZERO
);

418 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sz
+1, 0, 
MALLOCX_ZERO
), 
nsz
,

420 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
sz
),

421 "MemÜy‚Ù fËd: sz=%zu", 
sz
);

422 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 0x00, 
sz
, 
nsz
-sz),

423 "MemÜy‚Ù fËd: sz=%zu,‚sz-sz=%zu", 
sz
, 
nsz
-sz);

424 
	`mem£t
((*)((
ušŒ_t
)
p
 + 
sz
), 
FILL_BYTE
, 
nsz
-sz);

425 
	`as£¹_çl£
(
	`v®id©e_fl
(
p
, 
FILL_BYTE
, 0, 
nsz
),

426 "MemÜy‚Ù fËd:‚sz=%zu", 
nsz
);

429 
	`d®locx
(
p
, 0);

430 
	}
}

432 
	$TEST_BEGIN
(
‹¡_z”o_Ïrge
)

434 
size_t
 
Ïrge0
, 
Ïrgemax
;

437 
Ïrge0
 = 
	`g‘_Ïrge_size
(0);

438 
Ïrgemax
 = 
	`g‘_Ïrge_size
(
	`g‘_Æ¬ge
()-1);

440 
	`‹¡_z”o
(
Ïrge0
, 
Ïrgemax
);

441 
	}
}

442 
TEST_END


444 
	$TEST_BEGIN
(
‹¡_z”o_huge
)

446 
size_t
 
huge0
, 
huge1
;

449 
huge0
 = 
	`g‘_huge_size
(0);

450 
huge1
 = 
	`g‘_huge_size
(1);

452 
	`‹¡_z”o
(
huge1
, 
huge0
 * 2);

453 
	}
}

454 
TEST_END


457 
	$maš
()

460  (
	`‹¡
(

461 
‹¡_§me_size
,

462 
‹¡_exŒa_no_move
,

463 
‹¡_no_move_ç
,

464 
‹¡_size
,

465 
‹¡_size_exŒa_ov”æow
,

466 
‹¡_exŒa_sm®l
,

467 
‹¡_exŒa_Ïrge
,

468 
‹¡_exŒa_huge
,

469 
‹¡_z”o_Ïrge
,

470 
‹¡_z”o_huge
));

471 
	}
}

	@deps/jemalloc/test/src/SFMT.c

48 
	#SFMT_C_


	)

49 
	~"‹¡/jem®loc_‹¡.h
"

50 
	~"‹¡/SFMT-·¿ms.h
"

52 #ià
defšed
(
JEMALLOC_BIG_ENDIAN
è&& !defšed(
BIG_ENDIAN64
)

53 
	#BIG_ENDIAN64
 1

	)

55 #ià
defšed
(
__BIG_ENDIAN__
è&& !defšed(
__amd64
è&& !defšed(
BIG_ENDIAN64
)

56 
	#BIG_ENDIAN64
 1

	)

58 #ià
defšed
(
HAVE_ALTIVEC
è&& !defšed(
BIG_ENDIAN64
)

59 
	#BIG_ENDIAN64
 1

	)

61 #ià
defšed
(
ONLY64
è&& !defšed(
BIG_ENDIAN64
)

62 #ià
defšed
(
__GNUC__
)

65 #undeà
ONLY64


70 #ià
defšed
(
HAVE_ALTIVEC
)

72 
	uW128_T
 {

73 
veùÜ
 
	ms
;

74 
ušt32_t
 
	mu
[4];

77 
W128_T
 
	tw128_t
;

79 #–ià
defšed
(
HAVE_SSE2
)

81 
	uW128_T
 {

82 
__m128i
 
	msi
;

83 
ušt32_t
 
	mu
[4];

86 
W128_T
 
	tw128_t
;

91 
	sW128_T
 {

92 
ušt32_t
 
	mu
[4];

95 
W128_T
 
	tw128_t
;

99 
	ssfmt_s
 {

101 
w128_t
 
	msfmt
[
N
];

103 
	midx
;

106 
	mš™Ÿlized
;

115 
ušt32_t
 
	g·r™y
[4] = {
PARITY1
, 
PARITY2
, 
PARITY3
, 
PARITY4
};

120 
JEMALLOC_INLINE_C
 
idxof
(
i
);

121 #ià(!
defšed
(
HAVE_ALTIVEC
)è&& (!defšed(
HAVE_SSE2
))

122 
JEMALLOC_INLINE_C
 
rshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
);

123 
JEMALLOC_INLINE_C
 
lshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
);

125 
JEMALLOC_INLINE_C
 
g’_¿nd_®l
(
sfmt_t
 *
ùx
);

126 
JEMALLOC_INLINE_C
 
g’_¿nd_¬¿y
(
sfmt_t
 *
ùx
, 
w128_t
 *
¬¿y
, 
size
);

127 
JEMALLOC_INLINE_C
 
ušt32_t
 
func1
(ušt32_ˆ
x
);

128 
JEMALLOC_INLINE_C
 
ušt32_t
 
func2
(ušt32_ˆ
x
);

129 
³riod_û¹ifiÿtiÚ
(
sfmt_t
 *
ùx
);

130 #ià
defšed
(
BIG_ENDIAN64
è&& !defšed(
ONLY64
)

131 
JEMALLOC_INLINE_C
 
sw­
(
w128_t
 *
¬¿y
, 
size
);

134 #ià
defšed
(
HAVE_ALTIVEC
)

135 
	~"‹¡/SFMT-®ti.h
"

136 #–ià
defšed
(
HAVE_SSE2
)

137 
	~"‹¡/SFMT-s£2.h
"

144 #ifdeà
ONLY64


145 
JEMALLOC_INLINE_C
 
	$idxof
(
i
) {

146  
i
 ^ 1;

147 
	}
}

149 
JEMALLOC_INLINE_C
 
	$idxof
(
i
) {

150  
i
;

151 
	}
}

161 #ià(!
defšed
(
HAVE_ALTIVEC
)è&& (!defšed(
HAVE_SSE2
))

162 #ifdeà
ONLY64


163 
JEMALLOC_INLINE_C
 
	$rshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
) {

164 
ušt64_t
 
th
, 

, 
oh
, 
Ş
;

166 
th
 = ((
ušt64_t
)
š
->
u
[2] << 32) | ((uint64_t)in->u[3]);

167 

 = ((
ušt64_t
)
š
->
u
[0] << 32) | ((uint64_t)in->u[1]);

169 
oh
 = 
th
 >> (
shiá
 * 8);

170 
Ş
 = 

 >> (
shiá
 * 8);

171 
Ş
 |ğ
th
 << (64 - 
shiá
 * 8);

172 
out
->
u
[0] = (
ušt32_t
)(
Ş
 >> 32);

173 
out
->
u
[1] = (
ušt32_t
)
Ş
;

174 
out
->
u
[2] = (
ušt32_t
)(
oh
 >> 32);

175 
out
->
u
[3] = (
ušt32_t
)
oh
;

176 
	}
}

178 
JEMALLOC_INLINE_C
 
	$rshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
) {

179 
ušt64_t
 
th
, 

, 
oh
, 
Ş
;

181 
th
 = ((
ušt64_t
)
š
->
u
[3] << 32) | ((uint64_t)in->u[2]);

182 

 = ((
ušt64_t
)
š
->
u
[1] << 32) | ((uint64_t)in->u[0]);

184 
oh
 = 
th
 >> (
shiá
 * 8);

185 
Ş
 = 

 >> (
shiá
 * 8);

186 
Ş
 |ğ
th
 << (64 - 
shiá
 * 8);

187 
out
->
u
[1] = (
ušt32_t
)(
Ş
 >> 32);

188 
out
->
u
[0] = (
ušt32_t
)
Ş
;

189 
out
->
u
[3] = (
ušt32_t
)(
oh
 >> 32);

190 
out
->
u
[2] = (
ušt32_t
)
oh
;

191 
	}
}

201 #ifdeà
ONLY64


202 
JEMALLOC_INLINE_C
 
	$lshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
) {

203 
ušt64_t
 
th
, 

, 
oh
, 
Ş
;

205 
th
 = ((
ušt64_t
)
š
->
u
[2] << 32) | ((uint64_t)in->u[3]);

206 

 = ((
ušt64_t
)
š
->
u
[0] << 32) | ((uint64_t)in->u[1]);

208 
oh
 = 
th
 << (
shiá
 * 8);

209 
Ş
 = 

 << (
shiá
 * 8);

210 
oh
 |ğ

 >> (64 - 
shiá
 * 8);

211 
out
->
u
[0] = (
ušt32_t
)(
Ş
 >> 32);

212 
out
->
u
[1] = (
ušt32_t
)
Ş
;

213 
out
->
u
[2] = (
ušt32_t
)(
oh
 >> 32);

214 
out
->
u
[3] = (
ušt32_t
)
oh
;

215 
	}
}

217 
JEMALLOC_INLINE_C
 
	$lshiá128
(
w128_t
 *
out
, w128_ˆcÚ¡ *
š
, 
shiá
) {

218 
ušt64_t
 
th
, 

, 
oh
, 
Ş
;

220 
th
 = ((
ušt64_t
)
š
->
u
[3] << 32) | ((uint64_t)in->u[2]);

221 

 = ((
ušt64_t
)
š
->
u
[1] << 32) | ((uint64_t)in->u[0]);

223 
oh
 = 
th
 << (
shiá
 * 8);

224 
Ş
 = 

 << (
shiá
 * 8);

225 
oh
 |ğ

 >> (64 - 
shiá
 * 8);

226 
out
->
u
[1] = (
ušt32_t
)(
Ş
 >> 32);

227 
out
->
u
[0] = (
ušt32_t
)
Ş
;

228 
out
->
u
[3] = (
ušt32_t
)(
oh
 >> 32);

229 
out
->
u
[2] = (
ušt32_t
)
oh
;

230 
	}
}

242 #ià(!
defšed
(
HAVE_ALTIVEC
)è&& (!defšed(
HAVE_SSE2
))

243 #ifdeà
ONLY64


244 
JEMALLOC_INLINE_C
 
	$do_»cursiÚ
(
w128_t
 *
r
, w128_ˆ*
a
, w128_ˆ*
b
, w128_ˆ*
c
,

245 
w128_t
 *
d
) {

246 
w128_t
 
x
;

247 
w128_t
 
y
;

249 
	`lshiá128
(&
x
, 
a
, 
SL2
);

250 
	`rshiá128
(&
y
, 
c
, 
SR2
);

251 
r
->
u
[0] = 
a
->u[0] ^ 
x
.u[0] ^ ((
b
->u[0] >> 
SR1
è& 
MSK2
è^ 
y
.u[0]

252 ^ (
d
->
u
[0] << 
SL1
);

253 
r
->
u
[1] = 
a
->u[1] ^ 
x
.u[1] ^ ((
b
->u[1] >> 
SR1
è& 
MSK1
è^ 
y
.u[1]

254 ^ (
d
->
u
[1] << 
SL1
);

255 
r
->
u
[2] = 
a
->u[2] ^ 
x
.u[2] ^ ((
b
->u[2] >> 
SR1
è& 
MSK4
è^ 
y
.u[2]

256 ^ (
d
->
u
[2] << 
SL1
);

257 
r
->
u
[3] = 
a
->u[3] ^ 
x
.u[3] ^ ((
b
->u[3] >> 
SR1
è& 
MSK3
è^ 
y
.u[3]

258 ^ (
d
->
u
[3] << 
SL1
);

259 
	}
}

261 
JEMALLOC_INLINE_C
 
	$do_»cursiÚ
(
w128_t
 *
r
, w128_ˆ*
a
, w128_ˆ*
b
, w128_ˆ*
c
,

262 
w128_t
 *
d
) {

263 
w128_t
 
x
;

264 
w128_t
 
y
;

266 
	`lshiá128
(&
x
, 
a
, 
SL2
);

267 
	`rshiá128
(&
y
, 
c
, 
SR2
);

268 
r
->
u
[0] = 
a
->u[0] ^ 
x
.u[0] ^ ((
b
->u[0] >> 
SR1
è& 
MSK1
è^ 
y
.u[0]

269 ^ (
d
->
u
[0] << 
SL1
);

270 
r
->
u
[1] = 
a
->u[1] ^ 
x
.u[1] ^ ((
b
->u[1] >> 
SR1
è& 
MSK2
è^ 
y
.u[1]

271 ^ (
d
->
u
[1] << 
SL1
);

272 
r
->
u
[2] = 
a
->u[2] ^ 
x
.u[2] ^ ((
b
->u[2] >> 
SR1
è& 
MSK3
è^ 
y
.u[2]

273 ^ (
d
->
u
[2] << 
SL1
);

274 
r
->
u
[3] = 
a
->u[3] ^ 
x
.u[3] ^ ((
b
->u[3] >> 
SR1
è& 
MSK4
è^ 
y
.u[3]

275 ^ (
d
->
u
[3] << 
SL1
);

276 
	}
}

280 #ià(!
defšed
(
HAVE_ALTIVEC
)è&& (!defšed(
HAVE_SSE2
))

285 
JEMALLOC_INLINE_C
 
	$g’_¿nd_®l
(
sfmt_t
 *
ùx
) {

286 
i
;

287 
w128_t
 *
r1
, *
r2
;

289 
r1
 = &
ùx
->
sfmt
[
N
 - 2];

290 
r2
 = &
ùx
->
sfmt
[
N
 - 1];

291 
i
 = 0; i < 
N
 - 
POS1
; i++) {

292 
	`do_»cursiÚ
(&
ùx
->
sfmt
[
i
], &ùx->sfmt[i], &ùx->sfmt[˜+ 
POS1
], 
r1
,

293 
r2
);

294 
r1
 = 
r2
;

295 
r2
 = &
ùx
->
sfmt
[
i
];

297 ; 
i
 < 
N
; i++) {

298 
	`do_»cursiÚ
(&
ùx
->
sfmt
[
i
], &ùx->sfmt[i], &ùx->sfmt[˜+ 
POS1
 - 
N
], 
r1
,

299 
r2
);

300 
r1
 = 
r2
;

301 
r2
 = &
ùx
->
sfmt
[
i
];

303 
	}
}

312 
JEMALLOC_INLINE_C
 
	$g’_¿nd_¬¿y
(
sfmt_t
 *
ùx
, 
w128_t
 *
¬¿y
, 
size
) {

313 
i
, 
j
;

314 
w128_t
 *
r1
, *
r2
;

316 
r1
 = &
ùx
->
sfmt
[
N
 - 2];

317 
r2
 = &
ùx
->
sfmt
[
N
 - 1];

318 
i
 = 0; i < 
N
 - 
POS1
; i++) {

319 
	`do_»cursiÚ
(&
¬¿y
[
i
], &
ùx
->
sfmt
[i], &ùx->sfmt[˜+ 
POS1
], 
r1
, 
r2
);

320 
r1
 = 
r2
;

321 
r2
 = &
¬¿y
[
i
];

323 ; 
i
 < 
N
; i++) {

324 
	`do_»cursiÚ
(&
¬¿y
[
i
], &
ùx
->
sfmt
[i], &¬¿y[˜+ 
POS1
 - 
N
], 
r1
, 
r2
);

325 
r1
 = 
r2
;

326 
r2
 = &
¬¿y
[
i
];

328 ; 
i
 < 
size
 - 
N
; i++) {

329 
	`do_»cursiÚ
(&
¬¿y
[
i
], &¬¿y[˜- 
N
], &¬¿y[˜+ 
POS1
 - N], 
r1
, 
r2
);

330 
r1
 = 
r2
;

331 
r2
 = &
¬¿y
[
i
];

333 
j
 = 0; j < 2 * 
N
 - 
size
; j++) {

334 
ùx
->
sfmt
[
j
] = 
¬¿y
[j + 
size
 - 
N
];

336 ; 
i
 < 
size
; i++, 
j
++) {

337 
	`do_»cursiÚ
(&
¬¿y
[
i
], &¬¿y[˜- 
N
], &¬¿y[˜+ 
POS1
 - N], 
r1
, 
r2
);

338 
r1
 = 
r2
;

339 
r2
 = &
¬¿y
[
i
];

340 
ùx
->
sfmt
[
j
] = 
¬¿y
[
i
];

342 
	}
}

345 #ià
defšed
(
BIG_ENDIAN64
è&& !defšed(
ONLY64
è&& !defšed(
HAVE_ALTIVEC
)

346 
JEMALLOC_INLINE_C
 
	$sw­
(
w128_t
 *
¬¿y
, 
size
) {

347 
i
;

348 
ušt32_t
 
x
, 
y
;

350 
i
 = 0; i < 
size
; i++) {

351 
x
 = 
¬¿y
[
i
].
u
[0];

352 
y
 = 
¬¿y
[
i
].
u
[2];

353 
¬¿y
[
i
].
u
[0] =‡rray[i].u[1];

354 
¬¿y
[
i
].
u
[2] =‡rray[i].u[3];

355 
¬¿y
[
i
].
u
[1] = 
x
;

356 
¬¿y
[
i
].
u
[3] = 
y
;

358 
	}
}

366 
ušt32_t
 
	$func1
(
ušt32_t
 
x
) {

367  (
x
 ^ (x >> 27)è* (
ušt32_t
)1664525UL;

368 
	}
}

376 
ušt32_t
 
	$func2
(
ušt32_t
 
x
) {

377  (
x
 ^ (x >> 27)è* (
ušt32_t
)1566083941UL;

378 
	}
}

383 
	$³riod_û¹ifiÿtiÚ
(
sfmt_t
 *
ùx
) {

384 
šÃr
 = 0;

385 
i
, 
j
;

386 
ušt32_t
 
wÜk
;

387 
ušt32_t
 *
psfmt32
 = &
ùx
->
sfmt
[0].
u
[0];

389 
i
 = 0; i < 4; i++)

390 
šÃr
 ^ğ
psfmt32
[
	`idxof
(
i
)] & 
·r™y
[i];

391 
i
 = 16; i > 0; i >>= 1)

392 
šÃr
 ^ğšÃ¸>> 
i
;

393 
šÃr
 &= 1;

395 ià(
šÃr
 == 1) {

399 
i
 = 0; i < 4; i++) {

400 
wÜk
 = 1;

401 
j
 = 0; j < 32; j++) {

402 ià((
wÜk
 & 
·r™y
[
i
]) != 0) {

403 
psfmt32
[
	`idxof
(
i
)] ^ğ
wÜk
;

406 
wÜk
 = work << 1;

409 
	}
}

419 cÚ¡ *
	$g‘_id¡ršg
() {

420  
IDSTR
;

421 
	}
}

428 
	$g‘_mš_¬¿y_size32
() {

429  
N32
;

430 
	}
}

437 
	$g‘_mš_¬¿y_size64
() {

438  
N64
;

439 
	}
}

441 #iâdeà
ONLY64


447 
ušt32_t
 
	$g’_¿nd32
(
sfmt_t
 *
ùx
) {

448 
ušt32_t
 
r
;

449 
ušt32_t
 *
psfmt32
 = &
ùx
->
sfmt
[0].
u
[0];

451 
	`as£¹
(
ùx
->
š™Ÿlized
);

452 ià(
ùx
->
idx
 >ğ
N32
) {

453 
	`g’_¿nd_®l
(
ùx
);

454 
ùx
->
idx
 = 0;

456 
r
 = 
psfmt32
[
ùx
->
idx
++];

457  
r
;

458 
	}
}

461 
ušt32_t
 
	$g’_¿nd32_¿nge
(
sfmt_t
 *
ùx
, 
ušt32_t
 
lim™
) {

462 
ušt32_t
 
»t
, 
above
;

464 
above
 = 0xffffffffU - (0xffffffffU % 
lim™
);

466 
»t
 = 
	`g’_¿nd32
(
ùx
);

467 ià(
»t
 < 
above
) {

468 
»t
 %ğ
lim™
;

472  
»t
;

473 
	}
}

482 
ušt64_t
 
	$g’_¿nd64
(
sfmt_t
 *
ùx
) {

483 #ià
	`defšed
(
BIG_ENDIAN64
è&& !defšed(
ONLY64
)

484 
ušt32_t
 
r1
, 
r2
;

485 
ušt32_t
 *
psfmt32
 = &
ùx
->
sfmt
[0].
u
[0];

487 
ušt64_t
 
r
;

488 
ušt64_t
 *
psfmt64
 = (ušt64_ˆ*)&
ùx
->
sfmt
[0].
u
[0];

491 
	`as£¹
(
ùx
->
š™Ÿlized
);

492 
	`as£¹
(
ùx
->
idx
 % 2 == 0);

494 ià(
ùx
->
idx
 >ğ
N32
) {

495 
	`g’_¿nd_®l
(
ùx
);

496 
ùx
->
idx
 = 0;

498 #ià
	`defšed
(
BIG_ENDIAN64
è&& !defšed(
ONLY64
)

499 
r1
 = 
psfmt32
[
ùx
->
idx
];

500 
r2
 = 
psfmt32
[
ùx
->
idx
 + 1];

501 
ùx
->
idx
 += 2;

502  ((
ušt64_t
)
r2
 << 32è| 
r1
;

504 
r
 = 
psfmt64
[
ùx
->
idx
 / 2];

505 
ùx
->
idx
 += 2;

506  
r
;

508 
	}
}

511 
ušt64_t
 
	$g’_¿nd64_¿nge
(
sfmt_t
 *
ùx
, 
ušt64_t
 
lim™
) {

512 
ušt64_t
 
»t
, 
above
;

514 
above
 = 
	`KQU
(0xffffffffffffffffè- (KQU(0xffffffffffffffffè% 
lim™
);

516 
»t
 = 
	`g’_¿nd64
(
ùx
);

517 ià(
»t
 < 
above
) {

518 
»t
 %ğ
lim™
;

522  
»t
;

523 
	}
}

525 #iâdeà
ONLY64


551 
	$fl_¬¿y32
(
sfmt_t
 *
ùx
, 
ušt32_t
 *
¬¿y
, 
size
) {

552 
	`as£¹
(
ùx
->
š™Ÿlized
);

553 
	`as£¹
(
ùx
->
idx
 =ğ
N32
);

554 
	`as£¹
(
size
 % 4 == 0);

555 
	`as£¹
(
size
 >ğ
N32
);

557 
	`g’_¿nd_¬¿y
(
ùx
, (
w128_t
 *)
¬¿y
, 
size
 / 4);

558 
ùx
->
idx
 = 
N32
;

559 
	}
}

587 
	$fl_¬¿y64
(
sfmt_t
 *
ùx
, 
ušt64_t
 *
¬¿y
, 
size
) {

588 
	`as£¹
(
ùx
->
š™Ÿlized
);

589 
	`as£¹
(
ùx
->
idx
 =ğ
N32
);

590 
	`as£¹
(
size
 % 2 == 0);

591 
	`as£¹
(
size
 >ğ
N64
);

593 
	`g’_¿nd_¬¿y
(
ùx
, (
w128_t
 *)
¬¿y
, 
size
 / 2);

594 
ùx
->
idx
 = 
N32
;

596 #ià
	`defšed
(
BIG_ENDIAN64
è&& !defšed(
ONLY64
)

597 
	`sw­
((
w128_t
 *)
¬¿y
, 
size
 /2);

599 
	}
}

607 
sfmt_t
 *
	$š™_g’_¿nd
(
ušt32_t
 
£ed
) {

608 *
p
;

609 
sfmt_t
 *
ùx
;

610 
i
;

611 
ušt32_t
 *
psfmt32
;

613 ià(
	`posix_mem®ign
(&
p
, (
w128_t
), (
sfmt_t
)) != 0) {

614  
NULL
;

616 
ùx
 = (
sfmt_t
 *)
p
;

617 
psfmt32
 = &
ùx
->
sfmt
[0].
u
[0];

619 
psfmt32
[
	`idxof
(0)] = 
£ed
;

620 
i
 = 1; i < 
N32
; i++) {

621 
psfmt32
[
	`idxof
(
i
)] = 1812433253UL * (psfmt32[idxof(i - 1)]

622 ^ (
psfmt32
[
	`idxof
(
i
 - 1)] >> 30))

623 + 
i
;

625 
ùx
->
idx
 = 
N32
;

626 
	`³riod_û¹ifiÿtiÚ
(
ùx
);

627 
ùx
->
š™Ÿlized
 = 1;

629  
ùx
;

630 
	}
}

638 
sfmt_t
 *
	$š™_by_¬¿y
(
ušt32_t
 *
š™_key
, 
key_Ëngth
) {

639 *
p
;

640 
sfmt_t
 *
ùx
;

641 
i
, 
j
, 
couÁ
;

642 
ušt32_t
 
r
;

643 
Ïg
;

644 
mid
;

645 
size
 = 
N
 * 4;

646 
ušt32_t
 *
psfmt32
;

648 ià(
	`posix_mem®ign
(&
p
, (
w128_t
), (
sfmt_t
)) != 0) {

649  
NULL
;

651 
ùx
 = (
sfmt_t
 *)
p
;

652 
psfmt32
 = &
ùx
->
sfmt
[0].
u
[0];

654 ià(
size
 >= 623) {

655 
Ïg
 = 11;

656 } ià(
size
 >= 68) {

657 
Ïg
 = 7;

658 } ià(
size
 >= 39) {

659 
Ïg
 = 5;

661 
Ïg
 = 3;

663 
mid
 = (
size
 - 
Ïg
) / 2;

665 
	`mem£t
(
ùx
->
sfmt
, 0x8b, (ctx->sfmt));

666 ià(
key_Ëngth
 + 1 > 
N32
) {

667 
couÁ
 = 
key_Ëngth
 + 1;

669 
couÁ
 = 
N32
;

671 
r
 = 
	`func1
(
psfmt32
[
	`idxof
(0)] ^…sfmt32[idxof(
mid
)]

672 ^ 
psfmt32
[
	`idxof
(
N32
 - 1)]);

673 
psfmt32
[
	`idxof
(
mid
)] +ğ
r
;

674 
r
 +ğ
key_Ëngth
;

675 
psfmt32
[
	`idxof
(
mid
 + 
Ïg
)] +ğ
r
;

676 
psfmt32
[
	`idxof
(0)] = 
r
;

678 
couÁ
--;

679 
i
 = 1, 
j
 = 0; (j < 
couÁ
è&& (j < 
key_Ëngth
); j++) {

680 
r
 = 
	`func1
(
psfmt32
[
	`idxof
(
i
)] ^…sfmt32[idxof((˜+ 
mid
è% 
N32
)]

681 ^ 
psfmt32
[
	`idxof
((
i
 + 
N32
 - 1) % N32)]);

682 
psfmt32
[
	`idxof
((
i
 + 
mid
è% 
N32
)] +ğ
r
;

683 
r
 +ğ
š™_key
[
j
] + 
i
;

684 
psfmt32
[
	`idxof
((
i
 + 
mid
 + 
Ïg
è% 
N32
)] +ğ
r
;

685 
psfmt32
[
	`idxof
(
i
)] = 
r
;

686 
i
 = (˜+ 1è% 
N32
;

688 ; 
j
 < 
couÁ
; j++) {

689 
r
 = 
	`func1
(
psfmt32
[
	`idxof
(
i
)] ^…sfmt32[idxof((˜+ 
mid
è% 
N32
)]

690 ^ 
psfmt32
[
	`idxof
((
i
 + 
N32
 - 1) % N32)]);

691 
psfmt32
[
	`idxof
((
i
 + 
mid
è% 
N32
)] +ğ
r
;

692 
r
 +ğ
i
;

693 
psfmt32
[
	`idxof
((
i
 + 
mid
 + 
Ïg
è% 
N32
)] +ğ
r
;

694 
psfmt32
[
	`idxof
(
i
)] = 
r
;

695 
i
 = (˜+ 1è% 
N32
;

697 
j
 = 0; j < 
N32
; j++) {

698 
r
 = 
	`func2
(
psfmt32
[
	`idxof
(
i
)] +…sfmt32[idxof((˜+ 
mid
è% 
N32
)]

699 + 
psfmt32
[
	`idxof
((
i
 + 
N32
 - 1) % N32)]);

700 
psfmt32
[
	`idxof
((
i
 + 
mid
è% 
N32
)] ^ğ
r
;

701 
r
 -ğ
i
;

702 
psfmt32
[
	`idxof
((
i
 + 
mid
 + 
Ïg
è% 
N32
)] ^ğ
r
;

703 
psfmt32
[
	`idxof
(
i
)] = 
r
;

704 
i
 = (˜+ 1è% 
N32
;

707 
ùx
->
idx
 = 
N32
;

708 
	`³riod_û¹ifiÿtiÚ
(
ùx
);

709 
ùx
->
š™Ÿlized
 = 1;

711  
ùx
;

712 
	}
}

714 
	$fši_g’_¿nd
(
sfmt_t
 *
ùx
) {

715 
	`as£¹
(
ùx
 !ğ
NULL
);

717 
ùx
->
š™Ÿlized
 = 0;

718 
	`ä“
(
ùx
);

719 
	}
}

	@deps/jemalloc/test/src/btalloc.c

1 
	~"‹¡/jem®loc_‹¡.h
"

4 
	$bÎoc
(
size_t
 
size
, 
b™s
)

7  (
	`bÎoc_0
(
size
, 
b™s
));

8 
	}
}

	@deps/jemalloc/test/src/btalloc_0.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
bÎoc_n_g’
(0)

	@deps/jemalloc/test/src/btalloc_1.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
bÎoc_n_g’
(1)

	@deps/jemalloc/test/src/math.c

1 
	#MATH_C_


	)

2 
	~"‹¡/jem®loc_‹¡.h
"

	@deps/jemalloc/test/src/mq.c

1 
	~"‹¡/jem®loc_‹¡.h
"

8 
	$mq_Çno¦“p
(
ns
)

11 
	`as£¹
(
ns
 <= 1000*1000*1000);

13 #ifdeà
_WIN32


14 
	`SË•
(
ns
 / 1000);

17 
time¥ec
 
timeout
;

19 ià(
ns
 < 1000*1000*1000) {

20 
timeout
.
tv_£c
 = 0;

21 
timeout
.
tv_n£c
 = 
ns
;

23 
timeout
.
tv_£c
 = 1;

24 
timeout
.
tv_n£c
 = 0;

26 
	`Çno¦“p
(&
timeout
, 
NULL
);

29 
	}
}

	@deps/jemalloc/test/src/mtx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #iâdeà
_CRT_SPINCOUNT


4 
	#_CRT_SPINCOUNT
 4000

	)

7 
boŞ


8 
	$mtx_š™
(
mtx_t
 *
mtx
)

11 #ifdeà
_WIN32


12 ià(!
	`In™ŸlizeCr™iÿlSeùiÚAndSpšCouÁ
(&
mtx
->
lock
, 
_CRT_SPINCOUNT
))

13  (
Œue
);

14 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

15 
mtx
->
lock
 = 0;

17 
±h»ad_mu‹x©Œ_t
 
©Œ
;

19 ià(
	`±h»ad_mu‹x©Œ_š™
(&
©Œ
) != 0)

20  (
Œue
);

21 
	`±h»ad_mu‹x©Œ_£‰y³
(&
©Œ
, 
PTHREAD_MUTEX_DEFAULT
);

22 ià(
	`±h»ad_mu‹x_š™
(&
mtx
->
lock
, &
©Œ
) != 0) {

23 
	`±h»ad_mu‹x©Œ_de¡roy
(&
©Œ
);

24  (
Œue
);

26 
	`±h»ad_mu‹x©Œ_de¡roy
(&
©Œ
);

28  (
çl£
);

29 
	}
}

32 
	$mtx_fši
(
mtx_t
 *
mtx
)

35 #ifdeà
_WIN32


36 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

38 
	`±h»ad_mu‹x_de¡roy
(&
mtx
->
lock
);

40 
	}
}

43 
	$mtx_lock
(
mtx_t
 *
mtx
)

46 #ifdeà
_WIN32


47 
	`EÁ”Cr™iÿlSeùiÚ
(&
mtx
->
lock
);

48 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

49 
	`OSSpšLockLock
(&
mtx
->
lock
);

51 
	`±h»ad_mu‹x_lock
(&
mtx
->
lock
);

53 
	}
}

56 
	$mtx_uÆock
(
mtx_t
 *
mtx
)

59 #ifdeà
_WIN32


60 
	`L—veCr™iÿlSeùiÚ
(&
mtx
->
lock
);

61 #–ià(
	`defšed
(
JEMALLOC_OSSPIN
))

62 
	`OSSpšLockUÆock
(&
mtx
->
lock
);

64 
	`±h»ad_mu‹x_uÆock
(&
mtx
->
lock
);

66 
	}
}

	@deps/jemalloc/test/src/test.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	g‹¡_couÁ
 = 0;

4 
‹¡_¡©us_t
 
	g‹¡_couÁs
[
‹¡_¡©us_couÁ
] = {0, 0, 0};

5 
‹¡_¡©us_t
 
	g‹¡_¡©us
 = 
‹¡_¡©us_·ss
;

6 cÚ¡ * 
	g‹¡_Çme
 = "";

8 
	$JEMALLOC_FORMAT_PRINTF
(1, 2)

10 
	$‹¡_sk
(cÚ¡ *
fÜm©
, ...)

12 
va_li¡
 
­
;

14 
	`va_¡¬t
(
­
, 
fÜm©
);

15 
	`m®loc_vırštf
(
NULL
, NULL, 
fÜm©
, 
­
);

16 
	`va_’d
(
­
);

17 
	`m®loc_´štf
("\n");

18 
‹¡_¡©us
 = 
‹¡_¡©us_sk
;

19 
	}
}

21 
	$JEMALLOC_FORMAT_PRINTF
(1, 2)

23 
	$‹¡_ç
(cÚ¡ *
fÜm©
, ...)

25 
va_li¡
 
­
;

27 
	`va_¡¬t
(
­
, 
fÜm©
);

28 
	`m®loc_vırštf
(
NULL
, NULL, 
fÜm©
, 
­
);

29 
	`va_’d
(
­
);

30 
	`m®loc_´štf
("\n");

31 
‹¡_¡©us
 = 
‹¡_¡©us_ç
;

32 
	}
}

35 
	$‹¡_¡©us_¡ršg
(
‹¡_¡©us_t
 
‹¡_¡©us
)

38 
‹¡_¡©us
) {

39 
‹¡_¡©us_·ss
:  "pass";

40 
‹¡_¡©us_sk
:  "skip";

41 
‹¡_¡©us_ç
:  "fail";

42 : 
	`nÙ_»ached
();

44 
	}
}

47 
	$p_‹¡_š™
(cÚ¡ *
Çme
)

50 
‹¡_couÁ
++;

51 
‹¡_¡©us
 = 
‹¡_¡©us_·ss
;

52 
‹¡_Çme
 = 
Çme
;

53 
	}
}

56 
	$p_‹¡_fši
()

59 
‹¡_couÁs
[
‹¡_¡©us
]++;

60 
	`m®loc_´štf
("%s: %s\n", 
‹¡_Çme
, 
	`‹¡_¡©us_¡ršg
(
‹¡_¡©us
));

61 
	}
}

63 
‹¡_¡©us_t


64 
	$p_‹¡
(
‹¡_t
 *
t
, ...)

66 
‹¡_¡©us_t
 
»t
;

67 
va_li¡
 
­
;

76 ià(
	`ÇÎocx
(1, 0) == 0) {

77 
	`m®loc_´štf
("Initializationƒrror");

78  (
‹¡_¡©us_ç
);

81 
»t
 = 
‹¡_¡©us_·ss
;

82 
	`va_¡¬t
(
­
, 
t
);

83 ; 
t
 !ğ
NULL
; = 
	`va_¬g
(
­
, 
‹¡_t
 *)) {

84 
	`t
();

85 ià(
‹¡_¡©us
 > 
»t
)

86 
»t
 = 
‹¡_¡©us
;

88 
	`va_’d
(
­
);

90 
	`m®loc_´štf
("--- %s: %u/%u, %s: %u/%u, %s: %u/%u ---\n",

91 
	`‹¡_¡©us_¡ršg
(
‹¡_¡©us_·ss
),

92 
‹¡_couÁs
[
‹¡_¡©us_·ss
], 
‹¡_couÁ
,

93 
	`‹¡_¡©us_¡ršg
(
‹¡_¡©us_sk
),

94 
‹¡_couÁs
[
‹¡_¡©us_sk
], 
‹¡_couÁ
,

95 
	`‹¡_¡©us_¡ršg
(
‹¡_¡©us_ç
),

96 
‹¡_couÁs
[
‹¡_¡©us_ç
], 
‹¡_couÁ
);

98  (
»t
);

99 
	}
}

102 
	$p_‹¡_ç
(cÚ¡ *
´efix
, cÚ¡ *
mes§ge
)

105 
	`m®loc_ırštf
(
NULL
, NULL, "%s%s\n", 
´efix
, 
mes§ge
);

106 
‹¡_¡©us
 = 
‹¡_¡©us_ç
;

107 
	}
}

	@deps/jemalloc/test/src/thd.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
_WIN32


5 
	$thd_ü—‹
(
thd_t
 *
thd
, *(*
´oc
)(*), *
¬g
)

7 
LPTHREAD_START_ROUTINE
 
routše
 = (LPTHREAD_START_ROUTINE)
´oc
;

8 *
thd
 = 
	`C»©eTh»ad
(
NULL
, 0, 
routše
, 
¬g
, 0, NULL);

9 ià(*
thd
 =ğ
NULL
)

10 
	`‹¡_ç
("Error in CreateThread()\n");

11 
	}
}

14 
	$thd_još
(
thd_t
 
thd
, **
»t
)

17 ià(
	`Wa™FÜSšgËObjeù
(
thd
, 
INFINITE
è=ğ
WAIT_OBJECT_0
 && 
»t
) {

18 
DWORD
 
ex™_code
;

19 
	`G‘Ex™CodeTh»ad
(
thd
, (
LPDWORD
è&
ex™_code
);

20 *
»t
 = (*)(
ušŒ_t
)
ex™_code
;

22 
	}
}

26 
	$thd_ü—‹
(
thd_t
 *
thd
, *(*
´oc
)(*), *
¬g
)

29 ià(
	`±h»ad_ü—‹
(
thd
, 
NULL
, 
´oc
, 
¬g
) != 0)

30 
	`‹¡_ç
("Error in…thread_create()\n");

31 
	}
}

34 
	$thd_još
(
thd_t
 
thd
, **
»t
)

37 
	`±h»ad_još
(
thd
, 
»t
);

38 
	}
}

	@deps/jemalloc/test/src/timer.c

1 
	~"‹¡/jem®loc_‹¡.h
"

4 
	$tim”_¡¬t
(
timed–_t
 *
tim”
)

7 #ifdeà
_WIN32


8 
	`G‘Sy¡emTimeAsFeTime
(&
tim”
->
á0
);

9 #–ià
JEMALLOC_CLOCK_GETTIME


10 ià(
	`syscÚf
(
_SC_MONOTONIC_CLOCK
) <= 0)

11 
tim”
->
şock_id
 = 
CLOCK_REALTIME
;

13 
tim”
->
şock_id
 = 
CLOCK_MONOTONIC
;

14 
	`şock_g‘time
(
tim”
->
şock_id
, &tim”->
ts0
);

16 
	`g‘timeofday
(&
tim”
->
tv0
, 
NULL
);

18 
	}
}

21 
	$tim”_¡İ
(
timed–_t
 *
tim”
)

24 #ifdeà
_WIN32


25 
	`G‘Sy¡emTimeAsFeTime
(&
tim”
->
á0
);

26 #–ià
JEMALLOC_CLOCK_GETTIME


27 
	`şock_g‘time
(
tim”
->
şock_id
, &tim”->
ts1
);

29 
	`g‘timeofday
(&
tim”
->
tv1
, 
NULL
);

31 
	}
}

33 
ušt64_t


34 
	$tim”_u£c
(cÚ¡ 
timed–_t
 *
tim”
)

37 #ifdeà
_WIN32


38 
ušt64_t
 
t0
, 
t1
;

39 
t0
 = (((
ušt64_t
)
tim”
->
á0
.
dwHighD©eTime
) << 32) |

40 
tim”
->
á0
.
dwLowD©eTime
;

41 
t1
 = (((
ušt64_t
)
tim”
->
á1
.
dwHighD©eTime
) << 32) |

42 
tim”
->
á1
.
dwLowD©eTime
;

43  ((
t1
 - 
t0
) / 10);

44 #–ià
JEMALLOC_CLOCK_GETTIME


45  (((
tim”
->
ts1
.
tv_£c
 -im”->
ts0
.tv_sec) * 1000000) +

46 (
tim”
->
ts1
.
tv_n£c
 -im”->
ts0
.tv_nsec) / 1000);

48  (((
tim”
->
tv1
.
tv_£c
 -im”->
tv0
.tv_sec) * 1000000) +

49 
tim”
->
tv1
.
tv_u£c
 -im”->
tv0
.tv_usec);

51 
	}
}

54 
	$tim”_¿tio
(
timed–_t
 *
a
,imed–_ˆ*
b
, *
buf
, 
size_t
 
buæ’
)

56 
ušt64_t
 
t0
 = 
	`tim”_u£c
(
a
);

57 
ušt64_t
 
t1
 = 
	`tim”_u£c
(
b
);

58 
ušt64_t
 
muÉ
;

59 
i
 = 0;

60 
j
;

61 
n
;

64 
n
 = 
	`m®loc_¢´štf
(&
buf
[
i
], 
buæ’
-i, "%"
FMTu64
, 
t0
 / 
t1
);

65 
i
 +ğ
n
;

66 ià(
i
 >ğ
buæ’
)

68 
muÉ
 = 1;

69 
j
 = 0; j < 
n
; j++)

70 
muÉ
 *= 10;

73 
n
 = 
	`m®loc_¢´štf
(&
buf
[
i
], 
buæ’
-i, ".");

74 
i
 +ğ
n
;

77 
i
 < 
buæ’
-1) {

78 
ušt64_t
 
round
 = (
i
+1 =ğ
buæ’
-1 && ((
t0
 * 
muÉ
 * 10 / 
t1
) % 10

80 
n
 = 
	`m®loc_¢´štf
(&
buf
[
i
], 
buæ’
-i,

81 "%"
FMTu64
, (
t0
 * 
muÉ
 / 
t1
è% 10 + 
round
);

82 
i
 +ğ
n
;

83 
muÉ
 *= 10;

85 
	}
}

	@deps/jemalloc/test/stress/microbench.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
JEMALLOC_INLINE_C
 

4 
	$time_func
(
timed–_t
 *
tim”
, 
ušt64_t
 
nw¬mup
, ušt64_ˆ
n™”
, (*
func
)())

6 
ušt64_t
 
i
;

8 
i
 = 0; i < 
nw¬mup
; i++)

9 
	`func
();

10 
	`tim”_¡¬t
(
tim”
);

11 
i
 = 0; i < 
n™”
; i++)

12 
	`func
();

13 
	`tim”_¡İ
(
tim”
);

14 
	}
}

17 
com·»_funcs
(
ušt64_t
 
nw¬mup
, ušt64_ˆ
n™”
, cÚ¡ *
Çme_a
,

18 (*
func_a
), cÚ¡ *
Çme_b
, (*
func_b
))

20 
timed–_t
 
tim”_a
, 
tim”_b
;

21 
¿tio_buf
[6];

22 *
p
;

24 
p
 = 
	`m®locx
(1, 0);

25 ià(
p
 =ğ
NULL
) {

26 
	`‹¡_ç
("Unexpected mallocx() failure");

30 
	`time_func
(&
tim”_a
, 
nw¬mup
, 
n™”
, 
func_a
);

31 
	`time_func
(&
tim”_b
, 
nw¬mup
, 
n™”
, 
func_b
);

33 
	`tim”_¿tio
(&
tim”_a
, &
tim”_b
, 
¿tio_buf
, (ratio_buf));

34 
	`m®loc_´štf
("%"
FMTu64
" iterations, %s=%"FMTu64"us, "

35 "%s=%"
FMTu64
"us,„atio=1:%s\n",

36 
n™”
, 
Çme_a
, 
	`tim”_u£c
(&
tim”_a
), 
Çme_b
,im”_u£c(&
tim”_b
),

37 
¿tio_buf
);

39 
	`d®locx
(
p
, 0);

40 
	}
}

43 
	$m®loc_ä“
()

46 *
p
 = 
	`m®loc
(1);

47 ià(
p
 =ğ
NULL
) {

48 
	`‹¡_ç
("Unexpected malloc() failure");

51 
	`ä“
(
p
);

52 
	}
}

55 
	$m®locx_ä“
()

57 *
p
 = 
	`m®locx
(1, 0);

58 ià(
p
 =ğ
NULL
) {

59 
	`‹¡_ç
("Unexpected mallocx() failure");

62 
	`ä“
(
p
);

63 
	}
}

65 
	$TEST_BEGIN
(
‹¡_m®loc_vs_m®locx
)

68 
	`com·»_funcs
(10*1000*1000, 100*1000*1000, "malloc",

69 
m®loc_ä“
, "m®locx", 
m®locx_ä“
);

70 
	}
}

71 
TEST_END


74 
	$m®loc_d®locx
()

76 *
p
 = 
	`m®loc
(1);

77 ià(
p
 =ğ
NULL
) {

78 
	`‹¡_ç
("Unexpected malloc() failure");

81 
	`d®locx
(
p
, 0);

82 
	}
}

85 
	$m®loc_sd®locx
()

87 *
p
 = 
	`m®loc
(1);

88 ià(
p
 =ğ
NULL
) {

89 
	`‹¡_ç
("Unexpected malloc() failure");

92 
	`sd®locx
(
p
, 1, 0);

93 
	}
}

95 
	$TEST_BEGIN
(
‹¡_ä“_vs_d®locx
)

98 
	`com·»_funcs
(10*1000*1000, 100*1000*1000, "ä“", 
m®loc_ä“
,

99 "d®locx", 
m®loc_d®locx
);

100 
	}
}

101 
TEST_END


103 
	$TEST_BEGIN
(
‹¡_d®locx_vs_sd®locx
)

106 
	`com·»_funcs
(10*1000*1000, 100*1000*1000, "d®locx", 
m®loc_d®locx
,

107 "sd®locx", 
m®loc_sd®locx
);

108 
	}
}

109 
TEST_END


112 
	$m®loc_mus_ä“
()

114 *
p
;

116 
p
 = 
	`m®loc
(1);

117 ià(
p
 =ğ
NULL
) {

118 
	`‹¡_ç
("Unexpected malloc() failure");

121 
	`m®loc_u§bË_size
(
p
);

122 
	`ä“
(
p
);

123 
	}
}

126 
	$m®loc_§Îocx_ä“
()

128 *
p
;

130 
p
 = 
	`m®loc
(1);

131 ià(
p
 =ğ
NULL
) {

132 
	`‹¡_ç
("Unexpected malloc() failure");

135 ià(
	`§Îocx
(
p
, 0) < 1)

136 
	`‹¡_ç
("Unexpected sallocx() failure");

137 
	`ä“
(
p
);

138 
	}
}

140 
	$TEST_BEGIN
(
‹¡_mus_vs_§Îocx
)

143 
	`com·»_funcs
(10*1000*1000, 100*1000*1000, "malloc_usable_size",

144 
m®loc_mus_ä“
, "§Îocx", 
m®loc_§Îocx_ä“
);

145 
	}
}

146 
TEST_END


149 
	$m®loc_ÇÎocx_ä“
()

151 *
p
;

153 
p
 = 
	`m®loc
(1);

154 ià(
p
 =ğ
NULL
) {

155 
	`‹¡_ç
("Unexpected malloc() failure");

158 ià(
	`ÇÎocx
(1, 0) < 1)

159 
	`‹¡_ç
("Unexpected‚allocx() failure");

160 
	`ä“
(
p
);

161 
	}
}

163 
	$TEST_BEGIN
(
‹¡_§Îocx_vs_ÇÎocx
)

166 
	`com·»_funcs
(10*1000*1000, 100*1000*1000, "sallocx",

167 
m®loc_§Îocx_ä“
, "ÇÎocx", 
m®loc_ÇÎocx_ä“
);

168 
	}
}

169 
TEST_END


172 
	$maš
()

175  (
	`‹¡
(

176 
‹¡_m®loc_vs_m®locx
,

177 
‹¡_ä“_vs_d®locx
,

178 
‹¡_d®locx_vs_sd®locx
,

179 
‹¡_mus_vs_§Îocx
,

180 
‹¡_§Îocx_vs_ÇÎocx
));

181 
	}
}

	@deps/jemalloc/test/unit/SFMT.c

36 
	~"‹¡/jem®loc_‹¡.h
"

38 
	#BLOCK_SIZE
 10000

	)

39 
	#BLOCK_SIZE64
 (
BLOCK_SIZE
 / 2)

	)

40 
	#COUNT_1
 1000

	)

41 
	#COUNT_2
 700

	)

43 cÚ¡ 
ušt32_t
 
	gš™_g’_¿nd_32_ex³ùed
[] = {

245 cÚ¡ 
ušt32_t
 
	gš™_by_¬¿y_32_ex³ùed
[] = {

447 cÚ¡ 
ušt64_t
 
	gš™_g’_¿nd_64_ex³ùed
[] = {

448 
KQU
(16924766246869039260), KQU( 8201438687333352714),

449 
KQU
( 2265290287015001750), KQU(18397264611805473832),

450 
KQU
( 3375255223302384358), KQU( 6345559975416828796),

451 
KQU
(18229739242790328073), KQU( 7596792742098800905),

452 
KQU
( 255338647169685981), KQU( 2052747240048610300),

453 
KQU
(18328151576097299343), KQU(12472905421133796567),

454 
KQU
(11315245349717600863), KQU(16594110197775871209),

455 
KQU
(15708751964632456450), KQU(10452031272054632535),

456 
KQU
(11097646720811454386), KQU( 4556090668445745441),

457 
KQU
(17116187693090663106), KQU(14931526836144510645),

458 
KQU
( 9190752218020552591), KQU( 9625800285771901401),

459 
KQU
(13995141077659972832), KQU( 5194209094927829625),

460 
KQU
( 4156788379151063303), KQU( 8523452593770139494),

461 
KQU
(14082382103049296727), KQU( 2462601863986088483),

462 
KQU
( 3030583461592840678), KQU( 5221622077872827681),

463 
KQU
( 3084210671228981236), KQU(13956758381389953823),

464 
KQU
(13503889856213423831), KQU(15696904024189836170),

465 
KQU
( 4612584152877036206), KQU( 6231135538447867881),

466 
KQU
(10172457294158869468), KQU( 6452258628466708150),

467 
KQU
(14044432824917330221), KQU( 370168364480044279),

468 
KQU
(10102144686427193359), KQU( 667870489994776076),

469 
KQU
( 2732271956925885858), KQU(18027788905977284151),

470 
KQU
(15009842788582923859), KQU( 7136357960180199542),

471 
KQU
(15901736243475578127), KQU(16951293785352615701),

472 
KQU
(10551492125243691632), KQU(17668869969146434804),

473 
KQU
(13646002971174390445), KQU( 9804471050759613248),

474 
KQU
( 5511670439655935493), KQU(18103342091070400926),

475 
KQU
(17224512747665137533), KQU(15534627482992618168),

476 
KQU
( 1423813266186582647), KQU(15821176807932930024),

477 
KQU
( 30323369733607156), KQU(11599382494723479403),

478 
KQU
( 653856076586810062), KQU( 3176437395144899659),

479 
KQU
(14028076268147963917), KQU(16156398271809666195),

480 
KQU
( 3166955484848201676), KQU( 5746805620136919390),

481 
KQU
(17297845208891256593), KQU(11691653183226428483),

482 
KQU
(17900026146506981577), KQU(15387382115755971042),

483 
KQU
(16923567681040845943), KQU( 8039057517199388606),

484 
KQU
(11748409241468629263), KQU( 794358245539076095),

485 
KQU
(13438501964693401242), KQU(14036803236515618962),

486 
KQU
( 5252311215205424721), KQU(17806589612915509081),

487 
KQU
( 6802767092397596006), KQU(14212120431184557140),

488 
KQU
( 1072951366761385712), KQU(13098491780722836296),

489 
KQU
( 9466676828710797353), KQU(12673056849042830081),

490 
KQU
(12763726623645357580), KQU(16468961652999309493),

491 
KQU
(15305979875636438926), KQU(17444713151223449734),

492 
KQU
( 5692214267627883674), KQU(13049589139196151505),

493 
KQU
( 880115207831670745), KQU( 1776529075789695498),

494 
KQU
(16695225897801466485), KQU(10666901778795346845),

495 
KQU
( 6164389346722833869), KQU( 2863817793264300475),

496 
KQU
( 9464049921886304754), KQU( 3993566636740015468),

497 
KQU
( 9983749692528514136), KQU(16375286075057755211),

498 
KQU
(16042643417005440820), KQU(11445419662923489877),

499 
KQU
( 7999038846885158836), KQU( 6721913661721511535),

500 
KQU
( 5363052654139357320), KQU( 1817788761173584205),

501 
KQU
(13290974386445856444), KQU( 4650350818937984680),

502 
KQU
( 8219183528102484836), KQU( 1569862923500819899),

503 
KQU
( 4189359732136641860), KQU(14202822961683148583),

504 
KQU
( 4457498315309429058), KQU(13089067387019074834),

505 
KQU
(11075517153328927293), KQU(10277016248336668389),

506 
KQU
( 7070509725324401122), KQU(17808892017780289380),

507 
KQU
(13143367339909287349), KQU( 1377743745360085151),

508 
KQU
( 5749341807421286485), KQU(14832814616770931325),

509 
KQU
( 7688820635324359492), KQU(10960474011539770045),

510 
KQU
( 81970066653179790), KQU(12619476072607878022),

511 
KQU
( 4419566616271201744), KQU(15147917311750568503),

512 
KQU
( 5549739182852706345), KQU( 7308198397975204770),

513 
KQU
(13580425496671289278), KQU(17070764785210130301),

514 
KQU
( 8202832846285604405), KQU( 6873046287640887249),

515 
KQU
( 6927424434308206114), KQU( 6139014645937224874),

516 
KQU
(10290373645978487639), KQU(15904261291701523804),

517 
KQU
( 9628743442057826883), KQU(18383429096255546714),

518 
KQU
( 4977413265753686967), KQU( 7714317492425012869),

519 
KQU
( 9025232586309926193), KQU(14627338359776709107),

520 
KQU
(14759849896467790763), KQU(10931129435864423252),

521 
KQU
( 4588456988775014359), KQU(10699388531797056724),

522 
KQU
( 468652268869238792), KQU( 5755943035328078086),

523 
KQU
( 2102437379988580216), KQU( 9986312786506674028),

524 
KQU
( 2654207180040945604), KQU( 8726634790559960062),

525 
KQU
( 100497234871808137), KQU( 2800137176951425819),

526 
KQU
( 6076627612918553487), KQU( 5780186919186152796),

527 
KQU
( 8179183595769929098), KQU( 6009426283716221169),

528 
KQU
( 2796662551397449358), KQU( 1756961367041986764),

529 
KQU
( 6972897917355606205), KQU(14524774345368968243),

530 
KQU
( 2773529684745706940), KQU( 4853632376213075959),

531 
KQU
( 4198177923731358102), KQU( 8271224913084139776),

532 
KQU
( 2741753121611092226), KQU(16782366145996731181),

533 
KQU
(15426125238972640790), KQU(13595497100671260342),

534 
KQU
( 3173531022836259898), KQU( 6573264560319511662),

535 
KQU
(18041111951511157441), KQU( 2351433581833135952),

536 
KQU
( 3113255578908173487), KQU( 1739371330877858784),

537 
KQU
(16046126562789165480), KQU( 8072101652214192925),

538 
KQU
(15267091584090664910), KQU( 9309579200403648940),

539 
KQU
( 5218892439752408722), KQU(14492477246004337115),

540 
KQU
(17431037586679770619), KQU( 7385248135963250480),

541 
KQU
( 9580144956565560660), KQU( 4919546228040008720),

542 
KQU
(15261542469145035584), KQU(18233297270822253102),

543 
KQU
( 5453248417992302857), KQU( 9309519155931460285),

544 
KQU
(10342813012345291756), KQU(15676085186784762381),

545 
KQU
(15912092950691300645), KQU( 9371053121499003195),

546 
KQU
( 9897186478226866746), KQU(14061858287188196327),

547 
KQU
( 122575971620788119), KQU(12146750969116317754),

548 
KQU
( 4438317272813245201), KQU( 8332576791009527119),

549 
KQU
(13907785691786542057), KQU(10374194887283287467),

550 
KQU
( 2098798755649059566), KQU( 3416235197748288894),

551 
KQU
( 8688269957320773484), KQU( 7503964602397371571),

552 
KQU
(16724977015147478236), KQU( 9461512855439858184),

553 
KQU
(13259049744534534727), KQU( 3583094952542899294),

554 
KQU
( 8764245731305528292), KQU(13240823595462088985),

555 
KQU
(13716141617617910448), KQU(18114969519935960955),

556 
KQU
( 2297553615798302206), KQU( 4585521442944663362),

557 
KQU
(17776858680630198686), KQU( 4685873229192163363),

558 
KQU
( 152558080671135627), KQU(15424900540842670088),

559 
KQU
(13229630297130024108), KQU(17530268788245718717),

560 
KQU
(16675633913065714144), KQU( 3158912717897568068),

561 
KQU
(15399132185380087288), KQU( 7401418744515677872),

562 
KQU
(13135412922344398535), KQU( 6385314346100509511),

563 
KQU
(13962867001134161139), KQU(10272780155442671999),

564 
KQU
(12894856086597769142), KQU(13340877795287554994),

565 
KQU
(12913630602094607396), KQU(12543167911119793857),

566 
KQU
(17343570372251873096), KQU(10959487764494150545),

567 
KQU
( 6966737953093821128), KQU(13780699135496988601),

568 
KQU
( 4405070719380142046), KQU(14923788365607284982),

569 
KQU
( 2869487678905148380), KQU( 6416272754197188403),

570 
KQU
(15017380475943612591), KQU( 1995636220918429487),

571 
KQU
( 3402016804620122716), KQU(15800188663407057080),

572 
KQU
(11362369990390932882), KQU(15262183501637986147),

573 
KQU
(10239175385387371494), KQU( 9352042420365748334),

574 
KQU
( 1682457034285119875), KQU( 1724710651376289644),

575 
KQU
( 2038157098893817966), KQU( 9897825558324608773),

576 
KQU
( 1477666236519164736), KQU(16835397314511233640),

577 
KQU
(10370866327005346508), KQU(10157504370660621982),

578 
KQU
(12113904045335882069), KQU(13326444439742783008),

579 
KQU
(11302769043000765804), KQU(13594979923955228484),

580 
KQU
(11779351762613475968), KQU( 3786101619539298383),

581 
KQU
( 8021122969180846063), KQU(15745904401162500495),

582 
KQU
(10762168465993897267), KQU(13552058957896319026),

583 
KQU
(11200228655252462013), KQU( 5035370357337441226),

584 
KQU
( 7593918984545500013), KQU( 5418554918361528700),

585 
KQU
( 4858270799405446371), KQU( 9974659566876282544),

586 
KQU
(18227595922273957859), KQU( 2772778443635656220),

587 
KQU
(14285143053182085385), KQU( 9939700992429600469),

588 
KQU
(12756185904545598068), KQU( 2020783375367345262),

589 
KQU
( 57026775058331227), KQU( 950827867930065454),

590 
KQU
( 6602279670145371217), KQU( 2291171535443566929),

591 
KQU
( 5832380724425010313), KQU( 1220343904715982285),

592 
KQU
(17045542598598037633), KQU(15460481779702820971),

593 
KQU
(13948388779949365130), KQU(13975040175430829518),

594 
KQU
(17477538238425541763), KQU(11104663041851745725),

595 
KQU
(15860992957141157587), KQU(14529434633012950138),

596 
KQU
( 2504838019075394203), KQU( 7512113882611121886),

597 
KQU
( 4859973559980886617), KQU( 1258601555703250219),

598 
KQU
(15594548157514316394), KQU( 4516730171963773048),

599 
KQU
(11380103193905031983), KQU( 6809282239982353344),

600 
KQU
(18045256930420065002), KQU( 2453702683108791859),

601 
KQU
( 977214582986981460), KQU( 2006410402232713466),

602 
KQU
( 6192236267216378358), KQU( 3429468402195675253),

603 
KQU
(18146933153017348921), KQU(17369978576367231139),

604 
KQU
( 1246940717230386603), KQU(11335758870083327110),

605 
KQU
(14166488801730353682), KQU( 9008573127269635732),

606 
KQU
(10776025389820643815), KQU(15087605441903942962),

607 
KQU
( 1359542462712147922), KQU(13898874411226454206),

608 
KQU
(17911176066536804411), KQU( 9435590428600085274),

609 
KQU
( 294488509967864007), KQU( 8890111397567922046),

610 
KQU
( 7987823476034328778), KQU(13263827582440967651),

611 
KQU
( 7503774813106751573), KQU(14974747296185646837),

612 
KQU
( 8504765037032103375), KQU(17340303357444536213),

613 
KQU
( 7704610912964485743), KQU( 8107533670327205061),

614 
KQU
( 9062969835083315985), KQU(16968963142126734184),

615 
KQU
(12958041214190810180), KQU( 2720170147759570200),

616 
KQU
( 2986358963942189566), KQU(14884226322219356580),

617 
KQU
( 286224325144368520), KQU(11313800433154279797),

618 
KQU
(18366849528439673248), KQU(17899725929482368789),

619 
KQU
( 3730004284609106799), KQU( 1654474302052767205),

620 
KQU
( 5006698007047077032), KQU( 8196893913601182838),

621 
KQU
(15214541774425211640), KQU(17391346045606626073),

622 
KQU
( 8369003584076969089), KQU( 3939046733368550293),

623 
KQU
(10178639720308707785), KQU( 2180248669304388697),

624 
KQU
( 62894391300126322), KQU( 9205708961736223191),

625 
KQU
( 6837431058165360438), KQU( 3150743890848308214),

626 
KQU
(17849330658111464583), KQU(12214815643135450865),

627 
KQU
(13410713840519603402), KQU( 3200778126692046802),

628 
KQU
(13354780043041779313), KQU( 800850022756886036),

629 
KQU
(15660052933953067433), KQU( 6572823544154375676),

630 
KQU
(11030281857015819266), KQU(12682241941471433835),

631 
KQU
(11654136407300274693), KQU( 4517795492388641109),

632 
KQU
( 9757017371504524244), KQU(17833043400781889277),

633 
KQU
(12685085201747792227), KQU(10408057728835019573),

634 
KQU
( 98370418513455221), KQU( 6732663555696848598),

635 
KQU
(13248530959948529780), KQU( 3530441401230622826),

636 
KQU
(18188251992895660615), KQU( 1847918354186383756),

637 
KQU
( 1127392190402660921), KQU(11293734643143819463),

638 
KQU
( 3015506344578682982), KQU(13852645444071153329),

639 
KQU
( 2121359659091349142), KQU( 1294604376116677694),

640 
KQU
( 5616576231286352318), KQU( 7112502442954235625),

641 
KQU
(11676228199551561689), KQU(12925182803007305359),

642 
KQU
( 7852375518160493082), KQU( 1136513130539296154),

643 
KQU
( 5636923900916593195), KQU( 3221077517612607747),

644 
KQU
(17784790465798152513), KQU( 3554210049056995938),

645 
KQU
(17476839685878225874), KQU( 3206836372585575732),

646 
KQU
( 2765333945644823430), KQU(10080070903718799528),

647 
KQU
( 5412370818878286353), KQU( 9689685887726257728),

648 
KQU
( 8236117509123533998), KQU( 1951139137165040214),

649 
KQU
( 4492205209227980349), KQU(16541291230861602967),

650 
KQU
( 1424371548301437940), KQU( 9117562079669206794),

651 
KQU
(14374681563251691625), KQU(13873164030199921303),

652 
KQU
( 6680317946770936731), KQU(15586334026918276214),

653 
KQU
(10896213950976109802), KQU( 9506261949596413689),

654 
KQU
( 9903949574308040616), KQU( 6038397344557204470),

655 
KQU
( 174601465422373648), KQU(15946141191338238030),

656 
KQU
(17142225620992044937), KQU( 7552030283784477064),

657 
KQU
( 2947372384532947997), KQU( 510797021688197711),

658 
KQU
( 4962499439249363461), KQU( 23770320158385357),

659 
KQU
( 959774499105138124), KQU( 1468396011518788276),

660 
KQU
( 2015698006852312308), KQU( 4149400718489980136),

661 
KQU
( 5992916099522371188), KQU(10819182935265531076),

662 
KQU
(16189787999192351131), KQU( 342833961790261950),

663 
KQU
(12470830319550495336), KQU(18128495041912812501),

664 
KQU
( 1193600899723524337), KQU( 9056793666590079770),

665 
KQU
( 2154021227041669041), KQU( 4963570213951235735),

666 
KQU
( 4865075960209211409), KQU( 2097724599039942963),

667 
KQU
( 2024080278583179845), KQU(11527054549196576736),

668 
KQU
(10650256084182390252), KQU( 4808408648695766755),

669 
KQU
( 1642839215013788844), KQU(10607187948250398390),

670 
KQU
( 7076868166085913508), KQU( 730522571106887032),

671 
KQU
(12500579240208524895), KQU( 4484390097311355324),

672 
KQU
(15145801330700623870), KQU( 8055827661392944028),

673 
KQU
( 5865092976832712268), KQU(15159212508053625143),

674 
KQU
( 3560964582876483341), KQU( 4070052741344438280),

675 
KQU
( 6032585709886855634), KQU(15643262320904604873),

676 
KQU
( 2565119772293371111), KQU( 318314293065348260),

677 
KQU
(15047458749141511872), KQU( 7772788389811528730),

678 
KQU
( 7081187494343801976), KQU( 6465136009467253947),

679 
KQU
(10425940692543362069), KQU( 554608190318339115),

680 
KQU
(14796699860302125214), KQU( 1638153134431111443),

681 
KQU
(10336967447052276248), KQU( 8412308070396592958),

682 
KQU
( 4004557277152051226), KQU( 8143598997278774834),

683 
KQU
(16413323996508783221), KQU(13139418758033994949),

684 
KQU
( 9772709138335006667), KQU( 2818167159287157659),

685 
KQU
(17091740573832523669), KQU(14629199013130751608),

686 
KQU
(18268322711500338185), KQU( 8290963415675493063),

687 
KQU
( 8830864907452542588), KQU( 1614839084637494849),

688 
KQU
(14855358500870422231), KQU( 3472996748392519937),

689 
KQU
(15317151166268877716), KQU( 5825895018698400362),

690 
KQU
(16730208429367544129), KQU(10481156578141202800),

691 
KQU
( 4746166512382823750), KQU(12720876014472464998),

692 
KQU
( 8825177124486735972), KQU(13733447296837467838),

693 
KQU
( 6412293741681359625), KQU( 8313213138756135033),

694 
KQU
(11421481194803712517), KQU( 7997007691544174032),

695 
KQU
( 6812963847917605930), KQU( 9683091901227558641),

696 
KQU
(14703594165860324713), KQU( 1775476144519618309),

697 
KQU
( 2724283288516469519), KQU( 717642555185856868),

698 
KQU
( 8736402192215092346), KQU(11878800336431381021),

699 
KQU
( 4348816066017061293), KQU( 6115112756583631307),

700 
KQU
( 9176597239667142976), KQU(12615622714894259204),

701 
KQU
(10283406711301385987), KQU( 5111762509485379420),

702 
KQU
( 3118290051198688449), KQU( 7345123071632232145),

703 
KQU
( 9176423451688682359), KQU( 4843865456157868971),

704 
KQU
(12008036363752566088), KQU(12058837181919397720),

705 
KQU
( 2145073958457347366), KQU( 1526504881672818067),

706 
KQU
( 3488830105567134848), KQU(13208362960674805143),

707 
KQU
( 4077549672899572192), KQU( 7770995684693818365),

708 
KQU
( 1398532341546313593), KQU(12711859908703927840),

709 
KQU
( 1417561172594446813), KQU(17045191024194170604),

710 
KQU
( 4101933177604931713), KQU(14708428834203480320),

711 
KQU
(17447509264469407724), KQU(14314821973983434255),

712 
KQU
(17990472271061617265), KQU( 5087756685841673942),

713 
KQU
(12797820586893859939), KQU( 1778128952671092879),

714 
KQU
( 3535918530508665898), KQU( 9035729701042481301),

715 
KQU
(14808661568277079962), KQU(14587345077537747914),

716 
KQU
(11920080002323122708), KQU( 6426515805197278753),

717 
KQU
( 3295612216725984831), KQU(11040722532100876120),

718 
KQU
(12305952936387598754), KQU(16097391899742004253),

719 
KQU
( 4908537335606182208), KQU(12446674552196795504),

720 
KQU
(16010497855816895177), KQU( 9194378874788615551),

721 
KQU
( 3382957529567613384), KQU( 5154647600754974077),

722 
KQU
( 9801822865328396141), KQU( 9023662173919288143),

723 
KQU
(17623115353825147868), KQU( 8238115767443015816),

724 
KQU
(15811444159859002560), KQU( 9085612528904059661),

725 
KQU
( 6888601089398614254), KQU( 258252992894160189),

726 
KQU
( 6704363880792428622), KQU( 6114966032147235763),

727 
KQU
(11075393882690261875), KQU( 8797664238933620407),

728 
KQU
( 5901892006476726920), KQU( 5309780159285518958),

729 
KQU
(14940808387240817367), KQU(14642032021449656698),

730 
KQU
( 9808256672068504139), KQU( 3670135111380607658),

731 
KQU
(11211211097845960152), KQU( 1474304506716695808),

732 
KQU
(15843166204506876239), KQU( 7661051252471780561),

733 
KQU
(10170905502249418476), KQU( 7801416045582028589),

734 
KQU
( 2763981484737053050), KQU( 9491377905499253054),

735 
KQU
(16201395896336915095), KQU( 9256513756442782198),

736 
KQU
( 5411283157972456034), KQU( 5059433122288321676),

737 
KQU
( 4327408006721123357), KQU( 9278544078834433377),

738 
KQU
( 7601527110882281612), KQU(11848295896975505251),

739 
KQU
(12096998801094735560), KQU(14773480339823506413),

740 
KQU
(15586227433895802149), KQU(12786541257830242872),

741 
KQU
( 6904692985140503067), KQU( 5309011515263103959),

742 
KQU
(12105257191179371066), KQU(14654380212442225037),

743 
KQU
( 2556774974190695009), KQU( 4461297399927600261),

744 
KQU
(14888225660915118646), KQU(14915459341148291824),

745 
KQU
( 2738802166252327631), KQU( 6047155789239131512),

746 
KQU
(12920545353217010338), KQU(10697617257007840205),

747 
KQU
( 2751585253158203504), KQU(13252729159780047496),

748 
KQU
(14700326134672815469), KQU(14082527904374600529),

749 
KQU
(16852962273496542070), KQU(17446675504235853907),

750 
KQU
(15019600398527572311), KQU(12312781346344081551),

751 
KQU
(14524667935039810450), KQU( 5634005663377195738),

752 
KQU
(11375574739525000569), KQU( 2423665396433260040),

753 
KQU
( 5222836914796015410), KQU( 4397666386492647387),

754 
KQU
( 4619294441691707638), KQU( 665088602354770716),

755 
KQU
(13246495665281593610), KQU( 6564144270549729409),

756 
KQU
(10223216188145661688), KQU( 3961556907299230585),

757 
KQU
(11543262515492439914), KQU(16118031437285993790),

758 
KQU
( 7143417964520166465), KQU(13295053515909486772),

759 
KQU
( 40434666004899675), KQU(17127804194038347164),

760 
KQU
( 8599165966560586269), KQU( 8214016749011284903),

761 
KQU
(13725130352140465239), KQU( 5467254474431726291),

762 
KQU
( 7748584297438219877), KQU(16933551114829772472),

763 
KQU
( 2169618439506799400), KQU( 2169787627665113463),

764 
KQU
(17314493571267943764), KQU(18053575102911354912),

765 
KQU
(11928303275378476973), KQU(11593850925061715550),

766 
KQU
(17782269923473589362), KQU( 3280235307704747039),

767 
KQU
( 6145343578598685149), KQU(17080117031114086090),

768 
KQU
(18066839902983594755), KQU( 6517508430331020706),

769 
KQU
( 8092908893950411541), KQU(12558378233386153732),

770 
KQU
( 4476532167973132976), KQU(16081642430367025016),

771 
KQU
( 4233154094369139361), KQU( 8693630486693161027),

772 
KQU
(11244959343027742285), KQU(12273503967768513508),

773 
KQU
(14108978636385284876), KQU( 7242414665378826984),

774 
KQU
( 6561316938846562432), KQU( 8601038474994665795),

775 
KQU
(17532942353612365904), KQU(17940076637020912186),

776 
KQU
( 7340260368823171304), KQU( 7061807613916067905),

777 
KQU
(10561734935039519326), KQU(17990796503724650862),

778 
KQU
( 6208732943911827159), KQU( 359077562804090617),

779 
KQU
(14177751537784403113), KQU(10659599444915362902),

780 
KQU
(15081727220615085833), KQU(13417573895659757486),

781 
KQU
(15513842342017811524), KQU(11814141516204288231),

782 
KQU
( 1827312513875101814), KQU( 2804611699894603103),

783 
KQU
(17116500469975602763), KQU(12270191815211952087),

784 
KQU
(12256358467786024988), KQU(18435021722453971267),

785 
KQU
( 671330264390865618), KQU( 476504300460286050),

786 
KQU
(16465470901027093441), KQU( 4047724406247136402),

787 
KQU
( 1322305451411883346), KQU( 1388308688834322280),

788 
KQU
( 7303989085269758176), KQU( 9323792664765233642),

789 
KQU
( 4542762575316368936), KQU(17342696132794337618),

790 
KQU
( 4588025054768498379), KQU(13415475057390330804),

791 
KQU
(17880279491733405570), KQU(10610553400618620353),

792 
KQU
( 3180842072658960139), KQU(13002966655454270120),

793 
KQU
( 1665301181064982826), KQU( 7083673946791258979),

794 
KQU
( 190522247122496820), KQU(17388280237250677740),

795 
KQU
( 8430770379923642945), KQU(12987180971921668584),

796 
KQU
( 2311086108365390642), KQU( 2870984383579822345),

797 
KQU
(14014682609164653318), KQU(14467187293062251484),

798 
KQU
( 192186361147413298), KQU(15171951713531796524),

799 
KQU
( 9900305495015948728), KQU(17958004775615466344),

800 
KQU
(14346380954498606514), KQU(18040047357617407096),

801 
KQU
( 5035237584833424532), KQU(15089555460613972287),

802 
KQU
( 4131411873749729831), KQU( 1329013581168250330),

803 
KQU
(10095353333051193949), KQU(10749518561022462716),

804 
KQU
( 9050611429810755847), KQU(15022028840236655649),

805 
KQU
( 8775554279239748298), KQU(13105754025489230502),

806 
KQU
(15471300118574167585), KQU( 89864764002355628),

807 
KQU
( 8776416323420466637), KQU( 5280258630612040891),

808 
KQU
( 2719174488591862912), KQU( 7599309137399661994),

809 
KQU
(15012887256778039979), KQU(14062981725630928925),

810 
KQU
(12038536286991689603), KQU( 7089756544681775245),

811 
KQU
(10376661532744718039), KQU( 1265198725901533130),

812 
KQU
(13807996727081142408), KQU( 2935019626765036403),

813 
KQU
( 7651672460680700141), KQU( 3644093016200370795),

814 
KQU
( 2840982578090080674), KQU(17956262740157449201),

815 
KQU
(18267979450492880548), KQU(11799503659796848070),

816 
KQU
( 9942537025669672388), KQU(11886606816406990297),

817 
KQU
( 5488594946437447576), KQU( 7226714353282744302),

818 
KQU
( 3784851653123877043), KQU( 878018453244803041),

819 
KQU
(12110022586268616085), KQU( 734072179404675123),

820 
KQU
(11869573627998248542), KQU( 469150421297783998),

821 
KQU
( 260151124912803804), KQU(11639179410120968649),

822 
KQU
( 9318165193840846253), KQU(12795671722734758075),

823 
KQU
(15318410297267253933), KQU( 691524703570062620),

824 
KQU
( 5837129010576994601), KQU(15045963859726941052),

825 
KQU
( 5850056944932238169), KQU(12017434144750943807),

826 
KQU
( 7447139064928956574), KQU( 3101711812658245019),

827 
KQU
(16052940704474982954), KQU(18195745945986994042),

828 
KQU
( 8932252132785575659), KQU(13390817488106794834),

829 
KQU
(11582771836502517453), KQU( 4964411326683611686),

830 
KQU
( 2195093981702694011), KQU(14145229538389675669),

831 
KQU
(16459605532062271798), KQU( 866316924816482864),

832 
KQU
( 4593041209937286377), KQU( 8415491391910972138),

833 
KQU
( 4171236715600528969), KQU(16637569303336782889),

834 
KQU
( 2002011073439212680), KQU(17695124661097601411),

835 
KQU
( 4627687053598611702), KQU( 7895831936020190403),

836 
KQU
( 8455951300917267802), KQU( 2923861649108534854),

837 
KQU
( 8344557563927786255), KQU( 6408671940373352556),

838 
KQU
(12210227354536675772), KQU(14294804157294222295),

839 
KQU
(10103022425071085127), KQU(10092959489504123771),

840 
KQU
( 6554774405376736268), KQU(12629917718410641774),

841 
KQU
( 6260933257596067126), KQU( 2460827021439369673),

842 
KQU
( 2541962996717103668), KQU( 597377203127351475),

843 
KQU
( 5316984203117315309), KQU( 4811211393563241961),

844 
KQU
(13119698597255811641), KQU( 8048691512862388981),

845 
KQU
(10216818971194073842), KQU( 4612229970165291764),

846 
KQU
(10000980798419974770), KQU( 6877640812402540687),

847 
KQU
( 1488727563290436992), KQU( 2227774069895697318),

848 
KQU
(11237754507523316593), KQU(13478948605382290972),

849 
KQU
( 1963583846976858124), KQU( 5512309205269276457),

850 
KQU
( 3972770164717652347), KQU( 3841751276198975037),

851 
KQU
(10283343042181903117), KQU( 8564001259792872199),

852 
KQU
(16472187244722489221), KQU( 8953493499268945921),

853 
KQU
( 3518747340357279580), KQU( 4003157546223963073),

854 
KQU
( 3270305958289814590), KQU( 3966704458129482496),

855 
KQU
( 8122141865926661939), KQU(14627734748099506653),

856 
KQU
(13064426990862560568), KQU( 2414079187889870829),

857 
KQU
( 5378461209354225306), KQU(10841985740128255566),

858 
KQU
( 538582442885401738), KQU( 7535089183482905946),

859 
KQU
(16117559957598879095), KQU( 8477890721414539741),

860 
KQU
( 1459127491209533386), KQU(17035126360733620462),

861 
KQU
( 8517668552872379126), KQU(10292151468337355014),

862 
KQU
(17081267732745344157), KQU(13751455337946087178),

863 
KQU
(14026945459523832966), KQU( 6653278775061723516),

864 
KQU
(10619085543856390441), KQU( 2196343631481122885),

865 
KQU
(10045966074702826136), KQU(10082317330452718282),

866 
KQU
( 5920859259504831242), KQU( 9951879073426540617),

867 
KQU
( 7074696649151414158), KQU(15808193543879464318),

868 
KQU
( 7385247772746953374), KQU( 3192003544283864292),

869 
KQU
(18153684490917593847), KQU(12423498260668568905),

870 
KQU
(10957758099756378169), KQU(11488762179911016040),

871 
KQU
( 2099931186465333782), KQU(11180979581250294432),

872 
KQU
( 8098916250668367933), KQU( 3529200436790763465),

873 
KQU
(12988418908674681745), KQU( 6147567275954808580),

874 
KQU
( 3207503344604030989), KQU(10761592604898615360),

875 
KQU
( 229854861031893504), KQU( 8809853962667144291),

876 
KQU
(13957364469005693860), KQU( 7634287665224495886),

877 
KQU
(12353487366976556874), KQU( 1134423796317152034),

878 
KQU
( 2088992471334107068), KQU( 7393372127190799698),

879 
KQU
( 1845367839871058391), KQU( 207922563987322884),

880 
KQU
(11960870813159944976), KQU(12182120053317317363),

881 
KQU
(17307358132571709283), KQU(13871081155552824936),

882 
KQU
(18304446751741566262), KQU( 7178705220184302849),

883 
KQU
(10929605677758824425), KQU(16446976977835806844),

884 
KQU
(13723874412159769044), KQU( 6942854352100915216),

885 
KQU
( 1726308474365729390), KQU( 2150078766445323155),

886 
KQU
(15345558947919656626), KQU(12145453828874527201),

887 
KQU
( 2054448620739726849), KQU( 2740102003352628137),

888 
KQU
(11294462163577610655), KQU( 756164283387413743),

889 
KQU
(17841144758438810880), KQU(10802406021185415861),

890 
KQU
( 8716455530476737846), KQU( 6321788834517649606),

891 
KQU
(14681322910577468426), KQU(17330043563884336387),

892 
KQU
(12701802180050071614), KQU(14695105111079727151),

893 
KQU
( 5112098511654172830), KQU( 4957505496794139973),

894 
KQU
( 8270979451952045982), KQU(12307685939199120969),

895 
KQU
(12425799408953443032), KQU( 8376410143634796588),

896 
KQU
(16621778679680060464), KQU( 3580497854566660073),

897 
KQU
( 1122515747803382416), KQU( 857664980960597599),

898 
KQU
( 6343640119895925918), KQU(12878473260854462891),

899 
KQU
(10036813920765722626), KQU(14451335468363173812),

900 
KQU
( 5476809692401102807), KQU(16442255173514366342),

901 
KQU
(13060203194757167104), KQU(14354124071243177715),

902 
KQU
(15961249405696125227), KQU(13703893649690872584),

903 
KQU
( 363907326340340064), KQU( 6247455540491754842),

904 
KQU
(12242249332757832361), KQU( 156065475679796717),

905 
KQU
( 9351116235749732355), KQU( 4590350628677701405),

906 
KQU
( 1671195940982350389), KQU(13501398458898451905),

907 
KQU
( 6526341991225002255), KQU( 1689782913778157592),

908 
KQU
( 7439222350869010334), KQU(13975150263226478308),

909 
KQU
(11411961169932682710), KQU(17204271834833847277),

910 
KQU
( 541534742544435367), KQU( 6591191931218949684),

911 
KQU
( 2645454775478232486), KQU( 4322857481256485321),

912 
KQU
( 8477416487553065110), KQU(12902505428548435048),

913 
KQU
( 971445777981341415), KQU(14995104682744976712),

914 
KQU
( 4243341648807158063), KQU( 8695061252721927661),

915 
KQU
( 5028202003270177222), KQU( 2289257340915567840),

916 
KQU
(13870416345121866007), KQU(13994481698072092233),

917 
KQU
( 6912785400753196481), KQU( 2278309315841980139),

918 
KQU
( 4329765449648304839), KQU( 5963108095785485298),

919 
KQU
( 4880024847478722478), KQU(16015608779890240947),

920 
KQU
( 1866679034261393544), KQU( 914821179919731519),

921 
KQU
( 9643404035648760131), KQU( 2418114953615593915),

922 
KQU
( 944756836073702374), KQU(15186388048737296834),

923 
KQU
( 7723355336128442206), KQU( 7500747479679599691),

924 
KQU
(18013961306453293634), KQU( 2315274808095756456),

925 
KQU
(13655308255424029566), KQU(17203800273561677098),

926 
KQU
( 1382158694422087756), KQU( 5090390250309588976),

927 
KQU
( 517170818384213989), KQU( 1612709252627729621),

928 
KQU
( 1330118955572449606), KQU( 300922478056709885),

929 
KQU
(18115693291289091987), KQU(13491407109725238321),

930 
KQU
(15293714633593827320), KQU( 5151539373053314504),

931 
KQU
( 5951523243743139207), KQU(14459112015249527975),

932 
KQU
( 5456113959000700739), KQU( 3877918438464873016),

933 
KQU
(12534071654260163555), KQU(15871678376893555041),

934 
KQU
(11005484805712025549), KQU(16353066973143374252),

935 
KQU
( 4358331472063256685), KQU( 8268349332210859288),

936 
KQU
(12485161590939658075), KQU(13955993592854471343),

937 
KQU
( 5911446886848367039), KQU(14925834086813706974),

938 
KQU
( 6590362597857994805), KQU( 1280544923533661875),

939 
KQU
( 1637756018947988164), KQU( 4734090064512686329),

940 
KQU
(16693705263131485912), KQU( 6834882340494360958),

941 
KQU
( 8120732176159658505), KQU( 2244371958905329346),

942 
KQU
(10447499707729734021), KQU( 7318742361446942194),

943 
KQU
( 8032857516355555296), KQU(14023605983059313116),

944 
KQU
( 1032336061815461376), KQU( 9840995337876562612),

945 
KQU
( 9869256223029203587), KQU(12227975697177267636),

946 
KQU
(12728115115844186033), KQU( 7752058479783205470),

947 
KQU
( 729733219713393087), KQU(12954017801239007622)

949 cÚ¡ 
ušt64_t
 
	gš™_by_¬¿y_64_ex³ùed
[] = {

950 
KQU
( 2100341266307895239), KQU( 8344256300489757943),

951 
KQU
(15687933285484243894), KQU( 8268620370277076319),

952 
KQU
(12371852309826545459), KQU( 8800491541730110238),

953 
KQU
(18113268950100835773), KQU( 2886823658884438119),

954 
KQU
( 3293667307248180724), KQU( 9307928143300172731),

955 
KQU
( 7688082017574293629), KQU( 900986224735166665),

956 
KQU
( 9977972710722265039), KQU( 6008205004994830552),

957 
KQU
( 546909104521689292), KQU( 7428471521869107594),

958 
KQU
(14777563419314721179), KQU(16116143076567350053),

959 
KQU
( 5322685342003142329), KQU( 4200427048445863473),

960 
KQU
( 4693092150132559146), KQU(13671425863759338582),

961 
KQU
( 6747117460737639916), KQU( 4732666080236551150),

962 
KQU
( 5912839950611941263), KQU( 3903717554504704909),

963 
KQU
( 2615667650256786818), KQU(10844129913887006352),

964 
KQU
(13786467861810997820), KQU(14267853002994021570),

965 
KQU
(13767807302847237439), KQU(16407963253707224617),

966 
KQU
( 4802498363698583497), KQU( 2523802839317209764),

967 
KQU
( 3822579397797475589), KQU( 8950320572212130610),

968 
KQU
( 3745623504978342534), KQU(16092609066068482806),

969 
KQU
( 9817016950274642398), KQU(10591660660323829098),

970 
KQU
(11751606650792815920), KQU( 5122873818577122211),

971 
KQU
(17209553764913936624), KQU( 6249057709284380343),

972 
KQU
(15088791264695071830), KQU(15344673071709851930),

973 
KQU
( 4345751415293646084), KQU( 2542865750703067928),

974 
KQU
(13520525127852368784), KQU(18294188662880997241),

975 
KQU
( 3871781938044881523), KQU( 2873487268122812184),

976 
KQU
(15099676759482679005), KQU(15442599127239350490),

977 
KQU
( 6311893274367710888), KQU( 3286118760484672933),

978 
KQU
( 4146067961333542189), KQU(13303942567897208770),

979 
KQU
( 8196013722255630418), KQU( 4437815439340979989),

980 
KQU
(15433791533450605135), KQU( 4254828956815687049),

981 
KQU
( 1310903207708286015), KQU(10529182764462398549),

982 
KQU
(14900231311660638810), KQU( 9727017277104609793),

983 
KQU
( 1821308310948199033), KQU(11628861435066772084),

984 
KQU
( 9469019138491546924), KQU( 3145812670532604988),

985 
KQU
( 9938468915045491919), KQU( 1562447430672662142),

986 
KQU
(13963995266697989134), KQU( 3356884357625028695),

987 
KQU
( 4499850304584309747), KQU( 8456825817023658122),

988 
KQU
(10859039922814285279), KQU( 8099512337972526555),

989 
KQU
( 348006375109672149), KQU(11919893998241688603),

990 
KQU
( 1104199577402948826), KQU(16689191854356060289),

991 
KQU
(10992552041730168078), KQU( 7243733172705465836),

992 
KQU
( 5668075606180319560), KQU(18182847037333286970),

993 
KQU
( 4290215357664631322), KQU( 4061414220791828613),

994 
KQU
(13006291061652989604), KQU( 7140491178917128798),

995 
KQU
(12703446217663283481), KQU( 5500220597564558267),

996 
KQU
(10330551509971296358), KQU(15958554768648714492),

997 
KQU
( 5174555954515360045), KQU( 1731318837687577735),

998 
KQU
( 3557700801048354857), KQU(13764012341928616198),

999 
KQU
(13115166194379119043), KQU( 7989321021560255519),

1000 
KQU
( 2103584280905877040), KQU( 9230788662155228488),

1001 
KQU
(16396629323325547654), KQU( 657926409811318051),

1002 
KQU
(15046700264391400727), KQU( 5120132858771880830),

1003 
KQU
( 7934160097989028561), KQU( 6963121488531976245),

1004 
KQU
(17412329602621742089), KQU(15144843053931774092),

1005 
KQU
(17204176651763054532), KQU(13166595387554065870),

1006 
KQU
( 8590377810513960213), KQU( 5834365135373991938),

1007 
KQU
( 7640913007182226243), KQU( 3479394703859418425),

1008 
KQU
(16402784452644521040), KQU( 4993979809687083980),

1009 
KQU
(13254522168097688865), KQU(15643659095244365219),

1010 
KQU
( 5881437660538424982), KQU(11174892200618987379),

1011 
KQU
( 254409966159711077), KQU(17158413043140549909),

1012 
KQU
( 3638048789290376272), KQU( 1376816930299489190),

1013 
KQU
( 4622462095217761923), KQU(15086407973010263515),

1014 
KQU
(13253971772784692238), KQU( 5270549043541649236),

1015 
KQU
(11182714186805411604), KQU(12283846437495577140),

1016 
KQU
( 5297647149908953219), KQU(10047451738316836654),

1017 
KQU
( 4938228100367874746), KQU(12328523025304077923),

1018 
KQU
( 3601049438595312361), KQU( 9313624118352733770),

1019 
KQU
(13322966086117661798), KQU(16660005705644029394),

1020 
KQU
(11337677526988872373), KQU(13869299102574417795),

1021 
KQU
(15642043183045645437), KQU( 3021755569085880019),

1022 
KQU
( 4979741767761188161), KQU(13679979092079279587),

1023 
KQU
( 3344685842861071743), KQU(13947960059899588104),

1024 
KQU
( 305806934293368007), KQU( 5749173929201650029),

1025 
KQU
(11123724852118844098), KQU(15128987688788879802),

1026 
KQU
(15251651211024665009), KQU( 7689925933816577776),

1027 
KQU
(16732804392695859449), KQU(17087345401014078468),

1028 
KQU
(14315108589159048871), KQU( 4820700266619778917),

1029 
KQU
(16709637539357958441), KQU( 4936227875177351374),

1030 
KQU
( 2137907697912987247), KQU(11628565601408395420),

1031 
KQU
( 2333250549241556786), KQU( 5711200379577778637),

1032 
KQU
( 5170680131529031729), KQU(12620392043061335164),

1033 
KQU
( 95363390101096078), KQU( 5487981914081709462),

1034 
KQU
( 1763109823981838620), KQU( 3395861271473224396),

1035 
KQU
( 1300496844282213595), KQU( 6894316212820232902),

1036 
KQU
(10673859651135576674), KQU( 5911839658857903252),

1037 
KQU
(17407110743387299102), KQU( 8257427154623140385),

1038 
KQU
(11389003026741800267), KQU( 4070043211095013717),

1039 
KQU
(11663806997145259025), KQU(15265598950648798210),

1040 
KQU
( 630585789434030934), KQU( 3524446529213587334),

1041 
KQU
( 7186424168495184211), KQU(10806585451386379021),

1042 
KQU
(11120017753500499273), KQU( 1586837651387701301),

1043 
KQU
(17530454400954415544), KQU( 9991670045077880430),

1044 
KQU
( 7550997268990730180), KQU( 8640249196597379304),

1045 
KQU
( 3522203892786893823), KQU(10401116549878854788),

1046 
KQU
(13690285544733124852), KQU( 8295785675455774586),

1047 
KQU
(15535716172155117603), KQU( 3112108583723722511),

1048 
KQU
(17633179955339271113), KQU(18154208056063759375),

1049 
KQU
( 1866409236285815666), KQU(13326075895396412882),

1050 
KQU
( 8756261842948020025), KQU( 6281852999868439131),

1051 
KQU
(15087653361275292858), KQU(10333923911152949397),

1052 
KQU
( 5265567645757408500), KQU(12728041843210352184),

1053 
KQU
( 6347959327507828759), KQU( 154112802625564758),

1054 
KQU
(18235228308679780218), KQU( 3253805274673352418),

1055 
KQU
( 4849171610689031197), KQU(17948529398340432518),

1056 
KQU
(13803510475637409167), KQU(13506570190409883095),

1057 
KQU
(15870801273282960805), KQU( 8451286481299170773),

1058 
KQU
( 9562190620034457541), KQU( 8518905387449138364),

1059 
KQU
(12681306401363385655), KQU( 3788073690559762558),

1060 
KQU
( 5256820289573487769), KQU( 2752021372314875467),

1061 
KQU
( 6354035166862520716), KQU( 4328956378309739069),

1062 
KQU
( 449087441228269600), KQU( 5533508742653090868),

1063 
KQU
( 1260389420404746988), KQU(18175394473289055097),

1064 
KQU
( 1535467109660399420), KQU( 8818894282874061442),

1065 
KQU
(12140873243824811213), KQU(15031386653823014946),

1066 
KQU
( 1286028221456149232), KQU( 6329608889367858784),

1067 
KQU
( 9419654354945132725), KQU( 6094576547061672379),

1068 
KQU
(17706217251847450255), KQU( 1733495073065878126),

1069 
KQU
(16918923754607552663), KQU( 8881949849954945044),

1070 
KQU
(12938977706896313891), KQU(14043628638299793407),

1071 
KQU
(18393874581723718233), KQU( 6886318534846892044),

1072 
KQU
(14577870878038334081), KQU(13541558383439414119),

1073 
KQU
(13570472158807588273), KQU(18300760537910283361),

1074 
KQU
( 818368572800609205), KQU( 1417000585112573219),

1075 
KQU
(12337533143867683655), KQU(12433180994702314480),

1076 
KQU
( 778190005829189083), KQU(13667356216206524711),

1077 
KQU
( 9866149895295225230), KQU(11043240490417111999),

1078 
KQU
( 1123933826541378598), KQU( 6469631933605123610),

1079 
KQU
(14508554074431980040), KQU(13918931242962026714),

1080 
KQU
( 2870785929342348285), KQU(14786362626740736974),

1081 
KQU
(13176680060902695786), KQU( 9591778613541679456),

1082 
KQU
( 9097662885117436706), KQU( 749262234240924947),

1083 
KQU
( 1944844067793307093), KQU( 4339214904577487742),

1084 
KQU
( 8009584152961946551), KQU(16073159501225501777),

1085 
KQU
( 3335870590499306217), KQU(17088312653151202847),

1086 
KQU
( 3108893142681931848), KQU(16636841767202792021),

1087 
KQU
(10423316431118400637), KQU( 8008357368674443506),

1088 
KQU
(11340015231914677875), KQU(17687896501594936090),

1089 
KQU
(15173627921763199958), KQU( 542569482243721959),

1090 
KQU
(15071714982769812975), KQU( 4466624872151386956),

1091 
KQU
( 1901780715602332461), KQU( 9822227742154351098),

1092 
KQU
( 1479332892928648780), KQU( 6981611948382474400),

1093 
KQU
( 7620824924456077376), KQU(14095973329429406782),

1094 
KQU
( 7902744005696185404), KQU(15830577219375036920),

1095 
KQU
(10287076667317764416), KQU(12334872764071724025),

1096 
KQU
( 4419302088133544331), KQU(14455842851266090520),

1097 
KQU
(12488077416504654222), KQU( 7953892017701886766),

1098 
KQU
( 6331484925529519007), KQU( 4902145853785030022),

1099 
KQU
(17010159216096443073), KQU(11945354668653886087),

1100 
KQU
(15112022728645230829), KQU(17363484484522986742),

1101 
KQU
( 4423497825896692887), KQU( 8155489510809067471),

1102 
KQU
( 258966605622576285), KQU( 5462958075742020534),

1103 
KQU
( 6763710214913276228), KQU( 2368935183451109054),

1104 
KQU
(14209506165246453811), KQU( 2646257040978514881),

1105 
KQU
( 3776001911922207672), KQU( 1419304601390147631),

1106 
KQU
(14987366598022458284), KQU( 3977770701065815721),

1107 
KQU
( 730820417451838898), KQU( 3982991703612885327),

1108 
KQU
( 2803544519671388477), KQU(17067667221114424649),

1109 
KQU
( 2922555119737867166), KQU( 1989477584121460932),

1110 
KQU
(15020387605892337354), KQU( 9293277796427533547),

1111 
KQU
(10722181424063557247), KQU(16704542332047511651),

1112 
KQU
( 5008286236142089514), KQU(16174732308747382540),

1113 
KQU
(17597019485798338402), KQU(13081745199110622093),

1114 
KQU
( 8850305883842258115), KQU(12723629125624589005),

1115 
KQU
( 8140566453402805978), KQU(15356684607680935061),

1116 
KQU
(14222190387342648650), KQU(11134610460665975178),

1117 
KQU
( 1259799058620984266), KQU(13281656268025610041),

1118 
KQU
( 298262561068153992), KQU(12277871700239212922),

1119 
KQU
(13911297774719779438), KQU(16556727962761474934),

1120 
KQU
(17903010316654728010), KQU( 9682617699648434744),

1121 
KQU
(14757681836838592850), KQU( 1327242446558524473),

1122 
KQU
(11126645098780572792), KQU( 1883602329313221774),

1123 
KQU
( 2543897783922776873), KQU(15029168513767772842),

1124 
KQU
(12710270651039129878), KQU(16118202956069604504),

1125 
KQU
(15010759372168680524), KQU( 2296827082251923948),

1126 
KQU
(10793729742623518101), KQU(13829764151845413046),

1127 
KQU
(17769301223184451213), KQU( 3118268169210783372),

1128 
KQU
(17626204544105123127), KQU( 7416718488974352644),

1129 
KQU
(10450751996212925994), KQU( 9352529519128770586),

1130 
KQU
( 259347569641110140), KQU( 8048588892269692697),

1131 
KQU
( 1774414152306494058), KQU(10669548347214355622),

1132 
KQU
(13061992253816795081), KQU(18432677803063861659),

1133 
KQU
( 8879191055593984333), KQU(12433753195199268041),

1134 
KQU
(14919392415439730602), KQU( 6612848378595332963),

1135 
KQU
( 6320986812036143628), KQU(10465592420226092859),

1136 
KQU
( 4196009278962570808), KQU( 3747816564473572224),

1137 
KQU
(17941203486133732898), KQU( 2350310037040505198),

1138 
KQU
( 5811779859134370113), KQU(10492109599506195126),

1139 
KQU
( 7699650690179541274), KQU( 1954338494306022961),

1140 
KQU
(14095816969027231152), KQU( 5841346919964852061),

1141 
KQU
(14945969510148214735), KQU( 3680200305887550992),

1142 
KQU
( 6218047466131695792), KQU( 8242165745175775096),

1143 
KQU
(11021371934053307357), KQU( 1265099502753169797),

1144 
KQU
( 4644347436111321718), KQU( 3609296916782832859),

1145 
KQU
( 8109807992218521571), KQU(18387884215648662020),

1146 
KQU
(14656324896296392902), KQU(17386819091238216751),

1147 
KQU
(17788300878582317152), KQU( 7919446259742399591),

1148 
KQU
( 4466613134576358004), KQU(12928181023667938509),

1149 
KQU
(13147446154454932030), KQU(16552129038252734620),

1150 
KQU
( 8395299403738822450), KQU(11313817655275361164),

1151 
KQU
( 434258809499511718), KQU( 2074882104954788676),

1152 
KQU
( 7929892178759395518), KQU( 9006461629105745388),

1153 
KQU
( 5176475650000323086), KQU(11128357033468341069),

1154 
KQU
(12026158851559118955), KQU(14699716249471156500),

1155 
KQU
( 448982497120206757), KQU( 4156475356685519900),

1156 
KQU
( 6063816103417215727), KQU(10073289387954971479),

1157 
KQU
( 8174466846138590962), KQU( 2675777452363449006),

1158 
KQU
( 9090685420572474281), KQU( 6659652652765562060),

1159 
KQU
(12923120304018106621), KQU(11117480560334526775),

1160 
KQU
( 937910473424587511), KQU( 1838692113502346645),

1161 
KQU
(11133914074648726180), KQU( 7922600945143884053),

1162 
KQU
(13435287702700959550), KQU( 5287964921251123332),

1163 
KQU
(11354875374575318947), KQU(17955724760748238133),

1164 
KQU
(13728617396297106512), KQU( 4107449660118101255),

1165 
KQU
( 1210269794886589623), KQU(11408687205733456282),

1166 
KQU
( 4538354710392677887), KQU(13566803319341319267),

1167 
KQU
(17870798107734050771), KQU( 3354318982568089135),

1168 
KQU
( 9034450839405133651), KQU(13087431795753424314),

1169 
KQU
( 950333102820688239), KQU( 1968360654535604116),

1170 
KQU
(16840551645563314995), KQU( 8867501803892924995),

1171 
KQU
(11395388644490626845), KQU( 1529815836300732204),

1172 
KQU
(13330848522996608842), KQU( 1813432878817504265),

1173 
KQU
( 2336867432693429560), KQU(15192805445973385902),

1174 
KQU
( 2528593071076407877), KQU( 128459777936689248),

1175 
KQU
( 9976345382867214866), KQU( 6208885766767996043),

1176 
KQU
(14982349522273141706), KQU( 3099654362410737822),

1177 
KQU
(13776700761947297661), KQU( 8806185470684925550),

1178 
KQU
( 8151717890410585321), KQU( 640860591588072925),

1179 
KQU
(14592096303937307465), KQU( 9056472419613564846),

1180 
KQU
(14861544647742266352), KQU(12703771500398470216),

1181 
KQU
( 3142372800384138465), KQU( 6201105606917248196),

1182 
KQU
(18337516409359270184), KQU(15042268695665115339),

1183 
KQU
(15188246541383283846), KQU(12800028693090114519),

1184 
KQU
( 5992859621101493472), KQU(18278043971816803521),

1185 
KQU
( 9002773075219424560), KQU( 7325707116943598353),

1186 
KQU
( 7930571931248040822), KQU( 5645275869617023448),

1187 
KQU
( 7266107455295958487), KQU( 4363664528273524411),

1188 
KQU
(14313875763787479809), KQU(17059695613553486802),

1189 
KQU
( 9247761425889940932), KQU(13704726459237593128),

1190 
KQU
( 2701312427328909832), KQU(17235532008287243115),

1191 
KQU
(14093147761491729538), KQU( 6247352273768386516),

1192 
KQU
( 8268710048153268415), KQU( 7985295214477182083),

1193 
KQU
(15624495190888896807), KQU( 3772753430045262788),

1194 
KQU
( 9133991620474991698), KQU( 5665791943316256028),

1195 
KQU
( 7551996832462193473), KQU(13163729206798953877),

1196 
KQU
( 9263532074153846374), KQU( 1015460703698618353),

1197 
KQU
(17929874696989519390), KQU(18257884721466153847),

1198 
KQU
(16271867543011222991), KQU( 3905971519021791941),

1199 
KQU
(16814488397137052085), KQU( 1321197685504621613),

1200 
KQU
( 2870359191894002181), KQU(14317282970323395450),

1201 
KQU
(13663920845511074366), KQU( 2052463995796539594),

1202 
KQU
(14126345686431444337), KQU( 1727572121947022534),

1203 
KQU
(17793552254485594241), KQU( 6738857418849205750),

1204 
KQU
( 1282987123157442952), KQU(16655480021581159251),

1205 
KQU
( 6784587032080183866), KQU(14726758805359965162),

1206 
KQU
( 7577995933961987349), KQU(12539609320311114036),

1207 
KQU
(10789773033385439494), KQU( 8517001497411158227),

1208 
KQU
(10075543932136339710), KQU(14838152340938811081),

1209 
KQU
( 9560840631794044194), KQU(17445736541454117475),

1210 
KQU
(10633026464336393186), KQU(15705729708242246293),

1211 
KQU
( 1117517596891411098), KQU( 4305657943415886942),

1212 
KQU
( 4948856840533979263), KQU(16071681989041789593),

1213 
KQU
(13723031429272486527), KQU( 7639567622306509462),

1214 
KQU
(12670424537483090390), KQU( 9715223453097197134),

1215 
KQU
( 5457173389992686394), KQU( 289857129276135145),

1216 
KQU
(17048610270521972512), KQU( 692768013309835485),

1217 
KQU
(14823232360546632057), KQU(18218002361317895936),

1218 
KQU
( 3281724260212650204), KQU(16453957266549513795),

1219 
KQU
( 8592711109774511881), KQU( 929825123473369579),

1220 
KQU
(15966784769764367791), KQU( 9627344291450607588),

1221 
KQU
(10849555504977813287), KQU( 9234566913936339275),

1222 
KQU
( 6413807690366911210), KQU(10862389016184219267),

1223 
KQU
(13842504799335374048), KQU( 1531994113376881174),

1224 
KQU
( 2081314867544364459), KQU(16430628791616959932),

1225 
KQU
( 8314714038654394368), KQU( 9155473892098431813),

1226 
KQU
(12577843786670475704), KQU( 4399161106452401017),

1227 
KQU
( 1668083091682623186), KQU( 1741383777203714216),

1228 
KQU
( 2162597285417794374), KQU(15841980159165218736),

1229 
KQU
( 1971354603551467079), KQU( 1206714764913205968),

1230 
KQU
( 4790860439591272330), KQU(14699375615594055799),

1231 
KQU
( 8374423871657449988), KQU(10950685736472937738),

1232 
KQU
( 697344331343267176), KQU(10084998763118059810),

1233 
KQU
(12897369539795983124), KQU(12351260292144383605),

1234 
KQU
( 1268810970176811234), KQU( 7406287800414582768),

1235 
KQU
( 516169557043807831), KQU( 5077568278710520380),

1236 
KQU
( 3828791738309039304), KQU( 7721974069946943610),

1237 
KQU
( 3534670260981096460), KQU( 4865792189600584891),

1238 
KQU
(16892578493734337298), KQU( 9161499464278042590),

1239 
KQU
(11976149624067055931), KQU(13219479887277343990),

1240 
KQU
(14161556738111500680), KQU(14670715255011223056),

1241 
KQU
( 4671205678403576558), KQU(12633022931454259781),

1242 
KQU
(14821376219869187646), KQU( 751181776484317028),

1243 
KQU
( 2192211308839047070), KQU(11787306362361245189),

1244 
KQU
(10672375120744095707), KQU( 4601972328345244467),

1245 
KQU
(15457217788831125879), KQU( 8464345256775460809),

1246 
KQU
(10191938789487159478), KQU( 6184348739615197613),

1247 
KQU
(11425436778806882100), KQU( 2739227089124319793),

1248 
KQU
( 461464518456000551), KQU( 4689850170029177442),

1249 
KQU
( 6120307814374078625), KQU(11153579230681708671),

1250 
KQU
( 7891721473905347926), KQU(10281646937824872400),

1251 
KQU
( 3026099648191332248), KQU( 8666750296953273818),

1252 
KQU
(14978499698844363232), KQU(13303395102890132065),

1253 
KQU
( 8182358205292864080), KQU(10560547713972971291),

1254 
KQU
(11981635489418959093), KQU( 3134621354935288409),

1255 
KQU
(11580681977404383968), KQU(14205530317404088650),

1256 
KQU
( 5997789011854923157), KQU(13659151593432238041),

1257 
KQU
(11664332114338865086), KQU( 7490351383220929386),

1258 
KQU
( 7189290499881530378), KQU(15039262734271020220),

1259 
KQU
( 2057217285976980055), KQU( 555570804905355739),

1260 
KQU
(11235311968348555110), KQU(13824557146269603217),

1261 
KQU
(16906788840653099693), KQU( 7222878245455661677),

1262 
KQU
( 5245139444332423756), KQU( 4723748462805674292),

1263 
KQU
(12216509815698568612), KQU(17402362976648951187),

1264 
KQU
(17389614836810366768), KQU( 4880936484146667711),

1265 
KQU
( 9085007839292639880), KQU(13837353458498535449),

1266 
KQU
(11914419854360366677), KQU(16595890135313864103),

1267 
KQU
( 6313969847197627222), KQU(18296909792163910431),

1268 
KQU
(10041780113382084042), KQU( 2499478551172884794),

1269 
KQU
(11057894246241189489), KQU( 9742243032389068555),

1270 
KQU
(12838934582673196228), KQU(13437023235248490367),

1271 
KQU
(13372420669446163240), KQU( 6752564244716909224),

1272 
KQU
( 7157333073400313737), KQU(12230281516370654308),

1273 
KQU
( 1182884552219419117), KQU( 2955125381312499218),

1274 
KQU
(10308827097079443249), KQU( 1337648572986534958),

1275 
KQU
(16378788590020343939), KQU( 108619126514420935),

1276 
KQU
( 3990981009621629188), KQU( 5460953070230946410),

1277 
KQU
( 9703328329366531883), KQU(13166631489188077236),

1278 
KQU
( 1104768831213675170), KQU( 3447930458553877908),

1279 
KQU
( 8067172487769945676), KQU( 5445802098190775347),

1280 
KQU
( 3244840981648973873), KQU(17314668322981950060),

1281 
KQU
( 5006812527827763807), KQU(18158695070225526260),

1282 
KQU
( 2824536478852417853), KQU(13974775809127519886),

1283 
KQU
( 9814362769074067392), KQU(17276205156374862128),

1284 
KQU
(11361680725379306967), KQU( 3422581970382012542),

1285 
KQU
(11003189603753241266), KQU(11194292945277862261),

1286 
KQU
( 6839623313908521348), KQU(11935326462707324634),

1287 
KQU
( 1611456788685878444), KQU(13112620989475558907),

1288 
KQU
( 517659108904450427), KQU(13558114318574407624),

1289 
KQU
(15699089742731633077), KQU( 4988979278862685458),

1290 
KQU
( 8111373583056521297), KQU( 3891258746615399627),

1291 
KQU
( 8137298251469718086), KQU(12748663295624701649),

1292 
KQU
( 4389835683495292062), KQU( 5775217872128831729),

1293 
KQU
( 9462091896405534927), KQU( 8498124108820263989),

1294 
KQU
( 8059131278842839525), KQU(10503167994254090892),

1295 
KQU
(11613153541070396656), KQU(18069248738504647790),

1296 
KQU
( 570657419109768508), KQU( 3950574167771159665),

1297 
KQU
( 5514655599604313077), KQU( 2908460854428484165),

1298 
KQU
(10777722615935663114), KQU(12007363304839279486),

1299 
KQU
( 9800646187569484767), KQU( 8795423564889864287),

1300 
KQU
(14257396680131028419), KQU( 6405465117315096498),

1301 
KQU
( 7939411072208774878), KQU(17577572378528990006),

1302 
KQU
(14785873806715994850), KQU(16770572680854747390),

1303 
KQU
(18127549474419396481), KQU(11637013449455757750),

1304 
KQU
(14371851933996761086), KQU( 3601181063650110280),

1305 
KQU
( 4126442845019316144), KQU(10198287239244320669),

1306 
KQU
(18000169628555379659), KQU(18392482400739978269),

1307 
KQU
( 6219919037686919957), KQU( 3610085377719446052),

1308 
KQU
( 2513925039981776336), KQU(16679413537926716955),

1309 
KQU
(12903302131714909434), KQU( 5581145789762985009),

1310 
KQU
(12325955044293303233), KQU(17216111180742141204),

1311 
KQU
( 6321919595276545740), KQU( 3507521147216174501),

1312 
KQU
( 9659194593319481840), KQU(11473976005975358326),

1313 
KQU
(14742730101435987026), KQU( 492845897709954780),

1314 
KQU
(16976371186162599676), KQU(17712703422837648655),

1315 
KQU
( 9881254778587061697), KQU( 8413223156302299551),

1316 
KQU
( 1563841828254089168), KQU( 9996032758786671975),

1317 
KQU
( 138877700583772667), KQU(13003043368574995989),

1318 
KQU
( 4390573668650456587), KQU( 8610287390568126755),

1319 
KQU
(15126904974266642199), KQU( 6703637238986057662),

1320 
KQU
( 2873075592956810157), KQU( 6035080933946049418),

1321 
KQU
(13382846581202353014), KQU( 7303971031814642463),

1322 
KQU
(18418024405307444267), KQU( 5847096731675404647),

1323 
KQU
( 4035880699639842500), KQU(11525348625112218478),

1324 
KQU
( 3041162365459574102), KQU( 2604734487727986558),

1325 
KQU
(15526341771636983145), KQU(14556052310697370254),

1326 
KQU
(12997787077930808155), KQU( 9601806501755554499),

1327 
KQU
(11349677952521423389), KQU(14956777807644899350),

1328 
KQU
(16559736957742852721), KQU(12360828274778140726),

1329 
KQU
( 6685373272009662513), KQU(16932258748055324130),

1330 
KQU
(15918051131954158508), KQU( 1692312913140790144),

1331 
KQU
( 546653826801637367), KQU( 5341587076045986652),

1332 
KQU
(14975057236342585662), KQU(12374976357340622412),

1333 
KQU
(10328833995181940552), KQU(12831807101710443149),

1334 
KQU
(10548514914382545716), KQU( 2217806727199715993),

1335 
KQU
(12627067369242845138), KQU( 4598965364035438158),

1336 
KQU
( 150923352751318171), KQU(14274109544442257283),

1337 
KQU
( 4696661475093863031), KQU( 1505764114384654516),

1338 
KQU
(10699185831891495147), KQU( 2392353847713620519),

1339 
KQU
( 3652870166711788383), KQU( 8640653276221911108),

1340 
KQU
( 3894077592275889704), KQU( 4918592872135964845),

1341 
KQU
(16379121273281400789), KQU(12058465483591683656),

1342 
KQU
(11250106829302924945), KQU( 1147537556296983005),

1343 
KQU
( 6376342756004613268), KQU(14967128191709280506),

1344 
KQU
(18007449949790627628), KQU( 9497178279316537841),

1345 
KQU
( 7920174844809394893), KQU(10037752595255719907),

1346 
KQU
(15875342784985217697), KQU(15311615921712850696),

1347 
KQU
( 9552902652110992950), KQU(14054979450099721140),

1348 
KQU
( 5998709773566417349), KQU(18027910339276320187),

1349 
KQU
( 8223099053868585554), KQU( 7842270354824999767),

1350 
KQU
( 4896315688770080292), KQU(12969320296569787895),

1351 
KQU
( 2674321489185759961), KQU( 4053615936864718439),

1352 
KQU
(11349775270588617578), KQU( 4743019256284553975),

1353 
KQU
( 5602100217469723769), KQU(14398995691411527813),

1354 
KQU
( 7412170493796825470), KQU( 836262406131744846),

1355 
KQU
( 8231086633845153022), KQU( 5161377920438552287),

1356 
KQU
( 8828731196169924949), KQU(16211142246465502680),

1357 
KQU
( 3307990879253687818), KQU( 5193405406899782022),

1358 
KQU
( 8510842117467566693), KQU( 6070955181022405365),

1359 
KQU
(14482950231361409799), KQU(12585159371331138077),

1360 
KQU
( 3511537678933588148), KQU( 2041849474531116417),

1361 
KQU
(10944936685095345792), KQU(18303116923079107729),

1362 
KQU
( 2720566371239725320), KQU( 4958672473562397622),

1363 
KQU
( 3032326668253243412), KQU(13689418691726908338),

1364 
KQU
( 1895205511728843996), KQU( 8146303515271990527),

1365 
KQU
(16507343500056113480), KQU( 473996939105902919),

1366 
KQU
( 9897686885246881481), KQU(14606433762712790575),

1367 
KQU
( 6732796251605566368), KQU( 1399778120855368916),

1368 
KQU
( 935023885182833777), KQU(16066282816186753477),

1369 
KQU
( 7291270991820612055), KQU(17530230393129853844),

1370 
KQU
(10223493623477451366), KQU(15841725630495676683),

1371 
KQU
(17379567246435515824), KQU( 8588251429375561971),

1372 
KQU
(18339511210887206423), KQU(17349587430725976100),

1373 
KQU
(12244876521394838088), KQU( 6382187714147161259),

1374 
KQU
(12335807181848950831), KQU(16948885622305460665),

1375 
KQU
(13755097796371520506), KQU(14806740373324947801),

1376 
KQU
( 4828699633859287703), KQU( 8209879281452301604),

1377 
KQU
(12435716669553736437), KQU(13970976859588452131),

1378 
KQU
( 6233960842566773148), KQU(12507096267900505759),

1379 
KQU
( 1198713114381279421), KQU(14989862731124149015),

1380 
KQU
(15932189508707978949), KQU( 2526406641432708722),

1381 
KQU
( 29187427817271982), KQU( 1499802773054556353),

1382 
KQU
(10816638187021897173), KQU( 5436139270839738132),

1383 
KQU
( 6659882287036010082), KQU( 2154048955317173697),

1384 
KQU
(10887317019333757642), KQU(16281091802634424955),

1385 
KQU
(10754549879915384901), KQU(10760611745769249815),

1386 
KQU
( 2161505946972504002), KQU( 5243132808986265107),

1387 
KQU
(10129852179873415416), KQU( 710339480008649081),

1388 
KQU
( 7802129453068808528), KQU(17967213567178907213),

1389 
KQU
(15730859124668605599), KQU(13058356168962376502),

1390 
KQU
( 3701224985413645909), KQU(14464065869149109264),

1391 
KQU
( 9959272418844311646), KQU(10157426099515958752),

1392 
KQU
(14013736814538268528), KQU(17797456992065653951),

1393 
KQU
(17418878140257344806), KQU(15457429073540561521),

1394 
KQU
( 2184426881360949378), KQU( 2062193041154712416),

1395 
KQU
( 8553463347406931661), KQU( 4913057625202871854),

1396 
KQU
( 2668943682126618425), KQU(17064444737891172288),

1397 
KQU
( 4997115903913298637), KQU(12019402608892327416),

1398 
KQU
(17603584559765897352), KQU(11367529582073647975),

1399 
KQU
( 8211476043518436050), KQU( 8676849804070323674),

1400 
KQU
(18431829230394475730), KQU(10490177861361247904),

1401 
KQU
( 9508720602025651349), KQU( 7409627448555722700),

1402 
KQU
( 5804047018862729008), KQU(11943858176893142594),

1403 
KQU
(11908095418933847092), KQU( 5415449345715887652),

1404 
KQU
( 1554022699166156407), KQU( 9073322106406017161),

1405 
KQU
( 7080630967969047082), KQU(18049736940860732943),

1406 
KQU
(12748714242594196794), KQU( 1226992415735156741),

1407 
KQU
(17900981019609531193), KQU(11720739744008710999),

1408 
KQU
( 3006400683394775434), KQU(11347974011751996028),

1409 
KQU
( 3316999628257954608), KQU( 8384484563557639101),

1410 
KQU
(18117794685961729767), KQU( 1900145025596618194),

1411 
KQU
(17459527840632892676), KQU( 5634784101865710994),

1412 
KQU
( 7918619300292897158), KQU( 3146577625026301350),

1413 
KQU
( 9955212856499068767), KQU( 1873995843681746975),

1414 
KQU
( 1561487759967972194), KQU( 8322718804375878474),

1415 
KQU
(11300284215327028366), KQU( 4667391032508998982),

1416 
KQU
( 9820104494306625580), KQU(17922397968599970610),

1417 
KQU
( 1784690461886786712), KQU(14940365084341346821),

1418 
KQU
( 5348719575594186181), KQU(10720419084507855261),

1419 
KQU
(14210394354145143274), KQU( 2426468692164000131),

1420 
KQU
(16271062114607059202), KQU(14851904092357070247),

1421 
KQU
( 6524493015693121897), KQU( 9825473835127138531),

1422 
KQU
(14222500616268569578), KQU(15521484052007487468),

1423 
KQU
(14462579404124614699), KQU(11012375590820665520),

1424 
KQU
(11625327350536084927), KQU(14452017765243785417),

1425 
KQU
( 9989342263518766305), KQU( 3640105471101803790),

1426 
KQU
( 4749866455897513242), KQU(13963064946736312044),

1427 
KQU
(10007416591973223791), KQU(18314132234717431115),

1428 
KQU
( 3286596588617483450), KQU( 7726163455370818765),

1429 
KQU
( 7575454721115379328), KQU( 5308331576437663422),

1430 
KQU
(18288821894903530934), KQU( 8028405805410554106),

1431 
KQU
(15744019832103296628), KQU( 149765559630932100),

1432 
KQU
( 6137705557200071977), KQU(14513416315434803615),

1433 
KQU
(11665702820128984473), KQU( 218926670505601386),

1434 
KQU
( 6868675028717769519), KQU(15282016569441512302),

1435 
KQU
( 5707000497782960236), KQU( 6671120586555079567),

1436 
KQU
( 2194098052618985448), KQU(16849577895477330978),

1437 
KQU
(12957148471017466283), KQU( 1997805535404859393),

1438 
KQU
( 1180721060263860490), KQU(13206391310193756958),

1439 
KQU
(12980208674461861797), KQU( 3825967775058875366),

1440 
KQU
(17543433670782042631), KQU( 1518339070120322730),

1441 
KQU
(16344584340890991669), KQU( 2611327165318529819),

1442 
KQU
(11265022723283422529), KQU( 4001552800373196817),

1443 
KQU
(14509595890079346161), KQU( 3528717165416234562),

1444 
KQU
(18153222571501914072), KQU( 9387182977209744425),

1445 
KQU
(10064342315985580021), KQU(11373678413215253977),

1446 
KQU
( 2308457853228798099), KQU( 9729042942839545302),

1447 
KQU
( 7833785471140127746), KQU( 6351049900319844436),

1448 
KQU
(14454610627133496067), KQU(12533175683634819111),

1449 
KQU
(15570163926716513029), KQU(13356980519185762498)

1452 
	$TEST_BEGIN
(
‹¡_g’_¿nd_32
)

1454 
ušt32_t
 
¬¿y32
[
BLOCK_SIZE
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1455 
ušt32_t
 
¬¿y32_2
[
BLOCK_SIZE
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1456 
i
;

1457 
ušt32_t
 
r32
;

1458 
sfmt_t
 *
ùx
;

1460 
	`as£¹_d_Ë
(
	`g‘_mš_¬¿y_size32
(), 
BLOCK_SIZE
,

1462 
ùx
 = 
	`š™_g’_¿nd
(1234);

1463 
	`fl_¬¿y32
(
ùx
, 
¬¿y32
, 
BLOCK_SIZE
);

1464 
	`fl_¬¿y32
(
ùx
, 
¬¿y32_2
, 
BLOCK_SIZE
);

1465 
	`fši_g’_¿nd
(
ùx
);

1467 
ùx
 = 
	`š™_g’_¿nd
(1234);

1468 
i
 = 0; i < 
BLOCK_SIZE
; i++) {

1469 ià(
i
 < 
COUNT_1
) {

1470 
	`as£¹_u32_eq
(
¬¿y32
[
i
], 
š™_g’_¿nd_32_ex³ùed
[i],

1471 "Ouuˆmism©ch fÜ i=%d", 
i
);

1473 
r32
 = 
	`g’_¿nd32
(
ùx
);

1474 
	`as£¹_u32_eq
(
r32
, 
¬¿y32
[
i
],

1475 "Mism©ch‡ˆ¬¿y32[%d]=%x, g’=%x", 
i
, 
¬¿y32
[i], 
r32
);

1477 
i
 = 0; i < 
COUNT_2
; i++) {

1478 
r32
 = 
	`g’_¿nd32
(
ùx
);

1479 
	`as£¹_u32_eq
(
r32
, 
¬¿y32_2
[
i
],

1480 "Mism©ch‡ˆ¬¿y32_2[%d]=%x, g’=%x", 
i
, 
¬¿y32_2
[i],

1481 
r32
);

1483 
	`fši_g’_¿nd
(
ùx
);

1484 
	}
}

1485 
TEST_END


1487 
	$TEST_BEGIN
(
‹¡_by_¬¿y_32
)

1489 
ušt32_t
 
¬¿y32
[
BLOCK_SIZE
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1490 
ušt32_t
 
¬¿y32_2
[
BLOCK_SIZE
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1491 
i
;

1492 
ušt32_t
 
ši
[4] = {0x1234, 0x5678, 0x9abc, 0xdef0};

1493 
ušt32_t
 
r32
;

1494 
sfmt_t
 *
ùx
;

1496 
	`as£¹_d_Ë
(
	`g‘_mš_¬¿y_size32
(), 
BLOCK_SIZE
,

1498 
ùx
 = 
	`š™_by_¬¿y
(
ši
, 4);

1499 
	`fl_¬¿y32
(
ùx
, 
¬¿y32
, 
BLOCK_SIZE
);

1500 
	`fl_¬¿y32
(
ùx
, 
¬¿y32_2
, 
BLOCK_SIZE
);

1501 
	`fši_g’_¿nd
(
ùx
);

1503 
ùx
 = 
	`š™_by_¬¿y
(
ši
, 4);

1504 
i
 = 0; i < 
BLOCK_SIZE
; i++) {

1505 ià(
i
 < 
COUNT_1
) {

1506 
	`as£¹_u32_eq
(
¬¿y32
[
i
], 
š™_by_¬¿y_32_ex³ùed
[i],

1507 "Ouuˆmism©ch fÜ i=%d", 
i
);

1509 
r32
 = 
	`g’_¿nd32
(
ùx
);

1510 
	`as£¹_u32_eq
(
r32
, 
¬¿y32
[
i
],

1511 "Mism©ch‡ˆ¬¿y32[%d]=%x, g’=%x", 
i
, 
¬¿y32
[i], 
r32
);

1513 
i
 = 0; i < 
COUNT_2
; i++) {

1514 
r32
 = 
	`g’_¿nd32
(
ùx
);

1515 
	`as£¹_u32_eq
(
r32
, 
¬¿y32_2
[
i
],

1516 "Mism©ch‡ˆ¬¿y32_2[%d]=%x, g’=%x", 
i
, 
¬¿y32_2
[i],

1517 
r32
);

1519 
	`fši_g’_¿nd
(
ùx
);

1520 
	}
}

1521 
TEST_END


1523 
	$TEST_BEGIN
(
‹¡_g’_¿nd_64
)

1525 
ušt64_t
 
¬¿y64
[
BLOCK_SIZE64
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1526 
ušt64_t
 
¬¿y64_2
[
BLOCK_SIZE64
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1527 
i
;

1528 
ušt64_t
 
r
;

1529 
sfmt_t
 *
ùx
;

1531 
	`as£¹_d_Ë
(
	`g‘_mš_¬¿y_size64
(), 
BLOCK_SIZE64
,

1533 
ùx
 = 
	`š™_g’_¿nd
(4321);

1534 
	`fl_¬¿y64
(
ùx
, 
¬¿y64
, 
BLOCK_SIZE64
);

1535 
	`fl_¬¿y64
(
ùx
, 
¬¿y64_2
, 
BLOCK_SIZE64
);

1536 
	`fši_g’_¿nd
(
ùx
);

1538 
ùx
 = 
	`š™_g’_¿nd
(4321);

1539 
i
 = 0; i < 
BLOCK_SIZE64
; i++) {

1540 ià(
i
 < 
COUNT_1
) {

1541 
	`as£¹_u64_eq
(
¬¿y64
[
i
], 
š™_g’_¿nd_64_ex³ùed
[i],

1542 "Ouuˆmism©ch fÜ i=%d", 
i
);

1544 
r
 = 
	`g’_¿nd64
(
ùx
);

1545 
	`as£¹_u64_eq
(
r
, 
¬¿y64
[
i
],

1546 "Mism©ch‡ˆ¬¿y64[%d]=%"
FMTx64
", g’=%"FMTx64, 
i
,

1547 
¬¿y64
[
i
], 
r
);

1549 
i
 = 0; i < 
COUNT_2
; i++) {

1550 
r
 = 
	`g’_¿nd64
(
ùx
);

1551 
	`as£¹_u64_eq
(
r
, 
¬¿y64_2
[
i
],

1552 "Mism©ch‡ˆ¬¿y64_2[%d]=%"
FMTx64
" g’=%"FMTx64"", 
i
,

1553 
¬¿y64_2
[
i
], 
r
);

1555 
	`fši_g’_¿nd
(
ùx
);

1556 
	}
}

1557 
TEST_END


1559 
	$TEST_BEGIN
(
‹¡_by_¬¿y_64
)

1561 
ušt64_t
 
¬¿y64
[
BLOCK_SIZE64
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1562 
ušt64_t
 
¬¿y64_2
[
BLOCK_SIZE64
] 
	`JEMALLOC_ATTR
(
	`®igÃd
(16));

1563 
i
;

1564 
ušt64_t
 
r
;

1565 
ušt32_t
 
ši
[] = {5, 4, 3, 2, 1};

1566 
sfmt_t
 *
ùx
;

1568 
	`as£¹_d_Ë
(
	`g‘_mš_¬¿y_size64
(), 
BLOCK_SIZE64
,

1570 
ùx
 = 
	`š™_by_¬¿y
(
ši
, 5);

1571 
	`fl_¬¿y64
(
ùx
, 
¬¿y64
, 
BLOCK_SIZE64
);

1572 
	`fl_¬¿y64
(
ùx
, 
¬¿y64_2
, 
BLOCK_SIZE64
);

1573 
	`fši_g’_¿nd
(
ùx
);

1575 
ùx
 = 
	`š™_by_¬¿y
(
ši
, 5);

1576 
i
 = 0; i < 
BLOCK_SIZE64
; i++) {

1577 ià(
i
 < 
COUNT_1
) {

1578 
	`as£¹_u64_eq
(
¬¿y64
[
i
], 
š™_by_¬¿y_64_ex³ùed
[i],

1579 "Ouuˆmism©ch fÜ i=%d", 
i
);

1581 
r
 = 
	`g’_¿nd64
(
ùx
);

1582 
	`as£¹_u64_eq
(
r
, 
¬¿y64
[
i
],

1583 "Mism©ch‡ˆ¬¿y64[%d]=%"
FMTx64
" g’=%"FMTx64, 
i
,

1584 
¬¿y64
[
i
], 
r
);

1586 
i
 = 0; i < 
COUNT_2
; i++) {

1587 
r
 = 
	`g’_¿nd64
(
ùx
);

1588 
	`as£¹_u64_eq
(
r
, 
¬¿y64_2
[
i
],

1589 "Mism©ch‡ˆ¬¿y64_2[%d]=%"
FMTx64
" g’=%"FMTx64, 
i
,

1590 
¬¿y64_2
[
i
], 
r
);

1592 
	`fši_g’_¿nd
(
ùx
);

1593 
	}
}

1594 
TEST_END


1597 
	$maš
()

1600  (
	`‹¡
(

1601 
‹¡_g’_¿nd_32
,

1602 
‹¡_by_¬¿y_32
,

1603 
‹¡_g’_¿nd_64
,

1604 
‹¡_by_¬¿y_64
));

1605 
	}
}

	@deps/jemalloc/test/unit/atomic.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#TEST_STRUCT
(
p
, 
t
) \

4 
p
##
_‹¡_s
 { \

5 
t
 
accum0
; \

6 
t
 
x
; \

7 
t
 
s
; \

9 
p
##
	t_‹¡_s
 
	tp
##
	t_‹¡_t
;

	)

11 
	#TEST_BODY
(
p
, 
t
, 
tc
, 

, 
FMT
) do { \

12 cÚ¡ 
p
##
_‹¡_t
 
‹¡s
[] = { \

13 {(
t
)-1, (t)-1, (t)-2}, \

14 {(
t
)-1, (t) 0, (t)-2}, \

15 {(
t
)-1, (t) 1, (t)-2}, \

17 {(
t
) 0, (t)-1, (t)-2}, \

18 {(
t
) 0, (t) 0, (t)-2}, \

19 {(
t
) 0, (t) 1, (t)-2}, \

21 {(
t
) 1, (t)-1, (t)-2}, \

22 {(
t
) 1, (t) 0, (t)-2}, \

23 {(
t
) 1, (t) 1, (t)-2}, \

25 {(
t
)0, (t)-(1 << 22), (t)-2}, \

26 {(
t
)0, (t)(1 << 22), (t)-2}, \

27 {(
t
)(1 << 22), (t)-(1 << 22), (t)-2}, \

28 {(
t
)(1 << 22), (t)(1 << 22), (t)-2} \

30 
i
; \

32 
i
 = 0; i < (
‹¡s
)/(
p
##
_‹¡_t
); i++) { \

33 
boŞ
 
”r
; \

34 
t
 
accum
 = 
‹¡s
[
i
].
accum0
; \

35 
as£¹_
##

##
	`_eq
(
©omic_»ad_
##
	`p
(&
accum
), \

36 
‹¡s
[
i
].
accum0
, \

37 "E¼Úeou »ad, i=%u", 
i
); \

39 
as£¹_
##

##
	`_eq
(
©omic_add_
##
	`p
(&
accum
, 
‹¡s
[
i
].
x
), \

40 (
t
)((
tc
)
‹¡s
[
i
].
accum0
 + (tcée¡s[i].
x
), \

41 "i=%u,‡ccum=%"
FMT
", x=%"FMT, \

42 
i
, 
‹¡s
[i].
accum0
,e¡s[i].
x
); \

43 
as£¹_
##

##
	`_eq
(
©omic_»ad_
##
	`p
(&
accum
),‡ccum, \

44 "E¼Úeou add, i=%u", 
i
); \

46 
accum
 = 
‹¡s
[
i
].
accum0
; \

47 
as£¹_
##

##
	`_eq
(
©omic_sub_
##
	`p
(&
accum
, 
‹¡s
[
i
].
x
), \

48 (
t
)((
tc
)
‹¡s
[
i
].
accum0
 - (tcée¡s[i].
x
), \

49 "i=%u,‡ccum=%"
FMT
", x=%"FMT, \

50 
i
, 
‹¡s
[i].
accum0
,e¡s[i].
x
); \

51 
as£¹_
##

##
	`_eq
(
©omic_»ad_
##
	`p
(&
accum
),‡ccum, \

52 "E¼Úeou sub, i=%u", 
i
); \

54 
accum
 = 
‹¡s
[
i
].
accum0
; \

55 
”r
 = 
©omic_ÿs_
##
	`p
(&
accum
, 
‹¡s
[
i
].
x
,e¡s[i].
s
); \

56 
	`as£¹_b_eq
(
”r
, 
‹¡s
[
i
].
accum0
 !ğ‹¡s[i].
x
, \

58 
as£¹_
##

##
	`_eq
(
accum
, 
”r
 ? 
‹¡s
[
i
].
accum0
 : \

59 
‹¡s
[
i
].
s
, "Erroneous casƒffect, i=%u", i); \

61 
accum
 = 
‹¡s
[
i
].
accum0
; \

62 
©omic_wr™e_
##
	`p
(&
accum
, 
‹¡s
[
i
].
s
); \

63 
as£¹_
##

##
	`_eq
(
accum
, 
‹¡s
[
i
].
s
, \

64 "E¼Úeou wr™e, i=%u", 
i
); \

66 } 0)

	)

68 
	$TEST_STRUCT
(
ušt64
, 
ušt64_t
)

69 
	$TEST_BEGIN
(
‹¡_©omic_ušt64
)

72 #ià!(
LG_SIZEOF_PTR
 =ğ3 || 
LG_SIZEOF_INT
 == 3)

73 
	`‹¡_sk
("64-bit‡tomic operations‚ot supported");

75 
	`TEST_BODY
(
ušt64
, 
ušt64_t
, ušt64_t, 
u64
, 
FMTx64
);

77 
	}
}

78 
TEST_END


80 
	$TEST_STRUCT
(
ušt32
, 
ušt32_t
)

81 
	$TEST_BEGIN
(
‹¡_©omic_ušt32
)

84 
	`TEST_BODY
(
ušt32
, 
ušt32_t
, ušt32_t, 
u32
, "#"
FMTx32
);

85 
	}
}

86 
TEST_END


88 
	$TEST_STRUCT
(
p
, *)

89 
	$TEST_BEGIN
(
‹¡_©omic_p
)

92 
	`TEST_BODY
(
p
, *, 
ušŒ_t
, 
±r
, "p");

93 
	}
}

94 
TEST_END


96 
	$TEST_STRUCT
(
z
, 
size_t
)

97 
	$TEST_BEGIN
(
‹¡_©omic_z
)

100 
	`TEST_BODY
(
z
, 
size_t
, size_t, 
zu
, "#zx");

101 
	}
}

102 
TEST_END


104 
	$TEST_STRUCT
(
u
, )

105 
	$TEST_BEGIN
(
‹¡_©omic_u
)

108 
	`TEST_BODY
(
u
, , , u, "#x");

109 
	}
}

110 
TEST_END


113 
	$maš
()

116  (
	`‹¡
(

117 
‹¡_©omic_ušt64
,

118 
‹¡_©omic_ušt32
,

119 
‹¡_©omic_p
,

120 
‹¡_©omic_z
,

121 
‹¡_©omic_u
));

122 
	}
}

	@deps/jemalloc/test/unit/bitmap.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_b™m­_size
)

5 
size_t
 
i
, 
´ev_size
;

7 
´ev_size
 = 0;

8 
i
 = 1; i <ğ
BITMAP_MAXBITS
; i++) {

9 
size_t
 
size
 = 
	`b™m­_size
(
i
);

10 
	`as£¹_Œue
(
size
 >ğ
´ev_size
,

12 
´ev_size
 = 
size
;

14 
	}
}

15 
TEST_END


17 
	$TEST_BEGIN
(
‹¡_b™m­_š™
)

19 
size_t
 
i
;

21 
i
 = 1; i <ğ
BITMAP_MAXBITS
; i++) {

22 
b™m­_šfo_t
 
bšfo
;

23 
	`b™m­_šfo_š™
(&
bšfo
, 
i
);

25 
size_t
 
j
;

26 
b™m­_t
 *
b™m­
 = (b™m­_ˆ*)
	`m®loc
((bitmap_t) *

27 
	`b™m­_šfo_ngroups
(&
bšfo
));

28 
	`b™m­_š™
(
b™m­
, &
bšfo
);

30 
j
 = 0; j < 
i
; j++) {

31 
	`as£¹_çl£
(
	`b™m­_g‘
(
b™m­
, &
bšfo
, 
j
),

34 
	`ä“
(
b™m­
);

37 
	}
}

38 
TEST_END


40 
	$TEST_BEGIN
(
‹¡_b™m­_£t
)

42 
size_t
 
i
;

44 
i
 = 1; i <ğ
BITMAP_MAXBITS
; i++) {

45 
b™m­_šfo_t
 
bšfo
;

46 
	`b™m­_šfo_š™
(&
bšfo
, 
i
);

48 
size_t
 
j
;

49 
b™m­_t
 *
b™m­
 = (b™m­_ˆ*)
	`m®loc
((bitmap_t) *

50 
	`b™m­_šfo_ngroups
(&
bšfo
));

51 
	`b™m­_š™
(
b™m­
, &
bšfo
);

53 
j
 = 0; j < 
i
; j++)

54 
	`b™m­_£t
(
b™m­
, &
bšfo
, 
j
);

55 
	`as£¹_Œue
(
	`b™m­_fuÎ
(
b™m­
, &
bšfo
),

57 
	`ä“
(
b™m­
);

60 
	}
}

61 
TEST_END


63 
	$TEST_BEGIN
(
‹¡_b™m­_un£t
)

65 
size_t
 
i
;

67 
i
 = 1; i <ğ
BITMAP_MAXBITS
; i++) {

68 
b™m­_šfo_t
 
bšfo
;

69 
	`b™m­_šfo_š™
(&
bšfo
, 
i
);

71 
size_t
 
j
;

72 
b™m­_t
 *
b™m­
 = (b™m­_ˆ*)
	`m®loc
((bitmap_t) *

73 
	`b™m­_šfo_ngroups
(&
bšfo
));

74 
	`b™m­_š™
(
b™m­
, &
bšfo
);

76 
j
 = 0; j < 
i
; j++)

77 
	`b™m­_£t
(
b™m­
, &
bšfo
, 
j
);

78 
	`as£¹_Œue
(
	`b™m­_fuÎ
(
b™m­
, &
bšfo
),

80 
j
 = 0; j < 
i
; j++)

81 
	`b™m­_un£t
(
b™m­
, &
bšfo
, 
j
);

82 
j
 = 0; j < 
i
; j++)

83 
	`b™m­_£t
(
b™m­
, &
bšfo
, 
j
);

84 
	`as£¹_Œue
(
	`b™m­_fuÎ
(
b™m­
, &
bšfo
),

86 
	`ä“
(
b™m­
);

89 
	}
}

90 
TEST_END


92 
	$TEST_BEGIN
(
‹¡_b™m­_sfu
)

94 
size_t
 
i
;

96 
i
 = 1; i <ğ
BITMAP_MAXBITS
; i++) {

97 
b™m­_šfo_t
 
bšfo
;

98 
	`b™m­_šfo_š™
(&
bšfo
, 
i
);

100 
ssize_t
 
j
;

101 
b™m­_t
 *
b™m­
 = (b™m­_ˆ*)
	`m®loc
((bitmap_t) *

102 
	`b™m­_šfo_ngroups
(&
bšfo
));

103 
	`b™m­_š™
(
b™m­
, &
bšfo
);

106 
j
 = 0; j < 
i
; j++) {

107 
	`as£¹_zd_eq
(
	`b™m­_sfu
(
b™m­
, &
bšfo
), 
j
,

111 
	`as£¹_Œue
(
	`b™m­_fuÎ
(
b™m­
, &
bšfo
),

118 
j
 = 
i
 - 1; j >= 0; j--) {

119 
	`b™m­_un£t
(
b™m­
, &
bšfo
, 
j
);

120 
	`as£¹_zd_eq
(
	`b™m­_sfu
(
b™m­
, &
bšfo
), 
j
,

123 
	`b™m­_un£t
(
b™m­
, &
bšfo
, 
j
);

125 
	`as£¹_çl£
(
	`b™m­_g‘
(
b™m­
, &
bšfo
, 0),

132 
j
 = 1; j < 
i
; j++) {

133 
	`b™m­_£t
(
b™m­
, &
bšfo
, 
j
 - 1);

134 
	`as£¹_zd_eq
(
	`b™m­_sfu
(
b™m­
, &
bšfo
), 
j
,

137 
	`b™m­_un£t
(
b™m­
, &
bšfo
, 
j
);

139 
	`as£¹_zd_eq
(
	`b™m­_sfu
(
b™m­
, &
bšfo
), 
i
 - 1,

141 
	`as£¹_Œue
(
	`b™m­_fuÎ
(
b™m­
, &
bšfo
),

143 
	`ä“
(
b™m­
);

146 
	}
}

147 
TEST_END


150 
	$maš
()

153  (
	`‹¡
(

154 
‹¡_b™m­_size
,

155 
‹¡_b™m­_š™
,

156 
‹¡_b™m­_£t
,

157 
‹¡_b™m­_un£t
,

158 
‹¡_b™m­_sfu
));

159 
	}
}

	@deps/jemalloc/test/unit/ckh.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_Ãw_d–‘e
)

5 
tsd_t
 *
tsd
;

6 
ckh_t
 
ckh
;

8 
tsd
 = 
	`tsd_ãtch
();

10 
	`as£¹_çl£
(
	`ckh_Ãw
(
tsd
, &
ckh
, 2, 
ckh_¡ršg_hash
, 
ckh_¡ršg_keycomp
),

12 
	`ckh_d–‘e
(
tsd
, &
ckh
);

14 
	`as£¹_çl£
(
	`ckh_Ãw
(
tsd
, &
ckh
, 3, 
ckh_poš‹r_hash
,

15 
ckh_poš‹r_keycomp
), "Unexpected ckh_new()ƒrror");

16 
	`ckh_d–‘e
(
tsd
, &
ckh
);

17 
	}
}

18 
TEST_END


20 
	$TEST_BEGIN
(
‹¡_couÁ_š£¹_£¬ch_»move
)

22 
tsd_t
 *
tsd
;

23 
ckh_t
 
ckh
;

24 cÚ¡ *
¡rs
[] = {

30 cÚ¡ *
missšg
 = "A string‚ot inhe hashable.";

31 
size_t
 
i
;

33 
tsd
 = 
	`tsd_ãtch
();

35 
	`as£¹_çl£
(
	`ckh_Ãw
(
tsd
, &
ckh
, 2, 
ckh_¡ršg_hash
, 
ckh_¡ršg_keycomp
),

37 
	`as£¹_zu_eq
(
	`ckh_couÁ
(&
ckh
), 0,

38 "ckh_couÁ(èshould„‘uº %zu, buˆ™„‘uºed %zu", 
	`ZU
(0),

39 
	`ckh_couÁ
(&
ckh
));

42 
i
 = 0; i < (
¡rs
)/(const *); i++) {

43 
	`ckh_š£¹
(
tsd
, &
ckh
, 
¡rs
[
i
], strs[i]);

44 
	`as£¹_zu_eq
(
	`ckh_couÁ
(&
ckh
), 
i
+1,

45 "ckh_couÁ(èshould„‘uº %zu, buˆ™„‘uºed %zu", 
i
+1,

46 
	`ckh_couÁ
(&
ckh
));

50 
i
 = 0; i < (
¡rs
)/(const *); i++) {

52 *
p
;

53 cÚ¡ *
s
;

54 } 
k
, 
v
;

55 **
kp
, **
vp
;

56 cÚ¡ *
ks
, *
vs
;

58 
kp
 = (
i
 & 1è? &
k
.
p
 : 
NULL
;

59 
vp
 = (
i
 & 2è? &
v
.
p
 : 
NULL
;

60 
k
.
p
 = 
NULL
;

61 
v
.
p
 = 
NULL
;

62 
	`as£¹_çl£
(
	`ckh_£¬ch
(&
ckh
, 
¡rs
[
i
], 
kp
, 
vp
),

65 
ks
 = (
i
 & 1è? 
¡rs
[i] : (cÚ¡ *)
NULL
;

66 
vs
 = (
i
 & 2è? 
¡rs
[i] : (cÚ¡ *)
NULL
;

67 
	`as£¹_±r_eq
((*)
ks
, (*)
k
.
s
, "Key mismatch, i=%zu",

68 
i
);

69 
	`as£¹_±r_eq
((*)
vs
, (*)
v
.
s
, "Value mismatch, i=%zu",

70 
i
);

72 
	`as£¹_Œue
(
	`ckh_£¬ch
(&
ckh
, 
missšg
, 
NULL
, NULL),

76 
i
 = 0; i < (
¡rs
)/(const *); i++) {

78 *
p
;

79 cÚ¡ *
s
;

80 } 
k
, 
v
;

81 **
kp
, **
vp
;

82 cÚ¡ *
ks
, *
vs
;

84 
kp
 = (
i
 & 1è? &
k
.
p
 : 
NULL
;

85 
vp
 = (
i
 & 2è? &
v
.
p
 : 
NULL
;

86 
k
.
p
 = 
NULL
;

87 
v
.
p
 = 
NULL
;

88 
	`as£¹_çl£
(
	`ckh_»move
(
tsd
, &
ckh
, 
¡rs
[
i
], 
kp
, 
vp
),

91 
ks
 = (
i
 & 1è? 
¡rs
[i] : (cÚ¡ *)
NULL
;

92 
vs
 = (
i
 & 2è? 
¡rs
[i] : (cÚ¡ *)
NULL
;

93 
	`as£¹_±r_eq
((*)
ks
, (*)
k
.
s
, "Key mismatch, i=%zu",

94 
i
);

95 
	`as£¹_±r_eq
((*)
vs
, (*)
v
.
s
, "Value mismatch, i=%zu",

96 
i
);

97 
	`as£¹_zu_eq
(
	`ckh_couÁ
(&
ckh
),

98 (
¡rs
)/(cÚ¡ *è- 
i
 - 1,

100 (
¡rs
)/(cÚ¡ *è- 
i
 - 1,

101 
	`ckh_couÁ
(&
ckh
));

104 
	`ckh_d–‘e
(
tsd
, &
ckh
);

105 
	}
}

106 
TEST_END


108 
	$TEST_BEGIN
(
‹¡_š£¹_™”_»move
)

110 
	#NITEMS
 
	`ZU
(1000)

	)

111 
tsd_t
 *
tsd
;

112 
ckh_t
 
ckh
;

113 **
p
[
NITEMS
];

114 *
q
, *
r
;

115 
size_t
 
i
;

117 
tsd
 = 
	`tsd_ãtch
();

119 
	`as£¹_çl£
(
	`ckh_Ãw
(
tsd
, &
ckh
, 2, 
ckh_poš‹r_hash
,

120 
ckh_poš‹r_keycomp
), "Unexpected ckh_new()ƒrror");

122 
i
 = 0; i < 
NITEMS
; i++) {

123 
p
[
i
] = 
	`m®locx
(i+1, 0);

124 
	`as£¹_±r_nÙ_nuÎ
(
p
[
i
], "Unexpected mallocx() failure");

127 
i
 = 0; i < 
NITEMS
; i++) {

128 
size_t
 
j
;

130 
j
 = 
i
; j < 
NITEMS
; j++) {

131 
	`as£¹_çl£
(
	`ckh_š£¹
(
tsd
, &
ckh
, 
p
[
j
],…[j]),

133 
	`as£¹_çl£
(
	`ckh_£¬ch
(&
ckh
, 
p
[
j
], &
q
, &
r
),

135 
	`as£¹_±r_eq
(
p
[
j
], 
q
, "Key…ointer mismatch");

136 
	`as£¹_±r_eq
(
p
[
j
], 
r
, "Value…ointer mismatch");

139 
	`as£¹_zu_eq
(
	`ckh_couÁ
(&
ckh
), 
NITEMS
,

141 
NITEMS
, 
	`ckh_couÁ
(&
ckh
));

143 
j
 = 
i
 + 1; j < 
NITEMS
; j++) {

144 
	`as£¹_çl£
(
	`ckh_£¬ch
(&
ckh
, 
p
[
j
], 
NULL
, NULL),

146 
	`as£¹_çl£
(
	`ckh_»move
(
tsd
, &
ckh
, 
p
[
j
], &
q
, &
r
),

148 
	`as£¹_±r_eq
(
p
[
j
], 
q
, "Key…ointer mismatch");

149 
	`as£¹_±r_eq
(
p
[
j
], 
r
, "Value…ointer mismatch");

150 
	`as£¹_Œue
(
	`ckh_£¬ch
(&
ckh
, 
p
[
j
], 
NULL
, NULL),

152 
	`as£¹_Œue
(
	`ckh_»move
(
tsd
, &
ckh
, 
p
[
j
], &
q
, &
r
),

157 
boŞ
 
£’
[
NITEMS
];

158 
size_t
 
bšd
;

160 
	`mem£t
(
£’
, 0, (seen));

162 
bšd
 = 0; !
	`ckh_™”
(&
ckh
, &bšd, &
q
, &
r
);) {

163 
size_t
 
k
;

165 
	`as£¹_±r_eq
(
q
, 
r
, "Key‡nd val‚otƒqual");

167 
k
 = 0; k < 
NITEMS
; k++) {

168 ià(
p
[
k
] =ğ
q
) {

169 
	`as£¹_çl£
(
£’
[
k
],

170 "I‹m %zu‡Ì—dy s“n", 
k
);

171 
£’
[
k
] = 
Œue
;

177 
j
 = 0; j < 
i
 + 1; j++)

178 
	`as£¹_Œue
(
£’
[
j
], "Item %zu‚ot seen", j);

179 ; 
j
 < 
NITEMS
; j++)

180 
	`as£¹_çl£
(
£’
[
j
], "Item %zu seen", j);

184 
i
 = 0; i < 
NITEMS
; i++) {

185 
	`as£¹_çl£
(
	`ckh_£¬ch
(&
ckh
, 
p
[
i
], 
NULL
, NULL),

187 
	`as£¹_çl£
(
	`ckh_»move
(
tsd
, &
ckh
, 
p
[
i
], &
q
, &
r
),

189 
	`as£¹_±r_eq
(
p
[
i
], 
q
, "Key…ointer mismatch");

190 
	`as£¹_±r_eq
(
p
[
i
], 
r
, "Value…ointer mismatch");

191 
	`as£¹_Œue
(
	`ckh_£¬ch
(&
ckh
, 
p
[
i
], 
NULL
, NULL),

193 
	`as£¹_Œue
(
	`ckh_»move
(
tsd
, &
ckh
, 
p
[
i
], &
q
, &
r
),

195 
	`d®locx
(
p
[
i
], 0);

198 
	`as£¹_zu_eq
(
	`ckh_couÁ
(&
ckh
), 0,

200 
	`ZU
(0), 
	`ckh_couÁ
(&
ckh
));

201 
	`ckh_d–‘e
(
tsd
, &
ckh
);

202 #undeà
NITEMS


203 
	}
}

204 
TEST_END


207 
	$maš
()

210  (
	`‹¡
(

211 
‹¡_Ãw_d–‘e
,

212 
‹¡_couÁ_š£¹_£¬ch_»move
,

213 
‹¡_š£¹_™”_»move
));

214 
	}
}

	@deps/jemalloc/test/unit/hash.c

30 
	~"‹¡/jem®loc_‹¡.h
"

33 
	mhash_v¬ŸÁ_x86_32
,

34 
	mhash_v¬ŸÁ_x86_128
,

35 
	mhash_v¬ŸÁ_x64_128


36 } 
	thash_v¬ŸÁ_t
;

38 
size_t


39 
	$hash_v¬ŸÁ_b™s
(
hash_v¬ŸÁ_t
 
v¬ŸÁ
)

42 
v¬ŸÁ
) {

43 
hash_v¬ŸÁ_x86_32
:  (32);

44 
hash_v¬ŸÁ_x86_128
:  (128);

45 
hash_v¬ŸÁ_x64_128
:  (128);

46 : 
	`nÙ_»ached
();

48 
	}
}

51 
	$hash_v¬ŸÁ_¡ršg
(
hash_v¬ŸÁ_t
 
v¬ŸÁ
)

54 
v¬ŸÁ
) {

55 
hash_v¬ŸÁ_x86_32
:  ("hash_x86_32");

56 
hash_v¬ŸÁ_x86_128
:  ("hash_x86_128");

57 
hash_v¬ŸÁ_x64_128
:  ("hash_x64_128");

58 : 
	`nÙ_»ached
();

60 
	}
}

63 
	$hash_v¬ŸÁ_v”ify
(
hash_v¬ŸÁ_t
 
v¬ŸÁ
)

65 cÚ¡ 
size_t
 
hashby‹s
 = 
	`hash_v¬ŸÁ_b™s
(
v¬ŸÁ
) / 8;

66 
ušt8_t
 
key
[256];

67 
	`VARIABLE_ARRAY
(
ušt8_t
, 
hashes
, 
hashby‹s
 * 256);

68 
	`VARIABLE_ARRAY
(
ušt8_t
, 
fš®
, 
hashby‹s
);

69 
i
;

70 
ušt32_t
 
compu‹d
, 
ex³ùed
;

72 
	`mem£t
(
key
, 0, (key));

73 
	`mem£t
(
hashes
, 0, (hashes));

74 
	`mem£t
(
fš®
, 0, (final));

80 
i
 = 0; i < 256; i++) {

81 
key
[
i
] = (
ušt8_t
)i;

82 
v¬ŸÁ
) {

83 
hash_v¬ŸÁ_x86_32
: {

84 
ušt32_t
 
out
;

85 
out
 = 
	`hash_x86_32
(
key
, 
i
, 256-i);

86 
	`memıy
(&
hashes
[
i
*
hashby‹s
], &
out
, hashbytes);

88 } 
hash_v¬ŸÁ_x86_128
: {

89 
ušt64_t
 
out
[2];

90 
	`hash_x86_128
(
key
, 
i
, 256-i, 
out
);

91 
	`memıy
(&
hashes
[
i
*
hashby‹s
], 
out
, hashbytes);

93 } 
hash_v¬ŸÁ_x64_128
: {

94 
ušt64_t
 
out
[2];

95 
	`hash_x64_128
(
key
, 
i
, 256-i, 
out
);

96 
	`memıy
(&
hashes
[
i
*
hashby‹s
], 
out
, hashbytes);

98 } : 
	`nÙ_»ached
();

103 
v¬ŸÁ
) {

104 
hash_v¬ŸÁ_x86_32
: {

105 
ušt32_t
 
out
 = 
	`hash_x86_32
(
hashes
, 
hashby‹s
*256, 0);

106 
	`memıy
(
fš®
, &
out
, (out));

108 } 
hash_v¬ŸÁ_x86_128
: {

109 
ušt64_t
 
out
[2];

110 
	`hash_x86_128
(
hashes
, 
hashby‹s
*256, 0, 
out
);

111 
	`memıy
(
fš®
, 
out
, (out));

113 } 
hash_v¬ŸÁ_x64_128
: {

114 
ušt64_t
 
out
[2];

115 
	`hash_x64_128
(
hashes
, 
hashby‹s
*256, 0, 
out
);

116 
	`memıy
(
fš®
, 
out
, (out));

118 } : 
	`nÙ_»ached
();

121 
compu‹d
 = (
fš®
[0] << 0) | (final[1] << 8) | (final[2] << 16) |

122 (
fš®
[3] << 24);

124 
v¬ŸÁ
) {

125 #ifdeà
JEMALLOC_BIG_ENDIAN


126 
hash_v¬ŸÁ_x86_32
: 
ex³ùed
 = 0x6213303eU; ;

127 
hash_v¬ŸÁ_x86_128
: 
ex³ùed
 = 0x266820caU; ;

128 
hash_v¬ŸÁ_x64_128
: 
ex³ùed
 = 0xcc622b6fU; ;

130 
hash_v¬ŸÁ_x86_32
: 
ex³ùed
 = 0xb0f57ee3U; ;

131 
hash_v¬ŸÁ_x86_128
: 
ex³ùed
 = 0xb3ece62aU; ;

132 
hash_v¬ŸÁ_x64_128
: 
ex³ùed
 = 0x6384ba69U; ;

134 : 
	`nÙ_»ached
();

137 
	`as£¹_u32_eq
(
compu‹d
, 
ex³ùed
,

139 
	`hash_v¬ŸÁ_¡ršg
(
v¬ŸÁ
), 
ex³ùed
, 
compu‹d
);

140 
	}
}

142 
	$TEST_BEGIN
(
‹¡_hash_x86_32
)

145 
	`hash_v¬ŸÁ_v”ify
(
hash_v¬ŸÁ_x86_32
);

146 
	}
}

147 
TEST_END


149 
	$TEST_BEGIN
(
‹¡_hash_x86_128
)

152 
	`hash_v¬ŸÁ_v”ify
(
hash_v¬ŸÁ_x86_128
);

153 
	}
}

154 
TEST_END


156 
	$TEST_BEGIN
(
‹¡_hash_x64_128
)

159 
	`hash_v¬ŸÁ_v”ify
(
hash_v¬ŸÁ_x64_128
);

160 
	}
}

161 
TEST_END


164 
	$maš
()

167  (
	`‹¡
(

168 
‹¡_hash_x86_32
,

169 
‹¡_hash_x86_128
,

170 
‹¡_hash_x64_128
));

171 
	}
}

	@deps/jemalloc/test/unit/junk.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_FILL


4 #iâdeà
JEMALLOC_TEST_JUNK_OPT


5 
	#JEMALLOC_TEST_JUNK_OPT
 "junk:Œue"

	)

7 cÚ¡ *
	gm®loc_cÚf
 =

8 "abÜt:çl£,z”o:çl£,»dzÚe:Œue,qu¬ªtše:0," 
JEMALLOC_TEST_JUNK_OPT
;

11 
¬’a_d®loc_junk_sm®l_t
 *
	g¬’a_d®loc_junk_sm®l_Üig
;

12 
¬’a_d®loc_junk_Ïrge_t
 *
	g¬’a_d®loc_junk_Ïrge_Üig
;

13 
huge_d®loc_junk_t
 *
	ghuge_d®loc_junk_Üig
;

14 *
	gw©ch_fÜ_junkšg
;

15 
boŞ
 
	g§w_junkšg
;

18 
	$w©ch_junkšg
(*
p
)

21 
w©ch_fÜ_junkšg
 = 
p
;

22 
§w_junkšg
 = 
çl£
;

23 
	}
}

26 
	$¬’a_d®loc_junk_sm®l_š‹rû±
(*
±r
, 
¬’a_bš_šfo_t
 *
bš_šfo
)

28 
size_t
 
i
;

30 
	`¬’a_d®loc_junk_sm®l_Üig
(
±r
, 
bš_šfo
);

31 
i
 = 0; i < 
bš_šfo
->
»g_size
; i++) {

32 
	`as£¹_c_eq
(((*)
±r
)[
i
], 0x5a,

34 
i
, 
bš_šfo
->
»g_size
);

36 ià(
±r
 =ğ
w©ch_fÜ_junkšg
)

37 
§w_junkšg
 = 
Œue
;

38 
	}
}

41 
	$¬’a_d®loc_junk_Ïrge_š‹rû±
(*
±r
, 
size_t
 
usize
)

43 
size_t
 
i
;

45 
	`¬’a_d®loc_junk_Ïrge_Üig
(
±r
, 
usize
);

46 
i
 = 0; i < 
usize
; i++) {

47 
	`as£¹_c_eq
(((*)
±r
)[
i
], 0x5a,

49 
i
, 
usize
);

51 ià(
±r
 =ğ
w©ch_fÜ_junkšg
)

52 
§w_junkšg
 = 
Œue
;

53 
	}
}

56 
	$huge_d®loc_junk_š‹rû±
(*
±r
, 
size_t
 
usize
)

59 
	`huge_d®loc_junk_Üig
(
±r
, 
usize
);

65 ià(
±r
 =ğ
w©ch_fÜ_junkšg
)

66 
§w_junkšg
 = 
Œue
;

67 
	}
}

70 
	$‹¡_junk
(
size_t
 
sz_mš
, size_ˆ
sz_max
)

72 *
s
;

73 
size_t
 
sz_´ev
, 
sz
, 
i
;

75 ià(
İt_junk_ä“
) {

76 
¬’a_d®loc_junk_sm®l_Üig
 = 
¬’a_d®loc_junk_sm®l
;

77 
¬’a_d®loc_junk_sm®l
 = 
¬’a_d®loc_junk_sm®l_š‹rû±
;

78 
¬’a_d®loc_junk_Ïrge_Üig
 = 
¬’a_d®loc_junk_Ïrge
;

79 
¬’a_d®loc_junk_Ïrge
 = 
¬’a_d®loc_junk_Ïrge_š‹rû±
;

80 
huge_d®loc_junk_Üig
 = 
huge_d®loc_junk
;

81 
huge_d®loc_junk
 = 
huge_d®loc_junk_š‹rû±
;

84 
sz_´ev
 = 0;

85 
s
 = (*)
	`m®locx
(
sz_mš
, 0);

86 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

88 
sz
 = 
	`§Îocx
(
s
, 0); sz <ğ
sz_max
;

89 
sz_´ev
 = 
sz
, sz = 
	`§Îocx
(
s
, 0)) {

90 ià(
sz_´ev
 > 0) {

91 
	`as£¹_c_eq
(
s
[0], 'a',

93 
	`ZU
(0), 
sz_´ev
);

94 
	`as£¹_c_eq
(
s
[
sz_´ev
-1], 'a',

96 
sz_´ev
-1, sz_prev);

99 
i
 = 
sz_´ev
; i < 
sz
; i++) {

100 ià(
İt_junk_®loc
) {

101 
	`as£¹_c_eq
(
s
[
i
], 0xa5,

103 "junk-fËd", 
i
, 
sz
);

105 
s
[
i
] = 'a';

108 ià(
	`x®locx
(
s
, 
sz
+1, 0, 0) == sz) {

109 
	`w©ch_junkšg
(
s
);

110 
s
 = (*)
	`¿Îocx
(s, 
sz
+1, 0);

111 
	`as£¹_±r_nÙ_nuÎ
((*)
s
,

113 
	`as£¹_Œue
(!
İt_junk_ä“
 || 
§w_junkšg
,

115 
sz
);

119 
	`w©ch_junkšg
(
s
);

120 
	`d®locx
(
s
, 0);

121 
	`as£¹_Œue
(!
İt_junk_ä“
 || 
§w_junkšg
,

122 "Ex³ùed„egiÚ oàsiz%zuØbjunk-fËd", 
sz
);

124 ià(
İt_junk_ä“
) {

125 
¬’a_d®loc_junk_sm®l
 = 
¬’a_d®loc_junk_sm®l_Üig
;

126 
¬’a_d®loc_junk_Ïrge
 = 
¬’a_d®loc_junk_Ïrge_Üig
;

127 
huge_d®loc_junk
 = 
huge_d®loc_junk_Üig
;

129 
	}
}

131 
	$TEST_BEGIN
(
‹¡_junk_sm®l
)

134 
	`‹¡_sk_if
(!
cÚfig_fl
);

135 
	`‹¡_junk
(1, 
SMALL_MAXCLASS
-1);

136 
	}
}

137 
TEST_END


139 
	$TEST_BEGIN
(
‹¡_junk_Ïrge
)

142 
	`‹¡_sk_if
(!
cÚfig_fl
);

143 
	`‹¡_junk
(
SMALL_MAXCLASS
+1, 
Ïrge_maxşass
);

144 
	}
}

145 
TEST_END


147 
	$TEST_BEGIN
(
‹¡_junk_huge
)

150 
	`‹¡_sk_if
(!
cÚfig_fl
);

151 
	`‹¡_junk
(
Ïrge_maxşass
+1, 
chunksize
*2);

152 
	}
}

153 
TEST_END


155 
¬’a_¿Îoc_junk_Ïrge_t
 *
	g¬’a_¿Îoc_junk_Ïrge_Üig
;

156 *
	gmo¡_»ûÁly_Œimmed
;

158 
size_t


159 
	$shršk_size
(
size_t
 
size
)

161 
size_t
 
shršk_size
;

163 
shršk_size
 = 
size
 - 1; 
	`ÇÎocx
(shrink_size, 0) == size;

164 
shršk_size
--)

167  (
shršk_size
);

168 
	}
}

171 
	$¬’a_¿Îoc_junk_Ïrge_š‹rû±
(*
±r
, 
size_t
 
Şd_usize
, size_ˆ
usize
)

174 
	`¬’a_¿Îoc_junk_Ïrge_Üig
(
±r
, 
Şd_usize
, 
usize
);

175 
	`as£¹_zu_eq
(
Şd_usize
, 
Ïrge_maxşass
, "Unexpected old_usize");

176 
	`as£¹_zu_eq
(
usize
, 
	`shršk_size
(
Ïrge_maxşass
), "Unexpected usize");

177 
mo¡_»ûÁly_Œimmed
 = 
±r
;

178 
	}
}

180 
	$TEST_BEGIN
(
‹¡_junk_Ïrge_¿Îoc_shršk
)

182 *
p1
, *
p2
;

184 
p1
 = 
	`m®locx
(
Ïrge_maxşass
, 0);

185 
	`as£¹_±r_nÙ_nuÎ
(
p1
, "Unexpected mallocx() failure");

187 
¬’a_¿Îoc_junk_Ïrge_Üig
 = 
¬’a_¿Îoc_junk_Ïrge
;

188 
¬’a_¿Îoc_junk_Ïrge
 = 
¬’a_¿Îoc_junk_Ïrge_š‹rû±
;

190 
p2
 = 
	`¿Îocx
(
p1
, 
	`shršk_size
(
Ïrge_maxşass
), 0);

191 
	`as£¹_±r_eq
(
p1
, 
p2
, "Unexpected move during shrink");

193 
¬’a_¿Îoc_junk_Ïrge
 = 
¬’a_¿Îoc_junk_Ïrge_Üig
;

195 
	`as£¹_±r_eq
(
mo¡_»ûÁly_Œimmed
, 
p1
,

197 
	}
}

198 
TEST_END


200 
boŞ
 
	gd‘eùed_»dzÚe_cÜru±iÚ
;

203 
	$¬’a_»dzÚe_cÜru±iÚ_»¶aûm’t
(*
±r
, 
size_t
 
usize
, 
boŞ
 
aá”
,

204 
size_t
 
off£t
, 
ušt8_t
 
by‹
)

207 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
Œue
;

208 
	}
}

210 
	$TEST_BEGIN
(
‹¡_junk_»dzÚe
)

212 *
s
;

213 
¬’a_»dzÚe_cÜru±iÚ_t
 *
¬’a_»dzÚe_cÜru±iÚ_Üig
;

215 
	`‹¡_sk_if
(!
cÚfig_fl
);

216 
	`‹¡_sk_if
(!
İt_junk_®loc
 || !
İt_junk_ä“
);

218 
¬’a_»dzÚe_cÜru±iÚ_Üig
 = 
¬’a_»dzÚe_cÜru±iÚ
;

219 
¬’a_»dzÚe_cÜru±iÚ
 = 
¬’a_»dzÚe_cÜru±iÚ_»¶aûm’t
;

222 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
çl£
;

223 
s
 = (*)
	`m®locx
(1, 0);

224 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

225 
s
[-1] = 0xbb;

226 
	`d®locx
(
s
, 0);

227 
	`as£¹_Œue
(
d‘eùed_»dzÚe_cÜru±iÚ
,

231 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
çl£
;

232 
s
 = (*)
	`m®locx
(1, 0);

233 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

234 
s
[
	`§Îocx
(s, 0)] = 0xbb;

235 
	`d®locx
(
s
, 0);

236 
	`as£¹_Œue
(
d‘eùed_»dzÚe_cÜru±iÚ
,

239 
¬’a_»dzÚe_cÜru±iÚ
 = 
¬’a_»dzÚe_cÜru±iÚ_Üig
;

240 
	}
}

241 
TEST_END


244 
	$maš
()

247 
	`as£¹
(!
cÚfig_fl
 || 
İt_junk_®loc
 || 
İt_junk_ä“
);

248  (
	`‹¡
(

249 
‹¡_junk_sm®l
,

250 
‹¡_junk_Ïrge
,

251 
‹¡_junk_huge
,

252 
‹¡_junk_Ïrge_¿Îoc_shršk
,

253 
‹¡_junk_»dzÚe
));

254 
	}
}

	@deps/jemalloc/test/unit/junk_alloc.c

1 
	#JEMALLOC_TEST_JUNK_OPT
 "junk:®loc"

	)

2 
	~"junk.c
"

3 #undeà
JEMALLOC_TEST_JUNK_OPT


	@deps/jemalloc/test/unit/junk_free.c

1 
	#JEMALLOC_TEST_JUNK_OPT
 "junk:ä“"

	)

2 
	~"junk.c
"

3 #undeà
JEMALLOC_TEST_JUNK_OPT


	@deps/jemalloc/test/unit/lg_chunk.c

1 
	~"‹¡/jem®loc_‹¡.h
"

8 cÚ¡ *
	gm®loc_cÚf
 = "lg_chunk:0";

10 
	$TEST_BEGIN
(
‹¡_lg_chunk_şamp
)

12 *
p
;

14 
p
 = 
	`m®locx
(1, 0);

15 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

16 
	`d®locx
(
p
, 0);

17 
	}
}

18 
TEST_END


21 
	$maš
()

24  (
	`‹¡
(

25 
‹¡_lg_chunk_şamp
));

26 
	}
}

	@deps/jemalloc/test/unit/mallctl.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_m®lùl_”rÜs
)

5 
ušt64_t
 
•och
;

6 
size_t
 
sz
;

8 
	`as£¹_d_eq
(
	`m®lùl
("no_such_Çme", 
NULL
, NULL, NULL, 0), 
ENOENT
,

11 
	`as£¹_d_eq
(
	`m®lùl
("v”siÚ", 
NULL
, NULL, "0.0.0", 
	`¡¾’
("0.0.0")),

12 
EPERM
, "mallctl() should„eturn EPERM on‡ttempto write "

15 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)-1),

16 
EINVAL
, "mallctl() should„eturn EINVAL for input size mismatch");

17 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)+1),

18 
EINVAL
, "mallctl() should„eturn EINVAL for input size mismatch");

20 
sz
 = (
•och
)-1;

21 
	`as£¹_d_eq
(
	`m®lùl
("•och", &
•och
, &
sz
, 
NULL
, 0), 
EINVAL
,

23 
sz
 = (
•och
)+1;

24 
	`as£¹_d_eq
(
	`m®lùl
("•och", &
•och
, &
sz
, 
NULL
, 0), 
EINVAL
,

26 
	}
}

27 
TEST_END


29 
	$TEST_BEGIN
(
‹¡_m®lùÊam‘omib_”rÜs
)

31 
size_t
 
mib
[1];

32 
size_t
 
mibËn
;

34 
mibËn
 = (
mib
)/(
size_t
);

35 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("no_such_Çme", 
mib
, &
mibËn
), 
ENOENT
,

37 
	}
}

38 
TEST_END


40 
	$TEST_BEGIN
(
‹¡_m®lùlbymib_”rÜs
)

42 
ušt64_t
 
•och
;

43 
size_t
 
sz
;

44 
size_t
 
mib
[1];

45 
size_t
 
mibËn
;

47 
mibËn
 = (
mib
)/(
size_t
);

48 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("v”siÚ", 
mib
, &
mibËn
), 0,

51 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, "0.0.0",

52 
	`¡¾’
("0.0.0")), 
EPERM
, "mallctl() should„eturn EPERM on "

55 
mibËn
 = (
mib
)/(
size_t
);

56 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("•och", 
mib
, &
mibËn
), 0,

59 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, &
•och
,

60 (
•och
)-1), 
EINVAL
,

62 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, &
•och
,

63 (
•och
)+1), 
EINVAL
,

66 
sz
 = (
•och
)-1;

67 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
•och
, &
sz
, 
NULL
, 0), 
EINVAL
,

69 
sz
 = (
•och
)+1;

70 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
•och
, &
sz
, 
NULL
, 0), 
EINVAL
,

72 
	}
}

73 
TEST_END


75 
	$TEST_BEGIN
(
‹¡_m®lùl_»ad_wr™e
)

77 
ušt64_t
 
Şd_•och
, 
Ãw_•och
;

78 
size_t
 
sz
 = (
Şd_•och
);

81 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, NULL, 0), 0,

83 
	`as£¹_zu_eq
(
sz
, (
Şd_•och
), "Unexpected output size");

86 
	`as£¹_d_eq
(
	`m®lùl
("•och", &
Şd_•och
, &
sz
, 
NULL
, 0), 0,

88 
	`as£¹_zu_eq
(
sz
, (
Şd_•och
), "Unexpected output size");

91 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
Ãw_•och
, (new_epoch)),

93 
	`as£¹_zu_eq
(
sz
, (
Şd_•och
), "Unexpected output size");

96 
	`as£¹_d_eq
(
	`m®lùl
("•och", &
Şd_•och
, &
sz
, &
Ãw_•och
,

97 (
Ãw_•och
)), 0, "Unexpected mallctl() failure");

98 
	`as£¹_zu_eq
(
sz
, (
Şd_•och
), "Unexpected output size");

99 
	}
}

100 
TEST_END


102 
	$TEST_BEGIN
(
‹¡_m®lùÊam‘omib_shÜt_mib
)

104 
size_t
 
mib
[4];

105 
size_t
 
mibËn
;

107 
mibËn
 = 3;

108 
mib
[3] = 42;

109 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’as.bš.0.Äegs", 
mib
, &
mibËn
), 0,

111 
	`as£¹_zu_eq
(
mibËn
, 3, "Unexpected mib output†ength");

112 
	`as£¹_zu_eq
(
mib
[3], 42,

114 
	}
}

115 
TEST_END


117 
	$TEST_BEGIN
(
‹¡_m®lùl_cÚfig
)

120 
	#TEST_MALLCTL_CONFIG
(
cÚfig
) do { \

121 
boŞ
 
Şdv®
; \

122 
size_t
 
sz
 = (
Şdv®
); \

123 
	`as£¹_d_eq
(
	`m®lùl
("cÚfig."#cÚfig, &
Şdv®
, &
sz
, 
NULL
, 0), \

125 
	`as£¹_b_eq
(
Şdv®
, 
cÚfig_
##
cÚfig
, "Incorrect config value"); \

126 
	`as£¹_zu_eq
(
sz
, (
Şdv®
), "Unexpected output size"); \

127 } 0)

	)

129 
	`TEST_MALLCTL_CONFIG
(
ÿche_oblivious
);

130 
	`TEST_MALLCTL_CONFIG
(
debug
);

131 
	`TEST_MALLCTL_CONFIG
(
fl
);

132 
	`TEST_MALLCTL_CONFIG
(
Ïzy_lock
);

133 
	`TEST_MALLCTL_CONFIG
(
munm­
);

134 
	`TEST_MALLCTL_CONFIG
(
´of
);

135 
	`TEST_MALLCTL_CONFIG
(
´of_libgcc
);

136 
	`TEST_MALLCTL_CONFIG
(
´of_libunwšd
);

137 
	`TEST_MALLCTL_CONFIG
(
¡©s
);

138 
	`TEST_MALLCTL_CONFIG
(
tÿche
);

139 
	`TEST_MALLCTL_CONFIG
(
s
);

140 
	`TEST_MALLCTL_CONFIG
(
uŒaû
);

141 
	`TEST_MALLCTL_CONFIG
(
v®gršd
);

142 
	`TEST_MALLCTL_CONFIG
(
xm®loc
);

144 #undeà
TEST_MALLCTL_CONFIG


145 
	}
}

146 
TEST_END


148 
	$TEST_BEGIN
(
‹¡_m®lùl_İt
)

150 
boŞ
 
cÚfig_®ways
 = 
Œue
;

152 
	#TEST_MALLCTL_OPT
(
t
, 
İt
, 
cÚfig
) do { \

153 
t
 
Şdv®
; \

154 
size_t
 
sz
 = (
Şdv®
); \

155 
ex³ùed
 = 
cÚfig_
##
cÚfig
 ? 0 : 
ENOENT
; \

156 
»suÉ
 = 
	`m®lùl
("İt."#İt, &
Şdv®
, &
sz
, 
NULL
, 0); \

157 
	`as£¹_d_eq
(
»suÉ
, 
ex³ùed
, \

159 
	`as£¹_zu_eq
(
sz
, (
Şdv®
), "Unexpected output size"); \

160 } 0)

	)

162 
	`TEST_MALLCTL_OPT
(
boŞ
, 
abÜt
, 
®ways
);

163 
	`TEST_MALLCTL_OPT
(
size_t
, 
lg_chunk
, 
®ways
);

164 
	`TEST_MALLCTL_OPT
(cÚ¡ *, 
dss
, 
®ways
);

165 
	`TEST_MALLCTL_OPT
(
size_t
, 
Ç»Çs
, 
®ways
);

166 
	`TEST_MALLCTL_OPT
(
ssize_t
, 
lg_dœty_muÉ
, 
®ways
);

167 
	`TEST_MALLCTL_OPT
(
boŞ
, 
¡©s_´št
, 
®ways
);

168 
	`TEST_MALLCTL_OPT
(cÚ¡ *, 
junk
, 
fl
);

169 
	`TEST_MALLCTL_OPT
(
size_t
, 
qu¬ªtše
, 
fl
);

170 
	`TEST_MALLCTL_OPT
(
boŞ
, 
»dzÚe
, 
fl
);

171 
	`TEST_MALLCTL_OPT
(
boŞ
, 
z”o
, 
fl
);

172 
	`TEST_MALLCTL_OPT
(
boŞ
, 
uŒaû
, utrace);

173 
	`TEST_MALLCTL_OPT
(
boŞ
, 
xm®loc
, xmalloc);

174 
	`TEST_MALLCTL_OPT
(
boŞ
, 
tÿche
,cache);

175 
	`TEST_MALLCTL_OPT
(
size_t
, 
lg_tÿche_max
, 
tÿche
);

176 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of
,…rof);

177 
	`TEST_MALLCTL_OPT
(cÚ¡ *, 
´of_´efix
, 
´of
);

178 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of_aùive
, 
´of
);

179 
	`TEST_MALLCTL_OPT
(
ssize_t
, 
lg_´of_§m¶e
, 
´of
);

180 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of_accum
, 
´of
);

181 
	`TEST_MALLCTL_OPT
(
ssize_t
, 
lg_´of_š‹rv®
, 
´of
);

182 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of_gdump
, 
´of
);

183 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of_fš®
, 
´of
);

184 
	`TEST_MALLCTL_OPT
(
boŞ
, 
´of_Ëak
, 
´of
);

186 #undeà
TEST_MALLCTL_OPT


187 
	}
}

188 
TEST_END


190 
	$TEST_BEGIN
(
‹¡_mª·ge_exam¶e
)

192 
nbšs
, 
i
;

193 
size_t
 
mib
[4];

194 
size_t
 
Ën
, 
mibËn
;

196 
Ën
 = (
nbšs
);

197 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.nbšs", &
nbšs
, &
Ën
, 
NULL
, 0), 0,

200 
mibËn
 = 4;

201 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’as.bš.0.size", 
mib
, &
mibËn
), 0,

203 
i
 = 0; i < 
nbšs
; i++) {

204 
size_t
 
bš_size
;

206 
mib
[2] = 
i
;

207 
Ën
 = (
bš_size
);

208 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
bš_size
, &
Ën
, 
NULL
, 0),

212 
	}
}

213 
TEST_END


215 
	$TEST_BEGIN
(
‹¡_tÿche_nÚe
)

217 *
p0
, *
q
, *
p1
;

219 
	`‹¡_sk_if
(!
cÚfig_tÿche
);

222 
p0
 = 
	`m®locx
(42, 0);

223 
	`as£¹_±r_nÙ_nuÎ
(
p0
, "Unexpected mallocx() failure");

224 
q
 = 
	`m®locx
(42, 0);

225 
	`as£¹_±r_nÙ_nuÎ
(
q
, "Unexpected mallocx() failure");

228 
	`d®locx
(
p0
, 0);

229 
	`d®locx
(
q
, 
MALLOCX_TCACHE_NONE
);

232 
p1
 = 
	`m®locx
(42, 0);

233 
	`as£¹_±r_nÙ_nuÎ
(
p1
, "Unexpected mallocx() failure");

234 
	`as£¹_±r_eq
(
p0
, 
p1
, "Expectedcacheo‡llocate cached„egion");

237 
	`d®locx
(
p1
, 
MALLOCX_TCACHE_NONE
);

238 
	}
}

239 
TEST_END


241 
	$TEST_BEGIN
(
‹¡_tÿche
)

243 
	#NTCACHES
 10

	)

244 
tis
[
NTCACHES
];

245 *
ps
[
NTCACHES
];

246 *
qs
[
NTCACHES
];

247 
i
;

248 
size_t
 
sz
, 
psz
, 
qsz
;

250 
	`‹¡_sk_if
(!
cÚfig_tÿche
);

252 
psz
 = 42;

253 
qsz
 = 
	`ÇÎocx
(
psz
, 0) + 1;

256 
i
 = 0; i < 
NTCACHES
; i++) {

257 
sz
 = ();

258 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.ü—‹", &
tis
[
i
], &
sz
, 
NULL
, 0), 0,

259 "UÃx³ùed m®lùl(èçu», i=%u", 
i
);

263 
i
 = 0; i < 
NTCACHES
; i++) {

264 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.de¡roy", 
NULL
, NULL, &
tis
[
i
],

266 
i
);

268 
i
 = 0; i < 
NTCACHES
; i++) {

269 
sz
 = ();

270 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.ü—‹", &
tis
[
i
], &
sz
, 
NULL
, 0), 0,

271 "UÃx³ùed m®lùl(èçu», i=%u", 
i
);

275 
i
 = 0; i < 
NTCACHES
; i++) {

276 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.æush", 
NULL
, NULL, &
tis
[
i
],

278 
i
);

282 
i
 = 0; i < 
NTCACHES
; i++) {

283 
ps
[
i
] = 
	`m®locx
(
psz
, 
	`MALLOCX_TCACHE
(
tis
[i]));

284 
	`as£¹_±r_nÙ_nuÎ
(
ps
[
i
], "Unexpected mallocx() failure, i=%u",

285 
i
);

286 
	`d®locx
(
ps
[
i
], 
	`MALLOCX_TCACHE
(
tis
[i]));

288 
qs
[
i
] = 
	`m®locx
(
qsz
, 
	`MALLOCX_TCACHE
(
tis
[i]));

289 
	`as£¹_±r_nÙ_nuÎ
(
qs
[
i
], "Unexpected mallocx() failure, i=%u",

290 
i
);

291 
	`d®locx
(
qs
[
i
], 
	`MALLOCX_TCACHE
(
tis
[i]));

295 
i
 = 0; i < 
NTCACHES
; i++) {

296 *
p0
 = 
ps
[
i
];

297 
ps
[
i
] = 
	`m®locx
(
psz
, 
	`MALLOCX_TCACHE
(
tis
[i]));

298 
	`as£¹_±r_nÙ_nuÎ
(
ps
[
i
], "Unexpected mallocx() failure, i=%u",

299 
i
);

300 
	`as£¹_±r_eq
(
ps
[
i
], 
p0
,

301 "Ex³ùed m®locx(ètØ®loÿ‹ cached„egiÚ, i=%u", 
i
);

305 
i
 = 0; i < 
NTCACHES
; i++) {

306 *
q0
 = 
qs
[
i
];

307 
qs
[
i
] = 
	`¿Îocx
(
ps
[i], 
qsz
, 
	`MALLOCX_TCACHE
(
tis
[i]));

308 
	`as£¹_±r_nÙ_nuÎ
(
qs
[
i
], "Unexpected„allocx() failure, i=%u",

309 
i
);

310 
	`as£¹_±r_eq
(
qs
[
i
], 
q0
,

311 "Ex³ùed„®locx(ètØ®loÿ‹ cached„egiÚ, i=%u", 
i
);

313 ià(
qs
[
i
] =ğ
NULL
)

314 
qs
[
i
] = 
ps
[i];

316 
i
 = 0; i < 
NTCACHES
; i++)

317 
	`d®locx
(
qs
[
i
], 
	`MALLOCX_TCACHE
(
tis
[i]));

320 
i
 = 0; i < 
NTCACHES
/2; i++) {

321 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.æush", 
NULL
, NULL, &
tis
[
i
],

323 
i
);

327 
i
 = 0; i < 
NTCACHES
; i++) {

328 
	`as£¹_d_eq
(
	`m®lùl
("tÿche.de¡roy", 
NULL
, NULL, &
tis
[
i
],

330 
i
);

332 
	}
}

333 
TEST_END


335 
	$TEST_BEGIN
(
‹¡_th»ad_¬’a
)

337 
¬’a_Şd
, 
¬’a_Ãw
, 
Ç»Çs
;

338 
size_t
 
sz
 = ();

340 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ç»Çs", &
Ç»Çs
, &
sz
, 
NULL
, 0), 0,

342 
	`as£¹_u_eq
(
Ç»Çs
, 
İt_Ç»Çs
, "Number of‡renas incorrect");

343 
¬’a_Ãw
 = 
Ç»Çs
 - 1;

344 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", &
¬’a_Şd
, &
sz
, &
¬’a_Ãw
,

346 
¬’a_Ãw
 = 0;

347 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", &
¬’a_Şd
, &
sz
, &
¬’a_Ãw
,

349 
	}
}

350 
TEST_END


352 
	$TEST_BEGIN
(
‹¡_¬’a_i_lg_dœty_muÉ
)

354 
ssize_t
 
lg_dœty_muÉ
, 
Üig_lg_dœty_muÉ
, 
´ev_lg_dœty_muÉ
;

355 
size_t
 
sz
 = (
ssize_t
);

357 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.lg_dœty_muÉ", &
Üig_lg_dœty_muÉ
, &
sz
,

358 
NULL
, 0), 0, "Unexpected mallctl() failure");

360 
lg_dœty_muÉ
 = -2;

361 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.lg_dœty_muÉ", 
NULL
, NULL,

362 &
lg_dœty_muÉ
, (
ssize_t
)), 
EFAULT
,

365 
lg_dœty_muÉ
 = ((
size_t
) << 3);

366 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.lg_dœty_muÉ", 
NULL
, NULL,

367 &
lg_dœty_muÉ
, (
ssize_t
)), 
EFAULT
,

370 
´ev_lg_dœty_muÉ
 = 
Üig_lg_dœty_muÉ
, 
lg_dœty_muÉ
 = -1;

371 
lg_dœty_muÉ
 < (
ssize_t
)((
size_t
è<< 3); 
´ev_lg_dœty_muÉ


372 ğ
lg_dœty_muÉ
,†g_dirty_mult++) {

373 
ssize_t
 
Şd_lg_dœty_muÉ
;

375 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.lg_dœty_muÉ", &
Şd_lg_dœty_muÉ
,

376 &
sz
, &
lg_dœty_muÉ
, (
ssize_t
)), 0,

378 
	`as£¹_zd_eq
(
Şd_lg_dœty_muÉ
, 
´ev_lg_dœty_muÉ
,

381 
	}
}

382 
TEST_END


384 
	$TEST_BEGIN
(
‹¡_¬’a_i_purge
)

386 
Ç»Çs
;

387 
size_t
 
sz
 = ();

388 
size_t
 
mib
[3];

389 
size_t
 
mibËn
 = 3;

391 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.purge", 
NULL
, NULL, NULL, 0), 0,

394 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ç»Çs", &
Ç»Çs
, &
sz
, 
NULL
, 0), 0,

396 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’a.0.purge", 
mib
, &
mibËn
), 0,

398 
mib
[1] = 
Ç»Çs
;

399 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, 
NULL
, NULL, NULL, 0), 0,

401 
	}
}

402 
TEST_END


404 
	$TEST_BEGIN
(
‹¡_¬’a_i_dss
)

406 cÚ¡ *
dss_´ec_Şd
, *
dss_´ec_Ãw
;

407 
size_t
 
sz
 = (
dss_´ec_Şd
);

408 
size_t
 
mib
[3];

409 
size_t
 
mibËn
;

411 
mibËn
 = (
mib
)/(
size_t
);

412 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’a.0.dss", 
mib
, &
mibËn
), 0,

415 
dss_´ec_Ãw
 = "disabled";

416 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Şd
, &
sz
, &
dss_´ec_Ãw
,

417 (
dss_´ec_Ãw
)), 0, "Unexpected mallctl() failure");

418 
	`as£¹_¡r_Ã
(
dss_´ec_Şd
, "primary",

421 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Ãw
, &
sz
, &
dss_´ec_Şd
,

422 (
dss_´ec_Şd
)), 0, "Unexpected mallctl() failure");

424 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Şd
, &
sz
, 
NULL
, 0), 0,

426 
	`as£¹_¡r_Ã
(
dss_´ec_Şd
, "primary",

429 
mib
[1] = 
	`Ç»Çs_tÙ®_g‘
();

430 
dss_´ec_Ãw
 = "disabled";

431 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Şd
, &
sz
, &
dss_´ec_Ãw
,

432 (
dss_´ec_Ãw
)), 0, "Unexpected mallctl() failure");

433 
	`as£¹_¡r_Ã
(
dss_´ec_Şd
, "primary",

436 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Ãw
, &
sz
, &
dss_´ec_Şd
,

437 (
dss_´ec_Ãw
)), 0, "Unexpected mallctl() failure");

439 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
dss_´ec_Şd
, &
sz
, 
NULL
, 0), 0,

441 
	`as£¹_¡r_Ã
(
dss_´ec_Şd
, "primary",

443 
	}
}

444 
TEST_END


446 
	$TEST_BEGIN
(
‹¡_¬’as_š™Ÿlized
)

448 
Ç»Çs
;

449 
size_t
 
sz
 = (
Ç»Çs
);

451 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ç»Çs", &
Ç»Çs
, &
sz
, 
NULL
, 0), 0,

454 
	`VARIABLE_ARRAY
(
boŞ
, 
š™Ÿlized
, 
Ç»Çs
);

456 
sz
 = 
Ç»Çs
 * (
boŞ
);

457 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.š™Ÿlized", 
š™Ÿlized
, &
sz
,

458 
NULL
, 0), 0, "Unexpected mallctl() failure");

460 
	}
}

461 
TEST_END


463 
	$TEST_BEGIN
(
‹¡_¬’as_lg_dœty_muÉ
)

465 
ssize_t
 
lg_dœty_muÉ
, 
Üig_lg_dœty_muÉ
, 
´ev_lg_dœty_muÉ
;

466 
size_t
 
sz
 = (
ssize_t
);

468 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.lg_dœty_muÉ", &
Üig_lg_dœty_muÉ
, &
sz
,

469 
NULL
, 0), 0, "Unexpected mallctl() failure");

471 
lg_dœty_muÉ
 = -2;

472 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.lg_dœty_muÉ", 
NULL
, NULL,

473 &
lg_dœty_muÉ
, (
ssize_t
)), 
EFAULT
,

476 
lg_dœty_muÉ
 = ((
size_t
) << 3);

477 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.lg_dœty_muÉ", 
NULL
, NULL,

478 &
lg_dœty_muÉ
, (
ssize_t
)), 
EFAULT
,

481 
´ev_lg_dœty_muÉ
 = 
Üig_lg_dœty_muÉ
, 
lg_dœty_muÉ
 = -1;

482 
lg_dœty_muÉ
 < (
ssize_t
)((
size_t
è<< 3); 
´ev_lg_dœty_muÉ
 =

483 
lg_dœty_muÉ
,†g_dirty_mult++) {

484 
ssize_t
 
Şd_lg_dœty_muÉ
;

486 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.lg_dœty_muÉ", &
Şd_lg_dœty_muÉ
,

487 &
sz
, &
lg_dœty_muÉ
, (
ssize_t
)), 0,

489 
	`as£¹_zd_eq
(
Şd_lg_dœty_muÉ
, 
´ev_lg_dœty_muÉ
,

492 
	}
}

493 
TEST_END


495 
	$TEST_BEGIN
(
‹¡_¬’as_cÚ¡ªts
)

498 
	#TEST_ARENAS_CONSTANT
(
t
, 
Çme
, 
ex³ùed
) do { \

499 
t
 
Çme
; \

500 
size_t
 
sz
 = (
t
); \

501 
	`as£¹_d_eq
(
	`m®lùl
("¬’as."#Çme, &
Çme
, &
sz
, 
NULL
, 0), 0, \

503 
	`as£¹_zu_eq
(
Çme
, 
ex³ùed
, "Incorrect "#name" size"); \

504 } 0)

	)

506 
	`TEST_ARENAS_CONSTANT
(
size_t
, 
quªtum
, 
QUANTUM
);

507 
	`TEST_ARENAS_CONSTANT
(
size_t
, 
·ge
, 
PAGE
);

508 
	`TEST_ARENAS_CONSTANT
(, 
nbšs
, 
NBINS
);

509 
	`TEST_ARENAS_CONSTANT
(, 
Æruns
, 
Æşas£s
);

510 
	`TEST_ARENAS_CONSTANT
(, 
nhchunks
, 
nhşas£s
);

512 #undeà
TEST_ARENAS_CONSTANT


513 
	}
}

514 
TEST_END


516 
	$TEST_BEGIN
(
‹¡_¬’as_bš_cÚ¡ªts
)

519 
	#TEST_ARENAS_BIN_CONSTANT
(
t
, 
Çme
, 
ex³ùed
) do { \

520 
t
 
Çme
; \

521 
size_t
 
sz
 = (
t
); \

522 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.bš.0."#Çme, &
Çme
, &
sz
, 
NULL
, 0), \

524 
	`as£¹_zu_eq
(
Çme
, 
ex³ùed
, "Incorrect "#name" size"); \

525 } 0)

	)

527 
	`TEST_ARENAS_BIN_CONSTANT
(
size_t
, 
size
, 
¬’a_bš_šfo
[0].
»g_size
);

528 
	`TEST_ARENAS_BIN_CONSTANT
(
ušt32_t
, 
Äegs
, 
¬’a_bš_šfo
[0].nregs);

529 
	`TEST_ARENAS_BIN_CONSTANT
(
size_t
, 
run_size
, 
¬’a_bš_šfo
[0].run_size);

531 #undeà
TEST_ARENAS_BIN_CONSTANT


532 
	}
}

533 
TEST_END


535 
	$TEST_BEGIN
(
‹¡_¬’as_Ìun_cÚ¡ªts
)

538 
	#TEST_ARENAS_LRUN_CONSTANT
(
t
, 
Çme
, 
ex³ùed
) do { \

539 
t
 
Çme
; \

540 
size_t
 
sz
 = (
t
); \

541 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ìun.0."#Çme, &
Çme
, &
sz
, 
NULL
, \

543 
	`as£¹_zu_eq
(
Çme
, 
ex³ùed
, "Incorrect "#name" size"); \

544 } 0)

	)

546 
	`TEST_ARENAS_LRUN_CONSTANT
(
size_t
, 
size
, 
LARGE_MINCLASS
);

548 #undeà
TEST_ARENAS_LRUN_CONSTANT


549 
	}
}

550 
TEST_END


552 
	$TEST_BEGIN
(
‹¡_¬’as_hchunk_cÚ¡ªts
)

555 
	#TEST_ARENAS_HCHUNK_CONSTANT
(
t
, 
Çme
, 
ex³ùed
) do { \

556 
t
 
Çme
; \

557 
size_t
 
sz
 = (
t
); \

558 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.hchunk.0."#Çme, &
Çme
, &
sz
, 
NULL
, \

560 
	`as£¹_zu_eq
(
Çme
, 
ex³ùed
, "Incorrect "#name" size"); \

561 } 0)

	)

563 
	`TEST_ARENAS_HCHUNK_CONSTANT
(
size_t
, 
size
, 
chunksize
);

565 #undeà
TEST_ARENAS_HCHUNK_CONSTANT


566 
	}
}

567 
TEST_END


569 
	$TEST_BEGIN
(
‹¡_¬’as_ex‹nd
)

571 
Ç»Çs_befÜe
, 
¬’a
, 
Ç»Çs_aá”
;

572 
size_t
 
sz
 = ();

574 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ç»Çs", &
Ç»Çs_befÜe
, &
sz
, 
NULL
, 0), 0,

576 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.ex‹nd", &
¬’a
, &
sz
, 
NULL
, 0), 0,

578 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.Ç»Çs", &
Ç»Çs_aá”
, &
sz
, 
NULL
, 0), 0,

581 
	`as£¹_u_eq
(
Ç»Çs_befÜe
+1, 
Ç»Çs_aá”
,

583 
	`as£¹_u_eq
(
¬’a
, 
Ç»Çs_aá”
-1, "Unexpected‡rena index");

584 
	}
}

585 
TEST_END


587 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as
)

590 
	#TEST_STATS_ARENAS
(
t
, 
Çme
) do { \

591 
t
 
Çme
; \

592 
size_t
 
sz
 = (
t
); \

593 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0."#Çme, &
Çme
, &
sz
, 
NULL
, \

595 } 0)

	)

597 
	`TEST_STATS_ARENAS
(cÚ¡ *, 
dss
);

598 
	`TEST_STATS_ARENAS
(, 
Áh»ads
);

599 
	`TEST_STATS_ARENAS
(
size_t
, 
·ùive
);

600 
	`TEST_STATS_ARENAS
(
size_t
, 
pdœty
);

602 #undeà
TEST_STATS_ARENAS


603 
	}
}

604 
TEST_END


607 
	$maš
()

610  (
	`‹¡
(

611 
‹¡_m®lùl_”rÜs
,

612 
‹¡_m®lùÊam‘omib_”rÜs
,

613 
‹¡_m®lùlbymib_”rÜs
,

614 
‹¡_m®lùl_»ad_wr™e
,

615 
‹¡_m®lùÊam‘omib_shÜt_mib
,

616 
‹¡_m®lùl_cÚfig
,

617 
‹¡_m®lùl_İt
,

618 
‹¡_mª·ge_exam¶e
,

619 
‹¡_tÿche_nÚe
,

620 
‹¡_tÿche
,

621 
‹¡_th»ad_¬’a
,

622 
‹¡_¬’a_i_lg_dœty_muÉ
,

623 
‹¡_¬’a_i_purge
,

624 
‹¡_¬’a_i_dss
,

625 
‹¡_¬’as_š™Ÿlized
,

626 
‹¡_¬’as_lg_dœty_muÉ
,

627 
‹¡_¬’as_cÚ¡ªts
,

628 
‹¡_¬’as_bš_cÚ¡ªts
,

629 
‹¡_¬’as_Ìun_cÚ¡ªts
,

630 
‹¡_¬’as_hchunk_cÚ¡ªts
,

631 
‹¡_¬’as_ex‹nd
,

632 
‹¡_¡©s_¬’as
));

633 
	}
}

	@deps/jemalloc/test/unit/math.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#MAX_REL_ERR
 1.0e-9

	)

4 
	#MAX_ABS_ERR
 1.0e-9

	)

6 
	~<æßt.h
>

8 #iâdeà
INFINITY


9 
	#INFINITY
 (
DBL_MAX
 + DBL_MAX)

	)

12 
boŞ


13 
	$doubË_eq_»l
(
a
, 
b
, 
max_»l_”r
, 
max_abs_”r
)

15 
»l_”r
;

17 ià(
	`çbs
(
a
 - 
b
è< 
max_abs_”r
)

18  (
Œue
);

19 
»l_”r
 = (
	`çbs
(
b
è> fabs(
a
)) ? fabs((a-b)/b) : fabs((a-b)/a);

20  (
»l_”r
 < 
max_»l_”r
);

21 
	}
}

23 
ušt64_t


24 
	$çùÜŸl
(
x
)

26 
ušt64_t
 
»t
 = 1;

27 
i
;

29 
i
 = 2; i <ğ
x
; i++)

30 
»t
 *ğ(
ušt64_t
)
i
;

32  (
»t
);

33 
	}
}

35 
	$TEST_BEGIN
(
‹¡_Ê_gamma_çùÜŸl
)

37 
x
;

40 
x
 = 1; x <= 21; x++) {

41 
	`as£¹_Œue
(
	`doubË_eq_»l
(
	`exp
(
	`Ê_gamma
(
x
)),

42 ()
	`çùÜŸl
(
x
-1), 
MAX_REL_ERR
, 
MAX_ABS_ERR
),

43 "IncÜ»ù faùÜŸÈ»suÉ fÜ x=%u", 
x
);

45 
	}
}

46 
TEST_END


49 cÚ¡ 
	gÊ_gamma_misc_ex³ùed
[] = {

50 
INFINITY
,

187 
	$TEST_BEGIN
(
‹¡_Ê_gamma_misc
)

189 
i
;

191 
i
 = 1; i < (
Ê_gamma_misc_ex³ùed
)/(); i++) {

192 
x
 = ()
i
 * 0.25;

193 
	`as£¹_Œue
(
	`doubË_eq_»l
(
	`Ê_gamma
(
x
),

194 
Ê_gamma_misc_ex³ùed
[
i
], 
MAX_REL_ERR
, 
MAX_ABS_ERR
),

195 "IncÜ»ù†n_gamm¨»suÉ fÜ i=%u", 
i
);

197 
	}
}

198 
TEST_END


201 cÚ¡ 
	g±_nÜm_ex³ùed
[] = {

202 -
INFINITY
,

238 
	$TEST_BEGIN
(
‹¡_±_nÜm
)

240 
i
;

242 
i
 = 1; i < (
±_nÜm_ex³ùed
)/(); i++) {

243 
p
 = ()
i
 * 0.01;

244 
	`as£¹_Œue
(
	`doubË_eq_»l
(
	`±_nÜm
(
p
), 
±_nÜm_ex³ùed
[
i
],

245 
MAX_REL_ERR
, 
MAX_ABS_ERR
),

246 "IncÜ»ù…t_nÜm„esuÉ fÜ i=%u", 
i
);

248 
	}
}

249 
TEST_END


255 cÚ¡ 
	g±_chi2_df
[] = {0.1, 1.1, 10.1, 100.1, 1000.1};

256 cÚ¡ 
	g±_chi2_ex³ùed
[] = {

288 
	$TEST_BEGIN
(
‹¡_±_chi2
)

290 
i
, 
j
;

291 
e
 = 0;

293 
i
 = 0; i < (
±_chi2_df
)/(); i++) {

294 
df
 = 
±_chi2_df
[
i
];

295 
Ê_gamma_df
 = 
	`Ê_gamma
(
df
 * 0.5);

296 
j
 = 1; j < 100; j += 7) {

297 
p
 = ()
j
 * 0.01;

298 
	`as£¹_Œue
(
	`doubË_eq_»l
(
	`±_chi2
(
p
, 
df
, 
Ê_gamma_df
),

299 
±_chi2_ex³ùed
[
e
], 
MAX_REL_ERR
, 
MAX_ABS_ERR
),

300 "IncÜ»ù…t_chi2„esuÉ fÜ i=%u, j=%u", 
i
, 
j
);

301 
e
++;

304 
	}
}

305 
TEST_END


311 cÚ¡ 
	g±_gamma_sh­e
[] = {0.5, 1.0, 1.5, 2.0, 2.5, 3.0};

312 cÚ¡ 
	g±_gamma_ex³ùed
[] = {

350 
	$TEST_BEGIN
(
‹¡_±_gamma_sh­e
)

352 
i
, 
j
;

353 
e
 = 0;

355 
i
 = 0; i < (
±_gamma_sh­e
)/(); i++) {

356 
sh­e
 = 
±_gamma_sh­e
[
i
];

357 
Ê_gamma_sh­e
 = 
	`Ê_gamma
(
sh­e
);

358 
j
 = 1; j < 100; j += 7) {

359 
p
 = ()
j
 * 0.01;

360 
	`as£¹_Œue
(
	`doubË_eq_»l
(
	`±_gamma
(
p
, 
sh­e
, 1.0,

361 
Ê_gamma_sh­e
), 
±_gamma_ex³ùed
[
e
], 
MAX_REL_ERR
,

362 
MAX_ABS_ERR
),

363 "IncÜ»ù…t_gamm¨»suÉ fÜ i=%u, j=%u", 
i
, 
j
);

364 
e
++;

367 
	}
}

368 
TEST_END


370 
	$TEST_BEGIN
(
‹¡_±_gamma_sÿË
)

372 
sh­e
 = 1.0;

373 
Ê_gamma_sh­e
 = 
	`Ê_gamma
(
sh­e
);

375 
	`as£¹_Œue
(
	`doubË_eq_»l
(

376 
	`±_gamma
(0.5, 
sh­e
, 1.0, 
Ê_gamma_sh­e
) * 10.0,

377 
	`±_gamma
(0.5, 
sh­e
, 10.0, 
Ê_gamma_sh­e
), 
MAX_REL_ERR
,

378 
MAX_ABS_ERR
),

380 
	}
}

381 
TEST_END


384 
	$maš
()

387  (
	`‹¡
(

388 
‹¡_Ê_gamma_çùÜŸl
,

389 
‹¡_Ê_gamma_misc
,

390 
‹¡_±_nÜm
,

391 
‹¡_±_chi2
,

392 
‹¡_±_gamma_sh­e
,

393 
‹¡_±_gamma_sÿË
));

394 
	}
}

	@deps/jemalloc/test/unit/mq.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#NSENDERS
 3

	)

4 
	#NMSGS
 100000

	)

6 
mq_msg_s
 
	tmq_msg_t
;

7 
	smq_msg_s
 {

8 
mq_msg
(
mq_msg_t
è
	mlšk
;

10 
	$mq_g’
(, 
mq_
, 
mq_t
, 
mq_msg_t
, 
lšk
)

12 
	$TEST_BEGIN
(
‹¡_mq_basic
)

14 
mq_t
 
mq
;

15 
mq_msg_t
 
msg
;

17 
	`as£¹_çl£
(
	`mq_š™
(&
mq
), "Unexpected mq_init() failure");

18 
	`as£¹_u_eq
(
	`mq_couÁ
(&
mq
), 0, "mq should beƒmpty");

19 
	`as£¹_±r_nuÎ
(
	`mq_Œyg‘
(&
mq
),

22 
	`mq_put
(&
mq
, &
msg
);

23 
	`as£¹_u_eq
(
	`mq_couÁ
(&
mq
), 1, "mq should contain one message");

24 
	`as£¹_±r_eq
(
	`mq_Œyg‘
(&
mq
), &
msg
, "mq_tryget() should„eturn msg");

26 
	`mq_put
(&
mq
, &
msg
);

27 
	`as£¹_±r_eq
(
	`mq_g‘
(&
mq
), &
msg
, "mq_get() should„eturn msg");

29 
	`mq_fši
(&
mq
);

30 
	}
}

31 
TEST_END


34 
	$thd_»ûiv”_¡¬t
(*
¬g
)

36 
mq_t
 *
mq
 = (mq_ˆ*)
¬g
;

37 
i
;

39 
i
 = 0; i < (
NSENDERS
 * 
NMSGS
); i++) {

40 
mq_msg_t
 *
msg
 = 
	`mq_g‘
(
mq
);

41 
	`as£¹_±r_nÙ_nuÎ
(
msg
, "mq_get() should‚ever„eturn NULL");

42 
	`d®locx
(
msg
, 0);

44  (
NULL
);

45 
	}
}

48 
	$thd_£nd”_¡¬t
(*
¬g
)

50 
mq_t
 *
mq
 = (mq_ˆ*)
¬g
;

51 
i
;

53 
i
 = 0; i < 
NMSGS
; i++) {

54 
mq_msg_t
 *
msg
;

55 *
p
;

56 
p
 = 
	`m®locx
((
mq_msg_t
), 0);

57 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

58 
msg
 = (
mq_msg_t
 *)
p
;

59 
	`mq_put
(
mq
, 
msg
);

61  (
NULL
);

62 
	}
}

64 
	$TEST_BEGIN
(
‹¡_mq_th»aded
)

66 
mq_t
 
mq
;

67 
thd_t
 
»ûiv”
;

68 
thd_t
 
£nd”s
[
NSENDERS
];

69 
i
;

71 
	`as£¹_çl£
(
	`mq_š™
(&
mq
), "Unexpected mq_init() failure");

73 
	`thd_ü—‹
(&
»ûiv”
, 
thd_»ûiv”_¡¬t
, (*)&
mq
);

74 
i
 = 0; i < 
NSENDERS
; i++)

75 
	`thd_ü—‹
(&
£nd”s
[
i
], 
thd_£nd”_¡¬t
, (*)&
mq
);

77 
	`thd_još
(
»ûiv”
, 
NULL
);

78 
i
 = 0; i < 
NSENDERS
; i++)

79 
	`thd_još
(
£nd”s
[
i
], 
NULL
);

81 
	`mq_fši
(&
mq
);

82 
	}
}

83 
TEST_END


86 
	$maš
()

89  (
	`‹¡
(

90 
‹¡_mq_basic
,

91 
‹¡_mq_th»aded
));

92 
	}
}

	@deps/jemalloc/test/unit/mtx.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#NTHREADS
 2

	)

4 
	#NINCRS
 2000000

	)

6 
	$TEST_BEGIN
(
‹¡_mtx_basic
)

8 
mtx_t
 
mtx
;

10 
	`as£¹_çl£
(
	`mtx_š™
(&
mtx
), "Unexpected mtx_init() failure");

11 
	`mtx_lock
(&
mtx
);

12 
	`mtx_uÆock
(&
mtx
);

13 
	`mtx_fši
(&
mtx
);

14 
	}
}

15 
TEST_END


18 
mtx_t
 
	mmtx
;

19 
	mx
;

20 } 
	tthd_¡¬t_¬g_t
;

23 
	$thd_¡¬t
(*
v¬g
)

25 
thd_¡¬t_¬g_t
 *
¬g
 = (thd_¡¬t_¬g_ˆ*)
v¬g
;

26 
i
;

28 
i
 = 0; i < 
NINCRS
; i++) {

29 
	`mtx_lock
(&
¬g
->
mtx
);

30 
¬g
->
x
++;

31 
	`mtx_uÆock
(&
¬g
->
mtx
);

33  (
NULL
);

34 
	}
}

36 
	$TEST_BEGIN
(
‹¡_mtx_¿û
)

38 
thd_¡¬t_¬g_t
 
¬g
;

39 
thd_t
 
thds
[
NTHREADS
];

40 
i
;

42 
	`as£¹_çl£
(
	`mtx_š™
(&
¬g
.
mtx
), "Unexpected mtx_init() failure");

43 
¬g
.
x
 = 0;

44 
i
 = 0; i < 
NTHREADS
; i++)

45 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
, (*)&
¬g
);

46 
i
 = 0; i < 
NTHREADS
; i++)

47 
	`thd_još
(
thds
[
i
], 
NULL
);

48 
	`as£¹_u_eq
(
¬g
.
x
, 
NTHREADS
 * 
NINCRS
,

50 
	}
}

51 
TEST_END


54 
	$maš
()

57  (
	`‹¡
(

58 
‹¡_mtx_basic
,

59 
‹¡_mtx_¿û
));

60 
	}
}

	@deps/jemalloc/test/unit/prof_accum.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#NTHREADS
 4

	)

4 
	#NALLOCS_PER_THREAD
 50

	)

5 
	#DUMP_INTERVAL
 1

	)

6 
	#BT_COUNT_CHECK_INTERVAL
 5

	)

8 #ifdeà
JEMALLOC_PROF


9 cÚ¡ *
	gm®loc_cÚf
 =

14 
	$´of_dump_İ’_š‹rû±
(
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
)

16 
fd
;

18 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_WRONLY
);

19 
	`as£¹_d_Ã
(
fd
, -1, "Unexpected open() failure");

21  (
fd
);

22 
	}
}

25 
	$®loc_äom_³rmu‹d_backŒaû
(
thd_šd
, 
™”©iÚ
)

28  (
	`bÎoc
(1, 
thd_šd
*
NALLOCS_PER_THREAD
 + 
™”©iÚ
));

29 
	}
}

32 
	$thd_¡¬t
(*
v¬g
)

34 
thd_šd
 = *(*)
v¬g
;

35 
size_t
 
bt_couÁ_´ev
, 
bt_couÁ
;

36 
i_´ev
, 
i
;

38 
i_´ev
 = 0;

39 
bt_couÁ_´ev
 = 0;

40 
i
 = 0; i < 
NALLOCS_PER_THREAD
; i++) {

41 *
p
 = 
	`®loc_äom_³rmu‹d_backŒaû
(
thd_šd
, 
i
);

42 
	`d®locx
(
p
, 0);

43 ià(
i
 % 
DUMP_INTERVAL
 == 0) {

44 
	`as£¹_d_eq
(
	`m®lùl
("´of.dump", 
NULL
, NULL, NULL, 0),

48 ià(
i
 % 
BT_COUNT_CHECK_INTERVAL
 == 0 ||

49 
i
+1 =ğ
NALLOCS_PER_THREAD
) {

50 
bt_couÁ
 = 
	`´of_bt_couÁ
();

51 
	`as£¹_zu_Ë
(
bt_couÁ_´ev
+(
i
-
i_´ev
), 
bt_couÁ
,

53 
i_´ev
 = 
i
;

54 
bt_couÁ_´ev
 = 
bt_couÁ
;

58  (
NULL
);

59 
	}
}

61 
	$TEST_BEGIN
(
‹¡_idump
)

63 
boŞ
 
aùive
;

64 
thd_t
 
thds
[
NTHREADS
];

65 
thd_¬gs
[
NTHREADS
];

66 
i
;

68 
	`‹¡_sk_if
(!
cÚfig_´of
);

70 
aùive
 = 
Œue
;

71 
	`as£¹_d_eq
(
	`m®lùl
("´of.aùive", 
NULL
, NULL, &
aùive
, (active)),

74 
´of_dump_İ’
 = 
´of_dump_İ’_š‹rû±
;

76 
i
 = 0; i < 
NTHREADS
; i++) {

77 
thd_¬gs
[
i
] = i;

78 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
, (*)&
thd_¬gs
[i]);

80 
i
 = 0; i < 
NTHREADS
; i++)

81 
	`thd_još
(
thds
[
i
], 
NULL
);

82 
	}
}

83 
TEST_END


86 
	$maš
()

89  (
	`‹¡
(

90 
‹¡_idump
));

91 
	}
}

	@deps/jemalloc/test/unit/prof_active.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_PROF


4 cÚ¡ *
	gm®loc_cÚf
 =

9 
	$m®lùl_boŞ_g‘
(cÚ¡ *
Çme
, 
boŞ
 
ex³ùed
, cÚ¡ *
func
, 
lše
)

11 
boŞ
 
Şd
;

12 
size_t
 
sz
;

14 
sz
 = (
Şd
);

15 
	`as£¹_d_eq
(
	`m®lùl
(
Çme
, &
Şd
, &
sz
, 
NULL
, 0), 0,

16 "%s():%d: UÃx³ùed m®lùÈçu»„—dšg %s", 
func
, 
lše
, 
Çme
);

17 
	`as£¹_b_eq
(
Şd
, 
ex³ùed
, "%s():%d: UÃx³ùed % v®ue", 
func
, 
lše
,

18 
Çme
);

19 
	}
}

22 
	$m®lùl_boŞ_£t
(cÚ¡ *
Çme
, 
boŞ
 
Şd_ex³ùed
, boŞ 
v®_Ãw
,

23 cÚ¡ *
func
, 
lše
)

25 
boŞ
 
Şd
;

26 
size_t
 
sz
;

28 
sz
 = (
Şd
);

29 
	`as£¹_d_eq
(
	`m®lùl
(
Çme
, &
Şd
, &
sz
, &
v®_Ãw
, (val_new)), 0,

30 "%s():%d: UÃx³ùed m®lùÈçu»„—dšg/wr™šg %s", 
func
,

31 
lše
, 
Çme
);

32 
	`as£¹_b_eq
(
Şd
, 
Şd_ex³ùed
, "%s():%d: UÃx³ùed % v®ue", 
func
,

33 
lše
, 
Çme
);

34 
	}
}

37 
	$m®lùl_´of_aùive_g‘_im¶
(
boŞ
 
´of_aùive_Şd_ex³ùed
, cÚ¡ *
func
,

38 
lše
)

41 
	`m®lùl_boŞ_g‘
("´of.aùive", 
´of_aùive_Şd_ex³ùed
, 
func
, 
lše
);

42 
	}
}

43 
	#m®lùl_´of_aùive_g‘
(
a
) \

44 
	`m®lùl_´of_aùive_g‘_im¶
(
a
, 
__func__
, 
__LINE__
)

	)

47 
	$m®lùl_´of_aùive_£t_im¶
(
boŞ
 
´of_aùive_Şd_ex³ùed
,

48 
boŞ
 
´of_aùive_Ãw
, cÚ¡ *
func
, 
lše
)

51 
	`m®lùl_boŞ_£t
("´of.aùive", 
´of_aùive_Şd_ex³ùed
,

52 
´of_aùive_Ãw
, 
func
, 
lše
);

53 
	}
}

54 
	#m®lùl_´of_aùive_£t
(
a
, 
b
) \

55 
	`m®lùl_´of_aùive_£t_im¶
(
a
, 
b
, 
__func__
, 
__LINE__
)

	)

58 
	$m®lùl_th»ad_´of_aùive_g‘_im¶
(
boŞ
 
th»ad_´of_aùive_Şd_ex³ùed
,

59 cÚ¡ *
func
, 
lše
)

62 
	`m®lùl_boŞ_g‘
("th»ad.´of.aùive", 
th»ad_´of_aùive_Şd_ex³ùed
,

63 
func
, 
lše
);

64 
	}
}

65 
	#m®lùl_th»ad_´of_aùive_g‘
(
a
) \

66 
	`m®lùl_th»ad_´of_aùive_g‘_im¶
(
a
, 
__func__
, 
__LINE__
)

	)

69 
	$m®lùl_th»ad_´of_aùive_£t_im¶
(
boŞ
 
th»ad_´of_aùive_Şd_ex³ùed
,

70 
boŞ
 
th»ad_´of_aùive_Ãw
, cÚ¡ *
func
, 
lše
)

73 
	`m®lùl_boŞ_£t
("th»ad.´of.aùive", 
th»ad_´of_aùive_Şd_ex³ùed
,

74 
th»ad_´of_aùive_Ãw
, 
func
, 
lše
);

75 
	}
}

76 
	#m®lùl_th»ad_´of_aùive_£t
(
a
, 
b
) \

77 
	`m®lùl_th»ad_´of_aùive_£t_im¶
(
a
, 
b
, 
__func__
, 
__LINE__
)

	)

80 
	$´of_§m¶šg_´obe_im¶
(
boŞ
 
ex³ù_§m¶e
, cÚ¡ *
func
, 
lše
)

82 *
p
;

83 
size_t
 
ex³ùed_backŒaûs
 = 
ex³ù_§m¶e
 ? 1 : 0;

85 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 0, "%s():%d: Ex³ùed 0 backŒaûs", 
func
,

86 
lše
);

87 
p
 = 
	`m®locx
(1, 0);

88 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

89 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 
ex³ùed_backŒaûs
,

90 "%s():%d: UÃx³ùed backŒaû couÁ", 
func
, 
lše
);

91 
	`d®locx
(
p
, 0);

92 
	}
}

93 
	#´of_§m¶šg_´obe
(
a
) \

94 
	`´of_§m¶šg_´obe_im¶
(
a
, 
__func__
, 
__LINE__
)

	)

96 
	$TEST_BEGIN
(
‹¡_´of_aùive
)

99 
	`‹¡_sk_if
(!
cÚfig_´of
);

101 
	`m®lùl_´of_aùive_g‘
(
Œue
);

102 
	`m®lùl_th»ad_´of_aùive_g‘
(
çl£
);

104 
	`m®lùl_´of_aùive_£t
(
Œue
,rue);

105 
	`m®lùl_th»ad_´of_aùive_£t
(
çl£
, false);

107 
	`´of_§m¶šg_´obe
(
çl£
);

109 
	`m®lùl_´of_aùive_£t
(
Œue
, 
çl£
);

110 
	`m®lùl_th»ad_´of_aùive_£t
(
çl£
, false);

112 
	`´of_§m¶šg_´obe
(
çl£
);

114 
	`m®lùl_´of_aùive_£t
(
çl£
, false);

115 
	`m®lùl_th»ad_´of_aùive_£t
(
çl£
, 
Œue
);

117 
	`´of_§m¶šg_´obe
(
çl£
);

119 
	`m®lùl_´of_aùive_£t
(
çl£
, 
Œue
);

120 
	`m®lùl_th»ad_´of_aùive_£t
(
Œue
,rue);

122 
	`´of_§m¶šg_´obe
(
Œue
);

125 
	`m®lùl_´of_aùive_£t
(
Œue
,rue);

126 
	`m®lùl_th»ad_´of_aùive_£t
(
Œue
, 
çl£
);

127 
	}
}

128 
TEST_END


131 
	$maš
()

134  (
	`‹¡
(

135 
‹¡_´of_aùive
));

136 
	}
}

	@deps/jemalloc/test/unit/prof_gdump.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_PROF


4 cÚ¡ *
	gm®loc_cÚf
 = "prof:true,prof_active:false,prof_gdump:true";

7 
boŞ
 
	gdid_´of_dump_İ’
;

10 
	$´of_dump_İ’_š‹rû±
(
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
)

12 
fd
;

14 
did_´of_dump_İ’
 = 
Œue
;

16 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_WRONLY
);

17 
	`as£¹_d_Ã
(
fd
, -1, "Unexpected open() failure");

19  (
fd
);

20 
	}
}

22 
	$TEST_BEGIN
(
‹¡_gdump
)

24 
boŞ
 
aùive
, 
gdump
, 
gdump_Şd
;

25 *
p
, *
q
, *
r
, *
s
;

26 
size_t
 
sz
;

28 
	`‹¡_sk_if
(!
cÚfig_´of
);

30 
aùive
 = 
Œue
;

31 
	`as£¹_d_eq
(
	`m®lùl
("´of.aùive", 
NULL
, NULL, &
aùive
, (active)),

34 
´of_dump_İ’
 = 
´of_dump_İ’_š‹rû±
;

36 
did_´of_dump_İ’
 = 
çl£
;

37 
p
 = 
	`m®locx
(
chunksize
, 0);

38 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

39 
	`as£¹_Œue
(
did_´of_dump_İ’
, "Expected‡…rofile dump");

41 
did_´of_dump_İ’
 = 
çl£
;

42 
q
 = 
	`m®locx
(
chunksize
, 0);

43 
	`as£¹_±r_nÙ_nuÎ
(
q
, "Unexpected mallocx() failure");

44 
	`as£¹_Œue
(
did_´of_dump_İ’
, "Expected‡…rofile dump");

46 
gdump
 = 
çl£
;

47 
sz
 = (
gdump_Şd
);

48 
	`as£¹_d_eq
(
	`m®lùl
("´of.gdump", &
gdump_Şd
, &
sz
, &
gdump
,

49 (
gdump
)), 0,

51 
	`as£¹
(
gdump_Şd
);

52 
did_´of_dump_İ’
 = 
çl£
;

53 
r
 = 
	`m®locx
(
chunksize
, 0);

54 
	`as£¹_±r_nÙ_nuÎ
(
q
, "Unexpected mallocx() failure");

55 
	`as£¹_çl£
(
did_´of_dump_İ’
, "Unexpected…rofile dump");

57 
gdump
 = 
Œue
;

58 
sz
 = (
gdump_Şd
);

59 
	`as£¹_d_eq
(
	`m®lùl
("´of.gdump", &
gdump_Şd
, &
sz
, &
gdump
,

60 (
gdump
)), 0,

62 
	`as£¹
(!
gdump_Şd
);

63 
did_´of_dump_İ’
 = 
çl£
;

64 
s
 = 
	`m®locx
(
chunksize
, 0);

65 
	`as£¹_±r_nÙ_nuÎ
(
q
, "Unexpected mallocx() failure");

66 
	`as£¹_Œue
(
did_´of_dump_İ’
, "Expected‡…rofile dump");

68 
	`d®locx
(
p
, 0);

69 
	`d®locx
(
q
, 0);

70 
	`d®locx
(
r
, 0);

71 
	`d®locx
(
s
, 0);

72 
	}
}

73 
TEST_END


76 
	$maš
()

79  (
	`‹¡
(

80 
‹¡_gdump
));

81 
	}
}

	@deps/jemalloc/test/unit/prof_idump.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_PROF


4 cÚ¡ *
	gm®loc_cÚf
 =

9 
boŞ
 
	gdid_´of_dump_İ’
;

12 
	$´of_dump_İ’_š‹rû±
(
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
)

14 
fd
;

16 
did_´of_dump_İ’
 = 
Œue
;

18 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_WRONLY
);

19 
	`as£¹_d_Ã
(
fd
, -1, "Unexpected open() failure");

21  (
fd
);

22 
	}
}

24 
	$TEST_BEGIN
(
‹¡_idump
)

26 
boŞ
 
aùive
;

27 *
p
;

29 
	`‹¡_sk_if
(!
cÚfig_´of
);

31 
aùive
 = 
Œue
;

32 
	`as£¹_d_eq
(
	`m®lùl
("´of.aùive", 
NULL
, NULL, &
aùive
, (active)),

35 
´of_dump_İ’
 = 
´of_dump_İ’_š‹rû±
;

37 
did_´of_dump_İ’
 = 
çl£
;

38 
p
 = 
	`m®locx
(1, 0);

39 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

40 
	`d®locx
(
p
, 0);

41 
	`as£¹_Œue
(
did_´of_dump_İ’
, "Expected‡…rofile dump");

42 
	}
}

43 
TEST_END


46 
	$maš
()

49  (
	`‹¡
(

50 
‹¡_idump
));

51 
	}
}

	@deps/jemalloc/test/unit/prof_reset.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_PROF


4 cÚ¡ *
	gm®loc_cÚf
 =

9 
	$´of_dump_İ’_š‹rû±
(
boŞ
 
´İag©e_”r
, cÚ¡ *
f’ame
)

11 
fd
;

13 
fd
 = 
	`İ’
("/dev/nuÎ", 
O_WRONLY
);

14 
	`as£¹_d_Ã
(
fd
, -1, "Unexpected open() failure");

16  (
fd
);

17 
	}
}

20 
	$£t_´of_aùive
(
boŞ
 
aùive
)

23 
	`as£¹_d_eq
(
	`m®lùl
("´of.aùive", 
NULL
, NULL, &
aùive
, (active)),

25 
	}
}

27 
size_t


28 
	$g‘_lg_´of_§m¶e
()

30 
size_t
 
lg_´of_§m¶e
;

31 
size_t
 
sz
 = (size_t);

33 
	`as£¹_d_eq
(
	`m®lùl
("´of.lg_§m¶e", &
lg_´of_§m¶e
, &
sz
, 
NULL
, 0), 0,

35  (
lg_´of_§m¶e
);

36 
	}
}

39 
	$do_´of_»£t
(
size_t
 
lg_´of_§m¶e
)

41 
	`as£¹_d_eq
(
	`m®lùl
("´of.»£t", 
NULL
, NULL,

42 &
lg_´of_§m¶e
, (
size_t
)), 0,

44 
	`as£¹_zu_eq
(
lg_´of_§m¶e
, 
	`g‘_lg_´of_§m¶e
(),

46 
	}
}

48 
	$TEST_BEGIN
(
‹¡_´of_»£t_basic
)

50 
size_t
 
lg_´of_§m¶e_Üig
, 
lg_´of_§m¶e
, 
lg_´of_§m¶e_Ãxt
;

51 
size_t
 
sz
;

52 
i
;

54 
	`‹¡_sk_if
(!
cÚfig_´of
);

56 
sz
 = (
size_t
);

57 
	`as£¹_d_eq
(
	`m®lùl
("İt.lg_´of_§m¶e", &
lg_´of_§m¶e_Üig
, &
sz
,

58 
NULL
, 0), 0,

60 
	`as£¹_zu_eq
(
lg_´of_§m¶e_Üig
, 0,

62 
lg_´of_§m¶e
 = 
	`g‘_lg_´of_§m¶e
();

63 
	`as£¹_zu_eq
(
lg_´of_§m¶e_Üig
, 
lg_´of_§m¶e
,

68 
i
 = 0; i < 2; i++) {

69 
	`as£¹_d_eq
(
	`m®lùl
("´of.»£t", 
NULL
, NULL, NULL, 0), 0,

71 
lg_´of_§m¶e
 = 
	`g‘_lg_´of_§m¶e
();

72 
	`as£¹_zu_eq
(
lg_´of_§m¶e_Üig
, 
lg_´of_§m¶e
,

77 
lg_´of_§m¶e_Ãxt
 = 1;

78 
i
 = 0; i < 2; i++) {

79 
	`do_´of_»£t
(
lg_´of_§m¶e_Ãxt
);

80 
lg_´of_§m¶e
 = 
	`g‘_lg_´of_§m¶e
();

81 
	`as£¹_zu_eq
(
lg_´of_§m¶e
, 
lg_´of_§m¶e_Ãxt
,

83 
lg_´of_§m¶e_Ãxt
 = 
lg_´of_§m¶e_Üig
;

87 
lg_´of_§m¶e
 = 
	`g‘_lg_´of_§m¶e
();

88 
	`as£¹_zu_eq
(
lg_´of_§m¶e_Üig
, 
lg_´of_§m¶e
,

91 
	}
}

92 
TEST_END


94 
boŞ
 
	g´of_dump_h—d”_š‹rû±ed
 = 
çl£
;

95 
´of_út_t
 
	gút_®l_cİy
 = {0, 0, 0, 0};

96 
boŞ


97 
	$´of_dump_h—d”_š‹rû±
(
boŞ
 
´İag©e_”r
, cÚ¡ 
´of_út_t
 *
út_®l
)

100 
´of_dump_h—d”_š‹rû±ed
 = 
Œue
;

101 
	`memıy
(&
út_®l_cİy
, 
út_®l
, (
´of_út_t
));

103  (
çl£
);

104 
	}
}

106 
	$TEST_BEGIN
(
‹¡_´of_»£t_ş—nup
)

108 *
p
;

109 
´of_dump_h—d”_t
 *
´of_dump_h—d”_Üig
;

111 
	`‹¡_sk_if
(!
cÚfig_´of
);

113 
	`£t_´of_aùive
(
Œue
);

115 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 0, "Expected 0 backtraces");

116 
p
 = 
	`m®locx
(1, 0);

117 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

118 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 1, "Expected 1 backtrace");

120 
´of_dump_h—d”_Üig
 = 
´of_dump_h—d”
;

121 
´of_dump_h—d”
 = 
´of_dump_h—d”_š‹rû±
;

122 
	`as£¹_çl£
(
´of_dump_h—d”_š‹rû±ed
, "Unexpected intercept");

124 
	`as£¹_d_eq
(
	`m®lùl
("´of.dump", 
NULL
, NULL, NULL, 0),

126 
	`as£¹_Œue
(
´of_dump_h—d”_š‹rû±ed
, "Expected intercept");

127 
	`as£¹_u64_eq
(
út_®l_cİy
.
curobjs
, 1, "Expected 1‡llocation");

129 
	`as£¹_d_eq
(
	`m®lùl
("´of.»£t", 
NULL
, NULL, NULL, 0), 0,

131 
	`as£¹_d_eq
(
	`m®lùl
("´of.dump", 
NULL
, NULL, NULL, 0),

133 
	`as£¹_u64_eq
(
út_®l_cİy
.
curobjs
, 0, "Expected 0‡llocations");

134 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 1, "Expected 1 backtrace");

136 
´of_dump_h—d”
 = 
´of_dump_h—d”_Üig
;

138 
	`d®locx
(
p
, 0);

139 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 0, "Expected 0 backtraces");

141 
	`£t_´of_aùive
(
çl£
);

142 
	}
}

143 
	gTEST_END


145 
	#NTHREADS
 4

	)

146 
	#NALLOCS_PER_THREAD
 (1U << 13)

	)

147 
	#OBJ_RING_BUF_COUNT
 1531

	)

148 
	#RESET_INTERVAL
 (1U << 10)

	)

149 
	#DUMP_INTERVAL
 3677

	)

151 
	$thd_¡¬t
(*
v¬g
)

153 
thd_šd
 = *(*)
v¬g
;

154 
i
;

155 *
objs
[
OBJ_RING_BUF_COUNT
];

157 
	`mem£t
(
objs
, 0, (objs));

159 
i
 = 0; i < 
NALLOCS_PER_THREAD
; i++) {

160 ià(
i
 % 
RESET_INTERVAL
 == 0) {

161 
	`as£¹_d_eq
(
	`m®lùl
("´of.»£t", 
NULL
, NULL, NULL, 0),

166 ià(
i
 % 
DUMP_INTERVAL
 == 0) {

167 
	`as£¹_d_eq
(
	`m®lùl
("´of.dump", 
NULL
, NULL, NULL, 0),

172 **
µ
 = &
objs
[
i
 % 
OBJ_RING_BUF_COUNT
];

173 ià(*
µ
 !ğ
NULL
) {

174 
	`d®locx
(*
µ
, 0);

175 *
µ
 = 
NULL
;

177 *
µ
 = 
	`bÎoc
(1, 
thd_šd
*
NALLOCS_PER_THREAD
 + 
i
);

178 
	`as£¹_±r_nÙ_nuÎ
(*
µ
,

184 
i
 = 0; i < 
OBJ_RING_BUF_COUNT
; i++) {

185 **
µ
 = &
objs
[
i
 % 
OBJ_RING_BUF_COUNT
];

186 ià(*
µ
 !ğ
NULL
) {

187 
	`d®locx
(*
µ
, 0);

188 *
µ
 = 
NULL
;

192  (
NULL
);

193 
	}
}

195 
	$TEST_BEGIN
(
‹¡_´of_»£t
)

197 
size_t
 
lg_´of_§m¶e_Üig
;

198 
thd_t
 
thds
[
NTHREADS
];

199 
thd_¬gs
[
NTHREADS
];

200 
i
;

201 
size_t
 
bt_couÁ
, 
td©a_couÁ
;

203 
	`‹¡_sk_if
(!
cÚfig_´of
);

205 
bt_couÁ
 = 
	`´of_bt_couÁ
();

206 
	`as£¹_zu_eq
(
bt_couÁ
, 0,

208 
td©a_couÁ
 = 
	`´of_td©a_couÁ
();

210 
lg_´of_§m¶e_Üig
 = 
	`g‘_lg_´of_§m¶e
();

211 
	`do_´of_»£t
(5);

213 
	`£t_´of_aùive
(
Œue
);

215 
i
 = 0; i < 
NTHREADS
; i++) {

216 
thd_¬gs
[
i
] = i;

217 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
, (*)&
thd_¬gs
[i]);

219 
i
 = 0; i < 
NTHREADS
; i++)

220 
	`thd_još
(
thds
[
i
], 
NULL
);

222 
	`as£¹_zu_eq
(
	`´of_bt_couÁ
(), 
bt_couÁ
,

224 
	`as£¹_zu_eq
(
	`´of_td©a_couÁ
(), 
td©a_couÁ
,

227 
	`£t_´of_aùive
(
çl£
);

229 
	`do_´of_»£t
(
lg_´of_§m¶e_Üig
);

230 
	}
}

231 
	gTEST_END


232 #undeà
NTHREADS


233 #undeà
NALLOCS_PER_THREAD


234 #undeà
OBJ_RING_BUF_COUNT


235 #undeà
RESET_INTERVAL


236 #undeà
DUMP_INTERVAL


239 
	#NITER
 10

	)

240 
	$TEST_BEGIN
(
‹¡_x®locx
)

242 
size_t
 
lg_´of_§m¶e_Üig
;

243 
i
;

244 *
±rs
[
NITER
];

246 
	`‹¡_sk_if
(!
cÚfig_´of
);

248 
lg_´of_§m¶e_Üig
 = 
	`g‘_lg_´of_§m¶e
();

249 
	`£t_´of_aùive
(
Œue
);

252 
	`do_´of_»£t
(0);

254 
i
 = 0; i < 
NITER
; i++) {

255 *
p
;

256 
size_t
 
sz
, 
nsz
;

259 
	`do_´of_»£t
(0);

262 
p
 = 
±rs
[
i
] = 
	`m®locx
(1, 0);

263 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

266 
	`do_´of_»£t
(0);

269 
sz
 = 
	`§Îocx
(
p
, 0);

270 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
sz
, 0, 0), sz,

274 
nsz
 = 
	`ÇÎocx
(
sz
+1, 0);

275 
	`as£¹_zu_eq
(
	`x®locx
(
p
, 
nsz
, 0, 0), 
sz
,

279 
i
 = 0; i < 
NITER
; i++) {

281 
	`d®locx
(
±rs
[
i
], 0);

284 
	`£t_´of_aùive
(
çl£
);

285 
	`do_´of_»£t
(
lg_´of_§m¶e_Üig
);

286 
	}
}

287 
	gTEST_END


288 #undeà
NITER


291 
	$maš
()

295 
´of_dump_İ’
 = 
´of_dump_İ’_š‹rû±
;

297  (
	`‹¡
(

298 
‹¡_´of_»£t_basic
,

299 
‹¡_´of_»£t_ş—nup
,

300 
‹¡_´of_»£t
,

301 
‹¡_x®locx
));

302 
	}
}

	@deps/jemalloc/test/unit/prof_thread_name.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_PROF


4 cÚ¡ *
	gm®loc_cÚf
 = "prof:true,prof_active:false";

8 
	$m®lùl_th»ad_Çme_g‘_im¶
(cÚ¡ *
th»ad_Çme_ex³ùed
, cÚ¡ *
func
,

9 
lše
)

11 cÚ¡ *
th»ad_Çme_Şd
;

12 
size_t
 
sz
;

14 
sz
 = (
th»ad_Çme_Şd
);

15 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.´of.Çme", &
th»ad_Çme_Şd
, &
sz
, 
NULL
, 0),

17 
func
, 
lše
);

18 
	`as£¹_¡r_eq
(
th»ad_Çme_Şd
, 
th»ad_Çme_ex³ùed
,

19 "%s():%d: UÃx³ùedh»ad.´of.Çmv®ue", 
func
, 
lše
);

20 
	}
}

21 
	#m®lùl_th»ad_Çme_g‘
(
a
) \

22 
	`m®lùl_th»ad_Çme_g‘_im¶
(
a
, 
__func__
, 
__LINE__
)

	)

25 
	$m®lùl_th»ad_Çme_£t_im¶
(cÚ¡ *
th»ad_Çme
, cÚ¡ *
func
,

26 
lše
)

29 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.´of.Çme", 
NULL
, NULL, &
th»ad_Çme
,

30 (
th»ad_Çme
)), 0,

32 
func
, 
lše
);

33 
	`m®lùl_th»ad_Çme_g‘_im¶
(
th»ad_Çme
, 
func
, 
lše
);

34 
	}
}

35 
	#m®lùl_th»ad_Çme_£t
(
a
) \

36 
	`m®lùl_th»ad_Çme_£t_im¶
(
a
, 
__func__
, 
__LINE__
)

	)

38 
	$TEST_BEGIN
(
‹¡_´of_th»ad_Çme_v®id©iÚ
)

40 cÚ¡ *
th»ad_Çme
;

42 
	`‹¡_sk_if
(!
cÚfig_´of
);

44 
	`m®lùl_th»ad_Çme_g‘
("");

45 
	`m®lùl_th»ad_Çme_£t
("hihere");

48 
th»ad_Çme
 = 
NULL
;

49 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.´of.Çme", 
NULL
, NULL, &
th»ad_Çme
,

50 (
th»ad_Çme
)), 
EFAULT
,

52 
th»ad_Çme
);

55 
th»ad_Çme
 = "hi\nthere";

56 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.´of.Çme", 
NULL
, NULL, &
th»ad_Çme
,

57 (
th»ad_Çme
)), 
EFAULT
,

59 
th»ad_Çme
);

63 cÚ¡ *
th»ad_Çme_Şd
;

64 
size_t
 
sz
;

66 
sz
 = (
th»ad_Çme_Şd
);

67 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.´of.Çme", &
th»ad_Çme_Şd
, &
sz
,

68 &
th»ad_Çme
, Ñh»ad_Çme)), 
EPERM
,

70 "th»ad.´of.Çme", 
th»ad_Çme
);

73 
	`m®lùl_th»ad_Çme_£t
("");

74 
	}
}

75 
	gTEST_END


77 
	#NTHREADS
 4

	)

78 
	#NRESET
 25

	)

80 
	$thd_¡¬t
(*
v¬g
)

82 
thd_šd
 = *(*)
v¬g
;

83 
th»ad_Çme
[16] = "";

84 
i
;

86 
	`m®loc_¢´štf
(
th»ad_Çme
, Ñh»ad_Çme), "th»ad %u", 
thd_šd
);

88 
	`m®lùl_th»ad_Çme_g‘
("");

89 
	`m®lùl_th»ad_Çme_£t
(
th»ad_Çme
);

91 
i
 = 0; i < 
NRESET
; i++) {

92 
	`as£¹_d_eq
(
	`m®lùl
("´of.»£t", 
NULL
, NULL, NULL, 0), 0,

94 
	`m®lùl_th»ad_Çme_g‘
(
th»ad_Çme
);

97 
	`m®lùl_th»ad_Çme_£t
(
th»ad_Çme
);

98 
	`m®lùl_th»ad_Çme_£t
("");

100  (
NULL
);

101 
	}
}

103 
	$TEST_BEGIN
(
‹¡_´of_th»ad_Çme_th»aded
)

105 
thd_t
 
thds
[
NTHREADS
];

106 
thd_¬gs
[
NTHREADS
];

107 
i
;

109 
	`‹¡_sk_if
(!
cÚfig_´of
);

111 
i
 = 0; i < 
NTHREADS
; i++) {

112 
thd_¬gs
[
i
] = i;

113 
	`thd_ü—‹
(&
thds
[
i
], 
thd_¡¬t
, (*)&
thd_¬gs
[i]);

115 
i
 = 0; i < 
NTHREADS
; i++)

116 
	`thd_još
(
thds
[
i
], 
NULL
);

117 
	}
}

118 
	gTEST_END


119 #undeà
NTHREADS


120 #undeà
NRESET


123 
	$maš
()

126  (
	`‹¡
(

127 
‹¡_´of_th»ad_Çme_v®id©iÚ
,

128 
‹¡_´of_th»ad_Çme_th»aded
));

129 
	}
}

	@deps/jemalloc/test/unit/ql.c

1 
	~"‹¡/jem®loc_‹¡.h
"

4 
	#NENTRIES
 9

	)

6 
li¡_s
 
	tli¡_t
;

7 
	$ql_h—d
(
	tli¡_t
è
	tli¡_h—d_t
;

9 
	sli¡_s
 {

10 
	`ql_–m
(
li¡_t
è
lšk
;

11 
id
;

15 
	$‹¡_em±y_li¡
(
li¡_h—d_t
 *
h—d
)

17 
li¡_t
 *
t
;

18 
i
;

20 
	`as£¹_±r_nuÎ
(
	`ql_fœ¡
(
h—d
), "Unexpectedƒlement forƒmpty†ist");

21 
	`as£¹_±r_nuÎ
(
	`ql_Ï¡
(
h—d
, 
lšk
),

24 
i
 = 0;

25 
	`ql_fÜ—ch
(
t
, 
h—d
, 
lšk
) {

26 
i
++;

28 
	`as£¹_u_eq
(
i
, 0, "Unexpectedƒlement forƒmpty†ist");

30 
i
 = 0;

31 
	`ql_»v”£_fÜ—ch
(
t
, 
h—d
, 
lšk
) {

32 
i
++;

34 
	`as£¹_u_eq
(
i
, 0, "Unexpectedƒlement forƒmpty†ist");

35 
	}
}

37 
	$TEST_BEGIN
(
‹¡_ql_em±y
)

39 
li¡_h—d_t
 
h—d
;

41 
	`ql_Ãw
(&
h—d
);

42 
	`‹¡_em±y_li¡
(&
h—d
);

43 
	}
}

44 
TEST_END


47 
	$š™_’Œ›s
(
li¡_t
 *
’Œ›s
, 
ÃÁr›s
)

49 
i
;

51 
i
 = 0; i < 
ÃÁr›s
; i++) {

52 
’Œ›s
[
i
].
id
 = 'a' + i;

53 
	`ql_–m_Ãw
(&
’Œ›s
[
i
], 
lšk
);

55 
	}
}

58 
	$‹¡_’Œ›s_li¡
(
li¡_h—d_t
 *
h—d
, 
li¡_t
 *
’Œ›s
, 
ÃÁr›s
)

60 
li¡_t
 *
t
;

61 
i
;

63 
	`as£¹_c_eq
(
	`ql_fœ¡
(
h—d
)->
id
, 
’Œ›s
[0].id, "Element id mismatch");

64 
	`as£¹_c_eq
(
	`ql_Ï¡
(
h—d
, 
lšk
)->
id
, 
’Œ›s
[
ÃÁr›s
-1].id,

67 
i
 = 0;

68 
	`ql_fÜ—ch
(
t
, 
h—d
, 
lšk
) {

69 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
i
].id, "Element id mismatch");

70 
i
++;

73 
i
 = 0;

74 
	`ql_»v”£_fÜ—ch
(
t
, 
h—d
, 
lšk
) {

75 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
ÃÁr›s
-
i
-1].id,

77 
i
++;

80 
i
 = 0; i < 
ÃÁr›s
-1; i++) {

81 
t
 = 
	`ql_Ãxt
(
h—d
, &
’Œ›s
[
i
], 
lšk
);

82 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
i
+1].id, "Element id mismatch");

84 
	`as£¹_±r_nuÎ
(
	`ql_Ãxt
(
h—d
, &
’Œ›s
[
ÃÁr›s
-1], 
lšk
),

87 
	`as£¹_±r_nuÎ
(
	`ql_´ev
(
h—d
, &
’Œ›s
[0], 
lšk
), "Unexpectedƒlement");

88 
i
 = 1; i < 
ÃÁr›s
; i++) {

89 
t
 = 
	`ql_´ev
(
h—d
, &
’Œ›s
[
i
], 
lšk
);

90 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
i
-1].id, "Element id mismatch");

92 
	}
}

94 
	$TEST_BEGIN
(
‹¡_ql__š£¹
)

96 
li¡_h—d_t
 
h—d
;

97 
li¡_t
 
’Œ›s
[
NENTRIES
];

98 
i
;

100 
	`ql_Ãw
(&
h—d
);

101 
	`š™_’Œ›s
(
’Œ›s
, ÓÁr›s)/(
li¡_t
));

102 
i
 = 0; i < 
NENTRIES
; i++)

103 
	`ql__š£¹
(&
h—d
, &
’Œ›s
[
i
], 
lšk
);

105 
	`‹¡_’Œ›s_li¡
(&
h—d
, 
’Œ›s
, 
NENTRIES
);

106 
	}
}

107 
TEST_END


109 
	$TEST_BEGIN
(
‹¡_ql__»move
)

111 
li¡_h—d_t
 
h—d
;

112 
li¡_t
 
’Œ›s
[
NENTRIES
];

113 
i
;

115 
	`ql_Ãw
(&
h—d
);

116 
	`š™_’Œ›s
(
’Œ›s
, ÓÁr›s)/(
li¡_t
));

117 
i
 = 0; i < 
NENTRIES
; i++)

118 
	`ql__š£¹
(&
h—d
, &
’Œ›s
[
i
], 
lšk
);

120 
i
 = 0; i < 
NENTRIES
; i++) {

121 
	`‹¡_’Œ›s_li¡
(&
h—d
, 
’Œ›s
, 
NENTRIES
-
i
);

122 
	`ql__»move
(&
h—d
, 
li¡_t
, 
lšk
);

124 
	`‹¡_em±y_li¡
(&
h—d
);

125 
	}
}

126 
TEST_END


128 
	$TEST_BEGIN
(
‹¡_ql_h—d_š£¹
)

130 
li¡_h—d_t
 
h—d
;

131 
li¡_t
 
’Œ›s
[
NENTRIES
];

132 
i
;

134 
	`ql_Ãw
(&
h—d
);

135 
	`š™_’Œ›s
(
’Œ›s
, ÓÁr›s)/(
li¡_t
));

136 
i
 = 0; i < 
NENTRIES
; i++)

137 
	`ql_h—d_š£¹
(&
h—d
, &
’Œ›s
[
NENTRIES
-
i
-1], 
lšk
);

139 
	`‹¡_’Œ›s_li¡
(&
h—d
, 
’Œ›s
, 
NENTRIES
);

140 
	}
}

141 
TEST_END


143 
	$TEST_BEGIN
(
‹¡_ql_h—d_»move
)

145 
li¡_h—d_t
 
h—d
;

146 
li¡_t
 
’Œ›s
[
NENTRIES
];

147 
i
;

149 
	`ql_Ãw
(&
h—d
);

150 
	`š™_’Œ›s
(
’Œ›s
, ÓÁr›s)/(
li¡_t
));

151 
i
 = 0; i < 
NENTRIES
; i++)

152 
	`ql_h—d_š£¹
(&
h—d
, &
’Œ›s
[
NENTRIES
-
i
-1], 
lšk
);

154 
i
 = 0; i < 
NENTRIES
; i++) {

155 
	`‹¡_’Œ›s_li¡
(&
h—d
, &
’Œ›s
[
i
], 
NENTRIES
-i);

156 
	`ql_h—d_»move
(&
h—d
, 
li¡_t
, 
lšk
);

158 
	`‹¡_em±y_li¡
(&
h—d
);

159 
	}
}

160 
TEST_END


162 
	$TEST_BEGIN
(
‹¡_ql_š£¹
)

164 
li¡_h—d_t
 
h—d
;

165 
li¡_t
 
’Œ›s
[8];

166 
li¡_t
 *
a
, *
b
, *
c
, *
d
, *
e
, *
f
, *
g
, *
h
;

168 
	`ql_Ãw
(&
h—d
);

169 
	`š™_’Œ›s
(
’Œ›s
, ÓÁr›s)/(
li¡_t
));

170 
a
 = &
’Œ›s
[0];

171 
b
 = &
’Œ›s
[1];

172 
c
 = &
’Œ›s
[2];

173 
d
 = &
’Œ›s
[3];

174 
e
 = &
’Œ›s
[4];

175 
f
 = &
’Œ›s
[5];

176 
g
 = &
’Œ›s
[6];

177 
h
 = &
’Œ›s
[7];

185 
	`ql__š£¹
(&
h—d
, 
f
, 
lšk
);

186 
	`ql_befÜe_š£¹
(&
h—d
, 
f
, 
b
, 
lšk
);

187 
	`ql_befÜe_š£¹
(&
h—d
, 
f
, 
c
, 
lšk
);

188 
	`ql_aá”_š£¹
(
f
, 
h
, 
lšk
);

189 
	`ql_aá”_š£¹
(
f
, 
g
, 
lšk
);

190 
	`ql_befÜe_š£¹
(&
h—d
, 
b
, 
a
, 
lšk
);

191 
	`ql_aá”_š£¹
(
c
, 
d
, 
lšk
);

192 
	`ql_befÜe_š£¹
(&
h—d
, 
f
, 
e
, 
lšk
);

194 
	`‹¡_’Œ›s_li¡
(&
h—d
, 
’Œ›s
, ÓÁr›s)/(
li¡_t
));

195 
	}
}

196 
TEST_END


199 
	$maš
()

202  (
	`‹¡
(

203 
‹¡_ql_em±y
,

204 
‹¡_ql__š£¹
,

205 
‹¡_ql__»move
,

206 
‹¡_ql_h—d_š£¹
,

207 
‹¡_ql_h—d_»move
,

208 
‹¡_ql_š£¹
));

209 
	}
}

	@deps/jemalloc/test/unit/qr.c

1 
	~"‹¡/jem®loc_‹¡.h
"

4 
	#NENTRIES
 9

	)

6 
	#SPLIT_INDEX
 5

	)

8 
ršg_s
 
	tršg_t
;

10 
	sršg_s
 {

11 
qr
(
ršg_t
è
	mlšk
;

12 
	mid
;

16 
	$š™_’Œ›s
(
ršg_t
 *
’Œ›s
)

18 
i
;

20 
i
 = 0; i < 
NENTRIES
; i++) {

21 
	`qr_Ãw
(&
’Œ›s
[
i
], 
lšk
);

22 
’Œ›s
[
i
].
id
 = 'a' + i;

24 
	}
}

27 
	$‹¡_šd•’d’t_’Œ›s
(
ršg_t
 *
’Œ›s
)

29 
ršg_t
 *
t
;

30 
i
, 
j
;

32 
i
 = 0; i < 
NENTRIES
; i++) {

33 
j
 = 0;

34 
	`qr_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

35 
j
++;

37 
	`as£¹_u_eq
(
j
, 1,

41 
i
 = 0; i < 
NENTRIES
; i++) {

42 
j
 = 0;

43 
	`qr_»v”£_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

44 
j
++;

46 
	`as£¹_u_eq
(
j
, 1,

50 
i
 = 0; i < 
NENTRIES
; i++) {

51 
t
 = 
	`qr_Ãxt
(&
’Œ›s
[
i
], 
lšk
);

52 
	`as£¹_±r_eq
(
t
, &
’Œ›s
[
i
],

56 
i
 = 0; i < 
NENTRIES
; i++) {

57 
t
 = 
	`qr_´ev
(&
’Œ›s
[
i
], 
lšk
);

58 
	`as£¹_±r_eq
(
t
, &
’Œ›s
[
i
],

62 
	}
}

64 
	$TEST_BEGIN
(
‹¡_qr_Úe
)

66 
ršg_t
 
’Œ›s
[
NENTRIES
];

68 
	`š™_’Œ›s
(
’Œ›s
);

69 
	`‹¡_šd•’d’t_’Œ›s
(
’Œ›s
);

70 
	}
}

71 
TEST_END


74 
	$‹¡_’Œ›s_ršg
(
ršg_t
 *
’Œ›s
)

76 
ršg_t
 *
t
;

77 
i
, 
j
;

79 
i
 = 0; i < 
NENTRIES
; i++) {

80 
j
 = 0;

81 
	`qr_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

82 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
i
+
j
è% 
NENTRIES
].id,

84 
j
++;

87 
i
 = 0; i < 
NENTRIES
; i++) {

88 
j
 = 0;

89 
	`qr_»v”£_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

90 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
NENTRIES
+
i
-
j
-1) %

91 
NENTRIES
].
id
, "Element id mismatch");

92 
j
++;

95 
i
 = 0; i < 
NENTRIES
; i++) {

96 
t
 = 
	`qr_Ãxt
(&
’Œ›s
[
i
], 
lšk
);

97 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
i
+1è% 
NENTRIES
].id,

100 
i
 = 0; i < 
NENTRIES
; i++) {

101 
t
 = 
	`qr_´ev
(&
’Œ›s
[
i
], 
lšk
);

102 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
NENTRIES
+
i
-1) % NENTRIES].id,

105 
	}
}

107 
	$TEST_BEGIN
(
‹¡_qr_aá”_š£¹
)

109 
ršg_t
 
’Œ›s
[
NENTRIES
];

110 
i
;

112 
	`š™_’Œ›s
(
’Œ›s
);

113 
i
 = 1; i < 
NENTRIES
; i++)

114 
	`qr_aá”_š£¹
(&
’Œ›s
[
i
 - 1], &’Œ›s[i], 
lšk
);

115 
	`‹¡_’Œ›s_ršg
(
’Œ›s
);

116 
	}
}

117 
TEST_END


119 
	$TEST_BEGIN
(
‹¡_qr_»move
)

121 
ršg_t
 
’Œ›s
[
NENTRIES
];

122 
ršg_t
 *
t
;

123 
i
, 
j
;

125 
	`š™_’Œ›s
(
’Œ›s
);

126 
i
 = 1; i < 
NENTRIES
; i++)

127 
	`qr_aá”_š£¹
(&
’Œ›s
[
i
 - 1], &’Œ›s[i], 
lšk
);

129 
i
 = 0; i < 
NENTRIES
; i++) {

130 
j
 = 0;

131 
	`qr_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

132 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
i
+
j
].id,

134 
j
++;

136 
j
 = 0;

137 
	`qr_»v”£_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

138 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[
NENTRIES
 - 1 - 
j
].id,

140 
j
++;

142 
	`qr_»move
(&
’Œ›s
[
i
], 
lšk
);

144 
	`‹¡_šd•’d’t_’Œ›s
(
’Œ›s
);

145 
	}
}

146 
TEST_END


148 
	$TEST_BEGIN
(
‹¡_qr_befÜe_š£¹
)

150 
ršg_t
 
’Œ›s
[
NENTRIES
];

151 
ršg_t
 *
t
;

152 
i
, 
j
;

154 
	`š™_’Œ›s
(
’Œ›s
);

155 
i
 = 1; i < 
NENTRIES
; i++)

156 
	`qr_befÜe_š£¹
(&
’Œ›s
[
i
 - 1], &’Œ›s[i], 
lšk
);

157 
i
 = 0; i < 
NENTRIES
; i++) {

158 
j
 = 0;

159 
	`qr_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

160 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
NENTRIES
+
i
-
j
) %

161 
NENTRIES
].
id
, "Element id mismatch");

162 
j
++;

165 
i
 = 0; i < 
NENTRIES
; i++) {

166 
j
 = 0;

167 
	`qr_»v”£_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

168 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
i
+
j
+1è% 
NENTRIES
].id,

170 
j
++;

173 
i
 = 0; i < 
NENTRIES
; i++) {

174 
t
 = 
	`qr_Ãxt
(&
’Œ›s
[
i
], 
lšk
);

175 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
NENTRIES
+
i
-1) % NENTRIES].id,

178 
i
 = 0; i < 
NENTRIES
; i++) {

179 
t
 = 
	`qr_´ev
(&
’Œ›s
[
i
], 
lšk
);

180 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
i
+1è% 
NENTRIES
].id,

183 
	}
}

184 
TEST_END


187 
	$‹¡_¥l™_’Œ›s
(
ršg_t
 *
’Œ›s
)

189 
ršg_t
 *
t
;

190 
i
, 
j
;

192 
i
 = 0; i < 
NENTRIES
; i++) {

193 
j
 = 0;

194 
	`qr_fÜ—ch
(
t
, &
’Œ›s
[
i
], 
lšk
) {

195 ià(
i
 < 
SPLIT_INDEX
) {

196 
	`as£¹_c_eq
(
t
->
id
,

197 
’Œ›s
[(
i
+
j
è% 
SPLIT_INDEX
].
id
,

200 
	`as£¹_c_eq
(
t
->
id
, 
’Œ›s
[(
i
+
j
-
SPLIT_INDEX
) %

201 (
NENTRIES
-
SPLIT_INDEX
è+ SPLIT_INDEX].
id
,

204 
j
++;

207 
	}
}

209 
	$TEST_BEGIN
(
‹¡_qr_m–d_¥l™
)

211 
ršg_t
 
’Œ›s
[
NENTRIES
];

212 
i
;

214 
	`š™_’Œ›s
(
’Œ›s
);

215 
i
 = 1; i < 
NENTRIES
; i++)

216 
	`qr_aá”_š£¹
(&
’Œ›s
[
i
 - 1], &’Œ›s[i], 
lšk
);

218 
	`qr_¥l™
(&
’Œ›s
[0], &’Œ›s[
SPLIT_INDEX
], 
lšk
);

219 
	`‹¡_¥l™_’Œ›s
(
’Œ›s
);

221 
	`qr_m–d
(&
’Œ›s
[0], &’Œ›s[
SPLIT_INDEX
], 
lšk
);

222 
	`‹¡_’Œ›s_ršg
(
’Œ›s
);

224 
	`qr_m–d
(&
’Œ›s
[0], &’Œ›s[
SPLIT_INDEX
], 
lšk
);

225 
	`‹¡_¥l™_’Œ›s
(
’Œ›s
);

227 
	`qr_¥l™
(&
’Œ›s
[0], &’Œ›s[
SPLIT_INDEX
], 
lšk
);

228 
	`‹¡_’Œ›s_ršg
(
’Œ›s
);

230 
	`qr_¥l™
(&
’Œ›s
[0], &’Œ›s[0], 
lšk
);

231 
	`‹¡_’Œ›s_ršg
(
’Œ›s
);

233 
	`qr_m–d
(&
’Œ›s
[0], &’Œ›s[0], 
lšk
);

234 
	`‹¡_’Œ›s_ršg
(
’Œ›s
);

235 
	}
}

236 
TEST_END


239 
	$maš
()

242  (
	`‹¡
(

243 
‹¡_qr_Úe
,

244 
‹¡_qr_aá”_š£¹
,

245 
‹¡_qr_»move
,

246 
‹¡_qr_befÜe_š£¹
,

247 
‹¡_qr_m–d_¥l™
));

248 
	}
}

	@deps/jemalloc/test/unit/quarantine.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#QUARANTINE_SIZE
 8192

	)

4 
	#STRINGIFY_HELPER
(
x
è#x

	)

5 
	#STRINGIFY
(
x
è
	`STRINGIFY_HELPER
(x)

	)

7 #ifdeà
JEMALLOC_FILL


8 cÚ¡ *
	gm®loc_cÚf
 = "abort:false,junk:true,redzone:true,quarantine:"

9 
STRINGIFY
(
QUARANTINE_SIZE
);

13 
	$qu¬ªtše_ş—r
()

15 *
p
;

17 
p
 = 
	`m®locx
(
QUARANTINE_SIZE
*2, 0);

18 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

19 
	`d®locx
(
p
, 0);

20 
	}
}

22 
	$TEST_BEGIN
(
‹¡_qu¬ªtše
)

24 
	#SZ
 
	`ZU
(256)

	)

25 
	#NQUARANTINED
 (
QUARANTINE_SIZE
/
SZ
)

	)

26 *
qu¬ªtšed
[
NQUARANTINED
+1];

27 
size_t
 
i
, 
j
;

29 
	`‹¡_sk_if
(!
cÚfig_fl
);

31 
	`as£¹_zu_eq
(
	`ÇÎocx
(
SZ
, 0), SZ,

32 "SZ=%zu dÛ nÙ…»ci£lyƒqu®‡ sizşass", 
SZ
);

34 
	`qu¬ªtše_ş—r
();

43 
i
 = 0; i < 
NQUARANTINED
+1; i++) {

44 *
p
 = 
	`m®locx
(
SZ
, 0);

45 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

46 
qu¬ªtšed
[
i
] = 
p
;

47 
	`d®locx
(
p
, 0);

48 
j
 = 0; j < 
i
; j++) {

49 
	`as£¹_±r_Ã
(
p
, 
qu¬ªtšed
[
j
],

51 "i=%zu, j=%zu", 
i
, 
j
);

54 #undeà
NQUARANTINED


55 #undeà
SZ


56 
	}
}

57 
TEST_END


59 
boŞ
 
	gd‘eùed_»dzÚe_cÜru±iÚ
;

62 
	$¬’a_»dzÚe_cÜru±iÚ_»¶aûm’t
(*
±r
, 
size_t
 
usize
, 
boŞ
 
aá”
,

63 
size_t
 
off£t
, 
ušt8_t
 
by‹
)

66 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
Œue
;

67 
	}
}

69 
	$TEST_BEGIN
(
‹¡_qu¬ªtše_»dzÚe
)

71 *
s
;

72 
¬’a_»dzÚe_cÜru±iÚ_t
 *
¬’a_»dzÚe_cÜru±iÚ_Üig
;

74 
	`‹¡_sk_if
(!
cÚfig_fl
);

76 
¬’a_»dzÚe_cÜru±iÚ_Üig
 = 
¬’a_»dzÚe_cÜru±iÚ
;

77 
¬’a_»dzÚe_cÜru±iÚ
 = 
¬’a_»dzÚe_cÜru±iÚ_»¶aûm’t
;

80 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
çl£
;

81 
s
 = (*)
	`m®locx
(1, 0);

82 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

83 
s
[-1] = 0xbb;

84 
	`d®locx
(
s
, 0);

85 
	`as£¹_Œue
(
d‘eùed_»dzÚe_cÜru±iÚ
,

89 
d‘eùed_»dzÚe_cÜru±iÚ
 = 
çl£
;

90 
s
 = (*)
	`m®locx
(1, 0);

91 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

92 
s
[
	`§Îocx
(s, 0)] = 0xbb;

93 
	`d®locx
(
s
, 0);

94 
	`as£¹_Œue
(
d‘eùed_»dzÚe_cÜru±iÚ
,

97 
¬’a_»dzÚe_cÜru±iÚ
 = 
¬’a_»dzÚe_cÜru±iÚ_Üig
;

98 
	}
}

99 
TEST_END


102 
	$maš
()

105  (
	`‹¡
(

106 
‹¡_qu¬ªtše
,

107 
‹¡_qu¬ªtše_»dzÚe
));

108 
	}
}

	@deps/jemalloc/test/unit/rb.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#rbŠ_bÏck_height
(
a_ty³
, 
a_f›ld
, 
a_rbt
, 
r_height
) do { \

4 
a_ty³
 *
rbp_bh_t
; \

5 
rbp_bh_t
 = (
a_rbt
)->
rbt_roÙ
, (
r_height
) = 0; \

6 
rbp_bh_t
 !ğ&(
a_rbt
)->
rbt_n
; \

7 
rbp_bh_t
 = 
	`rbŠ_Ëá_g‘
(
a_ty³
, 
a_f›ld
,„bp_bh_t)) { \

8 ià(!
	`rbŠ_»d_g‘
(
a_ty³
, 
a_f›ld
, 
rbp_bh_t
)) { \

9 (
r_height
)++; \

12 } 0)

	)

14 
node_s
 
	tnode_t
;

16 
	snode_s
 {

17 
	#NODE_MAGIC
 0x9823af7e

	)

18 
ušt32_t
 
	mmagic
;

19 
rb_node
(
node_t
è
	mlšk
;

20 
ušt64_t
 
	mkey
;

24 
	$node_cmp
(
node_t
 *
a
,‚ode_ˆ*
b
) {

25 
»t
;

27 
	`as£¹_u32_eq
(
a
->
magic
, 
NODE_MAGIC
, "Bad magic");

28 
	`as£¹_u32_eq
(
b
->
magic
, 
NODE_MAGIC
, "Bad magic");

30 
»t
 = (
a
->
key
 > 
b
->key) - (a->key < b->key);

31 ià(
»t
 == 0) {

36 
»t
 = (((
ušŒ_t
)
a
è> ((ušŒ_t)
b
))

37 - (((
ušŒ_t
)
a
è< ((ušŒ_t)
b
));

39  (
»t
);

40 
	}
}

42 
	$rb_Œ“
(
	tnode_t
è
	tŒ“_t
;

43 
	`rb_g’
(, 
Œ“_
, 
Œ“_t
, 
node_t
, 
lšk
, 
node_cmp
);

45 
	$TEST_BEGIN
(
‹¡_rb_em±y
)

47 
Œ“_t
 
Œ“
;

48 
node_t
 
key
;

50 
	`Œ“_Ãw
(&
Œ“
);

52 
	`as£¹_Œue
(
	`Œ“_em±y
(&
Œ“
), "Tree should beƒmpty");

53 
	`as£¹_±r_nuÎ
(
	`Œ“_fœ¡
(&
Œ“
), "Unexpected‚ode");

54 
	`as£¹_±r_nuÎ
(
	`Œ“_Ï¡
(&
Œ“
), "Unexpected‚ode");

56 
key
.key = 0;

57 
key
.
magic
 = 
NODE_MAGIC
;

58 
	`as£¹_±r_nuÎ
(
	`Œ“_£¬ch
(&
Œ“
, &
key
), "Unexpected‚ode");

60 
key
.key = 0;

61 
key
.
magic
 = 
NODE_MAGIC
;

62 
	`as£¹_±r_nuÎ
(
	`Œ“_n£¬ch
(&
Œ“
, &
key
), "Unexpected‚ode");

64 
key
.key = 0;

65 
key
.
magic
 = 
NODE_MAGIC
;

66 
	`as£¹_±r_nuÎ
(
	`Œ“_p£¬ch
(&
Œ“
, &
key
), "Unexpected‚ode");

67 
	}
}

68 
TEST_END


71 
	$Œ“_»cur£
(
node_t
 *
node
, 
bÏck_height
, 
bÏck_d•th
,

72 
node_t
 *
n
)

74 
»t
 = 0;

75 
node_t
 *
Ëá_node
 = 
	`rbŠ_Ëá_g‘
Òode_t, 
lšk
, 
node
);

76 
node_t
 *
right_node
 = 
	`rbŠ_right_g‘
Òode_t, 
lšk
, 
node
);

78 ià(!
	`rbŠ_»d_g‘
(
node_t
, 
lšk
, 
node
))

79 
bÏck_d•th
++;

82 ià(
	`rbŠ_»d_g‘
(
node_t
, 
lšk
, 
node
)) {

83 
	`as£¹_çl£
(
	`rbŠ_»d_g‘
(
node_t
, 
lšk
, 
Ëá_node
),

85 
	`as£¹_çl£
(
	`rbŠ_»d_g‘
(
node_t
, 
lšk
, 
right_node
),

89 ià(
node
 =ğ
n
)

90  (
»t
);

92 
	`as£¹_u32_eq
(
node
->
magic
, 
NODE_MAGIC
, "Bad magic");

95 ià(
Ëá_node
 !ğ
n
)

96 
»t
 +ğ
	`Œ“_»cur£
(
Ëá_node
, 
bÏck_height
, 
bÏck_d•th
, 
n
);

98 
»t
 +ğ(
bÏck_d•th
 !ğ
bÏck_height
);

101 ià(
right_node
 !ğ
n
)

102 
»t
 +ğ
	`Œ“_»cur£
(
right_node
, 
bÏck_height
, 
bÏck_d•th
, 
n
);

104 
»t
 +ğ(
bÏck_d•th
 !ğ
bÏck_height
);

106  (
»t
);

107 
	}
}

109 
node_t
 *

110 
	$Œ“_™”©e_cb
(
Œ“_t
 *
Œ“
, 
node_t
 *
node
, *
d©a
)

112 *
i
 = (*)
d©a
;

113 
node_t
 *
£¬ch_node
;

115 
	`as£¹_u32_eq
(
node
->
magic
, 
NODE_MAGIC
, "Bad magic");

118 
£¬ch_node
 = 
	`Œ“_£¬ch
(
Œ“
, 
node
);

119 
	`as£¹_±r_eq
(
£¬ch_node
, 
node
,

123 
£¬ch_node
 = 
	`Œ“_n£¬ch
(
Œ“
, 
node
);

124 
	`as£¹_±r_eq
(
£¬ch_node
, 
node
,

128 
£¬ch_node
 = 
	`Œ“_p£¬ch
(
Œ“
, 
node
);

129 
	`as£¹_±r_eq
(
£¬ch_node
, 
node
,

132 (*
i
)++;

134  (
NULL
);

135 
	}
}

138 
	$Œ“_™”©e
(
Œ“_t
 *
Œ“
)

140 
i
;

142 
i
 = 0;

143 
	`Œ“_™”
(
Œ“
, 
NULL
, 
Œ“_™”©e_cb
, (*)&
i
);

145  (
i
);

146 
	}
}

149 
	$Œ“_™”©e_»v”£
(
Œ“_t
 *
Œ“
)

151 
i
;

153 
i
 = 0;

154 
	`Œ“_»v”£_™”
(
Œ“
, 
NULL
, 
Œ“_™”©e_cb
, (*)&
i
);

156  (
i
);

157 
	}
}

160 
	$node_»move
(
Œ“_t
 *
Œ“
, 
node_t
 *
node
, 
Âodes
)

162 
node_t
 *
£¬ch_node
;

163 
bÏck_height
, 
imb®ªûs
;

165 
	`Œ“_»move
(
Œ“
, 
node
);

168 
£¬ch_node
 = 
	`Œ“_n£¬ch
(
Œ“
, 
node
);

169 ià(
£¬ch_node
 !ğ
NULL
) {

170 
	`as£¹_u64_ge
(
£¬ch_node
->
key
, 
node
->key,

175 
£¬ch_node
 = 
	`Œ“_p£¬ch
(
Œ“
, 
node
);

176 ià(
£¬ch_node
 !ğ
NULL
) {

177 
	`as£¹_u64_Ë
(
£¬ch_node
->
key
, 
node
->key,

181 
node
->
magic
 = 0;

183 
	`rbŠ_bÏck_height
(
node_t
, 
lšk
, 
Œ“
, 
bÏck_height
);

184 
imb®ªûs
 = 
	`Œ“_»cur£
(
Œ“
->
rbt_roÙ
, 
bÏck_height
, 0,

185 &(
Œ“
->
rbt_n
));

186 
	`as£¹_u_eq
(
imb®ªûs
, 0, "Tree is unbalanced");

187 
	`as£¹_u_eq
(
	`Œ“_™”©e
(
Œ“
), 
Âodes
-1,

189 
	`as£¹_u_eq
(
	`Œ“_™”©e_»v”£
(
Œ“
), 
Âodes
-1,

191 
	}
}

193 
node_t
 *

194 
	$»move_™”©e_cb
(
Œ“_t
 *
Œ“
, 
node_t
 *
node
, *
d©a
)

196 *
Âodes
 = (*)
d©a
;

197 
node_t
 *
»t
 = 
	`Œ“_Ãxt
(
Œ“
, 
node
);

199 
	`node_»move
(
Œ“
, 
node
, *
Âodes
);

201  (
»t
);

202 
	}
}

204 
node_t
 *

205 
	$»move_»v”£_™”©e_cb
(
Œ“_t
 *
Œ“
, 
node_t
 *
node
, *
d©a
)

207 *
Âodes
 = (*)
d©a
;

208 
node_t
 *
»t
 = 
	`Œ“_´ev
(
Œ“
, 
node
);

210 
	`node_»move
(
Œ“
, 
node
, *
Âodes
);

212  (
»t
);

213 
	}
}

215 
	$TEST_BEGIN
(
‹¡_rb_¿ndom
)

217 
	#NNODES
 25

	)

218 
	#NBAGS
 250

	)

219 
	#SEED
 42

	)

220 
sfmt_t
 *
sfmt
;

221 
ušt64_t
 
bag
[
NNODES
];

222 
Œ“_t
 
Œ“
;

223 
node_t
 
nodes
[
NNODES
];

224 
i
, 
j
, 
k
, 
bÏck_height
, 
imb®ªûs
;

226 
sfmt
 = 
	`š™_g’_¿nd
(
SEED
);

227 
i
 = 0; i < 
NBAGS
; i++) {

228 
i
) {

231 
j
 = 0; j < 
NNODES
; j++)

232 
bag
[
j
] = j;

236 
j
 = 0; j < 
NNODES
; j++)

237 
bag
[
j
] = 
NNODES
 - j - 1;

240 
j
 = 0; j < 
NNODES
; j++)

241 
bag
[
j
] = 
	`g’_¿nd64_¿nge
(
sfmt
, 
NNODES
);

244 
j
 = 1; j <ğ
NNODES
; j++) {

246 
	`Œ“_Ãw
(&
Œ“
);

247 
Œ“
.
rbt_n
.
magic
 = 0;

248 
k
 = 0; k < 
j
; k++) {

249 
nodes
[
k
].
magic
 = 
NODE_MAGIC
;

250 
nodes
[
k
].
key
 = 
bag
[k];

254 
k
 = 0; k < 
j
; k++) {

255 
	`Œ“_š£¹
(&
Œ“
, &
nodes
[
k
]);

257 
	`rbŠ_bÏck_height
(
node_t
, 
lšk
, &
Œ“
,

258 
bÏck_height
);

259 
imb®ªûs
 = 
	`Œ“_»cur£
(
Œ“
.
rbt_roÙ
,

260 
bÏck_height
, 0, &(
Œ“
.
rbt_n
));

261 
	`as£¹_u_eq
(
imb®ªûs
, 0,

264 
	`as£¹_u_eq
(
	`Œ“_™”©e
(&
Œ“
), 
k
+1,

266 
	`as£¹_u_eq
(
	`Œ“_™”©e_»v”£
(&
Œ“
), 
k
+1,

269 
	`as£¹_çl£
(
	`Œ“_em±y
(&
Œ“
),

271 
	`as£¹_±r_nÙ_nuÎ
(
	`Œ“_fœ¡
(&
Œ“
),

273 
	`as£¹_±r_nÙ_nuÎ
(
	`Œ“_Ï¡
(&
Œ“
),

276 
	`Œ“_Ãxt
(&
Œ“
, &
nodes
[
k
]);

277 
	`Œ“_´ev
(&
Œ“
, &
nodes
[
k
]);

281 
i
 % 4) {

283 
k
 = 0; k < 
j
; k++)

284 
	`node_»move
(&
Œ“
, &
nodes
[
k
], 
j
 - k);

287 
k
 = 
j
; k > 0; k--)

288 
	`node_»move
(&
Œ“
, &
nodes
[
k
-1], k);

291 
node_t
 *
¡¬t
;

292 
Âodes
 = 
j
;

294 
¡¬t
 = 
NULL
;

296 
¡¬t
 = 
	`Œ“_™”
(&
Œ“
, start,

297 
»move_™”©e_cb
, (*)&
Âodes
);

298 
Âodes
--;

299 } 
¡¬t
 !ğ
NULL
);

300 
	`as£¹_u_eq
(
Âodes
, 0,

304 
node_t
 *
¡¬t
;

305 
Âodes
 = 
j
;

307 
¡¬t
 = 
NULL
;

309 
¡¬t
 = 
	`Œ“_»v”£_™”
(&
Œ“
, start,

310 
»move_»v”£_™”©e_cb
,

311 (*)&
Âodes
);

312 
Âodes
--;

313 } 
¡¬t
 !ğ
NULL
);

314 
	`as£¹_u_eq
(
Âodes
, 0,

318 
	`nÙ_»ached
();

322 
	`fši_g’_¿nd
(
sfmt
);

323 #undeà
NNODES


324 #undeà
NBAGS


325 #undeà
SEED


326 
	}
}

327 
TEST_END


330 
	$maš
()

333  (
	`‹¡
(

334 
‹¡_rb_em±y
,

335 
‹¡_rb_¿ndom
));

336 
	}
}

	@deps/jemalloc/test/unit/rtree.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
¹»e_node_–m_t
 *

4 
	$node_®loc
(
size_t
 
Ãlms
)

7  ((
¹»e_node_–m_t
 *)
	`ÿÎoc
(
Ãlms
, (rtree_node_elm_t)));

8 
	}
}

11 
	$node_d®loc
(
¹»e_node_–m_t
 *
node
)

14 
	`ä“
(
node
);

15 
	}
}

17 
	$TEST_BEGIN
(
‹¡_¹»e_g‘_em±y
)

19 
i
;

21 
i
 = 1; i <ğ((
ušŒ_t
) << 3); i++) {

22 
¹»e_t
 
¹»e
;

23 
	`as£¹_çl£
(
	`¹»e_Ãw
(&
¹»e
, 
i
, 
node_®loc
, 
node_d®loc
),

25 
	`as£¹_±r_nuÎ
(
	`¹»e_g‘
(&
¹»e
, 0, 
çl£
),

27 
	`¹»e_d–‘e
(&
¹»e
);

29 
	}
}

30 
TEST_END


32 
	$TEST_BEGIN
(
‹¡_¹»e_exŒema
)

34 
i
;

35 
ex‹Á_node_t
 
node_a
, 
node_b
;

37 
i
 = 1; i <ğ((
ušŒ_t
) << 3); i++) {

38 
¹»e_t
 
¹»e
;

39 
	`as£¹_çl£
(
	`¹»e_Ãw
(&
¹»e
, 
i
, 
node_®loc
, 
node_d®loc
),

42 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, 0, &
node_a
),

44 
	`as£¹_±r_eq
(
	`¹»e_g‘
(&
¹»e
, 0, 
Œue
), &
node_a
,

47 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, ~((
ušŒ_t
)0), &
node_b
),

49 
	`as£¹_±r_eq
(
	`¹»e_g‘
(&
¹»e
, ~((
ušŒ_t
)0), 
Œue
), &
node_b
,

52 
	`¹»e_d–‘e
(&
¹»e
);

54 
	}
}

55 
TEST_END


57 
	$TEST_BEGIN
(
‹¡_¹»e_b™s
)

59 
i
, 
j
, 
k
;

61 
i
 = 1; i < ((
ušŒ_t
) << 3); i++) {

62 
ušŒ_t
 
keys
[] = {0, 1,

63 (((
ušŒ_t
)1è<< ((ušŒ_t)*8-
i
)) - 1};

64 
ex‹Á_node_t
 
node
;

65 
¹»e_t
 
¹»e
;

67 
	`as£¹_çl£
(
	`¹»e_Ãw
(&
¹»e
, 
i
, 
node_®loc
, 
node_d®loc
),

70 
j
 = 0; j < (
keys
)/(
ušŒ_t
); j++) {

71 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, 
keys
[
j
], &
node
),

73 
k
 = 0; k < (
keys
)/(
ušŒ_t
); k++) {

74 
	`as£¹_±r_eq
(
	`¹»e_g‘
(&
¹»e
, 
keys
[
k
], 
Œue
),

75 &
node
, "rtree_get() should„eturn "

78 "£ˆkey=%#"
FMTxPTR
", g‘ key=%#"FMTxPTR, 
i
,

79 
j
, 
k
, 
keys
[j], keys[k]);

81 
	`as£¹_±r_nuÎ
(
	`¹»e_g‘
(&
¹»e
,

82 (((
ušŒ_t
)1è<< ((ušŒ_t)*8-
i
)), 
çl£
),

84 "i=%u, j=%u", 
i
, 
j
);

85 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, 
keys
[
j
], 
NULL
),

89 
	`¹»e_d–‘e
(&
¹»e
);

91 
	}
}

92 
TEST_END


94 
	$TEST_BEGIN
(
‹¡_¹»e_¿ndom
)

96 
i
;

97 
sfmt_t
 *
sfmt
;

98 
	#NSET
 16

	)

99 
	#SEED
 42

	)

101 
sfmt
 = 
	`š™_g’_¿nd
(
SEED
);

102 
i
 = 1; i <ğ((
ušŒ_t
) << 3); i++) {

103 
ušŒ_t
 
keys
[
NSET
];

104 
ex‹Á_node_t
 
node
;

105 
j
;

106 
¹»e_t
 
¹»e
;

108 
	`as£¹_çl£
(
	`¹»e_Ãw
(&
¹»e
, 
i
, 
node_®loc
, 
node_d®loc
),

111 
j
 = 0; j < 
NSET
; j++) {

112 
keys
[
j
] = (
ušŒ_t
)
	`g’_¿nd64
(
sfmt
);

113 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, 
keys
[
j
], &
node
),

115 
	`as£¹_±r_eq
(
	`¹»e_g‘
(&
¹»e
, 
keys
[
j
], 
Œue
), &
node
,

118 
j
 = 0; j < 
NSET
; j++) {

119 
	`as£¹_±r_eq
(
	`¹»e_g‘
(&
¹»e
, 
keys
[
j
], 
Œue
), &
node
,

123 
j
 = 0; j < 
NSET
; j++) {

124 
	`as£¹_çl£
(
	`¹»e_£t
(&
¹»e
, 
keys
[
j
], 
NULL
),

126 
	`as£¹_±r_nuÎ
(
	`¹»e_g‘
(&
¹»e
, 
keys
[
j
], 
Œue
),

129 
j
 = 0; j < 
NSET
; j++) {

130 
	`as£¹_±r_nuÎ
(
	`¹»e_g‘
(&
¹»e
, 
keys
[
j
], 
Œue
),

134 
	`¹»e_d–‘e
(&
¹»e
);

136 
	`fši_g’_¿nd
(
sfmt
);

137 #undeà
NSET


138 #undeà
SEED


139 
	}
}

140 
TEST_END


143 
	$maš
()

146  (
	`‹¡
(

147 
‹¡_¹»e_g‘_em±y
,

148 
‹¡_¹»e_exŒema
,

149 
‹¡_¹»e_b™s
,

150 
‹¡_¹»e_¿ndom
));

151 
	}
}

	@deps/jemalloc/test/unit/size_classes.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
size_t


4 
	$g‘_max_size_şass
()

6 
nhchunks
;

7 
size_t
 
mib
[4];

8 
size_t
 
sz
, 
mibËn
, 
max_size_şass
;

10 
sz
 = ();

11 
	`as£¹_d_eq
(
	`m®lùl
("¬’as.nhchunks", &
nhchunks
, &
sz
, 
NULL
, 0), 0,

14 
mibËn
 = (
mib
è/ (
size_t
);

15 
	`as£¹_d_eq
(
	`m®lùÊam‘omib
("¬’as.hchunk.0.size", 
mib
, &
mibËn
), 0,

17 
mib
[2] = 
nhchunks
 - 1;

19 
sz
 = (
size_t
);

20 
	`as£¹_d_eq
(
	`m®lùlbymib
(
mib
, 
mibËn
, &
max_size_şass
, &
sz
, 
NULL
, 0), 0,

23  (
max_size_şass
);

24 
	}
}

26 
	$TEST_BEGIN
(
‹¡_size_şas£s
)

28 
size_t
 
size_şass
, 
max_size_şass
;

29 
szšd_t
 
šdex
, 
max_šdex
;

31 
max_size_şass
 = 
	`g‘_max_size_şass
();

32 
max_šdex
 = 
	`size2šdex
(
max_size_şass
);

34 
šdex
 = 0, 
size_şass
 = 
	`šdex2size
(šdex); index < 
max_šdex
 ||

35 
size_şass
 < 
max_size_şass
; 
šdex
++, size_class =

36 
	`šdex2size
(
šdex
)) {

37 
	`as£¹_Œue
(
šdex
 < 
max_šdex
,

39 "size_şass=%zu (%#zx)", 
šdex
, 
size_şass
, size_class);

40 
	`as£¹_Œue
(
size_şass
 < 
max_size_şass
,

42 "size_şass=%zu (%#zx)", 
šdex
, 
size_şass
, size_class);

44 
	`as£¹_u_eq
(
šdex
, 
	`size2šdex
(
size_şass
),

46 " size_şass=%zu --> index=%u --> size_şass=%zu", 
šdex
,

47 
size_şass
, 
	`size2šdex
(size_class),

48 
	`šdex2size
(
	`size2šdex
(
size_şass
)));

49 
	`as£¹_zu_eq
(
size_şass
, 
	`šdex2size
(
	`size2šdex
(size_class)),

51 " size_şass=%zu --> index=%u --> size_şass=%zu", 
šdex
,

52 
size_şass
, 
	`size2šdex
(size_class),

53 
	`šdex2size
(
	`size2šdex
(
size_şass
)));

55 
	`as£¹_u_eq
(
šdex
+1, 
	`size2šdex
(
size_şass
+1),

58 
	`as£¹_zu_eq
(
size_şass
, (
šdex
 > 0) ?

59 
	`s2u
(
	`šdex2size
(
šdex
-1)+1) : s2u(1),

61 
	`as£¹_zu_eq
(
size_şass
, 
	`s2u
(size_class-1),

63 
	`as£¹_zu_eq
(
size_şass
, 
	`s2u
(size_class),

65 
	`as£¹_zu_eq
(
	`s2u
(
size_şass
+1), 
	`šdex2size
(
šdex
+1),

69 
	`as£¹_u_eq
(
šdex
, 
	`size2šdex
(
	`šdex2size
(index)),

71 
	`as£¹_zu_eq
(
max_size_şass
, 
	`šdex2size
(
	`size2šdex
(max_size_class)),

74 
	`as£¹_zu_eq
(
size_şass
, 
	`s2u
(
	`šdex2size
(
šdex
-1)+1),

76 
	`as£¹_zu_eq
(
size_şass
, 
	`s2u
(size_class-1),

78 
	`as£¹_zu_eq
(
size_şass
, 
	`s2u
(size_class),

80 
	}
}

81 
TEST_END


84 
	$maš
()

87  (
	`‹¡
(

88 
‹¡_size_şas£s
));

89 
	}
}

	@deps/jemalloc/test/unit/stats.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_¡©s_summ¬y
)

5 
size_t
 *
ÿùive
;

6 
size_t
 
sz
, 
®loÿ‹d
, 
aùive
, 
»sid’t
, 
m­³d
;

7 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

9 
sz
 = (
ÿùive
);

10 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.ÿùive", &
ÿùive
, &
sz
, 
NULL
, 0), 
ex³ùed
,

13 
sz
 = (
size_t
);

14 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.®loÿ‹d", &
®loÿ‹d
, &
sz
, 
NULL
, 0),

15 
ex³ùed
, "Unexpected mallctl()„esult");

16 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.aùive", &
aùive
, &
sz
, 
NULL
, 0), 
ex³ùed
,

18 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.»sid’t", &
»sid’t
, &
sz
, 
NULL
, 0),

19 
ex³ùed
, "Unexpected mallctl()„esult");

20 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.m­³d", &
m­³d
, &
sz
, 
NULL
, 0), 
ex³ùed
,

23 ià(
cÚfig_¡©s
) {

24 
	`as£¹_zu_Ë
(
aùive
, *
ÿùive
,

26 
	`as£¹_zu_Ë
(
®loÿ‹d
, 
aùive
,

28 
	`as£¹_zu_É
(
aùive
, 
»sid’t
,

30 
	`as£¹_zu_É
(
aùive
, 
m­³d
,

33 
	}
}

34 
TEST_END


36 
	$TEST_BEGIN
(
‹¡_¡©s_huge
)

38 *
p
;

39 
ušt64_t
 
•och
;

40 
size_t
 
®loÿ‹d
;

41 
ušt64_t
 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

42 
size_t
 
sz
;

43 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

45 
p
 = 
	`m®locx
(
Ïrge_maxşass
+1, 0);

46 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

48 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

51 
sz
 = (
size_t
);

52 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.®loÿ‹d", &
®loÿ‹d
, &
sz
,

53 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

54 
sz
 = (
ušt64_t
);

55 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.nm®loc", &
nm®loc
, &
sz
, 
NULL
,

56 0), 
ex³ùed
, "Unexpected mallctl()„esult");

57 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.nd®loc", &
nd®loc
, &
sz
, 
NULL
,

58 0), 
ex³ùed
, "Unexpected mallctl()„esult");

59 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.Äeque¡s", &
Äeque¡s
, &
sz
,

60 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

62 ià(
cÚfig_¡©s
) {

63 
	`as£¹_zu_gt
(
®loÿ‹d
, 0,

65 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

67 
	`as£¹_u64_Ë
(
nm®loc
, 
Äeque¡s
,

71 
	`d®locx
(
p
, 0);

72 
	}
}

73 
TEST_END


75 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_summ¬y
)

77 
¬’a
;

78 *
l™e
, *
Ïrge
, *
huge
;

79 
ušt64_t
 
•och
;

80 
size_t
 
sz
;

81 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

82 
size_t
 
m­³d
;

83 
ušt64_t
 
Åurge
, 
nmadvi£
, 
purged
;

85 
¬’a
 = 0;

86 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

89 
l™e
 = 
	`m®locx
(
SMALL_MAXCLASS
, 0);

90 
	`as£¹_±r_nÙ_nuÎ
(
l™e
, "Unexpected mallocx() failure");

91 
Ïrge
 = 
	`m®locx
(
Ïrge_maxşass
, 0);

92 
	`as£¹_±r_nÙ_nuÎ
(
Ïrge
, "Unexpected mallocx() failure");

93 
huge
 = 
	`m®locx
(
chunksize
, 0);

94 
	`as£¹_±r_nÙ_nuÎ
(
huge
, "Unexpected mallocx() failure");

96 
	`as£¹_d_eq
(
	`m®lùl
("¬’a.0.purge", 
NULL
, NULL, NULL, 0), 0,

99 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

102 
sz
 = (
size_t
);

103 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.m­³d", &
m­³d
, &
sz
, 
NULL
, 0),

104 
ex³ùed
, "Unexepected mallctl()„esult");

105 
sz
 = (
ušt64_t
);

106 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Åurge", &
Åurge
, &
sz
, 
NULL
, 0),

107 
ex³ùed
, "Unexepected mallctl()„esult");

108 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.nmadvi£", &
nmadvi£
, &
sz
, 
NULL
, 0),

109 
ex³ùed
, "Unexepected mallctl()„esult");

110 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.purged", &
purged
, &
sz
, 
NULL
, 0),

111 
ex³ùed
, "Unexepected mallctl()„esult");

113 ià(
cÚfig_¡©s
) {

114 
	`as£¹_u64_gt
(
Åurge
, 0,

116 
	`as£¹_u64_Ë
(
nmadvi£
, 
purged
,

120 
	`d®locx
(
l™e
, 0);

121 
	`d®locx
(
Ïrge
, 0);

122 
	`d®locx
(
huge
, 0);

123 
	}
}

124 
TEST_END


127 
	$thd_¡¬t
(*
¬g
)

130  (
NULL
);

131 
	}
}

134 
	$no_Ïzy_lock
()

136 
thd_t
 
thd
;

138 
	`thd_ü—‹
(&
thd
, 
thd_¡¬t
, 
NULL
);

139 
	`thd_još
(
thd
, 
NULL
);

140 
	}
}

142 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_sm®l
)

144 
¬’a
;

145 *
p
;

146 
size_t
 
sz
, 
®loÿ‹d
;

147 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

148 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

150 
	`no_Ïzy_lock
();

152 
¬’a
 = 0;

153 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

156 
p
 = 
	`m®locx
(
SMALL_MAXCLASS
, 0);

157 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

159 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.æush", 
NULL
, NULL, NULL, 0),

160 
cÚfig_tÿche
 ? 0 : 
ENOENT
, "Unexpected mallctl()„esult");

162 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

165 
sz
 = (
size_t
);

166 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.sm®l.®loÿ‹d", &
®loÿ‹d
, &
sz
,

167 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

168 
sz
 = (
ušt64_t
);

169 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.sm®l.nm®loc", &
nm®loc
, &
sz
,

170 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

171 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.sm®l.nd®loc", &
nd®loc
, &
sz
,

172 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

173 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.sm®l.Äeque¡s", &
Äeque¡s
, &
sz
,

174 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

176 ià(
cÚfig_¡©s
) {

177 
	`as£¹_zu_gt
(
®loÿ‹d
, 0,

179 
	`as£¹_u64_gt
(
nm®loc
, 0,

181 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

183 
	`as£¹_u64_gt
(
Äeque¡s
, 0,

187 
	`d®locx
(
p
, 0);

188 
	}
}

189 
TEST_END


191 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_Ïrge
)

193 
¬’a
;

194 *
p
;

195 
size_t
 
sz
, 
®loÿ‹d
;

196 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

197 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

199 
¬’a
 = 0;

200 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

203 
p
 = 
	`m®locx
(
Ïrge_maxşass
, 0);

204 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

206 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

209 
sz
 = (
size_t
);

210 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ïrge.®loÿ‹d", &
®loÿ‹d
, &
sz
,

211 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

212 
sz
 = (
ušt64_t
);

213 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ïrge.nm®loc", &
nm®loc
, &
sz
,

214 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

215 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ïrge.nd®loc", &
nd®loc
, &
sz
,

216 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

217 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ïrge.Äeque¡s", &
Äeque¡s
, &
sz
,

218 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

220 ià(
cÚfig_¡©s
) {

221 
	`as£¹_zu_gt
(
®loÿ‹d
, 0,

223 
	`as£¹_zu_gt
(
nm®loc
, 0,

225 
	`as£¹_zu_ge
(
nm®loc
, 
nd®loc
,

227 
	`as£¹_zu_gt
(
Äeque¡s
, 0,

231 
	`d®locx
(
p
, 0);

232 
	}
}

233 
TEST_END


235 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_huge
)

237 
¬’a
;

238 *
p
;

239 
size_t
 
sz
, 
®loÿ‹d
;

240 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
;

241 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

243 
¬’a
 = 0;

244 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

247 
p
 = 
	`m®locx
(
chunksize
, 0);

248 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

250 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

253 
sz
 = (
size_t
);

254 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.®loÿ‹d", &
®loÿ‹d
, &
sz
,

255 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

256 
sz
 = (
ušt64_t
);

257 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.nm®loc", &
nm®loc
, &
sz
,

258 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

259 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.huge.nd®loc", &
nd®loc
, &
sz
,

260 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

262 ià(
cÚfig_¡©s
) {

263 
	`as£¹_zu_gt
(
®loÿ‹d
, 0,

265 
	`as£¹_zu_gt
(
nm®loc
, 0,

267 
	`as£¹_zu_ge
(
nm®loc
, 
nd®loc
,

271 
	`d®locx
(
p
, 0);

272 
	}
}

273 
TEST_END


275 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_bšs
)

277 
¬’a
;

278 *
p
;

279 
size_t
 
sz
, 
cu¼uns
, 
cu¼egs
;

280 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
, 
Äeque¡s
, 
nfls
, 
næushes
;

281 
ušt64_t
 
Äuns
, 
Ä”uns
;

282 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

284 
¬’a
 = 0;

285 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

288 
p
 = 
	`m®locx
(
¬’a_bš_šfo
[0].
»g_size
, 0);

289 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

291 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.tÿche.æush", 
NULL
, NULL, NULL, 0),

292 
cÚfig_tÿche
 ? 0 : 
ENOENT
, "Unexpected mallctl()„esult");

294 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

297 
sz
 = (
ušt64_t
);

298 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.nm®loc", &
nm®loc
, &
sz
,

299 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

300 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.nd®loc", &
nd®loc
, &
sz
,

301 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

302 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.Äeque¡s", &
Äeque¡s
, &
sz
,

303 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

304 
sz
 = (
size_t
);

305 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.cu¼egs", &
cu¼egs
, &
sz
,

306 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

308 
sz
 = (
ušt64_t
);

309 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.nfls", &
nfls
, &
sz
,

310 
NULL
, 0), 
cÚfig_tÿche
 ? 
ex³ùed
 : 
ENOENT
,

312 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.næushes", &
næushes
, &
sz
,

313 
NULL
, 0), 
cÚfig_tÿche
 ? 
ex³ùed
 : 
ENOENT
,

316 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.Äuns", &
Äuns
, &
sz
,

317 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

318 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.Ä”uns", &
Ä”uns
, &
sz
,

319 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

320 
sz
 = (
size_t
);

321 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.bšs.0.cu¼uns", &
cu¼uns
, &
sz
,

322 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

324 ià(
cÚfig_¡©s
) {

325 
	`as£¹_u64_gt
(
nm®loc
, 0,

327 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

329 
	`as£¹_u64_gt
(
Äeque¡s
, 0,

331 
	`as£¹_zu_gt
(
cu¼egs
, 0,

333 ià(
cÚfig_tÿche
) {

334 
	`as£¹_u64_gt
(
nfls
, 0,

336 
	`as£¹_u64_gt
(
næushes
, 0,

339 
	`as£¹_u64_gt
(
Äuns
, 0,

341 
	`as£¹_zu_gt
(
cu¼uns
, 0,

345 
	`d®locx
(
p
, 0);

346 
	}
}

347 
TEST_END


349 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_Ìuns
)

351 
¬’a
;

352 *
p
;

353 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
, 
Äeque¡s
;

354 
size_t
 
cu¼uns
, 
sz
;

355 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

357 
¬’a
 = 0;

358 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

361 
p
 = 
	`m®locx
(
LARGE_MINCLASS
, 0);

362 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

364 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

367 
sz
 = (
ušt64_t
);

368 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ìuns.0.nm®loc", &
nm®loc
, &
sz
,

369 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

370 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ìuns.0.nd®loc", &
nd®loc
, &
sz
,

371 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

372 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ìuns.0.Äeque¡s", &
Äeque¡s
, &
sz
,

373 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

374 
sz
 = (
size_t
);

375 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.Ìuns.0.cu¼uns", &
cu¼uns
, &
sz
,

376 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

378 ià(
cÚfig_¡©s
) {

379 
	`as£¹_u64_gt
(
nm®loc
, 0,

381 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

383 
	`as£¹_u64_gt
(
Äeque¡s
, 0,

385 
	`as£¹_u64_gt
(
cu¼uns
, 0,

389 
	`d®locx
(
p
, 0);

390 
	}
}

391 
TEST_END


393 
	$TEST_BEGIN
(
‹¡_¡©s_¬’as_hchunks
)

395 
¬’a
;

396 *
p
;

397 
ušt64_t
 
•och
, 
nm®loc
, 
nd®loc
;

398 
size_t
 
curhchunks
, 
sz
;

399 
ex³ùed
 = 
cÚfig_¡©s
 ? 0 : 
ENOENT
;

401 
¬’a
 = 0;

402 
	`as£¹_d_eq
(
	`m®lùl
("th»ad.¬’a", 
NULL
, NULL, &
¬’a
, (arena)),

405 
p
 = 
	`m®locx
(
chunksize
, 0);

406 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected mallocx() failure");

408 
	`as£¹_d_eq
(
	`m®lùl
("•och", 
NULL
, NULL, &
•och
, (epoch)), 0,

411 
sz
 = (
ušt64_t
);

412 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.hchunks.0.nm®loc", &
nm®loc
, &
sz
,

413 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

414 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.hchunks.0.nd®loc", &
nd®loc
, &
sz
,

415 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

416 
sz
 = (
size_t
);

417 
	`as£¹_d_eq
(
	`m®lùl
("¡©s.¬’as.0.hchunks.0.curhchunks", &
curhchunks
,

418 &
sz
, 
NULL
, 0), 
ex³ùed
, "Unexpected mallctl()„esult");

420 ià(
cÚfig_¡©s
) {

421 
	`as£¹_u64_gt
(
nm®loc
, 0,

423 
	`as£¹_u64_ge
(
nm®loc
, 
nd®loc
,

425 
	`as£¹_u64_gt
(
curhchunks
, 0,

429 
	`d®locx
(
p
, 0);

430 
	}
}

431 
TEST_END


434 
	$maš
()

437  (
	`‹¡
(

438 
‹¡_¡©s_summ¬y
,

439 
‹¡_¡©s_huge
,

440 
‹¡_¡©s_¬’as_summ¬y
,

441 
‹¡_¡©s_¬’as_sm®l
,

442 
‹¡_¡©s_¬’as_Ïrge
,

443 
‹¡_¡©s_¬’as_huge
,

444 
‹¡_¡©s_¬’as_bšs
,

445 
‹¡_¡©s_¬’as_Ìuns
,

446 
‹¡_¡©s_¬’as_hchunks
));

447 
	}
}

	@deps/jemalloc/test/unit/tsd.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	#THREAD_DATA
 0x72b65c10

	)

5 
	td©a_t
;

7 
boŞ
 
	gd©a_ş—nup_execu‹d
;

9 
	$m®loc_tsd_ty³s
(
d©a_
, 
d©a_t
)

10 
	$m®loc_tsd_´Ùos
(, 
d©a_
, 
d©a_t
)

13 
	$d©a_ş—nup
(*
¬g
)

15 
d©a_t
 *
d©a
 = (d©a_ˆ*)
¬g
;

17 ià(!
d©a_ş—nup_execu‹d
) {

18 
	`as£¹_x_eq
(*
d©a
, 
THREAD_DATA
,

22 
d©a_ş—nup_execu‹d
 = 
Œue
;

28 *
d©a
) {

29 
THREAD_DATA
:

30 *
d©a
 = 1;

31 
	`d©a_tsd_£t
(
d©a
);

34 *
d©a
 = 2;

35 
	`d©a_tsd_£t
(
d©a
);

40 
	`nÙ_»ached
();

44 *
p
 = 
	`m®locx
(1, 0);

45 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpeced mallocx() failure");

46 
	`d®locx
(
p
, 0);

48 
	}
}

50 
	$m®loc_tsd_ex‹ºs
(
d©a_
, 
d©a_t
)

51 
	#DATA_INIT
 0x12345678

	)

52 
	$m®loc_tsd_d©a
(, 
d©a_
, 
d©a_t
, 
DATA_INIT
)

53 
	$m®loc_tsd_funcs
(, 
d©a_
, 
d©a_t
, 
DATA_INIT
, 
d©a_ş—nup
)

56 
	$thd_¡¬t
(*
¬g
)

58 
d©a_t
 
d
 = (d©a_t)(
ušŒ_t
)
¬g
;

59 *
p
;

61 
	`as£¹_x_eq
(*
	`d©a_tsd_g‘
(), 
DATA_INIT
,

64 
p
 = 
	`m®loc
(1);

65 
	`as£¹_±r_nÙ_nuÎ
(
p
, "Unexpected malloc() failure");

67 
	`d©a_tsd_£t
(&
d
);

68 
	`as£¹_x_eq
(*
	`d©a_tsd_g‘
(), 
d
,

71 
d
 = 0;

72 
	`as£¹_x_eq
(*
	`d©a_tsd_g‘
(), (
d©a_t
)(
ušŒ_t
)
¬g
,

75 
	`ä“
(
p
);

76  (
NULL
);

77 
	}
}

79 
	$TEST_BEGIN
(
‹¡_tsd_maš_th»ad
)

82 
	`thd_¡¬t
((*) 0xa5f3e329);

83 
	}
}

84 
TEST_END


86 
	$TEST_BEGIN
(
‹¡_tsd_sub_th»ad
)

88 
thd_t
 
thd
;

90 
d©a_ş—nup_execu‹d
 = 
çl£
;

91 
	`thd_ü—‹
(&
thd
, 
thd_¡¬t
, (*)
THREAD_DATA
);

92 
	`thd_još
(
thd
, 
NULL
);

93 
	`as£¹_Œue
(
d©a_ş—nup_execu‹d
,

95 
	}
}

96 
TEST_END


99 
	$maš
()

102 
	`d©a_tsd_boÙ
();

104  (
	`‹¡
(

105 
‹¡_tsd_maš_th»ad
,

106 
‹¡_tsd_sub_th»ad
));

107 
	}
}

	@deps/jemalloc/test/unit/util.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 
	$TEST_BEGIN
(
‹¡_pow2_û
)

5 
i
, 
pow2
;

6 
size_t
 
x
;

8 
	`as£¹_zu_eq
(
	`pow2_û
(0), 0, "Unexpected„esult");

10 
i
 = 0; i < (
size_t
) * 8; i++) {

11 
	`as£¹_zu_eq
(
	`pow2_û
(
	`ZU
(1è<< 
i
), ZU(1) << i,

15 
i
 = 2; i < (
size_t
) * 8; i++) {

16 
	`as£¹_zu_eq
(
	`pow2_û
((
	`ZU
(1è<< 
i
) - 1), ZU(1) << i,

20 
i
 = 0; i < (
size_t
) * 8 - 1; i++) {

21 
	`as£¹_zu_eq
(
	`pow2_û
((
	`ZU
(1è<< 
i
) + 1), ZU(1) << (i+1),

25 
pow2
 = 1;…ow2 < 25;…ow2++) {

26 
x
 = (
	`ZU
(1è<< (
pow2
-1)) + 1; x <= ZU(1) <<…ow2; x++) {

27 
	`as£¹_zu_eq
(
	`pow2_û
(
x
), 
	`ZU
(1è<< 
pow2
,

28 "UÃx³ùed„esuÉ, x=%zu", 
x
);

31 
	}
}

32 
TEST_END


34 
	$TEST_BEGIN
(
‹¡_m®loc_¡¹oumax_no_’d±r
)

36 
”r
;

38 
	`£t_”ºo
(0);

39 
	`as£¹_ju_eq
(
	`m®loc_¡¹oumax
("0", 
NULL
, 0), 0, "Unexpected„esult");

40 
”r
 = 
	`g‘_”ºo
();

41 
	`as£¹_d_eq
(
”r
, 0, "Unexpected failure");

42 
	}
}

43 
TEST_END


45 
	$TEST_BEGIN
(
‹¡_m®loc_¡¹oumax
)

47 
	s‹¡_s
 {

48 cÚ¡ *
šput
;

49 cÚ¡ *
ex³ùed_»mašd”
;

50 
ba£
;

51 
ex³ùed_”ºo
;

52 cÚ¡ *
ex³ùed_”ºo_Çme
;

53 
uštmax_t
 
ex³ùed_x
;

55 
	#ERR
(
e
èe, #e

	)

56 
	#KUMAX
(
x
è((
uštmax_t
)x##
ULL
)

	)

57 
‹¡_s
 
‹¡s
[] = {

58 {"0", "0", -1, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

59 {"0", "0", 1, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

60 {"0", "0", 37, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

62 {"", "", 0, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

63 {"+", "+", 0, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

64 {"++3", "++3", 0, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

65 {"-", "-", 0, 
	`ERR
(
EINVAL
), 
UINTMAX_MAX
},

67 {"42", "", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

68 {"+42", "", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

69 {"-42", "", 0, 
	`ERR
(0), 
	`KUMAX
(-42)},

70 {"042", "", 0, 
	`ERR
(0), 
	`KUMAX
(042)},

71 {"+042", "", 0, 
	`ERR
(0), 
	`KUMAX
(042)},

72 {"-042", "", 0, 
	`ERR
(0), 
	`KUMAX
(-042)},

73 {"0x42", "", 0, 
	`ERR
(0), 
	`KUMAX
(0x42)},

74 {"+0x42", "", 0, 
	`ERR
(0), 
	`KUMAX
(0x42)},

75 {"-0x42", "", 0, 
	`ERR
(0), 
	`KUMAX
(-0x42)},

77 {"0", "", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

78 {"1", "", 0, 
	`ERR
(0), 
	`KUMAX
(1)},

80 {"42", "", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

81 {" 42", "", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

82 {"42 ", " ", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

83 {"0x", "x", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

84 {"42x", "x", 0, 
	`ERR
(0), 
	`KUMAX
(42)},

86 {"07", "", 0, 
	`ERR
(0), 
	`KUMAX
(7)},

87 {"010", "", 0, 
	`ERR
(0), 
	`KUMAX
(8)},

88 {"08", "8", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

89 {"0_", "_", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

91 {"0x", "x", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

92 {"0X", "X", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

93 {"0xg", "xg", 0, 
	`ERR
(0), 
	`KUMAX
(0)},

94 {"0XA", "", 0, 
	`ERR
(0), 
	`KUMAX
(10)},

96 {"010", "", 10, 
	`ERR
(0), 
	`KUMAX
(10)},

97 {"0x3", "x3", 10, 
	`ERR
(0), 
	`KUMAX
(0)},

99 {"12", "2", 2, 
	`ERR
(0), 
	`KUMAX
(1)},

100 {"78", "8", 8, 
	`ERR
(0), 
	`KUMAX
(7)},

101 {"9a", "a", 10, 
	`ERR
(0), 
	`KUMAX
(9)},

102 {"9A", "A", 10, 
	`ERR
(0), 
	`KUMAX
(9)},

103 {"fg", "g", 16, 
	`ERR
(0), 
	`KUMAX
(15)},

104 {"FG", "G", 16, 
	`ERR
(0), 
	`KUMAX
(15)},

105 {"0xfg", "g", 16, 
	`ERR
(0), 
	`KUMAX
(15)},

106 {"0XFG", "G", 16, 
	`ERR
(0), 
	`KUMAX
(15)},

107 {"z_", "_", 36, 
	`ERR
(0), 
	`KUMAX
(35)},

108 {"Z_", "_", 36, 
	`ERR
(0), 
	`KUMAX
(35)}

110 #undeà
ERR


111 #undeà
KUMAX


112 
i
;

114 
i
 = 0; i < (
‹¡s
)/(
‹¡_s
); i++) {

115 
‹¡_s
 *
‹¡
 = &
‹¡s
[
i
];

116 
”r
;

117 
uštmax_t
 
»suÉ
;

118 *
»mašd”
;

120 
	`£t_”ºo
(0);

121 
»suÉ
 = 
	`m®loc_¡¹oumax
(
‹¡
->
šput
, &
»mašd”
,e¡->
ba£
);

122 
”r
 = 
	`g‘_”ºo
();

123 
	`as£¹_d_eq
(
”r
, 
‹¡
->
ex³ùed_”ºo
,

125 
‹¡
->
ex³ùed_”ºo_Çme
,e¡->
šput
,e¡->
ba£
);

126 
	`as£¹_¡r_eq
(
»mašd”
, 
‹¡
->
ex³ùed_»mašd”
,

128 
‹¡
->
šput
,e¡->
ba£
);

129 ià(
”r
 == 0) {

130 
	`as£¹_ju_eq
(
»suÉ
, 
‹¡
->
ex³ùed_x
,

132 
‹¡
->
šput
,e¡->
ba£
);

135 
	}
}

136 
TEST_END


138 
	$TEST_BEGIN
(
‹¡_m®loc_¢´štf_Œunÿ‹d
)

140 
	#BUFLEN
 15

	)

141 
buf
[
BUFLEN
];

142 
»suÉ
;

143 
size_t
 
Ën
;

144 
	#TEST
(
ex³ùed_¡r_uÁrunÿ‹d
, ...) do { \

145 
»suÉ
 = 
	`m®loc_¢´štf
(
buf
, 
Ën
, 
__VA_ARGS__
); \

146 
	`as£¹_d_eq
(
	`¡ºcmp
(
buf
, 
ex³ùed_¡r_uÁrunÿ‹d
, 
Ën
-1), 0, \

148 
buf
, 
ex³ùed_¡r_uÁrunÿ‹d
); \

149 
	`as£¹_d_eq
(
»suÉ
, 
	`¡¾’
(
ex³ùed_¡r_uÁrunÿ‹d
), \

151 } 0)

	)

153 
Ën
 = 1;†’ < 
BUFLEN
;†en++) {

154 
	`TEST
("012346789", "012346789");

155 
	`TEST
("a0123b", "a%sb", "0123");

156 
	`TEST
("a01234567", "a%s%s", "0123", "4567");

157 
	`TEST
("a0123 ", "a%-6s", "0123");

158 
	`TEST
("a 0123", "a%6s", "0123");

159 
	`TEST
("a 012", "a%6.3s", "0123");

160 
	`TEST
("a 012", "a%*.*s", 6, 3, "0123");

161 
	`TEST
("a 123b", "a% db", 123);

162 
	`TEST
("a123b", "a%-db", 123);

163 
	`TEST
("a-123b", "a%-db", -123);

164 
	`TEST
("a+123b", "a%+db", 123);

166 #undeà
BUFLEN


167 #undeà
TEST


168 
	}
}

169 
TEST_END


171 
	$TEST_BEGIN
(
‹¡_m®loc_¢´štf
)

173 
	#BUFLEN
 128

	)

174 
buf
[
BUFLEN
];

175 
»suÉ
;

176 
	#TEST
(
ex³ùed_¡r
, ...) do { \

177 
»suÉ
 = 
	`m®loc_¢´štf
(
buf
, (buf), 
__VA_ARGS__
); \

178 
	`as£¹_¡r_eq
(
buf
, 
ex³ùed_¡r
, "Unexpected output"); \

179 
	`as£¹_d_eq
(
»suÉ
, 
	`¡¾’
(
ex³ùed_¡r
), "Unexpected„esult"); \

180 } 0)

	)

182 
	`TEST
("hello", "hello");

184 
	`TEST
("50%, 100%", "50%%, %d%%", 100);

186 
	`TEST
("a0123b", "a%sb", "0123");

188 
	`TEST
("a 0123b", "a%5sb", "0123");

189 
	`TEST
("a 0123b", "a%*sb", 5, "0123");

191 
	`TEST
("a0123 b", "a%-5sb", "0123");

192 
	`TEST
("a0123b", "a%*sb", -1, "0123");

193 
	`TEST
("a0123 b", "a%*sb", -5, "0123");

194 
	`TEST
("a0123 b", "a%-*sb", -5, "0123");

196 
	`TEST
("a012b", "a%.3sb", "0123");

197 
	`TEST
("a012b", "a%.*sb", 3, "0123");

198 
	`TEST
("a0123b", "a%.*sb", -3, "0123");

200 
	`TEST
("a 012b", "a%5.3sb", "0123");

201 
	`TEST
("a 012b", "a%5.*sb", 3, "0123");

202 
	`TEST
("a 012b", "a%*.3sb", 5, "0123");

203 
	`TEST
("a 012b", "a%*.*sb", 5, 3, "0123");

204 
	`TEST
("a 0123b", "a%*.*sb", 5, -3, "0123");

206 
	`TEST
("_abcd_", "_%x_", 0xabcd);

207 
	`TEST
("_0xabcd_", "_%#x_", 0xabcd);

208 
	`TEST
("_1234_", "_%o_", 01234);

209 
	`TEST
("_01234_", "_%#o_", 01234);

210 
	`TEST
("_1234_", "_%u_", 1234);

212 
	`TEST
("_1234_", "_%d_", 1234);

213 
	`TEST
("_ 1234_", "_% d_", 1234);

214 
	`TEST
("_+1234_", "_%+d_", 1234);

215 
	`TEST
("_-1234_", "_%d_", -1234);

216 
	`TEST
("_-1234_", "_% d_", -1234);

217 
	`TEST
("_-1234_", "_%+d_", -1234);

219 
	`TEST
("_-1234_", "_%d_", -1234);

220 
	`TEST
("_1234_", "_%d_", 1234);

221 
	`TEST
("_-1234_", "_%i_", -1234);

222 
	`TEST
("_1234_", "_%i_", 1234);

223 
	`TEST
("_01234_", "_%#o_", 01234);

224 
	`TEST
("_1234_", "_%u_", 1234);

225 
	`TEST
("_0x1234abc_", "_%#x_", 0x1234abc);

226 
	`TEST
("_0X1234ABC_", "_%#X_", 0x1234abc);

227 
	`TEST
("_c_", "_%c_", 'c');

228 
	`TEST
("_string_", "_%s_", "string");

229 
	`TEST
("_0x42_", "_%p_", ((*)0x42));

231 
	`TEST
("_-1234_", "_%ld_", (()-1234));

232 
	`TEST
("_1234_", "_%ld_", (()1234));

233 
	`TEST
("_-1234_", "_%li_", (()-1234));

234 
	`TEST
("_1234_", "_%li_", (()1234));

235 
	`TEST
("_01234_", "_%#lo_", (()01234));

236 
	`TEST
("_1234_", "_%lu_", (()1234));

237 
	`TEST
("_0x1234abc_", "_%#lx_", (()0x1234abc));

238 
	`TEST
("_0X1234ABC_", "_%#lX_", (()0x1234ABC));

240 
	`TEST
("_-1234_", "_%lld_", (()-1234));

241 
	`TEST
("_1234_", "_%lld_", (()1234));

242 
	`TEST
("_-1234_", "_%lli_", (()-1234));

243 
	`TEST
("_1234_", "_%lli_", (()1234));

244 
	`TEST
("_01234_", "_%#llo_", (()01234));

245 
	`TEST
("_1234_", "_%llu_", (()1234));

246 
	`TEST
("_0x1234abc_", "_%#llx_", (()0x1234abc));

247 
	`TEST
("_0X1234ABC_", "_%#llX_", (()0x1234ABC));

249 
	`TEST
("_-1234_", "_%qd_", (()-1234));

250 
	`TEST
("_1234_", "_%qd_", (()1234));

251 
	`TEST
("_-1234_", "_%qi_", (()-1234));

252 
	`TEST
("_1234_", "_%qi_", (()1234));

253 
	`TEST
("_01234_", "_%#qo_", (()01234));

254 
	`TEST
("_1234_", "_%qu_", (()1234));

255 
	`TEST
("_0x1234abc_", "_%#qx_", (()0x1234abc));

256 
	`TEST
("_0X1234ABC_", "_%#qX_", (()0x1234ABC));

258 
	`TEST
("_-1234_", "_%jd_", ((
štmax_t
)-1234));

259 
	`TEST
("_1234_", "_%jd_", ((
štmax_t
)1234));

260 
	`TEST
("_-1234_", "_%ji_", ((
štmax_t
)-1234));

261 
	`TEST
("_1234_", "_%ji_", ((
štmax_t
)1234));

262 
	`TEST
("_01234_", "_%#jo_", ((
štmax_t
)01234));

263 
	`TEST
("_1234_", "_%ju_", ((
štmax_t
)1234));

264 
	`TEST
("_0x1234abc_", "_%#jx_", ((
štmax_t
)0x1234abc));

265 
	`TEST
("_0X1234ABC_", "_%#jX_", ((
štmax_t
)0x1234ABC));

267 
	`TEST
("_1234_", "_%td_", ((
±rdiff_t
)1234));

268 
	`TEST
("_-1234_", "_%td_", ((
±rdiff_t
)-1234));

269 
	`TEST
("_1234_", "_%ti_", ((
±rdiff_t
)1234));

270 
	`TEST
("_-1234_", "_%ti_", ((
±rdiff_t
)-1234));

272 
	`TEST
("_-1234_", "_%zd_", ((
ssize_t
)-1234));

273 
	`TEST
("_1234_", "_%zd_", ((
ssize_t
)1234));

274 
	`TEST
("_-1234_", "_%zi_", ((
ssize_t
)-1234));

275 
	`TEST
("_1234_", "_%zi_", ((
ssize_t
)1234));

276 
	`TEST
("_01234_", "_%#zo_", ((
ssize_t
)01234));

277 
	`TEST
("_1234_", "_%zu_", ((
ssize_t
)1234));

278 
	`TEST
("_0x1234abc_", "_%#zx_", ((
ssize_t
)0x1234abc));

279 
	`TEST
("_0X1234ABC_", "_%#zX_", ((
ssize_t
)0x1234ABC));

280 #undeà
BUFLEN


281 
	}
}

282 
TEST_END


285 
	$maš
()

288  (
	`‹¡
(

289 
‹¡_pow2_û
,

290 
‹¡_m®loc_¡¹oumax_no_’d±r
,

291 
‹¡_m®loc_¡¹oumax
,

292 
‹¡_m®loc_¢´štf_Œunÿ‹d
,

293 
‹¡_m®loc_¢´štf
));

294 
	}
}

	@deps/jemalloc/test/unit/zero.c

1 
	~"‹¡/jem®loc_‹¡.h
"

3 #ifdeà
JEMALLOC_FILL


4 cÚ¡ *
	gm®loc_cÚf
 =

9 
	$‹¡_z”o
(
size_t
 
sz_mš
, size_ˆ
sz_max
)

11 *
s
;

12 
size_t
 
sz_´ev
, 
sz
, 
i
;

14 
sz_´ev
 = 0;

15 
s
 = (*)
	`m®locx
(
sz_mš
, 0);

16 
	`as£¹_±r_nÙ_nuÎ
((*)
s
, "Unexpected mallocx() failure");

18 
sz
 = 
	`§Îocx
(
s
, 0); sz <ğ
sz_max
;

19 
sz_´ev
 = 
sz
, sz = 
	`§Îocx
(
s
, 0)) {

20 ià(
sz_´ev
 > 0) {

21 
	`as£¹_c_eq
(
s
[0], 'a',

23 
	`ZU
(0), 
sz_´ev
);

24 
	`as£¹_c_eq
(
s
[
sz_´ev
-1], 'a',

26 
sz_´ev
-1, sz_prev);

29 
i
 = 
sz_´ev
; i < 
sz
; i++) {

30 
	`as£¹_c_eq
(
s
[
i
], 0x0,

32 
i
, 
sz
);

33 
s
[
i
] = 'a';

36 ià(
	`x®locx
(
s
, 
sz
+1, 0, 0) == sz) {

37 
s
 = (*)
	`¿Îocx
(s, 
sz
+1, 0);

38 
	`as£¹_±r_nÙ_nuÎ
((*)
s
,

43 
	`d®locx
(
s
, 0);

44 
	}
}

46 
	$TEST_BEGIN
(
‹¡_z”o_sm®l
)

49 
	`‹¡_sk_if
(!
cÚfig_fl
);

50 
	`‹¡_z”o
(1, 
SMALL_MAXCLASS
-1);

51 
	}
}

52 
TEST_END


54 
	$TEST_BEGIN
(
‹¡_z”o_Ïrge
)

57 
	`‹¡_sk_if
(!
cÚfig_fl
);

58 
	`‹¡_z”o
(
SMALL_MAXCLASS
+1, 
Ïrge_maxşass
);

59 
	}
}

60 
TEST_END


62 
	$TEST_BEGIN
(
‹¡_z”o_huge
)

65 
	`‹¡_sk_if
(!
cÚfig_fl
);

66 
	`‹¡_z”o
(
Ïrge_maxşass
+1, 
chunksize
*2);

67 
	}
}

68 
TEST_END


71 
	$maš
()

74  (
	`‹¡
(

75 
‹¡_z”o_sm®l
,

76 
‹¡_z”o_Ïrge
,

77 
‹¡_z”o_huge
));

78 
	}
}

	@deps/linenoise/example.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~"lš’oi£.h
"

7 
	$com¶‘iÚ
(cÚ¡ *
buf
, 
lš’oi£Com¶‘iÚs
 *
lc
) {

8 ià(
buf
[0] == 'h') {

9 
	`lš’oi£AddCom¶‘iÚ
(
lc
,"hello");

10 
	`lš’oi£AddCom¶‘iÚ
(
lc
,"hellohere");

12 
	}
}

14 *
	$hšts
(cÚ¡ *
buf
, *
cŞÜ
, *
bŞd
) {

15 ià(!
	`¡rÿ£cmp
(
buf
,"hello")) {

16 *
cŞÜ
 = 35;

17 *
bŞd
 = 0;

20  
NULL
;

21 
	}
}

23 
	$maš
(
¬gc
, **
¬gv
) {

24 *
lše
;

25 *
´gÇme
 = 
¬gv
[0];

28 
¬gc
 > 1) {

29 
¬gc
--;

30 
¬gv
++;

31 ià(!
	`¡rcmp
(*
¬gv
,"--multiline")) {

32 
	`lš’oi£S‘MuÉiLše
(1);

33 
	`´štf
("Multi-line modeƒnabled.\n");

34 } ià(!
	`¡rcmp
(*
¬gv
,"--keycodes")) {

35 
	`lš’oi£PrštKeyCodes
();

36 
	`ex™
(0);

38 
	`årštf
(
¡d”r
, "U§ge: % [--muÉše] [--keycodes]\n", 
´gÇme
);

39 
	`ex™
(1);

45 
	`lš’oi£S‘Com¶‘iÚC®lback
(
com¶‘iÚ
);

46 
	`lš’oi£S‘HštsC®lback
(
hšts
);

50 
	`lš’oi£Hi¡ÜyLßd
("history.txt");

58 (
lše
 = 
	`lš’oi£
("h–lo> ")è!ğ
NULL
) {

60 ià(
lše
[0] != '\0' &&†ine[0] != '/') {

61 
	`´štf
("echo: '%s'\n", 
lše
);

62 
	`lš’oi£Hi¡ÜyAdd
(
lše
);

63 
	`lš’oi£Hi¡ÜySave
("history.txt");

64 } ià(!
	`¡ºcmp
(
lše
,"/historylen",11)) {

66 
Ën
 = 
	`©oi
(
lše
+11);

67 
	`lš’oi£Hi¡ÜyS‘MaxL’
(
Ën
);

68 } ià(
lše
[0] == '/') {

69 
	`´štf
("UÄecÚized commªd: %s\n", 
lše
);

71 
	`ä“
(
lše
);

74 
	}
}

	@deps/linenoise/linenoise.c

106 
	~<‹rmios.h
>

107 
	~<uni¡d.h
>

108 
	~<¡dlib.h
>

109 
	~<¡dio.h
>

110 
	~<”ºo.h
>

111 
	~<¡ršg.h
>

112 
	~<¡dlib.h
>

113 
	~<ùy³.h
>

114 
	~<sys/¡©.h
>

115 
	~<sys/ty³s.h
>

116 
	~<sys/ioùl.h
>

117 
	~<uni¡d.h
>

118 
	~"lš’oi£.h
"

120 
	#LINENOISE_DEFAULT_HISTORY_MAX_LEN
 100

	)

121 
	#LINENOISE_MAX_LINE
 4096

	)

122 *
	gunsuµÜ‹d_‹rm
[] = {"dumb","cÚs25","emacs",
NULL
};

123 
lš’oi£Com¶‘iÚC®lback
 *
	gcom¶‘iÚC®lback
 = 
NULL
;

124 
lš’oi£HštsC®lback
 *
	ghštsC®lback
 = 
NULL
;

125 
lš’oi£F»eHštsC®lback
 *
	gä“HštsC®lback
 = 
NULL
;

127 
‹rmios
 
	gÜig_‹rmios
;

128 
	g¿wmode
 = 0;

129 
	gmlmode
 = 0;

130 
	g©ex™_»gi¡”ed
 = 0;

131 
	ghi¡Üy_max_Ën
 = 
LINENOISE_DEFAULT_HISTORY_MAX_LEN
;

132 
	ghi¡Üy_Ën
 = 0;

133 **
	ghi¡Üy
 = 
NULL
;

138 
	slš’oi£S‹
 {

139 
	mifd
;

140 
	mofd
;

141 *
	mbuf
;

142 
size_t
 
	mbuæ’
;

143 cÚ¡ *
	m´om±
;

144 
size_t
 
	m¶’
;

145 
size_t
 
	mpos
;

146 
size_t
 
	mŞdpos
;

147 
size_t
 
	mËn
;

148 
size_t
 
	mcŞs
;

149 
size_t
 
	mmaxrows
;

150 
	mhi¡Üy_šdex
;

153 
	eKEY_ACTION
{

154 
	mKEY_NULL
 = 0,

155 
	mCTRL_A
 = 1,

156 
	mCTRL_B
 = 2,

157 
	mCTRL_C
 = 3,

158 
	mCTRL_D
 = 4,

159 
	mCTRL_E
 = 5,

160 
	mCTRL_F
 = 6,

161 
	mCTRL_H
 = 8,

162 
	mTAB
 = 9,

163 
	mCTRL_K
 = 11,

164 
	mCTRL_L
 = 12,

165 
	mENTER
 = 13,

166 
	mCTRL_N
 = 14,

167 
	mCTRL_P
 = 16,

168 
	mCTRL_T
 = 20,

169 
	mCTRL_U
 = 21,

170 
	mCTRL_W
 = 23,

171 
	mESC
 = 27,

172 
	mBACKSPACE
 = 127

175 
lš’oi£AtEx™
();

176 
lš’oi£Hi¡ÜyAdd
(cÚ¡ *
lše
);

177 
»äeshLše
(
lš’oi£S‹
 *
l
);

181 
FILE
 *
	gÊdebug_å
 = 
NULL
;

182 
	#Êdebug
(...) \

184 ià(
Êdebug_å
 =ğ
NULL
) { \

185 
Êdebug_å
 = 
	`fİ’
("/tmp/lndebug.txt","a"); \

186 
	`årštf
(
Êdebug_å
, \

188 ()
l
->
Ën
,(î->
pos
,(î->
Şdpos
,
¶’
,
rows
,
½os
, \

189 ()
l
->
maxrows
,
Şd_rows
); \

191 
	`årštf
(
Êdebug_å
, ", " 
__VA_ARGS__
); \

192 
	`fæush
(
Êdebug_å
); \

193 } 0)

	)

195 
	#Êdebug
(
fmt
, ...)

	)

201 
	$lš’oi£S‘MuÉiLše
(
ml
) {

202 
mlmode
 = 
ml
;

203 
	}
}

207 
	$isUnsuµÜ‹dT”m
() {

208 *
‹rm
 = 
	`g‘’v
("TERM");

209 
j
;

211 ià(
‹rm
 =ğ
NULL
)  0;

212 
j
 = 0; 
unsuµÜ‹d_‹rm
[j]; j++)

213 ià(!
	`¡rÿ£cmp
(
‹rm
,
unsuµÜ‹d_‹rm
[
j
]))  1;

215 
	}
}

218 
	$’abËRawMode
(
fd
) {

219 
‹rmios
 
¿w
;

221 ià(!
	`i§‰y
(
STDIN_FILENO
)è
çl
;

222 ià(!
©ex™_»gi¡”ed
) {

223 
	`©ex™
(
lš’oi£AtEx™
);

224 
©ex™_»gi¡”ed
 = 1;

226 ià(
	`tcg‘©Œ
(
fd
,&
Üig_‹rmios
è=ğ-1è
çl
;

228 
¿w
 = 
Üig_‹rmios
;

231 
¿w
.
c_iæag
 &ğ~(
BRKINT
 | 
ICRNL
 | 
INPCK
 | 
ISTRIP
 | 
IXON
);

233 
¿w
.
c_oæag
 &ğ~(
OPOST
);

235 
¿w
.
c_cæag
 |ğ(
CS8
);

238 
¿w
.
c_læag
 &ğ~(
ECHO
 | 
ICANON
 | 
IEXTEN
 | 
ISIG
);

241 
¿w
.
c_cc
[
VMIN
] = 1;„aw.c_cc[
VTIME
] = 0;

244 ià(
	`tc£‰r
(
fd
,
TCSAFLUSH
,&
¿w
è< 0è
çl
;

245 
¿wmode
 = 1;

248 
çl
:

249 
”ºo
 = 
ENOTTY
;

251 
	}
}

253 
	$di§bËRawMode
(
fd
) {

255 ià(
¿wmode
 && 
	`tc£‰r
(
fd
,
TCSAFLUSH
,&
Üig_‹rmios
) != -1)

256 
¿wmode
 = 0;

257 
	}
}

262 
	$g‘CursÜPos™iÚ
(
ifd
, 
ofd
) {

263 
buf
[32];

264 
cŞs
, 
rows
;

265 
i
 = 0;

268 ià(
	`wr™e
(
ofd
, "\x1b[6n", 4) != 4)  -1;

271 
i
 < (
buf
)-1) {

272 ià(
	`»ad
(
ifd
,
buf
+
i
,1) != 1) ;

273 ià(
buf
[
i
] == 'R') ;

274 
i
++;

276 
buf
[
i
] = '\0';

279 ià(
buf
[0] !ğ
ESC
 || buf[1] != '[')  -1;

280 ià(
	`ssÿnf
(
buf
+2,"%d;%d",&
rows
,&
cŞs
) != 2)  -1;

281  
cŞs
;

282 
	}
}

286 
	$g‘CŞumns
(
ifd
, 
ofd
) {

287 
wšsize
 
ws
;

289 ià(
	`ioùl
(1, 
TIOCGWINSZ
, &
ws
è=ğ-1 || ws.
ws_cŞ
 == 0) {

291 
¡¬t
, 
cŞs
;

294 
¡¬t
 = 
	`g‘CursÜPos™iÚ
(
ifd
,
ofd
);

295 ià(
¡¬t
 =ğ-1è
çed
;

298 ià(
	`wr™e
(
ofd
,"\x1b[999C",6è!ğ6è
çed
;

299 
cŞs
 = 
	`g‘CursÜPos™iÚ
(
ifd
,
ofd
);

300 ià(
cŞs
 =ğ-1è
çed
;

303 ià(
cŞs
 > 
¡¬t
) {

304 
£q
[32];

305 
	`¢´štf
(
£q
,32,"\x1b[%dD",
cŞs
-
¡¬t
);

306 ià(
	`wr™e
(
ofd
,
£q
,
	`¡¾’
(seq)) == -1) {

310  
cŞs
;

312  
ws
.
ws_cŞ
;

315 
çed
:

317 
	}
}

320 
	$lš’oi£CË¬Sü“n
() {

321 ià(
	`wr™e
(
STDOUT_FILENO
,"\x1b[H\x1b[2J",7) <= 0) {

324 
	}
}

328 
	$lš’oi£B“p
() {

329 
	`årštf
(
¡d”r
, "\x7");

330 
	`fæush
(
¡d”r
);

331 
	}
}

336 
	$ä“Com¶‘iÚs
(
lš’oi£Com¶‘iÚs
 *
lc
) {

337 
size_t
 
i
;

338 
i
 = 0; i < 
lc
->
Ën
; i++)

339 
	`ä“
(
lc
->
cvec
[
i
]);

340 ià(
lc
->
cvec
 !ğ
NULL
)

341 
	`ä“
(
lc
->
cvec
);

342 
	}
}

350 
	$com¶‘eLše
(
lš’oi£S‹
 *
ls
) {

351 
lš’oi£Com¶‘iÚs
 
lc
 = { 0, 
NULL
 };

352 
Ä—d
, 
nwr™‹n
;

353 
c
 = 0;

355 
	`com¶‘iÚC®lback
(
ls
->
buf
,&
lc
);

356 ià(
lc
.
Ën
 == 0) {

357 
	`lš’oi£B“p
();

359 
size_t
 
¡İ
 = 0, 
i
 = 0;

361 !
¡İ
) {

363 ià(
i
 < 
lc
.
Ën
) {

364 
lš’oi£S‹
 
§ved
 = *
ls
;

366 
ls
->
Ën
 =†s->
pos
 = 
	`¡¾’
(
lc
.
cvec
[
i
]);

367 
ls
->
buf
 = 
lc
.
cvec
[
i
];

368 
	`»äeshLše
(
ls
);

369 
ls
->
Ën
 = 
§ved
.len;

370 
ls
->
pos
 = 
§ved
.pos;

371 
ls
->
buf
 = 
§ved
.buf;

373 
	`»äeshLše
(
ls
);

376 
Ä—d
 = 
	`»ad
(
ls
->
ifd
,&
c
,1);

377 ià(
Ä—d
 <= 0) {

378 
	`ä“Com¶‘iÚs
(&
lc
);

382 
c
) {

384 
i
 = (i+1è% (
lc
.
Ën
+1);

385 ià(
i
 =ğ
lc
.
Ën
è
	`lš’oi£B“p
();

389 ià(
i
 < 
lc
.
Ën
è
	`»äeshLše
(
ls
);

390 
¡İ
 = 1;

394 ià(
i
 < 
lc
.
Ën
) {

395 
nwr™‹n
 = 
	`¢´štf
(
ls
->
buf
,ls->
buæ’
,"%s",
lc
.
cvec
[
i
]);

396 
ls
->
Ën
 =†s->
pos
 = 
nwr™‹n
;

398 
¡İ
 = 1;

404 
	`ä“Com¶‘iÚs
(&
lc
);

405  
c
;

406 
	}
}

409 
	$lš’oi£S‘Com¶‘iÚC®lback
(
lš’oi£Com¶‘iÚC®lback
 *
â
) {

410 
com¶‘iÚC®lback
 = 
â
;

411 
	}
}

415 
	$lš’oi£S‘HštsC®lback
(
lš’oi£HštsC®lback
 *
â
) {

416 
hštsC®lback
 = 
â
;

417 
	}
}

421 
	$lš’oi£S‘F»eHštsC®lback
(
lš’oi£F»eHštsC®lback
 *
â
) {

422 
ä“HštsC®lback
 = 
â
;

423 
	}
}

429 
	$lš’oi£AddCom¶‘iÚ
(
lš’oi£Com¶‘iÚs
 *
lc
, cÚ¡ *
¡r
) {

430 
size_t
 
Ën
 = 
	`¡¾’
(
¡r
);

431 *
cİy
, **
cvec
;

433 
cİy
 = 
	`m®loc
(
Ën
+1);

434 ià(
cİy
 =ğ
NULL
) ;

435 
	`memıy
(
cİy
,
¡r
,
Ën
+1);

436 
cvec
 = 
	`»®loc
(
lc
->cvec,(*)*Öc->
Ën
+1));

437 ià(
cvec
 =ğ
NULL
) {

438 
	`ä“
(
cİy
);

441 
lc
->
cvec
 = cvec;

442 
lc
->
cvec
[lc->
Ën
++] = 
cİy
;

443 
	}
}

451 
	sabuf
 {

452 *
	mb
;

453 
	mËn
;

456 
	$abIn™
(
abuf
 *
ab
) {

457 
ab
->
b
 = 
NULL
;

458 
ab
->
Ën
 = 0;

459 
	}
}

461 
	$abAµ’d
(
abuf
 *
ab
, cÚ¡ *
s
, 
Ën
) {

462 *
Ãw
 = 
	`»®loc
(
ab
->
b
,ab->
Ën
+len);

464 ià(
Ãw
 =ğ
NULL
) ;

465 
	`memıy
(
Ãw
+
ab
->
Ën
,
s
,len);

466 
ab
->
b
 = 
Ãw
;

467 
ab
->
Ën
 +=†en;

468 
	}
}

470 
	$abF»e
(
abuf
 *
ab
) {

471 
	`ä“
(
ab
->
b
);

472 
	}
}

476 
	$»äeshShowHšts
(
abuf
 *
ab
, 
lš’oi£S‹
 *
l
, 
¶’
) {

477 
£q
[64];

478 ià(
hštsC®lback
 && 
¶’
+
l
->
Ën
 <†->
cŞs
) {

479 
cŞÜ
 = -1, 
bŞd
 = 0;

480 *
hšt
 = 
	`hštsC®lback
(
l
->
buf
,&
cŞÜ
,&
bŞd
);

481 ià(
hšt
) {

482 
hš’
 = 
	`¡¾’
(
hšt
);

483 
hštmaxËn
 = 
l
->
cŞs
-(
¶’
+l->
Ën
);

484 ià(
hš’
 > 
hštmaxËn
) hintlen = hintmaxlen;

485 ià(
bŞd
 =ğ1 && 
cŞÜ
 == -1) color = 37;

486 ià(
cŞÜ
 !ğ-1 || 
bŞd
 != 0)

487 
	`¢´štf
(
£q
,64,"\033[%d;%d;49m",
bŞd
,
cŞÜ
);

488 
	`abAµ’d
(
ab
,
£q
,
	`¡¾’
(seq));

489 
	`abAµ’d
(
ab
,
hšt
,
hš’
);

490 ià(
cŞÜ
 !ğ-1 || 
bŞd
 != 0)

491 
	`abAµ’d
(
ab
,"\033[0m",4);

493 ià(
ä“HštsC®lback
è
	`ä“HštsC®lback
(
hšt
);

496 
	}
}

502 
	$»äeshSšgËLše
(
lš’oi£S‹
 *
l
) {

503 
£q
[64];

504 
size_t
 
¶’
 = 
	`¡¾’
(
l
->
´om±
);

505 
fd
 = 
l
->
ofd
;

506 *
buf
 = 
l
->buf;

507 
size_t
 
Ën
 = 
l
->len;

508 
size_t
 
pos
 = 
l
->pos;

509 
abuf
 
ab
;

511 (
¶’
+
pos
è>ğ
l
->
cŞs
) {

512 
buf
++;

513 
Ën
--;

514 
pos
--;

516 
¶’
+
Ën
 > 
l
->
cŞs
) {

517 
Ën
--;

520 
	`abIn™
(&
ab
);

522 
	`¢´štf
(
£q
,64,"\r");

523 
	`abAµ’d
(&
ab
,
£q
,
	`¡¾’
(seq));

525 
	`abAµ’d
(&
ab
,
l
->
´om±
,
	`¡¾’
(l->prompt));

526 
	`abAµ’d
(&
ab
,
buf
,
Ën
);

528 
	`»äeshShowHšts
(&
ab
,
l
,
¶’
);

530 
	`¢´štf
(
£q
,64,"\x1b[0K");

531 
	`abAµ’d
(&
ab
,
£q
,
	`¡¾’
(seq));

533 
	`¢´štf
(
£q
,64,"\r\x1b[%dC", ()(
pos
+
¶’
));

534 
	`abAµ’d
(&
ab
,
£q
,
	`¡¾’
(seq));

535 ià(
	`wr™e
(
fd
,
ab
.
b
,ab.
Ën
) == -1) {}

536 
	`abF»e
(&
ab
);

537 
	}
}

543 
	$»äeshMuÉiLše
(
lš’oi£S‹
 *
l
) {

544 
£q
[64];

545 
¶’
 = 
	`¡¾’
(
l
->
´om±
);

546 
rows
 = (
¶’
+
l
->
Ën
+l->
cŞs
-1)/l->cols;

547 
½os
 = (
¶’
+
l
->
Şdpos
+l->
cŞs
)/l->cols;

548 
½os2
;

549 
cŞ
;

550 
Şd_rows
 = 
l
->
maxrows
;

551 
fd
 = 
l
->
ofd
, 
j
;

552 
abuf
 
ab
;

555 ià(
rows
 > ()
l
->
maxrows
)†->maxrows =„ows;

559 
	`abIn™
(&
ab
);

560 ià(
Şd_rows
-
½os
 > 0) {

561 
	`Êdebug
("gØdowÀ%d", 
Şd_rows
-
½os
);

562 
	`¢´štf
(
£q
,64,"\x1b[%dB", 
Şd_rows
-
½os
);

563 
	`abAµ’d
(&
ab
,
£q
,
	`¡¾’
(seq));

567 
j
 = 0; j < 
Şd_rows
-1; j++) {

568 
	`Êdebug
("clear+up");

569 
	`¢´štf
(
£q
,64,"\r\x1b[0K\x1b[1A");

570 
	`abAµ’d
(&
ab
,
£q
,
	`¡¾’
(seq));

574 
	`Êdebug
("clear");

575 
	`¢´štf
(
£q
,64,"\r\x1b[0K");

576 
	`abAµ’d
(&
ab
,
£q
,
	`¡¾’
(seq));

579 
	`abAµ’d
(&
ab
,
l
->
´om±
,
	`¡¾’
(l->prompt));

580 
	`abAµ’d
(&
ab
,
l
->
buf
,l->
Ën
);

583 
	`»äeshShowHšts
(&
ab
,
l
,
¶’
);

587 ià(
l
->
pos
 &&

588 
l
->
pos
 =ğl->
Ën
 &&

589 (
l
->
pos
+
¶’
è%†->
cŞs
 == 0)

591 
	`Êdebug
("<newline>");

592 
	`abAµ’d
(&
ab
,"\n",1);

593 
	`¢´štf
(
£q
,64,"\r");

594 
	`abAµ’d
(&
ab
,
£q
,
	`¡¾’
(seq));

595 
rows
++;

596 ià(
rows
 > ()
l
->
maxrows
)†->maxrows =„ows;

600 
½os2
 = (
¶’
+
l
->
pos
+l->
cŞs
)/l->cols;

601 
	`Êdebug
("½os2 %d", 
½os2
);

604 ià(
rows
-
½os2
 > 0) {

605 
	`Êdebug
("go-u°%d", 
rows
-
½os2
);

606 
	`¢´štf
(
£q
,64,"\x1b[%dA", 
rows
-
½os2
);

607 
	`abAµ’d
(&
ab
,
£q
,
	`¡¾’
(seq));

611 
cŞ
 = (
¶’
+()
l
->
pos
è% (î->
cŞs
;

612 
	`Êdebug
("£ˆcŞ %d", 1+
cŞ
);

613 ià(
cŞ
)

614 
	`¢´štf
(
£q
,64,"\r\x1b[%dC", 
cŞ
);

616 
	`¢´štf
(
£q
,64,"\r");

617 
	`abAµ’d
(&
ab
,
£q
,
	`¡¾’
(seq));

619 
	`Êdebug
("\n");

620 
l
->
Şdpos
 =†->
pos
;

622 ià(
	`wr™e
(
fd
,
ab
.
b
,ab.
Ën
) == -1) {}

623 
	`abF»e
(&
ab
);

624 
	}
}

628 
	$»äeshLše
(
lš’oi£S‹
 *
l
) {

629 ià(
mlmode
)

630 
	`»äeshMuÉiLše
(
l
);

632 
	`»äeshSšgËLše
(
l
);

633 
	}
}

638 
	$lš’oi£Ed™In£¹
(
lš’oi£S‹
 *
l
, 
c
) {

639 ià(
l
->
Ën
 <†->
buæ’
) {

640 ià(
l
->
Ën
 =ğl->
pos
) {

641 
l
->
buf
[l->
pos
] = 
c
;

642 
l
->
pos
++;

643 
l
->
Ën
++;

644 
l
->
buf
[l->
Ën
] = '\0';

645 ià((!
mlmode
 && 
l
->
¶’
+l->
Ën
 <†->
cŞs
 && !
hštsC®lback
)) {

648 ià(
	`wr™e
(
l
->
ofd
,&
c
,1) == -1)  -1;

650 
	`»äeshLše
(
l
);

653 
	`memmove
(
l
->
buf
+l->
pos
+1,l->buf+l->pos,l->
Ën
-l->pos);

654 
l
->
buf
[l->
pos
] = 
c
;

655 
l
->
Ën
++;

656 
l
->
pos
++;

657 
l
->
buf
[l->
Ën
] = '\0';

658 
	`»äeshLše
(
l
);

662 
	}
}

665 
	$lš’oi£Ed™MoveLeá
(
lš’oi£S‹
 *
l
) {

666 ià(
l
->
pos
 > 0) {

667 
l
->
pos
--;

668 
	`»äeshLše
(
l
);

670 
	}
}

673 
	$lš’oi£Ed™MoveRight
(
lš’oi£S‹
 *
l
) {

674 ià(
l
->
pos
 !ğl->
Ën
) {

675 
l
->
pos
++;

676 
	`»äeshLše
(
l
);

678 
	}
}

681 
	$lš’oi£Ed™MoveHome
(
lš’oi£S‹
 *
l
) {

682 ià(
l
->
pos
 != 0) {

683 
l
->
pos
 = 0;

684 
	`»äeshLše
(
l
);

686 
	}
}

689 
	$lš’oi£Ed™MoveEnd
(
lš’oi£S‹
 *
l
) {

690 ià(
l
->
pos
 !ğl->
Ën
) {

691 
l
->
pos
 =†->
Ën
;

692 
	`»äeshLše
(
l
);

694 
	}
}

698 
	#LINENOISE_HISTORY_NEXT
 0

	)

699 
	#LINENOISE_HISTORY_PREV
 1

	)

700 
	$lš’oi£Ed™Hi¡ÜyNext
(
lš’oi£S‹
 *
l
, 
dœ
) {

701 ià(
hi¡Üy_Ën
 > 1) {

704 
	`ä“
(
hi¡Üy
[
hi¡Üy_Ën
 - 1 - 
l
->
hi¡Üy_šdex
]);

705 
hi¡Üy
[
hi¡Üy_Ën
 - 1 - 
l
->
hi¡Üy_šdex
] = 
	`¡rdup
Ö->
buf
);

707 
l
->
hi¡Üy_šdex
 +ğ(
dœ
 =ğ
LINENOISE_HISTORY_PREV
) ? 1 : -1;

708 ià(
l
->
hi¡Üy_šdex
 < 0) {

709 
l
->
hi¡Üy_šdex
 = 0;

711 } ià(
l
->
hi¡Üy_šdex
 >ğ
hi¡Üy_Ën
) {

712 
l
->
hi¡Üy_šdex
 = 
hi¡Üy_Ën
-1;

715 
	`¡ºıy
(
l
->
buf
,
hi¡Üy
[
hi¡Üy_Ën
 - 1 -†->
hi¡Üy_šdex
],l->
buæ’
);

716 
l
->
buf
[l->
buæ’
-1] = '\0';

717 
l
->
Ën
 =†->
pos
 = 
	`¡¾’
Ö->
buf
);

718 
	`»äeshLše
(
l
);

720 
	}
}

724 
	$lš’oi£Ed™D–‘e
(
lš’oi£S‹
 *
l
) {

725 ià(
l
->
Ën
 > 0 &&†->
pos
 <†->len) {

726 
	`memmove
(
l
->
buf
+l->
pos
,l->buf+l->pos+1,l->
Ën
-l->pos-1);

727 
l
->
Ën
--;

728 
l
->
buf
[l->
Ën
] = '\0';

729 
	`»äeshLše
(
l
);

731 
	}
}

734 
	$lš’oi£Ed™Back¥aû
(
lš’oi£S‹
 *
l
) {

735 ià(
l
->
pos
 > 0 &&†->
Ën
 > 0) {

736 
	`memmove
(
l
->
buf
+l->
pos
-1,l->buf+l->pos,l->
Ën
-l->pos);

737 
l
->
pos
--;

738 
l
->
Ën
--;

739 
l
->
buf
[l->
Ën
] = '\0';

740 
	`»äeshLše
(
l
);

742 
	}
}

746 
	$lš’oi£Ed™D–‘eP»vWÜd
(
lš’oi£S‹
 *
l
) {

747 
size_t
 
Şd_pos
 = 
l
->
pos
;

748 
size_t
 
diff
;

750 
l
->
pos
 > 0 &&†->
buf
[l->pos-1] == ' ')

751 
l
->
pos
--;

752 
l
->
pos
 > 0 &&†->
buf
[l->pos-1] != ' ')

753 
l
->
pos
--;

754 
diff
 = 
Şd_pos
 - 
l
->
pos
;

755 
	`memmove
(
l
->
buf
+l->
pos
,l->buf+
Şd_pos
,l->
Ën
-old_pos+1);

756 
l
->
Ën
 -ğ
diff
;

757 
	`»äeshLše
(
l
);

758 
	}
}

768 
	$lš’oi£Ed™
(
¡dš_fd
, 
¡dout_fd
, *
buf
, 
size_t
 
buæ’
, cÚ¡ *
´om±
)

770 
lš’oi£S‹
 
l
;

774 
l
.
ifd
 = 
¡dš_fd
;

775 
l
.
ofd
 = 
¡dout_fd
;

776 
l
.
buf
 = buf;

777 
l
.
buæ’
 = buflen;

778 
l
.
´om±
 =…rompt;

779 
l
.
¶’
 = 
	`¡¾’
(
´om±
);

780 
l
.
Şdpos
 =†.
pos
 = 0;

781 
l
.
Ën
 = 0;

782 
l
.
cŞs
 = 
	`g‘CŞumns
(
¡dš_fd
, 
¡dout_fd
);

783 
l
.
maxrows
 = 0;

784 
l
.
hi¡Üy_šdex
 = 0;

787 
l
.
buf
[0] = '\0';

788 
l
.
buæ’
--;

792 
	`lš’oi£Hi¡ÜyAdd
("");

794 ià(
	`wr™e
(
l
.
ofd
,
´om±
,l.
¶’
) == -1)  -1;

796 
c
;

797 
Ä—d
;

798 
£q
[3];

800 
Ä—d
 = 
	`»ad
(
l
.
ifd
,&
c
,1);

801 ià(
Ä—d
 <ğ0è 
l
.
Ën
;

806 ià(
c
 =ğ9 && 
com¶‘iÚC®lback
 !ğ
NULL
) {

807 
c
 = 
	`com¶‘eLše
(&
l
);

809 ià(
c
 < 0è 
l
.
Ën
;

811 ià(
c
 == 0) ;

814 
c
) {

815 
ENTER
:

816 
hi¡Üy_Ën
--;

817 
	`ä“
(
hi¡Üy
[
hi¡Üy_Ën
]);

818 ià(
mlmode
è
	`lš’oi£Ed™MoveEnd
(&
l
);

819 ià(
hštsC®lback
) {

822 
lš’oi£HštsC®lback
 *
hc
 = 
hštsC®lback
;

823 
hštsC®lback
 = 
NULL
;

824 
	`»äeshLše
(&
l
);

825 
hštsC®lback
 = 
hc
;

827  ()
l
.
Ën
;

828 
CTRL_C
:

829 
”ºo
 = 
EAGAIN
;

831 
BACKSPACE
:

833 
	`lš’oi£Ed™Back¥aû
(&
l
);

835 
CTRL_D
:

837 ià(
l
.
Ën
 > 0) {

838 
	`lš’oi£Ed™D–‘e
(&
l
);

840 
hi¡Üy_Ën
--;

841 
	`ä“
(
hi¡Üy
[
hi¡Üy_Ën
]);

845 
CTRL_T
:

846 ià(
l
.
pos
 > 0 &&†.po <†.
Ën
) {

847 
aux
 = 
buf
[
l
.
pos
-1];

848 
buf
[
l
.
pos
-1] = buf[l.pos];

849 
buf
[
l
.
pos
] = 
aux
;

850 ià(
l
.
pos
 !ğl.
Ën
-1)†.pos++;

851 
	`»äeshLše
(&
l
);

854 
CTRL_B
:

855 
	`lš’oi£Ed™MoveLeá
(&
l
);

857 
CTRL_F
:

858 
	`lš’oi£Ed™MoveRight
(&
l
);

860 
CTRL_P
:

861 
	`lš’oi£Ed™Hi¡ÜyNext
(&
l
, 
LINENOISE_HISTORY_PREV
);

863 
CTRL_N
:

864 
	`lš’oi£Ed™Hi¡ÜyNext
(&
l
, 
LINENOISE_HISTORY_NEXT
);

866 
ESC
:

870 ià(
	`»ad
(
l
.
ifd
,
£q
,1) == -1) ;

871 ià(
	`»ad
(
l
.
ifd
,
£q
+1,1) == -1) ;

874 ià(
£q
[0] == '[') {

875 ià(
£q
[1] >= '0' && seq[1] <= '9') {

877 ià(
	`»ad
(
l
.
ifd
,
£q
+2,1) == -1) ;

878 ià(
£q
[2] == '~') {

879 
£q
[1]) {

881 
	`lš’oi£Ed™D–‘e
(&
l
);

886 
£q
[1]) {

888 
	`lš’oi£Ed™Hi¡ÜyNext
(&
l
, 
LINENOISE_HISTORY_PREV
);

891 
	`lš’oi£Ed™Hi¡ÜyNext
(&
l
, 
LINENOISE_HISTORY_NEXT
);

894 
	`lš’oi£Ed™MoveRight
(&
l
);

897 
	`lš’oi£Ed™MoveLeá
(&
l
);

900 
	`lš’oi£Ed™MoveHome
(&
l
);

903 
	`lš’oi£Ed™MoveEnd
(&
l
);

910 ià(
£q
[0] == 'O') {

911 
£q
[1]) {

913 
	`lš’oi£Ed™MoveHome
(&
l
);

916 
	`lš’oi£Ed™MoveEnd
(&
l
);

922 ià(
	`lš’oi£Ed™In£¹
(&
l
,
c
))  -1;

924 
CTRL_U
:

925 
buf
[0] = '\0';

926 
l
.
pos
 =†.
Ën
 = 0;

927 
	`»äeshLše
(&
l
);

929 
CTRL_K
:

930 
buf
[
l
.
pos
] = '\0';

931 
l
.
Ën
 =†.
pos
;

932 
	`»äeshLše
(&
l
);

934 
CTRL_A
:

935 
	`lš’oi£Ed™MoveHome
(&
l
);

937 
CTRL_E
:

938 
	`lš’oi£Ed™MoveEnd
(&
l
);

940 
CTRL_L
:

941 
	`lš’oi£CË¬Sü“n
();

942 
	`»äeshLše
(&
l
);

944 
CTRL_W
:

945 
	`lš’oi£Ed™D–‘eP»vWÜd
(&
l
);

949  
l
.
Ën
;

950 
	}
}

955 
	$lš’oi£PrštKeyCodes
() {

956 
qu™
[4];

958 
	`´štf
("Linenoise key codes debugging mode.\n"

960 ià(
	`’abËRawMode
(
STDIN_FILENO
) == -1) ;

961 
	`mem£t
(
qu™
,' ',4);

963 
c
;

964 
Ä—d
;

966 
Ä—d
 = 
	`»ad
(
STDIN_FILENO
,&
c
,1);

967 ià(
Ä—d
 <= 0) ;

968 
	`memmove
(
qu™
,quit+1,(quit)-1);

969 
qu™
[(qu™)-1] = 
c
;

970 ià(
	`memcmp
(
qu™
,"quit",(quit)) == 0) ;

972 
	`´štf
("'%c' %02x (%d) (type quitoƒxit)\n",

973 
	`i¥ršt
(
c
) ? c : '?', ()c, ()c);

974 
	`´štf
("\r");

975 
	`fæush
(
¡dout
);

977 
	`di§bËRawMode
(
STDIN_FILENO
);

978 
	}
}

982 
	$lš’oi£Raw
(*
buf
, 
size_t
 
buæ’
, cÚ¡ *
´om±
) {

983 
couÁ
;

985 ià(
buæ’
 == 0) {

986 
”ºo
 = 
EINVAL
;

990 ià(
	`’abËRawMode
(
STDIN_FILENO
) == -1)  -1;

991 
couÁ
 = 
	`lš’oi£Ed™
(
STDIN_FILENO
, 
STDOUT_FILENO
, 
buf
, 
buæ’
, 
´om±
);

992 
	`di§bËRawMode
(
STDIN_FILENO
);

993 
	`´štf
("\n");

994  
couÁ
;

995 
	}
}

1002 *
	$lš’oi£NoTTY
() {

1003 *
lše
 = 
NULL
;

1004 
size_t
 
Ën
 = 0, 
maxËn
 = 0;

1007 ià(
Ën
 =ğ
maxËn
) {

1008 ià(
maxËn
 == 0) maxlen = 16;

1009 
maxËn
 *= 2;

1010 *
Şdv®
 = 
lše
;

1011 
lše
 = 
	`»®loc
Öše,
maxËn
);

1012 ià(
lše
 =ğ
NULL
) {

1013 ià(
Şdv®
è
	`ä“
(oldval);

1014  
NULL
;

1017 
c
 = 
	`fg‘c
(
¡dš
);

1018 ià(
c
 =ğ
EOF
 || c == '\n') {

1019 ià(
c
 =ğ
EOF
 && 
Ën
 == 0) {

1020 
	`ä“
(
lše
);

1021  
NULL
;

1023 
lše
[
Ën
] = '\0';

1024  
lše
;

1027 
lše
[
Ën
] = 
c
;

1028 
Ën
++;

1031 
	}
}

1038 *
	$lš’oi£
(cÚ¡ *
´om±
) {

1039 
buf
[
LINENOISE_MAX_LINE
];

1040 
couÁ
;

1042 ià(!
	`i§‰y
(
STDIN_FILENO
)) {

1045  
	`lš’oi£NoTTY
();

1046 } ià(
	`isUnsuµÜ‹dT”m
()) {

1047 
size_t
 
Ën
;

1049 
	`´štf
("%s",
´om±
);

1050 
	`fæush
(
¡dout
);

1051 ià(
	`fg‘s
(
buf
,
LINENOISE_MAX_LINE
,
¡dš
è=ğ
NULL
)  NULL;

1052 
Ën
 = 
	`¡¾’
(
buf
);

1053 
Ën
 && (
buf
[len-1] == '\n' || buf[len-1] == '\r')) {

1054 
Ën
--;

1055 
buf
[
Ën
] = '\0';

1057  
	`¡rdup
(
buf
);

1059 
couÁ
 = 
	`lš’oi£Raw
(
buf
,
LINENOISE_MAX_LINE
,
´om±
);

1060 ià(
couÁ
 =ğ-1è 
NULL
;

1061  
	`¡rdup
(
buf
);

1063 
	}
}

1069 
	$lš’oi£F»e
(*
±r
) {

1070 
	`ä“
(
±r
);

1071 
	}
}

1077 
	$ä“Hi¡Üy
() {

1078 ià(
hi¡Üy
) {

1079 
j
;

1081 
j
 = 0; j < 
hi¡Üy_Ën
; j++)

1082 
	`ä“
(
hi¡Üy
[
j
]);

1083 
	`ä“
(
hi¡Üy
);

1085 
	}
}

1088 
	$lš’oi£AtEx™
() {

1089 
	`di§bËRawMode
(
STDIN_FILENO
);

1090 
	`ä“Hi¡Üy
();

1091 
	}
}

1100 
	$lš’oi£Hi¡ÜyAdd
(cÚ¡ *
lše
) {

1101 *
lšecİy
;

1103 ià(
hi¡Üy_max_Ën
 == 0)  0;

1106 ià(
hi¡Üy
 =ğ
NULL
) {

1107 
hi¡Üy
 = 
	`m®loc
((*)*
hi¡Üy_max_Ën
);

1108 ià(
hi¡Üy
 =ğ
NULL
)  0;

1109 
	`mem£t
(
hi¡Üy
,0,((*)*
hi¡Üy_max_Ën
));

1113 ià(
hi¡Üy_Ën
 && !
	`¡rcmp
(
hi¡Üy
[hi¡Üy_Ën-1], 
lše
))  0;

1117 
lšecİy
 = 
	`¡rdup
(
lše
);

1118 ià(!
lšecİy
)  0;

1119 ià(
hi¡Üy_Ën
 =ğ
hi¡Üy_max_Ën
) {

1120 
	`ä“
(
hi¡Üy
[0]);

1121 
	`memmove
(
hi¡Üy
,hi¡Üy+1,(*)*(
hi¡Üy_max_Ën
-1));

1122 
hi¡Üy_Ën
--;

1124 
hi¡Üy
[
hi¡Üy_Ën
] = 
lšecİy
;

1125 
hi¡Üy_Ën
++;

1127 
	}
}

1133 
	$lš’oi£Hi¡ÜyS‘MaxL’
(
Ën
) {

1134 **
Ãw
;

1136 ià(
Ën
 < 1)  0;

1137 ià(
hi¡Üy
) {

1138 
tocİy
 = 
hi¡Üy_Ën
;

1140 
Ãw
 = 
	`m®loc
((*)*
Ën
);

1141 ià(
Ãw
 =ğ
NULL
)  0;

1144 ià(
Ën
 < 
tocİy
) {

1145 
j
;

1147 
j
 = 0; j < 
tocİy
-
Ën
; j++è
	`ä“
(
hi¡Üy
[j]);

1148 
tocİy
 = 
Ën
;

1150 
	`mem£t
(
Ãw
,0,(*)*
Ën
);

1151 
	`memıy
(
Ãw
,
hi¡Üy
+(
hi¡Üy_Ën
-
tocİy
), (*)*tocopy);

1152 
	`ä“
(
hi¡Üy
);

1153 
hi¡Üy
 = 
Ãw
;

1155 
hi¡Üy_max_Ën
 = 
Ën
;

1156 ià(
hi¡Üy_Ën
 > 
hi¡Üy_max_Ën
)

1157 
hi¡Üy_Ën
 = 
hi¡Üy_max_Ën
;

1159 
	}
}

1163 
	$lš’oi£Hi¡ÜySave
(cÚ¡ *
f’ame
) {

1164 
mode_t
 
Şd_umask
 = 
	`umask
(
S_IXUSR
|
S_IRWXG
|
S_IRWXO
);

1165 
FILE
 *
å
;

1166 
j
;

1168 
å
 = 
	`fİ’
(
f’ame
,"w");

1169 
	`umask
(
Şd_umask
);

1170 ià(
å
 =ğ
NULL
)  -1;

1171 
	`chmod
(
f’ame
,
S_IRUSR
|
S_IWUSR
);

1172 
j
 = 0; j < 
hi¡Üy_Ën
; j++)

1173 
	`årštf
(
å
,"%s\n",
hi¡Üy
[
j
]);

1174 
	`fşo£
(
å
);

1176 
	}
}

1183 
	$lš’oi£Hi¡ÜyLßd
(cÚ¡ *
f’ame
) {

1184 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r");

1185 
buf
[
LINENOISE_MAX_LINE
];

1187 ià(
å
 =ğ
NULL
)  -1;

1189 
	`fg‘s
(
buf
,
LINENOISE_MAX_LINE
,
å
è!ğ
NULL
) {

1190 *
p
;

1192 
p
 = 
	`¡rchr
(
buf
,'\r');

1193 ià(!
p
è°ğ
	`¡rchr
(
buf
,'\n');

1194 ià(
p
) *p = '\0';

1195 
	`lš’oi£Hi¡ÜyAdd
(
buf
);

1197 
	`fşo£
(
å
);

1199 
	}
}

	@deps/linenoise/linenoise.h

39 #iâdeà
__LINENOISE_H


40 
	#__LINENOISE_H


	)

42 #ifdeà
__ılu¥lus


46 
	slš’oi£Com¶‘iÚs
 {

47 
size_t
 
Ën
;

48 **
cvec
;

49 } 
	tlš’oi£Com¶‘iÚs
;

51 (
lš’oi£Com¶‘iÚC®lback
)(cÚ¡ *, 
	tlš’oi£Com¶‘iÚs
 *);

52 *(
	tlš’oi£HštsC®lback
)(cÚ¡ *, *
	tcŞÜ
, *
	tbŞd
);

53 (
lš’oi£F»eHštsC®lback
)(*);

54 
lš’oi£S‘Com¶‘iÚC®lback
(
lš’oi£Com¶‘iÚC®lback
 *);

55 
lš’oi£S‘HštsC®lback
(
lš’oi£HštsC®lback
 *);

56 
lš’oi£S‘F»eHštsC®lback
(
lš’oi£F»eHštsC®lback
 *);

57 
lš’oi£AddCom¶‘iÚ
(
lš’oi£Com¶‘iÚs
 *, const *);

59 *
lš’oi£
(cÚ¡ *
´om±
);

60 
lš’oi£F»e
(*
±r
);

61 
lš’oi£Hi¡ÜyAdd
(cÚ¡ *
lše
);

62 
lš’oi£Hi¡ÜyS‘MaxL’
(
Ën
);

63 
lš’oi£Hi¡ÜySave
(cÚ¡ *
f’ame
);

64 
lš’oi£Hi¡ÜyLßd
(cÚ¡ *
f’ame
);

65 
lš’oi£CË¬Sü“n
();

66 
lš’oi£S‘MuÉiLše
(
ml
);

67 
lš’oi£PrštKeyCodes
();

69 #ifdeà
__ılu¥lus


	@deps/lua/etc/all.c

5 
	#lu¯Î_c


	)

7 
	~"Ïpi.c
"

8 
	~"lcode.c
"

9 
	~"ldebug.c
"

10 
	~"ldo.c
"

11 
	~"ldump.c
"

12 
	~"lfunc.c
"

13 
	~"lgc.c
"

14 
	~"Îex.c
"

15 
	~"lmem.c
"

16 
	~"lobjeù.c
"

17 
	~"lİcodes.c
"

18 
	~"Í¬£r.c
"

19 
	~"l¡©e.c
"

20 
	~"l¡ršg.c
"

21 
	~"ÉabË.c
"

22 
	~"Ém.c
"

23 
	~"lundump.c
"

24 
	~"lvm.c
"

25 
	~"lzio.c
"

27 
	~"Ïuxlib.c
"

28 
	~"lba£lib.c
"

29 
	~"ldblib.c
"

30 
	~"liŞib.c
"

31 
	~"lš™.c
"

32 
	~"lm©hlib.c
"

33 
	~"lßdlib.c
"

34 
	~"lo¦ib.c
"

35 
	~"l¡¾ib.c
"

36 
	~"Éablib.c
"

38 
	~"lua.c
"

	@deps/lua/etc/lua.hpp

6 
	~"lua.h
"

7 
	~"lu®ib.h
"

8 
	~"Ïuxlib.h
"

	@deps/lua/etc/min.c

7 
	~<¡dio.h
>

9 
	~"lua.h
"

10 
	~"Ïuxlib.h
"

12 
	$´št
(
lua_S‹
 *
L
)

14 
n
=
	`lua_g‘tİ
(
L
);

15 
i
;

16 
i
=1; i<=
n
; i++)

18 ià(
i
>1è
	`´štf
("\t");

19 ià(
	`lua_is¡ršg
(
L
,
i
))

20 
	`´štf
("%s",
	`lua_to¡ršg
(
L
,
i
));

21 ià(
	`lua_i¢
(
L
,
i
))

22 
	`´štf
("%s","nil");

23 ià(
	`lua_isboŞ—n
(
L
,
i
))

24 
	`´štf
("%s",
	`lua_toboŞ—n
(
L
,
i
) ? "true" : "false");

26 
	`´štf
("%s:%p",
	`luaL_ty³Çme
(
L
,
i
),
	`lua_tİoš‹r
(L,i));

28 
	`´štf
("\n");

30 
	}
}

32 
	$maš
()

34 
lua_S‹
 *
L
=
	`lua_İ’
();

35 
	`lua_»gi¡”
(
L
,"´št",
´št
);

36 ià(
	`luaL_dofe
(
L
,
NULL
)!=0è
	`årštf
(
¡d”r
,"%s\n",
	`lua_to¡ršg
(L,-1));

37 
	`lua_şo£
(
L
);

39 
	}
}

	@deps/lua/etc/noparser.c

15 
	#LUA_CORE


	)

17 
	~"Îex.h
"

18 
	~"Í¬£r.h
"

19 
	~"lzio.h
"

21 
LUAI_FUNC
 
	$luaX_š™
 (
lua_S‹
 *
L
) {

22 
	`UNUSED
(
L
);

23 
	}
}

25 
LUAI_FUNC
 
PrÙo
 *
	$luaY_·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
Mbufãr
 *
buff
, cÚ¡ *
Çme
) {

26 
	`UNUSED
(
z
);

27 
	`UNUSED
(
buff
);

28 
	`UNUSED
(
Çme
);

29 
	`lua_pushl™”®
(
L
,"parser‚ot†oaded");

30 
	`lua_”rÜ
(
L
);

31  
NULL
;

32 
	}
}

34 #ifdeà
NODUMP


35 
	~"lundump.h
"

37 
LUAI_FUNC
 
	$luaU_dump
 (
lua_S‹
* 
L
, cÚ¡ 
PrÙo
* 
f
, 
lua_Wr™”
 
w
, * 
d©a
, 
¡r
) {

38 
	`UNUSED
(
f
);

39 
	`UNUSED
(
w
);

40 
	`UNUSED
(
d©a
);

41 
	`UNUSED
(
¡r
);

43 
	`UNUSED
(
L
);

46 
	`lua_pushl™”®
(
L
,"dumper‚ot†oaded");

47 
	`lua_”rÜ
(
L
);

49 
	}
}

	@deps/lua/src/fpconv.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<as£¹.h
>

34 
	~<¡ršg.h
>

36 
	~"åcÚv.h
"

43 
	gloÿË_decim®_pošt
 = '.';

52 
	$åcÚv_upd©e_loÿË
()

54 
buf
[8];

56 
	`¢´štf
(
buf
, (buf), "%g", 0.5);

60 ià(
buf
[0] != '0' || buf[2] != '5' || buf[3] != 0) {

61 
	`årštf
(
¡d”r
, "Error: wide characters found or…rintf() bug.");

62 
	`abÜt
();

65 
loÿË_decim®_pošt
 = 
buf
[1];

66 
	}
}

75 
šlše
 
	$v®id_numb”_ch¬aù”
(
ch
)

77 
low”_ch
;

79 ià('0' <ğ
ch
 && ch <= '9')

81 ià(
ch
 == '-' || ch == '+' || ch == '.')

85 
low”_ch
 = 
ch
 | 0x20;

86 ià('a' <ğ
low”_ch
 &&†ower_ch <= 'y')

90 
	}
}

94 
	$¡¹od_bufãr_size
(cÚ¡ *
s
)

96 cÚ¡ *
p
 = 
s
;

98 
	`v®id_numb”_ch¬aù”
(*
p
))

99 
p
++;

101  
p
 - 
s
;

102 
	}
}

106 
	$åcÚv_¡¹od
(cÚ¡ *
ÅŒ
, **
’d±r
)

108 
loÿlbuf
[
FPCONV_G_FMT_BUFSIZE
];

109 *
buf
, *
’dbuf
, *
dp
;

110 
buæ’
;

111 
v®ue
;

114 ià(
loÿË_decim®_pošt
 == '.')

115  
	`¡¹od
(
ÅŒ
, 
’d±r
);

117 
buæ’
 = 
	`¡¹od_bufãr_size
(
ÅŒ
);

118 ià(!
buæ’
) {

120 *
’d±r
 = (*)
ÅŒ
;

125 ià(
buæ’
 >ğ
FPCONV_G_FMT_BUFSIZE
) {

127 
buf
 = 
	`m®loc
(
buæ’
 + 1);

128 ià(!
buf
) {

129 
	`årštf
(
¡d”r
, "Out of memory");

130 
	`abÜt
();

134 
buf
 = 
loÿlbuf
;

136 
	`memıy
(
buf
, 
ÅŒ
, 
buæ’
);

137 
buf
[
buæ’
] = 0;

140 
dp
 = 
	`¡rchr
(
buf
, '.');

141 ià(
dp
)

142 *
dp
 = 
loÿË_decim®_pošt
;

144 
v®ue
 = 
	`¡¹od
(
buf
, &
’dbuf
);

145 *
’d±r
 = (*)&
ÅŒ
[
’dbuf
 - 
buf
];

146 ià(
buæ’
 >ğ
FPCONV_G_FMT_BUFSIZE
)

147 
	`ä“
(
buf
);

149  
v®ue
;

150 
	}
}

153 
	$£t_numb”_fÜm©
(*
fmt
, 
´ecisiÚ
)

155 
d1
, 
d2
, 
i
;

157 
	`as£¹
(1 <ğ
´ecisiÚ
 &&…recision <= 14);

160 
d1
 = 
´ecisiÚ
 / 10;

161 
d2
 = 
´ecisiÚ
 % 10;

162 
fmt
[0] = '%';

163 
fmt
[1] = '.';

164 
i
 = 2;

165 ià(
d1
) {

166 
fmt
[
i
++] = '0' + 
d1
;

168 
fmt
[
i
++] = '0' + 
d2
;

169 
fmt
[
i
++] = 'g';

170 
fmt
[
i
] = 0;

171 
	}
}

174 
	$åcÚv_g_fmt
(*
¡r
, 
num
, 
´ecisiÚ
)

176 
buf
[
FPCONV_G_FMT_BUFSIZE
];

177 
fmt
[6];

178 
Ën
;

179 *
b
;

181 
	`£t_numb”_fÜm©
(
fmt
, 
´ecisiÚ
);

184 ià(
loÿË_decim®_pošt
 == '.')

185  
	`¢´štf
(
¡r
, 
FPCONV_G_FMT_BUFSIZE
, 
fmt
, 
num
);

188 
Ën
 = 
	`¢´štf
(
buf
, 
FPCONV_G_FMT_BUFSIZE
, 
fmt
, 
num
);

191 
b
 = 
buf
;

193 *
¡r
++ = (*
b
 =ğ
loÿË_decim®_pošt
 ? '.' : *b);

194 } *
b
++);

196  
Ën
;

197 
	}
}

199 
	$åcÚv_š™
()

201 
	`åcÚv_upd©e_loÿË
();

202 
	}
}

	@deps/lua/src/fpconv.h

7 
	#FPCONV_G_FMT_BUFSIZE
 32

	)

9 #ifdeà
USE_INTERNAL_FPCONV


10 
šlše
 
	$åcÚv_š™
()

13 
	}
}

15 
åcÚv_š™
();

18 
åcÚv_g_fmt
(*, , );

19 
åcÚv_¡¹od
(const *, **);

	@deps/lua/src/lapi.c

8 
	~<as£¹.h
>

9 
	~<m©h.h
>

10 
	~<¡d¬g.h
>

11 
	~<¡ršg.h
>

13 
	#Ïpi_c


	)

14 
	#LUA_CORE


	)

16 
	~"lua.h
"

18 
	~"Ïpi.h
"

19 
	~"ldebug.h
"

20 
	~"ldo.h
"

21 
	~"lfunc.h
"

22 
	~"lgc.h
"

23 
	~"lmem.h
"

24 
	~"lobjeù.h
"

25 
	~"l¡©e.h
"

26 
	~"l¡ršg.h
"

27 
	~"ÉabË.h
"

28 
	~"Ém.h
"

29 
	~"lundump.h
"

30 
	~"lvm.h
"

34 cÚ¡ 
	glua_id’t
[] =

35 "$Lua: " 
LUA_RELEASE
 " " 
LUA_COPYRIGHT
 " $\n"

36 "$AuthÜs: " 
LUA_AUTHORS
 " $\n"

41 
	#­i_checkÃËms
(
L
, 
n
è
	`­i_check
(L, (nè<ğ(L->
tİ
 - L->
ba£
))

	)

43 
	#­i_checkv®idšdex
(
L
, 
i
è
	`­i_check
(L, (iè!ğ
luaO_nobjeù
)

	)

45 
	#­i_šü_tİ
(
L
è{
	`­i_check
(L, L->
tİ
 < L->
ci
->tİ); L->tİ++;}

	)

49 
TV®ue
 *
	$šdex2adr
 (
lua_S‹
 *
L
, 
idx
) {

50 ià(
idx
 > 0) {

51 
TV®ue
 *
o
 = 
L
->
ba£
 + (
idx
 - 1);

52 
	`­i_check
(
L
, 
idx
 <ğL->
ci
->
tİ
 - L->
ba£
);

53 ià(
o
 >ğ
L
->
tİ
è 
	`ÿ¡
(
TV®ue
 *, 
luaO_nobjeù
);

54  
o
;

56 ià(
idx
 > 
LUA_REGISTRYINDEX
) {

57 
	`­i_check
(
L
, 
idx
 !ğ0 && -idx <ğL->
tİ
 - L->
ba£
);

58  
L
->
tİ
 + 
idx
;

60 
idx
) {

61 
LUA_REGISTRYINDEX
:  
	`»gi¡ry
(
L
);

62 
LUA_ENVIRONINDEX
: {

63 
Closu»
 *
func
 = 
	`cu¼_func
(
L
);

64 
	`£thv®ue
(
L
, &L->
’v
, 
func
->
c
.env);

65  &
L
->
’v
;

67 
LUA_GLOBALSINDEX
:  
	`gt
(
L
);

69 
Closu»
 *
func
 = 
	`cu¼_func
(
L
);

70 
idx
 = 
LUA_GLOBALSINDEX
 - idx;

71  (
idx
 <ğ
func
->
c
.
nupv®ues
)

72 ? &
func
->
c
.
upv®ue
[
idx
-1]

73 : 
	`ÿ¡
(
TV®ue
 *, 
luaO_nobjeù
);

76 
	}
}

79 
TabË
 *
	$g‘cu¼’v
 (
lua_S‹
 *
L
) {

80 ià(
L
->
ci
 =ğL->
ba£_ci
)

81  
	`hv®ue
(
	`gt
(
L
));

83 
Closu»
 *
func
 = 
	`cu¼_func
(
L
);

84  
func
->
c
.
’v
;

86 
	}
}

89 
	$luaA_pushobjeù
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
) {

90 
	`£tobj2s
(
L
, L->
tİ
, 
o
);

91 
	`­i_šü_tİ
(
L
);

92 
	}
}

95 
LUA_API
 
	$lua_check¡ack
 (
lua_S‹
 *
L
, 
size
) {

96 
»s
 = 1;

97 
	`lua_lock
(
L
);

98 ià(
size
 > 
LUAI_MAXCSTACK
 || (
L
->
tİ
 - L->
ba£
 + size) > LUAI_MAXCSTACK)

99 
»s
 = 0;

100 ià(
size
 > 0) {

101 
	`luaD_check¡ack
(
L
, 
size
);

102 ià(
L
->
ci
->
tİ
 < L->tİ + 
size
)

103 
L
->
ci
->
tİ
 = L->tİ + 
size
;

105 
	`lua_uÆock
(
L
);

106  
»s
;

107 
	}
}

110 
LUA_API
 
	$lua_xmove
 (
lua_S‹
 *
äom
,†ua_S‹ *
to
, 
n
) {

111 
i
;

112 ià(
äom
 =ğ
to
) ;

113 
	`lua_lock
(
to
);

114 
	`­i_checkÃËms
(
äom
, 
n
);

115 
	`­i_check
(
äom
, 
	`G
(äomè=ğG(
to
));

116 
	`­i_check
(
äom
, 
to
->
ci
->
tİ
 -o->tİ >ğ
n
);

117 
äom
->
tİ
 -ğ
n
;

118 
i
 = 0; i < 
n
; i++) {

119 
	`£tobj2s
(
to
,o->
tİ
++, 
äom
->tİ + 
i
);

121 
	`lua_uÆock
(
to
);

122 
	}
}

125 
LUA_API
 
	$lua_£ev–
 (
lua_S‹
 *
äom
,†ua_S‹ *
to
) {

126 
to
->
nCÿÎs
 = 
äom
->nCcalls;

127 
	}
}

130 
LUA_API
 
lua_CFunùiÚ
 
	$lua_©·nic
 (
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
·nicf
) {

131 
lua_CFunùiÚ
 
Şd
;

132 
	`lua_lock
(
L
);

133 
Şd
 = 
	`G
(
L
)->
·nic
;

134 
	`G
(
L
)->
·nic
 = 
·nicf
;

135 
	`lua_uÆock
(
L
);

136  
Şd
;

137 
	}
}

140 
LUA_API
 
lua_S‹
 *
	$lua_Ãwth»ad
 (
lua_S‹
 *
L
) {

141 
lua_S‹
 *
L1
;

142 
	`lua_lock
(
L
);

143 
	`luaC_checkGC
(
L
);

144 
L1
 = 
	`luaE_Ãwth»ad
(
L
);

145 
	`£‰hv®ue
(
L
, L->
tİ
, 
L1
);

146 
	`­i_šü_tİ
(
L
);

147 
	`lua_uÆock
(
L
);

148 
	`luai_u£r¡©‘h»ad
(
L
, 
L1
);

149  
L1
;

150 
	}
}

159 
LUA_API
 
	$lua_g‘tİ
 (
lua_S‹
 *
L
) {

160  
	`ÿ¡_št
(
L
->
tİ
 - L->
ba£
);

161 
	}
}

164 
LUA_API
 
	$lua_£‰İ
 (
lua_S‹
 *
L
, 
idx
) {

165 
	`lua_lock
(
L
);

166 ià(
idx
 >= 0) {

167 
	`­i_check
(
L
, 
idx
 <ğL->
¡ack_Ï¡
 - L->
ba£
);

168 
L
->
tİ
 < L->
ba£
 + 
idx
)

169 
	`£Šv®ue
(
L
->
tİ
++);

170 
L
->
tİ
 = L->
ba£
 + 
idx
;

173 
	`­i_check
(
L
, -(
idx
+1è<ğ(L->
tİ
 - L->
ba£
));

174 
L
->
tİ
 +ğ
idx
+1;

176 
	`lua_uÆock
(
L
);

177 
	}
}

180 
LUA_API
 
	$lua_»move
 (
lua_S‹
 *
L
, 
idx
) {

181 
StkId
 
p
;

182 
	`lua_lock
(
L
);

183 
p
 = 
	`šdex2adr
(
L
, 
idx
);

184 
	`­i_checkv®idšdex
(
L
, 
p
);

185 ++
p
 < 
L
->
tİ
è
	`£tobjs2s
(L,…-1,…);

186 
L
->
tİ
--;

187 
	`lua_uÆock
(
L
);

188 
	}
}

191 
LUA_API
 
	$lua_š£¹
 (
lua_S‹
 *
L
, 
idx
) {

192 
StkId
 
p
;

193 
StkId
 
q
;

194 
	`lua_lock
(
L
);

195 
p
 = 
	`šdex2adr
(
L
, 
idx
);

196 
	`­i_checkv®idšdex
(
L
, 
p
);

197 
q
 = 
L
->
tİ
; q>
p
; q--è
	`£tobjs2s
(L, q, q-1);

198 
	`£tobjs2s
(
L
, 
p
, L->
tİ
);

199 
	`lua_uÆock
(
L
);

200 
	}
}

203 
LUA_API
 
	$lua_»¶aû
 (
lua_S‹
 *
L
, 
idx
) {

204 
StkId
 
o
;

205 
	`lua_lock
(
L
);

207 ià(
idx
 =ğ
LUA_ENVIRONINDEX
 && 
L
->
ci
 =ğL->
ba£_ci
)

208 
	`luaG_ruÃ¼Ü
(
L
, "no callingƒnvironment");

209 
	`­i_checkÃËms
(
L
, 1);

210 
o
 = 
	`šdex2adr
(
L
, 
idx
);

211 
	`­i_checkv®idšdex
(
L
, 
o
);

212 ià(
idx
 =ğ
LUA_ENVIRONINDEX
) {

213 
Closu»
 *
func
 = 
	`cu¼_func
(
L
);

214 
	`­i_check
(
L
, 
	`‰i¡abË
(L->
tİ
 - 1));

215 
func
->
c
.
’v
 = 
	`hv®ue
(
L
->
tİ
 - 1);

216 
	`luaC_b¬r›r
(
L
, 
func
, L->
tİ
 - 1);

219 
	`£tobj
(
L
, 
o
, L->
tİ
 - 1);

220 ià(
idx
 < 
LUA_GLOBALSINDEX
)

221 
	`luaC_b¬r›r
(
L
, 
	`cu¼_func
(L), L->
tİ
 - 1);

223 
L
->
tİ
--;

224 
	`lua_uÆock
(
L
);

225 
	}
}

228 
LUA_API
 
	$lua_pushv®ue
 (
lua_S‹
 *
L
, 
idx
) {

229 
	`lua_lock
(
L
);

230 
	`£tobj2s
(
L
, L->
tİ
, 
	`šdex2adr
(L, 
idx
));

231 
	`­i_šü_tİ
(
L
);

232 
	`lua_uÆock
(
L
);

233 
	}
}

242 
LUA_API
 
	$lua_ty³
 (
lua_S‹
 *
L
, 
idx
) {

243 
StkId
 
o
 = 
	`šdex2adr
(
L
, 
idx
);

244  (
o
 =ğ
luaO_nobjeù
è? 
LUA_TNONE
 : 
	`‰y³
(o);

245 
	}
}

248 
LUA_API
 cÚ¡ *
	$lua_ty³Çme
 (
lua_S‹
 *
L
, 
t
) {

249 
	`UNUSED
(
L
);

250  (
t
 =ğ
LUA_TNONE
è? "nØv®ue" : 
luaT_ty³Çmes
[t];

251 
	}
}

254 
LUA_API
 
	$lua_iscfunùiÚ
 (
lua_S‹
 *
L
, 
idx
) {

255 
StkId
 
o
 = 
	`šdex2adr
(
L
, 
idx
);

256  
	`iscfunùiÚ
(
o
);

257 
	}
}

260 
LUA_API
 
	$lua_i¢umb”
 (
lua_S‹
 *
L
, 
idx
) {

261 
TV®ue
 
n
;

262 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2adr
(
L
, 
idx
);

263  
	`tÚumb”
(
o
, &
n
);

264 
	}
}

267 
LUA_API
 
	$lua_is¡ršg
 (
lua_S‹
 *
L
, 
idx
) {

268 
t
 = 
	`lua_ty³
(
L
, 
idx
);

269  (
t
 =ğ
LUA_TSTRING
 || =ğ
LUA_TNUMBER
);

270 
	}
}

273 
LUA_API
 
	$lua_isu£rd©a
 (
lua_S‹
 *
L
, 
idx
) {

274 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2adr
(
L
, 
idx
);

275  (
	`‰isu£rd©a
(
o
è|| 
	`‰i¦ightu£rd©a
(o));

276 
	}
}

279 
LUA_API
 
	$lua_¿wequ®
 (
lua_S‹
 *
L
, 
šdex1
, 
šdex2
) {

280 
StkId
 
o1
 = 
	`šdex2adr
(
L
, 
šdex1
);

281 
StkId
 
o2
 = 
	`šdex2adr
(
L
, 
šdex2
);

282  (
o1
 =ğ
luaO_nobjeù
 || 
o2
 ==†uaO_nilobject) ? 0

283 : 
	`luaO_¿wequ®Obj
(
o1
, 
o2
);

284 
	}
}

287 
LUA_API
 
	$lua_equ®
 (
lua_S‹
 *
L
, 
šdex1
, 
šdex2
) {

288 
StkId
 
o1
, 
o2
;

289 
i
;

290 
	`lua_lock
(
L
);

291 
o1
 = 
	`šdex2adr
(
L
, 
šdex1
);

292 
o2
 = 
	`šdex2adr
(
L
, 
šdex2
);

293 
i
 = (
o1
 =ğ
luaO_nobjeù
 || 
o2
 =ğluaO_nobjeùè? 0 : 
	`equ®obj
(
L
, o1, o2);

294 
	`lua_uÆock
(
L
);

295  
i
;

296 
	}
}

299 
LUA_API
 
	$lua_Ës¡hª
 (
lua_S‹
 *
L
, 
šdex1
, 
šdex2
) {

300 
StkId
 
o1
, 
o2
;

301 
i
;

302 
	`lua_lock
(
L
);

303 
o1
 = 
	`šdex2adr
(
L
, 
šdex1
);

304 
o2
 = 
	`šdex2adr
(
L
, 
šdex2
);

305 
i
 = (
o1
 =ğ
luaO_nobjeù
 || 
o2
 ==†uaO_nilobject) ? 0

306 : 
	`luaV_Ës¡hª
(
L
, 
o1
, 
o2
);

307 
	`lua_uÆock
(
L
);

308  
i
;

309 
	}
}

313 
LUA_API
 
lua_Numb”
 
	$lua_tÚumb”
 (
lua_S‹
 *
L
, 
idx
) {

314 
TV®ue
 
n
;

315 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2adr
(
L
, 
idx
);

316 ià(
	`tÚumb”
(
o
, &
n
))

317  
	`nv®ue
(
o
);

320 
	}
}

323 
LUA_API
 
lua_IÁeg”
 
	$lua_toš‹g”
 (
lua_S‹
 *
L
, 
idx
) {

324 
TV®ue
 
n
;

325 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2adr
(
L
, 
idx
);

326 ià(
	`tÚumb”
(
o
, &
n
)) {

327 
lua_IÁeg”
 
»s
;

328 
lua_Numb”
 
num
 = 
	`nv®ue
(
o
);

329 
	`lua_numb”2š‹g”
(
»s
, 
num
);

330  
»s
;

334 
	}
}

337 
LUA_API
 
	$lua_toboŞ—n
 (
lua_S‹
 *
L
, 
idx
) {

338 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2adr
(
L
, 
idx
);

339  !
	`l_isçl£
(
o
);

340 
	}
}

343 
LUA_API
 cÚ¡ *
	$lua_tŞ¡ršg
 (
lua_S‹
 *
L
, 
idx
, 
size_t
 *
Ën
) {

344 
StkId
 
o
 = 
	`šdex2adr
(
L
, 
idx
);

345 ià(!
	`‰is¡ršg
(
o
)) {

346 
	`lua_lock
(
L
);

347 ià(!
	`luaV_to¡ršg
(
L
, 
o
)) {

348 ià(
Ën
 !ğ
NULL
) *len = 0;

349 
	`lua_uÆock
(
L
);

350  
NULL
;

352 
	`luaC_checkGC
(
L
);

353 
o
 = 
	`šdex2adr
(
L
, 
idx
);

354 
	`lua_uÆock
(
L
);

356 ià(
Ën
 !ğ
NULL
è*ËÀğ
	`tsv®ue
(
o
)->len;

357  
	`sv®ue
(
o
);

358 
	}
}

361 
LUA_API
 
size_t
 
	$lua_objËn
 (
lua_S‹
 *
L
, 
idx
) {

362 
StkId
 
o
 = 
	`šdex2adr
(
L
, 
idx
);

363 
	`‰y³
(
o
)) {

364 
LUA_TSTRING
:  
	`tsv®ue
(
o
)->
Ën
;

365 
LUA_TUSERDATA
:  
	`uv®ue
(
o
)->
Ën
;

366 
LUA_TTABLE
:  
	`luaH_g‘n
(
	`hv®ue
(
o
));

367 
LUA_TNUMBER
: {

368 
size_t
 
l
;

369 
	`lua_lock
(
L
);

370 
l
 = (
	`luaV_to¡ršg
(
L
, 
o
è? 
	`tsv®ue
(o)->
Ën
 : 0);

371 
	`lua_uÆock
(
L
);

372  
l
;

376 
	}
}

379 
LUA_API
 
lua_CFunùiÚ
 
	$lua_tocfunùiÚ
 (
lua_S‹
 *
L
, 
idx
) {

380 
StkId
 
o
 = 
	`šdex2adr
(
L
, 
idx
);

381  (!
	`iscfunùiÚ
(
o
)è? 
NULL
 : 
	`şv®ue
(o)->
c
.
f
;

382 
	}
}

385 
LUA_API
 *
	$lua_tou£rd©a
 (
lua_S‹
 *
L
, 
idx
) {

386 
StkId
 
o
 = 
	`šdex2adr
(
L
, 
idx
);

387 
	`‰y³
(
o
)) {

388 
LUA_TUSERDATA
:  (
	`¿wuv®ue
(
o
) + 1);

389 
LUA_TLIGHTUSERDATA
:  
	`pv®ue
(
o
);

390 :  
NULL
;

392 
	}
}

395 
LUA_API
 
lua_S‹
 *
	$lua_tÙh»ad
 (
lua_S‹
 *
L
, 
idx
) {

396 
StkId
 
o
 = 
	`šdex2adr
(
L
, 
idx
);

397  (!
	`‰i¡h»ad
(
o
)è? 
NULL
 : 
	`thv®ue
(o);

398 
	}
}

401 
LUA_API
 cÚ¡ *
	$lua_tİoš‹r
 (
lua_S‹
 *
L
, 
idx
) {

402 
StkId
 
o
 = 
	`šdex2adr
(
L
, 
idx
);

403 
	`‰y³
(
o
)) {

404 
LUA_TTABLE
:  
	`hv®ue
(
o
);

405 
LUA_TFUNCTION
:  
	`şv®ue
(
o
);

406 
LUA_TTHREAD
:  
	`thv®ue
(
o
);

407 
LUA_TUSERDATA
:

408 
LUA_TLIGHTUSERDATA
:

409  
	`lua_tou£rd©a
(
L
, 
idx
);

410 :  
NULL
;

412 
	}
}

421 
LUA_API
 
	$lua_pushn
 (
lua_S‹
 *
L
) {

422 
	`lua_lock
(
L
);

423 
	`£Šv®ue
(
L
->
tİ
);

424 
	`­i_šü_tİ
(
L
);

425 
	`lua_uÆock
(
L
);

426 
	}
}

429 
LUA_API
 
	$lua_pushnumb”
 (
lua_S‹
 *
L
, 
lua_Numb”
 
n
) {

430 
	`lua_lock
(
L
);

431 
	`£Šv®ue
(
L
->
tİ
, 
n
);

432 
	`­i_šü_tİ
(
L
);

433 
	`lua_uÆock
(
L
);

434 
	}
}

437 
LUA_API
 
	$lua_pushš‹g”
 (
lua_S‹
 *
L
, 
lua_IÁeg”
 
n
) {

438 
	`lua_lock
(
L
);

439 
	`£Šv®ue
(
L
->
tİ
, 
	`ÿ¡_num
(
n
));

440 
	`­i_šü_tİ
(
L
);

441 
	`lua_uÆock
(
L
);

442 
	}
}

445 
LUA_API
 
	$lua_pushl¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
s
, 
size_t
 
Ën
) {

446 
	`lua_lock
(
L
);

447 
	`luaC_checkGC
(
L
);

448 
	`£tsv®ue2s
(
L
, L->
tİ
, 
	`luaS_Ãwl¡r
(L, 
s
, 
Ën
));

449 
	`­i_šü_tİ
(
L
);

450 
	`lua_uÆock
(
L
);

451 
	}
}

454 
LUA_API
 
	$lua_push¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
s
) {

455 ià(
s
 =ğ
NULL
)

456 
	`lua_pushn
(
L
);

458 
	`lua_pushl¡ršg
(
L
, 
s
, 
	`¡¾’
(s));

459 
	}
}

462 
LUA_API
 cÚ¡ *
	$lua_pushvf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
,

463 
va_li¡
 
¬gp
) {

464 cÚ¡ *
»t
;

465 
	`lua_lock
(
L
);

466 
	`luaC_checkGC
(
L
);

467 
»t
 = 
	`luaO_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

468 
	`lua_uÆock
(
L
);

469  
»t
;

470 
	}
}

473 
LUA_API
 cÚ¡ *
	$lua_pushf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

474 cÚ¡ *
»t
;

475 
va_li¡
 
¬gp
;

476 
	`lua_lock
(
L
);

477 
	`luaC_checkGC
(
L
);

478 
	`va_¡¬t
(
¬gp
, 
fmt
);

479 
»t
 = 
	`luaO_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

480 
	`va_’d
(
¬gp
);

481 
	`lua_uÆock
(
L
);

482  
»t
;

483 
	}
}

486 
LUA_API
 
	$lua_pushcşosu»
 (
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
â
, 
n
) {

487 
Closu»
 *
ş
;

488 
	`lua_lock
(
L
);

489 
	`luaC_checkGC
(
L
);

490 
	`­i_checkÃËms
(
L
, 
n
);

491 
ş
 = 
	`luaF_ÃwCşosu»
(
L
, 
n
, 
	`g‘cu¼’v
(L));

492 
ş
->
c
.
f
 = 
â
;

493 
L
->
tİ
 -ğ
n
;

494 
n
--)

495 
	`£tobj2n
(
L
, &
ş
->
c
.
upv®ue
[
n
], L->
tİ
+n);

496 
	`£tşv®ue
(
L
, L->
tİ
, 
ş
);

497 
	`lua_as£¹
(
	`iswh™e
(
	`obj2gco
(
ş
)));

498 
	`­i_šü_tİ
(
L
);

499 
	`lua_uÆock
(
L
);

500 
	}
}

503 
LUA_API
 
	$lua_pushboŞ—n
 (
lua_S‹
 *
L
, 
b
) {

504 
	`lua_lock
(
L
);

505 
	`£tbv®ue
(
L
->
tİ
, (
b
 != 0));

506 
	`­i_šü_tİ
(
L
);

507 
	`lua_uÆock
(
L
);

508 
	}
}

511 
LUA_API
 
	$lua_pushlightu£rd©a
 (
lua_S‹
 *
L
, *
p
) {

512 
	`lua_lock
(
L
);

513 
	`£v®ue
(
L
->
tİ
, 
p
);

514 
	`­i_šü_tİ
(
L
);

515 
	`lua_uÆock
(
L
);

516 
	}
}

519 
LUA_API
 
	$lua_pushth»ad
 (
lua_S‹
 *
L
) {

520 
	`lua_lock
(
L
);

521 
	`£‰hv®ue
(
L
, L->
tİ
, L);

522 
	`­i_šü_tİ
(
L
);

523 
	`lua_uÆock
(
L
);

524  (
	`G
(
L
)->
mašth»ad
 == L);

525 
	}
}

534 
LUA_API
 
	$lua_g‘bË
 (
lua_S‹
 *
L
, 
idx
) {

535 
StkId
 
t
;

536 
	`lua_lock
(
L
);

537 
t
 = 
	`šdex2adr
(
L
, 
idx
);

538 
	`­i_checkv®idšdex
(
L
, 
t
);

539 
	`luaV_g‘bË
(
L
, 
t
, L->
tİ
 - 1, L->top - 1);

540 
	`lua_uÆock
(
L
);

541 
	}
}

544 
LUA_API
 
	$lua_g‘f›ld
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
) {

545 
StkId
 
t
;

546 
TV®ue
 
key
;

547 
	`lua_lock
(
L
);

548 
t
 = 
	`šdex2adr
(
L
, 
idx
);

549 
	`­i_checkv®idšdex
(
L
, 
t
);

550 
	`£tsv®ue
(
L
, &
key
, 
	`luaS_Ãw
(L, 
k
));

551 
	`luaV_g‘bË
(
L
, 
t
, &
key
, L->
tİ
);

552 
	`­i_šü_tİ
(
L
);

553 
	`lua_uÆock
(
L
);

554 
	}
}

557 
LUA_API
 
	$lua_¿wg‘
 (
lua_S‹
 *
L
, 
idx
) {

558 
StkId
 
t
;

559 
	`lua_lock
(
L
);

560 
t
 = 
	`šdex2adr
(
L
, 
idx
);

561 
	`­i_check
(
L
, 
	`‰i¡abË
(
t
));

562 
	`£tobj2s
(
L
, L->
tİ
 - 1, 
	`luaH_g‘
(
	`hv®ue
(
t
), L->top - 1));

563 
	`lua_uÆock
(
L
);

564 
	}
}

567 
LUA_API
 
	$lua_¿wg‘i
 (
lua_S‹
 *
L
, 
idx
, 
n
) {

568 
StkId
 
o
;

569 
	`lua_lock
(
L
);

570 
o
 = 
	`šdex2adr
(
L
, 
idx
);

571 
	`­i_check
(
L
, 
	`‰i¡abË
(
o
));

572 
	`£tobj2s
(
L
, L->
tİ
, 
	`luaH_g‘num
(
	`hv®ue
(
o
), 
n
));

573 
	`­i_šü_tİ
(
L
);

574 
	`lua_uÆock
(
L
);

575 
	}
}

578 
LUA_API
 
	$lua_ü—‹bË
 (
lua_S‹
 *
L
, 
Ç¼ay
, 
Äec
) {

579 
	`lua_lock
(
L
);

580 
	`luaC_checkGC
(
L
);

581 
	`£thv®ue
(
L
, L->
tİ
, 
	`luaH_Ãw
(L, 
Ç¼ay
, 
Äec
));

582 
	`­i_šü_tİ
(
L
);

583 
	`lua_uÆock
(
L
);

584 
	}
}

587 
LUA_API
 
	$lua_g‘m‘©abË
 (
lua_S‹
 *
L
, 
objšdex
) {

588 cÚ¡ 
TV®ue
 *
obj
;

589 
TabË
 *
mt
 = 
NULL
;

590 
»s
;

591 
	`lua_lock
(
L
);

592 
obj
 = 
	`šdex2adr
(
L
, 
objšdex
);

593 
	`‰y³
(
obj
)) {

594 
LUA_TTABLE
:

595 
mt
 = 
	`hv®ue
(
obj
)->
m‘©abË
;

597 
LUA_TUSERDATA
:

598 
mt
 = 
	`uv®ue
(
obj
)->
m‘©abË
;

601 
mt
 = 
	`G
(
L
)->mt[
	`‰y³
(
obj
)];

604 ià(
mt
 =ğ
NULL
)

605 
»s
 = 0;

607 
	`£thv®ue
(
L
, L->
tİ
, 
mt
);

608 
	`­i_šü_tİ
(
L
);

609 
»s
 = 1;

611 
	`lua_uÆock
(
L
);

612  
»s
;

613 
	}
}

616 
LUA_API
 
	$lua_g‘ãnv
 (
lua_S‹
 *
L
, 
idx
) {

617 
StkId
 
o
;

618 
	`lua_lock
(
L
);

619 
o
 = 
	`šdex2adr
(
L
, 
idx
);

620 
	`­i_checkv®idšdex
(
L
, 
o
);

621 
	`‰y³
(
o
)) {

622 
LUA_TFUNCTION
:

623 
	`£thv®ue
(
L
, L->
tİ
, 
	`şv®ue
(
o
)->
c
.
’v
);

625 
LUA_TUSERDATA
:

626 
	`£thv®ue
(
L
, L->
tİ
, 
	`uv®ue
(
o
)->
’v
);

628 
LUA_TTHREAD
:

629 
	`£tobj2s
(
L
, L->
tİ
, 
	`gt
(
	`thv®ue
(
o
)));

632 
	`£Šv®ue
(
L
->
tİ
);

635 
	`­i_šü_tİ
(
L
);

636 
	`lua_uÆock
(
L
);

637 
	}
}

645 
LUA_API
 
	$lua_£‰abË
 (
lua_S‹
 *
L
, 
idx
) {

646 
StkId
 
t
;

647 
	`lua_lock
(
L
);

648 
	`­i_checkÃËms
(
L
, 2);

649 
t
 = 
	`šdex2adr
(
L
, 
idx
);

650 
	`­i_checkv®idšdex
(
L
, 
t
);

651 
	`luaV_£‰abË
(
L
, 
t
, L->
tİ
 - 2, L->top - 1);

652 
L
->
tİ
 -= 2;

653 
	`lua_uÆock
(
L
);

654 
	}
}

657 
LUA_API
 
	$lua_£tf›ld
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
) {

658 
StkId
 
t
;

659 
TV®ue
 
key
;

660 
	`lua_lock
(
L
);

661 
	`­i_checkÃËms
(
L
, 1);

662 
t
 = 
	`šdex2adr
(
L
, 
idx
);

663 
	`­i_checkv®idšdex
(
L
, 
t
);

664 
	`£tsv®ue
(
L
, &
key
, 
	`luaS_Ãw
(L, 
k
));

665 
	`luaV_£‰abË
(
L
, 
t
, &
key
, L->
tİ
 - 1);

666 
L
->
tİ
--;

667 
	`lua_uÆock
(
L
);

668 
	}
}

671 
LUA_API
 
	$lua_¿w£t
 (
lua_S‹
 *
L
, 
idx
) {

672 
StkId
 
t
;

673 
	`lua_lock
(
L
);

674 
	`­i_checkÃËms
(
L
, 2);

675 
t
 = 
	`šdex2adr
(
L
, 
idx
);

676 
	`­i_check
(
L
, 
	`‰i¡abË
(
t
));

677 
	`£tobj2t
(
L
, 
	`luaH_£t
(L, 
	`hv®ue
(
t
), L->
tİ
-2), L->top-1);

678 
	`luaC_b¬r›¹
(
L
, 
	`hv®ue
(
t
), L->
tİ
-1);

679 
L
->
tİ
 -= 2;

680 
	`lua_uÆock
(
L
);

681 
	}
}

684 
LUA_API
 
	$lua_¿w£ti
 (
lua_S‹
 *
L
, 
idx
, 
n
) {

685 
StkId
 
o
;

686 
	`lua_lock
(
L
);

687 
	`­i_checkÃËms
(
L
, 1);

688 
o
 = 
	`šdex2adr
(
L
, 
idx
);

689 
	`­i_check
(
L
, 
	`‰i¡abË
(
o
));

690 
	`£tobj2t
(
L
, 
	`luaH_£Šum
(L, 
	`hv®ue
(
o
), 
n
), L->
tİ
-1);

691 
	`luaC_b¬r›¹
(
L
, 
	`hv®ue
(
o
), L->
tİ
-1);

692 
L
->
tİ
--;

693 
	`lua_uÆock
(
L
);

694 
	}
}

697 
LUA_API
 
	$lua_£tm‘©abË
 (
lua_S‹
 *
L
, 
objšdex
) {

698 
TV®ue
 *
obj
;

699 
TabË
 *
mt
;

700 
	`lua_lock
(
L
);

701 
	`­i_checkÃËms
(
L
, 1);

702 
obj
 = 
	`šdex2adr
(
L
, 
objšdex
);

703 
	`­i_checkv®idšdex
(
L
, 
obj
);

704 ià(
	`‰i¢
(
L
->
tİ
 - 1))

705 
mt
 = 
NULL
;

707 
	`­i_check
(
L
, 
	`‰i¡abË
(L->
tİ
 - 1));

708 
mt
 = 
	`hv®ue
(
L
->
tİ
 - 1);

710 
	`‰y³
(
obj
)) {

711 
LUA_TTABLE
: {

712 
	`hv®ue
(
obj
)->
m‘©abË
 = 
mt
;

713 ià(
mt
)

714 
	`luaC_objb¬r›¹
(
L
, 
	`hv®ue
(
obj
), 
mt
);

717 
LUA_TUSERDATA
: {

718 
	`uv®ue
(
obj
)->
m‘©abË
 = 
mt
;

719 ià(
mt
)

720 
	`luaC_objb¬r›r
(
L
, 
	`¿wuv®ue
(
obj
), 
mt
);

724 
	`G
(
L
)->
mt
[
	`‰y³
(
obj
)] = mt;

728 
L
->
tİ
--;

729 
	`lua_uÆock
(
L
);

731 
	}
}

734 
LUA_API
 
	$lua_£tãnv
 (
lua_S‹
 *
L
, 
idx
) {

735 
StkId
 
o
;

736 
»s
 = 1;

737 
	`lua_lock
(
L
);

738 
	`­i_checkÃËms
(
L
, 1);

739 
o
 = 
	`šdex2adr
(
L
, 
idx
);

740 
	`­i_checkv®idšdex
(
L
, 
o
);

741 
	`­i_check
(
L
, 
	`‰i¡abË
(L->
tİ
 - 1));

742 
	`‰y³
(
o
)) {

743 
LUA_TFUNCTION
:

744 
	`şv®ue
(
o
)->
c
.
’v
 = 
	`hv®ue
(
L
->
tİ
 - 1);

746 
LUA_TUSERDATA
:

747 
	`uv®ue
(
o
)->
’v
 = 
	`hv®ue
(
L
->
tİ
 - 1);

749 
LUA_TTHREAD
:

750 
	`£thv®ue
(
L
, 
	`gt
(
	`thv®ue
(
o
)), 
	`hv®ue
(L->
tİ
 - 1));

753 
»s
 = 0;

756 ià(
»s
è
	`luaC_objb¬r›r
(
L
, 
	`gcv®ue
(
o
), 
	`hv®ue
(L->
tİ
 - 1));

757 
L
->
tİ
--;

758 
	`lua_uÆock
(
L
);

759  
»s
;

760 
	}
}

768 
	#adju¡»suÉs
(
L
,
Äes
) \

769 { ià(
Äes
 =ğ
LUA_MULTRET
 && 
L
->
tİ
 >ğL->
ci
->tİèL->ci->tİ = L->tİ; }

	)

772 
	#check»suÉs
(
L
,
Ç
,
Ä
) \

773 
	`­i_check
(
L
, (
Ä
è=ğ
LUA_MULTRET
 || (L->
ci
->
tİ
 - L->tİ >ğÒrè- (
Ç
)))

	)

776 
LUA_API
 
	$lua_ÿÎ
 (
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
) {

777 
StkId
 
func
;

778 
	`lua_lock
(
L
);

779 
	`­i_checkÃËms
(
L
, 
Çrgs
+1);

780 
	`check»suÉs
(
L
, 
Çrgs
, 
ÄesuÉs
);

781 
func
 = 
L
->
tİ
 - (
Çrgs
+1);

782 
	`luaD_ÿÎ
(
L
, 
func
, 
ÄesuÉs
);

783 
	`adju¡»suÉs
(
L
, 
ÄesuÉs
);

784 
	`lua_uÆock
(
L
);

785 
	}
}

792 
	sC®lS
 {

793 
StkId
 
	mfunc
;

794 
	mÄesuÉs
;

798 
	$f_ÿÎ
 (
lua_S‹
 *
L
, *
ud
) {

799 
C®lS
 *
c
 = 
	`ÿ¡
(C®lS *, 
ud
);

800 
	`luaD_ÿÎ
(
L
, 
c
->
func
, c->
ÄesuÉs
);

801 
	}
}

805 
LUA_API
 
	$lua_pÿÎ
 (
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
, 
”rfunc
) {

806 
C®lS
 
c
;

807 
¡©us
;

808 
±rdiff_t
 
func
;

809 
	`lua_lock
(
L
);

810 
	`­i_checkÃËms
(
L
, 
Çrgs
+1);

811 
	`check»suÉs
(
L
, 
Çrgs
, 
ÄesuÉs
);

812 ià(
”rfunc
 == 0)

813 
func
 = 0;

815 
StkId
 
o
 = 
	`šdex2adr
(
L
, 
”rfunc
);

816 
	`­i_checkv®idšdex
(
L
, 
o
);

817 
func
 = 
	`§ve¡ack
(
L
, 
o
);

819 
c
.
func
 = 
L
->
tİ
 - (
Çrgs
+1);

820 
c
.
ÄesuÉs
 =‚results;

821 
¡©us
 = 
	`luaD_pÿÎ
(
L
, 
f_ÿÎ
, &
c
, 
	`§ve¡ack
(L, c.
func
), func);

822 
	`adju¡»suÉs
(
L
, 
ÄesuÉs
);

823 
	`lua_uÆock
(
L
);

824  
¡©us
;

825 
	}
}

831 
	sCC®lS
 {

832 
lua_CFunùiÚ
 
	mfunc
;

833 *
	mud
;

837 
	$f_CÿÎ
 (
lua_S‹
 *
L
, *
ud
) {

838 
CC®lS
 *
c
 = 
	`ÿ¡
(CC®lS *, 
ud
);

839 
Closu»
 *
ş
;

840 
ş
 = 
	`luaF_ÃwCşosu»
(
L
, 0, 
	`g‘cu¼’v
(L));

841 
ş
->
c
.
f
 = c->
func
;

842 
	`£tşv®ue
(
L
, L->
tİ
, 
ş
);

843 
	`­i_šü_tİ
(
L
);

844 
	`£v®ue
(
L
->
tİ
, 
c
->
ud
);

845 
	`­i_šü_tİ
(
L
);

846 
	`luaD_ÿÎ
(
L
, L->
tİ
 - 2, 0);

847 
	}
}

850 
LUA_API
 
	$lua_ıÿÎ
 (
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
func
, *
ud
) {

851 
CC®lS
 
c
;

852 
¡©us
;

853 
	`lua_lock
(
L
);

854 
c
.
func
 = func;

855 
c
.
ud
 = ud;

856 
¡©us
 = 
	`luaD_pÿÎ
(
L
, 
f_CÿÎ
, &
c
, 
	`§ve¡ack
(L, L->
tİ
), 0);

857 
	`lua_uÆock
(
L
);

858  
¡©us
;

859 
	}
}

862 
LUA_API
 
	$lua_lßd
 (
lua_S‹
 *
L
, 
lua_R—d”
 
»ad”
, *
d©a
,

863 cÚ¡ *
chunkÇme
) {

864 
ZIO
 
z
;

865 
¡©us
;

866 
	`lua_lock
(
L
);

867 ià(!
chunkÇme
) chunkname = "?";

868 
	`luaZ_š™
(
L
, &
z
, 
»ad”
, 
d©a
);

869 
¡©us
 = 
	`luaD_´Ùeùed·r£r
(
L
, &
z
, 
chunkÇme
);

870 
	`lua_uÆock
(
L
);

871  
¡©us
;

872 
	}
}

875 
LUA_API
 
	$lua_dump
 (
lua_S‹
 *
L
, 
lua_Wr™”
 
wr™”
, *
d©a
) {

876 
¡©us
;

877 
TV®ue
 *
o
;

878 
	`lua_lock
(
L
);

879 
	`­i_checkÃËms
(
L
, 1);

880 
o
 = 
L
->
tİ
 - 1;

881 ià(
	`isLfunùiÚ
(
o
))

882 
¡©us
 = 
	`luaU_dump
(
L
, 
	`şv®ue
(
o
)->
l
.
p
, 
wr™”
, 
d©a
, 0);

884 
¡©us
 = 1;

885 
	`lua_uÆock
(
L
);

886  
¡©us
;

887 
	}
}

890 
LUA_API
 
	$lua_¡©us
 (
lua_S‹
 *
L
) {

891  
L
->
¡©us
;

892 
	}
}

899 
LUA_API
 
	$lua_gc
 (
lua_S‹
 *
L
, 
wh©
, 
d©a
) {

900 
»s
 = 0;

901 
glob®_S‹
 *
g
;

902 
	`lua_lock
(
L
);

903 
g
 = 
	`G
(
L
);

904 
wh©
) {

905 
LUA_GCSTOP
: {

906 
g
->
GCth»shŞd
 = 
MAX_LUMEM
;

909 
LUA_GCRESTART
: {

910 
g
->
GCth»shŞd
 = g->
tÙ®by‹s
;

913 
LUA_GCCOLLECT
: {

914 
	`luaC_fuÎgc
(
L
);

917 
LUA_GCCOUNT
: {

919 
»s
 = 
	`ÿ¡_št
(
g
->
tÙ®by‹s
 >> 10);

922 
LUA_GCCOUNTB
: {

923 
»s
 = 
	`ÿ¡_št
(
g
->
tÙ®by‹s
 & 0x3ff);

926 
LUA_GCSTEP
: {

927 
lu_mem
 
a
 = (
	`ÿ¡
Öu_mem, 
d©a
) << 10);

928 ià(
a
 <ğ
g
->
tÙ®by‹s
)

929 
g
->
GCth»shŞd
 = g->
tÙ®by‹s
 - 
a
;

931 
g
->
GCth»shŞd
 = 0;

932 
g
->
GCth»shŞd
 <ğg->
tÙ®by‹s
) {

933 
	`luaC_¡•
(
L
);

934 ià(
g
->
gc¡©e
 =ğ
GCS·u£
) {

935 
»s
 = 1;

941 
LUA_GCSETPAUSE
: {

942 
»s
 = 
g
->
gıau£
;

943 
g
->
gıau£
 = 
d©a
;

946 
LUA_GCSETSTEPMUL
: {

947 
»s
 = 
g
->
gc¡•mul
;

948 
g
->
gc¡•mul
 = 
d©a
;

951 : 
»s
 = -1;

953 
	`lua_uÆock
(
L
);

954  
»s
;

955 
	}
}

964 
LUA_API
 
	$lua_”rÜ
 (
lua_S‹
 *
L
) {

965 
	`lua_lock
(
L
);

966 
	`­i_checkÃËms
(
L
, 1);

967 
	`luaG_”rÜmsg
(
L
);

968 
	`lua_uÆock
(
L
);

970 
	}
}

973 
LUA_API
 
	$lua_Ãxt
 (
lua_S‹
 *
L
, 
idx
) {

974 
StkId
 
t
;

975 
mÜe
;

976 
	`lua_lock
(
L
);

977 
t
 = 
	`šdex2adr
(
L
, 
idx
);

978 
	`­i_check
(
L
, 
	`‰i¡abË
(
t
));

979 
mÜe
 = 
	`luaH_Ãxt
(
L
, 
	`hv®ue
(
t
), L->
tİ
 - 1);

980 ià(
mÜe
) {

981 
	`­i_šü_tİ
(
L
);

984 
L
->
tİ
 -= 1;

985 
	`lua_uÆock
(
L
);

986  
mÜe
;

987 
	}
}

990 
LUA_API
 
	$lua_cÚÿt
 (
lua_S‹
 *
L
, 
n
) {

991 
	`lua_lock
(
L
);

992 
	`­i_checkÃËms
(
L
, 
n
);

993 ià(
n
 >= 2) {

994 
	`luaC_checkGC
(
L
);

995 
	`luaV_cÚÿt
(
L
, 
n
, 
	`ÿ¡_št
(L->
tİ
 - L->
ba£
) - 1);

996 
L
->
tİ
 -ğ(
n
-1);

998 ià(
n
 == 0) {

999 
	`£tsv®ue2s
(
L
, L->
tİ
, 
	`luaS_Ãwl¡r
(L, "", 0));

1000 
	`­i_šü_tİ
(
L
);

1003 
	`lua_uÆock
(
L
);

1004 
	}
}

1007 
LUA_API
 
lua_AÎoc
 
	$lua_g‘®locf
 (
lua_S‹
 *
L
, **
ud
) {

1008 
lua_AÎoc
 
f
;

1009 
	`lua_lock
(
L
);

1010 ià(
ud
è*ud = 
	`G
(
L
)->ud;

1011 
f
 = 
	`G
(
L
)->
ä—Îoc
;

1012 
	`lua_uÆock
(
L
);

1013  
f
;

1014 
	}
}

1017 
LUA_API
 
	$lua_£Îocf
 (
lua_S‹
 *
L
, 
lua_AÎoc
 
f
, *
ud
) {

1018 
	`lua_lock
(
L
);

1019 
	`G
(
L
)->
ud
 = ud;

1020 
	`G
(
L
)->
ä—Îoc
 = 
f
;

1021 
	`lua_uÆock
(
L
);

1022 
	}
}

1025 
LUA_API
 *
	$lua_Ãwu£rd©a
 (
lua_S‹
 *
L
, 
size_t
 
size
) {

1026 
Ud©a
 *
u
;

1027 
	`lua_lock
(
L
);

1028 
	`luaC_checkGC
(
L
);

1029 
u
 = 
	`luaS_Ãwud©a
(
L
, 
size
, 
	`g‘cu¼’v
(L));

1030 
	`£tuv®ue
(
L
, L->
tİ
, 
u
);

1031 
	`­i_šü_tİ
(
L
);

1032 
	`lua_uÆock
(
L
);

1033  
u
 + 1;

1034 
	}
}

1039 cÚ¡ *
	$aux_upv®ue
 (
StkId
 
fi
, 
n
, 
TV®ue
 **
v®
) {

1040 
Closu»
 *
f
;

1041 ià(!
	`‰isfunùiÚ
(
fi
)è 
NULL
;

1042 
f
 = 
	`şv®ue
(
fi
);

1043 ià(
f
->
c
.
isC
) {

1044 ià(!(1 <ğ
n
 &&‚ <ğ
f
->
c
.
nupv®ues
)è 
NULL
;

1045 *
v®
 = &
f
->
c
.
upv®ue
[
n
-1];

1049 
PrÙo
 *
p
 = 
f
->
l
.p;

1050 ià(!(1 <ğ
n
 &&‚ <ğ
p
->
sizeupv®ues
)è 
NULL
;

1051 *
v®
 = 
f
->
l
.
upv®s
[
n
-1]->
v
;

1052  
	`g‘¡r
(
p
->
upv®ues
[
n
-1]);

1054 
	}
}

1057 
LUA_API
 cÚ¡ *
	$lua_g‘upv®ue
 (
lua_S‹
 *
L
, 
funcšdex
, 
n
) {

1058 cÚ¡ *
Çme
;

1059 
TV®ue
 *
v®
;

1060 
	`lua_lock
(
L
);

1061 
Çme
 = 
	`aux_upv®ue
(
	`šdex2adr
(
L
, 
funcšdex
), 
n
, &
v®
);

1062 ià(
Çme
) {

1063 
	`£tobj2s
(
L
, L->
tİ
, 
v®
);

1064 
	`­i_šü_tİ
(
L
);

1066 
	`lua_uÆock
(
L
);

1067  
Çme
;

1068 
	}
}

1071 
LUA_API
 cÚ¡ *
	$lua_£tupv®ue
 (
lua_S‹
 *
L
, 
funcšdex
, 
n
) {

1072 cÚ¡ *
Çme
;

1073 
TV®ue
 *
v®
;

1074 
StkId
 
fi
;

1075 
	`lua_lock
(
L
);

1076 
fi
 = 
	`šdex2adr
(
L
, 
funcšdex
);

1077 
	`­i_checkÃËms
(
L
, 1);

1078 
Çme
 = 
	`aux_upv®ue
(
fi
, 
n
, &
v®
);

1079 ià(
Çme
) {

1080 
L
->
tİ
--;

1081 
	`£tobj
(
L
, 
v®
, L->
tİ
);

1082 
	`luaC_b¬r›r
(
L
, 
	`şv®ue
(
fi
), L->
tİ
);

1084 
	`lua_uÆock
(
L
);

1085  
Çme
;

1086 
	}
}

	@deps/lua/src/lapi.h

7 #iâdeà
Ïpi_h


8 
	#Ïpi_h


	)

11 
	~"lobjeù.h
"

14 
LUAI_FUNC
 
luaA_pushobjeù
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
);

	@deps/lua/src/lauxlib.c

8 
	~<ùy³.h
>

9 
	~<”ºo.h
>

10 
	~<¡d¬g.h
>

11 
	~<¡dio.h
>

12 
	~<¡dlib.h
>

13 
	~<¡ršg.h
>

20 
	#Ïuxlib_c


	)

21 
	#LUA_LIB


	)

23 
	~"lua.h
"

25 
	~"Ïuxlib.h
"

28 
	#FREELIST_REF
 0

	)

32 
	#abs_šdex
(
L
, 
i
è((iè> 0 || (iè<ğ
LUA_REGISTRYINDEX
 ? (i) : \

33 
	`lua_g‘tİ
(
L
è+ (
i
è+ 1)

	)

43 
LUALIB_API
 
	$luaL_¬g”rÜ
 (
lua_S‹
 *
L
, 
Çrg
, cÚ¡ *
exŒamsg
) {

44 
lua_Debug
 
¬
;

45 ià(!
	`lua_g‘¡ack
(
L
, 0, &
¬
))

46  
	`luaL_”rÜ
(
L
, "bad‡rgum’ˆ#%d (%s)", 
Çrg
, 
exŒamsg
);

47 
	`lua_g‘šfo
(
L
, "n", &
¬
);

48 ià(
	`¡rcmp
(
¬
.
Çmewh©
, "method") == 0) {

49 
Çrg
--;

50 ià(
Çrg
 == 0)

51  
	`luaL_”rÜ
(
L
, "ÿÎšg " 
LUA_QS
 " on bad self (%s)",

52 
¬
.
Çme
, 
exŒamsg
);

54 ià(
¬
.
Çme
 =ğ
NULL
)

55 
¬
.
Çme
 = "?";

56  
	`luaL_”rÜ
(
L
, "bad‡rgum’ˆ#%dØ" 
LUA_QS
 " (%s)",

57 
Çrg
, 
¬
.
Çme
, 
exŒamsg
);

58 
	}
}

61 
LUALIB_API
 
	$luaL_ty³¼Ü
 (
lua_S‹
 *
L
, 
Çrg
, cÚ¡ *
Šame
) {

62 cÚ¡ *
msg
 = 
	`lua_pushf¡ršg
(
L
, "%sƒxpected, got %s",

63 
Šame
, 
	`luaL_ty³Çme
(
L
, 
Çrg
));

64  
	`luaL_¬g”rÜ
(
L
, 
Çrg
, 
msg
);

65 
	}
}

68 
	$g_”rÜ
 (
lua_S‹
 *
L
, 
Çrg
, 
g
) {

69 
	`luaL_ty³¼Ü
(
L
, 
Çrg
, 
	`lua_ty³Çme
(L, 
g
));

70 
	}
}

73 
LUALIB_API
 
	$luaL_wh”e
 (
lua_S‹
 *
L
, 
Ëv–
) {

74 
lua_Debug
 
¬
;

75 ià(
	`lua_g‘¡ack
(
L
, 
Ëv–
, &
¬
)) {

76 
	`lua_g‘šfo
(
L
, "Sl", &
¬
);

77 ià(
¬
.
cu¼’še
 > 0) {

78 
	`lua_pushf¡ršg
(
L
, "%s:%d: ", 
¬
.
shÜt_¤c
,‡r.
cu¼’še
);

82 
	`lua_pushl™”®
(
L
, "");

83 
	}
}

86 
LUALIB_API
 
	$luaL_”rÜ
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

87 
va_li¡
 
¬gp
;

88 
	`va_¡¬t
(
¬gp
, 
fmt
);

89 
	`luaL_wh”e
(
L
, 1);

90 
	`lua_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

91 
	`va_’d
(
¬gp
);

92 
	`lua_cÚÿt
(
L
, 2);

93  
	`lua_”rÜ
(
L
);

94 
	}
}

99 
LUALIB_API
 
	$luaL_checkİtiÚ
 (
lua_S‹
 *
L
, 
Çrg
, cÚ¡ *
def
,

100 cÚ¡ *cÚ¡ 
l¡
[]) {

101 cÚ¡ *
Çme
 = (
def
è? 
	`luaL_İt¡ršg
(
L
, 
Çrg
, def) :

102 
	`luaL_check¡ršg
(
L
, 
Çrg
);

103 
i
;

104 
i
=0; 
l¡
[i]; i++)

105 ià(
	`¡rcmp
(
l¡
[
i
], 
Çme
) == 0)

106  
i
;

107  
	`luaL_¬g”rÜ
(
L
, 
Çrg
,

108 
	`lua_pushf¡ršg
(
L
, "šv®id o±iÚ " 
LUA_QS
, 
Çme
));

109 
	}
}

112 
LUALIB_API
 
	$luaL_Ãwm‘©abË
 (
lua_S‹
 *
L
, cÚ¡ *
Šame
) {

113 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
Šame
);

114 ià(!
	`lua_i¢
(
L
, -1))

116 
	`lua_pİ
(
L
, 1);

117 
	`lua_ÃwbË
(
L
);

118 
	`lua_pushv®ue
(
L
, -1);

119 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
Šame
);

121 
	}
}

124 
LUALIB_API
 *
	$luaL_checkud©a
 (
lua_S‹
 *
L
, 
ud
, cÚ¡ *
Šame
) {

125 *
p
 = 
	`lua_tou£rd©a
(
L
, 
ud
);

126 ià(
p
 !ğ
NULL
) {

127 ià(
	`lua_g‘m‘©abË
(
L
, 
ud
)) {

128 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
Šame
);

129 ià(
	`lua_¿wequ®
(
L
, -1, -2)) {

130 
	`lua_pİ
(
L
, 2);

131  
p
;

135 
	`luaL_ty³¼Ü
(
L
, 
ud
, 
Šame
);

136  
NULL
;

137 
	}
}

140 
LUALIB_API
 
	$luaL_check¡ack
 (
lua_S‹
 *
L
, 
¥aû
, cÚ¡ *
mes
) {

141 ià(!
	`lua_check¡ack
(
L
, 
¥aû
))

142 
	`luaL_”rÜ
(
L
, "¡ack ov”æow (%s)", 
mes
);

143 
	}
}

146 
LUALIB_API
 
	$luaL_checkty³
 (
lua_S‹
 *
L
, 
Çrg
, 
t
) {

147 ià(
	`lua_ty³
(
L
, 
Çrg
è!ğ
t
)

148 
	`g_”rÜ
(
L
, 
Çrg
, 
t
);

149 
	}
}

152 
LUALIB_API
 
	$luaL_checkªy
 (
lua_S‹
 *
L
, 
Çrg
) {

153 ià(
	`lua_ty³
(
L
, 
Çrg
è=ğ
LUA_TNONE
)

154 
	`luaL_¬g”rÜ
(
L
, 
Çrg
, "valueƒxpected");

155 
	}
}

158 
LUALIB_API
 cÚ¡ *
	$luaL_checkl¡ršg
 (
lua_S‹
 *
L
, 
Çrg
, 
size_t
 *
Ën
) {

159 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, 
Çrg
, 
Ën
);

160 ià(!
s
è
	`g_”rÜ
(
L
, 
Çrg
, 
LUA_TSTRING
);

161  
s
;

162 
	}
}

165 
LUALIB_API
 cÚ¡ *
	$luaL_İ¡ršg
 (
lua_S‹
 *
L
, 
Çrg
,

166 cÚ¡ *
def
, 
size_t
 *
Ën
) {

167 ià(
	`lua_i¢ÚeÜn
(
L
, 
Çrg
)) {

168 ià(
Ën
)

169 *
Ën
 = (
def
 ? 
	`¡¾’
(def) : 0);

170  
def
;

172  
	`luaL_checkl¡ršg
(
L
, 
Çrg
, 
Ën
);

173 
	}
}

176 
LUALIB_API
 
lua_Numb”
 
	$luaL_checknumb”
 (
lua_S‹
 *
L
, 
Çrg
) {

177 
lua_Numb”
 
d
 = 
	`lua_tÚumb”
(
L
, 
Çrg
);

178 ià(
d
 =ğ0 && !
	`lua_i¢umb”
(
L
, 
Çrg
))

179 
	`g_”rÜ
(
L
, 
Çrg
, 
LUA_TNUMBER
);

180  
d
;

181 
	}
}

184 
LUALIB_API
 
lua_Numb”
 
	$luaL_İŠumb”
 (
lua_S‹
 *
L
, 
Çrg
, 
lua_Numb”
 
def
) {

185  
	`luaL_İt
(
L
, 
luaL_checknumb”
, 
Çrg
, 
def
);

186 
	}
}

189 
LUALIB_API
 
lua_IÁeg”
 
	$luaL_checkš‹g”
 (
lua_S‹
 *
L
, 
Çrg
) {

190 
lua_IÁeg”
 
d
 = 
	`lua_toš‹g”
(
L
, 
Çrg
);

191 ià(
d
 =ğ0 && !
	`lua_i¢umb”
(
L
, 
Çrg
))

192 
	`g_”rÜ
(
L
, 
Çrg
, 
LUA_TNUMBER
);

193  
d
;

194 
	}
}

197 
LUALIB_API
 
lua_IÁeg”
 
	$luaL_İtš‹g”
 (
lua_S‹
 *
L
, 
Çrg
,

198 
lua_IÁeg”
 
def
) {

199  
	`luaL_İt
(
L
, 
luaL_checkš‹g”
, 
Çrg
, 
def
);

200 
	}
}

203 
LUALIB_API
 
	$luaL_g‘m‘af›ld
 (
lua_S‹
 *
L
, 
obj
, cÚ¡ *
ev’t
) {

204 ià(!
	`lua_g‘m‘©abË
(
L
, 
obj
))

206 
	`lua_push¡ršg
(
L
, 
ev’t
);

207 
	`lua_¿wg‘
(
L
, -2);

208 ià(
	`lua_i¢
(
L
, -1)) {

209 
	`lua_pİ
(
L
, 2);

213 
	`lua_»move
(
L
, -2);

216 
	}
}

219 
LUALIB_API
 
	$luaL_ÿÎm‘a
 (
lua_S‹
 *
L
, 
obj
, cÚ¡ *
ev’t
) {

220 
obj
 = 
	`abs_šdex
(
L
, obj);

221 ià(!
	`luaL_g‘m‘af›ld
(
L
, 
obj
, 
ev’t
))

223 
	`lua_pushv®ue
(
L
, 
obj
);

224 
	`lua_ÿÎ
(
L
, 1, 1);

226 
	}
}

229 
LUALIB_API
 (
luaL_»gi¡”
è(
lua_S‹
 *
L
, cÚ¡ *
libÇme
,

230 cÚ¡ 
luaL_Reg
 *
l
) {

231 
	`luaI_İ’lib
(
L
, 
libÇme
, 
l
, 0);

232 
	}
}

235 
	$libsize
 (cÚ¡ 
luaL_Reg
 *
l
) {

236 
size
 = 0;

237 ; 
l
->
Çme
;†++è
size
++;

238  
size
;

239 
	}
}

242 
LUALIB_API
 
	$luaI_İ’lib
 (
lua_S‹
 *
L
, cÚ¡ *
libÇme
,

243 cÚ¡ 
luaL_Reg
 *
l
, 
nup
) {

244 ià(
libÇme
) {

245 
size
 = 
	`libsize
(
l
);

247 
	`luaL_fšdbË
(
L
, 
LUA_REGISTRYINDEX
, "_LOADED", 1);

248 
	`lua_g‘f›ld
(
L
, -1, 
libÇme
);

249 ià(!
	`lua_i¡abË
(
L
, -1)) {

250 
	`lua_pİ
(
L
, 1);

252 ià(
	`luaL_fšdbË
(
L
, 
LUA_GLOBALSINDEX
, 
libÇme
, 
size
è!ğ
NULL
)

253 
	`luaL_”rÜ
(
L
, "ÇmcÚæiù fÜ moduË " 
LUA_QS
, 
libÇme
);

254 
	`lua_pushv®ue
(
L
, -1);

255 
	`lua_£tf›ld
(
L
, -3, 
libÇme
);

257 
	`lua_»move
(
L
, -2);

258 
	`lua_š£¹
(
L
, -(
nup
+1));

260 ; 
l
->
Çme
;†++) {

261 
i
;

262 
i
=0; i<
nup
; i++)

263 
	`lua_pushv®ue
(
L
, -
nup
);

264 
	`lua_pushcşosu»
(
L
, 
l
->
func
, 
nup
);

265 
	`lua_£tf›ld
(
L
, -(
nup
+2), 
l
->
Çme
);

267 
	`lua_pİ
(
L
, 
nup
);

268 
	}
}

278 #ià
defšed
(
LUA_COMPAT_GETN
)

280 
	$checkšt
 (
lua_S‹
 *
L
, 
tİİ
) {

281 
n
 = (
	`lua_ty³
(
L
, -1è=ğ
LUA_TNUMBER
è? 
	`lua_toš‹g”
(L, -1) : -1;

282 
	`lua_pİ
(
L
, 
tİİ
);

283  
n
;

284 
	}
}

287 
	$g‘sizes
 (
lua_S‹
 *
L
) {

288 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, "LUA_SIZES");

289 ià(
	`lua_i¢
(
L
, -1)) {

290 
	`lua_pİ
(
L
, 1);

291 
	`lua_ÃwbË
(
L
);

292 
	`lua_pushv®ue
(
L
, -1);

293 
	`lua_£tm‘©abË
(
L
, -2);

294 
	`lua_pushl™”®
(
L
, "kv");

295 
	`lua_£tf›ld
(
L
, -2, "__mode");

296 
	`lua_pushv®ue
(
L
, -1);

297 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, "LUA_SIZES");

299 
	}
}

302 
LUALIB_API
 
	$luaL_£Š
 (
lua_S‹
 *
L
, 
t
, 
n
) {

303 
t
 = 
	`abs_šdex
(
L
,);

304 
	`lua_pushl™”®
(
L
, "n");

305 
	`lua_¿wg‘
(
L
, 
t
);

306 ià(
	`checkšt
(
L
, 1) >= 0) {

307 
	`lua_pushl™”®
(
L
, "n");

308 
	`lua_pushš‹g”
(
L
, 
n
);

309 
	`lua_¿w£t
(
L
, 
t
);

312 
	`g‘sizes
(
L
);

313 
	`lua_pushv®ue
(
L
, 
t
);

314 
	`lua_pushš‹g”
(
L
, 
n
);

315 
	`lua_¿w£t
(
L
, -3);

316 
	`lua_pİ
(
L
, 1);

318 
	}
}

321 
LUALIB_API
 
	$luaL_g‘n
 (
lua_S‹
 *
L
, 
t
) {

322 
n
;

323 
t
 = 
	`abs_šdex
(
L
,);

324 
	`lua_pushl™”®
(
L
, "n");

325 
	`lua_¿wg‘
(
L
, 
t
);

326 ià((
n
 = 
	`checkšt
(
L
, 1)) >= 0) ‚;

327 
	`g‘sizes
(
L
);

328 
	`lua_pushv®ue
(
L
, 
t
);

329 
	`lua_¿wg‘
(
L
, -2);

330 ià((
n
 = 
	`checkšt
(
L
, 2)) >= 0) ‚;

331  ()
	`lua_objËn
(
L
, 
t
);

332 
	}
}

340 
LUALIB_API
 cÚ¡ *
	$luaL_gsub
 (
lua_S‹
 *
L
, cÚ¡ *
s
, cÚ¡ *
p
,

341 cÚ¡ *
r
) {

342 cÚ¡ *
wd
;

343 
size_t
 
l
 = 
	`¡¾’
(
p
);

344 
luaL_Bufãr
 
b
;

345 
	`luaL_buffš™
(
L
, &
b
);

346 (
wd
 = 
	`¡r¡r
(
s
, 
p
)è!ğ
NULL
) {

347 
	`luaL_addl¡ršg
(&
b
, 
s
, 
wd
 - s);

348 
	`luaL_add¡ršg
(&
b
, 
r
);

349 
s
 = 
wd
 + 
l
;

351 
	`luaL_add¡ršg
(&
b
, 
s
);

352 
	`luaL_push»suÉ
(&
b
);

353  
	`lua_to¡ršg
(
L
, -1);

354 
	}
}

357 
LUALIB_API
 cÚ¡ *
	$luaL_fšdbË
 (
lua_S‹
 *
L
, 
idx
,

358 cÚ¡ *
âame
, 
szhšt
) {

359 cÚ¡ *
e
;

360 
	`lua_pushv®ue
(
L
, 
idx
);

362 
e
 = 
	`¡rchr
(
âame
, '.');

363 ià(
e
 =ğ
NULL
èğ
âame
 + 
	`¡¾’
(fname);

364 
	`lua_pushl¡ršg
(
L
, 
âame
, 
e
 - fname);

365 
	`lua_¿wg‘
(
L
, -2);

366 ià(
	`lua_i¢
(
L
, -1)) {

367 
	`lua_pİ
(
L
, 1);

368 
	`lua_ü—‹bË
(
L
, 0, (*
e
 =ğ'.' ? 1 : 
szhšt
));

369 
	`lua_pushl¡ršg
(
L
, 
âame
, 
e
 - fname);

370 
	`lua_pushv®ue
(
L
, -2);

371 
	`lua_£‰abË
(
L
, -4);

373 ià(!
	`lua_i¡abË
(
L
, -1)) {

374 
	`lua_pİ
(
L
, 2);

375  
âame
;

377 
	`lua_»move
(
L
, -2);

378 
âame
 = 
e
 + 1;

379 } *
e
 == '.');

380  
NULL
;

381 
	}
}

392 
	#bufæ’
(
B
è((B)->
p
 - (B)->
bufãr
)

	)

393 
	#buffä“
(
B
è((
size_t
)(
LUAL_BUFFERSIZE
 - 
	`bufæ’
(B)))

	)

395 
	#LIMIT
 (
LUA_MINSTACK
/2)

	)

398 
	$em±ybufãr
 (
luaL_Bufãr
 *
B
) {

399 
size_t
 
l
 = 
	`bufæ’
(
B
);

400 ià(
l
 == 0)  0;

402 
	`lua_pushl¡ršg
(
B
->
L
, B->
bufãr
, 
l
);

403 
B
->
p
 = B->
bufãr
;

404 
B
->
lvl
++;

407 
	}
}

410 
	$adju¡¡ack
 (
luaL_Bufãr
 *
B
) {

411 ià(
B
->
lvl
 > 1) {

412 
lua_S‹
 *
L
 = 
B
->L;

413 
tog‘
 = 1;

414 
size_t
 
tİËn
 = 
	`lua_¡¾’
(
L
, -1);

416 
size_t
 
l
 = 
	`lua_¡¾’
(
L
, -(
tog‘
+1));

417 ià(
B
->
lvl
 - 
tog‘
 + 1 >ğ
LIMIT
 || 
tİËn
 > 
l
) {

418 
tİËn
 +ğ
l
;

419 
tog‘
++;

422 } 
tog‘
 < 
B
->
lvl
);

423 
	`lua_cÚÿt
(
L
, 
tog‘
);

424 
B
->
lvl
 = B->lvÈ- 
tog‘
 + 1;

426 
	}
}

429 
LUALIB_API
 *
	$luaL_´•bufãr
 (
luaL_Bufãr
 *
B
) {

430 ià(
	`em±ybufãr
(
B
))

431 
	`adju¡¡ack
(
B
);

432  
B
->
bufãr
;

433 
	}
}

436 
LUALIB_API
 
	$luaL_addl¡ršg
 (
luaL_Bufãr
 *
B
, cÚ¡ *
s
, 
size_t
 
l
) {

437 
l
--)

438 
	`luaL_addch¬
(
B
, *
s
++);

439 
	}
}

442 
LUALIB_API
 
	$luaL_add¡ršg
 (
luaL_Bufãr
 *
B
, cÚ¡ *
s
) {

443 
	`luaL_addl¡ršg
(
B
, 
s
, 
	`¡¾’
(s));

444 
	}
}

447 
LUALIB_API
 
	$luaL_push»suÉ
 (
luaL_Bufãr
 *
B
) {

448 
	`em±ybufãr
(
B
);

449 
	`lua_cÚÿt
(
B
->
L
, B->
lvl
);

450 
B
->
lvl
 = 1;

451 
	}
}

454 
LUALIB_API
 
	$luaL_addv®ue
 (
luaL_Bufãr
 *
B
) {

455 
lua_S‹
 *
L
 = 
B
->L;

456 
size_t
 
vl
;

457 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
vl
);

458 ià(
vl
 <ğ
	`buffä“
(
B
)) {

459 
	`memıy
(
B
->
p
, 
s
, 
vl
);

460 
B
->
p
 +ğ
vl
;

461 
	`lua_pİ
(
L
, 1);

464 ià(
	`em±ybufãr
(
B
))

465 
	`lua_š£¹
(
L
, -2);

466 
B
->
lvl
++;

467 
	`adju¡¡ack
(
B
);

469 
	}
}

472 
LUALIB_API
 
	$luaL_buffš™
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
B
) {

473 
B
->
L
 = L;

474 
B
->
p
 = B->
bufãr
;

475 
B
->
lvl
 = 0;

476 
	}
}

481 
LUALIB_API
 
	$luaL_»f
 (
lua_S‹
 *
L
, 
t
) {

482 
»f
;

483 
t
 = 
	`abs_šdex
(
L
,);

484 ià(
	`lua_i¢
(
L
, -1)) {

485 
	`lua_pİ
(
L
, 1);

486  
LUA_REFNIL
;

488 
	`lua_¿wg‘i
(
L
, 
t
, 
FREELIST_REF
);

489 
»f
 = ()
	`lua_toš‹g”
(
L
, -1);

490 
	`lua_pİ
(
L
, 1);

491 ià(
»f
 != 0) {

492 
	`lua_¿wg‘i
(
L
, 
t
, 
»f
);

493 
	`lua_¿w£ti
(
L
, 
t
, 
FREELIST_REF
);

496 
»f
 = ()
	`lua_objËn
(
L
, 
t
);

497 
»f
++;

499 
	`lua_¿w£ti
(
L
, 
t
, 
»f
);

500  
»f
;

501 
	}
}

504 
LUALIB_API
 
	$luaL_uÄef
 (
lua_S‹
 *
L
, 
t
, 
»f
) {

505 ià(
»f
 >= 0) {

506 
t
 = 
	`abs_šdex
(
L
,);

507 
	`lua_¿wg‘i
(
L
, 
t
, 
FREELIST_REF
);

508 
	`lua_¿w£ti
(
L
, 
t
, 
»f
);

509 
	`lua_pushš‹g”
(
L
, 
»f
);

510 
	`lua_¿w£ti
(
L
, 
t
, 
FREELIST_REF
);

512 
	}
}

522 
	sLßdF
 {

523 
	mexŒ®še
;

524 
FILE
 *
	mf
;

525 
	mbuff
[
LUAL_BUFFERSIZE
];

526 } 
	tLßdF
;

529 cÚ¡ *
	$g‘F
 (
lua_S‹
 *
L
, *
ud
, 
size_t
 *
size
) {

530 
LßdF
 *
lf
 = (LßdF *)
ud
;

531 ()
L
;

532 ià(
lf
->
exŒ®še
) {

533 
lf
->
exŒ®še
 = 0;

534 *
size
 = 1;

537 ià(
	`ãof
(
lf
->
f
)è 
NULL
;

538 *
size
 = 
	`ä—d
(
lf
->
buff
, 1, Öf->buff),†f->
f
);

539  (*
size
 > 0è? 
lf
->
buff
 : 
NULL
;

540 
	}
}

543 
	$”rfe
 (
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
âamešdex
) {

544 cÚ¡ *
£¼
 = 
	`¡»¼Ü
(
”ºo
);

545 cÚ¡ *
f’ame
 = 
	`lua_to¡ršg
(
L
, 
âamešdex
) + 1;

546 
	`lua_pushf¡ršg
(
L
, "ÿÂÙ % %s: %s", 
wh©
, 
f’ame
, 
£¼
);

547 
	`lua_»move
(
L
, 
âamešdex
);

548  
LUA_ERRFILE
;

549 
	}
}

552 
LUALIB_API
 
	$luaL_lßdfe
 (
lua_S‹
 *
L
, cÚ¡ *
f’ame
) {

553 
LßdF
 
lf
;

554 
¡©us
, 
»ad¡©us
;

555 
c
;

556 
âamešdex
 = 
	`lua_g‘tİ
(
L
) + 1;

557 
lf
.
exŒ®še
 = 0;

558 ià(
f’ame
 =ğ
NULL
) {

559 
	`lua_pushl™”®
(
L
, "=stdin");

560 
lf
.
f
 = 
¡dš
;

563 
	`lua_pushf¡ršg
(
L
, "@%s", 
f’ame
);

564 
lf
.
f
 = 
	`fİ’
(
f’ame
, "r");

565 ià(
lf
.
f
 =ğ
NULL
è 
	`”rfe
(
L
, "İ’", 
âamešdex
);

567 
c
 = 
	`g‘c
(
lf
.
f
);

568 ià(
c
 == '#') {

569 
lf
.
exŒ®še
 = 1;

570 (
c
 = 
	`g‘c
(
lf
.
f
)è!ğ
EOF
 && c != '\n') ;

571 ià(
c
 =ğ'\n'èøğ
	`g‘c
(
lf
.
f
);

573 ià(
c
 =ğ
LUA_SIGNATURE
[0] && 
f’ame
) {

574 
	`´štf
("%s: o³nšg usšg„eİ’\n", 
__func__
);

575 
lf
.
f
 = 
	`äeİ’
(
f’ame
, "rb",†f.f);

576 ià(
lf
.
f
 =ğ
NULL
è 
	`”rfe
(
L
, "»İ’", 
âamešdex
);

578 (
c
 = 
	`g‘c
(
lf
.
f
)è!ğ
EOF
 && c !ğ
LUA_SIGNATURE
[0]) ;

579 
lf
.
exŒ®še
 = 0;

581 
	`ung‘c
(
c
, 
lf
.
f
);

582 
¡©us
 = 
	`lua_lßd
(
L
, 
g‘F
, &
lf
, 
	`lua_to¡ršg
(L, -1));

583 
»ad¡©us
 = 
	`ã¼Ü
(
lf
.
f
);

584 ià(
f’ame
è
	`fşo£
(
lf
.
f
);

585 ià(
»ad¡©us
) {

586 
	`lua_£‰İ
(
L
, 
âamešdex
);

587  
	`”rfe
(
L
, "»ad", 
âamešdex
);

589 
	`lua_»move
(
L
, 
âamešdex
);

590  
¡©us
;

591 
	}
}

594 
	sLßdS
 {

595 cÚ¡ *
	ms
;

596 
size_t
 
	msize
;

597 } 
	tLßdS
;

600 cÚ¡ *
	$g‘S
 (
lua_S‹
 *
L
, *
ud
, 
size_t
 *
size
) {

601 
LßdS
 *
ls
 = (LßdS *)
ud
;

602 ()
L
;

603 ià(
ls
->
size
 =ğ0è 
NULL
;

604 *
size
 = 
ls
->size;

605 
ls
->
size
 = 0;

606  
ls
->
s
;

607 
	}
}

610 
LUALIB_API
 
	$luaL_lßdbufãr
 (
lua_S‹
 *
L
, cÚ¡ *
buff
, 
size_t
 
size
,

611 cÚ¡ *
Çme
) {

612 
LßdS
 
ls
;

613 
ls
.
s
 = 
buff
;

614 
ls
.
size
 = size;

615  
	`lua_lßd
(
L
, 
g‘S
, &
ls
, 
Çme
);

616 
	}
}

619 
LUALIB_API
 (
luaL_lßd¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
s
) {

620  
	`luaL_lßdbufãr
(
L
, 
s
, 
	`¡¾’
(s), s);

621 
	}
}

628 *
	$l_®loc
 (*
ud
, *
±r
, 
size_t
 
osize
, size_ˆ
nsize
) {

629 ()
ud
;

630 ()
osize
;

631 ià(
nsize
 == 0) {

632 
	`ä“
(
±r
);

633  
NULL
;

636  
	`»®loc
(
±r
, 
nsize
);

637 
	}
}

640 
	$·nic
 (
lua_S‹
 *
L
) {

641 ()
L
;

642 
	`årštf
(
¡d”r
, "PANIC: unprotectedƒrror in callo Lua API (%s)\n",

643 
	`lua_to¡ršg
(
L
, -1));

645 
	}
}

648 
LUALIB_API
 
lua_S‹
 *
	$luaL_Ãw¡©e
 () {

649 
lua_S‹
 *
L
 = 
	`lua_Ãw¡©e
(
l_®loc
, 
NULL
);

650 ià(
L
è
	`lua_©·nic
(L, &
·nic
);

651  
L
;

652 
	}
}

	@deps/lua/src/lauxlib.h

8 #iâdeà
Ïuxlib_h


9 
	#Ïuxlib_h


	)

12 
	~<¡ddef.h
>

13 
	~<¡dio.h
>

15 
	~"lua.h
"

18 #ià
defšed
(
LUA_COMPAT_GETN
)

19 
LUALIB_API
 (
luaL_g‘n
è(
lua_S‹
 *
L
, 
t
);

20 
LUALIB_API
 (
luaL_£Š
è(
lua_S‹
 *
L
, 
t
, 
n
);

22 
	#luaL_g‘n
(
L
,
i
è(()
	`lua_objËn
(L, i))

	)

23 
	#luaL_£Š
(
L
,
i
,
j
è(()0è

	)

26 #ià
	`defšed
(
LUA_COMPAT_OPENLIB
)

27 
	#luaI_İ’lib
 
luaL_İ’lib


	)

32 
	#LUA_ERRFILE
 (
LUA_ERRERR
+1)

	)

35 
	sluaL_Reg
 {

36 cÚ¡ *
Çme
;

37 
lua_CFunùiÚ
 
func
;

38 } 
	tluaL_Reg
;

42 
LUALIB_API
 (
luaI_İ’lib
è(
lua_S‹
 *
L
, cÚ¡ *
libÇme
,

43 cÚ¡ 
luaL_Reg
 *
l
, 
nup
);

44 
LUALIB_API
 (
luaL_»gi¡”
è(
lua_S‹
 *
L
, cÚ¡ *
libÇme
,

45 cÚ¡ 
luaL_Reg
 *
l
);

46 
LUALIB_API
 (
luaL_g‘m‘af›ld
è(
lua_S‹
 *
L
, 
obj
, cÚ¡ *
e
);

47 
LUALIB_API
 (
luaL_ÿÎm‘a
è(
lua_S‹
 *
L
, 
obj
, cÚ¡ *
e
);

48 
LUALIB_API
 (
luaL_ty³¼Ü
è(
lua_S‹
 *
L
, 
Çrg
, cÚ¡ *
Šame
);

49 
LUALIB_API
 (
luaL_¬g”rÜ
è(
lua_S‹
 *
L
, 
num¬g
, cÚ¡ *
exŒamsg
);

50 
LUALIB_API
 cÚ¡ *(
luaL_checkl¡ršg
è(
lua_S‹
 *
L
, 
numArg
,

51 
size_t
 *
l
);

52 
LUALIB_API
 cÚ¡ *(
luaL_İ¡ršg
è(
lua_S‹
 *
L
, 
numArg
,

53 cÚ¡ *
def
, 
size_t
 *
l
);

54 
LUALIB_API
 
	$lua_Numb”
 (
luaL_checknumb”
è(
lua_S‹
 *
L
, 
numArg
);

55 
LUALIB_API
 
	$lua_Numb”
 (
luaL_İŠumb”
è(
lua_S‹
 *
L
, 
nArg
, 
lua_Numb”
 
def
);

57 
LUALIB_API
 
	$lua_IÁeg”
 (
luaL_checkš‹g”
è(
lua_S‹
 *
L
, 
numArg
);

58 
LUALIB_API
 
	$lua_IÁeg”
 (
luaL_İtš‹g”
è(
lua_S‹
 *
L
, 
nArg
,

59 
lua_IÁeg”
 
def
);

61 
LUALIB_API
 (
luaL_check¡ack
è(
lua_S‹
 *
L
, 
sz
, cÚ¡ *
msg
);

62 
LUALIB_API
 (
luaL_checkty³
è(
lua_S‹
 *
L
, 
Çrg
, 
t
);

63 
LUALIB_API
 (
luaL_checkªy
è(
lua_S‹
 *
L
, 
Çrg
);

65 
LUALIB_API
 (
luaL_Ãwm‘©abË
è(
lua_S‹
 *
L
, cÚ¡ *
Šame
);

66 
LUALIB_API
 *(
luaL_checkud©a
è(
lua_S‹
 *
L
, 
ud
, cÚ¡ *
Šame
);

68 
LUALIB_API
 (
luaL_wh”e
è(
lua_S‹
 *
L
, 
lvl
);

69 
LUALIB_API
 (
luaL_”rÜ
è(
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

71 
LUALIB_API
 (
luaL_checkİtiÚ
è(
lua_S‹
 *
L
, 
Çrg
, cÚ¡ *
def
,

72 cÚ¡ *cÚ¡ 
l¡
[]);

74 
LUALIB_API
 (
luaL_»f
è(
lua_S‹
 *
L
, 
t
);

75 
LUALIB_API
 (
luaL_uÄef
è(
lua_S‹
 *
L
, 
t
, 
»f
);

77 
LUALIB_API
 (
luaL_lßdfe
è(
lua_S‹
 *
L
, cÚ¡ *
f’ame
);

78 
LUALIB_API
 (
luaL_lßdbufãr
è(
lua_S‹
 *
L
, cÚ¡ *
buff
, 
size_t
 
sz
,

79 cÚ¡ *
Çme
);

80 
LUALIB_API
 (
luaL_lßd¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
s
);

82 
LUALIB_API
 
lua_S‹
 *(
luaL_Ãw¡©e
) ();

85 
LUALIB_API
 cÚ¡ *(
luaL_gsub
è(
lua_S‹
 *
L
, cÚ¡ *
s
, cÚ¡ *
p
,

86 cÚ¡ *
r
);

88 
LUALIB_API
 cÚ¡ *(
luaL_fšdbË
è(
lua_S‹
 *
L
, 
idx
,

89 cÚ¡ *
âame
, 
szhšt
);

100 
	#luaL_¬gcheck
(
L
, 
cÚd
,
num¬g
,
exŒamsg
) \

101 (()((
cÚd
è|| 
	`luaL_¬g”rÜ
(
L
, (
num¬g
), (
exŒamsg
))))

	)

102 
	#luaL_check¡ršg
(
L
,
n
è(
	`luaL_checkl¡ršg
(L, (n), 
NULL
))

	)

103 
	#luaL_İt¡ršg
(
L
,
n
,
d
è(
	`luaL_İ¡ršg
(L, (n), (d), 
NULL
))

	)

104 
	#luaL_checkšt
(
L
,
n
è(()
	`luaL_checkš‹g”
(L, (n)))

	)

105 
	#luaL_İtšt
(
L
,
n
,
d
è(()
	`luaL_İtš‹g”
(L, (n), (d)))

	)

106 
	#luaL_checklÚg
(
L
,
n
è(()
	`luaL_checkš‹g”
(L, (n)))

	)

107 
	#luaL_İÚg
(
L
,
n
,
d
è(()
	`luaL_İtš‹g”
(L, (n), (d)))

	)

109 
	#luaL_ty³Çme
(
L
,
i
è
	`lua_ty³Çme
(L, 
	`lua_ty³
(L,(i)))

	)

111 
	#luaL_dofe
(
L
, 
â
) \

112 (
	`luaL_lßdfe
(
L
, 
â
è|| 
	`lua_pÿÎ
(L, 0, 
LUA_MULTRET
, 0))

	)

114 
	#luaL_do¡ršg
(
L
, 
s
) \

115 (
	`luaL_lßd¡ršg
(
L
, 
s
è|| 
	`lua_pÿÎ
(L, 0, 
LUA_MULTRET
, 0))

	)

117 
	#luaL_g‘m‘©abË
(
L
,
n
è(
	`lua_g‘f›ld
(L, 
LUA_REGISTRYINDEX
, (n)))

	)

119 
	#luaL_İt
(
L
,
f
,
n
,
d
è(
	`lua_i¢ÚeÜn
(L,Ò)è? (dè: 
	`f
(L,Ò)))

	)

129 
	sluaL_Bufãr
 {

130 *
p
;

131 
lvl
;

132 
lua_S‹
 *
L
;

133 
bufãr
[
LUAL_BUFFERSIZE
];

134 } 
	tluaL_Bufãr
;

136 
	#luaL_addch¬
(
B
,
c
) \

137 (()((
B
)->
p
 < ((B)->
bufãr
+
LUAL_BUFFERSIZE
è|| 
	`luaL_´•bufãr
(B)), \

138 (*(
B
)->
p
++ = ()(
c
)))

	)

141 
	#luaL_putch¬
(
B
,
c
è
	`luaL_addch¬
(B,c)

	)

143 
	#luaL_addsize
(
B
,
n
è((B)->
p
 +ğÒ))

	)

145 
LUALIB_API
 (
luaL_buffš™
è(
lua_S‹
 *
L
, 
luaL_Bufãr
 *
B
);

146 
LUALIB_API
 *(
luaL_´•bufãr
è(
luaL_Bufãr
 *
B
);

147 
LUALIB_API
 (
luaL_addl¡ršg
è(
luaL_Bufãr
 *
B
, cÚ¡ *
s
, 
size_t
 
l
);

148 
LUALIB_API
 (
luaL_add¡ršg
è(
luaL_Bufãr
 *
B
, cÚ¡ *
s
);

149 
LUALIB_API
 (
luaL_addv®ue
è(
luaL_Bufãr
 *
B
);

150 
LUALIB_API
 (
luaL_push»suÉ
è(
luaL_Bufãr
 *
B
);

159 
	#LUA_NOREF
 (-2)

	)

160 
	#LUA_REFNIL
 (-1)

	)

162 
	#lua_»f
(
L
,
lock
è(Öockè? 
	`luaL_»f
(L, 
LUA_REGISTRYINDEX
) : \

163 (
	`lua_push¡ršg
(
L
, "uÆocked„eã»nû ¬obsŞ‘e"), 
	`lua_”rÜ
(L), 0))

	)

165 
	#lua_uÄef
(
L
,
»f
è
	`luaL_uÄef
(L, 
LUA_REGISTRYINDEX
, (»f))

	)

167 
	#lua_g‘»f
(
L
,
»f
è
	`lua_¿wg‘i
(L, 
LUA_REGISTRYINDEX
, (»f))

	)

170 
	#luaL_»g
 
luaL_Reg


	)

	@deps/lua/src/lbaselib.c

9 
	~<ùy³.h
>

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

14 
	#lba£lib_c


	)

15 
	#LUA_LIB


	)

17 
	~"lua.h
"

19 
	~"Ïuxlib.h
"

20 
	~"lu®ib.h
"

31 
	$luaB_´št
 (
lua_S‹
 *
L
) {

32 
n
 = 
	`lua_g‘tİ
(
L
);

33 
i
;

34 
	`lua_g‘glob®
(
L
, "tostring");

35 
i
=1; i<=
n
; i++) {

36 cÚ¡ *
s
;

37 
	`lua_pushv®ue
(
L
, -1);

38 
	`lua_pushv®ue
(
L
, 
i
);

39 
	`lua_ÿÎ
(
L
, 1, 1);

40 
s
 = 
	`lua_to¡ršg
(
L
, -1);

41 ià(
s
 =ğ
NULL
)

42  
	`luaL_”rÜ
(
L
, 
	`LUA_QL
("tostring") " must„eturn‡ stringo "

43 
	`LUA_QL
("print"));

44 ià(
i
>1è
	`åuts
("\t", 
¡dout
);

45 
	`åuts
(
s
, 
¡dout
);

46 
	`lua_pİ
(
L
, 1);

48 
	`åuts
("\n", 
¡dout
);

50 
	}
}

53 
	$luaB_tÚumb”
 (
lua_S‹
 *
L
) {

54 
ba£
 = 
	`luaL_İtšt
(
L
, 2, 10);

55 ià(
ba£
 == 10) {

56 
	`luaL_checkªy
(
L
, 1);

57 ià(
	`lua_i¢umb”
(
L
, 1)) {

58 
	`lua_pushnumb”
(
L
, 
	`lua_tÚumb”
(L, 1));

63 cÚ¡ *
s1
 = 
	`luaL_check¡ršg
(
L
, 1);

64 *
s2
;

65 
n
;

66 
	`luaL_¬gcheck
(
L
, 2 <ğ
ba£
 && base <= 36, 2, "base out of„ange");

67 
n
 = 
	`¡¹oul
(
s1
, &
s2
, 
ba£
);

68 ià(
s1
 !ğ
s2
) {

69 
	`is¥aû
(()(*
s2
))) s2++;

70 ià(*
s2
 == '\0') {

71 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)
n
);

76 
	`lua_pushn
(
L
);

78 
	}
}

81 
	$luaB_”rÜ
 (
lua_S‹
 *
L
) {

82 
Ëv–
 = 
	`luaL_İtšt
(
L
, 2, 1);

83 
	`lua_£‰İ
(
L
, 1);

84 ià(
	`lua_is¡ršg
(
L
, 1è&& 
Ëv–
 > 0) {

85 
	`luaL_wh”e
(
L
, 
Ëv–
);

86 
	`lua_pushv®ue
(
L
, 1);

87 
	`lua_cÚÿt
(
L
, 2);

89  
	`lua_”rÜ
(
L
);

90 
	}
}

93 
	$luaB_g‘m‘©abË
 (
lua_S‹
 *
L
) {

94 
	`luaL_checkªy
(
L
, 1);

95 ià(!
	`lua_g‘m‘©abË
(
L
, 1)) {

96 
	`lua_pushn
(
L
);

99 
	`luaL_g‘m‘af›ld
(
L
, 1, "__metatable");

101 
	}
}

104 
	$luaB_£tm‘©abË
 (
lua_S‹
 *
L
) {

105 
t
 = 
	`lua_ty³
(
L
, 2);

106 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

107 
	`luaL_¬gcheck
(
L
, 
t
 =ğ
LUA_TNIL
 || =ğ
LUA_TTABLE
, 2,

109 ià(
	`luaL_g‘m‘af›ld
(
L
, 1, "__metatable"))

110 
	`luaL_”rÜ
(
L
, "cannot change‡…rotected metatable");

111 
	`lua_£‰İ
(
L
, 2);

112 
	`lua_£tm‘©abË
(
L
, 1);

114 
	}
}

117 
	$g‘func
 (
lua_S‹
 *
L
, 
İt
) {

118 ià(
	`lua_isfunùiÚ
(
L
, 1)è
	`lua_pushv®ue
(L, 1);

120 
lua_Debug
 
¬
;

121 
Ëv–
 = 
İt
 ? 
	`luaL_İtšt
(
L
, 1, 1è: 
	`luaL_checkšt
(L, 1);

122 
	`luaL_¬gcheck
(
L
, 
Ëv–
 >= 0, 1, "level must be‚on-negative");

123 ià(
	`lua_g‘¡ack
(
L
, 
Ëv–
, &
¬
) == 0)

124 
	`luaL_¬g”rÜ
(
L
, 1, "invalid†evel");

125 
	`lua_g‘šfo
(
L
, "f", &
¬
);

126 ià(
	`lua_i¢
(
L
, -1))

127 
	`luaL_”rÜ
(
L
, "no functionƒnvironment forail call‡t†evel %d",

128 
Ëv–
);

130 
	}
}

133 
	$luaB_g‘ãnv
 (
lua_S‹
 *
L
) {

134 
	`g‘func
(
L
, 1);

135 ià(
	`lua_iscfunùiÚ
(
L
, -1))

136 
	`lua_pushv®ue
(
L
, 
LUA_GLOBALSINDEX
);

138 
	`lua_g‘ãnv
(
L
, -1);

140 
	}
}

143 
	$luaB_£tãnv
 (
lua_S‹
 *
L
) {

144 
	`luaL_checkty³
(
L
, 2, 
LUA_TTABLE
);

145 
	`g‘func
(
L
, 0);

146 
	`lua_pushv®ue
(
L
, 2);

147 ià(
	`lua_i¢umb”
(
L
, 1è&& 
	`lua_tÚumb”
(L, 1) == 0) {

149 
	`lua_pushth»ad
(
L
);

150 
	`lua_š£¹
(
L
, -2);

151 
	`lua_£tãnv
(
L
, -2);

154 ià(
	`lua_iscfunùiÚ
(
L
, -2è|| 
	`lua_£tãnv
(L, -2) == 0)

155 
	`luaL_”rÜ
(
L
,

156 
	`LUA_QL
("setfenv") " cannot changeƒnvironment of given object");

158 
	}
}

161 
	$luaB_¿wequ®
 (
lua_S‹
 *
L
) {

162 
	`luaL_checkªy
(
L
, 1);

163 
	`luaL_checkªy
(
L
, 2);

164 
	`lua_pushboŞ—n
(
L
, 
	`lua_¿wequ®
(L, 1, 2));

166 
	}
}

169 
	$luaB_¿wg‘
 (
lua_S‹
 *
L
) {

170 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

171 
	`luaL_checkªy
(
L
, 2);

172 
	`lua_£‰İ
(
L
, 2);

173 
	`lua_¿wg‘
(
L
, 1);

175 
	}
}

177 
	$luaB_¿w£t
 (
lua_S‹
 *
L
) {

178 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

179 
	`luaL_checkªy
(
L
, 2);

180 
	`luaL_checkªy
(
L
, 3);

181 
	`lua_£‰İ
(
L
, 3);

182 
	`lua_¿w£t
(
L
, 1);

184 
	}
}

187 
	$luaB_gcšfo
 (
lua_S‹
 *
L
) {

188 
	`lua_pushš‹g”
(
L
, 
	`lua_g‘gccouÁ
(L));

190 
	}
}

193 
	$luaB_cŞËùg¬bage
 (
lua_S‹
 *
L
) {

194 cÚ¡ *cÚ¡ 
İts
[] = {"stop", "restart", "collect",

195 "couÁ", "¡•", "£au£", "£t¡•mul", 
NULL
};

196 cÚ¡ 
İt¢um
[] = {
LUA_GCSTOP
, 
LUA_GCRESTART
, 
LUA_GCCOLLECT
,

197 
LUA_GCCOUNT
, 
LUA_GCSTEP
, 
LUA_GCSETPAUSE
, 
LUA_GCSETSTEPMUL
};

198 
o
 = 
	`luaL_checkİtiÚ
(
L
, 1, "cŞËù", 
İts
);

199 
ex
 = 
	`luaL_İtšt
(
L
, 2, 0);

200 
»s
 = 
	`lua_gc
(
L
, 
İt¢um
[
o
], 
ex
);

201 
İt¢um
[
o
]) {

202 
LUA_GCCOUNT
: {

203 
b
 = 
	`lua_gc
(
L
, 
LUA_GCCOUNTB
, 0);

204 
	`lua_pushnumb”
(
L
, 
»s
 + ((
lua_Numb”
)
b
/1024));

207 
LUA_GCSTEP
: {

208 
	`lua_pushboŞ—n
(
L
, 
»s
);

212 
	`lua_pushnumb”
(
L
, 
»s
);

216 
	}
}

219 
	$luaB_ty³
 (
lua_S‹
 *
L
) {

220 
	`luaL_checkªy
(
L
, 1);

221 
	`lua_push¡ršg
(
L
, 
	`luaL_ty³Çme
(L, 1));

223 
	}
}

226 
	$luaB_Ãxt
 (
lua_S‹
 *
L
) {

227 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

228 
	`lua_£‰İ
(
L
, 2);

229 ià(
	`lua_Ãxt
(
L
, 1))

232 
	`lua_pushn
(
L
);

235 
	}
}

238 
	$luaB_·œs
 (
lua_S‹
 *
L
) {

239 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

240 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(1));

241 
	`lua_pushv®ue
(
L
, 1);

242 
	`lua_pushn
(
L
);

244 
	}
}

247 
	$aœ§ux
 (
lua_S‹
 *
L
) {

248 
i
 = 
	`luaL_checkšt
(
L
, 2);

249 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

250 
i
++;

251 
	`lua_pushš‹g”
(
L
, 
i
);

252 
	`lua_¿wg‘i
(
L
, 1, 
i
);

253  (
	`lua_i¢
(
L
, -1)) ? 0 : 2;

254 
	}
}

257 
	$luaB_aœs
 (
lua_S‹
 *
L
) {

258 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

259 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(1));

260 
	`lua_pushv®ue
(
L
, 1);

261 
	`lua_pushš‹g”
(
L
, 0);

263 
	}
}

266 
	$lßd_aux
 (
lua_S‹
 *
L
, 
¡©us
) {

267 ià(
¡©us
 == 0)

270 
	`lua_pushn
(
L
);

271 
	`lua_š£¹
(
L
, -2);

274 
	}
}

277 
	$luaB_lßd¡ršg
 (
lua_S‹
 *
L
) {

278 
size_t
 
l
;

279 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

280 cÚ¡ *
chunkÇme
 = 
	`luaL_İt¡ršg
(
L
, 2, 
s
);

281  
	`lßd_aux
(
L
, 
	`luaL_lßdbufãr
(L, 
s
, 
l
, 
chunkÇme
));

282 
	}
}

285 
	$luaB_lßdfe
 (
lua_S‹
 *
L
) {

286 cÚ¡ *
âame
 = 
	`luaL_İt¡ršg
(
L
, 1, 
NULL
);

287  
	`lßd_aux
(
L
, 
	`luaL_lßdfe
(L, 
âame
));

288 
	}
}

297 cÚ¡ *
	$g’”ic_»ad”
 (
lua_S‹
 *
L
, *
ud
, 
size_t
 *
size
) {

298 ()
ud
;

299 
	`luaL_check¡ack
(
L
, 2, "too many‚ested functions");

300 
	`lua_pushv®ue
(
L
, 1);

301 
	`lua_ÿÎ
(
L
, 0, 1);

302 ià(
	`lua_i¢
(
L
, -1)) {

303 *
size
 = 0;

304  
NULL
;

306 ià(
	`lua_is¡ršg
(
L
, -1)) {

307 
	`lua_»¶aû
(
L
, 3);

308  
	`lua_tŞ¡ršg
(
L
, 3, 
size
);

310 
	`luaL_”rÜ
(
L
, "reader function must„eturn‡ string");

311  
NULL
;

312 
	}
}

315 
	$luaB_lßd
 (
lua_S‹
 *
L
) {

316 
¡©us
;

317 cÚ¡ *
úame
 = 
	`luaL_İt¡ršg
(
L
, 2, "=(load)");

318 
	`luaL_checkty³
(
L
, 1, 
LUA_TFUNCTION
);

319 
	`lua_£‰İ
(
L
, 3);

320 
¡©us
 = 
	`lua_lßd
(
L
, 
g’”ic_»ad”
, 
NULL
, 
úame
);

321  
	`lßd_aux
(
L
, 
¡©us
);

322 
	}
}

325 
	$luaB_dofe
 (
lua_S‹
 *
L
) {

326 cÚ¡ *
âame
 = 
	`luaL_İt¡ršg
(
L
, 1, 
NULL
);

327 
n
 = 
	`lua_g‘tİ
(
L
);

328 ià(
	`luaL_lßdfe
(
L
, 
âame
è!ğ0è
	`lua_”rÜ
(L);

329 
	`lua_ÿÎ
(
L
, 0, 
LUA_MULTRET
);

330  
	`lua_g‘tİ
(
L
è- 
n
;

331 
	}
}

334 
	$luaB_as£¹
 (
lua_S‹
 *
L
) {

335 
	`luaL_checkªy
(
L
, 1);

336 ià(!
	`lua_toboŞ—n
(
L
, 1))

337  
	`luaL_”rÜ
(
L
, "%s", 
	`luaL_İt¡ršg
(L, 2, "assertion failed!"));

338  
	`lua_g‘tİ
(
L
);

339 
	}
}

342 
	$luaB_uÅack
 (
lua_S‹
 *
L
) {

343 
i
, 
e
, 
n
;

344 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

345 
i
 = 
	`luaL_İtšt
(
L
, 2, 1);

346 
e
 = 
	`luaL_İt
(
L
, 
luaL_checkšt
, 3, 
	`luaL_g‘n
(L, 1));

347 ià(
i
 > 
e
)  0;

348 
n
 = 
e
 - 
i
 + 1;

349 ià(
n
 <ğ0 || !
	`lua_check¡ack
(
L
,‚))

350  
	`luaL_”rÜ
(
L
, "too many„esultso unpack");

351 
	`lua_¿wg‘i
(
L
, 1, 
i
);

352 
i
++ < 
e
)

353 
	`lua_¿wg‘i
(
L
, 1, 
i
);

354  
n
;

355 
	}
}

358 
	$luaB_£Ëù
 (
lua_S‹
 *
L
) {

359 
n
 = 
	`lua_g‘tİ
(
L
);

360 ià(
	`lua_ty³
(
L
, 1è=ğ
LUA_TSTRING
 && *
	`lua_to¡ršg
(L, 1) == '#') {

361 
	`lua_pushš‹g”
(
L
, 
n
-1);

365 
i
 = 
	`luaL_checkšt
(
L
, 1);

366 ià(
i
 < 0è˜ğ
n
 + i;

367 ià(
i
 > 
n
) i =‚;

368 
	`luaL_¬gcheck
(
L
, 1 <ğ
i
, 1, "index out of„ange");

369  
n
 - 
i
;

371 
	}
}

374 
	$luaB_pÿÎ
 (
lua_S‹
 *
L
) {

375 
¡©us
;

376 
	`luaL_checkªy
(
L
, 1);

377 
¡©us
 = 
	`lua_pÿÎ
(
L
, 
	`lua_g‘tİ
(Lè- 1, 
LUA_MULTRET
, 0);

378 
	`lua_pushboŞ—n
(
L
, (
¡©us
 == 0));

379 
	`lua_š£¹
(
L
, 1);

380  
	`lua_g‘tİ
(
L
);

381 
	}
}

384 
	$luaB_xpÿÎ
 (
lua_S‹
 *
L
) {

385 
¡©us
;

386 
	`luaL_checkªy
(
L
, 2);

387 
	`lua_£‰İ
(
L
, 2);

388 
	`lua_š£¹
(
L
, 1);

389 
¡©us
 = 
	`lua_pÿÎ
(
L
, 0, 
LUA_MULTRET
, 1);

390 
	`lua_pushboŞ—n
(
L
, (
¡©us
 == 0));

391 
	`lua_»¶aû
(
L
, 1);

392  
	`lua_g‘tİ
(
L
);

393 
	}
}

396 
	$luaB_to¡ršg
 (
lua_S‹
 *
L
) {

397 
	`luaL_checkªy
(
L
, 1);

398 ià(
	`luaL_ÿÎm‘a
(
L
, 1, "__tostring"))

400 
	`lua_ty³
(
L
, 1)) {

401 
LUA_TNUMBER
:

402 
	`lua_push¡ršg
(
L
, 
	`lua_to¡ršg
(L, 1));

404 
LUA_TSTRING
:

405 
	`lua_pushv®ue
(
L
, 1);

407 
LUA_TBOOLEAN
:

408 
	`lua_push¡ršg
(
L
, (
	`lua_toboŞ—n
(L, 1) ? "true" : "false"));

410 
LUA_TNIL
:

411 
	`lua_pushl™”®
(
L
, "nil");

414 
	`lua_pushf¡ršg
(
L
, "%s: %p", 
	`luaL_ty³Çme
(L, 1), 
	`lua_tİoš‹r
(L, 1));

418 
	}
}

421 
	$luaB_Ãw´oxy
 (
lua_S‹
 *
L
) {

422 
	`lua_£‰İ
(
L
, 1);

423 
	`lua_Ãwu£rd©a
(
L
, 0);

424 ià(
	`lua_toboŞ—n
(
L
, 1) == 0)

426 ià(
	`lua_isboŞ—n
(
L
, 1)) {

427 
	`lua_ÃwbË
(
L
);

428 
	`lua_pushv®ue
(
L
, -1);

429 
	`lua_pushboŞ—n
(
L
, 1);

430 
	`lua_¿w£t
(
L
, 
	`lua_upv®uešdex
(1));

433 
v®id´oxy
 = 0;

434 ià(
	`lua_g‘m‘©abË
(
L
, 1)) {

435 
	`lua_¿wg‘
(
L
, 
	`lua_upv®uešdex
(1));

436 
v®id´oxy
 = 
	`lua_toboŞ—n
(
L
, -1);

437 
	`lua_pİ
(
L
, 1);

439 
	`luaL_¬gcheck
(
L
, 
v®id´oxy
, 1, "boolean or…roxyƒxpected");

440 
	`lua_g‘m‘©abË
(
L
, 1);

442 
	`lua_£tm‘©abË
(
L
, 2);

444 
	}
}

447 cÚ¡ 
luaL_Reg
 
	gba£_funcs
[] = {

448 {"as£¹", 
luaB_as£¹
},

449 {"cŞËùg¬bage", 
luaB_cŞËùg¬bage
},

450 {"dofe", 
luaB_dofe
},

451 {"”rÜ", 
luaB_”rÜ
},

452 {"gcšfo", 
luaB_gcšfo
},

453 {"g‘ãnv", 
luaB_g‘ãnv
},

454 {"g‘m‘©abË", 
luaB_g‘m‘©abË
},

455 {"lßdfe", 
luaB_lßdfe
},

456 {"lßd", 
luaB_lßd
},

457 {"lßd¡ršg", 
luaB_lßd¡ršg
},

458 {"Ãxt", 
luaB_Ãxt
},

459 {"pÿÎ", 
luaB_pÿÎ
},

460 {"´št", 
luaB_´št
},

461 {"¿wequ®", 
luaB_¿wequ®
},

462 {"¿wg‘", 
luaB_¿wg‘
},

463 {"¿w£t", 
luaB_¿w£t
},

464 {"£Ëù", 
luaB_£Ëù
},

465 {"£tãnv", 
luaB_£tãnv
},

466 {"£tm‘©abË", 
luaB_£tm‘©abË
},

467 {"tÚumb”", 
luaB_tÚumb”
},

468 {"to¡ršg", 
luaB_to¡ršg
},

469 {"ty³", 
luaB_ty³
},

470 {"uÅack", 
luaB_uÅack
},

471 {"xpÿÎ", 
luaB_xpÿÎ
},

472 {
NULL
, NULL}

482 
	#CO_RUN
 0

	)

483 
	#CO_SUS
 1

	)

484 
	#CO_NOR
 2

	)

485 
	#CO_DEAD
 3

	)

487 cÚ¡ *cÚ¡ 
	g¡©Çmes
[] =

490 
	$co¡©us
 (
lua_S‹
 *
L
,†ua_S‹ *
co
) {

491 ià(
L
 =ğ
co
è 
CO_RUN
;

492 
	`lua_¡©us
(
co
)) {

493 
LUA_YIELD
:

494  
CO_SUS
;

496 
lua_Debug
 
¬
;

497 ià(
	`lua_g‘¡ack
(
co
, 0, &
¬
) > 0)

498  
CO_NOR
;

499 ià(
	`lua_g‘tİ
(
co
) == 0)

500  
CO_DEAD
;

502  
CO_SUS
;

505  
CO_DEAD
;

507 
	}
}

510 
	$luaB_co¡©us
 (
lua_S‹
 *
L
) {

511 
lua_S‹
 *
co
 = 
	`lua_tÙh»ad
(
L
, 1);

512 
	`luaL_¬gcheck
(
L
, 
co
, 1, "coroutineƒxpected");

513 
	`lua_push¡ršg
(
L
, 
¡©Çmes
[
	`co¡©us
(L, 
co
)]);

515 
	}
}

518 
	$aux»sume
 (
lua_S‹
 *
L
,†ua_S‹ *
co
, 
Çrg
) {

519 
¡©us
 = 
	`co¡©us
(
L
, 
co
);

520 ià(!
	`lua_check¡ack
(
co
, 
Çrg
))

521 
	`luaL_”rÜ
(
L
, "too many‡rgumentso„esume");

522 ià(
¡©us
 !ğ
CO_SUS
) {

523 
	`lua_pushf¡ršg
(
L
, "ÿÂÙ„esum% cÜoutše", 
¡©Çmes
[
¡©us
]);

526 
	`lua_xmove
(
L
, 
co
, 
Çrg
);

527 
	`lua_£ev–
(
L
, 
co
);

528 
¡©us
 = 
	`lua_»sume
(
co
, 
Çrg
);

529 ià(
¡©us
 =ğ0 || stu =ğ
LUA_YIELD
) {

530 
Äes
 = 
	`lua_g‘tİ
(
co
);

531 ià(!
	`lua_check¡ack
(
L
, 
Äes
 + 1))

532 
	`luaL_”rÜ
(
L
, "too many„esultso„esume");

533 
	`lua_xmove
(
co
, 
L
, 
Äes
);

534  
Äes
;

537 
	`lua_xmove
(
co
, 
L
, 1);

540 
	}
}

543 
	$luaB_cÜesume
 (
lua_S‹
 *
L
) {

544 
lua_S‹
 *
co
 = 
	`lua_tÙh»ad
(
L
, 1);

545 
r
;

546 
	`luaL_¬gcheck
(
L
, 
co
, 1, "coroutineƒxpected");

547 
r
 = 
	`aux»sume
(
L
, 
co
, 
	`lua_g‘tİ
(L) - 1);

548 ià(
r
 < 0) {

549 
	`lua_pushboŞ—n
(
L
, 0);

550 
	`lua_š£¹
(
L
, -2);

554 
	`lua_pushboŞ—n
(
L
, 1);

555 
	`lua_š£¹
(
L
, -(
r
 + 1));

556  
r
 + 1;

558 
	}
}

561 
	$luaB_auxw¿p
 (
lua_S‹
 *
L
) {

562 
lua_S‹
 *
co
 = 
	`lua_tÙh»ad
(
L
, 
	`lua_upv®uešdex
(1));

563 
r
 = 
	`aux»sume
(
L
, 
co
, 
	`lua_g‘tİ
(L));

564 ià(
r
 < 0) {

565 ià(
	`lua_is¡ršg
(
L
, -1)) {

566 
	`luaL_wh”e
(
L
, 1);

567 
	`lua_š£¹
(
L
, -2);

568 
	`lua_cÚÿt
(
L
, 2);

570 
	`lua_”rÜ
(
L
);

572  
r
;

573 
	}
}

576 
	$luaB_coü—‹
 (
lua_S‹
 *
L
) {

577 
lua_S‹
 *
NL
 = 
	`lua_Ãwth»ad
(
L
);

578 
	`luaL_¬gcheck
(
L
, 
	`lua_isfunùiÚ
(L, 1è&& !
	`lua_iscfunùiÚ
(L, 1), 1,

580 
	`lua_pushv®ue
(
L
, 1);

581 
	`lua_xmove
(
L
, 
NL
, 1);

583 
	}
}

586 
	$luaB_cow¿p
 (
lua_S‹
 *
L
) {

587 
	`luaB_coü—‹
(
L
);

588 
	`lua_pushcşosu»
(
L
, 
luaB_auxw¿p
, 1);

590 
	}
}

593 
	$luaB_y›ld
 (
lua_S‹
 *
L
) {

594  
	`lua_y›ld
(
L
, 
	`lua_g‘tİ
(L));

595 
	}
}

598 
	$luaB_cÜuÂšg
 (
lua_S‹
 *
L
) {

599 ià(
	`lua_pushth»ad
(
L
))

600 
	`lua_pushn
(
L
);

602 
	}
}

605 cÚ¡ 
luaL_Reg
 
	gco_funcs
[] = {

606 {"ü—‹", 
luaB_coü—‹
},

607 {"»sume", 
luaB_cÜesume
},

608 {"ruÂšg", 
luaB_cÜuÂšg
},

609 {"¡©us", 
luaB_co¡©us
},

610 {"w¿p", 
luaB_cow¿p
},

611 {"y›ld", 
luaB_y›ld
},

612 {
NULL
, NULL}

618 
	$auxİ’
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
,

619 
lua_CFunùiÚ
 
f
,†ua_CFunùiÚ 
u
) {

620 
	`lua_pushcfunùiÚ
(
L
, 
u
);

621 
	`lua_pushcşosu»
(
L
, 
f
, 1);

622 
	`lua_£tf›ld
(
L
, -2, 
Çme
);

623 
	}
}

626 
	$ba£_İ’
 (
lua_S‹
 *
L
) {

628 
	`lua_pushv®ue
(
L
, 
LUA_GLOBALSINDEX
);

629 
	`lua_£tglob®
(
L
, "_G");

631 
	`luaL_»gi¡”
(
L
, "_G", 
ba£_funcs
);

632 
	`lua_pushl™”®
(
L
, 
LUA_VERSION
);

633 
	`lua_£tglob®
(
L
, "_VERSION");

635 
	`auxİ’
(
L
, "aœs", 
luaB_aœs
, 
aœ§ux
);

636 
	`auxİ’
(
L
, "·œs", 
luaB_·œs
, 
luaB_Ãxt
);

638 
	`lua_ü—‹bË
(
L
, 0, 1);

639 
	`lua_pushv®ue
(
L
, -1);

640 
	`lua_£tm‘©abË
(
L
, -2);

641 
	`lua_pushl™”®
(
L
, "kv");

642 
	`lua_£tf›ld
(
L
, -2, "__mode");

643 
	`lua_pushcşosu»
(
L
, 
luaB_Ãw´oxy
, 1);

644 
	`lua_£tglob®
(
L
, "newproxy");

645 
	}
}

648 
LUALIB_API
 
	$luaİ’_ba£
 (
lua_S‹
 *
L
) {

649 
	`ba£_İ’
(
L
);

650 
	`luaL_»gi¡”
(
L
, 
LUA_COLIBNAME
, 
co_funcs
);

652 
	}
}

	@deps/lua/src/lcode.c

8 
	~<¡dlib.h
>

10 
	#lcode_c


	)

11 
	#LUA_CORE


	)

13 
	~"lua.h
"

15 
	~"lcode.h
"

16 
	~"ldebug.h
"

17 
	~"ldo.h
"

18 
	~"lgc.h
"

19 
	~"Îex.h
"

20 
	~"lmem.h
"

21 
	~"lobjeù.h
"

22 
	~"lİcodes.h
"

23 
	~"Í¬£r.h
"

24 
	~"ÉabË.h
"

27 
	#hasjumps
(
e
è(Ó)->
t
 !ğÓ)->
f
)

	)

30 
	$i¢um”®
(
expdesc
 *
e
) {

31  (
e
->
k
 =ğ
VKNUM
 &&ƒ->
t
 =ğ
NO_JUMP
 &&ƒ->
f
 == NO_JUMP);

32 
	}
}

35 
	$luaK_n
 (
FuncS‹
 *
fs
, 
äom
, 
n
) {

36 
In¡ruùiÚ
 *
´evious
;

37 ià(
fs
->
pc
 > fs->
Ï¡rg‘
) {

38 ià(
fs
->
pc
 == 0) {

39 ià(
äom
 >ğ
fs
->
Çùv¬
)

43 
´evious
 = &
fs
->
f
->
code
[fs->
pc
-1];

44 ià(
	`GET_OPCODE
(*
´evious
è=ğ
OP_LOADNIL
) {

45 
päom
 = 
	`GETARG_A
(*
´evious
);

46 
±o
 = 
	`GETARG_B
(*
´evious
);

47 ià(
päom
 <ğ
äom
 && from <ğ
±o
+1) {

48 ià(
äom
+
n
-1 > 
±o
)

49 
	`SETARG_B
(*
´evious
, 
äom
+
n
-1);

55 
	`luaK_codeABC
(
fs
, 
OP_LOADNIL
, 
äom
, from+
n
-1, 0);

56 
	}
}

59 
	$luaK_jump
 (
FuncS‹
 *
fs
) {

60 
jpc
 = 
fs
->jpc;

61 
j
;

62 
fs
->
jpc
 = 
NO_JUMP
;

63 
j
 = 
	`luaK_codeAsBx
(
fs
, 
OP_JMP
, 0, 
NO_JUMP
);

64 
	`luaK_cÚÿt
(
fs
, &
j
, 
jpc
);

65  
j
;

66 
	}
}

69 
	$luaK_»t
 (
FuncS‹
 *
fs
, 
fœ¡
, 
Ä‘
) {

70 
	`luaK_codeABC
(
fs
, 
OP_RETURN
, 
fœ¡
, 
Ä‘
+1, 0);

71 
	}
}

74 
	$cÚdjump
 (
FuncS‹
 *
fs
, 
OpCode
 
İ
, 
A
, 
B
, 
C
) {

75 
	`luaK_codeABC
(
fs
, 
İ
, 
A
, 
B
, 
C
);

76  
	`luaK_jump
(
fs
);

77 
	}
}

80 
	$fixjump
 (
FuncS‹
 *
fs
, 
pc
, 
de¡
) {

81 
In¡ruùiÚ
 *
jmp
 = &
fs
->
f
->
code
[
pc
];

82 
off£t
 = 
de¡
-(
pc
+1);

83 
	`lua_as£¹
(
de¡
 !ğ
NO_JUMP
);

84 ià(
	`abs
(
off£t
è> 
MAXARG_sBx
)

85 
	`luaX_syÁax”rÜ
(
fs
->
ls
, "control structureoo†ong");

86 
	`SETARG_sBx
(*
jmp
, 
off£t
);

87 
	}
}

94 
	$luaK_g‘Ïb–
 (
FuncS‹
 *
fs
) {

95 
fs
->
Ï¡rg‘
 = fs->
pc
;

96  
fs
->
pc
;

97 
	}
}

100 
	$g‘jump
 (
FuncS‹
 *
fs
, 
pc
) {

101 
off£t
 = 
	`GETARG_sBx
(
fs
->
f
->
code
[
pc
]);

102 ià(
off£t
 =ğ
NO_JUMP
)

103  
NO_JUMP
;

105  (
pc
+1)+
off£t
;

106 
	}
}

109 
In¡ruùiÚ
 *
	$g‘jumpcÚŒŞ
 (
FuncS‹
 *
fs
, 
pc
) {

110 
In¡ruùiÚ
 *
pi
 = &
fs
->
f
->
code
[
pc
];

111 ià(
pc
 >ğ1 && 
	`‹¡TMode
(
	`GET_OPCODE
(*(
pi
-1))))

112  
pi
-1;

114  
pi
;

115 
	}
}

122 
	$Ãed_v®ue
 (
FuncS‹
 *
fs
, 
li¡
) {

123 ; 
li¡
 !ğ
NO_JUMP
;†i¡ = 
	`g‘jump
(
fs
,†ist)) {

124 
In¡ruùiÚ
 
i
 = *
	`g‘jumpcÚŒŞ
(
fs
, 
li¡
);

125 ià(
	`GET_OPCODE
(
i
è!ğ
OP_TESTSET
)  1;

128 
	}
}

131 
	$·tch‹¡»g
 (
FuncS‹
 *
fs
, 
node
, 
»g
) {

132 
In¡ruùiÚ
 *
i
 = 
	`g‘jumpcÚŒŞ
(
fs
, 
node
);

133 ià(
	`GET_OPCODE
(*
i
è!ğ
OP_TESTSET
)

135 ià(
»g
 !ğ
NO_REG
 &&„eg !ğ
	`GETARG_B
(*
i
))

136 
	`SETARG_A
(*
i
, 
»g
);

138 *
i
 = 
	`CREATE_ABC
(
OP_TEST
, 
	`GETARG_B
(*i), 0, 
	`GETARG_C
(*i));

141 
	}
}

144 
	$»movev®ues
 (
FuncS‹
 *
fs
, 
li¡
) {

145 ; 
li¡
 !ğ
NO_JUMP
;†i¡ = 
	`g‘jump
(
fs
,†ist))

146 
	`·tch‹¡»g
(
fs
, 
li¡
, 
NO_REG
);

147 
	}
}

150 
	$·tchli¡aux
 (
FuncS‹
 *
fs
, 
li¡
, 
vrg‘
, 
»g
,

151 
drg‘
) {

152 
li¡
 !ğ
NO_JUMP
) {

153 
Ãxt
 = 
	`g‘jump
(
fs
, 
li¡
);

154 ià(
	`·tch‹¡»g
(
fs
, 
li¡
, 
»g
))

155 
	`fixjump
(
fs
, 
li¡
, 
vrg‘
);

157 
	`fixjump
(
fs
, 
li¡
, 
drg‘
);

158 
li¡
 = 
Ãxt
;

160 
	}
}

163 
	$disch¬gejpc
 (
FuncS‹
 *
fs
) {

164 
	`·tchli¡aux
(
fs
, fs->
jpc
, fs->
pc
, 
NO_REG
, fs->pc);

165 
fs
->
jpc
 = 
NO_JUMP
;

166 
	}
}

169 
	$luaK_·tchli¡
 (
FuncS‹
 *
fs
, 
li¡
, 
rg‘
) {

170 ià(
rg‘
 =ğ
fs
->
pc
)

171 
	`luaK_·tchtoh”e
(
fs
, 
li¡
);

173 
	`lua_as£¹
(
rg‘
 < 
fs
->
pc
);

174 
	`·tchli¡aux
(
fs
, 
li¡
, 
rg‘
, 
NO_REG
,arget);

176 
	}
}

179 
	$luaK_·tchtoh”e
 (
FuncS‹
 *
fs
, 
li¡
) {

180 
	`luaK_g‘Ïb–
(
fs
);

181 
	`luaK_cÚÿt
(
fs
, &fs->
jpc
, 
li¡
);

182 
	}
}

185 
	$luaK_cÚÿt
 (
FuncS‹
 *
fs
, *
l1
, 
l2
) {

186 ià(
l2
 =ğ
NO_JUMP
) ;

187 ià(*
l1
 =ğ
NO_JUMP
)

188 *
l1
 = 
l2
;

190 
li¡
 = *
l1
;

191 
Ãxt
;

192 (
Ãxt
 = 
	`g‘jump
(
fs
, 
li¡
)è!ğ
NO_JUMP
)

193 
li¡
 = 
Ãxt
;

194 
	`fixjump
(
fs
, 
li¡
, 
l2
);

196 
	}
}

199 
	$luaK_check¡ack
 (
FuncS‹
 *
fs
, 
n
) {

200 
Ãw¡ack
 = 
fs
->
ä“»g
 + 
n
;

201 ià(
Ãw¡ack
 > 
fs
->
f
->
max¡acksize
) {

202 ià(
Ãw¡ack
 >ğ
MAXSTACK
)

203 
	`luaX_syÁax”rÜ
(
fs
->
ls
, "function orƒxpressionoo complex");

204 
fs
->
f
->
max¡acksize
 = 
	`ÿ¡_by‹
(
Ãw¡ack
);

206 
	}
}

209 
	$luaK_»£rv”egs
 (
FuncS‹
 *
fs
, 
n
) {

210 
	`luaK_check¡ack
(
fs
, 
n
);

211 
fs
->
ä“»g
 +ğ
n
;

212 
	}
}

215 
	$ä“»g
 (
FuncS‹
 *
fs
, 
»g
) {

216 ià(!
	`ISK
(
»g
è&&„eg >ğ
fs
->
Çùv¬
) {

217 
fs
->
ä“»g
--;

218 
	`lua_as£¹
(
»g
 =ğ
fs
->
ä“»g
);

220 
	}
}

223 
	$ä“exp
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

224 ià(
e
->
k
 =ğ
VNONRELOC
)

225 
	`ä“»g
(
fs
, 
e
->
u
.
s
.
šfo
);

226 
	}
}

229 
	$addk
 (
FuncS‹
 *
fs
, 
TV®ue
 *
k
, TV®u*
v
) {

230 
lua_S‹
 *
L
 = 
fs
->L;

231 
TV®ue
 *
idx
 = 
	`luaH_£t
(
L
, 
fs
->
h
, 
k
);

232 
PrÙo
 *
f
 = 
fs
->f;

233 
Şdsize
 = 
f
->
sizek
;

234 ià(
	`‰i¢umb”
(
idx
)) {

235 
	`lua_as£¹
(
	`luaO_¿wequ®Obj
(&
fs
->
f
->
k
[
	`ÿ¡_št
(
	`nv®ue
(
idx
))], 
v
));

236  
	`ÿ¡_št
(
	`nv®ue
(
idx
));

239 
	`£Šv®ue
(
idx
, 
	`ÿ¡_num
(
fs
->
nk
));

240 
	`luaM_growveùÜ
(
L
, 
f
->
k
, 
fs
->
nk
, f->
sizek
, 
TV®ue
,

241 
MAXARG_Bx
, "constantable overflow");

242 
Şdsize
 < 
f
->
sizek
è
	`£Šv®ue
(&f->
k
[oldsize++]);

243 
	`£tobj
(
L
, &
f
->
k
[
fs
->
nk
], 
v
);

244 
	`luaC_b¬r›r
(
L
, 
f
, 
v
);

245  
fs
->
nk
++;

247 
	}
}

250 
	$luaK_¡ršgK
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
s
) {

251 
TV®ue
 
o
;

252 
	`£tsv®ue
(
fs
->
L
, &
o
, 
s
);

253  
	`addk
(
fs
, &
o
, &o);

254 
	}
}

257 
	$luaK_numb”K
 (
FuncS‹
 *
fs
, 
lua_Numb”
 
r
) {

258 
TV®ue
 
o
;

259 
	`£Šv®ue
(&
o
, 
r
);

260  
	`addk
(
fs
, &
o
, &o);

261 
	}
}

264 
	$boŞK
 (
FuncS‹
 *
fs
, 
b
) {

265 
TV®ue
 
o
;

266 
	`£tbv®ue
(&
o
, 
b
);

267  
	`addk
(
fs
, &
o
, &o);

268 
	}
}

271 
	$nK
 (
FuncS‹
 *
fs
) {

272 
TV®ue
 
k
, 
v
;

273 
	`£Šv®ue
(&
v
);

275 
	`£thv®ue
(
fs
->
L
, &
k
, fs->
h
);

276  
	`addk
(
fs
, &
k
, &
v
);

277 
	}
}

280 
	$luaK_£Œ‘uºs
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
ÄesuÉs
) {

281 ià(
e
->
k
 =ğ
VCALL
) {

282 
	`SETARG_C
(
	`g‘code
(
fs
, 
e
), 
ÄesuÉs
+1);

284 ià(
e
->
k
 =ğ
VVARARG
) {

285 
	`SETARG_B
(
	`g‘code
(
fs
, 
e
), 
ÄesuÉs
+1);

286 
	`SETARG_A
(
	`g‘code
(
fs
, 
e
), fs->
ä“»g
);

287 
	`luaK_»£rv”egs
(
fs
, 1);

289 
	}
}

292 
	$luaK_£tÚ”‘
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

293 ià(
e
->
k
 =ğ
VCALL
) {

294 
e
->
k
 = 
VNONRELOC
;

295 
e
->
u
.
s
.
šfo
 = 
	`GETARG_A
(
	`g‘code
(
fs
,ƒ));

297 ià(
e
->
k
 =ğ
VVARARG
) {

298 
	`SETARG_B
(
	`g‘code
(
fs
, 
e
), 2);

299 
e
->
k
 = 
VRELOCABLE
;

301 
	}
}

304 
	$luaK_disch¬gev¬s
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

305 
e
->
k
) {

306 
VLOCAL
: {

307 
e
->
k
 = 
VNONRELOC
;

310 
VUPVAL
: {

311 
e
->
u
.
s
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
OP_GETUPVAL
, 0,ƒ->u.s.info, 0);

312 
e
->
k
 = 
VRELOCABLE
;

315 
VGLOBAL
: {

316 
e
->
u
.
s
.
šfo
 = 
	`luaK_codeABx
(
fs
, 
OP_GETGLOBAL
, 0,ƒ->u.s.info);

317 
e
->
k
 = 
VRELOCABLE
;

320 
VINDEXED
: {

321 
	`ä“»g
(
fs
, 
e
->
u
.
s
.
aux
);

322 
	`ä“»g
(
fs
, 
e
->
u
.
s
.
šfo
);

323 
e
->
u
.
s
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
OP_GETTABLE
, 0,ƒ->u.s.šfo,ƒ->u.s.
aux
);

324 
e
->
k
 = 
VRELOCABLE
;

327 
VVARARG
:

328 
VCALL
: {

329 
	`luaK_£tÚ”‘
(
fs
, 
e
);

334 
	}
}

337 
	$code_Ïb–
 (
FuncS‹
 *
fs
, 
A
, 
b
, 
jump
) {

338 
	`luaK_g‘Ïb–
(
fs
);

339  
	`luaK_codeABC
(
fs
, 
OP_LOADBOOL
, 
A
, 
b
, 
jump
);

340 
	}
}

343 
	$disch¬ge2»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
»g
) {

344 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

345 
e
->
k
) {

346 
VNIL
: {

347 
	`luaK_n
(
fs
, 
»g
, 1);

350 
VFALSE
: 
VTRUE
: {

351 
	`luaK_codeABC
(
fs
, 
OP_LOADBOOL
, 
»g
, 
e
->
k
 =ğ
VTRUE
, 0);

354 
VK
: {

355 
	`luaK_codeABx
(
fs
, 
OP_LOADK
, 
»g
, 
e
->
u
.
s
.
šfo
);

358 
VKNUM
: {

359 
	`luaK_codeABx
(
fs
, 
OP_LOADK
, 
»g
, 
	`luaK_numb”K
(fs, 
e
->
u
.
nv®
));

362 
VRELOCABLE
: {

363 
In¡ruùiÚ
 *
pc
 = &
	`g‘code
(
fs
, 
e
);

364 
	`SETARG_A
(*
pc
, 
»g
);

367 
VNONRELOC
: {

368 ià(
»g
 !ğ
e
->
u
.
s
.
šfo
)

369 
	`luaK_codeABC
(
fs
, 
OP_MOVE
, 
»g
, 
e
->
u
.
s
.
šfo
, 0);

373 
	`lua_as£¹
(
e
->
k
 =ğ
VVOID
 ||ƒ->k =ğ
VJMP
);

377 
e
->
u
.
s
.
šfo
 = 
»g
;

378 
e
->
k
 = 
VNONRELOC
;

379 
	}
}

382 
	$disch¬ge2ªy»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

383 ià(
e
->
k
 !ğ
VNONRELOC
) {

384 
	`luaK_»£rv”egs
(
fs
, 1);

385 
	`disch¬ge2»g
(
fs
, 
e
, fs->
ä“»g
-1);

387 
	}
}

390 
	$exp2»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
»g
) {

391 
	`disch¬ge2»g
(
fs
, 
e
, 
»g
);

392 ià(
e
->
k
 =ğ
VJMP
)

393 
	`luaK_cÚÿt
(
fs
, &
e
->
t
,ƒ->
u
.
s
.
šfo
);

394 ià(
	`hasjumps
(
e
)) {

395 
fš®
;

396 
p_f
 = 
NO_JUMP
;

397 
p_t
 = 
NO_JUMP
;

398 ià(
	`Ãed_v®ue
(
fs
, 
e
->
t
è||‚“d_v®ue(fs,ƒ->
f
)) {

399 
fj
 = (
e
->
k
 =ğ
VJMP
è? 
NO_JUMP
 : 
	`luaK_jump
(
fs
);

400 
p_f
 = 
	`code_Ïb–
(
fs
, 
»g
, 0, 1);

401 
p_t
 = 
	`code_Ïb–
(
fs
, 
»g
, 1, 0);

402 
	`luaK_·tchtoh”e
(
fs
, 
fj
);

404 
fš®
 = 
	`luaK_g‘Ïb–
(
fs
);

405 
	`·tchli¡aux
(
fs
, 
e
->
f
, 
fš®
, 
»g
, 
p_f
);

406 
	`·tchli¡aux
(
fs
, 
e
->
t
, 
fš®
, 
»g
, 
p_t
);

408 
e
->
f
 =ƒ->
t
 = 
NO_JUMP
;

409 
e
->
u
.
s
.
šfo
 = 
»g
;

410 
e
->
k
 = 
VNONRELOC
;

411 
	}
}

414 
	$luaK_exp2ÃxŒeg
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

415 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

416 
	`ä“exp
(
fs
, 
e
);

417 
	`luaK_»£rv”egs
(
fs
, 1);

418 
	`exp2»g
(
fs
, 
e
, fs->
ä“»g
 - 1);

419 
	}
}

422 
	$luaK_exp2ªy»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

423 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

424 ià(
e
->
k
 =ğ
VNONRELOC
) {

425 ià(!
	`hasjumps
(
e
)èƒ->
u
.
s
.
šfo
;

426 ià(
e
->
u
.
s
.
šfo
 >ğ
fs
->
Çùv¬
) {

427 
	`exp2»g
(
fs
, 
e
,ƒ->
u
.
s
.
šfo
);

428  
e
->
u
.
s
.
šfo
;

431 
	`luaK_exp2ÃxŒeg
(
fs
, 
e
);

432  
e
->
u
.
s
.
šfo
;

433 
	}
}

436 
	$luaK_exp2v®
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

437 ià(
	`hasjumps
(
e
))

438 
	`luaK_exp2ªy»g
(
fs
, 
e
);

440 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

441 
	}
}

444 
	$luaK_exp2RK
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

445 
	`luaK_exp2v®
(
fs
, 
e
);

446 
e
->
k
) {

447 
VKNUM
:

448 
VTRUE
:

449 
VFALSE
:

450 
VNIL
: {

451 ià(
fs
->
nk
 <ğ
MAXINDEXRK
) {

452 
e
->
u
.
s
.
šfo
 = (e->
k
 =ğ
VNIL
è? 
	`nK
(
fs
) :

453 (
e
->
k
 =ğ
VKNUM
è? 
	`luaK_numb”K
(
fs
,ƒ->
u
.
nv®
) :

454 
	`boŞK
(
fs
, (
e
->
k
 =ğ
VTRUE
));

455 
e
->
k
 = 
VK
;

456  
	`RKASK
(
e
->
u
.
s
.
šfo
);

460 
VK
: {

461 ià(
e
->
u
.
s
.
šfo
 <ğ
MAXINDEXRK
)

462  
	`RKASK
(
e
->
u
.
s
.
šfo
);

468  
	`luaK_exp2ªy»g
(
fs
, 
e
);

469 
	}
}

472 
	$luaK_¡Üev¬
 (
FuncS‹
 *
fs
, 
expdesc
 *
v¬
,ƒxpdesø*
ex
) {

473 
v¬
->
k
) {

474 
VLOCAL
: {

475 
	`ä“exp
(
fs
, 
ex
);

476 
	`exp2»g
(
fs
, 
ex
, 
v¬
->
u
.
s
.
šfo
);

479 
VUPVAL
: {

480 
e
 = 
	`luaK_exp2ªy»g
(
fs
, 
ex
);

481 
	`luaK_codeABC
(
fs
, 
OP_SETUPVAL
, 
e
, 
v¬
->
u
.
s
.
šfo
, 0);

484 
VGLOBAL
: {

485 
e
 = 
	`luaK_exp2ªy»g
(
fs
, 
ex
);

486 
	`luaK_codeABx
(
fs
, 
OP_SETGLOBAL
, 
e
, 
v¬
->
u
.
s
.
šfo
);

489 
VINDEXED
: {

490 
e
 = 
	`luaK_exp2RK
(
fs
, 
ex
);

491 
	`luaK_codeABC
(
fs
, 
OP_SETTABLE
, 
v¬
->
u
.
s
.
šfo
, v¬->u.s.
aux
, 
e
);

495 
	`lua_as£¹
(0);

499 
	`ä“exp
(
fs
, 
ex
);

500 
	}
}

503 
	$luaK_£lf
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
,ƒxpdesø*
key
) {

504 
func
;

505 
	`luaK_exp2ªy»g
(
fs
, 
e
);

506 
	`ä“exp
(
fs
, 
e
);

507 
func
 = 
fs
->
ä“»g
;

508 
	`luaK_»£rv”egs
(
fs
, 2);

509 
	`luaK_codeABC
(
fs
, 
OP_SELF
, 
func
, 
e
->
u
.
s
.
šfo
, 
	`luaK_exp2RK
(fs, 
key
));

510 
	`ä“exp
(
fs
, 
key
);

511 
e
->
u
.
s
.
šfo
 = 
func
;

512 
e
->
k
 = 
VNONRELOC
;

513 
	}
}

516 
	$šv”tjump
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

517 
In¡ruùiÚ
 *
pc
 = 
	`g‘jumpcÚŒŞ
(
fs
, 
e
->
u
.
s
.
šfo
);

518 
	`lua_as£¹
(
	`‹¡TMode
(
	`GET_OPCODE
(*
pc
)è&& GET_OPCODE(*pcè!ğ
OP_TESTSET
 &&

519 
	`GET_OPCODE
(*
pc
è!ğ
OP_TEST
);

520 
	`SETARG_A
(*
pc
, !(
	`GETARG_A
(*pc)));

521 
	}
}

524 
	$jumpÚcÚd
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
cÚd
) {

525 ià(
e
->
k
 =ğ
VRELOCABLE
) {

526 
In¡ruùiÚ
 
›
 = 
	`g‘code
(
fs
, 
e
);

527 ià(
	`GET_OPCODE
(
›
è=ğ
OP_NOT
) {

528 
fs
->
pc
--;

529  
	`cÚdjump
(
fs
, 
OP_TEST
, 
	`GETARG_B
(
›
), 0, !
cÚd
);

533 
	`disch¬ge2ªy»g
(
fs
, 
e
);

534 
	`ä“exp
(
fs
, 
e
);

535  
	`cÚdjump
(
fs
, 
OP_TESTSET
, 
NO_REG
, 
e
->
u
.
s
.
šfo
, 
cÚd
);

536 
	}
}

539 
	$luaK_goiárue
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

540 
pc
;

541 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

542 
e
->
k
) {

543 
VK
: 
VKNUM
: 
VTRUE
: {

544 
pc
 = 
NO_JUMP
;

547 
VJMP
: {

548 
	`šv”tjump
(
fs
, 
e
);

549 
pc
 = 
e
->
u
.
s
.
šfo
;

553 
pc
 = 
	`jumpÚcÚd
(
fs
, 
e
, 0);

557 
	`luaK_cÚÿt
(
fs
, &
e
->
f
, 
pc
);

558 
	`luaK_·tchtoh”e
(
fs
, 
e
->
t
);

559 
e
->
t
 = 
NO_JUMP
;

560 
	}
}

563 
	$luaK_goifçl£
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

564 
pc
;

565 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

566 
e
->
k
) {

567 
VNIL
: 
VFALSE
: {

568 
pc
 = 
NO_JUMP
;

571 
VJMP
: {

572 
pc
 = 
e
->
u
.
s
.
šfo
;

576 
pc
 = 
	`jumpÚcÚd
(
fs
, 
e
, 1);

580 
	`luaK_cÚÿt
(
fs
, &
e
->
t
, 
pc
);

581 
	`luaK_·tchtoh”e
(
fs
, 
e
->
f
);

582 
e
->
f
 = 
NO_JUMP
;

583 
	}
}

586 
	$cod’Ù
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

587 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

588 
e
->
k
) {

589 
VNIL
: 
VFALSE
: {

590 
e
->
k
 = 
VTRUE
;

593 
VK
: 
VKNUM
: 
VTRUE
: {

594 
e
->
k
 = 
VFALSE
;

597 
VJMP
: {

598 
	`šv”tjump
(
fs
, 
e
);

601 
VRELOCABLE
:

602 
VNONRELOC
: {

603 
	`disch¬ge2ªy»g
(
fs
, 
e
);

604 
	`ä“exp
(
fs
, 
e
);

605 
e
->
u
.
s
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
OP_NOT
, 0,ƒ->u.s.info, 0);

606 
e
->
k
 = 
VRELOCABLE
;

610 
	`lua_as£¹
(0);

615 { 
‹mp
 = 
e
->
f
;ƒ->àğe->
t
;ƒ->t =emp; }

616 
	`»movev®ues
(
fs
, 
e
->
f
);

617 
	`»movev®ues
(
fs
, 
e
->
t
);

618 
	}
}

621 
	$luaK_šdexed
 (
FuncS‹
 *
fs
, 
expdesc
 *
t
,ƒxpdesø*
k
) {

622 
t
->
u
.
s
.
aux
 = 
	`luaK_exp2RK
(
fs
, 
k
);

623 
t
->
k
 = 
VINDEXED
;

624 
	}
}

627 
	$cÚ¡fŞdšg
 (
OpCode
 
İ
, 
expdesc
 *
e1
,ƒxpdesø*
e2
) {

628 
lua_Numb”
 
v1
, 
v2
, 
r
;

629 ià(!
	`i¢um”®
(
e1
è|| !i¢um”®(
e2
))  0;

630 
v1
 = 
e1
->
u
.
nv®
;

631 
v2
 = 
e2
->
u
.
nv®
;

632 
İ
) {

633 
OP_ADD
: 
r
 = 
	`luai_numadd
(
v1
, 
v2
); ;

634 
OP_SUB
: 
r
 = 
	`luai_numsub
(
v1
, 
v2
); ;

635 
OP_MUL
: 
r
 = 
	`luai_nummul
(
v1
, 
v2
); ;

636 
OP_DIV
:

637 ià(
v2
 == 0)  0;

638 
r
 = 
	`luai_numdiv
(
v1
, 
v2
); ;

639 
OP_MOD
:

640 ià(
v2
 == 0)  0;

641 
r
 = 
	`luai_nummod
(
v1
, 
v2
); ;

642 
OP_POW
: 
r
 = 
	`luai_numpow
(
v1
, 
v2
); ;

643 
OP_UNM
: 
r
 = 
	`luai_numunm
(
v1
); ;

644 
OP_LEN
:  0;

645 : 
	`lua_as£¹
(0); 
r
 = 0; ;

647 ià(
	`luai_numi¢ª
(
r
))  0;

648 
e1
->
u
.
nv®
 = 
r
;

650 
	}
}

653 
	$cod—r™h
 (
FuncS‹
 *
fs
, 
OpCode
 
İ
, 
expdesc
 *
e1
,ƒxpdesø*
e2
) {

654 ià(
	`cÚ¡fŞdšg
(
İ
, 
e1
, 
e2
))

657 
o2
 = (
İ
 !ğ
OP_UNM
 && o°!ğ
OP_LEN
è? 
	`luaK_exp2RK
(
fs
, 
e2
) : 0;

658 
o1
 = 
	`luaK_exp2RK
(
fs
, 
e1
);

659 ià(
o1
 > 
o2
) {

660 
	`ä“exp
(
fs
, 
e1
);

661 
	`ä“exp
(
fs
, 
e2
);

664 
	`ä“exp
(
fs
, 
e2
);

665 
	`ä“exp
(
fs
, 
e1
);

667 
e1
->
u
.
s
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
İ
, 0, 
o1
, 
o2
);

668 
e1
->
k
 = 
VRELOCABLE
;

670 
	}
}

673 
	$codecomp
 (
FuncS‹
 *
fs
, 
OpCode
 
İ
, 
cÚd
, 
expdesc
 *
e1
,

674 
expdesc
 *
e2
) {

675 
o1
 = 
	`luaK_exp2RK
(
fs
, 
e1
);

676 
o2
 = 
	`luaK_exp2RK
(
fs
, 
e2
);

677 
	`ä“exp
(
fs
, 
e2
);

678 
	`ä“exp
(
fs
, 
e1
);

679 ià(
cÚd
 =ğ0 && 
İ
 !ğ
OP_EQ
) {

680 
‹mp
;

681 
‹mp
 = 
o1
; o1 = 
o2
; o2 =emp;

682 
cÚd
 = 1;

684 
e1
->
u
.
s
.
šfo
 = 
	`cÚdjump
(
fs
, 
İ
, 
cÚd
, 
o1
, 
o2
);

685 
e1
->
k
 = 
VJMP
;

686 
	}
}

689 
	$luaK_´efix
 (
FuncS‹
 *
fs
, 
UnO´
 
İ
, 
expdesc
 *
e
) {

690 
expdesc
 
e2
;

691 
e2
.
t
 =ƒ2.
f
 = 
NO_JUMP
;ƒ2.
k
 = 
VKNUM
;ƒ2.
u
.
nv®
 = 0;

692 
İ
) {

693 
OPR_MINUS
: {

694 ià(!
	`i¢um”®
(
e
))

695 
	`luaK_exp2ªy»g
(
fs
, 
e
);

696 
	`cod—r™h
(
fs
, 
OP_UNM
, 
e
, &
e2
);

699 
OPR_NOT
: 
	`cod’Ù
(
fs
, 
e
); ;

700 
OPR_LEN
: {

701 
	`luaK_exp2ªy»g
(
fs
, 
e
);

702 
	`cod—r™h
(
fs
, 
OP_LEN
, 
e
, &
e2
);

705 : 
	`lua_as£¹
(0);

707 
	}
}

710 
	$luaK_šfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
, 
expdesc
 *
v
) {

711 
İ
) {

712 
OPR_AND
: {

713 
	`luaK_goiárue
(
fs
, 
v
);

716 
OPR_OR
: {

717 
	`luaK_goifçl£
(
fs
, 
v
);

720 
OPR_CONCAT
: {

721 
	`luaK_exp2ÃxŒeg
(
fs
, 
v
);

724 
OPR_ADD
: 
OPR_SUB
: 
OPR_MUL
: 
OPR_DIV
:

725 
OPR_MOD
: 
OPR_POW
: {

726 ià(!
	`i¢um”®
(
v
)è
	`luaK_exp2RK
(
fs
, v);

730 
	`luaK_exp2RK
(
fs
, 
v
);

734 
	}
}

737 
	$luaK_posfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
, 
expdesc
 *
e1
,ƒxpdesø*
e2
) {

738 
İ
) {

739 
OPR_AND
: {

740 
	`lua_as£¹
(
e1
->
t
 =ğ
NO_JUMP
);

741 
	`luaK_disch¬gev¬s
(
fs
, 
e2
);

742 
	`luaK_cÚÿt
(
fs
, &
e2
->
f
, 
e1
->f);

743 *
e1
 = *
e2
;

746 
OPR_OR
: {

747 
	`lua_as£¹
(
e1
->
f
 =ğ
NO_JUMP
);

748 
	`luaK_disch¬gev¬s
(
fs
, 
e2
);

749 
	`luaK_cÚÿt
(
fs
, &
e2
->
t
, 
e1
->t);

750 *
e1
 = *
e2
;

753 
OPR_CONCAT
: {

754 
	`luaK_exp2v®
(
fs
, 
e2
);

755 ià(
e2
->
k
 =ğ
VRELOCABLE
 && 
	`GET_OPCODE
(
	`g‘code
(
fs
,ƒ2)è=ğ
OP_CONCAT
) {

756 
	`lua_as£¹
(
e1
->
u
.
s
.
šfo
 =ğ
	`GETARG_B
(
	`g‘code
(
fs
, 
e2
))-1);

757 
	`ä“exp
(
fs
, 
e1
);

758 
	`SETARG_B
(
	`g‘code
(
fs
, 
e2
), 
e1
->
u
.
s
.
šfo
);

759 
e1
->
k
 = 
VRELOCABLE
;ƒ1->
u
.
s
.
šfo
 = 
e2
->u.s.info;

762 
	`luaK_exp2ÃxŒeg
(
fs
, 
e2
);

763 
	`cod—r™h
(
fs
, 
OP_CONCAT
, 
e1
, 
e2
);

767 
OPR_ADD
: 
	`cod—r™h
(
fs
, 
OP_ADD
, 
e1
, 
e2
); ;

768 
OPR_SUB
: 
	`cod—r™h
(
fs
, 
OP_SUB
, 
e1
, 
e2
); ;

769 
OPR_MUL
: 
	`cod—r™h
(
fs
, 
OP_MUL
, 
e1
, 
e2
); ;

770 
OPR_DIV
: 
	`cod—r™h
(
fs
, 
OP_DIV
, 
e1
, 
e2
); ;

771 
OPR_MOD
: 
	`cod—r™h
(
fs
, 
OP_MOD
, 
e1
, 
e2
); ;

772 
OPR_POW
: 
	`cod—r™h
(
fs
, 
OP_POW
, 
e1
, 
e2
); ;

773 
OPR_EQ
: 
	`codecomp
(
fs
, 
OP_EQ
, 1, 
e1
, 
e2
); ;

774 
OPR_NE
: 
	`codecomp
(
fs
, 
OP_EQ
, 0, 
e1
, 
e2
); ;

775 
OPR_LT
: 
	`codecomp
(
fs
, 
OP_LT
, 1, 
e1
, 
e2
); ;

776 
OPR_LE
: 
	`codecomp
(
fs
, 
OP_LE
, 1, 
e1
, 
e2
); ;

777 
OPR_GT
: 
	`codecomp
(
fs
, 
OP_LT
, 0, 
e1
, 
e2
); ;

778 
OPR_GE
: 
	`codecomp
(
fs
, 
OP_LE
, 0, 
e1
, 
e2
); ;

779 : 
	`lua_as£¹
(0);

781 
	}
}

784 
	$luaK_fixlše
 (
FuncS‹
 *
fs
, 
lše
) {

785 
fs
->
f
->
lšešfo
[fs->
pc
 - 1] = 
lše
;

786 
	}
}

789 
	$luaK_code
 (
FuncS‹
 *
fs
, 
In¡ruùiÚ
 
i
, 
lše
) {

790 
PrÙo
 *
f
 = 
fs
->f;

791 
	`disch¬gejpc
(
fs
);

793 
	`luaM_growveùÜ
(
fs
->
L
, 
f
->
code
, fs->
pc
, f->
sizecode
, 
In¡ruùiÚ
,

794 
MAX_INT
, "code size overflow");

795 
f
->
code
[
fs
->
pc
] = 
i
;

797 
	`luaM_growveùÜ
(
fs
->
L
, 
f
->
lšešfo
, fs->
pc
, f->
siz–šešfo
, ,

798 
MAX_INT
, "code size overflow");

799 
f
->
lšešfo
[
fs
->
pc
] = 
lše
;

800  
fs
->
pc
++;

801 
	}
}

804 
	$luaK_codeABC
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
a
, 
b
, 
c
) {

805 
	`lua_as£¹
(
	`g‘OpMode
(
o
è=ğ
iABC
);

806 
	`lua_as£¹
(
	`g‘BMode
(
o
è!ğ
OpArgN
 || 
b
 == 0);

807 
	`lua_as£¹
(
	`g‘CMode
(
o
è!ğ
OpArgN
 || 
c
 == 0);

808  
	`luaK_code
(
fs
, 
	`CREATE_ABC
(
o
, 
a
, 
b
, 
c
), fs->
ls
->
Ï¡lše
);

809 
	}
}

812 
	$luaK_codeABx
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
a
, 
bc
) {

813 
	`lua_as£¹
(
	`g‘OpMode
(
o
è=ğ
iABx
 || g‘OpMode(oè=ğ
iAsBx
);

814 
	`lua_as£¹
(
	`g‘CMode
(
o
è=ğ
OpArgN
);

815  
	`luaK_code
(
fs
, 
	`CREATE_ABx
(
o
, 
a
, 
bc
), fs->
ls
->
Ï¡lše
);

816 
	}
}

819 
	$luaK_£i¡
 (
FuncS‹
 *
fs
, 
ba£
, 
ÃËms
, 
to¡Üe
) {

820 
c
 = (
ÃËms
 - 1)/
LFIELDS_PER_FLUSH
 + 1;

821 
b
 = (
to¡Üe
 =ğ
LUA_MULTRET
) ? 0 :ostore;

822 
	`lua_as£¹
(
to¡Üe
 != 0);

823 ià(
c
 <ğ
MAXARG_C
)

824 
	`luaK_codeABC
(
fs
, 
OP_SETLIST
, 
ba£
, 
b
, 
c
);

826 
	`luaK_codeABC
(
fs
, 
OP_SETLIST
, 
ba£
, 
b
, 0);

827 
	`luaK_code
(
fs
, 
	`ÿ¡
(
In¡ruùiÚ
, 
c
), fs->
ls
->
Ï¡lše
);

829 
fs
->
ä“»g
 = 
ba£
 + 1;

830 
	}
}

	@deps/lua/src/lcode.h

7 #iâdeà
lcode_h


8 
	#lcode_h


	)

10 
	~"Îex.h
"

11 
	~"lobjeù.h
"

12 
	~"lİcodes.h
"

13 
	~"Í¬£r.h
"

20 
	#NO_JUMP
 (-1)

	)

26 
	eBšO´
 {

27 
	mOPR_ADD
, 
	mOPR_SUB
, 
	mOPR_MUL
, 
	mOPR_DIV
, 
	mOPR_MOD
, 
	mOPR_POW
,

28 
	mOPR_CONCAT
,

29 
	mOPR_NE
, 
	mOPR_EQ
,

30 
	mOPR_LT
, 
	mOPR_LE
, 
	mOPR_GT
, 
	mOPR_GE
,

31 
	mOPR_AND
, 
	mOPR_OR
,

32 
	mOPR_NOBINOPR


33 } 
	tBšO´
;

36 
	eUnO´
 { 
	mOPR_MINUS
, 
	mOPR_NOT
, 
	mOPR_LEN
, 
	mOPR_NOUNOPR
 } 
	tUnO´
;

39 
	#g‘code
(
fs
,
e
è((fs)->
f
->
code
[Ó)->
u
.
s
.
šfo
])

	)

41 
	#luaK_codeAsBx
(
fs
,
o
,
A
,
sBx
è
	`luaK_codeABx
(fs,o,A,(sBx)+
MAXARG_sBx
)

	)

43 
	#luaK_£tmuÉ»t
(
fs
,
e
è
	`luaK_£Œ‘uºs
(fs,ƒ, 
LUA_MULTRET
)

	)

45 
LUAI_FUNC
 
luaK_codeABx
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
A
, 
Bx
);

46 
LUAI_FUNC
 
luaK_codeABC
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
A
, 
B
, 
C
);

47 
LUAI_FUNC
 
luaK_fixlše
 (
FuncS‹
 *
fs
, 
lše
);

48 
LUAI_FUNC
 
luaK_n
 (
FuncS‹
 *
fs
, 
äom
, 
n
);

49 
LUAI_FUNC
 
luaK_»£rv”egs
 (
FuncS‹
 *
fs
, 
n
);

50 
LUAI_FUNC
 
luaK_check¡ack
 (
FuncS‹
 *
fs
, 
n
);

51 
LUAI_FUNC
 
luaK_¡ršgK
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
s
);

52 
LUAI_FUNC
 
luaK_numb”K
 (
FuncS‹
 *
fs
, 
lua_Numb”
 
r
);

53 
LUAI_FUNC
 
luaK_disch¬gev¬s
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

54 
LUAI_FUNC
 
luaK_exp2ªy»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

55 
LUAI_FUNC
 
luaK_exp2ÃxŒeg
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

56 
LUAI_FUNC
 
luaK_exp2v®
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

57 
LUAI_FUNC
 
luaK_exp2RK
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

58 
LUAI_FUNC
 
luaK_£lf
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
,ƒxpdesø*
key
);

59 
LUAI_FUNC
 
luaK_šdexed
 (
FuncS‹
 *
fs
, 
expdesc
 *
t
,ƒxpdesø*
k
);

60 
LUAI_FUNC
 
luaK_goiárue
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

61 
LUAI_FUNC
 
luaK_¡Üev¬
 (
FuncS‹
 *
fs
, 
expdesc
 *
v¬
,ƒxpdesø*
e
);

62 
LUAI_FUNC
 
luaK_£Œ‘uºs
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
ÄesuÉs
);

63 
LUAI_FUNC
 
luaK_£tÚ”‘
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

64 
LUAI_FUNC
 
luaK_jump
 (
FuncS‹
 *
fs
);

65 
LUAI_FUNC
 
luaK_»t
 (
FuncS‹
 *
fs
, 
fœ¡
, 
Ä‘
);

66 
LUAI_FUNC
 
luaK_·tchli¡
 (
FuncS‹
 *
fs
, 
li¡
, 
rg‘
);

67 
LUAI_FUNC
 
luaK_·tchtoh”e
 (
FuncS‹
 *
fs
, 
li¡
);

68 
LUAI_FUNC
 
luaK_cÚÿt
 (
FuncS‹
 *
fs
, *
l1
, 
l2
);

69 
LUAI_FUNC
 
luaK_g‘Ïb–
 (
FuncS‹
 *
fs
);

70 
LUAI_FUNC
 
luaK_´efix
 (
FuncS‹
 *
fs
, 
UnO´
 
İ
, 
expdesc
 *
v
);

71 
LUAI_FUNC
 
luaK_šfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
, 
expdesc
 *
v
);

72 
LUAI_FUNC
 
luaK_posfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
, 
expdesc
 *
v1
,ƒxpdesø*
v2
);

73 
LUAI_FUNC
 
luaK_£i¡
 (
FuncS‹
 *
fs
, 
ba£
, 
ÃËms
, 
to¡Üe
);

	@deps/lua/src/ldblib.c

8 
	~<¡dio.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

12 
	#ldblib_c


	)

13 
	#LUA_LIB


	)

15 
	~"lua.h
"

17 
	~"Ïuxlib.h
"

18 
	~"lu®ib.h
"

22 
	$db_g‘»gi¡ry
 (
lua_S‹
 *
L
) {

23 
	`lua_pushv®ue
(
L
, 
LUA_REGISTRYINDEX
);

25 
	}
}

28 
	$db_g‘m‘©abË
 (
lua_S‹
 *
L
) {

29 
	`luaL_checkªy
(
L
, 1);

30 ià(!
	`lua_g‘m‘©abË
(
L
, 1)) {

31 
	`lua_pushn
(
L
);

34 
	}
}

37 
	$db_£tm‘©abË
 (
lua_S‹
 *
L
) {

38 
t
 = 
	`lua_ty³
(
L
, 2);

39 
	`luaL_¬gcheck
(
L
, 
t
 =ğ
LUA_TNIL
 || =ğ
LUA_TTABLE
, 2,

41 
	`lua_£‰İ
(
L
, 2);

42 
	`lua_pushboŞ—n
(
L
, 
	`lua_£tm‘©abË
(L, 1));

44 
	}
}

47 
	$db_g‘ãnv
 (
lua_S‹
 *
L
) {

48 
	`luaL_checkªy
(
L
, 1);

49 
	`lua_g‘ãnv
(
L
, 1);

51 
	}
}

54 
	$db_£tãnv
 (
lua_S‹
 *
L
) {

55 
	`luaL_checkty³
(
L
, 2, 
LUA_TTABLE
);

56 
	`lua_£‰İ
(
L
, 2);

57 ià(
	`lua_£tãnv
(
L
, 1) == 0)

58 
	`luaL_”rÜ
(
L
, 
	`LUA_QL
("setfenv")

61 
	}
}

64 
	$£‰abss
 (
lua_S‹
 *
L
, cÚ¡ *
i
, cÚ¡ *
v
) {

65 
	`lua_push¡ršg
(
L
, 
v
);

66 
	`lua_£tf›ld
(
L
, -2, 
i
);

67 
	}
}

70 
	$£‰absi
 (
lua_S‹
 *
L
, cÚ¡ *
i
, 
v
) {

71 
	`lua_pushš‹g”
(
L
, 
v
);

72 
	`lua_£tf›ld
(
L
, -2, 
i
);

73 
	}
}

76 
lua_S‹
 *
	$g‘th»ad
 (
lua_S‹
 *
L
, *
¬g
) {

77 ià(
	`lua_i¡h»ad
(
L
, 1)) {

78 *
¬g
 = 1;

79  
	`lua_tÙh»ad
(
L
, 1);

82 *
¬g
 = 0;

83  
L
;

85 
	}
}

88 
	$Œ—t¡ackİtiÚ
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
, cÚ¡ *
âame
) {

89 ià(
L
 =ğ
L1
) {

90 
	`lua_pushv®ue
(
L
, -2);

91 
	`lua_»move
(
L
, -3);

94 
	`lua_xmove
(
L1
, 
L
, 1);

95 
	`lua_£tf›ld
(
L
, -2, 
âame
);

96 
	}
}

99 
	$db_g‘šfo
 (
lua_S‹
 *
L
) {

100 
lua_Debug
 
¬
;

101 
¬g
;

102 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

103 cÚ¡ *
İtiÚs
 = 
	`luaL_İt¡ršg
(
L
, 
¬g
+2, "flnSu");

104 ià(
	`lua_i¢umb”
(
L
, 
¬g
+1)) {

105 ià(!
	`lua_g‘¡ack
(
L1
, ()
	`lua_toš‹g”
(
L
, 
¬g
+1), &
¬
)) {

106 
	`lua_pushn
(
L
);

110 ià(
	`lua_isfunùiÚ
(
L
, 
¬g
+1)) {

111 
	`lua_pushf¡ršg
(
L
, ">%s", 
İtiÚs
);

112 
İtiÚs
 = 
	`lua_to¡ršg
(
L
, -1);

113 
	`lua_pushv®ue
(
L
, 
¬g
+1);

114 
	`lua_xmove
(
L
, 
L1
, 1);

117  
	`luaL_¬g”rÜ
(
L
, 
¬g
+1, "function or†evelƒxpected");

118 ià(!
	`lua_g‘šfo
(
L1
, 
İtiÚs
, &
¬
))

119  
	`luaL_¬g”rÜ
(
L
, 
¬g
+2, "invalid option");

120 
	`lua_ü—‹bË
(
L
, 0, 2);

121 ià(
	`¡rchr
(
İtiÚs
, 'S')) {

122 
	`£‰abss
(
L
, "sourû", 
¬
.
sourû
);

123 
	`£‰abss
(
L
, "shÜt_¤c", 
¬
.
shÜt_¤c
);

124 
	`£‰absi
(
L
, "lšedefšed", 
¬
.
lšedefšed
);

125 
	`£‰absi
(
L
, "Ï¡lšedefšed", 
¬
.
Ï¡lšedefšed
);

126 
	`£‰abss
(
L
, "wh©", 
¬
.
wh©
);

128 ià(
	`¡rchr
(
İtiÚs
, 'l'))

129 
	`£‰absi
(
L
, "cu¼’še", 
¬
.
cu¼’še
);

130 ià(
	`¡rchr
(
İtiÚs
, 'u'))

131 
	`£‰absi
(
L
, "nups", 
¬
.
nups
);

132 ià(
	`¡rchr
(
İtiÚs
, 'n')) {

133 
	`£‰abss
(
L
, "Çme", 
¬
.
Çme
);

134 
	`£‰abss
(
L
, "Çmewh©", 
¬
.
Çmewh©
);

136 ià(
	`¡rchr
(
İtiÚs
, 'L'))

137 
	`Œ—t¡ackİtiÚ
(
L
, 
L1
, "activelines");

138 ià(
	`¡rchr
(
İtiÚs
, 'f'))

139 
	`Œ—t¡ackİtiÚ
(
L
, 
L1
, "func");

141 
	}
}

144 
	$db_g‘loÿl
 (
lua_S‹
 *
L
) {

145 
¬g
;

146 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

147 
lua_Debug
 
¬
;

148 cÚ¡ *
Çme
;

149 ià(!
	`lua_g‘¡ack
(
L1
, 
	`luaL_checkšt
(
L
, 
¬g
+1), &
¬
))

150  
	`luaL_¬g”rÜ
(
L
, 
¬g
+1, "level out of„ange");

151 
Çme
 = 
	`lua_g‘loÿl
(
L1
, &
¬
, 
	`luaL_checkšt
(
L
, 
¬g
+2));

152 ià(
Çme
) {

153 
	`lua_xmove
(
L1
, 
L
, 1);

154 
	`lua_push¡ršg
(
L
, 
Çme
);

155 
	`lua_pushv®ue
(
L
, -2);

159 
	`lua_pushn
(
L
);

162 
	}
}

165 
	$db_£oÿl
 (
lua_S‹
 *
L
) {

166 
¬g
;

167 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

168 
lua_Debug
 
¬
;

169 ià(!
	`lua_g‘¡ack
(
L1
, 
	`luaL_checkšt
(
L
, 
¬g
+1), &
¬
))

170  
	`luaL_¬g”rÜ
(
L
, 
¬g
+1, "level out of„ange");

171 
	`luaL_checkªy
(
L
, 
¬g
+3);

172 
	`lua_£‰İ
(
L
, 
¬g
+3);

173 
	`lua_xmove
(
L
, 
L1
, 1);

174 
	`lua_push¡ršg
(
L
, 
	`lua_£oÿl
(
L1
, &
¬
, 
	`luaL_checkšt
(L, 
¬g
+2)));

176 
	}
}

179 
	$auxupv®ue
 (
lua_S‹
 *
L
, 
g‘
) {

180 cÚ¡ *
Çme
;

181 
n
 = 
	`luaL_checkšt
(
L
, 2);

182 
	`luaL_checkty³
(
L
, 1, 
LUA_TFUNCTION
);

183 ià(
	`lua_iscfunùiÚ
(
L
, 1))  0;

184 
Çme
 = 
g‘
 ? 
	`lua_g‘upv®ue
(
L
, 1, 
n
è: 
	`lua_£tupv®ue
(L, 1,‚);

185 ià(
Çme
 =ğ
NULL
)  0;

186 
	`lua_push¡ršg
(
L
, 
Çme
);

187 
	`lua_š£¹
(
L
, -(
g‘
+1));

188  
g‘
 + 1;

189 
	}
}

192 
	$db_g‘upv®ue
 (
lua_S‹
 *
L
) {

193  
	`auxupv®ue
(
L
, 1);

194 
	}
}

197 
	$db_£tupv®ue
 (
lua_S‹
 *
L
) {

198 
	`luaL_checkªy
(
L
, 3);

199  
	`auxupv®ue
(
L
, 0);

200 
	}
}

204 cÚ¡ 
	gKEY_HOOK
 = 'h';

207 
	$hookf
 (
lua_S‹
 *
L
, 
lua_Debug
 *
¬
) {

208 cÚ¡ *cÚ¡ 
hookÇmes
[] =

210 
	`lua_pushlightu£rd©a
(
L
, (*)&
KEY_HOOK
);

211 
	`lua_¿wg‘
(
L
, 
LUA_REGISTRYINDEX
);

212 
	`lua_pushlightu£rd©a
(
L
, L);

213 
	`lua_¿wg‘
(
L
, -2);

214 ià(
	`lua_isfunùiÚ
(
L
, -1)) {

215 
	`lua_push¡ršg
(
L
, 
hookÇmes
[()
¬
->
ev’t
]);

216 ià(
¬
->
cu¼’še
 >= 0)

217 
	`lua_pushš‹g”
(
L
, 
¬
->
cu¼’še
);

218 
	`lua_pushn
(
L
);

219 
	`lua_as£¹
(
	`lua_g‘šfo
(
L
, "lS", 
¬
));

220 
	`lua_ÿÎ
(
L
, 2, 0);

222 
	}
}

225 
	$makemask
 (cÚ¡ *
smask
, 
couÁ
) {

226 
mask
 = 0;

227 ià(
	`¡rchr
(
smask
, 'c')è
mask
 |ğ
LUA_MASKCALL
;

228 ià(
	`¡rchr
(
smask
, 'r')è
mask
 |ğ
LUA_MASKRET
;

229 ià(
	`¡rchr
(
smask
, 'l')è
mask
 |ğ
LUA_MASKLINE
;

230 ià(
couÁ
 > 0è
mask
 |ğ
LUA_MASKCOUNT
;

231  
mask
;

232 
	}
}

235 *
	$unmakemask
 (
mask
, *
smask
) {

236 
i
 = 0;

237 ià(
mask
 & 
LUA_MASKCALL
è
smask
[
i
++] = 'c';

238 ià(
mask
 & 
LUA_MASKRET
è
smask
[
i
++] = 'r';

239 ià(
mask
 & 
LUA_MASKLINE
è
smask
[
i
++] = 'l';

240 
smask
[
i
] = '\0';

241  
smask
;

242 
	}
}

245 
	$g‘hookbË
 (
lua_S‹
 *
L
) {

246 
	`lua_pushlightu£rd©a
(
L
, (*)&
KEY_HOOK
);

247 
	`lua_¿wg‘
(
L
, 
LUA_REGISTRYINDEX
);

248 ià(!
	`lua_i¡abË
(
L
, -1)) {

249 
	`lua_pİ
(
L
, 1);

250 
	`lua_ü—‹bË
(
L
, 0, 1);

251 
	`lua_pushlightu£rd©a
(
L
, (*)&
KEY_HOOK
);

252 
	`lua_pushv®ue
(
L
, -2);

253 
	`lua_¿w£t
(
L
, 
LUA_REGISTRYINDEX
);

255 
	}
}

258 
	$db_£thook
 (
lua_S‹
 *
L
) {

259 
¬g
, 
mask
, 
couÁ
;

260 
lua_Hook
 
func
;

261 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

262 ià(
	`lua_i¢ÚeÜn
(
L
, 
¬g
+1)) {

263 
	`lua_£‰İ
(
L
, 
¬g
+1);

264 
func
 = 
NULL
; 
mask
 = 0; 
couÁ
 = 0;

267 cÚ¡ *
smask
 = 
	`luaL_check¡ršg
(
L
, 
¬g
+2);

268 
	`luaL_checkty³
(
L
, 
¬g
+1, 
LUA_TFUNCTION
);

269 
couÁ
 = 
	`luaL_İtšt
(
L
, 
¬g
+3, 0);

270 
func
 = 
hookf
; 
mask
 = 
	`makemask
(
smask
, 
couÁ
);

272 
	`g‘hookbË
(
L
);

273 
	`lua_pushlightu£rd©a
(
L
, 
L1
);

274 
	`lua_pushv®ue
(
L
, 
¬g
+1);

275 
	`lua_¿w£t
(
L
, -3);

276 
	`lua_pİ
(
L
, 1);

277 
	`lua_£thook
(
L1
, 
func
, 
mask
, 
couÁ
);

279 
	}
}

282 
	$db_g‘hook
 (
lua_S‹
 *
L
) {

283 
¬g
;

284 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

285 
buff
[5];

286 
mask
 = 
	`lua_g‘hookmask
(
L1
);

287 
lua_Hook
 
hook
 = 
	`lua_g‘hook
(
L1
);

288 ià(
hook
 !ğ
NULL
 && hook !ğ
hookf
)

289 
	`lua_pushl™”®
(
L
, "external hook");

291 
	`g‘hookbË
(
L
);

292 
	`lua_pushlightu£rd©a
(
L
, 
L1
);

293 
	`lua_¿wg‘
(
L
, -2);

294 
	`lua_»move
(
L
, -2);

296 
	`lua_push¡ršg
(
L
, 
	`unmakemask
(
mask
, 
buff
));

297 
	`lua_pushš‹g”
(
L
, 
	`lua_g‘hookcouÁ
(
L1
));

299 
	}
}

302 
	$db_debug
 (
lua_S‹
 *
L
) {

304 
bufãr
[250];

305 
	`åuts
("lua_debug> ", 
¡d”r
);

306 ià(
	`fg‘s
(
bufãr
, (bufãr), 
¡dš
) == 0 ||

307 
	`¡rcmp
(
bufãr
, "cont\n") == 0)

309 ià(
	`luaL_lßdbufãr
(
L
, 
bufãr
, 
	`¡¾’
(buffer), "=(debug command)") ||

310 
	`lua_pÿÎ
(
L
, 0, 0, 0)) {

311 
	`åuts
(
	`lua_to¡ršg
(
L
, -1), 
¡d”r
);

312 
	`åuts
("\n", 
¡d”r
);

314 
	`lua_£‰İ
(
L
, 0);

316 
	}
}

319 
	#LEVELS1
 12

	)

320 
	#LEVELS2
 10

	)

322 
	$db_”rÜfb
 (
lua_S‹
 *
L
) {

323 
Ëv–
;

324 
fœ¡·¹
 = 1;

325 
¬g
;

326 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

327 
lua_Debug
 
¬
;

328 ià(
	`lua_i¢umb”
(
L
, 
¬g
+2)) {

329 
Ëv–
 = ()
	`lua_toš‹g”
(
L
, 
¬g
+2);

330 
	`lua_pİ
(
L
, 1);

333 
Ëv–
 = (
L
 =ğ
L1
) ? 1 : 0;

334 ià(
	`lua_g‘tİ
(
L
è=ğ
¬g
)

335 
	`lua_pushl™”®
(
L
, "");

336 ià(!
	`lua_is¡ršg
(
L
, 
¬g
+1))  1;

337 
	`lua_pushl™”®
(
L
, "\n");

338 
	`lua_pushl™”®
(
L
, "stackraceback:");

339 
	`lua_g‘¡ack
(
L1
, 
Ëv–
++, &
¬
)) {

340 ià(
Ëv–
 > 
LEVELS1
 && 
fœ¡·¹
) {

342 ià(!
	`lua_g‘¡ack
(
L1
, 
Ëv–
+
LEVELS2
, &
¬
))

343 
Ëv–
--;

345 
	`lua_pushl™”®
(
L
, "\n\t...");

346 
	`lua_g‘¡ack
(
L1
, 
Ëv–
+
LEVELS2
, &
¬
))

347 
Ëv–
++;

349 
fœ¡·¹
 = 0;

352 
	`lua_pushl™”®
(
L
, "\n\t");

353 
	`lua_g‘šfo
(
L1
, "SÆ", &
¬
);

354 
	`lua_pushf¡ršg
(
L
, "%s:", 
¬
.
shÜt_¤c
);

355 ià(
¬
.
cu¼’še
 > 0)

356 
	`lua_pushf¡ršg
(
L
, "%d:", 
¬
.
cu¼’še
);

357 ià(*
¬
.
Çmewh©
 != '\0')

358 
	`lua_pushf¡ršg
(
L
, " iÀfunùiÚ " 
LUA_QS
, 
¬
.
Çme
);

360 ià(*
¬
.
wh©
 == 'm')

361 
	`lua_pushf¡ršg
(
L
, " in main chunk");

362 ià(*
¬
.
wh©
 == 'C' || *ar.what == 't')

363 
	`lua_pushl™”®
(
L
, " ?");

365 
	`lua_pushf¡ršg
(
L
, " in function <%s:%d>",

366 
¬
.
shÜt_¤c
,‡r.
lšedefšed
);

368 
	`lua_cÚÿt
(
L
, 
	`lua_g‘tİ
(Lè- 
¬g
);

370 
	`lua_cÚÿt
(
L
, 
	`lua_g‘tİ
(Lè- 
¬g
);

372 
	}
}

375 cÚ¡ 
luaL_Reg
 
	gdblib
[] = {

376 {"debug", 
db_debug
},

377 {"g‘ãnv", 
db_g‘ãnv
},

378 {"g‘hook", 
db_g‘hook
},

379 {"g‘šfo", 
db_g‘šfo
},

380 {"g‘loÿl", 
db_g‘loÿl
},

381 {"g‘»gi¡ry", 
db_g‘»gi¡ry
},

382 {"g‘m‘©abË", 
db_g‘m‘©abË
},

383 {"g‘upv®ue", 
db_g‘upv®ue
},

384 {"£tãnv", 
db_£tãnv
},

385 {"£thook", 
db_£thook
},

386 {"£oÿl", 
db_£oÿl
},

387 {"£tm‘©abË", 
db_£tm‘©abË
},

388 {"£tupv®ue", 
db_£tupv®ue
},

389 {"Œaûback", 
db_”rÜfb
},

390 {
NULL
, NULL}

394 
LUALIB_API
 
	$luaİ’_debug
 (
lua_S‹
 *
L
) {

395 
	`luaL_»gi¡”
(
L
, 
LUA_DBLIBNAME
, 
dblib
);

397 
	}
}

	@deps/lua/src/ldebug.c

8 
	~<¡d¬g.h
>

9 
	~<¡ddef.h
>

10 
	~<¡ršg.h
>

13 
	#ldebug_c


	)

14 
	#LUA_CORE


	)

16 
	~"lua.h
"

18 
	~"Ïpi.h
"

19 
	~"lcode.h
"

20 
	~"ldebug.h
"

21 
	~"ldo.h
"

22 
	~"lfunc.h
"

23 
	~"lobjeù.h
"

24 
	~"lİcodes.h
"

25 
	~"l¡©e.h
"

26 
	~"l¡ršg.h
"

27 
	~"ÉabË.h
"

28 
	~"Ém.h
"

29 
	~"lvm.h
"

33 cÚ¡ *
g‘funúame
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, cÚ¡ **
Çme
);

36 
	$cu¼’c
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
) {

37 ià(!
	`isLua
(
ci
))  -1;

38 ià(
ci
 =ğ
L
->ci)

39 
ci
->
§vedpc
 = 
L
->savedpc;

40  
	`pcR–
(
ci
->
§vedpc
, 
	`ci_func
(ci)->
l
.
p
);

41 
	}
}

44 
	$cu¼’še
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
) {

45 
pc
 = 
	`cu¼’c
(
L
, 
ci
);

46 ià(
pc
 < 0)

49  
	`g‘lše
(
	`ci_func
(
ci
)->
l
.
p
, 
pc
);

50 
	}
}

56 
LUA_API
 
	$lua_£thook
 (
lua_S‹
 *
L
, 
lua_Hook
 
func
, 
mask
, 
couÁ
) {

57 ià(
func
 =ğ
NULL
 || 
mask
 == 0) {

58 
mask
 = 0;

59 
func
 = 
NULL
;

61 
L
->
hook
 = 
func
;

62 
L
->
ba£hookcouÁ
 = 
couÁ
;

63 
	`»£thookcouÁ
(
L
);

64 
L
->
hookmask
 = 
	`ÿ¡_by‹
(
mask
);

66 
	}
}

69 
LUA_API
 
lua_Hook
 
	$lua_g‘hook
 (
lua_S‹
 *
L
) {

70  
L
->
hook
;

71 
	}
}

74 
LUA_API
 
	$lua_g‘hookmask
 (
lua_S‹
 *
L
) {

75  
L
->
hookmask
;

76 
	}
}

79 
LUA_API
 
	$lua_g‘hookcouÁ
 (
lua_S‹
 *
L
) {

80  
L
->
ba£hookcouÁ
;

81 
	}
}

84 
LUA_API
 
	$lua_g‘¡ack
 (
lua_S‹
 *
L
, 
Ëv–
, 
lua_Debug
 *
¬
) {

85 
¡©us
;

86 
C®lInfo
 *
ci
;

87 
	`lua_lock
(
L
);

88 
ci
 = 
L
->ci; 
Ëv–
 > 0 && c˜> L->
ba£_ci
; ci--) {

89 
Ëv–
--;

90 ià(
	`f_isLua
(
ci
))

91 
Ëv–
 -ğ
ci
->
ÿÎs
;

93 ià(
Ëv–
 =ğ0 && 
ci
 > 
L
->
ba£_ci
) {

94 
¡©us
 = 1;

95 
¬
->
i_ci
 = 
	`ÿ¡_št
(
ci
 - 
L
->
ba£_ci
);

97 ià(
Ëv–
 < 0) {

98 
¡©us
 = 1;

99 
¬
->
i_ci
 = 0;

101 
¡©us
 = 0;

102 
	`lua_uÆock
(
L
);

103  
¡©us
;

104 
	}
}

107 
PrÙo
 *
	$g‘lu­rÙo
 (
C®lInfo
 *
ci
) {

108  (
	`isLua
(
ci
è? 
	`ci_func
(ci)->
l
.
p
 : 
NULL
);

109 
	}
}

112 cÚ¡ *
	$fšdloÿl
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, 
n
) {

113 cÚ¡ *
Çme
;

114 
PrÙo
 *
å
 = 
	`g‘lu­rÙo
(
ci
);

115 ià(
å
 && (
Çme
 = 
	`luaF_g‘loÿÊame
(å, 
n
, 
	`cu¼’c
(
L
, 
ci
))è!ğ
NULL
)

116  
Çme
;

118 
StkId
 
lim™
 = (
ci
 =ğ
L
->ciè? L->
tİ
 : (ci+1)->
func
;

119 ià(
lim™
 - 
ci
->
ba£
 >ğ
n
 &&‚ > 0)

122  
NULL
;

124 
	}
}

127 
LUA_API
 cÚ¡ *
	$lua_g‘loÿl
 (
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
) {

128 
C®lInfo
 *
ci
 = 
L
->
ba£_ci
 + 
¬
->
i_ci
;

129 cÚ¡ *
Çme
 = 
	`fšdloÿl
(
L
, 
ci
, 
n
);

130 
	`lua_lock
(
L
);

131 ià(
Çme
)

132 
	`luaA_pushobjeù
(
L
, 
ci
->
ba£
 + (
n
 - 1));

133 
	`lua_uÆock
(
L
);

134  
Çme
;

135 
	}
}

138 
LUA_API
 cÚ¡ *
	$lua_£oÿl
 (
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
) {

139 
C®lInfo
 *
ci
 = 
L
->
ba£_ci
 + 
¬
->
i_ci
;

140 cÚ¡ *
Çme
 = 
	`fšdloÿl
(
L
, 
ci
, 
n
);

141 
	`lua_lock
(
L
);

142 ià(
Çme
)

143 
	`£tobjs2s
(
L
, 
ci
->
ba£
 + (
n
 - 1), L->
tİ
 - 1);

144 
L
->
tİ
--;

145 
	`lua_uÆock
(
L
);

146  
Çme
;

147 
	}
}

150 
	$funcšfo
 (
lua_Debug
 *
¬
, 
Closu»
 *
ş
) {

151 ià(
ş
->
c
.
isC
) {

152 
¬
->
sourû
 = "=[C]";

153 
¬
->
lšedefšed
 = -1;

154 
¬
->
Ï¡lšedefšed
 = -1;

155 
¬
->
wh©
 = "C";

158 
¬
->
sourû
 = 
	`g‘¡r
(
ş
->
l
.
p
->source);

159 
¬
->
lšedefšed
 = 
ş
->
l
.
p
->linedefined;

160 
¬
->
Ï¡lšedefšed
 = 
ş
->
l
.
p
->lastlinedefined;

161 
¬
->
wh©
 = (¬->
lšedefšed
 == 0) ? "main" : "Lua";

163 
	`luaO_chunkid
(
¬
->
shÜt_¤c
,‡r->
sourû
, 
LUA_IDSIZE
);

164 
	}
}

167 
	$šfo_ÿÎ
 (
lua_Debug
 *
¬
) {

168 
¬
->
Çme
 =‡r->
Çmewh©
 = "";

169 
¬
->
wh©
 = "tail";

170 
¬
->
Ï¡lšedefšed
 =‡r->
lšedefšed
 =‡r->
cu¼’še
 = -1;

171 
¬
->
sourû
 = "=(tail call)";

172 
	`luaO_chunkid
(
¬
->
shÜt_¤c
,‡r->
sourû
, 
LUA_IDSIZE
);

173 
¬
->
nups
 = 0;

174 
	}
}

177 
	$cŞËùv®idlšes
 (
lua_S‹
 *
L
, 
Closu»
 *
f
) {

178 ià(
f
 =ğ
NULL
 || f->
c
.
isC
) {

179 
	`£Šv®ue
(
L
->
tİ
);

182 
TabË
 *
t
 = 
	`luaH_Ãw
(
L
, 0, 0);

183 *
lšešfo
 = 
f
->
l
.
p
->lineinfo;

184 
i
;

185 
i
=0; i<
f
->
l
.
p
->
siz–šešfo
; i++)

186 
	`£tbv®ue
(
	`luaH_£Šum
(
L
, 
t
, 
lšešfo
[
i
]), 1);

187 
	`£thv®ue
(
L
, L->
tİ
, 
t
);

189 
	`šü_tİ
(
L
);

190 
	}
}

193 
	$auxg‘šfo
 (
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
lua_Debug
 *
¬
,

194 
Closu»
 *
f
, 
C®lInfo
 *
ci
) {

195 
¡©us
 = 1;

196 ià(
f
 =ğ
NULL
) {

197 
	`šfo_ÿÎ
(
¬
);

198  
¡©us
;

200 ; *
wh©
; what++) {

201 *
wh©
) {

203 
	`funcšfo
(
¬
, 
f
);

207 
¬
->
cu¼’še
 = (
ci
è? 
	`cu¼’še
(
L
, ci) : -1;

211 
¬
->
nups
 = 
f
->
c
.
nupv®ues
;

215 
¬
->
Çmewh©
 = (
ci
è? 
	`g‘funúame
(
L
, ci, &¬->
Çme
è: 
NULL
;

216 ià(
¬
->
Çmewh©
 =ğ
NULL
) {

217 
¬
->
Çmewh©
 = "";

218 
¬
->
Çme
 = 
NULL
;

225 : 
¡©us
 = 0;

228  
¡©us
;

229 
	}
}

232 
LUA_API
 
	$lua_g‘šfo
 (
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
lua_Debug
 *
¬
) {

233 
¡©us
;

234 
Closu»
 *
f
 = 
NULL
;

235 
C®lInfo
 *
ci
 = 
NULL
;

236 
	`lua_lock
(
L
);

237 ià(*
wh©
 == '>') {

238 
StkId
 
func
 = 
L
->
tİ
 - 1;

239 
	`luai_­icheck
(
L
, 
	`‰isfunùiÚ
(
func
));

240 
wh©
++;

241 
f
 = 
	`şv®ue
(
func
);

242 
L
->
tİ
--;

244 ià(
¬
->
i_ci
 != 0) {

245 
ci
 = 
L
->
ba£_ci
 + 
¬
->
i_ci
;

246 
	`lua_as£¹
(
	`‰isfunùiÚ
(
ci
->
func
));

247 
f
 = 
	`şv®ue
(
ci
->
func
);

249 
¡©us
 = 
	`auxg‘šfo
(
L
, 
wh©
, 
¬
, 
f
, 
ci
);

250 ià(
	`¡rchr
(
wh©
, 'f')) {

251 ià(
f
 =ğ
NULL
è
	`£Šv®ue
(
L
->
tİ
);

252 
	`£tşv®ue
(
L
, L->
tİ
, 
f
);

253 
	`šü_tİ
(
L
);

255 ià(
	`¡rchr
(
wh©
, 'L'))

256 
	`cŞËùv®idlšes
(
L
, 
f
);

257 
	`lua_uÆock
(
L
);

258  
¡©us
;

259 
	}
}

268 
	#check
(
x
èià(!(x)è 0;

	)

270 
	#checkjump
(
±
,
pc
è
	`check
(0 <ğpø&&…ø<…t->
sizecode
)

	)

272 
	#check»g
(
±
,
»g
è
	`check
(Ôegè< (±)->
max¡acksize
)

	)

276 
	$´echeck
 (cÚ¡ 
PrÙo
 *
±
) {

277 
	`check
(
±
->
max¡acksize
 <ğ
MAXSTACK
);

278 
	`check
(
±
->
num·¿ms
+Õt->
is_v¬¬g
 & 
VARARG_HASARG
è<ğ±->
max¡acksize
);

279 
	`check
(!(
±
->
is_v¬¬g
 & 
VARARG_NEEDSARG
) ||

280 (
±
->
is_v¬¬g
 & 
VARARG_HASARG
));

281 
	`check
(
±
->
sizeupv®ues
 <ğ±->
nups
);

282 
	`check
(
±
->
siz–šešfo
 =ğ±->
sizecode
 ||…t->sizelineinfo == 0);

283 
	`check
(
±
->
sizecode
 > 0 && 
	`GET_OPCODE
Õt->
code
[±->sizecode-1]è=ğ
OP_RETURN
);

285 
	}
}

288 
	#checkİ’İ
(
±
,
pc
è
	`luaG_checkİ’İ
(Õt)->
code
[Õc)+1])

	)

290 
	$luaG_checkİ’İ
 (
In¡ruùiÚ
 
i
) {

291 
	`GET_OPCODE
(
i
)) {

292 
OP_CALL
:

293 
OP_TAILCALL
:

294 
OP_RETURN
:

295 
OP_SETLIST
: {

296 
	`check
(
	`GETARG_B
(
i
) == 0);

301 
	}
}

304 
	$checkArgMode
 (cÚ¡ 
PrÙo
 *
±
, 
r
, 
OpArgMask
 
mode
) {

305 
mode
) {

306 
OpArgN
: 
	`check
(
r
 == 0); ;

307 
OpArgU
: ;

308 
OpArgR
: 
	`check»g
(
±
, 
r
); ;

309 
OpArgK
:

310 
	`check
(
	`ISK
(
r
è? 
	`INDEXK
Ôè< 
±
->
sizek
 :„ <…t->
max¡acksize
);

314 
	}
}

317 
In¡ruùiÚ
 
	$symbexec
 (cÚ¡ 
PrÙo
 *
±
, 
Ï¡pc
, 
»g
) {

318 
pc
;

319 
Ï¡
;

320 
Ï¡
 = 
±
->
sizecode
-1;

321 
	`check
(
	`´echeck
(
±
));

322 
pc
 = 0;…ø< 
Ï¡pc
;…c++) {

323 
In¡ruùiÚ
 
i
 = 
±
->
code
[
pc
];

324 
OpCode
 
İ
 = 
	`GET_OPCODE
(
i
);

325 
a
 = 
	`GETARG_A
(
i
);

326 
b
 = 0;

327 
c
 = 0;

328 
	`check
(
İ
 < 
NUM_OPCODES
);

329 
	`check»g
(
±
, 
a
);

330 
	`g‘OpMode
(
İ
)) {

331 
iABC
: {

332 
b
 = 
	`GETARG_B
(
i
);

333 
c
 = 
	`GETARG_C
(
i
);

334 
	`check
(
	`checkArgMode
(
±
, 
b
, 
	`g‘BMode
(
İ
)));

335 
	`check
(
	`checkArgMode
(
±
, 
c
, 
	`g‘CMode
(
İ
)));

338 
iABx
: {

339 
b
 = 
	`GETARG_Bx
(
i
);

340 ià(
	`g‘BMode
(
İ
è=ğ
OpArgK
è
	`check
(
b
 < 
±
->
sizek
);

343 
iAsBx
: {

344 
b
 = 
	`GETARG_sBx
(
i
);

345 ià(
	`g‘BMode
(
İ
è=ğ
OpArgR
) {

346 
de¡
 = 
pc
+1+
b
;

347 
	`check
(0 <ğ
de¡
 && de¡ < 
±
->
sizecode
);

348 ià(
de¡
 > 0) {

349 
j
;

354 
j
 = 0; j < 
de¡
; j++) {

355 
In¡ruùiÚ
 
d
 = 
±
->
code
[
de¡
-1-
j
];

356 ià(!(
	`GET_OPCODE
(
d
è=ğ
OP_SETLIST
 && 
	`GETARG_C
(d) == 0)) ;

360 
	`check
((
j
&1) == 0);

366 ià(
	`‹¡AMode
(
İ
)) {

367 ià(
a
 =ğ
»g
è
Ï¡
 = 
pc
;

369 ià(
	`‹¡TMode
(
İ
)) {

370 
	`check
(
pc
+2 < 
±
->
sizecode
);

371 
	`check
(
	`GET_OPCODE
(
±
->
code
[
pc
+1]è=ğ
OP_JMP
);

373 
İ
) {

374 
OP_LOADBOOL
: {

375 ià(
c
 == 1) {

376 
	`check
(
pc
+2 < 
±
->
sizecode
);

377 
	`check
(
	`GET_OPCODE
(
±
->
code
[
pc
+1]è!ğ
OP_SETLIST
 ||

378 
	`GETARG_C
(
±
->
code
[
pc
+1]) != 0);

382 
OP_LOADNIL
: {

383 ià(
a
 <ğ
»g
 &&„eg <ğ
b
)

384 
Ï¡
 = 
pc
;

387 
OP_GETUPVAL
:

388 
OP_SETUPVAL
: {

389 
	`check
(
b
 < 
±
->
nups
);

392 
OP_GETGLOBAL
:

393 
OP_SETGLOBAL
: {

394 
	`check
(
	`‰is¡ršg
(&
±
->
k
[
b
]));

397 
OP_SELF
: {

398 
	`check»g
(
±
, 
a
+1);

399 ià(
»g
 =ğ
a
+1è
Ï¡
 = 
pc
;

402 
OP_CONCAT
: {

403 
	`check
(
b
 < 
c
);

406 
OP_TFORLOOP
: {

407 
	`check
(
c
 >= 1);

408 
	`check»g
(
±
, 
a
+2+
c
);

409 ià(
»g
 >ğ
a
+2è
Ï¡
 = 
pc
;

412 
OP_FORLOOP
:

413 
OP_FORPREP
:

414 
	`check»g
(
±
, 
a
+3);

416 
OP_JMP
: {

417 
de¡
 = 
pc
+1+
b
;

419 ià(
»g
 !ğ
NO_REG
 && 
pc
 < 
de¡
 && de¡ <ğ
Ï¡pc
)

420 
pc
 +ğ
b
;

423 
OP_CALL
:

424 
OP_TAILCALL
: {

425 ià(
b
 != 0) {

426 
	`check»g
(
±
, 
a
+
b
-1);

428 
c
--;

429 ià(
c
 =ğ
LUA_MULTRET
) {

430 
	`check
(
	`checkİ’İ
(
±
, 
pc
));

432 ià(
c
 != 0)

433 
	`check»g
(
±
, 
a
+
c
-1);

434 ià(
»g
 >ğ
a
è
Ï¡
 = 
pc
;

437 
OP_RETURN
: {

438 
b
--;

439 ià(
b
 > 0è
	`check»g
(
±
, 
a
+b-1);

442 
OP_SETLIST
: {

443 ià(
b
 > 0è
	`check»g
(
±
, 
a
 + b);

444 ià(
c
 == 0) {

445 
pc
++;

446 
	`check
(
pc
 < 
±
->
sizecode
 - 1);

450 
OP_CLOSURE
: {

451 
nup
, 
j
;

452 
	`check
(
b
 < 
±
->
siz•
);

453 
nup
 = 
±
->
p
[
b
]->
nups
;

454 
	`check
(
pc
 + 
nup
 < 
±
->
sizecode
);

455 
j
 = 1; j <ğ
nup
; j++) {

456 
OpCode
 
İ1
 = 
	`GET_OPCODE
(
±
->
code
[
pc
 + 
j
]);

457 
	`check
(
İ1
 =ğ
OP_GETUPVAL
 || op1 =ğ
OP_MOVE
);

459 ià(
»g
 !ğ
NO_REG
)

460 
pc
 +ğ
nup
;

463 
OP_VARARG
: {

464 
	`check
((
±
->
is_v¬¬g
 & 
VARARG_ISVARARG
) &&

465 !(
±
->
is_v¬¬g
 & 
VARARG_NEEDSARG
));

466 
b
--;

467 ià(
b
 =ğ
LUA_MULTRET
è
	`check
(
	`checkİ’İ
(
±
, 
pc
));

468 
	`check»g
(
±
, 
a
+
b
-1);

474  
±
->
code
[
Ï¡
];

475 
	}
}

477 #undeà
check


478 #undeà
checkjump


479 #undeà
check»g


484 
	$luaG_checkcode
 (cÚ¡ 
PrÙo
 *
±
) {

485  (
	`symbexec
(
±
,…t->
sizecode
, 
NO_REG
) != 0);

486 
	}
}

489 cÚ¡ *
	$kÇme
 (
PrÙo
 *
p
, 
c
) {

490 ià(
	`ISK
(
c
è&& 
	`‰is¡ršg
(&
p
->
k
[
	`INDEXK
(c)]))

491  
	`sv®ue
(&
p
->
k
[
	`INDEXK
(
c
)]);

494 
	}
}

497 cÚ¡ *
	$g‘objÇme
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, 
¡ackpos
,

498 cÚ¡ **
Çme
) {

499 ià(
	`isLua
(
ci
)) {

500 
PrÙo
 *
p
 = 
	`ci_func
(
ci
)->
l
.p;

501 
pc
 = 
	`cu¼’c
(
L
, 
ci
);

502 
In¡ruùiÚ
 
i
;

503 *
Çme
 = 
	`luaF_g‘loÿÊame
(
p
, 
¡ackpos
+1, 
pc
);

504 ià(*
Çme
)

506 
i
 = 
	`symbexec
(
p
, 
pc
, 
¡ackpos
);

507 
	`lua_as£¹
(
pc
 != -1);

508 
	`GET_OPCODE
(
i
)) {

509 
OP_GETGLOBAL
: {

510 
g
 = 
	`GETARG_Bx
(
i
);

511 
	`lua_as£¹
(
	`‰is¡ršg
(&
p
->
k
[
g
]));

512 *
Çme
 = 
	`sv®ue
(&
p
->
k
[
g
]);

515 
OP_MOVE
: {

516 
a
 = 
	`GETARG_A
(
i
);

517 
b
 = 
	`GETARG_B
(
i
);

518 ià(
b
 < 
a
)

519  
	`g‘objÇme
(
L
, 
ci
, 
b
, 
Çme
);

522 
OP_GETTABLE
: {

523 
k
 = 
	`GETARG_C
(
i
);

524 *
Çme
 = 
	`kÇme
(
p
, 
k
);

527 
OP_GETUPVAL
: {

528 
u
 = 
	`GETARG_B
(
i
);

529 *
Çme
 = 
p
->
upv®ues
 ? 
	`g‘¡r
Õ->upv®ues[
u
]) : "?";

532 
OP_SELF
: {

533 
k
 = 
	`GETARG_C
(
i
);

534 *
Çme
 = 
	`kÇme
(
p
, 
k
);

540  
NULL
;

541 
	}
}

544 cÚ¡ *
	$g‘funúame
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, cÚ¡ **
Çme
) {

545 
In¡ruùiÚ
 
i
;

546 ià((
	`isLua
(
ci
è&& ci->
ÿÎs
 > 0) || !isLua(ci - 1))

547  
NULL
;

548 
ci
--;

549 
i
 = 
	`ci_func
(
ci
)->
l
.
p
->
code
[
	`cu¼’c
(
L
, ci)];

550 ià(
	`GET_OPCODE
(
i
è=ğ
OP_CALL
 || GET_OPCODE(iè=ğ
OP_TAILCALL
 ||

551 
	`GET_OPCODE
(
i
è=ğ
OP_TFORLOOP
)

552  
	`g‘objÇme
(
L
, 
ci
, 
	`GETARG_A
(
i
), 
Çme
);

554  
NULL
;

555 
	}
}

559 
	$isš¡ack
 (
C®lInfo
 *
ci
, cÚ¡ 
TV®ue
 *
o
) {

560 
StkId
 
p
;

561 
p
 = 
ci
->
ba£
;… < ci->
tİ
;…++)

562 ià(
o
 =ğ
p
)  1;

564 
	}
}

567 
	$luaG_ty³”rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
, cÚ¡ *
İ
) {

568 cÚ¡ *
Çme
 = 
NULL
;

569 cÚ¡ *
t
 = 
luaT_ty³Çmes
[
	`‰y³
(
o
)];

570 cÚ¡ *
kšd
 = (
	`isš¡ack
(
L
->
ci
, 
o
)) ?

571 
	`g‘objÇme
(
L
, L->
ci
, 
	`ÿ¡_št
(
o
 - L->
ba£
), &
Çme
) :

572 
NULL
;

573 ià(
kšd
)

574 
	`luaG_ruÃ¼Ü
(
L
, "©‹m±Ø% % " 
LUA_QS
 " (a %s value)",

575 
İ
, 
kšd
, 
Çme
, 
t
);

577 
	`luaG_ruÃ¼Ü
(
L
, "©‹m±Ø% ¨% v®ue", 
İ
, 
t
);

578 
	}
}

581 
	$luaG_cÚÿ‹¼Ü
 (
lua_S‹
 *
L
, 
StkId
 
p1
, StkId 
p2
) {

582 ià(
	`‰is¡ršg
(
p1
è|| 
	`‰i¢umb”
Õ1)èp1 = 
p2
;

583 
	`lua_as£¹
(!
	`‰is¡ršg
(
p1
è&& !
	`‰i¢umb”
(p1));

584 
	`luaG_ty³”rÜ
(
L
, 
p1
, "concatenate");

585 
	}
}

588 
	$luaG_¬™h”rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
) {

589 
TV®ue
 
‹mp
;

590 ià(
	`luaV_tÚumb”
(
p1
, &
‹mp
è=ğ
NULL
)

591 
p2
 = 
p1
;

592 
	`luaG_ty³”rÜ
(
L
, 
p2
, "perform‡rithmetic on");

593 
	}
}

596 
	$luaG_Üd””rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
) {

597 cÚ¡ *
t1
 = 
luaT_ty³Çmes
[
	`‰y³
(
p1
)];

598 cÚ¡ *
t2
 = 
luaT_ty³Çmes
[
	`‰y³
(
p2
)];

599 ià(
t1
[2] =ğ
t2
[2])

600 
	`luaG_ruÃ¼Ü
(
L
, "©‹m±Øcom·»wØ% v®ues", 
t1
);

602 
	`luaG_ruÃ¼Ü
(
L
, "©‹m±Øcom·» % w™h %s", 
t1
, 
t2
);

604 
	}
}

607 
	$addšfo
 (
lua_S‹
 *
L
, cÚ¡ *
msg
) {

608 
C®lInfo
 *
ci
 = 
L
->ci;

609 ià(
	`isLua
(
ci
)) {

610 
buff
[
LUA_IDSIZE
];

611 
lše
 = 
	`cu¼’še
(
L
, 
ci
);

612 
	`luaO_chunkid
(
buff
, 
	`g‘¡r
(
	`g‘lu­rÙo
(
ci
)->
sourû
), 
LUA_IDSIZE
);

613 
	`luaO_pushf¡ršg
(
L
, "%s:%d: %s", 
buff
, 
lše
, 
msg
);

615 
	}
}

618 
	$luaG_”rÜmsg
 (
lua_S‹
 *
L
) {

619 ià(
L
->
”rfunc
 != 0) {

620 
StkId
 
”rfunc
 = 
	`»¡Üe¡ack
(
L
, L->errfunc);

621 ià(!
	`‰isfunùiÚ
(
”rfunc
)è
	`luaD_throw
(
L
, 
LUA_ERRERR
);

622 
	`£tobjs2s
(
L
, L->
tİ
, L->top - 1);

623 
	`£tobjs2s
(
L
, L->
tİ
 - 1, 
”rfunc
);

624 
	`šü_tİ
(
L
);

625 
	`luaD_ÿÎ
(
L
, L->
tİ
 - 2, 1);

627 
	`luaD_throw
(
L
, 
LUA_ERRRUN
);

628 
	}
}

631 
	$luaG_ruÃ¼Ü
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

632 
va_li¡
 
¬gp
;

633 
	`va_¡¬t
(
¬gp
, 
fmt
);

634 
	`addšfo
(
L
, 
	`luaO_pushvf¡ršg
(L, 
fmt
, 
¬gp
));

635 
	`va_’d
(
¬gp
);

636 
	`luaG_”rÜmsg
(
L
);

637 
	}
}

	@deps/lua/src/ldebug.h

7 #iâdeà
ldebug_h


8 
	#ldebug_h


	)

11 
	~"l¡©e.h
"

14 
	#pcR–
(
pc
, 
p
è(
	`ÿ¡
(, (pcè- (p)->
code
è- 1)

	)

16 
	#g‘lše
(
f
,
pc
è(((f)->
lšešfo
è? (f)->lšešfo[pc] : 0)

	)

18 
	#»£thookcouÁ
(
L
è(L->
hookcouÁ
 = L->
ba£hookcouÁ
)

	)

21 
LUAI_FUNC
 
luaG_ty³”rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
,

22 cÚ¡ *
İÇme
);

23 
LUAI_FUNC
 
luaG_cÚÿ‹¼Ü
 (
lua_S‹
 *
L
, 
StkId
 
p1
, StkId 
p2
);

24 
LUAI_FUNC
 
luaG_¬™h”rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

25 cÚ¡ 
TV®ue
 *
p2
);

26 
LUAI_FUNC
 
luaG_Üd””rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

27 cÚ¡ 
TV®ue
 *
p2
);

28 
LUAI_FUNC
 
luaG_ruÃ¼Ü
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

29 
LUAI_FUNC
 
luaG_”rÜmsg
 (
lua_S‹
 *
L
);

30 
LUAI_FUNC
 
luaG_checkcode
 (cÚ¡ 
PrÙo
 *
±
);

31 
LUAI_FUNC
 
luaG_checkİ’İ
 (
In¡ruùiÚ
 
i
);

	@deps/lua/src/ldo.c

8 
	~<£tjmp.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

12 
	#ldo_c


	)

13 
	#LUA_CORE


	)

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lfunc.h
"

20 
	~"lgc.h
"

21 
	~"lmem.h
"

22 
	~"lobjeù.h
"

23 
	~"lİcodes.h
"

24 
	~"Í¬£r.h
"

25 
	~"l¡©e.h
"

26 
	~"l¡ršg.h
"

27 
	~"ÉabË.h
"

28 
	~"Ém.h
"

29 
	~"lundump.h
"

30 
	~"lvm.h
"

31 
	~"lzio.h
"

44 
	slua_lÚgjmp
 {

45 
lua_lÚgjmp
 *
	m´evious
;

46 
luai_jmpbuf
 
	mb
;

47 vŞ©
	m¡©us
;

51 
	$luaD_£‹¼Üobj
 (
lua_S‹
 *
L
, 
”rcode
, 
StkId
 
Şdtİ
) {

52 
”rcode
) {

53 
LUA_ERRMEM
: {

54 
	`£tsv®ue2s
(
L
, 
Şdtİ
, 
	`luaS_Ãwl™”®
(L, 
MEMERRMSG
));

57 
LUA_ERRERR
: {

58 
	`£tsv®ue2s
(
L
, 
Şdtİ
, 
	`luaS_Ãwl™”®
(L, "error inƒrror handling"));

61 
LUA_ERRSYNTAX
:

62 
LUA_ERRRUN
: {

63 
	`£tobjs2s
(
L
, 
Şdtİ
, L->
tİ
 - 1);

67 
L
->
tİ
 = 
Şdtİ
 + 1;

68 
	}
}

71 
	$»¡Üe_¡ack_lim™
 (
lua_S‹
 *
L
) {

72 
	`lua_as£¹
(
L
->
¡ack_Ï¡
 - L->
¡ack
 =ğL->
¡acksize
 - 
EXTRA_STACK
 - 1);

73 ià(
L
->
size_ci
 > 
LUAI_MAXCALLS
) {

74 
šu£
 = 
	`ÿ¡_št
(
L
->
ci
 - L->
ba£_ci
);

75 ià(
šu£
 + 1 < 
LUAI_MAXCALLS
)

76 
	`luaD_»®locCI
(
L
, 
LUAI_MAXCALLS
);

78 
	}
}

81 
	$»£t¡ack
 (
lua_S‹
 *
L
, 
¡©us
) {

82 
L
->
ci
 = L->
ba£_ci
;

83 
L
->
ba£
 = L->
ci
->base;

84 
	`luaF_şo£
(
L
, L->
ba£
);

85 
	`luaD_£‹¼Üobj
(
L
, 
¡©us
, L->
ba£
);

86 
L
->
nCÿÎs
 = L->
ba£CÿÎs
;

87 
L
->
®lowhook
 = 1;

88 
	`»¡Üe_¡ack_lim™
(
L
);

89 
L
->
”rfunc
 = 0;

90 
L
->
”rÜJmp
 = 
NULL
;

91 
	}
}

94 
	$luaD_throw
 (
lua_S‹
 *
L
, 
”rcode
) {

95 ià(
L
->
”rÜJmp
) {

96 
L
->
”rÜJmp
->
¡©us
 = 
”rcode
;

97 
	`LUAI_THROW
(
L
, L->
”rÜJmp
);

100 
L
->
¡©us
 = 
	`ÿ¡_by‹
(
”rcode
);

101 ià(
	`G
(
L
)->
·nic
) {

102 
	`»£t¡ack
(
L
, 
”rcode
);

103 
	`lua_uÆock
(
L
);

104 
	`G
(
L
)->
	`·nic
(L);

106 
	`ex™
(
EXIT_FAILURE
);

108 
	}
}

111 
	$luaD_¿wruÅrÙeùed
 (
lua_S‹
 *
L
, 
Pfunc
 
f
, *
ud
) {

112 
lua_lÚgjmp
 
lj
;

113 
lj
.
¡©us
 = 0;

114 
lj
.
´evious
 = 
L
->
”rÜJmp
;

115 
L
->
”rÜJmp
 = &
lj
;

116 
	`LUAI_TRY
(
L
, &
lj
,

117 (*
f
)(
L
, 
ud
);

119 
L
->
”rÜJmp
 = 
lj
.
´evious
;

120  
lj
.
¡©us
;

121 
	}
}

126 
	$cÜ»ù¡ack
 (
lua_S‹
 *
L
, 
TV®ue
 *
Şd¡ack
) {

127 
C®lInfo
 *
ci
;

128 
GCObjeù
 *
up
;

129 
L
->
tİ
 = (L->tİ - 
Şd¡ack
è+ L->
¡ack
;

130 
up
 = 
L
->
İ’upv®
; u°!ğ
NULL
; u°ğup->
gch
.
Ãxt
)

131 
	`gco2uv
(
up
)->
v
 = (gco2uv(up)->v - 
Şd¡ack
è+ 
L
->
¡ack
;

132 
ci
 = 
L
->
ba£_ci
; ci <= L->ci; ci++) {

133 
ci
->
tİ
 = (ci->tİ - 
Şd¡ack
è+ 
L
->
¡ack
;

134 
ci
->
ba£
 = (ci->ba£ - 
Şd¡ack
è+ 
L
->
¡ack
;

135 
ci
->
func
 = (ci->funø- 
Şd¡ack
è+ 
L
->
¡ack
;

137 
L
->
ba£
 = (L->ba£ - 
Şd¡ack
è+ L->
¡ack
;

138 
	}
}

141 
	$luaD_»®loc¡ack
 (
lua_S‹
 *
L
, 
Ãwsize
) {

142 
TV®ue
 *
Şd¡ack
 = 
L
->
¡ack
;

143 
»®size
 = 
Ãwsize
 + 1 + 
EXTRA_STACK
;

144 
	`lua_as£¹
(
L
->
¡ack_Ï¡
 - L->
¡ack
 =ğL->
¡acksize
 - 
EXTRA_STACK
 - 1);

145 
	`luaM_»®locveùÜ
(
L
, L->
¡ack
, L->
¡acksize
, 
»®size
, 
TV®ue
);

146 
L
->
¡acksize
 = 
»®size
;

147 
L
->
¡ack_Ï¡
 = L->
¡ack
+
Ãwsize
;

148 
	`cÜ»ù¡ack
(
L
, 
Şd¡ack
);

149 
	}
}

152 
	$luaD_»®locCI
 (
lua_S‹
 *
L
, 
Ãwsize
) {

153 
C®lInfo
 *
Şdci
 = 
L
->
ba£_ci
;

154 
	`luaM_»®locveùÜ
(
L
, L->
ba£_ci
, L->
size_ci
, 
Ãwsize
, 
C®lInfo
);

155 
L
->
size_ci
 = 
Ãwsize
;

156 
L
->
ci
 = (L->c˜- 
Şdci
è+ L->
ba£_ci
;

157 
L
->
’d_ci
 = L->
ba£_ci
 + L->
size_ci
 - 1;

158 
	}
}

161 
	$luaD_grow¡ack
 (
lua_S‹
 *
L
, 
n
) {

162 ià(
n
 <ğ
L
->
¡acksize
)

163 
	`luaD_»®loc¡ack
(
L
, 2*L->
¡acksize
);

165 
	`luaD_»®loc¡ack
(
L
, L->
¡acksize
 + 
n
);

166 
	}
}

169 
C®lInfo
 *
	$growCI
 (
lua_S‹
 *
L
) {

170 ià(
L
->
size_ci
 > 
LUAI_MAXCALLS
)

171 
	`luaD_throw
(
L
, 
LUA_ERRERR
);

173 
	`luaD_»®locCI
(
L
, 2*L->
size_ci
);

174 ià(
L
->
size_ci
 > 
LUAI_MAXCALLS
)

175 
	`luaG_ruÃ¼Ü
(
L
, "stack overflow");

177  ++
L
->
ci
;

178 
	}
}

181 
	$luaD_ÿÎhook
 (
lua_S‹
 *
L
, 
ev’t
, 
lše
) {

182 
lua_Hook
 
hook
 = 
L
->hook;

183 ià(
hook
 && 
L
->
®lowhook
) {

184 
±rdiff_t
 
tİ
 = 
	`§ve¡ack
(
L
, L->top);

185 
±rdiff_t
 
ci_tİ
 = 
	`§ve¡ack
(
L
, L->
ci
->
tİ
);

186 
lua_Debug
 
¬
;

187 
¬
.
ev’t
 =ƒvent;

188 
¬
.
cu¼’še
 = 
lše
;

189 ià(
ev’t
 =ğ
LUA_HOOKTAILRET
)

190 
¬
.
i_ci
 = 0;

192 
¬
.
i_ci
 = 
	`ÿ¡_št
(
L
->
ci
 - L->
ba£_ci
);

193 
	`luaD_check¡ack
(
L
, 
LUA_MINSTACK
);

194 
L
->
ci
->
tİ
 = L->tİ + 
LUA_MINSTACK
;

195 
	`lua_as£¹
(
L
->
ci
->
tİ
 <ğL->
¡ack_Ï¡
);

196 
L
->
®lowhook
 = 0;

197 
	`lua_uÆock
(
L
);

198 (*
hook
)(
L
, &
¬
);

199 
	`lua_lock
(
L
);

200 
	`lua_as£¹
(!
L
->
®lowhook
);

201 
L
->
®lowhook
 = 1;

202 
L
->
ci
->
tİ
 = 
	`»¡Üe¡ack
(L, 
ci_tİ
);

203 
L
->
tİ
 = 
	`»¡Üe¡ack
(L,op);

205 
	}
}

208 
StkId
 
	$adju¡_v¬¬gs
 (
lua_S‹
 *
L
, 
PrÙo
 *
p
, 
aùu®
) {

209 
i
;

210 
nfix¬gs
 = 
p
->
num·¿ms
;

211 
TabË
 *
hb
 = 
NULL
;

212 
StkId
 
ba£
, 
fixed
;

213 ; 
aùu®
 < 
nfix¬gs
; ++actual)

214 
	`£Šv®ue
(
L
->
tİ
++);

215 #ià
	`defšed
(
LUA_COMPAT_VARARG
)

216 ià(
p
->
is_v¬¬g
 & 
VARARG_NEEDSARG
) {

217 
nv¬
 = 
aùu®
 - 
nfix¬gs
;

218 
	`lua_as£¹
(
p
->
is_v¬¬g
 & 
VARARG_HASARG
);

219 
	`luaC_checkGC
(
L
);

220 
	`luaD_check¡ack
(
L
, 
p
->
max¡acksize
);

221 
hb
 = 
	`luaH_Ãw
(
L
, 
nv¬
, 1);

222 
i
=0; i<
nv¬
; i++)

223 
	`£tobj2n
(
L
, 
	`luaH_£Šum
(L, 
hb
, 
i
+1), L->
tİ
 - 
nv¬
 + i);

225 
	`£Šv®ue
(
	`luaH_£t¡r
(
L
, 
hb
, 
	`luaS_Ãwl™”®
(L, "n")), 
	`ÿ¡_num
(
nv¬
));

229 
fixed
 = 
L
->
tİ
 - 
aùu®
;

230 
ba£
 = 
L
->
tİ
;

231 
i
=0; i<
nfix¬gs
; i++) {

232 
	`£tobjs2s
(
L
, L->
tİ
++, 
fixed
+
i
);

233 
	`£Šv®ue
(
fixed
+
i
);

236 ià(
hb
) {

237 
	`£thv®ue
(
L
, L->
tİ
++, 
hb
);

238 
	`lua_as£¹
(
	`iswh™e
(
	`obj2gco
(
hb
)));

240  
ba£
;

241 
	}
}

244 
StkId
 
	$ŒyfuncTM
 (
lua_S‹
 *
L
, 
StkId
 
func
) {

245 cÚ¡ 
TV®ue
 *
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
func
, 
TM_CALL
);

246 
StkId
 
p
;

247 
±rdiff_t
 
funü
 = 
	`§ve¡ack
(
L
, 
func
);

248 ià(!
	`‰isfunùiÚ
(
tm
))

249 
	`luaG_ty³”rÜ
(
L
, 
func
, "call");

251 
p
 = 
L
->
tİ
;… > 
func
;…--è
	`£tobjs2s
(L,…,…-1);

252 
	`šü_tİ
(
L
);

253 
func
 = 
	`»¡Üe¡ack
(
L
, 
funü
);

254 
	`£tobj2s
(
L
, 
func
, 
tm
);

255  
func
;

256 
	}
}

260 
	#šc_ci
(
L
) \

261 ((
L
->
ci
 =ğL->
’d_ci
è? 
	`growCI
(L) : \

262 (
	`cÚdh¬d¡ack‹¡s
(
	`luaD_»®locCI
(
L
, L->
size_ci
)), ++L->
ci
))

	)

265 
	$luaD_´eÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
ÄesuÉs
) {

266 
LClosu»
 *
ş
;

267 
±rdiff_t
 
funü
;

268 ià(!
	`‰isfunùiÚ
(
func
))

269 
func
 = 
	`ŒyfuncTM
(
L
, func);

270 
funü
 = 
	`§ve¡ack
(
L
, 
func
);

271 
ş
 = &
	`şv®ue
(
func
)->
l
;

272 
L
->
ci
->
§vedpc
 = L->savedpc;

273 ià(!
ş
->
isC
) {

274 
C®lInfo
 *
ci
;

275 
StkId
 
¡
, 
ba£
;

276 
PrÙo
 *
p
 = 
ş
->p;

277 
	`luaD_check¡ack
(
L
, 
p
->
max¡acksize
);

278 
func
 = 
	`»¡Üe¡ack
(
L
, 
funü
);

279 ià(!
p
->
is_v¬¬g
) {

280 
ba£
 = 
func
 + 1;

281 ià(
L
->
tİ
 > 
ba£
 + 
p
->
num·¿ms
)

282 
L
->
tİ
 = 
ba£
 + 
p
->
num·¿ms
;

285 
Çrgs
 = 
	`ÿ¡_št
(
L
->
tİ
 - 
func
) - 1;

286 
ba£
 = 
	`adju¡_v¬¬gs
(
L
, 
p
, 
Çrgs
);

287 
func
 = 
	`»¡Üe¡ack
(
L
, 
funü
);

289 
ci
 = 
	`šc_ci
(
L
);

290 
ci
->
func
 = func;

291 
L
->
ba£
 = 
ci
->base = base;

292 
ci
->
tİ
 = 
L
->
ba£
 + 
p
->
max¡acksize
;

293 
	`lua_as£¹
(
ci
->
tİ
 <ğ
L
->
¡ack_Ï¡
);

294 
L
->
§vedpc
 = 
p
->
code
;

295 
ci
->
ÿÎs
 = 0;

296 
ci
->
ÄesuÉs
 =‚results;

297 
¡
 = 
L
->
tİ
; sˆ< 
ci
->top; st++)

298 
	`£Šv®ue
(
¡
);

299 
L
->
tİ
 = 
ci
->top;

300 ià(
L
->
hookmask
 & 
LUA_MASKCALL
) {

301 
L
->
§vedpc
++;

302 
	`luaD_ÿÎhook
(
L
, 
LUA_HOOKCALL
, -1);

303 
L
->
§vedpc
--;

305  
PCRLUA
;

308 
C®lInfo
 *
ci
;

309 
n
;

310 
	`luaD_check¡ack
(
L
, 
LUA_MINSTACK
);

311 
ci
 = 
	`šc_ci
(
L
);

312 
ci
->
func
 = 
	`»¡Üe¡ack
(
L
, 
funü
);

313 
L
->
ba£
 = 
ci
->ba£ = ci->
func
 + 1;

314 
ci
->
tİ
 = 
L
->tİ + 
LUA_MINSTACK
;

315 
	`lua_as£¹
(
ci
->
tİ
 <ğ
L
->
¡ack_Ï¡
);

316 
ci
->
ÄesuÉs
 =‚results;

317 ià(
L
->
hookmask
 & 
LUA_MASKCALL
)

318 
	`luaD_ÿÎhook
(
L
, 
LUA_HOOKCALL
, -1);

319 
	`lua_uÆock
(
L
);

320 
n
 = (*
	`cu¼_func
(
L
)->
c
.
f
)(L);

321 
	`lua_lock
(
L
);

322 ià(
n
 < 0)

323  
PCRYIELD
;

325 
	`luaD_posÿÎ
(
L
, L->
tİ
 - 
n
);

326  
PCRC
;

329 
	}
}

332 
StkId
 
	$ÿÎ»thooks
 (
lua_S‹
 *
L
, 
StkId
 
fœ¡ResuÉ
) {

333 
±rdiff_t
 
ä
 = 
	`§ve¡ack
(
L
, 
fœ¡ResuÉ
);

334 
	`luaD_ÿÎhook
(
L
, 
LUA_HOOKRET
, -1);

335 ià(
	`f_isLua
(
L
->
ci
)) {

336 (
L
->
hookmask
 & 
LUA_MASKRET
è&& L->
ci
->
ÿÎs
--)

337 
	`luaD_ÿÎhook
(
L
, 
LUA_HOOKTAILRET
, -1);

339  
	`»¡Üe¡ack
(
L
, 
ä
);

340 
	}
}

343 
	$luaD_posÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
fœ¡ResuÉ
) {

344 
StkId
 
»s
;

345 
wª‹d
, 
i
;

346 
C®lInfo
 *
ci
;

347 ià(
L
->
hookmask
 & 
LUA_MASKRET
)

348 
fœ¡ResuÉ
 = 
	`ÿÎ»thooks
(
L
, firstResult);

349 
ci
 = 
L
->ci--;

350 
»s
 = 
ci
->
func
;

351 
wª‹d
 = 
ci
->
ÄesuÉs
;

352 
L
->
ba£
 = (
ci
 - 1)->base;

353 
L
->
§vedpc
 = (
ci
 - 1)->savedpc;

355 
i
 = 
wª‹d
; i !ğ0 && 
fœ¡ResuÉ
 < 
L
->
tİ
; i--)

356 
	`£tobjs2s
(
L
, 
»s
++, 
fœ¡ResuÉ
++);

357 
i
-- > 0)

358 
	`£Šv®ue
(
»s
++);

359 
L
->
tİ
 = 
»s
;

360  (
wª‹d
 - 
LUA_MULTRET
);

361 
	}
}

370 
	$luaD_ÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
nResuÉs
) {

371 ià(++
L
->
nCÿÎs
 >ğ
LUAI_MAXCCALLS
) {

372 ià(
L
->
nCÿÎs
 =ğ
LUAI_MAXCCALLS
)

373 
	`luaG_ruÃ¼Ü
(
L
, "C stack overflow");

374 ià(
L
->
nCÿÎs
 >ğ(
LUAI_MAXCCALLS
 + (LUAI_MAXCCALLS>>3)))

375 
	`luaD_throw
(
L
, 
LUA_ERRERR
);

377 ià(
	`luaD_´eÿÎ
(
L
, 
func
, 
nResuÉs
è=ğ
PCRLUA
)

378 
	`luaV_execu‹
(
L
, 1);

379 
L
->
nCÿÎs
--;

380 
	`luaC_checkGC
(
L
);

381 
	}
}

384 
	$»sume
 (
lua_S‹
 *
L
, *
ud
) {

385 
StkId
 
fœ¡Arg
 = 
	`ÿ¡
(StkId, 
ud
);

386 
C®lInfo
 *
ci
 = 
L
->ci;

387 ià(
L
->
¡©us
 == 0) {

388 
	`lua_as£¹
(
ci
 =ğ
L
->
ba£_ci
 && 
fœ¡Arg
 > L->
ba£
);

389 ià(
	`luaD_´eÿÎ
(
L
, 
fœ¡Arg
 - 1, 
LUA_MULTRET
è!ğ
PCRLUA
)

393 
	`lua_as£¹
(
L
->
¡©us
 =ğ
LUA_YIELD
);

394 
L
->
¡©us
 = 0;

395 ià(!
	`f_isLua
(
ci
)) {

397 
	`lua_as£¹
(
	`GET_OPCODE
(*((
ci
-1)->
§vedpc
 - 1)è=ğ
OP_CALL
 ||

398 
	`GET_OPCODE
(*((
ci
-1)->
§vedpc
 - 1)è=ğ
OP_TAILCALL
);

399 ià(
	`luaD_posÿÎ
(
L
, 
fœ¡Arg
))

400 
L
->
tİ
 = L->
ci
->top;

403 
L
->
ba£
 = L->
ci
->base;

405 
	`luaV_execu‹
(
L
, 
	`ÿ¡_št
(L->
ci
 - L->
ba£_ci
));

406 
	}
}

409 
	$»sume_”rÜ
 (
lua_S‹
 *
L
, cÚ¡ *
msg
) {

410 
L
->
tİ
 = L->
ci
->
ba£
;

411 
	`£tsv®ue2s
(
L
, L->
tİ
, 
	`luaS_Ãw
(L, 
msg
));

412 
	`šü_tİ
(
L
);

413 
	`lua_uÆock
(
L
);

414  
LUA_ERRRUN
;

415 
	}
}

418 
LUA_API
 
	$lua_»sume
 (
lua_S‹
 *
L
, 
Çrgs
) {

419 
¡©us
;

420 
	`lua_lock
(
L
);

421 ià(
L
->
¡©us
 !ğ
LUA_YIELD
 && (L->¡©u !ğ0 || L->
ci
 !ğL->
ba£_ci
))

422  
	`»sume_”rÜ
(
L
, "cannot„esume‚on-suspended coroutine");

423 ià(
L
->
nCÿÎs
 >ğ
LUAI_MAXCCALLS
)

424  
	`»sume_”rÜ
(
L
, "C stack overflow");

425 
	`luai_u£r¡©”esume
(
L
, 
Çrgs
);

426 
	`lua_as£¹
(
L
->
”rfunc
 == 0);

427 
L
->
ba£CÿÎs
 = ++L->
nCÿÎs
;

428 
¡©us
 = 
	`luaD_¿wruÅrÙeùed
(
L
, 
»sume
, L->
tİ
 - 
Çrgs
);

429 ià(
¡©us
 != 0) {

430 
L
->
¡©us
 = 
	`ÿ¡_by‹
(status);

431 
	`luaD_£‹¼Üobj
(
L
, 
¡©us
, L->
tİ
);

432 
L
->
ci
->
tİ
 = L->top;

435 
	`lua_as£¹
(
L
->
nCÿÎs
 =ğL->
ba£CÿÎs
);

436 
¡©us
 = 
L
->status;

438 --
L
->
nCÿÎs
;

439 
	`lua_uÆock
(
L
);

440  
¡©us
;

441 
	}
}

444 
LUA_API
 
	$lua_y›ld
 (
lua_S‹
 *
L
, 
ÄesuÉs
) {

445 
	`luai_u£r¡©ey›ld
(
L
, 
ÄesuÉs
);

446 
	`lua_lock
(
L
);

447 ià(
L
->
nCÿÎs
 > L->
ba£CÿÎs
)

448 
	`luaG_ruÃ¼Ü
(
L
, "attempto yield‡cross metamethod/C-call boundary");

449 
L
->
ba£
 = L->
tİ
 - 
ÄesuÉs
;

450 
L
->
¡©us
 = 
LUA_YIELD
;

451 
	`lua_uÆock
(
L
);

453 
	}
}

456 
	$luaD_pÿÎ
 (
lua_S‹
 *
L
, 
Pfunc
 
func
, *
u
,

457 
±rdiff_t
 
Şd_tİ
,…Œdiff_ˆ
ef
) {

458 
¡©us
;

459 
ŞdnCÿÎs
 = 
L
->
nCÿÎs
;

460 
±rdiff_t
 
Şd_ci
 = 
	`§veci
(
L
, L->
ci
);

461 
lu_by‹
 
Şd_®lowhooks
 = 
L
->
®lowhook
;

462 
±rdiff_t
 
Şd_”rfunc
 = 
L
->
”rfunc
;

463 
L
->
”rfunc
 = 
ef
;

464 
¡©us
 = 
	`luaD_¿wruÅrÙeùed
(
L
, 
func
, 
u
);

465 ià(
¡©us
 != 0) {

466 
StkId
 
Şdtİ
 = 
	`»¡Üe¡ack
(
L
, 
Şd_tİ
);

467 
	`luaF_şo£
(
L
, 
Şdtİ
);

468 
	`luaD_£‹¼Üobj
(
L
, 
¡©us
, 
Şdtİ
);

469 
L
->
nCÿÎs
 = 
ŞdnCÿÎs
;

470 
L
->
ci
 = 
	`»¡Üeci
(L, 
Şd_ci
);

471 
L
->
ba£
 = L->
ci
->base;

472 
L
->
§vedpc
 = L->
ci
->savedpc;

473 
L
->
®lowhook
 = 
Şd_®lowhooks
;

474 
	`»¡Üe_¡ack_lim™
(
L
);

476 
L
->
”rfunc
 = 
Şd_”rfunc
;

477  
¡©us
;

478 
	}
}

485 
	sSP¬£r
 {

486 
ZIO
 *
	mz
;

487 
Mbufãr
 
	mbuff
;

488 cÚ¡ *
	mÇme
;

491 
	$f_·r£r
 (
lua_S‹
 *
L
, *
ud
) {

492 
i
;

493 
PrÙo
 *
tf
;

494 
Closu»
 *
ş
;

495 
SP¬£r
 *
p
 = 
	`ÿ¡
(SP¬£¸*, 
ud
);

496 
c
 = 
	`luaZ_lookah—d
(
p
->
z
);

497 
	`luaC_checkGC
(
L
);

498 
tf
 = (
luaY_·r£r
)(
L
, 
p
->
z
,

499 &
p
->
buff
,…->
Çme
);

500 
ş
 = 
	`luaF_ÃwLşosu»
(
L
, 
tf
->
nups
, 
	`hv®ue
(
	`gt
(L)));

501 
ş
->
l
.
p
 = 
tf
;

502 
i
 = 0; i < 
tf
->
nups
; i++)

503 
ş
->
l
.
upv®s
[
i
] = 
	`luaF_Ãwupv®
(
L
);

504 
	`£tşv®ue
(
L
, L->
tİ
, 
ş
);

505 
	`šü_tİ
(
L
);

506 
	}
}

509 
	$luaD_´Ùeùed·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, cÚ¡ *
Çme
) {

510 
SP¬£r
 
p
;

511 
¡©us
;

512 
p
.
z
 = z;….
Çme
 =‚ame;

513 
	`luaZ_š™bufãr
(
L
, &
p
.
buff
);

514 
¡©us
 = 
	`luaD_pÿÎ
(
L
, 
f_·r£r
, &
p
, 
	`§ve¡ack
(L, L->
tİ
), L->
”rfunc
);

515 
	`luaZ_ä“bufãr
(
L
, &
p
.
buff
);

516  
¡©us
;

517 
	}
}

	@deps/lua/src/ldo.h

7 #iâdeà
ldo_h


8 
	#ldo_h


	)

11 
	~"lobjeù.h
"

12 
	~"l¡©e.h
"

13 
	~"lzio.h
"

16 
	#luaD_check¡ack
(
L
,
n
) \

17 ià((*)
L
->
¡ack_Ï¡
 - (*)L->
tİ
 <ğ(
n
)*()(
TV®ue
)) \

18 
	`luaD_grow¡ack
(
L
, 
n
); \

19 
	`cÚdh¬d¡ack‹¡s
(
	`luaD_»®loc¡ack
(
L
, L->
¡acksize
 - 
EXTRA_STACK
 - 1));

	)

22 
	#šü_tİ
(
L
è{
	`luaD_check¡ack
(L,1); L->
tİ
++;}

	)

24 
	#§ve¡ack
(
L
,
p
è((*)Õè- (*)L->
¡ack
)

	)

25 
	#»¡Üe¡ack
(
L
,
n
è((
TV®ue
 *)((*)L->
¡ack
 + (n)))

	)

27 
	#§veci
(
L
,
p
è((*)Õè- (*)L->
ba£_ci
)

	)

28 
	#»¡Üeci
(
L
,
n
è((
C®lInfo
 *)((*)L->
ba£_ci
 + (n)))

	)

32 
	#PCRLUA
 0

	)

33 
	#PCRC
 1

	)

34 
	#PCRYIELD
 2

	)

38 (*
	tPfunc
è(
	tlua_S‹
 *
	tL
, *
	tud
);

40 
LUAI_FUNC
 
	`luaD_´Ùeùed·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, cÚ¡ *
Çme
);

41 
LUAI_FUNC
 
	`luaD_ÿÎhook
 (
lua_S‹
 *
L
, 
ev’t
, 
lše
);

42 
LUAI_FUNC
 
	`luaD_´eÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
ÄesuÉs
);

43 
LUAI_FUNC
 
	`luaD_ÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
nResuÉs
);

44 
LUAI_FUNC
 
	`luaD_pÿÎ
 (
lua_S‹
 *
L
, 
Pfunc
 
func
, *
u
,

45 
±rdiff_t
 
Şdtİ
,…Œdiff_ˆ
ef
);

46 
LUAI_FUNC
 
	`luaD_posÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
fœ¡ResuÉ
);

47 
LUAI_FUNC
 
	`luaD_»®locCI
 (
lua_S‹
 *
L
, 
Ãwsize
);

48 
LUAI_FUNC
 
	`luaD_»®loc¡ack
 (
lua_S‹
 *
L
, 
Ãwsize
);

49 
LUAI_FUNC
 
	`luaD_grow¡ack
 (
lua_S‹
 *
L
, 
n
);

51 
LUAI_FUNC
 
	`luaD_throw
 (
lua_S‹
 *
L
, 
”rcode
);

52 
LUAI_FUNC
 
	`luaD_¿wruÅrÙeùed
 (
lua_S‹
 *
L
, 
Pfunc
 
f
, *
ud
);

54 
LUAI_FUNC
 
	`luaD_£‹¼Üobj
 (
lua_S‹
 *
L
, 
”rcode
, 
StkId
 
Şdtİ
);

	@deps/lua/src/ldump.c

7 
	~<¡ddef.h
>

9 
	#ldump_c


	)

10 
	#LUA_CORE


	)

12 
	~"lua.h
"

14 
	~"lobjeù.h
"

15 
	~"l¡©e.h
"

16 
	~"lundump.h
"

19 
lua_S‹
* 
	mL
;

20 
lua_Wr™”
 
	mwr™”
;

21 * 
	md©a
;

22 
	m¡r
;

23 
	m¡©us
;

24 } 
	tDumpS‹
;

26 
	#DumpMem
(
b
,
n
,
size
,
D
è
	`DumpBlock
(b,Ò)*(size),D)

	)

27 
	#DumpV¬
(
x
,
D
è
	`DumpMem
(&x,1,(x),D)

	)

29 
	$DumpBlock
(cÚ¡ * 
b
, 
size_t
 
size
, 
DumpS‹
* 
D
)

31 ià(
D
->
¡©us
==0)

33 
	`lua_uÆock
(
D
->
L
);

34 
D
->
¡©us
=(*D->
wr™”
)(D->
L
,
b
,
size
,D->
d©a
);

35 
	`lua_lock
(
D
->
L
);

37 
	}
}

39 
	$DumpCh¬
(
y
, 
DumpS‹
* 
D
)

41 
x
=()
y
;

42 
	`DumpV¬
(
x
,
D
);

43 
	}
}

45 
	$DumpIÁ
(
x
, 
DumpS‹
* 
D
)

47 
	`DumpV¬
(
x
,
D
);

48 
	}
}

50 
	$DumpNumb”
(
lua_Numb”
 
x
, 
DumpS‹
* 
D
)

52 
	`DumpV¬
(
x
,
D
);

53 
	}
}

55 
	$DumpVeùÜ
(cÚ¡ * 
b
, 
n
, 
size_t
 
size
, 
DumpS‹
* 
D
)

57 
	`DumpIÁ
(
n
,
D
);

58 
	`DumpMem
(
b
,
n
,
size
,
D
);

59 
	}
}

61 
	$DumpSŒšg
(cÚ¡ 
TSŒšg
* 
s
, 
DumpS‹
* 
D
)

63 ià(
s
==
NULL
 || 
	`g‘¡r
(s)==NULL)

65 
size_t
 
size
=0;

66 
	`DumpV¬
(
size
,
D
);

70 
size_t
 
size
=
s
->
tsv
.
Ën
+1;

71 
	`DumpV¬
(
size
,
D
);

72 
	`DumpBlock
(
	`g‘¡r
(
s
),
size
,
D
);

74 
	}
}

76 
	#DumpCode
(
f
,
D
è
	`DumpVeùÜ
(f->
code
,f->
sizecode
,(
In¡ruùiÚ
),D)

	)

78 
DumpFunùiÚ
(cÚ¡ 
PrÙo
* 
f
, cÚ¡ 
TSŒšg
* 
p
, 
DumpS‹
* 
D
);

80 
	$DumpCÚ¡ªts
(cÚ¡ 
PrÙo
* 
f
, 
DumpS‹
* 
D
)

82 
i
,
n
=
f
->
sizek
;

83 
	`DumpIÁ
(
n
,
D
);

84 
i
=0; i<
n
; i++)

86 cÚ¡ 
TV®ue
* 
o
=&
f
->
k
[
i
];

87 
	`DumpCh¬
(
	`‰y³
(
o
),
D
);

88 
	`‰y³
(
o
))

90 
LUA_TNIL
:

92 
LUA_TBOOLEAN
:

93 
	`DumpCh¬
(
	`bv®ue
(
o
),
D
);

95 
LUA_TNUMBER
:

96 
	`DumpNumb”
(
	`nv®ue
(
o
),
D
);

98 
LUA_TSTRING
:

99 
	`DumpSŒšg
(
	`¿wtsv®ue
(
o
),
D
);

102 
	`lua_as£¹
(0);

106 
n
=
f
->
siz•
;

107 
	`DumpIÁ
(
n
,
D
);

108 
i
=0; i<
n
; i++è
	`DumpFunùiÚ
(
f
->
p
[i],f->
sourû
,
D
);

109 
	}
}

111 
	$DumpDebug
(cÚ¡ 
PrÙo
* 
f
, 
DumpS‹
* 
D
)

113 
i
,
n
;

114 
n
ğ(
D
->
¡r
è? 0 : 
f
->
siz–šešfo
;

115 
	`DumpVeùÜ
(
f
->
lšešfo
,
n
,(),
D
);

116 
n
ğ(
D
->
¡r
è? 0 : 
f
->
siz–ocv¬s
;

117 
	`DumpIÁ
(
n
,
D
);

118 
i
=0; i<
n
; i++)

120 
	`DumpSŒšg
(
f
->
locv¬s
[
i
].
v¬Çme
,
D
);

121 
	`DumpIÁ
(
f
->
locv¬s
[
i
].
¡¬c
,
D
);

122 
	`DumpIÁ
(
f
->
locv¬s
[
i
].
’dpc
,
D
);

124 
n
ğ(
D
->
¡r
è? 0 : 
f
->
sizeupv®ues
;

125 
	`DumpIÁ
(
n
,
D
);

126 
i
=0; i<
n
; i++è
	`DumpSŒšg
(
f
->
upv®ues
[i],
D
);

127 
	}
}

129 
	$DumpFunùiÚ
(cÚ¡ 
PrÙo
* 
f
, cÚ¡ 
TSŒšg
* 
p
, 
DumpS‹
* 
D
)

131 
	`DumpSŒšg
((
f
->
sourû
==
p
 || 
D
->
¡r
è? 
NULL
 : f->source,D);

132 
	`DumpIÁ
(
f
->
lšedefšed
,
D
);

133 
	`DumpIÁ
(
f
->
Ï¡lšedefšed
,
D
);

134 
	`DumpCh¬
(
f
->
nups
,
D
);

135 
	`DumpCh¬
(
f
->
num·¿ms
,
D
);

136 
	`DumpCh¬
(
f
->
is_v¬¬g
,
D
);

137 
	`DumpCh¬
(
f
->
max¡acksize
,
D
);

138 
	`DumpCode
(
f
,
D
);

139 
	`DumpCÚ¡ªts
(
f
,
D
);

140 
	`DumpDebug
(
f
,
D
);

141 
	}
}

143 
	$DumpH—d”
(
DumpS‹
* 
D
)

145 
h
[
LUAC_HEADERSIZE
];

146 
	`luaU_h—d”
(
h
);

147 
	`DumpBlock
(
h
,
LUAC_HEADERSIZE
,
D
);

148 
	}
}

153 
	$luaU_dump
 (
lua_S‹
* 
L
, cÚ¡ 
PrÙo
* 
f
, 
lua_Wr™”
 
w
, * 
d©a
, 
¡r
)

155 
DumpS‹
 
D
;

156 
D
.
L
=L;

157 
D
.
wr™”
=
w
;

158 
D
.
d©a
=data;

159 
D
.
¡r
=strip;

160 
D
.
¡©us
=0;

161 
	`DumpH—d”
(&
D
);

162 
	`DumpFunùiÚ
(
f
,
NULL
,&
D
);

163  
D
.
¡©us
;

164 
	}
}

	@deps/lua/src/lfunc.c

8 
	~<¡ddef.h
>

10 
	#lfunc_c


	)

11 
	#LUA_CORE


	)

13 
	~"lua.h
"

15 
	~"lfunc.h
"

16 
	~"lgc.h
"

17 
	~"lmem.h
"

18 
	~"lobjeù.h
"

19 
	~"l¡©e.h
"

23 
Closu»
 *
	$luaF_ÃwCşosu»
 (
lua_S‹
 *
L
, 
ÃËms
, 
TabË
 *
e
) {

24 
Closu»
 *
c
 = 
	`ÿ¡
(Closu» *, 
	`luaM_m®loc
(
L
, 
	`sizeCşosu»
(
ÃËms
)));

25 
	`luaC_lšk
(
L
, 
	`obj2gco
(
c
), 
LUA_TFUNCTION
);

26 
c
->c.
isC
 = 1;

27 
c
->c.
’v
 = 
e
;

28 
c
->c.
nupv®ues
 = 
	`ÿ¡_by‹
(
ÃËms
);

29  
c
;

30 
	}
}

33 
Closu»
 *
	$luaF_ÃwLşosu»
 (
lua_S‹
 *
L
, 
ÃËms
, 
TabË
 *
e
) {

34 
Closu»
 *
c
 = 
	`ÿ¡
(Closu» *, 
	`luaM_m®loc
(
L
, 
	`sizeLşosu»
(
ÃËms
)));

35 
	`luaC_lšk
(
L
, 
	`obj2gco
(
c
), 
LUA_TFUNCTION
);

36 
c
->
l
.
isC
 = 0;

37 
c
->
l
.
’v
 = 
e
;

38 
c
->
l
.
nupv®ues
 = 
	`ÿ¡_by‹
(
ÃËms
);

39 
ÃËms
--è
c
->
l
.
upv®s
[ÃËms] = 
NULL
;

40  
c
;

41 
	}
}

44 
UpV®
 *
	$luaF_Ãwupv®
 (
lua_S‹
 *
L
) {

45 
UpV®
 *
uv
 = 
	`luaM_Ãw
(
L
, UpVal);

46 
	`luaC_lšk
(
L
, 
	`obj2gco
(
uv
), 
LUA_TUPVAL
);

47 
uv
->
v
 = &uv->
u
.
v®ue
;

48 
	`£Šv®ue
(
uv
->
v
);

49  
uv
;

50 
	}
}

53 
UpV®
 *
	$luaF_fšdupv®
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
) {

54 
glob®_S‹
 *
g
 = 
	`G
(
L
);

55 
GCObjeù
 **
µ
 = &
L
->
İ’upv®
;

56 
UpV®
 *
p
;

57 
UpV®
 *
uv
;

58 *
µ
 !ğ
NULL
 && (
p
 = 
	`ngcÙouv
(*µ))->
v
 >ğ
Ëv–
) {

59 
	`lua_as£¹
(
p
->
v
 !ğ&p->
u
.
v®ue
);

60 ià(
p
->
v
 =ğ
Ëv–
) {

61 ià(
	`isd—d
(
g
, 
	`obj2gco
(
p
)))

62 
	`chªgewh™e
(
	`obj2gco
(
p
));

63  
p
;

65 
µ
 = &
p
->
Ãxt
;

67 
uv
 = 
	`luaM_Ãw
(
L
, 
UpV®
);

68 
uv
->
‰
 = 
LUA_TUPVAL
;

69 
uv
->
m¬ked
 = 
	`luaC_wh™e
(
g
);

70 
uv
->
v
 = 
Ëv–
;

71 
uv
->
Ãxt
 = *
µ
;

72 *
µ
 = 
	`obj2gco
(
uv
);

73 
uv
->
u
.
l
.
´ev
 = &
g
->
uvh—d
;

74 
uv
->
u
.
l
.
Ãxt
 = 
g
->
uvh—d
.u.l.next;

75 
uv
->
u
.
l
.
Ãxt
->u.l.
´ev
 = uv;

76 
g
->
uvh—d
.
u
.
l
.
Ãxt
 = 
uv
;

77 
	`lua_as£¹
(
uv
->
u
.
l
.
Ãxt
->u.l.
´ev
 == uv && uv->u.l.prev->u.l.next == uv);

78  
uv
;

79 
	}
}

82 
	$uÆškupv®
 (
UpV®
 *
uv
) {

83 
	`lua_as£¹
(
uv
->
u
.
l
.
Ãxt
->u.l.
´ev
 == uv && uv->u.l.prev->u.l.next == uv);

84 
uv
->
u
.
l
.
Ãxt
->u.l.
´ev
 = uv->u.l.prev;

85 
uv
->
u
.
l
.
´ev
->u.l.
Ãxt
 = uv->u.l.next;

86 
	}
}

89 
	$luaF_ä“upv®
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
) {

90 ià(
uv
->
v
 !ğ&uv->
u
.
v®ue
)

91 
	`uÆškupv®
(
uv
);

92 
	`luaM_ä“
(
L
, 
uv
);

93 
	}
}

96 
	$luaF_şo£
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
) {

97 
UpV®
 *
uv
;

98 
glob®_S‹
 *
g
 = 
	`G
(
L
);

99 
L
->
İ’upv®
 !ğ
NULL
 && (
uv
 = 
	`ngcÙouv
(L->İ’upv®))->
v
 >ğ
Ëv–
) {

100 
GCObjeù
 *
o
 = 
	`obj2gco
(
uv
);

101 
	`lua_as£¹
(!
	`isbÏck
(
o
è&& 
uv
->
v
 !ğ&uv->
u
.
v®ue
);

102 
L
->
İ’upv®
 = 
uv
->
Ãxt
;

103 ià(
	`isd—d
(
g
, 
o
))

104 
	`luaF_ä“upv®
(
L
, 
uv
);

106 
	`uÆškupv®
(
uv
);

107 
	`£tobj
(
L
, &
uv
->
u
.
v®ue
, uv->
v
);

108 
uv
->
v
 = &uv->
u
.
v®ue
;

109 
	`luaC_lškupv®
(
L
, 
uv
);

112 
	}
}

115 
PrÙo
 *
	$luaF_Ãw´Ùo
 (
lua_S‹
 *
L
) {

116 
PrÙo
 *
f
 = 
	`luaM_Ãw
(
L
, Proto);

117 
	`luaC_lšk
(
L
, 
	`obj2gco
(
f
), 
LUA_TPROTO
);

118 
f
->
k
 = 
NULL
;

119 
f
->
sizek
 = 0;

120 
f
->
p
 = 
NULL
;

121 
f
->
siz•
 = 0;

122 
f
->
code
 = 
NULL
;

123 
f
->
sizecode
 = 0;

124 
f
->
siz–šešfo
 = 0;

125 
f
->
sizeupv®ues
 = 0;

126 
f
->
nups
 = 0;

127 
f
->
upv®ues
 = 
NULL
;

128 
f
->
num·¿ms
 = 0;

129 
f
->
is_v¬¬g
 = 0;

130 
f
->
max¡acksize
 = 0;

131 
f
->
lšešfo
 = 
NULL
;

132 
f
->
siz–ocv¬s
 = 0;

133 
f
->
locv¬s
 = 
NULL
;

134 
f
->
lšedefšed
 = 0;

135 
f
->
Ï¡lšedefšed
 = 0;

136 
f
->
sourû
 = 
NULL
;

137  
f
;

138 
	}
}

141 
	$luaF_ä“´Ùo
 (
lua_S‹
 *
L
, 
PrÙo
 *
f
) {

142 
	`luaM_ä“¬¿y
(
L
, 
f
->
code
, f->
sizecode
, 
In¡ruùiÚ
);

143 
	`luaM_ä“¬¿y
(
L
, 
f
->
p
, f->
siz•
, 
PrÙo
 *);

144 
	`luaM_ä“¬¿y
(
L
, 
f
->
k
, f->
sizek
, 
TV®ue
);

145 
	`luaM_ä“¬¿y
(
L
, 
f
->
lšešfo
, f->
siz–šešfo
, );

146 
	`luaM_ä“¬¿y
(
L
, 
f
->
locv¬s
, f->
siz–ocv¬s
, 
LocV¬
);

147 
	`luaM_ä“¬¿y
(
L
, 
f
->
upv®ues
, f->
sizeupv®ues
, 
TSŒšg
 *);

148 
	`luaM_ä“
(
L
, 
f
);

149 
	}
}

152 
	$luaF_ä“şosu»
 (
lua_S‹
 *
L
, 
Closu»
 *
c
) {

153 
size
 = (
c
->c.
isC
è? 
	`sizeCşosu»
(c->c.
nupv®ues
) :

154 
	`sizeLşosu»
(
c
->
l
.
nupv®ues
);

155 
	`luaM_ä“mem
(
L
, 
c
, 
size
);

156 
	}
}

163 cÚ¡ *
	$luaF_g‘loÿÊame
 (cÚ¡ 
PrÙo
 *
f
, 
loÿl_numb”
, 
pc
) {

164 
i
;

165 
i
 = 0; i<
f
->
siz–ocv¬s
 && f->
locv¬s
[i].
¡¬c
 <ğ
pc
; i++) {

166 ià(
pc
 < 
f
->
locv¬s
[
i
].
’dpc
) {

167 
loÿl_numb”
--;

168 ià(
loÿl_numb”
 == 0)

169  
	`g‘¡r
(
f
->
locv¬s
[
i
].
v¬Çme
);

172  
NULL
;

173 
	}
}

	@deps/lua/src/lfunc.h

7 #iâdeà
lfunc_h


8 
	#lfunc_h


	)

11 
	~"lobjeù.h
"

14 
	#sizeCşosu»
(
n
è(
	`ÿ¡
(, (
CClosu»
)) + \

15 
	`ÿ¡
(, (
TV®ue
)*((
n
)-1)))

	)

17 
	#sizeLşosu»
(
n
è(
	`ÿ¡
(, (
LClosu»
)) + \

18 
	`ÿ¡
(, (
TV®ue
 *)*((
n
)-1)))

	)

21 
LUAI_FUNC
 
PrÙo
 *
luaF_Ãw´Ùo
 (
lua_S‹
 *
L
);

22 
LUAI_FUNC
 
Closu»
 *
luaF_ÃwCşosu»
 (
lua_S‹
 *
L
, 
ÃËms
, 
TabË
 *
e
);

23 
LUAI_FUNC
 
Closu»
 *
luaF_ÃwLşosu»
 (
lua_S‹
 *
L
, 
ÃËms
, 
TabË
 *
e
);

24 
LUAI_FUNC
 
UpV®
 *
luaF_Ãwupv®
 (
lua_S‹
 *
L
);

25 
LUAI_FUNC
 
UpV®
 *
luaF_fšdupv®
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
);

26 
LUAI_FUNC
 
luaF_şo£
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
);

27 
LUAI_FUNC
 
luaF_ä“´Ùo
 (
lua_S‹
 *
L
, 
PrÙo
 *
f
);

28 
LUAI_FUNC
 
luaF_ä“şosu»
 (
lua_S‹
 *
L
, 
Closu»
 *
c
);

29 
LUAI_FUNC
 
luaF_ä“upv®
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
);

30 
LUAI_FUNC
 cÚ¡ *
luaF_g‘loÿÊame
 (cÚ¡ 
PrÙo
 *
func
, 
loÿl_numb”
,

31 
pc
);

	@deps/lua/src/lgc.c

7 
	~<¡ršg.h
>

9 
	#lgc_c


	)

10 
	#LUA_CORE


	)

12 
	~"lua.h
"

14 
	~"ldebug.h
"

15 
	~"ldo.h
"

16 
	~"lfunc.h
"

17 
	~"lgc.h
"

18 
	~"lmem.h
"

19 
	~"lobjeù.h
"

20 
	~"l¡©e.h
"

21 
	~"l¡ršg.h
"

22 
	~"ÉabË.h
"

23 
	~"Ém.h
"

26 
	#GCSTEPSIZE
 1024u

	)

27 
	#GCSWEEPMAX
 40

	)

28 
	#GCSWEEPCOST
 10

	)

29 
	#GCFINALIZECOST
 100

	)

32 
	#maskm¬ks
 
	`ÿ¡_by‹
(~(
	`b™mask
(
BLACKBIT
)|
WHITEBITS
))

	)

34 
	#makewh™e
(
g
,
x
) \

35 ((
x
)->
gch
.
m¬ked
 = 
	`ÿ¡_by‹
(((x)->gch.m¬ked & 
maskm¬ks
è| 
	`luaC_wh™e
(
g
)))

	)

37 
	#wh™e2g¿y
(
x
è
	`»£t2b™s
((x)->
gch
.
m¬ked
, 
WHITE0BIT
, 
WHITE1BIT
)

	)

38 
	#bÏck2g¿y
(
x
è
	`»£tb™
((x)->
gch
.
m¬ked
, 
BLACKBIT
)

	)

40 
	#¡ršgm¬k
(
s
è
	`»£t2b™s
((s)->
tsv
.
m¬ked
, 
WHITE0BIT
, 
WHITE1BIT
)

	)

43 
	#isfš®ized
(
u
è
	`‹¡b™
((u)->
m¬ked
, 
FINALIZEDBIT
)

	)

44 
	#m¬kfš®ized
(
u
è
	`l_£tb™
((u)->
m¬ked
, 
FINALIZEDBIT
)

	)

47 
	#KEYWEAK
 
	`b™mask
(
KEYWEAKBIT
)

	)

48 
	#VALUEWEAK
 
	`b™mask
(
VALUEWEAKBIT
)

	)

52 
	#m¬kv®ue
(
g
,
o
è{ 
	`checkcÚsi¡’cy
(o); \

53 ià(
	`iscŞËùabË
(
o
è&& 
	`iswh™e
(
	`gcv®ue
(o))è
	`»®lym¬kobjeù
(
g
,gcv®ue(o)); }

	)

55 
	#m¬kobjeù
(
g
,
t
è{ ià(
	`iswh™e
(
	`obj2gco
(t))) \

56 
	`»®lym¬kobjeù
(
g
, 
	`obj2gco
(
t
)); }

	)

59 
	#£‰h»shŞd
(
g
è(g->
GCth»shŞd
 = (g->
e¡im©e
/100è* g->
gıau£
)

	)

62 
	$»mov“Áry
 (
Node
 *
n
) {

63 
	`lua_as£¹
(
	`‰i¢
(
	`gv®
(
n
)));

64 ià(
	`iscŞËùabË
(
	`gkey
(
n
)))

65 
	`£‰ty³
(
	`gkey
(
n
), 
LUA_TDEADKEY
);

66 
	}
}

69 
	$»®lym¬kobjeù
 (
glob®_S‹
 *
g
, 
GCObjeù
 *
o
) {

70 
	`lua_as£¹
(
	`iswh™e
(
o
è&& !
	`isd—d
(
g
, o));

71 
	`wh™e2g¿y
(
o
);

72 
o
->
gch
.
‰
) {

73 
LUA_TSTRING
: {

76 
LUA_TUSERDATA
: {

77 
TabË
 *
mt
 = 
	`gco2u
(
o
)->
m‘©abË
;

78 
	`g¿y2bÏck
(
o
);

79 ià(
mt
è
	`m¬kobjeù
(
g
, mt);

80 
	`m¬kobjeù
(
g
, 
	`gco2u
(
o
)->
’v
);

83 
LUA_TUPVAL
: {

84 
UpV®
 *
uv
 = 
	`gco2uv
(
o
);

85 
	`m¬kv®ue
(
g
, 
uv
->
v
);

86 ià(
uv
->
v
 =ğ&uv->
u
.
v®ue
)

87 
	`g¿y2bÏck
(
o
);

90 
LUA_TFUNCTION
: {

91 
	`gco2ş
(
o
)->
c
.
gşi¡
 = 
g
->
g¿y
;

92 
g
->
g¿y
 = 
o
;

95 
LUA_TTABLE
: {

96 
	`gco2h
(
o
)->
gşi¡
 = 
g
->
g¿y
;

97 
g
->
g¿y
 = 
o
;

100 
LUA_TTHREAD
: {

101 
	`gco2th
(
o
)->
gşi¡
 = 
g
->
g¿y
;

102 
g
->
g¿y
 = 
o
;

105 
LUA_TPROTO
: {

106 
	`gco2p
(
o
)->
gşi¡
 = 
g
->
g¿y
;

107 
g
->
g¿y
 = 
o
;

110 : 
	`lua_as£¹
(0);

112 
	}
}

115 
	$m¬ktmu
 (
glob®_S‹
 *
g
) {

116 
GCObjeù
 *
u
 = 
g
->
tmud©a
;

117 ià(
u
) {

119 
u
 = u->
gch
.
Ãxt
;

120 
	`makewh™e
(
g
, 
u
);

121 
	`»®lym¬kobjeù
(
g
, 
u
);

122 } 
u
 !ğ
g
->
tmud©a
);

124 
	}
}

128 
size_t
 
	$luaC_£·¿‹ud©a
 (
lua_S‹
 *
L
, 
®l
) {

129 
glob®_S‹
 *
g
 = 
	`G
(
L
);

130 
size_t
 
d—dmem
 = 0;

131 
GCObjeù
 **
p
 = &
g
->
mašth»ad
->
Ãxt
;

132 
GCObjeù
 *
cu¼
;

133 (
cu¼
 = *
p
è!ğ
NULL
) {

134 ià(!(
	`iswh™e
(
cu¼
è|| 
®l
è|| 
	`isfš®ized
(
	`gco2u
(curr)))

135 
p
 = &
cu¼
->
gch
.
Ãxt
;

136 ià(
	`ç¡tm
(
L
, 
	`gco2u
(
cu¼
)->
m‘©abË
, 
TM_GC
è=ğ
NULL
) {

137 
	`m¬kfš®ized
(
	`gco2u
(
cu¼
));

138 
p
 = &
cu¼
->
gch
.
Ãxt
;

141 
d—dmem
 +ğ
	`sizeud©a
(
	`gco2u
(
cu¼
));

142 
	`m¬kfš®ized
(
	`gco2u
(
cu¼
));

143 *
p
 = 
cu¼
->
gch
.
Ãxt
;

145 ià(
g
->
tmud©a
 =ğ
NULL
)

146 
g
->
tmud©a
 = 
cu¼
->
gch
.
Ãxt
 = curr;

148 
cu¼
->
gch
.
Ãxt
 = 
g
->
tmud©a
->gch.next;

149 
g
->
tmud©a
->
gch
.
Ãxt
 = 
cu¼
;

150 
g
->
tmud©a
 = 
cu¼
;

154  
d—dmem
;

155 
	}
}

158 
	$Œav”£bË
 (
glob®_S‹
 *
g
, 
TabË
 *
h
) {

159 
i
;

160 
w—kkey
 = 0;

161 
w—kv®ue
 = 0;

162 cÚ¡ 
TV®ue
 *
mode
;

163 ià(
h
->
m‘©abË
)

164 
	`m¬kobjeù
(
g
, 
h
->
m‘©abË
);

165 
mode
 = 
	`gç¡tm
(
g
, 
h
->
m‘©abË
, 
TM_MODE
);

166 ià(
mode
 && 
	`‰is¡ršg
(mode)) {

167 
w—kkey
 = (
	`¡rchr
(
	`sv®ue
(
mode
), 'k'è!ğ
NULL
);

168 
w—kv®ue
 = (
	`¡rchr
(
	`sv®ue
(
mode
), 'v'è!ğ
NULL
);

169 ià(
w—kkey
 || 
w—kv®ue
) {

170 
h
->
m¬ked
 &ğ~(
KEYWEAK
 | 
VALUEWEAK
);

171 
h
->
m¬ked
 |ğ
	`ÿ¡_by‹
((
w—kkey
 << 
KEYWEAKBIT
) |

172 (
w—kv®ue
 << 
VALUEWEAKBIT
));

173 
h
->
gşi¡
 = 
g
->
w—k
;

174 
g
->
w—k
 = 
	`obj2gco
(
h
);

177 ià(
w—kkey
 && 
w—kv®ue
)  1;

178 ià(!
w—kv®ue
) {

179 
i
 = 
h
->
siz—¼ay
;

180 
i
--)

181 
	`m¬kv®ue
(
g
, &
h
->
¬¿y
[
i
]);

183 
i
 = 
	`siz’ode
(
h
);

184 
i
--) {

185 
Node
 *
n
 = 
	`gnode
(
h
, 
i
);

186 
	`lua_as£¹
(
	`‰y³
(
	`gkey
(
n
)è!ğ
LUA_TDEADKEY
 || 
	`‰i¢
(
	`gv®
(n)));

187 ià(
	`‰i¢
(
	`gv®
(
n
)))

188 
	`»mov“Áry
(
n
);

190 
	`lua_as£¹
(!
	`‰i¢
(
	`gkey
(
n
)));

191 ià(!
w—kkey
è
	`m¬kv®ue
(
g
, 
	`gkey
(
n
));

192 ià(!
w—kv®ue
è
	`m¬kv®ue
(
g
, 
	`gv®
(
n
));

195  
w—kkey
 || 
w—kv®ue
;

196 
	}
}

203 
	$Œav”£´Ùo
 (
glob®_S‹
 *
g
, 
PrÙo
 *
f
) {

204 
i
;

205 ià(
f
->
sourû
è
	`¡ršgm¬k
(f->source);

206 
i
=0; i<
f
->
sizek
; i++)

207 
	`m¬kv®ue
(
g
, &
f
->
k
[
i
]);

208 
i
=0; i<
f
->
sizeupv®ues
; i++) {

209 ià(
f
->
upv®ues
[
i
])

210 
	`¡ršgm¬k
(
f
->
upv®ues
[
i
]);

212 
i
=0; i<
f
->
siz•
; i++) {

213 ià(
f
->
p
[
i
])

214 
	`m¬kobjeù
(
g
, 
f
->
p
[
i
]);

216 
i
=0; i<
f
->
siz–ocv¬s
; i++) {

217 ià(
f
->
locv¬s
[
i
].
v¬Çme
)

218 
	`¡ršgm¬k
(
f
->
locv¬s
[
i
].
v¬Çme
);

220 
	}
}

224 
	$Œav”£şosu»
 (
glob®_S‹
 *
g
, 
Closu»
 *
ş
) {

225 
	`m¬kobjeù
(
g
, 
ş
->
c
.
’v
);

226 ià(
ş
->
c
.
isC
) {

227 
i
;

228 
i
=0; i<
ş
->
c
.
nupv®ues
; i++)

229 
	`m¬kv®ue
(
g
, &
ş
->
c
.
upv®ue
[
i
]);

232 
i
;

233 
	`lua_as£¹
(
ş
->
l
.
nupv®ues
 =ğş->l.
p
->
nups
);

234 
	`m¬kobjeù
(
g
, 
ş
->
l
.
p
);

235 
i
=0; i<
ş
->
l
.
nupv®ues
; i++)

236 
	`m¬kobjeù
(
g
, 
ş
->
l
.
upv®s
[
i
]);

238 
	}
}

241 
	$check¡acksizes
 (
lua_S‹
 *
L
, 
StkId
 
max
) {

242 
ci_u£d
 = 
	`ÿ¡_št
(
L
->
ci
 - L->
ba£_ci
);

243 
s_u£d
 = 
	`ÿ¡_št
(
max
 - 
L
->
¡ack
);

244 ià(
L
->
size_ci
 > 
LUAI_MAXCALLS
)

246 ià(4*
ci_u£d
 < 
L
->
size_ci
 && 2*
BASIC_CI_SIZE
 < L->size_ci)

247 
	`luaD_»®locCI
(
L
, L->
size_ci
/2);

248 
	`cÚdh¬d¡ack‹¡s
(
	`luaD_»®locCI
(
L
, 
ci_u£d
 + 1));

249 ià(4*
s_u£d
 < 
L
->
¡acksize
 &&

250 2*(
BASIC_STACK_SIZE
+
EXTRA_STACK
è< 
L
->
¡acksize
)

251 
	`luaD_»®loc¡ack
(
L
, L->
¡acksize
/2);

252 
	`cÚdh¬d¡ack‹¡s
(
	`luaD_»®loc¡ack
(
L
, 
s_u£d
));

253 
	}
}

256 
	$Œav”£¡ack
 (
glob®_S‹
 *
g
, 
lua_S‹
 *
l
) {

257 
StkId
 
o
, 
lim
;

258 
C®lInfo
 *
ci
;

259 
	`m¬kv®ue
(
g
, 
	`gt
(
l
));

260 
lim
 = 
l
->
tİ
;

261 
ci
 = 
l
->
ba£_ci
; ci <=†->ci; ci++) {

262 
	`lua_as£¹
(
ci
->
tİ
 <ğ
l
->
¡ack_Ï¡
);

263 ià(
lim
 < 
ci
->
tİ
)†im = ci->top;

265 
o
 = 
l
->
¡ack
; o <†->
tİ
; o++)

266 
	`m¬kv®ue
(
g
, 
o
);

267 ; 
o
 <ğ
lim
; o++)

268 
	`£Šv®ue
(
o
);

269 
	`check¡acksizes
(
l
, 
lim
);

270 
	}
}

277 
l_mem
 
	$´İag©em¬k
 (
glob®_S‹
 *
g
) {

278 
GCObjeù
 *
o
 = 
g
->
g¿y
;

279 
	`lua_as£¹
(
	`isg¿y
(
o
));

280 
	`g¿y2bÏck
(
o
);

281 
o
->
gch
.
‰
) {

282 
LUA_TTABLE
: {

283 
TabË
 *
h
 = 
	`gco2h
(
o
);

284 
g
->
g¿y
 = 
h
->
gşi¡
;

285 ià(
	`Œav”£bË
(
g
, 
h
))

286 
	`bÏck2g¿y
(
o
);

287  (
TabË
è+ (
TV®ue
è* 
h
->
siz—¼ay
 +

288 (
Node
è* 
	`siz’ode
(
h
);

290 
LUA_TFUNCTION
: {

291 
Closu»
 *
ş
 = 
	`gco2ş
(
o
);

292 
g
->
g¿y
 = 
ş
->
c
.
gşi¡
;

293 
	`Œav”£şosu»
(
g
, 
ş
);

294  (
ş
->
c
.
isC
è? 
	`sizeCşosu»
(ş->c.
nupv®ues
) :

295 
	`sizeLşosu»
(
ş
->
l
.
nupv®ues
);

297 
LUA_TTHREAD
: {

298 
lua_S‹
 *
th
 = 
	`gco2th
(
o
);

299 
g
->
g¿y
 = 
th
->
gşi¡
;

300 
th
->
gşi¡
 = 
g
->
g¿yagaš
;

301 
g
->
g¿yagaš
 = 
o
;

302 
	`bÏck2g¿y
(
o
);

303 
	`Œav”£¡ack
(
g
, 
th
);

304  (
lua_S‹
è+ (
TV®ue
è* 
th
->
¡acksize
 +

305 (
C®lInfo
è* 
th
->
size_ci
;

307 
LUA_TPROTO
: {

308 
PrÙo
 *
p
 = 
	`gco2p
(
o
);

309 
g
->
g¿y
 = 
p
->
gşi¡
;

310 
	`Œav”£´Ùo
(
g
, 
p
);

311  (
PrÙo
è+ (
In¡ruùiÚ
è* 
p
->
sizecode
 +

312 (
PrÙo
 *è* 
p
->
siz•
 +

313 (
TV®ue
è* 
p
->
sizek
 +

314 (è* 
p
->
siz–šešfo
 +

315 (
LocV¬
è* 
p
->
siz–ocv¬s
 +

316 (
TSŒšg
 *è* 
p
->
sizeupv®ues
;

318 : 
	`lua_as£¹
(0);  0;

320 
	}
}

323 
size_t
 
	$´İag©—Î
 (
glob®_S‹
 *
g
) {

324 
size_t
 
m
 = 0;

325 
g
->
g¿y
è
m
 +ğ
	`´İag©em¬k
(g);

326  
m
;

327 
	}
}

337 
	$isş—»d
 (cÚ¡ 
TV®ue
 *
o
, 
iskey
) {

338 ià(!
	`iscŞËùabË
(
o
))  0;

339 ià(
	`‰is¡ršg
(
o
)) {

340 
	`¡ršgm¬k
(
	`¿wtsv®ue
(
o
));

343  
	`iswh™e
(
	`gcv®ue
(
o
)) ||

344 (
	`‰isu£rd©a
(
o
è&& (!
iskey
 && 
	`isfš®ized
(
	`uv®ue
(o))));

345 
	}
}

351 
	$ş—¹abË
 (
GCObjeù
 *
l
) {

352 
l
) {

353 
TabË
 *
h
 = 
	`gco2h
(
l
);

354 
i
 = 
h
->
siz—¼ay
;

355 
	`lua_as£¹
(
	`‹¡b™
(
h
->
m¬ked
, 
VALUEWEAKBIT
) ||

356 
	`‹¡b™
(
h
->
m¬ked
, 
KEYWEAKBIT
));

357 ià(
	`‹¡b™
(
h
->
m¬ked
, 
VALUEWEAKBIT
)) {

358 
i
--) {

359 
TV®ue
 *
o
 = &
h
->
¬¿y
[
i
];

360 ià(
	`isş—»d
(
o
, 0))

361 
	`£Šv®ue
(
o
);

364 
i
 = 
	`siz’ode
(
h
);

365 
i
--) {

366 
Node
 *
n
 = 
	`gnode
(
h
, 
i
);

367 ià(!
	`‰i¢
(
	`gv®
(
n
)) &&

368 (
	`isş—»d
(
	`key2tv®
(
n
), 1è|| isş—»d(
	`gv®
(n), 0))) {

369 
	`£Šv®ue
(
	`gv®
(
n
));

370 
	`»mov“Áry
(
n
);

373 
l
 = 
h
->
gşi¡
;

375 
	}
}

378 
	$ä“obj
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
) {

379 
o
->
gch
.
‰
) {

380 
LUA_TPROTO
: 
	`luaF_ä“´Ùo
(
L
, 
	`gco2p
(
o
)); ;

381 
LUA_TFUNCTION
: 
	`luaF_ä“şosu»
(
L
, 
	`gco2ş
(
o
)); ;

382 
LUA_TUPVAL
: 
	`luaF_ä“upv®
(
L
, 
	`gco2uv
(
o
)); ;

383 
LUA_TTABLE
: 
	`luaH_ä“
(
L
, 
	`gco2h
(
o
)); ;

384 
LUA_TTHREAD
: {

385 
	`lua_as£¹
(
	`gco2th
(
o
è!ğ
L
 && gco2th(oè!ğ
	`G
(L)->
mašth»ad
);

386 
	`luaE_ä“th»ad
(
L
, 
	`gco2th
(
o
));

389 
LUA_TSTRING
: {

390 
	`G
(
L
)->
¡¹
.
nu£
--;

391 
	`luaM_ä“mem
(
L
, 
o
, 
	`size¡ršg
(
	`gco2ts
(o)));

394 
LUA_TUSERDATA
: {

395 
	`luaM_ä“mem
(
L
, 
o
, 
	`sizeud©a
(
	`gco2u
(o)));

398 : 
	`lua_as£¹
(0);

400 
	}
}

404 
	#sw“pwhŞ–i¡
(
L
,
p
è
	`sw“¶i¡
(L,p,
MAX_LUMEM
)

	)

407 
GCObjeù
 **
	$sw“¶i¡
 (
lua_S‹
 *
L
, 
GCObjeù
 **
p
, 
lu_mem
 
couÁ
) {

408 
GCObjeù
 *
cu¼
;

409 
glob®_S‹
 *
g
 = 
	`G
(
L
);

410 
d—dmask
 = 
	`Ùh”wh™e
(
g
);

411 (
cu¼
 = *
p
è!ğ
NULL
 && 
couÁ
-- > 0) {

412 ià(
cu¼
->
gch
.
‰
 =ğ
LUA_TTHREAD
)

413 
	`sw“pwhŞ–i¡
(
L
, &
	`gco2th
(
cu¼
)->
İ’upv®
);

414 ià((
cu¼
->
gch
.
m¬ked
 ^ 
WHITEBITS
è& 
d—dmask
) {

415 
	`lua_as£¹
(!
	`isd—d
(
g
, 
cu¼
è|| 
	`‹¡b™
(cu¼->
gch
.
m¬ked
, 
FIXEDBIT
));

416 
	`makewh™e
(
g
, 
cu¼
);

417 
p
 = &
cu¼
->
gch
.
Ãxt
;

420 
	`lua_as£¹
(
	`isd—d
(
g
, 
cu¼
è|| 
d—dmask
 =ğ
	`b™mask
(
SFIXEDBIT
));

421 *
p
 = 
cu¼
->
gch
.
Ãxt
;

422 ià(
cu¼
 =ğ
g
->
roÙgc
)

423 
g
->
roÙgc
 = 
cu¼
->
gch
.
Ãxt
;

424 
	`ä“obj
(
L
, 
cu¼
);

427  
p
;

428 
	}
}

431 
	$checkSizes
 (
lua_S‹
 *
L
) {

432 
glob®_S‹
 *
g
 = 
	`G
(
L
);

434 ià(
g
->
¡¹
.
nu£
 < 
	`ÿ¡
(
lu_št32
, g->¡¹.
size
/4) &&

435 
g
->
¡¹
.
size
 > 
MINSTRTABSIZE
*2)

436 
	`luaS_»size
(
L
, 
g
->
¡¹
.
size
/2);

438 ià(
	`luaZ_sizebufãr
(&
g
->
buff
è> 
LUA_MINBUFFER
*2) {

439 
size_t
 
Ãwsize
 = 
	`luaZ_sizebufãr
(&
g
->
buff
) / 2;

440 
	`luaZ_»sizebufãr
(
L
, &
g
->
buff
, 
Ãwsize
);

442 
	}
}

445 
	$GCTM
 (
lua_S‹
 *
L
) {

446 
glob®_S‹
 *
g
 = 
	`G
(
L
);

447 
GCObjeù
 *
o
 = 
g
->
tmud©a
->
gch
.
Ãxt
;

448 
Ud©a
 *
ud©a
 = 
	`¿wgco2u
(
o
);

449 cÚ¡ 
TV®ue
 *
tm
;

451 ià(
o
 =ğ
g
->
tmud©a
)

452 
g
->
tmud©a
 = 
NULL
;

454 
g
->
tmud©a
->
gch
.
Ãxt
 = 
ud©a
->
uv
.next;

455 
ud©a
->
uv
.
Ãxt
 = 
g
->
mašth»ad
->next;

456 
g
->
mašth»ad
->
Ãxt
 = 
o
;

457 
	`makewh™e
(
g
, 
o
);

458 
tm
 = 
	`ç¡tm
(
L
, 
ud©a
->
uv
.
m‘©abË
, 
TM_GC
);

459 ià(
tm
 !ğ
NULL
) {

460 
lu_by‹
 
Şdah
 = 
L
->
®lowhook
;

461 
lu_mem
 
Şdt
 = 
g
->
GCth»shŞd
;

462 
L
->
®lowhook
 = 0;

463 
g
->
GCth»shŞd
 = 2*g->
tÙ®by‹s
;

464 
	`£tobj2s
(
L
, L->
tİ
, 
tm
);

465 
	`£tuv®ue
(
L
, L->
tİ
+1, 
ud©a
);

466 
L
->
tİ
 += 2;

467 
	`luaD_ÿÎ
(
L
, L->
tİ
 - 2, 0);

468 
L
->
®lowhook
 = 
Şdah
;

469 
g
->
GCth»shŞd
 = 
Şdt
;

471 
	}
}

477 
	$luaC_ÿÎGCTM
 (
lua_S‹
 *
L
) {

478 
	`G
(
L
)->
tmud©a
)

479 
	`GCTM
(
L
);

480 
	}
}

483 
	$luaC_ä“®l
 (
lua_S‹
 *
L
) {

484 
glob®_S‹
 *
g
 = 
	`G
(
L
);

485 
i
;

486 
g
->
cu¼’twh™e
 = 
WHITEBITS
 | 
	`b™mask
(
SFIXEDBIT
);

487 
	`sw“pwhŞ–i¡
(
L
, &
g
->
roÙgc
);

488 
i
 = 0; i < 
g
->
¡¹
.
size
; i++)

489 
	`sw“pwhŞ–i¡
(
L
, &
g
->
¡¹
.
hash
[
i
]);

490 
	}
}

493 
	$m¬kmt
 (
glob®_S‹
 *
g
) {

494 
i
;

495 
i
=0; i<
NUM_TAGS
; i++)

496 ià(
g
->
mt
[
i
]è
	`m¬kobjeù
(g, g->mt[i]);

497 
	}
}

501 
	$m¬kroÙ
 (
lua_S‹
 *
L
) {

502 
glob®_S‹
 *
g
 = 
	`G
(
L
);

503 
g
->
g¿y
 = 
NULL
;

504 
g
->
g¿yagaš
 = 
NULL
;

505 
g
->
w—k
 = 
NULL
;

506 
	`m¬kobjeù
(
g
, g->
mašth»ad
);

508 
	`m¬kv®ue
(
g
, 
	`gt
(g->
mašth»ad
));

509 
	`m¬kv®ue
(
g
, 
	`»gi¡ry
(
L
));

510 
	`m¬kmt
(
g
);

511 
g
->
gc¡©e
 = 
GCS´İag©e
;

512 
	}
}

515 
	$»m¬kupv®s
 (
glob®_S‹
 *
g
) {

516 
UpV®
 *
uv
;

517 
uv
 = 
g
->
uvh—d
.
u
.
l
.
Ãxt
; uv != &g->uvhead; uv = uv->u.l.next) {

518 
	`lua_as£¹
(
uv
->
u
.
l
.
Ãxt
->u.l.
´ev
 == uv && uv->u.l.prev->u.l.next == uv);

519 ià(
	`isg¿y
(
	`obj2gco
(
uv
)))

520 
	`m¬kv®ue
(
g
, 
uv
->
v
);

522 
	}
}

525 
	$©omic
 (
lua_S‹
 *
L
) {

526 
glob®_S‹
 *
g
 = 
	`G
(
L
);

527 
size_t
 
udsize
;

529 
	`»m¬kupv®s
(
g
);

531 
	`´İag©—Î
(
g
);

533 
g
->
g¿y
 = g->
w—k
;

534 
g
->
w—k
 = 
NULL
;

535 
	`lua_as£¹
(!
	`iswh™e
(
	`obj2gco
(
g
->
mašth»ad
)));

536 
	`m¬kobjeù
(
g
, 
L
);

537 
	`m¬kmt
(
g
);

538 
	`´İag©—Î
(
g
);

540 
g
->
g¿y
 = g->
g¿yagaš
;

541 
g
->
g¿yagaš
 = 
NULL
;

542 
	`´İag©—Î
(
g
);

543 
udsize
 = 
	`luaC_£·¿‹ud©a
(
L
, 0);

544 
	`m¬ktmu
(
g
);

545 
udsize
 +ğ
	`´İag©—Î
(
g
);

546 
	`ş—¹abË
(
g
->
w—k
);

548 
g
->
cu¼’twh™e
 = 
	`ÿ¡_by‹
(
	`Ùh”wh™e
(g));

549 
g
->
sw“p¡rgc
 = 0;

550 
g
->
sw“pgc
 = &g->
roÙgc
;

551 
g
->
gc¡©e
 = 
GCSsw“p¡ršg
;

552 
g
->
e¡im©e
 = g->
tÙ®by‹s
 - 
udsize
;

553 
	}
}

556 
l_mem
 
	$sšgË¡•
 (
lua_S‹
 *
L
) {

557 
glob®_S‹
 *
g
 = 
	`G
(
L
);

559 
g
->
gc¡©e
) {

560 
GCS·u£
: {

561 
	`m¬kroÙ
(
L
);

564 
GCS´İag©e
: {

565 ià(
g
->
g¿y
)

566  
	`´İag©em¬k
(
g
);

568 
	`©omic
(
L
);

572 
GCSsw“p¡ršg
: {

573 
lu_mem
 
Şd
 = 
g
->
tÙ®by‹s
;

574 
	`sw“pwhŞ–i¡
(
L
, &
g
->
¡¹
.
hash
[g->
sw“p¡rgc
++]);

575 ià(
g
->
sw“p¡rgc
 >ğg->
¡¹
.
size
)

576 
g
->
gc¡©e
 = 
GCSsw“p
;

577 
	`lua_as£¹
(
Şd
 >ğ
g
->
tÙ®by‹s
);

578 
g
->
e¡im©e
 -ğ
Şd
 - g->
tÙ®by‹s
;

579  
GCSWEEPCOST
;

581 
GCSsw“p
: {

582 
lu_mem
 
Şd
 = 
g
->
tÙ®by‹s
;

583 
g
->
sw“pgc
 = 
	`sw“¶i¡
(
L
, g->sw“pgc, 
GCSWEEPMAX
);

584 ià(*
g
->
sw“pgc
 =ğ
NULL
) {

585 
	`checkSizes
(
L
);

586 
g
->
gc¡©e
 = 
GCSfš®ize
;

588 
	`lua_as£¹
(
Şd
 >ğ
g
->
tÙ®by‹s
);

589 
g
->
e¡im©e
 -ğ
Şd
 - g->
tÙ®by‹s
;

590  
GCSWEEPMAX
*
GCSWEEPCOST
;

592 
GCSfš®ize
: {

593 ià(
g
->
tmud©a
) {

594 
	`GCTM
(
L
);

595 ià(
g
->
e¡im©e
 > 
GCFINALIZECOST
)

596 
g
->
e¡im©e
 -ğ
GCFINALIZECOST
;

597  
GCFINALIZECOST
;

600 
g
->
gc¡©e
 = 
GCS·u£
;

601 
g
->
gcd•t
 = 0;

605 : 
	`lua_as£¹
(0);  0;

607 
	}
}

610 
	$luaC_¡•
 (
lua_S‹
 *
L
) {

611 
glob®_S‹
 *
g
 = 
	`G
(
L
);

612 
l_mem
 
lim
 = (
GCSTEPSIZE
/100è* 
g
->
gc¡•mul
;

613 ià(
lim
 == 0)

614 
lim
 = (
MAX_LUMEM
-1)/2;

615 
g
->
gcd•t
 +ğg->
tÙ®by‹s
 - g->
GCth»shŞd
;

617 
lim
 -ğ
	`sšgË¡•
(
L
);

618 ià(
g
->
gc¡©e
 =ğ
GCS·u£
)

620 } 
lim
 > 0);

621 ià(
g
->
gc¡©e
 !ğ
GCS·u£
) {

622 ià(
g
->
gcd•t
 < 
GCSTEPSIZE
)

623 
g
->
GCth»shŞd
 = g->
tÙ®by‹s
 + 
GCSTEPSIZE
;

625 
g
->
gcd•t
 -ğ
GCSTEPSIZE
;

626 
g
->
GCth»shŞd
 = g->
tÙ®by‹s
;

630 
	`£‰h»shŞd
(
g
);

632 
	}
}

635 
	$luaC_fuÎgc
 (
lua_S‹
 *
L
) {

636 
glob®_S‹
 *
g
 = 
	`G
(
L
);

637 ià(
g
->
gc¡©e
 <ğ
GCS´İag©e
) {

639 
g
->
sw“p¡rgc
 = 0;

640 
g
->
sw“pgc
 = &g->
roÙgc
;

642 
g
->
g¿y
 = 
NULL
;

643 
g
->
g¿yagaš
 = 
NULL
;

644 
g
->
w—k
 = 
NULL
;

645 
g
->
gc¡©e
 = 
GCSsw“p¡ršg
;

647 
	`lua_as£¹
(
g
->
gc¡©e
 !ğ
GCS·u£
 && g->gc¡©!ğ
GCS´İag©e
);

649 
g
->
gc¡©e
 !ğ
GCSfš®ize
) {

650 
	`lua_as£¹
(
g
->
gc¡©e
 =ğ
GCSsw“p¡ršg
 || g->gc¡©=ğ
GCSsw“p
);

651 
	`sšgË¡•
(
L
);

653 
	`m¬kroÙ
(
L
);

654 
g
->
gc¡©e
 !ğ
GCS·u£
) {

655 
	`sšgË¡•
(
L
);

657 
	`£‰h»shŞd
(
g
);

658 
	}
}

661 
	$luaC_b¬r›rf
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, GCObjeù *
v
) {

662 
glob®_S‹
 *
g
 = 
	`G
(
L
);

663 
	`lua_as£¹
(
	`isbÏck
(
o
è&& 
	`iswh™e
(
v
è&& !
	`isd—d
(
g
, v) && !isdead(g, o));

664 
	`lua_as£¹
(
g
->
gc¡©e
 !ğ
GCSfš®ize
 && g->gc¡©!ğ
GCS·u£
);

665 
	`lua_as£¹
(
	`‰y³
(&
o
->
gch
è!ğ
LUA_TTABLE
);

667 ià(
g
->
gc¡©e
 =ğ
GCS´İag©e
)

668 
	`»®lym¬kobjeù
(
g
, 
v
);

670 
	`makewh™e
(
g
, 
o
);

671 
	}
}

674 
	$luaC_b¬r›rback
 (
lua_S‹
 *
L
, 
TabË
 *
t
) {

675 
glob®_S‹
 *
g
 = 
	`G
(
L
);

676 
GCObjeù
 *
o
 = 
	`obj2gco
(
t
);

677 
	`lua_as£¹
(
	`isbÏck
(
o
è&& !
	`isd—d
(
g
, o));

678 
	`lua_as£¹
(
g
->
gc¡©e
 !ğ
GCSfš®ize
 && g->gc¡©!ğ
GCS·u£
);

679 
	`bÏck2g¿y
(
o
);

680 
t
->
gşi¡
 = 
g
->
g¿yagaš
;

681 
g
->
g¿yagaš
 = 
o
;

682 
	}
}

685 
	$luaC_lšk
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, 
lu_by‹
 
‰
) {

686 
glob®_S‹
 *
g
 = 
	`G
(
L
);

687 
o
->
gch
.
Ãxt
 = 
g
->
roÙgc
;

688 
g
->
roÙgc
 = 
o
;

689 
o
->
gch
.
m¬ked
 = 
	`luaC_wh™e
(
g
);

690 
o
->
gch
.
‰
 =t;

691 
	}
}

694 
	$luaC_lškupv®
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
) {

695 
glob®_S‹
 *
g
 = 
	`G
(
L
);

696 
GCObjeù
 *
o
 = 
	`obj2gco
(
uv
);

697 
o
->
gch
.
Ãxt
 = 
g
->
roÙgc
;

698 
g
->
roÙgc
 = 
o
;

699 ià(
	`isg¿y
(
o
)) {

700 ià(
g
->
gc¡©e
 =ğ
GCS´İag©e
) {

701 
	`g¿y2bÏck
(
o
);

702 
	`luaC_b¬r›r
(
L
, 
uv
, uv->
v
);

705 
	`makewh™e
(
g
, 
o
);

706 
	`lua_as£¹
(
g
->
gc¡©e
 !ğ
GCSfš®ize
 && g->gc¡©!ğ
GCS·u£
);

709 
	}
}

	@deps/lua/src/lgc.h

7 #iâdeà
lgc_h


8 
	#lgc_h


	)

11 
	~"lobjeù.h
"

17 
	#GCS·u£
 0

	)

18 
	#GCS´İag©e
 1

	)

19 
	#GCSsw“p¡ršg
 2

	)

20 
	#GCSsw“p
 3

	)

21 
	#GCSfš®ize
 4

	)

27 
	#»£tb™s
(
x
,
m
è((xè&ğ
	`ÿ¡
(
lu_by‹
, ~(m)))

	)

28 
	#£tb™s
(
x
,
m
è((xè|ğ(m))

	)

29 
	#‹¡b™s
(
x
,
m
è((xè& (m))

	)

30 
	#b™mask
(
b
è(1<<(b))

	)

31 
	#b™2mask
(
b1
,
b2
è(
	`b™mask
(b1è| b™mask(b2))

	)

32 
	#l_£tb™
(
x
,
b
è
	`£tb™s
(x, 
	`b™mask
(b))

	)

33 
	#»£tb™
(
x
,
b
è
	`»£tb™s
(x, 
	`b™mask
(b))

	)

34 
	#‹¡b™
(
x
,
b
è
	`‹¡b™s
(x, 
	`b™mask
(b))

	)

35 
	#£t2b™s
(
x
,
b1
,
b2
è
	`£tb™s
(x, (
	`b™2mask
(b1, b2)))

	)

36 
	#»£t2b™s
(
x
,
b1
,
b2
è
	`»£tb™s
(x, (
	`b™2mask
(b1, b2)))

	)

37 
	#‹¡2b™s
(
x
,
b1
,
b2
è
	`‹¡b™s
(x, (
	`b™2mask
(b1, b2)))

	)

54 
	#WHITE0BIT
 0

	)

55 
	#WHITE1BIT
 1

	)

56 
	#BLACKBIT
 2

	)

57 
	#FINALIZEDBIT
 3

	)

58 
	#KEYWEAKBIT
 3

	)

59 
	#VALUEWEAKBIT
 4

	)

60 
	#FIXEDBIT
 5

	)

61 
	#SFIXEDBIT
 6

	)

62 
	#WHITEBITS
 
	`b™2mask
(
WHITE0BIT
, 
WHITE1BIT
)

	)

65 
	#iswh™e
(
x
è
	`‹¡2b™s
((x)->
gch
.
m¬ked
, 
WHITE0BIT
, 
WHITE1BIT
)

	)

66 
	#isbÏck
(
x
è
	`‹¡b™
((x)->
gch
.
m¬ked
, 
BLACKBIT
)

	)

67 
	#isg¿y
(
x
è(!
	`isbÏck
(xè&& !
	`iswh™e
(x))

	)

69 
	#Ùh”wh™e
(
g
è(g->
cu¼’twh™e
 ^ 
WHITEBITS
)

	)

70 
	#isd—d
(
g
,
v
è((v)->
gch
.
m¬ked
 & 
	`Ùh”wh™e
(gè& 
WHITEBITS
)

	)

72 
	#chªgewh™e
(
x
è((x)->
gch
.
m¬ked
 ^ğ
WHITEBITS
)

	)

73 
	#g¿y2bÏck
(
x
è
	`l_£tb™
((x)->
gch
.
m¬ked
, 
BLACKBIT
)

	)

75 
	#v®iswh™e
(
x
è(
	`iscŞËùabË
(xè&& 
	`iswh™e
(
	`gcv®ue
(x)))

	)

77 
	#luaC_wh™e
(
g
è
	`ÿ¡
(
lu_by‹
, (g)->
cu¼’twh™e
 & 
WHITEBITS
)

	)

80 
	#luaC_checkGC
(
L
) { \

81 
	`cÚdh¬d¡ack‹¡s
(
	`luaD_»®loc¡ack
(
L
, L->
¡acksize
 - 
EXTRA_STACK
 - 1)); \

82 ià(
	`G
(
L
)->
tÙ®by‹s
 >ğG(L)->
GCth»shŞd
) \

83 
	`luaC_¡•
(
L
); }

	)

86 
	#luaC_b¬r›r
(
L
,
p
,
v
è{ ià(
	`v®iswh™e
(vè&& 
	`isbÏck
(
	`obj2gco
(p))) \

87 
	`luaC_b¬r›rf
(
L
,
	`obj2gco
(
p
),
	`gcv®ue
(
v
)); }

	)

89 
	#luaC_b¬r›¹
(
L
,
t
,
v
è{ ià(
	`v®iswh™e
(vè&& 
	`isbÏck
(
	`obj2gco
(t))) \

90 
	`luaC_b¬r›rback
(
L
,
t
); }

	)

92 
	#luaC_objb¬r›r
(
L
,
p
,
o
) \

93 { ià(
	`iswh™e
(
	`obj2gco
(
o
)è&& 
	`isbÏck
(obj2gco(
p
))) \

94 
	`luaC_b¬r›rf
(
L
,
	`obj2gco
(
p
),obj2gco(
o
)); }

	)

96 
	#luaC_objb¬r›¹
(
L
,
t
,
o
) \

97 { ià(
	`iswh™e
(
	`obj2gco
(
o
)è&& 
	`isbÏck
(obj2gco(
t
))è
	`luaC_b¬r›rback
(
L
,t); }

	)

99 
LUAI_FUNC
 
size_t
 
luaC_£·¿‹ud©a
 (
lua_S‹
 *
L
, 
®l
);

100 
LUAI_FUNC
 
luaC_ÿÎGCTM
 (
lua_S‹
 *
L
);

101 
LUAI_FUNC
 
luaC_ä“®l
 (
lua_S‹
 *
L
);

102 
LUAI_FUNC
 
luaC_¡•
 (
lua_S‹
 *
L
);

103 
LUAI_FUNC
 
luaC_fuÎgc
 (
lua_S‹
 *
L
);

104 
LUAI_FUNC
 
luaC_lšk
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, 
lu_by‹
 
‰
);

105 
LUAI_FUNC
 
luaC_lškupv®
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
);

106 
LUAI_FUNC
 
luaC_b¬r›rf
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, GCObjeù *
v
);

107 
LUAI_FUNC
 
luaC_b¬r›rback
 (
lua_S‹
 *
L
, 
TabË
 *
t
);

	@deps/lua/src/linit.c

8 
	#lš™_c


	)

9 
	#LUA_LIB


	)

11 
	~"lua.h
"

13 
	~"lu®ib.h
"

14 
	~"Ïuxlib.h
"

17 cÚ¡ 
luaL_Reg
 
	glu®ibs
[] = {

18 {"", 
luaİ’_ba£
},

19 {
LUA_LOADLIBNAME
, 
luaİ’_·ckage
},

20 {
LUA_TABLIBNAME
, 
luaİ’_bË
},

21 {
LUA_IOLIBNAME
, 
luaİ’_io
},

22 {
LUA_OSLIBNAME
, 
luaİ’_os
},

23 {
LUA_STRLIBNAME
, 
luaİ’_¡ršg
},

24 {
LUA_MATHLIBNAME
, 
luaİ’_m©h
},

25 {
LUA_DBLIBNAME
, 
luaİ’_debug
},

26 {
NULL
, NULL}

30 
LUALIB_API
 
	$luaL_İ’libs
 (
lua_S‹
 *
L
) {

31 cÚ¡ 
luaL_Reg
 *
lib
 = 
lu®ibs
;

32 ; 
lib
->
func
;†ib++) {

33 
	`lua_pushcfunùiÚ
(
L
, 
lib
->
func
);

34 
	`lua_push¡ršg
(
L
, 
lib
->
Çme
);

35 
	`lua_ÿÎ
(
L
, 1, 0);

37 
	}
}

	@deps/lua/src/liolib.c

8 
	~<”ºo.h
>

9 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

13 
	#liŞib_c


	)

14 
	#LUA_LIB


	)

16 
	~"lua.h
"

18 
	~"Ïuxlib.h
"

19 
	~"lu®ib.h
"

23 
	#IO_INPUT
 1

	)

24 
	#IO_OUTPUT
 2

	)

27 cÚ¡ *cÚ¡ 
	gâames
[] = {"input", "output"};

30 
	$push»suÉ
 (
lua_S‹
 *
L
, 
i
, cÚ¡ *
f’ame
) {

31 
’
 = 
”ºo
;

32 ià(
i
) {

33 
	`lua_pushboŞ—n
(
L
, 1);

37 
	`lua_pushn
(
L
);

38 ià(
f’ame
)

39 
	`lua_pushf¡ršg
(
L
, "%s: %s", 
f’ame
, 
	`¡»¼Ü
(
’
));

41 
	`lua_pushf¡ršg
(
L
, "%s", 
	`¡»¼Ü
(
’
));

42 
	`lua_pushš‹g”
(
L
, 
’
);

45 
	}
}

48 
	$f“¼Ü
 (
lua_S‹
 *
L
, 
¬g
, cÚ¡ *
f’ame
) {

49 
	`lua_pushf¡ršg
(
L
, "%s: %s", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

50 
	`luaL_¬g”rÜ
(
L
, 
¬g
, 
	`lua_to¡ršg
(L, -1));

51 
	}
}

54 
	#tof•
(
L
è((
FILE
 **)
	`luaL_checkud©a
(L, 1, 
LUA_FILEHANDLE
))

	)

57 
	$io_ty³
 (
lua_S‹
 *
L
) {

58 *
ud
;

59 
	`luaL_checkªy
(
L
, 1);

60 
ud
 = 
	`lua_tou£rd©a
(
L
, 1);

61 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_FILEHANDLE
);

62 ià(
ud
 =ğ
NULL
 || !
	`lua_g‘m‘©abË
(
L
, 1è|| !
	`lua_¿wequ®
(L, -2, -1))

63 
	`lua_pushn
(
L
);

64 ià(*((
FILE
 **)
ud
è=ğ
NULL
)

65 
	`lua_pushl™”®
(
L
, "closed file");

67 
	`lua_pushl™”®
(
L
, "file");

69 
	}
}

72 
FILE
 *
	$tofe
 (
lua_S‹
 *
L
) {

73 
FILE
 **
f
 = 
	`tof•
(
L
);

74 ià(*
f
 =ğ
NULL
)

75 
	`luaL_”rÜ
(
L
, "attempto use‡ closed file");

76  *
f
;

77 
	}
}

86 
FILE
 **
	$Ãwfe
 (
lua_S‹
 *
L
) {

87 
FILE
 **
pf
 = (FILE **)
	`lua_Ãwu£rd©a
(
L
, (FILE *));

88 *
pf
 = 
NULL
;

89 
	`luaL_g‘m‘©abË
(
L
, 
LUA_FILEHANDLE
);

90 
	`lua_£tm‘©abË
(
L
, -2);

91  
pf
;

92 
	}
}

98 
	$io_noşo£
 (
lua_S‹
 *
L
) {

99 
	`lua_pushn
(
L
);

100 
	`lua_pushl™”®
(
L
, "cannot close standard file");

102 
	}
}

108 
	$io_pşo£
 (
lua_S‹
 *
L
) {

109 
FILE
 **
p
 = 
	`tof•
(
L
);

110 
ok
 = 
	`lua_pşo£
(
L
, *
p
);

111 *
p
 = 
NULL
;

112  
	`push»suÉ
(
L
, 
ok
, 
NULL
);

113 
	}
}

119 
	$io_fşo£
 (
lua_S‹
 *
L
) {

120 
FILE
 **
p
 = 
	`tof•
(
L
);

121 
ok
 = (
	`fşo£
(*
p
) == 0);

122 *
p
 = 
NULL
;

123  
	`push»suÉ
(
L
, 
ok
, 
NULL
);

124 
	}
}

127 
	$aux_şo£
 (
lua_S‹
 *
L
) {

128 
	`lua_g‘ãnv
(
L
, 1);

129 
	`lua_g‘f›ld
(
L
, -1, "__close");

130  (
	`lua_tocfunùiÚ
(
L
, -1))(L);

131 
	}
}

134 
	$io_şo£
 (
lua_S‹
 *
L
) {

135 ià(
	`lua_i¢Úe
(
L
, 1))

136 
	`lua_¿wg‘i
(
L
, 
LUA_ENVIRONINDEX
, 
IO_OUTPUT
);

137 
	`tofe
(
L
);

138  
	`aux_şo£
(
L
);

139 
	}
}

142 
	$io_gc
 (
lua_S‹
 *
L
) {

143 
FILE
 *
f
 = *
	`tof•
(
L
);

145 ià(
f
 !ğ
NULL
)

146 
	`aux_şo£
(
L
);

148 
	}
}

151 
	$io_to¡ršg
 (
lua_S‹
 *
L
) {

152 
FILE
 *
f
 = *
	`tof•
(
L
);

153 ià(
f
 =ğ
NULL
)

154 
	`lua_pushl™”®
(
L
, "file (closed)");

156 
	`lua_pushf¡ršg
(
L
, "f(%p)", 
f
);

158 
	}
}

161 
	$io_İ’
 (
lua_S‹
 *
L
) {

162 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

163 cÚ¡ *
mode
 = 
	`luaL_İt¡ršg
(
L
, 2, "r");

164 
FILE
 **
pf
 = 
	`Ãwfe
(
L
);

165 *
pf
 = 
	`fİ’
(
f’ame
, 
mode
);

166  (*
pf
 =ğ
NULL
è? 
	`push»suÉ
(
L
, 0, 
f’ame
) : 1;

167 
	}
}

174 
	$io_pİ’
 (
lua_S‹
 *
L
) {

175 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

176 cÚ¡ *
mode
 = 
	`luaL_İt¡ršg
(
L
, 2, "r");

177 
FILE
 **
pf
 = 
	`Ãwfe
(
L
);

178 *
pf
 = 
	`lua_pİ’
(
L
, 
f’ame
, 
mode
);

179  (*
pf
 =ğ
NULL
è? 
	`push»suÉ
(
L
, 0, 
f’ame
) : 1;

180 
	}
}

183 
	$io_tmpfe
 (
lua_S‹
 *
L
) {

184 
FILE
 **
pf
 = 
	`Ãwfe
(
L
);

185 *
pf
 = 
	`tmpfe
();

186  (*
pf
 =ğ
NULL
è? 
	`push»suÉ
(
L
, 0, NULL) : 1;

187 
	}
}

190 
FILE
 *
	$g‘iofe
 (
lua_S‹
 *
L
, 
fšdex
) {

191 
FILE
 *
f
;

192 
	`lua_¿wg‘i
(
L
, 
LUA_ENVIRONINDEX
, 
fšdex
);

193 
f
 = *(
FILE
 **)
	`lua_tou£rd©a
(
L
, -1);

194 ià(
f
 =ğ
NULL
)

195 
	`luaL_”rÜ
(
L
, "¡ªd¬d % fi şo£d", 
âames
[
fšdex
 - 1]);

196  
f
;

197 
	}
}

200 
	$g_iofe
 (
lua_S‹
 *
L
, 
f
, cÚ¡ *
mode
) {

201 ià(!
	`lua_i¢ÚeÜn
(
L
, 1)) {

202 cÚ¡ *
f’ame
 = 
	`lua_to¡ršg
(
L
, 1);

203 ià(
f’ame
) {

204 
FILE
 **
pf
 = 
	`Ãwfe
(
L
);

205 *
pf
 = 
	`fİ’
(
f’ame
, 
mode
);

206 ià(*
pf
 =ğ
NULL
)

207 
	`f“¼Ü
(
L
, 1, 
f’ame
);

210 
	`tofe
(
L
);

211 
	`lua_pushv®ue
(
L
, 1);

213 
	`lua_¿w£ti
(
L
, 
LUA_ENVIRONINDEX
, 
f
);

216 
	`lua_¿wg‘i
(
L
, 
LUA_ENVIRONINDEX
, 
f
);

218 
	}
}

221 
	$io_šput
 (
lua_S‹
 *
L
) {

222  
	`g_iofe
(
L
, 
IO_INPUT
, "r");

223 
	}
}

226 
	$io_ouut
 (
lua_S‹
 *
L
) {

227  
	`g_iofe
(
L
, 
IO_OUTPUT
, "w");

228 
	}
}

231 
io_»adlše
 (
lua_S‹
 *
L
);

234 
	$aux_lšes
 (
lua_S‹
 *
L
, 
idx
, 
toşo£
) {

235 
	`lua_pushv®ue
(
L
, 
idx
);

236 
	`lua_pushboŞ—n
(
L
, 
toşo£
);

237 
	`lua_pushcşosu»
(
L
, 
io_»adlše
, 2);

238 
	}
}

241 
	$f_lšes
 (
lua_S‹
 *
L
) {

242 
	`tofe
(
L
);

243 
	`aux_lšes
(
L
, 1, 0);

245 
	}
}

248 
	$io_lšes
 (
lua_S‹
 *
L
) {

249 ià(
	`lua_i¢ÚeÜn
(
L
, 1)) {

251 
	`lua_¿wg‘i
(
L
, 
LUA_ENVIRONINDEX
, 
IO_INPUT
);

252  
	`f_lšes
(
L
);

255 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

256 
FILE
 **
pf
 = 
	`Ãwfe
(
L
);

257 *
pf
 = 
	`fİ’
(
f’ame
, "r");

258 ià(*
pf
 =ğ
NULL
)

259 
	`f“¼Ü
(
L
, 1, 
f’ame
);

260 
	`aux_lšes
(
L
, 
	`lua_g‘tİ
(L), 1);

263 
	}
}

273 
	$»ad_numb”
 (
lua_S‹
 *
L
, 
FILE
 *
f
) {

274 
lua_Numb”
 
d
;

275 ià(
	`fsÿnf
(
f
, 
LUA_NUMBER_SCAN
, &
d
) == 1) {

276 
	`lua_pushnumb”
(
L
, 
d
);

280 
	`lua_pushn
(
L
);

283 
	}
}

286 
	$‹¡_eof
 (
lua_S‹
 *
L
, 
FILE
 *
f
) {

287 
c
 = 
	`g‘c
(
f
);

288 
	`ung‘c
(
c
, 
f
);

289 
	`lua_pushl¡ršg
(
L
, 
NULL
, 0);

290  (
c
 !ğ
EOF
);

291 
	}
}

294 
	$»ad_lše
 (
lua_S‹
 *
L
, 
FILE
 *
f
) {

295 
luaL_Bufãr
 
b
;

296 
	`luaL_buffš™
(
L
, &
b
);

298 
size_t
 
l
;

299 *
p
 = 
	`luaL_´•bufãr
(&
b
);

300 ià(
	`fg‘s
(
p
, 
LUAL_BUFFERSIZE
, 
f
è=ğ
NULL
) {

301 
	`luaL_push»suÉ
(&
b
);

302  (
	`lua_objËn
(
L
, -1) > 0);

304 
l
 = 
	`¡¾’
(
p
);

305 ià(
l
 =ğ0 || 
p
[l-1] != '\n')

306 
	`luaL_addsize
(&
b
, 
l
);

308 
	`luaL_addsize
(&
b
, 
l
 - 1);

309 
	`luaL_push»suÉ
(&
b
);

313 
	}
}

316 
	$»ad_ch¬s
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
size_t
 
n
) {

317 
size_t
 
¾’
;

318 
size_t
 
Ä
;

319 
luaL_Bufãr
 
b
;

320 
	`luaL_buffš™
(
L
, &
b
);

321 
¾’
 = 
LUAL_BUFFERSIZE
;

323 *
p
 = 
	`luaL_´•bufãr
(&
b
);

324 ià(
¾’
 > 
n
)„len =‚;

325 
Ä
 = 
	`ä—d
(
p
, (), 
¾’
, 
f
);

326 
	`luaL_addsize
(&
b
, 
Ä
);

327 
n
 -ğ
Ä
;

328 } 
n
 > 0 && 
Ä
 =ğ
¾’
);

329 
	`luaL_push»suÉ
(&
b
);

330  (
n
 =ğ0 || 
	`lua_objËn
(
L
, -1) > 0);

331 
	}
}

334 
	$g_»ad
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
fœ¡
) {

335 
Çrgs
 = 
	`lua_g‘tİ
(
L
) - 1;

336 
sucûss
;

337 
n
;

338 
	`ş—»¼
(
f
);

339 ià(
Çrgs
 == 0) {

340 
sucûss
 = 
	`»ad_lše
(
L
, 
f
);

341 
n
 = 
fœ¡
+1;

344 
	`luaL_check¡ack
(
L
, 
Çrgs
+
LUA_MINSTACK
, "too many‡rguments");

345 
sucûss
 = 1;

346 
n
 = 
fœ¡
; 
Çrgs
-- && 
sucûss
;‚++) {

347 ià(
	`lua_ty³
(
L
, 
n
è=ğ
LUA_TNUMBER
) {

348 
size_t
 
l
 = (size_t)
	`lua_toš‹g”
(
L
, 
n
);

349 
sucûss
 = (
l
 =ğ0è? 
	`‹¡_eof
(
L
, 
f
è: 
	`»ad_ch¬s
(L, f,†);

352 cÚ¡ *
p
 = 
	`lua_to¡ršg
(
L
, 
n
);

353 
	`luaL_¬gcheck
(
L
, 
p
 &&…[0] =ğ'*', 
n
, "invalid option");

354 
p
[1]) {

356 
sucûss
 = 
	`»ad_numb”
(
L
, 
f
);

359 
sucûss
 = 
	`»ad_lše
(
L
, 
f
);

362 
	`»ad_ch¬s
(
L
, 
f
, ~((
size_t
)0));

363 
sucûss
 = 1;

366  
	`luaL_¬g”rÜ
(
L
, 
n
, "invalid format");

371 ià(
	`ã¼Ü
(
f
))

372  
	`push»suÉ
(
L
, 0, 
NULL
);

373 ià(!
sucûss
) {

374 
	`lua_pİ
(
L
, 1);

375 
	`lua_pushn
(
L
);

377  
n
 - 
fœ¡
;

378 
	}
}

381 
	$io_»ad
 (
lua_S‹
 *
L
) {

382  
	`g_»ad
(
L
, 
	`g‘iofe
(L, 
IO_INPUT
), 1);

383 
	}
}

386 
	$f_»ad
 (
lua_S‹
 *
L
) {

387  
	`g_»ad
(
L
, 
	`tofe
(L), 2);

388 
	}
}

391 
	$io_»adlše
 (
lua_S‹
 *
L
) {

392 
FILE
 *
f
 = *(FILE **)
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

393 
suûss
;

394 ià(
f
 =ğ
NULL
)

395 
	`luaL_”rÜ
(
L
, "file is‡lready closed");

396 
suûss
 = 
	`»ad_lše
(
L
, 
f
);

397 ià(
	`ã¼Ü
(
f
))

398  
	`luaL_”rÜ
(
L
, "%s", 
	`¡»¼Ü
(
”ºo
));

399 ià(
suûss
)  1;

401 ià(
	`lua_toboŞ—n
(
L
, 
	`lua_upv®uešdex
(2))) {

402 
	`lua_£‰İ
(
L
, 0);

403 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(1));

404 
	`aux_şo£
(
L
);

408 
	}
}

413 
	$g_wr™e
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
¬g
) {

414 
Çrgs
 = 
	`lua_g‘tİ
(
L
) - 1;

415 
¡©us
 = 1;

416 ; 
Çrgs
--; 
¬g
++) {

417 ià(
	`lua_ty³
(
L
, 
¬g
è=ğ
LUA_TNUMBER
) {

419 
¡©us
 = status &&

420 
	`årštf
(
f
, 
LUA_NUMBER_FMT
, 
	`lua_tÚumb”
(
L
, 
¬g
)) > 0;

423 
size_t
 
l
;

424 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
l
);

425 
¡©us
 = stu && (
	`fwr™e
(
s
, (), 
l
, 
f
) ==†);

428  
	`push»suÉ
(
L
, 
¡©us
, 
NULL
);

429 
	}
}

432 
	$io_wr™e
 (
lua_S‹
 *
L
) {

433  
	`g_wr™e
(
L
, 
	`g‘iofe
(L, 
IO_OUTPUT
), 1);

434 
	}
}

437 
	$f_wr™e
 (
lua_S‹
 *
L
) {

438  
	`g_wr™e
(
L
, 
	`tofe
(L), 2);

439 
	}
}

442 
	$f_£ek
 (
lua_S‹
 *
L
) {

443 cÚ¡ 
mode
[] = {
SEEK_SET
, 
SEEK_CUR
, 
SEEK_END
};

444 cÚ¡ *cÚ¡ 
mod’ames
[] = {"£t", "cur", "’d", 
NULL
};

445 
FILE
 *
f
 = 
	`tofe
(
L
);

446 
İ
 = 
	`luaL_checkİtiÚ
(
L
, 2, "cur", 
mod’ames
);

447 
off£t
 = 
	`luaL_İÚg
(
L
, 3, 0);

448 
İ
 = 
	`f£ek
(
f
, 
off£t
, 
mode
[op]);

449 ià(
İ
)

450  
	`push»suÉ
(
L
, 0, 
NULL
);

452 
	`lua_pushš‹g”
(
L
, 
	`á–l
(
f
));

455 
	}
}

458 
	$f_£tvbuf
 (
lua_S‹
 *
L
) {

459 cÚ¡ 
mode
[] = {
_IONBF
, 
_IOFBF
, 
_IOLBF
};

460 cÚ¡ *cÚ¡ 
mod’ames
[] = {"no", "fuÎ", "lše", 
NULL
};

461 
FILE
 *
f
 = 
	`tofe
(
L
);

462 
İ
 = 
	`luaL_checkİtiÚ
(
L
, 2, 
NULL
, 
mod’ames
);

463 
lua_IÁeg”
 
sz
 = 
	`luaL_İtš‹g”
(
L
, 3, 
LUAL_BUFFERSIZE
);

464 
»s
 = 
	`£tvbuf
(
f
, 
NULL
, 
mode
[
İ
], 
sz
);

465  
	`push»suÉ
(
L
, 
»s
 =ğ0, 
NULL
);

466 
	}
}

470 
	$io_æush
 (
lua_S‹
 *
L
) {

471  
	`push»suÉ
(
L
, 
	`fæush
(
	`g‘iofe
(L, 
IO_OUTPUT
)è=ğ0, 
NULL
);

472 
	}
}

475 
	$f_æush
 (
lua_S‹
 *
L
) {

476  
	`push»suÉ
(
L
, 
	`fæush
(
	`tofe
(L)è=ğ0, 
NULL
);

477 
	}
}

480 cÚ¡ 
luaL_Reg
 
	giŞib
[] = {

481 {"şo£", 
io_şo£
},

482 {"æush", 
io_æush
},

483 {"šput", 
io_šput
},

484 {"lšes", 
io_lšes
},

485 {"İ’", 
io_İ’
},

486 {"ouut", 
io_ouut
},

487 {"pİ’", 
io_pİ’
},

488 {"»ad", 
io_»ad
},

489 {"tmpfe", 
io_tmpfe
},

490 {"ty³", 
io_ty³
},

491 {"wr™e", 
io_wr™e
},

492 {
NULL
, NULL}

496 cÚ¡ 
luaL_Reg
 
	gæib
[] = {

497 {"şo£", 
io_şo£
},

498 {"æush", 
f_æush
},

499 {"lšes", 
f_lšes
},

500 {"»ad", 
f_»ad
},

501 {"£ek", 
f_£ek
},

502 {"£tvbuf", 
f_£tvbuf
},

503 {"wr™e", 
f_wr™e
},

504 {"__gc", 
io_gc
},

505 {"__to¡ršg", 
io_to¡ršg
},

506 {
NULL
, NULL}

510 
	$ü—‹m‘a
 (
lua_S‹
 *
L
) {

511 
	`luaL_Ãwm‘©abË
(
L
, 
LUA_FILEHANDLE
);

512 
	`lua_pushv®ue
(
L
, -1);

513 
	`lua_£tf›ld
(
L
, -2, "__index");

514 
	`luaL_»gi¡”
(
L
, 
NULL
, 
æib
);

515 
	}
}

518 
	$ü—‹¡dfe
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
k
, cÚ¡ *
âame
) {

519 *
	`Ãwfe
(
L
èğ
f
;

520 ià(
k
 > 0) {

521 
	`lua_pushv®ue
(
L
, -1);

522 
	`lua_¿w£ti
(
L
, 
LUA_ENVIRONINDEX
, 
k
);

524 
	`lua_pushv®ue
(
L
, -2);

525 
	`lua_£tãnv
(
L
, -2);

526 
	`lua_£tf›ld
(
L
, -3, 
âame
);

527 
	}
}

530 
	$Ãwãnv
 (
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
şs
) {

531 
	`lua_ü—‹bË
(
L
, 0, 1);

532 
	`lua_pushcfunùiÚ
(
L
, 
şs
);

533 
	`lua_£tf›ld
(
L
, -2, "__close");

534 
	}
}

537 
LUALIB_API
 
	$luaİ’_io
 (
lua_S‹
 *
L
) {

538 
	`ü—‹m‘a
(
L
);

540 
	`Ãwãnv
(
L
, 
io_fşo£
);

541 
	`lua_»¶aû
(
L
, 
LUA_ENVIRONINDEX
);

543 
	`luaL_»gi¡”
(
L
, 
LUA_IOLIBNAME
, 
iŞib
);

545 
	`Ãwãnv
(
L
, 
io_noşo£
);

546 
	`ü—‹¡dfe
(
L
, 
¡dš
, 
IO_INPUT
, "stdin");

547 
	`ü—‹¡dfe
(
L
, 
¡dout
, 
IO_OUTPUT
, "stdout");

548 
	`ü—‹¡dfe
(
L
, 
¡d”r
, 0, "stderr");

549 
	`lua_pİ
(
L
, 1);

550 
	`lua_g‘f›ld
(
L
, -1, "popen");

551 
	`Ãwãnv
(
L
, 
io_pşo£
);

552 
	`lua_£tãnv
(
L
, -2);

553 
	`lua_pİ
(
L
, 1);

555 
	}
}

	@deps/lua/src/llex.c

8 
	~<ùy³.h
>

9 
	~<loÿË.h
>

10 
	~<¡ršg.h
>

12 
	#Îex_c


	)

13 
	#LUA_CORE


	)

15 
	~"lua.h
"

17 
	~"ldo.h
"

18 
	~"Îex.h
"

19 
	~"lobjeù.h
"

20 
	~"Í¬£r.h
"

21 
	~"l¡©e.h
"

22 
	~"l¡ršg.h
"

23 
	~"ÉabË.h
"

24 
	~"lzio.h
"

28 
	#Ãxt
(
ls
èÖs->
cu¼’t
 = 
	`zg‘c
Ös->
z
))

	)

33 
	#cu¼IsNewlše
(
ls
èÖs->
cu¼’t
 =ğ'\n' ||†s->cu¼’ˆ=ğ'\r')

	)

37 cÚ¡ *cÚ¡ 
	gluaX_tok’s
 [] = {

44 
NULL


48 
	#§ve_ªd_Ãxt
(
ls
è(
	`§ve
Ös,†s->
cu¼’t
), 
	`Ãxt
Ös))

	)

51 
	$§ve
 (
LexS‹
 *
ls
, 
c
) {

52 
Mbufãr
 *
b
 = 
ls
->
buff
;

53 ià(
b
->
n
 + 1 > b->
buffsize
) {

54 
size_t
 
Ãwsize
;

55 ià(
b
->
buffsize
 >ğ
MAX_SIZET
/2)

56 
	`luaX_Ëx”rÜ
(
ls
, "lexicalƒlementoo†ong", 0);

57 
Ãwsize
 = 
b
->
buffsize
 * 2;

58 
	`luaZ_»sizebufãr
(
ls
->
L
, 
b
, 
Ãwsize
);

60 
b
->
bufãr
[b->
n
++] = 
	`ÿ¡
(, 
c
);

61 
	}
}

64 
	$luaX_š™
 (
lua_S‹
 *
L
) {

65 
i
;

66 
i
=0; i<
NUM_RESERVED
; i++) {

67 
TSŒšg
 *
ts
 = 
	`luaS_Ãw
(
L
, 
luaX_tok’s
[
i
]);

68 
	`luaS_fix
(
ts
);

69 
	`lua_as£¹
(
	`¡¾’
(
luaX_tok’s
[
i
])+1 <ğ
TOKEN_LEN
);

70 
ts
->
tsv
.
»£rved
 = 
	`ÿ¡_by‹
(
i
+1);

72 
	}
}

75 
	#MAXSRC
 80

	)

78 cÚ¡ *
	$luaX_tok’2¡r
 (
LexS‹
 *
ls
, 
tok’
) {

79 ià(
tok’
 < 
FIRST_RESERVED
) {

80 
	`lua_as£¹
(
tok’
 =ğ
	`ÿ¡
(,oken));

81  (
	`isúŒl
(
tok’
)è? 
	`luaO_pushf¡ršg
(
ls
->
L
, "char(%d)",oken) :

82 
	`luaO_pushf¡ršg
(
ls
->
L
, "%c", 
tok’
);

85  
luaX_tok’s
[
tok’
-
FIRST_RESERVED
];

86 
	}
}

89 cÚ¡ *
	$txtTok’
 (
LexS‹
 *
ls
, 
tok’
) {

90 
tok’
) {

91 
TK_NAME
:

92 
TK_STRING
:

93 
TK_NUMBER
:

94 
	`§ve
(
ls
, '\0');

95  
	`luaZ_bufãr
(
ls
->
buff
);

97  
	`luaX_tok’2¡r
(
ls
, 
tok’
);

99 
	}
}

102 
	$luaX_Ëx”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
msg
, 
tok’
) {

103 
buff
[
MAXSRC
];

104 
	`luaO_chunkid
(
buff
, 
	`g‘¡r
(
ls
->
sourû
), 
MAXSRC
);

105 
msg
 = 
	`luaO_pushf¡ršg
(
ls
->
L
, "%s:%d: %s", 
buff
,†s->
lš’umb”
, msg);

106 ià(
tok’
)

107 
	`luaO_pushf¡ršg
(
ls
->
L
, "% Ã¬ " 
LUA_QS
, 
msg
, 
	`txtTok’
Ös, 
tok’
));

108 
	`luaD_throw
(
ls
->
L
, 
LUA_ERRSYNTAX
);

109 
	}
}

112 
	$luaX_syÁax”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
msg
) {

113 
	`luaX_Ëx”rÜ
(
ls
, 
msg
,†s->
t
.
tok’
);

114 
	}
}

117 
TSŒšg
 *
	$luaX_Ãw¡ršg
 (
LexS‹
 *
ls
, cÚ¡ *
¡r
, 
size_t
 
l
) {

118 
lua_S‹
 *
L
 = 
ls
->L;

119 
TSŒšg
 *
ts
 = 
	`luaS_Ãwl¡r
(
L
, 
¡r
, 
l
);

120 
TV®ue
 *
o
 = 
	`luaH_£t¡r
(
L
, 
ls
->
fs
->
h
, 
ts
);

121 ià(
	`‰i¢
(
o
)) {

122 
	`£tbv®ue
(
o
, 1);

123 
	`luaC_checkGC
(
L
);

125  
ts
;

126 
	}
}

129 
	$šşš’umb”
 (
LexS‹
 *
ls
) {

130 
Şd
 = 
ls
->
cu¼’t
;

131 
	`lua_as£¹
(
	`cu¼IsNewlše
(
ls
));

132 
	`Ãxt
(
ls
);

133 ià(
	`cu¼IsNewlše
(
ls
è&&†s->
cu¼’t
 !ğ
Şd
)

134 
	`Ãxt
(
ls
);

135 ià(++
ls
->
lš’umb”
 >ğ
MAX_INT
)

136 
	`luaX_syÁax”rÜ
(
ls
, "chunk hasoo many†ines");

137 
	}
}

140 
	$luaX_£tšput
 (
lua_S‹
 *
L
, 
LexS‹
 *
ls
, 
ZIO
 *
z
, 
TSŒšg
 *
sourû
) {

141 
ls
->
deıošt
 = '.';

142 
ls
->
L
 = L;

143 
ls
->
lookah—d
.
tok’
 = 
TK_EOS
;

144 
ls
->
z
 = z;

145 
ls
->
fs
 = 
NULL
;

146 
ls
->
lš’umb”
 = 1;

147 
ls
->
Ï¡lše
 = 1;

148 
ls
->
sourû
 = source;

149 
	`luaZ_»sizebufãr
(
ls
->
L
,†s->
buff
, 
LUA_MINBUFFER
);

150 
	`Ãxt
(
ls
);

151 
	}
}

163 
	$check_Ãxt
 (
LexS‹
 *
ls
, cÚ¡ *
£t
) {

164 ià(!
	`¡rchr
(
£t
, 
ls
->
cu¼’t
))

166 
	`§ve_ªd_Ãxt
(
ls
);

168 
	}
}

171 
	$bufä•Ïû
 (
LexS‹
 *
ls
, 
äom
, 
to
) {

172 
size_t
 
n
 = 
	`luaZ_bufæ’
(
ls
->
buff
);

173 *
p
 = 
	`luaZ_bufãr
(
ls
->
buff
);

174 
n
--)

175 ià(
p
[
n
] =ğ
äom
èp[n] = 
to
;

176 
	}
}

179 
	$Œydeıošt
 (
LexS‹
 *
ls
, 
SemInfo
 *
£mšfo
) {

181 
lcÚv
 *
cv
 = 
	`loÿËcÚv
();

182 
Şd
 = 
ls
->
deıošt
;

183 
ls
->
deıošt
 = (
cv
 ? cv->
decim®_pošt
[0] : '.');

184 
	`bufä•Ïû
(
ls
, 
Şd
,†s->
deıošt
);

185 ià(!
	`luaO_¡r2d
(
	`luaZ_bufãr
(
ls
->
buff
), &
£mšfo
->
r
)) {

187 
	`bufä•Ïû
(
ls
,†s->
deıošt
, '.');

188 
	`luaX_Ëx”rÜ
(
ls
, "m®fÜmed‚umb”", 
TK_NUMBER
);

190 
	}
}

194 
	$»ad_num”®
 (
LexS‹
 *
ls
, 
SemInfo
 *
£mšfo
) {

195 
	`lua_as£¹
(
	`isdig™
(
ls
->
cu¼’t
));

197 
	`§ve_ªd_Ãxt
(
ls
);

198 } 
	`isdig™
(
ls
->
cu¼’t
) ||†s->current == '.');

199 ià(
	`check_Ãxt
(
ls
, "Ee"))

200 
	`check_Ãxt
(
ls
, "+-");

201 
	`i§Êum
(
ls
->
cu¼’t
) ||†s->current == '_')

202 
	`§ve_ªd_Ãxt
(
ls
);

203 
	`§ve
(
ls
, '\0');

204 
	`bufä•Ïû
(
ls
, '.',†s->
deıošt
);

205 ià(!
	`luaO_¡r2d
(
	`luaZ_bufãr
(
ls
->
buff
), &
£mšfo
->
r
))

206 
	`Œydeıošt
(
ls
, 
£mšfo
);

207 
	}
}

210 
	$sk_£p
 (
LexS‹
 *
ls
) {

211 
couÁ
 = 0;

212 
s
 = 
ls
->
cu¼’t
;

213 
	`lua_as£¹
(
s
 == '[' || s == ']');

214 
	`§ve_ªd_Ãxt
(
ls
);

215 
ls
->
cu¼’t
 == '=') {

216 
	`§ve_ªd_Ãxt
(
ls
);

217 
couÁ
++;

219  (
ls
->
cu¼’t
 =ğ
s
è? 
couÁ
 : (-count) - 1;

220 
	}
}

223 
	$»ad_lÚg_¡ršg
 (
LexS‹
 *
ls
, 
SemInfo
 *
£mšfo
, 
£p
) {

224 
cÚt
 = 0;

225 ()(
cÚt
);

226 
	`§ve_ªd_Ãxt
(
ls
);

227 ià(
	`cu¼IsNewlše
(
ls
))

228 
	`šşš’umb”
(
ls
);

230 
ls
->
cu¼’t
) {

231 
EOZ
:

232 
	`luaX_Ëx”rÜ
(
ls
, (
£mšfo
) ? "unfinished†ong string" :

233 "unfšished†Úg comm’t", 
TK_EOS
);

235 #ià
	`defšed
(
LUA_COMPAT_LSTR
)

237 ià(
	`sk_£p
(
ls
è=ğ
£p
) {

238 
	`§ve_ªd_Ãxt
(
ls
);

239 
cÚt
++;

240 #ià
LUA_COMPAT_LSTR
 == 1

241 ià(
£p
 == 0)

242 
	`luaX_Ëx”rÜ
(
ls
, "nesting of [[...]] is deprecated", '[');

249 ià(
	`sk_£p
(
ls
è=ğ
£p
) {

250 
	`§ve_ªd_Ãxt
(
ls
);

251 #ià
	`defšed
(
LUA_COMPAT_LSTR
) && LUA_COMPAT_LSTR == 2

252 
cÚt
--;

253 ià(
£p
 =ğ0 && 
cÚt
 >= 0) ;

255 
’dloİ
;

261 
	`§ve
(
ls
, '\n');

262 
	`šşš’umb”
(
ls
);

263 ià(!
£mšfo
è
	`luaZ_»£tbufãr
(
ls
->
buff
);

267 ià(
£mšfo
è
	`§ve_ªd_Ãxt
(
ls
);

268 
	`Ãxt
(
ls
);

271 } 
’dloİ
:

272 ià(
£mšfo
)

273 
£mšfo
->
ts
 = 
	`luaX_Ãw¡ršg
(
ls
, 
	`luaZ_bufãr
Ös->
buff
è+ (2 + 
£p
),

274 
	`luaZ_bufæ’
(
ls
->
buff
è- 2*(2 + 
£p
));

275 
	}
}

278 
	$»ad_¡ršg
 (
LexS‹
 *
ls
, 
d–
, 
SemInfo
 *
£mšfo
) {

279 
	`§ve_ªd_Ãxt
(
ls
);

280 
ls
->
cu¼’t
 !ğ
d–
) {

281 
ls
->
cu¼’t
) {

282 
EOZ
:

283 
	`luaX_Ëx”rÜ
(
ls
, "unfšished sŒšg", 
TK_EOS
);

287 
	`luaX_Ëx”rÜ
(
ls
, "unfšished sŒšg", 
TK_STRING
);

290 
c
;

291 
	`Ãxt
(
ls
);

292 
ls
->
cu¼’t
) {

293 'a': 
c
 = '\a'; ;

294 'b': 
c
 = '\b'; ;

295 'f': 
c
 = '\f'; ;

296 'n': 
c
 = '\n'; ;

297 'r': 
c
 = '\r'; ;

298 't': 
c
 = '\t'; ;

299 'v': 
c
 = '\v'; ;

301 '\r': 
	`§ve
(
ls
, '\n'); 
	`šşš’umb”
(ls); ;

302 
EOZ
: ;

304 ià(!
	`isdig™
(
ls
->
cu¼’t
))

305 
	`§ve_ªd_Ãxt
(
ls
);

307 
i
 = 0;

308 
c
 = 0;

310 
c
 = 10*ø+ (
ls
->
cu¼’t
-'0');

311 
	`Ãxt
(
ls
);

312 } ++
i
<3 && 
	`isdig™
(
ls
->
cu¼’t
));

313 ià(
c
 > 
UCHAR_MAX
)

314 
	`luaX_Ëx”rÜ
(
ls
, "esÿ³ sequ’ûoØÏrge", 
TK_STRING
);

315 
	`§ve
(
ls
, 
c
);

320 
	`§ve
(
ls
, 
c
);

321 
	`Ãxt
(
ls
);

325 
	`§ve_ªd_Ãxt
(
ls
);

328 
	`§ve_ªd_Ãxt
(
ls
);

329 
£mšfo
->
ts
 = 
	`luaX_Ãw¡ršg
(
ls
, 
	`luaZ_bufãr
Ös->
buff
) + 1,

330 
	`luaZ_bufæ’
(
ls
->
buff
) - 2);

331 
	}
}

334 
	$Îex
 (
LexS‹
 *
ls
, 
SemInfo
 *
£mšfo
) {

335 
	`luaZ_»£tbufãr
(
ls
->
buff
);

337 
ls
->
cu¼’t
) {

340 
	`šşš’umb”
(
ls
);

344 
	`Ãxt
(
ls
);

345 ià(
ls
->
cu¼’t
 != '-')  '-';

347 
	`Ãxt
(
ls
);

348 ià(
ls
->
cu¼’t
 == '[') {

349 
£p
 = 
	`sk_£p
(
ls
);

350 
	`luaZ_»£tbufãr
(
ls
->
buff
);

351 ià(
£p
 >= 0) {

352 
	`»ad_lÚg_¡ršg
(
ls
, 
NULL
, 
£p
);

353 
	`luaZ_»£tbufãr
(
ls
->
buff
);

358 !
	`cu¼IsNewlše
(
ls
è&&†s->
cu¼’t
 !ğ
EOZ
)

359 
	`Ãxt
(
ls
);

363 
£p
 = 
	`sk_£p
(
ls
);

364 ià(
£p
 >= 0) {

365 
	`»ad_lÚg_¡ršg
(
ls
, 
£mšfo
, 
£p
);

366  
TK_STRING
;

368 ià(
£p
 == -1)  '[';

369 
	`luaX_Ëx”rÜ
(
ls
, "šv®id†Úg sŒšg d–im™”", 
TK_STRING
);

372 
	`Ãxt
(
ls
);

373 ià(
ls
->
cu¼’t
 != '=')  '=';

374 { 
	`Ãxt
(
ls
);  
TK_EQ
; }

377 
	`Ãxt
(
ls
);

378 ià(
ls
->
cu¼’t
 != '=')  '<';

379 { 
	`Ãxt
(
ls
);  
TK_LE
; }

382 
	`Ãxt
(
ls
);

383 ià(
ls
->
cu¼’t
 != '=')  '>';

384 { 
	`Ãxt
(
ls
);  
TK_GE
; }

387 
	`Ãxt
(
ls
);

388 ià(
ls
->
cu¼’t
 != '=')  '~';

389 { 
	`Ãxt
(
ls
);  
TK_NE
; }

393 
	`»ad_¡ršg
(
ls
,†s->
cu¼’t
, 
£mšfo
);

394  
TK_STRING
;

397 
	`§ve_ªd_Ãxt
(
ls
);

398 ià(
	`check_Ãxt
(
ls
, ".")) {

399 ià(
	`check_Ãxt
(
ls
, "."))

400  
TK_DOTS
;

401  
TK_CONCAT
;

403 ià(!
	`isdig™
(
ls
->
cu¼’t
))  '.';

405 
	`»ad_num”®
(
ls
, 
£mšfo
);

406  
TK_NUMBER
;

409 
EOZ
: {

410  
TK_EOS
;

413 ià(
	`is¥aû
(
ls
->
cu¼’t
)) {

414 
	`lua_as£¹
(!
	`cu¼IsNewlše
(
ls
));

415 
	`Ãxt
(
ls
);

418 ià(
	`isdig™
(
ls
->
cu¼’t
)) {

419 
	`»ad_num”®
(
ls
, 
£mšfo
);

420  
TK_NUMBER
;

422 ià(
	`i§Íha
(
ls
->
cu¼’t
) ||†s->current == '_') {

424 
TSŒšg
 *
ts
;

426 
	`§ve_ªd_Ãxt
(
ls
);

427 } 
	`i§Êum
(
ls
->
cu¼’t
) ||†s->current == '_');

428 
ts
 = 
	`luaX_Ãw¡ršg
(
ls
, 
	`luaZ_bufãr
Ös->
buff
),

429 
	`luaZ_bufæ’
(
ls
->
buff
));

430 ià(
ts
->
tsv
.
»£rved
 > 0)

431  
ts
->
tsv
.
»£rved
 - 1 + 
FIRST_RESERVED
;

433 
£mšfo
->
ts
 =s;

434  
TK_NAME
;

438 
c
 = 
ls
->
cu¼’t
;

439 
	`Ãxt
(
ls
);

440  
c
;

445 
	}
}

448 
	$luaX_Ãxt
 (
LexS‹
 *
ls
) {

449 
ls
->
Ï¡lše
 =†s->
lš’umb”
;

450 ià(
ls
->
lookah—d
.
tok’
 !ğ
TK_EOS
) {

451 
ls
->
t
 =†s->
lookah—d
;

452 
ls
->
lookah—d
.
tok’
 = 
TK_EOS
;

455 
ls
->
t
.
tok’
 = 
	`Îex
Ös, &ls->t.
£mšfo
);

456 
	}
}

459 
	$luaX_lookah—d
 (
LexS‹
 *
ls
) {

460 
	`lua_as£¹
(
ls
->
lookah—d
.
tok’
 =ğ
TK_EOS
);

461 
ls
->
lookah—d
.
tok’
 = 
	`Îex
Ös, &ls->lookah—d.
£mšfo
);

462 
	}
}

	@deps/lua/src/llex.h

7 #iâdeà
Îex_h


8 
	#Îex_h


	)

10 
	~"lobjeù.h
"

11 
	~"lzio.h
"

14 
	#FIRST_RESERVED
 257

	)

17 
	#TOKEN_LEN
 (("funùiÚ")/())

	)

24 
	eRESERVED
 {

26 
	mTK_AND
 = 
FIRST_RESERVED
, 
	mTK_BREAK
,

27 
	mTK_DO
, 
	mTK_ELSE
, 
	mTK_ELSEIF
, 
	mTK_END
, 
	mTK_FALSE
, 
	mTK_FOR
, 
	mTK_FUNCTION
,

28 
	mTK_IF
, 
	mTK_IN
, 
	mTK_LOCAL
, 
	mTK_NIL
, 
	mTK_NOT
, 
	mTK_OR
, 
	mTK_REPEAT
,

29 
	mTK_RETURN
, 
	mTK_THEN
, 
	mTK_TRUE
, 
	mTK_UNTIL
, 
	mTK_WHILE
,

31 
	mTK_CONCAT
, 
	mTK_DOTS
, 
	mTK_EQ
, 
	mTK_GE
, 
	mTK_LE
, 
	mTK_NE
, 
	mTK_NUMBER
,

32 
	mTK_NAME
, 
	mTK_STRING
, 
	mTK_EOS


36 
	#NUM_RESERVED
 (
	`ÿ¡
(, 
TK_WHILE
-
FIRST_RESERVED
+1))

	)

40 
LUAI_DATA
 cÚ¡ *cÚ¡ 
	gluaX_tok’s
 [];

44 
lua_Numb”
 
	mr
;

45 
TSŒšg
 *
	mts
;

46 } 
	tSemInfo
;

49 
	sTok’
 {

50 
	mtok’
;

51 
SemInfo
 
	m£mšfo
;

52 } 
	tTok’
;

55 
	sLexS‹
 {

56 
	mcu¼’t
;

57 
	mlš’umb”
;

58 
	mÏ¡lše
;

59 
Tok’
 
	mt
;

60 
Tok’
 
	mlookah—d
;

61 
FuncS‹
 *
	mfs
;

62 
lua_S‹
 *
	mL
;

63 
ZIO
 *
	mz
;

64 
Mbufãr
 *
	mbuff
;

65 
TSŒšg
 *
	msourû
;

66 
	mdeıošt
;

67 } 
	tLexS‹
;

70 
LUAI_FUNC
 
luaX_š™
 (
lua_S‹
 *
L
);

71 
LUAI_FUNC
 
luaX_£tšput
 (
lua_S‹
 *
L
, 
LexS‹
 *
ls
, 
ZIO
 *
z
,

72 
TSŒšg
 *
sourû
);

73 
LUAI_FUNC
 
TSŒšg
 *
luaX_Ãw¡ršg
 (
LexS‹
 *
ls
, cÚ¡ *
¡r
, 
size_t
 
l
);

74 
LUAI_FUNC
 
luaX_Ãxt
 (
LexS‹
 *
ls
);

75 
LUAI_FUNC
 
luaX_lookah—d
 (
LexS‹
 *
ls
);

76 
LUAI_FUNC
 
luaX_Ëx”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
msg
, 
tok’
);

77 
LUAI_FUNC
 
luaX_syÁax”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
s
);

78 
LUAI_FUNC
 cÚ¡ *
luaX_tok’2¡r
 (
LexS‹
 *
ls
, 
tok’
);

	@deps/lua/src/llimits.h

7 #iâdeà
Îim™s_h


8 
	#Îim™s_h


	)

11 
	~<lim™s.h
>

12 
	~<¡ddef.h
>

15 
	~"lua.h
"

18 
LUAI_UINT32
 
	tlu_št32
;

20 
LUAI_UMEM
 
	tlu_mem
;

22 
LUAI_MEM
 
	tl_mem
;

27 
	tlu_by‹
;

30 
	#MAX_SIZET
 ((
size_t
)(~(size_t)0)-2)

	)

32 
	#MAX_LUMEM
 ((
lu_mem
)(~Öu_mem)0)-2)

	)

35 
	#MAX_INT
 (
INT_MAX
-2è

	)

42 
	#IÁPošt
(
p
è(()(
lu_mem
)Õ))

	)

47 
LUAI_USER_ALIGNMENT_T
 
	tL_Umax®ign
;

51 
LUAI_UACNUMBER
 
	tl_uacNumb”
;

55 #ifdeà
lua_as£¹


57 
	#check_exp
(
c
,
e
è(
	`lua_as£¹
(c), (e))

	)

58 
	#­i_check
(
l
,
e
è
	`lua_as£¹
Ó)

	)

62 
	#lua_as£¹
(
c
è(()0)

	)

63 
	#check_exp
(
c
,
e
èÓ)

	)

64 
	#­i_check
 
luai_­icheck


	)

69 #iâdeà
UNUSED


70 
	#UNUSED
(
x
è(()(x)è

	)

74 #iâdeà
ÿ¡


75 
	#ÿ¡
(
t
, 
exp
è(Ñ)Óxp))

	)

78 
	#ÿ¡_by‹
(
i
è
	`ÿ¡
(
lu_by‹
, (i))

	)

79 
	#ÿ¡_num
(
i
è
	`ÿ¡
(
lua_Numb”
, (i))

	)

80 
	#ÿ¡_št
(
i
è
	`ÿ¡
(, (i))

	)

88 
lu_št32
 
	tIn¡ruùiÚ
;

93 
	#MAXSTACK
 250

	)

98 #iâdeà
MINSTRTABSIZE


99 
	#MINSTRTABSIZE
 32

	)

104 #iâdeà
LUA_MINBUFFER


105 
	#LUA_MINBUFFER
 32

	)

109 #iâdeà
lua_lock


110 
	#lua_lock
(
L
è((è0)

	)

111 
	#lua_uÆock
(
L
è((è0)

	)

114 #iâdeà
luai_th»ady›ld


115 
	#luai_th»ady›ld
(
L
è{
	`lua_uÆock
(L); 
	`lua_lock
(L);}

	)

122 #iâdeà
HARDSTACKTESTS


123 
	#cÚdh¬d¡ack‹¡s
(
x
è(()0)

	)

125 
	#cÚdh¬d¡ack‹¡s
(
x
è
	)
x

	@deps/lua/src/lmathlib.c

8 
	~<¡dlib.h
>

9 
	~<m©h.h
>

11 
	#lm©hlib_c


	)

12 
	#LUA_LIB


	)

14 
	~"lua.h
"

16 
	~"Ïuxlib.h
"

17 
	~"lu®ib.h
"

20 #undeà
PI


21 
	#PI
 (3.14159265358979323846)

	)

22 
	#RADIANS_PER_DEGREE
 (
PI
/180.0)

	)

26 
	$m©h_abs
 (
lua_S‹
 *
L
) {

27 
	`lua_pushnumb”
(
L
, 
	`çbs
(
	`luaL_checknumb”
(L, 1)));

29 
	}
}

31 
	$m©h_sš
 (
lua_S‹
 *
L
) {

32 
	`lua_pushnumb”
(
L
, 
	`sš
(
	`luaL_checknumb”
(L, 1)));

34 
	}
}

36 
	$m©h_sšh
 (
lua_S‹
 *
L
) {

37 
	`lua_pushnumb”
(
L
, 
	`sšh
(
	`luaL_checknumb”
(L, 1)));

39 
	}
}

41 
	$m©h_cos
 (
lua_S‹
 *
L
) {

42 
	`lua_pushnumb”
(
L
, 
	`cos
(
	`luaL_checknumb”
(L, 1)));

44 
	}
}

46 
	$m©h_cosh
 (
lua_S‹
 *
L
) {

47 
	`lua_pushnumb”
(
L
, 
	`cosh
(
	`luaL_checknumb”
(L, 1)));

49 
	}
}

51 
	$m©h_n
 (
lua_S‹
 *
L
) {

52 
	`lua_pushnumb”
(
L
, 
	`n
(
	`luaL_checknumb”
(L, 1)));

54 
	}
}

56 
	$m©h_nh
 (
lua_S‹
 *
L
) {

57 
	`lua_pushnumb”
(
L
, 
	`nh
(
	`luaL_checknumb”
(L, 1)));

59 
	}
}

61 
	$m©h_asš
 (
lua_S‹
 *
L
) {

62 
	`lua_pushnumb”
(
L
, 
	`asš
(
	`luaL_checknumb”
(L, 1)));

64 
	}
}

66 
	$m©h_acos
 (
lua_S‹
 *
L
) {

67 
	`lua_pushnumb”
(
L
, 
	`acos
(
	`luaL_checknumb”
(L, 1)));

69 
	}
}

71 
	$m©h_©ª
 (
lua_S‹
 *
L
) {

72 
	`lua_pushnumb”
(
L
, 
	`©ª
(
	`luaL_checknumb”
(L, 1)));

74 
	}
}

76 
	$m©h_©ª2
 (
lua_S‹
 *
L
) {

77 
	`lua_pushnumb”
(
L
, 
	`©ª2
(
	`luaL_checknumb”
(L, 1),†uaL_checknumber(L, 2)));

79 
	}
}

81 
	$m©h_û
 (
lua_S‹
 *
L
) {

82 
	`lua_pushnumb”
(
L
, 
	`û
(
	`luaL_checknumb”
(L, 1)));

84 
	}
}

86 
	$m©h_æoÜ
 (
lua_S‹
 *
L
) {

87 
	`lua_pushnumb”
(
L
, 
	`æoÜ
(
	`luaL_checknumb”
(L, 1)));

89 
	}
}

91 
	$m©h_fmod
 (
lua_S‹
 *
L
) {

92 
	`lua_pushnumb”
(
L
, 
	`fmod
(
	`luaL_checknumb”
(L, 1),†uaL_checknumber(L, 2)));

94 
	}
}

96 
	$m©h_modf
 (
lua_S‹
 *
L
) {

97 

;

98 
å
 = 
	`modf
(
	`luaL_checknumb”
(
L
, 1), &

);

99 
	`lua_pushnumb”
(
L
, 

);

100 
	`lua_pushnumb”
(
L
, 
å
);

102 
	}
}

104 
	$m©h_sq¹
 (
lua_S‹
 *
L
) {

105 
	`lua_pushnumb”
(
L
, 
	`sq¹
(
	`luaL_checknumb”
(L, 1)));

107 
	}
}

109 
	$m©h_pow
 (
lua_S‹
 *
L
) {

110 
	`lua_pushnumb”
(
L
, 
	`pow
(
	`luaL_checknumb”
(L, 1),†uaL_checknumber(L, 2)));

112 
	}
}

114 
	$m©h_log
 (
lua_S‹
 *
L
) {

115 
	`lua_pushnumb”
(
L
, 
	`log
(
	`luaL_checknumb”
(L, 1)));

117 
	}
}

119 
	$m©h_log10
 (
lua_S‹
 *
L
) {

120 
	`lua_pushnumb”
(
L
, 
	`log10
(
	`luaL_checknumb”
(L, 1)));

122 
	}
}

124 
	$m©h_exp
 (
lua_S‹
 *
L
) {

125 
	`lua_pushnumb”
(
L
, 
	`exp
(
	`luaL_checknumb”
(L, 1)));

127 
	}
}

129 
	$m©h_deg
 (
lua_S‹
 *
L
) {

130 
	`lua_pushnumb”
(
L
, 
	`luaL_checknumb”
(L, 1)/
RADIANS_PER_DEGREE
);

132 
	}
}

134 
	$m©h_¿d
 (
lua_S‹
 *
L
) {

135 
	`lua_pushnumb”
(
L
, 
	`luaL_checknumb”
(L, 1)*
RADIANS_PER_DEGREE
);

137 
	}
}

139 
	$m©h_äexp
 (
lua_S‹
 *
L
) {

140 
e
;

141 
	`lua_pushnumb”
(
L
, 
	`äexp
(
	`luaL_checknumb”
(L, 1), &
e
));

142 
	`lua_pushš‹g”
(
L
, 
e
);

144 
	}
}

146 
	$m©h_ldexp
 (
lua_S‹
 *
L
) {

147 
	`lua_pushnumb”
(
L
, 
	`ldexp
(
	`luaL_checknumb”
(L, 1), 
	`luaL_checkšt
(L, 2)));

149 
	}
}

153 
	$m©h_mš
 (
lua_S‹
 *
L
) {

154 
n
 = 
	`lua_g‘tİ
(
L
);

155 
lua_Numb”
 
dmš
 = 
	`luaL_checknumb”
(
L
, 1);

156 
i
;

157 
i
=2; i<=
n
; i++) {

158 
lua_Numb”
 
d
 = 
	`luaL_checknumb”
(
L
, 
i
);

159 ià(
d
 < 
dmš
)

160 
dmš
 = 
d
;

162 
	`lua_pushnumb”
(
L
, 
dmš
);

164 
	}
}

167 
	$m©h_max
 (
lua_S‹
 *
L
) {

168 
n
 = 
	`lua_g‘tİ
(
L
);

169 
lua_Numb”
 
dmax
 = 
	`luaL_checknumb”
(
L
, 1);

170 
i
;

171 
i
=2; i<=
n
; i++) {

172 
lua_Numb”
 
d
 = 
	`luaL_checknumb”
(
L
, 
i
);

173 ià(
d
 > 
dmax
)

174 
dmax
 = 
d
;

176 
	`lua_pushnumb”
(
L
, 
dmax
);

178 
	}
}

181 
	$m©h_¿ndom
 (
lua_S‹
 *
L
) {

184 
lua_Numb”
 
r
 = (lua_Numb”)(
	`¿nd
()%
RAND_MAX
) / (lua_Number)RAND_MAX;

185 
	`lua_g‘tİ
(
L
)) {

187 
	`lua_pushnumb”
(
L
, 
r
);

191 
u
 = 
	`luaL_checkšt
(
L
, 1);

192 
	`luaL_¬gcheck
(
L
, 1<=
u
, 1, "interval isƒmpty");

193 
	`lua_pushnumb”
(
L
, 
	`æoÜ
(
r
*
u
)+1);

197 
l
 = 
	`luaL_checkšt
(
L
, 1);

198 
u
 = 
	`luaL_checkšt
(
L
, 2);

199 
	`luaL_¬gcheck
(
L
, 
l
<=
u
, 2, "interval isƒmpty");

200 
	`lua_pushnumb”
(
L
, 
	`æoÜ
(
r
*(
u
-
l
+1))+l);

203 :  
	`luaL_”rÜ
(
L
, "wrong‚umber of‡rguments");

206 
	}
}

209 
	$m©h_¿ndom£ed
 (
lua_S‹
 *
L
) {

210 
	`¤ªd
(
	`luaL_checkšt
(
L
, 1));

212 
	}
}

215 cÚ¡ 
luaL_Reg
 
	gm©hlib
[] = {

216 {"abs", 
m©h_abs
},

217 {"acos", 
m©h_acos
},

218 {"asš", 
m©h_asš
},

219 {"©ª2", 
m©h_©ª2
},

220 {"©ª", 
m©h_©ª
},

221 {"û", 
m©h_û
},

222 {"cosh", 
m©h_cosh
},

223 {"cos", 
m©h_cos
},

224 {"deg", 
m©h_deg
},

225 {"exp", 
m©h_exp
},

226 {"æoÜ", 
m©h_æoÜ
},

227 {"fmod", 
m©h_fmod
},

228 {"äexp", 
m©h_äexp
},

229 {"ldexp", 
m©h_ldexp
},

230 {"log10", 
m©h_log10
},

231 {"log", 
m©h_log
},

232 {"max", 
m©h_max
},

233 {"mš", 
m©h_mš
},

234 {"modf", 
m©h_modf
},

235 {"pow", 
m©h_pow
},

236 {"¿d", 
m©h_¿d
},

237 {"¿ndom", 
m©h_¿ndom
},

238 {"¿ndom£ed", 
m©h_¿ndom£ed
},

239 {"sšh", 
m©h_sšh
},

240 {"sš", 
m©h_sš
},

241 {"sq¹", 
m©h_sq¹
},

242 {"nh", 
m©h_nh
},

243 {"n", 
m©h_n
},

244 {
NULL
, NULL}

251 
LUALIB_API
 
	$luaİ’_m©h
 (
lua_S‹
 *
L
) {

252 
	`luaL_»gi¡”
(
L
, 
LUA_MATHLIBNAME
, 
m©hlib
);

253 
	`lua_pushnumb”
(
L
, 
PI
);

254 
	`lua_£tf›ld
(
L
, -2, "pi");

255 
	`lua_pushnumb”
(
L
, 
HUGE_VAL
);

256 
	`lua_£tf›ld
(
L
, -2, "huge");

257 #ià
	`defšed
(
LUA_COMPAT_MOD
)

258 
	`lua_g‘f›ld
(
L
, -1, "fmod");

259 
	`lua_£tf›ld
(
L
, -2, "mod");

262 
	}
}

	@deps/lua/src/lmem.c

8 
	~<¡ddef.h
>

10 
	#lmem_c


	)

11 
	#LUA_CORE


	)

13 
	~"lua.h
"

15 
	~"ldebug.h
"

16 
	~"ldo.h
"

17 
	~"lmem.h
"

18 
	~"lobjeù.h
"

19 
	~"l¡©e.h
"

43 
	#MINSIZEARRAY
 4

	)

46 *
	$luaM_growaux_
 (
lua_S‹
 *
L
, *
block
, *
size
, 
size_t
 
size_–ems
,

47 
lim™
, cÚ¡ *
”rÜmsg
) {

48 *
Ãwblock
;

49 
Ãwsize
;

50 ià(*
size
 >ğ
lim™
/2) {

51 ià(*
size
 >ğ
lim™
)

52 
	`luaG_ruÃ¼Ü
(
L
, 
”rÜmsg
);

53 
Ãwsize
 = 
lim™
;

56 
Ãwsize
 = (*
size
)*2;

57 ià(
Ãwsize
 < 
MINSIZEARRAY
)

58 
Ãwsize
 = 
MINSIZEARRAY
;

60 
Ãwblock
 = 
	`luaM_»®locv
(
L
, 
block
, *
size
, 
Ãwsize
, 
size_–ems
);

61 *
size
 = 
Ãwsize
;

62  
Ãwblock
;

63 
	}
}

66 *
	$luaM_toobig
 (
lua_S‹
 *
L
) {

67 
	`luaG_ruÃ¼Ü
(
L
, "memory‡llocationƒrror: blockoo big");

68  
NULL
;

69 
	}
}

76 *
	$luaM_»®loc_
 (
lua_S‹
 *
L
, *
block
, 
size_t
 
osize
, size_ˆ
nsize
) {

77 
glob®_S‹
 *
g
 = 
	`G
(
L
);

78 
	`lua_as£¹
((
osize
 =ğ0è=ğ(
block
 =ğ
NULL
));

79 
block
 = (*
g
->
ä—Îoc
)(g->
ud
, block, 
osize
, 
nsize
);

80 ià(
block
 =ğ
NULL
 && 
nsize
 > 0)

81 
	`luaD_throw
(
L
, 
LUA_ERRMEM
);

82 
	`lua_as£¹
((
nsize
 =ğ0è=ğ(
block
 =ğ
NULL
));

83 
g
->
tÙ®by‹s
 = (g->tÙ®by‹ - 
osize
è+ 
nsize
;

84  
block
;

85 
	}
}

	@deps/lua/src/lmem.h

7 #iâdeà
lmem_h


8 
	#lmem_h


	)

11 
	~<¡ddef.h
>

13 
	~"Îim™s.h
"

14 
	~"lua.h
"

16 
	#MEMERRMSG
 "nÙƒnough memÜy"

	)

19 
	#luaM_»®locv
(
L
,
b
,
Ú
,
n
,
e
) \

20 ((
	`ÿ¡
(
size_t
, (
n
)+1è<ğ
MAX_SIZET
/(
e
)) ? \

21 
	`luaM_»®loc_
(
L
, (
b
), (
Ú
)*(
e
), (
n
)*(e)) : \

22 
	`luaM_toobig
(
L
))

	)

24 
	#luaM_ä“mem
(
L
, 
b
, 
s
è
	`luaM_»®loc_
(L, (b), (s), 0)

	)

25 
	#luaM_ä“
(
L
, 
b
è
	`luaM_»®loc_
(L, (b), (*(b)), 0)

	)

26 
	#luaM_ä“¬¿y
(
L
, 
b
, 
n
, 
t
è
	`luaM_»®locv
(L, (b),‚, 0, Ñ))

	)

28 
	#luaM_m®loc
(
L
,
t
è
	`luaM_»®loc_
(L, 
NULL
, 0, (t))

	)

29 
	#luaM_Ãw
(
L
,
t
è
	`ÿ¡
Ñ *, 
	`luaM_m®loc
(L, Ñ)))

	)

30 
	#luaM_ÃwveùÜ
(
L
,
n
,
t
) \

31 
	`ÿ¡
(
t
 *, 
	`luaM_»®locv
(
L
, 
NULL
, 0, 
n
, Ñ)))

	)

33 
	#luaM_growveùÜ
(
L
,
v
,
ÃËms
,
size
,
t
,
lim™
,
e
) \

34 ià((
ÃËms
)+1 > (
size
)) \

35 ((
v
)=
	`ÿ¡
(
t
 *, 
	`luaM_growaux_
(
L
,v,&(
size
),Ñ),
lim™
,
e
)))

	)

37 
	#luaM_»®locveùÜ
(
L
, 
v
,
Şdn
,
n
,
t
) \

38 ((
v
)=
	`ÿ¡
(
t
 *, 
	`luaM_»®locv
(
L
, v, 
Şdn
, 
n
, Ñ))))

	)

41 
LUAI_FUNC
 *
luaM_»®loc_
 (
lua_S‹
 *
L
, *
block
, 
size_t
 
Şdsize
,

42 
size_t
 
size
);

43 
LUAI_FUNC
 *
luaM_toobig
 (
lua_S‹
 *
L
);

44 
LUAI_FUNC
 *
luaM_growaux_
 (
lua_S‹
 *
L
, *
block
, *
size
,

45 
size_t
 
size_–em
, 
lim™
,

46 cÚ¡ *
”rÜmsg
);

	@deps/lua/src/loadlib.c

12 
	~<¡dlib.h
>

13 
	~<¡ršg.h
>

16 
	#lßdlib_c


	)

17 
	#LUA_LIB


	)

19 
	~"lua.h
"

21 
	~"Ïuxlib.h
"

22 
	~"lu®ib.h
"

26 
	#LUA_POF
 "luaİ’_"

	)

29 
	#LUA_OFSEP
 "_"

	)

32 
	#LIBPREFIX
 "LOADLIB: "

	)

34 
	#POF
 
LUA_POF


	)

35 
	#LIB_FAIL
 "İ’"

	)

39 
	#ERRLIB
 1

	)

40 
	#ERRFUNC
 2

	)

42 
	#£rogdœ
(
L
è(()0)

	)

45 
Î_uÆßdlib
 (*
lib
);

46 *
Î_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
);

47 
lua_CFunùiÚ
 
Î_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
);

51 #ià
defšed
(
LUA_DL_DLOPEN
)

61 
	~<dlfú.h
>

63 
	$Î_uÆßdlib
 (*
lib
) {

64 
	`dlşo£
(
lib
);

65 
	}
}

68 *
	$Î_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
) {

69 *
lib
 = 
	`dlİ’
(
·th
, 
RTLD_NOW
);

70 ià(
lib
 =ğ
NULL
è
	`lua_push¡ršg
(
L
, 
	`dË¼Ü
());

71  
lib
;

72 
	}
}

75 
lua_CFunùiÚ
 
	$Î_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
) {

76 
lua_CFunùiÚ
 
f
 = (lua_CFunùiÚ)
	`dlsym
(
lib
, 
sym
);

77 ià(
f
 =ğ
NULL
è
	`lua_push¡ršg
(
L
, 
	`dË¼Ü
());

78  
f
;

79 
	}
}

85 #–ià
defšed
(
LUA_DL_DLL
)

92 
	~<wšdows.h
>

95 #undeà
£rogdœ


97 
	$£rogdœ
 (
lua_S‹
 *
L
) {

98 
buff
[
MAX_PATH
 + 1];

99 *
lb
;

100 
DWORD
 
nsize
 = (
buff
)/();

101 
DWORD
 
n
 = 
	`G‘ModuËFeNameA
(
NULL
, 
buff
, 
nsize
);

102 ià(
n
 =ğ0 ||‚ =ğ
nsize
 || (
lb
 = 
	`¡¼chr
(
buff
, '\\')è=ğ
NULL
)

103 
	`luaL_”rÜ
(
L
, "unableo get ModuleFileName");

105 *
lb
 = '\0';

106 
	`luaL_gsub
(
L
, 
	`lua_to¡ršg
(L, -1), 
LUA_EXECDIR
, 
buff
);

107 
	`lua_»move
(
L
, -2);

109 
	}
}

112 
	$push”rÜ
 (
lua_S‹
 *
L
) {

113 
”rÜ
 = 
	`G‘La¡E¼Ü
();

114 
bufãr
[128];

115 ià(
	`FÜm©Mes§geA
(
FORMAT_MESSAGE_IGNORE_INSERTS
 | 
FORMAT_MESSAGE_FROM_SYSTEM
,

116 
NULL
, 
”rÜ
, 0, 
bufãr
, (buffer), NULL))

117 
	`lua_push¡ršg
(
L
, 
bufãr
);

119 
	`lua_pushf¡ršg
(
L
, "sy¡emƒ¼Ü %d\n", 
”rÜ
);

120 
	}
}

122 
	$Î_uÆßdlib
 (*
lib
) {

123 
	`F»eLib¿ry
((
HINSTANCE
)
lib
);

124 
	}
}

127 *
	$Î_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
) {

128 
HINSTANCE
 
lib
 = 
	`LßdLib¿ryA
(
·th
);

129 ià(
lib
 =ğ
NULL
è
	`push”rÜ
(
L
);

130  
lib
;

131 
	}
}

134 
lua_CFunùiÚ
 
	$Î_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
) {

135 
lua_CFunùiÚ
 
f
 = (lua_CFunùiÚ)
	`G‘ProcAdd»ss
((
HINSTANCE
)
lib
, 
sym
);

136 ià(
f
 =ğ
NULL
è
	`push”rÜ
(
L
);

137  
f
;

138 
	}
}

144 #–ià
defšed
(
LUA_DL_DYLD
)

151 
	~<mach-o/dyld.h
>

155 #undeà
POF


156 
	#POF
 "_" 
LUA_POF


	)

159 
	$push”rÜ
 (
lua_S‹
 *
L
) {

160 cÚ¡ *
”r_¡r
;

161 cÚ¡ *
”r_fe
;

162 
NSLškEd™E¼Üs
 
”r
;

163 
”r_num
;

164 
	`NSLškEd™E¼Ü
(&
”r
, &
”r_num
, &
”r_fe
, &
”r_¡r
);

165 
	`lua_push¡ršg
(
L
, 
”r_¡r
);

166 
	}
}

169 cÚ¡ *
	$”rÜäomcode
 (
NSObjeùFeImageR‘uºCode
 
»t
) {

170 
»t
) {

171 
NSObjeùFeImageIÇµrİrŸ‹Fe
:

173 
NSObjeùFeImageArch
:

175 
NSObjeùFeImageFÜm©
:

177 
NSObjeùFeImageAcûss
:

179 
NSObjeùFeImageFau»
:

183 
	}
}

186 
	$Î_uÆßdlib
 (*
lib
) {

187 
	`NSUnLškModuË
((
NSModuË
)
lib
, 
NSUNLINKMODULE_OPTION_RESET_LAZY_REFERENCES
);

188 
	}
}

191 *
	$Î_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
) {

192 
NSObjeùFeImage
 
img
;

193 
NSObjeùFeImageR‘uºCode
 
»t
;

195 if(!
	`_dyld_´e£Á
()) {

196 
	`lua_pushl™”®
(
L
, "dyld‚ot…resent");

197  
NULL
;

199 
»t
 = 
	`NSC»©eObjeùFeImageFromFe
(
·th
, &
img
);

200 ià(
»t
 =ğ
NSObjeùFeImageSucûss
) {

201 
NSModuË
 
mod
 = 
	`NSLškModuË
(
img
, 
·th
, 
NSLINKMODULE_OPTION_PRIVATE
 |

202 
NSLINKMODULE_OPTION_RETURN_ON_ERROR
);

203 
	`NSDe¡royObjeùFeImage
(
img
);

204 ià(
mod
 =ğ
NULL
è
	`push”rÜ
(
L
);

205  
mod
;

207 
	`lua_push¡ršg
(
L
, 
	`”rÜäomcode
(
»t
));

208  
NULL
;

209 
	}
}

212 
lua_CFunùiÚ
 
	$Î_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
) {

213 
NSSymbŞ
 
nss
 = 
	`NSLookupSymbŞInModuË
((
NSModuË
)
lib
, 
sym
);

214 ià(
nss
 =ğ
NULL
) {

215 
	`lua_pushf¡ršg
(
L
, "symbŞ " 
LUA_QS
 "‚Ù found", 
sym
);

216  
NULL
;

218  (
lua_CFunùiÚ
)
	`NSAdd»ssOfSymbŞ
(
nss
);

219 
	}
}

232 #undeà
LIB_FAIL


233 
	#LIB_FAIL
 "ab£Á"

	)

236 
	#DLMSG
 "dyÇmiølib¿r› nÙƒÇbËd; check you¸Lu¨š¡®ÏtiÚ"

	)

239 
	$Î_uÆßdlib
 (*
lib
) {

240 ()
lib
;

241 
	}
}

244 *
	$Î_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
) {

245 ()
·th
;

246 
	`lua_pushl™”®
(
L
, 
DLMSG
);

247  
NULL
;

248 
	}
}

251 
lua_CFunùiÚ
 
	$Î_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
) {

252 ()
lib
; ()
sym
;

253 
	`lua_pushl™”®
(
L
, 
DLMSG
);

254  
NULL
;

255 
	}
}

262 **
	$Î_»gi¡”
 (
lua_S‹
 *
L
, cÚ¡ *
·th
) {

263 **
¶ib
;

264 
	`lua_pushf¡ršg
(
L
, "%s%s", 
LIBPREFIX
, 
·th
);

265 
	`lua_g‘bË
(
L
, 
LUA_REGISTRYINDEX
);

266 ià(!
	`lua_i¢
(
L
, -1))

267 
¶ib
 = (**)
	`lua_tou£rd©a
(
L
, -1);

269 
	`lua_pİ
(
L
, 1);

270 
¶ib
 = (**)
	`lua_Ãwu£rd©a
(
L
, (const *));

271 *
¶ib
 = 
NULL
;

272 
	`luaL_g‘m‘©abË
(
L
, "_LOADLIB");

273 
	`lua_£tm‘©abË
(
L
, -2);

274 
	`lua_pushf¡ršg
(
L
, "%s%s", 
LIBPREFIX
, 
·th
);

275 
	`lua_pushv®ue
(
L
, -2);

276 
	`lua_£‰abË
(
L
, 
LUA_REGISTRYINDEX
);

278  
¶ib
;

279 
	}
}

286 
	$gùm
 (
lua_S‹
 *
L
) {

287 **
lib
 = (**)
	`luaL_checkud©a
(
L
, 1, "_LOADLIB");

288 ià(*
lib
è
	`Î_uÆßdlib
(*lib);

289 *
lib
 = 
NULL
;

291 
	}
}

294 
	$Î_lßdfunc
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, cÚ¡ *
sym
) {

295 **
»g
 = 
	`Î_»gi¡”
(
L
, 
·th
);

296 ià(*
»g
 =ğ
NULL
è*»g = 
	`Î_lßd
(
L
, 
·th
);

297 ià(*
»g
 =ğ
NULL
)

298  
ERRLIB
;

300 
lua_CFunùiÚ
 
f
 = 
	`Î_sym
(
L
, *
»g
, 
sym
);

301 ià(
f
 =ğ
NULL
)

302  
ERRFUNC
;

303 
	`lua_pushcfunùiÚ
(
L
, 
f
);

306 
	}
}

309 
	$Î_lßdlib
 (
lua_S‹
 *
L
) {

310 cÚ¡ *
·th
 = 
	`luaL_check¡ršg
(
L
, 1);

311 cÚ¡ *
š™
 = 
	`luaL_check¡ršg
(
L
, 2);

312 
¡©
 = 
	`Î_lßdfunc
(
L
, 
·th
, 
š™
);

313 ià(
¡©
 == 0)

316 
	`lua_pushn
(
L
);

317 
	`lua_š£¹
(
L
, -2);

318 
	`lua_push¡ršg
(
L
, (
¡©
 =ğ
ERRLIB
è? 
LIB_FAIL
 : "init");

321 
	}
}

332 
	$»adabË
 (cÚ¡ *
f’ame
) {

333 
FILE
 *
f
 = 
	`fİ’
(
f’ame
, "r");

334 ià(
f
 =ğ
NULL
)  0;

335 
	`fşo£
(
f
);

337 
	}
}

340 cÚ¡ *
	$pushÃx‰em¶©e
 (
lua_S‹
 *
L
, cÚ¡ *
·th
) {

341 cÚ¡ *
l
;

342 *
·th
 =ğ*
LUA_PATHSEP
)…ath++;

343 ià(*
·th
 =ğ'\0'è 
NULL
;

344 
l
 = 
	`¡rchr
(
·th
, *
LUA_PATHSEP
);

345 ià(
l
 =ğ
NULL
èÈğ
·th
 + 
	`¡¾’
(path);

346 
	`lua_pushl¡ršg
(
L
, 
·th
, 
l
 -…ath);

347  
l
;

348 
	}
}

351 cÚ¡ *
	$fšdfe
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
,

352 cÚ¡ *
²ame
) {

353 cÚ¡ *
·th
;

354 
Çme
 = 
	`luaL_gsub
(
L
,‚ame, ".", 
LUA_DIRSEP
);

355 
	`lua_g‘f›ld
(
L
, 
LUA_ENVIRONINDEX
, 
²ame
);

356 
·th
 = 
	`lua_to¡ršg
(
L
, -1);

357 ià(
·th
 =ğ
NULL
)

358 
	`luaL_”rÜ
(
L
, 
	`LUA_QL
("·ckage.%s"è" mu¡ b¨¡ršg", 
²ame
);

359 
	`lua_pushl™”®
(
L
, "");

360 (
·th
 = 
	`pushÃx‰em¶©e
(
L
,…©h)è!ğ
NULL
) {

361 cÚ¡ *
f’ame
;

362 
f’ame
 = 
	`luaL_gsub
(
L
, 
	`lua_to¡ršg
(L, -1), 
LUA_PATH_MARK
, 
Çme
);

363 
	`lua_»move
(
L
, -2);

364 ià(
	`»adabË
(
f’ame
))

365  
f’ame
;

366 
	`lua_pushf¡ršg
(
L
, "\n\ŠØf" 
LUA_QS
, 
f’ame
);

367 
	`lua_»move
(
L
, -2);

368 
	`lua_cÚÿt
(
L
, 2);

370  
NULL
;

371 
	}
}

374 
	$lßd”rÜ
 (
lua_S‹
 *
L
, cÚ¡ *
f’ame
) {

375 
	`luaL_”rÜ
(
L
, "”rÜ†ßdšg moduË " 
LUA_QS
 " from file " LUA_QS ":\n\t%s",

376 
	`lua_to¡ršg
(
L
, 1), 
f’ame
,†ua_tostring(L, -1));

377 
	}
}

380 
	$lßd”_Lua
 (
lua_S‹
 *
L
) {

381 cÚ¡ *
f’ame
;

382 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

383 
f’ame
 = 
	`fšdfe
(
L
, 
Çme
, "path");

384 ià(
f’ame
 =ğ
NULL
)  1;

385 ià(
	`luaL_lßdfe
(
L
, 
f’ame
) != 0)

386 
	`lßd”rÜ
(
L
, 
f’ame
);

388 
	}
}

391 cÚ¡ *
	$mkfunúame
 (
lua_S‹
 *
L
, cÚ¡ *
modÇme
) {

392 cÚ¡ *
funúame
;

393 cÚ¡ *
m¬k
 = 
	`¡rchr
(
modÇme
, *
LUA_IGMARK
);

394 ià(
m¬k
è
modÇme
 = mark + 1;

395 
funúame
 = 
	`luaL_gsub
(
L
, 
modÇme
, ".", 
LUA_OFSEP
);

396 
funúame
 = 
	`lua_pushf¡ršg
(
L
, 
POF
"%s", funcname);

397 
	`lua_»move
(
L
, -2);

398  
funúame
;

399 
	}
}

402 
	$lßd”_C
 (
lua_S‹
 *
L
) {

403 cÚ¡ *
funúame
;

404 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

405 cÚ¡ *
f’ame
 = 
	`fšdfe
(
L
, 
Çme
, "cpath");

406 ià(
f’ame
 =ğ
NULL
)  1;

407 
funúame
 = 
	`mkfunúame
(
L
, 
Çme
);

408 ià(
	`Î_lßdfunc
(
L
, 
f’ame
, 
funúame
) != 0)

409 
	`lßd”rÜ
(
L
, 
f’ame
);

411 
	}
}

414 
	$lßd”_CroÙ
 (
lua_S‹
 *
L
) {

415 cÚ¡ *
funúame
;

416 cÚ¡ *
f’ame
;

417 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

418 cÚ¡ *
p
 = 
	`¡rchr
(
Çme
, '.');

419 
¡©
;

420 ià(
p
 =ğ
NULL
)  0;

421 
	`lua_pushl¡ršg
(
L
, 
Çme
, 
p
 -‚ame);

422 
f’ame
 = 
	`fšdfe
(
L
, 
	`lua_to¡ršg
(L, -1), "cpath");

423 ià(
f’ame
 =ğ
NULL
)  1;

424 
funúame
 = 
	`mkfunúame
(
L
, 
Çme
);

425 ià((
¡©
 = 
	`Î_lßdfunc
(
L
, 
f’ame
, 
funúame
)) != 0) {

426 ià(
¡©
 !ğ
ERRFUNC
è
	`lßd”rÜ
(
L
, 
f’ame
);

427 
	`lua_pushf¡ršg
(
L
, "\n\ŠØmoduË " 
LUA_QS
 " in file " LUA_QS,

428 
Çme
, 
f’ame
);

432 
	}
}

435 
	$lßd”_´–ßd
 (
lua_S‹
 *
L
) {

436 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

437 
	`lua_g‘f›ld
(
L
, 
LUA_ENVIRONINDEX
, "preload");

438 ià(!
	`lua_i¡abË
(
L
, -1))

439 
	`luaL_”rÜ
(
L
, 
	`LUA_QL
("package.preload") " must be‡able");

440 
	`lua_g‘f›ld
(
L
, -1, 
Çme
);

441 ià(
	`lua_i¢
(
L
, -1))

442 
	`lua_pushf¡ršg
(
L
, "\n\ŠØf›ld…ackage.´–ßd['%s']", 
Çme
);

444 
	}
}

447 cÚ¡ 
	g£Áš–_
 = 0;

448 
	#£Áš–
 ((*)&
£Áš–_
)

	)

451 
	$Î_»quœe
 (
lua_S‹
 *
L
) {

452 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

453 
i
;

454 
	`lua_£‰İ
(
L
, 1);

455 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, "_LOADED");

456 
	`lua_g‘f›ld
(
L
, 2, 
Çme
);

457 ià(
	`lua_toboŞ—n
(
L
, -1)) {

458 ià(
	`lua_tou£rd©a
(
L
, -1è=ğ
£Áš–
)

459 
	`luaL_”rÜ
(
L
, "loİ o¸´eviou ”rÜ†ßdšg moduË " 
LUA_QS
, 
Çme
);

463 
	`lua_g‘f›ld
(
L
, 
LUA_ENVIRONINDEX
, "loaders");

464 ià(!
	`lua_i¡abË
(
L
, -1))

465 
	`luaL_”rÜ
(
L
, 
	`LUA_QL
("package.loaders") " must be‡able");

466 
	`lua_pushl™”®
(
L
, "");

467 
i
=1; ; i++) {

468 
	`lua_¿wg‘i
(
L
, -2, 
i
);

469 ià(
	`lua_i¢
(
L
, -1))

470 
	`luaL_”rÜ
(
L
, "moduË " 
LUA_QS
 "‚ot found:%s",

471 
Çme
, 
	`lua_to¡ršg
(
L
, -2));

472 
	`lua_push¡ršg
(
L
, 
Çme
);

473 
	`lua_ÿÎ
(
L
, 1, 1);

474 ià(
	`lua_isfunùiÚ
(
L
, -1))

476 ià(
	`lua_is¡ršg
(
L
, -1))

477 
	`lua_cÚÿt
(
L
, 2);

479 
	`lua_pİ
(
L
, 1);

481 
	`lua_pushlightu£rd©a
(
L
, 
£Áš–
);

482 
	`lua_£tf›ld
(
L
, 2, 
Çme
);

483 
	`lua_push¡ršg
(
L
, 
Çme
);

484 
	`lua_ÿÎ
(
L
, 1, 1);

485 ià(!
	`lua_i¢
(
L
, -1))

486 
	`lua_£tf›ld
(
L
, 2, 
Çme
);

487 
	`lua_g‘f›ld
(
L
, 2, 
Çme
);

488 ià(
	`lua_tou£rd©a
(
L
, -1è=ğ
£Áš–
) {

489 
	`lua_pushboŞ—n
(
L
, 1);

490 
	`lua_pushv®ue
(
L
, -1);

491 
	`lua_£tf›ld
(
L
, 2, 
Çme
);

494 
	}
}

507 
	$£tãnv
 (
lua_S‹
 *
L
) {

508 
lua_Debug
 
¬
;

509 ià(
	`lua_g‘¡ack
(
L
, 1, &
¬
) == 0 ||

510 
	`lua_g‘šfo
(
L
, "f", &
¬
) == 0 ||

511 
	`lua_iscfunùiÚ
(
L
, -1))

512 
	`luaL_”rÜ
(
L
, 
	`LUA_QL
("module") "‚ot called from‡ Lua function");

513 
	`lua_pushv®ue
(
L
, -2);

514 
	`lua_£tãnv
(
L
, -2);

515 
	`lua_pİ
(
L
, 1);

516 
	}
}

519 
	$doİtiÚs
 (
lua_S‹
 *
L
, 
n
) {

520 
i
;

521 
i
 = 2; i <ğ
n
; i++) {

522 
	`lua_pushv®ue
(
L
, 
i
);

523 
	`lua_pushv®ue
(
L
, -2);

524 
	`lua_ÿÎ
(
L
, 1, 0);

526 
	}
}

529 
	$modš™
 (
lua_S‹
 *
L
, cÚ¡ *
modÇme
) {

530 cÚ¡ *
dÙ
;

531 
	`lua_pushv®ue
(
L
, -1);

532 
	`lua_£tf›ld
(
L
, -2, "_M");

533 
	`lua_push¡ršg
(
L
, 
modÇme
);

534 
	`lua_£tf›ld
(
L
, -2, "_NAME");

535 
dÙ
 = 
	`¡¼chr
(
modÇme
, '.');

536 ià(
dÙ
 =ğ
NULL
èdÙ = 
modÇme
;

537 
dÙ
++;

539 
	`lua_pushl¡ršg
(
L
, 
modÇme
, 
dÙ
 - modname);

540 
	`lua_£tf›ld
(
L
, -2, "_PACKAGE");

541 
	}
}

544 
	$Î_moduË
 (
lua_S‹
 *
L
) {

545 cÚ¡ *
modÇme
 = 
	`luaL_check¡ršg
(
L
, 1);

546 
lßded
 = 
	`lua_g‘tİ
(
L
) + 1;

547 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, "_LOADED");

548 
	`lua_g‘f›ld
(
L
, 
lßded
, 
modÇme
);

549 ià(!
	`lua_i¡abË
(
L
, -1)) {

550 
	`lua_pİ
(
L
, 1);

552 ià(
	`luaL_fšdbË
(
L
, 
LUA_GLOBALSINDEX
, 
modÇme
, 1è!ğ
NULL
)

553  
	`luaL_”rÜ
(
L
, "ÇmcÚæiù fÜ moduË " 
LUA_QS
, 
modÇme
);

554 
	`lua_pushv®ue
(
L
, -1);

555 
	`lua_£tf›ld
(
L
, 
lßded
, 
modÇme
);

558 
	`lua_g‘f›ld
(
L
, -1, "_NAME");

559 ià(!
	`lua_i¢
(
L
, -1))

560 
	`lua_pİ
(
L
, 1);

562 
	`lua_pİ
(
L
, 1);

563 
	`modš™
(
L
, 
modÇme
);

565 
	`lua_pushv®ue
(
L
, -1);

566 
	`£tãnv
(
L
);

567 
	`doİtiÚs
(
L
, 
lßded
 - 1);

569 
	}
}

572 
	$Î_£—Î
 (
lua_S‹
 *
L
) {

573 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

574 ià(!
	`lua_g‘m‘©abË
(
L
, 1)) {

575 
	`lua_ü—‹bË
(
L
, 0, 1);

576 
	`lua_pushv®ue
(
L
, -1);

577 
	`lua_£tm‘©abË
(
L
, 1);

579 
	`lua_pushv®ue
(
L
, 
LUA_GLOBALSINDEX
);

580 
	`lua_£tf›ld
(
L
, -2, "__index");

582 
	}
}

590 
	#AUXMARK
 "\1"

	)

592 
	$£©h
 (
lua_S‹
 *
L
, cÚ¡ *
f›ldÇme
, cÚ¡ *
’vÇme
,

593 cÚ¡ *
def
) {

594 cÚ¡ *
·th
 = 
	`g‘’v
(
’vÇme
);

595 ià(
·th
 =ğ
NULL
)

596 
	`lua_push¡ršg
(
L
, 
def
);

599 
·th
 = 
	`luaL_gsub
(
L
,…©h, 
LUA_PATHSEP
 LUA_PATHSEP,

600 
LUA_PATHSEP
 
AUXMARK
 LUA_PATHSEP);

601 
	`luaL_gsub
(
L
, 
·th
, 
AUXMARK
, 
def
);

602 
	`lua_»move
(
L
, -2);

604 
	`£rogdœ
(
L
);

605 
	`lua_£tf›ld
(
L
, -2, 
f›ldÇme
);

606 
	}
}

609 cÚ¡ 
luaL_Reg
 
	gpk_funcs
[] = {

610 {"lßdlib", 
Î_lßdlib
},

611 {"£—Î", 
Î_£—Î
},

612 {
NULL
, NULL}

616 cÚ¡ 
luaL_Reg
 
	gÎ_funcs
[] = {

617 {"moduË", 
Î_moduË
},

618 {"»quœe", 
Î_»quœe
},

619 {
NULL
, NULL}

623 cÚ¡ 
lua_CFunùiÚ
 
	glßd”s
[] =

624 {
lßd”_´–ßd
, 
lßd”_Lua
, 
lßd”_C
, 
lßd”_CroÙ
, 
NULL
};

627 
LUALIB_API
 
	$luaİ’_·ckage
 (
lua_S‹
 *
L
) {

628 
i
;

630 
	`luaL_Ãwm‘©abË
(
L
, "_LOADLIB");

631 
	`lua_pushcfunùiÚ
(
L
, 
gùm
);

632 
	`lua_£tf›ld
(
L
, -2, "__gc");

634 
	`luaL_»gi¡”
(
L
, 
LUA_LOADLIBNAME
, 
pk_funcs
);

635 #ià
	`defšed
(
LUA_COMPAT_LOADLIB
)

636 
	`lua_g‘f›ld
(
L
, -1, "loadlib");

637 
	`lua_£tf›ld
(
L
, 
LUA_GLOBALSINDEX
, "loadlib");

639 
	`lua_pushv®ue
(
L
, -1);

640 
	`lua_»¶aû
(
L
, 
LUA_ENVIRONINDEX
);

642 
	`lua_ü—‹bË
(
L
, (
lßd”s
)/(loaders[0]) - 1, 0);

644 
i
=0; 
lßd”s
[i] !ğ
NULL
; i++) {

645 
	`lua_pushcfunùiÚ
(
L
, 
lßd”s
[
i
]);

646 
	`lua_¿w£ti
(
L
, -2, 
i
+1);

648 
	`lua_£tf›ld
(
L
, -2, "loaders");

649 
	`£©h
(
L
, "·th", 
LUA_PATH
, 
LUA_PATH_DEFAULT
);

650 
	`£©h
(
L
, "ı©h", 
LUA_CPATH
, 
LUA_CPATH_DEFAULT
);

652 
	`lua_pushl™”®
(
L
, 
LUA_DIRSEP
 "\n" 
LUA_PATHSEP
 "\n" 
LUA_PATH_MARK
 "\n"

653 
LUA_EXECDIR
 "\n" 
LUA_IGMARK
);

654 
	`lua_£tf›ld
(
L
, -2, "config");

656 
	`luaL_fšdbË
(
L
, 
LUA_REGISTRYINDEX
, "_LOADED", 2);

657 
	`lua_£tf›ld
(
L
, -2, "loaded");

659 
	`lua_ÃwbË
(
L
);

660 
	`lua_£tf›ld
(
L
, -2, "preload");

661 
	`lua_pushv®ue
(
L
, 
LUA_GLOBALSINDEX
);

662 
	`luaL_»gi¡”
(
L
, 
NULL
, 
Î_funcs
);

663 
	`lua_pİ
(
L
, 1);

665 
	}
}

	@deps/lua/src/lobject.c

7 
	~<ùy³.h
>

8 
	~<¡d¬g.h
>

9 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

13 
	#lobjeù_c


	)

14 
	#LUA_CORE


	)

16 
	~"lua.h
"

18 
	~"ldo.h
"

19 
	~"lmem.h
"

20 
	~"lobjeù.h
"

21 
	~"l¡©e.h
"

22 
	~"l¡ršg.h
"

23 
	~"lvm.h
"

27 cÚ¡ 
TV®ue
 
	gluaO_nobjeù_
 = {{
NULL
}, 
LUA_TNIL
};

35 
	$luaO_št2fb
 (
x
) {

36 
e
 = 0;

37 
x
 >= 16) {

38 
x
 = (x+1) >> 1;

39 
e
++;

41 ià(
x
 < 8)  x;

42  ((
e
+1è<< 3è| (
	`ÿ¡_št
(
x
) - 8);

43 
	}
}

47 
	$luaO_fb2št
 (
x
) {

48 
e
 = (
x
 >> 3) & 31;

49 ià(
e
 =ğ0è 
x
;

50  ((
x
 & 7)+8è<< (
e
 - 1);

51 
	}
}

54 
	$luaO_log2
 (
x
) {

55 cÚ¡ 
lu_by‹
 
log_2
[256] = {

65 
l
 = -1;

66 
x
 >ğ256è{ 
l
 += 8; x >>= 8; }

67  
l
 + 
log_2
[
x
];

69 
	}
}

72 
	$luaO_¿wequ®Obj
 (cÚ¡ 
TV®ue
 *
t1
, cÚ¡ TV®u*
t2
) {

73 ià(
	`‰y³
(
t1
è!ğ‰y³(
t2
))  0;

74 
	`‰y³
(
t1
)) {

75 
LUA_TNIL
:

77 
LUA_TNUMBER
:

78  
	`luai_numeq
(
	`nv®ue
(
t1
),‚v®ue(
t2
));

79 
LUA_TBOOLEAN
:

80  
	`bv®ue
(
t1
è=ğbv®ue(
t2
);

81 
LUA_TLIGHTUSERDATA
:

82  
	`pv®ue
(
t1
è=ğpv®ue(
t2
);

84 
	`lua_as£¹
(
	`iscŞËùabË
(
t1
));

85  
	`gcv®ue
(
t1
è=ğgcv®ue(
t2
);

87 
	}
}

90 
	$luaO_¡r2d
 (cÚ¡ *
s
, 
lua_Numb”
 *
»suÉ
) {

91 *
’d±r
;

92 *
»suÉ
 = 
	`lua_¡r2numb”
(
s
, &
’d±r
);

93 ià(
’d±r
 =ğ
s
)  0;

94 ià(*
’d±r
 == 'x' || *endptr == 'X')

95 *
»suÉ
 = 
	`ÿ¡_num
(
	`¡¹oul
(
s
, &
’d±r
, 16));

96 ià(*
’d±r
 == '\0')  1;

97 
	`is¥aû
(
	`ÿ¡
(, *
’d±r
)))ƒndptr++;

98 ià(*
’d±r
 != '\0')  0;

100 
	}
}

104 
	$push¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
) {

105 
	`£tsv®ue2s
(
L
, L->
tİ
, 
	`luaS_Ãw
(L, 
¡r
));

106 
	`šü_tİ
(
L
);

107 
	}
}

111 cÚ¡ *
	$luaO_pushvf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, 
va_li¡
 
¬gp
) {

112 
n
 = 1;

113 
	`push¡r
(
L
, "");

115 cÚ¡ *
e
 = 
	`¡rchr
(
fmt
, '%');

116 ià(
e
 =ğ
NULL
) ;

117 
	`£tsv®ue2s
(
L
, L->
tİ
, 
	`luaS_Ãwl¡r
(L, 
fmt
, 
e
-fmt));

118 
	`šü_tİ
(
L
);

119 *(
e
+1)) {

121 cÚ¡ *
s
 = 
	`va_¬g
(
¬gp
, *);

122 ià(
s
 =ğ
NULL
) s = "(null)";

123 
	`push¡r
(
L
, 
s
);

127 
buff
[2];

128 
buff
[0] = 
	`ÿ¡
(, 
	`va_¬g
(
¬gp
, ));

129 
buff
[1] = '\0';

130 
	`push¡r
(
L
, 
buff
);

134 
	`£Šv®ue
(
L
->
tİ
, 
	`ÿ¡_num
(
	`va_¬g
(
¬gp
, )));

135 
	`šü_tİ
(
L
);

139 
	`£Šv®ue
(
L
->
tİ
, 
	`ÿ¡_num
(
	`va_¬g
(
¬gp
, 
l_uacNumb”
)));

140 
	`šü_tİ
(
L
);

144 
buff
[4*(*) + 8];

145 
	`¥rštf
(
buff
, "%p", 
	`va_¬g
(
¬gp
, *));

146 
	`push¡r
(
L
, 
buff
);

150 
	`push¡r
(
L
, "%");

154 
buff
[3];

155 
buff
[0] = '%';

156 
buff
[1] = *(
e
+1);

157 
buff
[2] = '\0';

158 
	`push¡r
(
L
, 
buff
);

162 
n
 += 2;

163 
fmt
 = 
e
+2;

165 
	`push¡r
(
L
, 
fmt
);

166 
	`luaV_cÚÿt
(
L
, 
n
+1, 
	`ÿ¡_št
(L->
tİ
 - L->
ba£
) - 1);

167 
L
->
tİ
 -ğ
n
;

168  
	`sv®ue
(
L
->
tİ
 - 1);

169 
	}
}

172 cÚ¡ *
	$luaO_pushf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

173 cÚ¡ *
msg
;

174 
va_li¡
 
¬gp
;

175 
	`va_¡¬t
(
¬gp
, 
fmt
);

176 
msg
 = 
	`luaO_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

177 
	`va_’d
(
¬gp
);

178  
msg
;

179 
	}
}

182 
	$luaO_chunkid
 (*
out
, cÚ¡ *
sourû
, 
size_t
 
bufæ’
) {

183 ià(*
sourû
 == '=') {

184 
	`¡ºıy
(
out
, 
sourû
+1, 
bufæ’
);

185 
out
[
bufæ’
-1] = '\0';

188 ià(*
sourû
 == '@') {

189 
size_t
 
l
;

190 
sourû
++;

191 
bufæ’
 -= (" '...' ");

192 
l
 = 
	`¡¾’
(
sourû
);

193 
	`¡rıy
(
out
, "");

194 ià(
l
 > 
bufæ’
) {

195 
sourû
 +ğ(
l
-
bufæ’
);

196 
	`¡rÿt
(
out
, "...");

198 
	`¡rÿt
(
out
, 
sourû
);

201 
size_t
 
Ën
 = 
	`¡rc¥n
(
sourû
, "\n\r");

202 
bufæ’
 -= (" [string \"...\"] ");

203 ià(
Ën
 > 
bufæ’
)†en = bufflen;

204 
	`¡rıy
(
out
, "[string \"");

205 ià(
sourû
[
Ën
] != '\0') {

206 
	`¡ºÿt
(
out
, 
sourû
, 
Ën
);

207 
	`¡rÿt
(
out
, "...");

210 
	`¡rÿt
(
out
, 
sourû
);

211 
	`¡rÿt
(
out
, "\"]");

214 
	}
}

	@deps/lua/src/lobject.h

8 #iâdeà
lobjeù_h


9 
	#lobjeù_h


	)

12 
	~<¡d¬g.h
>

15 
	~"Îim™s.h
"

16 
	~"lua.h
"

20 
	#LAST_TAG
 
LUA_TTHREAD


	)

22 
	#NUM_TAGS
 (
LAST_TAG
+1)

	)

28 
	#LUA_TPROTO
 (
LAST_TAG
+1)

	)

29 
	#LUA_TUPVAL
 (
LAST_TAG
+2)

	)

30 
	#LUA_TDEADKEY
 (
LAST_TAG
+3)

	)

36 
GCObjeù
 
	tGCObjeù
;

43 
	#CommÚH—d”
 
GCObjeù
 *
Ãxt
; 
lu_by‹
 
‰
;†u_by‹ 
m¬ked


	)

49 
	sGCh—d”
 {

50 
	mCommÚH—d”
;

51 } 
	tGCh—d”
;

60 
GCObjeù
 *
	mgc
;

61 *
	mp
;

62 
lua_Numb”
 
	mn
;

63 
	mb
;

64 } 
	tV®ue
;

71 
	#TV®uef›lds
 
V®ue
 
v®ue
; 
‰


	)

73 
	slua_TV®ue
 {

74 
	mTV®uef›lds
;

75 } 
	tTV®ue
;

79 
	#‰i¢
(
o
è(
	`‰y³
(oè=ğ
LUA_TNIL
)

	)

80 
	#‰i¢umb”
(
o
è(
	`‰y³
(oè=ğ
LUA_TNUMBER
)

	)

81 
	#‰is¡ršg
(
o
è(
	`‰y³
(oè=ğ
LUA_TSTRING
)

	)

82 
	#‰i¡abË
(
o
è(
	`‰y³
(oè=ğ
LUA_TTABLE
)

	)

83 
	#‰isfunùiÚ
(
o
è(
	`‰y³
(oè=ğ
LUA_TFUNCTION
)

	)

84 
	#‰isboŞ—n
(
o
è(
	`‰y³
(oè=ğ
LUA_TBOOLEAN
)

	)

85 
	#‰isu£rd©a
(
o
è(
	`‰y³
(oè=ğ
LUA_TUSERDATA
)

	)

86 
	#‰i¡h»ad
(
o
è(
	`‰y³
(oè=ğ
LUA_TTHREAD
)

	)

87 
	#‰i¦ightu£rd©a
(
o
è(
	`‰y³
(oè=ğ
LUA_TLIGHTUSERDATA
)

	)

90 
	#‰y³
(
o
è((o)->
‰
)

	)

91 
	#gcv®ue
(
o
è
	`check_exp
(
	`iscŞËùabË
(o), (o)->
v®ue
.
gc
)

	)

92 
	#pv®ue
(
o
è
	`check_exp
(
	`‰i¦ightu£rd©a
(o), (o)->
v®ue
.
p
)

	)

93 
	#nv®ue
(
o
è
	`check_exp
(
	`‰i¢umb”
(o), (o)->
v®ue
.
n
)

	)

94 
	#¿wtsv®ue
(
o
è
	`check_exp
(
	`‰is¡ršg
(o), &(o)->
v®ue
.
gc
->
ts
)

	)

95 
	#tsv®ue
(
o
è(&
	`¿wtsv®ue
(o)->
tsv
)

	)

96 
	#¿wuv®ue
(
o
è
	`check_exp
(
	`‰isu£rd©a
(o), &(o)->
v®ue
.
gc
->
u
)

	)

97 
	#uv®ue
(
o
è(&
	`¿wuv®ue
(o)->
uv
)

	)

98 
	#şv®ue
(
o
è
	`check_exp
(
	`‰isfunùiÚ
(o), &(o)->
v®ue
.
gc
->
ş
)

	)

99 
	#hv®ue
(
o
è
	`check_exp
(
	`‰i¡abË
(o), &(o)->
v®ue
.
gc
->
h
)

	)

100 
	#bv®ue
(
o
è
	`check_exp
(
	`‰isboŞ—n
(o), (o)->
v®ue
.
b
)

	)

101 
	#thv®ue
(
o
è
	`check_exp
(
	`‰i¡h»ad
(o), &(o)->
v®ue
.
gc
->
th
)

	)

103 
	#l_isçl£
(
o
è(
	`‰i¢
(oè|| (
	`‰isboŞ—n
(oè&& 
	`bv®ue
(oè=ğ0))

	)

108 
	#checkcÚsi¡’cy
(
obj
) \

109 
	`lua_as£¹
(!
	`iscŞËùabË
(
obj
è|| (
	`‰y³
(objè=ğ(obj)->
v®ue
.
gc
->
gch
.
‰
))

	)

111 
	#checkliv’ess
(
g
,
obj
) \

112 
	`lua_as£¹
(!
	`iscŞËùabË
(
obj
) || \

113 ((
	`‰y³
(
obj
è=ğ(obj)->
v®ue
.
gc
->
gch
.
‰
è&& !
	`isd—d
(
g
, (obj)->v®ue.gc)))

	)

117 
	#£Šv®ue
(
obj
è((obj)->
‰
=
LUA_TNIL
)

	)

119 
	#£Šv®ue
(
obj
,
x
) \

120 { 
TV®ue
 *
i_o
=(
obj
); i_o->
v®ue
.
n
=(
x
); i_o->
‰
=
LUA_TNUMBER
; }

	)

122 
	#£v®ue
(
obj
,
x
) \

123 { 
TV®ue
 *
i_o
=(
obj
); i_o->
v®ue
.
p
=(
x
); i_o->
‰
=
LUA_TLIGHTUSERDATA
; }

	)

125 
	#£tbv®ue
(
obj
,
x
) \

126 { 
TV®ue
 *
i_o
=(
obj
); i_o->
v®ue
.
b
=(
x
); i_o->
‰
=
LUA_TBOOLEAN
; }

	)

128 
	#£tsv®ue
(
L
,
obj
,
x
) \

129 { 
TV®ue
 *
i_o
=(
obj
); \

130 
i_o
->
v®ue
.
gc
=
	`ÿ¡
(
GCObjeù
 *, (
x
)); i_o->
‰
=
LUA_TSTRING
; \

131 
	`checkliv’ess
(
	`G
(
L
),
i_o
); }

	)

133 
	#£tuv®ue
(
L
,
obj
,
x
) \

134 { 
TV®ue
 *
i_o
=(
obj
); \

135 
i_o
->
v®ue
.
gc
=
	`ÿ¡
(
GCObjeù
 *, (
x
)); i_o->
‰
=
LUA_TUSERDATA
; \

136 
	`checkliv’ess
(
	`G
(
L
),
i_o
); }

	)

138 
	#£‰hv®ue
(
L
,
obj
,
x
) \

139 { 
TV®ue
 *
i_o
=(
obj
); \

140 
i_o
->
v®ue
.
gc
=
	`ÿ¡
(
GCObjeù
 *, (
x
)); i_o->
‰
=
LUA_TTHREAD
; \

141 
	`checkliv’ess
(
	`G
(
L
),
i_o
); }

	)

143 
	#£tşv®ue
(
L
,
obj
,
x
) \

144 { 
TV®ue
 *
i_o
=(
obj
); \

145 
i_o
->
v®ue
.
gc
=
	`ÿ¡
(
GCObjeù
 *, (
x
)); i_o->
‰
=
LUA_TFUNCTION
; \

146 
	`checkliv’ess
(
	`G
(
L
),
i_o
); }

	)

148 
	#£thv®ue
(
L
,
obj
,
x
) \

149 { 
TV®ue
 *
i_o
=(
obj
); \

150 
i_o
->
v®ue
.
gc
=
	`ÿ¡
(
GCObjeù
 *, (
x
)); i_o->
‰
=
LUA_TTABLE
; \

151 
	`checkliv’ess
(
	`G
(
L
),
i_o
); }

	)

153 
	#£tv®ue
(
L
,
obj
,
x
) \

154 { 
TV®ue
 *
i_o
=(
obj
); \

155 
i_o
->
v®ue
.
gc
=
	`ÿ¡
(
GCObjeù
 *, (
x
)); i_o->
‰
=
LUA_TPROTO
; \

156 
	`checkliv’ess
(
	`G
(
L
),
i_o
); }

	)

161 
	#£tobj
(
L
,
obj1
,
obj2
) \

162 { cÚ¡ 
TV®ue
 *
o2
=(
obj2
); TV®u*
o1
=(
obj1
); \

163 
o1
->
v®ue
 = 
o2
->v®ue; o1->
‰
=o2->tt; \

164 
	`checkliv’ess
(
	`G
(
L
),
o1
); }

	)

172 
	#£tobjs2s
 
£tobj


	)

174 
	#£tobj2s
 
£tobj


	)

175 
	#£tsv®ue2s
 
£tsv®ue


	)

176 
	#£thv®ue2s
 
£thv®ue


	)

177 
	#£tv®ue2s
 
£tv®ue


	)

179 
	#£tobjt2t
 
£tobj


	)

181 
	#£tobj2t
 
£tobj


	)

183 
	#£tobj2n
 
£tobj


	)

184 
	#£tsv®ue2n
 
£tsv®ue


	)

186 
	#£‰ty³
(
obj
, 
‰
è(
	`‰y³
(objèğÑt))

	)

189 
	#iscŞËùabË
(
o
è(
	`‰y³
(oè>ğ
LUA_TSTRING
)

	)

193 
TV®ue
 *
	tStkId
;

199 
	uTSŒšg
 {

200 
L_Umax®ign
 
	mdummy
;

202 
	mCommÚH—d”
;

203 
lu_by‹
 
	m»£rved
;

204 
	mhash
;

205 
size_t
 
	mËn
;

206 } 
	mtsv
;

207 } 
	tTSŒšg
;

210 
	#g‘¡r
(
ts
è
	`ÿ¡
(cÚ¡ *, (tsè+ 1)

	)

211 
	#sv®ue
(
o
è
	`g‘¡r
(
	`¿wtsv®ue
(o))

	)

215 
	uUd©a
 {

216 
L_Umax®ign
 
	mdummy
;

218 
	mCommÚH—d”
;

219 
TabË
 *
	mm‘©abË
;

220 
TabË
 *
	m’v
;

221 
size_t
 
	mËn
;

222 } 
	muv
;

223 } 
	tUd©a
;

231 
	sPrÙo
 {

232 
	mCommÚH—d”
;

233 
TV®ue
 *
	mk
;

234 
In¡ruùiÚ
 *
	mcode
;

235 
PrÙo
 **
	mp
;

236 *
	mlšešfo
;

237 
LocV¬
 *
	mlocv¬s
;

238 
TSŒšg
 **
	mupv®ues
;

239 
TSŒšg
 *
	msourû
;

240 
	msizeupv®ues
;

241 
	msizek
;

242 
	msizecode
;

243 
	msiz–šešfo
;

244 
	msiz•
;

245 
	msiz–ocv¬s
;

246 
	mlšedefšed
;

247 
	mÏ¡lšedefšed
;

248 
GCObjeù
 *
	mgşi¡
;

249 
lu_by‹
 
	mnups
;

250 
lu_by‹
 
	mnum·¿ms
;

251 
lu_by‹
 
	mis_v¬¬g
;

252 
lu_by‹
 
	mmax¡acksize
;

253 } 
	tPrÙo
;

257 
	#VARARG_HASARG
 1

	)

258 
	#VARARG_ISVARARG
 2

	)

259 
	#VARARG_NEEDSARG
 4

	)

262 
	sLocV¬
 {

263 
TSŒšg
 *
	mv¬Çme
;

264 
	m¡¬c
;

265 
	m’dpc
;

266 } 
	tLocV¬
;

274 
	sUpV®
 {

275 
	mCommÚH—d”
;

276 
TV®ue
 *
	mv
;

278 
TV®ue
 
	mv®ue
;

280 
UpV®
 *
	m´ev
;

281 
UpV®
 *
	mÃxt
;

282 } 
	ml
;

283 } 
	mu
;

284 } 
	tUpV®
;

291 
	#Closu»H—d”
 \

292 
CommÚH—d”
; 
lu_by‹
 
isC
;†u_by‹ 
nupv®ues
; 
GCObjeù
 *
gşi¡
; \

293 
TabË
 *
’v


	)

295 
	sCClosu»
 {

296 
	mClosu»H—d”
;

297 
lua_CFunùiÚ
 
	mf
;

298 
TV®ue
 
	mupv®ue
[1];

299 } 
	tCClosu»
;

302 
	sLClosu»
 {

303 
	mClosu»H—d”
;

304 
PrÙo
 *
	mp
;

305 
UpV®
 *
	mupv®s
[1];

306 } 
	tLClosu»
;

309 
	uClosu»
 {

310 
CClosu»
 
	mc
;

311 
LClosu»
 
	ml
;

312 } 
	tClosu»
;

315 
	#iscfunùiÚ
(
o
è(
	`‰y³
(oè=ğ
LUA_TFUNCTION
 && 
	`şv®ue
(o)->
c
.
isC
)

	)

316 
	#isLfunùiÚ
(
o
è(
	`‰y³
(oè=ğ
LUA_TFUNCTION
 && !
	`şv®ue
(o)->
c
.
isC
)

	)

323 
	uTKey
 {

325 
	mTV®uef›lds
;

326 
Node
 *
	mÃxt
;

327 } 
	mnk
;

328 
TV®ue
 
	mtvk
;

329 } 
	tTKey
;

332 
	sNode
 {

333 
TV®ue
 
	mi_v®
;

334 
TKey
 
	mi_key
;

335 } 
	tNode
;

338 
	sTabË
 {

339 
	mCommÚH—d”
;

340 
lu_by‹
 
	mæags
;

341 
lu_by‹
 
	mlsiz’ode
;

342 
TabË
 *
	mm‘©abË
;

343 
TV®ue
 *
	m¬¿y
;

344 
Node
 *
	mnode
;

345 
Node
 *
	mÏ¡ä“
;

346 
GCObjeù
 *
	mgşi¡
;

347 
	msiz—¼ay
;

348 } 
	tTabË
;

355 
	#lmod
(
s
,
size
) \

356 (
	`check_exp
((
size
&(size-1))==0, (
	`ÿ¡
(, (
s
è& ((size)-1)))))

	)

359 
	#twÙo
(
x
è(1<<(x))

	)

360 
	#siz’ode
(
t
è(
	`twÙo
(Ñ)->
lsiz’ode
))

	)

363 
	#luaO_nobjeù
 (&
luaO_nobjeù_
)

	)

365 
LUAI_DATA
 cÚ¡ 
TV®ue
 
	gluaO_nobjeù_
;

367 
	#ûlog2
(
x
è(
	`luaO_log2
((x)-1è+ 1)

	)

369 
LUAI_FUNC
 
luaO_log2
 (
x
);

370 
LUAI_FUNC
 
luaO_št2fb
 (
x
);

371 
LUAI_FUNC
 
luaO_fb2št
 (
x
);

372 
LUAI_FUNC
 
luaO_¿wequ®Obj
 (cÚ¡ 
TV®ue
 *
t1
, cÚ¡ TV®u*
t2
);

373 
LUAI_FUNC
 
luaO_¡r2d
 (cÚ¡ *
s
, 
lua_Numb”
 *
»suÉ
);

374 
LUAI_FUNC
 cÚ¡ *
luaO_pushvf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
,

375 
va_li¡
 
¬gp
);

376 
LUAI_FUNC
 cÚ¡ *
luaO_pushf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

377 
LUAI_FUNC
 
luaO_chunkid
 (*
out
, cÚ¡ *
sourû
, 
size_t
 
Ën
);

	@deps/lua/src/lopcodes.c

7 
	#lİcodes_c


	)

8 
	#LUA_CORE


	)

11 
	~"lİcodes.h
"

16 cÚ¡ *cÚ¡ 
	gluaP_İÇmes
[
NUM_OPCODES
+1] = {

55 
NULL


59 
	#İmode
(
t
,
a
,
b
,
c
,
m
è((Ñ)<<7è| (×)<<6è| ((b)<<4è| ((c)<<2è| (m))

	)

61 cÚ¡ 
lu_by‹
 
	gluaP_İmodes
[
NUM_OPCODES
] = {

63 
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

64 ,
İmode
(0, 1, 
OpArgK
, 
OpArgN
, 
iABx
)

65 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

66 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

67 ,
İmode
(0, 1, 
OpArgU
, 
OpArgN
, 
iABC
)

68 ,
İmode
(0, 1, 
OpArgK
, 
OpArgN
, 
iABx
)

69 ,
İmode
(0, 1, 
OpArgR
, 
OpArgK
, 
iABC
)

70 ,
İmode
(0, 0, 
OpArgK
, 
OpArgN
, 
iABx
)

71 ,
İmode
(0, 0, 
OpArgU
, 
OpArgN
, 
iABC
)

72 ,
İmode
(0, 0, 
OpArgK
, OpArgK, 
iABC
)

73 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

74 ,
İmode
(0, 1, 
OpArgR
, 
OpArgK
, 
iABC
)

75 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

76 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

77 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

78 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

79 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

80 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

81 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

82 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

83 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

84 ,
İmode
(0, 1, 
OpArgR
, OpArgR, 
iABC
)

85 ,
İmode
(0, 0, 
OpArgR
, 
OpArgN
, 
iAsBx
)

86 ,
İmode
(1, 0, 
OpArgK
, OpArgK, 
iABC
)

87 ,
İmode
(1, 0, 
OpArgK
, OpArgK, 
iABC
)

88 ,
İmode
(1, 0, 
OpArgK
, OpArgK, 
iABC
)

89 ,
İmode
(1, 1, 
OpArgR
, 
OpArgU
, 
iABC
)

90 ,
İmode
(1, 1, 
OpArgR
, 
OpArgU
, 
iABC
)

91 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

92 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

93 ,
İmode
(0, 0, 
OpArgU
, 
OpArgN
, 
iABC
)

94 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iAsBx
)

95 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iAsBx
)

96 ,
İmode
(1, 0, 
OpArgN
, 
OpArgU
, 
iABC
)

97 ,
İmode
(0, 0, 
OpArgU
, OpArgU, 
iABC
)

98 ,
İmode
(0, 0, 
OpArgN
, OpArgN, 
iABC
)

99 ,
İmode
(0, 1, 
OpArgU
, 
OpArgN
, 
iABx
)

100 ,
İmode
(0, 1, 
OpArgU
, 
OpArgN
, 
iABC
)

	@deps/lua/src/lopcodes.h

7 #iâdeà
lİcodes_h


8 
	#lİcodes_h


	)

10 
	~"Îim™s.h
"

31 
	eOpMode
 {
	miABC
, 
	miABx
, 
	miAsBx
};

37 
	#SIZE_C
 9

	)

38 
	#SIZE_B
 9

	)

39 
	#SIZE_Bx
 (
SIZE_C
 + 
SIZE_B
)

	)

40 
	#SIZE_A
 8

	)

42 
	#SIZE_OP
 6

	)

44 
	#POS_OP
 0

	)

45 
	#POS_A
 (
POS_OP
 + 
SIZE_OP
)

	)

46 
	#POS_C
 (
POS_A
 + 
SIZE_A
)

	)

47 
	#POS_B
 (
POS_C
 + 
SIZE_C
)

	)

48 
	#POS_Bx
 
POS_C


	)

56 #ià
SIZE_Bx
 < 
LUAI_BITSINT
-1

57 
	#MAXARG_Bx
 ((1<<
SIZE_Bx
)-1)

	)

58 
	#MAXARG_sBx
 (
MAXARG_Bx
>>1è

	)

60 
	#MAXARG_Bx
 
MAX_INT


	)

61 
	#MAXARG_sBx
 
MAX_INT


	)

65 
	#MAXARG_A
 ((1<<
SIZE_A
)-1)

	)

66 
	#MAXARG_B
 ((1<<
SIZE_B
)-1)

	)

67 
	#MAXARG_C
 ((1<<
SIZE_C
)-1)

	)

71 
	#MASK1
(
n
,
p
è((~((~(
In¡ruùiÚ
)0)<<n))<<p)

	)

74 
	#MASK0
(
n
,
p
è(~
	`MASK1
Ò,p))

	)

80 
	#GET_OPCODE
(
i
è(
	`ÿ¡
(
OpCode
, ((i)>>
POS_OP
è& 
	`MASK1
(
SIZE_OP
,0)))

	)

81 
	#SET_OPCODE
(
i
,
o
è((ièğ(((i)&
	`MASK0
(
SIZE_OP
,
POS_OP
)) | \

82 ((
	`ÿ¡
(
In¡ruùiÚ
, 
o
)<<
POS_OP
)&
	`MASK1
(
SIZE_OP
,POS_OP))))

	)

84 
	#GETARG_A
(
i
è(
	`ÿ¡
(, ((i)>>
POS_A
è& 
	`MASK1
(
SIZE_A
,0)))

	)

85 
	#SETARG_A
(
i
,
u
è((ièğ(((i)&
	`MASK0
(
SIZE_A
,
POS_A
)) | \

86 ((
	`ÿ¡
(
In¡ruùiÚ
, 
u
)<<
POS_A
)&
	`MASK1
(
SIZE_A
,POS_A))))

	)

88 
	#GETARG_B
(
i
è(
	`ÿ¡
(, ((i)>>
POS_B
è& 
	`MASK1
(
SIZE_B
,0)))

	)

89 
	#SETARG_B
(
i
,
b
è((ièğ(((i)&
	`MASK0
(
SIZE_B
,
POS_B
)) | \

90 ((
	`ÿ¡
(
In¡ruùiÚ
, 
b
)<<
POS_B
)&
	`MASK1
(
SIZE_B
,POS_B))))

	)

92 
	#GETARG_C
(
i
è(
	`ÿ¡
(, ((i)>>
POS_C
è& 
	`MASK1
(
SIZE_C
,0)))

	)

93 
	#SETARG_C
(
i
,
b
è((ièğ(((i)&
	`MASK0
(
SIZE_C
,
POS_C
)) | \

94 ((
	`ÿ¡
(
In¡ruùiÚ
, 
b
)<<
POS_C
)&
	`MASK1
(
SIZE_C
,POS_C))))

	)

96 
	#GETARG_Bx
(
i
è(
	`ÿ¡
(, ((i)>>
POS_Bx
è& 
	`MASK1
(
SIZE_Bx
,0)))

	)

97 
	#SETARG_Bx
(
i
,
b
è((ièğ(((i)&
	`MASK0
(
SIZE_Bx
,
POS_Bx
)) | \

98 ((
	`ÿ¡
(
In¡ruùiÚ
, 
b
)<<
POS_Bx
)&
	`MASK1
(
SIZE_Bx
,POS_Bx))))

	)

100 
	#GETARG_sBx
(
i
è(
	`GETARG_Bx
(i)-
MAXARG_sBx
)

	)

101 
	#SETARG_sBx
(
i
,
b
è
	`SETARG_Bx
((i),
	`ÿ¡
(, (b)+
MAXARG_sBx
))

	)

104 
	#CREATE_ABC
(
o
,
a
,
b
,
c
è((
	`ÿ¡
(
In¡ruùiÚ
, o)<<
POS_OP
) \

105 | (
	`ÿ¡
(
In¡ruùiÚ
, 
a
)<<
POS_A
) \

106 | (
	`ÿ¡
(
In¡ruùiÚ
, 
b
)<<
POS_B
) \

107 | (
	`ÿ¡
(
In¡ruùiÚ
, 
c
)<<
POS_C
))

	)

109 
	#CREATE_ABx
(
o
,
a
,
bc
è((
	`ÿ¡
(
In¡ruùiÚ
, o)<<
POS_OP
) \

110 | (
	`ÿ¡
(
In¡ruùiÚ
, 
a
)<<
POS_A
) \

111 | (
	`ÿ¡
(
In¡ruùiÚ
, 
bc
)<<
POS_Bx
))

	)

119 
	#BITRK
 (1 << (
SIZE_B
 - 1))

	)

122 
	#ISK
(
x
è((xè& 
BITRK
)

	)

125 
	#INDEXK
(
r
è(()Ôè& ~
BITRK
)

	)

127 
	#MAXINDEXRK
 (
BITRK
 - 1)

	)

130 
	#RKASK
(
x
è((xè| 
BITRK
)

	)

136 
	#NO_REG
 
MAXARG_A


	)

154 
	mOP_MOVE
,

155 
	mOP_LOADK
,

156 
	mOP_LOADBOOL
,

157 
	mOP_LOADNIL
,

158 
	mOP_GETUPVAL
,

160 
	mOP_GETGLOBAL
,

161 
	mOP_GETTABLE
,

163 
	mOP_SETGLOBAL
,

164 
	mOP_SETUPVAL
,

165 
	mOP_SETTABLE
,

167 
	mOP_NEWTABLE
,

169 
	mOP_SELF
,

171 
	mOP_ADD
,

172 
	mOP_SUB
,

173 
	mOP_MUL
,

174 
	mOP_DIV
,

175 
	mOP_MOD
,

176 
	mOP_POW
,

177 
	mOP_UNM
,

178 
	mOP_NOT
,

179 
	mOP_LEN
,

181 
	mOP_CONCAT
,

183 
	mOP_JMP
,

185 
	mOP_EQ
,

186 
	mOP_LT
,

187 
	mOP_LE
,

189 
	mOP_TEST
,

190 
	mOP_TESTSET
,

192 
	mOP_CALL
,

193 
	mOP_TAILCALL
,

194 
	mOP_RETURN
,

196 
	mOP_FORLOOP
,

198 
	mOP_FORPREP
,

200 
	mOP_TFORLOOP
,

202 
	mOP_SETLIST
,

204 
	mOP_CLOSE
,

205 
	mOP_CLOSURE
,

207 
	mOP_VARARG


208 } 
	tOpCode
;

211 
	#NUM_OPCODES
 (
	`ÿ¡
(, 
OP_VARARG
è+ 1)

	)

245 
	eOpArgMask
 {

246 
	mOpArgN
,

247 
	mOpArgU
,

248 
	mOpArgR
,

249 
	mOpArgK


252 
LUAI_DATA
 cÚ¡ 
lu_by‹
 
	gluaP_İmodes
[
NUM_OPCODES
];

254 
	#g‘OpMode
(
m
è(
	`ÿ¡
(
OpMode
, 
luaP_İmodes
[m] & 3))

	)

255 
	#g‘BMode
(
m
è(
	`ÿ¡
(
OpArgMask
, (
luaP_İmodes
[m] >> 4è& 3))

	)

256 
	#g‘CMode
(
m
è(
	`ÿ¡
(
OpArgMask
, (
luaP_İmodes
[m] >> 2è& 3))

	)

257 
	#‹¡AMode
(
m
è(
luaP_İmodes
[m] & (1 << 6))

	)

258 
	#‹¡TMode
(
m
è(
luaP_İmodes
[m] & (1 << 7))

	)

261 
LUAI_DATA
 cÚ¡ *cÚ¡ 
	gluaP_İÇmes
[
NUM_OPCODES
+1];

265 
	#LFIELDS_PER_FLUSH
 50

	)

	@deps/lua/src/loslib.c

8 
	~<”ºo.h
>

9 
	~<loÿË.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

12 
	~<time.h
>

14 
	#lo¦ib_c


	)

15 
	#LUA_LIB


	)

17 
	~"lua.h
"

19 
	~"Ïuxlib.h
"

20 
	~"lu®ib.h
"

23 
	$os_push»suÉ
 (
lua_S‹
 *
L
, 
i
, cÚ¡ *
f’ame
) {

24 
’
 = 
”ºo
;

25 ià(
i
) {

26 
	`lua_pushboŞ—n
(
L
, 1);

30 
	`lua_pushn
(
L
);

31 
	`lua_pushf¡ršg
(
L
, "%s: %s", 
f’ame
, 
	`¡»¼Ü
(
’
));

32 
	`lua_pushš‹g”
(
L
, 
’
);

35 
	}
}

38 
	$os_execu‹
 (
lua_S‹
 *
L
) {

39 
	`lua_pushš‹g”
(
L
, 
	`sy¡em
(
	`luaL_İt¡ršg
(L, 1, 
NULL
)));

41 
	}
}

44 
	$os_»move
 (
lua_S‹
 *
L
) {

45 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

46  
	`os_push»suÉ
(
L
, 
	`»move
(
f’ame
) == 0, filename);

47 
	}
}

50 
	$os_»Çme
 (
lua_S‹
 *
L
) {

51 cÚ¡ *
äomÇme
 = 
	`luaL_check¡ršg
(
L
, 1);

52 cÚ¡ *
tÚame
 = 
	`luaL_check¡ršg
(
L
, 2);

53  
	`os_push»suÉ
(
L
, 
	`»Çme
(
äomÇme
, 
tÚame
) == 0, fromname);

54 
	}
}

57 
	$os_tm²ame
 (
lua_S‹
 *
L
) {

58 
buff
[
LUA_TMPNAMBUFSIZE
];

59 
”r
;

60 
	`lua_tm²am
(
buff
, 
”r
);

61 ià(
”r
)

62  
	`luaL_”rÜ
(
L
, "unableo generate‡ unique filename");

63 
	`lua_push¡ršg
(
L
, 
buff
);

65 
	}
}

68 
	$os_g‘’v
 (
lua_S‹
 *
L
) {

69 
	`lua_push¡ršg
(
L
, 
	`g‘’v
(
	`luaL_check¡ršg
(L, 1)));

71 
	}
}

74 
	$os_şock
 (
lua_S‹
 *
L
) {

75 
	`lua_pushnumb”
(
L
, ((
lua_Numb”
)
	`şock
())/Öua_Numb”)
CLOCKS_PER_SEC
);

77 
	}
}

88 
	$£tf›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
, 
v®ue
) {

89 
	`lua_pushš‹g”
(
L
, 
v®ue
);

90 
	`lua_£tf›ld
(
L
, -2, 
key
);

91 
	}
}

93 
	$£tboŞf›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
, 
v®ue
) {

94 ià(
v®ue
 < 0)

96 
	`lua_pushboŞ—n
(
L
, 
v®ue
);

97 
	`lua_£tf›ld
(
L
, -2, 
key
);

98 
	}
}

100 
	$g‘boŞf›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
) {

101 
»s
;

102 
	`lua_g‘f›ld
(
L
, -1, 
key
);

103 
»s
 = 
	`lua_i¢
(
L
, -1è? -1 : 
	`lua_toboŞ—n
(L, -1);

104 
	`lua_pİ
(
L
, 1);

105  
»s
;

106 
	}
}

109 
	$g‘f›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
, 
d
) {

110 
»s
;

111 
	`lua_g‘f›ld
(
L
, -1, 
key
);

112 ià(
	`lua_i¢umb”
(
L
, -1))

113 
»s
 = ()
	`lua_toš‹g”
(
L
, -1);

115 ià(
d
 < 0)

116  
	`luaL_”rÜ
(
L
, "f›ld " 
LUA_QS
 " missšg iÀd©bË", 
key
);

117 
»s
 = 
d
;

119 
	`lua_pİ
(
L
, 1);

120  
»s
;

121 
	}
}

124 
	$os_d©e
 (
lua_S‹
 *
L
) {

125 cÚ¡ *
s
 = 
	`luaL_İt¡ršg
(
L
, 1, "%c");

126 
time_t
 
t
 = 
	`luaL_İt
(
L
, (time_t)
luaL_checknumb”
, 2, 
	`time
(
NULL
));

127 
tm
 *
¡m
;

128 ià(*
s
 == '!') {

129 
¡m
 = 
	`gmtime
(&
t
);

130 
s
++;

133 
¡m
 = 
	`loÿÉime
(&
t
);

134 ià(
¡m
 =ğ
NULL
)

135 
	`lua_pushn
(
L
);

136 ià(
	`¡rcmp
(
s
, "*t") == 0) {

137 
	`lua_ü—‹bË
(
L
, 0, 9);

138 
	`£tf›ld
(
L
, "£c", 
¡m
->
tm_£c
);

139 
	`£tf›ld
(
L
, "mš", 
¡m
->
tm_mš
);

140 
	`£tf›ld
(
L
, "hour", 
¡m
->
tm_hour
);

141 
	`£tf›ld
(
L
, "day", 
¡m
->
tm_mday
);

142 
	`£tf›ld
(
L
, "mÚth", 
¡m
->
tm_mÚ
+1);

143 
	`£tf›ld
(
L
, "y—r", 
¡m
->
tm_y—r
+1900);

144 
	`£tf›ld
(
L
, "wday", 
¡m
->
tm_wday
+1);

145 
	`£tf›ld
(
L
, "yday", 
¡m
->
tm_yday
+1);

146 
	`£tboŞf›ld
(
L
, "isd¡", 
¡m
->
tm_isd¡
);

149 
cc
[3];

150 
luaL_Bufãr
 
b
;

151 
cc
[0] = '%'; cc[2] = '\0';

152 
	`luaL_buffš™
(
L
, &
b
);

153 ; *
s
; s++) {

154 ià(*
s
 != '%' || *(s + 1) == '\0')

155 
	`luaL_addch¬
(&
b
, *
s
);

157 
size_t
 
»¦’
;

158 
buff
[200];

159 
cc
[1] = *(++
s
);

160 
»¦’
 = 
	`¡ráime
(
buff
, (buff), 
cc
, 
¡m
);

161 
	`luaL_addl¡ršg
(&
b
, 
buff
, 
»¦’
);

164 
	`luaL_push»suÉ
(&
b
);

167 
	}
}

170 
	$os_time
 (
lua_S‹
 *
L
) {

171 
time_t
 
t
;

172 ià(
	`lua_i¢ÚeÜn
(
L
, 1))

173 
t
 = 
	`time
(
NULL
);

175 
tm
 
ts
;

176 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

177 
	`lua_£‰İ
(
L
, 1);

178 
ts
.
tm_£c
 = 
	`g‘f›ld
(
L
, "sec", 0);

179 
ts
.
tm_mš
 = 
	`g‘f›ld
(
L
, "min", 0);

180 
ts
.
tm_hour
 = 
	`g‘f›ld
(
L
, "hour", 12);

181 
ts
.
tm_mday
 = 
	`g‘f›ld
(
L
, "day", -1);

182 
ts
.
tm_mÚ
 = 
	`g‘f›ld
(
L
, "month", -1) - 1;

183 
ts
.
tm_y—r
 = 
	`g‘f›ld
(
L
, "year", -1) - 1900;

184 
ts
.
tm_isd¡
 = 
	`g‘boŞf›ld
(
L
, "isdst");

185 
t
 = 
	`mktime
(&
ts
);

187 ià(
t
 =ğ(
time_t
)(-1))

188 
	`lua_pushn
(
L
);

190 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)
t
);

192 
	}
}

195 
	$os_difáime
 (
lua_S‹
 *
L
) {

196 
	`lua_pushnumb”
(
L
, 
	`difáime
((
time_t
)(
	`luaL_checknumb”
(L, 1)),

197 (
time_t
)(
	`luaL_İŠumb”
(
L
, 2, 0))));

199 
	}
}

204 
	$os_£oÿË
 (
lua_S‹
 *
L
) {

205 cÚ¡ 
ÿt
[] = {
LC_ALL
, 
LC_COLLATE
, 
LC_CTYPE
, 
LC_MONETARY
,

206 
LC_NUMERIC
, 
LC_TIME
};

207 cÚ¡ *cÚ¡ 
ÿŠames
[] = {"all", "collate", "ctype", "monetary",

208 "num”ic", "time", 
NULL
};

209 cÚ¡ *
l
 = 
	`luaL_İt¡ršg
(
L
, 1, 
NULL
);

210 
İ
 = 
	`luaL_checkİtiÚ
(
L
, 2, "®l", 
ÿŠames
);

211 
	`lua_push¡ršg
(
L
, 
	`£oÿË
(
ÿt
[
İ
], 
l
));

213 
	}
}

216 
	$os_ex™
 (
lua_S‹
 *
L
) {

217 
	`ex™
(
	`luaL_İtšt
(
L
, 1, 
EXIT_SUCCESS
));

218 
	}
}

220 cÚ¡ 
luaL_Reg
 
	gsy¦ib
[] = {

221 {"şock", 
os_şock
},

222 {"d©e", 
os_d©e
},

223 {"difáime", 
os_difáime
},

224 {"execu‹", 
os_execu‹
},

225 {"ex™", 
os_ex™
},

226 {"g‘’v", 
os_g‘’v
},

227 {"»move", 
os_»move
},

228 {"»Çme", 
os_»Çme
},

229 {"£oÿË", 
os_£oÿË
},

230 {"time", 
os_time
},

231 {"tm²ame", 
os_tm²ame
},

232 {
NULL
, NULL}

239 
LUALIB_API
 
	$luaİ’_os
 (
lua_S‹
 *
L
) {

240 
	`luaL_»gi¡”
(
L
, 
LUA_OSLIBNAME
, 
sy¦ib
);

242 
	}
}

	@deps/lua/src/lparser.c

8 
	~<¡ršg.h
>

10 
	#Í¬£r_c


	)

11 
	#LUA_CORE


	)

13 
	~"lua.h
"

15 
	~"lcode.h
"

16 
	~"ldebug.h
"

17 
	~"ldo.h
"

18 
	~"lfunc.h
"

19 
	~"Îex.h
"

20 
	~"lmem.h
"

21 
	~"lobjeù.h
"

22 
	~"lİcodes.h
"

23 
	~"Í¬£r.h
"

24 
	~"l¡©e.h
"

25 
	~"l¡ršg.h
"

26 
	~"ÉabË.h
"

30 
	#hasmuÉ»t
(
k
è((kè=ğ
VCALL
 || (kè=ğ
VVARARG
)

	)

32 
	#g‘locv¬
(
fs
, 
i
è((fs)->
f
->
locv¬s
[(fs)->
aùv¬
[i]])

	)

34 
	#luaY_checklim™
(
fs
,
v
,
l
,
m
èià((v)>Ö)è
	`”rÜlim™
(fs,l,m)

	)

40 
	sBlockCÁ
 {

41 
BlockCÁ
 *
	m´evious
;

42 
	mb»akli¡
;

43 
lu_by‹
 
	mÇùv¬
;

44 
lu_by‹
 
	mupv®
;

45 
lu_by‹
 
	misb»akabË
;

46 } 
	tBlockCÁ
;

53 
chunk
 (
LexS‹
 *
ls
);

54 
ex´
 (
LexS‹
 *
ls
, 
expdesc
 *
v
);

57 
	$ªchÜ_tok’
 (
LexS‹
 *
ls
) {

58 ià(
ls
->
t
.
tok’
 =ğ
TK_NAME
 ||†s->t.tok’ =ğ
TK_STRING
) {

59 
TSŒšg
 *
ts
 = 
ls
->
t
.
£mšfo
.ts;

60 
	`luaX_Ãw¡ršg
(
ls
, 
	`g‘¡r
(
ts
),s->
tsv
.
Ën
);

62 
	}
}

65 
	$”rÜ_ex³ùed
 (
LexS‹
 *
ls
, 
tok’
) {

66 
	`luaX_syÁax”rÜ
(
ls
,

67 
	`luaO_pushf¡ršg
(
ls
->
L
, 
LUA_QS
 "ƒx³ùed", 
	`luaX_tok’2¡r
Ös, 
tok’
)));

68 
	}
}

71 
	$”rÜlim™
 (
FuncS‹
 *
fs
, 
lim™
, cÚ¡ *
wh©
) {

72 cÚ¡ *
msg
 = (
fs
->
f
->
lšedefšed
 == 0) ?

73 
	`luaO_pushf¡ršg
(
fs
->
L
, "maš funùiÚ ha mÜthª %d %s", 
lim™
, 
wh©
) :

74 
	`luaO_pushf¡ršg
(
fs
->
L
, "function‡t†ine %d has morehan %d %s",

75 
fs
->
f
->
lšedefšed
, 
lim™
, 
wh©
);

76 
	`luaX_Ëx”rÜ
(
fs
->
ls
, 
msg
, 0);

77 
	}
}

80 
	$‹¡Ãxt
 (
LexS‹
 *
ls
, 
c
) {

81 ià(
ls
->
t
.
tok’
 =ğ
c
) {

82 
	`luaX_Ãxt
(
ls
);

86 
	}
}

89 
	$check
 (
LexS‹
 *
ls
, 
c
) {

90 ià(
ls
->
t
.
tok’
 !ğ
c
)

91 
	`”rÜ_ex³ùed
(
ls
, 
c
);

92 
	}
}

94 
	$checkÃxt
 (
LexS‹
 *
ls
, 
c
) {

95 
	`check
(
ls
, 
c
);

96 
	`luaX_Ãxt
(
ls
);

97 
	}
}

100 
	#check_cÚd™iÚ
(
ls
,
c
,
msg
è{ ià(!(c)è
	`luaX_syÁax”rÜ
Ös, msg); }

	)

104 
	$check_m©ch
 (
LexS‹
 *
ls
, 
wh©
, 
who
, 
wh”e
) {

105 ià(!
	`‹¡Ãxt
(
ls
, 
wh©
)) {

106 ià(
wh”e
 =ğ
ls
->
lš’umb”
)

107 
	`”rÜ_ex³ùed
(
ls
, 
wh©
);

109 
	`luaX_syÁax”rÜ
(
ls
, 
	`luaO_pushf¡ršg
Ös->
L
,

110 
LUA_QS
 "ƒxpected (to close " LUA_QS "‡t†ine %d)",

111 
	`luaX_tok’2¡r
(
ls
, 
wh©
),†uaX_tok’2¡rÖs, 
who
), 
wh”e
));

114 
	}
}

117 
TSŒšg
 *
	$¡r_checkÇme
 (
LexS‹
 *
ls
) {

118 
TSŒšg
 *
ts
;

119 
	`check
(
ls
, 
TK_NAME
);

120 
ts
 = 
ls
->
t
.
£mšfo
.ts;

121 
	`luaX_Ãxt
(
ls
);

122  
ts
;

123 
	}
}

126 
	$š™_exp
 (
expdesc
 *
e
, 
expkšd
 
k
, 
i
) {

127 
e
->
f
 =ƒ->
t
 = 
NO_JUMP
;

128 
e
->
k
 = k;

129 
e
->
u
.
s
.
šfo
 = 
i
;

130 
	}
}

133 
	$code¡ršg
 (
LexS‹
 *
ls
, 
expdesc
 *
e
, 
TSŒšg
 *
s
) {

134 
	`š™_exp
(
e
, 
VK
, 
	`luaK_¡ršgK
(
ls
->
fs
, 
s
));

135 
	}
}

138 
	$checkÇme
(
LexS‹
 *
ls
, 
expdesc
 *
e
) {

139 
	`code¡ršg
(
ls
, 
e
, 
	`¡r_checkÇme
(ls));

140 
	}
}

143 
	$»gi¡”loÿlv¬
 (
LexS‹
 *
ls
, 
TSŒšg
 *
v¬Çme
) {

144 
FuncS‹
 *
fs
 = 
ls
->fs;

145 
PrÙo
 *
f
 = 
fs
->f;

146 
Şdsize
 = 
f
->
siz–ocv¬s
;

147 
	`luaM_growveùÜ
(
ls
->
L
, 
f
->
locv¬s
, 
fs
->
Æocv¬s
, f->
siz–ocv¬s
,

148 
LocV¬
, 
SHRT_MAX
, "too many†ocal variables");

149 
Şdsize
 < 
f
->
siz–ocv¬s
èf->
locv¬s
[Şdsize++].
v¬Çme
 = 
NULL
;

150 
f
->
locv¬s
[
fs
->
Æocv¬s
].
v¬Çme
 = varname;

151 
	`luaC_objb¬r›r
(
ls
->
L
, 
f
, 
v¬Çme
);

152  
fs
->
Æocv¬s
++;

153 
	}
}

156 
	#Ãw_loÿlv¬l™”®
(
ls
,
v
,
n
) \

157 
	`Ãw_loÿlv¬
(
ls
, 
	`luaX_Ãw¡ršg
Ös, "" 
v
, ((v)/())-1), 
n
)

	)

160 
	$Ãw_loÿlv¬
 (
LexS‹
 *
ls
, 
TSŒšg
 *
Çme
, 
n
) {

161 
FuncS‹
 *
fs
 = 
ls
->fs;

162 
	`luaY_checklim™
(
fs
, fs->
Çùv¬
+
n
+1, 
LUAI_MAXVARS
, "local variables");

163 
fs
->
aùv¬
[fs->
Çùv¬
+
n
] = 
	`ÿ¡
(, 
	`»gi¡”loÿlv¬
(
ls
, 
Çme
));

164 
	}
}

167 
	$adju¡loÿlv¬s
 (
LexS‹
 *
ls
, 
nv¬s
) {

168 
FuncS‹
 *
fs
 = 
ls
->fs;

169 
fs
->
Çùv¬
 = 
	`ÿ¡_by‹
(fs->Çùv¬ + 
nv¬s
);

170 ; 
nv¬s
;‚vars--) {

171 
	`g‘locv¬
(
fs
, fs->
Çùv¬
 - 
nv¬s
).
¡¬c
 = fs->
pc
;

173 
	}
}

176 
	$»movev¬s
 (
LexS‹
 *
ls
, 
tŞev–
) {

177 
FuncS‹
 *
fs
 = 
ls
->fs;

178 
fs
->
Çùv¬
 > 
tŞev–
)

179 
	`g‘locv¬
(
fs
, --fs->
Çùv¬
).
’dpc
 = fs->
pc
;

180 
	}
}

183 
	$šdexupv®ue
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
Çme
, 
expdesc
 *
v
) {

184 
i
;

185 
PrÙo
 *
f
 = 
fs
->f;

186 
Şdsize
 = 
f
->
sizeupv®ues
;

187 
i
=0; i<
f
->
nups
; i++) {

188 ià(
fs
->
upv®ues
[
i
].
k
 =ğ
v
->k && fs->upv®ues[i].
šfo
 =ğv->
u
.
s
.info) {

189 
	`lua_as£¹
(
f
->
upv®ues
[
i
] =ğ
Çme
);

190  
i
;

194 
	`luaY_checklim™
(
fs
, 
f
->
nups
 + 1, 
LUAI_MAXUPVALUES
, "upvalues");

195 
	`luaM_growveùÜ
(
fs
->
L
, 
f
->
upv®ues
, f->
nups
, f->
sizeupv®ues
,

196 
TSŒšg
 *, 
MAX_INT
, "");

197 
Şdsize
 < 
f
->
sizeupv®ues
èf->
upv®ues
[Şdsize++] = 
NULL
;

198 
f
->
upv®ues
[f->
nups
] = 
Çme
;

199 
	`luaC_objb¬r›r
(
fs
->
L
, 
f
, 
Çme
);

200 
	`lua_as£¹
(
v
->
k
 =ğ
VLOCAL
 || v->k =ğ
VUPVAL
);

201 
fs
->
upv®ues
[
f
->
nups
].
k
 = 
	`ÿ¡_by‹
(
v
->k);

202 
fs
->
upv®ues
[
f
->
nups
].
šfo
 = 
	`ÿ¡_by‹
(
v
->
u
.
s
.info);

203  
f
->
nups
++;

204 
	}
}

207 
	$£¬chv¬
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
n
) {

208 
i
;

209 
i
=
fs
->
Çùv¬
-1; i >= 0; i--) {

210 ià(
n
 =ğ
	`g‘locv¬
(
fs
, 
i
).
v¬Çme
)

211  
i
;

214 
	}
}

217 
	$m¬kupv®
 (
FuncS‹
 *
fs
, 
Ëv–
) {

218 
BlockCÁ
 *
bl
 = 
fs
->bl;

219 
bl
 && bl->
Çùv¬
 > 
Ëv–
èbÈğbl->
´evious
;

220 ià(
bl
èbl->
upv®
 = 1;

221 
	}
}

224 
	$sšgËv¬aux
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
n
, 
expdesc
 *
v¬
, 
ba£
) {

225 ià(
fs
 =ğ
NULL
) {

226 
	`š™_exp
(
v¬
, 
VGLOBAL
, 
NO_REG
);

227  
VGLOBAL
;

230 
v
 = 
	`£¬chv¬
(
fs
, 
n
);

231 ià(
v
 >= 0) {

232 
	`š™_exp
(
v¬
, 
VLOCAL
, 
v
);

233 ià(!
ba£
)

234 
	`m¬kupv®
(
fs
, 
v
);

235  
VLOCAL
;

238 ià(
	`sšgËv¬aux
(
fs
->
´ev
, 
n
, 
v¬
, 0è=ğ
VGLOBAL
)

239  
VGLOBAL
;

240 
v¬
->
u
.
s
.
šfo
 = 
	`šdexupv®ue
(
fs
, 
n
, var);

241 
v¬
->
k
 = 
VUPVAL
;

242  
VUPVAL
;

245 
	}
}

248 
	$sšgËv¬
 (
LexS‹
 *
ls
, 
expdesc
 *
v¬
) {

249 
TSŒšg
 *
v¬Çme
 = 
	`¡r_checkÇme
(
ls
);

250 
FuncS‹
 *
fs
 = 
ls
->fs;

251 ià(
	`sšgËv¬aux
(
fs
, 
v¬Çme
, 
v¬
, 1è=ğ
VGLOBAL
)

252 
v¬
->
u
.
s
.
šfo
 = 
	`luaK_¡ršgK
(
fs
, 
v¬Çme
);

253 
	}
}

256 
	$adju¡_assign
 (
LexS‹
 *
ls
, 
nv¬s
, 
Ãxps
, 
expdesc
 *
e
) {

257 
FuncS‹
 *
fs
 = 
ls
->fs;

258 
exŒa
 = 
nv¬s
 - 
Ãxps
;

259 ià(
	`hasmuÉ»t
(
e
->
k
)) {

260 
exŒa
++;

261 ià(
exŒa
 < 0)ƒxtra = 0;

262 
	`luaK_£Œ‘uºs
(
fs
, 
e
, 
exŒa
);

263 ià(
exŒa
 > 1è
	`luaK_»£rv”egs
(
fs
,ƒxtra-1);

266 ià(
e
->
k
 !ğ
VVOID
è
	`luaK_exp2ÃxŒeg
(
fs
,ƒ);

267 ià(
exŒa
 > 0) {

268 
»g
 = 
fs
->
ä“»g
;

269 
	`luaK_»£rv”egs
(
fs
, 
exŒa
);

270 
	`luaK_n
(
fs
, 
»g
, 
exŒa
);

273 
	}
}

276 
	$’‹¾ev–
 (
LexS‹
 *
ls
) {

277 ià(++
ls
->
L
->
nCÿÎs
 > 
LUAI_MAXCCALLS
)

278 
	`luaX_Ëx”rÜ
(
ls
, "chunk hasoo many syntax†evels", 0);

279 
	}
}

282 
	#Ëav–ev–
(
ls
è(Ös)->
L
->
nCÿÎs
--)

	)

285 
	$’‹rblock
 (
FuncS‹
 *
fs
, 
BlockCÁ
 *
bl
, 
lu_by‹
 
isb»akabË
) {

286 
bl
->
b»akli¡
 = 
NO_JUMP
;

287 
bl
->
isb»akabË
 = isbreakable;

288 
bl
->
Çùv¬
 = 
fs
->nactvar;

289 
bl
->
upv®
 = 0;

290 
bl
->
´evious
 = 
fs
->bl;

291 
fs
->
bl
 = bl;

292 
	`lua_as£¹
(
fs
->
ä“»g
 =ğfs->
Çùv¬
);

293 
	}
}

296 
	$Ëaveblock
 (
FuncS‹
 *
fs
) {

297 
BlockCÁ
 *
bl
 = 
fs
->bl;

298 
fs
->
bl
 = bl->
´evious
;

299 
	`»movev¬s
(
fs
->
ls
, 
bl
->
Çùv¬
);

300 ià(
bl
->
upv®
)

301 
	`luaK_codeABC
(
fs
, 
OP_CLOSE
, 
bl
->
Çùv¬
, 0, 0);

303 
	`lua_as£¹
(!
bl
->
isb»akabË
 || !bl->
upv®
);

304 
	`lua_as£¹
(
bl
->
Çùv¬
 =ğ
fs
->nactvar);

305 
fs
->
ä“»g
 = fs->
Çùv¬
;

306 
	`luaK_·tchtoh”e
(
fs
, 
bl
->
b»akli¡
);

307 
	}
}

310 
	$pushşosu»
 (
LexS‹
 *
ls
, 
FuncS‹
 *
func
, 
expdesc
 *
v
) {

311 
FuncS‹
 *
fs
 = 
ls
->fs;

312 
PrÙo
 *
f
 = 
fs
->f;

313 
Şdsize
 = 
f
->
siz•
;

314 
i
;

315 
	`luaM_growveùÜ
(
ls
->
L
, 
f
->
p
, 
fs
->
Å
, f->
siz•
, 
PrÙo
 *,

316 
MAXARG_Bx
, "constantable overflow");

317 
Şdsize
 < 
f
->
siz•
èf->
p
[Şdsize++] = 
NULL
;

318 
f
->
p
[
fs
->
Å
++] = 
func
->f;

319 
	`luaC_objb¬r›r
(
ls
->
L
, 
f
, 
func
->f);

320 
	`š™_exp
(
v
, 
VRELOCABLE
, 
	`luaK_codeABx
(
fs
, 
OP_CLOSURE
, 0, fs->
Å
-1));

321 
i
=0; i<
func
->
f
->
nups
; i++) {

322 
OpCode
 
o
 = (
func
->
upv®ues
[
i
].
k
 =ğ
VLOCAL
è? 
OP_MOVE
 : 
OP_GETUPVAL
;

323 
	`luaK_codeABC
(
fs
, 
o
, 0, 
func
->
upv®ues
[
i
].
šfo
, 0);

325 
	}
}

328 
	$İ’_func
 (
LexS‹
 *
ls
, 
FuncS‹
 *
fs
) {

329 
lua_S‹
 *
L
 = 
ls
->L;

330 
PrÙo
 *
f
 = 
	`luaF_Ãw´Ùo
(
L
);

331 
fs
->
f
 = f;

332 
fs
->
´ev
 = 
ls
->fs;

333 
fs
->
ls
 =†s;

334 
fs
->
L
 = L;

335 
ls
->
fs
 = fs;

336 
fs
->
pc
 = 0;

337 
fs
->
Ï¡rg‘
 = -1;

338 
fs
->
jpc
 = 
NO_JUMP
;

339 
fs
->
ä“»g
 = 0;

340 
fs
->
nk
 = 0;

341 
fs
->
Å
 = 0;

342 
fs
->
Æocv¬s
 = 0;

343 
fs
->
Çùv¬
 = 0;

344 
fs
->
bl
 = 
NULL
;

345 
f
->
sourû
 = 
ls
->source;

346 
f
->
max¡acksize
 = 2;

347 
fs
->
h
 = 
	`luaH_Ãw
(
L
, 0, 0);

349 
	`£thv®ue2s
(
L
, L->
tİ
, 
fs
->
h
);

350 
	`šü_tİ
(
L
);

351 
	`£tv®ue2s
(
L
, L->
tİ
, 
f
);

352 
	`šü_tİ
(
L
);

353 
	}
}

356 
	$şo£_func
 (
LexS‹
 *
ls
) {

357 
lua_S‹
 *
L
 = 
ls
->L;

358 
FuncS‹
 *
fs
 = 
ls
->fs;

359 
PrÙo
 *
f
 = 
fs
->f;

360 
	`»movev¬s
(
ls
, 0);

361 
	`luaK_»t
(
fs
, 0, 0);

362 
	`luaM_»®locveùÜ
(
L
, 
f
->
code
, f->
sizecode
, 
fs
->
pc
, 
In¡ruùiÚ
);

363 
f
->
sizecode
 = 
fs
->
pc
;

364 
	`luaM_»®locveùÜ
(
L
, 
f
->
lšešfo
, f->
siz–šešfo
, 
fs
->
pc
, );

365 
f
->
siz–šešfo
 = 
fs
->
pc
;

366 
	`luaM_»®locveùÜ
(
L
, 
f
->
k
, f->
sizek
, 
fs
->
nk
, 
TV®ue
);

367 
f
->
sizek
 = 
fs
->
nk
;

368 
	`luaM_»®locveùÜ
(
L
, 
f
->
p
, f->
siz•
, 
fs
->
Å
, 
PrÙo
 *);

369 
f
->
siz•
 = 
fs
->
Å
;

370 
	`luaM_»®locveùÜ
(
L
, 
f
->
locv¬s
, f->
siz–ocv¬s
, 
fs
->
Æocv¬s
, 
LocV¬
);

371 
f
->
siz–ocv¬s
 = 
fs
->
Æocv¬s
;

372 
	`luaM_»®locveùÜ
(
L
, 
f
->
upv®ues
, f->
sizeupv®ues
, f->
nups
, 
TSŒšg
 *);

373 
f
->
sizeupv®ues
 = f->
nups
;

374 
	`lua_as£¹
(
	`luaG_checkcode
(
f
));

375 
	`lua_as£¹
(
fs
->
bl
 =ğ
NULL
);

376 
ls
->
fs
 = fs->
´ev
;

378 ià(
fs
è
	`ªchÜ_tok’
(
ls
);

379 
L
->
tİ
 -= 2;

380 
	}
}

383 
PrÙo
 *
	$luaY_·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
Mbufãr
 *
buff
, cÚ¡ *
Çme
) {

384 
LexS‹
 
Ëx¡©e
;

385 
FuncS‹
 
func¡©e
;

386 
Ëx¡©e
.
buff
 = buff;

387 
	`luaX_£tšput
(
L
, &
Ëx¡©e
, 
z
, 
	`luaS_Ãw
(L, 
Çme
));

388 
	`İ’_func
(&
Ëx¡©e
, &
func¡©e
);

389 
func¡©e
.
f
->
is_v¬¬g
 = 
VARARG_ISVARARG
;

390 
	`luaX_Ãxt
(&
Ëx¡©e
);

391 
	`chunk
(&
Ëx¡©e
);

392 
	`check
(&
Ëx¡©e
, 
TK_EOS
);

393 
	`şo£_func
(&
Ëx¡©e
);

394 
	`lua_as£¹
(
func¡©e
.
´ev
 =ğ
NULL
);

395 
	`lua_as£¹
(
func¡©e
.
f
->
nups
 == 0);

396 
	`lua_as£¹
(
Ëx¡©e
.
fs
 =ğ
NULL
);

397  
func¡©e
.
f
;

398 
	}
}

407 
	$f›ld
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

409 
FuncS‹
 *
fs
 = 
ls
->fs;

410 
expdesc
 
key
;

411 
	`luaK_exp2ªy»g
(
fs
, 
v
);

412 
	`luaX_Ãxt
(
ls
);

413 
	`checkÇme
(
ls
, &
key
);

414 
	`luaK_šdexed
(
fs
, 
v
, &
key
);

415 
	}
}

418 
	$yšdex
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

420 
	`luaX_Ãxt
(
ls
);

421 
	`ex´
(
ls
, 
v
);

422 
	`luaK_exp2v®
(
ls
->
fs
, 
v
);

423 
	`checkÃxt
(
ls
, ']');

424 
	}
}

434 
	sCÚsCÚŒŞ
 {

435 
expdesc
 
	mv
;

436 
expdesc
 *
	mt
;

437 
	mnh
;

438 
	mÇ
;

439 
	mto¡Üe
;

443 
	$»cf›ld
 (
LexS‹
 *
ls
, 
CÚsCÚŒŞ
 *
cc
) {

445 
FuncS‹
 *
fs
 = 
ls
->fs;

446 
»g
 = 
ls
->
fs
->
ä“»g
;

447 
expdesc
 
key
, 
v®
;

448 
rkkey
;

449 ià(
ls
->
t
.
tok’
 =ğ
TK_NAME
) {

450 
	`luaY_checklim™
(
fs
, 
cc
->
nh
, 
MAX_INT
, "items in‡ constructor");

451 
	`checkÇme
(
ls
, &
key
);

454 
	`yšdex
(
ls
, &
key
);

455 
cc
->
nh
++;

456 
	`checkÃxt
(
ls
, '=');

457 
rkkey
 = 
	`luaK_exp2RK
(
fs
, &
key
);

458 
	`ex´
(
ls
, &
v®
);

459 
	`luaK_codeABC
(
fs
, 
OP_SETTABLE
, 
cc
->
t
->
u
.
s
.
šfo
, 
rkkey
, 
	`luaK_exp2RK
(fs, &
v®
));

460 
fs
->
ä“»g
 = 
»g
;

461 
	}
}

464 
	$şo£li¡f›ld
 (
FuncS‹
 *
fs
, 
CÚsCÚŒŞ
 *
cc
) {

465 ià(
cc
->
v
.
k
 =ğ
VVOID
) ;

466 
	`luaK_exp2ÃxŒeg
(
fs
, &
cc
->
v
);

467 
cc
->
v
.
k
 = 
VVOID
;

468 ià(
cc
->
to¡Üe
 =ğ
LFIELDS_PER_FLUSH
) {

469 
	`luaK_£i¡
(
fs
, 
cc
->
t
->
u
.
s
.
šfo
, cc->
Ç
, cc->
to¡Üe
);

470 
cc
->
to¡Üe
 = 0;

472 
	}
}

475 
	$Ï¡li¡f›ld
 (
FuncS‹
 *
fs
, 
CÚsCÚŒŞ
 *
cc
) {

476 ià(
cc
->
to¡Üe
 == 0) ;

477 ià(
	`hasmuÉ»t
(
cc
->
v
.
k
)) {

478 
	`luaK_£tmuÉ»t
(
fs
, &
cc
->
v
);

479 
	`luaK_£i¡
(
fs
, 
cc
->
t
->
u
.
s
.
šfo
, cc->
Ç
, 
LUA_MULTRET
);

480 
cc
->
Ç
--;

483 ià(
cc
->
v
.
k
 !ğ
VVOID
)

484 
	`luaK_exp2ÃxŒeg
(
fs
, &
cc
->
v
);

485 
	`luaK_£i¡
(
fs
, 
cc
->
t
->
u
.
s
.
šfo
, cc->
Ç
, cc->
to¡Üe
);

487 
	}
}

490 
	$li¡f›ld
 (
LexS‹
 *
ls
, 
CÚsCÚŒŞ
 *
cc
) {

491 
	`ex´
(
ls
, &
cc
->
v
);

492 
	`luaY_checklim™
(
ls
->
fs
, 
cc
->
Ç
, 
MAX_INT
, "items in‡ constructor");

493 
cc
->
Ç
++;

494 
cc
->
to¡Üe
++;

495 
	}
}

498 
	$cÚ¡ruùÜ
 (
LexS‹
 *
ls
, 
expdesc
 *
t
) {

500 
FuncS‹
 *
fs
 = 
ls
->fs;

501 
lše
 = 
ls
->
lš’umb”
;

502 
pc
 = 
	`luaK_codeABC
(
fs
, 
OP_NEWTABLE
, 0, 0, 0);

503 
CÚsCÚŒŞ
 
cc
;

504 
cc
.
Ç
 = cc.
nh
 = cc.
to¡Üe
 = 0;

505 
cc
.
t
 =;

506 
	`š™_exp
(
t
, 
VRELOCABLE
, 
pc
);

507 
	`š™_exp
(&
cc
.
v
, 
VVOID
, 0);

508 
	`luaK_exp2ÃxŒeg
(
ls
->
fs
, 
t
);

509 
	`checkÃxt
(
ls
, '{');

511 
	`lua_as£¹
(
cc
.
v
.
k
 =ğ
VVOID
 || cc.
to¡Üe
 > 0);

512 ià(
ls
->
t
.
tok’
 == '}') ;

513 
	`şo£li¡f›ld
(
fs
, &
cc
);

514 
ls
->
t
.
tok’
) {

515 
TK_NAME
: {

516 
	`luaX_lookah—d
(
ls
);

517 ià(
ls
->
lookah—d
.
tok’
 != '=')

518 
	`li¡f›ld
(
ls
, &
cc
);

520 
	`»cf›ld
(
ls
, &
cc
);

524 
	`»cf›ld
(
ls
, &
cc
);

528 
	`li¡f›ld
(
ls
, &
cc
);

532 } 
	`‹¡Ãxt
(
ls
, ',') ||estnext(ls, ';'));

533 
	`check_m©ch
(
ls
, '}', '{', 
lše
);

534 
	`Ï¡li¡f›ld
(
fs
, &
cc
);

535 
	`SETARG_B
(
fs
->
f
->
code
[
pc
], 
	`luaO_št2fb
(
cc
.
Ç
));

536 
	`SETARG_C
(
fs
->
f
->
code
[
pc
], 
	`luaO_št2fb
(
cc
.
nh
));

537 
	}
}

543 
	$·¾i¡
 (
LexS‹
 *
ls
) {

545 
FuncS‹
 *
fs
 = 
ls
->fs;

546 
PrÙo
 *
f
 = 
fs
->f;

547 
Å¬ams
 = 0;

548 
f
->
is_v¬¬g
 = 0;

549 ià(
ls
->
t
.
tok’
 != ')') {

551 
ls
->
t
.
tok’
) {

552 
TK_NAME
: {

553 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
Ös), 
Å¬ams
++);

556 
TK_DOTS
: {

557 
	`luaX_Ãxt
(
ls
);

558 #ià
	`defšed
(
LUA_COMPAT_VARARG
)

560 
	`Ãw_loÿlv¬l™”®
(
ls
, "¬g", 
Å¬ams
++);

561 
f
->
is_v¬¬g
 = 
VARARG_HASARG
 | 
VARARG_NEEDSARG
;

563 
f
->
is_v¬¬g
 |ğ
VARARG_ISVARARG
;

566 : 
	`luaX_syÁax”rÜ
(
ls
, "<Çme> o¸" 
	`LUA_QL
("...") "ƒxpected");

568 } !
f
->
is_v¬¬g
 && 
	`‹¡Ãxt
(
ls
, ','));

570 
	`adju¡loÿlv¬s
(
ls
, 
Å¬ams
);

571 
f
->
num·¿ms
 = 
	`ÿ¡_by‹
(
fs
->
Çùv¬
 - (f->
is_v¬¬g
 & 
VARARG_HASARG
));

572 
	`luaK_»£rv”egs
(
fs
, fs->
Çùv¬
);

573 
	}
}

576 
	$body
 (
LexS‹
 *
ls
, 
expdesc
 *
e
, 
Ãed£lf
, 
lše
) {

578 
FuncS‹
 
Ãw_fs
;

579 
	`İ’_func
(
ls
, &
Ãw_fs
);

580 
Ãw_fs
.
f
->
lšedefšed
 = 
lše
;

581 
	`checkÃxt
(
ls
, '(');

582 ià(
Ãed£lf
) {

583 
	`Ãw_loÿlv¬l™”®
(
ls
, "self", 0);

584 
	`adju¡loÿlv¬s
(
ls
, 1);

586 
	`·¾i¡
(
ls
);

587 
	`checkÃxt
(
ls
, ')');

588 
	`chunk
(
ls
);

589 
Ãw_fs
.
f
->
Ï¡lšedefšed
 = 
ls
->
lš’umb”
;

590 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_FUNCTION
, 
lše
);

591 
	`şo£_func
(
ls
);

592 
	`pushşosu»
(
ls
, &
Ãw_fs
, 
e
);

593 
	}
}

596 
	$ex¶i¡1
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

598 
n
 = 1;

599 
	`ex´
(
ls
, 
v
);

600 
	`‹¡Ãxt
(
ls
, ',')) {

601 
	`luaK_exp2ÃxŒeg
(
ls
->
fs
, 
v
);

602 
	`ex´
(
ls
, 
v
);

603 
n
++;

605  
n
;

606 
	}
}

609 
	$funÿrgs
 (
LexS‹
 *
ls
, 
expdesc
 *
f
) {

610 
FuncS‹
 *
fs
 = 
ls
->fs;

611 
expdesc
 
¬gs
;

612 
ba£
, 
Å¬ams
;

613 
lše
 = 
ls
->
lš’umb”
;

614 
ls
->
t
.
tok’
) {

616 ià(
lše
 !ğ
ls
->
Ï¡lše
)

617 
	`luaX_syÁax”rÜ
(
ls
,"ambiguous syntax (function call x‚ew statement)");

618 
	`luaX_Ãxt
(
ls
);

619 ià(
ls
->
t
.
tok’
 == ')')

620 
¬gs
.
k
 = 
VVOID
;

622 
	`ex¶i¡1
(
ls
, &
¬gs
);

623 
	`luaK_£tmuÉ»t
(
fs
, &
¬gs
);

625 
	`check_m©ch
(
ls
, ')', '(', 
lše
);

629 
	`cÚ¡ruùÜ
(
ls
, &
¬gs
);

632 
TK_STRING
: {

633 
	`code¡ršg
(
ls
, &
¬gs
,†s->
t
.
£mšfo
.
ts
);

634 
	`luaX_Ãxt
(
ls
);

638 
	`luaX_syÁax”rÜ
(
ls
, "function‡rgumentsƒxpected");

642 
	`lua_as£¹
(
f
->
k
 =ğ
VNONRELOC
);

643 
ba£
 = 
f
->
u
.
s
.
šfo
;

644 ià(
	`hasmuÉ»t
(
¬gs
.
k
))

645 
Å¬ams
 = 
LUA_MULTRET
;

647 ià(
¬gs
.
k
 !ğ
VVOID
)

648 
	`luaK_exp2ÃxŒeg
(
fs
, &
¬gs
);

649 
Å¬ams
 = 
fs
->
ä“»g
 - (
ba£
+1);

651 
	`š™_exp
(
f
, 
VCALL
, 
	`luaK_codeABC
(
fs
, 
OP_CALL
, 
ba£
, 
Å¬ams
+1, 2));

652 
	`luaK_fixlše
(
fs
, 
lše
);

653 
fs
->
ä“»g
 = 
ba£
+1;

655 
	}
}

667 
	$´efixexp
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

669 
ls
->
t
.
tok’
) {

671 
lše
 = 
ls
->
lš’umb”
;

672 
	`luaX_Ãxt
(
ls
);

673 
	`ex´
(
ls
, 
v
);

674 
	`check_m©ch
(
ls
, ')', '(', 
lše
);

675 
	`luaK_disch¬gev¬s
(
ls
->
fs
, 
v
);

678 
TK_NAME
: {

679 
	`sšgËv¬
(
ls
, 
v
);

683 
	`luaX_syÁax”rÜ
(
ls
, "unexpected symbol");

687 
	}
}

690 
	$´im¬yexp
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

693 
FuncS‹
 *
fs
 = 
ls
->fs;

694 
	`´efixexp
(
ls
, 
v
);

696 
ls
->
t
.
tok’
) {

698 
	`f›ld
(
ls
, 
v
);

702 
expdesc
 
key
;

703 
	`luaK_exp2ªy»g
(
fs
, 
v
);

704 
	`yšdex
(
ls
, &
key
);

705 
	`luaK_šdexed
(
fs
, 
v
, &
key
);

709 
expdesc
 
key
;

710 
	`luaX_Ãxt
(
ls
);

711 
	`checkÇme
(
ls
, &
key
);

712 
	`luaK_£lf
(
fs
, 
v
, &
key
);

713 
	`funÿrgs
(
ls
, 
v
);

716 '(': 
TK_STRING
: '{': {

717 
	`luaK_exp2ÃxŒeg
(
fs
, 
v
);

718 
	`funÿrgs
(
ls
, 
v
);

724 
	}
}

727 
	$sim¶“xp
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

730 
ls
->
t
.
tok’
) {

731 
TK_NUMBER
: {

732 
	`š™_exp
(
v
, 
VKNUM
, 0);

733 
v
->
u
.
nv®
 = 
ls
->
t
.
£mšfo
.
r
;

736 
TK_STRING
: {

737 
	`code¡ršg
(
ls
, 
v
,†s->
t
.
£mšfo
.
ts
);

740 
TK_NIL
: {

741 
	`š™_exp
(
v
, 
VNIL
, 0);

744 
TK_TRUE
: {

745 
	`š™_exp
(
v
, 
VTRUE
, 0);

748 
TK_FALSE
: {

749 
	`š™_exp
(
v
, 
VFALSE
, 0);

752 
TK_DOTS
: {

753 
FuncS‹
 *
fs
 = 
ls
->fs;

754 
	`check_cÚd™iÚ
(
ls
, 
fs
->
f
->
is_v¬¬g
,

755 "ÿÂÙ u£ " 
	`LUA_QL
("...") " outside‡ vararg function");

756 
fs
->
f
->
is_v¬¬g
 &ğ~
VARARG_NEEDSARG
;

757 
	`š™_exp
(
v
, 
VVARARG
, 
	`luaK_codeABC
(
fs
, 
OP_VARARG
, 0, 1, 0));

761 
	`cÚ¡ruùÜ
(
ls
, 
v
);

764 
TK_FUNCTION
: {

765 
	`luaX_Ãxt
(
ls
);

766 
	`body
(
ls
, 
v
, 0,†s->
lš’umb”
);

770 
	`´im¬yexp
(
ls
, 
v
);

774 
	`luaX_Ãxt
(
ls
);

775 
	}
}

778 
UnO´
 
	$g‘unİr
 (
İ
) {

779 
İ
) {

780 
TK_NOT
:  
OPR_NOT
;

781 '-':  
OPR_MINUS
;

782 '#':  
OPR_LEN
;

783 :  
OPR_NOUNOPR
;

785 
	}
}

788 
BšO´
 
	$g‘bšİr
 (
İ
) {

789 
İ
) {

790 '+':  
OPR_ADD
;

791 '-':  
OPR_SUB
;

792 '*':  
OPR_MUL
;

793 '/':  
OPR_DIV
;

794 '%':  
OPR_MOD
;

795 '^':  
OPR_POW
;

796 
TK_CONCAT
:  
OPR_CONCAT
;

797 
TK_NE
:  
OPR_NE
;

798 
TK_EQ
:  
OPR_EQ
;

799 '<':  
OPR_LT
;

800 
TK_LE
:  
OPR_LE
;

801 '>':  
OPR_GT
;

802 
TK_GE
:  
OPR_GE
;

803 
TK_AND
:  
OPR_AND
;

804 
TK_OR
:  
OPR_OR
;

805 :  
OPR_NOBINOPR
;

807 
	}
}

811 
lu_by‹
 
	mËá
;

812 
lu_by‹
 
	mright
;

813 } 
	g´iÜ™y
[] = {

821 
	#UNARY_PRIORITY
 8

	)

828 
BšO´
 
	$subex´
 (
LexS‹
 *
ls
, 
expdesc
 *
v
, 
lim™
) {

829 
BšO´
 
İ
;

830 
UnO´
 
uİ
;

831 
	`’‹¾ev–
(
ls
);

832 
uİ
 = 
	`g‘unİr
(
ls
->
t
.
tok’
);

833 ià(
uİ
 !ğ
OPR_NOUNOPR
) {

834 
	`luaX_Ãxt
(
ls
);

835 
	`subex´
(
ls
, 
v
, 
UNARY_PRIORITY
);

836 
	`luaK_´efix
(
ls
->
fs
, 
uİ
, 
v
);

838 
	`sim¶“xp
(
ls
, 
v
);

840 
İ
 = 
	`g‘bšİr
(
ls
->
t
.
tok’
);

841 
İ
 !ğ
OPR_NOBINOPR
 && 
´iÜ™y
[İ].
Ëá
 > 
lim™
) {

842 
expdesc
 
v2
;

843 
BšO´
 
Ãxtİ
;

844 
	`luaX_Ãxt
(
ls
);

845 
	`luaK_šfix
(
ls
->
fs
, 
İ
, 
v
);

847 
Ãxtİ
 = 
	`subex´
(
ls
, &
v2
, 
´iÜ™y
[
İ
].
right
);

848 
	`luaK_posfix
(
ls
->
fs
, 
İ
, 
v
, &
v2
);

849 
İ
 = 
Ãxtİ
;

851 
	`Ëav–ev–
(
ls
);

852  
İ
;

853 
	}
}

856 
	$ex´
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

857 
	`subex´
(
ls
, 
v
, 0);

858 
	}
}

871 
	$block_fŞlow
 (
tok’
) {

872 
tok’
) {

873 
TK_ELSE
: 
TK_ELSEIF
: 
TK_END
:

874 
TK_UNTIL
: 
TK_EOS
:

878 
	}
}

881 
	$block
 (
LexS‹
 *
ls
) {

883 
FuncS‹
 *
fs
 = 
ls
->fs;

884 
BlockCÁ
 
bl
;

885 
	`’‹rblock
(
fs
, &
bl
, 0);

886 
	`chunk
(
ls
);

887 
	`lua_as£¹
(
bl
.
b»akli¡
 =ğ
NO_JUMP
);

888 
	`Ëaveblock
(
fs
);

889 
	}
}

896 
	sLHS_assign
 {

897 
LHS_assign
 *
	m´ev
;

898 
expdesc
 
	mv
;

908 
	$check_cÚæiù
 (
LexS‹
 *
ls
, 
LHS_assign
 *
lh
, 
expdesc
 *
v
) {

909 
FuncS‹
 *
fs
 = 
ls
->fs;

910 
exŒa
 = 
fs
->
ä“»g
;

911 
cÚæiù
 = 0;

912 ; 
lh
;†h =†h->
´ev
) {

913 ià(
lh
->
v
.
k
 =ğ
VINDEXED
) {

914 ià(
lh
->
v
.
u
.
s
.
šfo
 == v->u.s.info) {

915 
cÚæiù
 = 1;

916 
lh
->
v
.
u
.
s
.
šfo
 = 
exŒa
;

918 ià(
lh
->
v
.
u
.
s
.
aux
 =ğv->u.s.
šfo
) {

919 
cÚæiù
 = 1;

920 
lh
->
v
.
u
.
s
.
aux
 = 
exŒa
;

924 ià(
cÚæiù
) {

925 
	`luaK_codeABC
(
fs
, 
OP_MOVE
, fs->
ä“»g
, 
v
->
u
.
s
.
šfo
, 0);

926 
	`luaK_»£rv”egs
(
fs
, 1);

928 
	}
}

931 
	$assignm’t
 (
LexS‹
 *
ls
, 
LHS_assign
 *
lh
, 
nv¬s
) {

932 
expdesc
 
e
;

933 
	`check_cÚd™iÚ
(
ls
, 
VLOCAL
 <ğ
lh
->
v
.
k
 &&†h->v.k <ğ
VINDEXED
,

935 ià(
	`‹¡Ãxt
(
ls
, ',')) {

936 
LHS_assign
 
nv
;

937 
nv
.
´ev
 = 
lh
;

938 
	`´im¬yexp
(
ls
, &
nv
.
v
);

939 ià(
nv
.
v
.
k
 =ğ
VLOCAL
)

940 
	`check_cÚæiù
(
ls
, 
lh
, &
nv
.
v
);

941 
	`luaY_checklim™
(
ls
->
fs
, 
nv¬s
, 
LUAI_MAXCCALLS
 -†s->
L
->
nCÿÎs
,

943 
	`assignm’t
(
ls
, &
nv
, 
nv¬s
+1);

946 
Ãxps
;

947 
	`checkÃxt
(
ls
, '=');

948 
Ãxps
 = 
	`ex¶i¡1
(
ls
, &
e
);

949 ià(
Ãxps
 !ğ
nv¬s
) {

950 
	`adju¡_assign
(
ls
, 
nv¬s
, 
Ãxps
, &
e
);

951 ià(
Ãxps
 > 
nv¬s
)

952 
ls
->
fs
->
ä“»g
 -ğ
Ãxps
 - 
nv¬s
;

955 
	`luaK_£tÚ”‘
(
ls
->
fs
, &
e
);

956 
	`luaK_¡Üev¬
(
ls
->
fs
, &
lh
->
v
, &
e
);

960 
	`š™_exp
(&
e
, 
VNONRELOC
, 
ls
->
fs
->
ä“»g
-1);

961 
	`luaK_¡Üev¬
(
ls
->
fs
, &
lh
->
v
, &
e
);

962 
	}
}

965 
	$cÚd
 (
LexS‹
 *
ls
) {

967 
expdesc
 
v
;

968 
	`ex´
(
ls
, &
v
);

969 ià(
v
.
k
 =ğ
VNIL
èv.k = 
VFALSE
;

970 
	`luaK_goiárue
(
ls
->
fs
, &
v
);

971  
v
.
f
;

972 
	}
}

975 
	$b»ak¡©
 (
LexS‹
 *
ls
) {

976 
FuncS‹
 *
fs
 = 
ls
->fs;

977 
BlockCÁ
 *
bl
 = 
fs
->bl;

978 
upv®
 = 0;

979 
bl
 && !bl->
isb»akabË
) {

980 
upv®
 |ğ
bl
->upval;

981 
bl
 = bl->
´evious
;

983 ià(!
bl
)

984 
	`luaX_syÁax”rÜ
(
ls
, "no†oopo break");

985 ià(
upv®
)

986 
	`luaK_codeABC
(
fs
, 
OP_CLOSE
, 
bl
->
Çùv¬
, 0, 0);

987 
	`luaK_cÚÿt
(
fs
, &
bl
->
b»akli¡
, 
	`luaK_jump
(fs));

988 
	}
}

991 
	$whe¡©
 (
LexS‹
 *
ls
, 
lše
) {

993 
FuncS‹
 *
fs
 = 
ls
->fs;

994 
wheš™
;

995 
cÚdex™
;

996 
BlockCÁ
 
bl
;

997 
	`luaX_Ãxt
(
ls
);

998 
wheš™
 = 
	`luaK_g‘Ïb–
(
fs
);

999 
cÚdex™
 = 
	`cÚd
(
ls
);

1000 
	`’‹rblock
(
fs
, &
bl
, 1);

1001 
	`checkÃxt
(
ls
, 
TK_DO
);

1002 
	`block
(
ls
);

1003 
	`luaK_·tchli¡
(
fs
, 
	`luaK_jump
(fs), 
wheš™
);

1004 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_WHILE
, 
lše
);

1005 
	`Ëaveblock
(
fs
);

1006 
	`luaK_·tchtoh”e
(
fs
, 
cÚdex™
);

1007 
	}
}

1010 
	$»³©¡©
 (
LexS‹
 *
ls
, 
lše
) {

1012 
cÚdex™
;

1013 
FuncS‹
 *
fs
 = 
ls
->fs;

1014 
»³©_š™
 = 
	`luaK_g‘Ïb–
(
fs
);

1015 
BlockCÁ
 
bl1
, 
bl2
;

1016 
	`’‹rblock
(
fs
, &
bl1
, 1);

1017 
	`’‹rblock
(
fs
, &
bl2
, 0);

1018 
	`luaX_Ãxt
(
ls
);

1019 
	`chunk
(
ls
);

1020 
	`check_m©ch
(
ls
, 
TK_UNTIL
, 
TK_REPEAT
, 
lše
);

1021 
cÚdex™
 = 
	`cÚd
(
ls
);

1022 ià(!
bl2
.
upv®
) {

1023 
	`Ëaveblock
(
fs
);

1024 
	`luaK_·tchli¡
(
ls
->
fs
, 
cÚdex™
, 
»³©_š™
);

1027 
	`b»ak¡©
(
ls
);

1028 
	`luaK_·tchtoh”e
(
ls
->
fs
, 
cÚdex™
);

1029 
	`Ëaveblock
(
fs
);

1030 
	`luaK_·tchli¡
(
ls
->
fs
, 
	`luaK_jump
(fs), 
»³©_š™
);

1032 
	`Ëaveblock
(
fs
);

1033 
	}
}

1036 
	$exp1
 (
LexS‹
 *
ls
) {

1037 
expdesc
 
e
;

1038 
k
;

1039 
	`ex´
(
ls
, &
e
);

1040 
k
 = 
e
.k;

1041 
	`luaK_exp2ÃxŒeg
(
ls
->
fs
, &
e
);

1042  
k
;

1043 
	}
}

1046 
	$fÜbody
 (
LexS‹
 *
ls
, 
ba£
, 
lše
, 
nv¬s
, 
i¢um
) {

1048 
BlockCÁ
 
bl
;

1049 
FuncS‹
 *
fs
 = 
ls
->fs;

1050 
´•
, 
’dfÜ
;

1051 
	`adju¡loÿlv¬s
(
ls
, 3);

1052 
	`checkÃxt
(
ls
, 
TK_DO
);

1053 
´•
 = 
i¢um
 ? 
	`luaK_codeAsBx
(
fs
, 
OP_FORPREP
, 
ba£
, 
NO_JUMP
è: 
	`luaK_jump
(fs);

1054 
	`’‹rblock
(
fs
, &
bl
, 0);

1055 
	`adju¡loÿlv¬s
(
ls
, 
nv¬s
);

1056 
	`luaK_»£rv”egs
(
fs
, 
nv¬s
);

1057 
	`block
(
ls
);

1058 
	`Ëaveblock
(
fs
);

1059 
	`luaK_·tchtoh”e
(
fs
, 
´•
);

1060 
’dfÜ
 = (
i¢um
è? 
	`luaK_codeAsBx
(
fs
, 
OP_FORLOOP
, 
ba£
, 
NO_JUMP
) :

1061 
	`luaK_codeABC
(
fs
, 
OP_TFORLOOP
, 
ba£
, 0, 
nv¬s
);

1062 
	`luaK_fixlše
(
fs
, 
lše
);

1063 
	`luaK_·tchli¡
(
fs
, (
i¢um
 ? 
’dfÜ
 : 
	`luaK_jump
(fs)), 
´•
 + 1);

1064 
	}
}

1067 
	$fÜnum
 (
LexS‹
 *
ls
, 
TSŒšg
 *
v¬Çme
, 
lše
) {

1069 
FuncS‹
 *
fs
 = 
ls
->fs;

1070 
ba£
 = 
fs
->
ä“»g
;

1071 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for index)", 0);

1072 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for†imit)", 1);

1073 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for step)", 2);

1074 
	`Ãw_loÿlv¬
(
ls
, 
v¬Çme
, 3);

1075 
	`checkÃxt
(
ls
, '=');

1076 
	`exp1
(
ls
);

1077 
	`checkÃxt
(
ls
, ',');

1078 
	`exp1
(
ls
);

1079 ià(
	`‹¡Ãxt
(
ls
, ','))

1080 
	`exp1
(
ls
);

1082 
	`luaK_codeABx
(
fs
, 
OP_LOADK
, fs->
ä“»g
, 
	`luaK_numb”K
(fs, 1));

1083 
	`luaK_»£rv”egs
(
fs
, 1);

1085 
	`fÜbody
(
ls
, 
ba£
, 
lše
, 1, 1);

1086 
	}
}

1089 
	$fÜli¡
 (
LexS‹
 *
ls
, 
TSŒšg
 *
šdexÇme
) {

1091 
FuncS‹
 *
fs
 = 
ls
->fs;

1092 
expdesc
 
e
;

1093 
nv¬s
 = 0;

1094 
lše
;

1095 
ba£
 = 
fs
->
ä“»g
;

1097 
	`Ãw_loÿlv¬l™”®
(
ls
, "(fÜ g’”©Ü)", 
nv¬s
++);

1098 
	`Ãw_loÿlv¬l™”®
(
ls
, "(fÜ s‹)", 
nv¬s
++);

1099 
	`Ãw_loÿlv¬l™”®
(
ls
, "(fÜ cÚŒŞ)", 
nv¬s
++);

1101 
	`Ãw_loÿlv¬
(
ls
, 
šdexÇme
, 
nv¬s
++);

1102 
	`‹¡Ãxt
(
ls
, ','))

1103 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
Ös), 
nv¬s
++);

1104 
	`checkÃxt
(
ls
, 
TK_IN
);

1105 
lše
 = 
ls
->
lš’umb”
;

1106 
	`adju¡_assign
(
ls
, 3, 
	`ex¶i¡1
Ös, &
e
), &e);

1107 
	`luaK_check¡ack
(
fs
, 3);

1108 
	`fÜbody
(
ls
, 
ba£
, 
lše
, 
nv¬s
 - 3, 0);

1109 
	}
}

1112 
	$fÜ¡©
 (
LexS‹
 *
ls
, 
lše
) {

1114 
FuncS‹
 *
fs
 = 
ls
->fs;

1115 
TSŒšg
 *
v¬Çme
;

1116 
BlockCÁ
 
bl
;

1117 
	`’‹rblock
(
fs
, &
bl
, 1);

1118 
	`luaX_Ãxt
(
ls
);

1119 
v¬Çme
 = 
	`¡r_checkÇme
(
ls
);

1120 
ls
->
t
.
tok’
) {

1121 '=': 
	`fÜnum
(
ls
, 
v¬Çme
, 
lše
); ;

1122 ',': 
TK_IN
: 
	`fÜli¡
(
ls
, 
v¬Çme
); ;

1123 : 
	`luaX_syÁax”rÜ
(
ls
, 
	`LUA_QL
("=") " or " LUA_QL("in") "ƒxpected");

1125 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_FOR
, 
lše
);

1126 
	`Ëaveblock
(
fs
);

1127 
	}
}

1130 
	$‹¡_th’_block
 (
LexS‹
 *
ls
) {

1132 
cÚdex™
;

1133 
	`luaX_Ãxt
(
ls
);

1134 
cÚdex™
 = 
	`cÚd
(
ls
);

1135 
	`checkÃxt
(
ls
, 
TK_THEN
);

1136 
	`block
(
ls
);

1137  
cÚdex™
;

1138 
	}
}

1141 
	$if¡©
 (
LexS‹
 *
ls
, 
lše
) {

1143 
FuncS‹
 *
fs
 = 
ls
->fs;

1144 
æi¡
;

1145 
esÿ³li¡
 = 
NO_JUMP
;

1146 
æi¡
 = 
	`‹¡_th’_block
(
ls
);

1147 
ls
->
t
.
tok’
 =ğ
TK_ELSEIF
) {

1148 
	`luaK_cÚÿt
(
fs
, &
esÿ³li¡
, 
	`luaK_jump
(fs));

1149 
	`luaK_·tchtoh”e
(
fs
, 
æi¡
);

1150 
æi¡
 = 
	`‹¡_th’_block
(
ls
);

1152 ià(
ls
->
t
.
tok’
 =ğ
TK_ELSE
) {

1153 
	`luaK_cÚÿt
(
fs
, &
esÿ³li¡
, 
	`luaK_jump
(fs));

1154 
	`luaK_·tchtoh”e
(
fs
, 
æi¡
);

1155 
	`luaX_Ãxt
(
ls
);

1156 
	`block
(
ls
);

1159 
	`luaK_cÚÿt
(
fs
, &
esÿ³li¡
, 
æi¡
);

1160 
	`luaK_·tchtoh”e
(
fs
, 
esÿ³li¡
);

1161 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_IF
, 
lše
);

1162 
	}
}

1165 
	$loÿlfunc
 (
LexS‹
 *
ls
) {

1166 
expdesc
 
v
, 
b
;

1167 
FuncS‹
 *
fs
 = 
ls
->fs;

1168 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
(ls), 0);

1169 
	`š™_exp
(&
v
, 
VLOCAL
, 
fs
->
ä“»g
);

1170 
	`luaK_»£rv”egs
(
fs
, 1);

1171 
	`adju¡loÿlv¬s
(
ls
, 1);

1172 
	`body
(
ls
, &
b
, 0,†s->
lš’umb”
);

1173 
	`luaK_¡Üev¬
(
fs
, &
v
, &
b
);

1175 
	`g‘locv¬
(
fs
, fs->
Çùv¬
 - 1).
¡¬c
 = fs->
pc
;

1176 
	}
}

1179 
	$loÿl¡©
 (
LexS‹
 *
ls
) {

1181 
nv¬s
 = 0;

1182 
Ãxps
;

1183 
expdesc
 
e
;

1185 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
Ös), 
nv¬s
++);

1186 } 
	`‹¡Ãxt
(
ls
, ','));

1187 ià(
	`‹¡Ãxt
(
ls
, '='))

1188 
Ãxps
 = 
	`ex¶i¡1
(
ls
, &
e
);

1190 
e
.
k
 = 
VVOID
;

1191 
Ãxps
 = 0;

1193 
	`adju¡_assign
(
ls
, 
nv¬s
, 
Ãxps
, &
e
);

1194 
	`adju¡loÿlv¬s
(
ls
, 
nv¬s
);

1195 
	}
}

1198 
	$funúame
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

1200 
Ãed£lf
 = 0;

1201 
	`sšgËv¬
(
ls
, 
v
);

1202 
ls
->
t
.
tok’
 == '.')

1203 
	`f›ld
(
ls
, 
v
);

1204 ià(
ls
->
t
.
tok’
 == ':') {

1205 
Ãed£lf
 = 1;

1206 
	`f›ld
(
ls
, 
v
);

1208  
Ãed£lf
;

1209 
	}
}

1212 
	$func¡©
 (
LexS‹
 *
ls
, 
lše
) {

1214 
Ãed£lf
;

1215 
expdesc
 
v
, 
b
;

1216 
	`luaX_Ãxt
(
ls
);

1217 
Ãed£lf
 = 
	`funúame
(
ls
, &
v
);

1218 
	`body
(
ls
, &
b
, 
Ãed£lf
, 
lše
);

1219 
	`luaK_¡Üev¬
(
ls
->
fs
, &
v
, &
b
);

1220 
	`luaK_fixlše
(
ls
->
fs
, 
lše
);

1221 
	}
}

1224 
	$ex´¡©
 (
LexS‹
 *
ls
) {

1226 
FuncS‹
 *
fs
 = 
ls
->fs;

1227 
LHS_assign
 
v
;

1228 
	`´im¬yexp
(
ls
, &
v
.v);

1229 ià(
v
.v.
k
 =ğ
VCALL
)

1230 
	`SETARG_C
(
	`g‘code
(
fs
, &
v
.v), 1);

1232 
v
.
´ev
 = 
NULL
;

1233 
	`assignm’t
(
ls
, &
v
, 1);

1235 
	}
}

1238 
	$»t¡©
 (
LexS‹
 *
ls
) {

1240 
FuncS‹
 *
fs
 = 
ls
->fs;

1241 
expdesc
 
e
;

1242 
fœ¡
, 
Ä‘
;

1243 
	`luaX_Ãxt
(
ls
);

1244 ià(
	`block_fŞlow
(
ls
->
t
.
tok’
) ||†s->t.token == ';')

1245 
fœ¡
 = 
Ä‘
 = 0;

1247 
Ä‘
 = 
	`ex¶i¡1
(
ls
, &
e
);

1248 ià(
	`hasmuÉ»t
(
e
.
k
)) {

1249 
	`luaK_£tmuÉ»t
(
fs
, &
e
);

1250 ià(
e
.
k
 =ğ
VCALL
 && 
Ä‘
 == 1) {

1251 
	`SET_OPCODE
(
	`g‘code
(
fs
,&
e
), 
OP_TAILCALL
);

1252 
	`lua_as£¹
(
	`GETARG_A
(
	`g‘code
(
fs
,&
e
)è=ğfs->
Çùv¬
);

1254 
fœ¡
 = 
fs
->
Çùv¬
;

1255 
Ä‘
 = 
LUA_MULTRET
;

1258 ià(
Ä‘
 == 1)

1259 
fœ¡
 = 
	`luaK_exp2ªy»g
(
fs
, &
e
);

1261 
	`luaK_exp2ÃxŒeg
(
fs
, &
e
);

1262 
fœ¡
 = 
fs
->
Çùv¬
;

1263 
	`lua_as£¹
(
Ä‘
 =ğ
fs
->
ä“»g
 - 
fœ¡
);

1267 
	`luaK_»t
(
fs
, 
fœ¡
, 
Ä‘
);

1268 
	}
}

1271 
	$¡©em’t
 (
LexS‹
 *
ls
) {

1272 
lše
 = 
ls
->
lš’umb”
;

1273 
ls
->
t
.
tok’
) {

1274 
TK_IF
: {

1275 
	`if¡©
(
ls
, 
lše
);

1278 
TK_WHILE
: {

1279 
	`whe¡©
(
ls
, 
lše
);

1282 
TK_DO
: {

1283 
	`luaX_Ãxt
(
ls
);

1284 
	`block
(
ls
);

1285 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_DO
, 
lše
);

1288 
TK_FOR
: {

1289 
	`fÜ¡©
(
ls
, 
lše
);

1292 
TK_REPEAT
: {

1293 
	`»³©¡©
(
ls
, 
lše
);

1296 
TK_FUNCTION
: {

1297 
	`func¡©
(
ls
, 
lše
);

1300 
TK_LOCAL
: {

1301 
	`luaX_Ãxt
(
ls
);

1302 ià(
	`‹¡Ãxt
(
ls
, 
TK_FUNCTION
))

1303 
	`loÿlfunc
(
ls
);

1305 
	`loÿl¡©
(
ls
);

1308 
TK_RETURN
: {

1309 
	`»t¡©
(
ls
);

1312 
TK_BREAK
: {

1313 
	`luaX_Ãxt
(
ls
);

1314 
	`b»ak¡©
(
ls
);

1318 
	`ex´¡©
(
ls
);

1322 
	}
}

1325 
	$chunk
 (
LexS‹
 *
ls
) {

1327 
i¦a¡
 = 0;

1328 
	`’‹¾ev–
(
ls
);

1329 !
i¦a¡
 && !
	`block_fŞlow
(
ls
->
t
.
tok’
)) {

1330 
i¦a¡
 = 
	`¡©em’t
(
ls
);

1331 
	`‹¡Ãxt
(
ls
, ';');

1332 
	`lua_as£¹
(
ls
->
fs
->
f
->
max¡acksize
 >ğls->fs->
ä“»g
 &&

1333 
ls
->
fs
->
ä“»g
 >ğls->fs->
Çùv¬
);

1334 
ls
->
fs
->
ä“»g
 =†s->fs->
Çùv¬
;

1336 
	`Ëav–ev–
(
ls
);

1337 
	}
}

	@deps/lua/src/lparser.h

7 #iâdeà
Í¬£r_h


8 
	#Í¬£r_h


	)

10 
	~"Îim™s.h
"

11 
	~"lobjeù.h
"

12 
	~"lzio.h
"

20 
	mVVOID
,

21 
	mVNIL
,

22 
	mVTRUE
,

23 
	mVFALSE
,

24 
	mVK
,

25 
	mVKNUM
,

26 
	mVLOCAL
,

27 
	mVUPVAL
,

28 
	mVGLOBAL
,

29 
	mVINDEXED
,

30 
	mVJMP
,

31 
	mVRELOCABLE
,

32 
	mVNONRELOC
,

33 
	mVCALL
,

34 
	mVVARARG


35 } 
	texpkšd
;

37 
	sexpdesc
 {

38 
expkšd
 
	mk
;

40 ¡ruù { 
	mšfo
, 
	maux
; } 
	ms
;

41 
lua_Numb”
 
	mnv®
;

42 } 
	mu
;

43 
	mt
;

44 
	mf
;

45 } 
	texpdesc
;

48 
	supv®desc
 {

49 
lu_by‹
 
	mk
;

50 
lu_by‹
 
	mšfo
;

51 } 
	tupv®desc
;

54 
	gBlockCÁ
;

58 
	sFuncS‹
 {

59 
PrÙo
 *
	mf
;

60 
TabË
 *
	mh
;

61 
FuncS‹
 *
	m´ev
;

62 
LexS‹
 *
	mls
;

63 
lua_S‹
 *
	mL
;

64 
BlockCÁ
 *
	mbl
;

65 
	mpc
;

66 
	mÏ¡rg‘
;

67 
	mjpc
;

68 
	mä“»g
;

69 
	mnk
;

70 
	mÅ
;

71 
	mÆocv¬s
;

72 
lu_by‹
 
	mÇùv¬
;

73 
upv®desc
 
	mupv®ues
[
LUAI_MAXUPVALUES
];

74 
	maùv¬
[
LUAI_MAXVARS
];

75 } 
	tFuncS‹
;

78 
LUAI_FUNC
 
PrÙo
 *
luaY_·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
Mbufãr
 *
buff
,

79 cÚ¡ *
Çme
);

	@deps/lua/src/lstate.c

8 
	~<¡ddef.h
>

10 
	#l¡©e_c


	)

11 
	#LUA_CORE


	)

13 
	~"lua.h
"

15 
	~"ldebug.h
"

16 
	~"ldo.h
"

17 
	~"lfunc.h
"

18 
	~"lgc.h
"

19 
	~"Îex.h
"

20 
	~"lmem.h
"

21 
	~"l¡©e.h
"

22 
	~"l¡ršg.h
"

23 
	~"ÉabË.h
"

24 
	~"Ém.h
"

27 
	#¡©e_size
(
x
è((xè+ 
LUAI_EXTRASPACE
)

	)

28 
	#äom¡©e
(
l
è(
	`ÿ¡
(
lu_by‹
 *, (l)è- 
LUAI_EXTRASPACE
)

	)

29 
	#to¡©e
(
l
è(
	`ÿ¡
(
lua_S‹
 *, ca¡(
lu_by‹
 *,†è+ 
LUAI_EXTRASPACE
))

	)

35 
	sLG
 {

36 
lua_S‹
 
	ml
;

37 
glob®_S‹
 
	mg
;

38 } 
	tLG
;

42 
	$¡ack_š™
 (
lua_S‹
 *
L1
,†ua_S‹ *
L
) {

44 
L1
->
ba£_ci
 = 
	`luaM_ÃwveùÜ
(
L
, 
BASIC_CI_SIZE
, 
C®lInfo
);

45 
L1
->
ci
 = L1->
ba£_ci
;

46 
L1
->
size_ci
 = 
BASIC_CI_SIZE
;

47 
L1
->
’d_ci
 = L1->
ba£_ci
 + L1->
size_ci
 - 1;

49 
L1
->
¡ack
 = 
	`luaM_ÃwveùÜ
(
L
, 
BASIC_STACK_SIZE
 + 
EXTRA_STACK
, 
TV®ue
);

50 
L1
->
¡acksize
 = 
BASIC_STACK_SIZE
 + 
EXTRA_STACK
;

51 
L1
->
tİ
 = L1->
¡ack
;

52 
L1
->
¡ack_Ï¡
 = L1->
¡ack
+(L1->
¡acksize
 - 
EXTRA_STACK
)-1;

54 
L1
->
ci
->
func
 = L1->
tİ
;

55 
	`£Šv®ue
(
L1
->
tİ
++);

56 
L1
->
ba£
 = L1->
ci
->ba£ = L1->
tİ
;

57 
L1
->
ci
->
tİ
 = L1->tİ + 
LUA_MINSTACK
;

58 
	}
}

61 
	$ä“¡ack
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
) {

62 
	`luaM_ä“¬¿y
(
L
, 
L1
->
ba£_ci
, L1->
size_ci
, 
C®lInfo
);

63 
	`luaM_ä“¬¿y
(
L
, 
L1
->
¡ack
, L1->
¡acksize
, 
TV®ue
);

64 
	}
}

70 
	$f_luaİ’
 (
lua_S‹
 *
L
, *
ud
) {

71 
glob®_S‹
 *
g
 = 
	`G
(
L
);

72 
	`UNUSED
(
ud
);

73 
	`¡ack_š™
(
L
, L);

74 
	`£thv®ue
(
L
, 
	`gt
(L), 
	`luaH_Ãw
(L, 0, 2));

75 
	`£thv®ue
(
L
, 
	`»gi¡ry
(L), 
	`luaH_Ãw
(L, 0, 2));

76 
	`luaS_»size
(
L
, 
MINSTRTABSIZE
);

77 
	`luaT_š™
(
L
);

78 
	`luaX_š™
(
L
);

79 
	`luaS_fix
(
	`luaS_Ãwl™”®
(
L
, 
MEMERRMSG
));

80 
g
->
GCth»shŞd
 = 4*g->
tÙ®by‹s
;

81 
	}
}

84 
	$´eš™_¡©e
 (
lua_S‹
 *
L
, 
glob®_S‹
 *
g
) {

85 
	`G
(
L
èğ
g
;

86 
L
->
¡ack
 = 
NULL
;

87 
L
->
¡acksize
 = 0;

88 
L
->
”rÜJmp
 = 
NULL
;

89 
L
->
hook
 = 
NULL
;

90 
L
->
hookmask
 = 0;

91 
L
->
ba£hookcouÁ
 = 0;

92 
L
->
®lowhook
 = 1;

93 
	`»£thookcouÁ
(
L
);

94 
L
->
İ’upv®
 = 
NULL
;

95 
L
->
size_ci
 = 0;

96 
L
->
nCÿÎs
 = L->
ba£CÿÎs
 = 0;

97 
L
->
¡©us
 = 0;

98 
L
->
ba£_ci
 = L->
ci
 = 
NULL
;

99 
L
->
§vedpc
 = 
NULL
;

100 
L
->
”rfunc
 = 0;

101 
	`£Šv®ue
(
	`gt
(
L
));

102 
	}
}

105 
	$şo£_¡©e
 (
lua_S‹
 *
L
) {

106 
glob®_S‹
 *
g
 = 
	`G
(
L
);

107 
	`luaF_şo£
(
L
, L->
¡ack
);

108 
	`luaC_ä“®l
(
L
);

109 
	`lua_as£¹
(
g
->
roÙgc
 =ğ
	`obj2gco
(
L
));

110 
	`lua_as£¹
(
g
->
¡¹
.
nu£
 == 0);

111 
	`luaM_ä“¬¿y
(
L
, 
	`G
(L)->
¡¹
.
hash
, G(L)->¡¹.
size
, 
TSŒšg
 *);

112 
	`luaZ_ä“bufãr
(
L
, &
g
->
buff
);

113 
	`ä“¡ack
(
L
, L);

114 
	`lua_as£¹
(
g
->
tÙ®by‹s
 =ğ(
LG
));

115 (*
g
->
ä—Îoc
)(g->
ud
, 
	`äom¡©e
(
L
), 
	`¡©e_size
(
LG
), 0);

116 
	}
}

119 
lua_S‹
 *
	$luaE_Ãwth»ad
 (
lua_S‹
 *
L
) {

120 
lua_S‹
 *
L1
 = 
	`to¡©e
(
	`luaM_m®loc
(
L
, 
	`¡©e_size
(lua_State)));

121 
	`luaC_lšk
(
L
, 
	`obj2gco
(
L1
), 
LUA_TTHREAD
);

122 
	`´eš™_¡©e
(
L1
, 
	`G
(
L
));

123 
	`¡ack_š™
(
L1
, 
L
);

124 
	`£tobj2n
(
L
, 
	`gt
(
L1
), gt(L));

125 
L1
->
hookmask
 = 
L
->hookmask;

126 
L1
->
ba£hookcouÁ
 = 
L
->basehookcount;

127 
L1
->
hook
 = 
L
->hook;

128 
	`»£thookcouÁ
(
L1
);

129 
	`lua_as£¹
(
	`iswh™e
(
	`obj2gco
(
L1
)));

130  
L1
;

131 
	}
}

134 
	$luaE_ä“th»ad
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
) {

135 
	`luaF_şo£
(
L1
, L1->
¡ack
);

136 
	`lua_as£¹
(
L1
->
İ’upv®
 =ğ
NULL
);

137 
	`luai_u£r¡©eä“
(
L1
);

138 
	`ä“¡ack
(
L
, 
L1
);

139 
	`luaM_ä“mem
(
L
, 
	`äom¡©e
(
L1
), 
	`¡©e_size
(
lua_S‹
));

140 
	}
}

143 
LUA_API
 
lua_S‹
 *
	$lua_Ãw¡©e
 (
lua_AÎoc
 
f
, *
ud
) {

144 
i
;

145 
lua_S‹
 *
L
;

146 
glob®_S‹
 *
g
;

147 *
l
 = (*
f
)(
ud
, 
NULL
, 0, 
	`¡©e_size
(
LG
));

148 ià(
l
 =ğ
NULL
)  NULL;

149 
L
 = 
	`to¡©e
(
l
);

150 
g
 = &((
LG
 *)
L
)->g;

151 
L
->
Ãxt
 = 
NULL
;

152 
L
->
‰
 = 
LUA_TTHREAD
;

153 
g
->
cu¼’twh™e
 = 
	`b™2mask
(
WHITE0BIT
, 
FIXEDBIT
);

154 
L
->
m¬ked
 = 
	`luaC_wh™e
(
g
);

155 
	`£t2b™s
(
L
->
m¬ked
, 
FIXEDBIT
, 
SFIXEDBIT
);

156 
	`´eš™_¡©e
(
L
, 
g
);

157 
g
->
ä—Îoc
 = 
f
;

158 
g
->
ud
 = ud;

159 
g
->
mašth»ad
 = 
L
;

160 
g
->
uvh—d
.
u
.
l
.
´ev
 = &g->uvhead;

161 
g
->
uvh—d
.
u
.
l
.
Ãxt
 = &g->uvhead;

162 
g
->
GCth»shŞd
 = 0;

163 
g
->
¡¹
.
size
 = 0;

164 
g
->
¡¹
.
nu£
 = 0;

165 
g
->
¡¹
.
hash
 = 
NULL
;

166 
	`£Šv®ue
(
	`»gi¡ry
(
L
));

167 
	`luaZ_š™bufãr
(
L
, &
g
->
buff
);

168 
g
->
·nic
 = 
NULL
;

169 
g
->
gc¡©e
 = 
GCS·u£
;

170 
g
->
roÙgc
 = 
	`obj2gco
(
L
);

171 
g
->
sw“p¡rgc
 = 0;

172 
g
->
sw“pgc
 = &g->
roÙgc
;

173 
g
->
g¿y
 = 
NULL
;

174 
g
->
g¿yagaš
 = 
NULL
;

175 
g
->
w—k
 = 
NULL
;

176 
g
->
tmud©a
 = 
NULL
;

177 
g
->
tÙ®by‹s
 = (
LG
);

178 
g
->
gıau£
 = 
LUAI_GCPAUSE
;

179 
g
->
gc¡•mul
 = 
LUAI_GCMUL
;

180 
g
->
gcd•t
 = 0;

181 
i
=0; i<
NUM_TAGS
; i++è
g
->
mt
[i] = 
NULL
;

182 ià(
	`luaD_¿wruÅrÙeùed
(
L
, 
f_luaİ’
, 
NULL
) != 0) {

184 
	`şo£_¡©e
(
L
);

185 
L
 = 
NULL
;

188 
	`luai_u£r¡©eİ’
(
L
);

189  
L
;

190 
	}
}

193 
	$ÿÎ®lgcTM
 (
lua_S‹
 *
L
, *
ud
) {

194 
	`UNUSED
(
ud
);

195 
	`luaC_ÿÎGCTM
(
L
);

196 
	}
}

199 
LUA_API
 
	$lua_şo£
 (
lua_S‹
 *
L
) {

200 
L
 = 
	`G
(L)->
mašth»ad
;

201 
	`lua_lock
(
L
);

202 
	`luaF_şo£
(
L
, L->
¡ack
);

203 
	`luaC_£·¿‹ud©a
(
L
, 1);

204 
L
->
”rfunc
 = 0;

206 
L
->
ci
 = L->
ba£_ci
;

207 
L
->
ba£
 = L->
tİ
 = L->
ci
->base;

208 
L
->
nCÿÎs
 = L->
ba£CÿÎs
 = 0;

209 } 
	`luaD_¿wruÅrÙeùed
(
L
, 
ÿÎ®lgcTM
, 
NULL
) != 0);

210 
	`lua_as£¹
(
	`G
(
L
)->
tmud©a
 =ğ
NULL
);

211 
	`luai_u£r¡©eşo£
(
L
);

212 
	`şo£_¡©e
(
L
);

213 
	}
}

	@deps/lua/src/lstate.h

7 #iâdeà
l¡©e_h


8 
	#l¡©e_h


	)

10 
	~"lua.h
"

12 
	~"lobjeù.h
"

13 
	~"Ém.h
"

14 
	~"lzio.h
"

18 
	glua_lÚgjmp
;

22 
	#gt
(
L
è(&L->
l_gt
)

	)

25 
	#»gi¡ry
(
L
è(&
	`G
(L)->
l_»gi¡ry
)

	)

29 
	#EXTRA_STACK
 5

	)

32 
	#BASIC_CI_SIZE
 8

	)

34 
	#BASIC_STACK_SIZE
 (2*
LUA_MINSTACK
)

	)

38 
	s¡ršgbË
 {

39 
GCObjeù
 **
	mhash
;

40 
lu_št32
 
	mnu£
;

41 
	msize
;

42 } 
	t¡ršgbË
;

48 
	sC®lInfo
 {

49 
StkId
 
	mba£
;

50 
StkId
 
	mfunc
;

51 
StkId
 
	mtİ
;

52 cÚ¡ 
In¡ruùiÚ
 *
	m§vedpc
;

53 
	mÄesuÉs
;

54 
	mÿÎs
;

55 } 
	tC®lInfo
;

59 
	#cu¼_func
(
L
è(
	`şv®ue
(L->
ci
->
func
))

	)

60 
	#ci_func
(
ci
è(
	`şv®ue
((ci)->
func
))

	)

61 
	#f_isLua
(
ci
è(!
	`ci_func
(ci)->
c
.
isC
)

	)

62 
	#isLua
(
ci
è(
	`‰isfunùiÚ
((ci)->
func
è&& 
	`f_isLua
(ci))

	)

68 
	sglob®_S‹
 {

69 
¡ršgbË
 
	m¡¹
;

70 
lua_AÎoc
 
	mä—Îoc
;

71 *
	mud
;

72 
lu_by‹
 
	mcu¼’twh™e
;

73 
lu_by‹
 
	mgc¡©e
;

74 
	msw“p¡rgc
;

75 
GCObjeù
 *
	mroÙgc
;

76 
GCObjeù
 **
	msw“pgc
;

77 
GCObjeù
 *
	mg¿y
;

78 
GCObjeù
 *
	mg¿yagaš
;

79 
GCObjeù
 *
	mw—k
;

80 
GCObjeù
 *
	mtmud©a
;

81 
Mbufãr
 
	mbuff
;

82 
lu_mem
 
	mGCth»shŞd
;

83 
lu_mem
 
	mtÙ®by‹s
;

84 
lu_mem
 
	me¡im©e
;

85 
lu_mem
 
	mgcd•t
;

86 
	mgıau£
;

87 
	mgc¡•mul
;

88 
lua_CFunùiÚ
 
	m·nic
;

89 
TV®ue
 
	ml_»gi¡ry
;

90 
lua_S‹
 *
	mmašth»ad
;

91 
UpV®
 
	muvh—d
;

92 
TabË
 *
	mmt
[
NUM_TAGS
];

93 
TSŒšg
 *
	mtmÇme
[
TM_N
];

94 } 
	tglob®_S‹
;

100 
	slua_S‹
 {

101 
	mCommÚH—d”
;

102 
lu_by‹
 
	m¡©us
;

103 
StkId
 
	mtİ
;

104 
StkId
 
	mba£
;

105 
glob®_S‹
 *
	ml_G
;

106 
C®lInfo
 *
	mci
;

107 cÚ¡ 
In¡ruùiÚ
 *
	m§vedpc
;

108 
StkId
 
	m¡ack_Ï¡
;

109 
StkId
 
	m¡ack
;

110 
C®lInfo
 *
	m’d_ci
;

111 
C®lInfo
 *
	mba£_ci
;

112 
	m¡acksize
;

113 
	msize_ci
;

114 
	mnCÿÎs
;

115 
	mba£CÿÎs
;

116 
lu_by‹
 
	mhookmask
;

117 
lu_by‹
 
	m®lowhook
;

118 
	mba£hookcouÁ
;

119 
	mhookcouÁ
;

120 
lua_Hook
 
	mhook
;

121 
TV®ue
 
	ml_gt
;

122 
TV®ue
 
	m’v
;

123 
GCObjeù
 *
	mİ’upv®
;

124 
GCObjeù
 *
	mgşi¡
;

125 
lua_lÚgjmp
 *
	m”rÜJmp
;

126 
±rdiff_t
 
	m”rfunc
;

130 
	#G
(
L
è(L->
l_G
)

	)

136 
	uGCObjeù
 {

137 
GCh—d”
 
	mgch
;

138 
TSŒšg
 
	mts
;

139 
Ud©a
 
	mu
;

140 
Closu»
 
	mş
;

141 
TabË
 
	mh
;

142 
PrÙo
 
	mp
;

143 
UpV®
 
	muv
;

144 
lua_S‹
 
	mth
;

149 
	#¿wgco2ts
(
o
è
	`check_exp
((o)->
gch
.
‰
 =ğ
LUA_TSTRING
, &((o)->
ts
))

	)

150 
	#gco2ts
(
o
è(&
	`¿wgco2ts
(o)->
tsv
)

	)

151 
	#¿wgco2u
(
o
è
	`check_exp
((o)->
gch
.
‰
 =ğ
LUA_TUSERDATA
, &((o)->
u
))

	)

152 
	#gco2u
(
o
è(&
	`¿wgco2u
(o)->
uv
)

	)

153 
	#gco2ş
(
o
è
	`check_exp
((o)->
gch
.
‰
 =ğ
LUA_TFUNCTION
, &((o)->
ş
))

	)

154 
	#gco2h
(
o
è
	`check_exp
((o)->
gch
.
‰
 =ğ
LUA_TTABLE
, &((o)->
h
))

	)

155 
	#gco2p
(
o
è
	`check_exp
((o)->
gch
.
‰
 =ğ
LUA_TPROTO
, &((o)->
p
))

	)

156 
	#gco2uv
(
o
è
	`check_exp
((o)->
gch
.
‰
 =ğ
LUA_TUPVAL
, &((o)->
uv
))

	)

157 
	#ngcÙouv
(
o
) \

158 
	`check_exp
((
o
è=ğ
NULL
 || (o)->
gch
.
‰
 =ğ
LUA_TUPVAL
, &((o)->
uv
))

	)

159 
	#gco2th
(
o
è
	`check_exp
((o)->
gch
.
‰
 =ğ
LUA_TTHREAD
, &((o)->
th
))

	)

162 
	#obj2gco
(
v
è(
	`ÿ¡
(
GCObjeù
 *, (v)))

	)

165 
LUAI_FUNC
 
lua_S‹
 *
luaE_Ãwth»ad
 (lua_S‹ *
L
);

166 
LUAI_FUNC
 
luaE_ä“th»ad
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
);

	@deps/lua/src/lstring.c

8 
	~<¡ršg.h
>

10 
	#l¡ršg_c


	)

11 
	#LUA_CORE


	)

13 
	~"lua.h
"

15 
	~"lmem.h
"

16 
	~"lobjeù.h
"

17 
	~"l¡©e.h
"

18 
	~"l¡ršg.h
"

22 
	$luaS_»size
 (
lua_S‹
 *
L
, 
Ãwsize
) {

23 
GCObjeù
 **
Ãwhash
;

24 
¡ršgbË
 *
tb
;

25 
i
;

26 ià(
	`G
(
L
)->
gc¡©e
 =ğ
GCSsw“p¡ršg
)

28 
Ãwhash
 = 
	`luaM_ÃwveùÜ
(
L
, 
Ãwsize
, 
GCObjeù
 *);

29 
tb
 = &
	`G
(
L
)->
¡¹
;

30 
i
=0; i<
Ãwsize
; i++è
Ãwhash
[i] = 
NULL
;

32 
i
=0; i<
tb
->
size
; i++) {

33 
GCObjeù
 *
p
 = 
tb
->
hash
[
i
];

34 
p
) {

35 
GCObjeù
 *
Ãxt
 = 
p
->
gch
.next;

36 
h
 = 
	`gco2ts
(
p
)->
hash
;

37 
h1
 = 
	`lmod
(
h
, 
Ãwsize
);

38 
	`lua_as£¹
(
	`ÿ¡_št
(
h
%
Ãwsize
è=ğ
	`lmod
(h,‚ewsize));

39 
p
->
gch
.
Ãxt
 = 
Ãwhash
[
h1
];

40 
Ãwhash
[
h1
] = 
p
;

41 
p
 = 
Ãxt
;

44 
	`luaM_ä“¬¿y
(
L
, 
tb
->
hash
,b->
size
, 
TSŒšg
 *);

45 
tb
->
size
 = 
Ãwsize
;

46 
tb
->
hash
 = 
Ãwhash
;

47 
	}
}

50 
TSŒšg
 *
	$Ãwl¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
,

51 
h
) {

52 
TSŒšg
 *
ts
;

53 
¡ršgbË
 *
tb
;

54 ià(
l
+1 > (
MAX_SIZET
 - (
TSŒšg
))/())

55 
	`luaM_toobig
(
L
);

56 
ts
 = 
	`ÿ¡
(
TSŒšg
 *, 
	`luaM_m®loc
(
L
, (
l
+1)*()+(TString)));

57 
ts
->
tsv
.
Ën
 = 
l
;

58 
ts
->
tsv
.
hash
 = 
h
;

59 
ts
->
tsv
.
m¬ked
 = 
	`luaC_wh™e
(
	`G
(
L
));

60 
ts
->
tsv
.
‰
 = 
LUA_TSTRING
;

61 
ts
->
tsv
.
»£rved
 = 0;

62 
	`memıy
(
ts
+1, 
¡r
, 
l
*());

63 ((*)(
ts
+1))[
l
] = '\0';

64 
tb
 = &
	`G
(
L
)->
¡¹
;

65 
h
 = 
	`lmod
(h, 
tb
->
size
);

66 
ts
->
tsv
.
Ãxt
 = 
tb
->
hash
[
h
];

67 
tb
->
hash
[
h
] = 
	`obj2gco
(
ts
);

68 
tb
->
nu£
++;

69 ià(
tb
->
nu£
 > 
	`ÿ¡
(
lu_št32
,b->
size
è&&b->siz<ğ
MAX_INT
/2)

70 
	`luaS_»size
(
L
, 
tb
->
size
*2);

71  
ts
;

72 
	}
}

75 
TSŒšg
 *
	$luaS_Ãwl¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
) {

76 
GCObjeù
 *
o
;

77 
h
 = 
	`ÿ¡
(, 
l
);

78 
size_t
 
¡•
 = (
l
>>5)+1;

79 
size_t
 
l1
;

80 
l1
=
l
;†1>=
¡•
;†1-=step)

81 
h
 = h ^ ((h<<5)+(h>>2)+
	`ÿ¡
(, 
¡r
[
l1
-1]));

82 
o
 = 
	`G
(
L
)->
¡¹
.
hash
[
	`lmod
(
h
, G(L)->¡¹.
size
)];

83 
o
 !ğ
NULL
;

84 
o
 = o->
gch
.
Ãxt
) {

85 
TSŒšg
 *
ts
 = 
	`¿wgco2ts
(
o
);

86 ià(
ts
->
tsv
.
Ën
 =ğ
l
 && (
	`memcmp
(
¡r
, 
	`g‘¡r
(ts),†) == 0)) {

88 ià(
	`isd—d
(
	`G
(
L
), 
o
)è
	`chªgewh™e
(o);

89  
ts
;

92  
	`Ãwl¡r
(
L
, 
¡r
, 
l
, 
h
);

93 
	}
}

96 
Ud©a
 *
	$luaS_Ãwud©a
 (
lua_S‹
 *
L
, 
size_t
 
s
, 
TabË
 *
e
) {

97 
Ud©a
 *
u
;

98 ià(
s
 > 
MAX_SIZET
 - (
Ud©a
))

99 
	`luaM_toobig
(
L
);

100 
u
 = 
	`ÿ¡
(
Ud©a
 *, 
	`luaM_m®loc
(
L
, 
s
 + (Udata)));

101 
u
->
uv
.
m¬ked
 = 
	`luaC_wh™e
(
	`G
(
L
));

102 
u
->
uv
.
‰
 = 
LUA_TUSERDATA
;

103 
u
->
uv
.
Ën
 = 
s
;

104 
u
->
uv
.
m‘©abË
 = 
NULL
;

105 
u
->
uv
.
’v
 = 
e
;

107 
u
->
uv
.
Ãxt
 = 
	`G
(
L
)->
mašth»ad
->next;

108 
	`G
(
L
)->
mašth»ad
->
Ãxt
 = 
	`obj2gco
(
u
);

109  
u
;

110 
	}
}

	@deps/lua/src/lstring.h

7 #iâdeà
l¡ršg_h


8 
	#l¡ršg_h


	)

11 
	~"lgc.h
"

12 
	~"lobjeù.h
"

13 
	~"l¡©e.h
"

16 
	#size¡ršg
(
s
è((
TSŒšg
)+((s)->
Ën
+1)*())

	)

18 
	#sizeud©a
(
u
è((
Ud©a
)+(u)->
Ën
)

	)

20 
	#luaS_Ãw
(
L
, 
s
è(
	`luaS_Ãwl¡r
(L, s, 
	`¡¾’
(s)))

	)

21 
	#luaS_Ãwl™”®
(
L
, 
s
è(
	`luaS_Ãwl¡r
(L, "" s, \

22 ((
s
)/())-1))

	)

24 
	#luaS_fix
(
s
è
	`l_£tb™
((s)->
tsv
.
m¬ked
, 
FIXEDBIT
)

	)

26 
LUAI_FUNC
 
luaS_»size
 (
lua_S‹
 *
L
, 
Ãwsize
);

27 
LUAI_FUNC
 
Ud©a
 *
luaS_Ãwud©a
 (
lua_S‹
 *
L
, 
size_t
 
s
, 
TabË
 *
e
);

28 
LUAI_FUNC
 
TSŒšg
 *
luaS_Ãwl¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
);

	@deps/lua/src/lstrlib.c

8 
	~<ùy³.h
>

9 
	~<¡ddef.h
>

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

14 
	#l¡¾ib_c


	)

15 
	#LUA_LIB


	)

17 
	~"lua.h
"

19 
	~"Ïuxlib.h
"

20 
	~"lu®ib.h
"

24 
	#uch¬
(
c
è(()(c))

	)

28 
	$¡r_Ën
 (
lua_S‹
 *
L
) {

29 
size_t
 
l
;

30 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

31 
	`lua_pushš‹g”
(
L
, 
l
);

33 
	}
}

36 
±rdiff_t
 
	$po¤–©
 (
±rdiff_t
 
pos
, 
size_t
 
Ën
) {

38 ià(
pos
 < 0èpo +ğ(
±rdiff_t
)
Ën
 + 1;

39  (
pos
 >= 0) ?…os : 0;

40 
	}
}

43 
	$¡r_sub
 (
lua_S‹
 *
L
) {

44 
size_t
 
l
;

45 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

46 
±rdiff_t
 
¡¬t
 = 
	`po¤–©
(
	`luaL_checkš‹g”
(
L
, 2), 
l
);

47 
±rdiff_t
 
’d
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, -1), 
l
);

48 ià(
¡¬t
 < 1) start = 1;

49 ià(
’d
 > (
±rdiff_t
)
l
)ƒnd = (ptrdiff_t)l;

50 ià(
¡¬t
 <ğ
’d
)

51 
	`lua_pushl¡ršg
(
L
, 
s
+
¡¬t
-1, 
’d
-start+1);

52 
	`lua_pushl™”®
(
L
, "");

54 
	}
}

57 
	$¡r_»v”£
 (
lua_S‹
 *
L
) {

58 
size_t
 
l
;

59 
luaL_Bufãr
 
b
;

60 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

61 
	`luaL_buffš™
(
L
, &
b
);

62 
l
--è
	`luaL_addch¬
(&
b
, 
s
[l]);

63 
	`luaL_push»suÉ
(&
b
);

65 
	}
}

68 
	$¡r_low”
 (
lua_S‹
 *
L
) {

69 
size_t
 
l
;

70 
size_t
 
i
;

71 
luaL_Bufãr
 
b
;

72 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

73 
	`luaL_buffš™
(
L
, &
b
);

74 
i
=0; i<
l
; i++)

75 
	`luaL_addch¬
(&
b
, 
	`tŞow”
(
	`uch¬
(
s
[
i
])));

76 
	`luaL_push»suÉ
(&
b
);

78 
	}
}

81 
	$¡r_uµ”
 (
lua_S‹
 *
L
) {

82 
size_t
 
l
;

83 
size_t
 
i
;

84 
luaL_Bufãr
 
b
;

85 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

86 
	`luaL_buffš™
(
L
, &
b
);

87 
i
=0; i<
l
; i++)

88 
	`luaL_addch¬
(&
b
, 
	`touµ”
(
	`uch¬
(
s
[
i
])));

89 
	`luaL_push»suÉ
(&
b
);

91 
	}
}

93 
	$¡r_»p
 (
lua_S‹
 *
L
) {

94 
size_t
 
l
;

95 
luaL_Bufãr
 
b
;

96 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

97 
n
 = 
	`luaL_checkšt
(
L
, 2);

98 
	`luaL_buffš™
(
L
, &
b
);

99 
n
-- > 0)

100 
	`luaL_addl¡ršg
(&
b
, 
s
, 
l
);

101 
	`luaL_push»suÉ
(&
b
);

103 
	}
}

106 
	$¡r_by‹
 (
lua_S‹
 *
L
) {

107 
size_t
 
l
;

108 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

109 
±rdiff_t
 
posi
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 2, 1), 
l
);

110 
±rdiff_t
 
po£
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, 
posi
), 
l
);

111 
n
, 
i
;

112 ià(
posi
 <= 0)…osi = 1;

113 ià((
size_t
)
po£
 > 
l
)…ose =†;

114 ià(
posi
 > 
po£
)  0;

115 
n
 = ()(
po£
 - 
posi
 + 1);

116 ià(
posi
 + 
n
 <ğ
po£
)

117 
	`luaL_”rÜ
(
L
, "string sliceoo†ong");

118 
	`luaL_check¡ack
(
L
, 
n
, "string sliceoo†ong");

119 
i
=0; i<
n
; i++)

120 
	`lua_pushš‹g”
(
L
, 
	`uch¬
(
s
[
posi
+
i
-1]));

121  
n
;

122 
	}
}

125 
	$¡r_ch¬
 (
lua_S‹
 *
L
) {

126 
n
 = 
	`lua_g‘tİ
(
L
);

127 
i
;

128 
luaL_Bufãr
 
b
;

129 
	`luaL_buffš™
(
L
, &
b
);

130 
i
=1; i<=
n
; i++) {

131 
c
 = 
	`luaL_checkšt
(
L
, 
i
);

132 
	`luaL_¬gcheck
(
L
, 
	`uch¬
(
c
è=ğc, 
i
, "invalid value");

133 
	`luaL_addch¬
(&
b
, 
	`uch¬
(
c
));

135 
	`luaL_push»suÉ
(&
b
);

137 
	}
}

140 
	$wr™”
 (
lua_S‹
 *
L
, cÚ¡ * 
b
, 
size_t
 
size
, * 
B
) {

141 ()
L
;

142 
	`luaL_addl¡ršg
((
luaL_Bufãr
*è
B
, (cÚ¡ *)
b
, 
size
);

144 
	}
}

147 
	$¡r_dump
 (
lua_S‹
 *
L
) {

148 
luaL_Bufãr
 
b
;

149 
	`luaL_checkty³
(
L
, 1, 
LUA_TFUNCTION
);

150 
	`lua_£‰İ
(
L
, 1);

151 
	`luaL_buffš™
(
L
,&
b
);

152 ià(
	`lua_dump
(
L
, 
wr™”
, &
b
) != 0)

153 
	`luaL_”rÜ
(
L
, "unableo dump given function");

154 
	`luaL_push»suÉ
(&
b
);

156 
	}
}

167 
	#CAP_UNFINISHED
 (-1)

	)

168 
	#CAP_POSITION
 (-2)

	)

170 
	sM©chS‹
 {

171 cÚ¡ *
	m¤c_š™
;

172 cÚ¡ *
	m¤c_’d
;

173 
lua_S‹
 *
	mL
;

174 
	mËv–
;

176 cÚ¡ *
	mš™
;

177 
±rdiff_t
 
	mËn
;

178 } 
	mÿ±u»
[
LUA_MAXCAPTURES
];

179 } 
	tM©chS‹
;

182 
	#L_ESC
 '%'

	)

183 
	#SPECIALS
 "^$*+?.([%-"

	)

186 
	$check_ÿ±u»
 (
M©chS‹
 *
ms
, 
l
) {

187 
l
 -= '1';

188 ià(
l
 < 0 ||† >ğ
ms
->
Ëv–
 || ms->
ÿ±u»
[l].
Ën
 =ğ
CAP_UNFINISHED
)

189  
	`luaL_”rÜ
(
ms
->
L
, "invalid capture index");

190  
l
;

191 
	}
}

194 
	$ÿ±u»_to_şo£
 (
M©chS‹
 *
ms
) {

195 
Ëv–
 = 
ms
->level;

196 
Ëv–
--;†evel>=0;†evel--)

197 ià(
ms
->
ÿ±u»
[
Ëv–
].
Ën
 =ğ
CAP_UNFINISHED
) †evel;

198  
	`luaL_”rÜ
(
ms
->
L
, "invalid…attern capture");

199 
	}
}

202 cÚ¡ *
	$şas£nd
 (
M©chS‹
 *
ms
, cÚ¡ *
p
) {

203 *
p
++) {

204 
L_ESC
: {

205 ià(*
p
 == '\0')

206 
	`luaL_”rÜ
(
ms
->
L
, "m®fÜmed…©‹º (’d w™h " 
	`LUA_QL
("%%") ")");

207  
p
+1;

210 ià(*
p
 == '^')…++;

212 ià(*
p
 == '\0')

213 
	`luaL_”rÜ
(
ms
->
L
, "m®fÜmed…©‹º (missšg " 
	`LUA_QL
("]") ")");

214 ià(*(
p
++è=ğ
L_ESC
 && *p != '\0')

215 
p
++;

216 } *
p
 != ']');

217  
p
+1;

220  
p
;

223 
	}
}

226 
	$m©ch_şass
 (
c
, 
ş
) {

227 
»s
;

228 
	`tŞow”
(
ş
)) {

229 'a' : 
»s
 = 
	`i§Íha
(
c
); ;

230 'c' : 
»s
 = 
	`isúŒl
(
c
); ;

231 'd' : 
»s
 = 
	`isdig™
(
c
); ;

232 'l' : 
»s
 = 
	`i¦ow”
(
c
); ;

233 'p' : 
»s
 = 
	`i¥unù
(
c
); ;

234 's' : 
»s
 = 
	`is¥aû
(
c
); ;

235 'u' : 
»s
 = 
	`isuµ”
(
c
); ;

236 'w' : 
»s
 = 
	`i§Êum
(
c
); ;

237 'x' : 
»s
 = 
	`isxdig™
(
c
); ;

238 'z' : 
»s
 = (
c
 == 0); ;

239 :  (
ş
 =ğ
c
);

241  (
	`i¦ow”
(
ş
è? 
»s
 : !res);

242 
	}
}

245 
	$m©chb¿ck‘şass
 (
c
, cÚ¡ *
p
, cÚ¡ *
ec
) {

246 
sig
 = 1;

247 ià(*(
p
+1) == '^') {

248 
sig
 = 0;

249 
p
++;

251 ++
p
 < 
ec
) {

252 ià(*
p
 =ğ
L_ESC
) {

253 
p
++;

254 ià(
	`m©ch_şass
(
c
, 
	`uch¬
(*
p
)))

255  
sig
;

257 ià((*(
p
+1è=ğ'-'è&& (p+2 < 
ec
)) {

258 
p
+=2;

259 ià(
	`uch¬
(*(
p
-2)è<ğ
c
 && c <= uchar(*p))

260  
sig
;

262 ià(
	`uch¬
(*
p
è=ğ
c
è 
sig
;

264  !
sig
;

265 
	}
}

268 
	$sšgËm©ch
 (
c
, cÚ¡ *
p
, cÚ¡ *
•
) {

269 *
p
) {

271 
L_ESC
:  
	`m©ch_şass
(
c
, 
	`uch¬
(*(
p
+1)));

272 '[':  
	`m©chb¿ck‘şass
(
c
, 
p
, 
•
-1);

273 :  (
	`uch¬
(*
p
è=ğ
c
);

275 
	}
}

278 cÚ¡ *
m©ch
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
);

281 cÚ¡ *
	$m©chb®ªû
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

282 cÚ¡ *
p
) {

283 ià(*
p
 == 0 || *(p+1) == 0)

284 
	`luaL_”rÜ
(
ms
->
L
, "unbalanced…attern");

285 ià(*
s
 !ğ*
p
è 
NULL
;

287 
b
 = *
p
;

288 
e
 = *(
p
+1);

289 
cÚt
 = 1;

290 ++
s
 < 
ms
->
¤c_’d
) {

291 ià(*
s
 =ğ
e
) {

292 ià(--
cÚt
 =ğ0è 
s
+1;

294 ià(*
s
 =ğ
b
è
cÚt
++;

297  
NULL
;

298 
	}
}

301 cÚ¡ *
	$max_ex·nd
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

302 cÚ¡ *
p
, cÚ¡ *
•
) {

303 
±rdiff_t
 
i
 = 0;

304 (
s
+
i
)<
ms
->
¤c_’d
 && 
	`sšgËm©ch
(
	`uch¬
(*(s+i)), 
p
, 
•
))

305 
i
++;

307 
i
>=0) {

308 cÚ¡ *
»s
 = 
	`m©ch
(
ms
, (
s
+
i
), 
•
+1);

309 ià(
»s
) „es;

310 
i
--;

312  
NULL
;

313 
	}
}

316 cÚ¡ *
	$mš_ex·nd
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

317 cÚ¡ *
p
, cÚ¡ *
•
) {

319 cÚ¡ *
»s
 = 
	`m©ch
(
ms
, 
s
, 
•
+1);

320 ià(
»s
 !ğ
NULL
)

321  
»s
;

322 ià(
s
<
ms
->
¤c_’d
 && 
	`sšgËm©ch
(
	`uch¬
(*s), 
p
, 
•
))

323 
s
++;

324  
NULL
;

326 
	}
}

329 cÚ¡ *
	$¡¬t_ÿ±u»
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

330 cÚ¡ *
p
, 
wh©
) {

331 cÚ¡ *
»s
;

332 
Ëv–
 = 
ms
->level;

333 ià(
Ëv–
 >ğ
LUA_MAXCAPTURES
è
	`luaL_”rÜ
(
ms
->
L
, "too many captures");

334 
ms
->
ÿ±u»
[
Ëv–
].
š™
 = 
s
;

335 
ms
->
ÿ±u»
[
Ëv–
].
Ën
 = 
wh©
;

336 
ms
->
Ëv–
 =†evel+1;

337 ià((
»s
=
	`m©ch
(
ms
, 
s
, 
p
)è=ğ
NULL
)

338 
ms
->
Ëv–
--;

339  
»s
;

340 
	}
}

343 cÚ¡ *
	$’d_ÿ±u»
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

344 cÚ¡ *
p
) {

345 
l
 = 
	`ÿ±u»_to_şo£
(
ms
);

346 cÚ¡ *
»s
;

347 
ms
->
ÿ±u»
[
l
].
Ën
 = 
s
 - ms->ÿ±u»[l].
š™
;

348 ià((
»s
 = 
	`m©ch
(
ms
, 
s
, 
p
)è=ğ
NULL
)

349 
ms
->
ÿ±u»
[
l
].
Ën
 = 
CAP_UNFINISHED
;

350  
»s
;

351 
	}
}

354 cÚ¡ *
	$m©ch_ÿ±u»
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, 
l
) {

355 
size_t
 
Ën
;

356 
l
 = 
	`check_ÿ±u»
(
ms
,†);

357 
Ën
 = 
ms
->
ÿ±u»
[
l
].len;

358 ià((
size_t
)(
ms
->
¤c_’d
-
s
è>ğ
Ën
 &&

359 
	`memcmp
(
ms
->
ÿ±u»
[
l
].
š™
, 
s
, 
Ën
) == 0)

360  
s
+
Ën
;

361  
NULL
;

362 
	}
}

365 cÚ¡ *
	$m©ch
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
) {

366 
š™
:

367 *
p
) {

369 ià(*(
p
+1) == ')')

370  
	`¡¬t_ÿ±u»
(
ms
, 
s
, 
p
+2, 
CAP_POSITION
);

372  
	`¡¬t_ÿ±u»
(
ms
, 
s
, 
p
+1, 
CAP_UNFINISHED
);

375  
	`’d_ÿ±u»
(
ms
, 
s
, 
p
+1);

377 
L_ESC
: {

378 *(
p
+1)) {

380 
s
 = 
	`m©chb®ªû
(
ms
, s, 
p
+2);

381 ià(
s
 =ğ
NULL
)  NULL;

382 
p
+=4; 
š™
;

385 cÚ¡ *
•
; 
´evious
;

386 
p
 += 2;

387 ià(*
p
 != '[')

388 
	`luaL_”rÜ
(
ms
->
L
, "missšg " 
	`LUA_QL
("[") "‡fter "

389 
	`LUA_QL
("%%f") " in…attern");

390 
•
 = 
	`şas£nd
(
ms
, 
p
);

391 
´evious
 = (
s
 =ğ
ms
->
¤c_š™
) ? '\0' : *(s-1);

392 ià(
	`m©chb¿ck‘şass
(
	`uch¬
(
´evious
), 
p
, 
•
-1) ||

393 !
	`m©chb¿ck‘şass
(
	`uch¬
(*
s
), 
p
, 
•
-1)è 
NULL
;

394 
p
=
•
; 
š™
;

397 ià(
	`isdig™
(
	`uch¬
(*(
p
+1)))) {

398 
s
 = 
	`m©ch_ÿ±u»
(
ms
, s, 
	`uch¬
(*(
p
+1)));

399 ià(
s
 =ğ
NULL
)  NULL;

400 
p
+=2; 
š™
;

402 
dæt
;

407  
s
;

410 ià(*(
p
+1) == '\0')

411  (
s
 =ğ
ms
->
¤c_’d
è? s : 
NULL
;

412 
dæt
;

414 : 
dæt
: {

415 cÚ¡ *
•
 = 
	`şas£nd
(
ms
, 
p
);

416 
m
 = 
s
<
ms
->
¤c_’d
 && 
	`sšgËm©ch
(
	`uch¬
(*s), 
p
, 
•
);

417 *
•
) {

419 cÚ¡ *
»s
;

420 ià(
m
 && ((
»s
=
	`m©ch
(
ms
, 
s
+1, 
•
+1)è!ğ
NULL
))

421  
»s
;

422 
p
=
•
+1; 
š™
;

425  
	`max_ex·nd
(
ms
, 
s
, 
p
, 
•
);

428  (
m
 ? 
	`max_ex·nd
(
ms
, 
s
+1, 
p
, 
•
è: 
NULL
);

431  
	`mš_ex·nd
(
ms
, 
s
, 
p
, 
•
);

434 ià(!
m
è 
NULL
;

435 
s
++; 
p
=
•
; 
š™
;

440 
	}
}

444 cÚ¡ *
	$lmemfšd
 (cÚ¡ *
s1
, 
size_t
 
l1
,

445 cÚ¡ *
s2
, 
size_t
 
l2
) {

446 ià(
l2
 =ğ0è 
s1
;

447 ià(
l2
 > 
l1
è 
NULL
;

449 cÚ¡ *
š™
;

450 
l2
--;

451 
l1
 =†1-
l2
;

452 
l1
 > 0 && (
š™
 = (cÚ¡ *)
	`memchr
(
s1
, *
s2
,†1)è!ğ
NULL
) {

453 
š™
++;

454 ià(
	`memcmp
(
š™
, 
s2
+1, 
l2
) == 0)

455  
š™
-1;

457 
l1
 -ğ
š™
-
s1
;

458 
s1
 = 
š™
;

461  
NULL
;

463 
	}
}

466 
	$push_Úeÿ±u»
 (
M©chS‹
 *
ms
, 
i
, cÚ¡ *
s
,

467 cÚ¡ *
e
) {

468 ià(
i
 >ğ
ms
->
Ëv–
) {

469 ià(
i
 == 0)

470 
	`lua_pushl¡ršg
(
ms
->
L
, 
s
, 
e
 - s);

472 
	`luaL_”rÜ
(
ms
->
L
, "invalid capture index");

475 
±rdiff_t
 
l
 = 
ms
->
ÿ±u»
[
i
].
Ën
;

476 ià(
l
 =ğ
CAP_UNFINISHED
è
	`luaL_”rÜ
(
ms
->
L
, "unfinished capture");

477 ià(
l
 =ğ
CAP_POSITION
)

478 
	`lua_pushš‹g”
(
ms
->
L
, ms->
ÿ±u»
[
i
].
š™
 - ms->
¤c_š™
 + 1);

480 
	`lua_pushl¡ršg
(
ms
->
L
, ms->
ÿ±u»
[
i
].
š™
, 
l
);

482 
	}
}

485 
	$push_ÿ±u»s
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
e
) {

486 
i
;

487 
Æev–s
 = (
ms
->
Ëv–
 =ğ0 && 
s
) ? 1 : ms->level;

488 
	`luaL_check¡ack
(
ms
->
L
, 
Æev–s
, "too many captures");

489 
i
 = 0; i < 
Æev–s
; i++)

490 
	`push_Úeÿ±u»
(
ms
, 
i
, 
s
, 
e
);

491  
Æev–s
;

492 
	}
}

495 
	$¡r_fšd_aux
 (
lua_S‹
 *
L
, 
fšd
) {

496 
size_t
 
l1
, 
l2
;

497 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l1
);

498 cÚ¡ *
p
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
l2
);

499 
±rdiff_t
 
š™
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, 1), 
l1
) - 1;

500 ià(
š™
 < 0) init = 0;

501 ià((
size_t
)(
š™
è> 
l1
èš™ = (
±rdiff_t
)l1;

502 ià(
fšd
 && (
	`lua_toboŞ—n
(
L
, 4) ||

503 
	`¡½brk
(
p
, 
SPECIALS
è=ğ
NULL
)) {

505 cÚ¡ *
s2
 = 
	`lmemfšd
(
s
+
š™
, 
l1
-š™, 
p
, 
l2
);

506 ià(
s2
) {

507 
	`lua_pushš‹g”
(
L
, 
s2
-
s
+1);

508 
	`lua_pushš‹g”
(
L
, 
s2
-
s
+
l2
);

513 
M©chS‹
 
ms
;

514 
ªchÜ
 = (*
p
 == '^') ? (p++, 1) : 0;

515 cÚ¡ *
s1
=
s
+
š™
;

516 
ms
.
L
 = L;

517 
ms
.
¤c_š™
 = 
s
;

518 
ms
.
¤c_’d
 = 
s
+
l1
;

520 cÚ¡ *
»s
;

521 
ms
.
Ëv–
 = 0;

522 ià((
»s
=
	`m©ch
(&
ms
, 
s1
, 
p
)è!ğ
NULL
) {

523 ià(
fšd
) {

524 
	`lua_pushš‹g”
(
L
, 
s1
-
s
+1);

525 
	`lua_pushš‹g”
(
L
, 
»s
-
s
);

526  
	`push_ÿ±u»s
(&
ms
, 
NULL
, 0) + 2;

529  
	`push_ÿ±u»s
(&
ms
, 
s1
, 
»s
);

531 } 
s1
++ < 
ms
.
¤c_’d
 && !
ªchÜ
);

533 
	`lua_pushn
(
L
);

535 
	}
}

538 
	$¡r_fšd
 (
lua_S‹
 *
L
) {

539  
	`¡r_fšd_aux
(
L
, 1);

540 
	}
}

543 
	$¡r_m©ch
 (
lua_S‹
 *
L
) {

544  
	`¡r_fšd_aux
(
L
, 0);

545 
	}
}

548 
	$gm©ch_aux
 (
lua_S‹
 *
L
) {

549 
M©chS‹
 
ms
;

550 
size_t
 
ls
;

551 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, 
	`lua_upv®uešdex
(1), &
ls
);

552 cÚ¡ *
p
 = 
	`lua_to¡ršg
(
L
, 
	`lua_upv®uešdex
(2));

553 cÚ¡ *
¤c
;

554 
ms
.
L
 = L;

555 
ms
.
¤c_š™
 = 
s
;

556 
ms
.
¤c_’d
 = 
s
+
ls
;

557 
¤c
 = 
s
 + (
size_t
)
	`lua_toš‹g”
(
L
, 
	`lua_upv®uešdex
(3));

558 
¤c
 <ğ
ms
.
¤c_’d
;

559 
¤c
++) {

560 cÚ¡ *
e
;

561 
ms
.
Ëv–
 = 0;

562 ià((
e
 = 
	`m©ch
(&
ms
, 
¤c
, 
p
)è!ğ
NULL
) {

563 
lua_IÁeg”
 
Ãw¡¬t
 = 
e
-
s
;

564 ià(
e
 =ğ
¤c
è
Ãw¡¬t
++;

565 
	`lua_pushš‹g”
(
L
, 
Ãw¡¬t
);

566 
	`lua_»¶aû
(
L
, 
	`lua_upv®uešdex
(3));

567  
	`push_ÿ±u»s
(&
ms
, 
¤c
, 
e
);

571 
	}
}

574 
	$gm©ch
 (
lua_S‹
 *
L
) {

575 
	`luaL_check¡ršg
(
L
, 1);

576 
	`luaL_check¡ršg
(
L
, 2);

577 
	`lua_£‰İ
(
L
, 2);

578 
	`lua_pushš‹g”
(
L
, 0);

579 
	`lua_pushcşosu»
(
L
, 
gm©ch_aux
, 3);

581 
	}
}

584 
	$gfšd_nodef
 (
lua_S‹
 *
L
) {

585  
	`luaL_”rÜ
(
L
, 
	`LUA_QL
("string.gfind") " was„enamedo "

586 
	`LUA_QL
("string.gmatch"));

587 
	}
}

590 
	$add_s
 (
M©chS‹
 *
ms
, 
luaL_Bufãr
 *
b
, cÚ¡ *
s
,

591 cÚ¡ *
e
) {

592 
size_t
 
l
, 
i
;

593 cÚ¡ *
Ãws
 = 
	`lua_tŞ¡ršg
(
ms
->
L
, 3, &
l
);

594 
i
 = 0; i < 
l
; i++) {

595 ià(
Ãws
[
i
] !ğ
L_ESC
)

596 
	`luaL_addch¬
(
b
, 
Ãws
[
i
]);

598 
i
++;

599 ià(!
	`isdig™
(
	`uch¬
(
Ãws
[
i
])))

600 
	`luaL_addch¬
(
b
, 
Ãws
[
i
]);

601 ià(
Ãws
[
i
] == '0')

602 
	`luaL_addl¡ršg
(
b
, 
s
, 
e
 - s);

604 
	`push_Úeÿ±u»
(
ms
, 
Ãws
[
i
] - '1', 
s
, 
e
);

605 
	`luaL_addv®ue
(
b
);

609 
	}
}

612 
	$add_v®ue
 (
M©chS‹
 *
ms
, 
luaL_Bufãr
 *
b
, cÚ¡ *
s
,

613 cÚ¡ *
e
) {

614 
lua_S‹
 *
L
 = 
ms
->L;

615 
	`lua_ty³
(
L
, 3)) {

616 
LUA_TNUMBER
:

617 
LUA_TSTRING
: {

618 
	`add_s
(
ms
, 
b
, 
s
, 
e
);

621 
LUA_TFUNCTION
: {

622 
n
;

623 
	`lua_pushv®ue
(
L
, 3);

624 
n
 = 
	`push_ÿ±u»s
(
ms
, 
s
, 
e
);

625 
	`lua_ÿÎ
(
L
, 
n
, 1);

628 
LUA_TTABLE
: {

629 
	`push_Úeÿ±u»
(
ms
, 0, 
s
, 
e
);

630 
	`lua_g‘bË
(
L
, 3);

634 ià(!
	`lua_toboŞ—n
(
L
, -1)) {

635 
	`lua_pİ
(
L
, 1);

636 
	`lua_pushl¡ršg
(
L
, 
s
, 
e
 - s);

638 ià(!
	`lua_is¡ršg
(
L
, -1))

639 
	`luaL_”rÜ
(
L
, "šv®id„•Ïûm’ˆv®u× %s)", 
	`luaL_ty³Çme
(L, -1));

640 
	`luaL_addv®ue
(
b
);

641 
	}
}

644 
	$¡r_gsub
 (
lua_S‹
 *
L
) {

645 
size_t
 
¤ş
;

646 cÚ¡ *
¤c
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
¤ş
);

647 cÚ¡ *
p
 = 
	`luaL_check¡ršg
(
L
, 2);

648 
Œ
 = 
	`lua_ty³
(
L
, 3);

649 
max_s
 = 
	`luaL_İtšt
(
L
, 4, 
¤ş
+1);

650 
ªchÜ
 = (*
p
 == '^') ? (p++, 1) : 0;

651 
n
 = 0;

652 
M©chS‹
 
ms
;

653 
luaL_Bufãr
 
b
;

654 
	`luaL_¬gcheck
(
L
, 
Œ
 =ğ
LUA_TNUMBER
 ||¸=ğ
LUA_TSTRING
 ||

655 
Œ
 =ğ
LUA_TFUNCTION
 ||¸=ğ
LUA_TTABLE
, 3,

657 
	`luaL_buffš™
(
L
, &
b
);

658 
ms
.
L
 = L;

659 
ms
.
¤c_š™
 = 
¤c
;

660 
ms
.
¤c_’d
 = 
¤c
+
¤ş
;

661 
n
 < 
max_s
) {

662 cÚ¡ *
e
;

663 
ms
.
Ëv–
 = 0;

664 
e
 = 
	`m©ch
(&
ms
, 
¤c
, 
p
);

665 ià(
e
) {

666 
n
++;

667 
	`add_v®ue
(&
ms
, &
b
, 
¤c
, 
e
);

669 ià(
e
 &&ƒ>
¤c
)

670 
¤c
 = 
e
;

671 ià(
¤c
 < 
ms
.
¤c_’d
)

672 
	`luaL_addch¬
(&
b
, *
¤c
++);

674 ià(
ªchÜ
) ;

676 
	`luaL_addl¡ršg
(&
b
, 
¤c
, 
ms
.
¤c_’d
-src);

677 
	`luaL_push»suÉ
(&
b
);

678 
	`lua_pushš‹g”
(
L
, 
n
);

680 
	}
}

686 
	#MAX_ITEM
 512

	)

688 
	#FLAGS
 "-+ #0"

	)

693 
	#MAX_FORMAT
 ((
FLAGS
è+ (
LUA_INTFRMLEN
è+ 10)

	)

696 
	$addquÙed
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
b
, 
¬g
) {

697 
size_t
 
l
;

698 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
l
);

699 
	`luaL_addch¬
(
b
, '"');

700 
l
--) {

701 *
s
) {

703 
	`luaL_addch¬
(
b
, '\\');

704 
	`luaL_addch¬
(
b
, *
s
);

708 
	`luaL_addl¡ršg
(
b
, "\\r", 2);

712 
	`luaL_addl¡ršg
(
b
, "\\000", 4);

716 
	`luaL_addch¬
(
b
, *
s
);

720 
s
++;

722 
	`luaL_addch¬
(
b
, '"');

723 
	}
}

725 cÚ¡ *
	$sÿnfÜm©
 (
lua_S‹
 *
L
, cÚ¡ *
¡rämt
, *
fÜm
) {

726 cÚ¡ *
p
 = 
¡rämt
;

727 *
p
 !ğ'\0' && 
	`¡rchr
(
FLAGS
, *pè!ğ
NULL
)…++;

728 ià((
size_t
)(
p
 - 
¡rämt
è>ğ(
FLAGS
))

729 
	`luaL_”rÜ
(
L
, "invalid format (repeated flags)");

730 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

731 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

732 ià(*
p
 == '.') {

733 
p
++;

734 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

735 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

737 ià(
	`isdig™
(
	`uch¬
(*
p
)))

738 
	`luaL_”rÜ
(
L
, "invalid format (width or…recisionoo†ong)");

739 *(
fÜm
++) = '%';

740 
	`¡ºıy
(
fÜm
, 
¡rämt
, 
p
 - strfrmt + 1);

741 
fÜm
 +ğ
p
 - 
¡rämt
 + 1;

742 *
fÜm
 = '\0';

743  
p
;

744 
	}
}

747 
	$addš’
 (*
fÜm
) {

748 
size_t
 
l
 = 
	`¡¾’
(
fÜm
);

749 
¥ec
 = 
fÜm
[
l
 - 1];

750 
	`¡rıy
(
fÜm
 + 
l
 - 1, 
LUA_INTFRMLEN
);

751 
fÜm
[
l
 + (
LUA_INTFRMLEN
è- 2] = 
¥ec
;

752 
fÜm
[
l
 + (
LUA_INTFRMLEN
) - 1] = '\0';

753 
	}
}

756 
	$¡r_fÜm©
 (
lua_S‹
 *
L
) {

757 
tİ
 = 
	`lua_g‘tİ
(
L
);

758 
¬g
 = 1;

759 
size_t
 
sæ
;

760 cÚ¡ *
¡rämt
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
sæ
);

761 cÚ¡ *
¡rämt_’d
 = 
¡rämt
+
sæ
;

762 
luaL_Bufãr
 
b
;

763 
	`luaL_buffš™
(
L
, &
b
);

764 
¡rämt
 < 
¡rämt_’d
) {

765 ià(*
¡rämt
 !ğ
L_ESC
)

766 
	`luaL_addch¬
(&
b
, *
¡rämt
++);

767 ià(*++
¡rämt
 =ğ
L_ESC
)

768 
	`luaL_addch¬
(&
b
, *
¡rämt
++);

770 
fÜm
[
MAX_FORMAT
];

771 
buff
[
MAX_ITEM
];

772 ià(++
¬g
 > 
tİ
)

773 
	`luaL_¬g”rÜ
(
L
, 
¬g
, "no value");

774 
¡rämt
 = 
	`sÿnfÜm©
(
L
, sŒämt, 
fÜm
);

775 *
¡rämt
++) {

777 
	`¥rštf
(
buff
, 
fÜm
, ()
	`luaL_checknumb”
(
L
, 
¬g
));

781 
	`addš’
(
fÜm
);

782 
	`¥rštf
(
buff
, 
fÜm
, (
LUA_INTFRM_T
)
	`luaL_checknumb”
(
L
, 
¬g
));

786 
	`addš’
(
fÜm
);

787 
	`¥rštf
(
buff
, 
fÜm
, (
LUA_INTFRM_T
)
	`luaL_checknumb”
(
L
, 
¬g
));

792 
	`¥rštf
(
buff
, 
fÜm
, ()
	`luaL_checknumb”
(
L
, 
¬g
));

796 
	`addquÙed
(
L
, &
b
, 
¬g
);

800 
size_t
 
l
;

801 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
l
);

802 ià(!
	`¡rchr
(
fÜm
, '.'è&& 
l
 >= 100) {

805 
	`lua_pushv®ue
(
L
, 
¬g
);

806 
	`luaL_addv®ue
(&
b
);

810 
	`¥rštf
(
buff
, 
fÜm
, 
s
);

815  
	`luaL_”rÜ
(
L
, "šv®id o±iÚ " 
	`LUA_QL
("%%%c") "o "

816 
	`LUA_QL
("fÜm©"), *(
¡rämt
 - 1));

819 
	`luaL_addl¡ršg
(&
b
, 
buff
, 
	`¡¾’
(buff));

822 
	`luaL_push»suÉ
(&
b
);

824 
	}
}

827 cÚ¡ 
luaL_Reg
 
	g¡¾ib
[] = {

828 {"by‹", 
¡r_by‹
},

829 {"ch¬", 
¡r_ch¬
},

830 {"dump", 
¡r_dump
},

831 {"fšd", 
¡r_fšd
},

832 {"fÜm©", 
¡r_fÜm©
},

833 {"gfšd", 
gfšd_nodef
},

834 {"gm©ch", 
gm©ch
},

835 {"gsub", 
¡r_gsub
},

836 {"Ën", 
¡r_Ën
},

837 {"low”", 
¡r_low”
},

838 {"m©ch", 
¡r_m©ch
},

839 {"»p", 
¡r_»p
},

840 {"»v”£", 
¡r_»v”£
},

841 {"sub", 
¡r_sub
},

842 {"uµ”", 
¡r_uµ”
},

843 {
NULL
, NULL}

847 
	$ü—‹m‘©abË
 (
lua_S‹
 *
L
) {

848 
	`lua_ü—‹bË
(
L
, 0, 1);

849 
	`lua_pushl™”®
(
L
, "");

850 
	`lua_pushv®ue
(
L
, -2);

851 
	`lua_£tm‘©abË
(
L
, -2);

852 
	`lua_pİ
(
L
, 1);

853 
	`lua_pushv®ue
(
L
, -2);

854 
	`lua_£tf›ld
(
L
, -2, "__index");

855 
	`lua_pİ
(
L
, 1);

856 
	}
}

862 
LUALIB_API
 
	$luaİ’_¡ršg
 (
lua_S‹
 *
L
) {

863 
	`luaL_»gi¡”
(
L
, 
LUA_STRLIBNAME
, 
¡¾ib
);

864 #ià
	`defšed
(
LUA_COMPAT_GFIND
)

865 
	`lua_g‘f›ld
(
L
, -1, "gmatch");

866 
	`lua_£tf›ld
(
L
, -2, "gfind");

868 
	`ü—‹m‘©abË
(
L
);

870 
	}
}

	@deps/lua/src/ltable.c

21 
	~<m©h.h
>

22 
	~<¡ršg.h
>

24 
	#ÉabË_c


	)

25 
	#LUA_CORE


	)

27 
	~"lua.h
"

29 
	~"ldebug.h
"

30 
	~"ldo.h
"

31 
	~"lgc.h
"

32 
	~"lmem.h
"

33 
	~"lobjeù.h
"

34 
	~"l¡©e.h
"

35 
	~"ÉabË.h
"

41 #ià
LUAI_BITSINT
 > 26

42 
	#MAXBITS
 26

	)

44 
	#MAXBITS
 (
LUAI_BITSINT
-2)

	)

47 
	#MAXASIZE
 (1 << 
MAXBITS
)

	)

50 
	#hashpow2
(
t
,
n
è(
	`gnode
Ñ, 
	`lmod
(Ò), 
	`siz’ode
Ñ))))

	)

52 
	#hash¡r
(
t
,
¡r
è
	`hashpow2
Ñ, (¡r)->
tsv
.
hash
)

	)

53 
	#hashboŞ—n
(
t
,
p
è
	`hashpow2
Ñ,…)

	)

60 
	#hashmod
(
t
,
n
è(
	`gnode
Ñ, (Òè% ((
	`siz’ode
Ñ)-1)|1))))

	)

63 
	#hashpoš‹r
(
t
,
p
è
	`hashmod
Ñ, 
	`IÁPošt
Õ))

	)

69 
	#numšts
 
	`ÿ¡_št
((
lua_Numb”
)/())

	)

73 
	#dummynode
 (&
dummynode_
)

	)

75 cÚ¡ 
Node
 
	gdummynode_
 = {

76 {{
NULL
}, 
LUA_TNIL
},

77 {{{
NULL
}, 
LUA_TNIL
, NULL}}

84 
Node
 *
	$hashnum
 (cÚ¡ 
TabË
 *
t
, 
lua_Numb”
 
n
) {

85 
a
[
numšts
];

86 
i
;

87 ià(
	`luai_numeq
(
n
, 0))

88  
	`gnode
(
t
, 0);

89 
	`memıy
(
a
, &
n
, (a));

90 
i
 = 1; i < 
numšts
; i++è
a
[0] +=‡[i];

91  
	`hashmod
(
t
, 
a
[0]);

92 
	}
}

100 
Node
 *
	$mašpos™iÚ
 (cÚ¡ 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

101 
	`‰y³
(
key
)) {

102 
LUA_TNUMBER
:

103  
	`hashnum
(
t
, 
	`nv®ue
(
key
));

104 
LUA_TSTRING
:

105  
	`hash¡r
(
t
, 
	`¿wtsv®ue
(
key
));

106 
LUA_TBOOLEAN
:

107  
	`hashboŞ—n
(
t
, 
	`bv®ue
(
key
));

108 
LUA_TLIGHTUSERDATA
:

109  
	`hashpoš‹r
(
t
, 
	`pv®ue
(
key
));

111  
	`hashpoš‹r
(
t
, 
	`gcv®ue
(
key
));

113 
	}
}

120 
	$¬¿yšdex
 (cÚ¡ 
TV®ue
 *
key
) {

121 ià(
	`‰i¢umb”
(
key
)) {

122 
lua_Numb”
 
n
 = 
	`nv®ue
(
key
);

123 
k
;

124 
	`lua_numb”2št
(
k
, 
n
);

125 ià(
	`luai_numeq
(
	`ÿ¡_num
(
k
), 
n
))

126  
k
;

129 
	}
}

137 
	$fšdšdex
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
StkId
 
key
) {

138 
i
;

139 ià(
	`‰i¢
(
key
))  -1;

140 
i
 = 
	`¬¿yšdex
(
key
);

141 ià(0 < 
i
 && i <ğ
t
->
siz—¼ay
)

142  
i
-1;

144 
Node
 *
n
 = 
	`mašpos™iÚ
(
t
, 
key
);

147 ià(
	`luaO_¿wequ®Obj
(
	`key2tv®
(
n
), 
key
) ||

148 (
	`‰y³
(
	`gkey
(
n
)è=ğ
LUA_TDEADKEY
 && 
	`iscŞËùabË
(
key
) &&

149 
	`gcv®ue
(
	`gkey
(
n
)è=ğgcv®ue(
key
))) {

150 
i
 = 
	`ÿ¡_št
(
n
 - 
	`gnode
(
t
, 0));

152  
i
 + 
t
->
siz—¼ay
;

154 
n
 = 
	`gÃxt
(n);

155 } 
n
);

156 
	`luaG_ruÃ¼Ü
(
L
, "šv®id keyØ" 
	`LUA_QL
("next"));

159 
	}
}

162 
	$luaH_Ãxt
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
StkId
 
key
) {

163 
i
 = 
	`fšdšdex
(
L
, 
t
, 
key
);

164 
i
++; i < 
t
->
siz—¼ay
; i++) {

165 ià(!
	`‰i¢
(&
t
->
¬¿y
[
i
])) {

166 
	`£Šv®ue
(
key
, 
	`ÿ¡_num
(
i
+1));

167 
	`£tobj2s
(
L
, 
key
+1, &
t
->
¬¿y
[
i
]);

171 
i
 -ğ
t
->
siz—¼ay
; i < 
	`siz’ode
(t); i++) {

172 ià(!
	`‰i¢
(
	`gv®
(
	`gnode
(
t
, 
i
)))) {

173 
	`£tobj2s
(
L
, 
key
, 
	`key2tv®
(
	`gnode
(
t
, 
i
)));

174 
	`£tobj2s
(
L
, 
key
+1, 
	`gv®
(
	`gnode
(
t
, 
i
)));

179 
	}
}

189 
	$compu‹sizes
 (
nums
[], *
Ç¼ay
) {

190 
i
;

191 
twÙoi
;

192 
a
 = 0;

193 
Ç
 = 0;

194 
n
 = 0;

195 
i
 = 0, 
twÙoi
 = 1;wÙoi/2 < *
Ç¼ay
; i++,wotoi *= 2) {

196 ià(
nums
[
i
] > 0) {

197 
a
 +ğ
nums
[
i
];

198 ià(
a
 > 
twÙoi
/2) {

199 
n
 = 
twÙoi
;

200 
Ç
 = 
a
;

203 ià(
a
 =ğ*
Ç¼ay
) ;

205 *
Ç¼ay
 = 
n
;

206 
	`lua_as£¹
(*
Ç¼ay
/2 <ğ
Ç
 &&‚a <= *narray);

207  
Ç
;

208 
	}
}

211 
	$couÁšt
 (cÚ¡ 
TV®ue
 *
key
, *
nums
) {

212 
k
 = 
	`¬¿yšdex
(
key
);

213 ià(0 < 
k
 && k <ğ
MAXASIZE
) {

214 
nums
[
	`ûlog2
(
k
)]++;

219 
	}
}

222 
	$numu£¬¿y
 (cÚ¡ 
TabË
 *
t
, *
nums
) {

223 
lg
;

224 
‰lg
;

225 
au£
 = 0;

226 
i
 = 1;

227 
lg
=0, 
‰lg
=1;†g<=
MAXBITS
;†g++,tlg*=2) {

228 
lc
 = 0;

229 
lim
 = 
‰lg
;

230 ià(
lim
 > 
t
->
siz—¼ay
) {

231 
lim
 = 
t
->
siz—¼ay
;

232 ià(
i
 > 
lim
)

236 ; 
i
 <ğ
lim
; i++) {

237 ià(!
	`‰i¢
(&
t
->
¬¿y
[
i
-1]))

238 
lc
++;

240 
nums
[
lg
] +ğ
lc
;

241 
au£
 +ğ
lc
;

243  
au£
;

244 
	}
}

247 
	$numu£hash
 (cÚ¡ 
TabË
 *
t
, *
nums
, *
²asize
) {

248 
tÙ®u£
 = 0;

249 
au£
 = 0;

250 
i
 = 
	`siz’ode
(
t
);

251 
i
--) {

252 
Node
 *
n
 = &
t
->
node
[
i
];

253 ià(!
	`‰i¢
(
	`gv®
(
n
))) {

254 
au£
 +ğ
	`couÁšt
(
	`key2tv®
(
n
), 
nums
);

255 
tÙ®u£
++;

258 *
²asize
 +ğ
au£
;

259  
tÙ®u£
;

260 
	}
}

263 
	$£¼ayveùÜ
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
size
) {

264 
i
;

265 
	`luaM_»®locveùÜ
(
L
, 
t
->
¬¿y
,->
siz—¼ay
, 
size
, 
TV®ue
);

266 
i
=
t
->
siz—¼ay
; i<
size
; i++)

267 
	`£Šv®ue
(&
t
->
¬¿y
[
i
]);

268 
t
->
siz—¼ay
 = 
size
;

269 
	}
}

272 
	$£ŠodeveùÜ
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
size
) {

273 
lsize
;

274 ià(
size
 == 0) {

275 
t
->
node
 = 
	`ÿ¡
(
Node
 *, 
dummynode
);

276 
lsize
 = 0;

279 
i
;

280 
lsize
 = 
	`ûlog2
(
size
);

281 ià(
lsize
 > 
MAXBITS
)

282 
	`luaG_ruÃ¼Ü
(
L
, "table overflow");

283 
size
 = 
	`twÙo
(
lsize
);

284 
t
->
node
 = 
	`luaM_ÃwveùÜ
(
L
, 
size
, 
Node
);

285 
i
=0; i<
size
; i++) {

286 
Node
 *
n
 = 
	`gnode
(
t
, 
i
);

287 
	`gÃxt
(
n
èğ
NULL
;

288 
	`£Šv®ue
(
	`gkey
(
n
));

289 
	`£Šv®ue
(
	`gv®
(
n
));

292 
t
->
lsiz’ode
 = 
	`ÿ¡_by‹
(
lsize
);

293 
t
->
Ï¡ä“
 = 
	`gnode
Ñ, 
size
);

294 
	}
}

297 
	$»size
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
Çsize
, 
nhsize
) {

298 
i
;

299 
Şdasize
 = 
t
->
siz—¼ay
;

300 
Şdhsize
 = 
t
->
lsiz’ode
;

301 
Node
 *
nŞd
 = 
t
->
node
;

302 ià(
Çsize
 > 
Şdasize
)

303 
	`£¼ayveùÜ
(
L
, 
t
, 
Çsize
);

305 
	`£ŠodeveùÜ
(
L
, 
t
, 
nhsize
);

306 ià(
Çsize
 < 
Şdasize
) {

307 
t
->
siz—¼ay
 = 
Çsize
;

309 
i
=
Çsize
; i<
Şdasize
; i++) {

310 ià(!
	`‰i¢
(&
t
->
¬¿y
[
i
]))

311 
	`£tobjt2t
(
L
, 
	`luaH_£Šum
(L, 
t
, 
i
+1), &t->
¬¿y
[i]);

314 
	`luaM_»®locveùÜ
(
L
, 
t
->
¬¿y
, 
Şdasize
, 
Çsize
, 
TV®ue
);

317 
i
 = 
	`twÙo
(
Şdhsize
) - 1; i >= 0; i--) {

318 
Node
 *
Şd
 = 
nŞd
+
i
;

319 ià(!
	`‰i¢
(
	`gv®
(
Şd
)))

320 
	`£tobjt2t
(
L
, 
	`luaH_£t
(L, 
t
, 
	`key2tv®
(
Şd
)), 
	`gv®
(old));

322 ià(
nŞd
 !ğ
dummynode
)

323 
	`luaM_ä“¬¿y
(
L
, 
nŞd
, 
	`twÙo
(
Şdhsize
), 
Node
);

324 
	}
}

327 
	$luaH_»siz—¼ay
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
Çsize
) {

328 
nsize
 = (
t
->
node
 =ğ
dummynode
è? 0 : 
	`siz’ode
(t);

329 
	`»size
(
L
, 
t
, 
Çsize
, 
nsize
);

330 
	}
}

333 
	$»hash
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
ek
) {

334 
Çsize
, 
Ç
;

335 
nums
[
MAXBITS
+1];

336 
i
;

337 
tÙ®u£
;

338 
i
=0; i<=
MAXBITS
; i++è
nums
[i] = 0;

339 
Çsize
 = 
	`numu£¬¿y
(
t
, 
nums
);

340 
tÙ®u£
 = 
Çsize
;

341 
tÙ®u£
 +ğ
	`numu£hash
(
t
, 
nums
, &
Çsize
);

343 
Çsize
 +ğ
	`couÁšt
(
ek
, 
nums
);

344 
tÙ®u£
++;

346 
Ç
 = 
	`compu‹sizes
(
nums
, &
Çsize
);

348 
	`»size
(
L
, 
t
, 
Çsize
, 
tÙ®u£
 - 
Ç
);

349 
	}
}

358 
TabË
 *
	$luaH_Ãw
 (
lua_S‹
 *
L
, 
Ç¼ay
, 
nhash
) {

359 
TabË
 *
t
 = 
	`luaM_Ãw
(
L
, Table);

360 
	`luaC_lšk
(
L
, 
	`obj2gco
(
t
), 
LUA_TTABLE
);

361 
t
->
m‘©abË
 = 
NULL
;

362 
t
->
æags
 = 
	`ÿ¡_by‹
(~0);

364 
t
->
¬¿y
 = 
NULL
;

365 
t
->
siz—¼ay
 = 0;

366 
t
->
lsiz’ode
 = 0;

367 
t
->
node
 = 
	`ÿ¡
(
Node
 *, 
dummynode
);

368 
	`£¼ayveùÜ
(
L
, 
t
, 
Ç¼ay
);

369 
	`£ŠodeveùÜ
(
L
, 
t
, 
nhash
);

370  
t
;

371 
	}
}

374 
	$luaH_ä“
 (
lua_S‹
 *
L
, 
TabË
 *
t
) {

375 ià(
t
->
node
 !ğ
dummynode
)

376 
	`luaM_ä“¬¿y
(
L
, 
t
->
node
, 
	`siz’ode
Ñ), 
Node
);

377 
	`luaM_ä“¬¿y
(
L
, 
t
->
¬¿y
,->
siz—¼ay
, 
TV®ue
);

378 
	`luaM_ä“
(
L
, 
t
);

379 
	}
}

382 
Node
 *
	$g‘ä“pos
 (
TabË
 *
t
) {

383 
t
->
Ï¡ä“
-- >->
node
) {

384 ià(
	`‰i¢
(
	`gkey
(
t
->
Ï¡ä“
)))

385  
t
->
Ï¡ä“
;

387  
NULL
;

388 
	}
}

399 
TV®ue
 *
	$Ãwkey
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

400 
Node
 *
mp
 = 
	`mašpos™iÚ
(
t
, 
key
);

401 ià(!
	`‰i¢
(
	`gv®
(
mp
)è|| m°=ğ
dummynode
) {

402 
Node
 *
Ùh”n
;

403 
Node
 *
n
 = 
	`g‘ä“pos
(
t
);

404 ià(
n
 =ğ
NULL
) {

405 
	`»hash
(
L
, 
t
, 
key
);

406  
	`luaH_£t
(
L
, 
t
, 
key
);

408 
	`lua_as£¹
(
n
 !ğ
dummynode
);

409 
Ùh”n
 = 
	`mašpos™iÚ
(
t
, 
	`key2tv®
(
mp
));

410 ià(
Ùh”n
 !ğ
mp
) {

412 
	`gÃxt
(
Ùh”n
è!ğ
mp
) othern = gnext(othern);

413 
	`gÃxt
(
Ùh”n
èğ
n
;

414 *
n
 = *
mp
;

415 
	`gÃxt
(
mp
èğ
NULL
;

416 
	`£Šv®ue
(
	`gv®
(
mp
));

420 
	`gÃxt
(
n
èğgÃxt(
mp
);

421 
	`gÃxt
(
mp
èğ
n
;

422 
mp
 = 
n
;

425 
	`gkey
(
mp
)->
v®ue
 = 
key
->v®ue; gkey(mp)->
‰
 = key->tt;

426 
	`luaC_b¬r›¹
(
L
, 
t
, 
key
);

427 
	`lua_as£¹
(
	`‰i¢
(
	`gv®
(
mp
)));

428  
	`gv®
(
mp
);

429 
	}
}

435 cÚ¡ 
TV®ue
 *
	$luaH_g‘num
 (
TabË
 *
t
, 
key
) {

437 ià(
	`ÿ¡
(, 
key
-1è< ca¡(, 
t
->
siz—¼ay
))

438  &
t
->
¬¿y
[
key
-1];

440 
lua_Numb”
 
nk
 = 
	`ÿ¡_num
(
key
);

441 
Node
 *
n
 = 
	`hashnum
(
t
, 
nk
);

443 ià(
	`‰i¢umb”
(
	`gkey
(
n
)è&& 
	`luai_numeq
(
	`nv®ue
(gkeyÒ)), 
nk
))

444  
	`gv®
(
n
);

445 
n
 = 
	`gÃxt
(n);

446 } 
n
);

447  
luaO_nobjeù
;

449 
	}
}

455 cÚ¡ 
TV®ue
 *
	$luaH_g‘¡r
 (
TabË
 *
t
, 
TSŒšg
 *
key
) {

456 
Node
 *
n
 = 
	`hash¡r
(
t
, 
key
);

458 ià(
	`‰is¡ršg
(
	`gkey
(
n
)è&& 
	`¿wtsv®ue
(gkeyÒ)è=ğ
key
)

459  
	`gv®
(
n
);

460 
n
 = 
	`gÃxt
(n);

461 } 
n
);

462  
luaO_nobjeù
;

463 
	}
}

469 cÚ¡ 
TV®ue
 *
	$luaH_g‘
 (
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

470 
	`‰y³
(
key
)) {

471 
LUA_TNIL
:  
luaO_nobjeù
;

472 
LUA_TSTRING
:  
	`luaH_g‘¡r
(
t
, 
	`¿wtsv®ue
(
key
));

473 
LUA_TNUMBER
: {

474 
k
;

475 
lua_Numb”
 
n
 = 
	`nv®ue
(
key
);

476 
	`lua_numb”2št
(
k
, 
n
);

477 ià(
	`luai_numeq
(
	`ÿ¡_num
(
k
), 
	`nv®ue
(
key
)))

478  
	`luaH_g‘num
(
t
, 
k
);

482 
Node
 *
n
 = 
	`mašpos™iÚ
(
t
, 
key
);

484 ià(
	`luaO_¿wequ®Obj
(
	`key2tv®
(
n
), 
key
))

485  
	`gv®
(
n
);

486 
n
 = 
	`gÃxt
(n);

487 } 
n
);

488  
luaO_nobjeù
;

491 
	}
}

494 
TV®ue
 *
	$luaH_£t
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

495 cÚ¡ 
TV®ue
 *
p
 = 
	`luaH_g‘
(
t
, 
key
);

496 
t
->
æags
 = 0;

497 ià(
p
 !ğ
luaO_nobjeù
)

498  
	`ÿ¡
(
TV®ue
 *, 
p
);

500 ià(
	`‰i¢
(
key
)è
	`luaG_ruÃ¼Ü
(
L
, "table index is‚il");

501 ià(
	`‰i¢umb”
(
key
è&& 
	`luai_numi¢ª
(
	`nv®ue
(key)))

502 
	`luaG_ruÃ¼Ü
(
L
, "table index is NaN");

503  
	`Ãwkey
(
L
, 
t
, 
key
);

505 
	}
}

508 
TV®ue
 *
	$luaH_£Šum
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
key
) {

509 cÚ¡ 
TV®ue
 *
p
 = 
	`luaH_g‘num
(
t
, 
key
);

510 ià(
p
 !ğ
luaO_nobjeù
)

511  
	`ÿ¡
(
TV®ue
 *, 
p
);

513 
TV®ue
 
k
;

514 
	`£Šv®ue
(&
k
, 
	`ÿ¡_num
(
key
));

515  
	`Ãwkey
(
L
, 
t
, &
k
);

517 
	}
}

520 
TV®ue
 *
	$luaH_£t¡r
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
TSŒšg
 *
key
) {

521 cÚ¡ 
TV®ue
 *
p
 = 
	`luaH_g‘¡r
(
t
, 
key
);

522 ià(
p
 !ğ
luaO_nobjeù
)

523  
	`ÿ¡
(
TV®ue
 *, 
p
);

525 
TV®ue
 
k
;

526 
	`£tsv®ue
(
L
, &
k
, 
key
);

527  
	`Ãwkey
(
L
, 
t
, &
k
);

529 
	}
}

532 
	$unbound_£¬ch
 (
TabË
 *
t
, 
j
) {

533 
i
 = 
j
;

534 
j
++;

536 !
	`‰i¢
(
	`luaH_g‘num
(
t
, 
j
))) {

537 
i
 = 
j
;

538 
j
 *= 2;

539 ià(
j
 > 
	`ÿ¡
(, 
MAX_INT
)) {

541 
i
 = 1;

542 !
	`‰i¢
(
	`luaH_g‘num
(
t
, 
i
))) i++;

543  
i
 - 1;

547 
j
 - 
i
 > 1) {

548 
m
 = (
i
+
j
)/2;

549 ià(
	`‰i¢
(
	`luaH_g‘num
(
t
, 
m
))è
j
 = m;

550 
i
 = 
m
;

552  
i
;

553 
	}
}

560 
	$luaH_g‘n
 (
TabË
 *
t
) {

561 
j
 = 
t
->
siz—¼ay
;

562 ià(
j
 > 0 && 
	`‰i¢
(&
t
->
¬¿y
[j - 1])) {

564 
i
 = 0;

565 
j
 - 
i
 > 1) {

566 
m
 = (
i
+
j
)/2;

567 ià(
	`‰i¢
(&
t
->
¬¿y
[
m
 - 1])è
j
 = m;

568 
i
 = 
m
;

570  
i
;

573 ià(
t
->
node
 =ğ
dummynode
)

574  
j
;

575  
	`unbound_£¬ch
(
t
, 
j
);

576 
	}
}

580 #ià
defšed
(
LUA_DEBUG
)

582 
Node
 *
	$luaH_mašpos™iÚ
 (cÚ¡ 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

583  
	`mašpos™iÚ
(
t
, 
key
);

584 
	}
}

586 
	$luaH_isdummy
 (
Node
 *
n
è{ ‚ =ğ
dummynode
; 
	}
}

	@deps/lua/src/ltable.h

7 #iâdeà
ÉabË_h


8 
	#ÉabË_h


	)

10 
	~"lobjeù.h
"

13 
	#gnode
(
t
,
i
è(&Ñ)->
node
[i])

	)

14 
	#gkey
(
n
è(&Ò)->
i_key
.
nk
)

	)

15 
	#gv®
(
n
è(&Ò)->
i_v®
)

	)

16 
	#gÃxt
(
n
è(Ò)->
i_key
.
nk
.
Ãxt
)

	)

18 
	#key2tv®
(
n
è(&Ò)->
i_key
.
tvk
)

	)

21 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaH_g‘num
 (
TabË
 *
t
, 
key
);

22 
LUAI_FUNC
 
TV®ue
 *
luaH_£Šum
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
key
);

23 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaH_g‘¡r
 (
TabË
 *
t
, 
TSŒšg
 *
key
);

24 
LUAI_FUNC
 
TV®ue
 *
luaH_£t¡r
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
TSŒšg
 *
key
);

25 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaH_g‘
 (
TabË
 *
t
, cÚ¡ TV®u*
key
);

26 
LUAI_FUNC
 
TV®ue
 *
luaH_£t
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ TV®u*
key
);

27 
LUAI_FUNC
 
TabË
 *
luaH_Ãw
 (
lua_S‹
 *
L
, 
Ç¼ay
, 
Êhash
);

28 
LUAI_FUNC
 
luaH_»siz—¼ay
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
Çsize
);

29 
LUAI_FUNC
 
luaH_ä“
 (
lua_S‹
 *
L
, 
TabË
 *
t
);

30 
LUAI_FUNC
 
luaH_Ãxt
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
StkId
 
key
);

31 
LUAI_FUNC
 
luaH_g‘n
 (
TabË
 *
t
);

34 #ià
defšed
(
LUA_DEBUG
)

35 
LUAI_FUNC
 
Node
 *
luaH_mašpos™iÚ
 (cÚ¡ 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
);

36 
LUAI_FUNC
 
luaH_isdummy
 (
Node
 *
n
);

	@deps/lua/src/ltablib.c

8 
	~<¡ddef.h
>

10 
	#Éablib_c


	)

11 
	#LUA_LIB


	)

13 
	~"lua.h
"

15 
	~"Ïuxlib.h
"

16 
	~"lu®ib.h
"

19 
	#aux_g‘n
(
L
,
n
è(
	`luaL_checkty³
(L,‚, 
LUA_TTABLE
), 
	`luaL_g‘n
(L,‚))

	)

22 
	$fÜ—chi
 (
lua_S‹
 *
L
) {

23 
i
;

24 
n
 = 
	`aux_g‘n
(
L
, 1);

25 
	`luaL_checkty³
(
L
, 2, 
LUA_TFUNCTION
);

26 
i
=1; i <ğ
n
; i++) {

27 
	`lua_pushv®ue
(
L
, 2);

28 
	`lua_pushš‹g”
(
L
, 
i
);

29 
	`lua_¿wg‘i
(
L
, 1, 
i
);

30 
	`lua_ÿÎ
(
L
, 2, 1);

31 ià(!
	`lua_i¢
(
L
, -1))

33 
	`lua_pİ
(
L
, 1);

36 
	}
}

39 
	$fÜ—ch
 (
lua_S‹
 *
L
) {

40 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

41 
	`luaL_checkty³
(
L
, 2, 
LUA_TFUNCTION
);

42 
	`lua_pushn
(
L
);

43 
	`lua_Ãxt
(
L
, 1)) {

44 
	`lua_pushv®ue
(
L
, 2);

45 
	`lua_pushv®ue
(
L
, -3);

46 
	`lua_pushv®ue
(
L
, -3);

47 
	`lua_ÿÎ
(
L
, 2, 1);

48 ià(!
	`lua_i¢
(
L
, -1))

50 
	`lua_pİ
(
L
, 2);

53 
	}
}

56 
	$maxn
 (
lua_S‹
 *
L
) {

57 
lua_Numb”
 
max
 = 0;

58 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

59 
	`lua_pushn
(
L
);

60 
	`lua_Ãxt
(
L
, 1)) {

61 
	`lua_pİ
(
L
, 1);

62 ià(
	`lua_ty³
(
L
, -1è=ğ
LUA_TNUMBER
) {

63 
lua_Numb”
 
v
 = 
	`lua_tÚumb”
(
L
, -1);

64 ià(
v
 > 
max
) max = v;

67 
	`lua_pushnumb”
(
L
, 
max
);

69 
	}
}

72 
	$g‘n
 (
lua_S‹
 *
L
) {

73 
	`lua_pushš‹g”
(
L
, 
	`aux_g‘n
(L, 1));

75 
	}
}

78 
	$£Š
 (
lua_S‹
 *
L
) {

79 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

80 #iâdeà
luaL_£Š


81 
	`luaL_£Š
(
L
, 1, 
	`luaL_checkšt
(L, 2));

83 
	`luaL_”rÜ
(
L
, 
	`LUA_QL
("setn") " is obsolete");

85 
	`lua_pushv®ue
(
L
, 1);

87 
	}
}

90 
	$tš£¹
 (
lua_S‹
 *
L
) {

91 
e
 = 
	`aux_g‘n
(
L
, 1) + 1;

92 
pos
;

93 
	`lua_g‘tİ
(
L
)) {

95 
pos
 = 
e
;

99 
i
;

100 
pos
 = 
	`luaL_checkšt
(
L
, 2);

101 ià(
pos
 > 
e
)ƒ =…os;

102 
i
 = 
e
; i > 
pos
; i--) {

103 
	`lua_¿wg‘i
(
L
, 1, 
i
-1);

104 
	`lua_¿w£ti
(
L
, 1, 
i
);

109  
	`luaL_”rÜ
(
L
, "wrÚg‚umb” oà¬gum’t tØ" 
	`LUA_QL
("insert"));

112 
	`luaL_£Š
(
L
, 1, 
e
);

113 
	`lua_¿w£ti
(
L
, 1, 
pos
);

115 
	}
}

118 
	$Œemove
 (
lua_S‹
 *
L
) {

119 
e
 = 
	`aux_g‘n
(
L
, 1);

120 
pos
 = 
	`luaL_İtšt
(
L
, 2, 
e
);

121 ià(!(1 <ğ
pos
 &&…o <ğ
e
))

123 
	`luaL_£Š
(
L
, 1, 
e
 - 1);

124 
	`lua_¿wg‘i
(
L
, 1, 
pos
);

125  ;
pos
<
e
;…os++) {

126 
	`lua_¿wg‘i
(
L
, 1, 
pos
+1);

127 
	`lua_¿w£ti
(
L
, 1, 
pos
);

129 
	`lua_pushn
(
L
);

130 
	`lua_¿w£ti
(
L
, 1, 
e
);

132 
	}
}

135 
	$addf›ld
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
b
, 
i
) {

136 
	`lua_¿wg‘i
(
L
, 1, 
i
);

137 ià(!
	`lua_is¡ršg
(
L
, -1))

138 
	`luaL_”rÜ
(
L
, "invalid value (%s)‡t index %d inable for "

139 
	`LUA_QL
("cÚÿt"), 
	`luaL_ty³Çme
(
L
, -1), 
i
);

140 
	`luaL_addv®ue
(
b
);

141 
	}
}

144 
	$tcÚÿt
 (
lua_S‹
 *
L
) {

145 
luaL_Bufãr
 
b
;

146 
size_t
 
l£p
;

147 
i
, 
Ï¡
;

148 cÚ¡ *
£p
 = 
	`luaL_İ¡ršg
(
L
, 2, "", &
l£p
);

149 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

150 
i
 = 
	`luaL_İtšt
(
L
, 3, 1);

151 
Ï¡
 = 
	`luaL_İt
(
L
, 
luaL_checkšt
, 4, 
	`luaL_g‘n
(L, 1));

152 
	`luaL_buffš™
(
L
, &
b
);

153 ; 
i
 < 
Ï¡
; i++) {

154 
	`addf›ld
(
L
, &
b
, 
i
);

155 
	`luaL_addl¡ršg
(&
b
, 
£p
, 
l£p
);

157 ià(
i
 =ğ
Ï¡
)

158 
	`addf›ld
(
L
, &
b
, 
i
);

159 
	`luaL_push»suÉ
(&
b
);

161 
	}
}

173 
	$£t2
 (
lua_S‹
 *
L
, 
i
, 
j
) {

174 
	`lua_¿w£ti
(
L
, 1, 
i
);

175 
	`lua_¿w£ti
(
L
, 1, 
j
);

176 
	}
}

178 
	$sÜt_comp
 (
lua_S‹
 *
L
, 
a
, 
b
) {

179 ià(!
	`lua_i¢
(
L
, 2)) {

180 
»s
;

181 
	`lua_pushv®ue
(
L
, 2);

182 
	`lua_pushv®ue
(
L
, 
a
-1);

183 
	`lua_pushv®ue
(
L
, 
b
-2);

184 
	`lua_ÿÎ
(
L
, 2, 1);

185 
»s
 = 
	`lua_toboŞ—n
(
L
, -1);

186 
	`lua_pİ
(
L
, 1);

187  
»s
;

190  
	`lua_Ës¡hª
(
L
, 
a
, 
b
);

191 
	}
}

193 
	$auxsÜt
 (
lua_S‹
 *
L
, 
l
, 
u
) {

194 
l
 < 
u
) {

195 
i
, 
j
;

197 
	`lua_¿wg‘i
(
L
, 1, 
l
);

198 
	`lua_¿wg‘i
(
L
, 1, 
u
);

199 ià(
	`sÜt_comp
(
L
, -1, -2))

200 
	`£t2
(
L
, 
l
, 
u
);

202 
	`lua_pİ
(
L
, 2);

203 ià(
u
-
l
 == 1) ;

204 
i
 = (
l
+
u
)/2;

205 
	`lua_¿wg‘i
(
L
, 1, 
i
);

206 
	`lua_¿wg‘i
(
L
, 1, 
l
);

207 ià(
	`sÜt_comp
(
L
, -2, -1))

208 
	`£t2
(
L
, 
i
, 
l
);

210 
	`lua_pİ
(
L
, 1);

211 
	`lua_¿wg‘i
(
L
, 1, 
u
);

212 ià(
	`sÜt_comp
(
L
, -1, -2))

213 
	`£t2
(
L
, 
i
, 
u
);

215 
	`lua_pİ
(
L
, 2);

217 ià(
u
-
l
 == 2) ;

218 
	`lua_¿wg‘i
(
L
, 1, 
i
);

219 
	`lua_pushv®ue
(
L
, -1);

220 
	`lua_¿wg‘i
(
L
, 1, 
u
-1);

221 
	`£t2
(
L
, 
i
, 
u
-1);

223 
i
 = 
l
; 
j
 = 
u
-1;

226 
	`lua_¿wg‘i
(
L
, 1, ++
i
), 
	`sÜt_comp
(L, -1, -2)) {

227 ià(
i
>
u
è
	`luaL_”rÜ
(
L
, "invalid order function for sorting");

228 
	`lua_pİ
(
L
, 1);

231 
	`lua_¿wg‘i
(
L
, 1, --
j
), 
	`sÜt_comp
(L, -3, -1)) {

232 ià(
j
<
l
è
	`luaL_”rÜ
(
L
, "invalid order function for sorting");

233 
	`lua_pİ
(
L
, 1);

235 ià(
j
<
i
) {

236 
	`lua_pİ
(
L
, 3);

239 
	`£t2
(
L
, 
i
, 
j
);

241 
	`lua_¿wg‘i
(
L
, 1, 
u
-1);

242 
	`lua_¿wg‘i
(
L
, 1, 
i
);

243 
	`£t2
(
L
, 
u
-1, 
i
);

246 ià(
i
-
l
 < 
u
-i) {

247 
j
=
l
; 
i
=i-1;†=i+2;

250 
j
=
i
+1; i=
u
; u=j-2;

252 
	`auxsÜt
(
L
, 
j
, 
i
);

254 
	}
}

256 
	$sÜt
 (
lua_S‹
 *
L
) {

257 
n
 = 
	`aux_g‘n
(
L
, 1);

258 
	`luaL_check¡ack
(
L
, 40, "");

259 ià(!
	`lua_i¢ÚeÜn
(
L
, 2))

260 
	`luaL_checkty³
(
L
, 2, 
LUA_TFUNCTION
);

261 
	`lua_£‰İ
(
L
, 2);

262 
	`auxsÜt
(
L
, 1, 
n
);

264 
	}
}

269 cÚ¡ 
luaL_Reg
 
	gb_funcs
[] = {

270 {"cÚÿt", 
tcÚÿt
},

271 {"fÜ—ch", 
fÜ—ch
},

272 {"fÜ—chi", 
fÜ—chi
},

273 {"g‘n", 
g‘n
},

274 {"maxn", 
maxn
},

275 {"š£¹", 
tš£¹
},

276 {"»move", 
Œemove
},

277 {"£Š", 
£Š
},

278 {"sÜt", 
sÜt
},

279 {
NULL
, NULL}

283 
LUALIB_API
 
	$luaİ’_bË
 (
lua_S‹
 *
L
) {

284 
	`luaL_»gi¡”
(
L
, 
LUA_TABLIBNAME
, 
b_funcs
);

286 
	}
}

	@deps/lua/src/ltm.c

8 
	~<¡ršg.h
>

10 
	#Ém_c


	)

11 
	#LUA_CORE


	)

13 
	~"lua.h
"

15 
	~"lobjeù.h
"

16 
	~"l¡©e.h
"

17 
	~"l¡ršg.h
"

18 
	~"ÉabË.h
"

19 
	~"Ém.h
"

23 cÚ¡ *cÚ¡ 
	gluaT_ty³Çmes
[] = {

30 
	$luaT_š™
 (
lua_S‹
 *
L
) {

31 cÚ¡ *cÚ¡ 
luaT_ev’Šame
[] = {

38 
i
;

39 
i
=0; i<
TM_N
; i++) {

40 
	`G
(
L
)->
tmÇme
[
i
] = 
	`luaS_Ãw
(L, 
luaT_ev’Šame
[i]);

41 
	`luaS_fix
(
	`G
(
L
)->
tmÇme
[
i
]);

43 
	}
}

50 cÚ¡ 
TV®ue
 *
	$luaT_g‘tm
 (
TabË
 *
ev’ts
, 
TMS
 
ev’t
, 
TSŒšg
 *
’ame
) {

51 cÚ¡ 
TV®ue
 *
tm
 = 
	`luaH_g‘¡r
(
ev’ts
, 
’ame
);

52 
	`lua_as£¹
(
ev’t
 <ğ
TM_EQ
);

53 ià(
	`‰i¢
(
tm
)) {

54 
ev’ts
->
æags
 |ğ
	`ÿ¡_by‹
(1u<<
ev’t
);

55  
NULL
;

57  
tm
;

58 
	}
}

61 cÚ¡ 
TV®ue
 *
	$luaT_g‘tmbyobj
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
, 
TMS
 
ev’t
) {

62 
TabË
 *
mt
;

63 
	`‰y³
(
o
)) {

64 
LUA_TTABLE
:

65 
mt
 = 
	`hv®ue
(
o
)->
m‘©abË
;

67 
LUA_TUSERDATA
:

68 
mt
 = 
	`uv®ue
(
o
)->
m‘©abË
;

71 
mt
 = 
	`G
(
L
)->mt[
	`‰y³
(
o
)];

73  (
mt
 ? 
	`luaH_g‘¡r
(mt, 
	`G
(
L
)->
tmÇme
[
ev’t
]è: 
luaO_nobjeù
);

74 
	}
}

	@deps/lua/src/ltm.h

7 #iâdeà
Ém_h


8 
	#Ém_h


	)

11 
	~"lobjeù.h
"

19 
	mTM_INDEX
,

20 
	mTM_NEWINDEX
,

21 
	mTM_GC
,

22 
	mTM_MODE
,

23 
	mTM_EQ
,

24 
	mTM_ADD
,

25 
	mTM_SUB
,

26 
	mTM_MUL
,

27 
	mTM_DIV
,

28 
	mTM_MOD
,

29 
	mTM_POW
,

30 
	mTM_UNM
,

31 
	mTM_LEN
,

32 
	mTM_LT
,

33 
	mTM_LE
,

34 
	mTM_CONCAT
,

35 
	mTM_CALL
,

36 
	mTM_N


37 } 
	tTMS
;

41 
	#gç¡tm
(
g
,
‘
,
e
è(Ótè=ğ
NULL
 ? NULL : \

42 ((
‘
)->
æags
 & (1u<<(
e
))è? 
NULL
 : 
	`luaT_g‘tm
Ót,ƒ, (
g
)->
tmÇme
[e]))

	)

44 
	#ç¡tm
(
l
,
‘
,
e
è
	`gç¡tm
(
	`G
Ö),ƒt,ƒ)

	)

46 
LUAI_DATA
 cÚ¡ *cÚ¡ 
	gluaT_ty³Çmes
[];

49 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaT_g‘tm
 (
TabË
 *
ev’ts
, 
TMS
 
ev’t
, 
TSŒšg
 *
’ame
);

50 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaT_g‘tmbyobj
 (
lua_S‹
 *
L
, cÚ¡ TV®u*
o
,

51 
TMS
 
ev’t
);

52 
LUAI_FUNC
 
luaT_š™
 (
lua_S‹
 *
L
);

	@deps/lua/src/lua.c

8 
	~<sigÇl.h
>

9 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

13 
	#lua_c


	)

15 
	~"lua.h
"

17 
	~"Ïuxlib.h
"

18 
	~"lu®ib.h
"

22 
lua_S‹
 *
	gglob®L
 = 
NULL
;

24 cÚ¡ *
	g´ogÇme
 = 
LUA_PROGNAME
;

28 
	$l¡İ
 (
lua_S‹
 *
L
, 
lua_Debug
 *
¬
) {

29 ()
¬
;

30 
	`lua_£thook
(
L
, 
NULL
, 0, 0);

31 
	`luaL_”rÜ
(
L
, "interrupted!");

32 
	}
}

35 
	$ÏùiÚ
 (
i
) {

36 
	`sigÇl
(
i
, 
SIG_DFL
);

38 
	`lua_£thook
(
glob®L
, 
l¡İ
, 
LUA_MASKCALL
 | 
LUA_MASKRET
 | 
LUA_MASKCOUNT
, 1);

39 
	}
}

42 
	$´št_u§ge
 () {

43 
	`årštf
(
¡d”r
,

46 " -¡©ƒxecu‹ sŒšg " 
	`LUA_QL
("stat") "\n"

47 " -ÈÇm„equœlib¿ry " 
	`LUA_QL
("name") "\n"

48 " -˜ƒÁ” iÁ”aùivmodaá”ƒxecutšg " 
	`LUA_QL
("script") "\n"

53 
´ogÇme
);

54 
	`fæush
(
¡d”r
);

55 
	}
}

58 
	$l_mes§ge
 (cÚ¡ *
²ame
, cÚ¡ *
msg
) {

59 ià(
²ame
è
	`årštf
(
¡d”r
, "%s: ",…name);

60 
	`årštf
(
¡d”r
, "%s\n", 
msg
);

61 
	`fæush
(
¡d”r
);

62 
	}
}

65 
	$»pÜt
 (
lua_S‹
 *
L
, 
¡©us
) {

66 ià(
¡©us
 && !
	`lua_i¢
(
L
, -1)) {

67 cÚ¡ *
msg
 = 
	`lua_to¡ršg
(
L
, -1);

68 ià(
msg
 =ğ
NULL
) msg = "(error object is‚ot‡ string)";

69 
	`l_mes§ge
(
´ogÇme
, 
msg
);

70 
	`lua_pİ
(
L
, 1);

72  
¡©us
;

73 
	}
}

76 
	$Œaûback
 (
lua_S‹
 *
L
) {

77 ià(!
	`lua_is¡ršg
(
L
, 1))

79 
	`lua_g‘f›ld
(
L
, 
LUA_GLOBALSINDEX
, "debug");

80 ià(!
	`lua_i¡abË
(
L
, -1)) {

81 
	`lua_pİ
(
L
, 1);

84 
	`lua_g‘f›ld
(
L
, -1, "traceback");

85 ià(!
	`lua_isfunùiÚ
(
L
, -1)) {

86 
	`lua_pİ
(
L
, 2);

89 
	`lua_pushv®ue
(
L
, 1);

90 
	`lua_pushš‹g”
(
L
, 2);

91 
	`lua_ÿÎ
(
L
, 2, 1);

93 
	}
}

96 
	$doÿÎ
 (
lua_S‹
 *
L
, 
Çrg
, 
ş—r
) {

97 
¡©us
;

98 
ba£
 = 
	`lua_g‘tİ
(
L
è- 
Çrg
;

99 
	`lua_pushcfunùiÚ
(
L
, 
Œaûback
);

100 
	`lua_š£¹
(
L
, 
ba£
);

101 
	`sigÇl
(
SIGINT
, 
ÏùiÚ
);

102 
¡©us
 = 
	`lua_pÿÎ
(
L
, 
Çrg
, (
ş—r
 ? 0 : 
LUA_MULTRET
), 
ba£
);

103 
	`sigÇl
(
SIGINT
, 
SIG_DFL
);

104 
	`lua_»move
(
L
, 
ba£
);

106 ià(
¡©us
 !ğ0è
	`lua_gc
(
L
, 
LUA_GCCOLLECT
, 0);

107  
¡©us
;

108 
	}
}

111 
	$´št_v”siÚ
 () {

112 
	`l_mes§ge
(
NULL
, 
LUA_RELEASE
 " " 
LUA_COPYRIGHT
);

113 
	}
}

116 
	$g‘¬gs
 (
lua_S‹
 *
L
, **
¬gv
, 
n
) {

117 
Çrg
;

118 
i
;

119 
¬gc
 = 0;

120 
¬gv
[
¬gc
])‡rgc++;

121 
Çrg
 = 
¬gc
 - (
n
 + 1);

122 
	`luaL_check¡ack
(
L
, 
Çrg
 + 3, "too many‡rgumentso script");

123 
i
=
n
+1; i < 
¬gc
; i++)

124 
	`lua_push¡ršg
(
L
, 
¬gv
[
i
]);

125 
	`lua_ü—‹bË
(
L
, 
Çrg
, 
n
 + 1);

126 
i
=0; i < 
¬gc
; i++) {

127 
	`lua_push¡ršg
(
L
, 
¬gv
[
i
]);

128 
	`lua_¿w£ti
(
L
, -2, 
i
 - 
n
);

130  
Çrg
;

131 
	}
}

134 
	$dofe
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

135 
¡©us
 = 
	`luaL_lßdfe
(
L
, 
Çme
è|| 
	`doÿÎ
(L, 0, 1);

136  
	`»pÜt
(
L
, 
¡©us
);

137 
	}
}

140 
	$do¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
s
, cÚ¡ *
Çme
) {

141 
¡©us
 = 
	`luaL_lßdbufãr
(
L
, 
s
, 
	`¡¾’
(s), 
Çme
è|| 
	`doÿÎ
(L, 0, 1);

142  
	`»pÜt
(
L
, 
¡©us
);

143 
	}
}

146 
	$dŞib¿ry
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

147 
	`lua_g‘glob®
(
L
, "require");

148 
	`lua_push¡ršg
(
L
, 
Çme
);

149  
	`»pÜt
(
L
, 
	`doÿÎ
(L, 1, 1));

150 
	}
}

153 cÚ¡ *
	$g‘_´om±
 (
lua_S‹
 *
L
, 
fœ¡lše
) {

154 cÚ¡ *
p
;

155 
	`lua_g‘f›ld
(
L
, 
LUA_GLOBALSINDEX
, 
fœ¡lše
 ? "_PROMPT" : "_PROMPT2");

156 
p
 = 
	`lua_to¡ršg
(
L
, -1);

157 ià(
p
 =ğ
NULL
è°ğ(
fœ¡lše
 ? 
LUA_PROMPT
 : 
LUA_PROMPT2
);

158 
	`lua_pİ
(
L
, 1);

159  
p
;

160 
	}
}

163 
	$šcom¶‘e
 (
lua_S‹
 *
L
, 
¡©us
) {

164 ià(
¡©us
 =ğ
LUA_ERRSYNTAX
) {

165 
size_t
 
lmsg
;

166 cÚ¡ *
msg
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
lmsg
);

167 cÚ¡ *

 = 
msg
 + 
lmsg
 - ((
	`LUA_QL
("<eof>")) - 1);

168 ià(
	`¡r¡r
(
msg
, 
	`LUA_QL
("<eof>")è=ğ

) {

169 
	`lua_pİ
(
L
, 1);

174 
	}
}

177 
	$pushlše
 (
lua_S‹
 *
L
, 
fœ¡lše
) {

178 
bufãr
[
LUA_MAXINPUT
];

179 *
b
 = 
bufãr
;

180 
size_t
 
l
;

181 cÚ¡ *
´mt
 = 
	`g‘_´om±
(
L
, 
fœ¡lše
);

182 ià(
	`lua_»adlše
(
L
, 
b
, 
´mt
) == 0)

184 
l
 = 
	`¡¾’
(
b
);

185 ià(
l
 > 0 && 
b
[l-1] == '\n')

186 
b
[
l
-1] = '\0';

187 ià(
fœ¡lše
 && 
b
[0] == '=')

188 
	`lua_pushf¡ršg
(
L
, "»tuº %s", 
b
+1);

190 
	`lua_push¡ršg
(
L
, 
b
);

191 
	`lua_ä“lše
(
L
, 
b
);

193 
	}
}

196 
	$lßdlše
 (
lua_S‹
 *
L
) {

197 
¡©us
;

198 
	`lua_£‰İ
(
L
, 0);

199 ià(!
	`pushlše
(
L
, 1))

202 
¡©us
 = 
	`luaL_lßdbufãr
(
L
, 
	`lua_to¡ršg
(L, 1), 
	`lua_¡¾’
(L, 1), "=stdin");

203 ià(!
	`šcom¶‘e
(
L
, 
¡©us
)) ;

204 ià(!
	`pushlše
(
L
, 0))

206 
	`lua_pushl™”®
(
L
, "\n");

207 
	`lua_š£¹
(
L
, -2);

208 
	`lua_cÚÿt
(
L
, 3);

210 
	`lua_§v–še
(
L
, 1);

211 
	`lua_»move
(
L
, 1);

212  
¡©us
;

213 
	}
}

216 
	$dÙty
 (
lua_S‹
 *
L
) {

217 
¡©us
;

218 cÚ¡ *
Şd´ogÇme
 = 
´ogÇme
;

219 
´ogÇme
 = 
NULL
;

220 (
¡©us
 = 
	`lßdlše
(
L
)) != -1) {

221 ià(
¡©us
 =ğ0è¡©u ğ
	`doÿÎ
(
L
, 0, 0);

222 
	`»pÜt
(
L
, 
¡©us
);

223 ià(
¡©us
 =ğ0 && 
	`lua_g‘tİ
(
L
) > 0) {

224 
	`lua_g‘glob®
(
L
, "print");

225 
	`lua_š£¹
(
L
, 1);

226 ià(
	`lua_pÿÎ
(
L
, 
	`lua_g‘tİ
(L)-1, 0, 0) != 0)

227 
	`l_mes§ge
(
´ogÇme
, 
	`lua_pushf¡ršg
(
L
,

228 "”rÜ c®lšg " 
	`LUA_QL
("print") " (%s)",

229 
	`lua_to¡ršg
(
L
, -1)));

232 
	`lua_£‰İ
(
L
, 0);

233 
	`åuts
("\n", 
¡dout
);

234 
	`fæush
(
¡dout
);

235 
´ogÇme
 = 
Şd´ogÇme
;

236 
	}
}

239 
	$hªdË_süt
 (
lua_S‹
 *
L
, **
¬gv
, 
n
) {

240 
¡©us
;

241 cÚ¡ *
âame
;

242 
Çrg
 = 
	`g‘¬gs
(
L
, 
¬gv
, 
n
);

243 
	`lua_£tglob®
(
L
, "arg");

244 
âame
 = 
¬gv
[
n
];

245 ià(
	`¡rcmp
(
âame
, "-"è=ğ0 && sŒcmp(
¬gv
[
n
-1], "--") != 0)

246 
âame
 = 
NULL
;

247 
¡©us
 = 
	`luaL_lßdfe
(
L
, 
âame
);

248 
	`lua_š£¹
(
L
, -(
Çrg
+1));

249 ià(
¡©us
 == 0)

250 
¡©us
 = 
	`doÿÎ
(
L
, 
Çrg
, 0);

252 
	`lua_pİ
(
L
, 
Çrg
);

253  
	`»pÜt
(
L
, 
¡©us
);

254 
	}
}

258 
	#nÙa
(
x
è{ià((x)[2] !ğ'\0'è -1;}

	)

261 
	$cŞËù¬gs
 (**
¬gv
, *
pi
, *
pv
, *
³
) {

262 
i
;

263 
i
 = 1; 
¬gv
[i] !ğ
NULL
; i++) {

264 ià(
¬gv
[
i
][0] != '-')

265  
i
;

266 
¬gv
[
i
][1]) {

268 
	`nÙa
(
¬gv
[
i
]);

269  (
¬gv
[
i
+1] !ğ
NULL
 ? i+1 : 0);

271  
i
;

273 
	`nÙa
(
¬gv
[
i
]);

274 *
pi
 = 1;

276 
	`nÙa
(
¬gv
[
i
]);

277 *
pv
 = 1;

280 *
³
 = 1;

282 ià(
¬gv
[
i
][2] == '\0') {

283 
i
++;

284 ià(
¬gv
[
i
] =ğ
NULL
)  -1;

291 
	}
}

294 
	$ruÇrgs
 (
lua_S‹
 *
L
, **
¬gv
, 
n
) {

295 
i
;

296 
i
 = 1; i < 
n
; i++) {

297 ià(
¬gv
[
i
] =ğ
NULL
) ;

298 
	`lua_as£¹
(
¬gv
[
i
][0] == '-');

299 
¬gv
[
i
][1]) {

301 cÚ¡ *
chunk
 = 
¬gv
[
i
] + 2;

302 ià(*
chunk
 =ğ'\0'èchunk = 
¬gv
[++
i
];

303 
	`lua_as£¹
(
chunk
 !ğ
NULL
);

304 ià(
	`do¡ršg
(
L
, 
chunk
, "=(command†ine)") != 0)

309 cÚ¡ *
f’ame
 = 
¬gv
[
i
] + 2;

310 ià(*
f’ame
 =ğ'\0'èf’amğ
¬gv
[++
i
];

311 
	`lua_as£¹
(
f’ame
 !ğ
NULL
);

312 ià(
	`dŞib¿ry
(
L
, 
f’ame
))

320 
	}
}

323 
	$hªdË_luaš™
 (
lua_S‹
 *
L
) {

324 cÚ¡ *
š™
 = 
	`g‘’v
(
LUA_INIT
);

325 ià(
š™
 =ğ
NULL
)  0;

326 ià(
š™
[0] == '@')

327  
	`dofe
(
L
, 
š™
+1);

329  
	`do¡ršg
(
L
, 
š™
, "=" 
LUA_INIT
);

330 
	}
}

333 
	sSmaš
 {

334 
	m¬gc
;

335 **
	m¬gv
;

336 
	m¡©us
;

340 
	$pmaš
 (
lua_S‹
 *
L
) {

341 
Smaš
 *
s
 = (Smaš *)
	`lua_tou£rd©a
(
L
, 1);

342 **
¬gv
 = 
s
->argv;

343 
süt
;

344 
has_i
 = 0, 
has_v
 = 0, 
has_e
 = 0;

345 
glob®L
 = 
L
;

346 ià(
¬gv
[0] &&‡rgv[0][0]è
´ogÇme
 =‡rgv[0];

347 
	`lua_gc
(
L
, 
LUA_GCSTOP
, 0);

348 
	`luaL_İ’libs
(
L
);

349 
	`lua_gc
(
L
, 
LUA_GCRESTART
, 0);

350 
s
->
¡©us
 = 
	`hªdË_luaš™
(
L
);

351 ià(
s
->
¡©us
 != 0)  0;

352 
süt
 = 
	`cŞËù¬gs
(
¬gv
, &
has_i
, &
has_v
, &
has_e
);

353 ià(
süt
 < 0) {

354 
	`´št_u§ge
();

355 
s
->
¡©us
 = 1;

358 ià(
has_v
è
	`´št_v”siÚ
();

359 
s
->
¡©us
 = 
	`ruÇrgs
(
L
, 
¬gv
, (
süt
 > 0è? süˆ: s->
¬gc
);

360 ià(
s
->
¡©us
 != 0)  0;

361 ià(
süt
)

362 
s
->
¡©us
 = 
	`hªdË_süt
(
L
, 
¬gv
, 
süt
);

363 ià(
s
->
¡©us
 != 0)  0;

364 ià(
has_i
)

365 
	`dÙty
(
L
);

366 ià(
süt
 =ğ0 && !
has_e
 && !
has_v
) {

367 ià(
	`lua_¡dš_is_‰y
()) {

368 
	`´št_v”siÚ
();

369 
	`dÙty
(
L
);

371 
	`dofe
(
L
, 
NULL
);

374 
	}
}

377 
	$maš
 (
¬gc
, **
¬gv
) {

378 
¡©us
;

379 
Smaš
 
s
;

380 
lua_S‹
 *
L
 = 
	`lua_İ’
();

381 ià(
L
 =ğ
NULL
) {

382 
	`l_mes§ge
(
¬gv
[0], "cannot create state:‚otƒnough memory");

383  
EXIT_FAILURE
;

385 
s
.
¬gc
 =‡rgc;

386 
s
.
¬gv
 =‡rgv;

387 
¡©us
 = 
	`lua_ıÿÎ
(
L
, &
pmaš
, &
s
);

388 
	`»pÜt
(
L
, 
¡©us
);

389 
	`lua_şo£
(
L
);

390  (
¡©us
 || 
s
.¡©usè? 
EXIT_FAILURE
 : 
EXIT_SUCCESS
;

391 
	}
}

	@deps/lua/src/lua.h

9 #iâdeà
lua_h


10 
	#lua_h


	)

12 
	~<¡d¬g.h
>

13 
	~<¡ddef.h
>

16 
	~"luacÚf.h
"

19 
	#LUA_VERSION
 "Lu¨5.1"

	)

20 
	#LUA_RELEASE
 "Lu¨5.1.5"

	)

21 
	#LUA_VERSION_NUM
 501

	)

22 
	#LUA_COPYRIGHT
 "Cİyrighˆ(Cè1994-2012 Lua.Üg, PUC-Rio"

	)

23 
	#LUA_AUTHORS
 "R. I”u§limschy, L. H. dFigueœedØ& W. C–es"

	)

27 
	#LUA_SIGNATURE
 "\033Lua"

	)

30 
	#LUA_MULTRET
 (-1)

	)

36 
	#LUA_REGISTRYINDEX
 (-10000)

	)

37 
	#LUA_ENVIRONINDEX
 (-10001)

	)

38 
	#LUA_GLOBALSINDEX
 (-10002)

	)

39 
	#lua_upv®uešdex
(
i
è(
LUA_GLOBALSINDEX
-(i))

	)

43 
	#LUA_YIELD
 1

	)

44 
	#LUA_ERRRUN
 2

	)

45 
	#LUA_ERRSYNTAX
 3

	)

46 
	#LUA_ERRMEM
 4

	)

47 
	#LUA_ERRERR
 5

	)

50 
lua_S‹
 
	tlua_S‹
;

52 (*
	tlua_CFunùiÚ
è(
	tlua_S‹
 *
	tL
);

58 cÚ¡ * (*
	tlua_R—d”
è(
	tlua_S‹
 *
	tL
, *
	tud
, 
	tsize_t
 *
	tsz
);

60 (*
	tlua_Wr™”
è(
	tlua_S‹
 *
	tL
, cÚ¡ * 
	tp
, 
	tsize_t
 
	tsz
, * 
	tud
);

66 * (*
	tlua_AÎoc
è(*
	tud
, *
	t±r
, 
	tsize_t
 
	tosize
, size_ˆ
	tnsize
);

72 
	#LUA_TNONE
 (-1)

	)

74 
	#LUA_TNIL
 0

	)

75 
	#LUA_TBOOLEAN
 1

	)

76 
	#LUA_TLIGHTUSERDATA
 2

	)

77 
	#LUA_TNUMBER
 3

	)

78 
	#LUA_TSTRING
 4

	)

79 
	#LUA_TTABLE
 5

	)

80 
	#LUA_TFUNCTION
 6

	)

81 
	#LUA_TUSERDATA
 7

	)

82 
	#LUA_TTHREAD
 8

	)

87 
	#LUA_MINSTACK
 20

	)

93 #ià
	`defšed
(
LUA_USER_H
)

94 #šşud
LUA_USER_H


99 
LUA_NUMBER
 
	tlua_Numb”
;

103 
LUA_INTEGER
 
	tlua_IÁeg”
;

110 
LUA_API
 
lua_S‹
 *(
lua_Ãw¡©e
è(
lua_AÎoc
 
f
, *
ud
);

111 
LUA_API
 (
lua_şo£
è(
lua_S‹
 *
L
);

112 
LUA_API
 
lua_S‹
 *(
lua_Ãwth»ad
èÖua_S‹ *
L
);

114 
LUA_API
 
	$lua_CFunùiÚ
 (
lua_©·nic
è(
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
·nicf
);

120 
LUA_API
 (
lua_g‘tİ
è(
lua_S‹
 *
L
);

121 
LUA_API
 (
lua_£‰İ
è(
lua_S‹
 *
L
, 
idx
);

122 
LUA_API
 (
lua_pushv®ue
è(
lua_S‹
 *
L
, 
idx
);

123 
LUA_API
 (
lua_»move
è(
lua_S‹
 *
L
, 
idx
);

124 
LUA_API
 (
lua_š£¹
è(
lua_S‹
 *
L
, 
idx
);

125 
LUA_API
 (
lua_»¶aû
è(
lua_S‹
 *
L
, 
idx
);

126 
LUA_API
 (
lua_check¡ack
è(
lua_S‹
 *
L
, 
sz
);

128 
LUA_API
 (
lua_xmove
è(
lua_S‹
 *
äom
,†ua_S‹ *
to
, 
n
);

135 
LUA_API
 (
lua_i¢umb”
è(
lua_S‹
 *
L
, 
idx
);

136 
LUA_API
 (
lua_is¡ršg
è(
lua_S‹
 *
L
, 
idx
);

137 
LUA_API
 (
lua_iscfunùiÚ
è(
lua_S‹
 *
L
, 
idx
);

138 
LUA_API
 (
lua_isu£rd©a
è(
lua_S‹
 *
L
, 
idx
);

139 
LUA_API
 (
lua_ty³
è(
lua_S‹
 *
L
, 
idx
);

140 
LUA_API
 cÚ¡ *(
lua_ty³Çme
è(
lua_S‹
 *
L
, 

);

142 
LUA_API
 (
lua_equ®
è(
lua_S‹
 *
L
, 
idx1
, 
idx2
);

143 
LUA_API
 (
lua_¿wequ®
è(
lua_S‹
 *
L
, 
idx1
, 
idx2
);

144 
LUA_API
 (
lua_Ës¡hª
è(
lua_S‹
 *
L
, 
idx1
, 
idx2
);

146 
LUA_API
 
	$lua_Numb”
 (
lua_tÚumb”
è(
lua_S‹
 *
L
, 
idx
);

147 
LUA_API
 
	$lua_IÁeg”
 (
lua_toš‹g”
è(
lua_S‹
 *
L
, 
idx
);

148 
LUA_API
 (
lua_toboŞ—n
è(
lua_S‹
 *
L
, 
idx
);

149 
LUA_API
 cÚ¡ *(
lua_tŞ¡ršg
è(
lua_S‹
 *
L
, 
idx
, 
size_t
 *
Ën
);

150 
LUA_API
 
	$size_t
 (
lua_objËn
è(
lua_S‹
 *
L
, 
idx
);

151 
LUA_API
 
	$lua_CFunùiÚ
 (
lua_tocfunùiÚ
è(
lua_S‹
 *
L
, 
idx
);

152 
LUA_API
 *(
lua_tou£rd©a
è(
lua_S‹
 *
L
, 
idx
);

153 
LUA_API
 
lua_S‹
 *(
lua_tÙh»ad
èÖua_S‹ *
L
, 
idx
);

154 
LUA_API
 cÚ¡ *(
lua_tİoš‹r
è(
lua_S‹
 *
L
, 
idx
);

160 
LUA_API
 (
lua_pushn
è(
lua_S‹
 *
L
);

161 
LUA_API
 (
lua_pushnumb”
è(
lua_S‹
 *
L
, 
lua_Numb”
 
n
);

162 
LUA_API
 (
lua_pushš‹g”
è(
lua_S‹
 *
L
, 
lua_IÁeg”
 
n
);

163 
LUA_API
 (
lua_pushl¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
s
, 
size_t
 
l
);

164 
LUA_API
 (
lua_push¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
s
);

165 
LUA_API
 cÚ¡ *(
lua_pushvf¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
fmt
,

166 
va_li¡
 
¬gp
);

167 
LUA_API
 cÚ¡ *(
lua_pushf¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

168 
LUA_API
 (
lua_pushcşosu»
è(
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
â
, 
n
);

169 
LUA_API
 (
lua_pushboŞ—n
è(
lua_S‹
 *
L
, 
b
);

170 
LUA_API
 (
lua_pushlightu£rd©a
è(
lua_S‹
 *
L
, *
p
);

171 
LUA_API
 (
lua_pushth»ad
è(
lua_S‹
 *
L
);

177 
LUA_API
 (
lua_g‘bË
è(
lua_S‹
 *
L
, 
idx
);

178 
LUA_API
 (
lua_g‘f›ld
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
);

179 
LUA_API
 (
lua_¿wg‘
è(
lua_S‹
 *
L
, 
idx
);

180 
LUA_API
 (
lua_¿wg‘i
è(
lua_S‹
 *
L
, 
idx
, 
n
);

181 
LUA_API
 (
lua_ü—‹bË
è(
lua_S‹
 *
L
, 
Ç¼
, 
Äec
);

182 
LUA_API
 *(
lua_Ãwu£rd©a
è(
lua_S‹
 *
L
, 
size_t
 
sz
);

183 
LUA_API
 (
lua_g‘m‘©abË
è(
lua_S‹
 *
L
, 
objšdex
);

184 
LUA_API
 (
lua_g‘ãnv
è(
lua_S‹
 *
L
, 
idx
);

190 
LUA_API
 (
lua_£‰abË
è(
lua_S‹
 *
L
, 
idx
);

191 
LUA_API
 (
lua_£tf›ld
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
);

192 
LUA_API
 (
lua_¿w£t
è(
lua_S‹
 *
L
, 
idx
);

193 
LUA_API
 (
lua_¿w£ti
è(
lua_S‹
 *
L
, 
idx
, 
n
);

194 
LUA_API
 (
lua_£tm‘©abË
è(
lua_S‹
 *
L
, 
objšdex
);

195 
LUA_API
 (
lua_£tãnv
è(
lua_S‹
 *
L
, 
idx
);

201 
LUA_API
 (
lua_ÿÎ
è(
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
);

202 
LUA_API
 (
lua_pÿÎ
è(
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
, 
”rfunc
);

203 
LUA_API
 (
lua_ıÿÎ
è(
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
func
, *
ud
);

204 
LUA_API
 (
lua_lßd
è(
lua_S‹
 *
L
, 
lua_R—d”
 
»ad”
, *
dt
,

205 cÚ¡ *
chunkÇme
);

207 
LUA_API
 (
lua_dump
è(
lua_S‹
 *
L
, 
lua_Wr™”
 
wr™”
, *
d©a
);

213 
LUA_API
 (
lua_y›ld
è(
lua_S‹
 *
L
, 
ÄesuÉs
);

214 
LUA_API
 (
lua_»sume
è(
lua_S‹
 *
L
, 
Çrg
);

215 
LUA_API
 (
lua_¡©us
è(
lua_S‹
 *
L
);

221 
	#LUA_GCSTOP
 0

	)

222 
	#LUA_GCRESTART
 1

	)

223 
	#LUA_GCCOLLECT
 2

	)

224 
	#LUA_GCCOUNT
 3

	)

225 
	#LUA_GCCOUNTB
 4

	)

226 
	#LUA_GCSTEP
 5

	)

227 
	#LUA_GCSETPAUSE
 6

	)

228 
	#LUA_GCSETSTEPMUL
 7

	)

230 
LUA_API
 (
lua_gc
è(
lua_S‹
 *
L
, 
wh©
, 
d©a
);

237 
LUA_API
 (
lua_”rÜ
è(
lua_S‹
 *
L
);

239 
LUA_API
 (
lua_Ãxt
è(
lua_S‹
 *
L
, 
idx
);

241 
LUA_API
 (
lua_cÚÿt
è(
lua_S‹
 *
L
, 
n
);

243 
LUA_API
 
	$lua_AÎoc
 (
lua_g‘®locf
è(
lua_S‹
 *
L
, **
ud
);

244 
LUA_API
 
	`lua_£Îocf
 (
lua_S‹
 *
L
, 
lua_AÎoc
 
f
, *
ud
);

254 
	#lua_pİ
(
L
,
n
è
	`lua_£‰İ
(L, -Ò)-1)

	)

256 
	#lua_ÃwbË
(
L
è
	`lua_ü—‹bË
(L, 0, 0)

	)

258 
	#lua_»gi¡”
(
L
,
n
,
f
è(
	`lua_pushcfunùiÚ
(L, (f)), 
	`lua_£tglob®
(L, (n)))

	)

260 
	#lua_pushcfunùiÚ
(
L
,
f
è
	`lua_pushcşosu»
(L, (f), 0)

	)

262 
	#lua_¡¾’
(
L
,
i
è
	`lua_objËn
(L, (i))

	)

264 
	#lua_isfunùiÚ
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TFUNCTION
)

	)

265 
	#lua_i¡abË
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TTABLE
)

	)

266 
	#lua_i¦ightu£rd©a
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TLIGHTUSERDATA
)

	)

267 
	#lua_i¢
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TNIL
)

	)

268 
	#lua_isboŞ—n
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TBOOLEAN
)

	)

269 
	#lua_i¡h»ad
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TTHREAD
)

	)

270 
	#lua_i¢Úe
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TNONE
)

	)

271 
	#lua_i¢ÚeÜn
(
L
, 
n
è(
	`lua_ty³
(L, (n)è<ğ0)

	)

273 
	#lua_pushl™”®
(
L
, 
s
) \

274 
	`lua_pushl¡ršg
(
L
, "" 
s
, ((s)/())-1)

	)

276 
	#lua_£tglob®
(
L
,
s
è
	`lua_£tf›ld
(L, 
LUA_GLOBALSINDEX
, (s))

	)

277 
	#lua_g‘glob®
(
L
,
s
è
	`lua_g‘f›ld
(L, 
LUA_GLOBALSINDEX
, (s))

	)

279 
	#lua_to¡ršg
(
L
,
i
è
	`lua_tŞ¡ršg
(L, (i), 
NULL
)

	)

287 
	#lua_İ’
(è
	`luaL_Ãw¡©e
()

	)

289 
	#lua_g‘»gi¡ry
(
L
è
	`lua_pushv®ue
(L, 
LUA_REGISTRYINDEX
)

	)

291 
	#lua_g‘gccouÁ
(
L
è
	`lua_gc
(L, 
LUA_GCCOUNT
, 0)

	)

293 
	#lua_Chunk»ad”
 
lua_R—d”


	)

294 
	#lua_Chunkwr™”
 
lua_Wr™”


	)

298 
LUA_API
 
	`lua_£ev–
 (
lua_S‹
 *
äom
,†ua_S‹ *
to
);

311 
	#LUA_HOOKCALL
 0

	)

312 
	#LUA_HOOKRET
 1

	)

313 
	#LUA_HOOKLINE
 2

	)

314 
	#LUA_HOOKCOUNT
 3

	)

315 
	#LUA_HOOKTAILRET
 4

	)

321 
	#LUA_MASKCALL
 (1 << 
LUA_HOOKCALL
)

	)

322 
	#LUA_MASKRET
 (1 << 
LUA_HOOKRET
)

	)

323 
	#LUA_MASKLINE
 (1 << 
LUA_HOOKLINE
)

	)

324 
	#LUA_MASKCOUNT
 (1 << 
LUA_HOOKCOUNT
)

	)

326 
lua_Debug
 
	tlua_Debug
;

330 (*
	tlua_Hook
è(
	tlua_S‹
 *
	tL
, 
	tlua_Debug
 *
	t¬
);

333 
LUA_API
 
	`lua_g‘¡ack
 (
lua_S‹
 *
L
, 
Ëv–
, 
lua_Debug
 *
¬
);

334 
LUA_API
 
	`lua_g‘šfo
 (
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
lua_Debug
 *
¬
);

335 
LUA_API
 cÚ¡ *
	`lua_g‘loÿl
 (
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
);

336 
LUA_API
 cÚ¡ *
	`lua_£oÿl
 (
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
);

337 
LUA_API
 cÚ¡ *
	`lua_g‘upv®ue
 (
lua_S‹
 *
L
, 
funcšdex
, 
n
);

338 
LUA_API
 cÚ¡ *
	`lua_£tupv®ue
 (
lua_S‹
 *
L
, 
funcšdex
, 
n
);

340 
LUA_API
 
	`lua_£thook
 (
lua_S‹
 *
L
, 
lua_Hook
 
func
, 
mask
, 
couÁ
);

341 
LUA_API
 
lua_Hook
 
	`lua_g‘hook
 (
lua_S‹
 *
L
);

342 
LUA_API
 
	`lua_g‘hookmask
 (
lua_S‹
 *
L
);

343 
LUA_API
 
	`lua_g‘hookcouÁ
 (
lua_S‹
 *
L
);

346 
	slua_Debug
 {

347 
ev’t
;

348 cÚ¡ *
Çme
;

349 cÚ¡ *
Çmewh©
;

350 cÚ¡ *
wh©
;

351 cÚ¡ *
sourû
;

352 
cu¼’še
;

353 
nups
;

354 
lšedefšed
;

355 
Ï¡lšedefšed
;

356 
shÜt_¤c
[
LUA_IDSIZE
];

358 
i_ci
;

	@deps/lua/src/lua_bit.c

29 
	#LUA_BITOP_VERSION
 "1.0.2"

	)

31 
	#LUA_LIB


	)

32 
	~"lua.h
"

33 
	~"Ïuxlib.h
"

35 #ifdeà
_MSC_VER


37 
__št32
 
	tšt32_t
;

38 
	t__št32
 
	tušt32_t
;

39 
	t__št64
 
	tušt64_t
;

41 
	~<¡dšt.h
>

44 
št32_t
 
	tSB™s
;

45 
ušt32_t
 
	tUB™s
;

48 
lua_Numb”
 
	mn
;

49 #ifdeà
LUA_NUMBER_DOUBLE


50 
ušt64_t
 
	mb
;

52 
UB™s
 
	mb
;

54 } 
	tB™Num
;

57 
UB™s
 
	$b¬g
(
lua_S‹
 *
L
, 
idx
)

59 
B™Num
 
bn
;

60 
UB™s
 
b
;

61 #ià
LUA_VERSION_NUM
 < 502

62 
bn
.
n
 = 
	`lua_tÚumb”
(
L
, 
idx
);

64 
bn
.
n
 = 
	`luaL_checknumb”
(
L
, 
idx
);

66 #ià
	`defšed
(
LUA_NUMBER_DOUBLE
)

67 
bn
.
n
 += 6755399441055744.0;

68 #ifdeà
SWAPPED_DOUBLE


69 
b
 = (
UB™s
)(
bn
.b >> 32);

71 
b
 = (
UB™s
)
bn
.b;

73 #–ià
	`defšed
(
LUA_NUMBER_INT
è|| defšed(
LUA_NUMBER_LONG
) || \

74 
	`defšed
(
LUA_NUMBER_LONGLONG
è|| defšed(
LUA_NUMBER_LONG_LONG
) || \

75 
	`defšed
(
LUA_NUMBER_LLONG
)

76 ià((
UB™s
è=ğ(
lua_Numb”
))

77 
b
 = 
bn
.b;

79 
b
 = (
UB™s
)(
SB™s
)
bn
.
n
;

80 #–ià
	`defšed
(
LUA_NUMBER_FLOAT
)

85 #ià
LUA_VERSION_NUM
 < 502

86 ià(
b
 =ğ0 && !
	`lua_i¢umb”
(
L
, 
idx
)) {

87 
	`luaL_ty³¼Ü
(
L
, 
idx
, "number");

90  
b
;

91 
	}
}

94 
	#BRET
(
b
è
	`lua_pushnumb”
(
L
, (
lua_Numb”
)(
SB™s
)(b));  1;

	)

96 
	$b™_tob™
(
lua_S‹
 *
L
è{ 
	`BRET
(
	`b¬g
(L, 1)è
	}
}

97 
	$b™_bnÙ
(
lua_S‹
 *
L
è{ 
	`BRET
(~
	`b¬g
(L, 1)è
	}
}

99 
	#BIT_OP
(
func
, 
İr
) \

100 
	`func
(
lua_S‹
 *
L
è{ 
i
; 
UB™s
 
b
 = 
	`b¬g
(L, 1); \

101 
i
 = 
	`lua_g‘tİ
(
L
); i > 1; i--è
b
 
İr
 
	`b¬g
(L, i); 
	`BRET
(bè}

	)

102 
	$BIT_OP
(
b™_bªd
, &=)

103 
	`BIT_OP
(
b™_bÜ
, |=)

104 
	`BIT_OP
(
b™_bxÜ
, ^=)

106 
	#bshl
(
b
, 
n
è(b <<‚)

	)

107 
	#bshr
(
b
, 
n
è(b >>‚)

	)

108 
	#b§r
(
b
, 
n
è((
SB™s
)b >>‚)

	)

109 
	#brŞ
(
b
, 
n
è((b <<‚è| (b >> (32-n)))

	)

110 
	#brÜ
(
b
, 
n
è((b << (32-n)è| (b >>‚))

	)

111 
	#BIT_SH
(
func
, 
â
) \

112 
	`func
(
lua_S‹
 *
L
) { \

113 
UB™s
 
b
 = 
	`b¬g
(
L
, 1); UB™ 
n
 = b¬g(L, 2è& 31; 
	`BRET
(
	`â
(b,‚)è
	}

	)
}

114 
	$BIT_SH
(
b™_lshiá
, 
bshl
)

115 
	$BIT_SH
(
b™_rshiá
, 
bshr
)

116 
	$BIT_SH
(
b™_¬shiá
, 
b§r
)

117 
	$BIT_SH
(
b™_rŞ
, 
brŞ
)

118 
	$BIT_SH
(
b™_rÜ
, 
brÜ
)

120 
	$b™_bsw­
(
lua_S‹
 *
L
)

122 
UB™s
 
b
 = 
	`b¬g
(
L
, 1);

123 
b
 = (b >> 24) | ((b >> 8) & 0xff00) | ((b & 0xff00) << 8) | (b << 24);

124 
	`BRET
(
b
)

125 
	}
}

127 
	$b™_tohex
(
lua_S‹
 *
L
)

129 
UB™s
 
b
 = 
	`b¬g
(
L
, 1);

130 
SB™s
 
n
 = 
	`lua_i¢Úe
(
L
, 2è? 8 : (SB™s)
	`b¬g
(L, 2);

131 cÚ¡ *
hexdig™s
 = "0123456789abcdef";

132 
buf
[8];

133 
i
;

134 ià(
n
 < 0è{‚ = -n; 
hexdig™s
 = "0123456789ABCDEF"; }

135 ià(
n
 > 8)‚ = 8;

136 
i
 = ()
n
; --˜>ğ0; ) { 
buf
[i] = 
hexdig™s
[
b
 & 15]; b >>= 4; }

137 
	`lua_pushl¡ršg
(
L
, 
buf
, (
size_t
)
n
);

139 
	}
}

141 cÚ¡ 
luaL_Reg
 
	gb™_funcs
[] = {

142 { "tob™", 
b™_tob™
 },

143 { "bnÙ", 
b™_bnÙ
 },

144 { "bªd", 
b™_bªd
 },

145 { "bÜ", 
b™_bÜ
 },

146 { "bxÜ", 
b™_bxÜ
 },

147 { "lshiá", 
b™_lshiá
 },

148 { "rshiá", 
b™_rshiá
 },

149 { "¬shiá", 
b™_¬shiá
 },

150 { "rŞ", 
b™_rŞ
 },

151 { "rÜ", 
b™_rÜ
 },

152 { "bsw­", 
b™_bsw­
 },

153 { "tohex", 
b™_tohex
 },

154 { 
NULL
, NULL }

161 
	#BAD_SAR
 (
	`b§r
(-8, 2è!ğ(
SB™s
)-2)

	)

163 
LUALIB_API
 
	$luaİ’_b™
(
lua_S‹
 *
L
)

165 
UB™s
 
b
;

166 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)1437217655L);

167 
b
 = 
	`b¬g
(
L
, -1);

168 ià(
b
 !ğ(
UB™s
)1437217655L || 
BAD_SAR
) {

169 cÚ¡ *
msg
 = "compiled with incompatible†uaconf.h";

170 #ifdeà
LUA_NUMBER_DOUBLE


171 #ifdeà
_WIN32


172 ià(
b
 =ğ(
UB™s
)1610612736L)

173 
msg
 = "use D3DCREATE_FPU_PRESERVE with DirectX";

175 ià(
b
 =ğ(
UB™s
)1127743488L)

176 
msg
 = "not compiled with SWAPPED_DOUBLE";

178 ià(
BAD_SAR
)

179 
msg
 = "arithmetic„ight-shift broken";

180 
	`luaL_”rÜ
(
L
, "b™†ib¿ry s–f-‹¡ faed (%s)", 
msg
);

182 #ià
LUA_VERSION_NUM
 < 502

183 
	`luaL_»gi¡”
(
L
, "b™", 
b™_funcs
);

185 
	`luaL_Ãwlib
(
L
, 
b™_funcs
);

188 
	}
}

	@deps/lua/src/lua_cjson.c

39 
	~<as£¹.h
>

40 
	~<¡ršg.h
>

41 
	~<m©h.h
>

42 
	~<lim™s.h
>

43 
	~"lua.h
"

44 
	~"Ïuxlib.h
"

46 
	~"¡rbuf.h
"

47 
	~"åcÚv.h
"

49 
	~"../../../¤c/sŞ¬isfixes.h
"

51 #iâdeà
CJSON_MODNAME


52 
	#CJSON_MODNAME
 "cjsÚ"

	)

55 #iâdeà
CJSON_VERSION


56 
	#CJSON_VERSION
 "2.1.0"

	)

60 #ià!
defšed
(
isšf
è&& (defšed(
USE_INTERNAL_ISINF
è|| defšed(
MISSING_ISINF
))

61 
	#isšf
(
x
è(!
	`i¢ª
(xè&& i¢ª((xè- (x)))

	)

64 
	#DEFAULT_SPARSE_CONVERT
 0

	)

65 
	#DEFAULT_SPARSE_RATIO
 2

	)

66 
	#DEFAULT_SPARSE_SAFE
 10

	)

67 
	#DEFAULT_ENCODE_MAX_DEPTH
 1000

	)

68 
	#DEFAULT_DECODE_MAX_DEPTH
 1000

	)

69 
	#DEFAULT_ENCODE_INVALID_NUMBERS
 0

	)

70 
	#DEFAULT_DECODE_INVALID_NUMBERS
 1

	)

71 
	#DEFAULT_ENCODE_KEEP_BUFFER
 1

	)

72 
	#DEFAULT_ENCODE_NUMBER_PRECISION
 14

	)

74 #ifdeà
DISABLE_INVALID_NUMBERS


75 #undeà
DEFAULT_DECODE_INVALID_NUMBERS


76 
	#DEFAULT_DECODE_INVALID_NUMBERS
 0

	)

80 
	mT_OBJ_BEGIN
,

81 
	mT_OBJ_END
,

82 
	mT_ARR_BEGIN
,

83 
	mT_ARR_END
,

84 
	mT_STRING
,

85 
	mT_NUMBER
,

86 
	mT_BOOLEAN
,

87 
	mT_NULL
,

88 
	mT_COLON
,

89 
	mT_COMMA
,

90 
	mT_END
,

91 
	mT_WHITESPACE
,

92 
	mT_ERROR
,

93 
	mT_UNKNOWN


94 } 
	tjsÚ_tok’_ty³_t
;

96 cÚ¡ *
	gjsÚ_tok’_ty³_Çme
[] = {

111 
NULL


115 
jsÚ_tok’_ty³_t
 
	mch2tok’
[256];

116 
	mesÿ³2ch¬
[256];

120 
¡rbuf_t
 
	m’code_buf
;

122 
	m’code_¥¬£_cÚv”t
;

123 
	m’code_¥¬£_¿tio
;

124 
	m’code_¥¬£_§ã
;

125 
	m’code_max_d•th
;

126 
	m’code_šv®id_numb”s
;

127 
	m’code_numb”_´ecisiÚ
;

128 
	m’code_k“p_bufãr
;

130 
	mdecode_šv®id_numb”s
;

131 
	mdecode_max_d•th
;

132 } 
	tjsÚ_cÚfig_t
;

135 cÚ¡ *
	md©a
;

136 cÚ¡ *
	m±r
;

137 
¡rbuf_t
 *
	mtmp
;

138 
jsÚ_cÚfig_t
 *
	mcfg
;

139 
	mcu¼’t_d•th
;

140 } 
	tjsÚ_·r£_t
;

143 
jsÚ_tok’_ty³_t
 
	mty³
;

144 
	mšdex
;

146 cÚ¡ *
	m¡ršg
;

147 
	mnumb”
;

148 
	mboŞ—n
;

149 } 
	mv®ue
;

150 
	m¡ršg_Ën
;

151 } 
	tjsÚ_tok’_t
;

153 cÚ¡ *
	gch¬2esÿ³
[256] = {

162 
NULL
, NULL, "\\\"", NULL, NULL, NULL, NULL, NULL,

163 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, "\\/",

164 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

165 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

166 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

167 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

168 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

169 
NULL
, NULL, NULL, NULL, "\\\\", NULL, NULL, NULL,

170 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

171 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

172 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

173 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, "\\u007f",

174 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

175 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

176 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

177 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

178 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

179 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

180 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

181 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

182 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

183 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

184 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

185 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

186 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

187 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

188 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

189 
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, NULL,

194 
jsÚ_cÚfig_t
 *
	$jsÚ_ãtch_cÚfig
(
lua_S‹
 *
l
)

196 
jsÚ_cÚfig_t
 *
cfg
;

198 
cfg
 = 
	`lua_tou£rd©a
(
l
, 
	`lua_upv®uešdex
(1));

199 ià(!
cfg
)

200 
	`luaL_”rÜ
(
l
, "BUG: Unableo fetch CJSON configuration");

202  
cfg
;

203 
	}
}

208 
jsÚ_cÚfig_t
 *
	$jsÚ_¬g_š™
(
lua_S‹
 *
l
, 
¬gs
)

210 
	`luaL_¬gcheck
(
l
, 
	`lua_g‘tİ
Öè<ğ
¬gs
,‡rgs + 1,

213 
	`lua_g‘tİ
(
l
è< 
¬gs
)

214 
	`lua_pushn
(
l
);

216  
	`jsÚ_ãtch_cÚfig
(
l
);

217 
	}
}

220 
	$jsÚ_š‹g”_İtiÚ
(
lua_S‹
 *
l
, 
İtšdex
, *
£‰šg
,

221 
mš
, 
max
)

223 
”rmsg
[64];

224 
v®ue
;

226 ià(!
	`lua_i¢
(
l
, 
İtšdex
)) {

227 
v®ue
 = 
	`luaL_checkš‹g”
(
l
, 
İtšdex
);

228 
	`¢´štf
(
”rmsg
, Ó¼msg), "ex³ùed iÁeg” b‘w“À%d‡nd %d", 
mš
, 
max
);

229 
	`luaL_¬gcheck
(
l
, 
mš
 <ğ
v®ue
 && v®u<ğ
max
, 1, 
”rmsg
);

230 *
£‰šg
 = 
v®ue
;

233 
	`lua_pushš‹g”
(
l
, *
£‰šg
);

236 
	}
}

239 
	$jsÚ_’um_İtiÚ
(
lua_S‹
 *
l
, 
İtšdex
, *
£‰šg
,

240 cÚ¡ **
İtiÚs
, 
boŞ_Œue
)

242 cÚ¡ *
boŞ_İtiÚs
[] = { "off", "Ú", 
NULL
 };

244 ià(!
İtiÚs
) {

245 
İtiÚs
 = 
boŞ_İtiÚs
;

246 
boŞ_Œue
 = 1;

249 ià(!
	`lua_i¢
(
l
, 
İtšdex
)) {

250 ià(
boŞ_Œue
 && 
	`lua_isboŞ—n
(
l
, 
İtšdex
))

251 *
£‰šg
 = 
	`lua_toboŞ—n
(
l
, 
İtšdex
è* 
boŞ_Œue
;

253 *
£‰šg
 = 
	`luaL_checkİtiÚ
(
l
, 
İtšdex
, 
NULL
, 
İtiÚs
);

256 ià(
boŞ_Œue
 && (*
£‰šg
 == 0 || *setting == bool_true))

257 
	`lua_pushboŞ—n
(
l
, *
£‰šg
);

259 
	`lua_push¡ršg
(
l
, 
İtiÚs
[*
£‰šg
]);

262 
	}
}

268 
	$jsÚ_cfg_’code_¥¬£_¬¿y
(
lua_S‹
 *
l
)

270 
jsÚ_cÚfig_t
 *
cfg
 = 
	`jsÚ_¬g_š™
(
l
, 3);

272 
	`jsÚ_’um_İtiÚ
(
l
, 1, &
cfg
->
’code_¥¬£_cÚv”t
, 
NULL
, 1);

273 
	`jsÚ_š‹g”_İtiÚ
(
l
, 2, &
cfg
->
’code_¥¬£_¿tio
, 0, 
INT_MAX
);

274 
	`jsÚ_š‹g”_İtiÚ
(
l
, 3, &
cfg
->
’code_¥¬£_§ã
, 0, 
INT_MAX
);

277 
	}
}

281 
	$jsÚ_cfg_’code_max_d•th
(
lua_S‹
 *
l
)

283 
jsÚ_cÚfig_t
 *
cfg
 = 
	`jsÚ_¬g_š™
(
l
, 1);

285  
	`jsÚ_š‹g”_İtiÚ
(
l
, 1, &
cfg
->
’code_max_d•th
, 1, 
INT_MAX
);

286 
	}
}

290 
	$jsÚ_cfg_decode_max_d•th
(
lua_S‹
 *
l
)

292 
jsÚ_cÚfig_t
 *
cfg
 = 
	`jsÚ_¬g_š™
(
l
, 1);

294  
	`jsÚ_š‹g”_İtiÚ
(
l
, 1, &
cfg
->
decode_max_d•th
, 1, 
INT_MAX
);

295 
	}
}

298 
	$jsÚ_cfg_’code_numb”_´ecisiÚ
(
lua_S‹
 *
l
)

300 
jsÚ_cÚfig_t
 *
cfg
 = 
	`jsÚ_¬g_š™
(
l
, 1);

302  
	`jsÚ_š‹g”_İtiÚ
(
l
, 1, &
cfg
->
’code_numb”_´ecisiÚ
, 1, 14);

303 
	}
}

306 
	$jsÚ_cfg_’code_k“p_bufãr
(
lua_S‹
 *
l
)

308 
jsÚ_cÚfig_t
 *
cfg
 = 
	`jsÚ_¬g_š™
(
l
, 1);

309 
Şd_v®ue
;

311 
Şd_v®ue
 = 
cfg
->
’code_k“p_bufãr
;

313 
	`jsÚ_’um_İtiÚ
(
l
, 1, &
cfg
->
’code_k“p_bufãr
, 
NULL
, 1);

316 ià(
Şd_v®ue
 ^ 
cfg
->
’code_k“p_bufãr
) {

317 ià(
cfg
->
’code_k“p_bufãr
)

318 
	`¡rbuf_š™
(&
cfg
->
’code_buf
, 0);

320 
	`¡rbuf_ä“
(&
cfg
->
’code_buf
);

324 
	}
}

326 #ià
defšed
(
DISABLE_INVALID_NUMBERS
è&& !defšed(
USE_INTERNAL_FPCONV
)

327 
	$jsÚ_v”ify_šv®id_numb”_£‰šg
(
lua_S‹
 *
l
, *
£‰šg
)

329 ià(*
£‰šg
 == 1) {

330 *
£‰šg
 = 0;

331 
	`luaL_”rÜ
(
l
, "Infinity, NaN,‡nd/or hexadecimal‚umbers‡re‚ot supported.");

333 
	}
}

335 
	#jsÚ_v”ify_šv®id_numb”_£‰šg
(
l
, 
s
èdØ{ } 0)

	)

338 
	$jsÚ_cfg_’code_šv®id_numb”s
(
lua_S‹
 *
l
)

340 cÚ¡ *
İtiÚs
[] = { "off", "Ú", "nuÎ", 
NULL
 };

341 
jsÚ_cÚfig_t
 *
cfg
 = 
	`jsÚ_¬g_š™
(
l
, 1);

343 
	`jsÚ_’um_İtiÚ
(
l
, 1, &
cfg
->
’code_šv®id_numb”s
, 
İtiÚs
, 1);

345 
	`jsÚ_v”ify_šv®id_numb”_£‰šg
(
l
, &
cfg
->
’code_šv®id_numb”s
);

348 
	}
}

350 
	$jsÚ_cfg_decode_šv®id_numb”s
(
lua_S‹
 *
l
)

352 
jsÚ_cÚfig_t
 *
cfg
 = 
	`jsÚ_¬g_š™
(
l
, 1);

354 
	`jsÚ_’um_İtiÚ
(
l
, 1, &
cfg
->
decode_šv®id_numb”s
, 
NULL
, 1);

356 
	`jsÚ_v”ify_šv®id_numb”_£‰šg
(
l
, &
cfg
->
’code_šv®id_numb”s
);

359 
	}
}

361 
	$jsÚ_de¡roy_cÚfig
(
lua_S‹
 *
l
)

363 
jsÚ_cÚfig_t
 *
cfg
;

365 
cfg
 = 
	`lua_tou£rd©a
(
l
, 1);

366 ià(
cfg
)

367 
	`¡rbuf_ä“
(&
cfg
->
’code_buf
);

368 
cfg
 = 
NULL
;

371 
	}
}

373 
	$jsÚ_ü—‹_cÚfig
(
lua_S‹
 *
l
)

375 
jsÚ_cÚfig_t
 *
cfg
;

376 
i
;

378 
cfg
 = 
	`lua_Ãwu£rd©a
(
l
, (*cfg));

381 
	`lua_ÃwbË
(
l
);

382 
	`lua_pushcfunùiÚ
(
l
, 
jsÚ_de¡roy_cÚfig
);

383 
	`lua_£tf›ld
(
l
, -2, "__gc");

384 
	`lua_£tm‘©abË
(
l
, -2);

386 
cfg
->
’code_¥¬£_cÚv”t
 = 
DEFAULT_SPARSE_CONVERT
;

387 
cfg
->
’code_¥¬£_¿tio
 = 
DEFAULT_SPARSE_RATIO
;

388 
cfg
->
’code_¥¬£_§ã
 = 
DEFAULT_SPARSE_SAFE
;

389 
cfg
->
’code_max_d•th
 = 
DEFAULT_ENCODE_MAX_DEPTH
;

390 
cfg
->
decode_max_d•th
 = 
DEFAULT_DECODE_MAX_DEPTH
;

391 
cfg
->
’code_šv®id_numb”s
 = 
DEFAULT_ENCODE_INVALID_NUMBERS
;

392 
cfg
->
decode_šv®id_numb”s
 = 
DEFAULT_DECODE_INVALID_NUMBERS
;

393 
cfg
->
’code_k“p_bufãr
 = 
DEFAULT_ENCODE_KEEP_BUFFER
;

394 
cfg
->
’code_numb”_´ecisiÚ
 = 
DEFAULT_ENCODE_NUMBER_PRECISION
;

396 #ià
DEFAULT_ENCODE_KEEP_BUFFER
 > 0

397 
	`¡rbuf_š™
(&
cfg
->
’code_buf
, 0);

403 
i
 = 0; i < 256; i++)

404 
cfg
->
ch2tok’
[
i
] = 
T_ERROR
;

407 
cfg
->
ch2tok’
['{'] = 
T_OBJ_BEGIN
;

408 
cfg
->
ch2tok’
['}'] = 
T_OBJ_END
;

409 
cfg
->
ch2tok’
['['] = 
T_ARR_BEGIN
;

410 
cfg
->
ch2tok’
[']'] = 
T_ARR_END
;

411 
cfg
->
ch2tok’
[','] = 
T_COMMA
;

412 
cfg
->
ch2tok’
[':'] = 
T_COLON
;

413 
cfg
->
ch2tok’
['\0'] = 
T_END
;

414 
cfg
->
ch2tok’
[' '] = 
T_WHITESPACE
;

415 
cfg
->
ch2tok’
['\t'] = 
T_WHITESPACE
;

416 
cfg
->
ch2tok’
['\n'] = 
T_WHITESPACE
;

417 
cfg
->
ch2tok’
['\r'] = 
T_WHITESPACE
;

420 
cfg
->
ch2tok’
['f'] = 
T_UNKNOWN
;

421 
cfg
->
ch2tok’
['i'] = 
T_UNKNOWN
;

422 
cfg
->
ch2tok’
['I'] = 
T_UNKNOWN
;

423 
cfg
->
ch2tok’
['n'] = 
T_UNKNOWN
;

424 
cfg
->
ch2tok’
['N'] = 
T_UNKNOWN
;

425 
cfg
->
ch2tok’
['t'] = 
T_UNKNOWN
;

426 
cfg
->
ch2tok’
['"'] = 
T_UNKNOWN
;

427 
cfg
->
ch2tok’
['+'] = 
T_UNKNOWN
;

428 
cfg
->
ch2tok’
['-'] = 
T_UNKNOWN
;

429 
i
 = 0; i < 10; i++)

430 
cfg
->
ch2tok’
['0' + 
i
] = 
T_UNKNOWN
;

433 
i
 = 0; i < 256; i++)

434 
cfg
->
esÿ³2ch¬
[
i
] = 0;

435 
cfg
->
esÿ³2ch¬
['"'] = '"';

436 
cfg
->
esÿ³2ch¬
['\\'] = '\\';

437 
cfg
->
esÿ³2ch¬
['/'] = '/';

438 
cfg
->
esÿ³2ch¬
['b'] = '\b';

439 
cfg
->
esÿ³2ch¬
['t'] = '\t';

440 
cfg
->
esÿ³2ch¬
['n'] = '\n';

441 
cfg
->
esÿ³2ch¬
['f'] = '\f';

442 
cfg
->
esÿ³2ch¬
['r'] = '\r';

443 
cfg
->
esÿ³2ch¬
['u'] = 'u';

444 
	}
}

448 
	$jsÚ_’code_exû±iÚ
(
lua_S‹
 *
l
, 
jsÚ_cÚfig_t
 *
cfg
, 
¡rbuf_t
 *
jsÚ
, 
lšdex
,

449 cÚ¡ *
»asÚ
)

451 ià(!
cfg
->
’code_k“p_bufãr
)

452 
	`¡rbuf_ä“
(
jsÚ
);

453 
	`luaL_”rÜ
(
l
, "Cannot serialise %s: %s",

454 
	`lua_ty³Çme
(
l
, 
	`lua_ty³
Ö, 
lšdex
)), 
»asÚ
);

455 
	}
}

463 
	$jsÚ_­³nd_¡ršg
(
lua_S‹
 *
l
, 
¡rbuf_t
 *
jsÚ
, 
lšdex
)

465 cÚ¡ *
esc¡r
;

466 
i
;

467 cÚ¡ *
¡r
;

468 
size_t
 
Ën
;

470 
¡r
 = 
	`lua_tŞ¡ršg
(
l
, 
lšdex
, &
Ën
);

476 
	`¡rbuf_’su»_em±y_Ëngth
(
jsÚ
, 
Ën
 * 6 + 2);

478 
	`¡rbuf_­³nd_ch¬_un§ã
(
jsÚ
, '\"');

479 
i
 = 0; i < 
Ën
; i++) {

480 
esc¡r
 = 
ch¬2esÿ³
[()
¡r
[
i
]];

481 ià(
esc¡r
)

482 
	`¡rbuf_­³nd_¡ršg
(
jsÚ
, 
esc¡r
);

484 
	`¡rbuf_­³nd_ch¬_un§ã
(
jsÚ
, 
¡r
[
i
]);

486 
	`¡rbuf_­³nd_ch¬_un§ã
(
jsÚ
, '\"');

487 
	}
}

493 
	$lua_¬¿y_Ëngth
(
lua_S‹
 *
l
, 
jsÚ_cÚfig_t
 *
cfg
, 
¡rbuf_t
 *
jsÚ
)

495 
k
;

496 
max
;

497 
™ems
;

499 
max
 = 0;

500 
™ems
 = 0;

502 
	`lua_pushn
(
l
);

504 
	`lua_Ãxt
(
l
, -2) != 0) {

506 ià(
	`lua_ty³
(
l
, -2è=ğ
LUA_TNUMBER
 &&

507 (
k
 = 
	`lua_tÚumb”
(
l
, -2))) {

509 ià(
	`æoÜ
(
k
) == k && k >= 1) {

510 ià(
k
 > 
max
)

511 
max
 = 
k
;

512 
™ems
++;

513 
	`lua_pİ
(
l
, 1);

519 
	`lua_pİ
(
l
, 2);

524 ià(
cfg
->
’code_¥¬£_¿tio
 > 0 &&

525 
max
 > 
™ems
 * 
cfg
->
’code_¥¬£_¿tio
 &&

526 
max
 > 
cfg
->
’code_¥¬£_§ã
) {

527 ià(!
cfg
->
’code_¥¬£_cÚv”t
)

528 
	`jsÚ_’code_exû±iÚ
(
l
, 
cfg
, 
jsÚ
, -1, "excessively sparse‡rray");

533  
max
;

534 
	}
}

536 
	$jsÚ_check_’code_d•th
(
lua_S‹
 *
l
, 
jsÚ_cÚfig_t
 *
cfg
,

537 
cu¼’t_d•th
, 
¡rbuf_t
 *
jsÚ
)

549 ià(
cu¼’t_d•th
 <ğ
cfg
->
’code_max_d•th
 && 
	`lua_check¡ack
(
l
, 3))

552 ià(!
cfg
->
’code_k“p_bufãr
)

553 
	`¡rbuf_ä“
(
jsÚ
);

555 
	`luaL_”rÜ
(
l
, "Cannot serialise,ƒxcessive‚esting (%d)",

556 
cu¼’t_d•th
);

557 
	}
}

559 
jsÚ_­³nd_d©a
(
lua_S‹
 *
l
, 
jsÚ_cÚfig_t
 *
cfg
,

560 
cu¼’t_d•th
, 
¡rbuf_t
 *
jsÚ
);

566 
	$jsÚ_­³nd_¬¿y
(
lua_S‹
 *
l
, 
jsÚ_cÚfig_t
 *
cfg
, 
cu¼’t_d•th
,

567 
¡rbuf_t
 *
jsÚ
, 
¬¿y_Ëngth
)

569 
comma
, 
i
;

571 
	`¡rbuf_­³nd_ch¬
(
jsÚ
, '[');

573 
comma
 = 0;

574 
i
 = 1; i <ğ
¬¿y_Ëngth
; i++) {

575 ià(
comma
)

576 
	`¡rbuf_­³nd_ch¬
(
jsÚ
, ',');

578 
comma
 = 1;

580 
	`lua_¿wg‘i
(
l
, -1, 
i
);

581 
	`jsÚ_­³nd_d©a
(
l
, 
cfg
, 
cu¼’t_d•th
, 
jsÚ
);

582 
	`lua_pİ
(
l
, 1);

585 
	`¡rbuf_­³nd_ch¬
(
jsÚ
, ']');

586 
	}
}

588 
	$jsÚ_­³nd_numb”
(
lua_S‹
 *
l
, 
jsÚ_cÚfig_t
 *
cfg
,

589 
¡rbuf_t
 *
jsÚ
, 
lšdex
)

591 
num
 = 
	`lua_tÚumb”
(
l
, 
lšdex
);

592 
Ën
;

594 ià(
cfg
->
’code_šv®id_numb”s
 == 0) {

596 ià(
	`isšf
(
num
è|| 
	`i¢ª
(num))

597 
	`jsÚ_’code_exû±iÚ
(
l
, 
cfg
, 
jsÚ
, 
lšdex
, "must‚ot be NaN or Inf");

598 } ià(
cfg
->
’code_šv®id_numb”s
 == 1) {

601 ià(
	`i¢ª
(
num
)) {

602 
	`¡rbuf_­³nd_mem
(
jsÚ
, "nan", 3);

607 ià(
	`isšf
(
num
è|| 
	`i¢ª
(num)) {

608 
	`¡rbuf_­³nd_mem
(
jsÚ
, "null", 4);

613 
	`¡rbuf_’su»_em±y_Ëngth
(
jsÚ
, 
FPCONV_G_FMT_BUFSIZE
);

614 
Ën
 = 
	`åcÚv_g_fmt
(
	`¡rbuf_em±y_±r
(
jsÚ
), 
num
, 
cfg
->
’code_numb”_´ecisiÚ
);

615 
	`¡rbuf_ex‹nd_Ëngth
(
jsÚ
, 
Ën
);

616 
	}
}

618 
	$jsÚ_­³nd_objeù
(
lua_S‹
 *
l
, 
jsÚ_cÚfig_t
 *
cfg
,

619 
cu¼’t_d•th
, 
¡rbuf_t
 *
jsÚ
)

621 
comma
, 
keyty³
;

624 
	`¡rbuf_­³nd_ch¬
(
jsÚ
, '{');

626 
	`lua_pushn
(
l
);

628 
comma
 = 0;

629 
	`lua_Ãxt
(
l
, -2) != 0) {

630 ià(
comma
)

631 
	`¡rbuf_­³nd_ch¬
(
jsÚ
, ',');

633 
comma
 = 1;

636 
keyty³
 = 
	`lua_ty³
(
l
, -2);

637 ià(
keyty³
 =ğ
LUA_TNUMBER
) {

638 
	`¡rbuf_­³nd_ch¬
(
jsÚ
, '"');

639 
	`jsÚ_­³nd_numb”
(
l
, 
cfg
, 
jsÚ
, -2);

640 
	`¡rbuf_­³nd_mem
(
jsÚ
, "\":", 2);

641 } ià(
keyty³
 =ğ
LUA_TSTRING
) {

642 
	`jsÚ_­³nd_¡ršg
(
l
, 
jsÚ
, -2);

643 
	`¡rbuf_­³nd_ch¬
(
jsÚ
, ':');

645 
	`jsÚ_’code_exû±iÚ
(
l
, 
cfg
, 
jsÚ
, -2,

651 
	`jsÚ_­³nd_d©a
(
l
, 
cfg
, 
cu¼’t_d•th
, 
jsÚ
);

652 
	`lua_pİ
(
l
, 1);

656 
	`¡rbuf_­³nd_ch¬
(
jsÚ
, '}');

657 
	}
}

660 
	$jsÚ_­³nd_d©a
(
lua_S‹
 *
l
, 
jsÚ_cÚfig_t
 *
cfg
,

661 
cu¼’t_d•th
, 
¡rbuf_t
 *
jsÚ
)

663 
Ën
;

665 
	`lua_ty³
(
l
, -1)) {

666 
LUA_TSTRING
:

667 
	`jsÚ_­³nd_¡ršg
(
l
, 
jsÚ
, -1);

669 
LUA_TNUMBER
:

670 
	`jsÚ_­³nd_numb”
(
l
, 
cfg
, 
jsÚ
, -1);

672 
LUA_TBOOLEAN
:

673 ià(
	`lua_toboŞ—n
(
l
, -1))

674 
	`¡rbuf_­³nd_mem
(
jsÚ
, "true", 4);

676 
	`¡rbuf_­³nd_mem
(
jsÚ
, "false", 5);

678 
LUA_TTABLE
:

679 
cu¼’t_d•th
++;

680 
	`jsÚ_check_’code_d•th
(
l
, 
cfg
, 
cu¼’t_d•th
, 
jsÚ
);

681 
Ën
 = 
	`lua_¬¿y_Ëngth
(
l
, 
cfg
, 
jsÚ
);

682 ià(
Ën
 > 0)

683 
	`jsÚ_­³nd_¬¿y
(
l
, 
cfg
, 
cu¼’t_d•th
, 
jsÚ
, 
Ën
);

685 
	`jsÚ_­³nd_objeù
(
l
, 
cfg
, 
cu¼’t_d•th
, 
jsÚ
);

687 
LUA_TNIL
:

688 
	`¡rbuf_­³nd_mem
(
jsÚ
, "null", 4);

690 
LUA_TLIGHTUSERDATA
:

691 ià(
	`lua_tou£rd©a
(
l
, -1è=ğ
NULL
) {

692 
	`¡rbuf_­³nd_mem
(
jsÚ
, "null", 4);

698 
	`jsÚ_’code_exû±iÚ
(
l
, 
cfg
, 
jsÚ
, -1, "type‚ot supported");

701 
	}
}

703 
	$jsÚ_’code
(
lua_S‹
 *
l
)

705 
jsÚ_cÚfig_t
 *
cfg
 = 
	`jsÚ_ãtch_cÚfig
(
l
);

706 
¡rbuf_t
 
loÿl_’code_buf
;

707 
¡rbuf_t
 *
’code_buf
;

708 *
jsÚ
;

709 
Ën
;

711 
	`luaL_¬gcheck
(
l
, 
	`lua_g‘tİ
(l) == 1, 1, "expected 1‡rgument");

713 ià(!
cfg
->
’code_k“p_bufãr
) {

715 
’code_buf
 = &
loÿl_’code_buf
;

716 
	`¡rbuf_š™
(
’code_buf
, 0);

719 
’code_buf
 = &
cfg
->encode_buf;

720 
	`¡rbuf_»£t
(
’code_buf
);

723 
	`jsÚ_­³nd_d©a
(
l
, 
cfg
, 0, 
’code_buf
);

724 
jsÚ
 = 
	`¡rbuf_¡ršg
(
’code_buf
, &
Ën
);

726 
	`lua_pushl¡ršg
(
l
, 
jsÚ
, 
Ën
);

728 ià(!
cfg
->
’code_k“p_bufãr
)

729 
	`¡rbuf_ä“
(
’code_buf
);

732 
	}
}

736 
jsÚ_´oûss_v®ue
(
lua_S‹
 *
l
, 
jsÚ_·r£_t
 *
jsÚ
,

737 
jsÚ_tok’_t
 *
tok’
);

739 
	$hexdig™2št
(
hex
)

741 ià('0' <ğ
hex
 && hex <= '9')

742  
hex
 - '0';

745 
hex
 |= 0x20;

746 ià('a' <ğ
hex
 && hex <= 'f')

747  10 + 
hex
 - 'a';

750 
	}
}

752 
	$decode_hex4
(cÚ¡ *
hex
)

754 
dig™
[4];

755 
i
;

760 
i
 = 0; i < 4; i++) {

761 
dig™
[
i
] = 
	`hexdig™2št
(
hex
[i]);

762 ià(
dig™
[
i
] < 0) {

767  (
dig™
[0] << 12) +

768 (
dig™
[1] << 8) +

769 (
dig™
[2] << 4) +

770 
dig™
[3];

771 
	}
}

775 
	$cod•ošt_to_utf8
(*
utf8
, 
cod•ošt
)

778 ià(
cod•ošt
 <= 0x7F) {

779 
utf8
[0] = 
cod•ošt
;

784 ià(
cod•ošt
 <= 0x7FF) {

785 
utf8
[0] = (
cod•ošt
 >> 6) | 0xC0;

786 
utf8
[1] = (
cod•ošt
 & 0x3F) | 0x80;

791 ià(
cod•ošt
 <= 0xFFFF) {

792 
utf8
[0] = (
cod•ošt
 >> 12) | 0xE0;

793 
utf8
[1] = ((
cod•ošt
 >> 6) & 0x3F) | 0x80;

794 
utf8
[2] = (
cod•ošt
 & 0x3F) | 0x80;

799 ià(
cod•ošt
 <= 0x1FFFFF) {

800 
utf8
[0] = (
cod•ošt
 >> 18) | 0xF0;

801 
utf8
[1] = ((
cod•ošt
 >> 12) & 0x3F) | 0x80;

802 
utf8
[2] = ((
cod•ošt
 >> 6) & 0x3F) | 0x80;

803 
utf8
[3] = (
cod•ošt
 & 0x3F) | 0x80;

808 
	}
}

819 
	$jsÚ_­³nd_unicode_esÿ³
(
jsÚ_·r£_t
 *
jsÚ
)

821 
utf8
[4];

822 
cod•ošt
;

823 
su¼og©e_low
;

824 
Ën
;

825 
esÿ³_Ën
 = 6;

828 
cod•ošt
 = 
	`decode_hex4
(
jsÚ
->
±r
 + 2);

829 ià(
cod•ošt
 < 0)

838 ià((
cod•ošt
 & 0xF800) == 0xD800) {

840 ià(
cod•ošt
 & 0x400)

844 ià(*(
jsÚ
->
±r
 + 
esÿ³_Ën
) != '\\' ||

845 *(
jsÚ
->
±r
 + 
esÿ³_Ën
 + 1) != 'u') {

850 
su¼og©e_low
 = 
	`decode_hex4
(
jsÚ
->
±r
 + 2 + 
esÿ³_Ën
);

851 ià(
su¼og©e_low
 < 0)

855 ià((
su¼og©e_low
 & 0xFC00) != 0xDC00)

859 
cod•ošt
 = (codepoint & 0x3FF) << 10;

860 
su¼og©e_low
 &= 0x3FF;

861 
cod•ošt
 = (cod•ošˆ| 
su¼og©e_low
) + 0x10000;

862 
esÿ³_Ën
 = 12;

866 
Ën
 = 
	`cod•ošt_to_utf8
(
utf8
, 
cod•ošt
);

867 ià(!
Ën
)

871 
	`¡rbuf_­³nd_mem_un§ã
(
jsÚ
->
tmp
, 
utf8
, 
Ën
);

872 
jsÚ
->
±r
 +ğ
esÿ³_Ën
;

875 
	}
}

877 
	$jsÚ_£t_tok’_”rÜ
(
jsÚ_tok’_t
 *
tok’
, 
jsÚ_·r£_t
 *
jsÚ
,

878 cÚ¡ *
”¹y³
)

880 
tok’
->
ty³
 = 
T_ERROR
;

881 
tok’
->
šdex
 = 
jsÚ
->
±r
 - jsÚ->
d©a
;

882 
tok’
->
v®ue
.
¡ršg
 = 
”¹y³
;

883 
	}
}

885 
	$jsÚ_Ãxt_¡ršg_tok’
(
jsÚ_·r£_t
 *
jsÚ
, 
jsÚ_tok’_t
 *
tok’
)

887 *
esÿ³2ch¬
 = 
jsÚ
->
cfg
->escape2char;

888 
ch
;

891 
	`as£¹
(*
jsÚ
->
±r
 == '"');

894 
jsÚ
->
±r
++;

900 
	`¡rbuf_»£t
(
jsÚ
->
tmp
);

902 (
ch
 = *
jsÚ
->
±r
) != '"') {

903 ià(!
ch
) {

905 
	`jsÚ_£t_tok’_”rÜ
(
tok’
, 
jsÚ
, "unexpectedƒnd of string");

910 ià(
ch
 == '\\') {

912 
ch
 = *(
jsÚ
->
±r
 + 1);

915 
ch
 = 
esÿ³2ch¬
[()ch];

916 ià(
ch
 == 'u') {

917 ià(
	`jsÚ_­³nd_unicode_esÿ³
(
jsÚ
) == 0)

920 
	`jsÚ_£t_tok’_”rÜ
(
tok’
, 
jsÚ
,

924 ià(!
ch
) {

925 
	`jsÚ_£t_tok’_”rÜ
(
tok’
, 
jsÚ
, "invalidƒscape code");

930 
jsÚ
->
±r
++;

934 
	`¡rbuf_­³nd_ch¬_un§ã
(
jsÚ
->
tmp
, 
ch
);

935 
jsÚ
->
±r
++;

937 
jsÚ
->
±r
++;

939 
	`¡rbuf_’su»_nuÎ
(
jsÚ
->
tmp
);

941 
tok’
->
ty³
 = 
T_STRING
;

942 
tok’
->
v®ue
.
¡ršg
 = 
	`¡rbuf_¡ršg
(
jsÚ
->
tmp
, &tok’->
¡ršg_Ën
);

943 
	}
}

960 
	$jsÚ_is_šv®id_numb”
(
jsÚ_·r£_t
 *
jsÚ
)

962 cÚ¡ *
p
 = 
jsÚ
->
±r
;

965 ià(*
p
 == '+')

969 ià(*
p
 == '-')

970 
p
++;

973 ià(*
p
 == '0') {

974 
ch2
 = *(
p
 + 1);

976 ià((
ch2
 | 0x20) == 'x' ||

977 ('0' <ğ
ch2
 && ch2 <= '9'))

981 } ià(*
p
 <= '9') {

986 ià(!
	`¡ºÿ£cmp
(
p
, "inf", 3))

988 ià(!
	`¡ºÿ£cmp
(
p
, "nan", 3))

994 
	}
}

996 
	$jsÚ_Ãxt_numb”_tok’
(
jsÚ_·r£_t
 *
jsÚ
, 
jsÚ_tok’_t
 *
tok’
)

998 *
’d±r
;

1000 
tok’
->
ty³
 = 
T_NUMBER
;

1001 
tok’
->
v®ue
.
numb”
 = 
	`åcÚv_¡¹od
(
jsÚ
->
±r
, &
’d±r
);

1002 ià(
jsÚ
->
±r
 =ğ
’d±r
)

1003 
	`jsÚ_£t_tok’_”rÜ
(
tok’
, 
jsÚ
, "invalid‚umber");

1005 
jsÚ
->
±r
 = 
’d±r
;

1008 
	}
}

1014 
	$jsÚ_Ãxt_tok’
(
jsÚ_·r£_t
 *
jsÚ
, 
jsÚ_tok’_t
 *
tok’
)

1016 cÚ¡ 
jsÚ_tok’_ty³_t
 *
ch2tok’
 = 
jsÚ
->
cfg
->ch2token;

1017 
ch
;

1021 
ch
 = ()*(
jsÚ
->
±r
);

1022 
tok’
->
ty³
 = 
ch2tok’
[
ch
];

1023 ià(
tok’
->
ty³
 !ğ
T_WHITESPACE
)

1025 
jsÚ
->
±r
++;

1030 
tok’
->
šdex
 = 
jsÚ
->
±r
 - jsÚ->
d©a
;

1033 ià(
tok’
->
ty³
 =ğ
T_ERROR
) {

1034 
	`jsÚ_£t_tok’_”rÜ
(
tok’
, 
jsÚ
, "invalidoken");

1038 ià(
tok’
->
ty³
 =ğ
T_END
) {

1043 ià(
tok’
->
ty³
 !ğ
T_UNKNOWN
) {

1044 
jsÚ
->
±r
++;

1054 ià(
ch
 == '"') {

1055 
	`jsÚ_Ãxt_¡ršg_tok’
(
jsÚ
, 
tok’
);

1057 } ià(
ch
 == '-' || ('0' <= ch && ch <= '9')) {

1058 ià(!
jsÚ
->
cfg
->
decode_šv®id_numb”s
 && 
	`jsÚ_is_šv®id_numb”
(json)) {

1059 
	`jsÚ_£t_tok’_”rÜ
(
tok’
, 
jsÚ
, "invalid‚umber");

1062 
	`jsÚ_Ãxt_numb”_tok’
(
jsÚ
, 
tok’
);

1064 } ià(!
	`¡ºcmp
(
jsÚ
->
±r
, "true", 4)) {

1065 
tok’
->
ty³
 = 
T_BOOLEAN
;

1066 
tok’
->
v®ue
.
boŞ—n
 = 1;

1067 
jsÚ
->
±r
 += 4;

1069 } ià(!
	`¡ºcmp
(
jsÚ
->
±r
, "false", 5)) {

1070 
tok’
->
ty³
 = 
T_BOOLEAN
;

1071 
tok’
->
v®ue
.
boŞ—n
 = 0;

1072 
jsÚ
->
±r
 += 5;

1074 } ià(!
	`¡ºcmp
(
jsÚ
->
±r
, "null", 4)) {

1075 
tok’
->
ty³
 = 
T_NULL
;

1076 
jsÚ
->
±r
 += 4;

1078 } ià(
jsÚ
->
cfg
->
decode_šv®id_numb”s
 &&

1079 
	`jsÚ_is_šv®id_numb”
(
jsÚ
)) {

1085 
	`jsÚ_Ãxt_numb”_tok’
(
jsÚ
, 
tok’
);

1090 
	`jsÚ_£t_tok’_”rÜ
(
tok’
, 
jsÚ
, "invalidoken");

1091 
	}
}

1099 
	$jsÚ_throw_·r£_”rÜ
(
lua_S‹
 *
l
, 
jsÚ_·r£_t
 *
jsÚ
,

1100 cÚ¡ *
exp
, 
jsÚ_tok’_t
 *
tok’
)

1102 cÚ¡ *
found
;

1104 
	`¡rbuf_ä“
(
jsÚ
->
tmp
);

1106 ià(
tok’
->
ty³
 =ğ
T_ERROR
)

1107 
found
 = 
tok’
->
v®ue
.
¡ršg
;

1109 
found
 = 
jsÚ_tok’_ty³_Çme
[
tok’
->
ty³
];

1112 
	`luaL_”rÜ
(
l
, "Expected %s but found %s‡t character %d",

1113 
exp
, 
found
, 
tok’
->
šdex
 + 1);

1114 
	}
}

1116 
šlše
 
	$jsÚ_decode_asûnd
(
jsÚ_·r£_t
 *
jsÚ
)

1118 
jsÚ
->
cu¼’t_d•th
--;

1119 
	}
}

1121 
	$jsÚ_decode_desûnd
(
lua_S‹
 *
l
, 
jsÚ_·r£_t
 *
jsÚ
, 
¦Ùs
)

1123 
jsÚ
->
cu¼’t_d•th
++;

1125 ià(
jsÚ
->
cu¼’t_d•th
 <ğjsÚ->
cfg
->
decode_max_d•th
 &&

1126 
	`lua_check¡ack
(
l
, 
¦Ùs
)) {

1130 
	`¡rbuf_ä“
(
jsÚ
->
tmp
);

1131 
	`luaL_”rÜ
(
l
, "Foundoo many‚ested data structures (%d)‡t character %d",

1132 
jsÚ
->
cu¼’t_d•th
, jsÚ->
±r
 - jsÚ->
d©a
);

1133 
	}
}

1135 
	$jsÚ_·r£_objeù_cÚ‹xt
(
lua_S‹
 *
l
, 
jsÚ_·r£_t
 *
jsÚ
)

1137 
jsÚ_tok’_t
 
tok’
;

1141 
	`jsÚ_decode_desûnd
(
l
, 
jsÚ
, 3);

1143 
	`lua_ÃwbË
(
l
);

1145 
	`jsÚ_Ãxt_tok’
(
jsÚ
, &
tok’
);

1148 ià(
tok’
.
ty³
 =ğ
T_OBJ_END
) {

1149 
	`jsÚ_decode_asûnd
(
jsÚ
);

1154 ià(
tok’
.
ty³
 !ğ
T_STRING
)

1155 
	`jsÚ_throw_·r£_”rÜ
(
l
, 
jsÚ
, "objeù key sŒšg", &
tok’
);

1158 
	`lua_pushl¡ršg
(
l
, 
tok’
.
v®ue
.
¡ršg
,ok’.
¡ršg_Ën
);

1160 
	`jsÚ_Ãxt_tok’
(
jsÚ
, &
tok’
);

1161 ià(
tok’
.
ty³
 !ğ
T_COLON
)

1162 
	`jsÚ_throw_·r£_”rÜ
(
l
, 
jsÚ
, "cŞÚ", &
tok’
);

1165 
	`jsÚ_Ãxt_tok’
(
jsÚ
, &
tok’
);

1166 
	`jsÚ_´oûss_v®ue
(
l
, 
jsÚ
, &
tok’
);

1169 
	`lua_¿w£t
(
l
, -3);

1171 
	`jsÚ_Ãxt_tok’
(
jsÚ
, &
tok’
);

1173 ià(
tok’
.
ty³
 =ğ
T_OBJ_END
) {

1174 
	`jsÚ_decode_asûnd
(
jsÚ
);

1178 ià(
tok’
.
ty³
 !ğ
T_COMMA
)

1179 
	`jsÚ_throw_·r£_”rÜ
(
l
, 
jsÚ
, "comm¨Ü objeùƒnd", &
tok’
);

1181 
	`jsÚ_Ãxt_tok’
(
jsÚ
, &
tok’
);

1183 
	}
}

1186 
	$jsÚ_·r£_¬¿y_cÚ‹xt
(
lua_S‹
 *
l
, 
jsÚ_·r£_t
 *
jsÚ
)

1188 
jsÚ_tok’_t
 
tok’
;

1189 
i
;

1193 
	`jsÚ_decode_desûnd
(
l
, 
jsÚ
, 2);

1195 
	`lua_ÃwbË
(
l
);

1197 
	`jsÚ_Ãxt_tok’
(
jsÚ
, &
tok’
);

1200 ià(
tok’
.
ty³
 =ğ
T_ARR_END
) {

1201 
	`jsÚ_decode_asûnd
(
jsÚ
);

1205 
i
 = 1; ; i++) {

1206 
	`jsÚ_´oûss_v®ue
(
l
, 
jsÚ
, &
tok’
);

1207 
	`lua_¿w£ti
(
l
, -2, 
i
);

1209 
	`jsÚ_Ãxt_tok’
(
jsÚ
, &
tok’
);

1211 ià(
tok’
.
ty³
 =ğ
T_ARR_END
) {

1212 
	`jsÚ_decode_asûnd
(
jsÚ
);

1216 ià(
tok’
.
ty³
 !ğ
T_COMMA
)

1217 
	`jsÚ_throw_·r£_”rÜ
(
l
, 
jsÚ
, "comm¨Ü‡¼ayƒnd", &
tok’
);

1219 
	`jsÚ_Ãxt_tok’
(
jsÚ
, &
tok’
);

1221 
	}
}

1224 
	$jsÚ_´oûss_v®ue
(
lua_S‹
 *
l
, 
jsÚ_·r£_t
 *
jsÚ
,

1225 
jsÚ_tok’_t
 *
tok’
)

1227 
tok’
->
ty³
) {

1228 
T_STRING
:

1229 
	`lua_pushl¡ršg
(
l
, 
tok’
->
v®ue
.
¡ršg
,ok’->
¡ršg_Ën
);

1231 
T_NUMBER
:

1232 
	`lua_pushnumb”
(
l
, 
tok’
->
v®ue
.
numb”
);

1234 
T_BOOLEAN
:

1235 
	`lua_pushboŞ—n
(
l
, 
tok’
->
v®ue
.
boŞ—n
);

1237 
T_OBJ_BEGIN
:

1238 
	`jsÚ_·r£_objeù_cÚ‹xt
(
l
, 
jsÚ
);

1240 
T_ARR_BEGIN
:

1241 
	`jsÚ_·r£_¬¿y_cÚ‹xt
(
l
, 
jsÚ
);

1243 
T_NULL
:

1246 
	`lua_pushlightu£rd©a
(
l
, 
NULL
);

1249 
	`jsÚ_throw_·r£_”rÜ
(
l
, 
jsÚ
, "v®ue", 
tok’
);

1251 
	}
}

1253 
	$jsÚ_decode
(
lua_S‹
 *
l
)

1255 
jsÚ_·r£_t
 
jsÚ
;

1256 
jsÚ_tok’_t
 
tok’
;

1257 
size_t
 
jsÚ_Ën
;

1259 
	`luaL_¬gcheck
(
l
, 
	`lua_g‘tİ
(l) == 1, 1, "expected 1‡rgument");

1261 
jsÚ
.
cfg
 = 
	`jsÚ_ãtch_cÚfig
(
l
);

1262 
jsÚ
.
d©a
 = 
	`luaL_checkl¡ršg
(
l
, 1, &
jsÚ_Ën
);

1263 
jsÚ
.
cu¼’t_d•th
 = 0;

1264 
jsÚ
.
±r
 = jsÚ.
d©a
;

1271 ià(
jsÚ_Ën
 >ğ2 && (!
jsÚ
.
d©a
[0] || !json.data[1]))

1272 
	`luaL_”rÜ
(
l
, "JSON…arser does‚ot support UTF-16 or UTF-32");

1277 
jsÚ
.
tmp
 = 
	`¡rbuf_Ãw
(
jsÚ_Ën
);

1279 
	`jsÚ_Ãxt_tok’
(&
jsÚ
, &
tok’
);

1280 
	`jsÚ_´oûss_v®ue
(
l
, &
jsÚ
, &
tok’
);

1283 
	`jsÚ_Ãxt_tok’
(&
jsÚ
, &
tok’
);

1285 ià(
tok’
.
ty³
 !ğ
T_END
)

1286 
	`jsÚ_throw_·r£_”rÜ
(
l
, &
jsÚ
, "th’d", &
tok’
);

1288 
	`¡rbuf_ä“
(
jsÚ
.
tmp
);

1291 
	}
}

1295 #ià!
defšed
(
LUA_VERSION_NUM
) || LUA_VERSION_NUM < 502

1300 
	$luaL_£tfuncs
 (
lua_S‹
 *
l
, cÚ¡ 
luaL_Reg
 *
»g
, 
nup
)

1302 
i
;

1304 
	`luaL_check¡ack
(
l
, 
nup
, "too many upvalues");

1305 ; 
»g
->
Çme
 !ğ
NULL
;„eg++) {

1306 
i
 = 0; i < 
nup
; i++)

1307 
	`lua_pushv®ue
(
l
, -
nup
);

1308 
	`lua_pushcşosu»
(
l
, 
»g
->
func
, 
nup
);

1309 
	`lua_£tf›ld
(
l
, -(
nup
 + 2), 
»g
->
Çme
);

1311 
	`lua_pİ
(
l
, 
nup
);

1312 
	}
}

1318 
	$jsÚ_´Ùeù_cÚv”siÚ
(
lua_S‹
 *
l
)

1320 
”r
;

1323 
	`luaL_¬gcheck
(
l
, 
	`lua_g‘tİ
(l) == 1, 1, "expected 1‡rgument");

1326 
	`lua_pushv®ue
(
l
, 
	`lua_upv®uešdex
(1));

1327 
	`lua_š£¹
(
l
, 1);

1328 
”r
 = 
	`lua_pÿÎ
(
l
, 1, 1, 0);

1329 ià(!
”r
)

1332 ià(
”r
 =ğ
LUA_ERRRUN
) {

1333 
	`lua_pushn
(
l
);

1334 
	`lua_š£¹
(
l
, -2);

1340  
	`luaL_”rÜ
(
l
, "Memory‡llocationƒrror in CJSON…rotected call");

1341 
	}
}

1344 
	$lua_cjsÚ_Ãw
(
lua_S‹
 *
l
)

1346 
luaL_Reg
 
»g
[] = {

1347 { "’code", 
jsÚ_’code
 },

1348 { "decode", 
jsÚ_decode
 },

1349 { "’code_¥¬£_¬¿y", 
jsÚ_cfg_’code_¥¬£_¬¿y
 },

1350 { "’code_max_d•th", 
jsÚ_cfg_’code_max_d•th
 },

1351 { "decode_max_d•th", 
jsÚ_cfg_decode_max_d•th
 },

1352 { "’code_numb”_´ecisiÚ", 
jsÚ_cfg_’code_numb”_´ecisiÚ
 },

1353 { "’code_k“p_bufãr", 
jsÚ_cfg_’code_k“p_bufãr
 },

1354 { "’code_šv®id_numb”s", 
jsÚ_cfg_’code_šv®id_numb”s
 },

1355 { "decode_šv®id_numb”s", 
jsÚ_cfg_decode_šv®id_numb”s
 },

1356 { "Ãw", 
lua_cjsÚ_Ãw
 },

1357 { 
NULL
, NULL }

1361 
	`åcÚv_š™
();

1364 
	`lua_ÃwbË
(
l
);

1367 
	`jsÚ_ü—‹_cÚfig
(
l
);

1368 
	`luaL_£tfuncs
(
l
, 
»g
, 1);

1371 
	`lua_pushlightu£rd©a
(
l
, 
NULL
);

1372 
	`lua_£tf›ld
(
l
, -2, "null");

1375 
	`lua_pushl™”®
(
l
, 
CJSON_MODNAME
);

1376 
	`lua_£tf›ld
(
l
, -2, "_NAME");

1377 
	`lua_pushl™”®
(
l
, 
CJSON_VERSION
);

1378 
	`lua_£tf›ld
(
l
, -2, "_VERSION");

1381 
	}
}

1384 
	$lua_cjsÚ_§ã_Ãw
(
lua_S‹
 *
l
)

1386 cÚ¡ *
func
[] = { "decode", "’code", 
NULL
 };

1387 
i
;

1389 
	`lua_cjsÚ_Ãw
(
l
);

1392 
	`lua_pushcfunùiÚ
(
l
, 
lua_cjsÚ_§ã_Ãw
);

1393 
	`lua_£tf›ld
(
l
, -2, "new");

1395 
i
 = 0; 
func
[i]; i++) {

1396 
	`lua_g‘f›ld
(
l
, -1, 
func
[
i
]);

1397 
	`lua_pushcşosu»
(
l
, 
jsÚ_´Ùeù_cÚv”siÚ
, 1);

1398 
	`lua_£tf›ld
(
l
, -2, 
func
[
i
]);

1402 
	}
}

1404 
	$luaİ’_cjsÚ
(
lua_S‹
 *
l
)

1406 
	`lua_cjsÚ_Ãw
(
l
);

1408 #ifdeà
ENABLE_CJSON_GLOBAL


1410 
	`lua_pushv®ue
(
l
, -1);

1411 
	`lua_£tglob®
(
l
, 
CJSON_MODNAME
);

1416 
	}
}

1418 
	$luaİ’_cjsÚ_§ã
(
lua_S‹
 *
l
)

1420 
	`lua_cjsÚ_§ã_Ãw
(
l
);

1424 
	}
}

	@deps/lua/src/lua_cmsgpack.c

1 
	~<m©h.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dšt.h
>

4 
	~<¡ršg.h
>

5 
	~<as£¹.h
>

7 
	~"lua.h
"

8 
	~"Ïuxlib.h
"

10 
	#LUACMSGPACK_NAME
 "cmsg·ck"

	)

11 
	#LUACMSGPACK_SAFE_NAME
 "cmsg·ck_§ã"

	)

12 
	#LUACMSGPACK_VERSION
 "lua-cmsg·ck 0.4.0"

	)

13 
	#LUACMSGPACK_COPYRIGHT
 "Cİyrighˆ(Cè2012, S®v©ÜSªfpo"

	)

14 
	#LUACMSGPACK_DESCRIPTION
 "Mes§gePack C im¶em’tiÚ fÜ Lua"

	)

17 #iâdeà
LUACMSGPACK_MAX_NESTING


18 
	#LUACMSGPACK_MAX_NESTING
 16

	)

22 
	#IS_INT_TYPE_EQUIVALENT
(
x
, 
T
è(!
	`isšf
(xè&& (T)(xè=ğ(x))

	)

24 
	#IS_INT64_EQUIVALENT
(
x
è
	`IS_INT_TYPE_EQUIVALENT
(x, 
št64_t
)

	)

25 
	#IS_INT_EQUIVALENT
(
x
è
	`IS_INT_TYPE_EQUIVALENT
(x, )

	)

28 #ià
UINTPTR_MAX
 =ğ
UINT_MAX


29 
	#BITS_32
 1

	)

31 
	#BITS_32
 0

	)

34 #ià
BITS_32


35 
	#lua_pushunsigÃd
(
L
, 
n
è
	`lua_pushnumb”
(L,‚)

	)

37 
	#lua_pushunsigÃd
(
L
, 
n
è
	`lua_pushš‹g”
(L,‚)

	)

69 
	$mem»viæe
(*
±r
, 
size_t
 
Ën
) {

70 *
p
 = (*)
±r
,

71 *
e
 = (*)
p
+
Ën
-1,

72 
aux
;

73 
‹¡
 = 1;

74 *
‹¡p
 = (*è&
‹¡
;

76 ià(
‹¡p
[0] == 0) ;

77 
Ën
 /= 2;

78 
Ën
--) {

79 
aux
 = *
p
;

80 *
p
 = *
e
;

81 *
e
 = 
aux
;

82 
p
++;

83 
e
--;

85 
	}
}

93 
	smp_buf
 {

94 *
	mb
;

95 
size_t
 
	mËn
, 
	mä“
;

96 } 
	tmp_buf
;

98 *
	$mp_»®loc
(
lua_S‹
 *
L
, *
rg‘
, 
size_t
 
osize
,size_ˆ
nsize
) {

99 *(*
loÿl_»®loc
è(*, *, 
size_t
 
osize
, size_ˆ
nsize
èğ
NULL
;

100 *
ud
;

102 
loÿl_»®loc
 = 
	`lua_g‘®locf
(
L
, &
ud
);

104  
	`loÿl_»®loc
(
ud
, 
rg‘
, 
osize
, 
nsize
);

105 
	}
}

107 
mp_buf
 *
	$mp_buf_Ãw
(
lua_S‹
 *
L
) {

108 
mp_buf
 *
buf
 = 
NULL
;

111 
buf
 = (
mp_buf
*)
	`mp_»®loc
(
L
, 
NULL
, 0, (*buf));

113 
buf
->
b
 = 
NULL
;

114 
buf
->
Ën
 = buf->
ä“
 = 0;

115  
buf
;

116 
	}
}

118 
	$mp_buf_­³nd
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
, cÚ¡ *
s
, 
size_t
 
Ën
) {

119 ià(
buf
->
ä“
 < 
Ën
) {

120 
size_t
 
Ãwsize
 = (
buf
->
Ën
+len)*2;

122 
buf
->
b
 = (*)
	`mp_»®loc
(
L
, buf->b, buf->
Ën
 + buf->
ä“
, 
Ãwsize
);

123 
buf
->
ä“
 = 
Ãwsize
 - buf->
Ën
;

125 
	`memıy
(
buf
->
b
+buf->
Ën
,
s
,len);

126 
buf
->
Ën
 +=†en;

127 
buf
->
ä“
 -ğ
Ën
;

128 
	}
}

130 
	$mp_buf_ä“
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
) {

131 
	`mp_»®loc
(
L
, 
buf
->
b
, buf->
Ën
 + buf->
ä“
, 0);

132 
	`mp_»®loc
(
L
, 
buf
, (*buf), 0);

133 
	}
}

144 
	#MP_CUR_ERROR_NONE
 0

	)

145 
	#MP_CUR_ERROR_EOF
 1

	)

146 
	#MP_CUR_ERROR_BADFMT
 2

	)

148 
	smp_cur
 {

149 cÚ¡ *
	mp
;

150 
size_t
 
	mËá
;

151 
	m”r
;

152 } 
	tmp_cur
;

154 
	$mp_cur_š™
(
mp_cur
 *
cursÜ
, cÚ¡ *
s
, 
size_t
 
Ën
) {

155 
cursÜ
->
p
 = 
s
;

156 
cursÜ
->
Ëá
 = 
Ën
;

157 
cursÜ
->
”r
 = 
MP_CUR_ERROR_NONE
;

158 
	}
}

160 
	#mp_cur_cÚsume
(
_c
,
_Ën
èdØ{ _c->
p
 +ğ_Ën; _c->
Ëá
 -ğ_Ën; } 0)

	)

165 
	#mp_cur_Ãed
(
_c
,
_Ën
) do { \

166 ià(
_c
->
Ëá
 < 
_Ën
) { \

167 
_c
->
”r
 = 
MP_CUR_ERROR_EOF
; \

170 } 0)

	)

174 
	$mp_’code_by‹s
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
, cÚ¡ *
s
, 
size_t
 
Ën
) {

175 
hdr
[5];

176 
hd¾’
;

178 ià(
Ën
 < 32) {

179 
hdr
[0] = 0xa0 | (
Ën
&0xff);

180 
hd¾’
 = 1;

181 } ià(
Ën
 <= 0xff) {

182 
hdr
[0] = 0xd9;

183 
hdr
[1] = 
Ën
;

184 
hd¾’
 = 2;

185 } ià(
Ën
 <= 0xffff) {

186 
hdr
[0] = 0xda;

187 
hdr
[1] = (
Ën
&0xff00)>>8;

188 
hdr
[2] = 
Ën
&0xff;

189 
hd¾’
 = 3;

191 
hdr
[0] = 0xdb;

192 
hdr
[1] = (
Ën
&0xff000000)>>24;

193 
hdr
[2] = (
Ën
&0xff0000)>>16;

194 
hdr
[3] = (
Ën
&0xff00)>>8;

195 
hdr
[4] = 
Ën
&0xff;

196 
hd¾’
 = 5;

198 
	`mp_buf_­³nd
(
L
,
buf
,
hdr
,
hd¾’
);

199 
	`mp_buf_­³nd
(
L
,
buf
,
s
,
Ën
);

200 
	}
}

203 
	$mp_’code_doubË
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
, 
d
) {

204 
b
[9];

205 
f
 = 
d
;

207 
	`as£¹
((
f
è=ğ4 && (
d
) == 8);

208 ià(
d
 =ğ()
f
) {

209 
b
[0] = 0xca;

210 
	`memıy
(
b
+1,&
f
,4);

211 
	`mem»viæe
(
b
+1,4);

212 
	`mp_buf_­³nd
(
L
,
buf
,
b
,5);

213 } ià((
d
) == 8) {

214 
b
[0] = 0xcb;

215 
	`memıy
(
b
+1,&
d
,8);

216 
	`mem»viæe
(
b
+1,8);

217 
	`mp_buf_­³nd
(
L
,
buf
,
b
,9);

219 
	}
}

221 
	$mp_’code_št
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
, 
št64_t
 
n
) {

222 
b
[9];

223 
’ş’
;

225 ià(
n
 >= 0) {

226 ià(
n
 <= 127) {

227 
b
[0] = 
n
 & 0x7f;

228 
’ş’
 = 1;

229 } ià(
n
 <= 0xff) {

230 
b
[0] = 0xcc;

231 
b
[1] = 
n
 & 0xff;

232 
’ş’
 = 2;

233 } ià(
n
 <= 0xffff) {

234 
b
[0] = 0xcd;

235 
b
[1] = (
n
 & 0xff00) >> 8;

236 
b
[2] = 
n
 & 0xff;

237 
’ş’
 = 3;

238 } ià(
n
 <= 0xffffffffLL) {

239 
b
[0] = 0xce;

240 
b
[1] = (
n
 & 0xff000000) >> 24;

241 
b
[2] = (
n
 & 0xff0000) >> 16;

242 
b
[3] = (
n
 & 0xff00) >> 8;

243 
b
[4] = 
n
 & 0xff;

244 
’ş’
 = 5;

246 
b
[0] = 0xcf;

247 
b
[1] = (
n
 & 0xff00000000000000LL) >> 56;

248 
b
[2] = (
n
 & 0xff000000000000LL) >> 48;

249 
b
[3] = (
n
 & 0xff0000000000LL) >> 40;

250 
b
[4] = (
n
 & 0xff00000000LL) >> 32;

251 
b
[5] = (
n
 & 0xff000000) >> 24;

252 
b
[6] = (
n
 & 0xff0000) >> 16;

253 
b
[7] = (
n
 & 0xff00) >> 8;

254 
b
[8] = 
n
 & 0xff;

255 
’ş’
 = 9;

258 ià(
n
 >= -32) {

259 
b
[0] = ((sigÃd )
n
);

260 
’ş’
 = 1;

261 } ià(
n
 >= -128) {

262 
b
[0] = 0xd0;

263 
b
[1] = 
n
 & 0xff;

264 
’ş’
 = 2;

265 } ià(
n
 >= -32768) {

266 
b
[0] = 0xd1;

267 
b
[1] = (
n
 & 0xff00) >> 8;

268 
b
[2] = 
n
 & 0xff;

269 
’ş’
 = 3;

270 } ià(
n
 >= -2147483648LL) {

271 
b
[0] = 0xd2;

272 
b
[1] = (
n
 & 0xff000000) >> 24;

273 
b
[2] = (
n
 & 0xff0000) >> 16;

274 
b
[3] = (
n
 & 0xff00) >> 8;

275 
b
[4] = 
n
 & 0xff;

276 
’ş’
 = 5;

278 
b
[0] = 0xd3;

279 
b
[1] = (
n
 & 0xff00000000000000LL) >> 56;

280 
b
[2] = (
n
 & 0xff000000000000LL) >> 48;

281 
b
[3] = (
n
 & 0xff0000000000LL) >> 40;

282 
b
[4] = (
n
 & 0xff00000000LL) >> 32;

283 
b
[5] = (
n
 & 0xff000000) >> 24;

284 
b
[6] = (
n
 & 0xff0000) >> 16;

285 
b
[7] = (
n
 & 0xff00) >> 8;

286 
b
[8] = 
n
 & 0xff;

287 
’ş’
 = 9;

290 
	`mp_buf_­³nd
(
L
,
buf
,
b
,
’ş’
);

291 
	}
}

293 
	$mp_’code_¬¿y
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
, 
št64_t
 
n
) {

294 
b
[5];

295 
’ş’
;

297 ià(
n
 <= 15) {

298 
b
[0] = 0x90 | (
n
 & 0xf);

299 
’ş’
 = 1;

300 } ià(
n
 <= 65535) {

301 
b
[0] = 0xdc;

302 
b
[1] = (
n
 & 0xff00) >> 8;

303 
b
[2] = 
n
 & 0xff;

304 
’ş’
 = 3;

306 
b
[0] = 0xdd;

307 
b
[1] = (
n
 & 0xff000000) >> 24;

308 
b
[2] = (
n
 & 0xff0000) >> 16;

309 
b
[3] = (
n
 & 0xff00) >> 8;

310 
b
[4] = 
n
 & 0xff;

311 
’ş’
 = 5;

313 
	`mp_buf_­³nd
(
L
,
buf
,
b
,
’ş’
);

314 
	}
}

316 
	$mp_’code_m­
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
, 
št64_t
 
n
) {

317 
b
[5];

318 
’ş’
;

320 ià(
n
 <= 15) {

321 
b
[0] = 0x80 | (
n
 & 0xf);

322 
’ş’
 = 1;

323 } ià(
n
 <= 65535) {

324 
b
[0] = 0xde;

325 
b
[1] = (
n
 & 0xff00) >> 8;

326 
b
[2] = 
n
 & 0xff;

327 
’ş’
 = 3;

329 
b
[0] = 0xdf;

330 
b
[1] = (
n
 & 0xff000000) >> 24;

331 
b
[2] = (
n
 & 0xff0000) >> 16;

332 
b
[3] = (
n
 & 0xff00) >> 8;

333 
b
[4] = 
n
 & 0xff;

334 
’ş’
 = 5;

336 
	`mp_buf_­³nd
(
L
,
buf
,
b
,
’ş’
);

337 
	}
}

341 
	$mp_’code_lua_¡ršg
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
) {

342 
size_t
 
Ën
;

343 cÚ¡ *
s
;

345 
s
 = 
	`lua_tŞ¡ršg
(
L
,-1,&
Ën
);

346 
	`mp_’code_by‹s
(
L
,
buf
,(cÚ¡ *)
s
,
Ën
);

347 
	}
}

349 
	$mp_’code_lua_boŞ
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
) {

350 
b
 = 
	`lua_toboŞ—n
(
L
,-1) ? 0xc3 : 0xc2;

351 
	`mp_buf_­³nd
(
L
,
buf
,&
b
,1);

352 
	}
}

355 
	$mp_’code_lua_š‹g”
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
) {

356 #ià(
LUA_VERSION_NUM
 < 503è&& 
BITS_32


357 
lua_Numb”
 
i
 = 
	`lua_tÚumb”
(
L
,-1);

359 
lua_IÁeg”
 
i
 = 
	`lua_toš‹g”
(
L
,-1);

361 
	`mp_’code_št
(
L
, 
buf
, (
št64_t
)
i
);

362 
	}
}

367 
	$mp_’code_lua_numb”
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
) {

368 
lua_Numb”
 
n
 = 
	`lua_tÚumb”
(
L
,-1);

370 ià(
	`IS_INT64_EQUIVALENT
(
n
)) {

371 
	`mp_’code_lua_š‹g”
(
L
, 
buf
);

373 
	`mp_’code_doubË
(
L
,
buf
,()
n
);

375 
	}
}

377 
mp_’code_lua_ty³
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
, 
Ëv–
);

380 
	$mp_’code_lua_bË_as_¬¿y
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
, 
Ëv–
) {

381 #ià
LUA_VERSION_NUM
 < 502

382 
size_t
 
Ën
 = 
	`lua_objËn
(
L
,-1), 
j
;

384 
size_t
 
Ën
 = 
	`lua_¿wËn
(
L
,-1), 
j
;

387 
	`mp_’code_¬¿y
(
L
,
buf
,
Ën
);

388 
	`luaL_check¡ack
(
L
, 1, "in function mp_encode_lua_table_as_array");

389 
j
 = 1; j <ğ
Ën
; j++) {

390 
	`lua_pushnumb”
(
L
,
j
);

391 
	`lua_g‘bË
(
L
,-2);

392 
	`mp_’code_lua_ty³
(
L
,
buf
,
Ëv–
+1);

394 
	}
}

397 
	$mp_’code_lua_bË_as_m­
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
, 
Ëv–
) {

398 
size_t
 
Ën
 = 0;

404 
	`luaL_check¡ack
(
L
, 3, "in function mp_encode_lua_table_as_map");

405 
	`lua_pushn
(
L
);

406 
	`lua_Ãxt
(
L
,-2)) {

407 
	`lua_pİ
(
L
,1);

408 
Ën
++;

412 
	`mp_’code_m­
(
L
,
buf
,
Ën
);

413 
	`lua_pushn
(
L
);

414 
	`lua_Ãxt
(
L
,-2)) {

416 
	`lua_pushv®ue
(
L
,-2);

417 
	`mp_’code_lua_ty³
(
L
,
buf
,
Ëv–
+1);

418 
	`mp_’code_lua_ty³
(
L
,
buf
,
Ëv–
+1);

420 
	}
}

425 
	$bË_is_ª_¬¿y
(
lua_S‹
 *
L
) {

426 
couÁ
 = 0, 
max
 = 0;

427 #ià
LUA_VERSION_NUM
 < 503

428 
lua_Numb”
 
n
;

430 
lua_IÁeg”
 
n
;

434 
¡acktİ
;

436 
¡acktİ
 = 
	`lua_g‘tİ
(
L
);

438 
	`lua_pushn
(
L
);

439 
	`lua_Ãxt
(
L
,-2)) {

441 
	`lua_pİ
(
L
,1);

443 #ià
LUA_VERSION_NUM
 < 503

444 ià((
LUA_TNUMBER
 !ğ
	`lua_ty³
(
L
,-1)è|| (
n
 = 
	`lua_tÚumb”
(L, -1)) <= 0 ||

445 !
	`IS_INT_EQUIVALENT
(
n
))

447 ià(!
	`lua_isš‹g”
(
L
,-1è|| (
n
 = 
	`lua_toš‹g”
(L, -1)) <= 0)

450 
	`lua_£‰İ
(
L
, 
¡acktİ
);

453 
max
 = (
n
 > max ?‚ : max);

454 
couÁ
++;

461 
	`lua_£‰İ
(
L
, 
¡acktİ
);

462  
max
 =ğ
couÁ
;

463 
	}
}

468 
	$mp_’code_lua_bË
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
, 
Ëv–
) {

469 ià(
	`bË_is_ª_¬¿y
(
L
))

470 
	`mp_’code_lua_bË_as_¬¿y
(
L
,
buf
,
Ëv–
);

472 
	`mp_’code_lua_bË_as_m­
(
L
,
buf
,
Ëv–
);

473 
	}
}

475 
	$mp_’code_lua_nuÎ
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
) {

476 
b
[1];

478 
b
[0] = 0xc0;

479 
	`mp_buf_­³nd
(
L
,
buf
,
b
,1);

480 
	}
}

482 
	$mp_’code_lua_ty³
(
lua_S‹
 *
L
, 
mp_buf
 *
buf
, 
Ëv–
) {

483 
t
 = 
	`lua_ty³
(
L
,-1);

487 ià(
t
 =ğ
LUA_TTABLE
 && 
Ëv–
 =ğ
LUACMSGPACK_MAX_NESTING
èˆğ
LUA_TNIL
;

488 
t
) {

489 
LUA_TSTRING
: 
	`mp_’code_lua_¡ršg
(
L
,
buf
); ;

490 
LUA_TBOOLEAN
: 
	`mp_’code_lua_boŞ
(
L
,
buf
); ;

491 
LUA_TNUMBER
:

492 #ià
LUA_VERSION_NUM
 < 503

493 
	`mp_’code_lua_numb”
(
L
,
buf
); ;

495 ià(
	`lua_isš‹g”
(
L
, -1)) {

496 
	`mp_’code_lua_š‹g”
(
L
, 
buf
);

498 
	`mp_’code_lua_numb”
(
L
, 
buf
);

502 
LUA_TTABLE
: 
	`mp_’code_lua_bË
(
L
,
buf
,
Ëv–
); ;

503 : 
	`mp_’code_lua_nuÎ
(
L
,
buf
); ;

505 
	`lua_pİ
(
L
,1);

506 
	}
}

512 
	$mp_·ck
(
lua_S‹
 *
L
) {

513 
Çrgs
 = 
	`lua_g‘tİ
(
L
);

514 
i
;

515 
mp_buf
 *
buf
;

517 ià(
Çrgs
 == 0)

518  
	`luaL_¬g”rÜ
(
L
, 0, "MessagePack…ack‚eeds input.");

520 ià(!
	`lua_check¡ack
(
L
, 
Çrgs
))

521  
	`luaL_¬g”rÜ
(
L
, 0, "Too many‡rguments for MessagePack…ack.");

523 
buf
 = 
	`mp_buf_Ãw
(
L
);

524 
i
 = 1; i <ğ
Çrgs
; i++) {

527 
	`luaL_check¡ack
(
L
, 1, "in function mp_check");

528 
	`lua_pushv®ue
(
L
, 
i
);

530 
	`mp_’code_lua_ty³
(
L
,
buf
,0);

532 
	`lua_pushl¡ršg
(
L
,(*)
buf
->
b
,buf->
Ën
);

537 
buf
->
ä“
 +ğbuf->
Ën
;

538 
buf
->
Ën
 = 0;

540 
	`mp_buf_ä“
(
L
, 
buf
);

543 
	`lua_cÚÿt
(
L
, 
Çrgs
);

545 
	}
}

549 
mp_decode_to_lua_ty³
(
lua_S‹
 *
L
, 
mp_cur
 *
c
);

551 
	$mp_decode_to_lua_¬¿y
(
lua_S‹
 *
L
, 
mp_cur
 *
c
, 
size_t
 
Ën
) {

552 
	`as£¹
(
Ën
 <ğ
UINT_MAX
);

553 
šdex
 = 1;

555 
	`lua_ÃwbË
(
L
);

556 
	`luaL_check¡ack
(
L
, 1, "in function mp_decode_to_lua_array");

557 
Ën
--) {

558 
	`lua_pushnumb”
(
L
,
šdex
++);

559 
	`mp_decode_to_lua_ty³
(
L
,
c
);

560 ià(
c
->
”r
) ;

561 
	`lua_£‰abË
(
L
,-3);

563 
	}
}

565 
	$mp_decode_to_lua_hash
(
lua_S‹
 *
L
, 
mp_cur
 *
c
, 
size_t
 
Ën
) {

566 
	`as£¹
(
Ën
 <ğ
UINT_MAX
);

567 
	`lua_ÃwbË
(
L
);

568 
Ën
--) {

569 
	`mp_decode_to_lua_ty³
(
L
,
c
);

570 ià(
c
->
”r
) ;

571 
	`mp_decode_to_lua_ty³
(
L
,
c
);

572 ià(
c
->
”r
) ;

573 
	`lua_£‰abË
(
L
,-3);

575 
	}
}

579 
	$mp_decode_to_lua_ty³
(
lua_S‹
 *
L
, 
mp_cur
 *
c
) {

580 
	`mp_cur_Ãed
(
c
,1);

587 
	`luaL_check¡ack
(
L
, 1,

591 
c
->
p
[0]) {

593 
	`mp_cur_Ãed
(
c
,2);

594 
	`lua_pushunsigÃd
(
L
,
c
->
p
[1]);

595 
	`mp_cur_cÚsume
(
c
,2);

598 
	`mp_cur_Ãed
(
c
,2);

599 
	`lua_pushš‹g”
(
L
,(sigÃd )
c
->
p
[1]);

600 
	`mp_cur_cÚsume
(
c
,2);

603 
	`mp_cur_Ãed
(
c
,3);

604 
	`lua_pushunsigÃd
(
L
,

605 (
c
->
p
[1] << 8) |

606 
c
->
p
[2]);

607 
	`mp_cur_cÚsume
(
c
,3);

610 
	`mp_cur_Ãed
(
c
,3);

611 
	`lua_pushš‹g”
(
L
,(
št16_t
)

612 (
c
->
p
[1] << 8) |

613 
c
->
p
[2]);

614 
	`mp_cur_cÚsume
(
c
,3);

617 
	`mp_cur_Ãed
(
c
,5);

618 
	`lua_pushunsigÃd
(
L
,

619 ((
ušt32_t
)
c
->
p
[1] << 24) |

620 ((
ušt32_t
)
c
->
p
[2] << 16) |

621 ((
ušt32_t
)
c
->
p
[3] << 8) |

622 (
ušt32_t
)
c
->
p
[4]);

623 
	`mp_cur_cÚsume
(
c
,5);

626 
	`mp_cur_Ãed
(
c
,5);

627 
	`lua_pushš‹g”
(
L
,

628 ((
št32_t
)
c
->
p
[1] << 24) |

629 ((
št32_t
)
c
->
p
[2] << 16) |

630 ((
št32_t
)
c
->
p
[3] << 8) |

631 (
št32_t
)
c
->
p
[4]);

632 
	`mp_cur_cÚsume
(
c
,5);

635 
	`mp_cur_Ãed
(
c
,9);

636 
	`lua_pushunsigÃd
(
L
,

637 ((
ušt64_t
)
c
->
p
[1] << 56) |

638 ((
ušt64_t
)
c
->
p
[2] << 48) |

639 ((
ušt64_t
)
c
->
p
[3] << 40) |

640 ((
ušt64_t
)
c
->
p
[4] << 32) |

641 ((
ušt64_t
)
c
->
p
[5] << 24) |

642 ((
ušt64_t
)
c
->
p
[6] << 16) |

643 ((
ušt64_t
)
c
->
p
[7] << 8) |

644 (
ušt64_t
)
c
->
p
[8]);

645 
	`mp_cur_cÚsume
(
c
,9);

648 
	`mp_cur_Ãed
(
c
,9);

649 #ià
LUA_VERSION_NUM
 < 503

650 
	`lua_pushnumb”
(
L
,

652 
	`lua_pushš‹g”
(
L
,

654 ((
št64_t
)
c
->
p
[1] << 56) |

655 ((
št64_t
)
c
->
p
[2] << 48) |

656 ((
št64_t
)
c
->
p
[3] << 40) |

657 ((
št64_t
)
c
->
p
[4] << 32) |

658 ((
št64_t
)
c
->
p
[5] << 24) |

659 ((
št64_t
)
c
->
p
[6] << 16) |

660 ((
št64_t
)
c
->
p
[7] << 8) |

661 (
št64_t
)
c
->
p
[8]);

662 
	`mp_cur_cÚsume
(
c
,9);

665 
	`lua_pushn
(
L
);

666 
	`mp_cur_cÚsume
(
c
,1);

669 
	`lua_pushboŞ—n
(
L
,1);

670 
	`mp_cur_cÚsume
(
c
,1);

673 
	`lua_pushboŞ—n
(
L
,0);

674 
	`mp_cur_cÚsume
(
c
,1);

677 
	`mp_cur_Ãed
(
c
,5);

678 
	`as£¹
(() == 4);

680 
f
;

681 
	`memıy
(&
f
,
c
->
p
+1,4);

682 
	`mem»viæe
(&
f
,4);

683 
	`lua_pushnumb”
(
L
,
f
);

684 
	`mp_cur_cÚsume
(
c
,5);

688 
	`mp_cur_Ãed
(
c
,9);

689 
	`as£¹
(() == 8);

691 
d
;

692 
	`memıy
(&
d
,
c
->
p
+1,8);

693 
	`mem»viæe
(&
d
,8);

694 
	`lua_pushnumb”
(
L
,
d
);

695 
	`mp_cur_cÚsume
(
c
,9);

699 
	`mp_cur_Ãed
(
c
,2);

701 
size_t
 
l
 = 
c
->
p
[1];

702 
	`mp_cur_Ãed
(
c
,2+
l
);

703 
	`lua_pushl¡ršg
(
L
,(*)
c
->
p
+2,
l
);

704 
	`mp_cur_cÚsume
(
c
,2+
l
);

708 
	`mp_cur_Ãed
(
c
,3);

710 
size_t
 
l
 = (
c
->
p
[1] << 8) | c->p[2];

711 
	`mp_cur_Ãed
(
c
,3+
l
);

712 
	`lua_pushl¡ršg
(
L
,(*)
c
->
p
+3,
l
);

713 
	`mp_cur_cÚsume
(
c
,3+
l
);

717 
	`mp_cur_Ãed
(
c
,5);

719 
size_t
 
l
 = ((size_t)
c
->
p
[1] << 24) |

720 ((
size_t
)
c
->
p
[2] << 16) |

721 ((
size_t
)
c
->
p
[3] << 8) |

722 (
size_t
)
c
->
p
[4];

723 
	`mp_cur_cÚsume
(
c
,5);

724 
	`mp_cur_Ãed
(
c
,
l
);

725 
	`lua_pushl¡ršg
(
L
,(*)
c
->
p
,
l
);

726 
	`mp_cur_cÚsume
(
c
,
l
);

730 
	`mp_cur_Ãed
(
c
,3);

732 
size_t
 
l
 = (
c
->
p
[1] << 8) | c->p[2];

733 
	`mp_cur_cÚsume
(
c
,3);

734 
	`mp_decode_to_lua_¬¿y
(
L
,
c
,
l
);

738 
	`mp_cur_Ãed
(
c
,5);

740 
size_t
 
l
 = ((size_t)
c
->
p
[1] << 24) |

741 ((
size_t
)
c
->
p
[2] << 16) |

742 ((
size_t
)
c
->
p
[3] << 8) |

743 (
size_t
)
c
->
p
[4];

744 
	`mp_cur_cÚsume
(
c
,5);

745 
	`mp_decode_to_lua_¬¿y
(
L
,
c
,
l
);

749 
	`mp_cur_Ãed
(
c
,3);

751 
size_t
 
l
 = (
c
->
p
[1] << 8) | c->p[2];

752 
	`mp_cur_cÚsume
(
c
,3);

753 
	`mp_decode_to_lua_hash
(
L
,
c
,
l
);

757 
	`mp_cur_Ãed
(
c
,5);

759 
size_t
 
l
 = ((size_t)
c
->
p
[1] << 24) |

760 ((
size_t
)
c
->
p
[2] << 16) |

761 ((
size_t
)
c
->
p
[3] << 8) |

762 (
size_t
)
c
->
p
[4];

763 
	`mp_cur_cÚsume
(
c
,5);

764 
	`mp_decode_to_lua_hash
(
L
,
c
,
l
);

768 ià((
c
->
p
[0] & 0x80) == 0) {

769 
	`lua_pushunsigÃd
(
L
,
c
->
p
[0]);

770 
	`mp_cur_cÚsume
(
c
,1);

771 } ià((
c
->
p
[0] & 0xe0) == 0xe0) {

772 
	`lua_pushš‹g”
(
L
,(sigÃd )
c
->
p
[0]);

773 
	`mp_cur_cÚsume
(
c
,1);

774 } ià((
c
->
p
[0] & 0xe0) == 0xa0) {

775 
size_t
 
l
 = 
c
->
p
[0] & 0x1f;

776 
	`mp_cur_Ãed
(
c
,1+
l
);

777 
	`lua_pushl¡ršg
(
L
,(*)
c
->
p
+1,
l
);

778 
	`mp_cur_cÚsume
(
c
,1+
l
);

779 } ià((
c
->
p
[0] & 0xf0) == 0x90) {

780 
size_t
 
l
 = 
c
->
p
[0] & 0xf;

781 
	`mp_cur_cÚsume
(
c
,1);

782 
	`mp_decode_to_lua_¬¿y
(
L
,
c
,
l
);

783 } ià((
c
->
p
[0] & 0xf0) == 0x80) {

784 
size_t
 
l
 = 
c
->
p
[0] & 0xf;

785 
	`mp_cur_cÚsume
(
c
,1);

786 
	`mp_decode_to_lua_hash
(
L
,
c
,
l
);

788 
c
->
”r
 = 
MP_CUR_ERROR_BADFMT
;

791 
	}
}

793 
	$mp_uÅack_fuÎ
(
lua_S‹
 *
L
, 
lim™
, 
off£t
) {

794 
size_t
 
Ën
;

795 cÚ¡ *
s
;

796 
mp_cur
 
c
;

797 
út
;

798 
decode_®l
 = (!
lim™
 && !
off£t
);

800 
s
 = 
	`luaL_checkl¡ršg
(
L
,1,&
Ën
);

802 ià(
off£t
 < 0 || 
lim™
 < 0)

803  
	`luaL_”rÜ
(
L
,

805 
off£t
, 
Ën
);

806 ià(
off£t
 > 
Ën
)

807  
	`luaL_”rÜ
(
L
,

808 "S¹ off£ˆ%d g»©”hª iÅuˆËngth %d.", 
off£t
, 
Ën
);

810 ià(
decode_®l
è
lim™
 = 
INT_MAX
;

812 
	`mp_cur_š™
(&
c
,(cÚ¡ *)
s
+
off£t
,
Ën
-offset);

816 
út
 = 0; 
c
.
Ëá
 > 0 && cÁ < 
lim™
; cnt++) {

817 
	`mp_decode_to_lua_ty³
(
L
,&
c
);

819 ià(
c
.
”r
 =ğ
MP_CUR_ERROR_EOF
) {

820  
	`luaL_”rÜ
(
L
,"Missing bytes in input.");

821 } ià(
c
.
”r
 =ğ
MP_CUR_ERROR_BADFMT
) {

822  
	`luaL_”rÜ
(
L
,"Bad data format in input.");

826 ià(!
decode_®l
) {

830 
off£t
 = 
Ën
 - 
c
.
Ëá
;

832 
	`luaL_check¡ack
(
L
, 1, "in function mp_unpack_full");

835 
	`lua_pushš‹g”
(
L
, 
c
.
Ëá
 =ğ0 ? -1 : 
off£t
);

842 
	`lua_š£¹
(
L
, 2);

843 
út
 += 1;

846  
út
;

847 
	}
}

849 
	$mp_uÅack
(
lua_S‹
 *
L
) {

850  
	`mp_uÅack_fuÎ
(
L
, 0, 0);

851 
	}
}

853 
	$mp_uÅack_Úe
(
lua_S‹
 *
L
) {

854 
off£t
 = 
	`luaL_İtš‹g”
(
L
, 2, 0);

856 
	`lua_pİ
(
L
, 
	`lua_g‘tİ
(L)-1);

857  
	`mp_uÅack_fuÎ
(
L
, 1, 
off£t
);

858 
	}
}

860 
	$mp_uÅack_lim™
(
lua_S‹
 *
L
) {

861 
lim™
 = 
	`luaL_checkš‹g”
(
L
, 2);

862 
off£t
 = 
	`luaL_İtš‹g”
(
L
, 3, 0);

864 
	`lua_pİ
(
L
, 
	`lua_g‘tİ
(L)-1);

866  
	`mp_uÅack_fuÎ
(
L
, 
lim™
, 
off£t
);

867 
	}
}

869 
	$mp_§ã
(
lua_S‹
 *
L
) {

870 
¬gc
, 
”r
, 
tÙ®_»suÉs
;

872 
¬gc
 = 
	`lua_g‘tİ
(
L
);

876 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(1));

877 
	`lua_š£¹
(
L
, 1);

879 
”r
 = 
	`lua_pÿÎ
(
L
, 
¬gc
, 
LUA_MULTRET
, 0);

880 
tÙ®_»suÉs
 = 
	`lua_g‘tİ
(
L
);

882 ià(!
”r
) {

883  
tÙ®_»suÉs
;

885 
	`lua_pushn
(
L
);

886 
	`lua_š£¹
(
L
,-2);

889 
	}
}

892 cÚ¡ 
luaL_Reg
 
	gcmds
[] = {

893 {"·ck", 
mp_·ck
},

894 {"uÅack", 
mp_uÅack
},

895 {"uÅack_Úe", 
mp_uÅack_Úe
},

896 {"uÅack_lim™", 
mp_uÅack_lim™
},

900 
	$luaİ’_ü—‹
(
lua_S‹
 *
L
) {

901 
i
;

904 
	`lua_ÃwbË
(
L
);

906 
i
 = 0; i < ((
cmds
)/(*cmds) - 1); i++) {

907 
	`lua_pushcfunùiÚ
(
L
, 
cmds
[
i
].
func
);

908 
	`lua_£tf›ld
(
L
, -2, 
cmds
[
i
].
Çme
);

912 
	`lua_pushl™”®
(
L
, 
LUACMSGPACK_NAME
);

913 
	`lua_£tf›ld
(
L
, -2, "_NAME");

914 
	`lua_pushl™”®
(
L
, 
LUACMSGPACK_VERSION
);

915 
	`lua_£tf›ld
(
L
, -2, "_VERSION");

916 
	`lua_pushl™”®
(
L
, 
LUACMSGPACK_COPYRIGHT
);

917 
	`lua_£tf›ld
(
L
, -2, "_COPYRIGHT");

918 
	`lua_pushl™”®
(
L
, 
LUACMSGPACK_DESCRIPTION
);

919 
	`lua_£tf›ld
(
L
, -2, "_DESCRIPTION");

921 
	}
}

923 
LUALIB_API
 
	$luaİ’_cmsg·ck
(
lua_S‹
 *
L
) {

924 
	`luaİ’_ü—‹
(
L
);

926 #ià
LUA_VERSION_NUM
 < 502

928 
	`lua_pushv®ue
(
L
, -1);

929 
	`lua_£tglob®
(
L
, 
LUACMSGPACK_NAME
);

933 
	}
}

935 
LUALIB_API
 
	$luaİ’_cmsg·ck_§ã
(
lua_S‹
 *
L
) {

936 
i
;

938 
	`luaİ’_cmsg·ck
(
L
);

941 
i
 = 0; i < ((
cmds
)/(*cmds) - 1); i++) {

942 
	`lua_g‘f›ld
(
L
, -1, 
cmds
[
i
].
Çme
);

943 
	`lua_pushcşosu»
(
L
, 
mp_§ã
, 1);

944 
	`lua_£tf›ld
(
L
, -2, 
cmds
[
i
].
Çme
);

947 #ià
LUA_VERSION_NUM
 < 502

949 
	`lua_pushv®ue
(
L
, -1);

950 
	`lua_£tglob®
(
L
, 
LUACMSGPACK_SAFE_NAME
);

954 
	}
}

	@deps/lua/src/lua_struct.c

29 
	~<as£¹.h
>

30 
	~<ùy³.h
>

31 
	~<lim™s.h
>

32 
	~<¡ddef.h
>

33 
	~<¡ršg.h
>

36 
	~"lua.h
"

37 
	~"Ïuxlib.h
"

40 #ià(
LUA_VERSION_NUM
 >= 502)

42 
	#luaL_»gi¡”
(
L
,
n
,
f
è
	`luaL_Ãwlib
(L,f)

	)

48 #ià!
defšed
(
STRUCT_INT
)

49 
	#STRUCT_INT
 

	)

52 
STRUCT_INT
 
	tIÁty³
;

55 
	tSTRUCT_INT
 
	tUš‰y³
;

59 
	#MAXINTSIZE
 32

	)

62 
	#i¥2
(
x
è((xè> 0 && ((xè& ((xè- 1)è=ğ0)

	)

65 
	scD
 {

66 
	mc
;

67 
	md
;

71 
	#PADDING
 ((
cD
è- ())

	)

72 
	#MAXALIGN
 (
PADDING
 > (è? PADDING : ())

	)

76 
	#BIG
 0

	)

77 
	#LITTLE
 1

	)

81 
	mdummy
;

82 
	m’dŸn
;

83 } cÚ¡ 
	gÇtive
 = {1};

86 
	sH—d”
 {

87 
	m’dŸn
;

88 
	m®ign
;

89 } 
	tH—d”
;

92 
	$g‘num
 (cÚ¡ **
fmt
, 
df
) {

93 ià(!
	`isdig™
(**
fmt
))

94  
df
;

96 
a
 = 0;

98 
a
 =‡*10 + *((*
fmt
)++) - '0';

99 } 
	`isdig™
(**
fmt
));

100  
a
;

102 
	}
}

105 
	#deçuÉİtiÚs
(
h
è((h)->
’dŸn
 = 
Çtive
.’dŸn, (h)->
®ign
 = 1)

	)

109 
size_t
 
	$İtsize
 (
lua_S‹
 *
L
, 
İt
, cÚ¡ **
fmt
) {

110 
İt
) {

114 'T':  (
size_t
);

118 'c':  
	`g‘num
(
fmt
, 1);

120 
sz
 = 
	`g‘num
(
fmt
, ());

121 ià(
sz
 > 
MAXINTSIZE
)

122 
	`luaL_”rÜ
(
L
, "integral size %d is†argerhan†imit of %d",

123 
sz
, 
MAXINTSIZE
);

124  
sz
;

128 
	}
}

135 
	$g‘tßlign
 (
size_t
 
Ën
, 
H—d”
 *
h
, 
İt
, size_ˆ
size
) {

136 ià(
size
 =ğ0 || 
İt
 == 'c')  0;

137 ià(
size
 > (
size_t
)
h
->
®ign
)

138 
size
 = 
h
->
®ign
;

139  (
size
 - (
Ën
 & (size - 1))) & (size - 1);

140 
	}
}

146 
	$cÚŒŞİtiÚs
 (
lua_S‹
 *
L
, 
İt
, cÚ¡ **
fmt
,

147 
H—d”
 *
h
) {

148 
İt
) {

150 '>': 
h
->
’dŸn
 = 
BIG
; ;

151 '<': 
h
->
’dŸn
 = 
LITTLE
; ;

153 
a
 = 
	`g‘num
(
fmt
, 
MAXALIGN
);

154 ià(!
	`i¥2
(
a
))

155 
	`luaL_”rÜ
(
L
, "®ignm’ˆ%d i nÙ‡…ow” oà2", 
a
);

156 
h
->
®ign
 = 
a
;

160 cÚ¡ *
msg
 = 
	`lua_pushf¡ršg
(
L
, "šv®id fÜm© o±iÚ '%c'", 
İt
);

161 
	`luaL_¬g”rÜ
(
L
, 1, 
msg
);

164 
	}
}

167 
	$putš‹g”
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
b
, 
¬g
, 
’dŸn
,

168 
size
) {

169 
lua_Numb”
 
n
 = 
	`luaL_checknumb”
(
L
, 
¬g
);

170 
Uš‰y³
 
v®ue
;

171 
buff
[
MAXINTSIZE
];

172 ià(
n
 < 0)

173 
v®ue
 = (
Uš‰y³
)(
IÁty³
)
n
;

175 
v®ue
 = (
Uš‰y³
)
n
;

176 ià(
’dŸn
 =ğ
LITTLE
) {

177 
i
;

178 
i
 = 0; i < 
size
; i++) {

179 
buff
[
i
] = (
v®ue
 & 0xff);

180 
v®ue
 >>= 8;

184 
i
;

185 
i
 = 
size
 - 1; i >= 0; i--) {

186 
buff
[
i
] = (
v®ue
 & 0xff);

187 
v®ue
 >>= 8;

190 
	`luaL_addl¡ršg
(
b
, 
buff
, 
size
);

191 
	}
}

194 
	$cÜ»ùby‹s
 (*
b
, 
size
, 
’dŸn
) {

195 ià(
’dŸn
 !ğ
Çtive
.endian) {

196 
i
 = 0;

197 
i
 < --
size
) {

198 
‹mp
 = 
b
[
i
];

199 
b
[
i
++] = b[
size
];

200 
b
[
size
] = 
‹mp
;

203 
	}
}

206 
	$b_·ck
 (
lua_S‹
 *
L
) {

207 
luaL_Bufãr
 
b
;

208 cÚ¡ *
fmt
 = 
	`luaL_check¡ršg
(
L
, 1);

209 
H—d”
 
h
;

210 
¬g
 = 2;

211 
size_t
 
tÙ®size
 = 0;

212 
	`deçuÉİtiÚs
(&
h
);

213 
	`lua_pushn
(
L
);

214 
	`luaL_buffš™
(
L
, &
b
);

215 *
fmt
 != '\0') {

216 
İt
 = *
fmt
++;

217 
size_t
 
size
 = 
	`İtsize
(
L
, 
İt
, &
fmt
);

218 
tßlign
 = 
	`g‘tßlign
(
tÙ®size
, &
h
, 
İt
, 
size
);

219 
tÙ®size
 +ğ
tßlign
;

220 
tßlign
-- > 0è
	`luaL_addch¬
(&
b
, '\0');

221 
İt
) {

224 
	`putš‹g”
(
L
, &
b
, 
¬g
++, 
h
.
’dŸn
, 
size
);

228 
	`luaL_addch¬
(&
b
, '\0');

232 
f
 = ()
	`luaL_checknumb”
(
L
, 
¬g
++);

233 
	`cÜ»ùby‹s
((*)&
f
, 
size
, 
h
.
’dŸn
);

234 
	`luaL_addl¡ršg
(&
b
, (*)&
f
, 
size
);

238 
d
 = 
	`luaL_checknumb”
(
L
, 
¬g
++);

239 
	`cÜ»ùby‹s
((*)&
d
, 
size
, 
h
.
’dŸn
);

240 
	`luaL_addl¡ršg
(&
b
, (*)&
d
, 
size
);

244 
size_t
 
l
;

245 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
++, &
l
);

246 ià(
size
 =ğ0èsizğ
l
;

247 
	`luaL_¬gcheck
(
L
, 
l
 >ğ(
size_t
)
size
, 
¬g
, "stringoo short");

248 
	`luaL_addl¡ršg
(&
b
, 
s
, 
size
);

249 ià(
İt
 == 's') {

250 
	`luaL_addch¬
(&
b
, '\0');

251 
size
++;

255 : 
	`cÚŒŞİtiÚs
(
L
, 
İt
, &
fmt
, &
h
);

257 
tÙ®size
 +ğ
size
;

259 
	`luaL_push»suÉ
(&
b
);

261 
	}
}

264 
lua_Numb”
 
	$g‘š‹g”
 (cÚ¡ *
buff
, 
’dŸn
,

265 
issigÃd
, 
size
) {

266 
Uš‰y³
 
l
 = 0;

267 
i
;

268 ià(
’dŸn
 =ğ
BIG
) {

269 
i
 = 0; i < 
size
; i++) {

270 
l
 <<= 8;

271 
l
 |ğ(
Uš‰y³
)()
buff
[
i
];

275 
i
 = 
size
 - 1; i >= 0; i--) {

276 
l
 <<= 8;

277 
l
 |ğ(
Uš‰y³
)()
buff
[
i
];

280 ià(!
issigÃd
)

281  (
lua_Numb”
)
l
;

283 
Uš‰y³
 
mask
 = (Uš‰y³)(~((Uš‰y³)0)è<< (
size
*8 - 1);

284 ià(
l
 & 
mask
)

285 
l
 |ğ
mask
;

286  (
lua_Numb”
)(
IÁty³
)
l
;

288 
	}
}

291 
	$b_uÅack
 (
lua_S‹
 *
L
) {

292 
H—d”
 
h
;

293 cÚ¡ *
fmt
 = 
	`luaL_check¡ršg
(
L
, 1);

294 
size_t
 
ld
;

295 cÚ¡ *
d©a
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
ld
);

296 
size_t
 
pos
 = 
	`luaL_İtš‹g”
(
L
, 3, 1);

297 
	`luaL_¬gcheck
(
L
, 
pos
 > 0, 3, "offset must be 1 or greater");

298 
pos
--;

300 
n
 = 0;

301 
	`deçuÉİtiÚs
(&
h
);

302 *
fmt
) {

303 
İt
 = *
fmt
++;

304 
size_t
 
size
 = 
	`İtsize
(
L
, 
İt
, &
fmt
);

305 
pos
 +ğ
	`g‘tßlign
Õos, &
h
, 
İt
, 
size
);

306 
	`luaL_¬gcheck
(
L
, 
size
 <ğ
ld
 && 
pos
 <=†d - size,

309 
	`luaL_check¡ack
(
L
, 2, "too many„esults");

310 
İt
) {

313 
issigÃd
 = 
	`i¦ow”
(
İt
);

314 
lua_Numb”
 
»s
 = 
	`g‘š‹g”
(
d©a
+
pos
, 
h
.
’dŸn
, 
issigÃd
, 
size
);

315 
	`lua_pushnumb”
(
L
, 
»s
); 
n
++;

322 
f
;

323 
	`memıy
(&
f
, 
d©a
+
pos
, 
size
);

324 
	`cÜ»ùby‹s
((*)&
f
, (f), 
h
.
’dŸn
);

325 
	`lua_pushnumb”
(
L
, 
f
); 
n
++;

329 
d
;

330 
	`memıy
(&
d
, 
d©a
+
pos
, 
size
);

331 
	`cÜ»ùby‹s
((*)&
d
, (d), 
h
.
’dŸn
);

332 
	`lua_pushnumb”
(
L
, 
d
); 
n
++;

336 ià(
size
 == 0) {

337 ià(
n
 =ğ0 || !
	`lua_i¢umb”
(
L
, -1))

338 
	`luaL_”rÜ
(
L
, "format 'c0'‚eeds‡…revious size");

339 
size
 = 
	`lua_tÚumb”
(
L
, -1);

340 
	`lua_pİ
(
L
, 1); 
n
--;

341 
	`luaL_¬gcheck
(
L
, 
size
 <ğ
ld
 && 
pos
 <=†d - size,

344 
	`lua_pushl¡ršg
(
L
, 
d©a
+
pos
, 
size
); 
n
++;

348 cÚ¡ *
e
 = (cÚ¡ *)
	`memchr
(
d©a
+
pos
, '\0', 
ld
 -…os);

349 ià(
e
 =ğ
NULL
)

350 
	`luaL_”rÜ
(
L
, "unfinished string in data");

351 
size
 = (
e
 - (
d©a
+
pos
)) + 1;

352 
	`lua_pushl¡ršg
(
L
, 
d©a
+
pos
, 
size
 - 1); 
n
++;

355 : 
	`cÚŒŞİtiÚs
(
L
, 
İt
, &
fmt
, &
h
);

357 
pos
 +ğ
size
;

359 
	`lua_pushš‹g”
(
L
, 
pos
 + 1);

360  
n
 + 1;

361 
	}
}

364 
	$b_size
 (
lua_S‹
 *
L
) {

365 
H—d”
 
h
;

366 cÚ¡ *
fmt
 = 
	`luaL_check¡ršg
(
L
, 1);

367 
size_t
 
pos
 = 0;

368 
	`deçuÉİtiÚs
(&
h
);

369 *
fmt
) {

370 
İt
 = *
fmt
++;

371 
size_t
 
size
 = 
	`İtsize
(
L
, 
İt
, &
fmt
);

372 
pos
 +ğ
	`g‘tßlign
Õos, &
h
, 
İt
, 
size
);

373 ià(
İt
 == 's')

374 
	`luaL_¬g”rÜ
(
L
, 1, "option 's' has‚o fixed size");

375 ià(
İt
 =ğ'c' && 
size
 == 0)

376 
	`luaL_¬g”rÜ
(
L
, 1, "option 'c0' has‚o fixed size");

377 ià(!
	`i§Êum
(
İt
))

378 
	`cÚŒŞİtiÚs
(
L
, 
İt
, &
fmt
, &
h
);

379 
pos
 +ğ
size
;

381 
	`lua_pushš‹g”
(
L
, 
pos
);

383 
	}
}

389 cÚ¡ 
luaL_Reg
 
	gthi¦ib
[] = {

390 {"·ck", 
b_·ck
},

391 {"uÅack", 
b_uÅack
},

392 {"size", 
b_size
},

393 {
NULL
, NULL}

397 
LUALIB_API
 
luaİ’_¡ruù
 (
lua_S‹
 *
L
);

399 
LUALIB_API
 
	$luaİ’_¡ruù
 (
lua_S‹
 *
L
) {

400 
	`luaL_»gi¡”
(
L
, "¡ruù", 
thi¦ib
);

402 
	}
}

	@deps/lua/src/luac.c

7 
	~<”ºo.h
>

8 
	~<¡dio.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

12 
	#luac_c


	)

13 
	#LUA_CORE


	)

15 
	~"lua.h
"

16 
	~"Ïuxlib.h
"

18 
	~"ldo.h
"

19 
	~"lfunc.h
"

20 
	~"lmem.h
"

21 
	~"lobjeù.h
"

22 
	~"lİcodes.h
"

23 
	~"l¡ršg.h
"

24 
	~"lundump.h
"

26 
	#PROGNAME
 "luac"

	)

27 
	#OUTPUT
 
PROGNAME
 ".out"

	)

29 
	gli¡šg
=0;

30 
	gdumpšg
=1;

31 
	g¡rpšg
=0;

32 
	gOuut
[]={ 
OUTPUT
 };

33 cÚ¡ * 
	gouut
=
Ouut
;

34 cÚ¡ * 
	g´ogÇme
=
PROGNAME
;

36 
	$çl
(cÚ¡ * 
mes§ge
)

38 
	`årštf
(
¡d”r
,"%s: %s\n",
´ogÇme
,
mes§ge
);

39 
	`ex™
(
EXIT_FAILURE
);

40 
	}
}

42 
	$ÿÂÙ
(cÚ¡ * 
wh©
)

44 
	`årštf
(
¡d”r
,"%s: cªnÙ % %s: %s\n",
´ogÇme
,
wh©
,
ouut
,
	`¡»¼Ü
(
”ºo
));

45 
	`ex™
(
EXIT_FAILURE
);

46 
	}
}

48 
	$u§ge
(cÚ¡ * 
mes§ge
)

50 ià(*
mes§ge
=='-')

51 
	`årštf
(
¡d”r
,"%s: uÄecognized o±iÚ " 
LUA_QS
 "\n",
´ogÇme
,
mes§ge
);

53 
	`årštf
(
¡d”r
,"%s: %s\n",
´ogÇme
,
mes§ge
);

54 
	`årštf
(
¡d”r
,

59 " -ØÇm ouuˆtØf" 
	`LUA_QL
("name") " (default is \"%s\")\n"

64 
´ogÇme
,
Ouut
);

65 
	`ex™
(
EXIT_FAILURE
);

66 
	}
}

68 
	#IS
(
s
è(
	`¡rcmp
(
¬gv
[
i
],s)==0)

	)

70 
	$dßrgs
(
¬gc
, * 
¬gv
[])

72 
i
;

73 
v”siÚ
=0;

74 ià(
¬gv
[0]!=
NULL
 && *¬gv[0]!=0è
´ogÇme
=argv[0];

75 
i
=1; i<
¬gc
; i++)

77 ià(*
¬gv
[
i
]!='-')

79 ià(
	`IS
("--"))

81 ++
i
;

82 ià(
v”siÚ
) ++version;

85 ià(
	`IS
("-"))

87 ià(
	`IS
("-l"))

88 ++
li¡šg
;

89 ià(
	`IS
("-o"))

91 
ouut
=
¬gv
[++
i
];

92 ià(
ouut
==
NULL
 || *ouut==0è
	`u§ge
(
	`LUA_QL
("-o") "‚eeds‡rgument");

93 ià(
	`IS
("-")è
ouut
=
NULL
;

95 ià(
	`IS
("-p"))

96 
dumpšg
=0;

97 ià(
	`IS
("-s"))

98 
¡rpšg
=1;

99 ià(
	`IS
("-v"))

100 ++
v”siÚ
;

102 
	`u§ge
(
¬gv
[
i
]);

104 ià(
i
==
¬gc
 && (
li¡šg
 || !
dumpšg
))

106 
dumpšg
=0;

107 
¬gv
[--
i
]=
Ouut
;

109 ià(
v”siÚ
)

111 
	`´štf
("%  %s\n",
LUA_RELEASE
,
LUA_COPYRIGHT
);

112 ià(
v”siÚ
==
¬gc
-1è
	`ex™
(
EXIT_SUCCESS
);

114  
i
;

115 
	}
}

117 
	#tİrÙo
(
L
,
i
è(
	`şv®ue
(L->
tİ
+(i))->
l
.
p
)

	)

119 cÚ¡ 
PrÙo
* 
	$combše
(
lua_S‹
* 
L
, 
n
)

121 ià(
n
==1)

122  
	`tİrÙo
(
L
,-1);

125 
i
,
pc
;

126 
PrÙo
* 
f
=
	`luaF_Ãw´Ùo
(
L
);

127 
	`£tv®ue2s
(
L
,L->
tİ
,
f
); 
	`šü_tİ
(L);

128 
f
->
sourû
=
	`luaS_Ãwl™”®
(
L
,"=(" 
PROGNAME
 ")");

129 
f
->
max¡acksize
=1;

130 
pc
=2*
n
+1;

131 
f
->
code
=
	`luaM_ÃwveùÜ
(
L
,
pc
,
In¡ruùiÚ
);

132 
f
->
sizecode
=
pc
;

133 
f
->
p
=
	`luaM_ÃwveùÜ
(
L
,
n
,
PrÙo
*);

134 
f
->
siz•
=
n
;

135 
pc
=0;

136 
i
=0; i<
n
; i++)

138 
f
->
p
[
i
]=
	`tİrÙo
(
L
,i-
n
-1);

139 
f
->
code
[
pc
++]=
	`CREATE_ABx
(
OP_CLOSURE
,0,
i
);

140 
f
->
code
[
pc
++]=
	`CREATE_ABC
(
OP_CALL
,0,1,1);

142 
f
->
code
[
pc
++]=
	`CREATE_ABC
(
OP_RETURN
,0,1,0);

143  
f
;

145 
	}
}

147 
	$wr™”
(
lua_S‹
* 
L
, cÚ¡ * 
p
, 
size_t
 
size
, * 
u
)

149 
	`UNUSED
(
L
);

150  (
	`fwr™e
(
p
,
size
,1,(
FILE
*)
u
)!=1) && (size!=0);

151 
	}
}

153 
	sSmaš
 {

154 
	m¬gc
;

155 ** 
	m¬gv
;

158 
	$pmaš
(
lua_S‹
* 
L
)

160 
Smaš
* 
s
 = (Smaš*)
	`lua_tou£rd©a
(
L
, 1);

161 
¬gc
=
s
->argc;

162 ** 
¬gv
=
s
->argv;

163 cÚ¡ 
PrÙo
* 
f
;

164 
i
;

165 ià(!
	`lua_check¡ack
(
L
,
¬gc
)è
	`çl
("too many input files");

166 
i
=0; i<
¬gc
; i++)

168 cÚ¡ * 
f’ame
=
	`IS
("-"è? 
NULL
 : 
¬gv
[
i
];

169 ià(
	`luaL_lßdfe
(
L
,
f’ame
)!=0è
	`çl
(
	`lua_to¡ršg
(L,-1));

171 
f
=
	`combše
(
L
,
¬gc
);

172 ià(
li¡šg
è
	`luaU_´št
(
f
,listing>1);

173 ià(
dumpšg
)

175 
FILE
* 
D
ğ(
ouut
==
NULL
è? 
¡dout
 : 
	`fİ’
(output,"wb");

176 ià(
D
==
NULL
è
	`ÿÂÙ
("open");

177 
	`lua_lock
(
L
);

178 
	`luaU_dump
(
L
,
f
,
wr™”
,
D
,
¡rpšg
);

179 
	`lua_uÆock
(
L
);

180 ià(
	`ã¼Ü
(
D
)è
	`ÿÂÙ
("write");

181 ià(
	`fşo£
(
D
)è
	`ÿÂÙ
("close");

184 
	}
}

186 
	$maš
(
¬gc
, * 
¬gv
[])

188 
lua_S‹
* 
L
;

189 
Smaš
 
s
;

190 
i
=
	`dßrgs
(
¬gc
,
¬gv
);

191 
¬gc
-=
i
; 
¬gv
+=i;

192 ià(
¬gc
<=0è
	`u§ge
("no input files given");

193 
L
=
	`lua_İ’
();

194 ià(
L
==
NULL
è
	`çl
("notƒnough memory for state");

195 
s
.
¬gc
=argc;

196 
s
.
¬gv
=argv;

197 ià(
	`lua_ıÿÎ
(
L
,
pmaš
,&
s
)!=0è
	`çl
(
	`lua_to¡ršg
(L,-1));

198 
	`lua_şo£
(
L
);

199  
EXIT_SUCCESS
;

200 
	}
}

	@deps/lua/src/luaconf.h

8 #iâdeà
lcÚfig_h


9 
	#lcÚfig_h


	)

11 
	~<lim™s.h
>

12 
	~<¡ddef.h
>

27 #ià
defšed
(
__STRICT_ANSI__
)

28 
	#LUA_ANSI


	)

32 #ià!
defšed
(
LUA_ANSI
è&& defšed(
_WIN32
)

33 
	#LUA_WIN


	)

36 #ià
defšed
(
LUA_USE_LINUX
)

37 
	#LUA_USE_POSIX


	)

38 
	#LUA_USE_DLOPEN


	)

39 
	#LUA_USE_READLINE


	)

42 #ià
defšed
(
LUA_USE_MACOSX
)

43 
	#LUA_USE_POSIX


	)

44 
	#LUA_DL_DYLD


	)

54 #ià
defšed
(
LUA_USE_POSIX
)

55 
	#LUA_USE_MKSTEMP


	)

56 
	#LUA_USE_ISATTY


	)

57 
	#LUA_USE_POPEN


	)

58 
	#LUA_USE_ULONGJMP


	)

69 
	#LUA_PATH
 "LUA_PATH"

	)

70 
	#LUA_CPATH
 "LUA_CPATH"

	)

71 
	#LUA_INIT
 "LUA_INIT"

	)

83 #ià
defšed
(
_WIN32
)

88 
	#LUA_LDIR
 "!\\lua\\"

	)

89 
	#LUA_CDIR
 "!\\"

	)

90 
	#LUA_PATH_DEFAULT
 \

91 ".\\?.lua;" 
LUA_LDIR
"?.lua;" LUA_LDIR"?\\init.lua;" \

92 
LUA_CDIR
"?.lua;" LUA_CDIR"?\\š™.lua"

	)

93 
	#LUA_CPATH_DEFAULT
 \

94 ".\\?.dÎ;" 
LUA_CDIR
"?.dÎ;" LUA_CDIR"lßd®l.dÎ"

	)

97 
	#LUA_ROOT
 "/u¤/loÿl/"

	)

98 
	#LUA_LDIR
 
LUA_ROOT
 "sh¬e/lua/5.1/"

	)

99 
	#LUA_CDIR
 
LUA_ROOT
 "lib/lua/5.1/"

	)

100 
	#LUA_PATH_DEFAULT
 \

101 "./?.lua;" 
LUA_LDIR
"?.lua;" LUA_LDIR"?/init.lua;" \

102 
LUA_CDIR
"?.lua;" LUA_CDIR"?/š™.lua"

	)

103 
	#LUA_CPATH_DEFAULT
 \

104 "./?.so;" 
LUA_CDIR
"?.so;" LUA_CDIR"lßd®l.so"

	)

113 #ià
defšed
(
_WIN32
)

114 
	#LUA_DIRSEP
 "\\"

	)

116 
	#LUA_DIRSEP
 "/"

	)

132 
	#LUA_PATHSEP
 ";"

	)

133 
	#LUA_PATH_MARK
 "?"

	)

134 
	#LUA_EXECDIR
 "!"

	)

135 
	#LUA_IGMARK
 "-"

	)

143 
	#LUA_INTEGER
 
±rdiff_t


	)

154 #ià
defšed
(
LUA_BUILD_AS_DLL
)

156 #ià
defšed
(
LUA_CORE
è|| defšed(
LUA_LIB
)

157 
	#LUA_API
 
	`__deş¥ec
(
dÎexpÜt
)

	)

159 
	#LUA_API
 
	`__deş¥ec
(
dÎimpÜt
)

	)

164 
	#LUA_API
 

	)

169 
	#LUALIB_API
 
LUA_API


	)

181 #ià
defšed
(
lu¯Î_c
)

182 
	#LUAI_FUNC
 

	)

183 
	#LUAI_DATA


	)

185 #–ià
defšed
(
__GNUC__
è&& ((__GNUC__*100 + 
__GNUC_MINOR__
) >= 302) && \

186 
	$defšed
(
__ELF__
)

187 
	#LUAI_FUNC
 
	`__©Œibu‹__
((
	`visib™y
("hidd’"))è

	)

188 
	#LUAI_DATA
 
LUAI_FUNC


	)

191 
	#LUAI_FUNC
 

	)

192 
	#LUAI_DATA
 

	)

201 
	#LUA_QL
(
x
è"'" x "'"

	)

202 
	#LUA_QS
 
	`LUA_QL
("%s")

	)

210 
	#LUA_IDSIZE
 60

	)

219 #ià
	`defšed
(
lua_c
è|| defšed(
lu¯Î_c
)

227 #ià
	`defšed
(
LUA_USE_ISATTY
)

228 
	~<uni¡d.h
>

229 
	#lua_¡dš_is_‰y
(è
	`i§‰y
(0)

	)

230 #–ià
	`defšed
(
LUA_WIN
)

231 
	~<io.h
>

232 
	~<¡dio.h
>

233 
	#lua_¡dš_is_‰y
(è
	`_i§‰y
(
	`_f’o
(
¡dš
))

	)

235 
	#lua_¡dš_is_‰y
(è1

	)

245 
	#LUA_PROMPT
 "> "

	)

246 
	#LUA_PROMPT2
 ">> "

	)

254 
	#LUA_PROGNAME
 "lua"

	)

262 
	#LUA_MAXINPUT
 512

	)

273 #ià
	`defšed
(
LUA_USE_READLINE
)

274 
	~<¡dio.h
>

275 
	~<»adlše/»adlše.h
>

276 
	~<»adlše/hi¡Üy.h
>

277 
	#lua_»adlše
(
L
,
b
,
p
è(()L, ((b)=
	`»adlše
Õ)è!ğ
NULL
)

	)

278 
	#lua_§v–še
(
L
,
idx
) \

279 ià(
	`lua_¡¾’
(
L
,
idx
) > 0) \

280 
	`add_hi¡Üy
(
	`lua_to¡ršg
(
L
, 
idx
));

	)

281 
	#lua_ä“lše
(
L
,
b
è(()L, 
	`ä“
(b))

	)

283 
	#lua_»adlše
(
L
,
b
,
p
) \

284 (()
L
, 
	`åuts
(
p
, 
¡dout
), 
	`fæush
(stdout), \

285 
	`fg‘s
(
b
, 
LUA_MAXINPUT
, 
¡dš
è!ğ
NULL
è

	)

286 
	#lua_§v–še
(
L
,
idx
è{ ()L; ()idx; 
	}

	)
}

287 
	#lua_ä“lše
(
L
,
b
è{ ()L; ()b; }

	)

302 
	#LUAI_GCPAUSE
 200

	)

313 
	#LUAI_GCMUL
 200

	)

322 #undeà
LUA_COMPAT_GETN


329 #undeà
LUA_COMPAT_LOADLIB


336 
	#LUA_COMPAT_VARARG


	)

343 
	#LUA_COMPAT_MOD


	)

351 
	#LUA_COMPAT_LSTR
 1

	)

358 
	#LUA_COMPAT_GFIND


	)

366 
	#LUA_COMPAT_OPENLIB


	)

377 #ià
defšed
(
LUA_USE_APICHECK
)

378 
	~<as£¹.h
>

379 
	#luai_­icheck
(
L
,
o
è{ ()L; 
	`as£¹
(o); }

	)

381 
	#luai_­icheck
(
L
,
o
è{ ()L; }

	)

391 #ià
INT_MAX
-20 < 32760

392 
	#LUAI_BITSINT
 16

	)

393 #–ià
INT_MAX
 > 2147483640L

395 
	#LUAI_BITSINT
 32

	)

413 #ià
LUAI_BITSINT
 >= 32

414 
	#LUAI_UINT32
 

	)

415 
	#LUAI_INT32
 

	)

416 
	#LUAI_MAXINT32
 
INT_MAX


	)

417 
	#LUAI_UMEM
 
size_t


	)

418 
	#LUAI_MEM
 
±rdiff_t


	)

421 
	#LUAI_UINT32
 

	)

422 
	#LUAI_INT32
 

	)

423 
	#LUAI_MAXINT32
 
LONG_MAX


	)

424 
	#LUAI_UMEM
 

	)

425 
	#LUAI_MEM
 

	)

435 
	#LUAI_MAXCALLS
 20000

	)

446 
	#LUAI_MAXCSTACK
 8000

	)

468 
	#LUAI_MAXCCALLS
 200

	)

475 
	#LUAI_MAXVARS
 200

	)

482 
	#LUAI_MAXUPVALUES
 60

	)

488 
	#LUAL_BUFFERSIZE
 
BUFSIZ


	)

504 
	#LUA_NUMBER_DOUBLE


	)

505 
	#LUA_NUMBER
 

	)

511 
	#LUAI_UACNUMBER
 

	)

521 
	#LUA_NUMBER_SCAN
 "%lf"

	)

522 
	#LUA_NUMBER_FMT
 "%.14g"

	)

523 
	#lua_numb”2¡r
(
s
,
n
è
	`¥rštf
((s), 
LUA_NUMBER_FMT
, (n))

	)

524 
	#LUAI_MAXNUMBER2STR
 32

	)

525 
	#lua_¡r2numb”
(
s
,
p
è
	`¡¹od
((s), (p))

	)

531 #ià
defšed
(
LUA_CORE
)

532 
	~<m©h.h
>

533 
	#luai_numadd
(
a
,
b
è(×)+(b))

	)

534 
	#luai_numsub
(
a
,
b
è(×)-(b))

	)

535 
	#luai_nummul
(
a
,
b
è(×)*(b))

	)

536 
	#luai_numdiv
(
a
,
b
è(×)/(b))

	)

537 
	#luai_nummod
(
a
,
b
è(×è- 
	`æoÜ
(×)/(b))*(b))

	)

538 
	#luai_numpow
(
a
,
b
è(
	`pow
×,b))

	)

539 
	#luai_numunm
(
a
è(-×))

	)

540 
	#luai_numeq
(
a
,
b
è(×)==(b))

	)

541 
	#luai_numÉ
(
a
,
b
è(×)<(b))

	)

542 
	#luai_numË
(
a
,
b
è(×)<=(b))

	)

543 
	#luai_numi¢ª
(
a
è(!
	`luai_numeq
(×), (a)))

	)

557 #ià
defšed
(
LUA_NUMBER_DOUBLE
è&& !defšed(
LUA_ANSI
è&& !defšed(
__SSE2__
) && \

558 (
defšed
(
__i386
è|| defšed (
_M_IX86
è|| 
	$defšed
(
__i386__
))

561 #ià
	`defšed
(
_MSC_VER
)

563 
	#lua_numb”2št
(
i
,
d
è
__asm
 
æd
 d __asm 
fi¡p
 
	)
i

564 
	#lua_numb”2š‹g”
(
i
,
n
è
	`lua_numb”2št
(i,‚)

	)

570 
	uluai_Ca¡
 { 
l_d
; 
l_l
; };

571 
	#lua_numb”2št
(
i
,
d
) \

572 { vŞ©
luai_Ca¡
 
u
; u.
l_d
 = (
d
è+ 6755399441055744.0; (
i
èğu.
l_l
; 
	}

	)
}

573 
	#lua_numb”2š‹g”
(
i
,
n
è
	`lua_numb”2št
(i,‚)

	)

580 
	#lua_numb”2št
(
i
,
d
è((i)=()(d))

	)

581 
	#lua_numb”2š‹g”
(
i
,
d
è((i)=(
lua_IÁeg”
)(d))

	)

595 
	#LUAI_USER_ALIGNMENT_T
 uniÚ { 
u
; *
s
; 
l
; }

	)

606 #ià
defšed
(
__ılu¥lus
)

608 
	#LUAI_THROW
(
L
,
c
è
	`throw
(c)

	)

609 
	#LUAI_TRY
(
L
,
c
,
a
è
Œy
 {‡ } 
	`ÿtch
(...) \

610 { ià((
c
)->
¡©us
 =ğ0è(c)->¡©u ğ-1; }

	)

611 
	#luai_jmpbuf
 

	)

613 #–ià
defšed
(
LUA_USE_ULONGJMP
)

615 
	#LUAI_THROW
(
L
,
c
è
	`_lÚgjmp
((c)->
b
, 1)

	)

616 
	#LUAI_TRY
(
L
,
c
,
a
èià(
	`_£tjmp
((c)->
b
è=ğ0è{‡ }

	)

617 
	#luai_jmpbuf
 
jmp_buf


	)

621 
	#LUAI_THROW
(
L
,
c
è
	`lÚgjmp
((c)->
b
, 1)

	)

622 
	#LUAI_TRY
(
L
,
c
,
a
èià(
	`£tjmp
((c)->
b
è=ğ0è{‡ }

	)

623 
	#luai_jmpbuf
 
jmp_buf


	)

633 
	#LUA_MAXCAPTURES
 32

	)

644 #ià
defšed
(
lo¦ib_c
è|| defšed(
lu¯Î_c
)

646 #ià
defšed
(
LUA_USE_MKSTEMP
)

647 
	~<uni¡d.h
>

648 
	#LUA_TMPNAMBUFSIZE
 32

	)

649 
	#lua_tm²am
(
b
,
e
) { \

650 
	`¡rıy
(
b
, "/tmp/lua_XXXXXX"); \

651 
e
 = 
	`mk¡emp
(
b
); \

652 ià(
e
 !ğ-1è
	`şo£
(e); \

653 
e
 = (=ğ-1); }

	)

656 
	#LUA_TMPNAMBUFSIZE
 
L_tm²am


	)

657 
	#lua_tm²am
(
b
,
e
è{ƒ = (
	`tm²am
(bè=ğ
NULL
); }

	)

668 #ià
defšed
(
LUA_USE_POPEN
)

670 
	#lua_pİ’
(
L
,
c
,
m
è(()L, 
	`fæush
(
NULL
), 
	`pİ’
(c,m))

	)

671 
	#lua_pşo£
(
L
,
fe
è(()L, (
	`pşo£
(feè!ğ-1))

	)

673 #–ià
defšed
(
LUA_WIN
)

675 
	#lua_pİ’
(
L
,
c
,
m
è(()L, 
	`_pİ’
(c,m))

	)

676 
	#lua_pşo£
(
L
,
fe
è(()L, (
	`_pşo£
(feè!ğ-1))

	)

680 
	#lua_pİ’
(
L
,
c
,
m
) (()(()c, m), \

681 
	`luaL_”rÜ
(
L
, 
	`LUA_QL
("pİ’"è"‚Ù suµÜ‹d"), (
FILE
*)0)

	)

682 
	#lua_pşo£
(
L
,
fe
è(()(()L, fe), 0)

	)

700 #ià
defšed
(
LUA_USE_DLOPEN
)

701 
	#LUA_DL_DLOPEN


	)

704 #ià
defšed
(
LUA_WIN
)

705 
	#LUA_DL_DLL


	)

715 
	#LUAI_EXTRASPACE
 0

	)

723 
	#luai_u£r¡©eİ’
(
L
è(()L)

	)

724 
	#luai_u£r¡©eşo£
(
L
è(()L)

	)

725 
	#luai_u£r¡©‘h»ad
(
L
,
L1
è(()L)

	)

726 
	#luai_u£r¡©eä“
(
L
è(()L)

	)

727 
	#luai_u£r¡©”esume
(
L
,
n
è(()L)

	)

728 
	#luai_u£r¡©ey›ld
(
L
,
n
è(()L)

	)

739 #ià
defšed
(
LUA_USELONGLONG
)

741 
	#LUA_INTFRMLEN
 "Î"

	)

742 
	#LUA_INTFRM_T
 

	)

746 
	#LUA_INTFRMLEN
 "l"

	)

747 
	#LUA_INTFRM_T
 

	)

	@deps/lua/src/lualib.h

8 #iâdeà
lu®ib_h


9 
	#lu®ib_h


	)

11 
	~"lua.h
"

15 
	#LUA_FILEHANDLE
 "FILE*"

	)

18 
	#LUA_COLIBNAME
 "cÜoutše"

	)

19 
LUALIB_API
 (
luaİ’_ba£
è(
lua_S‹
 *
L
);

21 
	#LUA_TABLIBNAME
 "bË"

	)

22 
LUALIB_API
 (
luaİ’_bË
è(
lua_S‹
 *
L
);

24 
	#LUA_IOLIBNAME
 "io"

	)

25 
LUALIB_API
 (
luaİ’_io
è(
lua_S‹
 *
L
);

27 
	#LUA_OSLIBNAME
 "os"

	)

28 
LUALIB_API
 (
luaİ’_os
è(
lua_S‹
 *
L
);

30 
	#LUA_STRLIBNAME
 "¡ršg"

	)

31 
LUALIB_API
 (
luaİ’_¡ršg
è(
lua_S‹
 *
L
);

33 
	#LUA_MATHLIBNAME
 "m©h"

	)

34 
LUALIB_API
 (
luaİ’_m©h
è(
lua_S‹
 *
L
);

36 
	#LUA_DBLIBNAME
 "debug"

	)

37 
LUALIB_API
 (
luaİ’_debug
è(
lua_S‹
 *
L
);

39 
	#LUA_LOADLIBNAME
 "·ckage"

	)

40 
LUALIB_API
 (
luaİ’_·ckage
è(
lua_S‹
 *
L
);

44 
LUALIB_API
 (
luaL_İ’libs
è(
lua_S‹
 *
L
);

48 #iâdeà
lua_as£¹


49 
	#lua_as£¹
(
x
è(()0)

	)

	@deps/lua/src/lundump.c

7 
	~<¡ršg.h
>

9 
	#lundump_c


	)

10 
	#LUA_CORE


	)

12 
	~"lua.h
"

14 
	~"ldebug.h
"

15 
	~"ldo.h
"

16 
	~"lfunc.h
"

17 
	~"lmem.h
"

18 
	~"lobjeù.h
"

19 
	~"l¡ršg.h
"

20 
	~"lundump.h
"

21 
	~"lzio.h
"

24 
lua_S‹
* 
	mL
;

25 
ZIO
* 
	mZ
;

26 
Mbufãr
* 
	mb
;

27 cÚ¡ * 
	mÇme
;

28 } 
	tLßdS‹
;

30 #ifdeà
LUAC_TRUST_BINARIES


31 
	#IF
(
c
,
s
)

	)

32 
	#”rÜ
(
S
,
s
)

	)

34 
	#IF
(
c
,
s
èià(cè
	`”rÜ
(
S
,s)

	)

36 
	$”rÜ
(
LßdS‹
* 
S
, cÚ¡ * 
why
)

38 
	`luaO_pushf¡ršg
(
S
->
L
,"%s: % š…»comped chunk",S->
Çme
,
why
);

39 
	`luaD_throw
(
S
->
L
,
LUA_ERRSYNTAX
);

40 
	}
}

43 
	#LßdMem
(
S
,
b
,
n
,
size
è
	`LßdBlock
(S,b,Ò)*(size))

	)

44 
	#LßdBy‹
(
S
è(
lu_by‹
)
	`LßdCh¬
(S)

	)

45 
	#LßdV¬
(
S
,
x
è
	`LßdMem
(S,&x,1,(x))

	)

46 
	#LßdVeùÜ
(
S
,
b
,
n
,
size
è
	`LßdMem
(S,b,n,size)

	)

48 
	$LßdBlock
(
LßdS‹
* 
S
, * 
b
, 
size_t
 
size
)

50 
size_t
 
r
=
	`luaZ_»ad
(
S
->
Z
,
b
,
size
);

51 
	`IF
 (
r
!=0, "unexpectedƒnd");

52 
	}
}

54 
	$LßdCh¬
(
LßdS‹
* 
S
)

56 
x
;

57 
	`LßdV¬
(
S
,
x
);

58  
x
;

59 
	}
}

61 
	$LßdIÁ
(
LßdS‹
* 
S
)

63 
x
;

64 
	`LßdV¬
(
S
,
x
);

65 
	`IF
 (
x
<0, "bad integer");

66  
x
;

67 
	}
}

69 
lua_Numb”
 
	$LßdNumb”
(
LßdS‹
* 
S
)

71 
lua_Numb”
 
x
;

72 
	`LßdV¬
(
S
,
x
);

73  
x
;

74 
	}
}

76 
TSŒšg
* 
	$LßdSŒšg
(
LßdS‹
* 
S
)

78 
size_t
 
size
;

79 
	`LßdV¬
(
S
,
size
);

80 ià(
size
==0)

81  
NULL
;

84 * 
s
=
	`luaZ_İ’¥aû
(
S
->
L
,S->
b
,
size
);

85 
	`LßdBlock
(
S
,
s
,
size
);

86  
	`luaS_Ãwl¡r
(
S
->
L
,
s
,
size
-1);

88 
	}
}

90 
	$LßdCode
(
LßdS‹
* 
S
, 
PrÙo
* 
f
)

92 
n
=
	`LßdIÁ
(
S
);

93 
f
->
code
=
	`luaM_ÃwveùÜ
(
S
->
L
,
n
,
In¡ruùiÚ
);

94 
f
->
sizecode
=
n
;

95 
	`LßdVeùÜ
(
S
,
f
->
code
,
n
,(
In¡ruùiÚ
));

96 
	}
}

98 
PrÙo
* 
LßdFunùiÚ
(
LßdS‹
* 
S
, 
TSŒšg
* 
p
);

100 
	$LßdCÚ¡ªts
(
LßdS‹
* 
S
, 
PrÙo
* 
f
)

102 
i
,
n
;

103 
n
=
	`LßdIÁ
(
S
);

104 
f
->
k
=
	`luaM_ÃwveùÜ
(
S
->
L
,
n
,
TV®ue
);

105 
f
->
sizek
=
n
;

106 
i
=0; i<
n
; i++è
	`£Šv®ue
(&
f
->
k
[i]);

107 
i
=0; i<
n
; i++)

109 
TV®ue
* 
o
=&
f
->
k
[
i
];

110 
t
=
	`LßdCh¬
(
S
);

111 
t
)

113 
LUA_TNIL
:

114 
	`£Šv®ue
(
o
);

116 
LUA_TBOOLEAN
:

117 
	`£tbv®ue
(
o
,
	`LßdCh¬
(
S
)!=0);

119 
LUA_TNUMBER
:

120 
	`£Šv®ue
(
o
,
	`LßdNumb”
(
S
));

122 
LUA_TSTRING
:

123 
	`£tsv®ue2n
(
S
->
L
,
o
,
	`LßdSŒšg
(S));

126 
	`”rÜ
(
S
,"bad constant");

130 
n
=
	`LßdIÁ
(
S
);

131 
f
->
p
=
	`luaM_ÃwveùÜ
(
S
->
L
,
n
,
PrÙo
*);

132 
f
->
siz•
=
n
;

133 
i
=0; i<
n
; i++è
f
->
p
[i]=
NULL
;

134 
i
=0; i<
n
; i++è
f
->
p
[i]=
	`LßdFunùiÚ
(
S
,f->
sourû
);

135 
	}
}

137 
	$LßdDebug
(
LßdS‹
* 
S
, 
PrÙo
* 
f
)

139 
i
,
n
;

140 
n
=
	`LßdIÁ
(
S
);

141 
f
->
lšešfo
=
	`luaM_ÃwveùÜ
(
S
->
L
,
n
,);

142 
f
->
siz–šešfo
=
n
;

143 
	`LßdVeùÜ
(
S
,
f
->
lšešfo
,
n
,());

144 
n
=
	`LßdIÁ
(
S
);

145 
f
->
locv¬s
=
	`luaM_ÃwveùÜ
(
S
->
L
,
n
,
LocV¬
);

146 
f
->
siz–ocv¬s
=
n
;

147 
i
=0; i<
n
; i++è
f
->
locv¬s
[i].
v¬Çme
=
NULL
;

148 
i
=0; i<
n
; i++)

150 
f
->
locv¬s
[
i
].
v¬Çme
=
	`LßdSŒšg
(
S
);

151 
f
->
locv¬s
[
i
].
¡¬c
=
	`LßdIÁ
(
S
);

152 
f
->
locv¬s
[
i
].
’dpc
=
	`LßdIÁ
(
S
);

154 
n
=
	`LßdIÁ
(
S
);

155 
f
->
upv®ues
=
	`luaM_ÃwveùÜ
(
S
->
L
,
n
,
TSŒšg
*);

156 
f
->
sizeupv®ues
=
n
;

157 
i
=0; i<
n
; i++è
f
->
upv®ues
[i]=
NULL
;

158 
i
=0; i<
n
; i++è
f
->
upv®ues
[i]=
	`LßdSŒšg
(
S
);

159 
	}
}

161 
PrÙo
* 
	$LßdFunùiÚ
(
LßdS‹
* 
S
, 
TSŒšg
* 
p
)

163 
PrÙo
* 
f
;

164 ià(++
S
->
L
->
nCÿÎs
 > 
LUAI_MAXCCALLS
è
	`”rÜ
(S,"codeoo deep");

165 
f
=
	`luaF_Ãw´Ùo
(
S
->
L
);

166 
	`£tv®ue2s
(
S
->
L
,S->L->
tİ
,
f
); 
	`šü_tİ
(S->L);

167 
f
->
sourû
=
	`LßdSŒšg
(
S
); ià(f->sourû==
NULL
èf->sourû=
p
;

168 
f
->
lšedefšed
=
	`LßdIÁ
(
S
);

169 
f
->
Ï¡lšedefšed
=
	`LßdIÁ
(
S
);

170 
f
->
nups
=
	`LßdBy‹
(
S
);

171 
f
->
num·¿ms
=
	`LßdBy‹
(
S
);

172 
f
->
is_v¬¬g
=
	`LßdBy‹
(
S
);

173 
f
->
max¡acksize
=
	`LßdBy‹
(
S
);

174 
	`LßdCode
(
S
,
f
);

175 
	`LßdCÚ¡ªts
(
S
,
f
);

176 
	`LßdDebug
(
S
,
f
);

177 
	`IF
 (!
	`luaG_checkcode
(
f
), "bad code");

178 
S
->
L
->
tİ
--;

179 
S
->
L
->
nCÿÎs
--;

180  
f
;

181 
	}
}

183 
	$LßdH—d”
(
LßdS‹
* 
S
)

185 
h
[
LUAC_HEADERSIZE
];

186 
s
[
LUAC_HEADERSIZE
];

187 
	`luaU_h—d”
(
h
);

188 
	`LßdBlock
(
S
,
s
,
LUAC_HEADERSIZE
);

189 
	`IF
 (
	`memcmp
(
h
,
s
,
LUAC_HEADERSIZE
)!=0, "bad header");

190 
	}
}

195 
PrÙo
* 
	$luaU_undump
 (
lua_S‹
* 
L
, 
ZIO
* 
Z
, 
Mbufãr
* 
buff
, cÚ¡ * 
Çme
)

197 
LßdS‹
 
S
;

198 ià(*
Çme
=='@' || *name=='=')

199 
S
.
Çme
=name+1;

200 ià(*
Çme
==
LUA_SIGNATURE
[0])

201 
S
.
Çme
="binary string";

203 
S
.
Çme
=name;

204 
S
.
L
=L;

205 
S
.
Z
=Z;

206 
S
.
b
=
buff
;

207 
	`LßdH—d”
(&
S
);

208  
	`LßdFunùiÚ
(&
S
,
	`luaS_Ãwl™”®
(
L
,"=?"));

209 
	}
}

214 
	$luaU_h—d”
 (* 
h
)

216 
x
=1;

217 
	`memıy
(
h
,
LUA_SIGNATURE
,(LUA_SIGNATURE)-1);

218 
h
+=(
LUA_SIGNATURE
)-1;

219 *
h
++=()
LUAC_VERSION
;

220 *
h
++=()
LUAC_FORMAT
;

221 *
h
++=()*(*)&
x
;

222 *
h
++=()();

223 *
h
++=()(
size_t
);

224 *
h
++=()(
In¡ruùiÚ
);

225 *
h
++=()(
lua_Numb”
);

226 *
h
++=()(((
lua_Numb”
)0.5)==0);

227 
	}
}

	@deps/lua/src/lundump.h

7 #iâdeà
lundump_h


8 
	#lundump_h


	)

10 
	~"lobjeù.h
"

11 
	~"lzio.h
"

14 
LUAI_FUNC
 
PrÙo
* 
luaU_undump
 (
lua_S‹
* 
L
, 
ZIO
* 
Z
, 
Mbufãr
* 
buff
, cÚ¡ * 
Çme
);

17 
LUAI_FUNC
 
luaU_h—d”
 (* 
h
);

20 
LUAI_FUNC
 
luaU_dump
 (
lua_S‹
* 
L
, cÚ¡ 
PrÙo
* 
f
, 
lua_Wr™”
 
w
, * 
d©a
, 
¡r
);

22 #ifdeà
luac_c


24 
LUAI_FUNC
 
luaU_´št
 (cÚ¡ 
PrÙo
* 
f
, 
fuÎ
);

28 
	#LUAC_VERSION
 0x51

	)

31 
	#LUAC_FORMAT
 0

	)

34 
	#LUAC_HEADERSIZE
 12

	)

	@deps/lua/src/lvm.c

8 
	~<¡dio.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

12 
	#lvm_c


	)

13 
	#LUA_CORE


	)

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lfunc.h
"

20 
	~"lgc.h
"

21 
	~"lobjeù.h
"

22 
	~"lİcodes.h
"

23 
	~"l¡©e.h
"

24 
	~"l¡ršg.h
"

25 
	~"ÉabË.h
"

26 
	~"Ém.h
"

27 
	~"lvm.h
"

32 
	#MAXTAGLOOP
 100

	)

35 cÚ¡ 
TV®ue
 *
	$luaV_tÚumb”
 (cÚ¡ 
TV®ue
 *
obj
, TV®u*
n
) {

36 
lua_Numb”
 
num
;

37 ià(
	`‰i¢umb”
(
obj
))  obj;

38 ià(
	`‰is¡ršg
(
obj
è&& 
	`luaO_¡r2d
(
	`sv®ue
(obj), &
num
)) {

39 
	`£Šv®ue
(
n
, 
num
);

40  
n
;

43  
NULL
;

44 
	}
}

47 
	$luaV_to¡ršg
 (
lua_S‹
 *
L
, 
StkId
 
obj
) {

48 ià(!
	`‰i¢umb”
(
obj
))

51 
s
[
LUAI_MAXNUMBER2STR
];

52 
lua_Numb”
 
n
 = 
	`nv®ue
(
obj
);

53 
	`lua_numb”2¡r
(
s
, 
n
);

54 
	`£tsv®ue2s
(
L
, 
obj
, 
	`luaS_Ãw
(L, 
s
));

57 
	}
}

60 
	$Œaûexec
 (
lua_S‹
 *
L
, cÚ¡ 
In¡ruùiÚ
 *
pc
) {

61 
lu_by‹
 
mask
 = 
L
->
hookmask
;

62 cÚ¡ 
In¡ruùiÚ
 *
Şdpc
 = 
L
->
§vedpc
;

63 
L
->
§vedpc
 = 
pc
;

64 ià((
mask
 & 
LUA_MASKCOUNT
è&& 
L
->
hookcouÁ
 == 0) {

65 
	`»£thookcouÁ
(
L
);

66 
	`luaD_ÿÎhook
(
L
, 
LUA_HOOKCOUNT
, -1);

68 ià(
mask
 & 
LUA_MASKLINE
) {

69 
PrÙo
 *
p
 = 
	`ci_func
(
L
->
ci
)->
l
.p;

70 
Åc
 = 
	`pcR–
(
pc
, 
p
);

71 
Ãwlše
 = 
	`g‘lše
(
p
, 
Åc
);

74 ià(
Åc
 =ğ0 || 
pc
 <ğ
Şdpc
 || 
Ãwlše
 !ğ
	`g‘lše
(
p
, 
	`pcR–
(oldpc,…)))

75 
	`luaD_ÿÎhook
(
L
, 
LUA_HOOKLINE
, 
Ãwlše
);

77 
	}
}

80 
	$ÿÎTM»s
 (
lua_S‹
 *
L
, 
StkId
 
»s
, cÚ¡ 
TV®ue
 *
f
,

81 cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
) {

82 
±rdiff_t
 
»suÉ
 = 
	`§ve¡ack
(
L
, 
»s
);

83 
	`£tobj2s
(
L
, L->
tİ
, 
f
);

84 
	`£tobj2s
(
L
, L->
tİ
+1, 
p1
);

85 
	`£tobj2s
(
L
, L->
tİ
+2, 
p2
);

86 
	`luaD_check¡ack
(
L
, 3);

87 
L
->
tİ
 += 3;

88 
	`luaD_ÿÎ
(
L
, L->
tİ
 - 3, 1);

89 
»s
 = 
	`»¡Üe¡ack
(
L
, 
»suÉ
);

90 
L
->
tİ
--;

91 
	`£tobjs2s
(
L
, 
»s
, L->
tİ
);

92 
	}
}

96 
	$ÿÎTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
f
, cÚ¡ TV®u*
p1
,

97 cÚ¡ 
TV®ue
 *
p2
, cÚ¡ TV®u*
p3
) {

98 
	`£tobj2s
(
L
, L->
tİ
, 
f
);

99 
	`£tobj2s
(
L
, L->
tİ
+1, 
p1
);

100 
	`£tobj2s
(
L
, L->
tİ
+2, 
p2
);

101 
	`£tobj2s
(
L
, L->
tİ
+3, 
p3
);

102 
	`luaD_check¡ack
(
L
, 4);

103 
L
->
tİ
 += 4;

104 
	`luaD_ÿÎ
(
L
, L->
tİ
 - 4, 0);

105 
	}
}

108 
	$luaV_g‘bË
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
, 
StkId
 
v®
) {

109 
loİ
;

110 
loİ
 = 0;†oİ < 
MAXTAGLOOP
;†oop++) {

111 cÚ¡ 
TV®ue
 *
tm
;

112 ià(
	`‰i¡abË
(
t
)) {

113 
TabË
 *
h
 = 
	`hv®ue
(
t
);

114 cÚ¡ 
TV®ue
 *
»s
 = 
	`luaH_g‘
(
h
, 
key
);

115 ià(!
	`‰i¢
(
»s
) ||

116 (
tm
 = 
	`ç¡tm
(
L
, 
h
->
m‘©abË
, 
TM_INDEX
)è=ğ
NULL
) {

117 
	`£tobj2s
(
L
, 
v®
, 
»s
);

122 ià(
	`‰i¢
(
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
t
, 
TM_INDEX
)))

123 
	`luaG_ty³”rÜ
(
L
, 
t
, "index");

124 ià(
	`‰isfunùiÚ
(
tm
)) {

125 
	`ÿÎTM»s
(
L
, 
v®
, 
tm
, 
t
, 
key
);

128 
t
 = 
tm
;

130 
	`luaG_ruÃ¼Ü
(
L
, "loop in gettable");

131 
	}
}

134 
	$luaV_£‰abË
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
, 
StkId
 
v®
) {

135 
loİ
;

136 
TV®ue
 
‹mp
;

137 
loİ
 = 0;†oİ < 
MAXTAGLOOP
;†oop++) {

138 cÚ¡ 
TV®ue
 *
tm
;

139 ià(
	`‰i¡abË
(
t
)) {

140 
TabË
 *
h
 = 
	`hv®ue
(
t
);

141 
TV®ue
 *
Şdv®
 = 
	`luaH_£t
(
L
, 
h
, 
key
);

142 ià(!
	`‰i¢
(
Şdv®
) ||

143 (
tm
 = 
	`ç¡tm
(
L
, 
h
->
m‘©abË
, 
TM_NEWINDEX
)è=ğ
NULL
) {

144 
	`£tobj2t
(
L
, 
Şdv®
, 
v®
);

145 
h
->
æags
 = 0;

146 
	`luaC_b¬r›¹
(
L
, 
h
, 
v®
);

151 ià(
	`‰i¢
(
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
t
, 
TM_NEWINDEX
)))

152 
	`luaG_ty³”rÜ
(
L
, 
t
, "index");

153 ià(
	`‰isfunùiÚ
(
tm
)) {

154 
	`ÿÎTM
(
L
, 
tm
, 
t
, 
key
, 
v®
);

158 
	`£tobj
(
L
, &
‹mp
, 
tm
);

159 
t
 = &
‹mp
;

161 
	`luaG_ruÃ¼Ü
(
L
, "loop in settable");

162 
	}
}

165 
	$ÿÎ_bšTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

166 
StkId
 
»s
, 
TMS
 
ev’t
) {

167 cÚ¡ 
TV®ue
 *
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
p1
, 
ev’t
);

168 ià(
	`‰i¢
(
tm
))

169 
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
p2
, 
ev’t
);

170 ià(
	`‰i¢
(
tm
))  0;

171 
	`ÿÎTM»s
(
L
, 
»s
, 
tm
, 
p1
, 
p2
);

173 
	}
}

176 cÚ¡ 
TV®ue
 *
	$g‘_compTM
 (
lua_S‹
 *
L
, 
TabË
 *
mt1
, TabË *
mt2
,

177 
TMS
 
ev’t
) {

178 cÚ¡ 
TV®ue
 *
tm1
 = 
	`ç¡tm
(
L
, 
mt1
, 
ev’t
);

179 cÚ¡ 
TV®ue
 *
tm2
;

180 ià(
tm1
 =ğ
NULL
)  NULL;

181 ià(
mt1
 =ğ
mt2
è 
tm1
;

182 
tm2
 = 
	`ç¡tm
(
L
, 
mt2
, 
ev’t
);

183 ià(
tm2
 =ğ
NULL
)  NULL;

184 ià(
	`luaO_¿wequ®Obj
(
tm1
, 
tm2
))

185  
tm1
;

186  
NULL
;

187 
	}
}

190 
	$ÿÎ_Üd”TM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

191 
TMS
 
ev’t
) {

192 cÚ¡ 
TV®ue
 *
tm1
 = 
	`luaT_g‘tmbyobj
(
L
, 
p1
, 
ev’t
);

193 cÚ¡ 
TV®ue
 *
tm2
;

194 ià(
	`‰i¢
(
tm1
))  -1;

195 
tm2
 = 
	`luaT_g‘tmbyobj
(
L
, 
p2
, 
ev’t
);

196 ià(!
	`luaO_¿wequ®Obj
(
tm1
, 
tm2
))

198 
	`ÿÎTM»s
(
L
, L->
tİ
, 
tm1
, 
p1
, 
p2
);

199  !
	`l_isçl£
(
L
->
tİ
);

200 
	}
}

203 
	$l_¡rcmp
 (cÚ¡ 
TSŒšg
 *
ls
, cÚ¡ TSŒšg *
rs
) {

204 cÚ¡ *
l
 = 
	`g‘¡r
(
ls
);

205 
size_t
 
Î
 = 
ls
->
tsv
.
Ën
;

206 cÚ¡ *
r
 = 
	`g‘¡r
(
rs
);

207 
size_t
 
Ì
 = 
rs
->
tsv
.
Ën
;

209 
‹mp
 = 
	`¡rcŞl
(
l
, 
r
);

210 ià(
‹mp
 != 0) emp;

212 
size_t
 
Ën
 = 
	`¡¾’
(
l
);

213 ià(
Ën
 =ğ
Ì
)

214  (
Ën
 =ğ
Î
) ? 0 : 1;

215 ià(
Ën
 =ğ
Î
)

218 
Ën
++;

219 
l
 +ğ
Ën
; 
Î
 -ğËn; 
r
 +ğËn; 
Ì
 -=†en;

222 
	}
}

225 
	$luaV_Ës¡hª
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
) {

226 
»s
;

227 ià(
	`‰y³
(
l
è!ğ‰y³(
r
))

228  
	`luaG_Üd””rÜ
(
L
, 
l
, 
r
);

229 ià(
	`‰i¢umb”
(
l
))

230  
	`luai_numÉ
(
	`nv®ue
(
l
),‚v®ue(
r
));

231 ià(
	`‰is¡ršg
(
l
))

232  
	`l_¡rcmp
(
	`¿wtsv®ue
(
l
),„awtsv®ue(
r
)) < 0;

233 ià((
»s
 = 
	`ÿÎ_Üd”TM
(
L
, 
l
, 
r
, 
TM_LT
)) != -1)

234  
»s
;

235  
	`luaG_Üd””rÜ
(
L
, 
l
, 
r
);

236 
	}
}

239 
	$Ës£qu®
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
) {

240 
»s
;

241 ià(
	`‰y³
(
l
è!ğ‰y³(
r
))

242  
	`luaG_Üd””rÜ
(
L
, 
l
, 
r
);

243 ià(
	`‰i¢umb”
(
l
))

244  
	`luai_numË
(
	`nv®ue
(
l
),‚v®ue(
r
));

245 ià(
	`‰is¡ršg
(
l
))

246  
	`l_¡rcmp
(
	`¿wtsv®ue
(
l
),„awtsv®ue(
r
)) <= 0;

247 ià((
»s
 = 
	`ÿÎ_Üd”TM
(
L
, 
l
, 
r
, 
TM_LE
)) != -1)

248  
»s
;

249 ià((
»s
 = 
	`ÿÎ_Üd”TM
(
L
, 
r
, 
l
, 
TM_LT
)) != -1)

250  !
»s
;

251  
	`luaG_Üd””rÜ
(
L
, 
l
, 
r
);

252 
	}
}

255 
	$luaV_equ®v®
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t1
, cÚ¡ TV®u*
t2
) {

256 cÚ¡ 
TV®ue
 *
tm
;

257 
	`lua_as£¹
(
	`‰y³
(
t1
è=ğ‰y³(
t2
));

258 
	`‰y³
(
t1
)) {

259 
LUA_TNIL
:  1;

260 
LUA_TNUMBER
:  
	`luai_numeq
(
	`nv®ue
(
t1
),‚v®ue(
t2
));

261 
LUA_TBOOLEAN
:  
	`bv®ue
(
t1
è=ğbv®ue(
t2
);

262 
LUA_TLIGHTUSERDATA
:  
	`pv®ue
(
t1
è=ğpv®ue(
t2
);

263 
LUA_TUSERDATA
: {

264 ià(
	`uv®ue
(
t1
è=ğuv®ue(
t2
))  1;

265 
tm
 = 
	`g‘_compTM
(
L
, 
	`uv®ue
(
t1
)->
m‘©abË
, uv®ue(
t2
)->metatable,

266 
TM_EQ
);

269 
LUA_TTABLE
: {

270 ià(
	`hv®ue
(
t1
è=ğhv®ue(
t2
))  1;

271 
tm
 = 
	`g‘_compTM
(
L
, 
	`hv®ue
(
t1
)->
m‘©abË
, hv®ue(
t2
)->m‘©abË, 
TM_EQ
);

274 :  
	`gcv®ue
(
t1
è=ğgcv®ue(
t2
);

276 ià(
tm
 =ğ
NULL
)  0;

277 
	`ÿÎTM»s
(
L
, L->
tİ
, 
tm
, 
t1
, 
t2
);

278  !
	`l_isçl£
(
L
->
tİ
);

279 
	}
}

282 
	$luaV_cÚÿt
 (
lua_S‹
 *
L
, 
tÙ®
, 
Ï¡
) {

284 
StkId
 
tİ
 = 
L
->
ba£
 + 
Ï¡
 + 1;

285 
n
 = 2;

286 ià(!(
	`‰is¡ršg
(
tİ
-2è|| 
	`‰i¢umb”
Ñİ-2)è|| !
	`to¡ršg
(
L
,op-1)) {

287 ià(!
	`ÿÎ_bšTM
(
L
, 
tİ
-2,İ-1,İ-2, 
TM_CONCAT
))

288 
	`luaG_cÚÿ‹¼Ü
(
L
, 
tİ
-2,op-1);

289 } ià(
	`tsv®ue
(
tİ
-1)->
Ën
 == 0)

290 ()
	`to¡ršg
(
L
, 
tİ
 - 2);

293 
size_t
 

 = 
	`tsv®ue
(
tİ
-1)->
Ën
;

294 *
bufãr
;

295 
i
;

297 
n
 = 1;‚ < 
tÙ®
 && 
	`to¡ršg
(
L
, 
tİ
-n-1);‚++) {

298 
size_t
 
l
 = 
	`tsv®ue
(
tİ
-
n
-1)->
Ën
;

299 ià(
l
 >ğ
MAX_SIZET
 - 

è
	`luaG_ruÃ¼Ü
(
L
, "string†ength overflow");

300 

 +ğ
l
;

302 
bufãr
 = 
	`luaZ_İ’¥aû
(
L
, &
	`G
(L)->
buff
, 

);

303 

 = 0;

304 
i
=
n
; i>0; i--) {

305 
size_t
 
l
 = 
	`tsv®ue
(
tİ
-
i
)->
Ën
;

306 
	`memıy
(
bufãr
+

, 
	`sv®ue
(
tİ
-
i
), 
l
);

307 

 +ğ
l
;

309 
	`£tsv®ue2s
(
L
, 
tİ
-
n
, 
	`luaS_Ãwl¡r
(L, 
bufãr
, 

));

311 
tÙ®
 -ğ
n
-1;

312 
Ï¡
 -ğ
n
-1;

313 } 
tÙ®
 > 1);

314 
	}
}

317 
	$Ar™h
 (
lua_S‹
 *
L
, 
StkId
 
¿
, cÚ¡ 
TV®ue
 *
rb
,

318 cÚ¡ 
TV®ue
 *
rc
, 
TMS
 
İ
) {

319 
TV®ue
 
‹mpb
, 
‹mpc
;

320 cÚ¡ 
TV®ue
 *
b
, *
c
;

321 ià((
b
 = 
	`luaV_tÚumb”
(
rb
, &
‹mpb
)è!ğ
NULL
 &&

322 (
c
 = 
	`luaV_tÚumb”
(
rc
, &
‹mpc
)è!ğ
NULL
) {

323 
lua_Numb”
 
nb
 = 
	`nv®ue
(
b
), 
nc
 =‚v®ue(
c
);

324 
İ
) {

325 
TM_ADD
: 
	`£Šv®ue
(
¿
, 
	`luai_numadd
(
nb
, 
nc
)); ;

326 
TM_SUB
: 
	`£Šv®ue
(
¿
, 
	`luai_numsub
(
nb
, 
nc
)); ;

327 
TM_MUL
: 
	`£Šv®ue
(
¿
, 
	`luai_nummul
(
nb
, 
nc
)); ;

328 
TM_DIV
: 
	`£Šv®ue
(
¿
, 
	`luai_numdiv
(
nb
, 
nc
)); ;

329 
TM_MOD
: 
	`£Šv®ue
(
¿
, 
	`luai_nummod
(
nb
, 
nc
)); ;

330 
TM_POW
: 
	`£Šv®ue
(
¿
, 
	`luai_numpow
(
nb
, 
nc
)); ;

331 
TM_UNM
: 
	`£Šv®ue
(
¿
, 
	`luai_numunm
(
nb
)); ;

332 : 
	`lua_as£¹
(0); ;

335 ià(!
	`ÿÎ_bšTM
(
L
, 
rb
, 
rc
, 
¿
, 
İ
))

336 
	`luaG_¬™h”rÜ
(
L
, 
rb
, 
rc
);

337 
	}
}

345 
	#ruÁime_check
(
L
, 
c
è{ ià(!(c)è; }

	)

347 
	#RA
(
i
è(
ba£
+
	`GETARG_A
(i))

	)

349 
	#RB
(
i
è
	`check_exp
(
	`g‘BMode
(
	`GET_OPCODE
(i)è=ğ
OpArgR
, 
ba£
+
	`GETARG_B
(i))

	)

350 
	#RC
(
i
è
	`check_exp
(
	`g‘CMode
(
	`GET_OPCODE
(i)è=ğ
OpArgR
, 
ba£
+
	`GETARG_C
(i))

	)

351 
	#RKB
(
i
è
	`check_exp
(
	`g‘BMode
(
	`GET_OPCODE
(i)è=ğ
OpArgK
, \

352 
	`ISK
(
	`GETARG_B
(
i
)è? 
k
+
	`INDEXK
(GETARG_B(i)è: 
ba£
+GETARG_B(i))

	)

353 
	#RKC
(
i
è
	`check_exp
(
	`g‘CMode
(
	`GET_OPCODE
(i)è=ğ
OpArgK
, \

354 
	`ISK
(
	`GETARG_C
(
i
)è? 
k
+
	`INDEXK
(GETARG_C(i)è: 
ba£
+GETARG_C(i))

	)

355 
	#KBx
(
i
è
	`check_exp
(
	`g‘BMode
(
	`GET_OPCODE
(i)è=ğ
OpArgK
, 
k
+
	`GETARG_Bx
(i))

	)

358 
	#dojump
(
L
,
pc
,
i
è{Õcè+ğ(i); 
	`luai_th»ady›ld
(L);}

	)

361 
	#PrÙeù
(
x
è{ 
L
->
§vedpc
 = 
pc
; {x;}; 
ba£
 = L->ba£; }

	)

364 
	#¬™h_İ
(
İ
,
tm
) { \

365 
TV®ue
 *
rb
 = 
	`RKB
(
i
); \

366 
TV®ue
 *
rc
 = 
	`RKC
(
i
); \

367 ià(
	`‰i¢umb”
(
rb
è&&ti¢umb”(
rc
)) { \

368 
lua_Numb”
 
nb
 = 
	`nv®ue
(
rb
), 
nc
 =‚v®ue(
rc
); \

369 
	`£Šv®ue
(
¿
, 
	`İ
(
nb
, 
nc
)); \

372 
	`PrÙeù
(
	`Ar™h
(
L
, 
¿
, 
rb
, 
rc
, 
tm
)); \

373 }

	)

377 
	$luaV_execu‹
 (
lua_S‹
 *
L
, 
ÃxecÿÎs
) {

378 
LClosu»
 *
ş
;

379 
StkId
 
ba£
;

380 
TV®ue
 *
k
;

381 cÚ¡ 
In¡ruùiÚ
 *
pc
;

382 
»’Œy
:

383 
	`lua_as£¹
(
	`isLua
(
L
->
ci
));

384 
pc
 = 
L
->
§vedpc
;

385 
ş
 = &
	`şv®ue
(
L
->
ci
->
func
)->
l
;

386 
ba£
 = 
L
->base;

387 
k
 = 
ş
->
p
->k;

390 cÚ¡ 
In¡ruùiÚ
 
i
 = *
pc
++;

391 
StkId
 
¿
;

392 ià((
L
->
hookmask
 & (
LUA_MASKLINE
 | 
LUA_MASKCOUNT
)) &&

393 (--
L
->
hookcouÁ
 =ğ0 || L->
hookmask
 & 
LUA_MASKLINE
)) {

394 
	`Œaûexec
(
L
, 
pc
);

395 ià(
L
->
¡©us
 =ğ
LUA_YIELD
) {

396 
L
->
§vedpc
 = 
pc
 - 1;

399 
ba£
 = 
L
->base;

402 
¿
 = 
	`RA
(
i
);

403 
	`lua_as£¹
(
ba£
 =ğ
L
->ba£ && L->ba£ =ğL->
ci
->base);

404 
	`lua_as£¹
(
ba£
 <ğ
L
->
tİ
 && L->tİ <ğL->
¡ack
 + L->
¡acksize
);

405 
	`lua_as£¹
(
L
->
tİ
 =ğL->
ci
->tİ || 
	`luaG_checkİ’İ
(
i
));

406 
	`GET_OPCODE
(
i
)) {

407 
OP_MOVE
: {

408 
	`£tobjs2s
(
L
, 
¿
, 
	`RB
(
i
));

411 
OP_LOADK
: {

412 
	`£tobj2s
(
L
, 
¿
, 
	`KBx
(
i
));

415 
OP_LOADBOOL
: {

416 
	`£tbv®ue
(
¿
, 
	`GETARG_B
(
i
));

417 ià(
	`GETARG_C
(
i
)è
pc
++;

420 
OP_LOADNIL
: {

421 
TV®ue
 *
rb
 = 
	`RB
(
i
);

423 
	`£Šv®ue
(
rb
--);

424 } 
rb
 >ğ
¿
);

427 
OP_GETUPVAL
: {

428 
b
 = 
	`GETARG_B
(
i
);

429 
	`£tobj2s
(
L
, 
¿
, 
ş
->
upv®s
[
b
]->
v
);

432 
OP_GETGLOBAL
: {

433 
TV®ue
 
g
;

434 
TV®ue
 *
rb
 = 
	`KBx
(
i
);

435 
	`£thv®ue
(
L
, &
g
, 
ş
->
’v
);

436 
	`lua_as£¹
(
	`‰is¡ršg
(
rb
));

437 
	`PrÙeù
(
	`luaV_g‘bË
(
L
, &
g
, 
rb
, 
¿
));

440 
OP_GETTABLE
: {

441 
	`PrÙeù
(
	`luaV_g‘bË
(
L
, 
	`RB
(
i
), 
	`RKC
(i), 
¿
));

444 
OP_SETGLOBAL
: {

445 
TV®ue
 
g
;

446 
	`£thv®ue
(
L
, &
g
, 
ş
->
’v
);

447 
	`lua_as£¹
(
	`‰is¡ršg
(
	`KBx
(
i
)));

448 
	`PrÙeù
(
	`luaV_£‰abË
(
L
, &
g
, 
	`KBx
(
i
), 
¿
));

451 
OP_SETUPVAL
: {

452 
UpV®
 *
uv
 = 
ş
->
upv®s
[
	`GETARG_B
(
i
)];

453 
	`£tobj
(
L
, 
uv
->
v
, 
¿
);

454 
	`luaC_b¬r›r
(
L
, 
uv
, 
¿
);

457 
OP_SETTABLE
: {

458 
	`PrÙeù
(
	`luaV_£‰abË
(
L
, 
¿
, 
	`RKB
(
i
), 
	`RKC
(i)));

461 
OP_NEWTABLE
: {

462 
b
 = 
	`GETARG_B
(
i
);

463 
c
 = 
	`GETARG_C
(
i
);

464 
	`£thv®ue
(
L
, 
¿
, 
	`luaH_Ãw
(L, 
	`luaO_fb2št
(
b
),†uaO_fb2št(
c
)));

465 
	`PrÙeù
(
	`luaC_checkGC
(
L
));

468 
OP_SELF
: {

469 
StkId
 
rb
 = 
	`RB
(
i
);

470 
	`£tobjs2s
(
L
, 
¿
+1, 
rb
);

471 
	`PrÙeù
(
	`luaV_g‘bË
(
L
, 
rb
, 
	`RKC
(
i
), 
¿
));

474 
OP_ADD
: {

475 
	`¬™h_İ
(
luai_numadd
, 
TM_ADD
);

478 
OP_SUB
: {

479 
	`¬™h_İ
(
luai_numsub
, 
TM_SUB
);

482 
OP_MUL
: {

483 
	`¬™h_İ
(
luai_nummul
, 
TM_MUL
);

486 
OP_DIV
: {

487 
	`¬™h_İ
(
luai_numdiv
, 
TM_DIV
);

490 
OP_MOD
: {

491 
	`¬™h_İ
(
luai_nummod
, 
TM_MOD
);

494 
OP_POW
: {

495 
	`¬™h_İ
(
luai_numpow
, 
TM_POW
);

498 
OP_UNM
: {

499 
TV®ue
 *
rb
 = 
	`RB
(
i
);

500 ià(
	`‰i¢umb”
(
rb
)) {

501 
lua_Numb”
 
nb
 = 
	`nv®ue
(
rb
);

502 
	`£Šv®ue
(
¿
, 
	`luai_numunm
(
nb
));

505 
	`PrÙeù
(
	`Ar™h
(
L
, 
¿
, 
rb
,„b, 
TM_UNM
));

509 
OP_NOT
: {

510 
»s
 = 
	`l_isçl£
(
	`RB
(
i
));

511 
	`£tbv®ue
(
¿
, 
»s
);

514 
OP_LEN
: {

515 cÚ¡ 
TV®ue
 *
rb
 = 
	`RB
(
i
);

516 
	`‰y³
(
rb
)) {

517 
LUA_TTABLE
: {

518 
	`£Šv®ue
(
¿
, 
	`ÿ¡_num
(
	`luaH_g‘n
(
	`hv®ue
(
rb
))));

521 
LUA_TSTRING
: {

522 
	`£Šv®ue
(
¿
, 
	`ÿ¡_num
(
	`tsv®ue
(
rb
)->
Ën
));

526 
	`PrÙeù
(

527 ià(!
	`ÿÎ_bšTM
(
L
, 
rb
, 
luaO_nobjeù
, 
¿
, 
TM_LEN
))

528 
	`luaG_ty³”rÜ
(
L
, 
rb
, "get†ength of");

534 
OP_CONCAT
: {

535 
b
 = 
	`GETARG_B
(
i
);

536 
c
 = 
	`GETARG_C
(
i
);

537 
	`PrÙeù
(
	`luaV_cÚÿt
(
L
, 
c
-
b
+1, c); 
	`luaC_checkGC
(L));

538 
	`£tobjs2s
(
L
, 
	`RA
(
i
), 
ba£
+
b
);

541 
OP_JMP
: {

542 
	`dojump
(
L
, 
pc
, 
	`GETARG_sBx
(
i
));

545 
OP_EQ
: {

546 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

547 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

548 
	`PrÙeù
(

549 ià(
	`equ®obj
(
L
, 
rb
, 
rc
è=ğ
	`GETARG_A
(
i
))

550 
	`dojump
(
L
, 
pc
, 
	`GETARG_sBx
(*pc));

552 
pc
++;

555 
OP_LT
: {

556 
	`PrÙeù
(

557 ià(
	`luaV_Ës¡hª
(
L
, 
	`RKB
(
i
), 
	`RKC
(i)è=ğ
	`GETARG_A
(i))

558 
	`dojump
(
L
, 
pc
, 
	`GETARG_sBx
(*pc));

560 
pc
++;

563 
OP_LE
: {

564 
	`PrÙeù
(

565 ià(
	`Ës£qu®
(
L
, 
	`RKB
(
i
), 
	`RKC
(i)è=ğ
	`GETARG_A
(i))

566 
	`dojump
(
L
, 
pc
, 
	`GETARG_sBx
(*pc));

568 
pc
++;

571 
OP_TEST
: {

572 ià(
	`l_isçl£
(
¿
è!ğ
	`GETARG_C
(
i
))

573 
	`dojump
(
L
, 
pc
, 
	`GETARG_sBx
(*pc));

574 
pc
++;

577 
OP_TESTSET
: {

578 
TV®ue
 *
rb
 = 
	`RB
(
i
);

579 ià(
	`l_isçl£
(
rb
è!ğ
	`GETARG_C
(
i
)) {

580 
	`£tobjs2s
(
L
, 
¿
, 
rb
);

581 
	`dojump
(
L
, 
pc
, 
	`GETARG_sBx
(*pc));

583 
pc
++;

586 
OP_CALL
: {

587 
b
 = 
	`GETARG_B
(
i
);

588 
ÄesuÉs
 = 
	`GETARG_C
(
i
) - 1;

589 ià(
b
 !ğ0è
L
->
tİ
 = 
¿
+b;

590 
L
->
§vedpc
 = 
pc
;

591 
	`luaD_´eÿÎ
(
L
, 
¿
, 
ÄesuÉs
)) {

592 
PCRLUA
: {

593 
ÃxecÿÎs
++;

594 
»’Œy
;

596 
PCRC
: {

598 ià(
ÄesuÉs
 >ğ0è
L
->
tİ
 = L->
ci
->top;

599 
ba£
 = 
L
->base;

607 
OP_TAILCALL
: {

608 
b
 = 
	`GETARG_B
(
i
);

609 ià(
b
 !ğ0è
L
->
tİ
 = 
¿
+b;

610 
L
->
§vedpc
 = 
pc
;

611 
	`lua_as£¹
(
	`GETARG_C
(
i
è- 1 =ğ
LUA_MULTRET
);

612 
	`luaD_´eÿÎ
(
L
, 
¿
, 
LUA_MULTRET
)) {

613 
PCRLUA
: {

615 
C®lInfo
 *
ci
 = 
L
->ci - 1;

616 
aux
;

617 
StkId
 
func
 = 
ci
->func;

618 
StkId
 
pfunc
 = (
ci
+1)->
func
;

619 ià(
L
->
İ’upv®
è
	`luaF_şo£
(L, 
ci
->
ba£
);

620 
L
->
ba£
 = 
ci
->ba£ = ci->
func
 + ((ci+1)->ba£ - 
pfunc
);

621 
aux
 = 0; 
pfunc
+aux < 
L
->
tİ
;‡ux++)

622 
	`£tobjs2s
(
L
, 
func
+
aux
, 
pfunc
+aux);

623 
ci
->
tİ
 = 
L
->tİ = 
func
+
aux
;

624 
	`lua_as£¹
(
L
->
tİ
 =ğL->
ba£
 + 
	`şv®ue
(
func
)->
l
.
p
->
max¡acksize
);

625 
ci
->
§vedpc
 = 
L
->savedpc;

626 
ci
->
ÿÎs
++;

627 
L
->
ci
--;

628 
»’Œy
;

630 
PCRC
: {

631 
ba£
 = 
L
->base;

639 
OP_RETURN
: {

640 
b
 = 
	`GETARG_B
(
i
);

641 ià(
b
 !ğ0è
L
->
tİ
 = 
¿
+b-1;

642 ià(
L
->
İ’upv®
è
	`luaF_şo£
(L, 
ba£
);

643 
L
->
§vedpc
 = 
pc
;

644 
b
 = 
	`luaD_posÿÎ
(
L
, 
¿
);

645 ià(--
ÃxecÿÎs
 == 0)

648 ià(
b
è
L
->
tİ
 = L->
ci
->top;

649 
	`lua_as£¹
(
	`isLua
(
L
->
ci
));

650 
	`lua_as£¹
(
	`GET_OPCODE
(*((
L
->
ci
)->
§vedpc
 - 1)è=ğ
OP_CALL
);

651 
»’Œy
;

654 
OP_FORLOOP
: {

655 
lua_Numb”
 
¡•
 = 
	`nv®ue
(
¿
+2);

656 
lua_Numb”
 
idx
 = 
	`luai_numadd
(
	`nv®ue
(
¿
), 
¡•
);

657 
lua_Numb”
 
lim™
 = 
	`nv®ue
(
¿
+1);

658 ià(
	`luai_numÉ
(0, 
¡•
è? 
	`luai_numË
(
idx
, 
lim™
)

659 : 
	`luai_numË
(
lim™
, 
idx
)) {

660 
	`dojump
(
L
, 
pc
, 
	`GETARG_sBx
(
i
));

661 
	`£Šv®ue
(
¿
, 
idx
);

662 
	`£Šv®ue
(
¿
+3, 
idx
);

666 
OP_FORPREP
: {

667 cÚ¡ 
TV®ue
 *
š™
 = 
¿
;

668 cÚ¡ 
TV®ue
 *
¶im™
 = 
¿
+1;

669 cÚ¡ 
TV®ue
 *
p¡•
 = 
¿
+2;

670 
L
->
§vedpc
 = 
pc
;

671 ià(!
	`tÚumb”
(
š™
, 
¿
))

672 
	`luaG_ruÃ¼Ü
(
L
, 
	`LUA_QL
("for") " initial value must be‡‚umber");

673 ià(!
	`tÚumb”
(
¶im™
, 
¿
+1))

674 
	`luaG_ruÃ¼Ü
(
L
, 
	`LUA_QL
("for") "†imit must be‡‚umber");

675 ià(!
	`tÚumb”
(
p¡•
, 
¿
+2))

676 
	`luaG_ruÃ¼Ü
(
L
, 
	`LUA_QL
("for") " step must be‡‚umber");

677 
	`£Šv®ue
(
¿
, 
	`luai_numsub
(
	`nv®ue
Ôa),‚v®ue(
p¡•
)));

678 
	`dojump
(
L
, 
pc
, 
	`GETARG_sBx
(
i
));

681 
OP_TFORLOOP
: {

682 
StkId
 
cb
 = 
¿
 + 3;

683 
	`£tobjs2s
(
L
, 
cb
+2, 
¿
+2);

684 
	`£tobjs2s
(
L
, 
cb
+1, 
¿
+1);

685 
	`£tobjs2s
(
L
, 
cb
, 
¿
);

686 
L
->
tİ
 = 
cb
+3;

687 
	`PrÙeù
(
	`luaD_ÿÎ
(
L
, 
cb
, 
	`GETARG_C
(
i
)));

688 
L
->
tİ
 = L->
ci
->top;

689 
cb
 = 
	`RA
(
i
) + 3;

690 ià(!
	`‰i¢
(
cb
)) {

691 
	`£tobjs2s
(
L
, 
cb
-1, cb);

692 
	`dojump
(
L
, 
pc
, 
	`GETARG_sBx
(*pc));

694 
pc
++;

697 
OP_SETLIST
: {

698 
n
 = 
	`GETARG_B
(
i
);

699 
c
 = 
	`GETARG_C
(
i
);

700 
Ï¡
;

701 
TabË
 *
h
;

702 ià(
n
 == 0) {

703 
n
 = 
	`ÿ¡_št
(
L
->
tİ
 - 
¿
) - 1;

704 
L
->
tİ
 = L->
ci
->top;

706 ià(
c
 =ğ0èøğ
	`ÿ¡_št
(*
pc
++);

707 
	`ruÁime_check
(
L
, 
	`‰i¡abË
(
¿
));

708 
h
 = 
	`hv®ue
(
¿
);

709 
Ï¡
 = ((
c
-1)*
LFIELDS_PER_FLUSH
è+ 
n
;

710 ià(
Ï¡
 > 
h
->
siz—¼ay
)

711 
	`luaH_»siz—¼ay
(
L
, 
h
, 
Ï¡
);

712 ; 
n
 > 0;‚--) {

713 
TV®ue
 *
v®
 = 
¿
+
n
;

714 
	`£tobj2t
(
L
, 
	`luaH_£Šum
(L, 
h
, 
Ï¡
--), 
v®
);

715 
	`luaC_b¬r›¹
(
L
, 
h
, 
v®
);

719 
OP_CLOSE
: {

720 
	`luaF_şo£
(
L
, 
¿
);

723 
OP_CLOSURE
: {

724 
PrÙo
 *
p
;

725 
Closu»
 *
nş
;

726 
nup
, 
j
;

727 
p
 = 
ş
->p->p[
	`GETARG_Bx
(
i
)];

728 
nup
 = 
p
->
nups
;

729 
nş
 = 
	`luaF_ÃwLşosu»
(
L
, 
nup
, 
ş
->
’v
);

730 
nş
->
l
.
p
 =…;

731 
j
=0; j<
nup
; j++, 
pc
++) {

732 ià(
	`GET_OPCODE
(*
pc
è=ğ
OP_GETUPVAL
)

733 
nş
->
l
.
upv®s
[
j
] = 
ş
->upv®s[
	`GETARG_B
(*
pc
)];

735 
	`lua_as£¹
(
	`GET_OPCODE
(*
pc
è=ğ
OP_MOVE
);

736 
nş
->
l
.
upv®s
[
j
] = 
	`luaF_fšdupv®
(
L
, 
ba£
 + 
	`GETARG_B
(*
pc
));

739 
	`£tşv®ue
(
L
, 
¿
, 
nş
);

740 
	`PrÙeù
(
	`luaC_checkGC
(
L
));

743 
OP_VARARG
: {

744 
b
 = 
	`GETARG_B
(
i
) - 1;

745 
j
;

746 
C®lInfo
 *
ci
 = 
L
->ci;

747 
n
 = 
	`ÿ¡_št
(
ci
->
ba£
 - ci->
func
è- 
ş
->
p
->
num·¿ms
 - 1;

748 ià(
b
 =ğ
LUA_MULTRET
) {

749 
	`PrÙeù
(
	`luaD_check¡ack
(
L
, 
n
));

750 
¿
 = 
	`RA
(
i
);

751 
b
 = 
n
;

752 
L
->
tİ
 = 
¿
 + 
n
;

754 
j
 = 0; j < 
b
; j++) {

755 ià(
j
 < 
n
) {

756 
	`£tobjs2s
(
L
, 
¿
 + 
j
, 
ci
->
ba£
 - 
n
 + j);

759 
	`£Šv®ue
(
¿
 + 
j
);

766 
	}
}

	@deps/lua/src/lvm.h

7 #iâdeà
lvm_h


8 
	#lvm_h


	)

11 
	~"ldo.h
"

12 
	~"lobjeù.h
"

13 
	~"Ém.h
"

16 
	#to¡ršg
(
L
,
o
è((
	`‰y³
(oè=ğ
LUA_TSTRING
è|| (
	`luaV_to¡ršg
(L, o)))

	)

18 
	#tÚumb”
(
o
,
n
è(
	`‰y³
(oè=ğ
LUA_TNUMBER
 || \

19 (((
o
èğ
	`luaV_tÚumb”
(o,
n
)è!ğ
NULL
))

	)

21 
	#equ®obj
(
L
,
o1
,
o2
) \

22 (
	`‰y³
(
o1
è=ğ‰y³(
o2
è&& 
	`luaV_equ®v®
(
L
, o1, o2))

	)

25 
LUAI_FUNC
 
luaV_Ës¡hª
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
);

26 
LUAI_FUNC
 
luaV_equ®v®
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t1
, cÚ¡ TV®u*
t2
);

27 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaV_tÚumb”
 (cÚ¡ TV®u*
obj
, TV®u*
n
);

28 
LUAI_FUNC
 
luaV_to¡ršg
 (
lua_S‹
 *
L
, 
StkId
 
obj
);

29 
LUAI_FUNC
 
luaV_g‘bË
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
,

30 
StkId
 
v®
);

31 
LUAI_FUNC
 
luaV_£‰abË
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
,

32 
StkId
 
v®
);

33 
LUAI_FUNC
 
luaV_execu‹
 (
lua_S‹
 *
L
, 
ÃxecÿÎs
);

34 
LUAI_FUNC
 
luaV_cÚÿt
 (
lua_S‹
 *
L
, 
tÙ®
, 
Ï¡
);

	@deps/lua/src/lzio.c

8 
	~<¡ršg.h
>

10 
	#lzio_c


	)

11 
	#LUA_CORE


	)

13 
	~"lua.h
"

15 
	~"Îim™s.h
"

16 
	~"lmem.h
"

17 
	~"l¡©e.h
"

18 
	~"lzio.h
"

21 
	$luaZ_fl
 (
ZIO
 *
z
) {

22 
size_t
 
size
;

23 
lua_S‹
 *
L
 = 
z
->L;

24 cÚ¡ *
buff
;

25 
	`lua_uÆock
(
L
);

26 
buff
 = 
z
->
	`»ad”
(
L
, z->
d©a
, &
size
);

27 
	`lua_lock
(
L
);

28 ià(
buff
 =ğ
NULL
 || 
size
 =ğ0è 
EOZ
;

29 
z
->
n
 = 
size
 - 1;

30 
z
->
p
 = 
buff
;

31  
	`ch¬2št
(*(
z
->
p
++));

32 
	}
}

35 
	$luaZ_lookah—d
 (
ZIO
 *
z
) {

36 ià(
z
->
n
 == 0) {

37 ià(
	`luaZ_fl
(
z
è=ğ
EOZ
)

38  
EOZ
;

40 
z
->
n
++;

41 
z
->
p
--;

44  
	`ch¬2št
(*
z
->
p
);

45 
	}
}

48 
	$luaZ_š™
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
lua_R—d”
 
»ad”
, *
d©a
) {

49 
z
->
L
 = L;

50 
z
->
»ad”
 =„eader;

51 
z
->
d©a
 = data;

52 
z
->
n
 = 0;

53 
z
->
p
 = 
NULL
;

54 
	}
}

58 
size_t
 
	$luaZ_»ad
 (
ZIO
 *
z
, *
b
, 
size_t
 
n
) {

59 
n
) {

60 
size_t
 
m
;

61 ià(
	`luaZ_lookah—d
(
z
è=ğ
EOZ
)

62  
n
;

63 
m
 = (
n
 <ğ
z
->n) ?‚ : z->n;

64 
	`memıy
(
b
, 
z
->
p
, 
m
);

65 
z
->
n
 -ğ
m
;

66 
z
->
p
 +ğ
m
;

67 
b
 = (*)b + 
m
;

68 
n
 -ğ
m
;

71 
	}
}

74 *
	$luaZ_İ’¥aû
 (
lua_S‹
 *
L
, 
Mbufãr
 *
buff
, 
size_t
 
n
) {

75 ià(
n
 > 
buff
->
buffsize
) {

76 ià(
n
 < 
LUA_MINBUFFER
)‚ = LUA_MINBUFFER;

77 
	`luaZ_»sizebufãr
(
L
, 
buff
, 
n
);

79  
buff
->
bufãr
;

80 
	}
}

	@deps/lua/src/lzio.h

8 #iâdeà
lzio_h


9 
	#lzio_h


	)

11 
	~"lua.h
"

13 
	~"lmem.h
"

16 
	#EOZ
 (-1è

	)

18 
Zio
 
	tZIO
;

20 
	#ch¬2št
(
c
è
	`ÿ¡
(, ca¡(, (c)))

	)

22 
	#zg‘c
(
z
è(((z)->
n
--)>0 ? 
	`ch¬2št
(*(z)->
p
++è: 
	`luaZ_fl
(z))

	)

24 
	sMbufãr
 {

25 *
	mbufãr
;

26 
size_t
 
	mn
;

27 
size_t
 
	mbuffsize
;

28 } 
	tMbufãr
;

30 
	#luaZ_š™bufãr
(
L
, 
buff
è((buff)->
bufãr
 = 
NULL
, (buff)->
buffsize
 = 0)

	)

32 
	#luaZ_bufãr
(
buff
è((buff)->
bufãr
)

	)

33 
	#luaZ_sizebufãr
(
buff
è((buff)->
buffsize
)

	)

34 
	#luaZ_bufæ’
(
buff
è((buff)->
n
)

	)

36 
	#luaZ_»£tbufãr
(
buff
è((buff)->
n
 = 0)

	)

39 
	#luaZ_»sizebufãr
(
L
, 
buff
, 
size
) \

40 (
	`luaM_»®locveùÜ
(
L
, (
buff
)->
bufãr
, (buff)->
buffsize
, 
size
, ), \

41 (
buff
)->
buffsize
 = 
size
)

	)

43 
	#luaZ_ä“bufãr
(
L
, 
buff
è
	`luaZ_»sizebufãr
(L, buff, 0)

	)

46 
LUAI_FUNC
 *
luaZ_İ’¥aû
 (
lua_S‹
 *
L
, 
Mbufãr
 *
buff
, 
size_t
 
n
);

47 
LUAI_FUNC
 
luaZ_š™
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
lua_R—d”
 
»ad”
,

48 *
d©a
);

49 
LUAI_FUNC
 
size_t
 
luaZ_»ad
 (
ZIO
* 
z
, * 
b
, size_ˆ
n
);

50 
LUAI_FUNC
 
luaZ_lookah—d
 (
ZIO
 *
z
);

56 
	sZio
 {

57 
size_t
 
	mn
;

58 cÚ¡ *
	mp
;

59 
lua_R—d”
 
	m»ad”
;

60 * 
	md©a
;

61 
lua_S‹
 *
	mL
;

65 
LUAI_FUNC
 
luaZ_fl
 (
ZIO
 *
z
);

	@deps/lua/src/print.c

7 
	~<ùy³.h
>

8 
	~<¡dio.h
>

10 
	#luac_c


	)

11 
	#LUA_CORE


	)

13 
	~"ldebug.h
"

14 
	~"lobjeù.h
"

15 
	~"lİcodes.h
"

16 
	~"lundump.h
"

18 
	#PrštFunùiÚ
 
luaU_´št


	)

20 
	#Sizeof
(
x
è(()(x))

	)

21 
	#VOID
(
p
è((cÚ¡ *)Õ))

	)

23 
	$PrštSŒšg
(cÚ¡ 
TSŒšg
* 
ts
)

25 cÚ¡ * 
s
=
	`g‘¡r
(
ts
);

26 
size_t
 
i
,
n
=
ts
->
tsv
.
Ën
;

27 
	`putch¬
('"');

28 
i
=0; i<
n
; i++)

30 
c
=
s
[
i
];

31 
c
)

33 '"': 
	`´štf
("\\\""); ;

34 '\\': 
	`´štf
("\\\\"); ;

35 '\a': 
	`´štf
("\\a"); ;

36 '\b': 
	`´štf
("\\b"); ;

37 '\f': 
	`´štf
("\\f"); ;

38 '\n': 
	`´štf
("\\n"); ;

39 '\r': 
	`´štf
("\\r"); ;

40 '\t': 
	`´štf
("\\t"); ;

41 '\v': 
	`´štf
("\\v"); ;

42 : ià(
	`i¥ršt
(()
c
))

43 
	`putch¬
(
c
);

45 
	`´štf
("\\%03u",()
c
);

48 
	`putch¬
('"');

49 
	}
}

51 
	$PrštCÚ¡ªt
(cÚ¡ 
PrÙo
* 
f
, 
i
)

53 cÚ¡ 
TV®ue
* 
o
=&
f
->
k
[
i
];

54 
	`‰y³
(
o
))

56 
LUA_TNIL
:

57 
	`´štf
("nil");

59 
LUA_TBOOLEAN
:

60 
	`´štf
(
	`bv®ue
(
o
) ? "true" : "false");

62 
LUA_TNUMBER
:

63 
	`´štf
(
LUA_NUMBER_FMT
,
	`nv®ue
(
o
));

65 
LUA_TSTRING
:

66 
	`PrštSŒšg
(
	`¿wtsv®ue
(
o
));

69 
	`´štf
("?y³=%d",
	`‰y³
(
o
));

72 
	}
}

74 
	$PrštCode
(cÚ¡ 
PrÙo
* 
f
)

76 cÚ¡ 
In¡ruùiÚ
* 
code
=
f
->code;

77 
pc
,
n
=
f
->
sizecode
;

78 
pc
=0;…c<
n
;…c++)

80 
In¡ruùiÚ
 
i
=
code
[
pc
];

81 
OpCode
 
o
=
	`GET_OPCODE
(
i
);

82 
a
=
	`GETARG_A
(
i
);

83 
b
=
	`GETARG_B
(
i
);

84 
c
=
	`GETARG_C
(
i
);

85 
bx
=
	`GETARG_Bx
(
i
);

86 
sbx
=
	`GETARG_sBx
(
i
);

87 
lše
=
	`g‘lše
(
f
,
pc
);

88 
	`´štf
("\t%d\t",
pc
+1);

89 ià(
lše
>0è
	`´štf
("[%d]\t",line); printf("[-]\t");

90 
	`´štf
("%-9s\t",
luaP_İÇmes
[
o
]);

91 
	`g‘OpMode
(
o
))

93 
iABC
:

94 
	`´štf
("%d",
a
);

95 ià(
	`g‘BMode
(
o
)!=
OpArgN
è
	`´štf
(" %d",
	`ISK
(
b
è? (-1-
	`INDEXK
(b)) : b);

96 ià(
	`g‘CMode
(
o
)!=
OpArgN
è
	`´štf
(" %d",
	`ISK
(
c
è? (-1-
	`INDEXK
(c)) : c);

98 
iABx
:

99 ià(
	`g‘BMode
(
o
)==
OpArgK
è
	`´štf
("%d %d",
a
,-1-
bx
); printf("%d %d",a,bx);

101 
iAsBx
:

102 ià(
o
==
OP_JMP
è
	`´štf
("%d",
sbx
); ´štf("%d %d",
a
,sbx);

105 
o
)

107 
OP_LOADK
:

108 
	`´štf
("\t; "); 
	`PrštCÚ¡ªt
(
f
,
bx
);

110 
OP_GETUPVAL
:

111 
OP_SETUPVAL
:

112 
	`´štf
("\t; %s", (
f
->
sizeupv®ues
>0è? 
	`g‘¡r
(f->
upv®ues
[
b
]) : "-");

114 
OP_GETGLOBAL
:

115 
OP_SETGLOBAL
:

116 
	`´štf
("\t; %s",
	`sv®ue
(&
f
->
k
[
bx
]));

118 
OP_GETTABLE
:

119 
OP_SELF
:

120 ià(
	`ISK
(
c
)è{ 
	`´štf
("\t; "); 
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(c)); }

122 
OP_SETTABLE
:

123 
OP_ADD
:

124 
OP_SUB
:

125 
OP_MUL
:

126 
OP_DIV
:

127 
OP_POW
:

128 
OP_EQ
:

129 
OP_LT
:

130 
OP_LE
:

131 ià(
	`ISK
(
b
è|| ISK(
c
))

133 
	`´štf
("\t; ");

134 ià(
	`ISK
(
b
)è
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(b)); 
	`´štf
("-");

135 
	`´štf
(" ");

136 ià(
	`ISK
(
c
)è
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(c)); 
	`´štf
("-");

139 
OP_JMP
:

140 
OP_FORLOOP
:

141 
OP_FORPREP
:

142 
	`´štf
("\t;Ø%d",
sbx
+
pc
+2);

144 
OP_CLOSURE
:

145 
	`´štf
("\t; %p",
	`VOID
(
f
->
p
[
bx
]));

147 
OP_SETLIST
:

148 ià(
c
==0è
	`´štf
("\t; %d",()
code
[++
pc
]);

149 
	`´štf
("\t; %d",
c
);

154 
	`´štf
("\n");

156 
	}
}

158 
	#SS
(
x
è(x==1)?"":"s"

	)

159 
	#S
(
x
èx,
	`SS
(x)

	)

161 
	$PrštH—d”
(cÚ¡ 
PrÙo
* 
f
)

163 cÚ¡ * 
s
=
	`g‘¡r
(
f
->
sourû
);

164 ià(*
s
=='@' || *s=='=')

165 
s
++;

166 ià(*
s
==
LUA_SIGNATURE
[0])

167 
s
="(bstring)";

169 
s
="(string)";

170 
	`´štf
("\n%s <%s:%d,%d> (%d instruction%s, %d bytes‡t %p)\n",

171 (
f
->
lšedefšed
==0)?"maš":"funùiÚ",
s
,

172 
f
->
lšedefšed
,f->
Ï¡lšedefšed
,

173 
	`S
(
f
->
sizecode
),f->sizecode*
	`Sizeof
(
In¡ruùiÚ
),
	`VOID
(f));

174 
	`´štf
("%d%s…aram%s, %d slot%s, %d upvalue%s, ",

175 
f
->
num·¿ms
,f->
is_v¬¬g
?"+":"",
	`SS
(f->numparams),

176 
	`S
(
f
->
max¡acksize
),S(f->
nups
));

177 
	`´štf
("%d†ocal%s, %d constant%s, %d function%s\n",

178 
	`S
(
f
->
siz–ocv¬s
),S(f->
sizek
),S(f->
siz•
));

179 
	}
}

181 
	$PrštCÚ¡ªts
(cÚ¡ 
PrÙo
* 
f
)

183 
i
,
n
=
f
->
sizek
;

184 
	`´štf
("cÚ¡ªt (%dèfÜ %p:\n",
n
,
	`VOID
(
f
));

185 
i
=0; i<
n
; i++)

187 
	`´štf
("\t%d\t",
i
+1);

188 
	`PrštCÚ¡ªt
(
f
,
i
);

189 
	`´štf
("\n");

191 
	}
}

193 
	$PrštLoÿls
(cÚ¡ 
PrÙo
* 
f
)

195 
i
,
n
=
f
->
siz–ocv¬s
;

196 
	`´štf
("loÿl (%dèfÜ %p:\n",
n
,
	`VOID
(
f
));

197 
i
=0; i<
n
; i++)

199 
	`´štf
("\t%d\t%s\t%d\t%d\n",

200 
i
,
	`g‘¡r
(
f
->
locv¬s
[i].
v¬Çme
),f->locv¬s[i].
¡¬c
+1,f->locv¬s[i].
’dpc
+1);

202 
	}
}

204 
	$PrštUpv®ues
(cÚ¡ 
PrÙo
* 
f
)

206 
i
,
n
=
f
->
sizeupv®ues
;

207 
	`´štf
("upv®ue (%dèfÜ %p:\n",
n
,
	`VOID
(
f
));

208 ià(
f
->
upv®ues
==
NULL
) ;

209 
i
=0; i<
n
; i++)

211 
	`´štf
("\t%d\t%s\n",
i
,
	`g‘¡r
(
f
->
upv®ues
[i]));

213 
	}
}

215 
	$PrštFunùiÚ
(cÚ¡ 
PrÙo
* 
f
, 
fuÎ
)

217 
i
,
n
=
f
->
siz•
;

218 
	`PrštH—d”
(
f
);

219 
	`PrštCode
(
f
);

220 ià(
fuÎ
)

222 
	`PrštCÚ¡ªts
(
f
);

223 
	`PrštLoÿls
(
f
);

224 
	`PrštUpv®ues
(
f
);

226 
i
=0; i<
n
; i++è
	`PrštFunùiÚ
(
f
->
p
[i],
fuÎ
);

227 
	}
}

	@deps/lua/src/strbuf.c

25 
	~<¡dio.h
>

26 
	~<¡dlib.h
>

27 
	~<¡d¬g.h
>

28 
	~<¡ršg.h
>

30 
	~"¡rbuf.h
"

32 
	$d›
(cÚ¡ *
fmt
, ...)

34 
va_li¡
 
¬g
;

36 
	`va_¡¬t
(
¬g
, 
fmt
);

37 
	`vårštf
(
¡d”r
, 
fmt
, 
¬g
);

38 
	`va_’d
(
¬g
);

39 
	`årštf
(
¡d”r
, "\n");

41 
	`ex™
(-1);

42 
	}
}

44 
	$¡rbuf_š™
(
¡rbuf_t
 *
s
, 
Ën
)

46 
size
;

48 ià(
Ën
 <= 0)

49 
size
 = 
STRBUF_DEFAULT_SIZE
;

51 
size
 = 
Ën
 + 1;

53 
s
->
buf
 = 
NULL
;

54 
s
->
size
 = size;

55 
s
->
Ëngth
 = 0;

56 
s
->
šüem’t
 = 
STRBUF_DEFAULT_INCREMENT
;

57 
s
->
dyÇmic
 = 0;

58 
s
->
»®locs
 = 0;

59 
s
->
debug
 = 0;

61 
s
->
buf
 = 
	`m®loc
(
size
);

62 ià(!
s
->
buf
)

63 
	`d›
("Out of memory");

65 
	`¡rbuf_’su»_nuÎ
(
s
);

66 
	}
}

68 
¡rbuf_t
 *
	$¡rbuf_Ãw
(
Ën
)

70 
¡rbuf_t
 *
s
;

72 
s
 = 
	`m®loc
((
¡rbuf_t
));

73 ià(!
s
)

74 
	`d›
("Out of memory");

76 
	`¡rbuf_š™
(
s
, 
Ën
);

79 
s
->
dyÇmic
 = 1;

81  
s
;

82 
	}
}

84 
	$¡rbuf_£t_šüem’t
(
¡rbuf_t
 *
s
, 
šüem’t
)

88 ià(
šüem’t
 == 0 || increment == -1)

89 
	`d›
("BUG: Invalid string increment");

91 
s
->
šüem’t
 = increment;

92 
	}
}

94 
šlše
 
	$debug_¡©s
(
¡rbuf_t
 *
s
)

96 ià(
s
->
debug
) {

97 
	`årštf
(
¡d”r
, "strbuf(%lx)„eallocs: %d,†ength: %d, size: %d\n",

98 ()
s
, s->
»®locs
, s->
Ëngth
, s->
size
);

100 
	}
}

104 
	$¡rbuf_ä“
(
¡rbuf_t
 *
s
)

106 
	`debug_¡©s
(
s
);

108 ià(
s
->
buf
) {

109 
	`ä“
(
s
->
buf
);

110 
s
->
buf
 = 
NULL
;

112 ià(
s
->
dyÇmic
)

113 
	`ä“
(
s
);

114 
	}
}

116 *
	$¡rbuf_ä“_to_¡ršg
(
¡rbuf_t
 *
s
, *
Ën
)

118 *
buf
;

120 
	`debug_¡©s
(
s
);

122 
	`¡rbuf_’su»_nuÎ
(
s
);

124 
buf
 = 
s
->buf;

125 ià(
Ën
)

126 *
Ën
 = 
s
->
Ëngth
;

128 ià(
s
->
dyÇmic
)

129 
	`ä“
(
s
);

131  
buf
;

132 
	}
}

134 
	$ÿlcuÏ‹_Ãw_size
(
¡rbuf_t
 *
s
, 
Ën
)

136 
»qsize
, 
Ãwsize
;

138 ià(
Ën
 <= 0)

139 
	`d›
("BUG: Invalid strbuf†ength„equested");

142 
»qsize
 = 
Ën
 + 1;

145 ià(
s
->
size
 > 
»qsize
)

146  
»qsize
;

148 
Ãwsize
 = 
s
->
size
;

149 ià(
s
->
šüem’t
 < 0) {

151 
Ãwsize
 < 
»qsize
)

152 
Ãwsize
 *ğ-
s
->
šüem’t
;

155 
Ãwsize
 = (Òewsiz+ 
s
->
šüem’t
 - 1) / s->increment) * s->increment;

158  
Ãwsize
;

159 
	}
}

164 
	$¡rbuf_»size
(
¡rbuf_t
 *
s
, 
Ën
)

166 
Ãwsize
;

168 
Ãwsize
 = 
	`ÿlcuÏ‹_Ãw_size
(
s
, 
Ën
);

170 ià(
s
->
debug
 > 1) {

171 
	`årštf
(
¡d”r
, "strbuf(%lx)„esize: %d => %d\n",

172 ()
s
, s->
size
, 
Ãwsize
);

175 
s
->
size
 = 
Ãwsize
;

176 
s
->
buf
 = 
	`»®loc
(s->buf, s->
size
);

177 ià(!
s
->
buf
)

178 
	`d›
("Out of memory");

179 
s
->
»®locs
++;

180 
	}
}

182 
	$¡rbuf_­³nd_¡ršg
(
¡rbuf_t
 *
s
, cÚ¡ *
¡r
)

184 
¥aû
, 
i
;

186 
¥aû
 = 
	`¡rbuf_em±y_Ëngth
(
s
);

188 
i
 = 0; 
¡r
[i]; i++) {

189 ià(
¥aû
 < 1) {

190 
	`¡rbuf_»size
(
s
, s->
Ëngth
 + 1);

191 
¥aû
 = 
	`¡rbuf_em±y_Ëngth
(
s
);

194 
s
->
buf
[s->
Ëngth
] = 
¡r
[
i
];

195 
s
->
Ëngth
++;

196 
¥aû
--;

198 
	}
}

202 
	$¡rbuf_­³nd_fmt
(
¡rbuf_t
 *
s
, 
Ën
, cÚ¡ *
fmt
, ...)

204 
va_li¡
 
¬g
;

205 
fmt_Ën
;

207 
	`¡rbuf_’su»_em±y_Ëngth
(
s
, 
Ën
);

209 
	`va_¡¬t
(
¬g
, 
fmt
);

210 
fmt_Ën
 = 
	`v¢´štf
(
s
->
buf
 + s->
Ëngth
, 
Ën
, 
fmt
, 
¬g
);

211 
	`va_’d
(
¬g
);

213 ià(
fmt_Ën
 < 0)

214 
	`d›
("BUG: Unableo convert‚umber");

216 
s
->
Ëngth
 +ğ
fmt_Ën
;

217 
	}
}

221 
	$¡rbuf_­³nd_fmt_»Œy
(
¡rbuf_t
 *
s
, cÚ¡ *
fmt
, ...)

223 
va_li¡
 
¬g
;

224 
fmt_Ën
, 
Œy
;

225 
em±y_Ën
;

229 
Œy
 = 0; ;ry++) {

230 
	`va_¡¬t
(
¬g
, 
fmt
);

234 
em±y_Ën
 = 
	`¡rbuf_em±y_Ëngth
(
s
);

236 
fmt_Ën
 = 
	`v¢´štf
(
s
->
buf
 + s->
Ëngth
, 
em±y_Ën
 + 1, 
fmt
, 
¬g
);

237 
	`va_’d
(
¬g
);

239 ià(
fmt_Ën
 <ğ
em±y_Ën
)

241 ià(
Œy
 > 0)

242 
	`d›
("BUG:†ength of formatted string changed");

244 
	`¡rbuf_»size
(
s
, s->
Ëngth
 + 
fmt_Ën
);

247 
s
->
Ëngth
 +ğ
fmt_Ën
;

248 
	}
}

	@deps/lua/src/strbuf.h

25 
	~<¡dlib.h
>

26 
	~<¡d¬g.h
>

35 *
	mbuf
;

36 
	msize
;

37 
	mËngth
;

38 
	mšüem’t
;

39 
	mdyÇmic
;

40 
	m»®locs
;

41 
	mdebug
;

42 } 
	t¡rbuf_t
;

44 #iâdeà
STRBUF_DEFAULT_SIZE


45 
	#STRBUF_DEFAULT_SIZE
 1023

	)

47 #iâdeà
STRBUF_DEFAULT_INCREMENT


48 
	#STRBUF_DEFAULT_INCREMENT
 -2

	)

52 
¡rbuf_t
 *
¡rbuf_Ãw
(
Ën
);

53 
¡rbuf_š™
(
¡rbuf_t
 *
s
, 
Ën
);

54 
¡rbuf_£t_šüem’t
(
¡rbuf_t
 *
s
, 
šüem’t
);

57 
¡rbuf_ä“
(
¡rbuf_t
 *
s
);

58 *
¡rbuf_ä“_to_¡ršg
(
¡rbuf_t
 *
s
, *
Ën
);

61 
¡rbuf_»size
(
¡rbuf_t
 *
s
, 
Ën
);

62 
¡rbuf_em±y_Ëngth
(
¡rbuf_t
 *
s
);

63 
¡rbuf_Ëngth
(
¡rbuf_t
 *
s
);

64 *
¡rbuf_¡ršg
(
¡rbuf_t
 *
s
, *
Ën
);

65 
¡rbuf_’su»_em±y_Ëngth
(
¡rbuf_t
 *
s
, 
Ën
);

66 *
¡rbuf_em±y_±r
(
¡rbuf_t
 *
s
);

67 
¡rbuf_ex‹nd_Ëngth
(
¡rbuf_t
 *
s
, 
Ën
);

70 
¡rbuf_­³nd_fmt
(
¡rbuf_t
 *
s
, 
Ën
, cÚ¡ *
fmt
, ...);

71 
¡rbuf_­³nd_fmt_»Œy
(
¡rbuf_t
 *
s
, cÚ¡ *
fÜm©
, ...);

72 
¡rbuf_­³nd_mem
(
¡rbuf_t
 *
s
, cÚ¡ *
c
, 
Ën
);

73 
¡rbuf_­³nd_¡ršg
(
¡rbuf_t
 *
s
, cÚ¡ *
¡r
);

74 
¡rbuf_­³nd_ch¬
(
¡rbuf_t
 *
s
, cÚ¡ 
c
);

75 
¡rbuf_’su»_nuÎ
(
¡rbuf_t
 *
s
);

78 
šlše
 
	$¡rbuf_»£t
(
¡rbuf_t
 *
s
)

80 
s
->
Ëngth
 = 0;

81 
	}
}

83 
šlše
 
	$¡rbuf_®loÿ‹d
(
¡rbuf_t
 *
s
)

85  
s
->
buf
 !ğ
NULL
;

86 
	}
}

90 
šlše
 
	$¡rbuf_em±y_Ëngth
(
¡rbuf_t
 *
s
)

92  
s
->
size
 - s->
Ëngth
 - 1;

93 
	}
}

95 
šlše
 
	$¡rbuf_’su»_em±y_Ëngth
(
¡rbuf_t
 *
s
, 
Ën
)

97 ià(
Ën
 > 
	`¡rbuf_em±y_Ëngth
(
s
))

98 
	`¡rbuf_»size
(
s
, s->
Ëngth
 + 
Ën
);

99 
	}
}

101 
šlše
 *
	$¡rbuf_em±y_±r
(
¡rbuf_t
 *
s
)

103  
s
->
buf
 + s->
Ëngth
;

104 
	}
}

106 
šlše
 
	$¡rbuf_ex‹nd_Ëngth
(
¡rbuf_t
 *
s
, 
Ën
)

108 
s
->
Ëngth
 +ğ
Ën
;

109 
	}
}

111 
šlše
 
	$¡rbuf_Ëngth
(
¡rbuf_t
 *
s
)

113  
s
->
Ëngth
;

114 
	}
}

116 
šlše
 
	$¡rbuf_­³nd_ch¬
(
¡rbuf_t
 *
s
, cÚ¡ 
c
)

118 
	`¡rbuf_’su»_em±y_Ëngth
(
s
, 1);

119 
s
->
buf
[s->
Ëngth
++] = 
c
;

120 
	}
}

122 
šlše
 
	$¡rbuf_­³nd_ch¬_un§ã
(
¡rbuf_t
 *
s
, cÚ¡ 
c
)

124 
s
->
buf
[s->
Ëngth
++] = 
c
;

125 
	}
}

127 
šlše
 
	$¡rbuf_­³nd_mem
(
¡rbuf_t
 *
s
, cÚ¡ *
c
, 
Ën
)

129 
	`¡rbuf_’su»_em±y_Ëngth
(
s
, 
Ën
);

130 
	`memıy
(
s
->
buf
 + s->
Ëngth
, 
c
, 
Ën
);

131 
s
->
Ëngth
 +ğ
Ën
;

132 
	}
}

134 
šlše
 
	$¡rbuf_­³nd_mem_un§ã
(
¡rbuf_t
 *
s
, cÚ¡ *
c
, 
Ën
)

136 
	`memıy
(
s
->
buf
 + s->
Ëngth
, 
c
, 
Ën
);

137 
s
->
Ëngth
 +ğ
Ën
;

138 
	}
}

140 
šlše
 
	$¡rbuf_’su»_nuÎ
(
¡rbuf_t
 *
s
)

142 
s
->
buf
[s->
Ëngth
] = 0;

143 
	}
}

145 
šlše
 *
	$¡rbuf_¡ršg
(
¡rbuf_t
 *
s
, *
Ën
)

147 ià(
Ën
)

148 *
Ën
 = 
s
->
Ëngth
;

150  
s
->
buf
;

151 
	}
}

	@src/adlist.c

32 
	~<¡dlib.h
>

33 
	~"adli¡.h
"

34 
	~"zm®loc.h
"

41 
li¡
 *
	$li¡C»©e
()

43 
li¡
 *list;

45 ià((
li¡
 = 
	`zm®loc
((*li¡))è=ğ
NULL
)

46  
NULL
;

47 
li¡
->
h—d
 =†i¡->

 = 
NULL
;

48 
li¡
->
Ën
 = 0;

49 
li¡
->
dup
 = 
NULL
;

50 
li¡
->
ä“
 = 
NULL
;

51 
li¡
->
m©ch
 = 
NULL
;

52  
li¡
;

53 
	}
}

56 
	$li¡Em±y
(
li¡
 *list)

58 
Ën
;

59 
li¡Node
 *
cu¼’t
, *
Ãxt
;

61 
cu¼’t
 = 
li¡
->
h—d
;

62 
Ën
 = 
li¡
->len;

63 
Ën
--) {

64 
Ãxt
 = 
cu¼’t
->next;

65 ià(
li¡
->
ä“
èli¡->
	`ä“
(
cu¼’t
->
v®ue
);

66 
	`zä“
(
cu¼’t
);

67 
cu¼’t
 = 
Ãxt
;

69 
li¡
->
h—d
 =†i¡->

 = 
NULL
;

70 
li¡
->
Ën
 = 0;

71 
	}
}

76 
	$li¡R–—£
(
li¡
 *list)

78 
	`li¡Em±y
(
li¡
);

79 
	`zä“
(
li¡
);

80 
	}
}

88 
li¡
 *
	$li¡AddNodeH—d
(
li¡
 *li¡, *
v®ue
)

90 
li¡Node
 *
node
;

92 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

93  
NULL
;

94 
node
->
v®ue
 = value;

95 ià(
li¡
->
Ën
 == 0) {

96 
li¡
->
h—d
 =†i¡->

 = 
node
;

97 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

99 
node
->
´ev
 = 
NULL
;

100 
node
->
Ãxt
 = 
li¡
->
h—d
;

101 
li¡
->
h—d
->
´ev
 = 
node
;

102 
li¡
->
h—d
 = 
node
;

104 
li¡
->
Ën
++;

105  
li¡
;

106 
	}
}

114 
li¡
 *
	$li¡AddNodeTa
(
li¡
 *li¡, *
v®ue
)

116 
li¡Node
 *
node
;

118 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

119  
NULL
;

120 
node
->
v®ue
 = value;

121 ià(
li¡
->
Ën
 == 0) {

122 
li¡
->
h—d
 =†i¡->

 = 
node
;

123 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

125 
node
->
´ev
 = 
li¡
->

;

126 
node
->
Ãxt
 = 
NULL
;

127 
li¡
->

->
Ãxt
 = 
node
;

128 
li¡
->

 = 
node
;

130 
li¡
->
Ën
++;

131  
li¡
;

132 
	}
}

134 
li¡
 *
	$li¡In£¹Node
(
li¡
 *li¡, 
li¡Node
 *
Şd_node
, *
v®ue
, 
aá”
) {

135 
li¡Node
 *
node
;

137 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

138  
NULL
;

139 
node
->
v®ue
 = value;

140 ià(
aá”
) {

141 
node
->
´ev
 = 
Şd_node
;

142 
node
->
Ãxt
 = 
Şd_node
->next;

143 ià(
li¡
->

 =ğ
Şd_node
) {

144 
li¡
->

 = 
node
;

147 
node
->
Ãxt
 = 
Şd_node
;

148 
node
->
´ev
 = 
Şd_node
->prev;

149 ià(
li¡
->
h—d
 =ğ
Şd_node
) {

150 
li¡
->
h—d
 = 
node
;

153 ià(
node
->
´ev
 !ğ
NULL
) {

154 
node
->
´ev
->
Ãxt
 =‚ode;

156 ià(
node
->
Ãxt
 !ğ
NULL
) {

157 
node
->
Ãxt
->
´ev
 =‚ode;

159 
li¡
->
Ën
++;

160  
li¡
;

161 
	}
}

167 
	$li¡D–Node
(
li¡
 *li¡, 
li¡Node
 *
node
)

169 ià(
node
->
´ev
)

170 
node
->
´ev
->
Ãxt
 =‚ode->next;

172 
li¡
->
h—d
 = 
node
->
Ãxt
;

173 ià(
node
->
Ãxt
)

174 
node
->
Ãxt
->
´ev
 =‚ode->prev;

176 
li¡
->

 = 
node
->
´ev
;

177 ià(
li¡
->
ä“
èli¡->
	`ä“
(
node
->
v®ue
);

178 
	`zä“
(
node
);

179 
li¡
->
Ën
--;

180 
	}
}

186 
li¡I‹r
 *
	$li¡G‘I‹¿tÜ
(
li¡
 *li¡, 
dœeùiÚ
)

188 
li¡I‹r
 *
™”
;

190 ià((
™”
 = 
	`zm®loc
((*™”))è=ğ
NULL
)  NULL;

191 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
)

192 
™”
->
Ãxt
 = 
li¡
->
h—d
;

194 
™”
->
Ãxt
 = 
li¡
->

;

195 
™”
->
dœeùiÚ
 = direction;

196  
™”
;

197 
	}
}

200 
	$li¡R–—£I‹¿tÜ
(
li¡I‹r
 *
™”
) {

201 
	`zä“
(
™”
);

202 
	}
}

205 
	$li¡Rewšd
(
li¡
 *li¡, 
li¡I‹r
 *
li
) {

206 
li
->
Ãxt
 = 
li¡
->
h—d
;

207 
li
->
dœeùiÚ
 = 
AL_START_HEAD
;

208 
	}
}

210 
	$li¡RewšdTa
(
li¡
 *li¡, 
li¡I‹r
 *
li
) {

211 
li
->
Ãxt
 = 
li¡
->

;

212 
li
->
dœeùiÚ
 = 
AL_START_TAIL
;

213 
	}
}

229 
li¡Node
 *
	$li¡Next
(
li¡I‹r
 *
™”
)

231 
li¡Node
 *
cu¼’t
 = 
™”
->
Ãxt
;

233 ià(
cu¼’t
 !ğ
NULL
) {

234 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
)

235 
™”
->
Ãxt
 = 
cu¼’t
->next;

237 
™”
->
Ãxt
 = 
cu¼’t
->
´ev
;

239  
cu¼’t
;

240 
	}
}

250 
li¡
 *
	$li¡Dup
(
li¡
 *
Üig
)

252 
li¡
 *
cİy
;

253 
li¡I‹r
 
™”
;

254 
li¡Node
 *
node
;

256 ià((
cİy
 = 
	`li¡C»©e
()è=ğ
NULL
)

257  
NULL
;

258 
cİy
->
dup
 = 
Üig
->dup;

259 
cİy
->
ä“
 = 
Üig
->free;

260 
cİy
->
m©ch
 = 
Üig
->match;

261 
	`li¡Rewšd
(
Üig
, &
™”
);

262 (
node
 = 
	`li¡Next
(&
™”
)è!ğ
NULL
) {

263 *
v®ue
;

265 ià(
cİy
->
dup
) {

266 
v®ue
 = 
cİy
->
	`dup
(
node
->value);

267 ià(
v®ue
 =ğ
NULL
) {

268 
	`li¡R–—£
(
cİy
);

269  
NULL
;

272 
v®ue
 = 
node
->value;

273 ià(
	`li¡AddNodeTa
(
cİy
, 
v®ue
è=ğ
NULL
) {

274 
	`li¡R–—£
(
cİy
);

275  
NULL
;

278  
cİy
;

279 
	}
}

290 
li¡Node
 *
	$li¡S—rchKey
(
li¡
 *li¡, *
key
)

292 
li¡I‹r
 
™”
;

293 
li¡Node
 *
node
;

295 
	`li¡Rewšd
(
li¡
, &
™”
);

296 (
node
 = 
	`li¡Next
(&
™”
)è!ğ
NULL
) {

297 ià(
li¡
->
m©ch
) {

298 ià(
li¡
->
	`m©ch
(
node
->
v®ue
, 
key
)) {

299  
node
;

302 ià(
key
 =ğ
node
->
v®ue
) {

303  
node
;

307  
NULL
;

308 
	}
}

315 
li¡Node
 *
	$li¡Index
(
li¡
 *li¡, 
šdex
) {

316 
li¡Node
 *
n
;

318 ià(
šdex
 < 0) {

319 
šdex
 = (-index)-1;

320 
n
 = 
li¡
->

;

321 
šdex
-- && 
n
èÀğn->
´ev
;

323 
n
 = 
li¡
->
h—d
;

324 
šdex
-- && 
n
èÀğn->
Ãxt
;

326  
n
;

327 
	}
}

330 
	$li¡RÙ©e
(
li¡
 *list) {

331 
li¡Node
 *

 = 
li¡
->tail;

333 ià(
	`li¡L’gth
(
li¡
) <= 1) ;

336 
li¡
->

 =a->
´ev
;

337 
li¡
->

->
Ãxt
 = 
NULL
;

339 
li¡
->
h—d
->
´ev
 = 

;

340 

->
´ev
 = 
NULL
;

341 

->
Ãxt
 = 
li¡
->
h—d
;

342 
li¡
->
h—d
 = 

;

343 
	}
}

347 
	$li¡Još
(
li¡
 *
l
,†i¡ *
o
) {

348 ià(
o
->
h—d
)

349 
o
->
h—d
->
´ev
 = 
l
->

;

351 ià(
l
->

)

352 
l
->

->
Ãxt
 = 
o
->
h—d
;

354 
l
->
h—d
 = 
o
->head;

356 ià(
o
->

è
l
->tail = o->tail;

357 
l
->
Ën
 +ğ
o
->len;

360 
o
->
h—d
 = o->

 = 
NULL
;

361 
o
->
Ën
 = 0;

362 
	}
}

	@src/adlist.h

31 #iâdeà
__ADLIST_H__


32 
	#__ADLIST_H__


	)

36 
	sli¡Node
 {

37 
li¡Node
 *
	m´ev
;

38 
li¡Node
 *
	mÃxt
;

39 *
	mv®ue
;

40 } 
	tli¡Node
;

42 
	sli¡I‹r
 {

43 
li¡Node
 *
	mÃxt
;

44 
	mdœeùiÚ
;

45 } 
	tli¡I‹r
;

47 
	sli¡
 {

48 
li¡Node
 *
	mh—d
;

49 
li¡Node
 *
	m
;

50 *(*
	mdup
)(*
	m±r
);

51 (*
	mä“
)(*
	m±r
);

52 (*
	mm©ch
)(*
	m±r
, *
	mkey
);

53 
	mËn
;

54 } 
	tli¡
;

57 
	#li¡L’gth
(
l
è(Ö)->
Ën
)

	)

58 
	#li¡Fœ¡
(
l
è(Ö)->
h—d
)

	)

59 
	#li¡La¡
(
l
è(Ö)->

)

	)

60 
	#li¡P»vNode
(
n
è(Ò)->
´ev
)

	)

61 
	#li¡NextNode
(
n
è(Ò)->
Ãxt
)

	)

62 
	#li¡NodeV®ue
(
n
è(Ò)->
v®ue
)

	)

64 
	#li¡S‘DupM‘hod
(
l
,
m
è(Ö)->
dup
 = (m))

	)

65 
	#li¡S‘F»eM‘hod
(
l
,
m
è(Ö)->
ä“
 = (m))

	)

66 
	#li¡S‘M©chM‘hod
(
l
,
m
è(Ö)->
m©ch
 = (m))

	)

68 
	#li¡G‘DupM‘hod
(
l
è(Ö)->
dup
)

	)

69 
	#li¡G‘F»e
(
l
è(Ö)->
ä“
)

	)

70 
	#li¡G‘M©chM‘hod
(
l
è(Ö)->
m©ch
)

	)

73 
li¡
 *
li¡C»©e
();

74 
li¡R–—£
(
li¡
 *list);

75 
li¡Em±y
(
li¡
 *list);

76 
li¡
 *
li¡AddNodeH—d
Öi¡ *li¡, *
v®ue
);

77 
li¡
 *
li¡AddNodeTa
Öi¡ *li¡, *
v®ue
);

78 
li¡
 *
li¡In£¹Node
Öi¡ *li¡, 
li¡Node
 *
Şd_node
, *
v®ue
, 
aá”
);

79 
li¡D–Node
(
li¡
 *li¡, 
li¡Node
 *
node
);

80 
li¡I‹r
 *
li¡G‘I‹¿tÜ
(
li¡
 *li¡, 
dœeùiÚ
);

81 
li¡Node
 *
li¡Next
(
li¡I‹r
 *
™”
);

82 
li¡R–—£I‹¿tÜ
(
li¡I‹r
 *
™”
);

83 
li¡
 *
li¡Dup
Öi¡ *
Üig
);

84 
li¡Node
 *
li¡S—rchKey
(
li¡
 *li¡, *
key
);

85 
li¡Node
 *
li¡Index
(
li¡
 *li¡, 
šdex
);

86 
li¡Rewšd
(
li¡
 *li¡, 
li¡I‹r
 *
li
);

87 
li¡RewšdTa
(
li¡
 *li¡, 
li¡I‹r
 *
li
);

88 
li¡RÙ©e
(
li¡
 *list);

89 
li¡Još
(
li¡
 *
l
,†i¡ *
o
);

92 
	#AL_START_HEAD
 0

	)

93 
	#AL_START_TAIL
 1

	)

	@src/ae.c

33 
	~<¡dio.h
>

34 
	~<sys/time.h
>

35 
	~<sys/ty³s.h
>

36 
	~<uni¡d.h
>

37 
	~<¡dlib.h
>

38 
	~<pŞl.h
>

39 
	~<¡ršg.h
>

40 
	~<time.h
>

41 
	~<”ºo.h
>

43 
	~"«.h
"

44 
	~"zm®loc.h
"

45 
	~"cÚfig.h
"

49 #ifdeà
HAVE_EVPORT


50 
	~"«_evpÜt.c
"

52 #ifdeà
HAVE_EPOLL


53 
	~"«_•Şl.c
"

55 #ifdeà
HAVE_KQUEUE


56 
	~"«_kqueue.c
"

58 
	~"«_£Ëù.c
"

63 
«Ev’tLoİ
 *
	$«C»©eEv’tLoİ
(
£tsize
) {

64 
«Ev’tLoİ
 *
ev’tLoİ
;

65 
i
;

67 ià((
ev’tLoİ
 = 
	`zm®loc
((*ev’tLoİ))è=ğ
NULL
è
”r
;

68 
ev’tLoİ
->
ev’ts
 = 
	`zm®loc
((
«FeEv’t
)*
£tsize
);

69 
ev’tLoİ
->
fœed
 = 
	`zm®loc
((
«FœedEv’t
)*
£tsize
);

70 ià(
ev’tLoİ
->
ev’ts
 =ğ
NULL
 ||ƒv’tLoİ->
fœed
 =ğNULLè
”r
;

71 
ev’tLoİ
->
£tsize
 = setsize;

72 
ev’tLoİ
->
Ï¡Time
 = 
	`time
(
NULL
);

73 
ev’tLoİ
->
timeEv’tH—d
 = 
NULL
;

74 
ev’tLoİ
->
timeEv’tNextId
 = 0;

75 
ev’tLoİ
->
¡İ
 = 0;

76 
ev’tLoİ
->
maxfd
 = -1;

77 
ev’tLoİ
->
befÜe¦“p
 = 
NULL
;

78 
ev’tLoİ
->
aá”¦“p
 = 
NULL
;

79 ià(
	`«ApiC»©e
(
ev’tLoİ
è=ğ-1è
”r
;

82 
i
 = 0; i < 
£tsize
; i++)

83 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

84  
ev’tLoİ
;

86 
”r
:

87 ià(
ev’tLoİ
) {

88 
	`zä“
(
ev’tLoİ
->
ev’ts
);

89 
	`zä“
(
ev’tLoİ
->
fœed
);

90 
	`zä“
(
ev’tLoİ
);

92  
NULL
;

93 
	}
}

96 
	$«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
) {

97  
ev’tLoİ
->
£tsize
;

98 
	}
}

107 
	$«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

108 
i
;

110 ià(
£tsize
 =ğ
ev’tLoİ
->£tsizeè 
AE_OK
;

111 ià(
ev’tLoİ
->
maxfd
 >ğ
£tsize
è 
AE_ERR
;

112 ià(
	`«ApiResize
(
ev’tLoİ
,
£tsize
è=ğ-1è 
AE_ERR
;

114 
ev’tLoİ
->
ev’ts
 = 
	`z»®loc
Óv’tLoİ->ev’ts,(
«FeEv’t
)*
£tsize
);

115 
ev’tLoİ
->
fœed
 = 
	`z»®loc
Óv’tLoİ->fœed,(
«FœedEv’t
)*
£tsize
);

116 
ev’tLoİ
->
£tsize
 = setsize;

120 
i
 = 
ev’tLoİ
->
maxfd
+1; i < 
£tsize
; i++)

121 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

122  
AE_OK
;

123 
	}
}

125 
	$«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

126 
	`«ApiF»e
(
ev’tLoİ
);

127 
	`zä“
(
ev’tLoİ
->
ev’ts
);

128 
	`zä“
(
ev’tLoİ
->
fœed
);

129 
	`zä“
(
ev’tLoİ
);

130 
	}
}

132 
	$«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

133 
ev’tLoİ
->
¡İ
 = 1;

134 
	}
}

136 
	$«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

137 
«FeProc
 *
´oc
, *
ş›ÁD©a
)

139 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) {

140 
”ºo
 = 
ERANGE
;

141  
AE_ERR
;

143 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

145 ià(
	`«ApiAddEv’t
(
ev’tLoİ
, 
fd
, 
mask
) == -1)

146  
AE_ERR
;

147 
ã
->
mask
 |= mask;

148 ià(
mask
 & 
AE_READABLE
è
ã
->
rfeProc
 = 
´oc
;

149 ià(
mask
 & 
AE_WRITABLE
è
ã
->
wfeProc
 = 
´oc
;

150 
ã
->
ş›ÁD©a
 = clientData;

151 ià(
fd
 > 
ev’tLoİ
->
maxfd
)

152 
ev’tLoİ
->
maxfd
 = 
fd
;

153  
AE_OK
;

154 
	}
}

156 
	$«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
)

158 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) ;

159 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

160 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

164 ià(
mask
 & 
AE_WRITABLE
èmask |ğ
AE_BARRIER
;

166 
	`«ApiD–Ev’t
(
ev’tLoİ
, 
fd
, 
mask
);

167 
ã
->
mask
 = fe->mask & (~mask);

168 ià(
fd
 =ğ
ev’tLoİ
->
maxfd
 && 
ã
->
mask
 =ğ
AE_NONE
) {

170 
j
;

172 
j
 = 
ev’tLoİ
->
maxfd
-1; j >= 0; j--)

173 ià(
ev’tLoİ
->
ev’ts
[
j
].
mask
 !ğ
AE_NONE
) ;

174 
ev’tLoİ
->
maxfd
 = 
j
;

176 
	}
}

178 
	$«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
) {

179 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
)  0;

180 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

182  
ã
->
mask
;

183 
	}
}

185 
	$«G‘Time
(*
£cÚds
, *
mli£cÚds
)

187 
timev®
 
tv
;

189 
	`g‘timeofday
(&
tv
, 
NULL
);

190 *
£cÚds
 = 
tv
.
tv_£c
;

191 *
mli£cÚds
 = 
tv
.
tv_u£c
/1000;

192 
	}
}

194 
	$«AddMli£cÚdsToNow
(
mli£cÚds
, *
£c
, *
ms
) {

195 
cur_£c
, 
cur_ms
, 
wh’_£c
, 
wh’_ms
;

197 
	`«G‘Time
(&
cur_£c
, &
cur_ms
);

198 
wh’_£c
 = 
cur_£c
 + 
mli£cÚds
/1000;

199 
wh’_ms
 = 
cur_ms
 + 
mli£cÚds
%1000;

200 ià(
wh’_ms
 >= 1000) {

201 
wh’_£c
 ++;

202 
wh’_ms
 -= 1000;

204 *
£c
 = 
wh’_£c
;

205 *
ms
 = 
wh’_ms
;

206 
	}
}

208 
	$«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

209 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

210 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
)

212 
id
 = 
ev’tLoİ
->
timeEv’tNextId
++;

213 
«TimeEv’t
 *
‹
;

215 
‹
 = 
	`zm®loc
((*te));

216 ià(
‹
 =ğ
NULL
è 
AE_ERR
;

217 
‹
->
id
 = id;

218 
	`«AddMli£cÚdsToNow
(
mli£cÚds
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

219 
‹
->
timeProc
 = 
´oc
;

220 
‹
->
fš®iz”Proc
 = finalizerProc;

221 
‹
->
ş›ÁD©a
 = clientData;

222 
‹
->
´ev
 = 
NULL
;

223 
‹
->
Ãxt
 = 
ev’tLoİ
->
timeEv’tH—d
;

224 ià(
‹
->
Ãxt
)

225 
‹
->
Ãxt
->
´ev
 =e;

226 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
;

227  
id
;

228 
	}
}

230 
	$«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
)

232 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

233 
‹
) {

234 ià(
‹
->
id
 == id) {

235 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

236  
AE_OK
;

238 
‹
 =e->
Ãxt
;

240  
AE_ERR
;

241 
	}
}

254 
«TimeEv’t
 *
	$«S—rchN—»¡Tim”
(
«Ev’tLoİ
 *
ev’tLoİ
)

256 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

257 
«TimeEv’t
 *
Ã¬e¡
 = 
NULL
;

259 
‹
) {

260 ià(!
Ã¬e¡
 || 
‹
->
wh’_£c
 <‚earest->when_sec ||

261 (
‹
->
wh’_£c
 =ğ
Ã¬e¡
->when_sec &&

262 
‹
->
wh’_ms
 < 
Ã¬e¡
->when_ms))

263 
Ã¬e¡
 = 
‹
;

264 
‹
 =e->
Ãxt
;

266  
Ã¬e¡
;

267 
	}
}

270 
	$´oûssTimeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
) {

271 
´oûs£d
 = 0;

272 
«TimeEv’t
 *
‹
;

273 
maxId
;

274 
time_t
 
now
 = 
	`time
(
NULL
);

284 ià(
now
 < 
ev’tLoİ
->
Ï¡Time
) {

285 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

286 
‹
) {

287 
‹
->
wh’_£c
 = 0;

288 
‹
 =e->
Ãxt
;

291 
ev’tLoİ
->
Ï¡Time
 = 
now
;

293 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

294 
maxId
 = 
ev’tLoİ
->
timeEv’tNextId
-1;

295 
‹
) {

296 
now_£c
, 
now_ms
;

297 
id
;

300 ià(
‹
->
id
 =ğ
AE_DELETED_EVENT_ID
) {

301 
«TimeEv’t
 *
Ãxt
 = 
‹
->next;

302 ià(
‹
->
´ev
)

303 
‹
->
´ev
->
Ãxt
 =e->next;

305 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
->
Ãxt
;

306 ià(
‹
->
Ãxt
)

307 
‹
->
Ãxt
->
´ev
 =e->prev;

308 ià(
‹
->
fš®iz”Proc
)

309 
‹
->
	`fš®iz”Proc
(
ev’tLoİ
,e->
ş›ÁD©a
);

310 
	`zä“
(
‹
);

311 
‹
 = 
Ãxt
;

320 ià(
‹
->
id
 > 
maxId
) {

321 
‹
 =e->
Ãxt
;

324 
	`«G‘Time
(&
now_£c
, &
now_ms
);

325 ià(
now_£c
 > 
‹
->
wh’_£c
 ||

326 (
now_£c
 =ğ
‹
->
wh’_£c
 && 
now_ms
 >ğ‹->
wh’_ms
))

328 
»tv®
;

330 
id
 = 
‹
->id;

331 
»tv®
 = 
‹
->
	`timeProc
(
ev’tLoİ
, 
id
,e->
ş›ÁD©a
);

332 
´oûs£d
++;

333 ià(
»tv®
 !ğ
AE_NOMORE
) {

334 
	`«AddMli£cÚdsToNow
(
»tv®
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

336 
‹
->
id
 = 
AE_DELETED_EVENT_ID
;

339 
‹
 =e->
Ãxt
;

341  
´oûs£d
;

342 
	}
}

358 
	$«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
)

360 
´oûs£d
 = 0, 
numev’ts
;

363 ià(!(
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_FILE_EVENTS
))  0;

369 ià(
ev’tLoİ
->
maxfd
 != -1 ||

370 ((
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_DONT_WAIT
))) {

371 
j
;

372 
«TimeEv’t
 *
shÜ‹¡
 = 
NULL
;

373 
timev®
 
tv
, *
tvp
;

375 ià(
æags
 & 
AE_TIME_EVENTS
 && !(æag & 
AE_DONT_WAIT
))

376 
shÜ‹¡
 = 
	`«S—rchN—»¡Tim”
(
ev’tLoİ
);

377 ià(
shÜ‹¡
) {

378 
now_£c
, 
now_ms
;

380 
	`«G‘Time
(&
now_£c
, &
now_ms
);

381 
tvp
 = &
tv
;

385 
ms
 =

386 (
shÜ‹¡
->
wh’_£c
 - 
now_£c
)*1000 +

387 
shÜ‹¡
->
wh’_ms
 - 
now_ms
;

389 ià(
ms
 > 0) {

390 
tvp
->
tv_£c
 = 
ms
/1000;

391 
tvp
->
tv_u£c
 = (
ms
 % 1000)*1000;

393 
tvp
->
tv_£c
 = 0;

394 
tvp
->
tv_u£c
 = 0;

400 ià(
æags
 & 
AE_DONT_WAIT
) {

401 
tv
.
tv_£c
 =v.
tv_u£c
 = 0;

402 
tvp
 = &
tv
;

405 
tvp
 = 
NULL
;

411 
numev’ts
 = 
	`«ApiPŞl
(
ev’tLoİ
, 
tvp
);

414 ià(
ev’tLoİ
->
aá”¦“p
 !ğ
NULL
 && 
æags
 & 
AE_CALL_AFTER_SLEEP
)

415 
ev’tLoİ
->
	`aá”¦“p
(eventLoop);

417 
j
 = 0; j < 
numev’ts
; j++) {

418 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[ev’tLoİ->
fœed
[
j
].
fd
];

419 
mask
 = 
ev’tLoİ
->
fœed
[
j
].mask;

420 
fd
 = 
ev’tLoİ
->
fœed
[
j
].fd;

421 
fœed
 = 0;

434 
šv”t
 = 
ã
->
mask
 & 
AE_BARRIER
;

442 ià(!
šv”t
 && 
ã
->
mask
 & mask & 
AE_READABLE
) {

443 
ã
->
	`rfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

444 
fœed
++;

448 ià(
ã
->
mask
 & mask & 
AE_WRITABLE
) {

449 ià(!
fœed
 || 
ã
->
wfeProc
 !ğã->
rfeProc
) {

450 
ã
->
	`wfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

451 
fœed
++;

457 ià(
šv”t
 && 
ã
->
mask
 & mask & 
AE_READABLE
) {

458 ià(!
fœed
 || 
ã
->
wfeProc
 !ğã->
rfeProc
) {

459 
ã
->
	`rfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

460 
fœed
++;

464 
´oûs£d
++;

468 ià(
æags
 & 
AE_TIME_EVENTS
)

469 
´oûs£d
 +ğ
	`´oûssTimeEv’ts
(
ev’tLoİ
);

471  
´oûs£d
;

472 
	}
}

476 
	$«Wa™
(
fd
, 
mask
, 
mli£cÚds
) {

477 
pŞlfd
 
pfd
;

478 
»tmask
 = 0, 
»tv®
;

480 
	`mem£t
(&
pfd
, 0, (pfd));

481 
pfd
.
fd
 = fd;

482 ià(
mask
 & 
AE_READABLE
è
pfd
.
ev’ts
 |ğ
POLLIN
;

483 ià(
mask
 & 
AE_WRITABLE
è
pfd
.
ev’ts
 |ğ
POLLOUT
;

485 ià((
»tv®
 = 
	`pŞl
(&
pfd
, 1, 
mli£cÚds
))== 1) {

486 ià(
pfd
.
»v’ts
 & 
POLLIN
è
»tmask
 |ğ
AE_READABLE
;

487 ià(
pfd
.
»v’ts
 & 
POLLOUT
è
»tmask
 |ğ
AE_WRITABLE
;

488 ià(
pfd
.
»v’ts
 & 
POLLERR
è
»tmask
 |ğ
AE_WRITABLE
;

489 ià(
pfd
.
»v’ts
 & 
POLLHUP
è
»tmask
 |ğ
AE_WRITABLE
;

490  
»tmask
;

492  
»tv®
;

494 
	}
}

496 
	$«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
) {

497 
ev’tLoİ
->
¡İ
 = 0;

498 !
ev’tLoİ
->
¡İ
) {

499 ià(
ev’tLoİ
->
befÜe¦“p
 !ğ
NULL
)

500 
ev’tLoİ
->
	`befÜe¦“p
(eventLoop);

501 
	`«ProûssEv’ts
(
ev’tLoİ
, 
AE_ALL_EVENTS
|
AE_CALL_AFTER_SLEEP
);

503 
	}
}

505 *
	$«G‘ApiName
() {

506  
	`«ApiName
();

507 
	}
}

509 
	$«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
) {

510 
ev’tLoİ
->
befÜe¦“p
 = beforesleep;

511 
	}
}

513 
	$«S‘Aá”SË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
aá”¦“p
) {

514 
ev’tLoİ
->
aá”¦“p
 =‡ftersleep;

515 
	}
}

	@src/ae.h

33 #iâdeà
__AE_H__


34 
	#__AE_H__


	)

36 
	~<time.h
>

38 
	#AE_OK
 0

	)

39 
	#AE_ERR
 -1

	)

41 
	#AE_NONE
 0

	)

42 
	#AE_READABLE
 1

	)

43 
	#AE_WRITABLE
 2

	)

44 
	#AE_BARRIER
 4

	)

50 
	#AE_FILE_EVENTS
 1

	)

51 
	#AE_TIME_EVENTS
 2

	)

52 
	#AE_ALL_EVENTS
 (
AE_FILE_EVENTS
|
AE_TIME_EVENTS
)

	)

53 
	#AE_DONT_WAIT
 4

	)

54 
	#AE_CALL_AFTER_SLEEP
 8

	)

56 
	#AE_NOMORE
 -1

	)

57 
	#AE_DELETED_EVENT_ID
 -1

	)

60 
	#AE_NOTUSED
(
V
è((èV)

	)

62 
	g«Ev’tLoİ
;

65 
	t«FeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tfd
, *
	tş›ÁD©a
, 
	tmask
);

66 
	t«TimeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tid
, *
	tş›ÁD©a
);

67 
	t«Ev’tFš®iz”Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, *
	tş›ÁD©a
);

68 
	t«BefÜeSË•Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
);

71 
	s«FeEv’t
 {

72 
	mmask
;

73 
«FeProc
 *
	mrfeProc
;

74 
«FeProc
 *
	mwfeProc
;

75 *
	mş›ÁD©a
;

76 } 
	t«FeEv’t
;

79 
	s«TimeEv’t
 {

80 
	mid
;

81 
	mwh’_£c
;

82 
	mwh’_ms
;

83 
«TimeProc
 *
	mtimeProc
;

84 
«Ev’tFš®iz”Proc
 *
	mfš®iz”Proc
;

85 *
	mş›ÁD©a
;

86 
«TimeEv’t
 *
	m´ev
;

87 
«TimeEv’t
 *
	mÃxt
;

88 } 
	t«TimeEv’t
;

91 
	s«FœedEv’t
 {

92 
	mfd
;

93 
	mmask
;

94 } 
	t«FœedEv’t
;

97 
	s«Ev’tLoİ
 {

98 
	mmaxfd
;

99 
	m£tsize
;

100 
	mtimeEv’tNextId
;

101 
time_t
 
	mÏ¡Time
;

102 
«FeEv’t
 *
	mev’ts
;

103 
«FœedEv’t
 *
	mfœed
;

104 
«TimeEv’t
 *
	mtimeEv’tH—d
;

105 
	m¡İ
;

106 *
	m­id©a
;

107 
«BefÜeSË•Proc
 *
	mbefÜe¦“p
;

108 
«BefÜeSË•Proc
 *
	maá”¦“p
;

109 } 
	t«Ev’tLoİ
;

112 
«Ev’tLoİ
 *
«C»©eEv’tLoİ
(
£tsize
);

113 
«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

114 
«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

115 
«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

116 
«FeProc
 *
´oc
, *
ş›ÁD©a
);

117 
«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
);

118 
«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
);

119 
«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

120 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

121 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
);

122 
«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
);

123 
«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
);

124 
«Wa™
(
fd
, 
mask
, 
mli£cÚds
);

125 
«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
);

126 *
«G‘ApiName
();

127 
«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
);

128 
«S‘Aá”SË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
aá”¦“p
);

129 
«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
);

130 
«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
);

	@src/ae_epoll.c

32 
	~<sys/•Şl.h
>

34 
	s«ApiS‹
 {

35 
	m•fd
;

36 
•Şl_ev’t
 *
	mev’ts
;

37 } 
	t«ApiS‹
;

39 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

40 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

42 ià(!
¡©e
)  -1;

43 
¡©e
->
ev’ts
 = 
	`zm®loc
((
•Şl_ev’t
)*
ev’tLoİ
->
£tsize
);

44 ià(!
¡©e
->
ev’ts
) {

45 
	`zä“
(
¡©e
);

48 
¡©e
->
•fd
 = 
	`•Şl_ü—‹
(1024);

49 ià(
¡©e
->
•fd
 == -1) {

50 
	`zä“
(
¡©e
->
ev’ts
);

51 
	`zä“
(
¡©e
);

54 
ev’tLoİ
->
­id©a
 = 
¡©e
;

56 
	}
}

58 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

59 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

61 
¡©e
->
ev’ts
 = 
	`z»®loc
(¡©e->ev’ts, (
•Şl_ev’t
)*
£tsize
);

63 
	}
}

65 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

66 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

68 
	`şo£
(
¡©e
->
•fd
);

69 
	`zä“
(
¡©e
->
ev’ts
);

70 
	`zä“
(
¡©e
);

71 
	}
}

73 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

74 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

75 
•Şl_ev’t
 
“
 = {0};

78 
İ
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
 =ğ
AE_NONE
 ?

79 
EPOLL_CTL_ADD
 : 
EPOLL_CTL_MOD
;

81 
“
.
ev’ts
 = 0;

82 
mask
 |ğ
ev’tLoİ
->
ev’ts
[
fd
].mask;

83 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

84 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

85 
“
.
d©a
.
fd
 = fd;

86 ià(
	`•Şl_ùl
(
¡©e
->
•fd
,
İ
,
fd
,&
“
) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
d–mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
•Şl_ev’t
 
“
 = {0};

93 
mask
 = 
ev’tLoİ
->
ev’ts
[
fd
].mask & (~
d–mask
);

95 
“
.
ev’ts
 = 0;

96 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

97 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

98 
“
.
d©a
.
fd
 = fd;

99 ià(
mask
 !ğ
AE_NONE
) {

100 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_MOD
,
fd
,&
“
);

104 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_DEL
,
fd
,&
“
);

106 
	}
}

108 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

109 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

110 
»tv®
, 
numev’ts
 = 0;

112 
»tv®
 = 
	`•Şl_wa™
(
¡©e
->
•fd
,¡©e->
ev’ts
,
ev’tLoİ
->
£tsize
,

113 
tvp
 ? (tvp->
tv_£c
*1000 +vp->
tv_u£c
/1000) : -1);

114 ià(
»tv®
 > 0) {

115 
j
;

117 
numev’ts
 = 
»tv®
;

118 
j
 = 0; j < 
numev’ts
; j++) {

119 
mask
 = 0;

120 
•Şl_ev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

122 ià(
e
->
ev’ts
 & 
EPOLLIN
è
mask
 |ğ
AE_READABLE
;

123 ià(
e
->
ev’ts
 & 
EPOLLOUT
è
mask
 |ğ
AE_WRITABLE
;

124 ià(
e
->
ev’ts
 & 
EPOLLERR
è
mask
 |ğ
AE_WRITABLE
;

125 ià(
e
->
ev’ts
 & 
EPOLLHUP
è
mask
 |ğ
AE_WRITABLE
;

126 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
d©a
.fd;

127 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

130  
numev’ts
;

131 
	}
}

133 *
	$«ApiName
() {

135 
	}
}

	@src/ae_evport.c

31 
	~<as£¹.h
>

32 
	~<”ºo.h
>

33 
	~<pÜt.h
>

34 
	~<pŞl.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/time.h
>

39 
	~<¡dio.h
>

41 
	gevpÜt_debug
 = 0;

66 
	#MAX_EVENT_BATCHSZ
 512

	)

68 
	s«ApiS‹
 {

69 
	mpÜtfd
;

70 
	mÅ’dšg
;

71 
	m³ndšg_fds
[
MAX_EVENT_BATCHSZ
];

72 
	m³ndšg_masks
[
MAX_EVENT_BATCHSZ
];

73 } 
	t«ApiS‹
;

75 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

76 
i
;

77 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

78 ià(!
¡©e
)  -1;

80 
¡©e
->
pÜtfd
 = 
	`pÜt_ü—‹
();

81 ià(
¡©e
->
pÜtfd
 == -1) {

82 
	`zä“
(
¡©e
);

86 
¡©e
->
Å’dšg
 = 0;

88 
i
 = 0; i < 
MAX_EVENT_BATCHSZ
; i++) {

89 
¡©e
->
³ndšg_fds
[
i
] = -1;

90 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

93 
ev’tLoİ
->
­id©a
 = 
¡©e
;

95 
	}
}

97 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

100 
	}
}

102 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

103 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

105 
	`şo£
(
¡©e
->
pÜtfd
);

106 
	`zä“
(
¡©e
);

107 
	}
}

109 
	$«ApiLookupP’dšg
(
«ApiS‹
 *
¡©e
, 
fd
) {

110 
i
;

112 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

113 ià(
¡©e
->
³ndšg_fds
[
i
] =ğ
fd
)

114  (
i
);

118 
	}
}

123 
	$«ApiAssocŸ‹
(cÚ¡ *
wh”e
, 
pÜtfd
, 
fd
, 
mask
) {

124 
ev’ts
 = 0;

125 
rv
, 
”r
;

127 ià(
mask
 & 
AE_READABLE
)

128 
ev’ts
 |ğ
POLLIN
;

129 ià(
mask
 & 
AE_WRITABLE
)

130 
ev’ts
 |ğ
POLLOUT
;

132 ià(
evpÜt_debug
)

133 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹(%d, 0x%xèğ", 
wh”e
, 
fd
, 
ev’ts
);

135 
rv
 = 
	`pÜt_assocŸ‹
(
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
, 
ev’ts
,

136 (*)(
ušŒ_t
)
mask
);

137 
”r
 = 
”ºo
;

139 ià(
evpÜt_debug
)

140 
	`årštf
(
¡d”r
, "%d (%s)\n", 
rv
,„v =ğ0 ? "nØ”rÜ" : 
	`¡»¼Ü
(
”r
));

142 ià(
rv
 == -1) {

143 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹: %s\n", 
wh”e
, 
	`¡»¼Ü
(
”r
));

145 ià(
”r
 =ğ
EAGAIN
)

146 
	`årštf
(
¡d”r
, "aeApiAssociate:ƒvent…ort†imitƒxceeded.");

149  
rv
;

150 
	}
}

152 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

153 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

154 
fuÎmask
, 
pfd
;

156 ià(
evpÜt_debug
)

157 
	`årštf
(
¡d”r
, "«ApiAddEv’t: fd %d mask 0x%x\n", 
fd
, 
mask
);

164 
fuÎmask
 = 
mask
 | 
ev’tLoİ
->
ev’ts
[
fd
].mask;

165 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

167 ià(
pfd
 != -1) {

174 ià(
evpÜt_debug
)

175 
	`årštf
(
¡d”r
, "«ApiAddEv’t:‡ddšgØ³ndšg fd %d\n", 
fd
);

176 
¡©e
->
³ndšg_masks
[
pfd
] |ğ
fuÎmask
;

180  (
	`«ApiAssocŸ‹
("«ApiAddEv’t", 
¡©e
->
pÜtfd
, 
fd
, 
fuÎmask
));

181 
	}
}

183 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

184 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

185 
fuÎmask
, 
pfd
;

187 ià(
evpÜt_debug
)

188 
	`årštf
(
¡d”r
, "d– fd %d mask 0x%x\n", 
fd
, 
mask
);

190 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

192 ià(
pfd
 != -1) {

193 ià(
evpÜt_debug
)

194 
	`årštf
(
¡d”r
, "d–‘šgƒv’ˆäom…’dšg fd %d\n", 
fd
);

201 
¡©e
->
³ndšg_masks
[
pfd
] &ğ~
mask
;

203 ià(
¡©e
->
³ndšg_masks
[
pfd
] =ğ
AE_NONE
)

204 
¡©e
->
³ndšg_fds
[
pfd
] = -1;

217 
fuÎmask
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
;

218 ià(
fuÎmask
 =ğ
AE_NONE
) {

223 ià(
evpÜt_debug
)

224 
	`årštf
(
¡d”r
, "«ApiD–Ev’t:…Üt_dissocŸ‹(%d)\n", 
fd
);

226 ià(
	`pÜt_dissocŸ‹
(
¡©e
->
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
) != 0) {

227 
	`³¼Ü
("aeApiDelEvent:…ort_dissociate");

228 
	`abÜt
();

230 } ià(
	`«ApiAssocŸ‹
("«ApiD–Ev’t", 
¡©e
->
pÜtfd
, 
fd
,

231 
fuÎmask
) != 0) {

239 
	`abÜt
();

241 
	}
}

243 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

244 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

245 
time¥ec
 
timeout
, *
t¥
;

246 
mask
, 
i
;

247 
ušt_t
 
Ãv’ts
;

248 
pÜt_ev’t_t
 
ev’t
[
MAX_EVENT_BATCHSZ
];

255 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

256 ià(
¡©e
->
³ndšg_fds
[
i
] == -1)

260 ià(
	`«ApiAssocŸ‹
("«ApiPŞl", 
¡©e
->
pÜtfd
,

261 
¡©e
->
³ndšg_fds
[
i
], s‹->
³ndšg_masks
[i]) != 0) {

263 
	`abÜt
();

266 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

267 
¡©e
->
³ndšg_fds
[
i
] = -1;

270 
¡©e
->
Å’dšg
 = 0;

272 ià(
tvp
 !ğ
NULL
) {

273 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

274 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

275 
t¥
 = &
timeout
;

277 
t¥
 = 
NULL
;

284 
Ãv’ts
 = 1;

285 ià(
	`pÜt_g‘n
(
¡©e
->
pÜtfd
, 
ev’t
, 
MAX_EVENT_BATCHSZ
, &
Ãv’ts
,

286 
t¥
è=ğ-1 && (
”ºo
 !ğ
ETIME
 || 
Ãv’ts
 == 0)) {

287 ià(
”ºo
 =ğ
ETIME
 ||ƒ¼nØ=ğ
EINTR
)

291 
	`³¼Ü
("aeApiPoll:…ort_get");

292 
	`abÜt
();

295 
¡©e
->
Å’dšg
 = 
Ãv’ts
;

297 
i
 = 0; i < 
Ãv’ts
; i++) {

298 
mask
 = 0;

299 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLIN
)

300 
mask
 |ğ
AE_READABLE
;

301 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLOUT
)

302 
mask
 |ğ
AE_WRITABLE
;

304 
ev’tLoİ
->
fœed
[
i
].
fd
 = 
ev’t
[i].
pÜ‹v_objeù
;

305 
ev’tLoİ
->
fœed
[
i
].
mask
 = mask;

307 ià(
evpÜt_debug
)

308 
	`årštf
(
¡d”r
, "aeApiPoll: fd %d mask 0x%x\n",

309 ()
ev’t
[
i
].
pÜ‹v_objeù
, 
mask
);

311 
¡©e
->
³ndšg_fds
[
i
] = 
ev’t
[i].
pÜ‹v_objeù
;

312 
¡©e
->
³ndšg_masks
[
i
] = (
ušŒ_t
)
ev’t
[i].
pÜ‹v_u£r
;

315  
Ãv’ts
;

316 
	}
}

318 *
	$«ApiName
() {

320 
	}
}

	@src/ae_kqueue.c

32 
	~<sys/ty³s.h
>

33 
	~<sys/ev’t.h
>

34 
	~<sys/time.h
>

36 
	s«ApiS‹
 {

37 
	mkqfd
;

38 
kev’t
 *
	mev’ts
;

39 } 
	t«ApiS‹
;

41 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

42 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

44 ià(!
¡©e
)  -1;

45 
¡©e
->
ev’ts
 = 
	`zm®loc
((
kev’t
)*
ev’tLoİ
->
£tsize
);

46 ià(!
¡©e
->
ev’ts
) {

47 
	`zä“
(
¡©e
);

50 
¡©e
->
kqfd
 = 
	`kqueue
();

51 ià(
¡©e
->
kqfd
 == -1) {

52 
	`zä“
(
¡©e
->
ev’ts
);

53 
	`zä“
(
¡©e
);

56 
ev’tLoİ
->
­id©a
 = 
¡©e
;

58 
	}
}

60 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

61 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

63 
¡©e
->
ev’ts
 = 
	`z»®loc
(¡©e->ev’ts, (
kev’t
)*
£tsize
);

65 
	}
}

67 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

68 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

70 
	`şo£
(
¡©e
->
kqfd
);

71 
	`zä“
(
¡©e
->
ev’ts
);

72 
	`zä“
(
¡©e
);

73 
	}
}

75 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

76 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

77 
kev’t
 
ke
;

79 ià(
mask
 & 
AE_READABLE
) {

80 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_ADD
, 0, 0, 
NULL
);

81 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

83 ià(
mask
 & 
AE_WRITABLE
) {

84 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_ADD
, 0, 0, 
NULL
);

85 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
kev’t
 
ke
;

94 ià(
mask
 & 
AE_READABLE
) {

95 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 
NULL
);

96 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

98 ià(
mask
 & 
AE_WRITABLE
) {

99 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_DELETE
, 0, 0, 
NULL
);

100 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

102 
	}
}

104 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

105 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

106 
»tv®
, 
numev’ts
 = 0;

108 ià(
tvp
 !ğ
NULL
) {

109 
time¥ec
 
timeout
;

110 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

111 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

112 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

113 &
timeout
);

115 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

116 
NULL
);

119 ià(
»tv®
 > 0) {

120 
j
;

122 
numev’ts
 = 
»tv®
;

123 
j
 = 0; j < 
numev’ts
; j++) {

124 
mask
 = 0;

125 
kev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

127 ià(
e
->
f‹r
 =ğ
EVFILT_READ
è
mask
 |ğ
AE_READABLE
;

128 ià(
e
->
f‹r
 =ğ
EVFILT_WRITE
è
mask
 |ğ
AE_WRITABLE
;

129 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
id’t
;

130 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

133  
numev’ts
;

134 
	}
}

136 *
	$«ApiName
() {

138 
	}
}

	@src/ae_select.c

32 
	~<sys/£Ëù.h
>

33 
	~<¡ršg.h
>

35 
	s«ApiS‹
 {

36 
fd_£t
 
	mrfds
, 
	mwfds
;

39 
fd_£t
 
	m_rfds
, 
	m_wfds
;

40 } 
	t«ApiS‹
;

42 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

43 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

45 ià(!
¡©e
)  -1;

46 
	`FD_ZERO
(&
¡©e
->
rfds
);

47 
	`FD_ZERO
(&
¡©e
->
wfds
);

48 
ev’tLoİ
->
­id©a
 = 
¡©e
;

50 
	}
}

52 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

54 ià(
£tsize
 >ğ
FD_SETSIZE
)  -1;

56 
	}
}

58 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

59 
	`zä“
(
ev’tLoİ
->
­id©a
);

60 
	}
}

62 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

63 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

65 ià(
mask
 & 
AE_READABLE
è
	`FD_SET
(
fd
,&
¡©e
->
rfds
);

66 ià(
mask
 & 
AE_WRITABLE
è
	`FD_SET
(
fd
,&
¡©e
->
wfds
);

68 
	}
}

70 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

71 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

73 ià(
mask
 & 
AE_READABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
rfds
);

74 ià(
mask
 & 
AE_WRITABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
wfds
);

75 
	}
}

77 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

78 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

79 
»tv®
, 
j
, 
numev’ts
 = 0;

81 
	`memıy
(&
¡©e
->
_rfds
,&¡©e->
rfds
,(
fd_£t
));

82 
	`memıy
(&
¡©e
->
_wfds
,&¡©e->
wfds
,(
fd_£t
));

84 
»tv®
 = 
	`£Ëù
(
ev’tLoİ
->
maxfd
+1,

85 &
¡©e
->
_rfds
,&¡©e->
_wfds
,
NULL
,
tvp
);

86 ià(
»tv®
 > 0) {

87 
j
 = 0; j <ğ
ev’tLoİ
->
maxfd
; j++) {

88 
mask
 = 0;

89 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
j
];

91 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

92 ià(
ã
->
mask
 & 
AE_READABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_rfds
))

93 
mask
 |ğ
AE_READABLE
;

94 ià(
ã
->
mask
 & 
AE_WRITABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_wfds
))

95 
mask
 |ğ
AE_WRITABLE
;

96 
ev’tLoİ
->
fœed
[
numev’ts
].
fd
 = 
j
;

97 
ev’tLoİ
->
fœed
[
numev’ts
].
mask
 = mask;

98 
numev’ts
++;

101  
numev’ts
;

102 
	}
}

104 *
	$«ApiName
() {

106 
	}
}

	@src/anet.c

31 
	~"fmaüos.h
"

33 
	~<sys/ty³s.h
>

34 
	~<sys/sock‘.h
>

35 
	~<sys/¡©.h
>

36 
	~<sys/un.h
>

37 
	~<sys/time.h
>

38 
	~<Ãtš‘/š.h
>

39 
	~<Ãtš‘/tı.h
>

40 
	~<¬·/š‘.h
>

41 
	~<uni¡d.h
>

42 
	~<fú.h
>

43 
	~<¡ršg.h
>

44 
	~<Ãtdb.h
>

45 
	~<”ºo.h
>

46 
	~<¡d¬g.h
>

47 
	~<¡dio.h
>

49 
	~"ª‘.h
"

51 
	$ª‘S‘E¼Ü
(*
”r
, cÚ¡ *
fmt
, ...)

53 
va_li¡
 
­
;

55 ià(!
”r
) ;

56 
	`va_¡¬t
(
­
, 
fmt
);

57 
	`v¢´štf
(
”r
, 
ANET_ERR_LEN
, 
fmt
, 
­
);

58 
	`va_’d
(
­
);

59 
	}
}

61 
	$ª‘S‘Block
(*
”r
, 
fd
, 
nÚ_block
) {

62 
æags
;

67 ià((
æags
 = 
	`fú
(
fd
, 
F_GETFL
)) == -1) {

68 
	`ª‘S‘E¼Ü
(
”r
, "fú(F_GETFL): %s", 
	`¡»¼Ü
(
”ºo
));

69  
ANET_ERR
;

72 ià(
nÚ_block
)

73 
æags
 |ğ
O_NONBLOCK
;

75 
æags
 &ğ~
O_NONBLOCK
;

77 ià(
	`fú
(
fd
, 
F_SETFL
, 
æags
) == -1) {

78 
	`ª‘S‘E¼Ü
(
”r
, "fú(F_SETFL,O_NONBLOCK): %s", 
	`¡»¼Ü
(
”ºo
));

79  
ANET_ERR
;

81  
ANET_OK
;

82 
	}
}

84 
	$ª‘NÚBlock
(*
”r
, 
fd
) {

85  
	`ª‘S‘Block
(
”r
,
fd
,1);

86 
	}
}

88 
	$ª‘Block
(*
”r
, 
fd
) {

89  
	`ª‘S‘Block
(
”r
,
fd
,0);

90 
	}
}

95 
	$ª‘K“pAlive
(*
”r
, 
fd
, 
š‹rv®
)

97 
v®
 = 1;

99 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
v®
, (val)) == -1)

101 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_KEEPALIVE: %s", 
	`¡»¼Ü
(
”ºo
));

102  
ANET_ERR
;

105 #ifdeà
__lšux__


111 
v®
 = 
š‹rv®
;

112 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPIDLE
, &
v®
, (val)) < 0) {

113 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPIDLE: %s\n", 
	`¡»¼Ü
(
”ºo
));

114  
ANET_ERR
;

120 
v®
 = 
š‹rv®
/3;

121 ià(
v®
 == 0) val = 1;

122 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPINTVL
, &
v®
, (val)) < 0) {

123 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPINTVL: %s\n", 
	`¡»¼Ü
(
”ºo
));

124  
ANET_ERR
;

129 
v®
 = 3;

130 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPCNT
, &
v®
, (val)) < 0) {

131 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPCNT: %s\n", 
	`¡»¼Ü
(
”ºo
));

132  
ANET_ERR
;

135 ((è
š‹rv®
);

138  
ANET_OK
;

139 
	}
}

141 
	$ª‘S‘TıNoD–ay
(*
”r
, 
fd
, 
v®
)

143 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
v®
, (val)) == -1)

145 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_NODELAY: %s", 
	`¡»¼Ü
(
”ºo
));

146  
ANET_ERR
;

148  
ANET_OK
;

149 
	}
}

151 
	$ª‘EÇbËTıNoD–ay
(*
”r
, 
fd
)

153  
	`ª‘S‘TıNoD–ay
(
”r
, 
fd
, 1);

154 
	}
}

156 
	$ª‘Di§bËTıNoD–ay
(*
”r
, 
fd
)

158  
	`ª‘S‘TıNoD–ay
(
”r
, 
fd
, 0);

159 
	}
}

162 
	$ª‘S‘S’dBufãr
(*
”r
, 
fd
, 
buffsize
)

164 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
buffsize
, (buffsize)) == -1)

166 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_SNDBUF: %s", 
	`¡»¼Ü
(
”ºo
));

167  
ANET_ERR
;

169  
ANET_OK
;

170 
	}
}

172 
	$ª‘TıK“pAlive
(*
”r
, 
fd
)

174 
yes
 = 1;

175 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
yes
, (yes)) == -1) {

176 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_KEEPALIVE: %s", 
	`¡»¼Ü
(
”ºo
));

177  
ANET_ERR
;

179  
ANET_OK
;

180 
	}
}

184 
	$ª‘S’dTimeout
(*
”r
, 
fd
, 
ms
) {

185 
timev®
 
tv
;

187 
tv
.
tv_£c
 = 
ms
/1000;

188 
tv
.
tv_u£c
 = (
ms
%1000)*1000;

189 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_SNDTIMEO
, &
tv
, (tv)) == -1) {

190 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_SNDTIMEO: %s", 
	`¡»¼Ü
(
”ºo
));

191  
ANET_ERR
;

193  
ANET_OK
;

194 
	}
}

203 
	$ª‘G’”icResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
,

204 
æags
)

206 
addršfo
 
hšts
, *
šfo
;

207 
rv
;

209 
	`mem£t
(&
hšts
,0,(hints));

210 ià(
æags
 & 
ANET_IP_ONLY
è
hšts
.
ai_æags
 = 
AI_NUMERICHOST
;

211 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

212 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

214 ià((
rv
 = 
	`g‘addršfo
(
ho¡
, 
NULL
, &
hšts
, &
šfo
)) != 0) {

215 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

216  
ANET_ERR
;

218 ià(
šfo
->
ai_çmy
 =ğ
AF_INET
) {

219 
sockaddr_š
 *
§
 = (sockaddr_š *)
šfo
->
ai_addr
;

220 
	`š‘_Áİ
(
AF_INET
, &(
§
->
sš_addr
), 
buf
, 
buf_Ën
);

222 
sockaddr_š6
 *
§
 = (sockaddr_š6 *)
šfo
->
ai_addr
;

223 
	`š‘_Áİ
(
AF_INET6
, &(
§
->
sš6_addr
), 
buf
, 
buf_Ën
);

226 
	`ä“addršfo
(
šfo
);

227  
ANET_OK
;

228 
	}
}

230 
	$ª‘ResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
) {

231  
	`ª‘G’”icResŞve
(
”r
,
ho¡
,
buf
,
buf_Ën
,
ANET_NONE
);

232 
	}
}

234 
	$ª‘ResŞveIP
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
) {

235  
	`ª‘G’”icResŞve
(
”r
,
ho¡
,
buf
,
buf_Ën
,
ANET_IP_ONLY
);

236 
	}
}

238 
	$ª‘S‘Reu£Addr
(*
”r
, 
fd
) {

239 
yes
 = 1;

242 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes)) == -1) {

243 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_REUSEADDR: %s", 
	`¡»¼Ü
(
”ºo
));

244  
ANET_ERR
;

246  
ANET_OK
;

247 
	}
}

249 
	$ª‘C»©eSock‘
(*
”r
, 
domaš
) {

250 
s
;

251 ià((
s
 = 
	`sock‘
(
domaš
, 
SOCK_STREAM
, 0)) == -1) {

252 
	`ª‘S‘E¼Ü
(
”r
, "ü—tšg sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

253  
ANET_ERR
;

258 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
) {

259 
	`şo£
(
s
);

260  
ANET_ERR
;

262  
s
;

263 
	}
}

265 
	#ANET_CONNECT_NONE
 0

	)

266 
	#ANET_CONNECT_NONBLOCK
 1

	)

267 
	#ANET_CONNECT_BE_BINDING
 2

	)

268 
	$ª‘TıG’”icCÚÃù
(*
”r
, *
addr
, 
pÜt
,

269 *
sourû_addr
, 
æags
)

271 
s
 = 
ANET_ERR
, 
rv
;

272 
pÜt¡r
[6];

273 
addršfo
 
hšts
, *
£rvšfo
, *
b£rvšfo
, *
p
, *
b
;

275 
	`¢´štf
(
pÜt¡r
,ÕÜt¡r),"%d",
pÜt
);

276 
	`mem£t
(&
hšts
,0,(hints));

277 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

278 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

280 ià((
rv
 = 
	`g‘addršfo
(
addr
,
pÜt¡r
,&
hšts
,&
£rvšfo
)) != 0) {

281 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

282  
ANET_ERR
;

284 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

288 ià((
s
 = 
	`sock‘
(
p
->
ai_çmy
,p->
ai_sockty³
,p->
ai_´ÙocŞ
)) == -1)

290 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

291 ià(
æags
 & 
ANET_CONNECT_NONBLOCK
 && 
	`ª‘NÚBlock
(
”r
,
s
è!ğ
ANET_OK
)

292 
”rÜ
;

293 ià(
sourû_addr
) {

294 
bound
 = 0;

296 ià((
rv
 = 
	`g‘addršfo
(
sourû_addr
, 
NULL
, &
hšts
, &
b£rvšfo
)) != 0)

298 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

299 
”rÜ
;

301 
b
 = 
b£rvšfo
; b !ğ
NULL
; b = b->
ai_Ãxt
) {

302 ià(
	`bšd
(
s
,
b
->
ai_addr
,b->
ai_add¾’
) != -1) {

303 
bound
 = 1;

307 
	`ä“addršfo
(
b£rvšfo
);

308 ià(!
bound
) {

309 
	`ª‘S‘E¼Ü
(
”r
, "bšd: %s", 
	`¡»¼Ü
(
”ºo
));

310 
”rÜ
;

313 ià(
	`cÚÃù
(
s
,
p
->
ai_addr
,p->
ai_add¾’
) == -1) {

316 ià(
”ºo
 =ğ
EINPROGRESS
 && 
æags
 & 
ANET_CONNECT_NONBLOCK
)

317 
’d
;

318 
	`şo£
(
s
);

319 
s
 = 
ANET_ERR
;

325 
’d
;

327 ià(
p
 =ğ
NULL
)

328 
	`ª‘S‘E¼Ü
(
”r
, "ü—tšg sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

330 
”rÜ
:

331 ià(
s
 !ğ
ANET_ERR
) {

332 
	`şo£
(
s
);

333 
s
 = 
ANET_ERR
;

336 
’d
:

337 
	`ä“addršfo
(
£rvšfo
);

341 ià(
s
 =ğ
ANET_ERR
 && 
sourû_addr
 && (
æags
 & 
ANET_CONNECT_BE_BINDING
)) {

342  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
NULL
,
æags
);

344  
s
;

346 
	}
}

348 
	$ª‘TıCÚÃù
(*
”r
, *
addr
, 
pÜt
)

350  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
NULL
,
ANET_CONNECT_NONE
);

351 
	}
}

353 
	$ª‘TıNÚBlockCÚÃù
(*
”r
, *
addr
, 
pÜt
)

355  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
NULL
,
ANET_CONNECT_NONBLOCK
);

356 
	}
}

358 
	$ª‘TıNÚBlockBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
,

359 *
sourû_addr
)

361  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
sourû_addr
,

362 
ANET_CONNECT_NONBLOCK
);

363 
	}
}

365 
	$ª‘TıNÚBlockBe¡EffÜtBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
,

366 *
sourû_addr
)

368  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
sourû_addr
,

369 
ANET_CONNECT_NONBLOCK
|
ANET_CONNECT_BE_BINDING
);

370 
	}
}

372 
	$ª‘UnixG’”icCÚÃù
(*
”r
, *
·th
, 
æags
)

374 
s
;

375 
sockaddr_un
 
§
;

377 ià((
s
 = 
	`ª‘C»©eSock‘
(
”r
,
AF_LOCAL
)è=ğ
ANET_ERR
)

378  
ANET_ERR
;

380 
§
.
sun_çmy
 = 
AF_LOCAL
;

381 
	`¡ºıy
(
§
.
sun_·th
,
·th
,(sa.sun_path)-1);

382 ià(
æags
 & 
ANET_CONNECT_NONBLOCK
) {

383 ià(
	`ª‘NÚBlock
(
”r
,
s
è!ğ
ANET_OK
) {

384 
	`şo£
(
s
);

385  
ANET_ERR
;

388 ià(
	`cÚÃù
(
s
,(
sockaddr
*)&
§
,(sa)) == -1) {

389 ià(
”ºo
 =ğ
EINPROGRESS
 &&

390 
æags
 & 
ANET_CONNECT_NONBLOCK
)

391  
s
;

393 
	`ª‘S‘E¼Ü
(
”r
, "cÚÃù: %s", 
	`¡»¼Ü
(
”ºo
));

394 
	`şo£
(
s
);

395  
ANET_ERR
;

397  
s
;

398 
	}
}

400 
	$ª‘UnixCÚÃù
(*
”r
, *
·th
)

402  
	`ª‘UnixG’”icCÚÃù
(
”r
,
·th
,
ANET_CONNECT_NONE
);

403 
	}
}

405 
	$ª‘UnixNÚBlockCÚÃù
(*
”r
, *
·th
)

407  
	`ª‘UnixG’”icCÚÃù
(
”r
,
·th
,
ANET_CONNECT_NONBLOCK
);

408 
	}
}

412 
	$ª‘R—d
(
fd
, *
buf
, 
couÁ
)

414 
ssize_t
 
Ä—d
, 
tÙËn
 = 0;

415 
tÙËn
 !ğ
couÁ
) {

416 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
couÁ
-
tÙËn
);

417 ià(
Ä—d
 =ğ0è 
tÙËn
;

418 ià(
Ä—d
 == -1)  -1;

419 
tÙËn
 +ğ
Ä—d
;

420 
buf
 +ğ
Ä—d
;

422  
tÙËn
;

423 
	}
}

427 
	$ª‘Wr™e
(
fd
, *
buf
, 
couÁ
)

429 
ssize_t
 
nwr™‹n
, 
tÙËn
 = 0;

430 
tÙËn
 !ğ
couÁ
) {

431 
nwr™‹n
 = 
	`wr™e
(
fd
,
buf
,
couÁ
-
tÙËn
);

432 ià(
nwr™‹n
 =ğ0è 
tÙËn
;

433 ià(
nwr™‹n
 == -1)  -1;

434 
tÙËn
 +ğ
nwr™‹n
;

435 
buf
 +ğ
nwr™‹n
;

437  
tÙËn
;

438 
	}
}

440 
	$ª‘Li¡’
(*
”r
, 
s
, 
sockaddr
 *
§
, 
sockËn_t
 
Ën
, 
backlog
) {

441 ià(
	`bšd
(
s
,
§
,
Ën
) == -1) {

442 
	`ª‘S‘E¼Ü
(
”r
, "bšd: %s", 
	`¡»¼Ü
(
”ºo
));

443 
	`şo£
(
s
);

444  
ANET_ERR
;

447 ià(
	`li¡’
(
s
, 
backlog
) == -1) {

448 
	`ª‘S‘E¼Ü
(
”r
, "li¡’: %s", 
	`¡»¼Ü
(
”ºo
));

449 
	`şo£
(
s
);

450  
ANET_ERR
;

452  
ANET_OK
;

453 
	}
}

455 
	$ª‘V6OÆy
(*
”r
, 
s
) {

456 
yes
 = 1;

457 ià(
	`£tsockİt
(
s
,
IPPROTO_IPV6
,
IPV6_V6ONLY
,&
yes
,(yes)) == -1) {

458 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİt: %s", 
	`¡»¼Ü
(
”ºo
));

459 
	`şo£
(
s
);

460  
ANET_ERR
;

462  
ANET_OK
;

463 
	}
}

465 
	$_ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
af
, 
backlog
)

467 
s
 = -1, 
rv
;

468 
_pÜt
[6];

469 
addršfo
 
hšts
, *
£rvšfo
, *
p
;

471 
	`¢´štf
(
_pÜt
,6,"%d",
pÜt
);

472 
	`mem£t
(&
hšts
,0,(hints));

473 
hšts
.
ai_çmy
 = 
af
;

474 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

475 
hšts
.
ai_æags
 = 
AI_PASSIVE
;

477 ià((
rv
 = 
	`g‘addršfo
(
bšdaddr
,
_pÜt
,&
hšts
,&
£rvšfo
)) != 0) {

478 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

479  
ANET_ERR
;

481 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

482 ià((
s
 = 
	`sock‘
(
p
->
ai_çmy
,p->
ai_sockty³
,p->
ai_´ÙocŞ
)) == -1)

485 ià(
af
 =ğ
AF_INET6
 && 
	`ª‘V6OÆy
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

486 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

487 ià(
	`ª‘Li¡’
(
”r
,
s
,
p
->
ai_addr
,p->
ai_add¾’
,
backlog
è=ğ
ANET_ERR
) s = ANET_ERR;

488 
’d
;

490 ià(
p
 =ğ
NULL
) {

491 
	`ª‘S‘E¼Ü
(
”r
, "uÇbËØbšd sock‘,ƒ¼no: %d", 
”ºo
);

492 
”rÜ
;

495 
”rÜ
:

496 ià(
s
 !ğ-1è
	`şo£
(s);

497 
s
 = 
ANET_ERR
;

498 
’d
:

499 
	`ä“addršfo
(
£rvšfo
);

500  
s
;

501 
	}
}

503 
	$ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
)

505  
	`_ª‘TıS”v”
(
”r
, 
pÜt
, 
bšdaddr
, 
AF_INET
, 
backlog
);

506 
	}
}

508 
	$ª‘Tı6S”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
)

510  
	`_ª‘TıS”v”
(
”r
, 
pÜt
, 
bšdaddr
, 
AF_INET6
, 
backlog
);

511 
	}
}

513 
	$ª‘UnixS”v”
(*
”r
, *
·th
, 
mode_t
 
³rm
, 
backlog
)

515 
s
;

516 
sockaddr_un
 
§
;

518 ià((
s
 = 
	`ª‘C»©eSock‘
(
”r
,
AF_LOCAL
)è=ğ
ANET_ERR
)

519  
ANET_ERR
;

521 
	`mem£t
(&
§
,0,(sa));

522 
§
.
sun_çmy
 = 
AF_LOCAL
;

523 
	`¡ºıy
(
§
.
sun_·th
,
·th
,(sa.sun_path)-1);

524 ià(
	`ª‘Li¡’
(
”r
,
s
,(
sockaddr
*)&
§
,(§),
backlog
è=ğ
ANET_ERR
)

525  
ANET_ERR
;

526 ià(
³rm
)

527 
	`chmod
(
§
.
sun_·th
, 
³rm
);

528  
s
;

529 
	}
}

531 
	$ª‘G’”icAcû±
(*
”r
, 
s
, 
sockaddr
 *
§
, 
sockËn_t
 *
Ën
) {

532 
fd
;

534 
fd
 = 
	`acû±
(
s
,
§
,
Ën
);

535 ià(
fd
 == -1) {

536 ià(
”ºo
 =ğ
EINTR
)

539 
	`ª‘S‘E¼Ü
(
”r
, "acû±: %s", 
	`¡»¼Ü
(
”ºo
));

540  
ANET_ERR
;

545  
fd
;

546 
	}
}

548 
	$ª‘TıAcû±
(*
”r
, 
s
, *

, 
size_t
 
_Ën
, *
pÜt
) {

549 
fd
;

550 
sockaddr_¡Üage
 
§
;

551 
sockËn_t
 
§Ën
 = (
§
);

552 ià((
fd
 = 
	`ª‘G’”icAcû±
(
”r
,
s
,(
sockaddr
*)&
§
,&
§Ën
)) == -1)

553  
ANET_ERR
;

555 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

556 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

557 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

558 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

560 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

561 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

562 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

564  
fd
;

565 
	}
}

567 
	$ª‘UnixAcû±
(*
”r
, 
s
) {

568 
fd
;

569 
sockaddr_un
 
§
;

570 
sockËn_t
 
§Ën
 = (
§
);

571 ià((
fd
 = 
	`ª‘G’”icAcû±
(
”r
,
s
,(
sockaddr
*)&
§
,&
§Ën
)) == -1)

572  
ANET_ERR
;

574  
fd
;

575 
	}
}

577 
	$ª‘P“rToSŒšg
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
) {

578 
sockaddr_¡Üage
 
§
;

579 
sockËn_t
 
§Ën
 = (
§
);

581 ià(
	`g‘³”Çme
(
fd
,(
sockaddr
*)&
§
,&
§Ën
è=ğ-1è
”rÜ
;

582 ià(
_Ën
 =ğ0è
”rÜ
;

584 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

585 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

586 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

587 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

588 } ià(
§
.
ss_çmy
 =ğ
AF_INET6
) {

589 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

590 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

591 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

592 } ià(
§
.
ss_çmy
 =ğ
AF_UNIX
) {

593 ià(

è
	`¡ºıy
(,"/unixsock‘",
_Ën
);

594 ià(
pÜt
) *port = 0;

596 
”rÜ
;

600 
”rÜ
:

601 ià(

) {

602 ià(
_Ën
 >= 2) {

603 

[0] = '?';

604 

[1] = '\0';

605 } ià(
_Ën
 == 1) {

606 

[0] = '\0';

609 ià(
pÜt
) *port = 0;

611 
	}
}

616 
	$ª‘FÜm©Addr
(*
buf
, 
size_t
 
buf_Ën
, *

, 
pÜt
) {

617  
	`¢´štf
(
buf
,
buf_Ën
, 
	`¡rchr
(

,':') ?

618 "[%s]:%d" : "%s:%d", 

, 
pÜt
);

619 
	}
}

622 
	$ª‘FÜm©P“r
(
fd
, *
buf
, 
size_t
 
buf_Ën
) {

623 

[
INET6_ADDRSTRLEN
];

624 
pÜt
;

626 
	`ª‘P“rToSŒšg
(
fd
,

,(),&
pÜt
);

627  
	`ª‘FÜm©Addr
(
buf
, 
buf_Ën
, 

, 
pÜt
);

628 
	}
}

630 
	$ª‘SockName
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
) {

631 
sockaddr_¡Üage
 
§
;

632 
sockËn_t
 
§Ën
 = (
§
);

634 ià(
	`g‘sockÇme
(
fd
,(
sockaddr
*)&
§
,&
§Ën
) == -1) {

635 ià(
pÜt
) *port = 0;

636 

[0] = '?';

637 

[1] = '\0';

640 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

641 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

642 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

643 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

645 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

646 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

647 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

650 
	}
}

652 
	$ª‘FÜm©Sock
(
fd
, *
fmt
, 
size_t
 
fmt_Ën
) {

653 

[
INET6_ADDRSTRLEN
];

654 
pÜt
;

656 
	`ª‘SockName
(
fd
,

,(),&
pÜt
);

657  
	`ª‘FÜm©Addr
(
fmt
, 
fmt_Ën
, 

, 
pÜt
);

658 
	}
}

	@src/anet.h

31 #iâdeà
ANET_H


32 
	#ANET_H


	)

34 
	~<sys/ty³s.h
>

36 
	#ANET_OK
 0

	)

37 
	#ANET_ERR
 -1

	)

38 
	#ANET_ERR_LEN
 256

	)

41 
	#ANET_NONE
 0

	)

42 
	#ANET_IP_ONLY
 (1<<0)

	)

44 #ià
defšed
(
__sun
è|| defšed(
_AIX
)

45 
	#AF_LOCAL
 
AF_UNIX


	)

48 #ifdeà
_AIX


49 #undeà
_Ën


52 
ª‘TıCÚÃù
(*
”r
, *
addr
, 
pÜt
);

53 
ª‘TıNÚBlockCÚÃù
(*
”r
, *
addr
, 
pÜt
);

54 
ª‘TıNÚBlockBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
, *
sourû_addr
);

55 
ª‘TıNÚBlockBe¡EffÜtBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
, *
sourû_addr
);

56 
ª‘UnixCÚÃù
(*
”r
, *
·th
);

57 
ª‘UnixNÚBlockCÚÃù
(*
”r
, *
·th
);

58 
ª‘R—d
(
fd
, *
buf
, 
couÁ
);

59 
ª‘ResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
);

60 
ª‘ResŞveIP
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
);

61 
ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
);

62 
ª‘Tı6S”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
);

63 
ª‘UnixS”v”
(*
”r
, *
·th
, 
mode_t
 
³rm
, 
backlog
);

64 
ª‘TıAcû±
(*
”r
, 
£rv”sock
, *

, 
size_t
 
_Ën
, *
pÜt
);

65 
ª‘UnixAcû±
(*
”r
, 
£rv”sock
);

66 
ª‘Wr™e
(
fd
, *
buf
, 
couÁ
);

67 
ª‘NÚBlock
(*
”r
, 
fd
);

68 
ª‘Block
(*
”r
, 
fd
);

69 
ª‘EÇbËTıNoD–ay
(*
”r
, 
fd
);

70 
ª‘Di§bËTıNoD–ay
(*
”r
, 
fd
);

71 
ª‘TıK“pAlive
(*
”r
, 
fd
);

72 
ª‘S’dTimeout
(*
”r
, 
fd
, 
ms
);

73 
ª‘P“rToSŒšg
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
);

74 
ª‘K“pAlive
(*
”r
, 
fd
, 
š‹rv®
);

75 
ª‘SockName
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
);

76 
ª‘FÜm©Addr
(*
fmt
, 
size_t
 
fmt_Ën
, *

, 
pÜt
);

77 
ª‘FÜm©P“r
(
fd
, *
fmt
, 
size_t
 
fmt_Ën
);

78 
ª‘FÜm©Sock
(
fd
, *
fmt
, 
size_t
 
fmt_Ën
);

	@src/aof.c

30 
	~"£rv”.h
"

31 
	~"bio.h
"

32 
	~"rio.h
"

34 
	~<sigÇl.h
>

35 
	~<fú.h
>

36 
	~<sys/¡©.h
>

37 
	~<sys/ty³s.h
>

38 
	~<sys/time.h
>

39 
	~<sys/»sourû.h
>

40 
	~<sys/wa™.h
>

41 
	~<sys/·¿m.h
>

43 
aofUpd©eCu¼’tSize
();

44 
aofClo£Pes
();

60 
	#AOF_RW_BUF_BLOCK_SIZE
 (1024*1024*10è

	)

62 
	saoäwblock
 {

63 
	mu£d
, 
	mä“
;

64 
	mbuf
[
AOF_RW_BUF_BLOCK_SIZE
];

65 } 
	taoäwblock
;

70 
	$aofRewr™eBufãrRe£t
() {

71 ià(
£rv”
.
aof_»wr™e_buf_blocks
)

72 
	`li¡R–—£
(
£rv”
.
aof_»wr™e_buf_blocks
);

74 
£rv”
.
aof_»wr™e_buf_blocks
 = 
	`li¡C»©e
();

75 
	`li¡S‘F»eM‘hod
(
£rv”
.
aof_»wr™e_buf_blocks
,
zä“
);

76 
	}
}

79 
	$aofRewr™eBufãrSize
() {

80 
li¡Node
 *
Ê
;

81 
li¡I‹r
 
li
;

82 
size
 = 0;

84 
	`li¡Rewšd
(
£rv”
.
aof_»wr™e_buf_blocks
,&
li
);

85 (
Ê
 = 
	`li¡Next
(&
li
))) {

86 
aoäwblock
 *
block
 = 
	`li¡NodeV®ue
(
Ê
);

87 
size
 +ğ
block
->
u£d
;

89  
size
;

90 
	}
}

95 
	$aofChdWr™eDiffD©a
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

96 
li¡Node
 *
Ê
;

97 
aoäwblock
 *
block
;

98 
ssize_t
 
nwr™‹n
;

99 
	`UNUSED
(
–
);

100 
	`UNUSED
(
fd
);

101 
	`UNUSED
(
´ivd©a
);

102 
	`UNUSED
(
mask
);

105 
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

106 
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

107 ià(
£rv”
.
aof_¡İ_£ndšg_diff
 || !
block
) {

108 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
,

109 
AE_WRITABLE
);

112 ià(
block
->
u£d
 > 0) {

113 
nwr™‹n
 = 
	`wr™e
(
£rv”
.
aof_pe_wr™e_d©a_to_chd
,

114 
block
->
buf
,block->
u£d
);

115 ià(
nwr™‹n
 <= 0) ;

116 
	`memmove
(
block
->
buf
,block->buf+
nwr™‹n
,block->
u£d
-nwritten);

117 
block
->
u£d
 -ğ
nwr™‹n
;

118 
block
->
ä“
 +ğ
nwr™‹n
;

120 ià(
block
->
u£d
 =ğ0è
	`li¡D–Node
(
£rv”
.
aof_»wr™e_buf_blocks
,
Ê
);

122 
	}
}

125 
	$aofRewr™eBufãrAµ’d
(*
s
, 
Ën
) {

126 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

127 
aoäwblock
 *
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

129 
Ën
) {

132 ià(
block
) {

133 
thi¦’
 = (
block
->
ä“
 < 
Ën
) ? block->free :†en;

134 ià(
thi¦’
) {

135 
	`memıy
(
block
->
buf
+block->
u£d
, 
s
, 
thi¦’
);

136 
block
->
u£d
 +ğ
thi¦’
;

137 
block
->
ä“
 -ğ
thi¦’
;

138 
s
 +ğ
thi¦’
;

139 
Ën
 -ğ
thi¦’
;

143 ià(
Ën
) {

144 
numblocks
;

146 
block
 = 
	`zm®loc
((*block));

147 
block
->
ä“
 = 
AOF_RW_BUF_BLOCK_SIZE
;

148 
block
->
u£d
 = 0;

149 
	`li¡AddNodeTa
(
£rv”
.
aof_»wr™e_buf_blocks
,
block
);

153 
numblocks
 = 
	`li¡L’gth
(
£rv”
.
aof_»wr™e_buf_blocks
);

154 ià(((
numblocks
+1) % 10) == 0) {

155 
Ëv–
 = ((
numblocks
+1è% 100è=ğ0 ? 
LL_WARNING
 :

156 
LL_NOTICE
;

157 
	`£rv”Log
(
Ëv–
,"Background AOF buffer size: %lu MB",

158 
	`aofRewr™eBufãrSize
()/(1024*1024));

165 ià(
	`«G‘FeEv’ts
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
) == 0) {

166 
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
aof_pe_wr™e_d©a_to_chd
,

167 
AE_WRITABLE
, 
aofChdWr™eDiffD©a
, 
NULL
);

169 
	}
}

174 
ssize_t
 
	$aofRewr™eBufãrWr™e
(
fd
) {

175 
li¡Node
 *
Ê
;

176 
li¡I‹r
 
li
;

177 
ssize_t
 
couÁ
 = 0;

179 
	`li¡Rewšd
(
£rv”
.
aof_»wr™e_buf_blocks
,&
li
);

180 (
Ê
 = 
	`li¡Next
(&
li
))) {

181 
aoäwblock
 *
block
 = 
	`li¡NodeV®ue
(
Ê
);

182 
ssize_t
 
nwr™‹n
;

184 ià(
block
->
u£d
) {

185 
nwr™‹n
 = 
	`wr™e
(
fd
,
block
->
buf
,block->
u£d
);

186 ià(
nwr™‹n
 !ğ(
ssize_t
)
block
->
u£d
) {

187 ià(
nwr™‹n
 =ğ0è
”ºo
 = 
EIO
;

190 
couÁ
 +ğ
nwr™‹n
;

193  
couÁ
;

194 
	}
}

202 
	$aof_background_fsync
(
fd
) {

203 
	`bioC»©eBackgroundJob
(
BIO_AOF_FSYNC
,(*)()
fd
,
NULL
,NULL);

204 
	}
}

207 
	$klAµ’dOÆyChd
() {

208 
¡©loc
;

210 ià(
£rv”
.
aof_chd_pid
 == -1) ;

212 
	`£rv”Log
(
LL_NOTICE
,"Killing„unning AOF„ewrite child: %ld",

213 (è
£rv”
.
aof_chd_pid
);

214 ià(
	`kl
(
£rv”
.
aof_chd_pid
,
SIGUSR1
) != -1) {

215 
	`wa™3
(&
¡©loc
,0,
NULL
è!ğ
£rv”
.
aof_chd_pid
);

218 
	`aofRewr™eBufãrRe£t
();

219 
	`aofRemoveTempFe
(
£rv”
.
aof_chd_pid
);

220 
£rv”
.
aof_chd_pid
 = -1;

221 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

223 
	`aofClo£Pes
();

224 
	}
}

228 
	$¡İAµ’dOÆy
() {

229 
	`£rv”As£¹
(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
);

230 
	`æushAµ’dOÆyFe
(1);

231 
	`aof_fsync
(
£rv”
.
aof_fd
);

232 
	`şo£
(
£rv”
.
aof_fd
);

234 
£rv”
.
aof_fd
 = -1;

235 
£rv”
.
aof_£Ëùed_db
 = -1;

236 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

237 
	`klAµ’dOÆyChd
();

238 
	}
}

242 
	$¡¬tAµ’dOÆy
() {

243 
cwd
[
MAXPATHLEN
];

244 
Ãwfd
;

246 
Ãwfd
 = 
	`İ’
(
£rv”
.
aof_f’ame
,
O_RDWR
|
O_APPEND
|
O_CREAT
,0644);

247 
	`£rv”As£¹
(
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
);

248 ià(
Ãwfd
 == -1) {

249 *
cwdp
 = 
	`g‘cwd
(
cwd
,
MAXPATHLEN
);

251 
	`£rv”Log
(
LL_WARNING
,

254 
£rv”
.
aof_f’ame
,

255 
cwdp
 ? cwdp : "unknown",

256 
	`¡»¼Ü
(
”ºo
));

257  
C_ERR
;

259 ià(
£rv”
.
rdb_chd_pid
 != -1) {

260 
£rv”
.
aof_»wr™e_scheduËd
 = 1;

261 
	`£rv”Log
(
LL_WARNING
,"AOF wasƒnabled buthere is‡lready‡ child…rocess saving‡n RDB file on disk. An AOF background was scheduledo start when…ossible.");

266 ià(
£rv”
.
aof_chd_pid
 != -1) {

267 
	`£rv”Log
(
LL_WARNING
,"AOF wasƒnabled buthere is‡lready‡n AOF„ewriting in background. Stopping background AOF‡nd starting‡„ewrite‚ow.");

268 
	`klAµ’dOÆyChd
();

270 ià(
	`»wr™eAµ’dOÆyFeBackground
(è=ğ
C_ERR
) {

271 
	`şo£
(
Ãwfd
);

272 
	`£rv”Log
(
LL_WARNING
,"Redis‚eedsoƒnablehe AOF but can'trigger‡ background AOF„ewrite operation. Checkhe‡bove†ogs for more info‡boutheƒrror.");

273  
C_ERR
;

278 
£rv”
.
aof_¡©e
 = 
AOF_WAIT_REWRITE
;

279 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

280 
£rv”
.
aof_fd
 = 
Ãwfd
;

281  
C_OK
;

282 
	}
}

291 
ssize_t
 
	$aofWr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

292 
ssize_t
 
nwr™‹n
 = 0, 
tÙwr™‹n
 = 0;

294 
Ën
) {

295 
nwr™‹n
 = 
	`wr™e
(
fd
, 
buf
, 
Ën
);

297 ià(
nwr™‹n
 < 0) {

298 ià(
”ºo
 =ğ
EINTR
) {

301  
tÙwr™‹n
 ?otwritten : -1;

304 
Ën
 -ğ
nwr™‹n
;

305 
buf
 +ğ
nwr™‹n
;

306 
tÙwr™‹n
 +ğ
nwr™‹n
;

309  
tÙwr™‹n
;

310 
	}
}

330 
	#AOF_WRITE_LOG_ERROR_RATE
 30

	)

331 
	$æushAµ’dOÆyFe
(
fÜû
) {

332 
ssize_t
 
nwr™‹n
;

333 
sync_š_´og»ss
 = 0;

334 
m¡ime_t
 
Ï‹ncy
;

336 ià(
	`sd¦’
(
£rv”
.
aof_buf
) == 0) ;

338 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
)

339 
sync_š_´og»ss
 = 
	`bioP’dšgJobsOfTy³
(
BIO_AOF_FSYNC
) != 0;

341 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
 && !
fÜû
) {

345 ià(
sync_š_´og»ss
) {

346 ià(
£rv”
.
aof_æush_po¡pÚed_¡¬t
 == 0) {

349 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = s”v”.
unixtime
;

351 } ià(
£rv”
.
unixtime
 - s”v”.
aof_æush_po¡pÚed_¡¬t
 < 2) {

358 
£rv”
.
aof_d–ayed_fsync
++;

359 
	`£rv”Log
(
LL_NOTICE
,"Asynchronous AOF fsync isakingoo†ong (disk is busy?). Writinghe AOF buffer without waiting for fsynco complete,his may slow down Redis.");

368 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

369 
nwr™‹n
 = 
	`aofWr™e
(
£rv”
.
aof_fd
,£rv”.
aof_buf
,
	`sd¦’
(server.aof_buf));

370 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

376 ià(
sync_š_´og»ss
) {

377 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-³ndšg-fsync",
Ï‹ncy
);

378 } ià(
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 != -1) {

379 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-aùive-chd",
Ï‹ncy
);

381 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-®Úe",
Ï‹ncy
);

383 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e",
Ï‹ncy
);

386 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = 0;

388 ià(
nwr™‹n
 !ğ(
ssize_t
)
	`sd¦’
(
£rv”
.
aof_buf
)) {

389 
time_t
 
Ï¡_wr™e_”rÜ_log
 = 0;

390 
ÿn_log
 = 0;

393 ià((
£rv”
.
unixtime
 - 
Ï¡_wr™e_”rÜ_log
è> 
AOF_WRITE_LOG_ERROR_RATE
) {

394 
ÿn_log
 = 1;

395 
Ï¡_wr™e_”rÜ_log
 = 
£rv”
.
unixtime
;

399 ià(
nwr™‹n
 == -1) {

400 ià(
ÿn_log
) {

401 
	`£rv”Log
(
LL_WARNING
,"Error writingohe AOF file: %s",

402 
	`¡»¼Ü
(
”ºo
));

403 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 
”ºo
;

406 ià(
ÿn_log
) {

407 
	`£rv”Log
(
LL_WARNING
,"Short write while writingo "

410 ()
nwr™‹n
,

411 ()
	`sd¦’
(
£rv”
.
aof_buf
));

414 ià(
	`árunÿ‹
(
£rv”
.
aof_fd
, s”v”.
aof_cu¼’t_size
) == -1) {

415 ià(
ÿn_log
) {

416 
	`£rv”Log
(
LL_WARNING
, "Could‚ot„emove short write "

419 "árunÿ‹: %s", 
	`¡»¼Ü
(
”ºo
));

424 
nwr™‹n
 = -1;

426 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 
ENOSPC
;

430 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

435 
	`£rv”Log
(
LL_WARNING
,"Can't„ecover from AOF writeƒrror whenhe AOF fsync…olicy is 'always'. Exiting...");

436 
	`ex™
(1);

441 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
C_ERR
;

445 ià(
nwr™‹n
 > 0) {

446 
£rv”
.
aof_cu¼’t_size
 +ğ
nwr™‹n
;

447 
	`sd¤ªge
(
£rv”
.
aof_buf
,
nwr™‹n
,-1);

454 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_ERR
) {

455 
	`£rv”Log
(
LL_WARNING
,

457 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
C_OK
;

460 
£rv”
.
aof_cu¼’t_size
 +ğ
nwr™‹n
;

464 ià((
	`sd¦’
(
£rv”
.
aof_buf
)+
	`sd§va
(server.aof_buf)) < 4000) {

465 
	`sdsş—r
(
£rv”
.
aof_buf
);

467 
	`sdsä“
(
£rv”
.
aof_buf
);

468 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

473 ià(
£rv”
.
aof_no_fsync_Ú_»wr™e
 &&

474 (
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 != -1))

478 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

481 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

482 
	`aof_fsync
(
£rv”
.
aof_fd
);

483 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

484 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-fsync-®ways",
Ï‹ncy
);

485 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

486 } ià((
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
 &&

487 
£rv”
.
unixtime
 > s”v”.
aof_Ï¡_fsync
)) {

488 ià(!
sync_š_´og»ss
è
	`aof_background_fsync
(
£rv”
.
aof_fd
);

489 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

491 
	}
}

493 
sds
 
	$ÿtAµ’dOÆyG’”icCommªd
(
sds
 
d¡
, 
¬gc
, 
robj
 **
¬gv
) {

494 
buf
[32];

495 
Ën
, 
j
;

496 
robj
 *
o
;

498 
buf
[0] = '*';

499 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
¬gc
);

500 
buf
[
Ën
++] = '\r';

501 
buf
[
Ën
++] = '\n';

502 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

504 
j
 = 0; j < 
¬gc
; j++) {

505 
o
 = 
	`g‘DecodedObjeù
(
¬gv
[
j
]);

506 
buf
[0] = '$';

507 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
	`sd¦’
(
o
->
±r
));

508 
buf
[
Ën
++] = '\r';

509 
buf
[
Ën
++] = '\n';

510 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

511 
d¡
 = 
	`sdsÿ’
(d¡,
o
->
±r
,
	`sd¦’
(o->ptr));

512 
d¡
 = 
	`sdsÿ’
(dst,"\r\n",2);

513 
	`deüRefCouÁ
(
o
);

515  
d¡
;

516 
	}
}

525 
sds
 
	$ÿtAµ’dOÆyExpœeAtCommªd
(
sds
 
buf
, 
»disCommªd
 *
cmd
, 
robj
 *
key
,„obj *
£cÚds
) {

526 
wh’
;

527 
robj
 *
¬gv
[3];

530 
£cÚds
 = 
	`g‘DecodedObjeù
(seconds);

531 
wh’
 = 
	`¡¹Şl
(
£cÚds
->
±r
,
NULL
,10);

533 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
£‹xCommªd
 ||

534 
cmd
->
´oc
 =ğ
expœ—tCommªd
)

536 
wh’
 *= 1000;

539 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

540 
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
)

542 
wh’
 +ğ
	`m¡ime
();

544 
	`deüRefCouÁ
(
£cÚds
);

546 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
("PEXPIREAT",9);

547 
¬gv
[1] = 
key
;

548 
¬gv
[2] = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
wh’
);

549 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf, 3, 
¬gv
);

550 
	`deüRefCouÁ
(
¬gv
[0]);

551 
	`deüRefCouÁ
(
¬gv
[2]);

552  
buf
;

553 
	}
}

555 
	$ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

556 
sds
 
buf
 = 
	`sd£m±y
();

557 
robj
 *
tm·rgv
[3];

561 ià(
diùid
 !ğ
£rv”
.
aof_£Ëùed_db
) {

562 
£ldb
[64];

564 
	`¢´štf
(
£ldb
,(£ldb),"%d",
diùid
);

565 
buf
 = 
	`sdsÿrštf
(buf,"*2\r\n$6\r\nSELECT\r\n$%lu\r\n%s\r\n",

566 ()
	`¡¾’
(
£ldb
),seldb);

567 
£rv”
.
aof_£Ëùed_db
 = 
diùid
;

570 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

571 
cmd
->
´oc
 =ğ
expœ—tCommªd
) {

573 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

574 } ià(
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
) {

576 
tm·rgv
[0] = 
	`ü—‹SŒšgObjeù
("SET",3);

577 
tm·rgv
[1] = 
¬gv
[1];

578 
tm·rgv
[2] = 
¬gv
[3];

579 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,3,
tm·rgv
);

580 
	`deüRefCouÁ
(
tm·rgv
[0]);

581 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

582 } ià(
cmd
->
´oc
 =ğ
£tCommªd
 && 
¬gc
 > 3) {

583 
i
;

584 
robj
 *
ex¬g
 = 
NULL
, *
px¬g
 = NULL;

586 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,3,
¬gv
);

587 
i
 = 3; i < 
¬gc
; i ++) {

588 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
, "ex")è
ex¬g
 =‡rgv[i+1];

589 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
, "px")è
px¬g
 =‡rgv[i+1];

591 
	`£rv”As£¹
(!(
ex¬g
 && 
px¬g
));

592 ià(
ex¬g
)

593 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
£rv”
.
expœeCommªd
,
¬gv
[1],

594 
ex¬g
);

595 ià(
px¬g
)

596 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
£rv”
.
³xpœeCommªd
,
¬gv
[1],

597 
px¬g
);

602 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,
¬gc
,
¬gv
);

608 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
)

609 
£rv”
.
aof_buf
 = 
	`sdsÿ’
(£rv”.aof_buf,
buf
,
	`sd¦’
(buf));

615 ià(
£rv”
.
aof_chd_pid
 != -1)

616 
	`aofRewr™eBufãrAµ’d
((*)
buf
,
	`sd¦’
(buf));

618 
	`sdsä“
(
buf
);

619 
	}
}

627 
ş›Á
 *
	$ü—‹FakeCl›Á
() {

628 
ş›Á
 *
c
 = 
	`zm®loc
((*c));

630 
	`£ËùDb
(
c
,0);

631 
c
->
fd
 = -1;

632 
c
->
Çme
 = 
NULL
;

633 
c
->
qu”ybuf
 = 
	`sd£m±y
();

634 
c
->
qu”ybuf_³ak
 = 0;

635 
c
->
¬gc
 = 0;

636 
c
->
¬gv
 = 
NULL
;

637 
c
->
buåos
 = 0;

638 
c
->
æags
 = 0;

639 
c
->
bty³
 = 
BLOCKED_NONE
;

642 
c
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_START
;

643 
c
->
»¶y
 = 
	`li¡C»©e
();

644 
c
->
»¶y_by‹s
 = 0;

645 
c
->
obuf_soá_lim™_»ached_time
 = 0;

646 
c
->
w©ched_keys
 = 
	`li¡C»©e
();

647 
c
->
³”id
 = 
NULL
;

648 
	`li¡S‘F»eM‘hod
(
c
->
»¶y
,
deüRefCouÁVoid
);

649 
	`li¡S‘DupM‘hod
(
c
->
»¶y
,
dupCl›ÁR•lyV®ue
);

650 
	`š™Cl›ÁMuÉiS‹
(
c
);

651  
c
;

652 
	}
}

654 
	$ä“FakeCl›ÁArgv
(
ş›Á
 *
c
) {

655 
j
;

657 
j
 = 0; j < 
c
->
¬gc
; j++)

658 
	`deüRefCouÁ
(
c
->
¬gv
[
j
]);

659 
	`zä“
(
c
->
¬gv
);

660 
	}
}

662 
	$ä“FakeCl›Á
(
ş›Á
 *
c
) {

663 
	`sdsä“
(
c
->
qu”ybuf
);

664 
	`li¡R–—£
(
c
->
»¶y
);

665 
	`li¡R–—£
(
c
->
w©ched_keys
);

666 
	`ä“Cl›ÁMuÉiS‹
(
c
);

667 
	`zä“
(
c
);

668 
	}
}

673 
	$lßdAµ’dOÆyFe
(*
f’ame
) {

674 
ş›Á
 *
çkeCl›Á
;

675 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r");

676 
»dis_¡©
 
sb
;

677 
Şd_aof_¡©e
 = 
£rv”
.
aof_¡©e
;

678 
loİs
 = 0;

679 
off_t
 
v®id_up_to
 = 0;

681 ià(
å
 =ğ
NULL
) {

682 
	`£rv”Log
(
LL_WARNING
,"F©®ƒ¼Ü: cª'ˆİ’h­³nd†og ffÜ„—dšg: %s",
	`¡»¼Ü
(
”ºo
));

683 
	`ex™
(1);

690 ià(
å
 && 
	`»dis_f¡©
(
	`f’o
(å),&
sb
è!ğ-1 && sb.
¡_size
 == 0) {

691 
£rv”
.
aof_cu¼’t_size
 = 0;

692 
	`fşo£
(
å
);

693  
C_ERR
;

698 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

700 
çkeCl›Á
 = 
	`ü—‹FakeCl›Á
();

701 
	`¡¬tLßdšg
(
å
);

705 
sig
[5];

706 ià(
	`ä—d
(
sig
,1,5,
å
è!ğ5 || 
	`memcmp
(sig,"REDIS",5) != 0) {

708 ià(
	`f£ek
(
å
,0,
SEEK_SET
è=ğ-1è
»ad”r
;

711 
rio
 
rdb
;

713 
	`£rv”Log
(
LL_NOTICE
,"Reading RDB…reamble from AOF file...");

714 ià(
	`f£ek
(
å
,0,
SEEK_SET
è=ğ-1è
»ad”r
;

715 
	`rioIn™W™hFe
(&
rdb
,
å
);

716 ià(
	`rdbLßdRio
(&
rdb
,
NULL
,1è!ğ
C_OK
) {

717 
	`£rv”Log
(
LL_WARNING
,"Error„eadinghe RDB…reamble ofhe AOF file, AOF†oading‡borted");

718 
»ad”r
;

720 
	`£rv”Log
(
LL_NOTICE
,"Readinghe„emaining AOFail...");

726 
¬gc
, 
j
;

727 
Ën
;

728 
robj
 **
¬gv
;

729 
buf
[128];

730 
sds
 
¬gsds
;

731 
»disCommªd
 *
cmd
;

734 ià(!(
loİs
++ % 1000)) {

735 
	`lßdšgProg»ss
(
	`á–lo
(
å
));

736 
	`´oûssEv’tsWheBlocked
();

739 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

740 ià(
	`ãof
(
å
))

743 
»ad”r
;

745 ià(
buf
[0] !ğ'*'è
fm‹¼
;

746 ià(
buf
[1] =ğ'\0'è
»ad”r
;

747 
¬gc
 = 
	`©oi
(
buf
+1);

748 ià(
¬gc
 < 1è
fm‹¼
;

750 
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

751 
çkeCl›Á
->
¬gc
 =‡rgc;

752 
çkeCl›Á
->
¬gv
 =‡rgv;

754 
j
 = 0; j < 
¬gc
; j++) {

755 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

756 
çkeCl›Á
->
¬gc
 = 
j
;

757 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

758 
»ad”r
;

760 ià(
buf
[0] !ğ'$'è
fm‹¼
;

761 
Ën
 = 
	`¡¹Ş
(
buf
+1,
NULL
,10);

762 
¬gsds
 = 
	`sd¢ewËn
(
NULL
,
Ën
);

763 ià(
Ën
 && 
	`ä—d
(
¬gsds
,Ën,1,
å
) == 0) {

764 
	`sdsä“
(
¬gsds
);

765 
çkeCl›Á
->
¬gc
 = 
j
;

766 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

767 
»ad”r
;

769 
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,
¬gsds
);

770 ià(
	`ä—d
(
buf
,2,1,
å
) == 0) {

771 
çkeCl›Á
->
¬gc
 = 
j
+1;

772 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

773 
»ad”r
;

778 
cmd
 = 
	`lookupCommªd
(
¬gv
[0]->
±r
);

779 ià(!
cmd
) {

780 
	`£rv”Log
(
LL_WARNING
,"UnknowÀcommªd '%s'„—dšgh­³nd oÆy fe", (*)
¬gv
[0]->
±r
);

781 
	`ex™
(1);

785 
çkeCl›Á
->
cmd
 = cmd;

786 
cmd
->
	`´oc
(
çkeCl›Á
);

789 
	`£rv”As£¹
(
çkeCl›Á
->
buåos
 =ğ0 && 
	`li¡L’gth
(çkeCl›Á->
»¶y
) == 0);

791 
	`£rv”As£¹
((
çkeCl›Á
->
æags
 & 
CLIENT_BLOCKED
) == 0);

795 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

796 
çkeCl›Á
->
cmd
 = 
NULL
;

797 ià(
£rv”
.
aof_lßd_Œunÿ‹d
è
v®id_up_to
 = 
	`á–lo
(
å
);

802 ià(
çkeCl›Á
->
æags
 & 
CLIENT_MULTI
è
uxeof
;

804 
lßded_ok
:

805 
	`fşo£
(
å
);

806 
	`ä“FakeCl›Á
(
çkeCl›Á
);

807 
£rv”
.
aof_¡©e
 = 
Şd_aof_¡©e
;

808 
	`¡İLßdšg
();

809 
	`aofUpd©eCu¼’tSize
();

810 
£rv”
.
aof_»wr™e_ba£_size
 = s”v”.
aof_cu¼’t_size
;

811  
C_OK
;

813 
»ad”r
:

814 ià(!
	`ãof
(
å
)) {

815 ià(
çkeCl›Á
è
	`ä“FakeCl›Á
(fakeClient);

816 
	`£rv”Log
(
LL_WARNING
,"UÄecov”abËƒ¼Ü„—dšgh­³nd oÆy fe: %s", 
	`¡»¼Ü
(
”ºo
));

817 
	`ex™
(1);

820 
uxeof
:

821 ià(
£rv”
.
aof_lßd_Œunÿ‹d
) {

822 
	`£rv”Log
(
LL_WARNING
,"!!! Warning: short„ead while†oadinghe AOF file !!!");

823 
	`£rv”Log
(
LL_WARNING
,"!!! Truncatinghe AOF‡t offset %llu !!!",

824 (è
v®id_up_to
);

825 ià(
v®id_up_to
 =ğ-1 || 
	`Œunÿ‹
(
f’ame
,valid_up_to) == -1) {

826 ià(
v®id_up_to
 == -1) {

827 
	`£rv”Log
(
LL_WARNING
,"Last valid command offset is invalid");

829 
	`£rv”Log
(
LL_WARNING
,"Errorruncatinghe AOF file: %s",

830 
	`¡»¼Ü
(
”ºo
));

835 ià(
£rv”
.
aof_fd
 !ğ-1 && 
	`l£ek
(£rv”.aof_fd,0,
SEEK_END
) == -1) {

836 
	`£rv”Log
(
LL_WARNING
,"Can't seekheƒnd ofhe AOF file: %s",

837 
	`¡»¼Ü
(
”ºo
));

839 
	`£rv”Log
(
LL_WARNING
,

841 
lßded_ok
;

845 ià(
çkeCl›Á
è
	`ä“FakeCl›Á
(fakeClient);

846 
	`£rv”Log
(
LL_WARNING
,"Unexpectedƒnd of file„eadinghe‡ppend only file. You can: 1) Make‡ backup of your AOF file,hen use ./redis-check-aof --fix <filename>. 2) Alternatively you can sethe 'aof-load-truncated' configuration optiono yes‡nd„estarthe server.");

847 
	`ex™
(1);

849 
fm‹¼
:

850 ià(
çkeCl›Á
è
	`ä“FakeCl›Á
(fakeClient);

851 
	`£rv”Log
(
LL_WARNING
,"Bad file format„eadinghe‡ppend only file: make‡ backup of your AOF file,hen use ./redis-check-aof --fix <filename>");

852 
	`ex™
(1);

853 
	}
}

861 
	$rioWr™eBulkObjeù
(
rio
 *
r
, 
robj
 *
obj
) {

864 ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

865  
	`rioWr™eBulkLÚgLÚg
(
r
,()
obj
->
±r
);

866 } ià(
	`sdsEncodedObjeù
(
obj
)) {

867  
	`rioWr™eBulkSŒšg
(
r
,
obj
->
±r
,
	`sd¦’
(obj->ptr));

869 
	`£rv”Pªic
("Unknown stringƒncoding");

871 
	}
}

875 
	$»wr™eLi¡Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

876 
couÁ
 = 0, 
™ems
 = 
	`li¡Ty³L’gth
(
o
);

878 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

879 
quickli¡
 *
li¡
 = 
o
->
±r
;

880 
quickli¡I‹r
 *
li
 = 
	`quickli¡G‘I‹¿tÜ
(
li¡
, 
AL_START_HEAD
);

881 
quickli¡EÁry
 
’Œy
;

883 
	`quickli¡Next
(
li
,&
’Œy
)) {

884 ià(
couÁ
 == 0) {

885 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

886 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

887 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

888 ià(
	`rioWr™eBulkSŒšg
(
r
,"RPUSH",5) == 0)  0;

889 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

892 ià(
’Œy
.
v®ue
) {

893 ià(
	`rioWr™eBulkSŒšg
(
r
,(*)
’Œy
.
v®ue
,’Œy.
sz
) == 0)  0;

895 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
’Œy
.
lÚgv®
) == 0)  0;

897 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

898 
™ems
--;

900 
	`quickli¡R–—£I‹¿tÜ
(
li
);

902 
	`£rv”Pªic
("Unknown†istƒncoding");

905 
	}
}

909 
	$»wr™eS‘Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

910 
couÁ
 = 0, 
™ems
 = 
	`£tTy³Size
(
o
);

912 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

913 
ii
 = 0;

914 
št64_t
 
Îv®
;

916 
	`št£tG‘
(
o
->
±r
,
ii
++,&
Îv®
)) {

917 ià(
couÁ
 == 0) {

918 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

919 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

921 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

922 ià(
	`rioWr™eBulkSŒšg
(
r
,"SADD",4) == 0)  0;

923 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

925 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
Îv®
) == 0)  0;

926 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

927 
™ems
--;

929 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

930 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
o
->
±r
);

931 
diùEÁry
 *
de
;

933 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

934 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

935 ià(
couÁ
 == 0) {

936 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

937 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

939 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

940 ià(
	`rioWr™eBulkSŒšg
(
r
,"SADD",4) == 0)  0;

941 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

943 ià(
	`rioWr™eBulkSŒšg
(
r
,
–e
,
	`sd¦’
(ele)) == 0)  0;

944 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

945 
™ems
--;

947 
	`diùR–—£I‹¿tÜ
(
di
);

949 
	`£rv”Pªic
("Unknown setƒncoding");

952 
	}
}

956 
	$»wr™eSÜ‹dS‘Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

957 
couÁ
 = 0, 
™ems
 = 
	`z£tL’gth
(
o
);

959 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

960 *
zl
 = 
o
->
±r
;

961 *
•Œ
, *
¥Œ
;

962 *
v¡r
;

963 
vËn
;

964 
vÎ
;

965 
scÜe
;

967 
•Œ
 = 
	`zli¡Index
(
zl
,0);

968 
	`£rv”As£¹
(
•Œ
 !ğ
NULL
);

969 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

970 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

972 
•Œ
 !ğ
NULL
) {

973 
	`£rv”As£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vÎ
));

974 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

976 ià(
couÁ
 == 0) {

977 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

978 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

980 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

981 ià(
	`rioWr™eBulkSŒšg
(
r
,"ZADD",4) == 0)  0;

982 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

984 ià(
	`rioWr™eBulkDoubË
(
r
,
scÜe
) == 0)  0;

985 ià(
v¡r
 !ğ
NULL
) {

986 ià(
	`rioWr™eBulkSŒšg
(
r
,(*)
v¡r
,
vËn
) == 0)  0;

988 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
vÎ
) == 0)  0;

990 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

991 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

992 
™ems
--;

994 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

995 
z£t
 *
zs
 = 
o
->
±r
;

996 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
zs
->
diù
);

997 
diùEÁry
 *
de
;

999 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1000 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

1001 *
scÜe
 = 
	`diùG‘V®
(
de
);

1003 ià(
couÁ
 == 0) {

1004 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

1005 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

1007 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

1008 ià(
	`rioWr™eBulkSŒšg
(
r
,"ZADD",4) == 0)  0;

1009 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

1011 ià(
	`rioWr™eBulkDoubË
(
r
,*
scÜe
) == 0)  0;

1012 ià(
	`rioWr™eBulkSŒšg
(
r
,
–e
,
	`sd¦’
(ele)) == 0)  0;

1013 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

1014 
™ems
--;

1016 
	`diùR–—£I‹¿tÜ
(
di
);

1018 
	`£rv”Pªic
("Unknown sorted zsetƒncoding");

1021 
	}
}

1029 
	$rioWr™eHashI‹¿tÜCursÜ
(
rio
 *
r
, 
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

1030 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1031 *
v¡r
 = 
NULL
;

1032 
vËn
 = 
UINT_MAX
;

1033 
vÎ
 = 
LLONG_MAX
;

1035 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

1036 ià(
v¡r
)

1037  
	`rioWr™eBulkSŒšg
(
r
, (*)
v¡r
, 
vËn
);

1039  
	`rioWr™eBulkLÚgLÚg
(
r
, 
vÎ
);

1040 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1041 
sds
 
v®ue
 = 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
);

1042  
	`rioWr™eBulkSŒšg
(
r
, 
v®ue
, 
	`sd¦’
(value));

1045 
	`£rv”Pªic
("Unknown hashƒncoding");

1047 
	}
}

1051 
	$»wr™eHashObjeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

1052 
hashTy³I‹¿tÜ
 *
hi
;

1053 
couÁ
 = 0, 
™ems
 = 
	`hashTy³L’gth
(
o
);

1055 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

1056 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

1057 ià(
couÁ
 == 0) {

1058 
cmd_™ems
 = (
™ems
 > 
AOF_REWRITE_ITEMS_PER_CMD
) ?

1059 
AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

1061 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

1062 ià(
	`rioWr™eBulkSŒšg
(
r
,"HMSET",5) == 0)  0;

1063 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

1066 ià(
	`rioWr™eHashI‹¿tÜCursÜ
(
r
, 
hi
, 
OBJ_HASH_KEY
) == 0)  0;

1067 ià(
	`rioWr™eHashI‹¿tÜCursÜ
(
r
, 
hi
, 
OBJ_HASH_VALUE
) == 0)  0;

1068 ià(++
couÁ
 =ğ
AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

1069 
™ems
--;

1072 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

1075 
	}
}

1080 
	$»wr™eModuËObjeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

1081 
RedisModuËIO
 
io
;

1082 
moduËV®ue
 *
mv
 = 
o
->
±r
;

1083 
moduËTy³
 *
mt
 = 
mv
->
ty³
;

1084 
	`moduËIn™IOCÚ‹xt
(
io
,
mt
,
r
);

1085 
mt
->
	`aof_»wr™e
(&
io
,
key
,
mv
->
v®ue
);

1086 ià(
io
.
ùx
) {

1087 
	`moduËF»eCÚ‹xt
(
io
.
ùx
);

1088 
	`zä“
(
io
.
ùx
);

1090  
io
.
”rÜ
 ? 0 : 1;

1091 
	}
}

1096 
ssize_t
 
	$aofR—dDiffFromP¬’t
() {

1097 
buf
[65536];

1098 
ssize_t
 
Ä—d
, 
tÙ®
 = 0;

1100 (
Ä—d
 =

1101 
	`»ad
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
,
buf
,(buf))) > 0) {

1102 
£rv”
.
aof_chd_diff
 = 
	`sdsÿ’
(£rv”.aof_chd_diff,
buf
,
Ä—d
);

1103 
tÙ®
 +ğ
Ä—d
;

1105  
tÙ®
;

1106 
	}
}

1108 
	$»wr™eAµ’dOÆyFeRio
(
rio
 *
aof
) {

1109 
diùI‹¿tÜ
 *
di
 = 
NULL
;

1110 
diùEÁry
 *
de
;

1111 
size_t
 
´oûs£d
 = 0;

1112 
now
 = 
	`m¡ime
();

1113 
j
;

1115 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

1116 
£Ëùcmd
[] = "*2\r\n$6\r\nSELECT\r\n";

1117 
»disDb
 *
db
 = 
£rv”
.db+
j
;

1118 
diù
 *
d
 = 
db
->dict;

1119 ià(
	`diùSize
(
d
) == 0) ;

1120 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
d
);

1123 ià(
	`rioWr™e
(
aof
,
£Ëùcmd
,(£Ëùcmd)-1è=ğ0è
w”r
;

1124 ià(
	`rioWr™eBulkLÚgLÚg
(
aof
,
j
è=ğ0è
w”r
;

1127 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1128 
sds
 
key¡r
;

1129 
robj
 
key
, *
o
;

1130 
expœ‘ime
;

1132 
key¡r
 = 
	`diùG‘Key
(
de
);

1133 
o
 = 
	`diùG‘V®
(
de
);

1134 
	`š™SticSŒšgObjeù
(
key
,
key¡r
);

1136 
expœ‘ime
 = 
	`g‘Expœe
(
db
,&
key
);

1139 ià(
expœ‘ime
 !ğ-1 &&ƒxpœ‘im< 
now
) ;

1142 ià(
o
->
ty³
 =ğ
OBJ_STRING
) {

1144 
cmd
[]="*3\r\n$3\r\nSET\r\n";

1145 ià(
	`rioWr™e
(
aof
,
cmd
,(cmd)-1è=ğ0è
w”r
;

1147 ià(
	`rioWr™eBulkObjeù
(
aof
,&
key
è=ğ0è
w”r
;

1148 ià(
	`rioWr™eBulkObjeù
(
aof
,
o
è=ğ0è
w”r
;

1149 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

1150 ià(
	`»wr™eLi¡Objeù
(
aof
,&
key
,
o
è=ğ0è
w”r
;

1151 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

1152 ià(
	`»wr™eS‘Objeù
(
aof
,&
key
,
o
è=ğ0è
w”r
;

1153 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

1154 ià(
	`»wr™eSÜ‹dS‘Objeù
(
aof
,&
key
,
o
è=ğ0è
w”r
;

1155 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

1156 ià(
	`»wr™eHashObjeù
(
aof
,&
key
,
o
è=ğ0è
w”r
;

1157 } ià(
o
->
ty³
 =ğ
OBJ_MODULE
) {

1158 ià(
	`»wr™eModuËObjeù
(
aof
,&
key
,
o
è=ğ0è
w”r
;

1160 
	`£rv”Pªic
("Unknown objectype");

1163 ià(
expœ‘ime
 != -1) {

1164 
cmd
[]="*3\r\n$9\r\nPEXPIREAT\r\n";

1165 ià(
	`rioWr™e
(
aof
,
cmd
,(cmd)-1è=ğ0è
w”r
;

1166 ià(
	`rioWr™eBulkObjeù
(
aof
,&
key
è=ğ0è
w”r
;

1167 ià(
	`rioWr™eBulkLÚgLÚg
(
aof
,
expœ‘ime
è=ğ0è
w”r
;

1170 ià(
aof
->
´oûs£d_by‹s
 > 
´oûs£d
+
AOF_READ_DIFF_INTERVAL_BYTES
) {

1171 
´oûs£d
 = 
aof
->
´oûs£d_by‹s
;

1172 
	`aofR—dDiffFromP¬’t
();

1175 
	`diùR–—£I‹¿tÜ
(
di
);

1176 
di
 = 
NULL
;

1178  
C_OK
;

1180 
w”r
:

1181 ià(
di
è
	`diùR–—£I‹¿tÜ
(di);

1182  
C_ERR
;

1183 
	}
}

1192 
	$»wr™eAµ’dOÆyFe
(*
f’ame
) {

1193 
rio
 
aof
;

1194 
FILE
 *
å
;

1195 
tmpfe
[256];

1196 
by‹
;

1200 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-%d.aof", (è
	`g‘pid
());

1201 
å
 = 
	`fİ’
(
tmpfe
,"w+");

1202 ià(!
å
) {

1203 
	`£rv”Log
(
LL_WARNING
, "O³nšgh‹m°ffÜ AOF„ewr™š„ewr™eAµ’dOÆyFe(): %s", 
	`¡»¼Ü
(
”ºo
));

1204  
C_ERR
;

1207 
	`´štf
("%s: o³Ãd fw™h fd = %d\n", 
__func__
, 
	`f’o
(
å
));

1208 
£rv”
.
aof_chd_diff
 = 
	`sd£m±y
();

1209 
	`rioIn™W™hFe
(&
aof
,
å
);

1211 ià(
£rv”
.
aof_»wr™e_šüem’l_fsync
)

1212 
	`rioS‘AutoSync
(&
aof
,
AOF_AUTOSYNC_BYTES
);

1214 ià(
£rv”
.
aof_u£_rdb_´—mbË
) {

1215 
”rÜ
;

1216 ià(
	`rdbSaveRio
(&
aof
,&
”rÜ
,
RDB_SAVE_AOF_PREAMBLE
,
NULL
è=ğ
C_ERR
) {

1217 
”ºo
 = 
”rÜ
;

1218 
w”r
;

1221 ià(
	`»wr™eAµ’dOÆyFeRio
(&
aof
è=ğ
C_ERR
è
w”r
;

1226 
	`´štf
("%s: došg fæush‡nd fsynøÚ fd = %d\n", 
__func__
, 
	`f’o
(
å
));

1227 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

1228 ià(
	`fsync
(
	`f’o
(
å
)è=ğ-1è
w”r
;

1229 
	`´štf
("%s: did fsynøÚ fd = %d\n", 
__func__
, 
	`f’o
(
å
));

1237 
nod©a
 = 0;

1238 
m¡ime_t
 
¡¬t
 = 
	`m¡ime
();

1239 
	`m¡ime
()-
¡¬t
 < 1000 && 
nod©a
 < 20) {

1240 ià(
	`«Wa™
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
, 
AE_READABLE
, 1) <= 0)

1242 
nod©a
++;

1245 
nod©a
 = 0;

1247 
	`aofR—dDiffFromP¬’t
();

1251 
	`´štf
("%s:‡skšg ma¡”Ø¡İ s’dšg diffs. fd = %d\n", 
__func__
, 
£rv”
.
aof_pe_wr™e_ack_to_·»Á
);

1252 ià(
	`wr™e
(
£rv”
.
aof_pe_wr™e_ack_to_·»Á
,"!",1è!ğ1è
w”r
;

1253 
	`´štf
("%s:‡sked ma¡” sucûssfuÎy\n", 
__func__
);

1254 ià(
	`ª‘NÚBlock
(
NULL
,
£rv”
.
aof_pe_»ad_ack_äom_·»Á
è!ğ
ANET_OK
)

1255 
w”r
;

1259 ià(
	`syncR—d
(
£rv”
.
aof_pe_»ad_ack_äom_·»Á
,&
by‹
,1,5000) != 1 ||

1260 
by‹
 !ğ'!'è
w”r
;

1261 
	`£rv”Log
(
LL_NOTICE
,"Parent‡greedo stop sending diffs. Finalizing AOF...");

1264 
	`aofR—dDiffFromP¬’t
();

1267 
	`£rv”Log
(
LL_NOTICE
,

1269 (è
	`sd¦’
(
£rv”
.
aof_chd_diff
) / (1024*1024));

1270 ià(
	`rioWr™e
(&
aof
,
£rv”
.
aof_chd_diff
,
	`sd¦’
(server.aof_child_diff)) == 0)

1271 
w”r
;

1274 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

1275 ià(
	`fsync
(
	`f’o
(
å
)è=ğ-1è
w”r
;

1276 ià(
	`fşo£
(
å
è=ğ
EOF
è
w”r
;

1280 ià(
	`»Çme
(
tmpfe
,
f’ame
) == -1) {

1281 
	`£rv”Log
(
LL_WARNING
,"E¼Ü movšgem°­³nd oÆy fÚhfš® de¡š©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

1282 
	`uÆšk
(
tmpfe
);

1283  
C_ERR
;

1285 
	`£rv”Log
(
LL_NOTICE
,"SYNC‡ppend only file„ewrite…erformed");

1286  
C_OK
;

1288 
w”r
:

1289 
	`£rv”Log
(
LL_WARNING
,"Wr™”rÜ wr™šg‡µ’d oÆy fÚ disk: %s", 
	`¡»¼Ü
(
”ºo
));

1290 
	`fşo£
(
å
);

1291 
	`uÆšk
(
tmpfe
);

1292  
C_ERR
;

1293 
	}
}

1302 
	$aofChdPeR—dabË
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1303 
by‹
;

1304 
	`UNUSED
(
–
);

1305 
	`UNUSED
(
´ivd©a
);

1306 
	`UNUSED
(
mask
);

1308 ià(
	`»ad
(
fd
,&
by‹
,1) == 1 && byte == '!') {

1309 
	`£rv”Log
(
LL_NOTICE
,"AOF„ewrite child‡skso stop sending diffs.");

1310 
£rv”
.
aof_¡İ_£ndšg_diff
 = 1;

1311 ià(
	`wr™e
(
£rv”
.
aof_pe_wr™e_ack_to_chd
,"!",1) != 1) {

1316 
	`£rv”Log
(
LL_WARNING
,"Can't send ACKo AOF child: %s",

1317 
	`¡»¼Ü
(
”ºo
));

1322 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_»ad_ack_äom_chd
,
AE_READABLE
);

1323 
	}
}

1330 
	$aofC»©ePes
() {

1331 
fds
[6] = {-1, -1, -1, -1, -1, -1};

1332 
j
;

1334 ià(
	`pe
(
fds
è=ğ-1è
”rÜ
;

1335 ià(
	`pe
(
fds
+2è=ğ-1è
”rÜ
;

1336 ià(
	`pe
(
fds
+4è=ğ-1è
”rÜ
;

1338 ià(
	`ª‘NÚBlock
(
NULL
,
fds
[0]è!ğ
ANET_OK
è
”rÜ
;

1339 ià(
	`ª‘NÚBlock
(
NULL
,
fds
[1]è!ğ
ANET_OK
è
”rÜ
;

1340 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
fds
[2], 
AE_READABLE
, 
aofChdPeR—dabË
, 
NULL
è=ğ
AE_ERR
è
”rÜ
;

1342 
£rv”
.
aof_pe_wr™e_d©a_to_chd
 = 
fds
[1];

1343 
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
 = 
fds
[0];

1344 
£rv”
.
aof_pe_wr™e_ack_to_·»Á
 = 
fds
[3];

1345 
£rv”
.
aof_pe_»ad_ack_äom_chd
 = 
fds
[2];

1346 
£rv”
.
aof_pe_wr™e_ack_to_chd
 = 
fds
[5];

1347 
£rv”
.
aof_pe_»ad_ack_äom_·»Á
 = 
fds
[4];

1348 
£rv”
.
aof_¡İ_£ndšg_diff
 = 0;

1349  
C_OK
;

1351 
”rÜ
:

1352 
	`£rv”Log
(
LL_WARNING
,"Error opening /setting AOF„ewrite IPC…ipes: %s",

1353 
	`¡»¼Ü
(
”ºo
));

1354 
j
 = 0; j < 6; j++èif(
fds
[j] !ğ-1è
	`şo£
(fds[j]);

1355  
C_ERR
;

1356 
	}
}

1358 
	$aofClo£Pes
() {

1359 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_»ad_ack_äom_chd
,
AE_READABLE
);

1360 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
,
AE_WRITABLE
);

1361 
	`şo£
(
£rv”
.
aof_pe_wr™e_d©a_to_chd
);

1362 
	`şo£
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
);

1363 
	`şo£
(
£rv”
.
aof_pe_wr™e_ack_to_·»Á
);

1364 
	`şo£
(
£rv”
.
aof_pe_»ad_ack_äom_chd
);

1365 
	`şo£
(
£rv”
.
aof_pe_wr™e_ack_to_chd
);

1366 
	`şo£
(
£rv”
.
aof_pe_»ad_ack_äom_·»Á
);

1367 
	}
}

1385 
	$»wr™eAµ’dOÆyFeBackground
() {

1386 
pid_t
 
chdpid
;

1387 
¡¬t
;

1389 ià(
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 !ğ-1è 
C_ERR
;

1390 ià(
	`aofC»©ePes
(è!ğ
C_OK
è 
C_ERR
;

1391 
	`İ’ChdInfoPe
();

1392 
¡¬t
 = 
	`u¡ime
();

1393 ià((
chdpid
 = 
	`fÜk
()) == 0) {

1394 
tmpfe
[256];

1397 
	`şo£Li¡’šgSock‘s
(0);

1398 
	`»disS‘ProcT™Ë
("redis-aof-rewrite");

1399 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-bg-%d.aof", (è
	`g‘pid
());

1400 ià(
	`»wr™eAµ’dOÆyFe
(
tmpfe
è=ğ
C_OK
) {

1401 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
(-1);

1403 ià(
´iv©e_dœty
) {

1404 
	`£rv”Log
(
LL_NOTICE
,

1406 
´iv©e_dœty
/(1024*1024));

1409 
£rv”
.
chd_šfo_d©a
.
cow_size
 = 
´iv©e_dœty
;

1410 
	`£ndChdInfo
(
CHILD_INFO_TYPE_AOF
);

1411 
	`ex™FromChd
(0);

1413 
	`ex™FromChd
(1);

1417 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

1418 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

1419 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

1420 ià(
chdpid
 == -1) {

1421 
	`şo£ChdInfoPe
();

1422 
	`£rv”Log
(
LL_WARNING
,

1424 
	`¡»¼Ü
(
”ºo
));

1425 
	`aofClo£Pes
();

1426  
C_ERR
;

1428 
	`£rv”Log
(
LL_NOTICE
,

1429 "Background‡µ’d oÆy f»wr™šg s¹ed by…id %d",
chdpid
);

1430 
£rv”
.
aof_»wr™e_scheduËd
 = 0;

1431 
£rv”
.
aof_»wr™e_time_¡¬t
 = 
	`time
(
NULL
);

1432 
£rv”
.
aof_chd_pid
 = 
chdpid
;

1433 
	`upd©eDiùResizePŞicy
();

1438 
£rv”
.
aof_£Ëùed_db
 = -1;

1439 
	`»¶iÿtiÚSütCacheFlush
();

1440  
C_OK
;

1442  
C_OK
;

1443 
	}
}

1445 
	$bg»wr™—ofCommªd
(
ş›Á
 *
c
) {

1446 ià(
£rv”
.
aof_chd_pid
 != -1) {

1447 
	`addR•lyE¼Ü
(
c
,"Background‡ppend only file„ewriting‡lready in…rogress");

1448 } ià(
£rv”
.
rdb_chd_pid
 != -1) {

1449 
£rv”
.
aof_»wr™e_scheduËd
 = 1;

1450 
	`addR•lyStus
(
c
,"Background‡ppend only file„ewriting scheduled");

1451 } ià(
	`»wr™eAµ’dOÆyFeBackground
(è=ğ
C_OK
) {

1452 
	`addR•lyStus
(
c
,"Background‡ppend only file„ewriting started");

1454 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

1456 
	}
}

1458 
	$aofRemoveTempFe
(
pid_t
 
chdpid
) {

1459 
tmpfe
[256];

1461 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-bg-%d.aof", (è
chdpid
);

1462 
	`uÆšk
(
tmpfe
);

1463 
	}
}

1469 
	$aofUpd©eCu¼’tSize
() {

1470 
»dis_¡©
 
sb
;

1471 
m¡ime_t
 
Ï‹ncy
;

1473 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1474 ià(
	`»dis_f¡©
(
£rv”
.
aof_fd
,&
sb
) == -1) {

1475 
	`£rv”Log
(
LL_WARNING
,"Unableo obtainhe AOF file†ength. stat: %s",

1476 
	`¡»¼Ü
(
”ºo
));

1478 
£rv”
.
aof_cu¼’t_size
 = 
sb
.
¡_size
;

1480 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1481 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-f¡©",
Ï‹ncy
);

1482 
	}
}

1486 
	$backgroundRewr™eDÚeHªdËr
(
ex™code
, 
bysigÇl
) {

1487 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1488 
Ãwfd
, 
Şdfd
;

1489 
tmpfe
[256];

1490 
now
 = 
	`u¡ime
();

1491 
m¡ime_t
 
Ï‹ncy
;

1493 
	`£rv”Log
(
LL_NOTICE
,

1498 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1499 
	`¢´štf
(
tmpfe
,256,"temp-rewriteaof-bg-%d.aof",

1500 ()
£rv”
.
aof_chd_pid
);

1501 
Ãwfd
 = 
	`İ’
(
tmpfe
,
O_WRONLY
|
O_APPEND
);

1502 ià(
Ãwfd
 == -1) {

1503 
	`£rv”Log
(
LL_WARNING
,

1504 "UÇbËØİ’h‹mpÜ¬y AOF…roduûd byhchd: %s", 
	`¡»¼Ü
(
”ºo
));

1505 
ş—nup
;

1508 ià(
	`aofRewr™eBufãrWr™e
(
Ãwfd
) == -1) {

1509 
	`£rv”Log
(
LL_WARNING
,

1510 "E¼ÜryšgØæushh·»Á difàtØth»wr™‹ÀAOF: %s", 
	`¡»¼Ü
(
”ºo
));

1511 
	`şo£
(
Ãwfd
);

1512 
ş—nup
;

1514 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1515 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-»wr™e-diff-wr™e",
Ï‹ncy
);

1517 
	`£rv”Log
(
LL_NOTICE
,

1518 "Residu®…¬’ˆdifàsucûssfuÎy flushedØth»wr™‹ÀAOF (%.2àMB)", (è
	`aofRewr™eBufãrSize
() / (1024*1024));

1547 ià(
£rv”
.
aof_fd
 == -1) {

1553 
Şdfd
 = 
	`İ’
(
£rv”
.
aof_f’ame
,
O_RDONLY
|
O_NONBLOCK
);

1556 
Şdfd
 = -1;

1561 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1562 ià(
	`»Çme
(
tmpfe
,
£rv”
.
aof_f’ame
) == -1) {

1563 
	`£rv”Log
(
LL_WARNING
,

1565 
tmpfe
,

1566 
£rv”
.
aof_f’ame
,

1567 
	`¡»¼Ü
(
”ºo
));

1568 
	`şo£
(
Ãwfd
);

1569 ià(
Şdfd
 !ğ-1è
	`şo£
(oldfd);

1570 
ş—nup
;

1572 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1573 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-»Çme",
Ï‹ncy
);

1575 ià(
£rv”
.
aof_fd
 == -1) {

1578 
	`şo£
(
Ãwfd
);

1581 
Şdfd
 = 
£rv”
.
aof_fd
;

1582 
£rv”
.
aof_fd
 = 
Ãwfd
;

1583 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
)

1584 
	`aof_fsync
(
Ãwfd
);

1585 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
)

1586 
	`aof_background_fsync
(
Ãwfd
);

1587 
£rv”
.
aof_£Ëùed_db
 = -1;

1588 
	`aofUpd©eCu¼’tSize
();

1589 
£rv”
.
aof_»wr™e_ba£_size
 = s”v”.
aof_cu¼’t_size
;

1593 
	`sdsä“
(
£rv”
.
aof_buf
);

1594 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

1597 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_OK
;

1599 
	`£rv”Log
(
LL_NOTICE
, "Background AOF„ewrite finished successfully");

1601 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_WAIT_REWRITE
)

1602 
£rv”
.
aof_¡©e
 = 
AOF_ON
;

1605 ià(
Şdfd
 !ğ-1è
	`bioC»©eBackgroundJob
(
BIO_CLOSE_FILE
,(*)()Şdfd,
NULL
,NULL);

1607 
	`£rv”Log
(
LL_VERBOSE
,

1608 "Background AOF„ewr™sigÇÈhªdË¸took %Îdus", 
	`u¡ime
()-
now
);

1609 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1612 ià(
bysigÇl
 !ğ
SIGUSR1
)

1613 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_ERR
;

1614 
	`£rv”Log
(
LL_WARNING
,

1617 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_ERR
;

1619 
	`£rv”Log
(
LL_WARNING
,

1620 "Background AOF„ewr™‹rmš©ed by sigÇÈ%d", 
bysigÇl
);

1623 
ş—nup
:

1624 
	`aofClo£Pes
();

1625 
	`aofRewr™eBufãrRe£t
();

1626 
	`aofRemoveTempFe
(
£rv”
.
aof_chd_pid
);

1627 
£rv”
.
aof_chd_pid
 = -1;

1628 
£rv”
.
aof_»wr™e_time_Ï¡
 = 
	`time
(
NULL
)-£rv”.
aof_»wr™e_time_¡¬t
;

1629 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

1631 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_WAIT_REWRITE
)

1632 
£rv”
.
aof_»wr™e_scheduËd
 = 1;

1633 
	}
}

	@src/asciilogo.h

30 *
	gascii_logo
 =

	@src/atomicvar.h

60 
	~<±h»ad.h
>

62 #iâdeà
__ATOMIC_VAR_H


63 
	#__ATOMIC_VAR_H


	)

71 #ià!
defšed
(
__ATOMIC_VAR_FORCE_SYNC_MACROS
è&& defšed(
__ATOMIC_RELAXED
è&& !defšed(
__sun
è&& (!defšed(
__şªg__
è|| !defšed(
__APPLE__
è|| 
__­¶e_bud_v”siÚ__
 > 4210057)

74 
	#©omicInü
(
v¬
,
couÁ
è
	`__©omic_add_ãtch
(&v¬,(couÁ),
__ATOMIC_RELAXED
)

	)

75 
	#©omicG‘Inü
(
v¬
,
Şdv®ue_v¬
,
couÁ
) do { \

76 
Şdv®ue_v¬
 = 
	`__©omic_ãtch_add
(&
v¬
,(
couÁ
),
__ATOMIC_RELAXED
); \

77 } 0)

	)

78 
	#©omicDeü
(
v¬
,
couÁ
è
	`__©omic_sub_ãtch
(&v¬,(couÁ),
__ATOMIC_RELAXED
)

	)

79 
	#©omicG‘
(
v¬
,
d¡v¬
) do { \

80 
d¡v¬
 = 
	`__©omic_lßd_n
(&
v¬
,
__ATOMIC_RELAXED
); \

81 } 0)

	)

82 
	#©omicS‘
(
v¬
,
v®ue
è
	`__©omic_¡Üe_n
(&v¬,v®ue,
__ATOMIC_RELAXED
)

	)

83 
	#REDIS_ATOMIC_API
 "©omic-butš"

	)

85 #–ià
defšed
(
HAVE_ATOMIC
)

88 
	#©omicInü
(
v¬
,
couÁ
è
	`__sync_add_ªd_ãtch
(&v¬,(couÁ))

	)

89 
	#©omicG‘Inü
(
v¬
,
Şdv®ue_v¬
,
couÁ
) do { \

90 
Şdv®ue_v¬
 = 
	`__sync_ãtch_ªd_add
(&
v¬
,(
couÁ
)); \

91 } 0)

	)

92 
	#©omicDeü
(
v¬
,
couÁ
è
	`__sync_sub_ªd_ãtch
(&v¬,(couÁ))

	)

93 
	#©omicG‘
(
v¬
,
d¡v¬
) do { \

94 
d¡v¬
 = 
	`__sync_sub_ªd_ãtch
(&
v¬
,0); \

95 } 0)

	)

96 
	#©omicS‘
(
v¬
,
v®ue
) do { \

97 !
	`__sync_boŞ_com·»_ªd_sw­
(&
v¬
,v¬,
v®ue
)); \

98 } 0)

	)

99 
	#REDIS_ATOMIC_API
 "sync-butš"

	)

104 
	#©omicInü
(
v¬
,
couÁ
) do { \

105 
	`±h»ad_mu‹x_lock
(&
v¬
 ## 
_mu‹x
); \

106 
v¬
 +ğ(
couÁ
); \

107 
	`±h»ad_mu‹x_uÆock
(&
v¬
 ## 
_mu‹x
); \

108 } 0)

	)

109 
	#©omicG‘Inü
(
v¬
,
Şdv®ue_v¬
,
couÁ
) do { \

110 
	`±h»ad_mu‹x_lock
(&
v¬
 ## 
_mu‹x
); \

111 
Şdv®ue_v¬
 = 
v¬
; \

112 
v¬
 +ğ(
couÁ
); \

113 
	`±h»ad_mu‹x_uÆock
(&
v¬
 ## 
_mu‹x
); \

114 } 0)

	)

115 
	#©omicDeü
(
v¬
,
couÁ
) do { \

116 
	`±h»ad_mu‹x_lock
(&
v¬
 ## 
_mu‹x
); \

117 
v¬
 -ğ(
couÁ
); \

118 
	`±h»ad_mu‹x_uÆock
(&
v¬
 ## 
_mu‹x
); \

119 } 0)

	)

120 
	#©omicG‘
(
v¬
,
d¡v¬
) do { \

121 
	`±h»ad_mu‹x_lock
(&
v¬
 ## 
_mu‹x
); \

122 
d¡v¬
 = 
v¬
; \

123 
	`±h»ad_mu‹x_uÆock
(&
v¬
 ## 
_mu‹x
); \

124 } 0)

	)

125 
	#©omicS‘
(
v¬
,
v®ue
) do { \

126 
	`±h»ad_mu‹x_lock
(&
v¬
 ## 
_mu‹x
); \

127 
v¬
 = 
v®ue
; \

128 
	`±h»ad_mu‹x_uÆock
(&
v¬
 ## 
_mu‹x
); \

129 } 0)

	)

130 
	#REDIS_ATOMIC_API
 "±h»ad-mu‹x"

	)

	@src/bio.c

61 
	~"£rv”.h
"

62 
	~"bio.h
"

64 
±h»ad_t
 
	gbio_th»ads
[
BIO_NUM_OPS
];

65 
±h»ad_mu‹x_t
 
	gbio_mu‹x
[
BIO_NUM_OPS
];

66 
±h»ad_cÚd_t
 
	gbio_Ãwjob_cÚd
[
BIO_NUM_OPS
];

67 
±h»ad_cÚd_t
 
	gbio_¡•_cÚd
[
BIO_NUM_OPS
];

68 
li¡
 *
	gbio_jobs
[
BIO_NUM_OPS
];

75 
	gbio_³ndšg
[
BIO_NUM_OPS
];

79 
	sbio_job
 {

80 
time_t
 
	mtime
;

83 *
	m¬g1
, *
	m¬g2
, *
	m¬g3
;

86 *
bioProûssBackgroundJobs
(*
¬g
);

87 
Ïzyä“F»eObjeùFromBioTh»ad
(
robj
 *
o
);

88 
Ïzyä“F»eD©aba£FromBioTh»ad
(
diù
 *
ht1
, diù *
ht2
);

89 
Ïzyä“F»eSlÙsM­FromBioTh»ad
(
zskli¡
 *
¦
);

93 
	#REDIS_THREAD_STACK_SIZE
 (1024*1024*4)

	)

96 
	$bioIn™
() {

97 
±h»ad_©Œ_t
 
©Œ
;

98 
±h»ad_t
 
th»ad
;

99 
size_t
 
¡acksize
;

100 
j
;

103 
j
 = 0; j < 
BIO_NUM_OPS
; j++) {

104 
	`±h»ad_mu‹x_š™
(&
bio_mu‹x
[
j
],
NULL
);

105 
	`±h»ad_cÚd_š™
(&
bio_Ãwjob_cÚd
[
j
],
NULL
);

106 
	`±h»ad_cÚd_š™
(&
bio_¡•_cÚd
[
j
],
NULL
);

107 
bio_jobs
[
j
] = 
	`li¡C»©e
();

108 
bio_³ndšg
[
j
] = 0;

112 
	`±h»ad_©Œ_š™
(&
©Œ
);

113 
	`±h»ad_©Œ_g‘¡acksize
(&
©Œ
,&
¡acksize
);

114 ià(!
¡acksize
) stacksize = 1;

115 
¡acksize
 < 
REDIS_THREAD_STACK_SIZE
) stacksize *= 2;

116 
	`±h»ad_©Œ_£t¡acksize
(&
©Œ
, 
¡acksize
);

121 
j
 = 0; j < 
BIO_NUM_OPS
; j++) {

122 *
¬g
 = (*)(è
j
;

123 ià(
	`±h»ad_ü—‹
(&
th»ad
,&
©Œ
,
bioProûssBackgroundJobs
,
¬g
) != 0) {

124 
	`£rv”Log
(
LL_WARNING
,"Fatal: Can't initialize Background Jobs.");

125 
	`ex™
(1);

127 
bio_th»ads
[
j
] = 
th»ad
;

129 
	}
}

131 
	$bioC»©eBackgroundJob
(
ty³
, *
¬g1
, *
¬g2
, *
¬g3
) {

132 
bio_job
 *
job
 = 
	`zm®loc
((*job));

134 
job
->
time
 = 
	`time
(
NULL
);

135 
job
->
¬g1
 =‡rg1;

136 
job
->
¬g2
 =‡rg2;

137 
job
->
¬g3
 =‡rg3;

138 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

139 
	`li¡AddNodeTa
(
bio_jobs
[
ty³
],
job
);

140 
bio_³ndšg
[
ty³
]++;

141 
	`±h»ad_cÚd_sigÇl
(&
bio_Ãwjob_cÚd
[
ty³
]);

142 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

143 
	}
}

145 *
	$bioProûssBackgroundJobs
(*
¬g
) {

146 
bio_job
 *
job
;

147 
ty³
 = (è
¬g
;

148 
sig£t_t
 
sig£t
;

151 ià(
ty³
 >ğ
BIO_NUM_OPS
) {

152 
	`£rv”Log
(
LL_WARNING
,

153 "W¬nšg: biØth»ad s¹ed w™h wrÚgy³ %lu",
ty³
);

154  
NULL
;

159 
	`±h»ad_£tÿnûl¡©e
(
PTHREAD_CANCEL_ENABLE
, 
NULL
);

160 
	`±h»ad_£tÿnûÉy³
(
PTHREAD_CANCEL_ASYNCHRONOUS
, 
NULL
);

162 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

165 
	`sigem±y£t
(&
sig£t
);

166 
	`sigadd£t
(&
sig£t
, 
SIGALRM
);

167 ià(
	`±h»ad_sigmask
(
SIG_BLOCK
, &
sig£t
, 
NULL
))

168 
	`£rv”Log
(
LL_WARNING
,

169 "W¬nšg: cª'ˆmask SIGALRM iÀbio.øth»ad: %s", 
	`¡»¼Ü
(
”ºo
));

172 
li¡Node
 *
Ê
;

175 ià(
	`li¡L’gth
(
bio_jobs
[
ty³
]) == 0) {

176 
	`±h»ad_cÚd_wa™
(&
bio_Ãwjob_cÚd
[
ty³
],&
bio_mu‹x
[type]);

180 
Ê
 = 
	`li¡Fœ¡
(
bio_jobs
[
ty³
]);

181 
job
 = 
Ê
->
v®ue
;

184 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

187 ià(
ty³
 =ğ
BIO_CLOSE_FILE
) {

188 
	`şo£
(()
job
->
¬g1
);

189 } ià(
ty³
 =ğ
BIO_AOF_FSYNC
) {

190 
	`aof_fsync
(()
job
->
¬g1
);

191 } ià(
ty³
 =ğ
BIO_LAZY_FREE
) {

196 ià(
job
->
¬g1
)

197 
	`Ïzyä“F»eObjeùFromBioTh»ad
(
job
->
¬g1
);

198 ià(
job
->
¬g2
 && job->
¬g3
)

199 
	`Ïzyä“F»eD©aba£FromBioTh»ad
(
job
->
¬g2
,job->
¬g3
);

200 ià(
job
->
¬g3
)

201 
	`Ïzyä“F»eSlÙsM­FromBioTh»ad
(
job
->
¬g3
);

203 
	`£rv”Pªic
("Wrong jobype in bioProcessBackgroundJobs().");

205 
	`zä“
(
job
);

208 
	`±h»ad_cÚd_brßdÿ¡
(&
bio_¡•_cÚd
[
ty³
]);

212 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

213 
	`li¡D–Node
(
bio_jobs
[
ty³
],
Ê
);

214 
bio_³ndšg
[
ty³
]--;

216 
	}
}

219 
	$bioP’dšgJobsOfTy³
(
ty³
) {

220 
v®
;

221 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

222 
v®
 = 
bio_³ndšg
[
ty³
];

223 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

224  
v®
;

225 
	}
}

237 
	$bioWa™S‹pOfTy³
(
ty³
) {

238 
v®
;

239 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

240 
v®
 = 
bio_³ndšg
[
ty³
];

241 ià(
v®
 != 0) {

242 
	`±h»ad_cÚd_wa™
(&
bio_¡•_cÚd
[
ty³
],&
bio_mu‹x
[type]);

243 
v®
 = 
bio_³ndšg
[
ty³
];

245 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

246  
v®
;

247 
	}
}

253 
	$bioKlTh»ads
() {

254 
”r
, 
j
;

256 
j
 = 0; j < 
BIO_NUM_OPS
; j++) {

257 ià(
	`±h»ad_ÿnûl
(
bio_th»ads
[
j
]) == 0) {

258 ià((
”r
 = 
	`±h»ad_još
(
bio_th»ads
[
j
],
NULL
)) != 0) {

259 
	`£rv”Log
(
LL_WARNING
,

261 
j
, 
	`¡»¼Ü
(
”r
));

263 
	`£rv”Log
(
LL_WARNING
,

264 "BiØth»ad fÜ joby³ #%d”mš©ed",
j
);

268 
	}
}

	@src/bio.h

31 
bioIn™
();

32 
bioC»©eBackgroundJob
(
ty³
, *
¬g1
, *
¬g2
, *
¬g3
);

33 
bioP’dšgJobsOfTy³
(
ty³
);

34 
bioWa™S‹pOfTy³
(
ty³
);

35 
time_t
 
bioOld”JobOfTy³
(
ty³
);

36 
bioKlTh»ads
();

39 
	#BIO_CLOSE_FILE
 0

	)

40 
	#BIO_AOF_FSYNC
 1

	)

41 
	#BIO_LAZY_FREE
 2

	)

42 
	#BIO_NUM_OPS
 3

	)

	@src/bitops.c

31 
	~"£rv”.h
"

40 
size_t
 
	$»disPİcouÁ
(*
s
, 
couÁ
) {

41 
size_t
 
b™s
 = 0;

42 *
p
 = 
s
;

43 
ušt32_t
 *
p4
;

44 cÚ¡ 
b™sšby‹
[256] = {0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8};

47 ()
p
 & 3 && 
couÁ
) {

48 
b™s
 +ğ
b™sšby‹
[*
p
++];

49 
couÁ
--;

53 
p4
 = (
ušt32_t
*)
p
;

54 
couÁ
>=28) {

55 
ušt32_t
 
aux1
, 
aux2
, 
aux3
, 
aux4
, 
aux5
, 
aux6
, 
aux7
;

57 
aux1
 = *
p4
++;

58 
aux2
 = *
p4
++;

59 
aux3
 = *
p4
++;

60 
aux4
 = *
p4
++;

61 
aux5
 = *
p4
++;

62 
aux6
 = *
p4
++;

63 
aux7
 = *
p4
++;

64 
couÁ
 -= 28;

66 
aux1
 =‡ux1 - ((aux1 >> 1) & 0x55555555);

67 
aux1
 = (aux1 & 0x33333333) + ((aux1 >> 2) & 0x33333333);

68 
aux2
 =‡ux2 - ((aux2 >> 1) & 0x55555555);

69 
aux2
 = (aux2 & 0x33333333) + ((aux2 >> 2) & 0x33333333);

70 
aux3
 =‡ux3 - ((aux3 >> 1) & 0x55555555);

71 
aux3
 = (aux3 & 0x33333333) + ((aux3 >> 2) & 0x33333333);

72 
aux4
 =‡ux4 - ((aux4 >> 1) & 0x55555555);

73 
aux4
 = (aux4 & 0x33333333) + ((aux4 >> 2) & 0x33333333);

74 
aux5
 =‡ux5 - ((aux5 >> 1) & 0x55555555);

75 
aux5
 = (aux5 & 0x33333333) + ((aux5 >> 2) & 0x33333333);

76 
aux6
 =‡ux6 - ((aux6 >> 1) & 0x55555555);

77 
aux6
 = (aux6 & 0x33333333) + ((aux6 >> 2) & 0x33333333);

78 
aux7
 =‡ux7 - ((aux7 >> 1) & 0x55555555);

79 
aux7
 = (aux7 & 0x33333333) + ((aux7 >> 2) & 0x33333333);

80 
b™s
 +ğ((((
aux1
 + (aux1 >> 4)) & 0x0F0F0F0F) +

81 ((
aux2
 + (aux2 >> 4)) & 0x0F0F0F0F) +

82 ((
aux3
 + (aux3 >> 4)) & 0x0F0F0F0F) +

83 ((
aux4
 + (aux4 >> 4)) & 0x0F0F0F0F) +

84 ((
aux5
 + (aux5 >> 4)) & 0x0F0F0F0F) +

85 ((
aux6
 + (aux6 >> 4)) & 0x0F0F0F0F) +

86 ((
aux7
 + (aux7 >> 4)) & 0x0F0F0F0F))* 0x01010101) >> 24;

89 
p
 = (*)
p4
;

90 
couÁ
--è
b™s
 +ğ
b™sšby‹
[*
p
++];

91  
b™s
;

92 
	}
}

101 
	$»disB™pos
(*
s
, 
couÁ
, 
b™
) {

102 *
l
;

103 *
c
;

104 
skv®
, 
wÜd
 = 0, 
Úe
;

105 
pos
 = 0;

106 
j
;

107 
found
;

119 
skv®
 = 
b™
 ? 0 : 
UCHAR_MAX
;

120 
c
 = (*è
s
;

121 
found
 = 0;

122 ()
c
 & ((*
l
)-1è&& 
couÁ
) {

123 ià(*
c
 !ğ
skv®
) {

124 
found
 = 1;

127 
c
++;

128 
couÁ
--;

129 
pos
 += 8;

133 
l
 = (*è
c
;

134 ià(!
found
) {

135 
skv®
 = 
b™
 ? 0 : 
ULONG_MAX
;

136 
couÁ
 >ğ(*
l
)) {

137 ià(*
l
 !ğ
skv®
) ;

138 
l
++;

139 
couÁ
 -ğ(*
l
);

140 
pos
 +ğ(*
l
)*8;

151 
c
 = (*)
l
;

152 
j
 = 0; j < (*
l
); j++) {

153 
wÜd
 <<= 8;

154 ià(
couÁ
) {

155 
wÜd
 |ğ*
c
;

156 
c
++;

157 
couÁ
--;

166 ià(
b™
 =ğ1 && 
wÜd
 == 0)  -1;

172 
Úe
 = 
ULONG_MAX
;

173 
Úe
 >>= 1;

174 
Úe
 = ~one;

176 
Úe
) {

177 ià(((
Úe
 & 
wÜd
è!ğ0è=ğ
b™
è 
pos
;

178 
pos
++;

179 
Úe
 >>= 1;

184 
	`£rv”Pªic
("End of„edisBitpos()„eached.");

186 
	}
}

209 
	$£tUnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, ušt64_ˆ
v®ue
) {

210 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
;

212 
j
 = 0; j < 
b™s
; j++) {

213 
b™v®
 = (
v®ue
 & ((
ušt64_t
)1<<(
b™s
-1-
j
))) != 0;

214 
by‹
 = 
off£t
 >> 3;

215 
b™
 = 7 - (
off£t
 & 0x7);

216 
by‹v®
 = 
p
[
by‹
];

217 
by‹v®
 &ğ~(1 << 
b™
);

218 
by‹v®
 |ğ
b™v®
 << 
b™
;

219 
p
[
by‹
] = 
by‹v®
 & 0xff;

220 
off£t
++;

222 
	}
}

224 
	$£tSigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
, 
št64_t
 
v®ue
) {

225 
ušt64_t
 
uv
 = 
v®ue
;

226 
	`£tUnsigÃdB™f›ld
(
p
,
off£t
,
b™s
,
uv
);

227 
	}
}

229 
ušt64_t
 
	$g‘UnsigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

230 
ušt64_t
 
by‹
, 
b™
, 
by‹v®
, 
b™v®
, 
j
, 
v®ue
 = 0;

232 
j
 = 0; j < 
b™s
; j++) {

233 
by‹
 = 
off£t
 >> 3;

234 
b™
 = 7 - (
off£t
 & 0x7);

235 
by‹v®
 = 
p
[
by‹
];

236 
b™v®
 = (
by‹v®
 >> 
b™
) & 1;

237 
v®ue
 = (v®ue<<1è| 
b™v®
;

238 
off£t
++;

240  
v®ue
;

241 
	}
}

243 
št64_t
 
	$g‘SigÃdB™f›ld
(*
p
, 
ušt64_t
 
off£t
, ušt64_ˆ
b™s
) {

244 
št64_t
 
v®ue
;

245 uniÚ {
ušt64_t
 
u
; 
št64_t
 
i
;} 
cÚv
;

254 
cÚv
.
u
 = 
	`g‘UnsigÃdB™f›ld
(
p
,
off£t
,
b™s
);

255 
v®ue
 = 
cÚv
.
i
;

260 ià(
v®ue
 & ((
ušt64_t
)1 << (
b™s
-1)))

261 
v®ue
 |ğ((
ušt64_t
)-1è<< 
b™s
;

262  
v®ue
;

263 
	}
}

284 
	#BFOVERFLOW_WRAP
 0

	)

285 
	#BFOVERFLOW_SAT
 1

	)

286 
	#BFOVERFLOW_FAIL
 2

	)

288 
	$checkUnsigÃdB™f›ldOv”æow
(
ušt64_t
 
v®ue
, 
št64_t
 
šü
, ušt64_ˆ
b™s
, 
owty³
, ušt64_ˆ*
lim™
) {

289 
ušt64_t
 
max
 = (
b™s
 =ğ64è? 
UINT64_MAX
 : (((uint64_t)1<<bits)-1);

290 
št64_t
 
maxšü
 = 
max
-
v®ue
;

291 
št64_t
 
mššü
 = -
v®ue
;

293 ià(
v®ue
 > 
max
 || (
šü
 > 0 && inü > 
maxšü
)) {

294 ià(
lim™
) {

295 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

296 
hªdË_w¿p
;

297 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

298 *
lim™
 = 
max
;

302 } ià(
šü
 < 0 && inü < 
mššü
) {

303 ià(
lim™
) {

304 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

305 
hªdË_w¿p
;

306 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

307 *
lim™
 = 0;

314 
hªdË_w¿p
:

316 
ušt64_t
 
mask
 = ((ušt64_t)-1è<< 
b™s
;

317 
ušt64_t
 
»s
 = 
v®ue
+
šü
;

319 
»s
 &ğ~
mask
;

320 *
lim™
 = 
»s
;

323 
	}
}

325 
	$checkSigÃdB™f›ldOv”æow
(
št64_t
 
v®ue
, iÁ64_ˆ
šü
, 
ušt64_t
 
b™s
, 
owty³
, iÁ64_ˆ*
lim™
) {

326 
št64_t
 
max
 = (
b™s
 =ğ64è? 
INT64_MAX
 : (((int64_t)1<<(bits-1))-1);

327 
št64_t
 
mš
 = (-
max
)-1;

332 
št64_t
 
maxšü
 = 
max
-
v®ue
;

333 
št64_t
 
mššü
 = 
mš
-
v®ue
;

335 ià(
v®ue
 > 
max
 || (
b™s
 !ğ64 && 
šü
 > 
maxšü
) || (value >= 0 && incr > 0 && incr > maxincr))

337 ià(
lim™
) {

338 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

339 
hªdË_w¿p
;

340 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

341 *
lim™
 = 
max
;

345 } ià(
v®ue
 < 
mš
 || (
b™s
 !ğ64 && 
šü
 < 
mššü
) || (value < 0 && incr < 0 && incr < minincr)) {

346 ià(
lim™
) {

347 ià(
owty³
 =ğ
BFOVERFLOW_WRAP
) {

348 
hªdË_w¿p
;

349 } ià(
owty³
 =ğ
BFOVERFLOW_SAT
) {

350 *
lim™
 = 
mš
;

357 
hªdË_w¿p
:

359 
ušt64_t
 
mask
 = ((ušt64_t)-1è<< 
b™s
;

360 
ušt64_t
 
msb
 = (ušt64_t)1 << (
b™s
-1);

361 
ušt64_t
 
a
 = 
v®ue
, 
b
 = 
šü
, 
c
;

362 
c
 = 
a
+
b
;

367 ià(
c
 & 
msb
) {

368 
c
 |ğ
mask
;

370 
c
 &ğ~
mask
;

372 *
lim™
 = 
c
;

375 
	}
}

379 
	$´štB™s
(*
p
, 
couÁ
) {

380 
j
, 
i
, 
by‹
;

382 
j
 = 0; j < 
couÁ
; j++) {

383 
by‹
 = 
p
[
j
];

384 
i
 = 0x80; i > 0; i /= 2)

385 
	`´štf
("%c", (
by‹
 & 
i
) ? '1' : '0');

386 
	`´štf
("|");

388 
	`´štf
("\n");

389 
	}
}

395 
	#BITOP_AND
 0

	)

396 
	#BITOP_OR
 1

	)

397 
	#BITOP_XOR
 2

	)

398 
	#BITOP_NOT
 3

	)

400 
	#BITFIELDOP_GET
 0

	)

401 
	#BITFIELDOP_SET
 1

	)

402 
	#BITFIELDOP_INCRBY
 2

	)

411 
	$g‘B™Off£tFromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, 
size_t
 *
off£t
, 
hash
, 
b™s
) {

412 
loff£t
;

413 *
”r
 = "bit offset is‚ot‡n integer or out of„ange";

414 *
p
 = 
o
->
±r
;

415 
size_t
 
¶’
 = 
	`sd¦’
(
p
);

416 
u£hash
 = 0;

419 ià(
p
[0] =ğ'#' && 
hash
 && 
b™s
 > 0è
u£hash
 = 1;

421 ià(
	`¡ršg2Î
(
p
+
u£hash
,
¶’
-u£hash,&
loff£t
) == 0) {

422 
	`addR•lyE¼Ü
(
c
,
”r
);

423  
C_ERR
;

427 ià(
u£hash
è
loff£t
 *ğ
b™s
;

430 ià((
loff£t
 < 0) || (()loffset >> 3) >= (512*1024*1024))

432 
	`addR•lyE¼Ü
(
c
,
”r
);

433  
C_ERR
;

436 *
off£t
 = (
size_t
)
loff£t
;

437  
C_OK
;

438 
	}
}

447 
	$g‘B™f›ldTy³FromArgum’t
(
ş›Á
 *
c
, 
robj
 *
o
, *
sign
, *
b™s
) {

448 *
p
 = 
o
->
±r
;

449 *
”r
 = "Invalid bitfieldype. Use something†ike i16 u8. Notehat u64 is‚ot supported but i64 is.";

450 
Îb™s
;

452 ià(
p
[0] == 'i') {

453 *
sign
 = 1;

454 } ià(
p
[0] == 'u') {

455 *
sign
 = 0;

457 
	`addR•lyE¼Ü
(
c
,
”r
);

458  
C_ERR
;

461 ià((
	`¡ršg2Î
(
p
+1,
	`¡¾’
Õ+1),&
Îb™s
)) == 0 ||

462 
Îb™s
 < 1 ||

463 (*
sign
 =ğ1 && 
Îb™s
 > 64) ||

464 (*
sign
 =ğ0 && 
Îb™s
 > 63))

466 
	`addR•lyE¼Ü
(
c
,
”r
);

467  
C_ERR
;

469 *
b™s
 = 
Îb™s
;

470  
C_OK
;

471 
	}
}

478 
robj
 *
	$lookupSŒšgFÜB™Commªd
(
ş›Á
 *
c
, 
size_t
 
maxb™
) {

479 
size_t
 
by‹
 = 
maxb™
 >> 3;

480 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

482 ià(
o
 =ğ
NULL
) {

483 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
by‹
+1));

484 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

486 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)è 
NULL
;

487 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

488 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
by‹
+1);

490  
o
;

491 
	}
}

506 *
	$g‘ObjeùR—dOÆySŒšg
(
robj
 *
o
, *
Ën
, *
Îbuf
) {

507 
	`£rv”As£¹
(
o
->
ty³
 =ğ
OBJ_STRING
);

508 *
p
 = 
NULL
;

512 ià(
o
 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

513 
p
 = (*è
Îbuf
;

514 ià(
Ën
è*ËÀğ
	`Î2¡ršg
(
Îbuf
,
LONG_STR_SIZE
,()
o
->
±r
);

515 } ià(
o
) {

516 
p
 = (*è
o
->
±r
;

517 ià(
Ën
è*ËÀğ
	`sd¦’
(
o
->
±r
);

519 ià(
Ën
) *len = 0;

521  
p
;

522 
	}
}

525 
	$£tb™Commªd
(
ş›Á
 *
c
) {

526 
robj
 *
o
;

527 *
”r
 = "bit is‚ot‡n integer or out of„ange";

528 
size_t
 
b™off£t
;

529 
ssize_t
 
by‹
, 
b™
;

530 
by‹v®
, 
b™v®
;

531 
Ú
;

533 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
C_OK
)

536 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
Ú
,
”r
è!ğ
C_OK
)

540 ià(
Ú
 & ~1) {

541 
	`addR•lyE¼Ü
(
c
,
”r
);

545 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,
b™off£t
)è=ğ
NULL
) ;

548 
by‹
 = 
b™off£t
 >> 3;

549 
by‹v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
];

550 
b™
 = 7 - (
b™off£t
 & 0x7);

551 
b™v®
 = 
by‹v®
 & (1 << 
b™
);

554 
by‹v®
 &ğ~(1 << 
b™
);

555 
by‹v®
 |ğ((
Ú
 & 0x1è<< 
b™
);

556 ((
ušt8_t
*)
o
->
±r
)[
by‹
] = 
by‹v®
;

557 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

558 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

559 
£rv”
.
dœty
++;

560 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

561 
	}
}

564 
	$g‘b™Commªd
(
ş›Á
 *
c
) {

565 
robj
 *
o
;

566 
Îbuf
[32];

567 
size_t
 
b™off£t
;

568 
size_t
 
by‹
, 
b™
;

569 
size_t
 
b™v®
 = 0;

571 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
,0,0è!ğ
C_OK
)

574 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

575 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

577 
by‹
 = 
b™off£t
 >> 3;

578 
b™
 = 7 - (
b™off£t
 & 0x7);

579 ià(
	`sdsEncodedObjeù
(
o
)) {

580 ià(
by‹
 < 
	`sd¦’
(
o
->
±r
))

581 
b™v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
] & (1 << 
b™
);

583 ià(
by‹
 < (
size_t
)
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
))

584 
b™v®
 = 
Îbuf
[
by‹
] & (1 << 
b™
);

587 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

588 
	}
}

591 
	$b™İCommªd
(
ş›Á
 *
c
) {

592 *
İÇme
 = 
c
->
¬gv
[1]->
±r
;

593 
robj
 *
o
, *
rg‘key
 = 
c
->
¬gv
[2];

594 
İ
, 
j
, 
numkeys
;

595 
robj
 **
objeùs
;

596 **
¤c
;

597 *
Ën
, 
maxËn
 = 0;

599 
mšËn
 = 0;

600 *
»s
 = 
NULL
;

603 ià((
İÇme
[0] =ğ'a' || o²ame[0] =ğ'A'è&& !
	`¡rÿ£cmp
(opname,"and"))

604 
İ
 = 
BITOP_AND
;

605 if((
İÇme
[0] =ğ'o' || o²ame[0] =ğ'O'è&& !
	`¡rÿ£cmp
(opname,"or"))

606 
İ
 = 
BITOP_OR
;

607 if((
İÇme
[0] =ğ'x' || o²ame[0] =ğ'X'è&& !
	`¡rÿ£cmp
(opname,"xor"))

608 
İ
 = 
BITOP_XOR
;

609 if((
İÇme
[0] =ğ'n' || o²ame[0] =ğ'N'è&& !
	`¡rÿ£cmp
(opname,"not"))

610 
İ
 = 
BITOP_NOT
;

612 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

617 ià(
İ
 =ğ
BITOP_NOT
 && 
c
->
¬gc
 != 4) {

618 
	`addR•lyE¼Ü
(
c
,"BITOP NOT must be called with‡ single source key.");

623 
numkeys
 = 
c
->
¬gc
 - 3;

624 
¤c
 = 
	`zm®loc
((*è* 
numkeys
);

625 
Ën
 = 
	`zm®loc
((è* 
numkeys
);

626 
objeùs
 = 
	`zm®loc
((
robj
*è* 
numkeys
);

627 
j
 = 0; j < 
numkeys
; j++) {

628 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
+3]);

630 ià(
o
 =ğ
NULL
) {

631 
objeùs
[
j
] = 
NULL
;

632 
¤c
[
j
] = 
NULL
;

633 
Ën
[
j
] = 0;

634 
mšËn
 = 0;

638 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) {

639 
i
;

640 
i
 = 0; i < 
j
; i++) {

641 ià(
objeùs
[
i
])

642 
	`deüRefCouÁ
(
objeùs
[
i
]);

644 
	`zä“
(
¤c
);

645 
	`zä“
(
Ën
);

646 
	`zä“
(
objeùs
);

649 
objeùs
[
j
] = 
	`g‘DecodedObjeù
(
o
);

650 
¤c
[
j
] = 
objeùs
[j]->
±r
;

651 
Ën
[
j
] = 
	`sd¦’
(
objeùs
[j]->
±r
);

652 ià(
Ën
[
j
] > 
maxËn
) maxlen =†en[j];

653 ià(
j
 =ğ0 || 
Ën
[j] < 
mšËn
) minlen =†en[j];

657 ià(
maxËn
) {

658 
»s
 = (*è
	`sd¢ewËn
(
NULL
,
maxËn
);

659 
ouut
, 
by‹
;

660 
i
;

667 
j
 = 0;

668 #iâdeà
USE_ALIGNED_ACCESS


669 ià(
mšËn
 >ğ()*4 && 
numkeys
 <= 16) {

670 *
Í
[16];

671 *
Ìes
 = (*è
»s
;

674 
	`memıy
(
Í
,
¤c
,(*)*
numkeys
);

675 
	`memıy
(
»s
,
¤c
[0],
mšËn
);

678 ià(
İ
 =ğ
BITOP_AND
) {

679 
mšËn
 >= ()*4) {

680 
i
 = 1; i < 
numkeys
; i++) {

681 
Ìes
[0] &ğ
Í
[
i
][0];

682 
Ìes
[1] &ğ
Í
[
i
][1];

683 
Ìes
[2] &ğ
Í
[
i
][2];

684 
Ìes
[3] &ğ
Í
[
i
][3];

685 
Í
[
i
]+=4;

687 
Ìes
+=4;

688 
j
 += ()*4;

689 
mšËn
 -= ()*4;

691 } ià(
İ
 =ğ
BITOP_OR
) {

692 
mšËn
 >= ()*4) {

693 
i
 = 1; i < 
numkeys
; i++) {

694 
Ìes
[0] |ğ
Í
[
i
][0];

695 
Ìes
[1] |ğ
Í
[
i
][1];

696 
Ìes
[2] |ğ
Í
[
i
][2];

697 
Ìes
[3] |ğ
Í
[
i
][3];

698 
Í
[
i
]+=4;

700 
Ìes
+=4;

701 
j
 += ()*4;

702 
mšËn
 -= ()*4;

704 } ià(
İ
 =ğ
BITOP_XOR
) {

705 
mšËn
 >= ()*4) {

706 
i
 = 1; i < 
numkeys
; i++) {

707 
Ìes
[0] ^ğ
Í
[
i
][0];

708 
Ìes
[1] ^ğ
Í
[
i
][1];

709 
Ìes
[2] ^ğ
Í
[
i
][2];

710 
Ìes
[3] ^ğ
Í
[
i
][3];

711 
Í
[
i
]+=4;

713 
Ìes
+=4;

714 
j
 += ()*4;

715 
mšËn
 -= ()*4;

717 } ià(
İ
 =ğ
BITOP_NOT
) {

718 
mšËn
 >= ()*4) {

719 
Ìes
[0] = ~lres[0];

720 
Ìes
[1] = ~lres[1];

721 
Ìes
[2] = ~lres[2];

722 
Ìes
[3] = ~lres[3];

723 
Ìes
+=4;

724 
j
 += ()*4;

725 
mšËn
 -= ()*4;

732 ; 
j
 < 
maxËn
; j++) {

733 
ouut
 = (
Ën
[0] <ğ
j
è? 0 : 
¤c
[0][j];

734 ià(
İ
 =ğ
BITOP_NOT
è
ouut
 = ~output;

735 
i
 = 1; i < 
numkeys
; i++) {

736 
by‹
 = (
Ën
[
i
] <ğ
j
è? 0 : 
¤c
[i][j];

737 
İ
) {

738 
BITOP_AND
: 
ouut
 &ğ
by‹
; ;

739 
BITOP_OR
: 
ouut
 |ğ
by‹
; ;

740 
BITOP_XOR
: 
ouut
 ^ğ
by‹
; ;

743 
»s
[
j
] = 
ouut
;

746 
j
 = 0; j < 
numkeys
; j++) {

747 ià(
objeùs
[
j
])

748 
	`deüRefCouÁ
(
objeùs
[
j
]);

750 
	`zä“
(
¤c
);

751 
	`zä“
(
Ën
);

752 
	`zä“
(
objeùs
);

755 ià(
maxËn
) {

756 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
»s
);

757 
	`£tKey
(
c
->
db
,
rg‘key
,
o
);

758 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
rg‘key
,
c
->
db
->
id
);

759 
	`deüRefCouÁ
(
o
);

760 } ià(
	`dbD–‘e
(
c
->
db
,
rg‘key
)) {

761 
	`sigÇlModif›dKey
(
c
->
db
,
rg‘key
);

762 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
rg‘key
,
c
->
db
->
id
);

764 
£rv”
.
dœty
++;

765 
	`addR•lyLÚgLÚg
(
c
,
maxËn
);

766 
	}
}

769 
	$b™couÁCommªd
(
ş›Á
 *
c
) {

770 
robj
 *
o
;

771 
¡¬t
, 
’d
, 
¡¾’
;

772 *
p
;

773 
Îbuf
[
LONG_STR_SIZE
];

776 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

777 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

778 
p
 = 
	`g‘ObjeùR—dOÆySŒšg
(
o
,&
¡¾’
,
Îbuf
);

781 ià(
c
->
¬gc
 == 4) {

782 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
C_OK
)

784 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
C_OK
)

787 ià(
¡¬t
 < 0 && 
’d
 < 0 && start >ƒnd) {

788 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

791 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

792 ià(
’d
 < 0è’d = 
¡¾’
+end;

793 ià(
¡¬t
 < 0) start = 0;

794 ià(
’d
 < 0)ƒnd = 0;

795 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

796 } ià(
c
->
¬gc
 == 2) {

798 
¡¬t
 = 0;

799 
’d
 = 
¡¾’
-1;

802 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

808 ià(
¡¬t
 > 
’d
) {

809 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

811 
by‹s
 = 
’d
-
¡¬t
+1;

813 
	`addR•lyLÚgLÚg
(
c
,
	`»disPİcouÁ
(
p
+
¡¬t
,
by‹s
));

815 
	}
}

818 
	$b™posCommªd
(
ş›Á
 *
c
) {

819 
robj
 *
o
;

820 
b™
, 
¡¬t
, 
’d
, 
¡¾’
;

821 *
p
;

822 
Îbuf
[
LONG_STR_SIZE
];

823 
’d_giv’
 = 0;

827 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
b™
,
NULL
è!ğ
C_OK
)

829 ià(
b™
 != 0 && bit != 1) {

830 
	`addR•lyE¼Ü
(
c
, "The bit‡rgument must be 1 or 0.");

837 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1])è=ğ
NULL
) {

838 
	`addR•lyLÚgLÚg
(
c
, 
b™
 ? -1 : 0);

841 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

842 
p
 = 
	`g‘ObjeùR—dOÆySŒšg
(
o
,&
¡¾’
,
Îbuf
);

845 ià(
c
->
¬gc
 == 4 || c->argc == 5) {

846 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
¡¬t
,
NULL
è!ğ
C_OK
)

848 ià(
c
->
¬gc
 == 5) {

849 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
’d
,
NULL
è!ğ
C_OK
)

851 
’d_giv’
 = 1;

853 
’d
 = 
¡¾’
-1;

856 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

857 ià(
’d
 < 0è’d = 
¡¾’
+end;

858 ià(
¡¬t
 < 0) start = 0;

859 ià(
’d
 < 0)ƒnd = 0;

860 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

861 } ià(
c
->
¬gc
 == 3) {

863 
¡¬t
 = 0;

864 
’d
 = 
¡¾’
-1;

867 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

873 ià(
¡¬t
 > 
’d
) {

874 
	`addR•lyLÚgLÚg
(
c
, -1);

876 
by‹s
 = 
’d
-
¡¬t
+1;

877 
pos
 = 
	`»disB™pos
(
p
+
¡¬t
,
by‹s
,
b™
);

886 ià(
’d_giv’
 && 
b™
 =ğ0 && 
pos
 =ğ
by‹s
*8) {

887 
	`addR•lyLÚgLÚg
(
c
,-1);

890 ià(
pos
 !ğ-1èpo +ğ
¡¬t
*8;

891 
	`addR•lyLÚgLÚg
(
c
,
pos
);

893 
	}
}

905 
	sb™f›ldOp
 {

906 
ušt64_t
 
	moff£t
;

907 
št64_t
 
	mi64
;

908 
	mİcode
;

909 
	mowty³
;

910 
	mb™s
;

911 
	msign
;

914 
	$b™f›ldCommªd
(
ş›Á
 *
c
) {

915 
robj
 *
o
;

916 
size_t
 
b™off£t
;

917 
j
, 
numİs
 = 0, 
chªges
 = 0;

918 
b™f›ldOp
 *
İs
 = 
NULL
;

919 
owty³
 = 
BFOVERFLOW_WRAP
;

920 
»adÚly
 = 1;

921 
size_t
 
hige¡_wr™e_off£t
 = 0;

923 
j
 = 2; j < 
c
->
¬gc
; j++) {

924 
»m¬gs
 = 
c
->
¬gc
-
j
-1;

925 *
subcmd
 = 
c
->
¬gv
[
j
]->
±r
;

926 
İcode
;

927 
i64
 = 0;

928 
sign
 = 0;

929 
b™s
 = 0;

931 ià(!
	`¡rÿ£cmp
(
subcmd
,"g‘"è&& 
»m¬gs
 >= 2)

932 
İcode
 = 
BITFIELDOP_GET
;

933 ià(!
	`¡rÿ£cmp
(
subcmd
,"£t"è&& 
»m¬gs
 >= 3)

934 
İcode
 = 
BITFIELDOP_SET
;

935 ià(!
	`¡rÿ£cmp
(
subcmd
,"šüby"è&& 
»m¬gs
 >= 3)

936 
İcode
 = 
BITFIELDOP_INCRBY
;

937 ià(!
	`¡rÿ£cmp
(
subcmd
,"ov”æow"è&& 
»m¬gs
 >= 1) {

938 *
owty³Çme
 = 
c
->
¬gv
[
j
+1]->
±r
;

939 
j
++;

940 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"wrap"))

941 
owty³
 = 
BFOVERFLOW_WRAP
;

942 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"sat"))

943 
owty³
 = 
BFOVERFLOW_SAT
;

944 ià(!
	`¡rÿ£cmp
(
owty³Çme
,"fail"))

945 
owty³
 = 
BFOVERFLOW_FAIL
;

947 
	`addR•lyE¼Ü
(
c
,"Invalid OVERFLOWype specified");

948 
	`zä“
(
İs
);

953 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

954 
	`zä“
(
İs
);

959 ià(
	`g‘B™f›ldTy³FromArgum’t
(
c
,c->
¬gv
[
j
+1],&
sign
,&
b™s
è!ğ
C_OK
) {

960 
	`zä“
(
İs
);

964 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[
j
+2],&
b™off£t
,1,
b™s
è!ğ
C_OK
){

965 
	`zä“
(
İs
);

969 ià(
İcode
 !ğ
BITFIELDOP_GET
) {

970 
»adÚly
 = 0;

971 ià(
hige¡_wr™e_off£t
 < 
b™off£t
 + 
b™s
 - 1)

972 
hige¡_wr™e_off£t
 = 
b™off£t
 + 
b™s
 - 1;

974 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+3],&
i64
,
NULL
è!ğ
C_OK
){

975 
	`zä“
(
İs
);

981 
İs
 = 
	`z»®loc
(İs,(*İs)*(
numİs
+1));

982 
İs
[
numİs
].
off£t
 = 
b™off£t
;

983 
İs
[
numİs
].
i64
 = i64;

984 
İs
[
numİs
].
İcode
 = opcode;

985 
İs
[
numİs
].
owty³
 = owtype;

986 
İs
[
numİs
].
b™s
 = bits;

987 
İs
[
numİs
].
sign
 = sign;

988 
numİs
++;

990 
j
 +ğ3 - (
İcode
 =ğ
BITFIELDOP_GET
);

993 ià(
»adÚly
) {

996 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

997 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)) ;

1001 ià((
o
 = 
	`lookupSŒšgFÜB™Commªd
(
c
,

1002 
hige¡_wr™e_off£t
)è=ğ
NULL
) ;

1005 
	`addR•lyMuÉiBulkL’
(
c
,
numİs
);

1008 
j
 = 0; j < 
numİs
; j++) {

1009 
b™f›ldOp
 *
thisİ
 = 
İs
+
j
;

1012 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_SET
 ||

1013 
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
)

1022 ià(
thisİ
->
sign
) {

1023 
št64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1024 
ov”æow
;

1026 
Şdv®
 = 
	`g‘SigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1027 
thisİ
->
b™s
);

1029 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1030 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1031 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Şdv®
,

1032 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1033 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1034 
»tv®
 = 
Ãwv®
;

1036 
Ãwv®
 = 
thisİ
->
i64
;

1037 
ov”æow
 = 
	`checkSigÃdB™f›ldOv”æow
(
Ãwv®
,

1038 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1039 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1040 
»tv®
 = 
Şdv®
;

1045 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1046 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1047 
	`£tSigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1048 
thisİ
->
b™s
,
Ãwv®
);

1050 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1053 
ušt64_t
 
Şdv®
, 
Ãwv®
, 
w¿µed
, 
»tv®
;

1054 
ov”æow
;

1056 
Şdv®
 = 
	`g‘UnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1057 
thisİ
->
b™s
);

1059 ià(
thisİ
->
İcode
 =ğ
BITFIELDOP_INCRBY
) {

1060 
Ãwv®
 = 
Şdv®
 + 
thisİ
->
i64
;

1061 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Şdv®
,

1062 
thisİ
->
i64
,thisİ->
b™s
,thisİ->
owty³
,&
w¿µed
);

1063 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1064 
»tv®
 = 
Ãwv®
;

1066 
Ãwv®
 = 
thisİ
->
i64
;

1067 
ov”æow
 = 
	`checkUnsigÃdB™f›ldOv”æow
(
Ãwv®
,

1068 0,
thisİ
->
b™s
,thisİ->
owty³
,&
w¿µed
);

1069 ià(
ov”æow
è
Ãwv®
 = 
w¿µed
;

1070 
»tv®
 = 
Şdv®
;

1074 ià(!(
ov”æow
 && 
thisİ
->
owty³
 =ğ
BFOVERFLOW_FAIL
)) {

1075 
	`addR•lyLÚgLÚg
(
c
,
»tv®
);

1076 
	`£tUnsigÃdB™f›ld
(
o
->
±r
,
thisİ
->
off£t
,

1077 
thisİ
->
b™s
,
Ãwv®
);

1079 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1082 
chªges
++;

1085 
buf
[9];

1086 
¡¾’
 = 0;

1087 *
¤c
 = 
NULL
;

1088 
Îbuf
[
LONG_STR_SIZE
];

1090 ià(
o
 !ğ
NULL
)

1091 
¤c
 = 
	`g‘ObjeùR—dOÆySŒšg
(
o
,&
¡¾’
,
Îbuf
);

1097 
	`mem£t
(
buf
,0,9);

1098 
i
;

1099 
size_t
 
by‹
 = 
thisİ
->
off£t
 >> 3;

1100 
i
 = 0; i < 9; i++) {

1101 ià(
¤c
 =ğ
NULL
 || 
i
+
by‹
 >ğ(
size_t
)
¡¾’
) ;

1102 
buf
[
i
] = 
¤c
[i+
by‹
];

1107 ià(
thisİ
->
sign
) {

1108 
št64_t
 
v®
 = 
	`g‘SigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1109 
thisİ
->
b™s
);

1110 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1112 
ušt64_t
 
v®
 = 
	`g‘UnsigÃdB™f›ld
(
buf
,
thisİ
->
off£t
-(
by‹
*8),

1113 
thisİ
->
b™s
);

1114 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1119 ià(
chªges
) {

1120 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1121 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

1122 
£rv”
.
dœty
 +ğ
chªges
;

1124 
	`zä“
(
İs
);

1125 
	}
}

	@src/blocked.c

66 
	~"£rv”.h
"

76 
	$g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, 
m¡ime_t
 *
timeout
, 
un™
) {

77 
tv®
;

79 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
objeù
,&
tv®
,

80 "timeouˆi nÙ‡Àš‹g” o¸ouˆoà¿nge"è!ğ
C_OK
)

81  
C_ERR
;

83 ià(
tv®
 < 0) {

84 
	`addR•lyE¼Ü
(
c
,"timeout is‚egative");

85  
C_ERR
;

88 ià(
tv®
 > 0) {

89 ià(
un™
 =ğ
UNIT_SECONDS
è
tv®
 *= 1000;

90 
tv®
 +ğ
	`m¡ime
();

92 *
timeout
 = 
tv®
;

94  
C_OK
;

95 
	}
}

100 
	$blockCl›Á
(
ş›Á
 *
c
, 
bty³
) {

101 
c
->
æags
 |ğ
CLIENT_BLOCKED
;

102 
c
->
bty³
 = btype;

103 
£rv”
.
bpİ_blocked_ş›Ás
++;

104 
	}
}

109 
	$´oûssUnblockedCl›Ás
() {

110 
li¡Node
 *
Ê
;

111 
ş›Á
 *
c
;

113 
	`li¡L’gth
(
£rv”
.
unblocked_ş›Ás
)) {

114 
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
unblocked_ş›Ás
);

115 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

116 
c
 = 
Ê
->
v®ue
;

117 
	`li¡D–Node
(
£rv”
.
unblocked_ş›Ás
,
Ê
);

118 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

124 ià(!(
c
->
æags
 & 
CLIENT_BLOCKED
)) {

125 ià(
c
->
qu”ybuf
 && 
	`sd¦’
(c->querybuf) > 0) {

126 
	`´oûssIÅutBufãr
(
c
);

130 
	}
}

134 
	$unblockCl›Á
(
ş›Á
 *
c
) {

135 ià(
c
->
bty³
 =ğ
BLOCKED_LIST
) {

136 
	`unblockCl›ÁWa™šgD©a
(
c
);

137 } ià(
c
->
bty³
 =ğ
BLOCKED_WAIT
) {

138 
	`unblockCl›ÁWa™šgR•liÿs
(
c
);

139 } ià(
c
->
bty³
 =ğ
BLOCKED_MODULE
) {

140 
	`unblockCl›ÁFromModuË
(
c
);

142 
	`£rv”Pªic
("Unknown btype in unblockClient().");

146 
c
->
æags
 &ğ~
CLIENT_BLOCKED
;

147 
c
->
bty³
 = 
BLOCKED_NONE
;

148 
£rv”
.
bpİ_blocked_ş›Ás
--;

151 ià(!(
c
->
æags
 & 
CLIENT_UNBLOCKED
)) {

152 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

153 
	`li¡AddNodeTa
(
£rv”
.
unblocked_ş›Ás
,
c
);

155 
	}
}

160 
	$»¶yToBlockedCl›ÁTimedOut
(
ş›Á
 *
c
) {

161 ià(
c
->
bty³
 =ğ
BLOCKED_LIST
) {

162 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

163 } ià(
c
->
bty³
 =ğ
BLOCKED_WAIT
) {

164 
	`addR•lyLÚgLÚg
(
c
,
	`»¶iÿtiÚCouÁAcksByOff£t
(c->
bpİ
.
»¶off£t
));

165 } ià(
c
->
bty³
 =ğ
BLOCKED_MODULE
) {

166 
	`moduËBlockedCl›ÁTimedOut
(
c
);

168 
	`£rv”Pªic
("Unknown btype in„eplyToBlockedClientTimedOut().");

170 
	}
}

179 
	$discÚÃùAÎBlockedCl›Ás
() {

180 
li¡Node
 *
Ê
;

181 
li¡I‹r
 
li
;

183 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

184 (
Ê
 = 
	`li¡Next
(&
li
))) {

185 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

187 ià(
c
->
æags
 & 
CLIENT_BLOCKED
) {

188 
	`addR•lySds
(
c
,
	`sd¢ew
(

191 
	`unblockCl›Á
(
c
);

192 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

195 
	}
}

	@src/childinfo.c

30 
	~"£rv”.h
"

31 
	~<uni¡d.h
>

36 
	$İ’ChdInfoPe
() {

37 ià(
	`pe
(
£rv”
.
chd_šfo_pe
) == -1) {

40 
	`şo£ChdInfoPe
();

41 } ià(
	`ª‘NÚBlock
(
NULL
,
£rv”
.
chd_šfo_pe
[0]è!ğ
ANET_OK
) {

42 
	`şo£ChdInfoPe
();

44 
	`mem£t
(&
£rv”
.
chd_šfo_d©a
,0,(server.child_info_data));

46 
	}
}

49 
	$şo£ChdInfoPe
() {

50 ià(
£rv”
.
chd_šfo_pe
[0] != -1 ||

51 
£rv”
.
chd_šfo_pe
[1] != -1)

53 
	`şo£
(
£rv”
.
chd_šfo_pe
[0]);

54 
	`şo£
(
£rv”
.
chd_šfo_pe
[1]);

55 
£rv”
.
chd_šfo_pe
[0] = -1;

56 
£rv”
.
chd_šfo_pe
[1] = -1;

58 
	}
}

62 
	$£ndChdInfo
(
±y³
) {

63 ià(
£rv”
.
chd_šfo_pe
[1] == -1) ;

64 
£rv”
.
chd_šfo_d©a
.
magic
 = 
CHILD_INFO_MAGIC
;

65 
£rv”
.
chd_šfo_d©a
.
´oûss_ty³
 = 
±y³
;

66 
ssize_t
 
wËn
 = (
£rv”
.
chd_šfo_d©a
);

67 ià(
	`wr™e
(
£rv”
.
chd_šfo_pe
[1],&£rv”.
chd_šfo_d©a
,
wËn
) != wlen) {

70 
	}
}

73 
	$»ûiveChdInfo
() {

74 ià(
£rv”
.
chd_šfo_pe
[0] == -1) ;

75 
ssize_t
 
wËn
 = (
£rv”
.
chd_šfo_d©a
);

76 ià(
	`»ad
(
£rv”
.
chd_šfo_pe
[0],&£rv”.
chd_šfo_d©a
,
wËn
) == wlen &&

77 
£rv”
.
chd_šfo_d©a
.
magic
 =ğ
CHILD_INFO_MAGIC
)

79 ià(
£rv”
.
chd_šfo_d©a
.
´oûss_ty³
 =ğ
CHILD_INFO_TYPE_RDB
) {

80 
£rv”
.
¡©_rdb_cow_by‹s
 = s”v”.
chd_šfo_d©a
.
cow_size
;

81 } ià(
£rv”
.
chd_šfo_d©a
.
´oûss_ty³
 =ğ
CHILD_INFO_TYPE_AOF
) {

82 
£rv”
.
¡©_aof_cow_by‹s
 = s”v”.
chd_šfo_d©a
.
cow_size
;

85 
	}
}

	@src/cluster.c

31 
	~"£rv”.h
"

32 
	~"şu¡”.h
"

33 
	~"’dŸncÚv.h
"

35 
	~<sys/ty³s.h
>

36 
	~<sys/sock‘.h
>

37 
	~<¬·/š‘.h
>

38 
	~<fú.h
>

39 
	~<uni¡d.h
>

40 
	~<sys/¡©.h
>

41 
	~<sys/fe.h
>

42 
	~<m©h.h
>

47 
şu¡”Node
 *
	gmy£lf
 = 
NULL
;

49 
şu¡”Node
 *
ü—‹Clu¡”Node
(*
nod’ame
, 
æags
);

50 
şu¡”AddNode
(
şu¡”Node
 *
node
);

51 
şu¡”Acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

52 
şu¡”R—dHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

53 
şu¡”S’dPšg
(
şu¡”Lšk
 *
lšk
, 
ty³
);

54 
şu¡”S’dFa
(*
nod’ame
);

55 
şu¡”S’dFaov”AuthIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Msg
 *
»que¡
);

56 
şu¡”Upd©eS‹
();

57 
şu¡”NodeG‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
);

58 
sds
 
şu¡”G’NodesDesütiÚ
(
f‹r
);

59 
şu¡”Node
 *
şu¡”LookupNode
(*
Çme
);

60 
şu¡”NodeAddSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
);

61 
şu¡”AddSlÙ
(
şu¡”Node
 *
n
, 
¦Ù
);

62 
şu¡”D–SlÙ
(
¦Ù
);

63 
şu¡”D–NodeSlÙs
(
şu¡”Node
 *
node
);

64 
şu¡”NodeS‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
);

65 
şu¡”S‘Ma¡”
(
şu¡”Node
 *
n
);

66 
şu¡”HªdËSÏveFaov”
();

67 
şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
);

68 
b™m­Te¡B™
(*
b™m­
, 
pos
);

69 
şu¡”DoBefÜeSË•
(
æags
);

70 
şu¡”S’dUpd©e
(
şu¡”Lšk
 *
lšk
, 
şu¡”Node
 *
node
);

71 
»£tMªu®Faov”
();

72 
şu¡”Clo£AÎSlÙs
();

73 
şu¡”S‘NodeAsMa¡”
(
şu¡”Node
 *
n
);

74 
şu¡”D–Node
(
şu¡”Node
 *
d–node
);

75 
sds
 
»´e£ÁClu¡”NodeFÏgs
(sd 
ci
, 
ušt16_t
 
æags
);

76 
ušt64_t
 
şu¡”G‘MaxEpoch
();

77 
şu¡”BumpCÚfigEpochW™houtCÚ£nsus
();

89 
	$şu¡”LßdCÚfig
(*
f’ame
) {

90 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r");

91 
¡©
 
sb
;

92 *
lše
;

93 
maxlše
, 
j
;

95 ià(
å
 =ğ
NULL
) {

96 ià(
”ºo
 =ğ
ENOENT
) {

97  
C_ERR
;

99 
	`£rv”Log
(
LL_WARNING
,

101 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

102 
	`ex™
(1);

108 ià(
	`f¡©
(
	`f’o
(
å
),&
sb
è!ğ-1 && sb.
¡_size
 == 0) {

109 
	`fşo£
(
å
);

110  
C_ERR
;

120 
maxlše
 = 1024+
CLUSTER_SLOTS
*128;

121 
lše
 = 
	`zm®loc
(
maxlše
);

122 
	`fg‘s
(
lše
,
maxlše
,
å
è!ğ
NULL
) {

123 
¬gc
;

124 
sds
 *
¬gv
;

125 
şu¡”Node
 *
n
, *
ma¡”
;

126 *
p
, *
s
;

131 ià(
lše
[0] == '\n' ||†ine[0] == '\0') ;

134 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

135 ià(
¬gv
 =ğ
NULL
è
fm‹¼
;

139 ià(
	`¡rÿ£cmp
(
¬gv
[0],"vars") == 0) {

140 
j
 = 1; j < 
¬gc
; j += 2) {

141 ià(
	`¡rÿ£cmp
(
¬gv
[
j
],"currentEpoch") == 0) {

142 
£rv”
.
şu¡”
->
cu¼’tEpoch
 =

143 
	`¡¹ouÎ
(
¬gv
[
j
+1],
NULL
,10);

144 } ià(
	`¡rÿ£cmp
(
¬gv
[
j
],"lastVoteEpoch") == 0) {

145 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 =

146 
	`¡¹ouÎ
(
¬gv
[
j
+1],
NULL
,10);

148 
	`£rv”Log
(
LL_WARNING
,

150 
¬gv
[
j
]);

153 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

158 ià(
¬gc
 < 8è
fm‹¼
;

161 
n
 = 
	`şu¡”LookupNode
(
¬gv
[0]);

162 ià(!
n
) {

163 
n
 = 
	`ü—‹Clu¡”Node
(
¬gv
[0],0);

164 
	`şu¡”AddNode
(
n
);

167 ià((
p
 = 
	`¡¼chr
(
¬gv
[1],':')è=ğ
NULL
è
fm‹¼
;

168 *
p
 = '\0';

169 
	`memıy
(
n
->

,
¬gv
[1],
	`¡¾’
(argv[1])+1);

170 *
pÜt
 = 
p
+1;

171 *
bu¥
 = 
	`¡rchr
(
pÜt
,'@');

172 ià(
bu¥
) {

173 *
bu¥
 = '\0';

174 
bu¥
++;

176 
n
->
pÜt
 = 
	`©oi
(port);

180 
n
->
ıÜt
 = 
bu¥
 ? 
	`©oi
(bu¥è:‚->
pÜt
 + 
CLUSTER_PORT_INCR
;

183 
p
 = 
s
 = 
¬gv
[2];

184 
p
) {

185 
p
 = 
	`¡rchr
(
s
,',');

186 ià(
p
) *p = '\0';

187 ià(!
	`¡rÿ£cmp
(
s
,"myself")) {

188 
	`£rv”As£¹
(
£rv”
.
şu¡”
->
my£lf
 =ğ
NULL
);

189 
my£lf
 = 
£rv”
.
şu¡”
->my£làğ
n
;

190 
n
->
æags
 |ğ
CLUSTER_NODE_MYSELF
;

191 } ià(!
	`¡rÿ£cmp
(
s
,"master")) {

192 
n
->
æags
 |ğ
CLUSTER_NODE_MASTER
;

193 } ià(!
	`¡rÿ£cmp
(
s
,"slave")) {

194 
n
->
æags
 |ğ
CLUSTER_NODE_SLAVE
;

195 } ià(!
	`¡rÿ£cmp
(
s
,"fail?")) {

196 
n
->
æags
 |ğ
CLUSTER_NODE_PFAIL
;

197 } ià(!
	`¡rÿ£cmp
(
s
,"fail")) {

198 
n
->
æags
 |ğ
CLUSTER_NODE_FAIL
;

199 
n
->
ç_time
 = 
	`m¡ime
();

200 } ià(!
	`¡rÿ£cmp
(
s
,"handshake")) {

201 
n
->
æags
 |ğ
CLUSTER_NODE_HANDSHAKE
;

202 } ià(!
	`¡rÿ£cmp
(
s
,"noaddr")) {

203 
n
->
æags
 |ğ
CLUSTER_NODE_NOADDR
;

204 } ià(!
	`¡rÿ£cmp
(
s
,"nofailover")) {

205 
n
->
æags
 |ğ
CLUSTER_NODE_NOFAILOVER
;

206 } ià(!
	`¡rÿ£cmp
(
s
,"noflags")) {

209 
	`£rv”Pªic
("Unknown flag in„edis cluster config file");

211 ià(
p
è
s
 =…+1;

216 ià(
¬gv
[3][0] != '-') {

217 
ma¡”
 = 
	`şu¡”LookupNode
(
¬gv
[3]);

218 ià(!
ma¡”
) {

219 
ma¡”
 = 
	`ü—‹Clu¡”Node
(
¬gv
[3],0);

220 
	`şu¡”AddNode
(
ma¡”
);

222 
n
->
¦aveof
 = 
ma¡”
;

223 
	`şu¡”NodeAddSÏve
(
ma¡”
,
n
);

227 ià(
	`©oi
(
¬gv
[4])è
n
->
pšg_£Á
 = 
	`m¡ime
();

228 ià(
	`©oi
(
¬gv
[5])è
n
->
pÚg_»ûived
 = 
	`m¡ime
();

231 
n
->
cÚfigEpoch
 = 
	`¡¹ouÎ
(
¬gv
[6],
NULL
,10);

234 
j
 = 8; j < 
¬gc
; j++) {

235 
¡¬t
, 
¡İ
;

237 ià(
¬gv
[
j
][0] == '[') {

239 
¦Ù
;

240 
dœeùiÚ
;

241 
şu¡”Node
 *
ú
;

243 
p
 = 
	`¡rchr
(
¬gv
[
j
],'-');

244 
	`£rv”As£¹
(
p
 !ğ
NULL
);

245 *
p
 = '\0';

246 
dœeùiÚ
 = 
p
[1];

247 
¦Ù
 = 
	`©oi
(
¬gv
[
j
]+1);

248 ià(
¦Ù
 < 0 || slÙ >ğ
CLUSTER_SLOTS
è
fm‹¼
;

249 
p
 += 3;

250 
ú
 = 
	`şu¡”LookupNode
(
p
);

251 ià(!
ú
) {

252 
ú
 = 
	`ü—‹Clu¡”Node
(
p
,0);

253 
	`şu¡”AddNode
(
ú
);

255 ià(
dœeùiÚ
 == '>') {

256 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
ú
;

258 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
ú
;

261 } ià((
p
 = 
	`¡rchr
(
¬gv
[
j
],'-')è!ğ
NULL
) {

262 *
p
 = '\0';

263 
¡¬t
 = 
	`©oi
(
¬gv
[
j
]);

264 
¡İ
 = 
	`©oi
(
p
+1);

266 
¡¬t
 = 
¡İ
 = 
	`©oi
(
¬gv
[
j
]);

268 ià(
¡¬t
 < 0 || s¹ >ğ
CLUSTER_SLOTS
è
fm‹¼
;

269 ià(
¡İ
 < 0 || stİ >ğ
CLUSTER_SLOTS
è
fm‹¼
;

270 
¡¬t
 <ğ
¡İ
è
	`şu¡”AddSlÙ
(
n
, start++);

273 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

276 ià(
£rv”
.
şu¡”
->
my£lf
 =ğ
NULL
è
fm‹¼
;

278 
	`zä“
(
lše
);

279 
	`fşo£
(
å
);

281 
	`£rv”Log
(
LL_NOTICE
,"NodcÚfigu¿tiÚ†ßded, I'm %.40s", 
my£lf
->
Çme
);

286 ià(
	`şu¡”G‘MaxEpoch
(è> 
£rv”
.
şu¡”
->
cu¼’tEpoch
) {

287 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
	`şu¡”G‘MaxEpoch
();

289  
C_OK
;

291 
fm‹¼
:

292 
	`£rv”Log
(
LL_WARNING
,

294 
	`zä“
(
lše
);

295 ià(
å
è
	`fşo£
(fp);

296 
	`ex™
(1);

297 
	}
}

311 
	$şu¡”SaveCÚfig
(
do_fsync
) {

312 
sds
 
ci
;

313 
size_t
 
cÚ‹Á_size
;

314 
¡©
 
sb
;

315 
fd
;

317 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_SAVE_CONFIG
;

321 
ci
 = 
	`şu¡”G’NodesDesütiÚ
(
CLUSTER_NODE_HANDSHAKE
);

322 
ci
 = 
	`sdsÿrštf
(ci,"vars currentEpoch %llu†astVoteEpoch %llu\n",

323 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
,

324 (è
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
);

325 
cÚ‹Á_size
 = 
	`sd¦’
(
ci
);

327 ià((
fd
 = 
	`İ’
(
£rv”
.
şu¡”_cÚfigfe
,
O_WRONLY
|
O_CREAT
,0644))

328 =ğ-1è
”r
;

331 ià(
	`f¡©
(
fd
,&
sb
) != -1) {

332 ià(
sb
.
¡_size
 > (
off_t
)
cÚ‹Á_size
) {

333 
ci
 = 
	`sdsgrowz”o
(ci,
sb
.
¡_size
);

334 
	`mem£t
(
ci
+
cÚ‹Á_size
,'\n',
sb
.
¡_size
-content_size);

337 ià(
	`wr™e
(
fd
,
ci
,
	`sd¦’
(ci)è!ğ(
ssize_t
)sd¦’(ci)è
”r
;

338 ià(
do_fsync
) {

339 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_FSYNC_CONFIG
;

340 
	`fsync
(
fd
);

345 ià(
cÚ‹Á_size
 !ğ
	`sd¦’
(
ci
è&& 
	`árunÿ‹
(
fd
,content_size) == -1) {

348 
	`şo£
(
fd
);

349 
	`sdsä“
(
ci
);

352 
”r
:

353 ià(
fd
 !ğ-1è
	`şo£
(fd);

354 
	`sdsä“
(
ci
);

356 
	}
}

358 
	$şu¡”SaveCÚfigOrD›
(
do_fsync
) {

359 ià(
	`şu¡”SaveCÚfig
(
do_fsync
) == -1) {

360 
	`£rv”Log
(
LL_WARNING
,"Fatal: can't update cluster config file.");

361 
	`ex™
(1);

363 
	}
}

374 
	$şu¡”LockCÚfig
(*
f’ame
) {

379 #ià!
	`defšed
(
__sun
)

383 
fd
 = 
	`İ’
(
f’ame
,
O_WRONLY
|
O_CREAT
,0644);

384 ià(
fd
 == -1) {

385 
	`£rv”Log
(
LL_WARNING
,

387 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

388  
C_ERR
;

391 ià(
	`æock
(
fd
,
LOCK_EX
|
LOCK_NB
) == -1) {

392 ià(
”ºo
 =ğ
EWOULDBLOCK
) {

393 
	`£rv”Log
(
LL_WARNING
,

397 "fes.", 
f’ame
);

399 
	`£rv”Log
(
LL_WARNING
,

400 "ImpossibËØlock %s: %s", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

402 
	`şo£
(
fd
);

403  
C_ERR
;

409  
C_OK
;

410 
	}
}

416 
	$şu¡”Upd©eMy£lfFÏgs
() {

417 
Şdæags
 = 
my£lf
->
æags
;

418 
noçov”
 = 
£rv”
.
şu¡”_¦ave_no_çov”
 ?

419 
CLUSTER_NODE_NOFAILOVER
 : 0;

420 
my£lf
->
æags
 &ğ~
CLUSTER_NODE_NOFAILOVER
;

421 
my£lf
->
æags
 |ğ
noçov”
;

422 ià(
my£lf
->
æags
 !ğ
Şdæags
) {

423 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

424 
CLUSTER_TODO_UPDATE_STATE
);

426 
	}
}

428 
	$şu¡”In™
() {

429 
§vecÚf
 = 0;

431 
£rv”
.
şu¡”
 = 
	`zm®loc
((
şu¡”S‹
));

432 
£rv”
.
şu¡”
->
my£lf
 = 
NULL
;

433 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 0;

434 
£rv”
.
şu¡”
->
¡©e
 = 
CLUSTER_FAIL
;

435 
£rv”
.
şu¡”
->
size
 = 1;

436 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 = 0;

437 
£rv”
.
şu¡”
->
nodes
 = 
	`diùC»©e
(&
şu¡”NodesDiùTy³
,
NULL
);

438 
£rv”
.
şu¡”
->
nodes_bÏck_li¡
 =

439 
	`diùC»©e
(&
şu¡”NodesBÏckLi¡DiùTy³
,
NULL
);

440 
£rv”
.
şu¡”
->
çov”_auth_time
 = 0;

441 
£rv”
.
şu¡”
->
çov”_auth_couÁ
 = 0;

442 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 0;

443 
£rv”
.
şu¡”
->
çov”_auth_•och
 = 0;

444 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
CLUSTER_CANT_FAILOVER_NONE
;

445 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = 0;

446 
i
 = 0; i < 
CLUSTERMSG_TYPE_COUNT
; i++) {

447 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
[
i
] = 0;

448 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
[
i
] = 0;

450 
£rv”
.
şu¡”
->
¡©s_pç_nodes
 = 0;

451 
	`mem£t
(
£rv”
.
şu¡”
->
¦Ùs
,0, (server.cluster->slots));

452 
	`şu¡”Clo£AÎSlÙs
();

456 ià(
	`şu¡”LockCÚfig
(
£rv”
.
şu¡”_cÚfigfe
è=ğ
C_ERR
)

457 
	`ex™
(1);

460 ià(
	`şu¡”LßdCÚfig
(
£rv”
.
şu¡”_cÚfigfe
è=ğ
C_ERR
) {

463 
my£lf
 = 
£rv”
.
şu¡”
->myself =

464 
	`ü—‹Clu¡”Node
(
NULL
,
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_MASTER
);

465 
	`£rv”Log
(
LL_NOTICE
,"No cluster configuration found, I'm %.40s",

466 
my£lf
->
Çme
);

467 
	`şu¡”AddNode
(
my£lf
);

468 
§vecÚf
 = 1;

470 ià(
§vecÚf
è
	`şu¡”SaveCÚfigOrD›
(1);

473 
£rv”
.
cfd_couÁ
 = 0;

478 ià(
£rv”
.
pÜt
 > (65535-
CLUSTER_PORT_INCR
)) {

479 
	`£rv”Log
(
LL_WARNING
, "Redis…ort‚umberoo high. "

484 
	`ex™
(1);

487 ià(
	`li¡’ToPÜt
(
£rv”
.
pÜt
+
CLUSTER_PORT_INCR
,

488 
£rv”
.
cfd
,&£rv”.
cfd_couÁ
è=ğ
C_ERR
)

490 
	`ex™
(1);

492 
j
;

494 
j
 = 0; j < 
£rv”
.
cfd_couÁ
; j++) {

495 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
cfd
[
j
], 
AE_READABLE
,

496 
şu¡”Acû±HªdËr
, 
NULL
è=ğ
AE_ERR
)

497 
	`£rv”Pªic
("Unrecoverableƒrror creating Redis Cluster "

503 
£rv”
.
şu¡”
->
¦Ùs_to_keys
 = 
	`¿xNew
();

504 
	`mem£t
(
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
,0,

505 (
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
));

509 
my£lf
->
pÜt
 = 
£rv”
.port;

510 
my£lf
->
ıÜt
 = 
£rv”
.
pÜt
+
CLUSTER_PORT_INCR
;

511 ià(
£rv”
.
şu¡”_ªnounû_pÜt
)

512 
my£lf
->
pÜt
 = 
£rv”
.
şu¡”_ªnounû_pÜt
;

513 ià(
£rv”
.
şu¡”_ªnounû_bus_pÜt
)

514 
my£lf
->
ıÜt
 = 
£rv”
.
şu¡”_ªnounû_bus_pÜt
;

516 
£rv”
.
şu¡”
->
mf_’d
 = 0;

517 
	`»£tMªu®Faov”
();

518 
	`şu¡”Upd©eMy£lfFÏgs
();

519 
	}
}

530 
	$şu¡”Re£t
(
h¬d
) {

531 
diùI‹¿tÜ
 *
di
;

532 
diùEÁry
 *
de
;

533 
j
;

536 ià(
	`nodeIsSÏve
(
my£lf
)) {

537 
	`şu¡”S‘NodeAsMa¡”
(
my£lf
);

538 
	`»¶iÿtiÚUn£tMa¡”
();

539 
	`em±yDb
(-1,
EMPTYDB_NO_FLAGS
,
NULL
);

543 
	`şu¡”Clo£AÎSlÙs
();

544 
	`»£tMªu®Faov”
();

547 
j
 = 0; j < 
CLUSTER_SLOTS
; j++è
	`şu¡”D–SlÙ
(j);

550 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

551 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

552 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

554 ià(
node
 =ğ
my£lf
) ;

555 
	`şu¡”D–Node
(
node
);

557 
	`diùR–—£I‹¿tÜ
(
di
);

560 ià(
h¬d
) {

561 
sds
 
ŞdÇme
;

563 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 0;

564 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = 0;

565 
my£lf
->
cÚfigEpoch
 = 0;

566 
	`£rv”Log
(
LL_WARNING
, "configEpoch seto 0 via CLUSTER RESET HARD");

570 
ŞdÇme
 = 
	`sd¢ewËn
(
my£lf
->
Çme
, 
CLUSTER_NAMELEN
);

571 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
,
ŞdÇme
);

572 
	`sdsä“
(
ŞdÇme
);

573 
	`g‘RªdomHexCh¬s
(
my£lf
->
Çme
, 
CLUSTER_NAMELEN
);

574 
	`şu¡”AddNode
(
my£lf
);

575 
	`£rv”Log
(
LL_NOTICE
,"Nodh¬d„e£t,‚ow I'm %.40s", 
my£lf
->
Çme
);

579 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

580 
CLUSTER_TODO_UPDATE_STATE
|

581 
CLUSTER_TODO_FSYNC_CONFIG
);

582 
	}
}

588 
şu¡”Lšk
 *
	$ü—‹Clu¡”Lšk
(
şu¡”Node
 *
node
) {

589 
şu¡”Lšk
 *
lšk
 = 
	`zm®loc
((*link));

590 
lšk
->
ùime
 = 
	`m¡ime
();

591 
lšk
->
¢dbuf
 = 
	`sd£m±y
();

592 
lšk
->
rcvbuf
 = 
	`sd£m±y
();

593 
lšk
->
node
 =‚ode;

594 
lšk
->
fd
 = -1;

595  
lšk
;

596 
	}
}

601 
	$ä“Clu¡”Lšk
(
şu¡”Lšk
 *
lšk
) {

602 ià(
lšk
->
fd
 != -1) {

603 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_WRITABLE
);

604 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_READABLE
);

606 
	`sdsä“
(
lšk
->
¢dbuf
);

607 
	`sdsä“
(
lšk
->
rcvbuf
);

608 ià(
lšk
->
node
)

609 
lšk
->
node
->lšk = 
NULL
;

610 
	`şo£
(
lšk
->
fd
);

611 
	`zä“
(
lšk
);

612 
	}
}

614 
	#MAX_CLUSTER_ACCEPTS_PER_CALL
 1000

	)

615 
	$şu¡”Acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

616 
ıÜt
, 
cfd
;

617 
max
 = 
MAX_CLUSTER_ACCEPTS_PER_CALL
;

618 
c
[
NET_IP_STR_LEN
];

619 
şu¡”Lšk
 *
lšk
;

620 
	`UNUSED
(
–
);

621 
	`UNUSED
(
mask
);

622 
	`UNUSED
(
´ivd©a
);

626 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 && s”v”.
lßdšg
) ;

628 
max
--) {

629 
cfd
 = 
	`ª‘TıAcû±
(
£rv”
.
Ã‹¼
, 
fd
, 
c
, (c), &
ıÜt
);

630 ià(
cfd
 =ğ
ANET_ERR
) {

631 ià(
”ºo
 !ğ
EWOULDBLOCK
)

632 
	`£rv”Log
(
LL_VERBOSE
,

633 "E¼Ü‡cû±šg clu¡”‚ode: %s", 
£rv”
.
Ã‹¼
);

636 
	`ª‘NÚBlock
(
NULL
,
cfd
);

637 
	`ª‘EÇbËTıNoD–ay
(
NULL
,
cfd
);

640 
	`£rv”Log
(
LL_VERBOSE
,"Acû±ed clu¡”‚od%s:%d", 
c
, 
ıÜt
);

646 
lšk
 = 
	`ü—‹Clu¡”Lšk
(
NULL
);

647 
lšk
->
fd
 = 
cfd
;

648 
	`«C»©eFeEv’t
(
£rv”
.
–
,
cfd
,
AE_READABLE
,
şu¡”R—dHªdËr
,
lšk
);

650 
	}
}

662 
	$keyHashSlÙ
(*
key
, 
keyËn
) {

663 
s
, 
e
;

665 
s
 = 0; s < 
keyËn
; s++)

666 ià(
key
[
s
] == '{') ;

669 ià(
s
 =ğ
keyËn
è 
	`üc16
(
key
,keylen) & 0x3FFF;

672 
e
 = 
s
+1;ƒ < 
keyËn
;ƒ++)

673 ià(
key
[
e
] == '}') ;

676 ià(
e
 =ğ
keyËn
 ||ƒ =ğ
s
+1è 
	`üc16
(
key
,keylen) & 0x3FFF;

680  
	`üc16
(
key
+
s
+1,
e
-s-1) & 0x3FFF;

681 
	}
}

694 
şu¡”Node
 *
	$ü—‹Clu¡”Node
(*
nod’ame
, 
æags
) {

695 
şu¡”Node
 *
node
 = 
	`zm®loc
((*node));

697 ià(
nod’ame
)

698 
	`memıy
(
node
->
Çme
, 
nod’ame
, 
CLUSTER_NAMELEN
);

700 
	`g‘RªdomHexCh¬s
(
node
->
Çme
, 
CLUSTER_NAMELEN
);

701 
node
->
ùime
 = 
	`m¡ime
();

702 
node
->
cÚfigEpoch
 = 0;

703 
node
->
æags
 = flags;

704 
	`mem£t
(
node
->
¦Ùs
,0,(node->slots));

705 
node
->
num¦Ùs
 = 0;

706 
node
->
num¦aves
 = 0;

707 
node
->
¦aves
 = 
NULL
;

708 
node
->
¦aveof
 = 
NULL
;

709 
node
->
pšg_£Á
 =‚ode->
pÚg_»ûived
 = 0;

710 
node
->
ç_time
 = 0;

711 
node
->
lšk
 = 
NULL
;

712 
	`mem£t
(
node
->

,0,(node->ip));

713 
node
->
pÜt
 = 0;

714 
node
->
ıÜt
 = 0;

715 
node
->
ç_»pÜts
 = 
	`li¡C»©e
();

716 
node
->
vÙed_time
 = 0;

717 
node
->
Üphªed_time
 = 0;

718 
node
->
»¶_off£t_time
 = 0;

719 
node
->
»¶_off£t
 = 0;

720 
	`li¡S‘F»eM‘hod
(
node
->
ç_»pÜts
,
zä“
);

721  
node
;

722 
	}
}

734 
	$şu¡”NodeAddFau»R•Üt
(
şu¡”Node
 *
çšg
, clu¡”Nod*
£nd”
) {

735 
li¡
 *
l
 = 
çšg
->
ç_»pÜts
;

736 
li¡Node
 *
Ê
;

737 
li¡I‹r
 
li
;

738 
şu¡”NodeFaR•Üt
 *
ä
;

742 
	`li¡Rewšd
(
l
,&
li
);

743 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

744 
ä
 = 
Ê
->
v®ue
;

745 ià(
ä
->
node
 =ğ
£nd”
) {

746 
ä
->
time
 = 
	`m¡ime
();

752 
ä
 = 
	`zm®loc
((*fr));

753 
ä
->
node
 = 
£nd”
;

754 
ä
->
time
 = 
	`m¡ime
();

755 
	`li¡AddNodeTa
(
l
,
ä
);

757 
	}
}

764 
	$şu¡”NodeCËªupFau»R•Üts
(
şu¡”Node
 *
node
) {

765 
li¡
 *
l
 = 
node
->
ç_»pÜts
;

766 
li¡Node
 *
Ê
;

767 
li¡I‹r
 
li
;

768 
şu¡”NodeFaR•Üt
 *
ä
;

769 
m¡ime_t
 
maxtime
 = 
£rv”
.
şu¡”_node_timeout
 *

770 
CLUSTER_FAIL_REPORT_VALIDITY_MULT
;

771 
m¡ime_t
 
now
 = 
	`m¡ime
();

773 
	`li¡Rewšd
(
l
,&
li
);

774 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

775 
ä
 = 
Ê
->
v®ue
;

776 ià(
now
 - 
ä
->
time
 > 
maxtime
è
	`li¡D–Node
(
l
,
Ê
);

778 
	}
}

791 
	$şu¡”NodeD–Fau»R•Üt
(
şu¡”Node
 *
node
, clu¡”Nod*
£nd”
) {

792 
li¡
 *
l
 = 
node
->
ç_»pÜts
;

793 
li¡Node
 *
Ê
;

794 
li¡I‹r
 
li
;

795 
şu¡”NodeFaR•Üt
 *
ä
;

798 
	`li¡Rewšd
(
l
,&
li
);

799 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

800 
ä
 = 
Ê
->
v®ue
;

801 ià(
ä
->
node
 =ğ
£nd”
) ;

803 ià(!
Ê
)  0;

806 
	`li¡D–Node
(
l
,
Ê
);

807 
	`şu¡”NodeCËªupFau»R•Üts
(
node
);

809 
	}
}

814 
	$şu¡”NodeFau»R•ÜtsCouÁ
(
şu¡”Node
 *
node
) {

815 
	`şu¡”NodeCËªupFau»R•Üts
(
node
);

816  
	`li¡L’gth
(
node
->
ç_»pÜts
);

817 
	}
}

819 
	$şu¡”NodeRemoveSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
) {

820 
j
;

822 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++) {

823 ià(
ma¡”
->
¦aves
[
j
] =ğ
¦ave
) {

824 ià((
j
+1è< 
ma¡”
->
num¦aves
) {

825 
»maššg_¦aves
 = (
ma¡”
->
num¦aves
 - 
j
) - 1;

826 
	`memmove
(
ma¡”
->
¦aves
+
j
,master->slaves+(j+1),

827 ((*
ma¡”
->
¦aves
è* 
»maššg_¦aves
));

829 
ma¡”
->
num¦aves
--;

830 ià(
ma¡”
->
num¦aves
 == 0)

831 
ma¡”
->
æags
 &ğ~
CLUSTER_NODE_MIGRATE_TO
;

832  
C_OK
;

835  
C_ERR
;

836 
	}
}

838 
	$şu¡”NodeAddSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
) {

839 
j
;

842 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++)

843 ià(
ma¡”
->
¦aves
[
j
] =ğ
¦ave
è 
C_ERR
;

844 
ma¡”
->
¦aves
 = 
	`z»®loc
(master->slaves,

845 (
şu¡”Node
*)*(
ma¡”
->
num¦aves
+1));

846 
ma¡”
->
¦aves
[ma¡”->
num¦aves
] = 
¦ave
;

847 
ma¡”
->
num¦aves
++;

848 
ma¡”
->
æags
 |ğ
CLUSTER_NODE_MIGRATE_TO
;

849  
C_OK
;

850 
	}
}

852 
	$şu¡”CouÁNÚFašgSÏves
(
şu¡”Node
 *
n
) {

853 
j
, 
ok¦aves
 = 0;

855 
j
 = 0; j < 
n
->
num¦aves
; j++)

856 ià(!
	`nodeFaed
(
n
->
¦aves
[
j
])è
ok¦aves
++;

857  
ok¦aves
;

858 
	}
}

861 
	$ä“Clu¡”Node
(
şu¡”Node
 *
n
) {

862 
sds
 
nod’ame
;

863 
j
;

867 
j
 = 0; j < 
n
->
num¦aves
; j++)

868 
n
->
¦aves
[
j
]->
¦aveof
 = 
NULL
;

871 ià(
	`nodeIsSÏve
(
n
è&&‚->
¦aveof
è
	`şu¡”NodeRemoveSÏve
(n->slaveof,n);

874 
nod’ame
 = 
	`sd¢ewËn
(
n
->
Çme
, 
CLUSTER_NAMELEN
);

875 
	`£rv”As£¹
(
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
,
nod’ame
è=ğ
DICT_OK
);

876 
	`sdsä“
(
nod’ame
);

879 ià(
n
->
lšk
è
	`ä“Clu¡”Lšk
(n->link);

880 
	`li¡R–—£
(
n
->
ç_»pÜts
);

881 
	`zä“
(
n
->
¦aves
);

882 
	`zä“
(
n
);

883 
	}
}

886 
	$şu¡”AddNode
(
şu¡”Node
 *
node
) {

887 
»tv®
;

889 
»tv®
 = 
	`diùAdd
(
£rv”
.
şu¡”
->
nodes
,

890 
	`sd¢ewËn
(
node
->
Çme
,
CLUSTER_NAMELEN
),‚ode);

891  (
»tv®
 =ğ
DICT_OK
è? 
C_OK
 : 
C_ERR
;

892 
	}
}

905 
	$şu¡”D–Node
(
şu¡”Node
 *
d–node
) {

906 
j
;

907 
diùI‹¿tÜ
 *
di
;

908 
diùEÁry
 *
de
;

911 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

912 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] =ğ
d–node
)

913 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = 
NULL
;

914 ià(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
] =ğ
d–node
)

915 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
] = 
NULL
;

916 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
d–node
)

917 
	`şu¡”D–SlÙ
(
j
);

921 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

922 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

923 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

925 ià(
node
 =ğ
d–node
) ;

926 
	`şu¡”NodeD–Fau»R•Üt
(
node
,
d–node
);

928 
	`diùR–—£I‹¿tÜ
(
di
);

931 
	`ä“Clu¡”Node
(
d–node
);

932 
	}
}

935 
şu¡”Node
 *
	$şu¡”LookupNode
(*
Çme
) {

936 
sds
 
s
 = 
	`sd¢ewËn
(
Çme
, 
CLUSTER_NAMELEN
);

937 
diùEÁry
 *
de
;

939 
de
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes
,
s
);

940 
	`sdsä“
(
s
);

941 ià(
de
 =ğ
NULL
)  NULL;

942  
	`diùG‘V®
(
de
);

943 
	}
}

949 
	$şu¡”R’ameNode
(
şu¡”Node
 *
node
, *
ÃwÇme
) {

950 
»tv®
;

951 
sds
 
s
 = 
	`sd¢ewËn
(
node
->
Çme
, 
CLUSTER_NAMELEN
);

953 
	`£rv”Log
(
LL_DEBUG
,"Renaming‚ode %.40s into %.40s",

954 
node
->
Çme
, 
ÃwÇme
);

955 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
, 
s
);

956 
	`sdsä“
(
s
);

957 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

958 
	`memıy
(
node
->
Çme
, 
ÃwÇme
, 
CLUSTER_NAMELEN
);

959 
	`şu¡”AddNode
(
node
);

960 
	}
}

968 
ušt64_t
 
	$şu¡”G‘MaxEpoch
() {

969 
ušt64_t
 
max
 = 0;

970 
diùI‹¿tÜ
 *
di
;

971 
diùEÁry
 *
de
;

973 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

974 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

975 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

976 ià(
node
->
cÚfigEpoch
 > 
max
) max =‚ode->configEpoch;

978 
	`diùR–—£I‹¿tÜ
(
di
);

979 ià(
max
 < 
£rv”
.
şu¡”
->
cu¼’tEpoch
) max = server.cluster->currentEpoch;

980  
max
;

981 
	}
}

1012 
	$şu¡”BumpCÚfigEpochW™houtCÚ£nsus
() {

1013 
ušt64_t
 
maxEpoch
 = 
	`şu¡”G‘MaxEpoch
();

1015 ià(
my£lf
->
cÚfigEpoch
 == 0 ||

1016 
my£lf
->
cÚfigEpoch
 !ğ
maxEpoch
)

1018 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

1019 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
cu¼’tEpoch
;

1020 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1021 
CLUSTER_TODO_FSYNC_CONFIG
);

1022 
	`£rv”Log
(
LL_WARNING
,

1024 (è
my£lf
->
cÚfigEpoch
);

1025  
C_OK
;

1027  
C_ERR
;

1029 
	}
}

1077 
	$şu¡”HªdËCÚfigEpochCŞlisiÚ
(
şu¡”Node
 *
£nd”
) {

1079 ià(
£nd”
->
cÚfigEpoch
 !ğ
my£lf
->configEpoch ||

1080 !
	`nodeIsMa¡”
(
£nd”
è|| !nodeIsMa¡”(
my£lf
)) ;

1082 ià(
	`memcmp
(
£nd”
->
Çme
,
my£lf
->Çme,
CLUSTER_NAMELEN
) <= 0) ;

1084 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

1085 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
cu¼’tEpoch
;

1086 
	`şu¡”SaveCÚfigOrD›
(1);

1087 
	`£rv”Log
(
LL_VERBOSE
,

1090 
£nd”
->
Çme
,

1091 (è
my£lf
->
cÚfigEpoch
);

1092 
	}
}

1116 
	#CLUSTER_BLACKLIST_TTL
 60

	)

1125 
	$şu¡”BÏckli¡CËªup
() {

1126 
diùI‹¿tÜ
 *
di
;

1127 
diùEÁry
 *
de
;

1129 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
);

1130 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1131 
št64_t
 
expœe
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

1133 ià(
expœe
 < 
£rv”
.
unixtime
)

1134 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
	`diùG‘Key
(
de
));

1136 
	`diùR–—£I‹¿tÜ
(
di
);

1137 
	}
}

1140 
	$şu¡”BÏckli¡AddNode
(
şu¡”Node
 *
node
) {

1141 
diùEÁry
 *
de
;

1142 
sds
 
id
 = 
	`sd¢ewËn
(
node
->
Çme
,
CLUSTER_NAMELEN
);

1144 
	`şu¡”BÏckli¡CËªup
();

1145 ià(
	`diùAdd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
,
NULL
è=ğ
DICT_OK
) {

1148 
id
 = 
	`sdsdup
(id);

1150 
de
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
);

1151 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,
	`time
(
NULL
)+
CLUSTER_BLACKLIST_TTL
);

1152 
	`sdsä“
(
id
);

1153 
	}
}

1158 
	$şu¡”BÏckli¡Exi¡s
(*
nodeid
) {

1159 
sds
 
id
 = 
	`sd¢ewËn
(
nodeid
,
CLUSTER_NAMELEN
);

1160 
»tv®
;

1162 
	`şu¡”BÏckli¡CËªup
();

1163 
»tv®
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
è!ğ
NULL
;

1164 
	`sdsä“
(
id
);

1165  
»tv®
;

1166 
	}
}

1193 
	$m¬kNodeAsFašgIfN“ded
(
şu¡”Node
 *
node
) {

1194 
çu»s
;

1195 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

1197 ià(!
	`nodeTimedOut
(
node
)) ;

1198 ià(
	`nodeFaed
(
node
)) ;

1200 
çu»s
 = 
	`şu¡”NodeFau»R•ÜtsCouÁ
(
node
);

1202 ià(
	`nodeIsMa¡”
(
my£lf
)è
çu»s
++;

1203 ià(
çu»s
 < 
Ãeded_quÜum
) ;

1205 
	`£rv”Log
(
LL_NOTICE
,

1206 "M¬kšg‚od%.40 a çšg (quÜum„—ched).", 
node
->
Çme
);

1209 
node
->
æags
 &ğ~
CLUSTER_NODE_PFAIL
;

1210 
node
->
æags
 |ğ
CLUSTER_NODE_FAIL
;

1211 
node
->
ç_time
 = 
	`m¡ime
();

1215 ià(
	`nodeIsMa¡”
(
my£lf
)è
	`şu¡”S’dFa
(
node
->
Çme
);

1216 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1217 
	}
}

1222 
	$ş—rNodeFau»IfN“ded
(
şu¡”Node
 *
node
) {

1223 
m¡ime_t
 
now
 = 
	`m¡ime
();

1225 
	`£rv”As£¹
(
	`nodeFaed
(
node
));

1229 ià(
	`nodeIsSÏve
(
node
è||‚ode->
num¦Ùs
 == 0) {

1230 
	`£rv”Log
(
LL_NOTICE
,

1232 
node
->
Çme
,

1233 
	`nodeIsSÏve
(
node
) ? "slave" : "master without slots");

1234 
node
->
æags
 &ğ~
CLUSTER_NODE_FAIL
;

1235 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1242 ià(
	`nodeIsMa¡”
(
node
è&&‚ode->
num¦Ùs
 > 0 &&

1243 (
now
 - 
node
->
ç_time
) >

1244 (
£rv”
.
şu¡”_node_timeout
 * 
CLUSTER_FAIL_UNDO_TIME_MULT
))

1246 
	`£rv”Log
(
LL_NOTICE
,

1248 
node
->
Çme
);

1249 
node
->
æags
 &ğ~
CLUSTER_NODE_FAIL
;

1250 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1252 
	}
}

1257 
	$şu¡”HªdshakeInProg»ss
(*

, 
pÜt
, 
ıÜt
) {

1258 
diùI‹¿tÜ
 *
di
;

1259 
diùEÁry
 *
de
;

1261 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

1262 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1263 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

1265 ià(!
	`nodeInHªdshake
(
node
)) ;

1266 ià(!
	`¡rÿ£cmp
(
node
->

,ip) &&

1267 
node
->
pÜt
 ==…ort &&

1268 
node
->
ıÜt
 == cport) ;

1270 
	`diùR–—£I‹¿tÜ
(
di
);

1271  
de
 !ğ
NULL
;

1272 
	}
}

1281 
	$şu¡”S¹Hªdshake
(*

, 
pÜt
, 
ıÜt
) {

1282 
şu¡”Node
 *
n
;

1283 
nÜm_
[
NET_IP_STR_LEN
];

1284 
sockaddr_¡Üage
 
§
;

1287 ià(
	`š‘_±Ú
(
AF_INET
,

,

1288 &(((
sockaddr_š
 *)&
§
)->
sš_addr
)))

1290 
§
.
ss_çmy
 = 
AF_INET
;

1291 } ià(
	`š‘_±Ú
(
AF_INET6
,

,

1292 &(((
sockaddr_š6
 *)&
§
)->
sš6_addr
)))

1294 
§
.
ss_çmy
 = 
AF_INET6
;

1296 
”ºo
 = 
EINVAL
;

1301 ià(
pÜt
 <ğ0 ||…Üˆ> 65535 || 
ıÜt
 <= 0 || cport > 65535) {

1302 
”ºo
 = 
EINVAL
;

1308 
	`mem£t
(
nÜm_
,0,
NET_IP_STR_LEN
);

1309 ià(
§
.
ss_çmy
 =ğ
AF_INET
)

1310 
	`š‘_Áİ
(
AF_INET
,

1311 (*)&(((
sockaddr_š
 *)&
§
)->
sš_addr
),

1312 
nÜm_
,
NET_IP_STR_LEN
);

1314 
	`š‘_Áİ
(
AF_INET6
,

1315 (*)&(((
sockaddr_š6
 *)&
§
)->
sš6_addr
),

1316 
nÜm_
,
NET_IP_STR_LEN
);

1318 ià(
	`şu¡”HªdshakeInProg»ss
(
nÜm_
,
pÜt
,
ıÜt
)) {

1319 
”ºo
 = 
EAGAIN
;

1326 
n
 = 
	`ü—‹Clu¡”Node
(
NULL
,
CLUSTER_NODE_HANDSHAKE
|
CLUSTER_NODE_MEET
);

1327 
	`memıy
(
n
->

,
nÜm_
,(n->ip));

1328 
n
->
pÜt
 =…ort;

1329 
n
->
ıÜt
 = cport;

1330 
	`şu¡”AddNode
(
n
);

1332 
	}
}

1338 
	$şu¡”ProûssGossSeùiÚ
(
şu¡”Msg
 *
hdr
, 
şu¡”Lšk
 *
lšk
) {

1339 
ušt16_t
 
couÁ
 = 
	`Áohs
(
hdr
->count);

1340 
şu¡”MsgD©aGoss
 *
g
 = (şu¡”MsgD©aGoss*è
hdr
->
d©a
.
pšg
.
goss
;

1341 
şu¡”Node
 *
£nd”
 = 
lšk
->
node
 ?†šk->nod: 
	`şu¡”LookupNode
(
hdr
->sender);

1343 
couÁ
--) {

1344 
ušt16_t
 
æags
 = 
	`Áohs
(
g
->flags);

1345 
şu¡”Node
 *
node
;

1346 
sds
 
ci
;

1348 ià(
£rv”
.
v”bos™y
 =ğ
LL_DEBUG
) {

1349 
ci
 = 
	`»´e£ÁClu¡”NodeFÏgs
(
	`sd£m±y
(), 
æags
);

1350 
	`£rv”Log
(
LL_DEBUG
,"GOSSIP %.40s %s:%d@%d %s",

1351 
g
->
nod’ame
,

1352 
g
->

,

1353 
	`Áohs
(
g
->
pÜt
),

1354 
	`Áohs
(
g
->
ıÜt
),

1355 
ci
);

1356 
	`sdsä“
(
ci
);

1360 
node
 = 
	`şu¡”LookupNode
(
g
->
nod’ame
);

1361 ià(
node
) {

1364 ià(
£nd”
 && 
	`nodeIsMa¡”
(£nd”è&& 
node
 !ğ
my£lf
) {

1365 ià(
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
)) {

1366 ià(
	`şu¡”NodeAddFau»R•Üt
(
node
,
£nd”
)) {

1367 
	`£rv”Log
(
LL_VERBOSE
,

1369 
£nd”
->
Çme
, 
node
->name);

1371 
	`m¬kNodeAsFašgIfN“ded
(
node
);

1373 ià(
	`şu¡”NodeD–Fau»R•Üt
(
node
,
£nd”
)) {

1374 
	`£rv”Log
(
LL_VERBOSE
,

1376 
£nd”
->
Çme
, 
node
->name);

1385 ià(!(
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
)) &&

1386 
node
->
pšg_£Á
 == 0 &&

1387 
	`şu¡”NodeFau»R•ÜtsCouÁ
(
node
) == 0)

1389 
m¡ime_t
 
pÚgtime
 = 
	`Áohl
(
g
->
pÚg_»ûived
);

1390 
pÚgtime
 *= 1000;

1396 ià(
pÚgtime
 <ğ(
£rv”
.
m¡ime
+500) &&

1397 
pÚgtime
 > 
node
->
pÚg_»ûived
)

1399 
node
->
pÚg_»ûived
 = 
pÚgtime
;

1408 ià(
node
->
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
) &&

1409 !(
æags
 & 
CLUSTER_NODE_NOADDR
) &&

1410 !(
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
)) &&

1411 (
	`¡rÿ£cmp
(
node
->

,
g
->ip) ||

1412 
node
->
pÜt
 !ğ
	`Áohs
(
g
->port) ||

1413 
node
->
ıÜt
 !ğ
	`Áohs
(
g
->cport)))

1415 ià(
node
->
lšk
è
	`ä“Clu¡”Lšk
(node->link);

1416 
	`memıy
(
node
->

,
g
->,
NET_IP_STR_LEN
);

1417 
node
->
pÜt
 = 
	`Áohs
(
g
->port);

1418 
node
->
ıÜt
 = 
	`Áohs
(
g
->cport);

1419 
node
->
æags
 &ğ~
CLUSTER_NODE_NOADDR
;

1428 ià(
£nd”
 &&

1429 !(
æags
 & 
CLUSTER_NODE_NOADDR
) &&

1430 !
	`şu¡”BÏckli¡Exi¡s
(
g
->
nod’ame
))

1432 
	`şu¡”S¹Hªdshake
(
g
->

,
	`Áohs
(g->
pÜt
),Áohs(g->
ıÜt
));

1437 
g
++;

1439 
	}
}

1444 
	$nodeIp2SŒšg
(*
buf
, 
şu¡”Lšk
 *
lšk
, *
ªnounûd_
) {

1445 ià(
ªnounûd_
[0] != '\0') {

1446 
	`memıy
(
buf
,
ªnounûd_
,
NET_IP_STR_LEN
);

1447 
buf
[
NET_IP_STR_LEN
-1] = '\0';

1449 
	`ª‘P“rToSŒšg
(
lšk
->
fd
, 
buf
, 
NET_IP_STR_LEN
, 
NULL
);

1451 
	}
}

1465 
	$nodeUpd©eAdd»ssIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Lšk
 *
lšk
,

1466 
şu¡”Msg
 *
hdr
)

1468 

[
NET_IP_STR_LEN
] = {0};

1469 
pÜt
 = 
	`Áohs
(
hdr
->port);

1470 
ıÜt
 = 
	`Áohs
(
hdr
->cport);

1478 ià(
lšk
 =ğ
node
->link)  0;

1480 
	`nodeIp2SŒšg
(

,
lšk
,
hdr
->
my
);

1481 ià(
node
->
pÜt
 =ğpÜˆ&&‚ode->
ıÜt
 == cport &&

1482 
	`¡rcmp
(

,
node
->ip) == 0)  0;

1485 
	`memıy
(
node
->

,ip,(ip));

1486 
node
->
pÜt
 =…ort;

1487 
node
->
ıÜt
 = cport;

1488 ià(
node
->
lšk
è
	`ä“Clu¡”Lšk
(node->link);

1489 
node
->
æags
 &ğ~
CLUSTER_NODE_NOADDR
;

1490 
	`£rv”Log
(
LL_WARNING
,"Address updated for‚ode %.40s,‚ow %s:%d",

1491 
node
->
Çme
,‚ode->

,‚ode->
pÜt
);

1495 ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
node
)

1496 
	`»¶iÿtiÚS‘Ma¡”
(
node
->

,‚ode->
pÜt
);

1498 
	}
}

1503 
	$şu¡”S‘NodeAsMa¡”
(
şu¡”Node
 *
n
) {

1504 ià(
	`nodeIsMa¡”
(
n
)) ;

1506 ià(
n
->
¦aveof
) {

1507 
	`şu¡”NodeRemoveSÏve
(
n
->
¦aveof
,n);

1508 ià(
n
 !ğ
my£lf
èn->
æags
 |ğ
CLUSTER_NODE_MIGRATE_TO
;

1510 
n
->
æags
 &ğ~
CLUSTER_NODE_SLAVE
;

1511 
n
->
æags
 |ğ
CLUSTER_NODE_MASTER
;

1512 
n
->
¦aveof
 = 
NULL
;

1515 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1516 
CLUSTER_TODO_UPDATE_STATE
);

1517 
	}
}

1530 
	$şu¡”Upd©eSlÙsCÚfigW™h
(
şu¡”Node
 *
£nd”
, 
ušt64_t
 
£nd”CÚfigEpoch
, *
¦Ùs
) {

1531 
j
;

1532 
şu¡”Node
 *
curma¡”
, *
Ãwma¡”
 = 
NULL
;

1540 
ušt16_t
 
dœty_¦Ùs
[
CLUSTER_SLOTS
];

1541 
dœty_¦Ùs_couÁ
 = 0;

1546 
curma¡”
 = 
	`nodeIsMa¡”
(
my£lf
è? my£là: my£lf->
¦aveof
;

1548 ià(
£nd”
 =ğ
my£lf
) {

1549 
	`£rv”Log
(
LL_WARNING
,"Discarding UPDATE message‡bout myself.");

1553 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

1554 ià(
	`b™m­Te¡B™
(
¦Ùs
,
j
)) {

1556 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
£nd”
) ;

1562 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]) ;

1568 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

1569 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 < 
£nd”CÚfigEpoch
)

1573 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
my£lf
 &&

1574 
	`couÁKeysInSlÙ
(
j
) &&

1575 
£nd”
 !ğ
my£lf
)

1577 
dœty_¦Ùs
[
dœty_¦Ùs_couÁ
] = 
j
;

1578 
dœty_¦Ùs_couÁ
++;

1581 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
curma¡”
)

1582 
Ãwma¡”
 = 
£nd”
;

1583 
	`şu¡”D–SlÙ
(
j
);

1584 
	`şu¡”AddSlÙ
(
£nd”
,
j
);

1585 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1586 
CLUSTER_TODO_UPDATE_STATE
|

1587 
CLUSTER_TODO_FSYNC_CONFIG
);

1599 ià(
Ãwma¡”
 && 
curma¡”
->
num¦Ùs
 == 0) {

1600 
	`£rv”Log
(
LL_WARNING
,

1602 "a ¨»¶iÿ oà%.40s", 
£nd”
->
Çme
);

1603 
	`şu¡”S‘Ma¡”
(
£nd”
);

1604 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1605 
CLUSTER_TODO_UPDATE_STATE
|

1606 
CLUSTER_TODO_FSYNC_CONFIG
);

1607 } ià(
dœty_¦Ùs_couÁ
) {

1615 
j
 = 0; j < 
dœty_¦Ùs_couÁ
; j++)

1616 
	`d–KeysInSlÙ
(
dœty_¦Ùs
[
j
]);

1618 
	}
}

1629 
	$şu¡”ProûssPack‘
(
şu¡”Lšk
 *
lšk
) {

1630 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
lšk
->
rcvbuf
;

1631 
ušt32_t
 
tÙËn
 = 
	`Áohl
(
hdr
->totlen);

1632 
ušt16_t
 
ty³
 = 
	`Áohs
(
hdr
->type);

1634 ià(
ty³
 < 
CLUSTERMSG_TYPE_COUNT
)

1635 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
[
ty³
]++;

1636 
	`£rv”Log
(
LL_DEBUG
,"--- Processing…acket ofype %d, %lu bytes",

1637 
ty³
, (è
tÙËn
);

1640 ià(
tÙËn
 < 16)  1;

1641 ià(
tÙËn
 > 
	`sd¦’
(
lšk
->
rcvbuf
))  1;

1643 ià(
	`Áohs
(
hdr
->
v”
è!ğ
CLUSTER_PROTO_VER
) {

1648 
ušt16_t
 
æags
 = 
	`Áohs
(
hdr
->flags);

1649 
ušt64_t
 
£nd”Cu¼’tEpoch
 = 0, 
£nd”CÚfigEpoch
 = 0;

1650 
şu¡”Node
 *
£nd”
;

1652 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_PONG
 ||

1653 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1655 
ušt16_t
 
couÁ
 = 
	`Áohs
(
hdr
->count);

1656 
ušt32_t
 
ex¶’
;

1658 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1659 
ex¶’
 +ğ((
şu¡”MsgD©aGoss
)*
couÁ
);

1660 ià(
tÙËn
 !ğ
ex¶’
)  1;

1661 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

1662 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1664 
ex¶’
 +ğ(
şu¡”MsgD©aFa
);

1665 ià(
tÙËn
 !ğ
ex¶’
)  1;

1666 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PUBLISH
) {

1667 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1669 
ex¶’
 +ğ(
şu¡”MsgD©aPublish
) -

1671 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.
chªÃl_Ën
) +

1672 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.
mes§ge_Ën
);

1673 ià(
tÙËn
 !ğ
ex¶’
)  1;

1674 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
 ||

1675 
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
 ||

1676 
ty³
 =ğ
CLUSTERMSG_TYPE_MFSTART
)

1678 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1680 ià(
tÙËn
 !ğ
ex¶’
)  1;

1681 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

1682 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1684 
ex¶’
 +ğ(
şu¡”MsgD©aUpd©e
);

1685 ià(
tÙËn
 !ğ
ex¶’
)  1;

1689 
£nd”
 = 
	`şu¡”LookupNode
(
hdr
->sender);

1690 ià(
£nd”
 && !
	`nodeInHªdshake
(sender)) {

1692 
£nd”Cu¼’tEpoch
 = 
	`Áohu64
(
hdr
->
cu¼’tEpoch
);

1693 
£nd”CÚfigEpoch
 = 
	`Áohu64
(
hdr
->
cÚfigEpoch
);

1694 ià(
£nd”Cu¼’tEpoch
 > 
£rv”
.
şu¡”
->
cu¼’tEpoch
)

1695 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
£nd”Cu¼’tEpoch
;

1697 ià(
£nd”CÚfigEpoch
 > 
£nd”
->
cÚfigEpoch
) {

1698 
£nd”
->
cÚfigEpoch
 = 
£nd”CÚfigEpoch
;

1699 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1700 
CLUSTER_TODO_FSYNC_CONFIG
);

1703 
£nd”
->
»¶_off£t
 = 
	`Áohu64
(
hdr
->
off£t
);

1704 
£nd”
->
»¶_off£t_time
 = 
	`m¡ime
();

1707 ià(
£rv”
.
şu¡”
->
mf_’d
 &&

1708 
	`nodeIsSÏve
(
my£lf
) &&

1709 
my£lf
->
¦aveof
 =ğ
£nd”
 &&

1710 
hdr
->
mæags
[0] & 
CLUSTERMSG_FLAG0_PAUSED
 &&

1711 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 == 0)

1713 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 = 
£nd”
->
»¶_off£t
;

1714 
	`£rv”Log
(
LL_WARNING
,

1717 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
);

1722 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_MEET
) {

1723 
	`£rv”Log
(
LL_DEBUG
,"Pšg…ack‘„eûived: %p", (*)
lšk
->
node
);

1736 ià((
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
 || 
my£lf
->

[0] == '\0') &&

1737 
£rv”
.
şu¡”_ªnounû_
 =ğ
NULL
)

1739 

[
NET_IP_STR_LEN
];

1741 ià(
	`ª‘SockName
(
lšk
->
fd
,

,(),
NULL
) != -1 &&

1742 
	`¡rcmp
(

,
my£lf
->ip))

1744 
	`memıy
(
my£lf
->

,,
NET_IP_STR_LEN
);

1745 
	`£rv”Log
(
LL_WARNING
,"IP‡ddress forhis‚ode updatedo %s",

1746 
my£lf
->

);

1747 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1755 ià(!
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
) {

1756 
şu¡”Node
 *
node
;

1758 
node
 = 
	`ü—‹Clu¡”Node
(
NULL
,
CLUSTER_NODE_HANDSHAKE
);

1759 
	`nodeIp2SŒšg
(
node
->

,
lšk
,
hdr
->
my
);

1760 
node
->
pÜt
 = 
	`Áohs
(
hdr
->port);

1761 
node
->
ıÜt
 = 
	`Áohs
(
hdr
->cport);

1762 
	`şu¡”AddNode
(
node
);

1763 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1769 ià(!
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1770 
	`şu¡”ProûssGossSeùiÚ
(
hdr
,
lšk
);

1773 
	`şu¡”S’dPšg
(
lšk
,
CLUSTERMSG_TYPE_PONG
);

1777 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_PONG
 ||

1778 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1780 
	`£rv”Log
(
LL_DEBUG
,"%s…acket„eceived: %p",

1781 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ? "ping" : "pong",

1782 (*)
lšk
->
node
);

1783 ià(
lšk
->
node
) {

1784 ià(
	`nodeInHªdshake
(
lšk
->
node
)) {

1787 ià(
£nd”
) {

1788 
	`£rv”Log
(
LL_VERBOSE
,

1790 "upd©šghadd»s iàÃeded.", 
£nd”
->
Çme
);

1791 ià(
	`nodeUpd©eAdd»ssIfN“ded
(
£nd”
,
lšk
,
hdr
))

1793 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1794 
CLUSTER_TODO_UPDATE_STATE
);

1798 
	`şu¡”D–Node
(
lšk
->
node
);

1804 
	`şu¡”R’ameNode
(
lšk
->
node
, 
hdr
->
£nd”
);

1805 
	`£rv”Log
(
LL_DEBUG
,"Handshake with‚ode %.40s completed.",

1806 
lšk
->
node
->
Çme
);

1807 
lšk
->
node
->
æags
 &ğ~
CLUSTER_NODE_HANDSHAKE
;

1808 
lšk
->
node
->
æags
 |ğæags&(
CLUSTER_NODE_MASTER
|
CLUSTER_NODE_SLAVE
);

1809 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1810 } ià(
	`memcmp
(
lšk
->
node
->
Çme
,
hdr
->
£nd”
,

1811 
CLUSTER_NAMELEN
) != 0)

1816 
	`£rv”Log
(
LL_DEBUG
,"PONG contains mismatching sender ID. About‚ode %.40s‡dded %d ms‡go, having flags %d",

1817 
lšk
->
node
->
Çme
,

1818 ()(
	`m¡ime
()-(
lšk
->
node
->
ùime
)),

1819 
lšk
->
node
->
æags
);

1820 
lšk
->
node
->
æags
 |ğ
CLUSTER_NODE_NOADDR
;

1821 
lšk
->
node
->

[0] = '\0';

1822 
lšk
->
node
->
pÜt
 = 0;

1823 
lšk
->
node
->
ıÜt
 = 0;

1824 
	`ä“Clu¡”Lšk
(
lšk
);

1825 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1836 ià(
£nd”
) {

1837 
noçov”
 = 
æags
 & 
CLUSTER_NODE_NOFAILOVER
;

1838 
£nd”
->
æags
 &ğ~
CLUSTER_NODE_NOFAILOVER
;

1839 
£nd”
->
æags
 |ğ
noçov”
;

1843 ià(
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 &&

1844 !
	`nodeInHªdshake
(
£nd”
) &&

1845 
	`nodeUpd©eAdd»ssIfN“ded
(
£nd”
,
lšk
,
hdr
))

1847 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1848 
CLUSTER_TODO_UPDATE_STATE
);

1852 ià(
lšk
->
node
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PONG
) {

1853 
lšk
->
node
->
pÚg_»ûived
 = 
	`m¡ime
();

1854 
lšk
->
node
->
pšg_£Á
 = 0;

1862 ià(
	`nodeTimedOut
(
lšk
->
node
)) {

1863 
lšk
->
node
->
æags
 &ğ~
CLUSTER_NODE_PFAIL
;

1864 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1865 
CLUSTER_TODO_UPDATE_STATE
);

1866 } ià(
	`nodeFaed
(
lšk
->
node
)) {

1867 
	`ş—rNodeFau»IfN“ded
(
lšk
->
node
);

1872 ià(
£nd”
) {

1873 ià(!
	`memcmp
(
hdr
->
¦aveof
,
CLUSTER_NODE_NULL_NAME
,

1874 (
hdr
->
¦aveof
)))

1877 
	`şu¡”S‘NodeAsMa¡”
(
£nd”
);

1880 
şu¡”Node
 *
ma¡”
 = 
	`şu¡”LookupNode
(
hdr
->
¦aveof
);

1882 ià(
	`nodeIsMa¡”
(
£nd”
)) {

1884 
	`şu¡”D–NodeSlÙs
(
£nd”
);

1885 
£nd”
->
æags
 &ğ~(
CLUSTER_NODE_MASTER
|

1886 
CLUSTER_NODE_MIGRATE_TO
);

1887 
£nd”
->
æags
 |ğ
CLUSTER_NODE_SLAVE
;

1890 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1891 
CLUSTER_TODO_UPDATE_STATE
);

1895 ià(
ma¡”
 && 
£nd”
->
¦aveof
 != master) {

1896 ià(
£nd”
->
¦aveof
)

1897 
	`şu¡”NodeRemoveSÏve
(
£nd”
->
¦aveof
,sender);

1898 
	`şu¡”NodeAddSÏve
(
ma¡”
,
£nd”
);

1899 
£nd”
->
¦aveof
 = 
ma¡”
;

1902 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1916 
şu¡”Node
 *
£nd”_ma¡”
 = 
NULL
;

1917 
dœty_¦Ùs
 = 0;

1919 ià(
£nd”
) {

1920 
£nd”_ma¡”
 = 
	`nodeIsMa¡”
(
£nd”
è? s’d” : s’d”->
¦aveof
;

1921 ià(
£nd”_ma¡”
) {

1922 
dœty_¦Ùs
 = 
	`memcmp
(
£nd”_ma¡”
->
¦Ùs
,

1923 
hdr
->
my¦Ùs
,(hdr->myslots)) != 0;

1930 ià(
£nd”
 && 
	`nodeIsMa¡”
(£nd”è&& 
dœty_¦Ùs
)

1931 
	`şu¡”Upd©eSlÙsCÚfigW™h
(
£nd”
,
£nd”CÚfigEpoch
,
hdr
->
my¦Ùs
);

1951 ià(
£nd”
 && 
dœty_¦Ùs
) {

1952 
j
;

1954 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

1955 ià(
	`b™m­Te¡B™
(
hdr
->
my¦Ùs
,
j
)) {

1956 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
£nd”
 ||

1957 
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
) ;

1958 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 >

1959 
£nd”CÚfigEpoch
)

1961 
	`£rv”Log
(
LL_VERBOSE
,

1964 
£nd”
->
Çme
, 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->name);

1965 
	`şu¡”S’dUpd©e
(
£nd”
->
lšk
,

1966 
£rv”
.
şu¡”
->
¦Ùs
[
j
]);

1979 ià(
£nd”
 &&

1980 
	`nodeIsMa¡”
(
my£lf
è&&‚odeIsMa¡”(
£nd”
) &&

1981 
£nd”CÚfigEpoch
 =ğ
my£lf
->
cÚfigEpoch
)

1983 
	`şu¡”HªdËCÚfigEpochCŞlisiÚ
(
£nd”
);

1987 ià(
£nd”
è
	`şu¡”ProûssGossSeùiÚ
(
hdr
,
lšk
);

1988 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

1989 
şu¡”Node
 *
çšg
;

1991 ià(
£nd”
) {

1992 
çšg
 = 
	`şu¡”LookupNode
(
hdr
->
d©a
.
ç
.
about
.
nod’ame
);

1993 ià(
çšg
 &&

1994 !(
çšg
->
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_MYSELF
)))

1996 
	`£rv”Log
(
LL_NOTICE
,

1998 
hdr
->
£nd”
, hdr->
d©a
.
ç
.
about
.
nod’ame
);

1999 
çšg
->
æags
 |ğ
CLUSTER_NODE_FAIL
;

2000 
çšg
->
ç_time
 = 
	`m¡ime
();

2001 
çšg
->
æags
 &ğ~
CLUSTER_NODE_PFAIL
;

2002 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

2003 
CLUSTER_TODO_UPDATE_STATE
);

2006 
	`£rv”Log
(
LL_NOTICE
,

2008 
hdr
->
£nd”
, hdr->
d©a
.
ç
.
about
.
nod’ame
);

2010 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PUBLISH
) {

2011 
robj
 *
chªÃl
, *
mes§ge
;

2012 
ušt32_t
 
chªÃl_Ën
, 
mes§ge_Ën
;

2016 ià(
	`diùSize
(
£rv”
.
pubsub_chªÃls
) ||

2017 
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
))

2019 
chªÃl_Ën
 = 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.channel_len);

2020 
mes§ge_Ën
 = 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.message_len);

2021 
chªÃl
 = 
	`ü—‹SŒšgObjeù
(

2022 (*)
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
,
chªÃl_Ën
);

2023 
mes§ge
 = 
	`ü—‹SŒšgObjeù
(

2024 (*)
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
+
chªÃl_Ën
,

2025 
mes§ge_Ën
);

2026 
	`pubsubPublishMes§ge
(
chªÃl
,
mes§ge
);

2027 
	`deüRefCouÁ
(
chªÃl
);

2028 
	`deüRefCouÁ
(
mes§ge
);

2030 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
) {

2031 ià(!
£nd”
)  1;

2032 
	`şu¡”S’dFaov”AuthIfN“ded
(
£nd”
,
hdr
);

2033 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
) {

2034 ià(!
£nd”
)  1;

2038 ià(
	`nodeIsMa¡”
(
£nd”
è&& s’d”->
num¦Ùs
 > 0 &&

2039 
£nd”Cu¼’tEpoch
 >ğ
£rv”
.
şu¡”
->
çov”_auth_•och
)

2041 
£rv”
.
şu¡”
->
çov”_auth_couÁ
++;

2044 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_HANDLE_FAILOVER
);

2046 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_MFSTART
) {

2049 ià(!
£nd”
 || s’d”->
¦aveof
 !ğ
my£lf
)  1;

2052 
	`»£tMªu®Faov”
();

2053 
£rv”
.
şu¡”
->
mf_’d
 = 
	`m¡ime
(è+ 
CLUSTER_MF_TIMEOUT
;

2054 
£rv”
.
şu¡”
->
mf_¦ave
 = 
£nd”
;

2055 
	`·u£Cl›Ás
(
	`m¡ime
()+(
CLUSTER_MF_TIMEOUT
*2));

2056 
	`£rv”Log
(
LL_WARNING
,"Manual failover„equested by slave %.40s.",

2057 
£nd”
->
Çme
);

2058 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

2059 
şu¡”Node
 *
n
;

2060 
ušt64_t
 
»pÜ‹dCÚfigEpoch
 =

2061 
	`Áohu64
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
cÚfigEpoch
);

2063 ià(!
£nd”
)  1;

2064 
n
 = 
	`şu¡”LookupNode
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
nod’ame
);

2065 ià(!
n
)  1;

2066 ià(
n
->
cÚfigEpoch
 >ğ
»pÜ‹dCÚfigEpoch
)  1;

2069 ià(
	`nodeIsSÏve
(
n
)è
	`şu¡”S‘NodeAsMa¡”
(n);

2072 
n
->
cÚfigEpoch
 = 
»pÜ‹dCÚfigEpoch
;

2073 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

2074 
CLUSTER_TODO_FSYNC_CONFIG
);

2078 
	`şu¡”Upd©eSlÙsCÚfigW™h
(
n
,
»pÜ‹dCÚfigEpoch
,

2079 
hdr
->
d©a
.
upd©e
.
nodecfg
.
¦Ùs
);

2081 
	`£rv”Log
(
LL_WARNING
,"Reûived unknowÀ·ck‘y³: %d", 
ty³
);

2084 
	}
}

2092 
	$hªdËLškIOE¼Ü
(
şu¡”Lšk
 *
lšk
) {

2093 
	`ä“Clu¡”Lšk
(
lšk
);

2094 
	}
}

2099 
	$şu¡”Wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

2100 
şu¡”Lšk
 *
lšk
 = (şu¡”Lšk*è
´ivd©a
;

2101 
ssize_t
 
nwr™‹n
;

2102 
	`UNUSED
(
–
);

2103 
	`UNUSED
(
mask
);

2105 
nwr™‹n
 = 
	`wr™e
(
fd
, 
lšk
->
¢dbuf
, 
	`sd¦’
(link->sndbuf));

2106 ià(
nwr™‹n
 <= 0) {

2107 
	`£rv”Log
(
LL_DEBUG
,"I/Oƒrror writingo‚ode†ink: %s",

2108 
	`¡»¼Ü
(
”ºo
));

2109 
	`hªdËLškIOE¼Ü
(
lšk
);

2112 
	`sd¤ªge
(
lšk
->
¢dbuf
,
nwr™‹n
,-1);

2113 ià(
	`sd¦’
(
lšk
->
¢dbuf
) == 0)

2114 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_WRITABLE
);

2115 
	}
}

2120 
	$şu¡”R—dHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

2121 
buf
[(
şu¡”Msg
)];

2122 
ssize_t
 
Ä—d
;

2123 
şu¡”Msg
 *
hdr
;

2124 
şu¡”Lšk
 *
lšk
 = (şu¡”Lšk*è
´ivd©a
;

2125 
»adËn
, 
rcvbuæ’
;

2126 
	`UNUSED
(
–
);

2127 
	`UNUSED
(
mask
);

2130 
rcvbuæ’
 = 
	`sd¦’
(
lšk
->
rcvbuf
);

2131 ià(
rcvbuæ’
 < 8) {

2134 
»adËn
 = 8 - 
rcvbuæ’
;

2137 
hdr
 = (
şu¡”Msg
*è
lšk
->
rcvbuf
;

2138 ià(
rcvbuæ’
 == 8) {

2141 ià(
	`memcmp
(
hdr
->
sig
,"RCmb",4) != 0 ||

2142 
	`Áohl
(
hdr
->
tÙËn
è< 
CLUSTERMSG_MIN_LEN
)

2144 
	`£rv”Log
(
LL_WARNING
,

2147 
	`hªdËLškIOE¼Ü
(
lšk
);

2151 
»adËn
 = 
	`Áohl
(
hdr
->
tÙËn
è- 
rcvbuæ’
;

2152 ià(
»adËn
 > (
buf
))„eadlen = (buf);

2155 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
»adËn
);

2156 ià(
Ä—d
 =ğ-1 && 
”ºo
 =ğ
EAGAIN
) ;

2158 ià(
Ä—d
 <= 0) {

2160 
	`£rv”Log
(
LL_DEBUG
,"I/Oƒrror„eading from‚ode†ink: %s",

2161 (
Ä—d
 =ğ0è? "cÚÃùiÚ clo£d" : 
	`¡»¼Ü
(
”ºo
));

2162 
	`hªdËLškIOE¼Ü
(
lšk
);

2166 
lšk
->
rcvbuf
 = 
	`sdsÿ’
Öšk->rcvbuf,
buf
,
Ä—d
);

2167 
hdr
 = (
şu¡”Msg
*è
lšk
->
rcvbuf
;

2168 
rcvbuæ’
 +ğ
Ä—d
;

2172 ià(
rcvbuæ’
 >ğ8 &&„cvbuæ’ =ğ
	`Áohl
(
hdr
->
tÙËn
)) {

2173 ià(
	`şu¡”ProûssPack‘
(
lšk
)) {

2174 
	`sdsä“
(
lšk
->
rcvbuf
);

2175 
lšk
->
rcvbuf
 = 
	`sd£m±y
();

2181 
	}
}

2188 
	$şu¡”S’dMes§ge
(
şu¡”Lšk
 *
lšk
, *
msg
, 
size_t
 
msgËn
) {

2189 ià(
	`sd¦’
(
lšk
->
¢dbuf
è=ğ0 && 
msgËn
 != 0)

2190 
	`«C»©eFeEv’t
(
£rv”
.
–
,
lšk
->
fd
,
AE_WRITABLE
|
AE_BARRIER
,

2191 
şu¡”Wr™eHªdËr
,
lšk
);

2193 
lšk
->
¢dbuf
 = 
	`sdsÿ’
Öšk->¢dbuf, 
msg
, 
msgËn
);

2196 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
msg
;

2197 
ušt16_t
 
ty³
 = 
	`Áohs
(
hdr
->type);

2198 ià(
ty³
 < 
CLUSTERMSG_TYPE_COUNT
)

2199 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
[
ty³
]++;

2200 
	}
}

2208 
	$şu¡”Brßdÿ¡Mes§ge
(*
buf
, 
size_t
 
Ën
) {

2209 
diùI‹¿tÜ
 *
di
;

2210 
diùEÁry
 *
de
;

2212 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2213 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2214 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2216 ià(!
node
->
lšk
) ;

2217 ià(
node
->
æags
 & (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_HANDSHAKE
))

2219 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
Ën
);

2221 
	`diùR–—£I‹¿tÜ
(
di
);

2222 
	}
}

2226 
	$şu¡”BudMes§geHdr
(
şu¡”Msg
 *
hdr
, 
ty³
) {

2227 
tÙËn
 = 0;

2228 
ušt64_t
 
off£t
;

2229 
şu¡”Node
 *
ma¡”
;

2235 
ma¡”
 = (
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
) ?

2236 
my£lf
->
¦aveof
 : myself;

2238 
	`mem£t
(
hdr
,0,(*hdr));

2239 
hdr
->
v”
 = 
	`htÚs
(
CLUSTER_PROTO_VER
);

2240 
hdr
->
sig
[0] = 'R';

2241 
hdr
->
sig
[1] = 'C';

2242 
hdr
->
sig
[2] = 'm';

2243 
hdr
->
sig
[3] = 'b';

2244 
hdr
->
ty³
 = 
	`htÚs
(type);

2245 
	`memıy
(
hdr
->
£nd”
,
my£lf
->
Çme
,
CLUSTER_NAMELEN
);

2250 
	`mem£t
(
hdr
->
my
,0,
NET_IP_STR_LEN
);

2251 ià(
£rv”
.
şu¡”_ªnounû_
) {

2252 
	`¡ºıy
(
hdr
->
my
,
£rv”
.
şu¡”_ªnounû_
,
NET_IP_STR_LEN
);

2253 
hdr
->
my
[
NET_IP_STR_LEN
-1] = '\0';

2257 
ªnounûd_pÜt
 = 
£rv”
.
şu¡”_ªnounû_pÜt
 ?

2258 
£rv”
.
şu¡”_ªnounû_pÜt
 : s”v”.
pÜt
;

2259 
ªnounûd_ıÜt
 = 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 ?

2260 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 :

2261 (
£rv”
.
pÜt
 + 
CLUSTER_PORT_INCR
);

2263 
	`memıy
(
hdr
->
my¦Ùs
,
ma¡”
->
¦Ùs
,(hdr->myslots));

2264 
	`mem£t
(
hdr
->
¦aveof
,0,
CLUSTER_NAMELEN
);

2265 ià(
my£lf
->
¦aveof
 !ğ
NULL
)

2266 
	`memıy
(
hdr
->
¦aveof
,
my£lf
->¦aveof->
Çme
, 
CLUSTER_NAMELEN
);

2267 
hdr
->
pÜt
 = 
	`htÚs
(
ªnounûd_pÜt
);

2268 
hdr
->
ıÜt
 = 
	`htÚs
(
ªnounûd_ıÜt
);

2269 
hdr
->
æags
 = 
	`htÚs
(
my£lf
->flags);

2270 
hdr
->
¡©e
 = 
£rv”
.
şu¡”
->state;

2273 
hdr
->
cu¼’tEpoch
 = 
	`htÚu64
(
£rv”
.
şu¡”
->currentEpoch);

2274 
hdr
->
cÚfigEpoch
 = 
	`htÚu64
(
ma¡”
->configEpoch);

2277 ià(
	`nodeIsSÏve
(
my£lf
))

2278 
off£t
 = 
	`»¶iÿtiÚG‘SÏveOff£t
();

2280 
off£t
 = 
£rv”
.
ma¡”_»¶_off£t
;

2281 
hdr
->
off£t
 = 
	`htÚu64
(offset);

2284 ià(
	`nodeIsMa¡”
(
my£lf
è&& 
£rv”
.
şu¡”
->
mf_’d
)

2285 
hdr
->
mæags
[0] |ğ
CLUSTERMSG_FLAG0_PAUSED
;

2289 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

2290 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2291 
tÙËn
 +ğ(
şu¡”MsgD©aFa
);

2292 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

2293 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2294 
tÙËn
 +ğ(
şu¡”MsgD©aUpd©e
);

2296 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2298 
	}
}

2303 
	$şu¡”NodeIsInGossSeùiÚ
(
şu¡”Msg
 *
hdr
, 
couÁ
, 
şu¡”Node
 *
n
) {

2304 
j
;

2305 
j
 = 0; j < 
couÁ
; j++) {

2306 ià(
	`memcmp
(
hdr
->
d©a
.
pšg
.
goss
[
j
].
nod’ame
,
n
->
Çme
,

2307 
CLUSTER_NAMELEN
) == 0) ;

2309  
j
 !ğ
couÁ
;

2310 
	}
}

2314 
	$şu¡”S‘GossEÁry
(
şu¡”Msg
 *
hdr
, 
i
, 
şu¡”Node
 *
n
) {

2315 
şu¡”MsgD©aGoss
 *
goss
;

2316 
goss
 = &(
hdr
->
d©a
.
pšg
.goss[
i
]);

2317 
	`memıy
(
goss
->
nod’ame
,
n
->
Çme
,
CLUSTER_NAMELEN
);

2318 
goss
->
pšg_£Á
 = 
	`htÚl
(
n
->ping_sent/1000);

2319 
goss
->
pÚg_»ûived
 = 
	`htÚl
(
n
->pong_received/1000);

2320 
	`memıy
(
goss
->

,
n
->ip,(n->ip));

2321 
goss
->
pÜt
 = 
	`htÚs
(
n
->port);

2322 
goss
->
ıÜt
 = 
	`htÚs
(
n
->cport);

2323 
goss
->
æags
 = 
	`htÚs
(
n
->flags);

2324 
goss
->
nÙu£d1
 = 0;

2325 
	}
}

2329 
	$şu¡”S’dPšg
(
şu¡”Lšk
 *
lšk
, 
ty³
) {

2330 *
buf
;

2331 
şu¡”Msg
 *
hdr
;

2332 
gosscouÁ
 = 0;

2333 
wª‹d
;

2334 
tÙËn
;

2339 
äeshnodes
 = 
	`diùSize
(
£rv”
.
şu¡”
->
nodes
)-2;

2367 
wª‹d
 = 
	`æoÜ
(
	`diùSize
(
£rv”
.
şu¡”
->
nodes
)/10);

2368 ià(
wª‹d
 < 3) wanted = 3;

2369 ià(
wª‹d
 > 
äeshnodes
) wanted = freshnodes;

2373 
pç_wª‹d
 = 
£rv”
.
şu¡”
->
¡©s_pç_nodes
;

2378 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2379 
tÙËn
 +ğ((
şu¡”MsgD©aGoss
)*(
wª‹d
+
pç_wª‹d
));

2382 ià(
tÙËn
 < ()(
şu¡”Msg
))otlen = (clusterMsg);

2383 
buf
 = 
	`zÿÎoc
(
tÙËn
);

2384 
hdr
 = (
şu¡”Msg
*è
buf
;

2387 ià(
lšk
->
node
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
)

2388 
lšk
->
node
->
pšg_£Á
 = 
	`m¡ime
();

2389 
	`şu¡”BudMes§geHdr
(
hdr
,
ty³
);

2392 
max™”©iÚs
 = 
wª‹d
*3;

2393 
äeshnodes
 > 0 && 
gosscouÁ
 < 
wª‹d
 && 
max™”©iÚs
--) {

2394 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
şu¡”
->
nodes
);

2395 
şu¡”Node
 *
this
 = 
	`diùG‘V®
(
de
);

2399 ià(
this
 =ğ
my£lf
) ;

2402 ià(
this
->
æags
 & 
CLUSTER_NODE_PFAIL
) ;

2409 ià(
this
->
æags
 & (
CLUSTER_NODE_HANDSHAKE
|
CLUSTER_NODE_NOADDR
) ||

2410 (
this
->
lšk
 =ğ
NULL
 &&his->
num¦Ùs
 == 0))

2412 
äeshnodes
--;

2417 ià(
	`şu¡”NodeIsInGossSeùiÚ
(
hdr
,
gosscouÁ
,
this
)) ;

2420 
	`şu¡”S‘GossEÁry
(
hdr
,
gosscouÁ
,
this
);

2421 
äeshnodes
--;

2422 
gosscouÁ
++;

2426 ià(
pç_wª‹d
) {

2427 
diùI‹¿tÜ
 *
di
;

2428 
diùEÁry
 *
de
;

2430 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2431 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
 && 
pç_wª‹d
 > 0) {

2432 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2433 ià(
node
->
æags
 & 
CLUSTER_NODE_HANDSHAKE
) ;

2434 ià(
node
->
æags
 & 
CLUSTER_NODE_NOADDR
) ;

2435 ià(!(
node
->
æags
 & 
CLUSTER_NODE_PFAIL
)) ;

2436 
	`şu¡”S‘GossEÁry
(
hdr
,
gosscouÁ
,
node
);

2437 
äeshnodes
--;

2438 
gosscouÁ
++;

2442 
pç_wª‹d
--;

2444 
	`diùR–—£I‹¿tÜ
(
di
);

2449 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2450 
tÙËn
 +ğ((
şu¡”MsgD©aGoss
)*
gosscouÁ
);

2451 
hdr
->
couÁ
 = 
	`htÚs
(
gosscouÁ
);

2452 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2453 
	`şu¡”S’dMes§ge
(
lšk
,
buf
,
tÙËn
);

2454 
	`zä“
(
buf
);

2455 
	}
}

2471 
	#CLUSTER_BROADCAST_ALL
 0

	)

2472 
	#CLUSTER_BROADCAST_LOCAL_SLAVES
 1

	)

2473 
	$şu¡”Brßdÿ¡PÚg
(
rg‘
) {

2474 
diùI‹¿tÜ
 *
di
;

2475 
diùEÁry
 *
de
;

2477 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2478 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2479 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2481 ià(!
node
->
lšk
) ;

2482 ià(
node
 =ğ
my£lf
 || 
	`nodeInHªdshake
(node)) ;

2483 ià(
rg‘
 =ğ
CLUSTER_BROADCAST_LOCAL_SLAVES
) {

2484 
loÿl_¦ave
 =

2485 
	`nodeIsSÏve
(
node
è&&‚ode->
¦aveof
 &&

2486 (
node
->
¦aveof
 =ğ
my£lf
 ||‚ode->slaveof == myself->slaveof);

2487 ià(!
loÿl_¦ave
) ;

2489 
	`şu¡”S’dPšg
(
node
->
lšk
,
CLUSTERMSG_TYPE_PONG
);

2491 
	`diùR–—£I‹¿tÜ
(
di
);

2492 
	}
}

2497 
	$şu¡”S’dPublish
(
şu¡”Lšk
 *
lšk
, 
robj
 *
chªÃl
,„obj *
mes§ge
) {

2498 
buf
[(
şu¡”Msg
)], *
·ylßd
;

2499 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2500 
ušt32_t
 
tÙËn
;

2501 
ušt32_t
 
chªÃl_Ën
, 
mes§ge_Ën
;

2503 
chªÃl
 = 
	`g‘DecodedObjeù
(channel);

2504 
mes§ge
 = 
	`g‘DecodedObjeù
(message);

2505 
chªÃl_Ën
 = 
	`sd¦’
(
chªÃl
->
±r
);

2506 
mes§ge_Ën
 = 
	`sd¦’
(
mes§ge
->
±r
);

2508 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_PUBLISH
);

2509 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2510 
tÙËn
 +ğ(
şu¡”MsgD©aPublish
è- 8 + 
chªÃl_Ën
 + 
mes§ge_Ën
;

2512 
hdr
->
d©a
.
publish
.
msg
.
chªÃl_Ën
 = 
	`htÚl
(channel_len);

2513 
hdr
->
d©a
.
publish
.
msg
.
mes§ge_Ën
 = 
	`htÚl
(message_len);

2514 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2517 ià(
tÙËn
 < (
buf
)) {

2518 
·ylßd
 = 
buf
;

2520 
·ylßd
 = 
	`zm®loc
(
tÙËn
);

2521 
	`memıy
(
·ylßd
,
hdr
,(*hdr));

2522 
hdr
 = (
şu¡”Msg
*è
·ylßd
;

2524 
	`memıy
(
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
,
chªÃl
->
±r
,
	`sd¦’
(channel->ptr));

2525 
	`memıy
(
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
+
	`sd¦’
(
chªÃl
->
±r
),

2526 
mes§ge
->
±r
,
	`sd¦’
(message->ptr));

2528 ià(
lšk
)

2529 
	`şu¡”S’dMes§ge
(
lšk
,
·ylßd
,
tÙËn
);

2531 
	`şu¡”Brßdÿ¡Mes§ge
(
·ylßd
,
tÙËn
);

2533 
	`deüRefCouÁ
(
chªÃl
);

2534 
	`deüRefCouÁ
(
mes§ge
);

2535 ià(
·ylßd
 !ğ
buf
è
	`zä“
(payload);

2536 
	}
}

2543 
	$şu¡”S’dFa
(*
nod’ame
) {

2544 
buf
[(
şu¡”Msg
)];

2545 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2547 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAIL
);

2548 
	`memıy
(
hdr
->
d©a
.
ç
.
about
.
nod’ame
,nod’ame,
CLUSTER_NAMELEN
);

2549 
	`şu¡”Brßdÿ¡Mes§ge
(
buf
,
	`Áohl
(
hdr
->
tÙËn
));

2550 
	}
}

2555 
	$şu¡”S’dUpd©e
(
şu¡”Lšk
 *
lšk
, 
şu¡”Node
 *
node
) {

2556 
buf
[(
şu¡”Msg
)];

2557 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2559 ià(
lšk
 =ğ
NULL
) ;

2560 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_UPDATE
);

2561 
	`memıy
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
nod’ame
,
node
->
Çme
,
CLUSTER_NAMELEN
);

2562 
hdr
->
d©a
.
upd©e
.
nodecfg
.
cÚfigEpoch
 = 
	`htÚu64
(
node
->configEpoch);

2563 
	`memıy
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
¦Ùs
,
node
->slots,(node->slots));

2564 
	`şu¡”S’dMes§ge
(
lšk
,
buf
,
	`Áohl
(
hdr
->
tÙËn
));

2565 
	}
}

2574 
	$şu¡”Prİag©ePublish
(
robj
 *
chªÃl
,„obj *
mes§ge
) {

2575 
	`şu¡”S’dPublish
(
NULL
, 
chªÃl
, 
mes§ge
);

2576 
	}
}

2588 
	$şu¡”Reque¡Faov”Auth
() {

2589 
buf
[(
şu¡”Msg
)];

2590 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2591 
ušt32_t
 
tÙËn
;

2593 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
);

2597 ià(
£rv”
.
şu¡”
->
mf_’d
è
hdr
->
mæags
[0] |ğ
CLUSTERMSG_FLAG0_FORCEACK
;

2598 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2599 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2600 
	`şu¡”Brßdÿ¡Mes§ge
(
buf
,
tÙËn
);

2601 
	}
}

2604 
	$şu¡”S’dFaov”Auth
(
şu¡”Node
 *
node
) {

2605 
buf
[(
şu¡”Msg
)];

2606 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2607 
ušt32_t
 
tÙËn
;

2609 ià(!
node
->
lšk
) ;

2610 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
);

2611 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2612 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2613 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
tÙËn
);

2614 
	}
}

2617 
	$şu¡”S’dMFS¹
(
şu¡”Node
 *
node
) {

2618 
buf
[(
şu¡”Msg
)];

2619 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2620 
ušt32_t
 
tÙËn
;

2622 ià(!
node
->
lšk
) ;

2623 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_MFSTART
);

2624 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2625 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2626 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
tÙËn
);

2627 
	}
}

2630 
	$şu¡”S’dFaov”AuthIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Msg
 *
»que¡
) {

2631 
şu¡”Node
 *
ma¡”
 = 
node
->
¦aveof
;

2632 
ušt64_t
 
»que¡Cu¼’tEpoch
 = 
	`Áohu64
(
»que¡
->
cu¼’tEpoch
);

2633 
ušt64_t
 
»que¡CÚfigEpoch
 = 
	`Áohu64
(
»que¡
->
cÚfigEpoch
);

2634 *
şaimed_¦Ùs
 = 
»que¡
->
my¦Ùs
;

2635 
fÜû_ack
 = 
»que¡
->
mæags
[0] & 
CLUSTERMSG_FLAG0_FORCEACK
;

2636 
j
;

2642 ià(
	`nodeIsSÏve
(
my£lf
è|| my£lf->
num¦Ùs
 == 0) ;

2648 ià(
»que¡Cu¼’tEpoch
 < 
£rv”
.
şu¡”
->
cu¼’tEpoch
) {

2649 
	`£rv”Log
(
LL_WARNING
,

2651 
node
->
Çme
,

2652 (è
»que¡Cu¼’tEpoch
,

2653 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2658 ià(
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 =ğ£rv”.şu¡”->
cu¼’tEpoch
) {

2659 
	`£rv”Log
(
LL_WARNING
,

2661 
node
->
Çme
,

2662 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2669 ià(
	`nodeIsMa¡”
(
node
è|| 
ma¡”
 =ğ
NULL
 ||

2670 (!
	`nodeFaed
(
ma¡”
è&& !
fÜû_ack
))

2672 ià(
	`nodeIsMa¡”
(
node
)) {

2673 
	`£rv”Log
(
LL_WARNING
,

2675 
node
->
Çme
);

2676 } ià(
ma¡”
 =ğ
NULL
) {

2677 
	`£rv”Log
(
LL_WARNING
,

2679 
node
->
Çme
);

2680 } ià(!
	`nodeFaed
(
ma¡”
)) {

2681 
	`£rv”Log
(
LL_WARNING
,

2683 
node
->
Çme
);

2691 ià(
	`m¡ime
(è- 
node
->
¦aveof
->
vÙed_time
 < 
£rv”
.
şu¡”_node_timeout
 * 2)

2693 
	`£rv”Log
(
LL_WARNING
,

2696 
node
->
Çme
,

2697 (è((
£rv”
.
şu¡”_node_timeout
*2)-

2698 (
	`m¡ime
(è- 
node
->
¦aveof
->
vÙed_time
)));

2705 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

2706 ià(
	`b™m­Te¡B™
(
şaimed_¦Ùs
, 
j
) == 0) ;

2707 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

2708 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 <ğ
»que¡CÚfigEpoch
)

2715 
	`£rv”Log
(
LL_WARNING
,

2718 
node
->
Çme
, 
j
,

2719 (è
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
,

2720 (è
»que¡CÚfigEpoch
);

2725 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = s”v”.şu¡”->
cu¼’tEpoch
;

2726 
node
->
¦aveof
->
vÙed_time
 = 
	`m¡ime
();

2727 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|
CLUSTER_TODO_FSYNC_CONFIG
);

2728 
	`şu¡”S’dFaov”Auth
(
node
);

2729 
	`£rv”Log
(
LL_WARNING
, "Failover‡uth grantedo %.40s forƒpoch %llu",

2730 
node
->
Çme
, (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2731 
	}
}

2745 
	$şu¡”G‘SÏveRªk
() {

2746 
myoff£t
;

2747 
j
, 
¿nk
 = 0;

2748 
şu¡”Node
 *
ma¡”
;

2750 
	`£rv”As£¹
(
	`nodeIsSÏve
(
my£lf
));

2751 
ma¡”
 = 
my£lf
->
¦aveof
;

2752 ià(
ma¡”
 =ğ
NULL
)  0;

2754 
myoff£t
 = 
	`»¶iÿtiÚG‘SÏveOff£t
();

2755 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++)

2756 ià(
ma¡”
->
¦aves
[
j
] !ğ
my£lf
 &&

2757 !
	`nodeCªtFaov”
(
ma¡”
->
¦aves
[
j
]) &&

2758 
ma¡”
->
¦aves
[
j
]->
»¶_off£t
 > 
myoff£t
è
¿nk
++;

2759  
¿nk
;

2760 
	}
}

2784 
	$şu¡”LogCªtFaov”
(
»asÚ
) {

2785 *
msg
;

2786 
time_t
 
Ï¡log_time
 = 0;

2787 
m¡ime_t
 
nŞog_ç_time
 = 
£rv”
.
şu¡”_node_timeout
 + 5000;

2790 ià(
»asÚ
 =ğ
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 &&

2791 
	`time
(
NULL
)-
Ï¡log_time
 < 
CLUSTER_CANT_FAILOVER_RELOG_PERIOD
)

2794 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
»asÚ
;

2799 ià(
my£lf
->
¦aveof
 &&

2800 
	`nodeFaed
(
my£lf
->
¦aveof
) &&

2801 (
	`m¡ime
(è- 
my£lf
->
¦aveof
->
ç_time
è< 
nŞog_ç_time
) ;

2803 
»asÚ
) {

2804 
CLUSTER_CANT_FAILOVER_DATA_AGE
:

2805 
msg
 = "Disconnected from master for†ongerhan‡llowed. "

2809 
CLUSTER_CANT_FAILOVER_WAITING_DELAY
:

2810 
msg
 = "Waitinghe delay before I can start‡‚ew failover.";

2812 
CLUSTER_CANT_FAILOVER_EXPIRED
:

2813 
msg
 = "Failover‡ttemptƒxpired.";

2815 
CLUSTER_CANT_FAILOVER_WAITING_VOTES
:

2816 
msg
 = "Waiting for votes, but majority still‚ot„eached.";

2819 
msg
 = "Unknown„eason code.";

2822 
Ï¡log_time
 = 
	`time
(
NULL
);

2823 
	`£rv”Log
(
LL_WARNING
,"Cu¼’y uÇbËØçov”: %s", 
msg
);

2824 
	}
}

2832 
	$şu¡”Faov”R•ÏûYourMa¡”
() {

2833 
j
;

2834 
şu¡”Node
 *
Şdma¡”
 = 
my£lf
->
¦aveof
;

2836 ià(
	`nodeIsMa¡”
(
my£lf
è|| 
Şdma¡”
 =ğ
NULL
) ;

2839 
	`şu¡”S‘NodeAsMa¡”
(
my£lf
);

2840 
	`»¶iÿtiÚUn£tMa¡”
();

2843 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

2844 ià(
	`şu¡”NodeG‘SlÙB™
(
Şdma¡”
,
j
)) {

2845 
	`şu¡”D–SlÙ
(
j
);

2846 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

2851 
	`şu¡”Upd©eS‹
();

2852 
	`şu¡”SaveCÚfigOrD›
(1);

2856 
	`şu¡”Brßdÿ¡PÚg
(
CLUSTER_BROADCAST_ALL
);

2859 
	`»£tMªu®Faov”
();

2860 
	}
}

2870 
	$şu¡”HªdËSÏveFaov”
() {

2871 
m¡ime_t
 
d©a_age
;

2872 
m¡ime_t
 
auth_age
 = 
	`m¡ime
(è- 
£rv”
.
şu¡”
->
çov”_auth_time
;

2873 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

2874 
mªu®_çov”
 = 
£rv”
.
şu¡”
->
mf_’d
 != 0 &&

2875 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
;

2876 
m¡ime_t
 
auth_timeout
, 
auth_»Œy_time
;

2878 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_HANDLE_FAILOVER
;

2887 
auth_timeout
 = 
£rv”
.
şu¡”_node_timeout
*2;

2888 ià(
auth_timeout
 < 2000)‡uth_timeout = 2000;

2889 
auth_»Œy_time
 = 
auth_timeout
*2;

2898 ià(
	`nodeIsMa¡”
(
my£lf
) ||

2899 
my£lf
->
¦aveof
 =ğ
NULL
 ||

2900 (!
	`nodeFaed
(
my£lf
->
¦aveof
è&& !
mªu®_çov”
) ||

2901 (
£rv”
.
şu¡”_¦ave_no_çov”
 && !
mªu®_çov”
) ||

2902 
my£lf
->
¦aveof
->
num¦Ùs
 == 0)

2906 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
CLUSTER_CANT_FAILOVER_NONE
;

2912 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTED
) {

2913 
d©a_age
 = (
m¡ime_t
)(
£rv”
.
unixtime
 - s”v”.
ma¡”
->
Ï¡š‹¿ùiÚ
)

2916 
d©a_age
 = (
m¡ime_t
)(
£rv”
.
unixtime
 - s”v”.
»¶_down_sšû
) * 1000;

2922 ià(
d©a_age
 > 
£rv”
.
şu¡”_node_timeout
)

2923 
d©a_age
 -ğ
£rv”
.
şu¡”_node_timeout
;

2929 ià(
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 &&

2930 
d©a_age
 >

2931 (((
m¡ime_t
)
£rv”
.
»¶_pšg_¦ave_³riod
 * 1000) +

2932 (
£rv”
.
şu¡”_node_timeout
 * s”v”.
şu¡”_¦ave_v®id™y_çùÜ
)))

2934 ià(!
mªu®_çov”
) {

2935 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_DATA_AGE
);

2942 ià(
auth_age
 > 
auth_»Œy_time
) {

2943 
£rv”
.
şu¡”
->
çov”_auth_time
 = 
	`m¡ime
() +

2945 
	`¿ndom
() % 500;

2946 
£rv”
.
şu¡”
->
çov”_auth_couÁ
 = 0;

2947 
£rv”
.
şu¡”
->
çov”_auth_£Á
 = 0;

2948 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 
	`şu¡”G‘SÏveRªk
();

2952 
£rv”
.
şu¡”
->
çov”_auth_time
 +=

2953 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 * 1000;

2955 ià(
£rv”
.
şu¡”
->
mf_’d
) {

2956 
£rv”
.
şu¡”
->
çov”_auth_time
 = 
	`m¡ime
();

2957 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 0;

2959 
	`£rv”Log
(
LL_WARNING
,

2962 
£rv”
.
şu¡”
->
çov”_auth_time
 - 
	`m¡ime
(),

2963 
£rv”
.
şu¡”
->
çov”_auth_¿nk
,

2964 
	`»¶iÿtiÚG‘SÏveOff£t
());

2968 
	`şu¡”Brßdÿ¡PÚg
(
CLUSTER_BROADCAST_LOCAL_SLAVES
);

2977 ià(
£rv”
.
şu¡”
->
çov”_auth_£Á
 == 0 &&

2978 
£rv”
.
şu¡”
->
mf_’d
 == 0)

2980 
Ãw¿nk
 = 
	`şu¡”G‘SÏveRªk
();

2981 ià(
Ãw¿nk
 > 
£rv”
.
şu¡”
->
çov”_auth_¿nk
) {

2982 
added_d–ay
 =

2983 (
Ãw¿nk
 - 
£rv”
.
şu¡”
->
çov”_auth_¿nk
) * 1000;

2984 
£rv”
.
şu¡”
->
çov”_auth_time
 +ğ
added_d–ay
;

2985 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 
Ãw¿nk
;

2986 
	`£rv”Log
(
LL_WARNING
,

2988 
Ãw¿nk
, 
added_d–ay
);

2993 ià(
	`m¡ime
(è< 
£rv”
.
şu¡”
->
çov”_auth_time
) {

2994 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_WAITING_DELAY
);

2999 ià(
auth_age
 > 
auth_timeout
) {

3000 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_EXPIRED
);

3005 ià(
£rv”
.
şu¡”
->
çov”_auth_£Á
 == 0) {

3006 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

3007 
£rv”
.
şu¡”
->
çov”_auth_•och
 = s”v”.şu¡”->
cu¼’tEpoch
;

3008 
	`£rv”Log
(
LL_WARNING
,"Starting‡ failoverƒlection forƒpoch %llu.",

3009 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

3010 
	`şu¡”Reque¡Faov”Auth
();

3011 
£rv”
.
şu¡”
->
çov”_auth_£Á
 = 1;

3012 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

3013 
CLUSTER_TODO_UPDATE_STATE
|

3014 
CLUSTER_TODO_FSYNC_CONFIG
);

3019 ià(
£rv”
.
şu¡”
->
çov”_auth_couÁ
 >ğ
Ãeded_quÜum
) {

3022 
	`£rv”Log
(
LL_WARNING
,

3026 ià(
my£lf
->
cÚfigEpoch
 < 
£rv”
.
şu¡”
->
çov”_auth_•och
) {

3027 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
çov”_auth_•och
;

3028 
	`£rv”Log
(
LL_WARNING
,

3030 (è
my£lf
->
cÚfigEpoch
);

3034 
	`şu¡”Faov”R•ÏûYourMa¡”
();

3036 
	`şu¡”LogCªtFaov”
(
CLUSTER_CANT_FAILOVER_WAITING_VOTES
);

3038 
	}
}

3067 
	$şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
) {

3068 
j
, 
ok¦aves
 = 0;

3069 
şu¡”Node
 *
myma¡”
 = 
my£lf
->
¦aveof
, *
rg‘
 = 
NULL
, *
ÿndid©e
 = NULL;

3070 
diùI‹¿tÜ
 *
di
;

3071 
diùEÁry
 *
de
;

3074 ià(
£rv”
.
şu¡”
->
¡©e
 !ğ
CLUSTER_OK
) ;

3078 ià(
myma¡”
 =ğ
NULL
) ;

3079 
j
 = 0; j < 
myma¡”
->
num¦aves
; j++)

3080 ià(!
	`nodeFaed
(
myma¡”
->
¦aves
[
j
]) &&

3081 !
	`nodeTimedOut
(
myma¡”
->
¦aves
[
j
])è
ok¦aves
++;

3082 ià(
ok¦aves
 <ğ
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
) ;

3094 
ÿndid©e
 = 
my£lf
;

3095 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3096 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3097 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3098 
ok¦aves
 = 0, 
is_Üphªed
 = 1;

3104 ià(
	`nodeIsSÏve
(
node
è|| 
	`nodeFaed
Òode)è
is_Üphªed
 = 0;

3105 ià(!(
node
->
æags
 & 
CLUSTER_NODE_MIGRATE_TO
)è
is_Üphªed
 = 0;

3108 ià(
	`nodeIsMa¡”
(
node
)è
ok¦aves
 = 
	`şu¡”CouÁNÚFašgSÏves
(node);

3109 ià(
ok¦aves
 > 0è
is_Üphªed
 = 0;

3111 ià(
is_Üphªed
) {

3112 ià(!
rg‘
 && 
node
->
num¦Ùs
 > 0)arget =‚ode;

3116 ià(!
node
->
Üphªed_time
ènode->Üphªed_timğ
	`m¡ime
();

3118 
node
->
Üphªed_time
 = 0;

3124 ià(
ok¦aves
 =ğ
max_¦aves
) {

3125 
j
 = 0; j < 
node
->
num¦aves
; j++) {

3126 ià(
	`memcmp
(
node
->
¦aves
[
j
]->
Çme
,

3127 
ÿndid©e
->
Çme
,

3128 
CLUSTER_NAMELEN
) < 0)

3130 
ÿndid©e
 = 
node
->
¦aves
[
j
];

3135 
	`diùR–—£I‹¿tÜ
(
di
);

3142 ià(
rg‘
 && 
ÿndid©e
 =ğ
my£lf
 &&

3143 (
	`m¡ime
()-
rg‘
->
Üphªed_time
è> 
CLUSTER_SLAVE_MIGRATION_DELAY
)

3145 
	`£rv”Log
(
LL_WARNING
,"Migratingo orphaned master %.40s",

3146 
rg‘
->
Çme
);

3147 
	`şu¡”S‘Ma¡”
(
rg‘
);

3149 
	}
}

3185 
	$»£tMªu®Faov”
() {

3186 ià(
£rv”
.
şu¡”
->
mf_’d
 && 
	`ş›ÁsA»Pau£d
()) {

3187 
£rv”
.
ş›Ás_·u£_’d_time
 = 0;

3188 
	`ş›ÁsA»Pau£d
();

3190 
£rv”
.
şu¡”
->
mf_’d
 = 0;

3191 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 0;

3192 
£rv”
.
şu¡”
->
mf_¦ave
 = 
NULL
;

3193 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 = 0;

3194 
	}
}

3197 
	$mªu®Faov”CheckTimeout
() {

3198 ià(
£rv”
.
şu¡”
->
mf_’d
 && s”v”.şu¡”->mf_’d < 
	`m¡ime
()) {

3199 
	`£rv”Log
(
LL_WARNING
,"Manual failoverimed out.");

3200 
	`»£tMªu®Faov”
();

3202 
	}
}

3206 
	$şu¡”HªdËMªu®Faov”
() {

3208 ià(
£rv”
.
şu¡”
->
mf_’d
 == 0) ;

3212 ià(
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
) ;

3214 ià(
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 == 0) ;

3216 ià(
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 =ğ
	`»¶iÿtiÚG‘SÏveOff£t
()) {

3219 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 1;

3220 
	`£rv”Log
(
LL_WARNING
,

3224 
	}
}

3231 
	$şu¡”CrÚ
() {

3232 
diùI‹¿tÜ
 *
di
;

3233 
diùEÁry
 *
de
;

3234 
upd©e_¡©e
 = 0;

3235 
Üphªed_ma¡”s
;

3236 
max_¦aves
;

3237 
this_¦aves
;

3238 
m¡ime_t
 
mš_pÚg
 = 0, 
now
 = 
	`m¡ime
();

3239 
şu¡”Node
 *
mš_pÚg_node
 = 
NULL
;

3240 
™”©iÚ
 = 0;

3241 
m¡ime_t
 
hªdshake_timeout
;

3243 
™”©iÚ
++;

3249 *
´ev_
 = 
NULL
;

3250 *
cu¼_
 = 
£rv”
.
şu¡”_ªnounû_
;

3251 
chªged
 = 0;

3253 ià(
´ev_
 =ğ
NULL
 && 
cu¼_
 !ğNULLè
chªged
 = 1;

3254 ià(
´ev_
 !ğ
NULL
 && 
cu¼_
 =ğNULLè
chªged
 = 1;

3255 ià(
´ev_
 && 
cu¼_
 && 
	`¡rcmp
Õ»v_,cu¼_)è
chªged
 = 1;

3257 ià(
chªged
) {

3258 
´ev_
 = 
cu¼_
;

3259 ià(
´ev_
è´ev_ = 
	`z¡rdup
(prev_ip);

3261 ià(
cu¼_
) {

3262 
	`¡ºıy
(
my£lf
->

,
£rv”
.
şu¡”_ªnounû_
,
NET_IP_STR_LEN
);

3263 
my£lf
->

[
NET_IP_STR_LEN
-1] = '\0';

3265 
my£lf
->

[0] = '\0';

3274 
hªdshake_timeout
 = 
£rv”
.
şu¡”_node_timeout
;

3275 ià(
hªdshake_timeout
 < 1000) handshake_timeout = 1000;

3278 
	`şu¡”Upd©eMy£lfFÏgs
();

3283 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3284 
£rv”
.
şu¡”
->
¡©s_pç_nodes
 = 0;

3285 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3286 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3290 ià(
node
->
æags
 & (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_NOADDR
)) ;

3292 ià(
node
->
æags
 & 
CLUSTER_NODE_PFAIL
)

3293 
£rv”
.
şu¡”
->
¡©s_pç_nodes
++;

3297 ià(
	`nodeInHªdshake
(
node
è&& 
now
 -‚ode->
ùime
 > 
hªdshake_timeout
) {

3298 
	`şu¡”D–Node
(
node
);

3302 ià(
node
->
lšk
 =ğ
NULL
) {

3303 
fd
;

3304 
m¡ime_t
 
Şd_pšg_£Á
;

3305 
şu¡”Lšk
 *
lšk
;

3307 
fd
 = 
	`ª‘TıNÚBlockBšdCÚÃù
(
£rv”
.
Ã‹¼
, 
node
->

,

3308 
node
->
ıÜt
, 
NET_FIRST_BIND_ADDR
);

3309 ià(
fd
 == -1) {

3315 ià(
node
->
pšg_£Á
 =ğ0ènode->pšg_£Á = 
	`m¡ime
();

3316 
	`£rv”Log
(
LL_DEBUG
, "Unableo connecto "

3317 "Clu¡” Nod[%s]:%d -> %s", 
node
->

,

3318 
node
->
ıÜt
, 
£rv”
.
Ã‹¼
);

3321 
lšk
 = 
	`ü—‹Clu¡”Lšk
(
node
);

3322 
lšk
->
fd
 = fd;

3323 
node
->
lšk
 =†ink;

3324 
	`«C»©eFeEv’t
(
£rv”
.
–
,
lšk
->
fd
,
AE_READABLE
,

3325 
şu¡”R—dHªdËr
,
lšk
);

3332 
Şd_pšg_£Á
 = 
node
->
pšg_£Á
;

3333 
	`şu¡”S’dPšg
(
lšk
, 
node
->
æags
 & 
CLUSTER_NODE_MEET
 ?

3334 
CLUSTERMSG_TYPE_MEET
 : 
CLUSTERMSG_TYPE_PING
);

3335 ià(
Şd_pšg_£Á
) {

3339 
node
->
pšg_£Á
 = 
Şd_pšg_£Á
;

3346 
node
->
æags
 &ğ~
CLUSTER_NODE_MEET
;

3348 
	`£rv”Log
(
LL_DEBUG
,"Connecting with Node %.40s‡t %s:%d",

3349 
node
->
Çme
,‚ode->

,‚ode->
ıÜt
);

3352 
	`diùR–—£I‹¿tÜ
(
di
);

3356 ià(!(
™”©iÚ
 % 10)) {

3357 
j
;

3361 
j
 = 0; j < 5; j++) {

3362 
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
şu¡”
->
nodes
);

3363 
şu¡”Node
 *
this
 = 
	`diùG‘V®
(
de
);

3366 ià(
this
->
lšk
 =ğ
NULL
 ||his->
pšg_£Á
 != 0) ;

3367 ià(
this
->
æags
 & (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_HANDSHAKE
))

3369 ià(
mš_pÚg_node
 =ğ
NULL
 || 
mš_pÚg
 > 
this
->
pÚg_»ûived
) {

3370 
mš_pÚg_node
 = 
this
;

3371 
mš_pÚg
 = 
this
->
pÚg_»ûived
;

3374 ià(
mš_pÚg_node
) {

3375 
	`£rv”Log
(
LL_DEBUG
,"Pšgšg‚od%.40s", 
mš_pÚg_node
->
Çme
);

3376 
	`şu¡”S’dPšg
(
mš_pÚg_node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3386 
Üphªed_ma¡”s
 = 0;

3387 
max_¦aves
 = 0;

3388 
this_¦aves
 = 0;

3389 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3390 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3391 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3392 
now
 = 
	`m¡ime
();

3393 
m¡ime_t
 
d–ay
;

3395 ià(
node
->
æags
 &

3396 (
CLUSTER_NODE_MYSELF
|
CLUSTER_NODE_NOADDR
|
CLUSTER_NODE_HANDSHAKE
))

3401 ià(
	`nodeIsSÏve
(
my£lf
è&& 
	`nodeIsMa¡”
(
node
è&& !
	`nodeFaed
(node)) {

3402 
ok¦aves
 = 
	`şu¡”CouÁNÚFašgSÏves
(
node
);

3407 ià(
ok¦aves
 =ğ0 && 
node
->
num¦Ùs
 > 0 &&

3408 
node
->
æags
 & 
CLUSTER_NODE_MIGRATE_TO
)

3410 
Üphªed_ma¡”s
++;

3412 ià(
ok¦aves
 > 
max_¦aves
) max_slaves = okslaves;

3413 ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
node
)

3414 
this_¦aves
 = 
ok¦aves
;

3420 ià(
node
->
lšk
 &&

3421 
now
 - 
node
->
lšk
->
ùime
 >

3422 
£rv”
.
şu¡”_node_timeout
 &&

3423 
node
->
pšg_£Á
 &&

3424 
node
->
pÚg_»ûived
 <‚ode->
pšg_£Á
 &&

3426 
now
 - 
node
->
pšg_£Á
 > 
£rv”
.
şu¡”_node_timeout
/2)

3429 
	`ä“Clu¡”Lšk
(
node
->
lšk
);

3436 ià(
node
->
lšk
 &&

3437 
node
->
pšg_£Á
 == 0 &&

3438 (
now
 - 
node
->
pÚg_»ûived
è> 
£rv”
.
şu¡”_node_timeout
/2)

3440 
	`şu¡”S’dPšg
(
node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3446 ià(
£rv”
.
şu¡”
->
mf_’d
 &&

3447 
	`nodeIsMa¡”
(
my£lf
) &&

3448 
£rv”
.
şu¡”
->
mf_¦ave
 =ğ
node
 &&

3449 
node
->
lšk
)

3451 
	`şu¡”S’dPšg
(
node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3456 ià(
node
->
pšg_£Á
 == 0) ;

3461 
d–ay
 = 
now
 - 
node
->
pšg_£Á
;

3463 ià(
d–ay
 > 
£rv”
.
şu¡”_node_timeout
) {

3466 ià(!(
node
->
æags
 & (
CLUSTER_NODE_PFAIL
|
CLUSTER_NODE_FAIL
))) {

3467 
	`£rv”Log
(
LL_DEBUG
,"*** NODE %.40s…ossibly failing",

3468 
node
->
Çme
);

3469 
node
->
æags
 |ğ
CLUSTER_NODE_PFAIL
;

3470 
upd©e_¡©e
 = 1;

3474 
	`diùR–—£I‹¿tÜ
(
di
);

3479 ià(
	`nodeIsSÏve
(
my£lf
) &&

3480 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

3481 
my£lf
->
¦aveof
 &&

3482 
	`nodeHasAddr
(
my£lf
->
¦aveof
))

3484 
	`»¶iÿtiÚS‘Ma¡”
(
my£lf
->
¦aveof
->

, my£lf->¦aveof->
pÜt
);

3488 
	`mªu®Faov”CheckTimeout
();

3490 ià(
	`nodeIsSÏve
(
my£lf
)) {

3491 
	`şu¡”HªdËMªu®Faov”
();

3492 
	`şu¡”HªdËSÏveFaov”
();

3498 ià(
Üphªed_ma¡”s
 && 
max_¦aves
 >ğ2 && 
this_¦aves
 == max_slaves)

3499 
	`şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
);

3502 ià(
upd©e_¡©e
 || 
£rv”
.
şu¡”
->
¡©e
 =ğ
CLUSTER_FAIL
)

3503 
	`şu¡”Upd©eS‹
();

3504 
	}
}

3511 
	$şu¡”BefÜeSË•
() {

3514 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_HANDLE_FAILOVER
)

3515 
	`şu¡”HªdËSÏveFaov”
();

3518 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_UPDATE_STATE
)

3519 
	`şu¡”Upd©eS‹
();

3522 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_SAVE_CONFIG
) {

3523 
fsync
 = 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &

3524 
CLUSTER_TODO_FSYNC_CONFIG
;

3525 
	`şu¡”SaveCÚfigOrD›
(
fsync
);

3530 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 = 0;

3531 
	}
}

3533 
	$şu¡”DoBefÜeSË•
(
æags
) {

3534 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 |ğ
æags
;

3535 
	}
}

3543 
	$b™m­Te¡B™
(*
b™m­
, 
pos
) {

3544 
off_t
 
by‹
 = 
pos
/8;

3545 
b™
 = 
pos
&7;

3546  (
b™m­
[
by‹
] & (1<<
b™
)) != 0;

3547 
	}
}

3550 
	$b™m­S‘B™
(*
b™m­
, 
pos
) {

3551 
off_t
 
by‹
 = 
pos
/8;

3552 
b™
 = 
pos
&7;

3553 
b™m­
[
by‹
] |ğ1<<
b™
;

3554 
	}
}

3557 
	$b™m­CË¬B™
(*
b™m­
, 
pos
) {

3558 
off_t
 
by‹
 = 
pos
/8;

3559 
b™
 = 
pos
&7;

3560 
b™m­
[
by‹
] &ğ~(1<<
b™
);

3561 
	}
}

3566 
	$şu¡”Ma¡”sHaveSÏves
() {

3567 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3568 
diùEÁry
 *
de
;

3569 
¦aves
 = 0;

3570 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3571 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3573 ià(
	`nodeIsSÏve
(
node
)) ;

3574 
¦aves
 +ğ
node
->
num¦aves
;

3576 
	`diùR–—£I‹¿tÜ
(
di
);

3577  
¦aves
 != 0;

3578 
	}
}

3581 
	$şu¡”NodeS‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3582 
Şd
 = 
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3583 
	`b™m­S‘B™
(
n
->
¦Ùs
,
¦Ù
);

3584 ià(!
Şd
) {

3585 
n
->
num¦Ùs
++;

3599 ià(
n
->
num¦Ùs
 =ğ1 && 
	`şu¡”Ma¡”sHaveSÏves
())

3600 
n
->
æags
 |ğ
CLUSTER_NODE_MIGRATE_TO
;

3602  
Şd
;

3603 
	}
}

3606 
	$şu¡”NodeCË¬SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3607 
Şd
 = 
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3608 
	`b™m­CË¬B™
(
n
->
¦Ùs
,
¦Ù
);

3609 ià(
Şd
è
n
->
num¦Ùs
--;

3610  
Şd
;

3611 
	}
}

3614 
	$şu¡”NodeG‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3615  
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3616 
	}
}

3622 
	$şu¡”AddSlÙ
(
şu¡”Node
 *
n
, 
¦Ù
) {

3623 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
]è 
C_ERR
;

3624 
	`şu¡”NodeS‘SlÙB™
(
n
,
¦Ù
);

3625 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] = 
n
;

3626  
C_OK
;

3627 
	}
}

3632 
	$şu¡”D–SlÙ
(
¦Ù
) {

3633 
şu¡”Node
 *
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

3635 ià(!
n
è 
C_ERR
;

3636 
	`£rv”As£¹
(
	`şu¡”NodeCË¬SlÙB™
(
n
,
¦Ù
) == 1);

3637 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] = 
NULL
;

3638  
C_OK
;

3639 
	}
}

3643 
	$şu¡”D–NodeSlÙs
(
şu¡”Node
 *
node
) {

3644 
d–‘ed
 = 0, 
j
;

3646 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3647 ià(
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)) {

3648 
	`şu¡”D–SlÙ
(
j
);

3649 
d–‘ed
++;

3652  
d–‘ed
;

3653 
	}
}

3657 
	$şu¡”Clo£AÎSlÙs
() {

3658 
	`mem£t
(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
,0,

3659 (
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
));

3660 
	`mem£t
(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
,0,

3661 (
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
));

3662 
	}
}

3672 
	#CLUSTER_MAX_REJOIN_DELAY
 5000

	)

3673 
	#CLUSTER_MIN_REJOIN_DELAY
 500

	)

3674 
	#CLUSTER_WRITABLE_DELAY
 2000

	)

3676 
	$şu¡”Upd©eS‹
() {

3677 
j
, 
Ãw_¡©e
;

3678 
»achabË_ma¡”s
 = 0;

3679 
m¡ime_t
 
amÚg_mšÜ™y_time
;

3680 
m¡ime_t
 
fœ¡_ÿÎ_time
 = 0;

3682 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_UPDATE_STATE
;

3690 ià(
fœ¡_ÿÎ_time
 =ğ0èfœ¡_ÿÎ_timğ
	`m¡ime
();

3691 ià(
	`nodeIsMa¡”
(
my£lf
) &&

3692 
£rv”
.
şu¡”
->
¡©e
 =ğ
CLUSTER_FAIL
 &&

3693 
	`m¡ime
(è- 
fœ¡_ÿÎ_time
 < 
CLUSTER_WRITABLE_DELAY
) ;

3697 
Ãw_¡©e
 = 
CLUSTER_OK
;

3700 ià(
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
) {

3701 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3702 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

3703 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
æags
 & (
CLUSTER_NODE_FAIL
))

3705 
Ãw_¡©e
 = 
CLUSTER_FAIL
;

3717 
diùI‹¿tÜ
 *
di
;

3718 
diùEÁry
 *
de
;

3720 
£rv”
.
şu¡”
->
size
 = 0;

3721 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3722 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3723 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3725 ià(
	`nodeIsMa¡”
(
node
è&&‚ode->
num¦Ùs
) {

3726 
£rv”
.
şu¡”
->
size
++;

3727 ià((
node
->
æags
 & (
CLUSTER_NODE_FAIL
|
CLUSTER_NODE_PFAIL
)) == 0)

3728 
»achabË_ma¡”s
++;

3731 
	`diùR–—£I‹¿tÜ
(
di
);

3737 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

3739 ià(
»achabË_ma¡”s
 < 
Ãeded_quÜum
) {

3740 
Ãw_¡©e
 = 
CLUSTER_FAIL
;

3741 
amÚg_mšÜ™y_time
 = 
	`m¡ime
();

3746 ià(
Ãw_¡©e
 !ğ
£rv”
.
şu¡”
->
¡©e
) {

3747 
m¡ime_t
 
»još_d–ay
 = 
£rv”
.
şu¡”_node_timeout
;

3753 ià(
»još_d–ay
 > 
CLUSTER_MAX_REJOIN_DELAY
)

3754 
»još_d–ay
 = 
CLUSTER_MAX_REJOIN_DELAY
;

3755 ià(
»još_d–ay
 < 
CLUSTER_MIN_REJOIN_DELAY
)

3756 
»još_d–ay
 = 
CLUSTER_MIN_REJOIN_DELAY
;

3758 ià(
Ãw_¡©e
 =ğ
CLUSTER_OK
 &&

3759 
	`nodeIsMa¡”
(
my£lf
) &&

3760 
	`m¡ime
(è- 
amÚg_mšÜ™y_time
 < 
»još_d–ay
)

3766 
	`£rv”Log
(
LL_WARNING
,"Cluster state changed: %s",

3767 
Ãw_¡©e
 =ğ
CLUSTER_OK
 ? "ok" : "fail");

3768 
£rv”
.
şu¡”
->
¡©e
 = 
Ãw_¡©e
;

3770 
	}
}

3794 
	$v”ifyClu¡”CÚfigW™hD©a
() {

3795 
j
;

3796 
upd©e_cÚfig
 = 0;

3800 ià(
	`nodeIsSÏve
(
my£lf
)è 
C_OK
;

3803 
j
 = 1; j < 
£rv”
.
dbnum
; j++) {

3804 ià(
	`diùSize
(
£rv”
.
db
[
j
].
diù
)è 
C_ERR
;

3809 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3810 ià(!
	`couÁKeysInSlÙ
(
j
)) ;

3814 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
my£lf
 ||

3815 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] !ğ
NULL
) ;

3821 
upd©e_cÚfig
++;

3823 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
) {

3824 
	`£rv”Log
(
LL_WARNING
, "I have keys for unassigned slot %d. "

3825 "Takšg„e¥Úsib™y fÜ it.",
j
);

3826 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

3828 
	`£rv”Log
(
LL_WARNING
, "I have keys for slot %d, buthe slot is "

3830 "S‘tšg iˆtØimpÜtšg s‹.",
j
);

3831 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = s”v”.şu¡”->
¦Ùs
[j];

3834 ià(
upd©e_cÚfig
è
	`şu¡”SaveCÚfigOrD›
(1);

3835  
C_OK
;

3836 
	}
}

3844 
	$şu¡”S‘Ma¡”
(
şu¡”Node
 *
n
) {

3845 
	`£rv”As£¹
(
n
 !ğ
my£lf
);

3846 
	`£rv”As£¹
(
my£lf
->
num¦Ùs
 == 0);

3848 ià(
	`nodeIsMa¡”
(
my£lf
)) {

3849 
my£lf
->
æags
 &ğ~(
CLUSTER_NODE_MASTER
|
CLUSTER_NODE_MIGRATE_TO
);

3850 
my£lf
->
æags
 |ğ
CLUSTER_NODE_SLAVE
;

3851 
	`şu¡”Clo£AÎSlÙs
();

3853 ià(
my£lf
->
¦aveof
)

3854 
	`şu¡”NodeRemoveSÏve
(
my£lf
->
¦aveof
,myself);

3856 
my£lf
->
¦aveof
 = 
n
;

3857 
	`şu¡”NodeAddSÏve
(
n
,
my£lf
);

3858 
	`»¶iÿtiÚS‘Ma¡”
(
n
->

,‚->
pÜt
);

3859 
	`»£tMªu®Faov”
();

3860 
	}
}

3866 
	s»disNodeFÏgs
 {

3867 
ušt16_t
 
	mæag
;

3868 *
	mÇme
;

3871 
»disNodeFÏgs
 
	g»disNodeFÏgsTabË
[] = {

3872 {
CLUSTER_NODE_MYSELF
, "myself,"},

3873 {
CLUSTER_NODE_MASTER
, "master,"},

3874 {
CLUSTER_NODE_SLAVE
, "slave,"},

3875 {
CLUSTER_NODE_PFAIL
, "fail?,"},

3876 {
CLUSTER_NODE_FAIL
, "fail,"},

3877 {
CLUSTER_NODE_HANDSHAKE
, "handshake,"},

3878 {
CLUSTER_NODE_NOADDR
, "noaddr,"},

3879 {
CLUSTER_NODE_NOFAILOVER
, "nofailover,"}

3884 
sds
 
	$»´e£ÁClu¡”NodeFÏgs
(
sds
 
ci
, 
ušt16_t
 
æags
) {

3885 
size_t
 
Üig_Ën
 = 
	`sd¦’
(
ci
);

3886 
i
, 
size
 = (
»disNodeFÏgsTabË
)/(
»disNodeFÏgs
);

3887 
i
 = 0; i < 
size
; i++) {

3888 
»disNodeFÏgs
 *
nodeæag
 = 
»disNodeFÏgsTabË
 + 
i
;

3889 ià(
æags
 & 
nodeæag
->
æag
è
ci
 = 
	`sdsÿt
(ci,‚odeæag->
Çme
);

3892 ià(
	`sd¦’
(
ci
è=ğ
Üig_Ën
èc˜ğ
	`sdsÿt
(ci,"noflags,");

3893 
	`sdsInüL’
(
ci
,-1);

3894  
ci
;

3895 
	}
}

3901 
sds
 
	$şu¡”G’NodeDesütiÚ
(
şu¡”Node
 *
node
) {

3902 
j
, 
¡¬t
;

3903 
sds
 
ci
;

3906 
ci
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%.40s %s:%d@%d ",

3907 
node
->
Çme
,

3908 
node
->

,

3909 
node
->
pÜt
,

3910 
node
->
ıÜt
);

3913 
ci
 = 
	`»´e£ÁClu¡”NodeFÏgs
(ci, 
node
->
æags
);

3916 ià(
node
->
¦aveof
)

3917 
ci
 = 
	`sdsÿrštf
(ci," %.40 ",
node
->
¦aveof
->
Çme
);

3919 
ci
 = 
	`sdsÿ’
(ci," - ",3);

3922 
ci
 = 
	`sdsÿrštf
(ci,"%lld %lld %llu %s",

3923 (è
node
->
pšg_£Á
,

3924 (è
node
->
pÚg_»ûived
,

3925 (è
node
->
cÚfigEpoch
,

3926 (
node
->
lšk
 ||‚ode->
æags
 & 
CLUSTER_NODE_MYSELF
) ?

3930 
¡¬t
 = -1;

3931 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3932 
b™
;

3934 ià((
b™
 = 
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)) != 0) {

3935 ià(
¡¬t
 =ğ-1è¡¬ˆğ
j
;

3937 ià(
¡¬t
 !ğ-1 && (!
b™
 || 
j
 =ğ
CLUSTER_SLOTS
-1)) {

3938 ià(
b™
 && 
j
 =ğ
CLUSTER_SLOTS
-1) j++;

3940 ià(
¡¬t
 =ğ
j
-1) {

3941 
ci
 = 
	`sdsÿrštf
(ci," %d",
¡¬t
);

3943 
ci
 = 
	`sdsÿrštf
(ci," %d-%d",
¡¬t
,
j
-1);

3945 
¡¬t
 = -1;

3952 ià(
node
->
æags
 & 
CLUSTER_NODE_MYSELF
) {

3953 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

3954 ià(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
]) {

3955 
ci
 = 
	`sdsÿrštf
(ci," [%d->-%.40s]",
j
,

3956 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
]->
Çme
);

3957 } ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]) {

3958 
ci
 = 
	`sdsÿrštf
(ci," [%d-<-%.40s]",
j
,

3959 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]->
Çme
);

3963  
ci
;

3964 
	}
}

3978 
sds
 
	$şu¡”G’NodesDesütiÚ
(
f‹r
) {

3979 
sds
 
ci
 = 
	`sd£m±y
(), 
ni
;

3980 
diùI‹¿tÜ
 *
di
;

3981 
diùEÁry
 *
de
;

3983 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3984 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3985 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3987 ià(
node
->
æags
 & 
f‹r
) ;

3988 
ni
 = 
	`şu¡”G’NodeDesütiÚ
(
node
);

3989 
ci
 = 
	`sdsÿtsds
(ci,
ni
);

3990 
	`sdsä“
(
ni
);

3991 
ci
 = 
	`sdsÿ’
(ci,"\n",1);

3993 
	`diùR–—£I‹¿tÜ
(
di
);

3994  
ci
;

3995 
	}
}

4001 cÚ¡ *
	$şu¡”G‘Mes§geTy³SŒšg
(
ty³
) {

4002 
ty³
) {

4003 
CLUSTERMSG_TYPE_PING
:  "ping";

4004 
CLUSTERMSG_TYPE_PONG
:  "pong";

4005 
CLUSTERMSG_TYPE_MEET
:  "meet";

4006 
CLUSTERMSG_TYPE_FAIL
:  "fail";

4007 
CLUSTERMSG_TYPE_PUBLISH
:  "publish";

4008 
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
:  "auth-req";

4009 
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
:  "auth-ack";

4010 
CLUSTERMSG_TYPE_UPDATE
:  "update";

4011 
CLUSTERMSG_TYPE_MFSTART
:  "mfstart";

4014 
	}
}

4016 
	$g‘SlÙOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
) {

4017 
¦Ù
;

4019 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
¦Ù
è!ğ
C_OK
 ||

4020 
¦Ù
 < 0 || slÙ >ğ
CLUSTER_SLOTS
)

4022 
	`addR•lyE¼Ü
(
c
,"Invalid or out of„ange slot");

4025  (è
¦Ù
;

4026 
	}
}

4028 
	$şu¡”R•lyMuÉiBulkSlÙs
(
ş›Á
 *
c
) {

4040 
num_ma¡”s
 = 0;

4041 *
¦Ù_»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

4043 
diùEÁry
 *
de
;

4044 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

4045 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4046 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

4047 
j
 = 0, 
¡¬t
 = -1;

4051 ià(!
	`nodeIsMa¡”
(
node
è||‚ode->
num¦Ùs
 == 0) ;

4053 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

4054 
b™
, 
i
;

4056 ià((
b™
 = 
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)) != 0) {

4057 ià(
¡¬t
 =ğ-1è¡¬ˆğ
j
;

4059 ià(
¡¬t
 !ğ-1 && (!
b™
 || 
j
 =ğ
CLUSTER_SLOTS
-1)) {

4060 
Ã¡ed_–em’ts
 = 3;

4061 *
Ã¡ed_»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

4063 ià(
b™
 && 
j
 =ğ
CLUSTER_SLOTS
-1) j++;

4067 ià(
¡¬t
 =ğ
j
-1) {

4068 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

4069 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

4071 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

4072 
	`addR•lyLÚgLÚg
(
c
, 
j
-1);

4074 
¡¬t
 = -1;

4077 
	`addR•lyMuÉiBulkL’
(
c
, 3);

4078 
	`addR•lyBulkCSŒšg
(
c
, 
node
->

);

4079 
	`addR•lyLÚgLÚg
(
c
, 
node
->
pÜt
);

4080 
	`addR•lyBulkCBufãr
(
c
, 
node
->
Çme
, 
CLUSTER_NAMELEN
);

4083 
i
 = 0; i < 
node
->
num¦aves
; i++) {

4086 ià(
	`nodeFaed
(
node
->
¦aves
[
i
])) ;

4087 
	`addR•lyMuÉiBulkL’
(
c
, 3);

4088 
	`addR•lyBulkCSŒšg
(
c
, 
node
->
¦aves
[
i
]->

);

4089 
	`addR•lyLÚgLÚg
(
c
, 
node
->
¦aves
[
i
]->
pÜt
);

4090 
	`addR•lyBulkCBufãr
(
c
, 
node
->
¦aves
[
i
]->
Çme
, 
CLUSTER_NAMELEN
);

4091 
Ã¡ed_–em’ts
++;

4093 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
Ã¡ed_»¶yËn
, 
Ã¡ed_–em’ts
);

4094 
num_ma¡”s
++;

4098 
	`diùR–—£I‹¿tÜ
(
di
);

4099 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
¦Ù_»¶yËn
, 
num_ma¡”s
);

4100 
	}
}

4102 
	$şu¡”Commªd
(
ş›Á
 *
c
) {

4103 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

4104 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

4108 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"m“t"è&& (c->
¬gc
 == 4 || c->argc == 5)) {

4110 
pÜt
, 
ıÜt
;

4112 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[3], &
pÜt
è!ğ
C_OK
) {

4113 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid TCP base…ort specified: %s",

4114 (*)
c
->
¬gv
[3]->
±r
);

4118 ià(
c
->
¬gc
 == 5) {

4119 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[4], &
ıÜt
è!ğ
C_OK
) {

4120 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid TCP bus…ort specified: %s",

4121 (*)
c
->
¬gv
[4]->
±r
);

4125 
ıÜt
 = 
pÜt
 + 
CLUSTER_PORT_INCR
;

4128 ià(
	`şu¡”S¹Hªdshake
(
c
->
¬gv
[2]->
±r
,
pÜt
,
ıÜt
) == 0 &&

4129 
”ºo
 =ğ
EINVAL
)

4131 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‚ode‡ddress specified: %s:%s",

4132 (*)
c
->
¬gv
[2]->
±r
, (*)c->argv[3]->ptr);

4134 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4136 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"nodes"è&& c->
¬gc
 == 2) {

4138 
robj
 *
o
;

4139 
sds
 
ci
 = 
	`şu¡”G’NodesDesütiÚ
(0);

4141 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
ci
);

4142 
	`addR•lyBulk
(
c
,
o
);

4143 
	`deüRefCouÁ
(
o
);

4144 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"myid"è&& c->
¬gc
 == 2) {

4146 
	`addR•lyBulkCBufãr
(
c
,
my£lf
->
Çme
, 
CLUSTER_NAMELEN
);

4147 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦Ùs"è&& c->
¬gc
 == 2) {

4149 
	`şu¡”R•lyMuÉiBulkSlÙs
(
c
);

4150 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"æush¦Ùs"è&& c->
¬gc
 == 2) {

4152 ià(
	`diùSize
(
£rv”
.
db
[0].
diù
) != 0) {

4153 
	`addR•lyE¼Ü
(
c
,"DB must beƒmptyo…erform CLUSTER FLUSHSLOTS.");

4156 
	`şu¡”D–NodeSlÙs
(
my£lf
);

4157 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

4158 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4159 } ià((!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"addslots") ||

4160 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"d–¦Ùs")è&& c->
¬gc
 >= 3)

4164 
j
, 
¦Ù
;

4165 *
¦Ùs
 = 
	`zm®loc
(
CLUSTER_SLOTS
);

4166 
d–
 = !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"delslots");

4168 
	`mem£t
(
¦Ùs
,0,
CLUSTER_SLOTS
);

4171 
j
 = 2; j < 
c
->
¬gc
; j++) {

4172 ià((
¦Ù
 = 
	`g‘SlÙOrR•ly
(
c
,c->
¬gv
[
j
])) == -1) {

4173 
	`zä“
(
¦Ùs
);

4176 ià(
d–
 && 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
NULL
) {

4177 
	`addR•lyE¼ÜFÜm©
(
c
,"SlÙ %d i ®»ady uÇssigÃd", 
¦Ù
);

4178 
	`zä“
(
¦Ùs
);

4180 } ià(!
d–
 && 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
]) {

4181 
	`addR•lyE¼ÜFÜm©
(
c
,"SlÙ %d i ®»ady busy", 
¦Ù
);

4182 
	`zä“
(
¦Ùs
);

4185 ià(
¦Ùs
[
¦Ù
]++ == 1) {

4186 
	`addR•lyE¼ÜFÜm©
(
c
,"Slot %d specified multipleimes",

4187 ()
¦Ù
);

4188 
	`zä“
(
¦Ùs
);

4192 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

4193 ià(
¦Ùs
[
j
]) {

4194 
»tv®
;

4198 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
])

4199 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = 
NULL
;

4201 
»tv®
 = 
d–
 ? 
	`şu¡”D–SlÙ
(
j
) :

4202 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

4203 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
»tv®
 =ğ
C_OK
);

4206 
	`zä“
(
¦Ùs
);

4207 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

4208 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4209 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£t¦Ù"è&& c->
¬gc
 >= 4) {

4214 
¦Ù
;

4215 
şu¡”Node
 *
n
;

4217 ià(
	`nodeIsSÏve
(
my£lf
)) {

4218 
	`addR•lyE¼Ü
(
c
,"Please use SETSLOT only with masters.");

4222 ià((
¦Ù
 = 
	`g‘SlÙOrR•ly
(
c
,c->
¬gv
[2])) == -1) ;

4224 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"mig¿tšg"è&& c->
¬gc
 == 5) {

4225 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] !ğ
my£lf
) {

4226 
	`addR•lyE¼ÜFÜm©
(
c
,"I'm‚ÙhowÃ¸oàhash slÙ %u",
¦Ù
);

4229 ià((
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
)è=ğ
NULL
) {

4230 
	`addR•lyE¼ÜFÜm©
(
c
,"I don't know‡bout‚ode %s",

4231 (*)
c
->
¬gv
[4]->
±r
);

4234 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
n
;

4235 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"impÜtšg"è&& c->
¬gc
 == 5) {

4236 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
my£lf
) {

4237 
	`addR•lyE¼ÜFÜm©
(
c
,

4238 "I'm‡Ì—dyhowÃ¸oàhash slÙ %u",
¦Ù
);

4241 ià((
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
)è=ğ
NULL
) {

4242 
	`addR•lyE¼ÜFÜm©
(
c
,"I don't know‡bout‚ode %s",

4243 (*)
c
->
¬gv
[4]->
±r
);

4246 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
n
;

4247 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"¡abË"è&& c->
¬gc
 == 4) {

4249 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
NULL
;

4250 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
NULL
;

4251 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"node"è&& c->
¬gc
 == 5) {

4253 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
);

4255 ià(!
n
) {

4256 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown‚ode %s",

4257 (*)
c
->
¬gv
[4]->
±r
);

4262 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
my£lf
 && 
n
 != myself) {

4263 ià(
	`couÁKeysInSlÙ
(
¦Ù
) != 0) {

4264 
	`addR•lyE¼ÜFÜm©
(
c
,

4266 "whI stÈhŞd key fÜhi hash slÙ.", 
¦Ù
);

4273 ià(
	`couÁKeysInSlÙ
(
¦Ù
) == 0 &&

4274 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
])

4275 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
NULL
;

4279 ià(
n
 =ğ
my£lf
 &&

4280 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
])

4291 ià(
	`şu¡”BumpCÚfigEpochW™houtCÚ£nsus
(è=ğ
C_OK
) {

4292 
	`£rv”Log
(
LL_WARNING
,

4293 "cÚfigEpoch upd©ed‡á” impÜtšg slÙ %d", 
¦Ù
);

4295 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
NULL
;

4297 
	`şu¡”D–SlÙ
(
¦Ù
);

4298 
	`şu¡”AddSlÙ
(
n
,
¦Ù
);

4300 
	`addR•lyE¼Ü
(
c
,

4304 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|
CLUSTER_TODO_UPDATE_STATE
);

4305 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4306 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"bum³poch"è&& c->
¬gc
 == 2) {

4308 
»tv®
 = 
	`şu¡”BumpCÚfigEpochW™houtCÚ£nsus
();

4309 
sds
 
»¶y
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"+%s %llu\r\n",

4310 (
»tv®
 =ğ
C_OK
) ? "BUMPED" : "STILL",

4311 (è
my£lf
->
cÚfigEpoch
);

4312 
	`addR•lySds
(
c
,
»¶y
);

4313 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"šfo"è&& c->
¬gc
 == 2) {

4315 *
¡©e¡r
[] = {"ok","fail","needhelp"};

4316 
¦Ùs_assigÃd
 = 0, 
¦Ùs_ok
 = 0, 
¦Ùs_pç
 = 0, 
¦Ùs_ç
 = 0;

4317 
ušt64_t
 
my•och
;

4318 
j
;

4320 
j
 = 0; j < 
CLUSTER_SLOTS
; j++) {

4321 
şu¡”Node
 *
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
j
];

4323 ià(
n
 =ğ
NULL
) ;

4324 
¦Ùs_assigÃd
++;

4325 ià(
	`nodeFaed
(
n
)) {

4326 
¦Ùs_ç
++;

4327 } ià(
	`nodeTimedOut
(
n
)) {

4328 
¦Ùs_pç
++;

4330 
¦Ùs_ok
++;

4334 
my•och
 = (
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
) ?

4335 
my£lf
->
¦aveof
->
cÚfigEpoch
 : myself->configEpoch;

4337 
sds
 
šfo
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

4347 , 
¡©e¡r
[
£rv”
.
şu¡”
->
¡©e
],

4348 
¦Ùs_assigÃd
,

4349 
¦Ùs_ok
,

4350 
¦Ùs_pç
,

4351 
¦Ùs_ç
,

4352 
	`diùSize
(
£rv”
.
şu¡”
->
nodes
),

4353 
£rv”
.
şu¡”
->
size
,

4354 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
,

4355 (è
my•och


4359 
tÙ_msg_£Á
 = 0;

4360 
tÙ_msg_»ûived
 = 0;

4362 
i
 = 0; i < 
CLUSTERMSG_TYPE_COUNT
; i++) {

4363 ià(
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
[
i
] == 0) ;

4364 
tÙ_msg_£Á
 +ğ
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
[
i
];

4365 
šfo
 = 
	`sdsÿrštf
(info,

4367 
	`şu¡”G‘Mes§geTy³SŒšg
(
i
),

4368 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
[
i
]);

4370 
šfo
 = 
	`sdsÿrštf
(info,

4371 "şu¡”_¡©s_mes§ges_£Á:%Îd\r\n", 
tÙ_msg_£Á
);

4373 
i
 = 0; i < 
CLUSTERMSG_TYPE_COUNT
; i++) {

4374 ià(
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
[
i
] == 0) ;

4375 
tÙ_msg_»ûived
 +ğ
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
[
i
];

4376 
šfo
 = 
	`sdsÿrštf
(info,

4378 
	`şu¡”G‘Mes§geTy³SŒšg
(
i
),

4379 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
[
i
]);

4381 
šfo
 = 
	`sdsÿrštf
(info,

4382 "şu¡”_¡©s_mes§ges_»ûived:%Îd\r\n", 
tÙ_msg_»ûived
);

4385 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"$%lu\r\n",

4386 ()
	`sd¦’
(
šfo
)));

4387 
	`addR•lySds
(
c
,
šfo
);

4388 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

4389 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"§vecÚfig"è&& c->
¬gc
 == 2) {

4390 
»tv®
 = 
	`şu¡”SaveCÚfig
(1);

4392 ià(
»tv®
 == 0)

4393 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4395 
	`addR•lyE¼ÜFÜm©
(
c
,"error savinghe cluster‚ode config: %s",

4396 
	`¡»¼Ü
(
”ºo
));

4397 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"key¦Ù"è&& c->
¬gc
 == 3) {

4399 
sds
 
key
 = 
c
->
¬gv
[2]->
±r
;

4401 
	`addR•lyLÚgLÚg
(
c
,
	`keyHashSlÙ
(
key
,
	`sd¦’
(key)));

4402 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"couÁkeysš¦Ù"è&& c->
¬gc
 == 3) {

4404 
¦Ù
;

4406 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¦Ù
,
NULL
è!ğ
C_OK
)

4408 ià(
¦Ù
 < 0 || slÙ >ğ
CLUSTER_SLOTS
) {

4409 
	`addR•lyE¼Ü
(
c
,"Invalid slot");

4412 
	`addR•lyLÚgLÚg
(
c
,
	`couÁKeysInSlÙ
(
¦Ù
));

4413 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘keysš¦Ù"è&& c->
¬gc
 == 4) {

4415 
maxkeys
, 
¦Ù
;

4416 
numkeys
, 
j
;

4417 
robj
 **
keys
;

4419 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¦Ù
,
NULL
è!ğ
C_OK
)

4421 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
maxkeys
,
NULL
)

4422 !ğ
C_OK
)

4424 ià(
¦Ù
 < 0 || slÙ >ğ
CLUSTER_SLOTS
 || 
maxkeys
 < 0) {

4425 
	`addR•lyE¼Ü
(
c
,"Invalid slot or‚umber of keys");

4431 
keys_š_¦Ù
 = 
	`couÁKeysInSlÙ
(
¦Ù
);

4432 ià(
maxkeys
 > 
keys_š_¦Ù
) maxkeys = keys_in_slot;

4434 
keys
 = 
	`zm®loc
((
robj
*)*
maxkeys
);

4435 
numkeys
 = 
	`g‘KeysInSlÙ
(
¦Ù
, 
keys
, 
maxkeys
);

4436 
	`addR•lyMuÉiBulkL’
(
c
,
numkeys
);

4437 
j
 = 0; j < 
numkeys
; j++) {

4438 
	`addR•lyBulk
(
c
,
keys
[
j
]);

4439 
	`deüRefCouÁ
(
keys
[
j
]);

4441 
	`zä“
(
keys
);

4442 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"fÜg‘"è&& c->
¬gc
 == 3) {

4444 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4446 ià(!
n
) {

4447 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4449 } ià(
n
 =ğ
my£lf
) {

4450 
	`addR•lyE¼Ü
(
c
,"Iried hard but I can't forget myself...");

4452 } ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
n
) {

4453 
	`addR•lyE¼Ü
(
c
,"Can't forget my master!");

4456 
	`şu¡”BÏckli¡AddNode
(
n
);

4457 
	`şu¡”D–Node
(
n
);

4458 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|

4459 
CLUSTER_TODO_SAVE_CONFIG
);

4460 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4461 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»¶iÿ‹"è&& c->
¬gc
 == 3) {

4463 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4466 ià(!
n
) {

4467 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4472 ià(
n
 =ğ
my£lf
) {

4473 
	`addR•lyE¼Ü
(
c
,"Can't„eplicate myself");

4478 ià(
	`nodeIsSÏve
(
n
)) {

4479 
	`addR•lyE¼Ü
(
c
,"I can only„eplicate‡ master,‚ot‡ slave.");

4486 ià(
	`nodeIsMa¡”
(
my£lf
) &&

4487 (
my£lf
->
num¦Ùs
 !ğ0 || 
	`diùSize
(
£rv”
.
db
[0].
diù
) != 0)) {

4488 
	`addR•lyE¼Ü
(
c
,

4495 
	`şu¡”S‘Ma¡”
(
n
);

4496 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

4497 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4498 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦aves"è&& c->
¬gc
 == 3) {

4500 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4501 
j
;

4504 ià(!
n
) {

4505 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4509 ià(
	`nodeIsSÏve
(
n
)) {

4510 
	`addR•lyE¼Ü
(
c
,"The specified‚ode is‚ot‡ master");

4514 
	`addR•lyMuÉiBulkL’
(
c
,
n
->
num¦aves
);

4515 
j
 = 0; j < 
n
->
num¦aves
; j++) {

4516 
sds
 
ni
 = 
	`şu¡”G’NodeDesütiÚ
(
n
->
¦aves
[
j
]);

4517 
	`addR•lyBulkCSŒšg
(
c
,
ni
);

4518 
	`sdsä“
(
ni
);

4520 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"count-failure-reports") &&

4521 
c
->
¬gc
 == 3)

4524 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4526 ià(!
n
) {

4527 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4530 
	`addR•lyLÚgLÚg
(
c
,
	`şu¡”NodeFau»R•ÜtsCouÁ
(
n
));

4532 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"failover") &&

4533 (
c
->
¬gc
 == 2 || c->argc == 3))

4536 
fÜû
 = 0, 
keov”
 = 0;

4538 ià(
c
->
¬gc
 == 3) {

4539 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"force")) {

4540 
fÜû
 = 1;

4541 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"takeover")) {

4542 
keov”
 = 1;

4543 
fÜû
 = 1;

4545 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4551 ià(
	`nodeIsMa¡”
(
my£lf
)) {

4552 
	`addR•lyE¼Ü
(
c
,"You should send CLUSTER FAILOVERo‡ slave");

4554 } ià(
my£lf
->
¦aveof
 =ğ
NULL
) {

4555 
	`addR•lyE¼Ü
(
c
,"I'm‡ slave but my master is unknowno me");

4557 } ià(!
fÜû
 &&

4558 (
	`nodeFaed
(
my£lf
->
¦aveof
) ||

4559 
my£lf
->
¦aveof
->
lšk
 =ğ
NULL
))

4561 
	`addR•lyE¼Ü
(
c
,"Master is down or failed, "

4565 
	`»£tMªu®Faov”
();

4566 
£rv”
.
şu¡”
->
mf_’d
 = 
	`m¡ime
(è+ 
CLUSTER_MF_TIMEOUT
;

4568 ià(
keov”
) {

4573 
	`£rv”Log
(
LL_WARNING
,"Taking overhe master (user„equest).");

4574 
	`şu¡”BumpCÚfigEpochW™houtCÚ£nsus
();

4575 
	`şu¡”Faov”R•ÏûYourMa¡”
();

4576 } ià(
fÜû
) {

4580 
	`£rv”Log
(
LL_WARNING
,"Forced failover user„equest‡ccepted.");

4581 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 1;

4583 
	`£rv”Log
(
LL_WARNING
,"Manual failover user„equest‡ccepted.");

4584 
	`şu¡”S’dMFS¹
(
my£lf
->
¦aveof
);

4586 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4587 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£t-cÚfig-•och"è&& c->
¬gc
 == 3)

4596 
•och
;

4598 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
•och
,
NULL
è!ğ
C_OK
)

4601 ià(
•och
 < 0) {

4602 
	`addR•lyE¼ÜFÜm©
(
c
,"Inv®id cÚfigƒpoch s³cif›d: %Îd",
•och
);

4603 } ià(
	`diùSize
(
£rv”
.
şu¡”
->
nodes
) > 1) {

4604 
	`addR•lyE¼Ü
(
c
,"The user can‡ssign‡ configƒpoch only whenhe "

4606 } ià(
my£lf
->
cÚfigEpoch
 != 0) {

4607 
	`addR•lyE¼Ü
(
c
,"Node configƒpoch is‡lready‚on-zero");

4609 
my£lf
->
cÚfigEpoch
 = 
•och
;

4610 
	`£rv”Log
(
LL_WARNING
,

4612 (è
my£lf
->
cÚfigEpoch
);

4614 ià(
£rv”
.
şu¡”
->
cu¼’tEpoch
 < (
ušt64_t
)
•och
)

4615 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
•och
;

4619 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|

4620 
CLUSTER_TODO_SAVE_CONFIG
);

4621 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4623 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reset") &&

4624 (
c
->
¬gc
 == 2 || c->argc == 3))

4627 
h¬d
 = 0;

4630 ià(
c
->
¬gc
 == 3) {

4631 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"hard")) {

4632 
h¬d
 = 1;

4633 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"soft")) {

4634 
h¬d
 = 0;

4636 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4643 ià(
	`nodeIsMa¡”
(
my£lf
è&& 
	`diùSize
(
c
->
db
->
diù
) != 0) {

4644 
	`addR•lyE¼Ü
(
c
,"CLUSTER RESET can't be called with "

4648 
	`şu¡”Re£t
(
h¬d
);

4649 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4651 
	`addR•lyE¼Ü
(
c
,"Wrong CLUSTER subcommand or‚umber of‡rguments");

4653 
	}
}

4661 
	$ü—‹DumpPaylßd
(
rio
 *
·ylßd
, 
robj
 *
o
) {

4662 
buf
[2];

4663 
ušt64_t
 
üc
;

4667 
	`rioIn™W™hBufãr
(
·ylßd
,
	`sd£m±y
());

4668 
	`£rv”As£¹
(
	`rdbSaveObjeùTy³
(
·ylßd
,
o
));

4669 
	`£rv”As£¹
(
	`rdbSaveObjeù
(
·ylßd
,
o
));

4679 
buf
[0] = 
RDB_VERSION
 & 0xff;

4680 
buf
[1] = (
RDB_VERSION
 >> 8) & 0xff;

4681 
·ylßd
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Õaylßd->io.bufãr.±r,
buf
,2);

4684 
üc
 = 
	`üc64
(0,(*)
·ylßd
->
io
.
bufãr
.
±r
,

4685 
	`sd¦’
(
·ylßd
->
io
.
bufãr
.
±r
));

4686 
	`mem»v64ifbe
(&
üc
);

4687 
·ylßd
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Õaylßd->io.bufãr.±r,&
üc
,8);

4688 
	}
}

4694 
	$v”ifyDumpPaylßd
(*
p
, 
size_t
 
Ën
) {

4695 *
foÙ”
;

4696 
ušt16_t
 
rdbv”
;

4697 
ušt64_t
 
üc
;

4700 ià(
Ën
 < 10è 
C_ERR
;

4701 
foÙ”
 = 
p
+(
Ën
-10);

4704 
rdbv”
 = (
foÙ”
[1] << 8) | footer[0];

4705 ià(
rdbv”
 > 
RDB_VERSION
è 
C_ERR
;

4708 
üc
 = 
	`üc64
(0,
p
,
Ën
-8);

4709 
	`mem»v64ifbe
(&
üc
);

4710  (
	`memcmp
(&
üc
,
foÙ”
+2,8è=ğ0è? 
C_OK
 : 
C_ERR
;

4711 
	}
}

4716 
	$dumpCommªd
(
ş›Á
 *
c
) {

4717 
robj
 *
o
, *
dumpobj
;

4718 
rio
 
·ylßd
;

4721 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1])è=ğ
NULL
) {

4722 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

4727 
	`ü—‹DumpPaylßd
(&
·ylßd
,
o
);

4730 
dumpobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
·ylßd
.
io
.
bufãr
.
±r
);

4731 
	`addR•lyBulk
(
c
,
dumpobj
);

4732 
	`deüRefCouÁ
(
dumpobj
);

4734 
	}
}

4737 
	$»¡ÜeCommªd
(
ş›Á
 *
c
) {

4738 
‰l
;

4739 
rio
 
·ylßd
;

4740 
j
, 
ty³
, 
»¶aû
 = 0;

4741 
robj
 *
obj
;

4744 
j
 = 4; j < 
c
->
¬gc
; j++) {

4745 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"replace")) {

4746 
»¶aû
 = 1;

4748 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4754 ià(!
»¶aû
 && 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]è!ğ
NULL
) {

4755 
	`addR•ly
(
c
,
sh¬ed
.
busykey”r
);

4760 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
‰l
,
NULL
è!ğ
C_OK
) {

4762 } ià(
‰l
 < 0) {

4763 
	`addR•lyE¼Ü
(
c
,"Invalid TTL value, must be >= 0");

4768 ià(
	`v”ifyDumpPaylßd
(
c
->
¬gv
[3]->
±r
,
	`sd¦’
(c->¬gv[3]->±r)è=ğ
C_ERR
)

4770 
	`addR•lyE¼Ü
(
c
,"DUMP…ayload version or checksum‡re wrong");

4774 
	`rioIn™W™hBufãr
(&
·ylßd
,
c
->
¬gv
[3]->
±r
);

4775 ià(((
ty³
 = 
	`rdbLßdObjeùTy³
(&
·ylßd
)) == -1) ||

4776 ((
obj
 = 
	`rdbLßdObjeù
(
ty³
,&
·ylßd
)è=ğ
NULL
))

4778 
	`addR•lyE¼Ü
(
c
,"Bad data format");

4783 ià(
»¶aû
è
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

4786 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
obj
);

4787 ià(
‰l
è
	`£tExpœe
(
c
,c->
db
,c->
¬gv
[1],
	`m¡ime
()+ttl);

4788 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

4789 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4790 
£rv”
.
dœty
++;

4791 
	}
}

4799 
	#MIGRATE_SOCKET_CACHE_ITEMS
 64

	)

4800 
	#MIGRATE_SOCKET_CACHE_TTL
 10

	)

4802 
	smig¿‹CachedSock‘
 {

4803 
	mfd
;

4804 
	mÏ¡_dbid
;

4805 
time_t
 
	mÏ¡_u£_time
;

4806 } 
	tmig¿‹CachedSock‘
;

4819 
mig¿‹CachedSock‘
* 
	$mig¿‹G‘Sock‘
(
ş›Á
 *
c
, 
robj
 *
ho¡
,„obj *
pÜt
, 
timeout
) {

4820 
fd
;

4821 
sds
 
Çme
 = 
	`sd£m±y
();

4822 
mig¿‹CachedSock‘
 *
cs
;

4825 
Çme
 = 
	`sdsÿ’
Òame,
ho¡
->
±r
,
	`sd¦’
(host->ptr));

4826 
Çme
 = 
	`sdsÿ’
(name,":",1);

4827 
Çme
 = 
	`sdsÿ’
Òame,
pÜt
->
±r
,
	`sd¦’
(port->ptr));

4828 
cs
 = 
	`diùF‘chV®ue
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4829 ià(
cs
) {

4830 
	`sdsä“
(
Çme
);

4831 
cs
->
Ï¡_u£_time
 = 
£rv”
.
unixtime
;

4832  
cs
;

4836 ià(
	`diùSize
(
£rv”
.
mig¿‹_ÿched_sock‘s
è=ğ
MIGRATE_SOCKET_CACHE_ITEMS
) {

4838 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
mig¿‹_ÿched_sock‘s
);

4839 
cs
 = 
	`diùG‘V®
(
de
);

4840 
	`şo£
(
cs
->
fd
);

4841 
	`zä“
(
cs
);

4842 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
	`diùG‘Key
(
de
));

4846 
fd
 = 
	`ª‘TıNÚBlockCÚÃù
(
£rv”
.
Ã‹¼
,
c
->
¬gv
[1]->
±r
,

4847 
	`©oi
(
c
->
¬gv
[2]->
±r
));

4848 ià(
fd
 == -1) {

4849 
	`sdsä“
(
Çme
);

4850 
	`addR•lyE¼ÜFÜm©
(
c
,"Can't connectoarget‚ode: %s",

4851 
£rv”
.
Ã‹¼
);

4852  
NULL
;

4854 
	`ª‘EÇbËTıNoD–ay
(
£rv”
.
Ã‹¼
,
fd
);

4857 ià((
	`«Wa™
(
fd
,
AE_WRITABLE
,
timeout
) & AE_WRITABLE) == 0) {

4858 
	`sdsä“
(
Çme
);

4859 
	`addR•lySds
(
c
,

4860 
	`sd¢ew
("-IOERRƒrror orimeout connectingohe client\r\n"));

4861 
	`şo£
(
fd
);

4862  
NULL
;

4866 
cs
 = 
	`zm®loc
((*cs));

4867 
cs
->
fd
 = fd;

4868 
cs
->
Ï¡_dbid
 = -1;

4869 
cs
->
Ï¡_u£_time
 = 
£rv”
.
unixtime
;

4870 
	`diùAdd
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
,
cs
);

4871  
cs
;

4872 
	}
}

4875 
	$mig¿‹Clo£Sock‘
(
robj
 *
ho¡
,„obj *
pÜt
) {

4876 
sds
 
Çme
 = 
	`sd£m±y
();

4877 
mig¿‹CachedSock‘
 *
cs
;

4879 
Çme
 = 
	`sdsÿ’
Òame,
ho¡
->
±r
,
	`sd¦’
(host->ptr));

4880 
Çme
 = 
	`sdsÿ’
(name,":",1);

4881 
Çme
 = 
	`sdsÿ’
Òame,
pÜt
->
±r
,
	`sd¦’
(port->ptr));

4882 
cs
 = 
	`diùF‘chV®ue
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4883 ià(!
cs
) {

4884 
	`sdsä“
(
Çme
);

4888 
	`şo£
(
cs
->
fd
);

4889 
	`zä“
(
cs
);

4890 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4891 
	`sdsä“
(
Çme
);

4892 
	}
}

4894 
	$mig¿‹Clo£TimedoutSock‘s
() {

4895 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
mig¿‹_ÿched_sock‘s
);

4896 
diùEÁry
 *
de
;

4898 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4899 
mig¿‹CachedSock‘
 *
cs
 = 
	`diùG‘V®
(
de
);

4901 ià((
£rv”
.
unixtime
 - 
cs
->
Ï¡_u£_time
è> 
MIGRATE_SOCKET_CACHE_TTL
) {

4902 
	`şo£
(
cs
->
fd
);

4903 
	`zä“
(
cs
);

4904 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
	`diùG‘Key
(
de
));

4907 
	`diùR–—£I‹¿tÜ
(
di
);

4908 
	}
}

4916 
	$mig¿‹Commªd
(
ş›Á
 *
c
) {

4917 
mig¿‹CachedSock‘
 *
cs
;

4918 
cİy
 = 0, 
»¶aû
 = 0, 
j
;

4919 *
·sswÜd
 = 
NULL
;

4920 
timeout
;

4921 
dbid
;

4922 
robj
 **
ov
 = 
NULL
;

4923 
robj
 **
kv
 = 
NULL
;

4924 
robj
 **
Ãw¬gv
 = 
NULL
;

4925 
rio
 
cmd
, 
·ylßd
;

4926 
may_»Œy
 = 1;

4927 
wr™e_”rÜ
 = 0;

4928 
¬gv_»wr™‹n
 = 0;

4931 
fœ¡_key
 = 3;

4932 
num_keys
 = 1;

4935 
j
 = 6; j < 
c
->
¬gc
; j++) {

4936 
mÜ—rgs
 = 
j
 < 
c
->
¬gc
-1;

4937 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"copy")) {

4938 
cİy
 = 1;

4939 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"replace")) {

4940 
»¶aû
 = 1;

4941 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"auth")) {

4942 ià(!
mÜ—rgs
) {

4943 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4946 
j
++;

4947 
·sswÜd
 = 
c
->
¬gv
[
j
]->
±r
;

4948 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"keys")) {

4949 ià(
	`sd¦’
(
c
->
¬gv
[3]->
±r
) != 0) {

4950 
	`addR•lyE¼Ü
(
c
,

4955 
fœ¡_key
 = 
j
+1;

4956 
num_keys
 = 
c
->
¬gc
 - 
j
 - 1;

4959 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4965 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[5],&
timeout
,
NULL
è!ğ
C_OK
 ||

4966 
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
dbid
,
NULL
è!ğ
C_OK
)

4970 ià(
timeout
 <= 0)imeout = 1000;

4977 
ov
 = 
	`z»®loc
(ov,(
robj
*)*
num_keys
);

4978 
kv
 = 
	`z»®loc
(kv,(
robj
*)*
num_keys
);

4979 
oi
 = 0;

4981 
j
 = 0; j < 
num_keys
; j++) {

4982 ià((
ov
[
oi
] = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
fœ¡_key
+
j
])è!ğ
NULL
) {

4983 
kv
[
oi
] = 
c
->
¬gv
[
fœ¡_key
+
j
];

4984 
oi
++;

4987 
num_keys
 = 
oi
;

4988 ià(
num_keys
 == 0) {

4989 
	`zä“
(
ov
); zä“(
kv
);

4990 
	`addR•lySds
(
c
,
	`sd¢ew
("+NOKEY\r\n"));

4994 
Œy_agaš
:

4995 
wr™e_”rÜ
 = 0;

4998 
cs
 = 
	`mig¿‹G‘Sock‘
(
c
,c->
¬gv
[1],c->¬gv[2],
timeout
);

4999 ià(
cs
 =ğ
NULL
) {

5000 
	`zä“
(
ov
); zä“(
kv
);

5004 
	`rioIn™W™hBufãr
(&
cmd
,
	`sd£m±y
());

5007 ià(
·sswÜd
) {

5008 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkCouÁ
(&
cmd
,'*',2));

5009 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"AUTH",4));

5010 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,
·sswÜd
,

5011 
	`sd¦’
(
·sswÜd
)));

5015 
£Ëù
 = 
cs
->
Ï¡_dbid
 !ğ
dbid
;

5016 ià(
£Ëù
) {

5017 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkCouÁ
(&
cmd
,'*',2));

5018 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"SELECT",6));

5019 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkLÚgLÚg
(&
cmd
,
dbid
));

5023 
j
 = 0; j < 
num_keys
; j++) {

5024 
‰l
 = 0;

5025 
expœ—t
 = 
	`g‘Expœe
(
c
->
db
,
kv
[
j
]);

5027 ià(
expœ—t
 != -1) {

5028 
‰l
 = 
expœ—t
-
	`m¡ime
();

5029 ià(
‰l
 < 1)tl = 1;

5031 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,

5032 
	`rioWr™eBulkCouÁ
(&
cmd
,'*',
»¶aû
 ? 5 : 4));

5034 ià(
£rv”
.
şu¡”_’abËd
)

5035 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,

5036 
	`rioWr™eBulkSŒšg
(&
cmd
,"RESTORE-ASKING",14));

5038 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"RESTORE",7));

5039 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`sdsEncodedObjeù
(
kv
[
j
]));

5040 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,
kv
[
j
]->
±r
,

5041 
	`sd¦’
(
kv
[
j
]->
±r
)));

5042 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkLÚgLÚg
(&
cmd
,
‰l
));

5046 
	`ü—‹DumpPaylßd
(&
·ylßd
,
ov
[
j
]);

5047 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,

5048 
	`rioWr™eBulkSŒšg
(&
cmd
,
·ylßd
.
io
.
bufãr
.
±r
,

5049 
	`sd¦’
(
·ylßd
.
io
.
bufãr
.
±r
)));

5050 
	`sdsä“
(
·ylßd
.
io
.
bufãr
.
±r
);

5054 ià(
»¶aû
)

5055 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"REPLACE",7));

5059 
”ºo
 = 0;

5061 
sds
 
buf
 = 
cmd
.
io
.
bufãr
.
±r
;

5062 
size_t
 
pos
 = 0, 
towr™e
;

5063 
nwr™‹n
 = 0;

5065 (
towr™e
 = 
	`sd¦’
(
buf
)-
pos
) > 0) {

5066 
towr™e
 = (towrite > (64*1024) ? (64*1024) :owrite);

5067 
nwr™‹n
 = 
	`syncWr™e
(
cs
->
fd
,
buf
+
pos
,
towr™e
,
timeout
);

5068 ià(
nwr™‹n
 !ğ(sigÃd)
towr™e
) {

5069 
wr™e_”rÜ
 = 1;

5070 
sock‘_”r
;

5072 
pos
 +ğ
nwr™‹n
;

5076 
buf0
[1024];

5077 
buf1
[1024];

5078 
buf2
[1024];

5081 ià(
·sswÜd
 && 
	`syncR—dLše
(
cs
->
fd
, 
buf0
, (buf0), 
timeout
) <= 0)

5082 
sock‘_”r
;

5085 ià(
£Ëù
 && 
	`syncR—dLše
(
cs
->
fd
, 
buf1
, (buf1), 
timeout
) <= 0)

5086 
sock‘_”r
;

5089 
”rÜ_äom_rg‘
 = 0;

5090 
sock‘_”rÜ
 = 0;

5091 
d–_idx
 = 1;

5093 ià(!
cİy
è
Ãw¬gv
 = 
	`zm®loc
((
robj
*)*(
num_keys
+1));

5095 
j
 = 0; j < 
num_keys
; j++) {

5096 ià(
	`syncR—dLše
(
cs
->
fd
, 
buf2
, (buf2), 
timeout
) <= 0) {

5097 
sock‘_”rÜ
 = 1;

5100 ià((
·sswÜd
 && 
buf0
[0] == '-') ||

5101 (
£Ëù
 && 
buf1
[0] == '-') ||

5102 
buf2
[0] == '-')

5105 ià(!
”rÜ_äom_rg‘
) {

5106 
cs
->
Ï¡_dbid
 = -1;

5107 *
”rbuf
;

5108 ià(
·sswÜd
 && 
buf0
[0] =ğ'-'è
”rbuf
 = buf0;

5109 ià(
£Ëù
 && 
buf1
[0] =ğ'-'è
”rbuf
 = buf1;

5110 
”rbuf
 = 
buf2
;

5112 
”rÜ_äom_rg‘
 = 1;

5113 
	`addR•lyE¼ÜFÜm©
(
c
,"Target instance„eplied withƒrror: %s",

5114 
”rbuf
+1);

5117 ià(!
cİy
) {

5119 
	`dbD–‘e
(
c
->
db
,
kv
[
j
]);

5120 
	`sigÇlModif›dKey
(
c
->
db
,
kv
[
j
]);

5121 
£rv”
.
dœty
++;

5124 
Ãw¬gv
[
d–_idx
++] = 
kv
[
j
];

5125 
	`šüRefCouÁ
(
kv
[
j
]);

5133 ià(!
”rÜ_äom_rg‘
 && 
sock‘_”rÜ
 && 
j
 =ğ0 && 
may_»Œy
 &&

5134 
”ºo
 !ğ
ETIMEDOUT
)

5136 
sock‘_”r
;

5142 ià(
sock‘_”rÜ
è
	`mig¿‹Clo£Sock‘
(
c
->
¬gv
[1],c->argv[2]);

5144 ià(!
cİy
) {

5148 ià(
d–_idx
 > 1) {

5149 
Ãw¬gv
[0] = 
	`ü—‹SŒšgObjeù
("DEL",3);

5151 
	`»¶aûCl›ÁCommªdVeùÜ
(
c
,
d–_idx
,
Ãw¬gv
);

5152 
¬gv_»wr™‹n
 = 1;

5155 
	`zä“
(
Ãw¬gv
);

5157 
Ãw¬gv
 = 
NULL
;

5163 ià(!
”rÜ_äom_rg‘
 && 
sock‘_”rÜ
) {

5164 
may_»Œy
 = 0;

5165 
sock‘_”r
;

5168 ià(!
”rÜ_äom_rg‘
) {

5175 
cs
->
Ï¡_dbid
 = 
dbid
;

5176 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5182 
	`sdsä“
(
cmd
.
io
.
bufãr
.
±r
);

5183 
	`zä“
(
ov
); zä“(
kv
); zä“(
Ãw¬gv
);

5189 
sock‘_”r
:

5192 
	`sdsä“
(
cmd
.
io
.
bufãr
.
±r
);

5198 ià(!
¬gv_»wr™‹n
è
	`mig¿‹Clo£Sock‘
(
c
->
¬gv
[1],c->argv[2]);

5199 
	`zä“
(
Ãw¬gv
);

5200 
Ãw¬gv
 = 
NULL
;

5204 ià(
”ºo
 !ğ
ETIMEDOUT
 && 
may_»Œy
) {

5205 
may_»Œy
 = 0;

5206 
Œy_agaš
;

5210 
	`zä“
(
ov
); zä“(
kv
);

5211 
	`addR•lySds
(
c
,

5212 
	`sdsÿrštf
(
	`sd£m±y
(),

5214 
wr™e_”rÜ
 ? "writing" : "reading"));

5216 
	}
}

5226 
	$askšgCommªd
(
ş›Á
 *
c
) {

5227 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

5228 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

5231 
c
->
æags
 |ğ
CLIENT_ASKING
;

5232 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5233 
	}
}

5238 
	$»adÚlyCommªd
(
ş›Á
 *
c
) {

5239 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

5240 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

5243 
c
->
æags
 |ğ
CLIENT_READONLY
;

5244 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5245 
	}
}

5248 
	$»adwr™eCommªd
(
ş›Á
 *
c
) {

5249 
c
->
æags
 &ğ~
CLIENT_READONLY
;

5250 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

5251 
	}
}

5285 
şu¡”Node
 *
	$g‘NodeByQu”y
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
hash¦Ù
, *
”rÜ_code
) {

5286 
şu¡”Node
 *
n
 = 
NULL
;

5287 
robj
 *
fœ¡key
 = 
NULL
;

5288 
muÉË_keys
 = 0;

5289 
muÉiS‹
 *
ms
, 
_ms
;

5290 
muÉiCmd
 
mc
;

5291 
i
, 
¦Ù
 = 0, 
mig¿tšg_¦Ù
 = 0, 
impÜtšg_¦Ù
 = 0, 
missšg_keys
 = 0;

5294 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_NONE
;

5298 ià(
cmd
->
´oc
 =ğ
execCommªd
) {

5301 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)è 
my£lf
;

5302 
ms
 = &
c
->
m¡©e
;

5307 
ms
 = &
_ms
;

5308 
_ms
.
commªds
 = &
mc
;

5309 
_ms
.
couÁ
 = 1;

5310 
mc
.
¬gv
 =‡rgv;

5311 
mc
.
¬gc
 =‡rgc;

5312 
mc
.
cmd
 = cmd;

5317 
i
 = 0; i < 
ms
->
couÁ
; i++) {

5318 
»disCommªd
 *
mcmd
;

5319 
robj
 **
m¬gv
;

5320 
m¬gc
, *
keyšdex
, 
numkeys
, 
j
;

5322 
mcmd
 = 
ms
->
commªds
[
i
].
cmd
;

5323 
m¬gc
 = 
ms
->
commªds
[
i
].
¬gc
;

5324 
m¬gv
 = 
ms
->
commªds
[
i
].
¬gv
;

5326 
keyšdex
 = 
	`g‘KeysFromCommªd
(
mcmd
,
m¬gv
,
m¬gc
,&
numkeys
);

5327 
j
 = 0; j < 
numkeys
; j++) {

5328 
robj
 *
thiskey
 = 
m¬gv
[
keyšdex
[
j
]];

5329 
this¦Ù
 = 
	`keyHashSlÙ
((*)
thiskey
->
±r
,

5330 
	`sd¦’
(
thiskey
->
±r
));

5332 ià(
fœ¡key
 =ğ
NULL
) {

5335 
fœ¡key
 = 
thiskey
;

5336 
¦Ù
 = 
this¦Ù
;

5337 
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

5343 ià(
n
 =ğ
NULL
) {

5344 
	`g‘KeysF»eResuÉ
(
keyšdex
);

5345 ià(
”rÜ_code
)

5346 *
”rÜ_code
 = 
CLUSTER_REDIR_DOWN_UNBOUND
;

5347  
NULL
;

5355 ià(
n
 =ğ
my£lf
 &&

5356 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] !ğ
NULL
)

5358 
mig¿tšg_¦Ù
 = 1;

5359 } ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] !ğ
NULL
) {

5360 
impÜtšg_¦Ù
 = 1;

5365 ià(!
	`equ®SŒšgObjeùs
(
fœ¡key
,
thiskey
)) {

5366 ià(
¦Ù
 !ğ
this¦Ù
) {

5368 
	`g‘KeysF»eResuÉ
(
keyšdex
);

5369 ià(
”rÜ_code
)

5370 *
”rÜ_code
 = 
CLUSTER_REDIR_CROSS_SLOT
;

5371  
NULL
;

5375 
muÉË_keys
 = 1;

5381 ià((
mig¿tšg_¦Ù
 || 
impÜtšg_¦Ù
) &&

5382 
	`lookupKeyR—d
(&
£rv”
.
db
[0],
thiskey
è=ğ
NULL
)

5384 
missšg_keys
++;

5387 
	`g‘KeysF»eResuÉ
(
keyšdex
);

5392 ià(
n
 =ğ
NULL
è 
my£lf
;

5395 ià(
£rv”
.
şu¡”
->
¡©e
 !ğ
CLUSTER_OK
) {

5396 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_DOWN_STATE
;

5397  
NULL
;

5401 ià(
hash¦Ù
è*hash¦Ù = 
¦Ù
;

5406 ià((
mig¿tšg_¦Ù
 || 
impÜtšg_¦Ù
è&& 
cmd
->
´oc
 =ğ
mig¿‹Commªd
)

5407  
my£lf
;

5411 ià(
mig¿tšg_¦Ù
 && 
missšg_keys
) {

5412 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_ASK
;

5413  
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
];

5420 ià(
impÜtšg_¦Ù
 &&

5421 (
c
->
æags
 & 
CLIENT_ASKING
 || 
cmd
->æag & 
CMD_ASKING
))

5423 ià(
muÉË_keys
 && 
missšg_keys
) {

5424 ià(
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_UNSTABLE
;

5425  
NULL
;

5427  
my£lf
;

5434 ià(
c
->
æags
 & 
CLIENT_READONLY
 &&

5435 (
cmd
->
æags
 & 
CMD_READONLY
 || cmd->
´oc
 =ğ
ev®Commªd
 ||

5436 
cmd
->
´oc
 =ğ
ev®ShaCommªd
) &&

5437 
	`nodeIsSÏve
(
my£lf
) &&

5438 
my£lf
->
¦aveof
 =ğ
n
)

5440  
my£lf
;

5445 ià(
n
 !ğ
my£lf
 && 
”rÜ_code
è*”rÜ_codğ
CLUSTER_REDIR_MOVED
;

5446  
n
;

5447 
	}
}

5456 
	$şu¡”RedœeùCl›Á
(
ş›Á
 *
c
, 
şu¡”Node
 *
n
, 
hash¦Ù
, 
”rÜ_code
) {

5457 ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_CROSS_SLOT
) {

5458 
	`addR•lySds
(
c
,
	`sd¢ew
("-CROSSSLOT Keys in„equest don't hashohe same slot\r\n"));

5459 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_UNSTABLE
) {

5463 
	`addR•lySds
(
c
,
	`sd¢ew
("-TRYAGAIN Multiple keys„equest during„ehashing of slot\r\n"));

5464 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_DOWN_STATE
) {

5465 
	`addR•lySds
(
c
,
	`sd¢ew
("-CLUSTERDOWN The cluster is down\r\n"));

5466 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_DOWN_UNBOUND
) {

5467 
	`addR•lySds
(
c
,
	`sd¢ew
("-CLUSTERDOWN Hash slot‚ot served\r\n"));

5468 } ià(
”rÜ_code
 =ğ
CLUSTER_REDIR_MOVED
 ||

5469 
”rÜ_code
 =ğ
CLUSTER_REDIR_ASK
)

5471 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),

5473 (
”rÜ_code
 =ğ
CLUSTER_REDIR_ASK
) ? "ASK" : "MOVED",

5474 
hash¦Ù
,
n
->

,n->
pÜt
));

5476 
	`£rv”Pªic
("getNodeByQuery() unknownƒrror.");

5478 
	}
}

5491 
	$şu¡”RedœeùBlockedCl›ÁIfN“ded
(
ş›Á
 *
c
) {

5492 ià(
c
->
æags
 & 
CLIENT_BLOCKED
 && c->
bty³
 =ğ
BLOCKED_LIST
) {

5493 
diùEÁry
 *
de
;

5494 
diùI‹¿tÜ
 *
di
;

5497 ià(
£rv”
.
şu¡”
->
¡©e
 =ğ
CLUSTER_FAIL
) {

5498 
	`şu¡”RedœeùCl›Á
(
c
,
NULL
,0,
CLUSTER_REDIR_DOWN_STATE
);

5503 
di
 = 
	`diùG‘I‹¿tÜ
(
c
->
bpİ
.
keys
);

5504 ià((
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

5505 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

5506 
¦Ù
 = 
	`keyHashSlÙ
((*)
key
->
±r
, 
	`sd¦’
(key->ptr));

5507 
şu¡”Node
 *
node
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

5512 ià(
node
 !ğ
my£lf
 &&

5513 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] =ğ
NULL
)

5515 ià(
node
 =ğ
NULL
) {

5516 
	`şu¡”RedœeùCl›Á
(
c
,
NULL
,0,

5517 
CLUSTER_REDIR_DOWN_UNBOUND
);

5519 
	`şu¡”RedœeùCl›Á
(
c
,
node
,
¦Ù
,

5520 
CLUSTER_REDIR_MOVED
);

5522 
	`diùR–—£I‹¿tÜ
(
di
);

5526 
	`diùR–—£I‹¿tÜ
(
di
);

5529 
	}
}

	@src/cluster.h

1 #iâdeà
__CLUSTER_H


2 
	#__CLUSTER_H


	)

8 
	#CLUSTER_SLOTS
 16384

	)

9 
	#CLUSTER_OK
 0

	)

10 
	#CLUSTER_FAIL
 1

	)

11 
	#CLUSTER_NAMELEN
 40

	)

12 
	#CLUSTER_PORT_INCR
 10000

	)

16 
	#CLUSTER_DEFAULT_NODE_TIMEOUT
 15000

	)

17 
	#CLUSTER_DEFAULT_SLAVE_VALIDITY
 10

	)

18 
	#CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
 1

	)

19 
	#CLUSTER_DEFAULT_SLAVE_NO_FAILOVER
 0

	)

20 
	#CLUSTER_FAIL_REPORT_VALIDITY_MULT
 2

	)

21 
	#CLUSTER_FAIL_UNDO_TIME_MULT
 2

	)

22 
	#CLUSTER_FAIL_UNDO_TIME_ADD
 10

	)

23 
	#CLUSTER_FAILOVER_DELAY
 5

	)

24 
	#CLUSTER_DEFAULT_MIGRATION_BARRIER
 1

	)

25 
	#CLUSTER_MF_TIMEOUT
 5000

	)

26 
	#CLUSTER_MF_PAUSE_MULT
 2

	)

27 
	#CLUSTER_SLAVE_MIGRATION_DELAY
 5000

	)

30 
	#CLUSTER_REDIR_NONE
 0

	)

31 
	#CLUSTER_REDIR_CROSS_SLOT
 1

	)

32 
	#CLUSTER_REDIR_UNSTABLE
 2

	)

33 
	#CLUSTER_REDIR_ASK
 3

	)

34 
	#CLUSTER_REDIR_MOVED
 4

	)

35 
	#CLUSTER_REDIR_DOWN_STATE
 5

	)

36 
	#CLUSTER_REDIR_DOWN_UNBOUND
 6

	)

38 
	gşu¡”Node
;

41 
	sşu¡”Lšk
 {

42 
m¡ime_t
 
	mùime
;

43 
	mfd
;

44 
sds
 
	m¢dbuf
;

45 
sds
 
	mrcvbuf
;

46 
şu¡”Node
 *
	mnode
;

47 } 
	tşu¡”Lšk
;

50 
	#CLUSTER_NODE_MASTER
 1

	)

51 
	#CLUSTER_NODE_SLAVE
 2

	)

52 
	#CLUSTER_NODE_PFAIL
 4

	)

53 
	#CLUSTER_NODE_FAIL
 8

	)

54 
	#CLUSTER_NODE_MYSELF
 16

	)

55 
	#CLUSTER_NODE_HANDSHAKE
 32

	)

56 
	#CLUSTER_NODE_NOADDR
 64

	)

57 
	#CLUSTER_NODE_MEET
 128

	)

58 
	#CLUSTER_NODE_MIGRATE_TO
 256

	)

59 
	#CLUSTER_NODE_NOFAILOVER
 512

	)

60 
	#CLUSTER_NODE_NULL_NAME
 "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"

	)

62 
	#nodeIsMa¡”
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_MASTER
)

	)

63 
	#nodeIsSÏve
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_SLAVE
)

	)

64 
	#nodeInHªdshake
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_HANDSHAKE
)

	)

65 
	#nodeHasAddr
(
n
è(!(Ò)->
æags
 & 
CLUSTER_NODE_NOADDR
))

	)

66 
	#nodeW™houtAddr
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_NOADDR
)

	)

67 
	#nodeTimedOut
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_PFAIL
)

	)

68 
	#nodeFaed
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_FAIL
)

	)

69 
	#nodeCªtFaov”
(
n
è(Ò)->
æags
 & 
CLUSTER_NODE_NOFAILOVER
)

	)

72 
	#CLUSTER_CANT_FAILOVER_NONE
 0

	)

73 
	#CLUSTER_CANT_FAILOVER_DATA_AGE
 1

	)

74 
	#CLUSTER_CANT_FAILOVER_WAITING_DELAY
 2

	)

75 
	#CLUSTER_CANT_FAILOVER_EXPIRED
 3

	)

76 
	#CLUSTER_CANT_FAILOVER_WAITING_VOTES
 4

	)

77 
	#CLUSTER_CANT_FAILOVER_RELOG_PERIOD
 (60*5è

	)

80 
	#CLUSTER_TODO_HANDLE_FAILOVER
 (1<<0)

	)

81 
	#CLUSTER_TODO_UPDATE_STATE
 (1<<1)

	)

82 
	#CLUSTER_TODO_SAVE_CONFIG
 (1<<2)

	)

83 
	#CLUSTER_TODO_FSYNC_CONFIG
 (1<<3)

	)

91 
	#CLUSTERMSG_TYPE_PING
 0

	)

92 
	#CLUSTERMSG_TYPE_PONG
 1

	)

93 
	#CLUSTERMSG_TYPE_MEET
 2

	)

94 
	#CLUSTERMSG_TYPE_FAIL
 3

	)

95 
	#CLUSTERMSG_TYPE_PUBLISH
 4

	)

96 
	#CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
 5

	)

97 
	#CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
 6

	)

98 
	#CLUSTERMSG_TYPE_UPDATE
 7

	)

99 
	#CLUSTERMSG_TYPE_MFSTART
 8

	)

100 
	#CLUSTERMSG_TYPE_COUNT
 9

	)

103 
	sşu¡”NodeFaR•Üt
 {

104 
şu¡”Node
 *
	mnode
;

105 
m¡ime_t
 
	mtime
;

106 } 
	tşu¡”NodeFaR•Üt
;

108 
	sşu¡”Node
 {

109 
m¡ime_t
 
	mùime
;

110 
	mÇme
[
CLUSTER_NAMELEN
];

111 
	mæags
;

112 
ušt64_t
 
	mcÚfigEpoch
;

113 
	m¦Ùs
[
CLUSTER_SLOTS
/8];

114 
	mnum¦Ùs
;

115 
	mnum¦aves
;

116 
şu¡”Node
 **
	m¦aves
;

117 
şu¡”Node
 *
	m¦aveof
;

121 
m¡ime_t
 
	mpšg_£Á
;

122 
m¡ime_t
 
	mpÚg_»ûived
;

123 
m¡ime_t
 
	mç_time
;

124 
m¡ime_t
 
	mvÙed_time
;

125 
m¡ime_t
 
	m»¶_off£t_time
;

126 
m¡ime_t
 
	mÜphªed_time
;

127 
	m»¶_off£t
;

128 
	m
[
NET_IP_STR_LEN
];

129 
	mpÜt
;

130 
	mıÜt
;

131 
şu¡”Lšk
 *
	mlšk
;

132 
li¡
 *
	mç_»pÜts
;

133 } 
	tşu¡”Node
;

135 
	sşu¡”S‹
 {

136 
şu¡”Node
 *
	mmy£lf
;

137 
ušt64_t
 
	mcu¼’tEpoch
;

138 
	m¡©e
;

139 
	msize
;

140 
diù
 *
	mnodes
;

141 
diù
 *
	mnodes_bÏck_li¡
;

142 
şu¡”Node
 *
	mmig¿tšg_¦Ùs_to
[
CLUSTER_SLOTS
];

143 
şu¡”Node
 *
	mimpÜtšg_¦Ùs_äom
[
CLUSTER_SLOTS
];

144 
şu¡”Node
 *
	m¦Ùs
[
CLUSTER_SLOTS
];

145 
ušt64_t
 
	m¦Ùs_keys_couÁ
[
CLUSTER_SLOTS
];

146 
¿x
 *
	m¦Ùs_to_keys
;

148 
m¡ime_t
 
	mçov”_auth_time
;

149 
	mçov”_auth_couÁ
;

150 
	mçov”_auth_£Á
;

151 
	mçov”_auth_¿nk
;

152 
ušt64_t
 
	mçov”_auth_•och
;

153 
	mÿÁ_çov”_»asÚ
;

156 
m¡ime_t
 
	mmf_’d
;

159 
şu¡”Node
 *
	mmf_¦ave
;

161 
	mmf_ma¡”_off£t
;

163 
	mmf_ÿn_¡¬t
;

166 
ušt64_t
 
	mÏ¡VÙeEpoch
;

167 
	mtodo_befÜe_¦“p
;

169 
	m¡©s_bus_mes§ges_£Á
[
CLUSTERMSG_TYPE_COUNT
];

170 
	m¡©s_bus_mes§ges_»ûived
[
CLUSTERMSG_TYPE_COUNT
];

171 
	m¡©s_pç_nodes
;

173 } 
	tşu¡”S‹
;

181 
	mnod’ame
[
CLUSTER_NAMELEN
];

182 
ušt32_t
 
	mpšg_£Á
;

183 
ušt32_t
 
	mpÚg_»ûived
;

184 
	m
[
NET_IP_STR_LEN
];

185 
ušt16_t
 
	mpÜt
;

186 
ušt16_t
 
	mıÜt
;

187 
ušt16_t
 
	mæags
;

188 
ušt32_t
 
	mnÙu£d1
;

189 } 
	tşu¡”MsgD©aGoss
;

192 
	mnod’ame
[
CLUSTER_NAMELEN
];

193 } 
	tşu¡”MsgD©aFa
;

196 
ušt32_t
 
	mchªÃl_Ën
;

197 
ušt32_t
 
	mmes§ge_Ën
;

201 
	mbulk_d©a
[8];

202 } 
	tşu¡”MsgD©aPublish
;

205 
ušt64_t
 
	mcÚfigEpoch
;

206 
	mnod’ame
[
CLUSTER_NAMELEN
];

207 
	m¦Ùs
[
CLUSTER_SLOTS
/8];

208 } 
	tşu¡”MsgD©aUpd©e
;

210 
	uşu¡”MsgD©a
 {

214 
şu¡”MsgD©aGoss
 
	mgoss
[1];

215 } 
	mpšg
;

219 
şu¡”MsgD©aFa
 
	mabout
;

220 } 
	mç
;

224 
şu¡”MsgD©aPublish
 
	mmsg
;

225 } 
	mpublish
;

229 
şu¡”MsgD©aUpd©e
 
	mnodecfg
;

230 } 
	mupd©e
;

233 
	#CLUSTER_PROTO_VER
 1

	)

236 
	msig
[4];

237 
ušt32_t
 
	mtÙËn
;

238 
ušt16_t
 
	mv”
;

239 
ušt16_t
 
	mpÜt
;

240 
ušt16_t
 
	mty³
;

241 
ušt16_t
 
	mcouÁ
;

242 
ušt64_t
 
	mcu¼’tEpoch
;

243 
ušt64_t
 
	mcÚfigEpoch
;

246 
ušt64_t
 
	moff£t
;

248 
	m£nd”
[
CLUSTER_NAMELEN
];

249 
	mmy¦Ùs
[
CLUSTER_SLOTS
/8];

250 
	m¦aveof
[
CLUSTER_NAMELEN
];

251 
	mmy
[
NET_IP_STR_LEN
];

252 
	mnÙu£d1
[34];

253 
ušt16_t
 
	mıÜt
;

254 
ušt16_t
 
	mæags
;

255 
	m¡©e
;

256 
	mmæags
[3];

257 
şu¡”MsgD©a
 
	md©a
;

258 } 
	tşu¡”Msg
;

260 
	#CLUSTERMSG_MIN_LEN
 ((
şu¡”Msg
)-(
şu¡”MsgD©a
))

	)

264 
	#CLUSTERMSG_FLAG0_PAUSED
 (1<<0è

	)

265 
	#CLUSTERMSG_FLAG0_FORCEACK
 (1<<1è

	)

269 
şu¡”Node
 *
g‘NodeByQu”y
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
hash¦Ù
, *
ask
);

270 
şu¡”RedœeùBlockedCl›ÁIfN“ded
(
ş›Á
 *
c
);

271 
şu¡”RedœeùCl›Á
(
ş›Á
 *
c
, 
şu¡”Node
 *
n
, 
hash¦Ù
, 
”rÜ_code
);

	@src/config.c

31 
	~"£rv”.h
"

32 
	~"şu¡”.h
"

34 
	~<fú.h
>

35 
	~<sys/¡©.h
>

41 
	scÚfigEnum
 {

42 cÚ¡ *
	mÇme
;

43 cÚ¡ 
	mv®
;

44 } 
	tcÚfigEnum
;

46 
cÚfigEnum
 
	gmaxmemÜy_pŞicy_’um
[] = {

47 {"vŞ©e-Ìu", 
MAXMEMORY_VOLATILE_LRU
},

48 {"vŞ©e-lfu", 
MAXMEMORY_VOLATILE_LFU
},

49 {"vŞ©e-¿ndom",
MAXMEMORY_VOLATILE_RANDOM
},

50 {"vŞ©e-‰l",
MAXMEMORY_VOLATILE_TTL
},

51 {"®lkeys-Ìu",
MAXMEMORY_ALLKEYS_LRU
},

52 {"®lkeys-lfu",
MAXMEMORY_ALLKEYS_LFU
},

53 {"®lkeys-¿ndom",
MAXMEMORY_ALLKEYS_RANDOM
},

54 {"nÛviùiÚ",
MAXMEMORY_NO_EVICTION
},

55 {
NULL
, 0}

58 
cÚfigEnum
 
	gsy¦og_çc™y_’um
[] = {

59 {"u£r", 
LOG_USER
},

60 {"loÿl0", 
LOG_LOCAL0
},

61 {"loÿl1", 
LOG_LOCAL1
},

62 {"loÿl2", 
LOG_LOCAL2
},

63 {"loÿl3", 
LOG_LOCAL3
},

64 {"loÿl4", 
LOG_LOCAL4
},

65 {"loÿl5", 
LOG_LOCAL5
},

66 {"loÿl6", 
LOG_LOCAL6
},

67 {"loÿl7", 
LOG_LOCAL7
},

68 {
NULL
, 0}

71 
cÚfigEnum
 
	glogËv–_’um
[] = {

72 {"debug", 
LL_DEBUG
},

73 {"v”bo£", 
LL_VERBOSE
},

74 {"nÙiû", 
LL_NOTICE
},

75 {"w¬nšg", 
LL_WARNING
},

76 {
NULL
,0}

79 
cÚfigEnum
 
	gsu³rvi£d_mode_’um
[] = {

80 {"up¡¬t", 
SUPERVISED_UPSTART
},

81 {"sy¡emd", 
SUPERVISED_SYSTEMD
},

82 {"auto", 
SUPERVISED_AUTODETECT
},

83 {"no", 
SUPERVISED_NONE
},

84 {
NULL
, 0}

87 
cÚfigEnum
 
	gaof_fsync_’um
[] = {

88 {"ev”y£c", 
AOF_FSYNC_EVERYSEC
},

89 {"®ways", 
AOF_FSYNC_ALWAYS
},

90 {"no", 
AOF_FSYNC_NO
},

91 {
NULL
, 0}

95 
ş›ÁBufãrLim™sCÚfig
 
	gş›ÁBufãrLim™sDeçuÉs
[
CLIENT_TYPE_OBUF_COUNT
] = {

106 
	$cÚfigEnumG‘V®ue
(
cÚfigEnum
 *
û
, *
Çme
) {

107 
û
->
Çme
 !ğ
NULL
) {

108 ià(!
	`¡rÿ£cmp
(
û
->
Çme
,Çme)è ce->
v®
;

109 
û
++;

111  
INT_MIN
;

112 
	}
}

115 cÚ¡ *
	$cÚfigEnumG‘Name
(
cÚfigEnum
 *
û
, 
v®
) {

116 
û
->
Çme
 !ğ
NULL
) {

117 ià(
û
->
v®
 =ğv®è ce->
Çme
;

118 
û
++;

120  
NULL
;

121 
	}
}

125 cÚ¡ *
	$cÚfigEnumG‘NameOrUnknown
(
cÚfigEnum
 *
û
, 
v®
) {

126 cÚ¡ *
Çme
 = 
	`cÚfigEnumG‘Name
(
û
,
v®
);

127  
Çme
 ?‚ame : "unknown";

128 
	}
}

131 cÚ¡ *
	$eviùPŞicyToSŒšg
() {

132  
	`cÚfigEnumG‘NameOrUnknown
(
maxmemÜy_pŞicy_’um
,
£rv”
.
maxmemÜy_pŞicy
);

133 
	}
}

139 
	$ye¢Ùoi
(*
s
) {

140 ià(!
	`¡rÿ£cmp
(
s
,"yes"))  1;

141 ià(!
	`¡rÿ£cmp
(
s
,"no"))  0;

143 
	}
}

145 
	$­³ndS”v”SaveP¬ams
(
time_t
 
£cÚds
, 
chªges
) {

146 
£rv”
.
§v•¬ams
 = 
	`z»®loc
(£rv”.§v•¬ams,(
§v•¬am
)*(£rv”.
§v•¬am¦’
+1));

147 
£rv”
.
§v•¬ams
[£rv”.
§v•¬am¦’
].
£cÚds
 = seconds;

148 
£rv”
.
§v•¬ams
[£rv”.
§v•¬am¦’
].
chªges
 = changes;

149 
£rv”
.
§v•¬am¦’
++;

150 
	}
}

152 
	$»£tS”v”SaveP¬ams
() {

153 
	`zä“
(
£rv”
.
§v•¬ams
);

154 
£rv”
.
§v•¬ams
 = 
NULL
;

155 
£rv”
.
§v•¬am¦’
 = 0;

156 
	}
}

158 
	$queueLßdModuË
(
sds
 
·th
, sd *
¬gv
, 
¬gc
) {

159 
i
;

160 
moduËLßdQueueEÁry
 *
lßdmod
;

162 
lßdmod
 = 
	`zm®loc
((
moduËLßdQueueEÁry
));

163 
lßdmod
->
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

164 
lßdmod
->
·th
 = 
	`sd¢ew
(path);

165 
lßdmod
->
¬gc
 =‡rgc;

166 
i
 = 0; i < 
¬gc
; i++) {

167 
lßdmod
->
¬gv
[
i
] = 
	`ü—‹RawSŒšgObjeù
×rgv[i],
	`sd¦’
(argv[i]));

169 
	`li¡AddNodeTa
(
£rv”
.
lßdmoduË_queue
,
lßdmod
);

170 
	}
}

172 
	$lßdS”v”CÚfigFromSŒšg
(*
cÚfig
) {

173 *
”r
 = 
NULL
;

174 
lš’um
 = 0, 
tÙlšes
, 
i
;

175 
¦aveof_lš’um
 = 0;

176 
sds
 *
lšes
;

178 
lšes
 = 
	`sds¥l™Ën
(
cÚfig
,
	`¡¾’
(cÚfig),"\n",1,&
tÙlšes
);

180 
i
 = 0; i < 
tÙlšes
; i++) {

181 
sds
 *
¬gv
;

182 
¬gc
;

184 
lš’um
 = 
i
+1;

185 
lšes
[
i
] = 
	`sd¡rim
(lines[i]," \t\r\n");

188 ià(
lšes
[
i
][0] == '#' ||†ines[i][0] == '\0') ;

191 
¬gv
 = 
	`sds¥l™¬gs
(
lšes
[
i
],&
¬gc
);

192 ià(
¬gv
 =ğ
NULL
) {

193 
”r
 = "Unbalanced quotes in configuration†ine";

194 
lßd”r
;

198 ià(
¬gc
 == 0) {

199 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

202 
	`sd¡Şow”
(
¬gv
[0]);

205 ià(!
	`¡rÿ£cmp
(
¬gv
[0],"timeout"è&& 
¬gc
 == 2) {

206 
£rv”
.
maxidËtime
 = 
	`©oi
(
¬gv
[1]);

207 ià(
£rv”
.
maxidËtime
 < 0) {

208 
”r
 = "Inv®idimeouˆv®ue"; 
lßd”r
;

210 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"tı-k“·live"è&& 
¬gc
 == 2) {

211 
£rv”
.
tık“·live
 = 
	`©oi
(
¬gv
[1]);

212 ià(
£rv”
.
tık“·live
 < 0) {

213 
”r
 = "Inv®idı-k“·livv®ue"; 
lßd”r
;

215 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"´Ùeùed-mode"è&& 
¬gc
 == 2) {

216 ià((
£rv”
.
´Ùeùed_mode
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

217 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

219 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"pÜt"è&& 
¬gc
 == 2) {

220 
£rv”
.
pÜt
 = 
	`©oi
(
¬gv
[1]);

221 ià(
£rv”
.
pÜt
 < 0 || server.port > 65535) {

222 
”r
 = "Inv®id…Üt"; 
lßd”r
;

224 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"tı-backlog"è&& 
¬gc
 == 2) {

225 
£rv”
.
tı_backlog
 = 
	`©oi
(
¬gv
[1]);

226 ià(
£rv”
.
tı_backlog
 < 0) {

227 
”r
 = "Inv®id backlog v®ue"; 
lßd”r
;

229 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"bšd"è&& 
¬gc
 >= 2) {

230 
j
, 
add»s£s
 = 
¬gc
-1;

232 ià(
add»s£s
 > 
CONFIG_BINDADDR_MAX
) {

233 
”r
 = "ToØmªy bšd‡dd»s£ ¥ecif›d"; 
lßd”r
;

235 
j
 = 0; j < 
add»s£s
; j++)

236 
£rv”
.
bšdaddr
[
j
] = 
	`z¡rdup
(
¬gv
[j+1]);

237 
£rv”
.
bšdaddr_couÁ
 = 
add»s£s
;

238 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"unixsock‘"è&& 
¬gc
 == 2) {

239 
£rv”
.
unixsock‘
 = 
	`z¡rdup
(
¬gv
[1]);

240 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"unixsock‘³rm"è&& 
¬gc
 == 2) {

241 
”ºo
 = 0;

242 
£rv”
.
unixsock‘³rm
 = (
mode_t
)
	`¡¹Ş
(
¬gv
[1], 
NULL
, 8);

243 ià(
”ºo
 || 
£rv”
.
unixsock‘³rm
 > 0777) {

244 
”r
 = "Inv®id sock‘ f³rmissiÚs"; 
lßd”r
;

246 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"save")) {

247 ià(
¬gc
 == 3) {

248 
£cÚds
 = 
	`©oi
(
¬gv
[1]);

249 
chªges
 = 
	`©oi
(
¬gv
[2]);

250 ià(
£cÚds
 < 1 || 
chªges
 < 0) {

251 
”r
 = "Inv®id sav·¿m‘”s"; 
lßd”r
;

253 
	`­³ndS”v”SaveP¬ams
(
£cÚds
,
chªges
);

254 } ià(
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
¬gv
[1],"")) {

255 
	`»£tS”v”SaveP¬ams
();

257 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"dœ"è&& 
¬gc
 == 2) {

258 ià(
	`chdœ
(
¬gv
[1]) == -1) {

259 
	`£rv”Log
(
LL_WARNING
,"Can't chdiro '%s': %s",

260 
¬gv
[1], 
	`¡»¼Ü
(
”ºo
));

261 
	`ex™
(1);

263 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"logËv–"è&& 
¬gc
 == 2) {

264 
£rv”
.
v”bos™y
 = 
	`cÚfigEnumG‘V®ue
(
logËv–_’um
,
¬gv
[1]);

265 ià(
£rv”
.
v”bos™y
 =ğ
INT_MIN
) {

266 
”r
 = "Invalid†og†evel. "

268 
lßd”r
;

270 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"logfe"è&& 
¬gc
 == 2) {

271 
FILE
 *
logå
;

273 
	`zä“
(
£rv”
.
logfe
);

274 
£rv”
.
logfe
 = 
	`z¡rdup
(
¬gv
[1]);

275 ià(
£rv”
.
logfe
[0] != '\0') {

278 
logå
 = 
	`fİ’
(
£rv”
.
logfe
,"a");

279 ià(
logå
 =ğ
NULL
) {

280 
”r
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

281 "Cª'ˆİ’hlog fe: %s", 
	`¡»¼Ü
(
”ºo
));

282 
lßd”r
;

284 
	`fşo£
(
logå
);

286 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"®ways-show-logo"è&& 
¬gc
 == 2) {

287 ià((
£rv”
.
®ways_show_logo
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

288 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

290 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-’abËd"è&& 
¬gc
 == 2) {

291 ià((
£rv”
.
sy¦og_’abËd
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

292 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

294 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-id’t"è&& 
¬gc
 == 2) {

295 ià(
£rv”
.
sy¦og_id’t
è
	`zä“
(server.syslog_ident);

296 
£rv”
.
sy¦og_id’t
 = 
	`z¡rdup
(
¬gv
[1]);

297 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-çc™y"è&& 
¬gc
 == 2) {

298 
£rv”
.
sy¦og_çc™y
 =

299 
	`cÚfigEnumG‘V®ue
(
sy¦og_çc™y_’um
,
¬gv
[1]);

300 ià(
£rv”
.
sy¦og_çc™y
 =ğ
INT_MIN
) {

301 
”r
 = "Invalid†og facility. Must be one of USER or between LOCAL0-LOCAL7";

302 
lßd”r
;

304 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"d©aba£s"è&& 
¬gc
 == 2) {

305 
£rv”
.
dbnum
 = 
	`©oi
(
¬gv
[1]);

306 ià(
£rv”
.
dbnum
 < 1) {

307 
”r
 = "Inv®id‚umb” oàd©aba£s"; 
lßd”r
;

309 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"šşude"è&& 
¬gc
 == 2) {

310 
	`lßdS”v”CÚfig
(
¬gv
[1],
NULL
);

311 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxş›Ás"è&& 
¬gc
 == 2) {

312 
£rv”
.
maxş›Ás
 = 
	`©oi
(
¬gv
[1]);

313 ià(
£rv”
.
maxş›Ás
 < 1) {

314 
”r
 = "Inv®id max cl›Á lim™"; 
lßd”r
;

316 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy"è&& 
¬gc
 == 2) {

317 
£rv”
.
maxmemÜy
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

318 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy-pŞicy"è&& 
¬gc
 == 2) {

319 
£rv”
.
maxmemÜy_pŞicy
 =

320 
	`cÚfigEnumG‘V®ue
(
maxmemÜy_pŞicy_’um
,
¬gv
[1]);

321 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
INT_MIN
) {

322 
”r
 = "Invalid maxmemory…olicy";

323 
lßd”r
;

325 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy-§m¶es"è&& 
¬gc
 == 2) {

326 
£rv”
.
maxmemÜy_§m¶es
 = 
	`©oi
(
¬gv
[1]);

327 ià(
£rv”
.
maxmemÜy_§m¶es
 <= 0) {

328 
”r
 = "maxmemory-samples must be 1 or greater";

329 
lßd”r
;

331 } ià((!
	`¡rÿ£cmp
(
¬gv
[0],"´Ùo-max-bulk-Ën")è&& 
¬gc
 == 2) {

332 
£rv”
.
´Ùo_max_bulk_Ën
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

333 } ià((!
	`¡rÿ£cmp
(
¬gv
[0],"ş›Á-qu”y-bufãr-lim™")è&& 
¬gc
 == 2) {

334 
£rv”
.
ş›Á_max_qu”ybuf_Ën
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

335 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lfu-log-çùÜ"è&& 
¬gc
 == 2) {

336 
£rv”
.
lfu_log_çùÜ
 = 
	`©oi
(
¬gv
[1]);

337 ià(
£rv”
.
lfu_log_çùÜ
 < 0) {

338 
”r
 = "lfu-log-factor must be 0 or greater";

339 
lßd”r
;

341 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lfu-deÿy-time"è&& 
¬gc
 == 2) {

342 
£rv”
.
lfu_deÿy_time
 = 
	`©oi
(
¬gv
[1]);

343 ià(
£rv”
.
lfu_deÿy_time
 < 0) {

344 
”r
 = "lfu-decay-time must be 0 or greater";

345 
lßd”r
;

347 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦aveof"è&& 
¬gc
 == 3) {

348 
¦aveof_lš’um
 = 
lš’um
;

349 
£rv”
.
ma¡”ho¡
 = 
	`sd¢ew
(
¬gv
[1]);

350 
£rv”
.
ma¡”pÜt
 = 
	`©oi
(
¬gv
[2]);

351 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

352 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-pšg-¦ave-³riod"è&& 
¬gc
 == 2) {

353 
£rv”
.
»¶_pšg_¦ave_³riod
 = 
	`©oi
(
¬gv
[1]);

354 ià(
£rv”
.
»¶_pšg_¦ave_³riod
 <= 0) {

355 
”r
 = "repl-ping-slave-period must be 1 or greater";

356 
lßd”r
;

358 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-timeout"è&& 
¬gc
 == 2) {

359 
£rv”
.
»¶_timeout
 = 
	`©oi
(
¬gv
[1]);

360 ià(
£rv”
.
»¶_timeout
 <= 0) {

361 
”r
 = "repl-timeout must be 1 or greater";

362 
lßd”r
;

364 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-di§bË-tı-nod–ay"è&& 
¬gc
==2) {

365 ià((
£rv”
.
»¶_di§bË_tı_nod–ay
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

366 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

368 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-diskËss-sync"è&& 
¬gc
==2) {

369 ià((
£rv”
.
»¶_diskËss_sync
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

370 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

372 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-diskËss-sync-d–ay"è&& 
¬gc
==2) {

373 
£rv”
.
»¶_diskËss_sync_d–ay
 = 
	`©oi
(
¬gv
[1]);

374 ià(
£rv”
.
»¶_diskËss_sync_d–ay
 < 0) {

375 
”r
 = "repl-diskless-sync-delay can't be‚egative";

376 
lßd”r
;

378 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-backlog-size"è&& 
¬gc
 == 2) {

379 
size
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

380 ià(
size
 <= 0) {

381 
”r
 = "repl-backlog-size must be 1 or greater.";

382 
lßd”r
;

384 
	`»sizeR•liÿtiÚBacklog
(
size
);

385 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-backlog-‰l"è&& 
¬gc
 == 2) {

386 
£rv”
.
»¶_backlog_time_lim™
 = 
	`©oi
(
¬gv
[1]);

387 ià(
£rv”
.
»¶_backlog_time_lim™
 < 0) {

388 
”r
 = "repl-backlog-ttl can't be‚egative ";

389 
lßd”r
;

391 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ma¡”auth"è&& 
¬gc
 == 2) {

392 
	`zä“
(
£rv”
.
ma¡”auth
);

393 
£rv”
.
ma¡”auth
 = 
	`z¡rdup
(
¬gv
[1]);

394 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-£rve-¡®e-d©a"è&& 
¬gc
 == 2) {

395 ià((
£rv”
.
»¶_£rve_¡®e_d©a
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

396 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

398 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-»ad-Úly"è&& 
¬gc
 == 2) {

399 ià((
£rv”
.
»¶_¦ave_ro
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

400 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

402 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"rdbcom´essiÚ"è&& 
¬gc
 == 2) {

403 ià((
£rv”
.
rdb_com´essiÚ
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

404 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

406 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"rdbchecksum"è&& 
¬gc
 == 2) {

407 ià((
£rv”
.
rdb_checksum
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

408 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

410 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùiv”ehashšg"è&& 
¬gc
 == 2) {

411 ià((
£rv”
.
aùiv”ehashšg
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

412 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

414 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ïzyä“-Ïzy-eviùiÚ"è&& 
¬gc
 == 2) {

415 ià((
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

416 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

418 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ïzyä“-Ïzy-expœe"è&& 
¬gc
 == 2) {

419 ià((
£rv”
.
Ïzyä“_Ïzy_expœe
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

420 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

422 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ïzyä“-Ïzy-£rv”-d–"è&& 
¬gc
 == 2){

423 ià((
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

424 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

426 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-Ïzy-æush"è&& 
¬gc
 == 2) {

427 ià((
£rv”
.
»¶_¦ave_Ïzy_æush
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

428 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

430 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùivedeäag"è&& 
¬gc
 == 2) {

431 ià((
£rv”
.
aùive_deäag_’abËd
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

432 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

434 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"d«mÚize"è&& 
¬gc
 == 2) {

435 ià((
£rv”
.
d«mÚize
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

436 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

438 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hz"è&& 
¬gc
 == 2) {

439 
£rv”
.
hz
 = 
	`©oi
(
¬gv
[1]);

440 ià(
£rv”
.
hz
 < 
CONFIG_MIN_HZ
) server.hz = CONFIG_MIN_HZ;

441 ià(
£rv”
.
hz
 > 
CONFIG_MAX_HZ
) server.hz = CONFIG_MAX_HZ;

442 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndÚly"è&& 
¬gc
 == 2) {

443 
yes
;

445 ià((
yes
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

446 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

448 
£rv”
.
aof_¡©e
 = 
yes
 ? 
AOF_ON
 : 
AOF_OFF
;

449 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndf’ame"è&& 
¬gc
 == 2) {

450 ià(!
	`·thIsBa£Name
(
¬gv
[1])) {

451 
”r
 = "appendfilename can't be‡…ath, just‡ filename";

452 
lßd”r
;

454 
	`zä“
(
£rv”
.
aof_f’ame
);

455 
£rv”
.
aof_f’ame
 = 
	`z¡rdup
(
¬gv
[1]);

456 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"no-appendfsync-on-rewrite")

457 && 
¬gc
 == 2) {

458 ià((
£rv”
.
aof_no_fsync_Ú_»wr™e
ğ
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

459 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

461 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndfsync"è&& 
¬gc
 == 2) {

462 
£rv”
.
aof_fsync
 = 
	`cÚfigEnumG‘V®ue
(
aof_fsync_’um
,
¬gv
[1]);

463 ià(
£rv”
.
aof_fsync
 =ğ
INT_MIN
) {

464 
”r
 = "argument must be 'no', 'always' or 'everysec'";

465 
lßd”r
;

467 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auto-aof-rewrite-percentage") &&

468 
¬gc
 == 2)

470 
£rv”
.
aof_»wr™e_³rc
 = 
	`©oi
(
¬gv
[1]);

471 ià(
£rv”
.
aof_»wr™e_³rc
 < 0) {

472 
”r
 = "Invalid‚egative…ercentage for AOF‡uto„ewrite";

473 
lßd”r
;

475 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auto-aof-rewrite-min-size") &&

476 
¬gc
 == 2)

478 
£rv”
.
aof_»wr™e_mš_size
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

479 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aof-rewrite-incremental-fsync") &&

480 
¬gc
 == 2)

482 ià((
£rv”
.
aof_»wr™e_šüem’l_fsync
 =

483 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

484 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

486 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aof-lßd-Œunÿ‹d"è&& 
¬gc
 == 2) {

487 ià((
£rv”
.
aof_lßd_Œunÿ‹d
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

488 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

490 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aof-u£-rdb-´—mbË"è&& 
¬gc
 == 2) {

491 ià((
£rv”
.
aof_u£_rdb_´—mbË
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

492 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

494 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»quœ•ass"è&& 
¬gc
 == 2) {

495 ià(
	`¡¾’
(
¬gv
[1]è> 
CONFIG_AUTHPASS_MAX_LEN
) {

496 
”r
 = "Password is†ongerhan CONFIG_AUTHPASS_MAX_LEN";

497 
lßd”r
;

499 
£rv”
.
»quœ•ass
 = 
	`z¡rdup
(
¬gv
[1]);

500 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"pidfe"è&& 
¬gc
 == 2) {

501 
	`zä“
(
£rv”
.
pidfe
);

502 
£rv”
.
pidfe
 = 
	`z¡rdup
(
¬gv
[1]);

503 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"dbf’ame"è&& 
¬gc
 == 2) {

504 ià(!
	`·thIsBa£Name
(
¬gv
[1])) {

505 
”r
 = "dbfilename can't be‡…ath, just‡ filename";

506 
lßd”r
;

508 
	`zä“
(
£rv”
.
rdb_f’ame
);

509 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
¬gv
[1]);

510 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùive-deäag-th»shŞd-low”"è&& 
¬gc
 == 2) {

511 
£rv”
.
aùive_deäag_th»shŞd_low”
 = 
	`©oi
(
¬gv
[1]);

512 ià(
£rv”
.
aùive_deäag_th»shŞd_low”
 < 0) {

513 
”r
 = "active-defrag-threshold-lower must be 0 or greater";

514 
lßd”r
;

516 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùive-deäag-th»shŞd-uµ”"è&& 
¬gc
 == 2) {

517 
£rv”
.
aùive_deäag_th»shŞd_uµ”
 = 
	`©oi
(
¬gv
[1]);

518 ià(
£rv”
.
aùive_deäag_th»shŞd_uµ”
 < 0) {

519 
”r
 = "active-defrag-threshold-upper must be 0 or greater";

520 
lßd”r
;

522 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùive-deäag-ignÜe-by‹s"è&& 
¬gc
 == 2) {

523 
£rv”
.
aùive_deäag_ignÜe_by‹s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

524 ià(
£rv”
.
aùive_deäag_ignÜe_by‹s
 <= 0) {

525 
”r
 = "active-defrag-ignore-bytes must‡bove 0";

526 
lßd”r
;

528 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùive-deäag-cyşe-mš"è&& 
¬gc
 == 2) {

529 
£rv”
.
aùive_deäag_cyşe_mš
 = 
	`©oi
(
¬gv
[1]);

530 ià(
£rv”
.
aùive_deäag_cyşe_mš
 < 1 || server.active_defrag_cycle_min > 99) {

531 
”r
 = "active-defrag-cycle-min must be between 1‡nd 99";

532 
lßd”r
;

534 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùive-deäag-cyşe-max"è&& 
¬gc
 == 2) {

535 
£rv”
.
aùive_deäag_cyşe_max
 = 
	`©oi
(
¬gv
[1]);

536 ià(
£rv”
.
aùive_deäag_cyşe_max
 < 1 || server.active_defrag_cycle_max > 99) {

537 
”r
 = "active-defrag-cycle-max must be between 1‡nd 99";

538 
lßd”r
;

540 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hash-max-zli¡-’Œ›s"è&& 
¬gc
 == 2) {

541 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

542 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hash-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

543 
£rv”
.
hash_max_zli¡_v®ue
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

544 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-max-zli¡-’Œ›s"è&& 
¬gc
 == 2){

546 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

548 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-max-zli¡-size"è&& 
¬gc
 == 2) {

549 
£rv”
.
li¡_max_zli¡_size
 = 
	`©oi
(
¬gv
[1]);

550 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-com´ess-d•th"è&& 
¬gc
 == 2) {

551 
£rv”
.
li¡_com´ess_d•th
 = 
	`©oi
(
¬gv
[1]);

552 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"£t-max-št£t-’Œ›s"è&& 
¬gc
 == 2) {

553 
£rv”
.
£t_max_št£t_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

554 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"z£t-max-zli¡-’Œ›s"è&& 
¬gc
 == 2) {

555 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

556 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"z£t-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

557 
£rv”
.
z£t_max_zli¡_v®ue
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

558 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hÎ-¥¬£-max-by‹s"è&& 
¬gc
 == 2) {

559 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

560 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»Çme-commªd"è&& 
¬gc
 == 3) {

561 
»disCommªd
 *
cmd
 = 
	`lookupCommªd
(
¬gv
[1]);

562 
»tv®
;

564 ià(!
cmd
) {

565 
”r
 = "No such command in„ename-command";

566 
lßd”r
;

571 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
commªds
, 
¬gv
[1]);

572 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

575 ià(
	`sd¦’
(
¬gv
[2]) != 0) {

576 
sds
 
cİy
 = 
	`sdsdup
(
¬gv
[2]);

578 
»tv®
 = 
	`diùAdd
(
£rv”
.
commªds
, 
cİy
, 
cmd
);

579 ià(
»tv®
 !ğ
DICT_OK
) {

580 
	`sdsä“
(
cİy
);

581 
”r
 = "T¬g‘ commªd‚am®»adyƒxi¡s"; 
lßd”r
;

584 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-’abËd"è&& 
¬gc
 == 2) {

585 ià((
£rv”
.
şu¡”_’abËd
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

586 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

588 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-cÚfig-fe"è&& 
¬gc
 == 2) {

589 
	`zä“
(
£rv”
.
şu¡”_cÚfigfe
);

590 
£rv”
.
şu¡”_cÚfigfe
 = 
	`z¡rdup
(
¬gv
[1]);

591 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-ªnounû-"è&& 
¬gc
 == 2) {

592 
	`zä“
(
£rv”
.
şu¡”_ªnounû_
);

593 
£rv”
.
şu¡”_ªnounû_
 = 
	`z¡rdup
(
¬gv
[1]);

594 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-ªnounû-pÜt"è&& 
¬gc
 == 2) {

595 
£rv”
.
şu¡”_ªnounû_pÜt
 = 
	`©oi
(
¬gv
[1]);

596 ià(
£rv”
.
şu¡”_ªnounû_pÜt
 < 0 ||

597 
£rv”
.
şu¡”_ªnounû_pÜt
 > 65535)

599 
”r
 = "Inv®id…Üt"; 
lßd”r
;

601 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-announce-bus-port") &&

602 
¬gc
 == 2)

604 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 = 
	`©oi
(
¬gv
[1]);

605 ià(
£rv”
.
şu¡”_ªnounû_bus_pÜt
 < 0 ||

606 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 > 65535)

608 
”r
 = "Inv®id…Üt"; 
lßd”r
;

610 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-require-full-coverage") &&

611 
¬gc
 == 2)

613 ià((
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1)

615 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

617 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-node-timeout"è&& 
¬gc
 == 2) {

618 
£rv”
.
şu¡”_node_timeout
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

619 ià(
£rv”
.
şu¡”_node_timeout
 <= 0) {

620 
”r
 = "şu¡”‚odtimeouˆmu¡ b1 o¸g»©”"; 
lßd”r
;

622 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-migration-barrier")

623 && 
¬gc
 == 2)

625 
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 = 
	`©oi
(
¬gv
[1]);

626 ià(
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 < 0) {

627 
”r
 = "cluster migration barrier must zero or…ositive";

628 
lßd”r
;

630 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-slave-validity-factor")

631 && 
¬gc
 == 2)

633 
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 = 
	`©oi
(
¬gv
[1]);

634 ià(
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 < 0) {

635 
”r
 = "cluster slave validity factor must be zero or…ositive";

636 
lßd”r
;

638 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-slave-no-failover") &&

639 
¬gc
 == 2)

641 
£rv”
.
şu¡”_¦ave_no_çov”
 = 
	`ye¢Ùoi
(
¬gv
[1]);

642 ià(
£rv”
.
şu¡”_¦ave_no_çov”
 == -1) {

643 
”r
 = "argument must be 'yes' or 'no'";

644 
lßd”r
;

646 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lua-time-lim™"è&& 
¬gc
 == 2) {

647 
£rv”
.
lua_time_lim™
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

648 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"slowlog-log-slower-than") &&

649 
¬gc
 == 2)

651 
£rv”
.
¦owlog_log_¦ow”_thª
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

652 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"latency-monitor-threshold") &&

653 
¬gc
 == 2)

655 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

656 ià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 < 0) {

657 
”r
 = "The†atencyhreshold can't be‚egative";

658 
lßd”r
;

660 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦owlog-max-Ën"è&& 
¬gc
 == 2) {

661 
£rv”
.
¦owlog_max_Ën
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

662 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"client-output-buffer-limit") &&

663 
¬gc
 == 5)

665 
şass
 = 
	`g‘Cl›ÁTy³ByName
(
¬gv
[1]);

666 
h¬d
, 
soá
;

667 
soá_£cÚds
;

669 ià(
şass
 =ğ-1 || cÏs =ğ
CLIENT_TYPE_MASTER
) {

670 
”r
 = "Unrecognized client†imit class:he user specified "

672 
lßd”r
;

674 
h¬d
 = 
	`memtŞl
(
¬gv
[2],
NULL
);

675 
soá
 = 
	`memtŞl
(
¬gv
[3],
NULL
);

676 
soá_£cÚds
 = 
	`©oi
(
¬gv
[4]);

677 ià(
soá_£cÚds
 < 0) {

678 
”r
 = "Negative‚umber of seconds in soft†imit is invalid";

679 
lßd”r
;

681 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 = 
h¬d
;

682 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 = 
soá
;

683 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
 = 
soá_£cÚds
;

684 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"stop-writes-on-bgsave-error") &&

685 
¬gc
 == 2) {

686 ià((
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

687 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

689 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-´iÜ™y"è&& 
¬gc
 == 2) {

690 
£rv”
.
¦ave_´iÜ™y
 = 
	`©oi
(
¬gv
[1]);

691 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-ªnounû-"è&& 
¬gc
 == 2) {

692 
	`zä“
(
£rv”
.
¦ave_ªnounû_
);

693 
£rv”
.
¦ave_ªnounû_
 = 
	`z¡rdup
(
¬gv
[1]);

694 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-ªnounû-pÜt"è&& 
¬gc
 == 2) {

695 
£rv”
.
¦ave_ªnounû_pÜt
 = 
	`©oi
(
¬gv
[1]);

696 ià(
£rv”
.
¦ave_ªnounû_pÜt
 < 0 ||

697 
£rv”
.
¦ave_ªnounû_pÜt
 > 65535)

699 
”r
 = "Inv®id…Üt"; 
lßd”r
;

701 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mš-¦aves-to-wr™e"è&& 
¬gc
 == 2) {

702 
£rv”
.
»¶_mš_¦aves_to_wr™e
 = 
	`©oi
(
¬gv
[1]);

703 ià(
£rv”
.
»¶_mš_¦aves_to_wr™e
 < 0) {

704 
”r
 = "Inv®id v®ufÜ mš-¦aves-to-wr™e."; 
lßd”r
;

706 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mš-¦aves-max-Ïg"è&& 
¬gc
 == 2) {

707 
£rv”
.
»¶_mš_¦aves_max_Ïg
 = 
	`©oi
(
¬gv
[1]);

708 ià(
£rv”
.
»¶_mš_¦aves_max_Ïg
 < 0) {

709 
”r
 = "Inv®id v®ufÜ mš-¦aves-max-Ïg."; 
lßd”r
;

711 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"nÙify-key¥aû-ev’ts"è&& 
¬gc
 == 2) {

712 
æags
 = 
	`key¥aûEv’tsSŒšgToFÏgs
(
¬gv
[1]);

714 ià(
æags
 == -1) {

715 
”r
 = "Invalidƒvent class character. Use 'g$lshzxeA'.";

716 
lßd”r
;

718 
£rv”
.
nÙify_key¥aû_ev’ts
 = 
æags
;

719 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"su³rvi£d"è&& 
¬gc
 == 2) {

720 
£rv”
.
su³rvi£d_mode
 =

721 
	`cÚfigEnumG‘V®ue
(
su³rvi£d_mode_’um
,
¬gv
[1]);

723 ià(
£rv”
.
su³rvi£d_mode
 =ğ
INT_MIN
) {

724 
”r
 = "Invalid option for 'supervised'. "

726 
lßd”r
;

728 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lßdmoduË"è&& 
¬gc
 >= 2) {

729 
	`queueLßdModuË
(
¬gv
[1],&¬gv[2],
¬gc
-2);

730 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sentinel")) {

733 ià(
¬gc
 != 1) {

734 ià(!
£rv”
.
£Áš–_mode
) {

735 
”r
 = "sentinel directive while‚ot in sentinel mode";

736 
lßd”r
;

738 
”r
 = 
	`£Áš–HªdËCÚfigu¿tiÚ
(
¬gv
+1,
¬gc
-1);

739 ià(
”r
è
lßd”r
;

742 
”r
 = "Bad dœeùivÜ wrÚg‚umb” oà¬gum’ts"; 
lßd”r
;

744 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

748 ià(
£rv”
.
şu¡”_’abËd
 && s”v”.
ma¡”ho¡
) {

749 
lš’um
 = 
¦aveof_lš’um
;

750 
i
 = 
lš’um
-1;

751 
”r
 = "slaveof directive‚ot‡llowed in cluster mode";

752 
lßd”r
;

755 
	`sdsä“¥l™»s
(
lšes
,
tÙlšes
);

758 
lßd”r
:

759 
	`årštf
(
¡d”r
, "\n*** FATAL CONFIG FILE ERROR ***\n");

760 
	`årštf
(
¡d”r
, "R—dšghcÚfigu¿tiÚ fe,‡ˆlš%d\n", 
lš’um
);

761 
	`årštf
(
¡d”r
, ">>> '%s'\n", 
lšes
[
i
]);

762 
	`årštf
(
¡d”r
, "%s\n", 
”r
);

763 
	`ex™
(1);

764 
	}
}

773 
	$lßdS”v”CÚfig
(*
f’ame
, *
İtiÚs
) {

774 
sds
 
cÚfig
 = 
	`sd£m±y
();

775 
buf
[
CONFIG_MAX_LINE
+1];

778 ià(
f’ame
) {

779 
FILE
 *
å
;

781 ià(
f’ame
[0] == '-' && filename[1] == '\0') {

782 
å
 = 
¡dš
;

784 ià((
å
 = 
	`fİ’
(
f’ame
,"r")è=ğ
NULL
) {

785 
	`£rv”Log
(
LL_WARNING
,

786 "F©®ƒ¼Ü, cª'ˆİ’ cÚfig f'%s'", 
f’ame
);

787 
	`ex™
(1);

790 
	`fg‘s
(
buf
,
CONFIG_MAX_LINE
+1,
å
è!ğ
NULL
)

791 
cÚfig
 = 
	`sdsÿt
(cÚfig,
buf
);

792 ià(
å
 !ğ
¡dš
è
	`fşo£
(fp);

795 ià(
İtiÚs
) {

796 
cÚfig
 = 
	`sdsÿt
(config,"\n");

797 
cÚfig
 = 
	`sdsÿt
(cÚfig,
İtiÚs
);

799 
	`lßdS”v”CÚfigFromSŒšg
(
cÚfig
);

800 
	`sdsä“
(
cÚfig
);

801 
	}
}

807 
	#cÚfig_£t_boŞ_f›ld
(
_Çme
,
_v¬
) \

808 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

809 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
); \

810 ià(
yn
 =ğ-1è
badfmt
; \

811 
_v¬
 = 
yn
;

	)

813 
	#cÚfig_£t_num”iÿl_f›ld
(
_Çme
,
_v¬
,
mš
,
max
) \

814 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

815 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
è
badfmt
; \

816 ià(
mš
 !ğ
LLONG_MIN
 && 
Î
 < mšè
badfmt
; \

817 ià(
max
 !ğ
LLONG_MAX
 && 
Î
 > maxè
badfmt
; \

818 
_v¬
 = 
Î
;

	)

820 
	#cÚfig_£t_memÜy_f›ld
(
_Çme
,
_v¬
) \

821 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

822 
Î
 = 
	`memtŞl
(
o
->
±r
,&
”r
); \

823 ià(
”r
 || 
Î
 < 0è
badfmt
; \

824 
_v¬
 = 
Î
;

	)

826 
	#cÚfig_£t_’um_f›ld
(
_Çme
,
_v¬
,
_’umv¬
) \

827 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)) { \

828 
’umv®
 = 
	`cÚfigEnumG‘V®ue
(
_’umv¬
,
o
->
±r
); \

829 ià(
’umv®
 =ğ
INT_MIN
è
badfmt
; \

830 
_v¬
 = 
’umv®
;

	)

832 
	#cÚfig_£t_¥ecŸl_f›ld
(
_Çme
) \

833 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,
_Çme
)è{

	)

835 
	#cÚfig_£t_–£
 } 

	)

837 
	$cÚfigS‘Commªd
(
ş›Á
 *
c
) {

838 
robj
 *
o
;

839 
Î
;

840 
”r
;

841 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[2],
	`sdsEncodedObjeù
(c->argv[2]));

842 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[3],
	`sdsEncodedObjeù
(c->argv[3]));

843 
o
 = 
c
->
¬gv
[3];

848 
	`cÚfig_£t_¥ecŸl_f›ld
("dbfilename") {

849 ià(!
	`·thIsBa£Name
(
o
->
±r
)) {

850 
	`addR•lyE¼Ü
(
c
, "dbfilename can't be‡…ath, just‡ filename");

853 
	`zä“
(
£rv”
.
rdb_f’ame
);

854 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
o
->
±r
);

855 } 
	`cÚfig_£t_¥ecŸl_f›ld
("requirepass") {

856 ià(
	`sd¦’
(
o
->
±r
è> 
CONFIG_AUTHPASS_MAX_LEN
è
badfmt
;

857 
	`zä“
(
£rv”
.
»quœ•ass
);

858 
£rv”
.
»quœ•ass
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

859 } 
	`cÚfig_£t_¥ecŸl_f›ld
("masterauth") {

860 
	`zä“
(
£rv”
.
ma¡”auth
);

861 
£rv”
.
ma¡”auth
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

862 } 
	`cÚfig_£t_¥ecŸl_f›ld
("cluster-announce-ip") {

863 
	`zä“
(
£rv”
.
şu¡”_ªnounû_
);

864 
£rv”
.
şu¡”_ªnounû_
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

865 } 
	`cÚfig_£t_¥ecŸl_f›ld
("maxclients") {

866 
Üig_v®ue
 = 
£rv”
.
maxş›Ás
;

868 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†È< 1è
badfmt
;

871 
£rv”
.
maxş›Ás
 = 
Î
;

872 ià(
Î
 > 
Üig_v®ue
) {

873 
	`adju¡O³nFesLim™
();

874 ià(
£rv”
.
maxş›Ás
 !ğ
Î
) {

875 
	`addR•lyE¼ÜFÜm©
(
c
,"Thİ”©šg sy¡em i nÙ‡bËØhªdËh¥ecif›d‚umb” oàş›Ás,ry w™h %d", 
£rv”
.
maxş›Ás
);

876 
£rv”
.
maxş›Ás
 = 
Üig_v®ue
;

879 ià((è
	`«G‘S‘Size
(
£rv”
.
–
) <

880 
£rv”
.
maxş›Ás
 + 
CONFIG_FDSET_INCR
)

882 ià(
	`«ResizeS‘Size
(
£rv”
.
–
,

883 
£rv”
.
maxş›Ás
 + 
CONFIG_FDSET_INCR
è=ğ
AE_ERR
)

885 
	`addR•lyE¼Ü
(
c
,"Theƒvent†oop API used by Redis is‚ot‡bleo handlehe specified‚umber of clients");

886 
£rv”
.
maxş›Ás
 = 
Üig_v®ue
;

891 } 
	`cÚfig_£t_¥ecŸl_f›ld
("appendonly") {

892 
’abË
 = 
	`ye¢Ùoi
(
o
->
±r
);

894 ià(
’abË
 =ğ-1è
badfmt
;

895 ià(
’abË
 =ğ0 && 
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

896 
	`¡İAµ’dOÆy
();

897 } ià(
’abË
 && 
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
) {

898 ià(
	`¡¬tAµ’dOÆy
(è=ğ
C_ERR
) {

899 
	`addR•lyE¼Ü
(
c
,

904 } 
	`cÚfig_£t_¥ecŸl_f›ld
("save") {

905 
vËn
, 
j
;

906 
sds
 *
v
 = 
	`sds¥l™Ën
(
o
->
±r
,
	`sd¦’
(o->±r)," ",1,&
vËn
);

911 ià(
vËn
 & 1) {

912 
	`sdsä“¥l™»s
(
v
,
vËn
);

913 
badfmt
;

915 
j
 = 0; j < 
vËn
; j++) {

916 *
•Œ
;

917 
v®
;

919 
v®
 = 
	`¡¹Şl
(
v
[
j
], &
•Œ
, 10);

920 ià(
•Œ
[0] != '\0' ||

921 ((
j
 & 1è=ğ0 && 
v®
 < 1) ||

922 ((
j
 & 1è=ğ1 && 
v®
 < 0)) {

923 
	`sdsä“¥l™»s
(
v
,
vËn
);

924 
badfmt
;

928 
	`»£tS”v”SaveP¬ams
();

929 
j
 = 0; j < 
vËn
; j += 2) {

930 
time_t
 
£cÚds
;

931 
chªges
;

933 
£cÚds
 = 
	`¡¹Şl
(
v
[
j
],
NULL
,10);

934 
chªges
 = 
	`¡¹Şl
(
v
[
j
+1],
NULL
,10);

935 
	`­³ndS”v”SaveP¬ams
(
£cÚds
, 
chªges
);

937 
	`sdsä“¥l™»s
(
v
,
vËn
);

938 } 
	`cÚfig_£t_¥ecŸl_f›ld
("dir") {

939 ià(
	`chdœ
((*)
o
->
±r
) == -1) {

940 
	`addR•lyE¼ÜFÜm©
(
c
,"Chªgšg dœeùÜy: %s", 
	`¡»¼Ü
(
”ºo
));

943 } 
	`cÚfig_£t_¥ecŸl_f›ld
("client-output-buffer-limit") {

944 
vËn
, 
j
;

945 
sds
 *
v
 = 
	`sds¥l™Ën
(
o
->
±r
,
	`sd¦’
(o->±r)," ",1,&
vËn
);

948 ià(
vËn
 % 4) {

949 
	`sdsä“¥l™»s
(
v
,
vËn
);

950 
badfmt
;

956 
j
 = 0; j < 
vËn
; j++) {

957 
v®
;

959 ià((
j
 % 4) == 0) {

960 
şass
 = 
	`g‘Cl›ÁTy³ByName
(
v
[
j
]);

961 ià(
şass
 =ğ-1 || cÏs =ğ
CLIENT_TYPE_MASTER
) {

962 
	`sdsä“¥l™»s
(
v
,
vËn
);

963 
badfmt
;

966 
v®
 = 
	`memtŞl
(
v
[
j
], &
”r
);

967 ià(
”r
 || 
v®
 < 0) {

968 
	`sdsä“¥l™»s
(
v
,
vËn
);

969 
badfmt
;

974 
j
 = 0; j < 
vËn
; j += 4) {

975 
şass
;

976 
h¬d
, 
soá
;

977 
soá_£cÚds
;

979 
şass
 = 
	`g‘Cl›ÁTy³ByName
(
v
[
j
]);

980 
h¬d
 = 
	`¡¹Şl
(
v
[
j
+1],
NULL
,10);

981 
soá
 = 
	`¡¹Şl
(
v
[
j
+2],
NULL
,10);

982 
soá_£cÚds
 = 
	`¡¹Şl
(
v
[
j
+3],
NULL
,10);

984 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 = 
h¬d
;

985 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 = 
soá
;

986 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
 = 
soá_£cÚds
;

988 
	`sdsä“¥l™»s
(
v
,
vËn
);

989 } 
	`cÚfig_£t_¥ecŸl_f›ld
("notify-keyspace-events") {

990 
æags
 = 
	`key¥aûEv’tsSŒšgToFÏgs
(
o
->
±r
);

992 ià(
æags
 =ğ-1è
badfmt
;

993 
£rv”
.
nÙify_key¥aû_ev’ts
 = 
æags
;

994 } 
	`cÚfig_£t_¥ecŸl_f›ld
("slave-announce-ip") {

995 
	`zä“
(
£rv”
.
¦ave_ªnounû_
);

996 
£rv”
.
¦ave_ªnounû_
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

1000 } 
	`cÚfig_£t_boŞ_f›ld
(

1001 "rdbcom´essiÚ", 
£rv”
.
rdb_com´essiÚ
) {

1002 } 
	`cÚfig_£t_boŞ_f›ld
(

1003 "»¶-di§bË-tı-nod–ay",
£rv”
.
»¶_di§bË_tı_nod–ay
) {

1004 } 
	`cÚfig_£t_boŞ_f›ld
(

1005 "»¶-diskËss-sync",
£rv”
.
»¶_diskËss_sync
) {

1006 } 
	`cÚfig_£t_boŞ_f›ld
(

1007 "şu¡”-»quœe-fuÎ-cov”age",
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
) {

1008 } 
	`cÚfig_£t_boŞ_f›ld
(

1009 "şu¡”-¦ave-no-çov”",
£rv”
.
şu¡”_¦ave_no_çov”
) {

1010 } 
	`cÚfig_£t_boŞ_f›ld
(

1011 "aof-»wr™e-šüem’l-fsync",
£rv”
.
aof_»wr™e_šüem’l_fsync
) {

1012 } 
	`cÚfig_£t_boŞ_f›ld
(

1013 "aof-lßd-Œunÿ‹d",
£rv”
.
aof_lßd_Œunÿ‹d
) {

1014 } 
	`cÚfig_£t_boŞ_f›ld
(

1015 "aof-u£-rdb-´—mbË",
£rv”
.
aof_u£_rdb_´—mbË
) {

1016 } 
	`cÚfig_£t_boŞ_f›ld
(

1017 "¦ave-£rve-¡®e-d©a",
£rv”
.
»¶_£rve_¡®e_d©a
) {

1018 } 
	`cÚfig_£t_boŞ_f›ld
(

1019 "¦ave-»ad-Úly",
£rv”
.
»¶_¦ave_ro
) {

1020 } 
	`cÚfig_£t_boŞ_f›ld
(

1021 "aùiv”ehashšg",
£rv”
.
aùiv”ehashšg
) {

1022 } 
	`cÚfig_£t_boŞ_f›ld
(

1023 "aùivedeäag",
£rv”
.
aùive_deäag_’abËd
) {

1024 #iâdeà
HAVE_DEFRAG


1025 ià(
£rv”
.
aùive_deäag_’abËd
) {

1026 
£rv”
.
aùive_deäag_’abËd
 = 0;

1027 
	`addR•lyE¼Ü
(
c
,

1034 } 
	`cÚfig_£t_boŞ_f›ld
(

1035 "´Ùeùed-mode",
£rv”
.
´Ùeùed_mode
) {

1036 } 
	`cÚfig_£t_boŞ_f›ld
(

1037 "¡İ-wr™es-Ú-bg§ve-”rÜ",
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
) {

1038 } 
	`cÚfig_£t_boŞ_f›ld
(

1039 "Ïzyä“-Ïzy-eviùiÚ",
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
) {

1040 } 
	`cÚfig_£t_boŞ_f›ld
(

1041 "Ïzyä“-Ïzy-expœe",
£rv”
.
Ïzyä“_Ïzy_expœe
) {

1042 } 
	`cÚfig_£t_boŞ_f›ld
(

1043 "Ïzyä“-Ïzy-£rv”-d–",
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
) {

1044 } 
	`cÚfig_£t_boŞ_f›ld
(

1045 "¦ave-Ïzy-æush",
£rv”
.
»¶_¦ave_Ïzy_æush
) {

1046 } 
	`cÚfig_£t_boŞ_f›ld
(

1047 "no-­³ndfsync-Ú-»wr™e",
£rv”
.
aof_no_fsync_Ú_»wr™e
) {

1051 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1052 "tı-k“·live",
£rv”
.
tık“·live
,0,
LLONG_MAX
) {

1053 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1054 "maxmemÜy-§m¶es",
£rv”
.
maxmemÜy_§m¶es
,1,
LLONG_MAX
) {

1055 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1056 "lfu-log-çùÜ",
£rv”
.
lfu_log_çùÜ
,0,
LLONG_MAX
) {

1057 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1058 "lfu-deÿy-time",
£rv”
.
lfu_deÿy_time
,0,
LLONG_MAX
) {

1059 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1060 "timeout",
£rv”
.
maxidËtime
,0,
LONG_MAX
) {

1061 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1062 "aùive-deäag-th»shŞd-low”",
£rv”
.
aùive_deäag_th»shŞd_low”
,0,1000) {

1063 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1064 "aùive-deäag-th»shŞd-uµ”",
£rv”
.
aùive_deäag_th»shŞd_uµ”
,0,1000) {

1065 } 
	`cÚfig_£t_memÜy_f›ld
(

1066 "aùive-deäag-ignÜe-by‹s",
£rv”
.
aùive_deäag_ignÜe_by‹s
) {

1067 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1068 "aùive-deäag-cyşe-mš",
£rv”
.
aùive_deäag_cyşe_mš
,1,99) {

1069 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1070 "aùive-deäag-cyşe-max",
£rv”
.
aùive_deäag_cyşe_max
,1,99) {

1071 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1072 "auto-aof-»wr™e-³rûÁage",
£rv”
.
aof_»wr™e_³rc
,0,
LLONG_MAX
){

1073 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1074 "hash-max-zli¡-’Œ›s",
£rv”
.
hash_max_zli¡_’Œ›s
,0,
LLONG_MAX
) {

1075 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1076 "hash-max-zli¡-v®ue",
£rv”
.
hash_max_zli¡_v®ue
,0,
LLONG_MAX
) {

1077 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1078 "li¡-max-zli¡-size",
£rv”
.
li¡_max_zli¡_size
,
INT_MIN
,
INT_MAX
) {

1079 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1080 "li¡-com´ess-d•th",
£rv”
.
li¡_com´ess_d•th
,0,
INT_MAX
) {

1081 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1082 "£t-max-št£t-’Œ›s",
£rv”
.
£t_max_št£t_’Œ›s
,0,
LLONG_MAX
) {

1083 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1084 "z£t-max-zli¡-’Œ›s",
£rv”
.
z£t_max_zli¡_’Œ›s
,0,
LLONG_MAX
) {

1085 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1086 "z£t-max-zli¡-v®ue",
£rv”
.
z£t_max_zli¡_v®ue
,0,
LLONG_MAX
) {

1087 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1088 "hÎ-¥¬£-max-by‹s",
£rv”
.
hÎ_¥¬£_max_by‹s
,0,
LLONG_MAX
) {

1089 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1090 "lua-time-lim™",
£rv”
.
lua_time_lim™
,0,
LLONG_MAX
) {

1091 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1092 "¦owlog-log-¦ow”-thª",
£rv”
.
¦owlog_log_¦ow”_thª
,0,
LLONG_MAX
) {

1093 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1094 "¦owlog-max-Ën",
Î
,0,
LLONG_MAX
) {

1096 
£rv”
.
¦owlog_max_Ën
 = ()
Î
;

1097 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1098 "Ï‹ncy-mÚ™Ü-th»shŞd",
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
,0,
LLONG_MAX
){

1099 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1100 "»¶-pšg-¦ave-³riod",
£rv”
.
»¶_pšg_¦ave_³riod
,1,
LLONG_MAX
) {

1101 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1102 "»¶-timeout",
£rv”
.
»¶_timeout
,1,
LLONG_MAX
) {

1103 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1104 "»¶-backlog-‰l",
£rv”
.
»¶_backlog_time_lim™
,0,
LLONG_MAX
) {

1105 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1106 "»¶-diskËss-sync-d–ay",
£rv”
.
»¶_diskËss_sync_d–ay
,0,
LLONG_MAX
) {

1107 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1108 "¦ave-´iÜ™y",
£rv”
.
¦ave_´iÜ™y
,0,
LLONG_MAX
) {

1109 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1110 "¦ave-ªnounû-pÜt",
£rv”
.
¦ave_ªnounû_pÜt
,0,65535) {

1111 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1112 "mš-¦aves-to-wr™e",
£rv”
.
»¶_mš_¦aves_to_wr™e
,0,
LLONG_MAX
) {

1113 
	`»äeshGoodSÏvesCouÁ
();

1114 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1115 "mš-¦aves-max-Ïg",
£rv”
.
»¶_mš_¦aves_max_Ïg
,0,
LLONG_MAX
) {

1116 
	`»äeshGoodSÏvesCouÁ
();

1117 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1118 "şu¡”-node-timeout",
£rv”
.
şu¡”_node_timeout
,0,
LLONG_MAX
) {

1119 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1120 "şu¡”-ªnounû-pÜt",
£rv”
.
şu¡”_ªnounû_pÜt
,0,65535) {

1121 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1122 "şu¡”-ªnounû-bus-pÜt",
£rv”
.
şu¡”_ªnounû_bus_pÜt
,0,65535) {

1123 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1124 "şu¡”-mig¿tiÚ-b¬r›r",
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
,0,
LLONG_MAX
){

1125 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1126 "şu¡”-¦ave-v®id™y-çùÜ",
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
,0,
LLONG_MAX
) {

1127 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1128 "hz",
£rv”
.
hz
,0,
LLONG_MAX
) {

1131 ià(
£rv”
.
hz
 < 
CONFIG_MIN_HZ
) server.hz = CONFIG_MIN_HZ;

1132 ià(
£rv”
.
hz
 > 
CONFIG_MAX_HZ
) server.hz = CONFIG_MAX_HZ;

1133 } 
	`cÚfig_£t_num”iÿl_f›ld
(

1134 "w©chdog-³riod",
Î
,0,
LLONG_MAX
) {

1135 ià(
Î
)

1136 
	`’abËW©chdog
(
Î
);

1138 
	`di§bËW©chdog
();

1142 } 
	`cÚfig_£t_memÜy_f›ld
("maxmemÜy",
£rv”
.
maxmemÜy
) {

1143 ià(
£rv”
.
maxmemÜy
) {

1144 ià(
£rv”
.
maxmemÜy
 < 
	`zm®loc_u£d_memÜy
()) {

1145 
	`£rv”Log
(
LL_WARNING
,"WARNING:he‚ew maxmemory value set via CONFIG SET is smallerhanhe current memory usage. This will„esult in keysƒviction‡nd/or inabilityo‡ccept‚ew write commands depending onhe maxmemory-policy.");

1147 
	`ä“MemÜyIfN“ded
();

1149 } 
	`cÚfig_£t_memÜy_f›ld
(

1150 "´Ùo-max-bulk-Ën",
£rv”
.
´Ùo_max_bulk_Ën
) {

1151 } 
	`cÚfig_£t_memÜy_f›ld
(

1152 "ş›Á-qu”y-bufãr-lim™",
£rv”
.
ş›Á_max_qu”ybuf_Ën
) {

1153 } 
	`cÚfig_£t_memÜy_f›ld
("»¶-backlog-size",
Î
) {

1154 
	`»sizeR•liÿtiÚBacklog
(
Î
);

1155 } 
	`cÚfig_£t_memÜy_f›ld
("auto-aof-»wr™e-mš-size",
Î
) {

1156 
£rv”
.
aof_»wr™e_mš_size
 = 
Î
;

1160 } 
	`cÚfig_£t_’um_f›ld
(

1161 "logËv–",
£rv”
.
v”bos™y
,
logËv–_’um
) {

1162 } 
	`cÚfig_£t_’um_f›ld
(

1163 "maxmemÜy-pŞicy",
£rv”
.
maxmemÜy_pŞicy
,
maxmemÜy_pŞicy_’um
) {

1164 } 
	`cÚfig_£t_’um_f›ld
(

1165 "­³ndfsync",
£rv”
.
aof_fsync
,
aof_fsync_’um
) {

1168 } 
cÚfig_£t_–£
 {

1169 
	`addR•lyE¼ÜFÜm©
(
c
,"Unsupported CONFIG…arameter: %s",

1170 (*)
c
->
¬gv
[2]->
±r
);

1175 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1178 
badfmt
:

1179 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‡rgument '%s' for CONFIG SET '%s'",

1180 (*)
o
->
±r
,

1181 (*)
c
->
¬gv
[2]->
±r
);

1188 
	#cÚfig_g‘_¡ršg_f›ld
(
_Çme
,
_v¬
) do { \

1189 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1190 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1191 
	`addR•lyBulkCSŒšg
(
c
,
_v¬
 ? _var : ""); \

1192 
m©ches
++; \

1194 } 0);

	)

1196 
	#cÚfig_g‘_boŞ_f›ld
(
_Çme
,
_v¬
) do { \

1197 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1198 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1199 
	`addR•lyBulkCSŒšg
(
c
,
_v¬
 ? "yes" : "no"); \

1200 
m©ches
++; \

1202 } 0);

	)

1204 
	#cÚfig_g‘_num”iÿl_f›ld
(
_Çme
,
_v¬
) do { \

1205 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1206 
	`Î2¡ršg
(
buf
,(buf),
_v¬
); \

1207 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1208 
	`addR•lyBulkCSŒšg
(
c
,
buf
); \

1209 
m©ches
++; \

1211 } 0);

	)

1213 
	#cÚfig_g‘_’um_f›ld
(
_Çme
,
_v¬
,
_’umv¬
) do { \

1214 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,1)) { \

1215 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1216 
	`addR•lyBulkCSŒšg
(
c
,
	`cÚfigEnumG‘NameOrUnknown
(
_’umv¬
,
_v¬
)); \

1217 
m©ches
++; \

1219 } 0);

	)

1221 
	`cÚfigG‘Commªd
(
ş›Á
 *
c
) {

1222 
robj
 *
o
 = 
c
->
¬gv
[2];

1223 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1224 *
·‰”n
 = 
o
->
±r
;

1225 
buf
[128];

1226 
m©ches
 = 0;

1227 
	`£rv”As£¹W™hInfo
(
c
,
o
,
	`sdsEncodedObjeù
(o));

1230 
	`cÚfig_g‘_¡ršg_f›ld
("dbf’ame",
£rv”
.
rdb_f’ame
);

1231 
	`cÚfig_g‘_¡ršg_f›ld
("»quœ•ass",
£rv”
.
»quœ•ass
);

1232 
	`cÚfig_g‘_¡ršg_f›ld
("ma¡”auth",
£rv”
.
ma¡”auth
);

1233 
	`cÚfig_g‘_¡ršg_f›ld
("şu¡”-ªnounû-",
£rv”
.
şu¡”_ªnounû_
);

1234 
	`cÚfig_g‘_¡ršg_f›ld
("unixsock‘",
£rv”
.
unixsock‘
);

1235 
	`cÚfig_g‘_¡ršg_f›ld
("logfe",
£rv”
.
logfe
);

1236 
	`cÚfig_g‘_¡ršg_f›ld
("pidfe",
£rv”
.
pidfe
);

1237 
	`cÚfig_g‘_¡ršg_f›ld
("¦ave-ªnounû-",
£rv”
.
¦ave_ªnounû_
);

1240 
	`cÚfig_g‘_num”iÿl_f›ld
("maxmemÜy",
£rv”
.
maxmemÜy
);

1241 
	`cÚfig_g‘_num”iÿl_f›ld
("´Ùo-max-bulk-Ën",
£rv”
.
´Ùo_max_bulk_Ën
);

1242 
	`cÚfig_g‘_num”iÿl_f›ld
("ş›Á-qu”y-bufãr-lim™",
£rv”
.
ş›Á_max_qu”ybuf_Ën
);

1243 
	`cÚfig_g‘_num”iÿl_f›ld
("maxmemÜy-§m¶es",
£rv”
.
maxmemÜy_§m¶es
);

1244 
	`cÚfig_g‘_num”iÿl_f›ld
("lfu-log-çùÜ",
£rv”
.
lfu_log_çùÜ
);

1245 
	`cÚfig_g‘_num”iÿl_f›ld
("lfu-deÿy-time",
£rv”
.
lfu_deÿy_time
);

1246 
	`cÚfig_g‘_num”iÿl_f›ld
("timeout",
£rv”
.
maxidËtime
);

1247 
	`cÚfig_g‘_num”iÿl_f›ld
("aùive-deäag-th»shŞd-low”",
£rv”
.
aùive_deäag_th»shŞd_low”
);

1248 
	`cÚfig_g‘_num”iÿl_f›ld
("aùive-deäag-th»shŞd-uµ”",
£rv”
.
aùive_deäag_th»shŞd_uµ”
);

1249 
	`cÚfig_g‘_num”iÿl_f›ld
("aùive-deäag-ignÜe-by‹s",
£rv”
.
aùive_deäag_ignÜe_by‹s
);

1250 
	`cÚfig_g‘_num”iÿl_f›ld
("aùive-deäag-cyşe-mš",
£rv”
.
aùive_deäag_cyşe_mš
);

1251 
	`cÚfig_g‘_num”iÿl_f›ld
("aùive-deäag-cyşe-max",
£rv”
.
aùive_deäag_cyşe_max
);

1252 
	`cÚfig_g‘_num”iÿl_f›ld
("auto-aof-rewrite-percentage",

1253 
£rv”
.
aof_»wr™e_³rc
);

1254 
	`cÚfig_g‘_num”iÿl_f›ld
("auto-aof-rewrite-min-size",

1255 
£rv”
.
aof_»wr™e_mš_size
);

1256 
	`cÚfig_g‘_num”iÿl_f›ld
("hash-max-ziplist-entries",

1257 
£rv”
.
hash_max_zli¡_’Œ›s
);

1258 
	`cÚfig_g‘_num”iÿl_f›ld
("hash-max-ziplist-value",

1259 
£rv”
.
hash_max_zli¡_v®ue
);

1260 
	`cÚfig_g‘_num”iÿl_f›ld
("list-max-ziplist-size",

1261 
£rv”
.
li¡_max_zli¡_size
);

1262 
	`cÚfig_g‘_num”iÿl_f›ld
("list-compress-depth",

1263 
£rv”
.
li¡_com´ess_d•th
);

1264 
	`cÚfig_g‘_num”iÿl_f›ld
("set-max-intset-entries",

1265 
£rv”
.
£t_max_št£t_’Œ›s
);

1266 
	`cÚfig_g‘_num”iÿl_f›ld
("zset-max-ziplist-entries",

1267 
£rv”
.
z£t_max_zli¡_’Œ›s
);

1268 
	`cÚfig_g‘_num”iÿl_f›ld
("zset-max-ziplist-value",

1269 
£rv”
.
z£t_max_zli¡_v®ue
);

1270 
	`cÚfig_g‘_num”iÿl_f›ld
("hll-sparse-max-bytes",

1271 
£rv”
.
hÎ_¥¬£_max_by‹s
);

1272 
	`cÚfig_g‘_num”iÿl_f›ld
("lua-time-lim™",
£rv”
.
lua_time_lim™
);

1273 
	`cÚfig_g‘_num”iÿl_f›ld
("slowlog-log-slower-than",

1274 
£rv”
.
¦owlog_log_¦ow”_thª
);

1275 
	`cÚfig_g‘_num”iÿl_f›ld
("latency-monitor-threshold",

1276 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
);

1277 
	`cÚfig_g‘_num”iÿl_f›ld
("slowlog-max-len",

1278 
£rv”
.
¦owlog_max_Ën
);

1279 
	`cÚfig_g‘_num”iÿl_f›ld
("pÜt",
£rv”
.
pÜt
);

1280 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-ªnounû-pÜt",
£rv”
.
şu¡”_ªnounû_pÜt
);

1281 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-ªnounû-bus-pÜt",
£rv”
.
şu¡”_ªnounû_bus_pÜt
);

1282 
	`cÚfig_g‘_num”iÿl_f›ld
("tı-backlog",
£rv”
.
tı_backlog
);

1283 
	`cÚfig_g‘_num”iÿl_f›ld
("d©aba£s",
£rv”
.
dbnum
);

1284 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-pšg-¦ave-³riod",
£rv”
.
»¶_pšg_¦ave_³riod
);

1285 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-timeout",
£rv”
.
»¶_timeout
);

1286 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-backlog-size",
£rv”
.
»¶_backlog_size
);

1287 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-backlog-‰l",
£rv”
.
»¶_backlog_time_lim™
);

1288 
	`cÚfig_g‘_num”iÿl_f›ld
("maxş›Ás",
£rv”
.
maxş›Ás
);

1289 
	`cÚfig_g‘_num”iÿl_f›ld
("w©chdog-³riod",
£rv”
.
w©chdog_³riod
);

1290 
	`cÚfig_g‘_num”iÿl_f›ld
("¦ave-´iÜ™y",
£rv”
.
¦ave_´iÜ™y
);

1291 
	`cÚfig_g‘_num”iÿl_f›ld
("¦ave-ªnounû-pÜt",
£rv”
.
¦ave_ªnounû_pÜt
);

1292 
	`cÚfig_g‘_num”iÿl_f›ld
("mš-¦aves-to-wr™e",
£rv”
.
»¶_mš_¦aves_to_wr™e
);

1293 
	`cÚfig_g‘_num”iÿl_f›ld
("mš-¦aves-max-Ïg",
£rv”
.
»¶_mš_¦aves_max_Ïg
);

1294 
	`cÚfig_g‘_num”iÿl_f›ld
("hz",
£rv”
.
hz
);

1295 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-node-timeout",
£rv”
.
şu¡”_node_timeout
);

1296 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-mig¿tiÚ-b¬r›r",
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
);

1297 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-¦ave-v®id™y-çùÜ",
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
);

1298 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-diskËss-sync-d–ay",
£rv”
.
»¶_diskËss_sync_d–ay
);

1299 
	`cÚfig_g‘_num”iÿl_f›ld
("tı-k“·live",
£rv”
.
tık“·live
);

1302 
	`cÚfig_g‘_boŞ_f›ld
("cluster-require-full-coverage",

1303 
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
);

1304 
	`cÚfig_g‘_boŞ_f›ld
("cluster-slave-no-failover",

1305 
£rv”
.
şu¡”_¦ave_no_çov”
);

1306 
	`cÚfig_g‘_boŞ_f›ld
("no-appendfsync-on-rewrite",

1307 
£rv”
.
aof_no_fsync_Ú_»wr™e
);

1308 
	`cÚfig_g‘_boŞ_f›ld
("slave-serve-stale-data",

1309 
£rv”
.
»¶_£rve_¡®e_d©a
);

1310 
	`cÚfig_g‘_boŞ_f›ld
("slave-read-only",

1311 
£rv”
.
»¶_¦ave_ro
);

1312 
	`cÚfig_g‘_boŞ_f›ld
("stop-writes-on-bgsave-error",

1313 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
);

1314 
	`cÚfig_g‘_boŞ_f›ld
("d«mÚize", 
£rv”
.
d«mÚize
);

1315 
	`cÚfig_g‘_boŞ_f›ld
("rdbcom´essiÚ", 
£rv”
.
rdb_com´essiÚ
);

1316 
	`cÚfig_g‘_boŞ_f›ld
("rdbchecksum", 
£rv”
.
rdb_checksum
);

1317 
	`cÚfig_g‘_boŞ_f›ld
("aùiv”ehashšg", 
£rv”
.
aùiv”ehashšg
);

1318 
	`cÚfig_g‘_boŞ_f›ld
("aùivedeäag", 
£rv”
.
aùive_deäag_’abËd
);

1319 
	`cÚfig_g‘_boŞ_f›ld
("´Ùeùed-mode", 
£rv”
.
´Ùeùed_mode
);

1320 
	`cÚfig_g‘_boŞ_f›ld
("repl-disable-tcp-nodelay",

1321 
£rv”
.
»¶_di§bË_tı_nod–ay
);

1322 
	`cÚfig_g‘_boŞ_f›ld
("repl-diskless-sync",

1323 
£rv”
.
»¶_diskËss_sync
);

1324 
	`cÚfig_g‘_boŞ_f›ld
("aof-rewrite-incremental-fsync",

1325 
£rv”
.
aof_»wr™e_šüem’l_fsync
);

1326 
	`cÚfig_g‘_boŞ_f›ld
("aof-load-truncated",

1327 
£rv”
.
aof_lßd_Œunÿ‹d
);

1328 
	`cÚfig_g‘_boŞ_f›ld
("aof-use-rdb-preamble",

1329 
£rv”
.
aof_u£_rdb_´—mbË
);

1330 
	`cÚfig_g‘_boŞ_f›ld
("lazyfree-lazy-eviction",

1331 
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
);

1332 
	`cÚfig_g‘_boŞ_f›ld
("lazyfree-lazy-expire",

1333 
£rv”
.
Ïzyä“_Ïzy_expœe
);

1334 
	`cÚfig_g‘_boŞ_f›ld
("lazyfree-lazy-server-del",

1335 
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
);

1336 
	`cÚfig_g‘_boŞ_f›ld
("slave-lazy-flush",

1337 
£rv”
.
»¶_¦ave_Ïzy_æush
);

1340 
	`cÚfig_g‘_’um_f›ld
("maxmemory-policy",

1341 
£rv”
.
maxmemÜy_pŞicy
,
maxmemÜy_pŞicy_’um
);

1342 
	`cÚfig_g‘_’um_f›ld
("loglevel",

1343 
£rv”
.
v”bos™y
,
logËv–_’um
);

1344 
	`cÚfig_g‘_’um_f›ld
("supervised",

1345 
£rv”
.
su³rvi£d_mode
,
su³rvi£d_mode_’um
);

1346 
	`cÚfig_g‘_’um_f›ld
("appendfsync",

1347 
£rv”
.
aof_fsync
,
aof_fsync_’um
);

1348 
	`cÚfig_g‘_’um_f›ld
("syslog-facility",

1349 
£rv”
.
sy¦og_çc™y
,
sy¦og_çc™y_’um
);

1353 ià(
	`¡ršgm©ch
(
·‰”n
,"appendonly",1)) {

1354 
	`addR•lyBulkCSŒšg
(
c
,"appendonly");

1355 
	`addR•lyBulkCSŒšg
(
c
,
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
 ? "no" : "yes");

1356 
m©ches
++;

1358 ià(
	`¡ršgm©ch
(
·‰”n
,"dir",1)) {

1359 
buf
[1024];

1361 ià(
	`g‘cwd
(
buf
,(buf)è=ğ
NULL
)

1362 
buf
[0] = '\0';

1364 
	`addR•lyBulkCSŒšg
(
c
,"dir");

1365 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1366 
m©ches
++;

1368 ià(
	`¡ršgm©ch
(
·‰”n
,"save",1)) {

1369 
sds
 
buf
 = 
	`sd£m±y
();

1370 
j
;

1372 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1373 
buf
 = 
	`sdsÿrštf
(buf,"%jd %d",

1374 (
štmax_t
)
£rv”
.
§v•¬ams
[
j
].
£cÚds
,

1375 
£rv”
.
§v•¬ams
[
j
].
chªges
);

1376 ià(
j
 !ğ
£rv”
.
§v•¬am¦’
-1)

1377 
buf
 = 
	`sdsÿ’
(buf," ",1);

1379 
	`addR•lyBulkCSŒšg
(
c
,"save");

1380 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1381 
	`sdsä“
(
buf
);

1382 
m©ches
++;

1384 ià(
	`¡ršgm©ch
(
·‰”n
,"client-output-buffer-limit",1)) {

1385 
sds
 
buf
 = 
	`sd£m±y
();

1386 
j
;

1388 
j
 = 0; j < 
CLIENT_TYPE_OBUF_COUNT
; j++) {

1389 
buf
 = 
	`sdsÿrštf
(buf,"%s %llu %llu %ld",

1390 
	`g‘Cl›ÁTy³Name
(
j
),

1391 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
,

1392 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
,

1393 (è
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
);

1394 ià(
j
 !ğ
CLIENT_TYPE_OBUF_COUNT
-1)

1395 
buf
 = 
	`sdsÿ’
(buf," ",1);

1397 
	`addR•lyBulkCSŒšg
(
c
,"client-output-buffer-limit");

1398 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1399 
	`sdsä“
(
buf
);

1400 
m©ches
++;

1402 ià(
	`¡ršgm©ch
(
·‰”n
,"unixsocketperm",1)) {

1403 
buf
[32];

1404 
	`¢´štf
(
buf
,(buf),"%o",
£rv”
.
unixsock‘³rm
);

1405 
	`addR•lyBulkCSŒšg
(
c
,"unixsocketperm");

1406 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1407 
m©ches
++;

1409 ià(
	`¡ršgm©ch
(
·‰”n
,"slaveof",1)) {

1410 
buf
[256];

1412 
	`addR•lyBulkCSŒšg
(
c
,"slaveof");

1413 ià(
£rv”
.
ma¡”ho¡
)

1414 
	`¢´štf
(
buf
,(buf),"%s %d",

1415 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

1417 
buf
[0] = '\0';

1418 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1419 
m©ches
++;

1421 ià(
	`¡ršgm©ch
(
·‰”n
,"notify-keyspace-events",1)) {

1422 
robj
 *
æagsobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,

1423 
	`key¥aûEv’tsFÏgsToSŒšg
(
£rv”
.
nÙify_key¥aû_ev’ts
));

1425 
	`addR•lyBulkCSŒšg
(
c
,"notify-keyspace-events");

1426 
	`addR•lyBulk
(
c
,
æagsobj
);

1427 
	`deüRefCouÁ
(
æagsobj
);

1428 
m©ches
++;

1430 ià(
	`¡ršgm©ch
(
·‰”n
,"bind",1)) {

1431 
sds
 
aux
 = 
	`sdsjoš
(
£rv”
.
bšdaddr
,£rv”.
bšdaddr_couÁ
," ");

1433 
	`addR•lyBulkCSŒšg
(
c
,"bind");

1434 
	`addR•lyBulkCSŒšg
(
c
,
aux
);

1435 
	`sdsä“
(
aux
);

1436 
m©ches
++;

1438 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
m©ches
*2);

1445 
	#REDIS_CONFIG_REWRITE_SIGNATURE
 "# G’”©ed by CONFIG REWRITE"

	)

1450 
ušt64_t
 
	`diùSdsCa£Hash
(cÚ¡ *
key
);

1451 
	`diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

1452 
	`diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
);

1453 
	`diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
);

1457 
	`»wr™eCÚfigS’tš–O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
);

1459 
diùTy³
 
İtiÚToLšeDiùTy³
 = {

1460 
diùSdsCa£Hash
,

1461 
NULL
,

1462 
NULL
,

1463 
diùSdsKeyCa£Com·»
,

1464 
diùSdsDe¡ruùÜ
,

1465 
diùLi¡De¡ruùÜ


1468 
diùTy³
 
İtiÚS‘DiùTy³
 = {

1469 
diùSdsCa£Hash
,

1470 
NULL
,

1471 
NULL
,

1472 
diùSdsKeyCa£Com·»
,

1473 
diùSdsDe¡ruùÜ
,

1474 
NULL


1478 
	s»wr™eCÚfigS‹
 {

1479 
diù
 *
İtiÚ_to_lše
;

1480 
diù
 *
»wr™‹n
;

1481 
numlšes
;

1482 
sds
 *
lšes
;

1483 
has_
;

1488 
	`»wr™eCÚfigAµ’dLše
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
lše
) {

1489 
¡©e
->
lšes
 = 
	`z»®loc
(¡©e->lšes, (*è* (¡©e->
numlšes
+1));

1490 
¡©e
->
lšes
[¡©e->
numlšes
++] = 
lše
;

1494 
	`»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
İtiÚ
, 
lš’um
) {

1495 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
İtiÚ
);

1497 ià(
l
 =ğ
NULL
) {

1498 
l
 = 
	`li¡C»©e
();

1499 
	`diùAdd
(
¡©e
->
İtiÚ_to_lše
,
	`sdsdup
(
İtiÚ
),
l
);

1501 
	`li¡AddNodeTa
(
l
,(*)()
lš’um
);

1508 
	`»wr™eCÚfigM¬kAsProûs£d
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
) {

1509 
sds
 
İt
 = 
	`sd¢ew
(
İtiÚ
);

1511 ià(
	`diùAdd
(
¡©e
->
»wr™‹n
,
İt
,
NULL
è!ğ
DICT_OK
è
	`sdsä“
(opt);

1519 
»wr™eCÚfigS‹
 *
	`»wr™eCÚfigR—dOldFe
(*
·th
) {

1520 
FILE
 *
å
 = 
	`fİ’
(
·th
,"r");

1521 
»wr™eCÚfigS‹
 *
¡©e
 = 
	`zm®loc
((*state));

1522 
buf
[
CONFIG_MAX_LINE
+1];

1523 
lš’um
 = -1;

1525 ià(
å
 =ğ
NULL
 && 
”ºo
 !ğ
ENOENT
)  NULL;

1527 
¡©e
->
İtiÚ_to_lše
 = 
	`diùC»©e
(&
İtiÚToLšeDiùTy³
,
NULL
);

1528 
¡©e
->
»wr™‹n
 = 
	`diùC»©e
(&
İtiÚS‘DiùTy³
,
NULL
);

1529 
¡©e
->
numlšes
 = 0;

1530 
¡©e
->
lšes
 = 
NULL
;

1531 
¡©e
->
has_
 = 0;

1532 ià(
å
 =ğ
NULL
è 
¡©e
;

1535 
	`fg‘s
(
buf
,
CONFIG_MAX_LINE
+1,
å
è!ğ
NULL
) {

1536 
¬gc
;

1537 
sds
 *
¬gv
;

1538 
sds
 
lše
 = 
	`sd¡rim
(
	`sd¢ew
(
buf
),"\r\n\t ");

1540 
lš’um
++;

1543 ià(
lše
[0] == '#' ||†ine[0] == '\0') {

1544 ià(!
¡©e
->
has_
 && !
	`¡rcmp
(
lše
,
REDIS_CONFIG_REWRITE_SIGNATURE
))

1545 
¡©e
->
has_
 = 1;

1546 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1551 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

1552 ià(
¬gv
 =ğ
NULL
) {

1556 
sds
 
aux
 = 
	`sd¢ew
("# ??? ");

1557 
aux
 = 
	`sdsÿtsds
×ux,
lše
);

1558 
	`sdsä“
(
lše
);

1559 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
aux
);

1563 
	`sd¡Şow”
(
¬gv
[0]);

1567 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1568 
	`»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
¡©e
,
¬gv
[0],
lš’um
);

1570 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1572 
	`fşo£
(
å
);

1573  
¡©e
;

1592 
	`»wr™eCÚfigRewr™eLše
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
, 
sds
 
lše
, 
fÜû
) {

1593 
sds
 
o
 = 
	`sd¢ew
(
İtiÚ
);

1594 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
o
);

1596 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1598 ià(!
l
 && !
fÜû
) {

1600 
	`sdsä“
(
lše
);

1601 
	`sdsä“
(
o
);

1605 ià(
l
) {

1606 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

1607 
lš’um
 = (è
Ê
->
v®ue
;

1611 
	`li¡D–Node
(
l
,
Ê
);

1612 ià(
	`li¡L’gth
(
l
è=ğ0è
	`diùD–‘e
(
¡©e
->
İtiÚ_to_lše
,
o
);

1613 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1614 
¡©e
->
lšes
[
lš’um
] = 
lše
;

1617 ià(!
¡©e
->
has_
) {

1618 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,

1619 
	`sd¢ew
(
REDIS_CONFIG_REWRITE_SIGNATURE
));

1620 
¡©e
->
has_
 = 1;

1622 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1624 
	`sdsä“
(
o
);

1629 
	`»wr™eCÚfigFÜm©MemÜy
(*
buf
, 
size_t
 
Ën
, 
by‹s
) {

1630 
gb
 = 1024*1024*1024;

1631 
mb
 = 1024*1024;

1632 
kb
 = 1024;

1634 ià(
by‹s
 && (by‹ % 
gb
) == 0) {

1635  
	`¢´štf
(
buf
,
Ën
,"%Îdgb",
by‹s
/
gb
);

1636 } ià(
by‹s
 && (by‹ % 
mb
) == 0) {

1637  
	`¢´štf
(
buf
,
Ën
,"%Îdmb",
by‹s
/
mb
);

1638 } ià(
by‹s
 && (by‹ % 
kb
) == 0) {

1639  
	`¢´štf
(
buf
,
Ën
,"%Îdkb",
by‹s
/
kb
);

1641  
	`¢´štf
(
buf
,
Ën
,"%Îd",
by‹s
);

1646 
	`»wr™eCÚfigBy‹sO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1647 
buf
[64];

1648 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1649 
sds
 
lše
;

1651 
	`»wr™eCÚfigFÜm©MemÜy
(
buf
,(buf),
v®ue
);

1652 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
buf
);

1653 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1657 
	`»wr™eCÚfigYesNoO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1658 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1659 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,

1660 
v®ue
 ? "yes" : "no");

1662 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1666 
	`»wr™eCÚfigSŒšgO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, *
v®ue
, *
defv®ue
) {

1667 
fÜû
 = 1;

1668 
sds
 
lše
;

1672 ià(
v®ue
 =ğ
NULL
) {

1673 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1678 ià(
defv®ue
 && 
	`¡rcmp
(
v®ue
,defv®ueè=ğ0è
fÜû
 = 0;

1680 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1681 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1682 
lše
 = 
	`sdsÿŒ•r
Öše, 
v®ue
, 
	`¡¾’
(value));

1684 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1688 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1689 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1690 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %Îd",
İtiÚ
,
v®ue
);

1692 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1696 
	`»wr™eCÚfigOù®O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1697 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1698 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %o",
İtiÚ
,
v®ue
);

1700 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1706 
	`»wr™eCÚfigEnumO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
cÚfigEnum
 *
û
, 
defv®
) {

1707 
sds
 
lše
;

1708 cÚ¡ *
Çme
 = 
	`cÚfigEnumG‘NameOrUnknown
(
û
,
v®ue
);

1709 
fÜû
 = 
v®ue
 !ğ
defv®
;

1711 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
Çme
);

1712 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1716 
	`»wr™eCÚfigSy¦ogçc™yO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1717 
v®ue
 = 
£rv”
.
sy¦og_çc™y
;

1718 
fÜû
 = 
v®ue
 !ğ
LOG_LOCAL0
;

1719 cÚ¡ *
Çme
 = 
NULL
, *
İtiÚ
 = "syslog-facility";

1720 
sds
 
lše
;

1722 
Çme
 = 
	`cÚfigEnumG‘NameOrUnknown
(
sy¦og_çc™y_’um
,
v®ue
);

1723 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
Çme
);

1724 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1728 
	`»wr™eCÚfigSaveO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1729 
j
;

1730 
sds
 
lše
;

1735 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1736 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"save %ld %d",

1737 (è
£rv”
.
§v•¬ams
[
j
].
£cÚds
, s”v”.§v•¬ams[j].
chªges
);

1738 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"§ve",
lše
,1);

1741 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"save");

1745 
	`»wr™eCÚfigDœO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1746 
cwd
[1024];

1748 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

1749 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"dir");

1752 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"dœ",
cwd
,
NULL
);

1756 
	`»wr™eCÚfigSÏveofO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1757 *
İtiÚ
 = "slaveof";

1758 
sds
 
lše
;

1763 ià(
£rv”
.
şu¡”_’abËd
 || s”v”.
ma¡”ho¡
 =ğ
NULL
) {

1764 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"slaveof");

1767 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% % %d", 
İtiÚ
,

1768 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

1769 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,1);

1773 
	`»wr™eCÚfigNÙifykey¥aûev’tsO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1774 
fÜû
 = 
£rv”
.
nÙify_key¥aû_ev’ts
 != 0;

1775 *
İtiÚ
 = "notify-keyspace-events";

1776 
sds
 
lše
, 
æags
;

1778 
æags
 = 
	`key¥aûEv’tsFÏgsToSŒšg
(
£rv”
.
nÙify_key¥aû_ev’ts
);

1779 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1780 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1781 
lše
 = 
	`sdsÿŒ•r
Öše, 
æags
, 
	`sd¦’
(flags));

1782 
	`sdsä“
(
æags
);

1783 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1787 
	`»wr™eCÚfigCl›Áouutbufã¾im™O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1788 
j
;

1789 *
İtiÚ
 = "client-output-buffer-limit";

1791 
j
 = 0; j < 
CLIENT_TYPE_OBUF_COUNT
; j++) {

1792 
fÜû
 = (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
 !=

1793 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
h¬d_lim™_by‹s
) ||

1794 (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
 !=

1795 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
soá_lim™_by‹s
) ||

1796 (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
 !=

1797 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
soá_lim™_£cÚds
);

1798 
sds
 
lše
;

1799 
h¬d
[64], 
soá
[64];

1801 
	`»wr™eCÚfigFÜm©MemÜy
(
h¬d
,(hard),

1802 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
);

1803 
	`»wr™eCÚfigFÜm©MemÜy
(
soá
,(soft),

1804 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
);

1806 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%s %s %s %s %ld",

1807 
İtiÚ
, 
	`g‘Cl›ÁTy³Name
(
j
), 
h¬d
, 
soá
,

1808 (è
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
);

1809 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1814 
	`»wr™eCÚfigBšdO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1815 
fÜû
 = 1;

1816 
sds
 
lše
, 
add»s£s
;

1817 *
İtiÚ
 = "bind";

1820 ià(
£rv”
.
bšdaddr_couÁ
 == 0) {

1821 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1826 
add»s£s
 = 
	`sdsjoš
(
£rv”
.
bšdaddr
,£rv”.
bšdaddr_couÁ
," ");

1827 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1828 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1829 
lše
 = 
	`sdsÿtsds
Öše, 
add»s£s
);

1830 
	`sdsä“
(
add»s£s
);

1832 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1837 
sds
 
	`»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1838 
sds
 
cÚ‹Á
 = 
	`sd£m±y
();

1839 
j
, 
was_em±y
 = 0;

1841 
j
 = 0; j < 
¡©e
->
numlšes
; j++) {

1843 ià(
	`sd¦’
(
¡©e
->
lšes
[
j
]) == 0) {

1844 ià(
was_em±y
) ;

1845 
was_em±y
 = 1;

1847 
was_em±y
 = 0;

1849 
cÚ‹Á
 = 
	`sdsÿtsds
(cÚ‹Á,
¡©e
->
lšes
[
j
]);

1850 
cÚ‹Á
 = 
	`sdsÿ’
(content,"\n",1);

1852  
cÚ‹Á
;

1856 
	`»wr™eCÚfigR–—£S‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1857 
	`sdsä“¥l™»s
(
¡©e
->
lšes
,¡©e->
numlšes
);

1858 
	`diùR–—£
(
¡©e
->
İtiÚ_to_lše
);

1859 
	`diùR–—£
(
¡©e
->
»wr™‹n
);

1860 
	`zä“
(
¡©e
);

1871 
	`»wr™eCÚfigRemoveO½hªed
(
»wr™eCÚfigS‹
 *
¡©e
) {

1872 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
¡©e
->
İtiÚ_to_lše
);

1873 
diùEÁry
 *
de
;

1875 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1876 
li¡
 *
l
 = 
	`diùG‘V®
(
de
);

1877 
sds
 
İtiÚ
 = 
	`diùG‘Key
(
de
);

1881 ià(
	`diùFšd
(
¡©e
->
»wr™‹n
,
İtiÚ
è=ğ
NULL
) {

1882 
	`£rv”Log
(
LL_DEBUG
,"NÙ„ewr™‹ÀİtiÚ: %s", 
İtiÚ
);

1886 
	`li¡L’gth
(
l
)) {

1887 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

1888 
lš’um
 = (è
Ê
->
v®ue
;

1890 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1891 
¡©e
->
lšes
[
lš’um
] = 
	`sd£m±y
();

1892 
	`li¡D–Node
(
l
,
Ê
);

1895 
	`diùR–—£I‹¿tÜ
(
di
);

1910 
	`»wr™eCÚfigOv”wr™eFe
(*
cÚfigfe
, 
sds
 
cÚ‹Á
) {

1911 
»tv®
 = 0;

1912 
fd
 = 
	`İ’
(
cÚfigfe
,
O_RDWR
|
O_CREAT
,0644);

1913 
cÚ‹Á_size
 = 
	`sd¦’
(
cÚ‹Á
), 
·ddšg
 = 0;

1914 
¡©
 
sb
;

1915 
sds
 
cÚ‹Á_·dded
;

1919 ià(
fd
 == -1)  -1;

1920 ià(
	`f¡©
(
fd
,&
sb
) == -1) {

1921 
	`şo£
(
fd
);

1926 
cÚ‹Á_·dded
 = 
	`sdsdup
(
cÚ‹Á
);

1927 ià(
cÚ‹Á_size
 < 
sb
.
¡_size
) {

1930 
·ddšg
 = 
sb
.
¡_size
 - 
cÚ‹Á_size
;

1931 
cÚ‹Á_·dded
 = 
	`sdsgrowz”o
(cÚ‹Á_·dded,
sb
.
¡_size
);

1932 
cÚ‹Á_·dded
[
cÚ‹Á_size
] = '\n';

1933 
	`mem£t
(
cÚ‹Á_·dded
+
cÚ‹Á_size
+1,'#',
·ddšg
-1);

1937 ià(
	`wr™e
(
fd
,
cÚ‹Á_·dded
,
	`¡¾’
(content_padded)) == -1) {

1938 
»tv®
 = -1;

1939 
ş—nup
;

1943 ià(
·ddšg
) {

1944 ià(
	`árunÿ‹
(
fd
,
cÚ‹Á_size
) == -1) {

1949 
ş—nup
:

1950 
	`sdsä“
(
cÚ‹Á_·dded
);

1951 
	`şo£
(
fd
);

1952  
»tv®
;

1963 
	`»wr™eCÚfig
(*
·th
) {

1964 
»wr™eCÚfigS‹
 *
¡©e
;

1965 
sds
 
ÃwcÚ‹Á
;

1966 
»tv®
;

1969 ià((
¡©e
 = 
	`»wr™eCÚfigR—dOldFe
(
·th
)è=ğ
NULL
)  -1;

1974 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"d«mÚize",
£rv”
.
d«mÚize
,0);

1975 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"pidfe",
£rv”
.
pidfe
,
CONFIG_DEFAULT_PID_FILE
);

1976 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"pÜt",
£rv”
.
pÜt
,
CONFIG_DEFAULT_SERVER_PORT
);

1977 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-ªnounû-pÜt",
£rv”
.
şu¡”_ªnounû_pÜt
,
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT
);

1978 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-ªnounû-bus-pÜt",
£rv”
.
şu¡”_ªnounû_bus_pÜt
,
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT
);

1979 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"tı-backlog",
£rv”
.
tı_backlog
,
CONFIG_DEFAULT_TCP_BACKLOG
);

1980 
	`»wr™eCÚfigBšdO±iÚ
(
¡©e
);

1981 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"unixsock‘",
£rv”
.
unixsock‘
,
NULL
);

1982 
	`»wr™eCÚfigOù®O±iÚ
(
¡©e
,"unixsock‘³rm",
£rv”
.
unixsock‘³rm
,
CONFIG_DEFAULT_UNIX_SOCKET_PERM
);

1983 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"timeout",
£rv”
.
maxidËtime
,
CONFIG_DEFAULT_CLIENT_TIMEOUT
);

1984 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"tı-k“·live",
£rv”
.
tık“·live
,
CONFIG_DEFAULT_TCP_KEEPALIVE
);

1985 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦ave-ªnounû-pÜt",
£rv”
.
¦ave_ªnounû_pÜt
,
CONFIG_DEFAULT_SLAVE_ANNOUNCE_PORT
);

1986 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"logËv–",
£rv”
.
v”bos™y
,
logËv–_’um
,
CONFIG_DEFAULT_VERBOSITY
);

1987 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"logfe",
£rv”
.
logfe
,
CONFIG_DEFAULT_LOGFILE
);

1988 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"sy¦og-’abËd",
£rv”
.
sy¦og_’abËd
,
CONFIG_DEFAULT_SYSLOG_ENABLED
);

1989 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"sy¦og-id’t",
£rv”
.
sy¦og_id’t
,
CONFIG_DEFAULT_SYSLOG_IDENT
);

1990 
	`»wr™eCÚfigSy¦ogçc™yO±iÚ
(
¡©e
);

1991 
	`»wr™eCÚfigSaveO±iÚ
(
¡©e
);

1992 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"d©aba£s",
£rv”
.
dbnum
,
CONFIG_DEFAULT_DBNUM
);

1993 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¡İ-wr™es-Ú-bg§ve-”rÜ",
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
,
CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
);

1994 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"rdbcom´essiÚ",
£rv”
.
rdb_com´essiÚ
,
CONFIG_DEFAULT_RDB_COMPRESSION
);

1995 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"rdbchecksum",
£rv”
.
rdb_checksum
,
CONFIG_DEFAULT_RDB_CHECKSUM
);

1996 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"dbf’ame",
£rv”
.
rdb_f’ame
,
CONFIG_DEFAULT_RDB_FILENAME
);

1997 
	`»wr™eCÚfigDœO±iÚ
(
¡©e
);

1998 
	`»wr™eCÚfigSÏveofO±iÚ
(
¡©e
);

1999 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"¦ave-ªnounû-",
£rv”
.
¦ave_ªnounû_
,
CONFIG_DEFAULT_SLAVE_ANNOUNCE_IP
);

2000 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"ma¡”auth",
£rv”
.
ma¡”auth
,
NULL
);

2001 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"şu¡”-ªnounû-",
£rv”
.
şu¡”_ªnounû_
,
NULL
);

2002 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¦ave-£rve-¡®e-d©a",
£rv”
.
»¶_£rve_¡®e_d©a
,
CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA
);

2003 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¦ave-»ad-Úly",
£rv”
.
»¶_¦ave_ro
,
CONFIG_DEFAULT_SLAVE_READ_ONLY
);

2004 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-pšg-¦ave-³riod",
£rv”
.
»¶_pšg_¦ave_³riod
,
CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD
);

2005 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-timeout",
£rv”
.
»¶_timeout
,
CONFIG_DEFAULT_REPL_TIMEOUT
);

2006 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"»¶-backlog-size",
£rv”
.
»¶_backlog_size
,
CONFIG_DEFAULT_REPL_BACKLOG_SIZE
);

2007 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"»¶-backlog-‰l",
£rv”
.
»¶_backlog_time_lim™
,
CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
);

2008 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"»¶-di§bË-tı-nod–ay",
£rv”
.
»¶_di§bË_tı_nod–ay
,
CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY
);

2009 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"»¶-diskËss-sync",
£rv”
.
»¶_diskËss_sync
,
CONFIG_DEFAULT_REPL_DISKLESS_SYNC
);

2010 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-diskËss-sync-d–ay",
£rv”
.
»¶_diskËss_sync_d–ay
,
CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY
);

2011 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦ave-´iÜ™y",
£rv”
.
¦ave_´iÜ™y
,
CONFIG_DEFAULT_SLAVE_PRIORITY
);

2012 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"mš-¦aves-to-wr™e",
£rv”
.
»¶_mš_¦aves_to_wr™e
,
CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE
);

2013 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"mš-¦aves-max-Ïg",
£rv”
.
»¶_mš_¦aves_max_Ïg
,
CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG
);

2014 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"»quœ•ass",
£rv”
.
»quœ•ass
,
NULL
);

2015 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"maxş›Ás",
£rv”
.
maxş›Ás
,
CONFIG_DEFAULT_MAX_CLIENTS
);

2016 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"maxmemÜy",
£rv”
.
maxmemÜy
,
CONFIG_DEFAULT_MAXMEMORY
);

2017 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"´Ùo-max-bulk-Ën",
£rv”
.
´Ùo_max_bulk_Ën
,
CONFIG_DEFAULT_PROTO_MAX_BULK_LEN
);

2018 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"ş›Á-qu”y-bufãr-lim™",
£rv”
.
ş›Á_max_qu”ybuf_Ën
,
PROTO_MAX_QUERYBUF_LEN
);

2019 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"maxmemÜy-pŞicy",
£rv”
.
maxmemÜy_pŞicy
,
maxmemÜy_pŞicy_’um
,
CONFIG_DEFAULT_MAXMEMORY_POLICY
);

2020 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"maxmemÜy-§m¶es",
£rv”
.
maxmemÜy_§m¶es
,
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
);

2021 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"lfu-log-çùÜ",
£rv”
.
lfu_log_çùÜ
,
CONFIG_DEFAULT_LFU_LOG_FACTOR
);

2022 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"lfu-deÿy-time",
£rv”
.
lfu_deÿy_time
,
CONFIG_DEFAULT_LFU_DECAY_TIME
);

2023 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"aùive-deäag-th»shŞd-low”",
£rv”
.
aùive_deäag_th»shŞd_low”
,
CONFIG_DEFAULT_DEFRAG_THRESHOLD_LOWER
);

2024 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"aùive-deäag-th»shŞd-uµ”",
£rv”
.
aùive_deäag_th»shŞd_uµ”
,
CONFIG_DEFAULT_DEFRAG_THRESHOLD_UPPER
);

2025 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"aùive-deäag-ignÜe-by‹s",
£rv”
.
aùive_deäag_ignÜe_by‹s
,
CONFIG_DEFAULT_DEFRAG_IGNORE_BYTES
);

2026 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"aùive-deäag-cyşe-mš",
£rv”
.
aùive_deäag_cyşe_mš
,
CONFIG_DEFAULT_DEFRAG_CYCLE_MIN
);

2027 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"aùive-deäag-cyşe-max",
£rv”
.
aùive_deäag_cyşe_max
,
CONFIG_DEFAULT_DEFRAG_CYCLE_MAX
);

2028 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"­³ndÚly",
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
,0);

2029 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"­³ndf’ame",
£rv”
.
aof_f’ame
,
CONFIG_DEFAULT_AOF_FILENAME
);

2030 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"­³ndfsync",
£rv”
.
aof_fsync
,
aof_fsync_’um
,
CONFIG_DEFAULT_AOF_FSYNC
);

2031 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"no-­³ndfsync-Ú-»wr™e",
£rv”
.
aof_no_fsync_Ú_»wr™e
,
CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
);

2032 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"auto-aof-»wr™e-³rûÁage",
£rv”
.
aof_»wr™e_³rc
,
AOF_REWRITE_PERC
);

2033 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"auto-aof-»wr™e-mš-size",
£rv”
.
aof_»wr™e_mš_size
,
AOF_REWRITE_MIN_SIZE
);

2034 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"lua-time-lim™",
£rv”
.
lua_time_lim™
,
LUA_SCRIPT_TIME_LIMIT
);

2035 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"şu¡”-’abËd",
£rv”
.
şu¡”_’abËd
,0);

2036 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"şu¡”-cÚfig-fe",
£rv”
.
şu¡”_cÚfigfe
,
CONFIG_DEFAULT_CLUSTER_CONFIG_FILE
);

2037 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"şu¡”-»quœe-fuÎ-cov”age",
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
,
CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
);

2038 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"şu¡”-¦ave-no-çov”",
£rv”
.
şu¡”_¦ave_no_çov”
,
CLUSTER_DEFAULT_SLAVE_NO_FAILOVER
);

2039 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-node-timeout",
£rv”
.
şu¡”_node_timeout
,
CLUSTER_DEFAULT_NODE_TIMEOUT
);

2040 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-mig¿tiÚ-b¬r›r",
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
,
CLUSTER_DEFAULT_MIGRATION_BARRIER
);

2041 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-¦ave-v®id™y-çùÜ",
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
,
CLUSTER_DEFAULT_SLAVE_VALIDITY
);

2042 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦owlog-log-¦ow”-thª",
£rv”
.
¦owlog_log_¦ow”_thª
,
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
);

2043 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"Ï‹ncy-mÚ™Ü-th»shŞd",
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
,
CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD
);

2044 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦owlog-max-Ën",
£rv”
.
¦owlog_max_Ën
,
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
);

2045 
	`»wr™eCÚfigNÙifykey¥aûev’tsO±iÚ
(
¡©e
);

2046 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hash-max-zli¡-’Œ›s",
£rv”
.
hash_max_zli¡_’Œ›s
,
OBJ_HASH_MAX_ZIPLIST_ENTRIES
);

2047 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hash-max-zli¡-v®ue",
£rv”
.
hash_max_zli¡_v®ue
,
OBJ_HASH_MAX_ZIPLIST_VALUE
);

2048 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"li¡-max-zli¡-size",
£rv”
.
li¡_max_zli¡_size
,
OBJ_LIST_MAX_ZIPLIST_SIZE
);

2049 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"li¡-com´ess-d•th",
£rv”
.
li¡_com´ess_d•th
,
OBJ_LIST_COMPRESS_DEPTH
);

2050 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"£t-max-št£t-’Œ›s",
£rv”
.
£t_max_št£t_’Œ›s
,
OBJ_SET_MAX_INTSET_ENTRIES
);

2051 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"z£t-max-zli¡-’Œ›s",
£rv”
.
z£t_max_zli¡_’Œ›s
,
OBJ_ZSET_MAX_ZIPLIST_ENTRIES
);

2052 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"z£t-max-zli¡-v®ue",
£rv”
.
z£t_max_zli¡_v®ue
,
OBJ_ZSET_MAX_ZIPLIST_VALUE
);

2053 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hÎ-¥¬£-max-by‹s",
£rv”
.
hÎ_¥¬£_max_by‹s
,
CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
);

2054 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aùiv”ehashšg",
£rv”
.
aùiv”ehashšg
,
CONFIG_DEFAULT_ACTIVE_REHASHING
);

2055 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aùivedeäag",
£rv”
.
aùive_deäag_’abËd
,
CONFIG_DEFAULT_ACTIVE_DEFRAG
);

2056 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"´Ùeùed-mode",
£rv”
.
´Ùeùed_mode
,
CONFIG_DEFAULT_PROTECTED_MODE
);

2057 
	`»wr™eCÚfigCl›Áouutbufã¾im™O±iÚ
(
¡©e
);

2058 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hz",
£rv”
.
hz
,
CONFIG_DEFAULT_HZ
);

2059 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aof-»wr™e-šüem’l-fsync",
£rv”
.
aof_»wr™e_šüem’l_fsync
,
CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
);

2060 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aof-lßd-Œunÿ‹d",
£rv”
.
aof_lßd_Œunÿ‹d
,
CONFIG_DEFAULT_AOF_LOAD_TRUNCATED
);

2061 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aof-u£-rdb-´—mbË",
£rv”
.
aof_u£_rdb_´—mbË
,
CONFIG_DEFAULT_AOF_USE_RDB_PREAMBLE
);

2062 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"su³rvi£d",
£rv”
.
su³rvi£d_mode
,
su³rvi£d_mode_’um
,
SUPERVISED_NONE
);

2063 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"Ïzyä“-Ïzy-eviùiÚ",
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
,
CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION
);

2064 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"Ïzyä“-Ïzy-expœe",
£rv”
.
Ïzyä“_Ïzy_expœe
,
CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE
);

2065 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"Ïzyä“-Ïzy-£rv”-d–",
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
,
CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL
);

2066 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¦ave-Ïzy-æush",
£rv”
.
»¶_¦ave_Ïzy_æush
,
CONFIG_DEFAULT_SLAVE_LAZY_FLUSH
);

2069 ià(
£rv”
.
£Áš–_mode
è
	`»wr™eCÚfigS’tš–O±iÚ
(
¡©e
);

2074 
	`»wr™eCÚfigRemoveO½hªed
(
¡©e
);

2078 
ÃwcÚ‹Á
 = 
	`»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
¡©e
);

2079 
»tv®
 = 
	`»wr™eCÚfigOv”wr™eFe
(
£rv”
.
cÚfigfe
,
ÃwcÚ‹Á
);

2081 
	`sdsä“
(
ÃwcÚ‹Á
);

2082 
	`»wr™eCÚfigR–—£S‹
(
¡©e
);

2083  
»tv®
;

2090 
	`cÚfigCommªd
(
ş›Á
 *
c
) {

2092 ià(
£rv”
.
lßdšg
 && 
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

2093 
	`addR•lyE¼Ü
(
c
,"Only CONFIG GET is‡llowed during†oading");

2097 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set")) {

2098 ià(
c
->
¬gc
 !ğ4è
bad¬™y
;

2099 
	`cÚfigS‘Commªd
(
c
);

2100 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

2101 ià(
c
->
¬gc
 !ğ3è
bad¬™y
;

2102 
	`cÚfigG‘Commªd
(
c
);

2103 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"resetstat")) {

2104 ià(
c
->
¬gc
 !ğ2è
bad¬™y
;

2105 
	`»£tS”v”Sts
();

2106 
	`»£tCommªdTabËSts
();

2107 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2108 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"rewrite")) {

2109 ià(
c
->
¬gc
 !ğ2è
bad¬™y
;

2110 ià(
£rv”
.
cÚfigfe
 =ğ
NULL
) {

2111 
	`addR•lyE¼Ü
(
c
,"The server is„unning without‡ config file");

2114 ià(
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
) == -1) {

2115 
	`£rv”Log
(
LL_WARNING
,"CONFIG REWRITE faed: %s", 
	`¡»¼Ü
(
”ºo
));

2116 
	`addR•lyE¼ÜFÜm©
(
c
,"Rewr™šg cÚfig fe: %s", 
	`¡»¼Ü
(
”ºo
));

2118 
	`£rv”Log
(
LL_WARNING
,"CONFIG REWRITEƒxecuted with success.");

2119 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2122 
	`addR•lyE¼Ü
(
c
,

2127 
bad¬™y
:

2128 
	`addR•lyE¼ÜFÜm©
(
c
,"Wrong‚umber of‡rguments for CONFIG %s",

2129 (*è
c
->
¬gv
[1]->
±r
);

	@src/config.h

30 #iâdeà
__CONFIG_H


31 
	#__CONFIG_H


	)

33 #ifdeà
__APPLE__


34 
	~<Avaab™yMaüos.h
>

37 #ifdeà
__lšux__


38 
	~<lšux/v”siÚ.h
>

39 
	~<ã©u»s.h
>

43 #ià
defšed
(
__APPLE__
è&& !defšed(
MAC_OS_X_VERSION_10_6
)

44 
	#»dis_f¡©
 
f¡©64


	)

45 
	#»dis_¡©
 
¡©64


	)

47 
	#»dis_f¡©
 
f¡©


	)

48 
	#»dis_¡©
 
¡©


	)

52 #ifdeà
__lšux__


53 
	#HAVE_PROC_STAT
 1

	)

54 
	#HAVE_PROC_MAPS
 1

	)

55 
	#HAVE_PROC_SMAPS
 1

	)

56 
	#HAVE_PROC_SOMAXCONN
 1

	)

60 #ià
defšed
(
__APPLE__
)

61 
	#HAVE_TASKINFO
 1

	)

65 #ià
defšed
(
__APPLE__
è|| (defšed(
__lšux__
è&& defšed(
__GLIBC__
))

66 
	#HAVE_BACKTRACE
 1

	)

70 #ifdeà
__lšux__


71 
	#HAVE_MSG_NOSIGNAL
 1

	)

75 #ifdeà
__lšux__


76 
	#HAVE_EPOLL
 1

	)

79 #ià(
defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)è|| defšed(
__F»eBSD__
è|| defšed(
__O³nBSD__
è|| defšed (
__N‘BSD__
)

80 
	#HAVE_KQUEUE
 1

	)

83 #ifdeà
__sun


84 
	~<sys/ã©u»_‹¡s.h
>

85 #ifdeà
_DTRACE_VERSION


86 
	#HAVE_EVPORT
 1

	)

91 #ifdeà
__lšux__


94 
	#aof_fsync
 
fsync


	)

99 #ifdeà
__lšux__


100 #ià
defšed
(
__GLIBC__
è&& defšed(
__GLIBC_PREREQ
)

101 #ià(
LINUX_VERSION_CODE
 >ğ0x020611 && 
__GLIBC_PREREQ
(2, 6))

102 
	#HAVE_SYNC_FILE_RANGE
 1

	)

105 #ià(
LINUX_VERSION_CODE
 >= 0x020611)

106 
	#HAVE_SYNC_FILE_RANGE
 1

	)

111 #ifdeà
HAVE_SYNC_FILE_RANGE


112 
	#rdb_fsync_¿nge
(
fd
,
off
,
size
è
	`sync_fe_¿nge
(fd,off,size,
SYNC_FILE_RANGE_WAIT_BEFORE
|
SYNC_FILE_RANGE_WRITE
)

	)

114 
	#rdb_fsync_¿nge
(
fd
,
off
,
size
è
	`fsync
(fd)

	)

120 #ià(
defšed
 
__N‘BSD__
 || defšed 
__F»eBSD__
 || defšed 
__O³nBSD__
)

121 
	#USE_SETPROCTITLE


	)

124 #ià((
defšed
 
__lšux
 && defšed(
__GLIBC__
)è|| defšed 
__APPLE__
)

125 
	#USE_SETPROCTITLE


	)

126 
	#INIT_SETPROCTITLE_REPLACEMENT


	)

127 
¥t_š™
(
¬gc
, *
¬gv
[]);

128 
£roù™Ë
(cÚ¡ *
fmt
, ...);

132 
	~<sys/ty³s.h
>

134 #iâdeà
BYTE_ORDER


135 #ià(
BSD
 >= 199103)

136 
	~<machše/’dŸn.h
>

138 #ià
defšed
(
lšux
è|| defšed(
__lšux__
)

139 
	~<’dŸn.h
>

141 
	#LITTLE_ENDIAN
 1234

	)

142 
	#BIG_ENDIAN
 4321

	)

143 
	#PDP_ENDIAN
 3412

	)

145 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
è|| defšed(
__amd64__
) || \

146 
defšed
(
vax
è|| defšed(
ns32000
è|| defšed(
sun386
) || \

147 
defšed
(
MIPSEL
è|| defšed(
_MIPSEL
è|| defšed(
BIT_ZERO_ON_RIGHT
) || \

148 
defšed
(
__®pha__
è|| 
	$defšed
(
__®pha
)

149 
	#BYTE_ORDER
 
LITTLE_ENDIAN


	)

152 #ià
	`defšed
(
£l
è|| defšed(
pyr
è|| defšed(
mc68000
è|| defšed(
¥¬c
) || \

153 
	`defšed
(
is68k
è|| defšed(
hÛ
è|| defšed(
ibm032
è|| defšed(
ibm370
) || \

154 
	`defšed
(
MIPSEB
è|| defšed(
_MIPSEB
è|| defšed(
_IBMR2
è|| defšed(
DGUX
) ||\

155 
	`defšed
(
­Şlo
è|| defšed(
__cÚvex__
è|| defšed(
_CRAY
) || \

156 
	`defšed
(
__hµa
è|| defšed(
__hp9000
) || \

157 
	`defšed
(
__hp9000s300
è|| defšed(
__hp9000s700
) || \

158 
	`defšed
 (
BIT_ZERO_ON_LEFT
è|| defšed(
m68k
è|| 
	$defšed
(
__¥¬c
)

159 
	#BYTE_ORDER
 
BIG_ENDIAN


	)

169 #iâdeà
BYTE_ORDER


170 #ifdeà
__BYTE_ORDER


171 #ià
	`defšed
(
__LITTLE_ENDIAN
è&& defšed(
__BIG_ENDIAN
)

172 #iâdeà
LITTLE_ENDIAN


173 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

175 #iâdeà
BIG_ENDIAN


176 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

178 #ià(
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN
)

179 
	#BYTE_ORDER
 
LITTLE_ENDIAN


	)

181 
	#BYTE_ORDER
 
BIG_ENDIAN


	)

187 #ià!
	`defšed
(
BYTE_ORDER
) || \

188 (
BYTE_ORDER
 !ğ
BIG_ENDIAN
 && BYTE_ORDER !ğ
LITTLE_ENDIAN
)

197 #ià(
__i386
 || 
__amd64
 || 
__pow”pc__
è&& 
__GNUC__


198 
	#GNUC_VERSION
 (
__GNUC__
 * 10000 + 
__GNUC_MINOR__
 * 100 + 
__GNUC_PATCHLEVEL__
)

	)

199 #ià
	`defšed
(
__şªg__
)

200 
	#HAVE_ATOMIC


	)

202 #ià(
	`defšed
(
__GLIBC__
è&& defšed(
__GLIBC_PREREQ
))

203 #ià(
GNUC_VERSION
 >ğ40100 && 
	`__GLIBC_PREREQ
(2, 6))

204 
	#HAVE_ATOMIC


	)

211 #ià
	`defšed
(
__¬m
è&& !defšed(
__¬m__
)

212 
	#__¬m__


	)

214 #ià
	`defšed
 (
__¯rch64__
è&& !defšed(
__¬m64__
)

215 
	#__¬m64__


	)

219 #ià
	`defšed
(
__¥¬c
è&& !defšed(
__¥¬c__
)

220 
	#__¥¬c__


	)

223 #ià
	`defšed
(
__¥¬c__
è|| defšed(
__¬m__
)

224 
	#USE_ALIGNED_ACCESS


	)

	@src/crc16.c

1 
	~"£rv”.h
"

47 cÚ¡ 
ušt16_t
 
	güc16b
[256]= {

82 
ušt16_t
 
	$üc16
(cÚ¡ *
buf
, 
Ën
) {

83 
couÁ”
;

84 
ušt16_t
 
üc
 = 0;

85 
couÁ”
 = 0; couÁ” < 
Ën
; counter++)

86 
üc
 = (üc<<8è^ 
üc16b
[((üc>>8è^ *
buf
++)&0x00FF];

87  
üc
;

88 
	}
}

	@src/crc64.c

40 
	~<¡dšt.h
>

42 cÚ¡ 
ušt64_t
 
	güc64_b
[256] = {

43 
UINT64_C
(0x0000000000000000), UINT64_C(0x7ad870c830358979),

44 
UINT64_C
(0xf5b0e190606b12f2), UINT64_C(0x8f689158505e9b8b),

45 
UINT64_C
(0xc038e5739841b68f), UINT64_C(0xbae095bba8743ff6),

46 
UINT64_C
(0x358804e3f82aa47d), UINT64_C(0x4f50742bc81f2d04),

47 
UINT64_C
(0xab28ecb46814fe75), UINT64_C(0xd1f09c7c5821770c),

48 
UINT64_C
(0x5e980d24087fec87), UINT64_C(0x24407dec384a65fe),

49 
UINT64_C
(0x6b1009c7f05548fa), UINT64_C(0x11c8790fc060c183),

50 
UINT64_C
(0x9ea0e857903e5a08), UINT64_C(0xe478989fa00bd371),

51 
UINT64_C
(0x7d08ff3b88be6f81), UINT64_C(0x07d08ff3b88be6f8),

52 
UINT64_C
(0x88b81eabe8d57d73), UINT64_C(0xf2606e63d8e0f40a),

53 
UINT64_C
(0xbd301a4810ffd90e), UINT64_C(0xc7e86a8020ca5077),

54 
UINT64_C
(0x4880fbd87094cbfc), UINT64_C(0x32588b1040a14285),

55 
UINT64_C
(0xd620138fe0aa91f4), UINT64_C(0xacf86347d09f188d),

56 
UINT64_C
(0x2390f21f80c18306), UINT64_C(0x594882d7b0f40a7f),

57 
UINT64_C
(0x1618f6fc78eb277b), UINT64_C(0x6cc0863448deae02),

58 
UINT64_C
(0xe3a8176c18803589), UINT64_C(0x997067a428b5bcf0),

59 
UINT64_C
(0xfa11fe77117cdf02), UINT64_C(0x80c98ebf2149567b),

60 
UINT64_C
(0x0fa11fe77117cdf0), UINT64_C(0x75796f2f41224489),

61 
UINT64_C
(0x3a291b04893d698d), UINT64_C(0x40f16bccb908e0f4),

62 
UINT64_C
(0xcf99fa94e9567b7f), UINT64_C(0xb5418a5cd963f206),

63 
UINT64_C
(0x513912c379682177), UINT64_C(0x2be1620b495da80e),

64 
UINT64_C
(0xa489f35319033385), UINT64_C(0xde51839b2936bafc),

65 
UINT64_C
(0x9101f7b0e12997f8), UINT64_C(0xebd98778d11c1e81),

66 
UINT64_C
(0x64b116208142850a), UINT64_C(0x1e6966e8b1770c73),

67 
UINT64_C
(0x8719014c99c2b083), UINT64_C(0xfdc17184a9f739fa),

68 
UINT64_C
(0x72a9e0dcf9a9a271), UINT64_C(0x08719014c99c2b08),

69 
UINT64_C
(0x4721e43f0183060c), UINT64_C(0x3df994f731b68f75),

70 
UINT64_C
(0xb29105af61e814fe), UINT64_C(0xc849756751dd9d87),

71 
UINT64_C
(0x2c31edf8f1d64ef6), UINT64_C(0x56e99d30c1e3c78f),

72 
UINT64_C
(0xd9810c6891bd5c04), UINT64_C(0xa3597ca0a188d57d),

73 
UINT64_C
(0xec09088b6997f879), UINT64_C(0x96d1784359a27100),

74 
UINT64_C
(0x19b9e91b09fcea8b), UINT64_C(0x636199d339c963f2),

75 
UINT64_C
(0xdf7adabd7a6e2d6f), UINT64_C(0xa5a2aa754a5ba416),

76 
UINT64_C
(0x2aca3b2d1a053f9d), UINT64_C(0x50124be52a30b6e4),

77 
UINT64_C
(0x1f423fcee22f9be0), UINT64_C(0x659a4f06d21a1299),

78 
UINT64_C
(0xeaf2de5e82448912), UINT64_C(0x902aae96b271006b),

79 
UINT64_C
(0x74523609127ad31a), UINT64_C(0x0e8a46c1224f5a63),

80 
UINT64_C
(0x81e2d7997211c1e8), UINT64_C(0xfb3aa75142244891),

81 
UINT64_C
(0xb46ad37a8a3b6595), UINT64_C(0xceb2a3b2ba0eecec),

82 
UINT64_C
(0x41da32eaea507767), UINT64_C(0x3b024222da65fe1e),

83 
UINT64_C
(0xa2722586f2d042ee), UINT64_C(0xd8aa554ec2e5cb97),

84 
UINT64_C
(0x57c2c41692bb501c), UINT64_C(0x2d1ab4dea28ed965),

85 
UINT64_C
(0x624ac0f56a91f461), UINT64_C(0x1892b03d5aa47d18),

86 
UINT64_C
(0x97fa21650afae693), UINT64_C(0xed2251ad3acf6fea),

87 
UINT64_C
(0x095ac9329ac4bc9b), UINT64_C(0x7382b9faaaf135e2),

88 
UINT64_C
(0xfcea28a2faafae69), UINT64_C(0x8632586aca9a2710),

89 
UINT64_C
(0xc9622c4102850a14), UINT64_C(0xb3ba5c8932b0836d),

90 
UINT64_C
(0x3cd2cdd162ee18e6), UINT64_C(0x460abd1952db919f),

91 
UINT64_C
(0x256b24ca6b12f26d), UINT64_C(0x5fb354025b277b14),

92 
UINT64_C
(0xd0dbc55a0b79e09f), UINT64_C(0xaa03b5923b4c69e6),

93 
UINT64_C
(0xe553c1b9f35344e2), UINT64_C(0x9f8bb171c366cd9b),

94 
UINT64_C
(0x10e3202993385610), UINT64_C(0x6a3b50e1a30ddf69),

95 
UINT64_C
(0x8e43c87e03060c18), UINT64_C(0xf49bb8b633338561),

96 
UINT64_C
(0x7bf329ee636d1eea), UINT64_C(0x012b592653589793),

97 
UINT64_C
(0x4e7b2d0d9b47ba97), UINT64_C(0x34a35dc5ab7233ee),

98 
UINT64_C
(0xbbcbcc9dfb2ca865), UINT64_C(0xc113bc55cb19211c),

99 
UINT64_C
(0x5863dbf1e3ac9dec), UINT64_C(0x22bbab39d3991495),

100 
UINT64_C
(0xadd33a6183c78f1e), UINT64_C(0xd70b4aa9b3f20667),

101 
UINT64_C
(0x985b3e827bed2b63), UINT64_C(0xe2834e4a4bd8a21a),

102 
UINT64_C
(0x6debdf121b863991), UINT64_C(0x1733afda2bb3b0e8),

103 
UINT64_C
(0xf34b37458bb86399), UINT64_C(0x8993478dbb8deae0),

104 
UINT64_C
(0x06fbd6d5ebd3716b), UINT64_C(0x7c23a61ddbe6f812),

105 
UINT64_C
(0x3373d23613f9d516), UINT64_C(0x49aba2fe23cc5c6f),

106 
UINT64_C
(0xc6c333a67392c7e4), UINT64_C(0xbc1b436e43a74e9d),

107 
UINT64_C
(0x95ac9329ac4bc9b5), UINT64_C(0xef74e3e19c7e40cc),

108 
UINT64_C
(0x601c72b9cc20db47), UINT64_C(0x1ac40271fc15523e),

109 
UINT64_C
(0x5594765a340a7f3a), UINT64_C(0x2f4c0692043ff643),

110 
UINT64_C
(0xa02497ca54616dc8), UINT64_C(0xdafce7026454e4b1),

111 
UINT64_C
(0x3e847f9dc45f37c0), UINT64_C(0x445c0f55f46abeb9),

112 
UINT64_C
(0xcb349e0da4342532), UINT64_C(0xb1eceec59401ac4b),

113 
UINT64_C
(0xfebc9aee5c1e814f), UINT64_C(0x8464ea266c2b0836),

114 
UINT64_C
(0x0b0c7b7e3c7593bd), UINT64_C(0x71d40bb60c401ac4),

115 
UINT64_C
(0xe8a46c1224f5a634), UINT64_C(0x927c1cda14c02f4d),

116 
UINT64_C
(0x1d148d82449eb4c6), UINT64_C(0x67ccfd4a74ab3dbf),

117 
UINT64_C
(0x289c8961bcb410bb), UINT64_C(0x5244f9a98c8199c2),

118 
UINT64_C
(0xdd2c68f1dcdf0249), UINT64_C(0xa7f41839ecea8b30),

119 
UINT64_C
(0x438c80a64ce15841), UINT64_C(0x3954f06e7cd4d138),

120 
UINT64_C
(0xb63c61362c8a4ab3), UINT64_C(0xcce411fe1cbfc3ca),

121 
UINT64_C
(0x83b465d5d4a0eece), UINT64_C(0xf96c151de49567b7),

122 
UINT64_C
(0x76048445b4cbfc3c), UINT64_C(0x0cdcf48d84fe7545),

123 
UINT64_C
(0x6fbd6d5ebd3716b7), UINT64_C(0x15651d968d029fce),

124 
UINT64_C
(0x9a0d8ccedd5c0445), UINT64_C(0xe0d5fc06ed698d3c),

125 
UINT64_C
(0xaf85882d2576a038), UINT64_C(0xd55df8e515432941),

126 
UINT64_C
(0x5a3569bd451db2ca), UINT64_C(0x20ed197575283bb3),

127 
UINT64_C
(0xc49581ead523e8c2), UINT64_C(0xbe4df122e51661bb),

128 
UINT64_C
(0x3125607ab548fa30), UINT64_C(0x4bfd10b2857d7349),

129 
UINT64_C
(0x04ad64994d625e4d), UINT64_C(0x7e7514517d57d734),

130 
UINT64_C
(0xf11d85092d094cbf), UINT64_C(0x8bc5f5c11d3cc5c6),

131 
UINT64_C
(0x12b5926535897936), UINT64_C(0x686de2ad05bcf04f),

132 
UINT64_C
(0xe70573f555e26bc4), UINT64_C(0x9ddd033d65d7e2bd),

133 
UINT64_C
(0xd28d7716adc8cfb9), UINT64_C(0xa85507de9dfd46c0),

134 
UINT64_C
(0x273d9686cda3dd4b), UINT64_C(0x5de5e64efd965432),

135 
UINT64_C
(0xb99d7ed15d9d8743), UINT64_C(0xc3450e196da80e3a),

136 
UINT64_C
(0x4c2d9f413df695b1), UINT64_C(0x36f5ef890dc31cc8),

137 
UINT64_C
(0x79a59ba2c5dc31cc), UINT64_C(0x037deb6af5e9b8b5),

138 
UINT64_C
(0x8c157a32a5b7233e), UINT64_C(0xf6cd0afa9582aa47),

139 
UINT64_C
(0x4ad64994d625e4da), UINT64_C(0x300e395ce6106da3),

140 
UINT64_C
(0xbf66a804b64ef628), UINT64_C(0xc5bed8cc867b7f51),

141 
UINT64_C
(0x8aeeace74e645255), UINT64_C(0xf036dc2f7e51db2c),

142 
UINT64_C
(0x7f5e4d772e0f40a7), UINT64_C(0x05863dbf1e3ac9de),

143 
UINT64_C
(0xe1fea520be311aaf), UINT64_C(0x9b26d5e88e0493d6),

144 
UINT64_C
(0x144e44b0de5a085d), UINT64_C(0x6e963478ee6f8124),

145 
UINT64_C
(0x21c640532670ac20), UINT64_C(0x5b1e309b16452559),

146 
UINT64_C
(0xd476a1c3461bbed2), UINT64_C(0xaeaed10b762e37ab),

147 
UINT64_C
(0x37deb6af5e9b8b5b), UINT64_C(0x4d06c6676eae0222),

148 
UINT64_C
(0xc26e573f3ef099a9), UINT64_C(0xb8b627f70ec510d0),

149 
UINT64_C
(0xf7e653dcc6da3dd4), UINT64_C(0x8d3e2314f6efb4ad),

150 
UINT64_C
(0x0256b24ca6b12f26), UINT64_C(0x788ec2849684a65f),

151 
UINT64_C
(0x9cf65a1b368f752e), UINT64_C(0xe62e2ad306bafc57),

152 
UINT64_C
(0x6946bb8b56e467dc), UINT64_C(0x139ecb4366d1eea5),

153 
UINT64_C
(0x5ccebf68aecec3a1), UINT64_C(0x2616cfa09efb4ad8),

154 
UINT64_C
(0xa97e5ef8cea5d153), UINT64_C(0xd3a62e30fe90582a),

155 
UINT64_C
(0xb0c7b7e3c7593bd8), UINT64_C(0xca1fc72bf76cb2a1),

156 
UINT64_C
(0x45775673a732292a), UINT64_C(0x3faf26bb9707a053),

157 
UINT64_C
(0x70ff52905f188d57), UINT64_C(0x0a2722586f2d042e),

158 
UINT64_C
(0x854fb3003f739fa5), UINT64_C(0xff97c3c80f4616dc),

159 
UINT64_C
(0x1bef5b57af4dc5ad), UINT64_C(0x61372b9f9f784cd4),

160 
UINT64_C
(0xee5fbac7cf26d75f), UINT64_C(0x9487ca0fff135e26),

161 
UINT64_C
(0xdbd7be24370c7322), UINT64_C(0xa10fceec0739fa5b),

162 
UINT64_C
(0x2e675fb4576761d0), UINT64_C(0x54bf2f7c6752e8a9),

163 
UINT64_C
(0xcdcf48d84fe75459), UINT64_C(0xb71738107fd2dd20),

164 
UINT64_C
(0x387fa9482f8c46ab), UINT64_C(0x42a7d9801fb9cfd2),

165 
UINT64_C
(0x0df7adabd7a6e2d6), UINT64_C(0x772fdd63e7936baf),

166 
UINT64_C
(0xf8474c3bb7cdf024), UINT64_C(0x829f3cf387f8795d),

167 
UINT64_C
(0x66e7a46c27f3aa2c), UINT64_C(0x1c3fd4a417c62355),

168 
UINT64_C
(0x935745fc4798b8de), UINT64_C(0xe98f353477ad31a7),

169 
UINT64_C
(0xa6df411fbfb21ca3), UINT64_C(0xdc0731d78f8795da),

170 
UINT64_C
(0x536fa08fdfd90e51), UINT64_C(0x29b7d047efec8728),

173 
ušt64_t
 
	$üc64
(
ušt64_t
 
üc
, cÚ¡ *
s
, ušt64_ˆ
l
) {

174 
ušt64_t
 
j
;

176 
j
 = 0; j < 
l
; j++) {

177 
ušt8_t
 
by‹
 = 
s
[
j
];

178 
üc
 = 
üc64_b
[(
ušt8_t
)üø^ 
by‹
] ^ (crc >> 8);

180  
üc
;

181 
	}
}

184 #ifdeà
REDIS_TEST


185 
	~<¡dio.h
>

187 
	#UNUSED
(
x
è()(x)

	)

188 
	$üc64Te¡
(
¬gc
, *
¬gv
[]) {

189 
	`UNUSED
(
¬gc
);

190 
	`UNUSED
(
¬gv
);

191 
	`´štf
("e9c6d914c4b8d9ca == %016llx\n",

192 (è
	`üc64
(0,(*)"123456789",9));

194 
	}
}

	@src/crc64.h

1 #iâdeà
CRC64_H


2 
	#CRC64_H


	)

4 
	~<¡dšt.h
>

6 
ušt64_t
 
üc64
(ušt64_ˆ
üc
, cÚ¡ *
s
, ušt64_ˆ
l
);

8 #ifdeà
REDIS_TEST


9 
üc64Te¡
(
¬gc
, *
¬gv
[]);

	@src/db.c

30 
	~"£rv”.h
"

31 
	~"şu¡”.h
"

32 
	~"©omicv¬.h
"

34 
	~<sigÇl.h
>

35 
	~<ùy³.h
>

44 
	$upd©eLFU
(
robj
 *
v®
) {

45 
couÁ”
 = 
	`LFUDeüAndR‘uº
(
v®
);

46 
couÁ”
 = 
	`LFULogInü
(counter);

47 
v®
->
Ìu
 = (
	`LFUG‘TimeInMšu‹s
()<<8è| 
couÁ”
;

48 
	}
}

53 
robj
 *
	$lookupKey
(
»disDb
 *
db
, 
robj
 *
key
, 
æags
) {

54 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

55 ià(
de
) {

56 
robj
 *
v®
 = 
	`diùG‘V®
(
de
);

61 ià(
£rv”
.
rdb_chd_pid
 == -1 &&

62 
£rv”
.
aof_chd_pid
 == -1 &&

63 !(
æags
 & 
LOOKUP_NOTOUCH
))

65 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

66 
	`upd©eLFU
(
v®
);

68 
v®
->
Ìu
 = 
	`LRU_CLOCK
();

71  
v®
;

73  
NULL
;

75 
	}
}

98 
robj
 *
	$lookupKeyR—dW™hFÏgs
(
»disDb
 *
db
, 
robj
 *
key
, 
æags
) {

99 
robj
 *
v®
;

101 ià(
	`expœeIfN“ded
(
db
,
key
) == 1) {

105 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
)  NULL;

119 ià(
£rv”
.
cu¼’t_ş›Á
 &&

120 
£rv”
.
cu¼’t_ş›Á
 !ğ£rv”.
ma¡”
 &&

121 
£rv”
.
cu¼’t_ş›Á
->
cmd
 &&

122 
£rv”
.
cu¼’t_ş›Á
->
cmd
->
æags
 & 
CMD_READONLY
)

124  
NULL
;

127 
v®
 = 
	`lookupKey
(
db
,
key
,
æags
);

128 ià(
v®
 =ğ
NULL
)

129 
£rv”
.
¡©_key¥aû_mis£s
++;

131 
£rv”
.
¡©_key¥aû_h™s
++;

132  
v®
;

133 
	}
}

137 
robj
 *
	$lookupKeyR—d
(
»disDb
 *
db
, 
robj
 *
key
) {

138  
	`lookupKeyR—dW™hFÏgs
(
db
,
key
,
LOOKUP_NONE
);

139 
	}
}

146 
robj
 *
	$lookupKeyWr™e
(
»disDb
 *
db
, 
robj
 *
key
) {

147 
	`expœeIfN“ded
(
db
,
key
);

148  
	`lookupKey
(
db
,
key
,
LOOKUP_NONE
);

149 
	}
}

151 
robj
 *
	$lookupKeyR—dOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

152 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
, 
key
);

153 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

154  
o
;

155 
	}
}

157 
robj
 *
	$lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

158 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
, 
key
);

159 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

160  
o
;

161 
	}
}

167 
	$dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

168 
sds
 
cİy
 = 
	`sdsdup
(
key
->
±r
);

169 
»tv®
 = 
	`diùAdd
(
db
->
diù
, 
cİy
, 
v®
);

171 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
»tv®
 =ğ
DICT_OK
);

172 ià(
v®
->
ty³
 =ğ
OBJ_LIST
è
	`sigÇlLi¡AsR—dy
(
db
, 
key
);

173 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyAdd
(
key
);

174 
	}
}

181 
	$dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

182 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

184 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
de
 != NULL);

185 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

186 
robj
 *
Şd
 = 
	`diùG‘V®
(
de
);

187 
§ved_Ìu
 = 
Şd
->
Ìu
;

188 
	`diùR•Ïû
(
db
->
diù
, 
key
->
±r
, 
v®
);

189 
v®
->
Ìu
 = 
§ved_Ìu
;

192 
	`upd©eLFU
(
v®
);

194 
	`diùR•Ïû
(
db
->
diù
, 
key
->
±r
, 
v®
);

196 
	}
}

206 
	$£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

207 ià(
	`lookupKeyWr™e
(
db
,
key
è=ğ
NULL
) {

208 
	`dbAdd
(
db
,
key
,
v®
);

210 
	`dbOv”wr™e
(
db
,
key
,
v®
);

212 
	`šüRefCouÁ
(
v®
);

213 
	`»moveExpœe
(
db
,
key
);

214 
	`sigÇlModif›dKey
(
db
,
key
);

215 
	}
}

217 
	$dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
) {

218  
	`diùFšd
(
db
->
diù
,
key
->
±r
è!ğ
NULL
;

219 
	}
}

225 
robj
 *
	$dbRªdomKey
(
»disDb
 *
db
) {

226 
diùEÁry
 *
de
;

229 
sds
 
key
;

230 
robj
 *
keyobj
;

232 
de
 = 
	`diùG‘RªdomKey
(
db
->
diù
);

233 ià(
de
 =ğ
NULL
)  NULL;

235 
key
 = 
	`diùG‘Key
(
de
);

236 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

237 ià(
	`diùFšd
(
db
->
expœes
,
key
)) {

238 ià(
	`expœeIfN“ded
(
db
,
keyobj
)) {

239 
	`deüRefCouÁ
(
keyobj
);

243  
keyobj
;

245 
	}
}

248 
	$dbSyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

251 ià(
	`diùSize
(
db
->
expœes
è> 0è
	`diùD–‘e
(db->expœes,
key
->
±r
);

252 ià(
	`diùD–‘e
(
db
->
diù
,
key
->
±r
è=ğ
DICT_OK
) {

253 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyD–
(
key
);

258 
	}
}

262 
	$dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

263  
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
 ? 
	`dbAsyncD–‘e
(
db
,
key
) :

264 
	`dbSyncD–‘e
(
db
,
key
);

265 
	}
}

294 
robj
 *
	$dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
o
) {

295 
	`£rv”As£¹
(
o
->
ty³
 =ğ
OBJ_STRING
);

296 ià(
o
->
»fcouÁ
 !ğ1 || o->
’codšg
 !ğ
OBJ_ENCODING_RAW
) {

297 
robj
 *
decoded
 = 
	`g‘DecodedObjeù
(
o
);

298 
o
 = 
	`ü—‹RawSŒšgObjeù
(
decoded
->
±r
, 
	`sd¦’
(decoded->ptr));

299 
	`deüRefCouÁ
(
decoded
);

300 
	`dbOv”wr™e
(
db
,
key
,
o
);

302  
o
;

303 
	}
}

319 
em±yDb
(
dbnum
, 
æags
, (
ÿÎback
)(*)) {

320 
j
, 
async
 = (
æags
 & 
EMPTYDB_ASYNC
);

321 
»moved
 = 0;

323 ià(
dbnum
 < -1 || dbnum >ğ
£rv”
.dbnum) {

324 
”ºo
 = 
EINVAL
;

328 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

329 ià(
dbnum
 !ğ-1 && dbnum !ğ
j
) ;

330 
»moved
 +ğ
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

331 ià(
async
) {

332 
	`em±yDbAsync
(&
£rv”
.
db
[
j
]);

334 
	`diùEm±y
(
£rv”
.
db
[
j
].
diù
,
ÿÎback
);

335 
	`diùEm±y
(
£rv”
.
db
[
j
].
expœes
,
ÿÎback
);

338 ià(
£rv”
.
şu¡”_’abËd
) {

339 ià(
async
) {

340 
	`¦ÙToKeyFlushAsync
();

342 
	`¦ÙToKeyFlush
();

345 ià(
dbnum
 =ğ-1è
	`æushSÏveKeysW™hExpœeLi¡
();

346  
»moved
;

347 
	}
}

349 
	$£ËùDb
(
ş›Á
 *
c
, 
id
) {

350 ià(
id
 < 0 || id >ğ
£rv”
.
dbnum
)

351  
C_ERR
;

352 
c
->
db
 = &
£rv”
.db[
id
];

353  
C_OK
;

354 
	}
}

365 
	$sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
) {

366 
	`touchW©chedKey
(
db
,
key
);

367 
	}
}

369 
	$sigÇlFlushedDb
(
dbid
) {

370 
	`touchW©chedKeysOnFlush
(
dbid
);

371 
	}
}

385 
	$g‘FlushCommªdFÏgs
(
ş›Á
 *
c
, *
æags
) {

387 ià(
c
->
¬gc
 > 1) {

388 ià(
c
->
¬gc
 > 2 || 
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"async")) {

389 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

390  
C_ERR
;

392 *
æags
 = 
EMPTYDB_ASYNC
;

394 *
æags
 = 
EMPTYDB_NO_FLAGS
;

396  
C_OK
;

397 
	}
}

402 
	$æushdbCommªd
(
ş›Á
 *
c
) {

403 
æags
;

405 ià(
	`g‘FlushCommªdFÏgs
(
c
,&
æags
è=ğ
C_ERR
) ;

406 
	`sigÇlFlushedDb
(
c
->
db
->
id
);

407 
£rv”
.
dœty
 +ğ
	`em±yDb
(
c
->
db
->
id
,
æags
,
NULL
);

408 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

409 
	}
}

414 
	$æush®lCommªd
(
ş›Á
 *
c
) {

415 
æags
;

417 ià(
	`g‘FlushCommªdFÏgs
(
c
,&
æags
è=ğ
C_ERR
) ;

418 
	`sigÇlFlushedDb
(-1);

419 
£rv”
.
dœty
 +ğ
	`em±yDb
(-1,
æags
,
NULL
);

420 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

421 ià(
£rv”
.
rdb_chd_pid
 != -1) {

422 
	`kl
(
£rv”
.
rdb_chd_pid
,
SIGUSR1
);

423 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

425 ià(
£rv”
.
§v•¬am¦’
 > 0) {

428 
§ved_dœty
 = 
£rv”
.
dœty
;

429 
rdbSaveInfo
 
rsi
, *
rsŒ
;

430 
rsŒ
 = 
	`rdbPİuÏ‹SaveInfo
(&
rsi
);

431 
	`rdbSave
(
£rv”
.
rdb_f’ame
,
rsŒ
);

432 
£rv”
.
dœty
 = 
§ved_dœty
;

434 
£rv”
.
dœty
++;

435 
	}
}

438 
	$d–G’”icCommªd
(
ş›Á
 *
c
, 
Ïzy
) {

439 
numd–
 = 0, 
j
;

441 
j
 = 1; j < 
c
->
¬gc
; j++) {

442 
	`expœeIfN“ded
(
c
->
db
,c->
¬gv
[
j
]);

443 
d–‘ed
 = 
Ïzy
 ? 
	`dbAsyncD–‘e
(
c
->
db
,c->
¬gv
[
j
]) :

444 
	`dbSyncD–‘e
(
c
->
db
,c->
¬gv
[
j
]);

445 ià(
d–‘ed
) {

446 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

447 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

448 "d–",
c
->
¬gv
[
j
],c->
db
->
id
);

449 
£rv”
.
dœty
++;

450 
numd–
++;

453 
	`addR•lyLÚgLÚg
(
c
,
numd–
);

454 
	}
}

456 
	$d–Commªd
(
ş›Á
 *
c
) {

457 
	`d–G’”icCommªd
(
c
,0);

458 
	}
}

460 
	$uÆškCommªd
(
ş›Á
 *
c
) {

461 
	`d–G’”icCommªd
(
c
,1);

462 
	}
}

466 
	$exi¡sCommªd
(
ş›Á
 *
c
) {

467 
couÁ
 = 0;

468 
j
;

470 
j
 = 1; j < 
c
->
¬gc
; j++) {

471 
	`expœeIfN“ded
(
c
->
db
,c->
¬gv
[
j
]);

472 ià(
	`dbExi¡s
(
c
->
db
,c->
¬gv
[
j
])è
couÁ
++;

474 
	`addR•lyLÚgLÚg
(
c
,
couÁ
);

475 
	}
}

477 
	$£ËùCommªd
(
ş›Á
 *
c
) {

478 
id
;

480 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[1], &
id
,

481 "šv®id DB index"è!ğ
C_OK
)

484 ià(
£rv”
.
şu¡”_’abËd
 && 
id
 != 0) {

485 
	`addR•lyE¼Ü
(
c
,"SELECT is‚ot‡llowed in cluster mode");

488 ià(
	`£ËùDb
(
c
,
id
è=ğ
C_ERR
) {

489 
	`addR•lyE¼Ü
(
c
,"DB index is out of„ange");

491 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

493 
	}
}

495 
	$¿ndomkeyCommªd
(
ş›Á
 *
c
) {

496 
robj
 *
key
;

498 ià((
key
 = 
	`dbRªdomKey
(
c
->
db
)è=ğ
NULL
) {

499 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

503 
	`addR•lyBulk
(
c
,
key
);

504 
	`deüRefCouÁ
(
key
);

505 
	}
}

507 
	$keysCommªd
(
ş›Á
 *
c
) {

508 
diùI‹¿tÜ
 *
di
;

509 
diùEÁry
 *
de
;

510 
sds
 
·‰”n
 = 
c
->
¬gv
[1]->
±r
;

511 
¶’
 = 
	`sd¦’
(
·‰”n
), 
®lkeys
;

512 
numkeys
 = 0;

513 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

515 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
db
->
diù
);

516 
®lkeys
 = (
·‰”n
[0] == '*' &&…attern[1] == '\0');

517 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

518 
sds
 
key
 = 
	`diùG‘Key
(
de
);

519 
robj
 *
keyobj
;

521 ià(
®lkeys
 || 
	`¡ršgm©chËn
(
·‰”n
,
¶’
,
key
,
	`sd¦’
(key),0)) {

522 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

523 ià(
	`expœeIfN“ded
(
c
->
db
,
keyobj
) == 0) {

524 
	`addR•lyBulk
(
c
,
keyobj
);

525 
numkeys
++;

527 
	`deüRefCouÁ
(
keyobj
);

530 
	`diùR–—£I‹¿tÜ
(
di
);

531 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
numkeys
);

532 
	}
}

536 
	$sÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
) {

537 **
pd
 = (**è
´ivd©a
;

538 
li¡
 *
keys
 = 
pd
[0];

539 
robj
 *
o
 = 
pd
[1];

540 
robj
 *
key
, *
v®
 = 
NULL
;

542 ià(
o
 =ğ
NULL
) {

543 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

544 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
, 
	`sd¦’
(sdskey));

545 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

546 
sds
 
keysds
 = 
	`diùG‘Key
(
de
);

547 
key
 = 
	`ü—‹SŒšgObjeù
(
keysds
,
	`sd¦’
(keysds));

548 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

549 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

550 
sds
 
sdsv®
 = 
	`diùG‘V®
(
de
);

551 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
,
	`sd¦’
(sdskey));

552 
v®
 = 
	`ü—‹SŒšgObjeù
(
sdsv®
,
	`sd¦’
(sdsval));

553 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

554 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

555 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
,
	`sd¦’
(sdskey));

556 
v®
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(*(*)
	`diùG‘V®
(
de
),0);

558 
	`£rv”Pªic
("Type‚ot handled in SCAN callback.");

561 
	`li¡AddNodeTa
(
keys
, 
key
);

562 ià(
v®
è
	`li¡AddNodeTa
(
keys
, val);

563 
	}
}

569 
	$·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
) {

570 *
•Œ
;

574 
”ºo
 = 0;

575 *
cursÜ
 = 
	`¡¹oul
(
o
->
±r
, &
•Œ
, 10);

576 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] !ğ'\0' || 
”ºo
 =ğ
ERANGE
)

578 
	`addR•lyE¼Ü
(
c
, "invalid cursor");

579  
C_ERR
;

581  
C_OK
;

582 
	}
}

595 
	$sÿnG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
o
, 
cursÜ
) {

596 
i
, 
j
;

597 
li¡
 *
keys
 = 
	`li¡C»©e
();

598 
li¡Node
 *
node
, *
ÃxŠode
;

599 
couÁ
 = 10;

600 
sds
 
·t
 = 
NULL
;

601 
·’
 = 0, 
u£_·‰”n
 = 0;

602 
diù
 *
ht
;

606 
	`£rv”As£¹
(
o
 =ğ
NULL
 || o->
ty³
 =ğ
OBJ_SET
 || o->ty³ =ğ
OBJ_HASH
 ||

607 
o
->
ty³
 =ğ
OBJ_ZSET
);

610 
i
 = (
o
 =ğ
NULL
) ? 2 : 3;

613 
i
 < 
c
->
¬gc
) {

614 
j
 = 
c
->
¬gc
 - 
i
;

615 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "couÁ"è&& 
j
 >= 2) {

616 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
i
+1], &
couÁ
, 
NULL
)

617 !ğ
C_OK
)

619 
ş—nup
;

622 ià(
couÁ
 < 1) {

623 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

624 
ş—nup
;

627 
i
 += 2;

628 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "m©ch"è&& 
j
 >= 2) {

629 
·t
 = 
c
->
¬gv
[
i
+1]->
±r
;

630 
·’
 = 
	`sd¦’
(
·t
);

634 
u£_·‰”n
 = !(
·t
[0] =ğ'*' && 
·’
 == 1);

636 
i
 += 2;

638 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

639 
ş—nup
;

652 
ht
 = 
NULL
;

653 ià(
o
 =ğ
NULL
) {

654 
ht
 = 
c
->
db
->
diù
;

655 } ià(
o
->
ty³
 =ğ
OBJ_SET
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

656 
ht
 = 
o
->
±r
;

657 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 && o->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

658 
ht
 = 
o
->
±r
;

659 
couÁ
 *= 2;

660 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
 && o->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

661 
z£t
 *
zs
 = 
o
->
±r
;

662 
ht
 = 
zs
->
diù
;

663 
couÁ
 *= 2;

666 ià(
ht
) {

667 *
´ivd©a
[2];

672 
max™”©iÚs
 = 
couÁ
*10;

677 
´ivd©a
[0] = 
keys
;

678 
´ivd©a
[1] = 
o
;

680 
cursÜ
 = 
	`diùSÿn
(
ht
, cursÜ, 
sÿnC®lback
, 
NULL
, 
´ivd©a
);

681 } 
cursÜ
 &&

682 
max™”©iÚs
-- &&

683 
	`li¡L’gth
(
keys
è< ()
couÁ
);

684 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

685 
pos
 = 0;

686 
št64_t
 
Î
;

688 
	`št£tG‘
(
o
->
±r
,
pos
++,&
Î
))

689 
	`li¡AddNodeTa
(
keys
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î
));

690 
cursÜ
 = 0;

691 } ià(
o
->
ty³
 =ğ
OBJ_HASH
 || o->ty³ =ğ
OBJ_ZSET
) {

692 *
p
 = 
	`zli¡Index
(
o
->
±r
,0);

693 *
v¡r
;

694 
vËn
;

695 
vÎ
;

697 
p
) {

698 
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vÎ
);

699 
	`li¡AddNodeTa
(
keys
,

700 (
v¡r
 !ğ
NULL
è? 
	`ü—‹SŒšgObjeù
((*)v¡r,
vËn
) :

701 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
));

702 
p
 = 
	`zli¡Next
(
o
->
±r
,p);

704 
cursÜ
 = 0;

706 
	`£rv”Pªic
("Not handledƒncoding in SCAN.");

710 
node
 = 
	`li¡Fœ¡
(
keys
);

711 
node
) {

712 
robj
 *
kobj
 = 
	`li¡NodeV®ue
(
node
);

713 
ÃxŠode
 = 
	`li¡NextNode
(
node
);

714 
f‹r
 = 0;

717 ià(!
f‹r
 && 
u£_·‰”n
) {

718 ià(
	`sdsEncodedObjeù
(
kobj
)) {

719 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
kobj
->
±r
, 
	`sd¦’
(kobj->ptr), 0))

720 
f‹r
 = 1;

722 
buf
[
LONG_STR_SIZE
];

723 
Ën
;

725 
	`£rv”As£¹
(
kobj
->
’codšg
 =ğ
OBJ_ENCODING_INT
);

726 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
kobj
->
±r
);

727 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
buf
, 
Ën
, 0)è
f‹r
 = 1;

732 ià(!
f‹r
 && 
o
 =ğ
NULL
 && 
	`expœeIfN“ded
(
c
->
db
, 
kobj
)) filter = 1;

735 ià(
f‹r
) {

736 
	`deüRefCouÁ
(
kobj
);

737 
	`li¡D–Node
(
keys
, 
node
);

743 ià(
o
 && (o->
ty³
 =ğ
OBJ_ZSET
 || o->ty³ =ğ
OBJ_HASH
)) {

744 
node
 = 
ÃxŠode
;

745 
ÃxŠode
 = 
	`li¡NextNode
(
node
);

746 ià(
f‹r
) {

747 
kobj
 = 
	`li¡NodeV®ue
(
node
);

748 
	`deüRefCouÁ
(
kobj
);

749 
	`li¡D–Node
(
keys
, 
node
);

752 
node
 = 
ÃxŠode
;

756 
	`addR•lyMuÉiBulkL’
(
c
, 2);

757 
	`addR•lyBulkLÚgLÚg
(
c
,
cursÜ
);

759 
	`addR•lyMuÉiBulkL’
(
c
, 
	`li¡L’gth
(
keys
));

760 (
node
 = 
	`li¡Fœ¡
(
keys
)è!ğ
NULL
) {

761 
robj
 *
kobj
 = 
	`li¡NodeV®ue
(
node
);

762 
	`addR•lyBulk
(
c
, 
kobj
);

763 
	`deüRefCouÁ
(
kobj
);

764 
	`li¡D–Node
(
keys
, 
node
);

767 
ş—nup
:

768 
	`li¡S‘F»eM‘hod
(
keys
,
deüRefCouÁVoid
);

769 
	`li¡R–—£
(
keys
);

770 
	}
}

773 
	$sÿnCommªd
(
ş›Á
 *
c
) {

774 
cursÜ
;

775 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[1],&
cursÜ
è=ğ
C_ERR
) ;

776 
	`sÿnG’”icCommªd
(
c
,
NULL
,
cursÜ
);

777 
	}
}

779 
	$dbsizeCommªd
(
ş›Á
 *
c
) {

780 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
db
->
diù
));

781 
	}
}

783 
	$Ï¡§veCommªd
(
ş›Á
 *
c
) {

784 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
Ï¡§ve
);

785 
	}
}

787 
	$ty³Commªd
(
ş›Á
 *
c
) {

788 
robj
 *
o
;

789 *
ty³
;

791 
o
 = 
	`lookupKeyR—dW™hFÏgs
(
c
->
db
,c->
¬gv
[1],
LOOKUP_NOTOUCH
);

792 ià(
o
 =ğ
NULL
) {

793 
ty³
 = "none";

795 
o
->
ty³
) {

796 
OBJ_STRING
: 
ty³
 = "string"; ;

797 
OBJ_LIST
: 
ty³
 = "list"; ;

798 
OBJ_SET
: 
ty³
 = "set"; ;

799 
OBJ_ZSET
: 
ty³
 = "zset"; ;

800 
OBJ_HASH
: 
ty³
 = "hash"; ;

801 
OBJ_MODULE
: {

802 
moduËV®ue
 *
mv
 = 
o
->
±r
;

803 
ty³
 = 
mv
->ty³->
Çme
;

805 : 
ty³
 = "unknown"; ;

808 
	`addR•lyStus
(
c
,
ty³
);

809 
	}
}

811 
	$shutdownCommªd
(
ş›Á
 *
c
) {

812 
æags
 = 0;

814 ià(
c
->
¬gc
 > 2) {

815 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

817 } ià(
c
->
¬gc
 == 2) {

818 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"nosave")) {

819 
æags
 |ğ
SHUTDOWN_NOSAVE
;

820 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"save")) {

821 
æags
 |ğ
SHUTDOWN_SAVE
;

823 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

833 ià(
£rv”
.
lßdšg
 || s”v”.
£Áš–_mode
)

834 
æags
 = (æag & ~
SHUTDOWN_SAVE
è| 
SHUTDOWN_NOSAVE
;

835 ià(
	`´•¬eFÜShutdown
(
æags
è=ğ
C_OK
è
	`ex™
(0);

836 
	`addR•lyE¼Ü
(
c
,"Errorsryingo SHUTDOWN. Check†ogs.");

837 
	}
}

839 
	$»ÇmeG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

840 
robj
 *
o
;

841 
expœe
;

842 
§mekey
 = 0;

846 ià(
	`sdscmp
(
c
->
¬gv
[1]->
±r
,c->¬gv[2]->±rè=ğ0è
§mekey
 = 1;

848 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
)è=ğ
NULL
)

851 ià(
§mekey
) {

852 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cz”o
 : sh¬ed.
ok
);

856 
	`šüRefCouÁ
(
o
);

857 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

858 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]è!ğ
NULL
) {

859 ià(
nx
) {

860 
	`deüRefCouÁ
(
o
);

861 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

866 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[2]);

868 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
o
);

869 ià(
expœe
 !ğ-1è
	`£tExpœe
(
c
,c->
db
,c->
¬gv
[2],expire);

870 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

871 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

872 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

873 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_from",

874 
c
->
¬gv
[1],c->
db
->
id
);

875 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"rename_to",

876 
c
->
¬gv
[2],c->
db
->
id
);

877 
£rv”
.
dœty
++;

878 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

879 
	}
}

881 
	$»ÇmeCommªd
(
ş›Á
 *
c
) {

882 
	`»ÇmeG’”icCommªd
(
c
,0);

883 
	}
}

885 
	$»Çm’xCommªd
(
ş›Á
 *
c
) {

886 
	`»ÇmeG’”icCommªd
(
c
,1);

887 
	}
}

889 
	$moveCommªd
(
ş›Á
 *
c
) {

890 
robj
 *
o
;

891 
»disDb
 *
¤c
, *
d¡
;

892 
¤cid
;

893 
dbid
, 
expœe
;

895 ià(
£rv”
.
şu¡”_’abËd
) {

896 
	`addR•lyE¼Ü
(
c
,"MOVE is‚ot‡llowed in cluster mode");

901 
¤c
 = 
c
->
db
;

902 
¤cid
 = 
c
->
db
->
id
;

904 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[2],&
dbid
è=ğ
C_ERR
 ||

905 
dbid
 < 
INT_MIN
 || dbid > 
INT_MAX
 ||

906 
	`£ËùDb
(
c
,
dbid
è=ğ
C_ERR
)

908 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

911 
d¡
 = 
c
->
db
;

912 
	`£ËùDb
(
c
,
¤cid
);

916 ià(
¤c
 =ğ
d¡
) {

917 
	`addR•ly
(
c
,
sh¬ed
.
§meobjeù”r
);

922 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

923 ià(!
o
) {

924 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

927 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

930 ià(
	`lookupKeyWr™e
(
d¡
,
c
->
¬gv
[1]è!ğ
NULL
) {

931 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

934 
	`dbAdd
(
d¡
,
c
->
¬gv
[1],
o
);

935 ià(
expœe
 !ğ-1è
	`£tExpœe
(
c
,
d¡
,c->
¬gv
[1],expire);

936 
	`šüRefCouÁ
(
o
);

939 
	`dbD–‘e
(
¤c
,
c
->
¬gv
[1]);

940 
£rv”
.
dœty
++;

941 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

942 
	}
}

948 
	$sÿnD©aba£FÜR—dyLi¡s
(
»disDb
 *
db
) {

949 
diùEÁry
 *
de
;

950 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
db
->
blockšg_keys
);

951 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

952 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

953 
robj
 *
v®ue
 = 
	`lookupKey
(
db
,
key
,
LOOKUP_NOTOUCH
);

954 ià(
v®ue
 && v®ue->
ty³
 =ğ
OBJ_LIST
)

955 
	`sigÇlLi¡AsR—dy
(
db
, 
key
);

957 
	`diùR–—£I‹¿tÜ
(
di
);

958 
	}
}

968 
	$dbSw­D©aba£s
(
id1
, 
id2
) {

969 ià(
id1
 < 0 || id1 >ğ
£rv”
.
dbnum
 ||

970 
id2
 < 0 || id2 >ğ
£rv”
.
dbnum
è 
C_ERR
;

971 ià(
id1
 =ğ
id2
è 
C_OK
;

972 
»disDb
 
aux
 = 
£rv”
.
db
[
id1
];

973 
»disDb
 *
db1
 = &
£rv”
.
db
[
id1
], *
db2
 = &£rv”.db[
id2
];

978 
db1
->
diù
 = 
db2
->dict;

979 
db1
->
expœes
 = 
db2
->expires;

980 
db1
->
avg_‰l
 = 
db2
->avg_ttl;

982 
db2
->
diù
 = 
aux
.dict;

983 
db2
->
expœes
 = 
aux
.expires;

984 
db2
->
avg_‰l
 = 
aux
.avg_ttl;

995 
	`sÿnD©aba£FÜR—dyLi¡s
(
db1
);

996 
	`sÿnD©aba£FÜR—dyLi¡s
(
db2
);

997  
C_OK
;

998 
	}
}

1001 
	$sw­dbCommªd
(
ş›Á
 *
c
) {

1002 
id1
, 
id2
;

1005 ià(
£rv”
.
şu¡”_’abËd
) {

1006 
	`addR•lyE¼Ü
(
c
,"SWAPDB is‚ot‡llowed in cluster mode");

1011 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[1], &
id1
,

1012 "šv®id fœ¡ DB index"è!ğ
C_OK
)

1015 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
id2
,

1016 "šv®id secÚd DB index"è!ğ
C_OK
)

1020 ià(
	`dbSw­D©aba£s
(
id1
,
id2
è=ğ
C_ERR
) {

1021 
	`addR•lyE¼Ü
(
c
,"DB index is out of„ange");

1024 
£rv”
.
dœty
++;

1025 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1027 
	}
}

1033 
	$»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

1036 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

1037  
	`diùD–‘e
(
db
->
expœes
,
key
->
±r
è=ğ
DICT_OK
;

1038 
	}
}

1044 
	$£tExpœe
(
ş›Á
 *
c
, 
»disDb
 *
db
, 
robj
 *
key
, 
wh’
) {

1045 
diùEÁry
 *
kde
, *
de
;

1048 
kde
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

1049 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
kde
 != NULL);

1050 
de
 = 
	`diùAddOrFšd
(
db
->
expœes
,
	`diùG‘Key
(
kde
));

1051 
	`diùS‘SigÃdIÁeg”V®
(
de
,
wh’
);

1053 
wr™abË_¦ave
 = 
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¦ave_ro
 == 0;

1054 ià(
c
 && 
wr™abË_¦ave
 && !(c->
æags
 & 
CLIENT_MASTER
))

1055 
	`»memb”SÏveKeyW™hExpœe
(
db
,
key
);

1056 
	}
}

1060 
	$g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
) {

1061 
diùEÁry
 *
de
;

1064 ià(
	`diùSize
(
db
->
expœes
) == 0 ||

1065 (
de
 = 
	`diùFšd
(
db
->
expœes
,
key
->
±r
)è=ğ
NULL
)  -1;

1069 
	`£rv”As£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

1070  
	`diùG‘SigÃdIÁeg”V®
(
de
);

1071 
	}
}

1081 
	$´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
Ïzy
) {

1082 
robj
 *
¬gv
[2];

1084 
¬gv
[0] = 
Ïzy
 ? 
sh¬ed
.
uÆšk
 : sh¬ed.
d–
;

1085 
¬gv
[1] = 
key
;

1086 
	`šüRefCouÁ
(
¬gv
[0]);

1087 
	`šüRefCouÁ
(
¬gv
[1]);

1089 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
)

1090 
	`ãedAµ’dOÆyFe
(
£rv”
.
d–Commªd
,
db
->
id
,
¬gv
,2);

1091 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
,
db
->
id
,
¬gv
,2);

1093 
	`deüRefCouÁ
(
¬gv
[0]);

1094 
	`deüRefCouÁ
(
¬gv
[1]);

1095 
	}
}

1116 
	$expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
) {

1117 
m¡ime_t
 
wh’
 = 
	`g‘Expœe
(
db
,
key
);

1118 
m¡ime_t
 
now
;

1120 ià(
wh’
 < 0)  0;

1123 ià(
£rv”
.
lßdšg
)  0;

1130 
now
 = 
£rv”
.
lua_ÿÎ”
 ? s”v”.
lua_time_¡¬t
 : 
	`m¡ime
();

1139 ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
è 
now
 > 
wh’
;

1142 ià(
now
 <ğ
wh’
)  0;

1145 
£rv”
.
¡©_expœedkeys
++;

1146 
	`´İag©eExpœe
(
db
,
key
,
£rv”
.
Ïzyä“_Ïzy_expœe
);

1147 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EXPIRED
,

1148 "expœed",
key
,
db
->
id
);

1149  
£rv”
.
Ïzyä“_Ïzy_expœe
 ? 
	`dbAsyncD–‘e
(
db
,
key
) :

1150 
	`dbSyncD–‘e
(
db
,
key
);

1151 
	}
}

1159 *
	$g‘KeysUsšgCommªdTabË
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1160 
j
, 
i
 = 0, 
Ï¡
, *
keys
;

1161 
	`UNUSED
(
¬gv
);

1163 ià(
cmd
->
fœ¡key
 == 0) {

1164 *
numkeys
 = 0;

1165  
NULL
;

1168 
Ï¡
 = 
cmd
->
Ï¡key
;

1169 ià(
Ï¡
 < 0èÏ¡ = 
¬gc
+last;

1170 
keys
 = 
	`zm®loc
(()*((
Ï¡
 - 
cmd
->
fœ¡key
)+1));

1171 
j
 = 
cmd
->
fœ¡key
; j <ğ
Ï¡
; j +ğcmd->
key¡•
) {

1172 ià(
j
 >ğ
¬gc
) {

1179 ià(
cmd
->
æags
 & 
CMD_MODULE
 || cmd->
¬™y
 < 0) {

1180 
	`zä“
(
keys
);

1181 *
numkeys
 = 0;

1182  
NULL
;

1184 
	`£rv”Pªic
("Redis built-in command declared keys…ositions‚ot matchinghe‡rity„equirements.");

1187 
keys
[
i
++] = 
j
;

1189 *
numkeys
 = 
i
;

1190  
keys
;

1191 
	}
}

1204 *
	$g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1205 ià(
cmd
->
æags
 & 
CMD_MODULE_GETKEYS
) {

1206  
	`moduËG‘CommªdKeysVŸAPI
(
cmd
,
¬gv
,
¬gc
,
numkeys
);

1207 } ià(!(
cmd
->
æags
 & 
CMD_MODULE
è&& cmd->
g‘keys_´oc
) {

1208  
cmd
->
	`g‘keys_´oc
(cmd,
¬gv
,
¬gc
,
numkeys
);

1210  
	`g‘KeysUsšgCommªdTabË
(
cmd
,
¬gv
,
¬gc
,
numkeys
);

1212 
	}
}

1215 
	$g‘KeysF»eResuÉ
(*
»suÉ
) {

1216 
	`zä“
(
»suÉ
);

1217 
	}
}

1222 *
	$zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1223 
i
, 
num
, *
keys
;

1224 
	`UNUSED
(
cmd
);

1226 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1229 ià(
num
 > (
¬gc
-3)) {

1230 *
numkeys
 = 0;

1231  
NULL
;

1237 
keys
 = 
	`zm®loc
(()*(
num
+1));

1240 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1243 
keys
[
num
] = 1;

1244 *
numkeys
 = 
num
+1;

1245  
keys
;

1246 
	}
}

1251 *
	$ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1252 
i
, 
num
, *
keys
;

1253 
	`UNUSED
(
cmd
);

1255 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1258 ià(
num
 > (
¬gc
-3)) {

1259 *
numkeys
 = 0;

1260  
NULL
;

1263 
keys
 = 
	`zm®loc
(()*
num
);

1264 *
numkeys
 = 
num
;

1267 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1269  
keys
;

1270 
	}
}

1279 *
	$sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1280 
i
, 
j
, 
num
, *
keys
, 
found_¡Üe
 = 0;

1281 
	`UNUSED
(
cmd
);

1283 
num
 = 0;

1284 
keys
 = 
	`zm®loc
(()*2);

1286 
keys
[
num
++] = 1;

1293 *
Çme
;

1294 
sk
;

1295 } 
skli¡
[] = {

1299 {
NULL
, 0}

1302 
i
 = 2; i < 
¬gc
; i++) {

1303 
j
 = 0; 
skli¡
[j].
Çme
 !ğ
NULL
; j++) {

1304 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,
skli¡
[
j
].
Çme
)) {

1305 
i
 +ğ
skli¡
[
j
].
sk
;

1307 } ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"¡Üe"è&& i+1 < 
¬gc
) {

1311 
found_¡Üe
 = 1;

1312 
keys
[
num
] = 
i
+1;

1317 *
numkeys
 = 
num
 + 
found_¡Üe
;

1318  
keys
;

1319 
	}
}

1321 *
	$mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1322 
i
, 
num
, 
fœ¡
, *
keys
;

1323 
	`UNUSED
(
cmd
);

1326 
fœ¡
 = 3;

1327 
num
 = 1;

1330 ià(
¬gc
 > 6) {

1331 
i
 = 6; i < 
¬gc
; i++) {

1332 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"keys") &&

1333 
	`sd¦’
(
¬gv
[3]->
±r
) == 0)

1335 
fœ¡
 = 
i
+1;

1336 
num
 = 
¬gc
-
fœ¡
;

1342 
keys
 = 
	`zm®loc
(()*
num
);

1343 
i
 = 0; i < 
num
; i++è
keys
[i] = 
fœ¡
+i;

1344 *
numkeys
 = 
num
;

1345  
keys
;

1346 
	}
}

1352 *
	$geÜadiusG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1353 
i
, 
num
, *
keys
;

1354 
	`UNUSED
(
cmd
);

1357 
¡Üed_key
 = -1;

1358 
i
 = 5; i < 
¬gc
; i++) {

1359 *
¬g
 = 
¬gv
[
i
]->
±r
;

1364 ià((!
	`¡rÿ£cmp
(
¬g
, "¡Üe"è|| !¡rÿ£cmp×rg, "¡Üedi¡")è&& ((
i
+1è< 
¬gc
)) {

1365 
¡Üed_key
 = 
i
+1;

1366 
i
++;

1369 
num
 = 1 + (
¡Üed_key
 == -1 ? 0 : 1);

1375 
keys
 = 
	`zm®loc
((è* 
num
);

1378 
keys
[0] = 1;

1379 if(
num
 > 1) {

1380 
keys
[1] = 
¡Üed_key
;

1382 *
numkeys
 = 
num
;

1383  
keys
;

1384 
	}
}

1390 
	$¦ÙToKeyUpd©eKey
(
robj
 *
key
, 
add
) {

1391 
hash¦Ù
 = 
	`keyHashSlÙ
(
key
->
±r
,
	`sd¦’
(key->ptr));

1392 
buf
[64];

1393 *
šdexed
 = 
buf
;

1394 
size_t
 
keyËn
 = 
	`sd¦’
(
key
->
±r
);

1396 
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
[
hash¦Ù
] +ğ
add
 ? 1 : -1;

1397 ià(
keyËn
+2 > 64è
šdexed
 = 
	`zm®loc
(keylen+2);

1398 
šdexed
[0] = (
hash¦Ù
 >> 8) & 0xff;

1399 
šdexed
[1] = 
hash¦Ù
 & 0xff;

1400 
	`memıy
(
šdexed
+2,
key
->
±r
,
keyËn
);

1401 ià(
add
) {

1402 
	`¿xIn£¹
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
,
šdexed
,
keyËn
+2,
NULL
,NULL);

1404 
	`¿xRemove
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
,
šdexed
,
keyËn
+2,
NULL
);

1406 ià(
šdexed
 !ğ
buf
è
	`zä“
(indexed);

1407 
	}
}

1409 
	$¦ÙToKeyAdd
(
robj
 *
key
) {

1410 
	`¦ÙToKeyUpd©eKey
(
key
,1);

1411 
	}
}

1413 
	$¦ÙToKeyD–
(
robj
 *
key
) {

1414 
	`¦ÙToKeyUpd©eKey
(
key
,0);

1415 
	}
}

1417 
	$¦ÙToKeyFlush
() {

1418 
	`¿xF»e
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
);

1419 
£rv”
.
şu¡”
->
¦Ùs_to_keys
 = 
	`¿xNew
();

1420 
	`mem£t
(
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
,0,

1421 (
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
));

1422 
	}
}

1427 
	$g‘KeysInSlÙ
(
hash¦Ù
, 
robj
 **
keys
, 
couÁ
) {

1428 
¿xI‹¿tÜ
 
™”
;

1429 
j
 = 0;

1430 
šdexed
[2];

1432 
šdexed
[0] = (
hash¦Ù
 >> 8) & 0xff;

1433 
šdexed
[1] = 
hash¦Ù
 & 0xff;

1434 
	`¿xS¹
(&
™”
,
£rv”
.
şu¡”
->
¦Ùs_to_keys
);

1435 
	`¿xS“k
(&
™”
,">=",
šdexed
,2);

1436 
couÁ
-- && 
	`¿xNext
(&
™”
)) {

1437 ià(
™”
.
key
[0] !ğ
šdexed
[0] || iter.key[1] != indexed[1]) ;

1438 
keys
[
j
++] = 
	`ü—‹SŒšgObjeù
((*)
™”
.
key
+2,™”.
key_Ën
-2);

1440 
	`¿xStİ
(&
™”
);

1441  
j
;

1442 
	}
}

1446 
	$d–KeysInSlÙ
(
hash¦Ù
) {

1447 
¿xI‹¿tÜ
 
™”
;

1448 
j
 = 0;

1449 
šdexed
[2];

1451 
šdexed
[0] = (
hash¦Ù
 >> 8) & 0xff;

1452 
šdexed
[1] = 
hash¦Ù
 & 0xff;

1453 
	`¿xS¹
(&
™”
,
£rv”
.
şu¡”
->
¦Ùs_to_keys
);

1454 
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
[
hash¦Ù
]) {

1455 
	`¿xS“k
(&
™”
,">=",
šdexed
,2);

1456 
	`¿xNext
(&
™”
);

1458 
robj
 *
key
 = 
	`ü—‹SŒšgObjeù
((*)
™”
.key+2,™”.
key_Ën
-2);

1459 
	`dbD–‘e
(&
£rv”
.
db
[0],
key
);

1460 
	`deüRefCouÁ
(
key
);

1461 
j
++;

1463 
	`¿xStİ
(&
™”
);

1464  
j
;

1465 
	}
}

1467 
	$couÁKeysInSlÙ
(
hash¦Ù
) {

1468  
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
[
hash¦Ù
];

1469 
	}
}

	@src/debug.c

30 
	~"£rv”.h
"

31 
	~"sha1.h
"

32 
	~"üc64.h
"

34 
	~<¬·/š‘.h
>

35 
	~<sigÇl.h
>

36 
	~<dlfú.h
>

38 #ifdeà
HAVE_BACKTRACE


39 
	~<execšfo.h
>

40 
	~<ucÚ‹xt.h
>

41 
	~<fú.h
>

42 
	~"bio.h
"

43 
	~<uni¡d.h
>

46 #ifdeà
__CYGWIN__


47 #iâdeà
SA_ONSTACK


48 
	#SA_ONSTACK
 0x08000000

	)

60 
	$xÜDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
) {

61 
SHA1_CTX
 
ùx
;

62 
hash
[20], *
s
 = 
±r
;

63 
j
;

65 
	`SHA1In™
(&
ùx
);

66 
	`SHA1Upd©e
(&
ùx
,
s
,
Ën
);

67 
	`SHA1Fš®
(
hash
,&
ùx
);

69 
j
 = 0; j < 20; j++)

70 
dige¡
[
j
] ^ğ
hash
[j];

71 
	}
}

73 
	$xÜObjeùDige¡
(*
dige¡
, 
robj
 *
o
) {

74 
o
 = 
	`g‘DecodedObjeù
(o);

75 
	`xÜDige¡
(
dige¡
,
o
->
±r
,
	`sd¦’
(o->ptr));

76 
	`deüRefCouÁ
(
o
);

77 
	}
}

93 
	$mixDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
) {

94 
SHA1_CTX
 
ùx
;

95 *
s
 = 
±r
;

97 
	`xÜDige¡
(
dige¡
,
s
,
Ën
);

98 
	`SHA1In™
(&
ùx
);

99 
	`SHA1Upd©e
(&
ùx
,
dige¡
,20);

100 
	`SHA1Fš®
(
dige¡
,&
ùx
);

101 
	}
}

103 
	$mixObjeùDige¡
(*
dige¡
, 
robj
 *
o
) {

104 
o
 = 
	`g‘DecodedObjeù
(o);

105 
	`mixDige¡
(
dige¡
,
o
->
±r
,
	`sd¦’
(o->ptr));

106 
	`deüRefCouÁ
(
o
);

107 
	}
}

115 
	$compu‹D©a£tDige¡
(*
fš®
) {

116 
dige¡
[20];

117 
buf
[128];

118 
diùI‹¿tÜ
 *
di
 = 
NULL
;

119 
diùEÁry
 *
de
;

120 
j
;

121 
ušt32_t
 
aux
;

123 
	`mem£t
(
fš®
,0,20);

125 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

126 
»disDb
 *
db
 = 
£rv”
.db+
j
;

128 ià(
	`diùSize
(
db
->
diù
) == 0) ;

129 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
db
->
diù
);

133 
aux
 = 
	`htÚl
(
j
);

134 
	`mixDige¡
(
fš®
,&
aux
,(aux));

137 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

138 
sds
 
key
;

139 
robj
 *
keyobj
, *
o
;

140 
expœ‘ime
;

142 
	`mem£t
(
dige¡
,0,20);

143 
key
 = 
	`diùG‘Key
(
de
);

144 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

146 
	`mixDige¡
(
dige¡
,
key
,
	`sd¦’
(key));

148 
o
 = 
	`diùG‘V®
(
de
);

150 
aux
 = 
	`htÚl
(
o
->
ty³
);

151 
	`mixDige¡
(
dige¡
,&
aux
,(aux));

152 
expœ‘ime
 = 
	`g‘Expœe
(
db
,
keyobj
);

155 ià(
o
->
ty³
 =ğ
OBJ_STRING
) {

156 
	`mixObjeùDige¡
(
dige¡
,
o
);

157 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

158 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
o
,0,
LIST_TAIL
);

159 
li¡Ty³EÁry
 
’Œy
;

160 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

161 
robj
 *
–eobj
 = 
	`li¡Ty³G‘
(&
’Œy
);

162 
	`mixObjeùDige¡
(
dige¡
,
–eobj
);

163 
	`deüRefCouÁ
(
–eobj
);

165 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

166 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

167 
£tTy³I‹¿tÜ
 *
si
 = 
	`£tTy³In™I‹¿tÜ
(
o
);

168 
sds
 
sd£Ë
;

169 (
sd£Ë
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

170 
	`xÜDige¡
(
dige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

171 
	`sdsä“
(
sd£Ë
);

173 
	`£tTy³R–—£I‹¿tÜ
(
si
);

174 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

175 
–edige¡
[20];

177 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

178 *
zl
 = 
o
->
±r
;

179 *
•Œ
, *
¥Œ
;

180 *
v¡r
;

181 
vËn
;

182 
vÎ
;

183 
scÜe
;

185 
•Œ
 = 
	`zli¡Index
(
zl
,0);

186 
	`£rv”As£¹
(
•Œ
 !ğ
NULL
);

187 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

188 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

190 
•Œ
 !ğ
NULL
) {

191 
	`£rv”As£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vÎ
));

192 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

194 
	`mem£t
(
–edige¡
,0,20);

195 ià(
v¡r
 !ğ
NULL
) {

196 
	`mixDige¡
(
–edige¡
,
v¡r
,
vËn
);

198 
	`Î2¡ršg
(
buf
,(buf),
vÎ
);

199 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

202 
	`¢´štf
(
buf
,(buf),"%.17g",
scÜe
);

203 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

204 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

205 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

207 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

208 
z£t
 *
zs
 = 
o
->
±r
;

209 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
zs
->
diù
);

210 
diùEÁry
 *
de
;

212 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

213 
sds
 
sd£Ë
 = 
	`diùG‘Key
(
de
);

214 *
scÜe
 = 
	`diùG‘V®
(
de
);

216 
	`¢´štf
(
buf
,(buf),"%.17g",*
scÜe
);

217 
	`mem£t
(
–edige¡
,0,20);

218 
	`mixDige¡
(
–edige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

219 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

220 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

222 
	`diùR–—£I‹¿tÜ
(
di
);

224 
	`£rv”Pªic
("Unknown sorted setƒncoding");

226 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

227 
hashTy³I‹¿tÜ
 *
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

228 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

229 
–edige¡
[20];

230 
sds
 
sd£Ë
;

232 
	`mem£t
(
–edige¡
,0,20);

233 
sd£Ë
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_KEY
);

234 
	`mixDige¡
(
–edige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

235 
	`sdsä“
(
sd£Ë
);

236 
sd£Ë
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_VALUE
);

237 
	`mixDige¡
(
–edige¡
,
sd£Ë
,
	`sd¦’
(sdsele));

238 
	`sdsä“
(
sd£Ë
);

239 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

241 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

242 } ià(
o
->
ty³
 =ğ
OBJ_MODULE
) {

243 
RedisModuËDige¡
 
md
;

244 
moduËV®ue
 *
mv
 = 
o
->
±r
;

245 
moduËTy³
 *
mt
 = 
mv
->
ty³
;

246 
	`moduËIn™Dige¡CÚ‹xt
(
md
);

247 ià(
mt
->
dige¡
) {

248 
mt
->
	`dige¡
(&
md
,
mv
->
v®ue
);

249 
	`xÜDige¡
(
dige¡
,
md
.
x
,(md.x));

252 
	`£rv”Pªic
("Unknown objectype");

255 ià(
expœ‘ime
 !ğ-1è
	`xÜDige¡
(
dige¡
,"!!expire!!",10);

257 
	`xÜDige¡
(
fš®
,
dige¡
,20);

258 
	`deüRefCouÁ
(
keyobj
);

260 
	`diùR–—£I‹¿tÜ
(
di
);

262 
	}
}

264 
	$debugCommªd
(
ş›Á
 *
c
) {

265 ià(
c
->
¬gc
 == 1) {

266 
	`addR•lyE¼Ü
(
c
,"You must specify‡ subcommand for DEBUG. Try DEBUG HELP for info.");

270 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"help")) {

271 *
bËÅ
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

272 
bËn
 = 0;

273 
bËn
++; 
	`addR•lyStus
(
c
,

275 
bËn
++; 
	`addR•lyStus
(
c
,

277 
bËn
++; 
	`addR•lyStus
(
c
,

279 
bËn
++; 
	`addR•lyStus
(
c
,

281 
bËn
++; 
	`addR•lyStus
(
c
,

283 
bËn
++; 
	`addR•lyStus
(
c
,

285 
bËn
++; 
	`addR•lyStus
(
c
,

287 
bËn
++; 
	`addR•lyStus
(
c
,

289 
bËn
++; 
	`addR•lyStus
(
c
,

291 
bËn
++; 
	`addR•lyStus
(
c
,

293 
bËn
++; 
	`addR•lyStus
(
c
,

295 
bËn
++; 
	`addR•lyStus
(
c
,

297 
bËn
++; 
	`addR•lyStus
(
c
,

299 
bËn
++; 
	`addR•lyStus
(
c
,

301 
bËn
++; 
	`addR•lyStus
(
c
,

303 
bËn
++; 
	`addR•lyStus
(
c
,

305 
bËn
++; 
	`addR•lyStus
(
c
,

307 
bËn
++; 
	`addR•lyStus
(
c
,

309 
bËn
++; 
	`addR•lyStus
(
c
,

311 
bËn
++; 
	`addR•lyStus
(
c
,

313 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
bËÅ
,
bËn
);

314 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"segfault")) {

316 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"panic")) {

317 
	`£rv”Pªic
("DEBUG PANIC c®Ëd‡ˆUnixim%ld", 
	`time
(
NULL
));

318 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"restart") ||

319 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"crash-and-recover"))

321 
d–ay
 = 0;

322 ià(
c
->
¬gc
 >= 3) {

323 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
d–ay
, 
NULL
)

324 !ğ
C_OK
) ;

325 ià(
d–ay
 < 0) delay = 0;

327 
æags
 = !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"restart") ?

328 (
RESTART_SERVER_GRACEFULLY
|
RESTART_SERVER_CONFIG_REWRITE
) :

329 
RESTART_SERVER_NONE
;

330 
	`»¡¬tS”v”
(
æags
,
d–ay
);

331 
	`addR•lyE¼Ü
(
c
,"failedo„estarthe server. Check server†ogs.");

332 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"oom")) {

333 *
±r
 = 
	`zm®loc
(
ULONG_MAX
);

334 
	`zä“
(
±r
);

335 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

336 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"assert")) {

337 ià(
c
->
¬gc
 >ğ3èc->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

338 
	`£rv”As£¹W™hInfo
(
c
,c->
¬gv
[0],1 == 2);

339 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reload")) {

340 
rdbSaveInfo
 
rsi
, *
rsŒ
;

341 
rsŒ
 = 
	`rdbPİuÏ‹SaveInfo
(&
rsi
);

342 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
,
rsŒ
è!ğ
C_OK
) {

343 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

346 
	`em±yDb
(-1,
EMPTYDB_NO_FLAGS
,
NULL
);

347 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
,
NULL
è!ğ
C_OK
) {

348 
	`addR•lyE¼Ü
(
c
,"Errorryingo†oadhe RDB dump");

351 
	`£rv”Log
(
LL_WARNING
,"DB„eloaded by DEBUG RELOAD");

352 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

353 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"loadaof")) {

354 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
è
	`æushAµ’dOÆyFe
(1);

355 
	`em±yDb
(-1,
EMPTYDB_NO_FLAGS
,
NULL
);

356 ià(
	`lßdAµ’dOÆyFe
(
£rv”
.
aof_f’ame
è!ğ
C_OK
) {

357 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

360 
£rv”
.
dœty
 = 0;

361 
	`£rv”Log
(
LL_WARNING
,"Append Only File†oaded by DEBUG LOADAOF");

362 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

363 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"objeù"è&& c->
¬gc
 == 3) {

364 
diùEÁry
 *
de
;

365 
robj
 *
v®
;

366 *
¡»nc
;

368 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[2]->
±r
)è=ğ
NULL
) {

369 
	`addR•ly
(
c
,
sh¬ed
.
nokey”r
);

372 
v®
 = 
	`diùG‘V®
(
de
);

373 
¡»nc
 = 
	`¡rEncodšg
(
v®
->
’codšg
);

375 
exŒa
[138] = {0};

376 ià(
v®
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

377 *
ÃxŒa
 = 
exŒa
;

378 
»maššg
 = (
exŒa
);

379 
quickli¡
 *
ql
 = 
v®
->
±r
;

381 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_nodes:%lu", 
ql
->
Ën
);

382 
ÃxŒa
 +ğ
u£d
;

383 
»maššg
 -ğ
u£d
;

385 
avg
 = ()
ql
->
couÁ
/ql->
Ën
;

386 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_avg_node:%.2f", 
avg
);

387 
ÃxŒa
 +ğ
u£d
;

388 
»maššg
 -ğ
u£d
;

390 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_zli¡_max:%d", 
ql
->
fl
);

391 
ÃxŒa
 +ğ
u£d
;

392 
»maššg
 -ğ
u£d
;

394 
com´es£d
 = 
ql
->
com´ess
 != 0;

395 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_com´es£d:%d", 
com´es£d
);

396 
ÃxŒa
 +ğ
u£d
;

397 
»maššg
 -ğ
u£d
;

399 
sz
 = 0;

400 
quickli¡Node
 *
node
 = 
ql
->
h—d
;‚ode;‚odğnode->
Ãxt
) {

401 
sz
 +ğ
node
->sz;

403 
u£d
 = 
	`¢´štf
(
ÃxŒa
, 
»maššg
, " ql_uncom´es£d_size:%lu", 
sz
);

404 
ÃxŒa
 +ğ
u£d
;

405 
»maššg
 -ğ
u£d
;

408 
	`addR•lyStusFÜm©
(
c
,

412 (*)
v®
, v®->
»fcouÁ
,

413 
¡»nc
, 
	`rdbSavedObjeùL’
(
v®
),

414 
v®
->
Ìu
, 
	`e¡im©eObjeùIdËTime
(v®)/1000, 
exŒa
);

415 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"sd¦’"è&& c->
¬gc
 == 3) {

416 
diùEÁry
 *
de
;

417 
robj
 *
v®
;

418 
sds
 
key
;

420 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[2]->
±r
)è=ğ
NULL
) {

421 
	`addR•ly
(
c
,
sh¬ed
.
nokey”r
);

424 
v®
 = 
	`diùG‘V®
(
de
);

425 
key
 = 
	`diùG‘Key
(
de
);

427 ià(
v®
->
ty³
 !ğ
OBJ_STRING
 || !
	`sdsEncodedObjeù
(val)) {

428 
	`addR•lyE¼Ü
(
c
,"Not‡n sdsƒncoded string.");

430 
	`addR•lyStusFÜm©
(
c
,

433 (è
	`sd¦’
(
key
),

434 (è
	`sd§va
(
key
),

435 (è
	`sdsZm®locSize
(
key
),

436 (è
	`sd¦’
(
v®
->
±r
),

437 (è
	`sd§va
(
v®
->
±r
),

438 (è
	`g‘SŒšgObjeùSdsU£dMemÜy
(
v®
));

440 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"zli¡"è&& c->
¬gc
 == 3) {

441 
robj
 *
o
;

443 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nokey”r
))

444 =ğ
NULL
) ;

446 ià(
o
->
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
) {

447 
	`addR•lyE¼Ü
(
c
,"Not‡n sdsƒncoded string.");

449 
	`zli¡R•r
(
o
->
±r
);

450 
	`addR•lyStus
(
c
,"Ziplist structure…rinted on stdout");

452 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"populate") &&

453 
c
->
¬gc
 >= 3 && c->argc <= 5) {

454 
keys
, 
j
;

455 
robj
 *
key
, *
v®
;

456 
buf
[128];

458 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
keys
, 
NULL
è!ğ
C_OK
)

460 
	`diùEx·nd
(
c
->
db
->
diù
,
keys
);

461 
j
 = 0; j < 
keys
; j++) {

462 
v®size
 = 0;

463 
	`¢´štf
(
buf
,(buf),"%s:%lu",

464 (
c
->
¬gc
 =ğ3è? "key" : (*)c->
¬gv
[3]->
±r
, 
j
);

465 
key
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

466 ià(
c
->
¬gc
 == 5)

467 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[4], &
v®size
, 
NULL
è!ğ
C_OK
)

469 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
è!ğ
NULL
) {

470 
	`deüRefCouÁ
(
key
);

473 
	`¢´štf
(
buf
,(buf),"v®ue:%lu",
j
);

474 ià(
v®size
==0)

475 
v®
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

477 
buæ’
 = 
	`¡¾’
(
buf
);

478 
v®
 = 
	`ü—‹SŒšgObjeù
(
NULL
,
v®size
);

479 
	`memıy
(
v®
->
±r
, 
buf
, 
v®size
<=
buæ’
? valsize: buflen);

481 
	`dbAdd
(
c
->
db
,
key
,
v®
);

482 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

483 
	`deüRefCouÁ
(
key
);

485 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

486 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"dige¡"è&& c->
¬gc
 == 2) {

487 
dige¡
[20];

488 
sds
 
d
 = 
	`sd£m±y
();

489 
j
;

491 
	`compu‹D©a£tDige¡
(
dige¡
);

492 
j
 = 0; j < 20; j++)

493 
d
 = 
	`sdsÿrštf
(d, "%02x",
dige¡
[
j
]);

494 
	`addR•lyStus
(
c
,
d
);

495 
	`sdsä“
(
d
);

496 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦“p"è&& c->
¬gc
 == 3) {

497 
dtime
 = 
	`¡¹od
(
c
->
¬gv
[2]->
±r
,
NULL
);

498 
utime
 = 
dtime
*1000000;

499 
time¥ec
 
tv
;

501 
tv
.
tv_£c
 = 
utime
 / 1000000;

502 
tv
.
tv_n£c
 = (
utime
 % 1000000) * 1000;

503 
	`Çno¦“p
(&
tv
, 
NULL
);

504 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

505 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set-active-expire") &&

506 
c
->
¬gc
 == 3)

508 
£rv”
.
aùive_expœe_’abËd
 = 
	`©oi
(
c
->
¬gv
[2]->
±r
);

509 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

510 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"lua-always-replicate-commands") &&

511 
c
->
¬gc
 == 3)

513 
£rv”
.
lua_®ways_»¶iÿ‹_commªds
 = 
	`©oi
(
c
->
¬gv
[2]->
±r
);

514 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

515 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"”rÜ"è&& c->
¬gc
 == 3) {

516 
sds
 
”r¡r
 = 
	`sd¢ewËn
("-",1);

518 
”r¡r
 = 
	`sdsÿtsds
Ó¼¡r,
c
->
¬gv
[2]->
±r
);

519 
”r¡r
 = 
	`sdsm­ch¬s
(errstr,"\n\r"," ",2);

520 
”r¡r
 = 
	`sdsÿ’
(errstr,"\r\n",2);

521 
	`addR•lySds
(
c
,
”r¡r
);

522 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¡ruùsize"è&& c->
¬gc
 == 2) {

523 
sds
 
sizes
 = 
	`sd£m±y
();

524 
sizes
 = 
	`sdsÿrštf
(sizes,"bits:%d ",((*) == 8)?64:32);

525 
sizes
 = 
	`sdsÿrštf
(sizes,"robj:%d ",()(
robj
));

526 
sizes
 = 
	`sdsÿrštf
(sizes,"diù’Œy:%d ",()(
diùEÁry
));

527 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr5:%d ",()(
sdshdr5
));

528 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr8:%d ",()(
sdshdr8
));

529 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr16:%d ",()(
sdshdr16
));

530 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr32:%d ",()(
sdshdr32
));

531 
sizes
 = 
	`sdsÿrštf
(sizes,"sdshdr64:%d ",()(
sdshdr64
));

532 
	`addR•lyBulkSds
(
c
,
sizes
);

533 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"ht¡©s"è&& c->
¬gc
 == 3) {

534 
dbid
;

535 
sds
 
¡©s
 = 
	`sd£m±y
();

536 
buf
[4096];

538 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
dbid
, 
NULL
è!ğ
C_OK
)

540 ià(
dbid
 < 0 || dbid >ğ
£rv”
.
dbnum
) {

541 
	`addR•lyE¼Ü
(
c
,"Out of„ange database");

545 
¡©s
 = 
	`sdsÿrštf
(stats,"[Dictionary HT]\n");

546 
	`diùG‘Sts
(
buf
,(buf),
£rv”
.
db
[
dbid
].
diù
);

547 
¡©s
 = 
	`sdsÿt
(¡©s,
buf
);

549 
¡©s
 = 
	`sdsÿrštf
(stats,"[Expires HT]\n");

550 
	`diùG‘Sts
(
buf
,(buf),
£rv”
.
db
[
dbid
].
expœes
);

551 
¡©s
 = 
	`sdsÿt
(¡©s,
buf
);

553 
	`addR•lyBulkSds
(
c
,
¡©s
);

554 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"chªge-»¶-id"è&& c->
¬gc
 == 2) {

555 
	`£rv”Log
(
LL_WARNING
,"Changing„eplication IDs‡fter„eceiving DEBUG change-repl-id");

556 
	`chªgeR•liÿtiÚId
();

557 
	`ş—rR•liÿtiÚId2
();

558 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

560 
	`addR•lyE¼ÜFÜm©
(
c
, "Unknown DEBUG subcommand or wrong‚umber of‡rguments for '%s'",

561 (*)
c
->
¬gv
[1]->
±r
);

563 
	}
}

567 
	$_£rv”As£¹
(cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
) {

568 
	`bugR•ÜtS¹
();

569 
	`£rv”Log
(
LL_WARNING
,"=== ASSERTION FAILED ===");

570 
	`£rv”Log
(
LL_WARNING
,"==> %s:%d '%s' i nÙrue",
fe
,
lše
,
e¡r
);

571 #ifdeà
HAVE_BACKTRACE


572 
£rv”
.
as£¹_çed
 = 
e¡r
;

573 
£rv”
.
as£¹_fe
 = 
fe
;

574 
£rv”
.
as£¹_lše
 = 
lše
;

575 
	`£rv”Log
(
LL_WARNING
,"(forcing SIGSEGVo…rinthe bug„eport.)");

578 
	}
}

580 
	$_£rv”As£¹PrštCl›ÁInfo
(cÚ¡ 
ş›Á
 *
c
) {

581 
j
;

583 
	`bugR•ÜtS¹
();

584 
	`£rv”Log
(
LL_WARNING
,"=== ASSERTION FAILED CLIENT CONTEXT ===");

585 
	`£rv”Log
(
LL_WARNING
,"ş›Á->æag ğ%d", 
c
->
æags
);

586 
	`£rv”Log
(
LL_WARNING
,"ş›Á->fd = %d", 
c
->
fd
);

587 
	`£rv”Log
(
LL_WARNING
,"ş›Á->¬gøğ%d", 
c
->
¬gc
);

588 
j
=0; j < 
c
->
¬gc
; j++) {

589 
buf
[128];

590 *
¬g
;

592 ià(
c
->
¬gv
[
j
]->
ty³
 =ğ
OBJ_STRING
 && 
	`sdsEncodedObjeù
(c->argv[j])) {

593 
¬g
 = (*è
c
->
¬gv
[
j
]->
±r
;

595 
	`¢´štf
(
buf
,(buf),"Objectype: %u,ƒncoding: %u",

596 
c
->
¬gv
[
j
]->
ty³
, c->¬gv[j]->
’codšg
);

597 
¬g
 = 
buf
;

599 
	`£rv”Log
(
LL_WARNING
,"client->argv[%d] = \"%s\" (refcount: %d)",

600 
j
, 
¬g
, 
c
->
¬gv
[j]->
»fcouÁ
);

602 
	}
}

604 
	$£rv”LogObjeùDebugInfo
(cÚ¡ 
robj
 *
o
) {

605 
	`£rv”Log
(
LL_WARNING
,"Objeùy³: %d", 
o
->
ty³
);

606 
	`£rv”Log
(
LL_WARNING
,"Objeùƒncodšg: %d", 
o
->
’codšg
);

607 
	`£rv”Log
(
LL_WARNING
,"Objeù„efcouÁ: %d", 
o
->
»fcouÁ
);

608 ià(
o
->
ty³
 =ğ
OBJ_STRING
 && 
	`sdsEncodedObjeù
(o)) {

609 
	`£rv”Log
(
LL_WARNING
,"Objeù„aw sŒšg†’: %zu", 
	`sd¦’
(
o
->
±r
));

610 ià(
	`sd¦’
(
o
->
±r
) < 4096) {

611 
sds
 
»´
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
o
->
±r
,
	`sd¦’
(o->ptr));

612 
	`£rv”Log
(
LL_WARNING
,"Objeù„aw sŒšg cÚ‹Á: %s", 
»´
);

613 
	`sdsä“
(
»´
);

615 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

616 
	`£rv”Log
(
LL_WARNING
,"Li¡†’gth: %d", (è
	`li¡Ty³L’gth
(
o
));

617 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

618 
	`£rv”Log
(
LL_WARNING
,"S‘ size: %d", (è
	`£tTy³Size
(
o
));

619 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

620 
	`£rv”Log
(
LL_WARNING
,"Hash size: %d", (è
	`hashTy³L’gth
(
o
));

621 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

622 
	`£rv”Log
(
LL_WARNING
,"SÜ‹d s‘ size: %d", (è
	`z£tL’gth
(
o
));

623 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
)

624 
	`£rv”Log
(
LL_WARNING
,"Skli¡†ev–: %d", (è((cÚ¡ 
z£t
*)
o
->
±r
)->
z¦
->
Ëv–
);

626 
	}
}

628 
	$_£rv”As£¹PrštObjeù
(cÚ¡ 
robj
 *
o
) {

629 
	`bugR•ÜtS¹
();

630 
	`£rv”Log
(
LL_WARNING
,"=== ASSERTION FAILED OBJECT CONTEXT ===");

631 
	`£rv”LogObjeùDebugInfo
(
o
);

632 
	}
}

634 
	$_£rv”As£¹W™hInfo
(cÚ¡ 
ş›Á
 *
c
, cÚ¡ 
robj
 *
o
, cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
) {

635 ià(
c
è
	`_£rv”As£¹PrštCl›ÁInfo
(c);

636 ià(
o
è
	`_£rv”As£¹PrštObjeù
(o);

637 
	`_£rv”As£¹
(
e¡r
,
fe
,
lše
);

638 
	}
}

640 
	$_£rv”Pªic
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
msg
, ...) {

641 
va_li¡
 
­
;

642 
	`va_¡¬t
(
­
,
msg
);

643 
fmtmsg
[256];

644 
	`v¢´štf
(
fmtmsg
,(fmtmsg),
msg
,
­
);

645 
	`va_’d
(
­
);

647 
	`bugR•ÜtS¹
();

648 
	`£rv”Log
(
LL_WARNING
,"------------------------------------------------");

649 
	`£rv”Log
(
LL_WARNING
,"!!! Software Failure. Press†eft mouse buttono continue");

650 
	`£rv”Log
(
LL_WARNING
,"Guru Med™©iÚ: % #%s:%d",
fmtmsg
,
fe
,
lše
);

651 #ifdeà
HAVE_BACKTRACE


652 
	`£rv”Log
(
LL_WARNING
,"(forcing SIGSEGV in ordero…rinthe stackrace)");

654 
	`£rv”Log
(
LL_WARNING
,"------------------------------------------------");

656 
	}
}

658 
	$bugR•ÜtS¹
() {

659 ià(
£rv”
.
bug_»pÜt_¡¬t
 == 0) {

660 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

662 
£rv”
.
bug_»pÜt_¡¬t
 = 1;

664 
	}
}

666 #ifdeà
HAVE_BACKTRACE


667 *
	$g‘McÚ‹xtE
(
ucÚ‹xt_t
 *
uc
) {

668 #ià
	`defšed
(
__APPLE__
è&& !defšed(
MAC_OS_X_VERSION_10_6
)

670 #ià
	`defšed
(
__x86_64__
)

671  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
;

672 #–ià
	`defšed
(
__i386__
)

673  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
;

675  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__¤r0
;

677 #–ià
	`defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)

679 #ià
	`defšed
(
_STRUCT_X86_THREAD_STATE64
è&& !defšed(
__i386__
)

680  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
;

682  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
;

684 #–ià
	`defšed
(
__lšux__
)

686 #ià
	`defšed
(
__i386__
)

687  (*è
uc
->
uc_mcÚ‹xt
.
g»gs
[14];

688 #–ià
	`defšed
(
__X86_64__
è|| defšed(
__x86_64__
)

689  (*è
uc
->
uc_mcÚ‹xt
.
g»gs
[16];

690 #–ià
	`defšed
(
__Ÿ64__
)

691  (*è
uc
->
uc_mcÚ‹xt
.
sc_
;

692 #–ià
	`defšed
(
__¬m__
)

693  (*è
uc
->
uc_mcÚ‹xt
.
¬m_pc
;

696  
NULL
;

698 
	}
}

700 
	$logSckCÚ‹Á
(**
¥
) {

701 
i
;

702 
i
 = 15; i >= 0; i--) {

703 
addr
 = (è
¥
+
i
;

704 
v®
 = (è
¥
[
i
];

707 
	`£rv”Log
(
LL_WARNING
, "(%08lxè-> %08lx", 
addr
, 
v®
);

709 
	`£rv”Log
(
LL_WARNING
, "(%016lxè-> %016lx", 
addr
, 
v®
);

711 
	}
}

713 
	$logRegi¡”s
(
ucÚ‹xt_t
 *
uc
) {

714 
	`£rv”Log
(
LL_WARNING
|
LL_RAW
, "\n------ REGISTERS ------\n");

717 #ià
	`defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)

719 #ià
	`defšed
(
_STRUCT_X86_THREAD_STATE64
è&& !defšed(
__i386__
)

720 
	`£rv”Log
(
LL_WARNING
,

727 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__¿x
,

728 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rbx
,

729 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rcx
,

730 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rdx
,

731 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rdi
,

732 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rsi
,

733 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rbp
,

734 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r¥
,

735 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r8
,

736 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r9
,

737 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r10
,

738 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r11
,

739 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r12
,

740 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r13
,

741 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r14
,

742 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r15
,

743 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
,

744 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ræags
,

745 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__cs
,

746 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__fs
,

747 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__gs


749 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
->
__ss
.
__r¥
);

752 
	`£rv”Log
(
LL_WARNING
,

758 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__—x
,

759 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ebx
,

760 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ecx
,

761 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__edx
,

762 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__edi
,

763 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__esi
,

764 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ebp
,

765 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e¥
,

766 (è
uc
->
uc_mcÚ‹xt
->
__ss
.__ss,

767 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__eæags
,

768 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
,

769 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__cs
,

770 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ds
,

771 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__es
,

772 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__fs
,

773 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__gs


775 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
->
__ss
.
__e¥
);

778 #–ià
	`defšed
(
__lšux__
)

780 #ià
	`defšed
(
__i386__
)

781 
	`£rv”Log
(
LL_WARNING
,

787 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[11],

788 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[8],

789 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[10],

790 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[9],

791 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[4],

792 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[5],

793 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[6],

794 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[7],

795 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[18],

796 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[17],

797 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[14],

798 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[15],

799 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[3],

800 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[2],

801 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[1],

802 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[0]

804 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
.
g»gs
[7]);

805 #–ià
	`defšed
(
__X86_64__
è|| defšed(
__x86_64__
)

807 
	`£rv”Log
(
LL_WARNING
,

814 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[13],

815 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[11],

816 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[14],

817 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[12],

818 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[8],

819 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[9],

820 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[10],

821 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[15],

822 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[0],

823 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[1],

824 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[2],

825 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[3],

826 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[4],

827 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[5],

828 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[6],

829 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[7],

830 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[16],

831 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[17],

832 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[18]

834 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
.
g»gs
[15]);

837 
	`£rv”Log
(
LL_WARNING
,

840 
	}
}

848 
	$İ’DœeùLogFedes
() {

849 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

850 
fd
 = 
log_to_¡dout
 ?

851 
STDOUT_FILENO
 :

852 
	`İ’
(
£rv”
.
logfe
, 
O_APPEND
|
O_CREAT
|
O_WRONLY
, 0644);

853  
fd
;

854 
	}
}

857 
	$şo£DœeùLogFedes
(
fd
) {

858 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

859 ià(!
log_to_¡dout
è
	`şo£
(
fd
);

860 
	}
}

864 
	$logSckT¿û
(
ucÚ‹xt_t
 *
uc
) {

865 *
Œaû
[101];

866 
Œaû_size
 = 0, 
fd
 = 
	`İ’DœeùLogFedes
();

868 ià(
fd
 == -1) ;

871 
Œaû_size
 = 
	`backŒaû
(
Œaû
+1, 100);

873 ià(
	`g‘McÚ‹xtE
(
uc
è!ğ
NULL
) {

874 *
msg1
 = "EIP:\n";

875 *
msg2
 = "\nBacktrace:\n";

876 ià(
	`wr™e
(
fd
,
msg1
,
	`¡¾’
(msg1)) == -1) { };

877 
Œaû
[0] = 
	`g‘McÚ‹xtE
(
uc
);

878 
	`backŒaû_symbŞs_fd
(
Œaû
, 1, 
fd
);

879 ià(
	`wr™e
(
fd
,
msg2
,
	`¡¾’
(msg2)) == -1) { };

883 
	`backŒaû_symbŞs_fd
(
Œaû
+1, 
Œaû_size
, 
fd
);

886 
	`şo£DœeùLogFedes
(
fd
);

887 
	}
}

892 
	$logCu¼’tCl›Á
() {

893 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
NULL
) ;

895 
ş›Á
 *
cc
 = 
£rv”
.
cu¼’t_ş›Á
;

896 
sds
 
ş›Á
;

897 
j
;

899 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ CURRENT CLIENT INFO ------\n");

900 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
cc
);

901 
	`£rv”Log
(
LL_WARNING
|
LL_RAW
,"%s\n", 
ş›Á
);

902 
	`sdsä“
(
ş›Á
);

903 
j
 = 0; j < 
cc
->
¬gc
; j++) {

904 
robj
 *
decoded
;

906 
decoded
 = 
	`g‘DecodedObjeù
(
cc
->
¬gv
[
j
]);

907 
	`£rv”Log
(
LL_WARNING
|
LL_RAW
,"¬gv[%d]: '%s'\n", 
j
,

908 (*)
decoded
->
±r
);

909 
	`deüRefCouÁ
(
decoded
);

913 ià(
cc
->
¬gc
 >= 1) {

914 
robj
 *
v®
, *
key
;

915 
diùEÁry
 *
de
;

917 
key
 = 
	`g‘DecodedObjeù
(
cc
->
¬gv
[1]);

918 
de
 = 
	`diùFšd
(
cc
->
db
->
diù
, 
key
->
±r
);

919 ià(
de
) {

920 
v®
 = 
	`diùG‘V®
(
de
);

921 
	`£rv”Log
(
LL_WARNING
,"key '%s' found iÀDB cÚššghfŞlowšg objeù:", (*)
key
->
±r
);

922 
	`£rv”LogObjeùDebugInfo
(
v®
);

924 
	`deüRefCouÁ
(
key
);

926 
	}
}

928 #ià
defšed
(
HAVE_PROC_MAPS
)

930 
	#MEMTEST_MAX_REGIONS
 128

	)

933 
	$mem‹¡_‹¡_lšux_ªÚymous_m­s
() {

934 
FILE
 *
å
;

935 
lše
[1024];

936 
logbuf
[1024];

937 
size_t
 
¡¬t_addr
, 
’d_addr
, 
size
;

938 
size_t
 
¡¬t_veù
[
MEMTEST_MAX_REGIONS
];

939 
size_t
 
size_veù
[
MEMTEST_MAX_REGIONS
];

940 
»giÚs
 = 0, 
j
;

942 
fd
 = 
	`İ’DœeùLogFedes
();

943 ià(!
fd
)  0;

945 
å
 = 
	`fİ’
("/proc/self/maps","r");

946 ià(!
å
)  0;

947 
	`fg‘s
(
lše
,Öše),
å
è!ğ
NULL
) {

948 *
¡¬t
, *
’d
, *
p
 = 
lše
;

950 
¡¬t
 = 
p
;

951 
p
 = 
	`¡rchr
(p,'-');

952 ià(!
p
) ;

953 *
p
++ = '\0';

954 
’d
 = 
p
;

955 
p
 = 
	`¡rchr
(p,' ');

956 ià(!
p
) ;

957 *
p
++ = '\0';

958 ià(
	`¡r¡r
(
p
,"stack") ||

959 
	`¡r¡r
(
p
,"vdso") ||

960 
	`¡r¡r
(
p
,"vsyscall")) ;

961 ià(!
	`¡r¡r
(
p
,"00:00")) ;

962 ià(!
	`¡r¡r
(
p
,"rw")) ;

964 
¡¬t_addr
 = 
	`¡¹oul
(
¡¬t
,
NULL
,16);

965 
’d_addr
 = 
	`¡¹oul
(
’d
,
NULL
,16);

966 
size
 = 
’d_addr
-
¡¬t_addr
;

968 
¡¬t_veù
[
»giÚs
] = 
¡¬t_addr
;

969 
size_veù
[
»giÚs
] = 
size
;

970 
	`¢´štf
(
logbuf
,(logbuf),

972 (è
¡¬t_veù
[
»giÚs
],

973 (è
size_veù
[
»giÚs
]);

974 ià(
	`wr™e
(
fd
,
logbuf
,
	`¡¾’
(logbuf)) == -1) { }

975 
»giÚs
++;

978 
”rÜs
 = 0;

979 
j
 = 0; j < 
»giÚs
; j++) {

980 ià(
	`wr™e
(
fd
,".",1) == -1) { }

981 
”rÜs
 +ğ
	`mem‹¡_´e£rvšg_‹¡
((*)
¡¬t_veù
[
j
],
size_veù
[j],1);

982 ià(
	`wr™e
(
fd
, 
”rÜs
 ? "E" : "O",1) == -1) { }

984 ià(
	`wr™e
(
fd
,"\n",1) == -1) { }

989 
	`fşo£
(
å
);

990 
	`şo£DœeùLogFedes
(
fd
);

991  
”rÜs
;

992 
	}
}

998 
	$dumpX86C®ls
(*
addr
, 
size_t
 
Ën
) {

999 
size_t
 
j
;

1000 *
p
 = 
addr
;

1001 
Dl_šfo
 
šfo
;

1004 
ht
[256] = {0};

1006 ià(
Ën
 < 5) ;

1007 
j
 = 0; j < 
Ën
-4; j++) {

1008 ià(
p
[
j
] != 0xE8) ;

1009 
rg‘
 = ()
addr
+
j
+5;

1010 
rg‘
 +ğ*((
št32_t
*)(
p
+
j
+1));

1011 ià(
	`dÏddr
((*)
rg‘
, &
šfo
è!ğ0 && info.
dli_¢ame
 !ğ
NULL
) {

1012 ià(
ht
[
rg‘
&0xff] !=arget) {

1013 
	`´štf
("FunùiÚ‡ˆ0x%lx i %s\n",
rg‘
,
šfo
.
dli_¢ame
);

1014 
ht
[
rg‘
&0xff] =arget;

1016 
j
 += 4;

1019 
	}
}

1021 
	$sig£gvHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
) {

1022 
ucÚ‹xt_t
 *
uc
 = (ucÚ‹xt_t*è
£ü‘
;

1023 *
e
 = 
	`g‘McÚ‹xtE
(
uc
);

1024 
sds
 
šfo¡ršg
, 
ş›Ás
;

1025 
sigaùiÚ
 
aù
;

1026 
	`UNUSED
(
šfo
);

1028 
	`bugR•ÜtS¹
();

1029 
	`£rv”Log
(
LL_WARNING
,

1030 "Redi % üashed by sigÇl: %d", 
REDIS_VERSION
, 
sig
);

1031 ià(
e
 !ğ
NULL
) {

1032 
	`£rv”Log
(
LL_WARNING
,

1033 "C¿shed„uÂšghš¡ruùiÚ‡t: %p", 
e
);

1035 ià(
sig
 =ğ
SIGSEGV
 || sig =ğ
SIGBUS
) {

1036 
	`£rv”Log
(
LL_WARNING
,

1037 "Acûssšg‡dd»ss: %p", (*)
šfo
->
si_addr
);

1039 
	`£rv”Log
(
LL_WARNING
,

1040 "Faed‡s£¹iÚ: % (%s:%d)", 
£rv”
.
as£¹_çed
,

1041 
£rv”
.
as£¹_fe
, s”v”.
as£¹_lše
);

1044 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ STACK TRACE ------\n");

1045 
	`logSckT¿û
(
uc
);

1048 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ INFO OUTPUT ------\n");

1049 
šfo¡ršg
 = 
	`g’RedisInfoSŒšg
("all");

1050 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, 
šfo¡ršg
);

1051 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ CLIENT LIST OUTPUT ------\n");

1052 
ş›Ás
 = 
	`g‘AÎCl›ÁsInfoSŒšg
();

1053 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, 
ş›Ás
);

1054 
	`sdsä“
(
šfo¡ršg
);

1055 
	`sdsä“
(
ş›Ás
);

1058 
	`logCu¼’tCl›Á
();

1061 
	`logRegi¡”s
(
uc
);

1063 #ià
	`defšed
(
HAVE_PROC_MAPS
)

1065 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
, "\n------ FAST MEMORY TEST ------\n");

1066 
	`bioKlTh»ads
();

1067 ià(
	`mem‹¡_‹¡_lšux_ªÚymous_m­s
()) {

1068 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

1071 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

1076 ià(
e
 !ğ
NULL
) {

1077 
Dl_šfo
 
šfo
;

1078 ià(
	`dÏddr
(
e
, &
šfo
) != 0) {

1079 
	`£rv”Log
(
LL_WARNING
|
LL_RAW
,

1086 
šfo
.
dli_¢ame
, info.
dli_§ddr
, info.
dli_âame
, info.
dli_fba£
,

1087 
šfo
.
dli_§ddr
);

1088 
size_t
 
Ën
 = ()
e
 - ()
šfo
.
dli_§ddr
;

1089 
sz
 = 
	`syscÚf
(
_SC_PAGESIZE
);

1090 ià(
Ën
 < 1<<13) {

1094 
Ãxt
 = (()
e
 + 
sz
) & ~(sz-1);

1095 
’d
 = ()
e
 + 128;

1096 ià(
’d
 > 
Ãxt
)ƒnd =‚ext;

1097 
Ën
 = 
’d
 - ()
šfo
.
dli_§ddr
;

1098 
	`£rv”LogHexDump
(
LL_WARNING
, "dump of function",

1099 
šfo
.
dli_§ddr
 ,
Ën
);

1100 
	`dumpX86C®ls
(
šfo
.
dli_§ddr
,
Ën
);

1105 
	`£rv”LogRaw
(
LL_WARNING
|
LL_RAW
,

1113 ià(
£rv”
.
d«mÚize
 && s”v”.
su³rvi£d
 =ğ0è
	`uÆšk
(£rv”.
pidfe
);

1117 
	`sigem±y£t
 (&
aù
.
§_mask
);

1118 
aù
.
§_æags
 = 
SA_NODEFER
 | 
SA_ONSTACK
 | 
SA_RESETHAND
;

1119 
aù
.
§_hªdËr
 = 
SIG_DFL
;

1120 
	`sigaùiÚ
 (
sig
, &
aù
, 
NULL
);

1121 
	`kl
(
	`g‘pid
(),
sig
);

1122 
	}
}

1127 
	$£rv”LogHexDump
(
Ëv–
, *
desü
, *
v®ue
, 
size_t
 
Ën
) {

1128 
buf
[65], *
b
;

1129 *
v
 = 
v®ue
;

1130 
ch¬£t
[] = "0123456789abcdef";

1132 
	`£rv”Log
(
Ëv–
,"% (hexdum°oà%zu by‹s):", 
desü
, 
Ën
);

1133 
b
 = 
buf
;

1134 
Ën
) {

1135 
b
[0] = 
ch¬£t
[(*
v
)>>4];

1136 
b
[1] = 
ch¬£t
[(*
v
)&0xf];

1137 
b
[2] = '\0';

1138 
b
 += 2;

1139 
Ën
--;

1140 
v
++;

1141 ià(
b
-
buf
 =ğ64 || 
Ën
 == 0) {

1142 
	`£rv”LogRaw
(
Ëv–
|
LL_RAW
,
buf
);

1143 
b
 = 
buf
;

1146 
	`£rv”LogRaw
(
Ëv–
|
LL_RAW
,"\n");

1147 
	}
}

1150 
	~<sys/time.h
>

1152 
	$w©chdogSigÇlHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
) {

1153 #ifdeà
HAVE_BACKTRACE


1154 
ucÚ‹xt_t
 *
uc
 = (ucÚ‹xt_t*è
£ü‘
;

1156 
	`UNUSED
(
šfo
);

1157 
	`UNUSED
(
sig
);

1159 
	`£rv”LogFromHªdËr
(
LL_WARNING
,"\n--- WATCHDOG TIMER EXPIRED ---");

1160 #ifdeà
HAVE_BACKTRACE


1161 
	`logSckT¿û
(
uc
);

1163 
	`£rv”LogFromHªdËr
(
LL_WARNING
,"Sorry:‚o support for backtrace().");

1165 
	`£rv”LogFromHªdËr
(
LL_WARNING
,"--------\n");

1166 
	}
}

1171 
	$w©chdogScheduËSigÇl
(
³riod
) {

1172 
™im”v®
 
™
;

1175 
™
.
™_v®ue
.
tv_£c
 = 
³riod
/1000;

1176 
™
.
™_v®ue
.
tv_u£c
 = (
³riod
%1000)*1000;

1178 
™
.
™_š‹rv®
.
tv_£c
 = 0;

1179 
™
.
™_š‹rv®
.
tv_u£c
 = 0;

1180 
	`£t™im”
(
ITIMER_REAL
, &
™
, 
NULL
);

1181 
	}
}

1184 
	$’abËW©chdog
(
³riod
) {

1185 
mš_³riod
;

1187 ià(
£rv”
.
w©chdog_³riod
 == 0) {

1188 
sigaùiÚ
 
aù
;

1192 
	`sigem±y£t
(&
aù
.
§_mask
);

1193 
aù
.
§_æags
 = 
SA_ONSTACK
 | 
SA_SIGINFO
;

1194 
aù
.
§_sigaùiÚ
 = 
w©chdogSigÇlHªdËr
;

1195 
	`sigaùiÚ
(
SIGALRM
, &
aù
, 
NULL
);

1200 
mš_³riod
 = (1000/
£rv”
.
hz
)*2;

1201 ià(
³riod
 < 
mš_³riod
)…eriod = min_period;

1202 
	`w©chdogScheduËSigÇl
(
³riod
);

1203 
£rv”
.
w©chdog_³riod
 = 
³riod
;

1204 
	}
}

1207 
	$di§bËW©chdog
() {

1208 
sigaùiÚ
 
aù
;

1209 ià(
£rv”
.
w©chdog_³riod
 == 0) ;

1210 
	`w©chdogScheduËSigÇl
(0);

1214 
	`sigem±y£t
(&
aù
.
§_mask
);

1215 
aù
.
§_æags
 = 0;

1216 
aù
.
§_hªdËr
 = 
SIG_IGN
;

1217 
	`sigaùiÚ
(
SIGALRM
, &
aù
, 
NULL
);

1218 
£rv”
.
w©chdog_³riod
 = 0;

1219 
	}
}

	@src/debugmacro.h

33 
	~<¡dio.h
>

34 
	#D
(...) \

36 
FILE
 *
å
 = 
	`fİ’
("/tmp/log.txt","a"); \

37 
	`årštf
(
å
,"%s:%s:%d:\t", 
__FILE__
, 
__func__
, 
__LINE__
); \

38 
	`årštf
(
å
,
__VA_ARGS__
); \

39 
	`årštf
(
å
,"\n"); \

40 
	`fşo£
(
å
); \

41 } 0);

	)

	@src/defrag.c

37 
	~"£rv”.h
"

38 
	~<time.h
>

39 
	~<as£¹.h
>

40 
	~<¡ddef.h
>

42 #ifdeà
HAVE_DEFRAG


46 
je_g‘_deäag_hšt
(* 
±r
, *
bš_ut
, *
run_ut
);

53 * 
	$aùiveDeäagAÎoc
(*
±r
) {

54 
bš_ut
, 
run_ut
;

55 
size_t
 
size
;

56 *
Ãw±r
;

57 if(!
	`je_g‘_deäag_hšt
(
±r
, &
bš_ut
, &
run_ut
)) {

58 
£rv”
.
¡©_aùive_deäag_mis£s
++;

59  
NULL
;

64 ià(
run_ut
 > 
bš_ut
 ||„un_util == 1<<16) {

65 
£rv”
.
¡©_aùive_deäag_mis£s
++;

66  
NULL
;

71 
size
 = 
	`zm®loc_size
(
±r
);

72 
Ãw±r
 = 
	`zm®loc_no_tÿche
(
size
);

73 
	`memıy
(
Ãw±r
, 
±r
, 
size
);

74 
	`zä“_no_tÿche
(
±r
);

75  
Ãw±r
;

76 
	}
}

83 
sds
 
	$aùiveDeäagSds
(
sds
 
sd¥Œ
) {

84 * 
±r
 = 
	`sdsAÎocPŒ
(
sd¥Œ
);

85 * 
Ãw±r
 = 
	`aùiveDeäagAÎoc
(
±r
);

86 ià(
Ãw±r
) {

87 
size_t
 
off£t
 = 
sd¥Œ
 - (*)
±r
;

88 
sd¥Œ
 = (*)
Ãw±r
 + 
off£t
;

89  
sd¥Œ
;

91  
NULL
;

92 
	}
}

99 
robj
 *
	$aùiveDeäagSŒšgOb
(
robj
* 
ob
, *
deäagged
) {

100 
robj
 *
»t
 = 
NULL
;

101 ià(
ob
->
»fcouÁ
!=1)

102  
NULL
;

105 ià(
ob
->
ty³
!=
OBJ_STRING
 || ob->
’codšg
!=
OBJ_ENCODING_EMBSTR
) {

106 ià((
»t
 = 
	`aùiveDeäagAÎoc
(
ob
))) {

107 
ob
 = 
»t
;

108 (*
deäagged
)++;

113 ià(
ob
->
ty³
 =ğ
OBJ_STRING
) {

114 if(
ob
->
’codšg
==
OBJ_ENCODING_RAW
) {

115 
sds
 
Ãwsds
 = 
	`aùiveDeäagSds
((sds)
ob
->
±r
);

116 ià(
Ãwsds
) {

117 
ob
->
±r
 = 
Ãwsds
;

118 (*
deäagged
)++;

120 } ià(
ob
->
’codšg
==
OBJ_ENCODING_EMBSTR
) {

123 
ofs
 = (
šŒ_t
)
ob
->
±r
 - (intptr_t)ob;

124 ià((
»t
 = 
	`aùiveDeäagAÎoc
(
ob
))) {

125 
»t
->
±r
 = (*)((
šŒ_t
ì‘ + 
ofs
);

126 (*
deäagged
)++;

128 } ià(
ob
->
’codšg
!=
OBJ_ENCODING_INT
) {

129 
	`£rv”Pªic
("Unknown stringƒncoding");

132  
»t
;

133 
	}
}

137 
	$diùI‹rDeäagEÁry
(
diùI‹¿tÜ
 *
™”
) {

141 
deäagged
 = 0;

142 
diùht
 *
ht
;

145 ià(
™”
->
ÃxtEÁry
) {

146 
diùEÁry
 *
Ãwde
 = 
	`aùiveDeäagAÎoc
(
™”
->
ÃxtEÁry
);

147 ià(
Ãwde
) {

148 
deäagged
++;

149 
™”
->
ÃxtEÁry
 = 
Ãwde
;

150 
™”
->
’Œy
->
Ãxt
 = 
Ãwde
;

154 
ht
 = &
™”
->
d
->ht[™”->
bË
];

155 ià(
ht
->
bË
[
™”
->
šdex
] =ğ™”->
’Œy
) {

156 
diùEÁry
 *
Ãwde
 = 
	`aùiveDeäagAÎoc
(
™”
->
’Œy
);

157 ià(
Ãwde
) {

158 
™”
->
’Œy
 = 
Ãwde
;

159 
ht
->
bË
[
™”
->
šdex
] = 
Ãwde
;

160 
deäagged
++;

163  
deäagged
;

164 
	}
}

169 
	$diùDeäagTabËs
(
diù
** 
diùRef
) {

170 
diù
 *
d
 = *
diùRef
;

171 
diùEÁry
 **
ÃwbË
;

172 
deäagged
 = 0;

174 
diù
 *
Ãwd
 = 
	`aùiveDeäagAÎoc
(
d
);

175 ià(
Ãwd
)

176 
deäagged
++, *
diùRef
 = 
d
 = 
Ãwd
;

178 
ÃwbË
 = 
	`aùiveDeäagAÎoc
(
d
->
ht
[0].
bË
);

179 ià(
ÃwbË
)

180 
deäagged
++, 
d
->
ht
[0].
bË
 = 
ÃwbË
;

182 ià(
d
->
ht
[1].
bË
) {

183 
ÃwbË
 = 
	`aùiveDeäagAÎoc
(
d
->
ht
[1].
bË
);

184 ià(
ÃwbË
)

185 
deäagged
++, 
d
->
ht
[1].
bË
 = 
ÃwbË
;

187  
deäagged
;

188 
	}
}

191 
	$z¦Upd©eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
Şdnode
, zskli¡Nod*
Ãwnode
, zskli¡Nod**
upd©e
) {

192 
i
;

193 
i
 = 0; i < 
z¦
->
Ëv–
; i++) {

194 ià(
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 =ğ
Şdnode
)

195 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
Ãwnode
;

197 
	`£rv”As£¹
(
z¦
->
h—d”
!=
Şdnode
);

198 ià(
Ãwnode
->
Ëv–
[0].
fÜw¬d
) {

199 
	`£rv”As£¹
(
Ãwnode
->
Ëv–
[0].
fÜw¬d
->
backw¬d
==
Şdnode
);

200 
Ãwnode
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 =‚ewnode;

202 
	`£rv”As£¹
(
z¦
->

==
Şdnode
);

203 
z¦
->

 = 
Ãwnode
;

205 
	}
}

214 *
	$z¦Deäag
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
Şd–e
, sd 
Ãw–e
) {

215 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
, *
Ãwx
;

216 
i
;

217 
sds
 
–e
 = 
Ãw–e
?‚ew–e: 
Şd–e
;

221 
x
 = 
z¦
->
h—d”
;

222 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

223 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

224 
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
 !ğ
Şd–e
 &&

227 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

228 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

229 
	`sdscmp
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,ele) < 0)))

230 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

231 
upd©e
[
i
] = 
x
;

235 
x
 = x->
Ëv–
[0].
fÜw¬d
;

236 
	`£rv”As£¹
(
x
 && 
scÜe
 =ğx->scÜ&& x->
–e
==
Şd–e
);

237 ià(
Ãw–e
)

238 
x
->
–e
 = 
Ãw–e
;

241 
Ãwx
 = 
	`aùiveDeäagAÎoc
(
x
);

242 ià(
Ãwx
) {

243 
	`z¦Upd©eNode
(
z¦
, 
x
, 
Ãwx
, 
upd©e
);

244  &
Ãwx
->
scÜe
;

246  
NULL
;

247 
	}
}

256 
diùEÁry
* 
	$»¶aûS©–™eDiùKeyPŒAndOrDeäagDiùEÁry
(
diù
 *
d
, 
sds
 
Şdkey
, sd 
Ãwkey
, 
hash
, *
deäagged
) {

257 
diùEÁry
 **
d”ef
 = 
	`diùFšdEÁryRefByPŒAndHash
(
d
, 
Şdkey
, 
hash
);

258 ià(
d”ef
) {

259 
diùEÁry
 *
de
 = *
d”ef
;

260 
diùEÁry
 *
Ãwde
 = 
	`aùiveDeäagAÎoc
(
de
);

261 ià(
Ãwde
) {

262 
de
 = *
d”ef
 = 
Ãwde
;

263 (*
deäagged
)++;

265 ià(
Ãwkey
)

266 
de
->
key
 = 
Ãwkey
;

267  
de
;

269  
NULL
;

270 
	}
}

275 
	$deäagKey
(
»disDb
 *
db
, 
diùEÁry
 *
de
) {

276 
sds
 
keysds
 = 
	`diùG‘Key
(
de
);

277 
robj
 *
Ãwob
, *
ob
;

278 *
Ãwzl
;

279 
diù
 *
d
;

280 
diùI‹¿tÜ
 *
di
;

281 
deäagged
 = 0;

282 
sds
 
Ãwsds
;

285 
Ãwsds
 = 
	`aùiveDeäagSds
(
keysds
);

286 ià(
Ãwsds
)

287 
deäagged
++, 
de
->
key
 = 
Ãwsds
;

288 ià(
	`diùSize
(
db
->
expœes
)) {

292 
ušt64_t
 
hash
 = 
	`diùG‘Hash
(
db
->
diù
, 
de
->
key
);

293 
	`»¶aûS©–™eDiùKeyPŒAndOrDeäagDiùEÁry
(
db
->
expœes
, 
keysds
, 
Ãwsds
, 
hash
, &
deäagged
);

297 
ob
 = 
	`diùG‘V®
(
de
);

298 ià((
Ãwob
 = 
	`aùiveDeäagSŒšgOb
(
ob
, &
deäagged
))) {

299 
de
->
v
.
v®
 = 
Ãwob
;

300 
ob
 = 
Ãwob
;

303 ià(
ob
->
ty³
 =ğ
OBJ_STRING
) {

305 } ià(
ob
->
ty³
 =ğ
OBJ_LIST
) {

306 ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

307 
quickli¡
 *
ql
 = 
ob
->
±r
, *
Ãwql
;

308 
quickli¡Node
 *
node
 = 
ql
->
h—d
, *
Ãwnode
;

309 ià((
Ãwql
 = 
	`aùiveDeäagAÎoc
(
ql
)))

310 
deäagged
++, 
ob
->
±r
 = 
ql
 = 
Ãwql
;

311 
node
) {

312 ià((
Ãwnode
 = 
	`aùiveDeäagAÎoc
(
node
))) {

313 ià(
Ãwnode
->
´ev
)

314 
Ãwnode
->
´ev
->
Ãxt
 =‚ewnode;

316 
ql
->
h—d
 = 
Ãwnode
;

317 ià(
Ãwnode
->
Ãxt
)

318 
Ãwnode
->
Ãxt
->
´ev
 =‚ewnode;

320 
ql
->

 = 
Ãwnode
;

321 
node
 = 
Ãwnode
;

322 
deäagged
++;

324 ià((
Ãwzl
 = 
	`aùiveDeäagAÎoc
(
node
->
zl
)))

325 
deäagged
++, 
node
->
zl
 = 
Ãwzl
;

326 
node
 =‚ode->
Ãxt
;

328 } ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

329 ià((
Ãwzl
 = 
	`aùiveDeäagAÎoc
(
ob
->
±r
)))

330 
deäagged
++, 
ob
->
±r
 = 
Ãwzl
;

332 
	`£rv”Pªic
("Unknown†istƒncoding");

334 } ià(
ob
->
ty³
 =ğ
OBJ_SET
) {

335 ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

336 
d
 = 
ob
->
±r
;

337 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

338 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

339 
sds
 
sd£Ë
 = 
	`diùG‘Key
(
de
);

340 ià((
Ãwsds
 = 
	`aùiveDeäagSds
(
sd£Ë
)))

341 
deäagged
++, 
de
->
key
 = 
Ãwsds
;

342 
deäagged
 +ğ
	`diùI‹rDeäagEÁry
(
di
);

344 
	`diùR–—£I‹¿tÜ
(
di
);

345 
	`diùDeäagTabËs
((
diù
**)&
ob
->
±r
);

346 } ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

347 
št£t
 *
is
 = 
ob
->
±r
;

348 
št£t
 *
Ãwis
 = 
	`aùiveDeäagAÎoc
(
is
);

349 ià(
Ãwis
)

350 
deäagged
++, 
ob
->
±r
 = 
Ãwis
;

352 
	`£rv”Pªic
("Unknown setƒncoding");

354 } ià(
ob
->
ty³
 =ğ
OBJ_ZSET
) {

355 ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

356 ià((
Ãwzl
 = 
	`aùiveDeäagAÎoc
(
ob
->
±r
)))

357 
deäagged
++, 
ob
->
±r
 = 
Ãwzl
;

358 } ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

359 
z£t
 *
zs
 = (z£t*)
ob
->
±r
;

360 
z£t
 *
Ãwzs
;

361 
zskli¡
 *
Ãwz¦
;

362 
zskli¡Node
 *
Ãwh—d”
;

363 ià((
Ãwzs
 = 
	`aùiveDeäagAÎoc
(
zs
)))

364 
deäagged
++, 
ob
->
±r
 = 
zs
 = 
Ãwzs
;

365 ià((
Ãwz¦
 = 
	`aùiveDeäagAÎoc
(
zs
->
z¦
)))

366 
deäagged
++, 
zs
->
z¦
 = 
Ãwz¦
;

367 ià((
Ãwh—d”
 = 
	`aùiveDeäagAÎoc
(
zs
->
z¦
->
h—d”
)))

368 
deäagged
++, 
zs
->
z¦
->
h—d”
 = 
Ãwh—d”
;

369 
d
 = 
zs
->
diù
;

370 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

371 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

372 * 
ÃwscÜe
;

373 
sds
 
sd£Ë
 = 
	`diùG‘Key
(
de
);

374 ià((
Ãwsds
 = 
	`aùiveDeäagSds
(
sd£Ë
)))

375 
deäagged
++, 
de
->
key
 = 
Ãwsds
;

376 
ÃwscÜe
 = 
	`z¦Deäag
(
zs
->
z¦
, *(*)
	`diùG‘V®
(
de
), 
sd£Ë
, 
Ãwsds
);

377 ià(
ÃwscÜe
) {

378 
	`diùS‘V®
(
d
, 
de
, 
ÃwscÜe
);

379 
deäagged
++;

381 
deäagged
 +ğ
	`diùI‹rDeäagEÁry
(
di
);

383 
	`diùR–—£I‹¿tÜ
(
di
);

384 
	`diùDeäagTabËs
(&
zs
->
diù
);

386 
	`£rv”Pªic
("Unknown sorted setƒncoding");

388 } ià(
ob
->
ty³
 =ğ
OBJ_HASH
) {

389 ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

390 ià((
Ãwzl
 = 
	`aùiveDeäagAÎoc
(
ob
->
±r
)))

391 
deäagged
++, 
ob
->
±r
 = 
Ãwzl
;

392 } ià(
ob
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

393 
d
 = 
ob
->
±r
;

394 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

395 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

396 
sds
 
sd£Ë
 = 
	`diùG‘Key
(
de
);

397 ià((
Ãwsds
 = 
	`aùiveDeäagSds
(
sd£Ë
)))

398 
deäagged
++, 
de
->
key
 = 
Ãwsds
;

399 
sd£Ë
 = 
	`diùG‘V®
(
de
);

400 ià((
Ãwsds
 = 
	`aùiveDeäagSds
(
sd£Ë
)))

401 
deäagged
++, 
de
->
v
.
v®
 = 
Ãwsds
;

402 
deäagged
 +ğ
	`diùI‹rDeäagEÁry
(
di
);

404 
	`diùR–—£I‹¿tÜ
(
di
);

405 
	`diùDeäagTabËs
((
diù
**)&
ob
->
±r
);

407 
	`£rv”Pªic
("Unknown hashƒncoding");

409 } ià(
ob
->
ty³
 =ğ
OBJ_MODULE
) {

413 
	`£rv”Pªic
("Unknown objectype");

415  
deäagged
;

416 
	}
}

419 
	$deäagSÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
) {

420 
deäagged
 = 
	`deäagKey
((
»disDb
*)
´ivd©a
, (
diùEÁry
*)
de
);

421 
£rv”
.
¡©_aùive_deäag_h™s
 +ğ
deäagged
;

422 if(
deäagged
)

423 
£rv”
.
¡©_aùive_deäag_key_h™s
++;

425 
£rv”
.
¡©_aùive_deäag_key_mis£s
++;

426 
	}
}

430 
	$deäagDiùBuck‘C®lback
(*
´ivd©a
, 
diùEÁry
 **
buck‘»f
) {

431 
	`UNUSED
(
´ivd©a
);

432 *
buck‘»f
) {

433 
diùEÁry
 *
de
 = *
buck‘»f
, *
Ãwde
;

434 ià((
Ãwde
 = 
	`aùiveDeäagAÎoc
(
de
))) {

435 *
buck‘»f
 = 
Ãwde
;

437 
buck‘»f
 = &(*buck‘»f)->
Ãxt
;

439 
	}
}

447 
	$g‘AÎoÿtÜF¿gm’tiÚ
(
size_t
 *
out_äag_by‹s
) {

448 
size_t
 
•och
 = 1, 
®loÿ‹d
 = 0, 
»sid’t
 = 0, 
aùive
 = 0, 
sz
 = (size_t);

450 
	`je_m®lùl
("•och", &
•och
, &
sz
, &epoch, sz);

453 
	`je_m®lùl
("¡©s.»sid’t", &
»sid’t
, &
sz
, 
NULL
, 0);

456 
	`je_m®lùl
("¡©s.aùive", &
aùive
, &
sz
, 
NULL
, 0);

459 
	`je_m®lùl
("¡©s.®loÿ‹d", &
®loÿ‹d
, &
sz
, 
NULL
, 0);

460 
äag_pù
 = (()
aùive
 / 
®loÿ‹d
)*100 - 100;

461 
size_t
 
äag_by‹s
 = 
aùive
 - 
®loÿ‹d
;

462 
rss_pù
 = (()
»sid’t
 / 
®loÿ‹d
)*100 - 100;

463 
size_t
 
rss_by‹s
 = 
»sid’t
 - 
®loÿ‹d
;

464 if(
out_äag_by‹s
)

465 *
out_äag_by‹s
 = 
äag_by‹s
;

466 
	`£rv”Log
(
LL_DEBUG
,

468 
®loÿ‹d
, 
aùive
, 
»sid’t
, 
äag_pù
, 
rss_pù
, 
äag_by‹s
, 
rss_by‹s
);

469  
äag_pù
;

470 
	}
}

472 
	#INTERPOLATE
(
x
, 
x1
, 
x2
, 
y1
, 
y2
èĞ(y1è+ ((x)-(x1)è* ((y2)-(y1)è/ ((x2)-(x1)è)

	)

473 
	#LIMIT
(
y
, 
mš
, 
max
è((y)<(mš)? mš: ((y)>(max)? max: (y)))

	)

478 
	$aùiveDeäagCyşe
() {

479 
cu¼’t_db
 = -1;

480 
cursÜ
 = 0;

481 
»disDb
 *
db
 = 
NULL
;

482 
¡¬t_sÿn
, 
¡¬t_¡©
;

483 
™”©iÚs
 = 0;

484 
deäagged
 = 
£rv”
.
¡©_aùive_deäag_h™s
;

485 
¡¬t
, 
tim–im™
;

487 ià(
£rv”
.
aof_chd_pid
!=-1 || s”v”.
rdb_chd_pid
!=-1)

492 
	`run_w™h_³riod
(1000) {

493 
size_t
 
äag_by‹s
;

494 
äag_pù
 = 
	`g‘AÎoÿtÜF¿gm’tiÚ
(&
äag_by‹s
);

496 ià(!
£rv”
.
aùive_deäag_ruÂšg
) {

497 if(
äag_pù
 < 
£rv”
.
aùive_deäag_th»shŞd_low”
 || 
äag_by‹s
 < s”v”.
aùive_deäag_ignÜe_by‹s
)

502 
ıu_pù
 = 
	`INTERPOLATE
(
äag_pù
,

503 
£rv”
.
aùive_deäag_th»shŞd_low”
,

504 
£rv”
.
aùive_deäag_th»shŞd_uµ”
,

505 
£rv”
.
aùive_deäag_cyşe_mš
,

506 
£rv”
.
aùive_deäag_cyşe_max
);

507 
ıu_pù
 = 
	`LIMIT
(cpu_pct,

508 
£rv”
.
aùive_deäag_cyşe_mš
,

509 
£rv”
.
aùive_deäag_cyşe_max
);

512 ià(!
£rv”
.
aùive_deäag_ruÂšg
 ||

513 
ıu_pù
 > 
£rv”
.
aùive_deäag_ruÂšg
)

515 
£rv”
.
aùive_deäag_ruÂšg
 = 
ıu_pù
;

516 
	`£rv”Log
(
LL_VERBOSE
,

518 
äag_pù
, 
äag_by‹s
, 
ıu_pù
);

521 ià(!
£rv”
.
aùive_deäag_ruÂšg
)

525 
¡¬t
 = 
	`u¡ime
();

526 
tim–im™
 = 1000000*
£rv”
.
aùive_deäag_ruÂšg
/£rv”.
hz
/100;

527 ià(
tim–im™
 <= 0)imelimit = 1;

530 ià(!
cursÜ
) {

532 ià(++
cu¼’t_db
 >ğ
£rv”
.
dbnum
) {

533 
now
 = 
	`u¡ime
();

534 
size_t
 
äag_by‹s
;

535 
äag_pù
 = 
	`g‘AÎoÿtÜF¿gm’tiÚ
(&
äag_by‹s
);

536 
	`£rv”Log
(
LL_VERBOSE
,

538 ()((
now
 - 
¡¬t_sÿn
)/1000), ()(
£rv”
.
¡©_aùive_deäag_h™s
 - 
¡¬t_¡©
), 
äag_pù
, 
äag_by‹s
);

540 
¡¬t_sÿn
 = 
now
;

541 
cu¼’t_db
 = -1;

542 
cursÜ
 = 0;

543 
db
 = 
NULL
;

544 
£rv”
.
aùive_deäag_ruÂšg
 = 0;

547 ià(
cu¼’t_db
==0) {

549 
¡¬t_sÿn
 = 
	`u¡ime
();

550 
¡¬t_¡©
 = 
£rv”
.
¡©_aùive_deäag_h™s
;

553 
db
 = &
£rv”
.db[
cu¼’t_db
];

554 
cursÜ
 = 0;

558 
cursÜ
 = 
	`diùSÿn
(
db
->
diù
, cursÜ, 
deäagSÿnC®lback
, 
deäagDiùBuck‘C®lback
, db);

562 ià(
cursÜ
 && (++
™”©iÚs
 > 16 || 
£rv”
.
¡©_aùive_deäag_h™s
 - 
deäagged
 > 1000)) {

563 ià((
	`u¡ime
(è- 
¡¬t
è> 
tim–im™
) {

566 
™”©iÚs
 = 0;

567 
deäagged
 = 
£rv”
.
¡©_aùive_deäag_h™s
;

569 } 
cursÜ
);

571 
	}
}

575 
	$aùiveDeäagCyşe
() {

577 
	}
}

	@src/dict.c

36 
	~"fmaüos.h
"

38 
	~<¡dio.h
>

39 
	~<¡dlib.h
>

40 
	~<¡dšt.h
>

41 
	~<¡ršg.h
>

42 
	~<¡d¬g.h
>

43 
	~<lim™s.h
>

44 
	~<sys/time.h
>

46 
	~"diù.h
"

47 
	~"zm®loc.h
"

48 #iâdeà
DICT_BENCHMARK_MAIN


49 
	~"»di§s£¹.h
"

51 
	~<as£¹.h
>

62 
	gdiù_ÿn_»size
 = 1;

63 
	gdiù_fÜû_»size_¿tio
 = 5;

67 
_diùEx·ndIfN“ded
(
diù
 *
ht
);

68 
_diùNextPow”
(
size
);

69 
_diùKeyIndex
(
diù
 *
ht
, cÚ¡ *
key
, 
ušt64_t
 
hash
, 
diùEÁry
 **
exi¡šg
);

70 
_diùIn™
(
diù
 *
ht
, 
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

74 
ušt8_t
 
	gdiù_hash_funùiÚ_£ed
[16];

76 
	$diùS‘HashFunùiÚS“d
(
ušt8_t
 *
£ed
) {

77 
	`memıy
(
diù_hash_funùiÚ_£ed
,
£ed
,(dict_hash_function_seed));

78 
	}
}

80 
ušt8_t
 *
	$diùG‘HashFunùiÚS“d
() {

81  
diù_hash_funùiÚ_£ed
;

82 
	}
}

87 
ušt64_t
 
shash
(cÚ¡ 
ušt8_t
 *
š
, cÚ¡ 
size_t
 
šËn
, cÚ¡ ušt8_ˆ*
k
);

88 
ušt64_t
 
shash_noÿ£
(cÚ¡ 
ušt8_t
 *
š
, cÚ¡ 
size_t
 
šËn
, cÚ¡ ušt8_ˆ*
k
);

90 
ušt64_t
 
	$diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
) {

91  
	`shash
(
key
,
Ën
,
diù_hash_funùiÚ_£ed
);

92 
	}
}

94 
ušt64_t
 
	$diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
) {

95  
	`shash_noÿ£
(
buf
,
Ën
,
diù_hash_funùiÚ_£ed
);

96 
	}
}

102 
	$_diùRe£t
(
diùht
 *
ht
)

104 
ht
->
bË
 = 
NULL
;

105 
ht
->
size
 = 0;

106 
ht
->
sizemask
 = 0;

107 
ht
->
u£d
 = 0;

108 
	}
}

111 
diù
 *
	$diùC»©e
(
diùTy³
 *
ty³
,

112 *
´ivD©aPŒ
)

114 
diù
 *
d
 = 
	`zm®loc
((*d));

116 
	`_diùIn™
(
d
,
ty³
,
´ivD©aPŒ
);

117  
d
;

118 
	}
}

121 
	$_diùIn™
(
diù
 *
d
, 
diùTy³
 *
ty³
,

122 *
´ivD©aPŒ
)

124 
	`_diùRe£t
(&
d
->
ht
[0]);

125 
	`_diùRe£t
(&
d
->
ht
[1]);

126 
d
->
ty³
 =ype;

127 
d
->
´ivd©a
 = 
´ivD©aPŒ
;

128 
d
->
»hashidx
 = -1;

129 
d
->
™”©Üs
 = 0;

130  
DICT_OK
;

131 
	}
}

135 
	$diùResize
(
diù
 *
d
)

137 
mšim®
;

139 ià(!
diù_ÿn_»size
 || 
	`diùIsRehashšg
(
d
)è 
DICT_ERR
;

140 
mšim®
 = 
d
->
ht
[0].
u£d
;

141 ià(
mšim®
 < 
DICT_HT_INITIAL_SIZE
)

142 
mšim®
 = 
DICT_HT_INITIAL_SIZE
;

143  
	`diùEx·nd
(
d
, 
mšim®
);

144 
	}
}

147 
	$diùEx·nd
(
diù
 *
d
, 
size
)

149 
diùht
 
n
;

150 
»®size
 = 
	`_diùNextPow”
(
size
);

154 ià(
	`diùIsRehashšg
(
d
è|| d->
ht
[0].
u£d
 > 
size
)

155  
DICT_ERR
;

158 ià(
»®size
 =ğ
d
->
ht
[0].
size
è 
DICT_ERR
;

161 
n
.
size
 = 
»®size
;

162 
n
.
sizemask
 = 
»®size
-1;

163 
n
.
bË
 = 
	`zÿÎoc
(
»®size
*(
diùEÁry
*));

164 
n
.
u£d
 = 0;

168 ià(
d
->
ht
[0].
bË
 =ğ
NULL
) {

169 
d
->
ht
[0] = 
n
;

170  
DICT_OK
;

174 
d
->
ht
[1] = 
n
;

175 
d
->
»hashidx
 = 0;

176  
DICT_OK
;

177 
	}
}

188 
	$diùRehash
(
diù
 *
d
, 
n
) {

189 
em±y_vis™s
 = 
n
*10;

190 ià(!
	`diùIsRehashšg
(
d
))  0;

192 
n
-- && 
d
->
ht
[0].
u£d
 != 0) {

193 
diùEÁry
 *
de
, *
Ãxtde
;

197 
	`as£¹
(
d
->
ht
[0].
size
 > ()d->
»hashidx
);

198 
d
->
ht
[0].
bË
[d->
»hashidx
] =ğ
NULL
) {

199 
d
->
»hashidx
++;

200 ià(--
em±y_vis™s
 == 0)  1;

202 
de
 = 
d
->
ht
[0].
bË
[d->
»hashidx
];

204 
de
) {

205 
ušt64_t
 
h
;

207 
Ãxtde
 = 
de
->
Ãxt
;

209 
h
 = 
	`diùHashKey
(
d
, 
de
->
key
è& d->
ht
[1].
sizemask
;

210 
de
->
Ãxt
 = 
d
->
ht
[1].
bË
[
h
];

211 
d
->
ht
[1].
bË
[
h
] = 
de
;

212 
d
->
ht
[0].
u£d
--;

213 
d
->
ht
[1].
u£d
++;

214 
de
 = 
Ãxtde
;

216 
d
->
ht
[0].
bË
[d->
»hashidx
] = 
NULL
;

217 
d
->
»hashidx
++;

221 ià(
d
->
ht
[0].
u£d
 == 0) {

222 
	`zä“
(
d
->
ht
[0].
bË
);

223 
d
->
ht
[0] = d->ht[1];

224 
	`_diùRe£t
(&
d
->
ht
[1]);

225 
d
->
»hashidx
 = -1;

231 
	}
}

233 
	$timeInMli£cÚds
() {

234 
timev®
 
tv
;

236 
	`g‘timeofday
(&
tv
,
NULL
);

237  ((()
tv
.
tv_£c
)*1000)+Ñv.
tv_u£c
/1000);

238 
	}
}

241 
	$diùRehashMli£cÚds
(
diù
 *
d
, 
ms
) {

242 
¡¬t
 = 
	`timeInMli£cÚds
();

243 
»hashes
 = 0;

245 
	`diùRehash
(
d
,100)) {

246 
»hashes
 += 100;

247 ià(
	`timeInMli£cÚds
()-
¡¬t
 > 
ms
) ;

249  
»hashes
;

250 
	}
}

260 
	$_diùRehashS‹p
(
diù
 *
d
) {

261 ià(
d
->
™”©Üs
 =ğ0è
	`diùRehash
(d,1);

262 
	}
}

265 
	$diùAdd
(
diù
 *
d
, *
key
, *
v®
)

267 
diùEÁry
 *
’Œy
 = 
	`diùAddRaw
(
d
,
key
,
NULL
);

269 ià(!
’Œy
è 
DICT_ERR
;

270 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

271  
DICT_OK
;

272 
	}
}

292 
diùEÁry
 *
	$diùAddRaw
(
diù
 *
d
, *
key
, 
diùEÁry
 **
exi¡šg
)

294 
šdex
;

295 
diùEÁry
 *
’Œy
;

296 
diùht
 *
ht
;

298 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

302 ià((
šdex
 = 
	`_diùKeyIndex
(
d
, 
key
, 
	`diùHashKey
(d,key), 
exi¡šg
)) == -1)

303  
NULL
;

309 
ht
 = 
	`diùIsRehashšg
(
d
) ? &d->ht[1] : &d->ht[0];

310 
’Œy
 = 
	`zm®loc
((*entry));

311 
’Œy
->
Ãxt
 = 
ht
->
bË
[
šdex
];

312 
ht
->
bË
[
šdex
] = 
’Œy
;

313 
ht
->
u£d
++;

316 
	`diùS‘Key
(
d
, 
’Œy
, 
key
);

317  
’Œy
;

318 
	}
}

325 
	$diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
)

327 
diùEÁry
 *
’Œy
, *
exi¡šg
, 
aux’Œy
;

331 
’Œy
 = 
	`diùAddRaw
(
d
,
key
,&
exi¡šg
);

332 ià(
’Œy
) {

333 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

342 
aux’Œy
 = *
exi¡šg
;

343 
	`diùS‘V®
(
d
, 
exi¡šg
, 
v®
);

344 
	`diùF»eV®
(
d
, &
aux’Œy
);

346 
	}
}

355 
diùEÁry
 *
	$diùAddOrFšd
(
diù
 *
d
, *
key
) {

356 
diùEÁry
 *
’Œy
, *
exi¡šg
;

357 
’Œy
 = 
	`diùAddRaw
(
d
,
key
,&
exi¡šg
);

358  
’Œy
 ?ƒÁry : 
exi¡šg
;

359 
	}
}

364 
diùEÁry
 *
	$diùG’”icD–‘e
(
diù
 *
d
, cÚ¡ *
key
, 
noä“
) {

365 
ušt64_t
 
h
, 
idx
;

366 
diùEÁry
 *
he
, *
´evHe
;

367 
bË
;

369 ià(
d
->
ht
[0].
u£d
 =ğ0 && d->ht[1].u£d =ğ0è 
NULL
;

371 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

372 
h
 = 
	`diùHashKey
(
d
, 
key
);

374 
bË
 = 0;able <= 1;able++) {

375 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

376 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

377 
´evHe
 = 
NULL
;

378 
he
) {

379 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key)) {

381 ià(
´evHe
)

382 
´evHe
->
Ãxt
 = 
he
->next;

384 
d
->
ht
[
bË
].bË[
idx
] = 
he
->
Ãxt
;

385 ià(!
noä“
) {

386 
	`diùF»eKey
(
d
, 
he
);

387 
	`diùF»eV®
(
d
, 
he
);

388 
	`zä“
(
he
);

390 
d
->
ht
[
bË
].
u£d
--;

391  
he
;

393 
´evHe
 = 
he
;

394 
he
 = he->
Ãxt
;

396 ià(!
	`diùIsRehashšg
(
d
)) ;

398  
NULL
;

399 
	}
}

403 
	$diùD–‘e
(
diù
 *
ht
, cÚ¡ *
key
) {

404  
	`diùG’”icD–‘e
(
ht
,
key
,0è? 
DICT_OK
 : 
DICT_ERR
;

405 
	}
}

428 
diùEÁry
 *
	$diùUÆšk
(
diù
 *
ht
, cÚ¡ *
key
) {

429  
	`diùG’”icD–‘e
(
ht
,
key
,1);

430 
	}
}

434 
	$diùF»eUÆškedEÁry
(
diù
 *
d
, 
diùEÁry
 *
he
) {

435 ià(
he
 =ğ
NULL
) ;

436 
	`diùF»eKey
(
d
, 
he
);

437 
	`diùF»eV®
(
d
, 
he
);

438 
	`zä“
(
he
);

439 
	}
}

442 
_diùCË¬
(
diù
 *
d
, 
diùht
 *
ht
, (
ÿÎback
)(*)) {

443 
i
;

446 
i
 = 0; i < 
ht
->
size
 && ht->
u£d
 > 0; i++) {

447 
diùEÁry
 *
he
, *
ÃxtHe
;

449 ià(
ÿÎback
 && (
i
 & 65535è=ğ0è
	`ÿÎback
(
d
->
´ivd©a
);

451 ià((
he
 = 
ht
->
bË
[
i
]è=ğ
NULL
) ;

452 
he
) {

453 
ÃxtHe
 = 
he
->
Ãxt
;

454 
	`diùF»eKey
(
d
, 
he
);

455 
	`diùF»eV®
(
d
, 
he
);

456 
	`zä“
(
he
);

457 
ht
->
u£d
--;

458 
he
 = 
ÃxtHe
;

462 
	`zä“
(
ht
->
bË
);

464 
	`_diùRe£t
(
ht
);

465  
DICT_OK
;

466 
	}
}

469 
	$diùR–—£
(
diù
 *
d
)

471 
	`_diùCË¬
(
d
,&d->
ht
[0],
NULL
);

472 
	`_diùCË¬
(
d
,&d->
ht
[1],
NULL
);

473 
	`zä“
(
d
);

474 
	}
}

476 
diùEÁry
 *
	$diùFšd
(
diù
 *
d
, cÚ¡ *
key
)

478 
diùEÁry
 *
he
;

479 
ušt64_t
 
h
, 
idx
, 
bË
;

481 ià(
d
->
ht
[0].
u£d
 + d->ht[1].u£d =ğ0è 
NULL
;

482 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

483 
h
 = 
	`diùHashKey
(
d
, 
key
);

484 
bË
 = 0;able <= 1;able++) {

485 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

486 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

487 
he
) {

488 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key))

489  
he
;

490 
he
 = he->
Ãxt
;

492 ià(!
	`diùIsRehashšg
(
d
)è 
NULL
;

494  
NULL
;

495 
	}
}

497 *
	$diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
) {

498 
diùEÁry
 *
he
;

500 
he
 = 
	`diùFšd
(
d
,
key
);

501  
he
 ? 
	`diùG‘V®
(heè: 
NULL
;

502 
	}
}

510 
	$diùFšg”´št
(
diù
 *
d
) {

511 
š‹g”s
[6], 
hash
 = 0;

512 
j
;

514 
š‹g”s
[0] = (è
d
->
ht
[0].
bË
;

515 
š‹g”s
[1] = 
d
->
ht
[0].
size
;

516 
š‹g”s
[2] = 
d
->
ht
[0].
u£d
;

517 
š‹g”s
[3] = (è
d
->
ht
[1].
bË
;

518 
š‹g”s
[4] = 
d
->
ht
[1].
size
;

519 
š‹g”s
[5] = 
d
->
ht
[1].
u£d
;

528 
j
 = 0; j < 6; j++) {

529 
hash
 +ğ
š‹g”s
[
j
];

531 
hash
 = (~hash) + (hash << 21);

532 
hash
 = hash ^ (hash >> 24);

533 
hash
 = (hash + (hash << 3)) + (hash << 8);

534 
hash
 = hash ^ (hash >> 14);

535 
hash
 = (hash + (hash << 2)) + (hash << 4);

536 
hash
 = hash ^ (hash >> 28);

537 
hash
 = hash + (hash << 31);

539  
hash
;

540 
	}
}

542 
diùI‹¿tÜ
 *
	$diùG‘I‹¿tÜ
(
diù
 *
d
)

544 
diùI‹¿tÜ
 *
™”
 = 
	`zm®loc
((*iter));

546 
™”
->
d
 = d;

547 
™”
->
bË
 = 0;

548 
™”
->
šdex
 = -1;

549 
™”
->
§ã
 = 0;

550 
™”
->
’Œy
 = 
NULL
;

551 
™”
->
ÃxtEÁry
 = 
NULL
;

552  
™”
;

553 
	}
}

555 
diùI‹¿tÜ
 *
	$diùG‘SaãI‹¿tÜ
(
diù
 *
d
) {

556 
diùI‹¿tÜ
 *
i
 = 
	`diùG‘I‹¿tÜ
(
d
);

558 
i
->
§ã
 = 1;

559  
i
;

560 
	}
}

562 
diùEÁry
 *
	$diùNext
(
diùI‹¿tÜ
 *
™”
)

565 ià(
™”
->
’Œy
 =ğ
NULL
) {

566 
diùht
 *
ht
 = &
™”
->
d
->ht[™”->
bË
];

567 ià(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0) {

568 ià(
™”
->
§ã
)

569 
™”
->
d
->
™”©Üs
++;

571 
™”
->
fšg”´št
 = 
	`diùFšg”´št
(™”->
d
);

573 
™”
->
šdex
++;

574 ià(
™”
->
šdex
 >ğ(è
ht
->
size
) {

575 ià(
	`diùIsRehashšg
(
™”
->
d
è&& i‹r->
bË
 == 0) {

576 
™”
->
bË
++;

577 
™”
->
šdex
 = 0;

578 
ht
 = &
™”
->
d
->ht[1];

583 
™”
->
’Œy
 = 
ht
->
bË
[™”->
šdex
];

585 
™”
->
’Œy
 = i‹r->
ÃxtEÁry
;

587 ià(
™”
->
’Œy
) {

590 
™”
->
ÃxtEÁry
 = i‹r->
’Œy
->
Ãxt
;

591  
™”
->
’Œy
;

594  
NULL
;

595 
	}
}

597 
	$diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
)

599 ià(!(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0)) {

600 ià(
™”
->
§ã
)

601 
™”
->
d
->
™”©Üs
--;

603 
	`as£¹
(
™”
->
fšg”´št
 =ğ
	`diùFšg”´št
(™”->
d
));

605 
	`zä“
(
™”
);

606 
	}
}

610 
diùEÁry
 *
	$diùG‘RªdomKey
(
diù
 *
d
)

612 
diùEÁry
 *
he
, *
Üighe
;

613 
h
;

614 
li¡Ën
, 
li¡–e
;

616 ià(
	`diùSize
(
d
è=ğ0è 
NULL
;

617 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

618 ià(
	`diùIsRehashšg
(
d
)) {

622 
h
 = 
d
->
»hashidx
 + (
	`¿ndom
(è% (d->
ht
[0].
size
 +

623 
d
->
ht
[1].
size
 -

624 
d
->
»hashidx
));

625 
he
 = (
h
 >ğ
d
->
ht
[0].
size
è? d->ht[1].
bË
[h - d->ht[0].size] :

626 
d
->
ht
[0].
bË
[
h
];

627 } 
he
 =ğ
NULL
);

630 
h
 = 
	`¿ndom
(è& 
d
->
ht
[0].
sizemask
;

631 
he
 = 
d
->
ht
[0].
bË
[
h
];

632 } 
he
 =ğ
NULL
);

639 
li¡Ën
 = 0;

640 
Üighe
 = 
he
;

641 
he
) {

642 
he
 = he->
Ãxt
;

643 
li¡Ën
++;

645 
li¡–e
 = 
	`¿ndom
(è% 
li¡Ën
;

646 
he
 = 
Üighe
;

647 
li¡–e
--è
he
 = he->
Ãxt
;

648  
he
;

649 
	}
}

673 
	$diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
) {

674 
j
;

675 
bËs
;

676 
¡Üed
 = 0, 
maxsizemask
;

677 
max¡•s
;

679 ià(
	`diùSize
(
d
è< 
couÁ
) count = dictSize(d);

680 
max¡•s
 = 
couÁ
*10;

683 
j
 = 0; j < 
couÁ
; j++) {

684 ià(
	`diùIsRehashšg
(
d
))

685 
	`_diùRehashS‹p
(
d
);

690 
bËs
 = 
	`diùIsRehashšg
(
d
) ? 2 : 1;

691 
maxsizemask
 = 
d
->
ht
[0].
sizemask
;

692 ià(
bËs
 > 1 && 
maxsizemask
 < 
d
->
ht
[1].
sizemask
)

693 
maxsizemask
 = 
d
->
ht
[1].
sizemask
;

696 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

697 
em±yËn
 = 0;

698 
¡Üed
 < 
couÁ
 && 
max¡•s
--) {

699 
j
 = 0; j < 
bËs
; j++) {

703 ià(
bËs
 =ğ2 && 
j
 =ğ0 && 
i
 < (è
d
->
»hashidx
) {

708 ià(
i
 >ğ
d
->
ht
[1].
size
è˜ğd->
»hashidx
;

711 ià(
i
 >ğ
d
->
ht
[
j
].
size
) ;

712 
diùEÁry
 *
he
 = 
d
->
ht
[
j
].
bË
[
i
];

716 ià(
he
 =ğ
NULL
) {

717 
em±yËn
++;

718 ià(
em±yËn
 >ğ5 &&ƒm±yËÀ> 
couÁ
) {

719 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

720 
em±yËn
 = 0;

723 
em±yËn
 = 0;

724 
he
) {

727 *
des
 = 
he
;

728 
des
++;

729 
he
 = he->
Ãxt
;

730 
¡Üed
++;

731 ià(
¡Üed
 =ğ
couÁ
)  stored;

735 
i
 = (i+1è& 
maxsizemask
;

737  
¡Üed
;

738 
	}
}

742 
	$»v
(
v
) {

743 
s
 = 8 * (
v
);

744 
mask
 = ~0;

745 (
s
 >>= 1) > 0) {

746 
mask
 ^ğ(mask << 
s
);

747 
v
 = ((v >> 
s
è& 
mask
) | ((v << s) & ~mask);

749  
v
;

750 
	}
}

836 
	$diùSÿn
(
diù
 *
d
,

837 
v
,

838 
diùSÿnFunùiÚ
 *
â
,

839 
diùSÿnBuck‘FunùiÚ
* 
buck‘â
,

840 *
´ivd©a
)

842 
diùht
 *
t0
, *
t1
;

843 cÚ¡ 
diùEÁry
 *
de
, *
Ãxt
;

844 
m0
, 
m1
;

846 ià(
	`diùSize
(
d
) == 0)  0;

848 ià(!
	`diùIsRehashšg
(
d
)) {

849 
t0
 = &(
d
->
ht
[0]);

850 
m0
 = 
t0
->
sizemask
;

853 ià(
buck‘â
è
	`buck‘â
(
´ivd©a
, &
t0
->
bË
[
v
 & 
m0
]);

854 
de
 = 
t0
->
bË
[
v
 & 
m0
];

855 
de
) {

856 
Ãxt
 = 
de
->next;

857 
	`â
(
´ivd©a
, 
de
);

858 
de
 = 
Ãxt
;

863 
v
 |ğ~
m0
;

866 
v
 = 
	`»v
(v);

867 
v
++;

868 
v
 = 
	`»v
(v);

871 
t0
 = &
d
->
ht
[0];

872 
t1
 = &
d
->
ht
[1];

875 ià(
t0
->
size
 > 
t1
->size) {

876 
t0
 = &
d
->
ht
[1];

877 
t1
 = &
d
->
ht
[0];

880 
m0
 = 
t0
->
sizemask
;

881 
m1
 = 
t1
->
sizemask
;

884 ià(
buck‘â
è
	`buck‘â
(
´ivd©a
, &
t0
->
bË
[
v
 & 
m0
]);

885 
de
 = 
t0
->
bË
[
v
 & 
m0
];

886 
de
) {

887 
Ãxt
 = 
de
->next;

888 
	`â
(
´ivd©a
, 
de
);

889 
de
 = 
Ãxt
;

896 ià(
buck‘â
è
	`buck‘â
(
´ivd©a
, &
t1
->
bË
[
v
 & 
m1
]);

897 
de
 = 
t1
->
bË
[
v
 & 
m1
];

898 
de
) {

899 
Ãxt
 = 
de
->next;

900 
	`â
(
´ivd©a
, 
de
);

901 
de
 = 
Ãxt
;

905 
v
 |ğ~
m1
;

906 
v
 = 
	`»v
(v);

907 
v
++;

908 
v
 = 
	`»v
(v);

911 } 
v
 & (
m0
 ^ 
m1
));

914  
v
;

915 
	}
}

920 
	$_diùEx·ndIfN“ded
(
diù
 *
d
)

923 ià(
	`diùIsRehashšg
(
d
)è 
DICT_OK
;

926 ià(
d
->
ht
[0].
size
 =ğ0è 
	`diùEx·nd
(d, 
DICT_HT_INITIAL_SIZE
);

932 ià(
d
->
ht
[0].
u£d
 >ğd->ht[0].
size
 &&

933 (
diù_ÿn_»size
 ||

934 
d
->
ht
[0].
u£d
/d->ht[0].
size
 > 
diù_fÜû_»size_¿tio
))

936  
	`diùEx·nd
(
d
, d->
ht
[0].
u£d
*2);

938  
DICT_OK
;

939 
	}
}

942 
	$_diùNextPow”
(
size
)

944 
i
 = 
DICT_HT_INITIAL_SIZE
;

946 ià(
size
 >ğ
LONG_MAX
)  LONG_MAX + 1LU;

948 ià(
i
 >ğ
size
)

949  
i
;

950 
i
 *= 2;

952 
	}
}

961 
	$_diùKeyIndex
(
diù
 *
d
, cÚ¡ *
key
, 
ušt64_t
 
hash
, 
diùEÁry
 **
exi¡šg
)

963 
idx
, 
bË
;

964 
diùEÁry
 *
he
;

965 ià(
exi¡šg
è*exi¡šg = 
NULL
;

968 ià(
	`_diùEx·ndIfN“ded
(
d
è=ğ
DICT_ERR
)

970 
bË
 = 0;able <= 1;able++) {

971 
idx
 = 
hash
 & 
d
->
ht
[
bË
].
sizemask
;

973 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

974 
he
) {

975 ià(
key
==
he
->key || 
	`diùCom·»Keys
(
d
, key, he->key)) {

976 ià(
exi¡šg
è*exi¡šg = 
he
;

979 
he
 = he->
Ãxt
;

981 ià(!
	`diùIsRehashšg
(
d
)) ;

983  
idx
;

984 
	}
}

986 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*)) {

987 
	`_diùCË¬
(
d
,&d->
ht
[0],
ÿÎback
);

988 
	`_diùCË¬
(
d
,&d->
ht
[1],
ÿÎback
);

989 
d
->
»hashidx
 = -1;

990 
d
->
™”©Üs
 = 0;

991 
	}
}

993 
	$diùEÇbËResize
() {

994 
diù_ÿn_»size
 = 1;

995 
	}
}

997 
	$diùDi§bËResize
() {

998 
diù_ÿn_»size
 = 0;

999 
	}
}

1001 
ušt64_t
 
	$diùG‘Hash
(
diù
 *
d
, cÚ¡ *
key
) {

1002  
	`diùHashKey
(
d
, 
key
);

1003 
	}
}

1010 
diùEÁry
 **
	$diùFšdEÁryRefByPŒAndHash
(
diù
 *
d
, cÚ¡ *
Şd±r
, 
ušt64_t
 
hash
) {

1011 
diùEÁry
 *
he
, **
h”ef
;

1012 
idx
, 
bË
;

1014 ià(
d
->
ht
[0].
u£d
 + d->ht[1].u£d =ğ0è 
NULL
;

1015 
bË
 = 0;able <= 1;able++) {

1016 
idx
 = 
hash
 & 
d
->
ht
[
bË
].
sizemask
;

1017 
h”ef
 = &
d
->
ht
[
bË
].bË[
idx
];

1018 
he
 = *
h”ef
;

1019 
he
) {

1020 ià(
Şd±r
==
he
->
key
)

1021  
h”ef
;

1022 
h”ef
 = &
he
->
Ãxt
;

1023 
he
 = *
h”ef
;

1025 ià(!
	`diùIsRehashšg
(
d
)è 
NULL
;

1027  
NULL
;

1028 
	}
}

1032 
	#DICT_STATS_VECTLEN
 50

	)

1033 
size_t
 
	$_diùG‘StsHt
(*
buf
, 
size_t
 
bufsize
, 
diùht
 *
ht
, 
bËid
) {

1034 
i
, 
¦Ùs
 = 0, 
chašËn
, 
maxchašËn
 = 0;

1035 
tÙchašËn
 = 0;

1036 
şveùÜ
[
DICT_STATS_VECTLEN
];

1037 
size_t
 
l
 = 0;

1039 ià(
ht
->
u£d
 == 0) {

1040  
	`¢´štf
(
buf
,
bufsize
,

1045 
i
 = 0; i < 
DICT_STATS_VECTLEN
; i++è
şveùÜ
[i] = 0;

1046 
i
 = 0; i < 
ht
->
size
; i++) {

1047 
diùEÁry
 *
he
;

1049 ià(
ht
->
bË
[
i
] =ğ
NULL
) {

1050 
şveùÜ
[0]++;

1053 
¦Ùs
++;

1055 
chašËn
 = 0;

1056 
he
 = 
ht
->
bË
[
i
];

1057 
he
) {

1058 
chašËn
++;

1059 
he
 = he->
Ãxt
;

1061 
şveùÜ
[(
chašËn
 < 
DICT_STATS_VECTLEN
) ? chainlen : (DICT_STATS_VECTLEN-1)]++;

1062 ià(
chašËn
 > 
maxchašËn
) maxchainlen = chainlen;

1063 
tÙchašËn
 +ğ
chašËn
;

1067 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1076 
bËid
, (tableid == 0) ? "main hashable" : "rehashingarget",

1077 
ht
->
size
, ht->
u£d
, 
¦Ùs
, 
maxchašËn
,

1078 ()
tÙchašËn
/
¦Ùs
, ()
ht
->
u£d
/slots);

1080 
i
 = 0; i < 
DICT_STATS_VECTLEN
-1; i++) {

1081 ià(
şveùÜ
[
i
] == 0) ;

1082 ià(
l
 >ğ
bufsize
) ;

1083 
l
 +ğ
	`¢´štf
(
buf
+l,
bufsize
-l,

1085 (
i
 =ğ
DICT_STATS_VECTLEN
-1)?">= ":"",

1086 
i
, 
şveùÜ
[i], (()şveùÜ[i]/
ht
->
size
)*100);

1090 ià(
bufsize
è
buf
[bufsize-1] = '\0';

1091  
	`¡¾’
(
buf
);

1092 
	}
}

1094 
	$diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
) {

1095 
size_t
 
l
;

1096 *
Üig_buf
 = 
buf
;

1097 
size_t
 
Üig_bufsize
 = 
bufsize
;

1099 
l
 = 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[0],0);

1100 
buf
 +ğ
l
;

1101 
bufsize
 -ğ
l
;

1102 ià(
	`diùIsRehashšg
(
d
è&& 
bufsize
 > 0) {

1103 
	`_diùG‘StsHt
(
buf
,
bufsize
,&
d
->
ht
[1],1);

1106 ià(
Üig_bufsize
è
Üig_buf
[orig_bufsize-1] = '\0';

1107 
	}
}

1111 #ifdeà
DICT_BENCHMARK_MAIN


1113 
	~"sds.h
"

1115 
ušt64_t
 
	$hashC®lback
(cÚ¡ *
key
) {

1116  
	`diùG’HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

1117 
	}
}

1119 
	$com·»C®lback
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

1120 
l1
,
l2
;

1121 
	`DICT_NOTUSED
(
´ivd©a
);

1123 
l1
 = 
	`sd¦’
((
sds
)
key1
);

1124 
l2
 = 
	`sd¦’
((
sds
)
key2
);

1125 ià(
l1
 !ğ
l2
)  0;

1126  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

1127 
	}
}

1129 
	$ä“C®lback
(*
´ivd©a
, *
v®
) {

1130 
	`DICT_NOTUSED
(
´ivd©a
);

1132 
	`sdsä“
(
v®
);

1133 
	}
}

1135 
diùTy³
 
	gB’chm¬kDiùTy³
 = {

1136 
hashC®lback
,

1137 
NULL
,

1138 
NULL
,

1139 
com·»C®lback
,

1140 
ä“C®lback
,

1141 
NULL


1144 
	#¡¬t_b’chm¬k
(è
¡¬t
 = 
	`timeInMli£cÚds
()

	)

1145 
	#’d_b’chm¬k
(
msg
) do { \

1146 
–­£d
 = 
	`timeInMli£cÚds
()-
¡¬t
; \

1147 
	`´štf
(
msg
 ": %ld i‹m š %Îd ms\n", 
couÁ
, 
–­£d
); \

1148 } 0);

	)

1151 
	$maš
(
¬gc
, **
¬gv
) {

1152 
j
;

1153 
¡¬t
, 
–­£d
;

1154 
diù
 *diù = 
	`diùC»©e
(&
B’chm¬kDiùTy³
,
NULL
);

1155 
couÁ
 = 0;

1157 ià(
¬gc
 == 2) {

1158 
couÁ
 = 
	`¡¹Ş
(
¬gv
[1],
NULL
,10);

1160 
couÁ
 = 5000000;

1163 
	`¡¬t_b’chm¬k
();

1164 
j
 = 0; j < 
couÁ
; j++) {

1165 
»tv®
 = 
	`diùAdd
(
diù
,
	`sdsäomlÚglÚg
(
j
),(*)j);

1166 
	`as£¹
(
»tv®
 =ğ
DICT_OK
);

1168 
	`’d_b’chm¬k
("Inserting");

1169 
	`as£¹
(()
	`diùSize
(
diù
è=ğ
couÁ
);

1172 
	`diùIsRehashšg
(
diù
)) {

1173 
	`diùRehashMli£cÚds
(
diù
,100);

1176 
	`¡¬t_b’chm¬k
();

1177 
j
 = 0; j < 
couÁ
; j++) {

1178 
sds
 
key
 = 
	`sdsäomlÚglÚg
(
j
);

1179 
diùEÁry
 *
de
 = 
	`diùFšd
(
diù
,
key
);

1180 
	`as£¹
(
de
 !ğ
NULL
);

1181 
	`sdsä“
(
key
);

1183 
	`’d_b’chm¬k
("Linear‡ccess ofƒxistingƒlements");

1185 
	`¡¬t_b’chm¬k
();

1186 
j
 = 0; j < 
couÁ
; j++) {

1187 
sds
 
key
 = 
	`sdsäomlÚglÚg
(
j
);

1188 
diùEÁry
 *
de
 = 
	`diùFšd
(
diù
,
key
);

1189 
	`as£¹
(
de
 !ğ
NULL
);

1190 
	`sdsä“
(
key
);

1192 
	`’d_b’chm¬k
("Linear‡ccess ofƒxistingƒlements (2nd„ound)");

1194 
	`¡¬t_b’chm¬k
();

1195 
j
 = 0; j < 
couÁ
; j++) {

1196 
sds
 
key
 = 
	`sdsäomlÚglÚg
(
	`¿nd
(è% 
couÁ
);

1197 
diùEÁry
 *
de
 = 
	`diùFšd
(
diù
,
key
);

1198 
	`as£¹
(
de
 !ğ
NULL
);

1199 
	`sdsä“
(
key
);

1201 
	`’d_b’chm¬k
("Random‡ccess ofƒxistingƒlements");

1203 
	`¡¬t_b’chm¬k
();

1204 
j
 = 0; j < 
couÁ
; j++) {

1205 
sds
 
key
 = 
	`sdsäomlÚglÚg
(
	`¿nd
(è% 
couÁ
);

1206 
key
[0] = 'X';

1207 
diùEÁry
 *
de
 = 
	`diùFšd
(
diù
,
key
);

1208 
	`as£¹
(
de
 =ğ
NULL
);

1209 
	`sdsä“
(
key
);

1211 
	`’d_b’chm¬k
("Accessing missing");

1213 
	`¡¬t_b’chm¬k
();

1214 
j
 = 0; j < 
couÁ
; j++) {

1215 
sds
 
key
 = 
	`sdsäomlÚglÚg
(
j
);

1216 
»tv®
 = 
	`diùD–‘e
(
diù
,
key
);

1217 
	`as£¹
(
»tv®
 =ğ
DICT_OK
);

1218 
key
[0] += 17;

1219 
»tv®
 = 
	`diùAdd
(
diù
,
key
,(*)
j
);

1220 
	`as£¹
(
»tv®
 =ğ
DICT_OK
);

1222 
	`’d_b’chm¬k
("Removing‡nd‡dding");

1223 
	}
}

	@src/dict.h

36 
	~<¡dšt.h
>

38 #iâdeà
__DICT_H


39 
	#__DICT_H


	)

41 
	#DICT_OK
 0

	)

42 
	#DICT_ERR
 1

	)

45 
	#DICT_NOTUSED
(
V
è((èV)

	)

47 
	sdiùEÁry
 {

48 *
	mkey
;

50 *
	mv®
;

51 
ušt64_t
 
	mu64
;

52 
št64_t
 
	ms64
;

53 
	md
;

54 } 
	mv
;

55 
diùEÁry
 *
	mÃxt
;

56 } 
	tdiùEÁry
;

58 
	sdiùTy³
 {

59 
ušt64_t
 (*
hashFunùiÚ
)(cÚ¡ *
	mkey
);

60 *(*
	mkeyDup
)(*
	m´ivd©a
, cÚ¡ *
	mkey
);

61 *(*
	mv®Dup
)(*
	m´ivd©a
, cÚ¡ *
	mobj
);

62 (*
	mkeyCom·»
)(*
	m´ivd©a
, cÚ¡ *
	mkey1
, cÚ¡ *
	mkey2
);

63 (*
	mkeyDe¡ruùÜ
)(*
	m´ivd©a
, *
	mkey
);

64 (*
	mv®De¡ruùÜ
)(*
	m´ivd©a
, *
	mobj
);

65 } 
	tdiùTy³
;

69 
	sdiùht
 {

70 
diùEÁry
 **
	mbË
;

71 
	msize
;

72 
	msizemask
;

73 
	mu£d
;

74 } 
	tdiùht
;

76 
	sdiù
 {

77 
diùTy³
 *
	mty³
;

78 *
	m´ivd©a
;

79 
diùht
 
	mht
[2];

80 
	m»hashidx
;

81 
	m™”©Üs
;

82 } 
	tdiù
;

88 
	sdiùI‹¿tÜ
 {

89 
diù
 *
	md
;

90 
	mšdex
;

91 
	mbË
, 
	m§ã
;

92 
diùEÁry
 *
	m’Œy
, *
	mÃxtEÁry
;

94 
	mfšg”´št
;

95 } 
	tdiùI‹¿tÜ
;

97 (
	tdiùSÿnFunùiÚ
)(*
	t´ivd©a
, cÚ¡ 
	tdiùEÁry
 *
	tde
);

98 (
	tdiùSÿnBuck‘FunùiÚ
)(*
	t´ivd©a
, 
	tdiùEÁry
 **
	tbuck‘»f
);

101 
	#DICT_HT_INITIAL_SIZE
 4

	)

104 
	#diùF»eV®
(
d
, 
’Œy
) \

105 ià((
d
)->
ty³
->
v®De¡ruùÜ
) \

106 (
d
)->
ty³
->
	`v®De¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
v
.
v®
)

	)

108 
	#diùS‘V®
(
d
, 
’Œy
, 
_v®_
) do { \

109 ià((
d
)->
ty³
->
v®Dup
) \

110 (
’Œy
)->
v
.
v®
 = (
d
)->
ty³
->
	`v®Dup
((d)->
´ivd©a
, 
_v®_
); \

112 (
’Œy
)->
v
.
v®
 = (
_v®_
); \

113 
	}
} 0)

	)

115 
	#diùS‘SigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

116 dØ{ (
’Œy
)->
v
.
s64
 = 
_v®_
; } 0)

	)

118 
	#diùS‘UnsigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

119 dØ{ (
’Œy
)->
v
.
u64
 = 
_v®_
; } 0)

	)

121 
	#diùS‘DoubËV®
(
’Œy
, 
_v®_
) \

122 dØ{ (
’Œy
)->
v
.
d
 = 
_v®_
; } 0)

	)

124 
	#diùF»eKey
(
d
, 
’Œy
) \

125 ià((
d
)->
ty³
->
keyDe¡ruùÜ
) \

126 (
d
)->
ty³
->
	`keyDe¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
key
)

	)

128 
	#diùS‘Key
(
d
, 
’Œy
, 
_key_
) do { \

129 ià((
d
)->
ty³
->
keyDup
) \

130 (
’Œy
)->
key
 = (
d
)->
ty³
->
	`keyDup
((d)->
´ivd©a
, 
_key_
); \

132 (
’Œy
)->
key
 = (
_key_
); \

133 } 0)

	)

135 
	#diùCom·»Keys
(
d
, 
key1
, 
key2
) \

136 (((
d
)->
ty³
->
keyCom·»
) ? \

137 (
d
)->
ty³
->
	`keyCom·»
((d)->
´ivd©a
, 
key1
, 
key2
) : \

138 (
key1
è=ğ(
key2
))

	)

140 
	#diùHashKey
(
d
, 
key
è(d)->
ty³
->
	`hashFunùiÚ
(key)

	)

141 
	#diùG‘Key
(
he
è((he)->
key
)

	)

142 
	#diùG‘V®
(
he
è((he)->
v
.
v®
)

	)

143 
	#diùG‘SigÃdIÁeg”V®
(
he
è((he)->
v
.
s64
)

	)

144 
	#diùG‘UnsigÃdIÁeg”V®
(
he
è((he)->
v
.
u64
)

	)

145 
	#diùG‘DoubËV®
(
he
è((he)->
v
.
d
)

	)

146 
	#diùSlÙs
(
d
è((d)->
ht
[0].
size
+(d)->ht[1].size)

	)

147 
	#diùSize
(
d
è((d)->
ht
[0].
u£d
+(d)->ht[1].u£d)

	)

148 
	#diùIsRehashšg
(
d
è((d)->
»hashidx
 !ğ-1)

	)

151 
diù
 *
diùC»©e
(
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

152 
diùEx·nd
(
diù
 *
d
, 
size
);

153 
diùAdd
(
diù
 *
d
, *
key
, *
v®
);

154 
diùEÁry
 *
diùAddRaw
(
diù
 *
d
, *
key
, diùEÁry **
exi¡šg
);

155 
diùEÁry
 *
diùAddOrFšd
(
diù
 *
d
, *
key
);

156 
diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
);

157 
diùD–‘e
(
diù
 *
d
, cÚ¡ *
key
);

158 
diùEÁry
 *
diùUÆšk
(
diù
 *
ht
, cÚ¡ *
key
);

159 
diùF»eUÆškedEÁry
(
diù
 *
d
, 
diùEÁry
 *
he
);

160 
diùR–—£
(
diù
 *
d
);

161 
diùEÁry
 * 
diùFšd
(
diù
 *
d
, cÚ¡ *
key
);

162 *
diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
);

163 
diùResize
(
diù
 *
d
);

164 
diùI‹¿tÜ
 *
diùG‘I‹¿tÜ
(
diù
 *
d
);

165 
diùI‹¿tÜ
 *
diùG‘SaãI‹¿tÜ
(
diù
 *
d
);

166 
diùEÁry
 *
diùNext
(
diùI‹¿tÜ
 *
™”
);

167 
diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
);

168 
diùEÁry
 *
diùG‘RªdomKey
(
diù
 *
d
);

169 
diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
);

170 
diùG‘Sts
(*
buf
, 
size_t
 
bufsize
, 
diù
 *
d
);

171 
ušt64_t
 
diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
);

172 
ušt64_t
 
diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
);

173 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*));

174 
	`diùEÇbËResize
();

175 
	`diùDi§bËResize
();

176 
	`diùRehash
(
diù
 *
d
, 
n
);

177 
	`diùRehashMli£cÚds
(
diù
 *
d
, 
ms
);

178 
	`diùS‘HashFunùiÚS“d
(
ušt8_t
 *
£ed
);

179 
ušt8_t
 *
	`diùG‘HashFunùiÚS“d
();

180 
	`diùSÿn
(
diù
 *
d
, 
v
, 
diùSÿnFunùiÚ
 *
â
, 
diùSÿnBuck‘FunùiÚ
 *
buck‘â
, *
´ivd©a
);

181 
ušt64_t
 
	`diùG‘Hash
(
diù
 *
d
, cÚ¡ *
key
);

182 
diùEÁry
 **
	`diùFšdEÁryRefByPŒAndHash
(
diù
 *
d
, cÚ¡ *
Şd±r
, 
ušt64_t
 
hash
);

185 
diùTy³
 
diùTy³H—pSŒšgCİyKey
;

186 
diùTy³
 
diùTy³H—pSŒšgs
;

187 
diùTy³
 
diùTy³H—pSŒšgCİyKeyV®ue
;

	@src/endianconv.c

45 
	~<¡dšt.h
>

49 
	$mem»v16
(*
p
) {

50 *
x
 = 
p
, 
t
;

52 
t
 = 
x
[0];

53 
x
[0] = x[1];

54 
x
[1] = 
t
;

55 
	}
}

59 
	$mem»v32
(*
p
) {

60 *
x
 = 
p
, 
t
;

62 
t
 = 
x
[0];

63 
x
[0] = x[3];

64 
x
[3] = 
t
;

65 
t
 = 
x
[1];

66 
x
[1] = x[2];

67 
x
[2] = 
t
;

68 
	}
}

72 
	$mem»v64
(*
p
) {

73 *
x
 = 
p
, 
t
;

75 
t
 = 
x
[0];

76 
x
[0] = x[7];

77 
x
[7] = 
t
;

78 
t
 = 
x
[1];

79 
x
[1] = x[6];

80 
x
[6] = 
t
;

81 
t
 = 
x
[2];

82 
x
[2] = x[5];

83 
x
[5] = 
t
;

84 
t
 = 
x
[3];

85 
x
[3] = x[4];

86 
x
[4] = 
t
;

87 
	}
}

89 
ušt16_t
 
	$šŒev16
(
ušt16_t
 
v
) {

90 
	`mem»v16
(&
v
);

91  
v
;

92 
	}
}

94 
ušt32_t
 
	$šŒev32
(
ušt32_t
 
v
) {

95 
	`mem»v32
(&
v
);

96  
v
;

97 
	}
}

99 
ušt64_t
 
	$šŒev64
(
ušt64_t
 
v
) {

100 
	`mem»v64
(&
v
);

101  
v
;

102 
	}
}

104 #ifdeà
REDIS_TEST


105 
	~<¡dio.h
>

107 
	#UNUSED
(
x
è()(x)

	)

108 
	$’dŸncÚvTe¡
(
¬gc
, *
¬gv
[]) {

109 
buf
[32];

111 
	`UNUSED
(
¬gc
);

112 
	`UNUSED
(
¬gv
);

114 
	`¥rštf
(
buf
,"ciaoroma");

115 
	`mem»v16
(
buf
);

116 
	`´štf
("%s\n", 
buf
);

118 
	`¥rštf
(
buf
,"ciaoroma");

119 
	`mem»v32
(
buf
);

120 
	`´štf
("%s\n", 
buf
);

122 
	`¥rštf
(
buf
,"ciaoroma");

123 
	`mem»v64
(
buf
);

124 
	`´štf
("%s\n", 
buf
);

127 
	}
}

	@src/endianconv.h

33 #iâdeà
__ENDIANCONV_H


34 
	#__ENDIANCONV_H


	)

36 
	~"cÚfig.h
"

37 
	~<¡dšt.h
>

39 
mem»v16
(*
p
);

40 
mem»v32
(*
p
);

41 
mem»v64
(*
p
);

42 
ušt16_t
 
šŒev16
(ušt16_ˆ
v
);

43 
ušt32_t
 
šŒev32
(ušt32_ˆ
v
);

44 
ušt64_t
 
šŒev64
(ušt64_ˆ
v
);

48 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

49 
	#mem»v16ifbe
(
p
)

	)

50 
	#mem»v32ifbe
(
p
)

	)

51 
	#mem»v64ifbe
(
p
)

	)

52 
	#šŒev16ifbe
(
v
è(v)

	)

53 
	#šŒev32ifbe
(
v
è(v)

	)

54 
	#šŒev64ifbe
(
v
è(v)

	)

56 
	#mem»v16ifbe
(
p
è
	`mem»v16
Õ)

	)

57 
	#mem»v32ifbe
(
p
è
	`mem»v32
Õ)

	)

58 
	#mem»v64ifbe
(
p
è
	`mem»v64
Õ)

	)

59 
	#šŒev16ifbe
(
v
è
	`šŒev16
(v)

	)

60 
	#šŒev32ifbe
(
v
è
	`šŒev32
(v)

	)

61 
	#šŒev64ifbe
(
v
è
	`šŒev64
(v)

	)

66 #ià(
BYTE_ORDER
 =ğ
BIG_ENDIAN
)

67 
	#htÚu64
(
v
è(v)

	)

68 
	#Áohu64
(
v
è(v)

	)

70 
	#htÚu64
(
v
è
	`šŒev64
(v)

	)

71 
	#Áohu64
(
v
è
	`šŒev64
(v)

	)

74 #ifdeà
REDIS_TEST


75 
’dŸncÚvTe¡
(
¬gc
, *
¬gv
[]);

	@src/evict.c

33 
	~"£rv”.h
"

34 
	~"bio.h
"

35 
	~"©omicv¬.h
"

52 
	#EVPOOL_SIZE
 16

	)

53 
	#EVPOOL_CACHED_SDS_SIZE
 255

	)

54 
	seviùiÚPoŞEÁry
 {

55 
	midË
;

56 
sds
 
	mkey
;

57 
sds
 
	mÿched
;

58 
	mdbid
;

61 
eviùiÚPoŞEÁry
 *
	gEviùiÚPoŞLRU
;

70 
	$g‘LRUClock
() {

71  (
	`m¡ime
()/
LRU_CLOCK_RESOLUTION
è& 
LRU_CLOCK_MAX
;

72 
	}
}

78 
	$LRU_CLOCK
() {

79 
Ìuşock
;

80 ià(1000/
£rv”
.
hz
 <ğ
LRU_CLOCK_RESOLUTION
) {

81 
	`©omicG‘
(
£rv”
.
Ìuşock
,lruclock);

83 
Ìuşock
 = 
	`g‘LRUClock
();

85  
Ìuşock
;

86 
	}
}

90 
	$e¡im©eObjeùIdËTime
(
robj
 *
o
) {

91 
Ìuşock
 = 
	`LRU_CLOCK
();

92 ià(
Ìuşock
 >ğ
o
->
Ìu
) {

93  (
Ìuşock
 - 
o
->
Ìu
è* 
LRU_CLOCK_RESOLUTION
;

95  (
Ìuşock
 + (
LRU_CLOCK_MAX
 - 
o
->
Ìu
)) *

96 
LRU_CLOCK_RESOLUTION
;

98 
	}
}

139 
	$eviùiÚPoŞAÎoc
() {

140 
eviùiÚPoŞEÁry
 *
•
;

141 
j
;

143 
•
 = 
	`zm®loc
((*•)*
EVPOOL_SIZE
);

144 
j
 = 0; j < 
EVPOOL_SIZE
; j++) {

145 
•
[
j
].
idË
 = 0;

146 
•
[
j
].
key
 = 
NULL
;

147 
•
[
j
].
ÿched
 = 
	`sd¢ewËn
(
NULL
,
EVPOOL_CACHED_SDS_SIZE
);

148 
•
[
j
].
dbid
 = 0;

150 
EviùiÚPoŞLRU
 = 
•
;

151 
	}
}

162 
	$eviùiÚPoŞPİuÏ‹
(
dbid
, 
diù
 *
§m¶ediù
, diù *
keydiù
, 
eviùiÚPoŞEÁry
 *
poŞ
) {

163 
j
, 
k
, 
couÁ
;

164 
diùEÁry
 *
§m¶es
[
£rv”
.
maxmemÜy_§m¶es
];

166 
couÁ
 = 
	`diùG‘SomeKeys
(
§m¶ediù
,
§m¶es
,
£rv”
.
maxmemÜy_§m¶es
);

167 
j
 = 0; j < 
couÁ
; j++) {

168 
idË
;

169 
sds
 
key
;

170 
robj
 *
o
;

171 
diùEÁry
 *
de
;

173 
de
 = 
§m¶es
[
j
];

174 
key
 = 
	`diùG‘Key
(
de
);

179 ià(
£rv”
.
maxmemÜy_pŞicy
 !ğ
MAXMEMORY_VOLATILE_TTL
) {

180 ià(
§m¶ediù
 !ğ
keydiù
è
de
 = 
	`diùFšd
(keydiù, 
key
);

181 
o
 = 
	`diùG‘V®
(
de
);

187 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LRU
) {

188 
idË
 = 
	`e¡im©eObjeùIdËTime
(
o
);

189 } ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

197 
idË
 = 255-
	`LFUDeüAndR‘uº
(
o
);

198 } ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_TTL
) {

200 
idË
 = 
ULLONG_MAX
 - ()
	`diùG‘V®
(
de
);

202 
	`£rv”Pªic
("Unknownƒviction…olicy inƒvictionPoolPopulate()");

208 
k
 = 0;

209 
k
 < 
EVPOOL_SIZE
 &&

210 
poŞ
[
k
].
key
 &&

211 
poŞ
[
k
].
idË
 < idle) k++;

212 ià(
k
 =ğ0 && 
poŞ
[
EVPOOL_SIZE
-1].
key
 !ğ
NULL
) {

216 } ià(
k
 < 
EVPOOL_SIZE
 && 
poŞ
[k].
key
 =ğ
NULL
) {

221 ià(
poŞ
[
EVPOOL_SIZE
-1].
key
 =ğ
NULL
) {

226 
sds
 
ÿched
 = 
poŞ
[
EVPOOL_SIZE
-1].cached;

227 
	`memmove
(
poŞ
+
k
+1,pool+k,

228 (
poŞ
[0])*(
EVPOOL_SIZE
-
k
-1));

229 
poŞ
[
k
].
ÿched
 = cached;

232 
k
--;

235 
sds
 
ÿched
 = 
poŞ
[0].cached;

236 ià(
poŞ
[0].
key
 !ğpoŞ[0].
ÿched
è
	`sdsä“
(pool[0].key);

237 
	`memmove
(
poŞ
,poŞ+1,ÕoŞ[0])*
k
);

238 
poŞ
[
k
].
ÿched
 = cached;

246 
kËn
 = 
	`sd¦’
(
key
);

247 ià(
kËn
 > 
EVPOOL_CACHED_SDS_SIZE
) {

248 
poŞ
[
k
].
key
 = 
	`sdsdup
(key);

250 
	`memıy
(
poŞ
[
k
].
ÿched
,
key
,
kËn
+1);

251 
	`sds£’
(
poŞ
[
k
].
ÿched
,
kËn
);

252 
poŞ
[
k
].
key
 =…oŞ[k].
ÿched
;

254 
poŞ
[
k
].
idË
 = idle;

255 
poŞ
[
k
].
dbid
 = dbid;

257 
	}
}

299 
	$LFUG‘TimeInMšu‹s
() {

300  (
£rv”
.
unixtime
/60) & 65535;

301 
	}
}

307 
	$LFUTimeEÏp£d
(
ldt
) {

308 
now
 = 
	`LFUG‘TimeInMšu‹s
();

309 ià(
now
 >ğ
ldt
) ‚ow-ldt;

310  65535-
ldt
+
now
;

311 
	}
}

315 
ušt8_t
 
	$LFULogInü
(
ušt8_t
 
couÁ”
) {

316 ià(
couÁ”
 == 255)  255;

317 
r
 = ()
	`¿nd
()/
RAND_MAX
;

318 
ba£v®
 = 
couÁ”
 - 
LFU_INIT_VAL
;

319 ià(
ba£v®
 < 0) baseval = 0;

320 
p
 = 1.0/(
ba£v®
*
£rv”
.
lfu_log_çùÜ
+1);

321 ià(
r
 < 
p
è
couÁ”
++;

322  
couÁ”
;

323 
	}
}

335 
	$LFUDeüAndR‘uº
(
robj
 *
o
) {

336 
ldt
 = 
o
->
Ìu
 >> 8;

337 
couÁ”
 = 
o
->
Ìu
 & 255;

338 
num_³riods
 = 
£rv”
.
lfu_deÿy_time
 ? 
	`LFUTimeEÏp£d
(
ldt
) / server.lfu_decay_time : 0;

339 ià(
num_³riods
)

340 
couÁ”
 = (
num_³riods
 > counter) ? 0 : counter -‚um_periods;

341  
couÁ”
;

342 
	}
}

352 
size_t
 
	$ä“MemÜyG‘NÙCouÁedMemÜy
() {

353 
size_t
 
ov”h—d
 = 0;

354 
¦aves
 = 
	`li¡L’gth
(
£rv”
.slaves);

356 ià(
¦aves
) {

357 
li¡I‹r
 
li
;

358 
li¡Node
 *
Ê
;

360 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

361 (
Ê
 = 
	`li¡Next
(&
li
))) {

362 
ş›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

363 
ov”h—d
 +ğ
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
¦ave
);

366 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

367 
ov”h—d
 +ğ
	`sd¦’
(
£rv”
.
aof_buf
)+
	`aofRewr™eBufãrSize
();

369  
ov”h—d
;

370 
	}
}

372 
	$ä“MemÜyIfN“ded
() {

373 
size_t
 
mem_»pÜ‹d
, 
mem_u£d
, 
mem_toä“
, 
mem_ä“d
;

374 
m¡ime_t
 
Ï‹ncy
, 
eviùiÚ_Ï‹ncy
;

375 
d–
;

376 
¦aves
 = 
	`li¡L’gth
(
£rv”
.slaves);

381 ià(
	`ş›ÁsA»Pau£d
()è 
C_OK
;

385 
mem_»pÜ‹d
 = 
	`zm®loc_u£d_memÜy
();

386 ià(
mem_»pÜ‹d
 <ğ
£rv”
.
maxmemÜy
è 
C_OK
;

390 
mem_u£d
 = 
mem_»pÜ‹d
;

391 
size_t
 
ov”h—d
 = 
	`ä“MemÜyG‘NÙCouÁedMemÜy
();

392 
mem_u£d
 = (mem_u£d > 
ov”h—d
) ? mem_used-overhead : 0;

395 ià(
mem_u£d
 <ğ
£rv”
.
maxmemÜy
è 
C_OK
;

398 
mem_toä“
 = 
mem_u£d
 - 
£rv”
.
maxmemÜy
;

399 
mem_ä“d
 = 0;

401 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_NO_EVICTION
)

402 
ÿÁ_ä“
;

404 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

405 
mem_ä“d
 < 
mem_toä“
) {

406 
j
, 
k
, 
i
, 
keys_ä“d
 = 0;

407 
Ãxt_db
 = 0;

408 
sds
 
be¡key
 = 
NULL
;

409 
be¡dbid
;

410 
»disDb
 *
db
;

411 
diù
 *dict;

412 
diùEÁry
 *
de
;

414 ià(
£rv”
.
maxmemÜy_pŞicy
 & (
MAXMEMORY_FLAG_LRU
|
MAXMEMORY_FLAG_LFU
) ||

415 
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_TTL
)

417 
eviùiÚPoŞEÁry
 *
poŞ
 = 
EviùiÚPoŞLRU
;

419 
be¡key
 =ğ
NULL
) {

420 
tÙ®_keys
 = 0, 
keys
;

425 
i
 = 0; i < 
£rv”
.
dbnum
; i++) {

426 
db
 = 
£rv”
.db+
i
;

427 
diù
 = (
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_ALLKEYS
) ?

428 
db
->
diù
 : db->
expœes
;

429 ià((
keys
 = 
	`diùSize
(
diù
)) != 0) {

430 
	`eviùiÚPoŞPİuÏ‹
(
i
, 
diù
, 
db
->diù, 
poŞ
);

431 
tÙ®_keys
 +ğ
keys
;

434 ià(!
tÙ®_keys
) ;

437 
k
 = 
EVPOOL_SIZE
-1; k >= 0; k--) {

438 ià(
poŞ
[
k
].
key
 =ğ
NULL
) ;

439 
be¡dbid
 = 
poŞ
[
k
].
dbid
;

441 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_ALLKEYS
) {

442 
de
 = 
	`diùFšd
(
£rv”
.
db
[
poŞ
[
k
].
dbid
].
diù
,

443 
poŞ
[
k
].
key
);

445 
de
 = 
	`diùFšd
(
£rv”
.
db
[
poŞ
[
k
].
dbid
].
expœes
,

446 
poŞ
[
k
].
key
);

450 ià(
poŞ
[
k
].
key
 !ğpoŞ[k].
ÿched
)

451 
	`sdsä“
(
poŞ
[
k
].
key
);

452 
poŞ
[
k
].
key
 = 
NULL
;

453 
poŞ
[
k
].
idË
 = 0;

457 ià(
de
) {

458 
be¡key
 = 
	`diùG‘Key
(
de
);

468 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
 ||

469 
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_VOLATILE_RANDOM
)

474 
i
 = 0; i < 
£rv”
.
dbnum
; i++) {

475 
j
 = (++
Ãxt_db
è% 
£rv”
.
dbnum
;

476 
db
 = 
£rv”
.db+
j
;

477 
diù
 = (
£rv”
.
maxmemÜy_pŞicy
 =ğ
MAXMEMORY_ALLKEYS_RANDOM
) ?

478 
db
->
diù
 : db->
expœes
;

479 ià(
	`diùSize
(
diù
) != 0) {

480 
de
 = 
	`diùG‘RªdomKey
(
diù
);

481 
be¡key
 = 
	`diùG‘Key
(
de
);

482 
be¡dbid
 = 
j
;

489 ià(
be¡key
) {

490 
db
 = 
£rv”
.db+
be¡dbid
;

491 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
be¡key
,
	`sd¦’
(bestkey));

492 
	`´İag©eExpœe
(
db
,
keyobj
,
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
);

501 
d–
 = (è
	`zm®loc_u£d_memÜy
();

502 
	`Ï‹ncyS¹MÚ™Ü
(
eviùiÚ_Ï‹ncy
);

503 ià(
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
)

504 
	`dbAsyncD–‘e
(
db
,
keyobj
);

506 
	`dbSyncD–‘e
(
db
,
keyobj
);

507 
	`Ï‹ncyEndMÚ™Ü
(
eviùiÚ_Ï‹ncy
);

508 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-d–",
eviùiÚ_Ï‹ncy
);

509 
	`Ï‹ncyRemoveNe¡edEv’t
(
Ï‹ncy
,
eviùiÚ_Ï‹ncy
);

510 
d–
 -ğ(è
	`zm®loc_u£d_memÜy
();

511 
mem_ä“d
 +ğ
d–
;

512 
£rv”
.
¡©_eviùedkeys
++;

513 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EVICTED
, "evicted",

514 
keyobj
, 
db
->
id
);

515 
	`deüRefCouÁ
(
keyobj
);

516 
keys_ä“d
++;

522 ià(
¦aves
è
	`æushSÏvesOuutBufãrs
();

531 ià(
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
 && !(
keys_ä“d
 % 16)) {

532 
ov”h—d
 = 
	`ä“MemÜyG‘NÙCouÁedMemÜy
();

533 
mem_u£d
 = 
	`zm®loc_u£d_memÜy
();

534 
mem_u£d
 = (mem_u£d > 
ov”h—d
) ? mem_used-overhead : 0;

535 ià(
mem_u£d
 <ğ
£rv”
.
maxmemÜy
) {

536 
mem_ä“d
 = 
mem_toä“
;

541 ià(!
keys_ä“d
) {

542 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

543 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-cyşe",
Ï‹ncy
);

544 
ÿÁ_ä“
;

547 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

548 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-cyşe",
Ï‹ncy
);

549  
C_OK
;

551 
ÿÁ_ä“
:

555 
	`bioP’dšgJobsOfTy³
(
BIO_LAZY_FREE
)) {

556 ià(((
mem_»pÜ‹d
 - 
	`zm®loc_u£d_memÜy
()è+ 
mem_ä“d
è>ğ
mem_toä“
)

558 
	`u¦“p
(1000);

560  
C_ERR
;

561 
	}
}

	@src/expire.c

33 
	~"£rv”.h
"

54 
	$aùiveExpœeCyşeTryExpœe
(
»disDb
 *
db
, 
diùEÁry
 *
de
, 
now
) {

55 
t
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
);

56 ià(
now
 > 
t
) {

57 
sds
 
key
 = 
	`diùG‘Key
(
de
);

58 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

60 
	`´İag©eExpœe
(
db
,
keyobj
,
£rv”
.
Ïzyä“_Ïzy_expœe
);

61 ià(
£rv”
.
Ïzyä“_Ïzy_expœe
)

62 
	`dbAsyncD–‘e
(
db
,
keyobj
);

64 
	`dbSyncD–‘e
(
db
,
keyobj
);

65 
	`nÙifyKey¥aûEv’t
(
NOTIFY_EXPIRED
,

66 "expœed",
keyobj
,
db
->
id
);

67 
	`deüRefCouÁ
(
keyobj
);

68 
£rv”
.
¡©_expœedkeys
++;

73 
	}
}

97 
	$aùiveExpœeCyşe
(
ty³
) {

100 
cu¼’t_db
 = 0;

101 
tim–im™_ex™
 = 0;

102 
Ï¡_ç¡_cyşe
 = 0;

104 
j
, 
™”©iÚ
 = 0;

105 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

106 
¡¬t
 = 
	`u¡ime
(), 
tim–im™
, 
–­£d
;

111 ià(
	`ş›ÁsA»Pau£d
()) ;

113 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
) {

117 ià(!
tim–im™_ex™
) ;

118 ià(
¡¬t
 < 
Ï¡_ç¡_cyşe
 + 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
*2) ;

119 
Ï¡_ç¡_cyşe
 = 
¡¬t
;

129 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
 || 
tim–im™_ex™
)

130 
dbs_³r_ÿÎ
 = 
£rv”
.
dbnum
;

136 
tim–im™
 = 1000000*
ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
/
£rv”
.
hz
/100;

137 
tim–im™_ex™
 = 0;

138 ià(
tim–im™
 <= 0)imelimit = 1;

140 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
)

141 
tim–im™
 = 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
;

146 
tÙ®_§m¶ed
 = 0;

147 
tÙ®_expœed
 = 0;

149 
j
 = 0; j < 
dbs_³r_ÿÎ
 && 
tim–im™_ex™
 == 0; j++) {

150 
expœed
;

151 
»disDb
 *
db
 = 
£rv”
.db+(
cu¼’t_db
 % s”v”.
dbnum
);

156 
cu¼’t_db
++;

161 
num
, 
¦Ùs
;

162 
now
, 
‰l_sum
;

163 
‰l_§m¶es
;

164 
™”©iÚ
++;

167 ià((
num
 = 
	`diùSize
(
db
->
expœes
)) == 0) {

168 
db
->
avg_‰l
 = 0;

171 
¦Ùs
 = 
	`diùSlÙs
(
db
->
expœes
);

172 
now
 = 
	`m¡ime
();

177 ià(
num
 && 
¦Ùs
 > 
DICT_HT_INITIAL_SIZE
 &&

178 (
num
*100/
¦Ùs
 < 1)) ;

182 
expœed
 = 0;

183 
‰l_sum
 = 0;

184 
‰l_§m¶es
 = 0;

186 ià(
num
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
)

187 
num
 = 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
;

189 
num
--) {

190 
diùEÁry
 *
de
;

191 
‰l
;

193 ià((
de
 = 
	`diùG‘RªdomKey
(
db
->
expœes
)è=ğ
NULL
) ;

194 
‰l
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
)-
now
;

195 ià(
	`aùiveExpœeCyşeTryExpœe
(
db
,
de
,
now
)è
expœed
++;

196 ià(
‰l
 > 0) {

198 
‰l_sum
 +ğ
‰l
;

199 
‰l_§m¶es
++;

201 
tÙ®_§m¶ed
++;

203 
tÙ®_expœed
 +ğ
expœed
;

206 ià(
‰l_§m¶es
) {

207 
avg_‰l
 = 
‰l_sum
/
‰l_§m¶es
;

212 ià(
db
->
avg_‰l
 == 0) db->avg_ttl =‡vg_ttl;

213 
db
->
avg_‰l
 = (db->avg_ttl/50)*49 + (avg_ttl/50);

219 ià((
™”©iÚ
 & 0xf) == 0) {

220 
–­£d
 = 
	`u¡ime
()-
¡¬t
;

221 ià(
–­£d
 > 
tim–im™
) {

222 
tim–im™_ex™
 = 1;

223 
£rv”
.
¡©_expœed_time_ÿp_»ached_couÁ
++;

229 } 
expœed
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
/4);

232 
–­£d
 = 
	`u¡ime
()-
¡¬t
;

233 
	`Ï‹ncyAddSam¶eIfN“ded
("expœe-cyşe",
–­£d
/1000);

237 
cu¼’t_³rc
;

238 ià(
tÙ®_§m¶ed
) {

239 
cu¼’t_³rc
 = ()
tÙ®_expœed
/
tÙ®_§m¶ed
;

241 
cu¼’t_³rc
 = 0;

242 
£rv”
.
¡©_expœed_¡®e_³rc
 = (
cu¼’t_³rc
*0.05)+

243 (
£rv”
.
¡©_expœed_¡®e_³rc
*0.95);

244 
	}
}

281 
diù
 *
	g¦aveKeysW™hExpœe
 = 
NULL
;

285 
	$expœeSÏveKeys
() {

286 ià(
¦aveKeysW™hExpœe
 =ğ
NULL
 ||

287 
	`diùSize
(
¦aveKeysW™hExpœe
) == 0) ;

289 
cyşes
 = 0, 
nÛxpœe
 = 0;

290 
m¡ime_t
 
¡¬t
 = 
	`m¡ime
();

292 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
¦aveKeysW™hExpœe
);

293 
sds
 
keyÇme
 = 
	`diùG‘Key
(
de
);

294 
ušt64_t
 
dbids
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

295 
ušt64_t
 
Ãw_dbids
 = 0;

299 
dbid
 = 0;

300 
dbids
 && 
dbid
 < 
£rv”
.
dbnum
) {

301 ià((
dbids
 & 1) != 0) {

302 
»disDb
 *
db
 = 
£rv”
.db+
dbid
;

303 
diùEÁry
 *
expœe
 = 
	`diùFšd
(
db
->
expœes
,
keyÇme
);

304 
expœed
 = 0;

306 ià(
expœe
 &&

307 
	`aùiveExpœeCyşeTryExpœe
(
£rv”
.
db
+
dbid
,
expœe
,
¡¬t
))

309 
expœed
 = 1;

316 ià(
expœe
 && !
expœed
) {

317 
nÛxpœe
++;

318 
Ãw_dbids
 |ğ(
ušt64_t
)1 << 
dbid
;

321 
dbid
++;

322 
dbids
 >>= 1;

328 ià(
Ãw_dbids
)

329 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,
Ãw_dbids
);

331 
	`diùD–‘e
(
¦aveKeysW™hExpœe
,
keyÇme
);

335 
cyşes
++;

336 ià(
nÛxpœe
 > 3) ;

337 ià((
cyşes
 % 64è=ğ0 && 
	`m¡ime
()-
¡¬t
 > 1) ;

338 ià(
	`diùSize
(
¦aveKeysW™hExpœe
) == 0) ;

340 
	}
}

344 
	$»memb”SÏveKeyW™hExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

345 ià(
¦aveKeysW™hExpœe
 =ğ
NULL
) {

346 
diùTy³
 
dt
 = {

347 
diùSdsHash
,

348 
NULL
,

349 
NULL
,

350 
diùSdsKeyCom·»
,

351 
diùSdsDe¡ruùÜ
,

352 
NULL


354 
¦aveKeysW™hExpœe
 = 
	`diùC»©e
(&
dt
,
NULL
);

356 ià(
db
->
id
 > 63) ;

358 
diùEÁry
 *
de
 = 
	`diùAddOrFšd
(
¦aveKeysW™hExpœe
,
key
->
±r
);

363 ià(
de
->
key
 =ğkey->
±r
) {

364 
de
->
key
 = 
	`sdsdup
(key->
±r
);

365 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,0);

368 
ušt64_t
 
dbids
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

369 
dbids
 |ğ(
ušt64_t
)1 << 
db
->
id
;

370 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,
dbids
);

371 
	}
}

374 
size_t
 
	$g‘SÏveKeyW™hExpœeCouÁ
() {

375 ià(
¦aveKeysW™hExpœe
 =ğ
NULL
)  0;

376  
	`diùSize
(
¦aveKeysW™hExpœe
);

377 
	}
}

387 
	$æushSÏveKeysW™hExpœeLi¡
() {

388 ià(
¦aveKeysW™hExpœe
) {

389 
	`diùR–—£
(
¦aveKeysW™hExpœe
);

390 
¦aveKeysW™hExpœe
 = 
NULL
;

392 
	}
}

405 
	$expœeG’”icCommªd
(
ş›Á
 *
c
, 
ba£time
, 
un™
) {

406 
robj
 *
key
 = 
c
->
¬gv
[1], *
·¿m
 = c->argv[2];

407 
wh’
;

409 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
·¿m
, &
wh’
, 
NULL
è!ğ
C_OK
)

412 ià(
un™
 =ğ
UNIT_SECONDS
è
wh’
 *= 1000;

413 
wh’
 +ğ
ba£time
;

416 ià(
	`lookupKeyWr™e
(
c
->
db
,
key
è=ğ
NULL
) {

417 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

427 ià(
wh’
 <ğ
	`m¡ime
(è&& !
£rv”
.
lßdšg
 && !£rv”.
ma¡”ho¡
) {

428 
robj
 *
aux
;

430 
d–‘ed
 = 
£rv”
.
Ïzyä“_Ïzy_expœe
 ? 
	`dbAsyncD–‘e
(
c
->
db
,
key
) :

431 
	`dbSyncD–‘e
(
c
->
db
,
key
);

432 
	`£rv”As£¹W™hInfo
(
c
,
key
,
d–‘ed
);

433 
£rv”
.
dœty
++;

436 
aux
 = 
£rv”
.
Ïzyä“_Ïzy_expœe
 ? 
sh¬ed
.
uÆšk
 : sh¬ed.
d–
;

437 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
aux
,
key
);

438 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

439 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

440 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

443 
	`£tExpœe
(
c
,c->
db
,
key
,
wh’
);

444 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

445 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

446 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"expœe",
key
,
c
->
db
->
id
);

447 
£rv”
.
dœty
++;

450 
	}
}

453 
	$expœeCommªd
(
ş›Á
 *
c
) {

454 
	`expœeG’”icCommªd
(
c
,
	`m¡ime
(),
UNIT_SECONDS
);

455 
	}
}

458 
	$expœ—tCommªd
(
ş›Á
 *
c
) {

459 
	`expœeG’”icCommªd
(
c
,0,
UNIT_SECONDS
);

460 
	}
}

463 
	$³xpœeCommªd
(
ş›Á
 *
c
) {

464 
	`expœeG’”icCommªd
(
c
,
	`m¡ime
(),
UNIT_MILLISECONDS
);

465 
	}
}

468 
	$³xpœ—tCommªd
(
ş›Á
 *
c
) {

469 
	`expœeG’”icCommªd
(
c
,0,
UNIT_MILLISECONDS
);

470 
	}
}

473 
	$‰lG’”icCommªd
(
ş›Á
 *
c
, 
ouut_ms
) {

474 
expœe
, 
‰l
 = -1;

477 ià(
	`lookupKeyR—dW™hFÏgs
(
c
->
db
,c->
¬gv
[1],
LOOKUP_NOTOUCH
è=ğ
NULL
) {

478 
	`addR•lyLÚgLÚg
(
c
,-2);

483 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

484 ià(
expœe
 != -1) {

485 
‰l
 = 
expœe
-
	`m¡ime
();

486 ià(
‰l
 < 0)tl = 0;

488 ià(
‰l
 == -1) {

489 
	`addR•lyLÚgLÚg
(
c
,-1);

491 
	`addR•lyLÚgLÚg
(
c
,
ouut_ms
 ? 
‰l
 : ((ttl+500)/1000));

493 
	}
}

496 
	$‰lCommªd
(
ş›Á
 *
c
) {

497 
	`‰lG’”icCommªd
(
c
, 0);

498 
	}
}

501 
	$±Commªd
(
ş›Á
 *
c
) {

502 
	`‰lG’”icCommªd
(
c
, 1);

503 
	}
}

506 
	$³rsi¡Commªd
(
ş›Á
 *
c
) {

507 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1])) {

508 ià(
	`»moveExpœe
(
c
->
db
,c->
¬gv
[1])) {

509 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

510 
£rv”
.
dœty
++;

512 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

515 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

517 
	}
}

520 
	$touchCommªd
(
ş›Á
 *
c
) {

521 
touched
 = 0;

522 
j
 = 1; j < 
c
->
¬gc
; j++)

523 ià(
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]è!ğ
NULL
è
touched
++;

524 
	`addR•lyLÚgLÚg
(
c
,
touched
);

525 
	}
}

	@src/fmacros.h

30 #iâdeà
_REDIS_FMACRO_H


31 
	#_REDIS_FMACRO_H


	)

33 
	#_BSD_SOURCE


	)

35 #ià
defšed
(
__lšux__
)

36 
	#_GNU_SOURCE


	)

37 
	#_DEFAULT_SOURCE


	)

40 #ià
defšed
(
_AIX
)

41 
	#_ALL_SOURCE


	)

44 #ià
defšed
(
__lšux__
è|| defšed(
__O³nBSD__
)

45 
	#_XOPEN_SOURCE
 700

	)

50 #–ià!
defšed
(
__N‘BSD__
)

51 
	#_XOPEN_SOURCE


	)

54 #ià
defšed
(
__sun
)

55 
	#_POSIX_C_SOURCE
 199506L

	)

58 
	#_LARGEFILE_SOURCE


	)

59 
	#_FILE_OFFSET_BITS
 64

	)

	@src/geo.c

31 
	~"geo.h
"

32 
	~"geohash_h–³r.h
"

33 
	~"debugmaüo.h
"

37 *
zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

38 
z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

53 
geoA¼ay
 *
	$geoA¼ayC»©e
() {

54 
geoA¼ay
 *
ga
 = 
	`zm®loc
((*ga));

56 
ga
->
¬¿y
 = 
NULL
;

57 
ga
->
buck‘s
 = 0;

58 
ga
->
u£d
 = 0;

59  
ga
;

60 
	}
}

64 
geoPošt
 *
	$geoA¼ayAµ’d
(
geoA¼ay
 *
ga
) {

65 ià(
ga
->
u£d
 =ğga->
buck‘s
) {

66 
ga
->
buck‘s
 = (ga->buckets == 0) ? 8 : ga->buckets*2;

67 
ga
->
¬¿y
 = 
	`z»®loc
(ga->¬¿y,(
geoPošt
)*ga->
buck‘s
);

69 
geoPošt
 *
gp
 = 
ga
->
¬¿y
+ga->
u£d
;

70 
ga
->
u£d
++;

71  
gp
;

72 
	}
}

75 
	$geoA¼ayF»e
(
geoA¼ay
 *
ga
) {

76 
size_t
 
i
;

77 
i
 = 0; i < 
ga
->
u£d
; i++è
	`sdsä“
(ga->
¬¿y
[i].
memb”
);

78 
	`zä“
(
ga
->
¬¿y
);

79 
	`zä“
(
ga
);

80 
	}
}

85 
	$decodeGeohash
(
b™s
, *
xy
) {

86 
GeoHashB™s
 
hash
 = { .
b™s
 = (
ušt64_t
)b™s, .
¡•
 = 
GEO_STEP_MAX
 };

87  
	`geohashDecodeToLÚgL©WGS84
(
hash
, 
xy
);

88 
	}
}

93 
	$exŒaùLÚgL©OrR•ly
(
ş›Á
 *
c
, 
robj
 **
¬gv
, *
xy
) {

94 
i
;

95 
i
 = 0; i < 2; i++) {

96 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
, 
¬gv
[
i
], 
xy
 + i, 
NULL
) !=

97 
C_OK
) {

98  
C_ERR
;

101 ià(
xy
[0] < 
GEO_LONG_MIN
 || xy[0] > 
GEO_LONG_MAX
 ||

102 
xy
[1] < 
GEO_LAT_MIN
 || xy[1] > 
GEO_LAT_MAX
) {

103 
	`addR•lySds
(
c
, 
	`sdsÿrštf
(
	`sd£m±y
(),

104 "-ERR inv®id†Úg™ude,Ït™ud·œ %f,%f\r\n",
xy
[0],xy[1]));

105  
C_ERR
;

107  
C_OK
;

108 
	}
}

113 
	$lÚgL©FromMemb”
(
robj
 *
zobj
,„obj *
memb”
, *
xy
) {

114 
scÜe
 = 0;

116 ià(
	`z£tScÜe
(
zobj
, 
memb”
->
±r
, &
scÜe
è=ğ
C_ERR
)  C_ERR;

117 ià(!
	`decodeGeohash
(
scÜe
, 
xy
)è 
C_ERR
;

118  
C_OK
;

119 
	}
}

127 
	$exŒaùUn™OrR•ly
(
ş›Á
 *
c
, 
robj
 *
un™
) {

128 *
u
 = 
un™
->
±r
;

130 ià(!
	`¡rcmp
(
u
, "m")) {

132 } ià(!
	`¡rcmp
(
u
, "km")) {

134 } ià(!
	`¡rcmp
(
u
, "ft")) {

136 } ià(!
	`¡rcmp
(
u
, "mi")) {

139 
	`addR•lyE¼Ü
(
c
,

143 
	}
}

152 
	$exŒaùDi¡ªûOrR•ly
(
ş›Á
 *
c
, 
robj
 **
¬gv
,

153 *
cÚv”siÚ
) {

154 
di¡ªû
;

155 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
, 
¬gv
[0], &
di¡ªû
,

156 "Ãed‚um”iø¿dius"è!ğ
C_OK
) {

160 ià(
di¡ªû
 < 0) {

161 
	`addR•lyE¼Ü
(
c
,"radius cannot be‚egative");

165 
to_m‘”s
 = 
	`exŒaùUn™OrR•ly
(
c
,
¬gv
[1]);

166 ià(
to_m‘”s
 < 0) {

170 ià(
cÚv”siÚ
è*cÚv”siÚ = 
to_m‘”s
;

171  
di¡ªû
 * 
to_m‘”s
;

172 
	}
}

179 
	$addR•lyDoubËDi¡ªû
(
ş›Á
 *
c
, 
d
) {

180 
dbuf
[128];

181 
dËn
 = 
	`¢´štf
(
dbuf
, (dbuf), "%.4f", 
d
);

182 
	`addR•lyBulkCBufãr
(
c
, 
dbuf
, 
dËn
);

183 
	}
}

191 
	$geoAµ’dIfW™hšRadius
(
geoA¼ay
 *
ga
, 
lÚ
, 
Ït
, 
¿dius
, 
scÜe
, 
sds
 
memb”
) {

192 
di¡ªû
, 
xy
[2];

194 ià(!
	`decodeGeohash
(
scÜe
,
xy
)è 
C_ERR
;

197 ià(!
	`geohashG‘Di¡ªûIfInRadiusWGS84
(
lÚ
,
Ït
, 
xy
[0], xy[1],

198 
¿dius
, &
di¡ªû
))

200  
C_ERR
;

204 
geoPošt
 *
gp
 = 
	`geoA¼ayAµ’d
(
ga
);

205 
gp
->
lÚg™ude
 = 
xy
[0];

206 
gp
->
Ït™ude
 = 
xy
[1];

207 
gp
->
di¡
 = 
di¡ªû
;

208 
gp
->
memb”
 = member;

209 
gp
->
scÜe
 = score;

210  
C_OK
;

211 
	}
}

225 
	$geoG‘PoštsInRªge
(
robj
 *
zobj
, 
mš
, 
max
, 
lÚ
, 
Ït
, 
¿dius
, 
geoA¼ay
 *
ga
) {

228 
z¿nge¥ec
 
¿nge
 = { .
mš
 = mš, .
max
 = max, .
mšex
 = 0, .
maxex
 = 1 };

229 
size_t
 
ÜigšcouÁ
 = 
ga
->
u£d
;

230 
sds
 
memb”
;

232 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

233 *
zl
 = 
zobj
->
±r
;

234 *
•Œ
, *
¥Œ
;

235 *
v¡r
 = 
NULL
;

236 
vËn
 = 0;

237 
vlÚg
 = 0;

238 
scÜe
 = 0;

240 ià((
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
, &
¿nge
)è=ğ
NULL
) {

245 
¥Œ
 = 
	`zli¡Next
(
zl
, 
•Œ
);

246 
•Œ
) {

247 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

250 ià(!
	`z¦V®ueL‹Max
(
scÜe
, &
¿nge
))

254 
	`zli¡G‘
(
•Œ
, &
v¡r
, &
vËn
, &
vlÚg
);

255 
memb”
 = (
v¡r
 =ğ
NULL
è? 
	`sdsäomlÚglÚg
(
vlÚg
) :

256 
	`sd¢ewËn
(
v¡r
,
vËn
);

257 ià(
	`geoAµ’dIfW™hšRadius
(
ga
,
lÚ
,
Ït
,
¿dius
,
scÜe
,
memb”
)

258 =ğ
C_ERR
è
	`sdsä“
(
memb”
);

259 
	`zzlNext
(
zl
, &
•Œ
, &
¥Œ
);

261 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

262 
z£t
 *
zs
 = 
zobj
->
±r
;

263 
zskli¡
 *
z¦
 = 
zs
->zsl;

264 
zskli¡Node
 *
Ê
;

266 ià((
Ê
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
)è=ğ
NULL
) {

271 
Ê
) {

272 
sds
 
–e
 = 
Ê
->ele;

274 ià(!
	`z¦V®ueL‹Max
(
Ê
->
scÜe
, &
¿nge
))

277 
–e
 = 
	`sdsdup
(ele);

278 ià(
	`geoAµ’dIfW™hšRadius
(
ga
,
lÚ
,
Ït
,
¿dius
,
Ê
->
scÜe
,
–e
)

279 =ğ
C_ERR
è
	`sdsä“
(
–e
);

280 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

283  
ga
->
u£d
 - 
ÜigšcouÁ
;

284 
	}
}

289 
	$scÜesOfGeoHashBox
(
GeoHashB™s
 
hash
, 
GeoHashFix52B™s
 *
mš
, GeoHashFix52B™ *
max
) {

310 *
mš
 = 
	`geohashAlign52B™s
(
hash
);

311 
hash
.
b™s
++;

312 *
max
 = 
	`geohashAlign52B™s
(
hash
);

313 
	}
}

318 
	$memb”sOfGeoHashBox
(
robj
 *
zobj
, 
GeoHashB™s
 
hash
, 
geoA¼ay
 *
ga
, 
lÚ
, 
Ït
, 
¿dius
) {

319 
GeoHashFix52B™s
 
mš
, 
max
;

321 
	`scÜesOfGeoHashBox
(
hash
,&
mš
,&
max
);

322  
	`geoG‘PoštsInRªge
(
zobj
, 
mš
, 
max
, 
lÚ
, 
Ït
, 
¿dius
, 
ga
);

323 
	}
}

326 
	$memb”sOfAÎNeighbÜs
(
robj
 *
zobj
, 
GeoHashRadius
 
n
, 
lÚ
, 
Ït
, 
¿dius
, 
geoA¼ay
 *
ga
) {

327 
GeoHashB™s
 
ÃighbÜs
[9];

328 
i
, 
couÁ
 = 0, 
Ï¡_´oûs£d
 = 0;

329 
debugmsg
 = 0;

331 
ÃighbÜs
[0] = 
n
.
hash
;

332 
ÃighbÜs
[1] = 
n
.ÃighbÜs.
nÜth
;

333 
ÃighbÜs
[2] = 
n
.ÃighbÜs.
south
;

334 
ÃighbÜs
[3] = 
n
.ÃighbÜs.
—¡
;

335 
ÃighbÜs
[4] = 
n
.ÃighbÜs.
we¡
;

336 
ÃighbÜs
[5] = 
n
.ÃighbÜs.
nÜth_—¡
;

337 
ÃighbÜs
[6] = 
n
.ÃighbÜs.
nÜth_we¡
;

338 
ÃighbÜs
[7] = 
n
.ÃighbÜs.
south_—¡
;

339 
ÃighbÜs
[8] = 
n
.ÃighbÜs.
south_we¡
;

343 
i
 = 0; i < (
ÃighbÜs
) / (*neighbors); i++) {

344 ià(
	`HASHISZERO
(
ÃighbÜs
[
i
])) {

345 ià(
debugmsg
è
	`D
("ÃighbÜs[%d] i z”o",
i
);

350 ià(
debugmsg
) {

351 
GeoHashRªge
 
lÚg_¿nge
, 
Ït_¿nge
;

352 
	`geohashG‘CoÜdRªge
(&
lÚg_¿nge
,&
Ït_¿nge
);

353 
GeoHashA»a
 
my¬—
 = {{0}};

354 
	`geohashDecode
(
lÚg_¿nge
, 
Ït_¿nge
, 
ÃighbÜs
[
i
], &
my¬—
);

357 
	`D
("ÃighbÜs[%d]:\n",
i
);

358 
	`D
("¬—.lÚg™ude.mš: %f\n", 
my¬—
.
lÚg™ude
.
mš
);

359 
	`D
("¬—.lÚg™ude.max: %f\n", 
my¬—
.
lÚg™ude
.
max
);

360 
	`D
("¬—.Ït™ude.mš: %f\n", 
my¬—
.
Ït™ude
.
mš
);

361 
	`D
("¬—.Ït™ude.max: %f\n", 
my¬—
.
Ït™ude
.
max
);

362 
	`D
("\n");

369 ià(
Ï¡_´oûs£d
 &&

370 
ÃighbÜs
[
i
].
b™s
 =ğÃighbÜs[
Ï¡_´oûs£d
].bits &&

371 
ÃighbÜs
[
i
].
¡•
 =ğÃighbÜs[
Ï¡_´oûs£d
].step)

373 ià(
debugmsg
)

374 
	`D
("Skpšg…roûssšg oà%d, sama ´evious\n",
i
);

377 
couÁ
 +ğ
	`memb”sOfGeoHashBox
(
zobj
, 
ÃighbÜs
[
i
], 
ga
, 
lÚ
, 
Ït
, 
¿dius
);

378 
Ï¡_´oûs£d
 = 
i
;

380  
couÁ
;

381 
	}
}

384 
	$sÜt_gp_asc
(cÚ¡ *
a
, cÚ¡ *
b
) {

385 cÚ¡ 
geoPošt
 *
g·
 = 
a
, *
gpb
 = 
b
;

388 ià(
g·
->
di¡
 > 
gpb
->dist)

390 ià(
g·
->
di¡
 =ğ
gpb
->dist)

394 
	}
}

396 
	$sÜt_gp_desc
(cÚ¡ *
a
, cÚ¡ *
b
) {

397  -
	`sÜt_gp_asc
(
a
, 
b
);

398 
	}
}

405 
	$geßddCommªd
(
ş›Á
 *
c
) {

407 ià((
c
->
¬gc
 - 2) % 3 != 0) {

409 
	`addR•lyE¼Ü
(
c
, "syntaxƒrror. Try GEOADD key [x1] [y1] [name1] "

414 
–em’ts
 = (
c
->
¬gc
 - 2) / 3;

415 
¬gc
 = 2+
–em’ts
*2;

416 
robj
 **
¬gv
 = 
	`zÿÎoc
(
¬gc
*(robj*));

417 
¬gv
[0] = 
	`ü—‹RawSŒšgObjeù
("zadd",4);

418 
¬gv
[1] = 
c
->argv[1];

419 
	`šüRefCouÁ
(
¬gv
[1]);

424 
i
;

425 
i
 = 0; i < 
–em’ts
; i++) {

426 
xy
[2];

428 ià(
	`exŒaùLÚgL©OrR•ly
(
c
, (c->
¬gv
+2)+(
i
*3),
xy
è=ğ
C_ERR
) {

429 
i
 = 0; i < 
¬gc
; i++)

430 ià(
¬gv
[
i
]è
	`deüRefCouÁ
(argv[i]);

431 
	`zä“
(
¬gv
);

436 
GeoHashB™s
 
hash
;

437 
	`geohashEncodeWGS84
(
xy
[0], xy[1], 
GEO_STEP_MAX
, &
hash
);

438 
GeoHashFix52B™s
 
b™s
 = 
	`geohashAlign52B™s
(
hash
);

439 
robj
 *
scÜe
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
	`sdsäomlÚglÚg
(
b™s
));

440 
robj
 *
v®
 = 
c
->
¬gv
[2 + 
i
 * 3 + 2];

441 
¬gv
[2+
i
*2] = 
scÜe
;

442 
¬gv
[3+
i
*2] = 
v®
;

443 
	`šüRefCouÁ
(
v®
);

447 
	`»¶aûCl›ÁCommªdVeùÜ
(
c
,
¬gc
,
¬gv
);

448 
	`zaddCommªd
(
c
);

449 
	}
}

451 
	#SORT_NONE
 0

	)

452 
	#SORT_ASC
 1

	)

453 
	#SORT_DESC
 2

	)

455 
	#RADIUS_COORDS
 (1<<0è

	)

456 
	#RADIUS_MEMBER
 (1<<1è

	)

457 
	#RADIUS_NOSTORE
 (1<<2è

	)

462 
	$geÜadiusG’”ic
(
ş›Á
 *
c
, 
æags
) {

463 
robj
 *
key
 = 
c
->
¬gv
[1];

464 
robj
 *
¡Üekey
 = 
NULL
;

465 
¡Üedi¡
 = 0;

468 
robj
 *
zobj
 = 
NULL
;

469 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

470 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) {

475 
ba£_¬gs
;

476 
xy
[2] = { 0 };

477 ià(
æags
 & 
RADIUS_COORDS
) {

478 
ba£_¬gs
 = 6;

479 ià(
	`exŒaùLÚgL©OrR•ly
(
c
, c->
¬gv
 + 2, 
xy
è=ğ
C_ERR
)

481 } ià(
æags
 & 
RADIUS_MEMBER
) {

482 
ba£_¬gs
 = 5;

483 
robj
 *
memb”
 = 
c
->
¬gv
[2];

484 ià(
	`lÚgL©FromMemb”
(
zobj
, 
memb”
, 
xy
è=ğ
C_ERR
) {

485 
	`addR•lyE¼Ü
(
c
, "could‚ot decode„equested zset member");

489 
	`addR•lyE¼Ü
(
c
, "Unknown georadius searchype");

494 
¿dius_m‘”s
 = 0, 
cÚv”siÚ
 = 1;

495 ià((
¿dius_m‘”s
 = 
	`exŒaùDi¡ªûOrR•ly
(
c
, c->
¬gv
 + 
ba£_¬gs
 - 2,

496 &
cÚv”siÚ
)) < 0) {

501 
w™hdi¡
 = 0, 
w™hhash
 = 0, 
w™hcoÜds
 = 0;

502 
sÜt
 = 
SORT_NONE
;

503 
couÁ
 = 0;

504 ià(
c
->
¬gc
 > 
ba£_¬gs
) {

505 
»maššg
 = 
c
->
¬gc
 - 
ba£_¬gs
;

506 
i
 = 0; i < 
»maššg
; i++) {

507 *
¬g
 = 
c
->
¬gv
[
ba£_¬gs
 + 
i
]->
±r
;

508 ià(!
	`¡rÿ£cmp
(
¬g
, "withdist")) {

509 
w™hdi¡
 = 1;

510 } ià(!
	`¡rÿ£cmp
(
¬g
, "withhash")) {

511 
w™hhash
 = 1;

512 } ià(!
	`¡rÿ£cmp
(
¬g
, "withcoord")) {

513 
w™hcoÜds
 = 1;

514 } ià(!
	`¡rÿ£cmp
(
¬g
, "asc")) {

515 
sÜt
 = 
SORT_ASC
;

516 } ià(!
	`¡rÿ£cmp
(
¬g
, "desc")) {

517 
sÜt
 = 
SORT_DESC
;

518 } ià(!
	`¡rÿ£cmp
(
¬g
, "couÁ"è&& (
i
+1è< 
»maššg
) {

519 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
ba£_¬gs
+
i
+1],

520 &
couÁ
, 
NULL
è!ğ
C_OK
) ;

521 ià(
couÁ
 <= 0) {

522 
	`addR•lyE¼Ü
(
c
,"COUNT must be > 0");

525 
i
++;

526 } ià(!
	`¡rÿ£cmp
(
¬g
, "store") &&

527 (
i
+1è< 
»maššg
 &&

528 !(
æags
 & 
RADIUS_NOSTORE
))

530 
¡Üekey
 = 
c
->
¬gv
[
ba£_¬gs
+
i
+1];

531 
¡Üedi¡
 = 0;

532 
i
++;

533 } ià(!
	`¡rÿ£cmp
(
¬g
, "storedist") &&

534 (
i
+1è< 
»maššg
 &&

535 !(
æags
 & 
RADIUS_NOSTORE
))

537 
¡Üekey
 = 
c
->
¬gv
[
ba£_¬gs
+
i
+1];

538 
¡Üedi¡
 = 1;

539 
i
++;

541 
	`addR•ly
(
c
, 
sh¬ed
.
syÁax”r
);

548 ià(
¡Üekey
 && (
w™hdi¡
 || 
w™hhash
 || 
w™hcoÜds
)) {

549 
	`addR•lyE¼Ü
(
c
,

557 ià(
couÁ
 !ğ0 && 
sÜt
 =ğ
SORT_NONE
èsÜˆğ
SORT_ASC
;

560 
GeoHashRadius
 
geÜadius
 =

561 
	`geohashG‘A»asByRadiusWGS84
(
xy
[0], xy[1], 
¿dius_m‘”s
);

564 
geoA¼ay
 *
ga
 = 
	`geoA¼ayC»©e
();

565 
	`memb”sOfAÎNeighbÜs
(
zobj
, 
geÜadius
, 
xy
[0], xy[1], 
¿dius_m‘”s
, 
ga
);

568 ià(
ga
->
u£d
 =ğ0 && 
¡Üekey
 =ğ
NULL
) {

569 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

570 
	`geoA¼ayF»e
(
ga
);

574 
»suÉ_Ëngth
 = 
ga
->
u£d
;

575 
»tuºed_™ems
 = (
couÁ
 =ğ0 || 
»suÉ_Ëngth
 < count) ?

576 
»suÉ_Ëngth
 : 
couÁ
;

577 
İtiÚ_Ëngth
 = 0;

580 ià(
sÜt
 =ğ
SORT_ASC
) {

581 
	`qsÜt
(
ga
->
¬¿y
, 
»suÉ_Ëngth
, (
geoPošt
), 
sÜt_gp_asc
);

582 } ià(
sÜt
 =ğ
SORT_DESC
) {

583 
	`qsÜt
(
ga
->
¬¿y
, 
»suÉ_Ëngth
, (
geoPošt
), 
sÜt_gp_desc
);

586 ià(
¡Üekey
 =ğ
NULL
) {

591 ià(
w™hdi¡
)

592 
İtiÚ_Ëngth
++;

594 ià(
w™hcoÜds
)

595 
İtiÚ_Ëngth
++;

597 ià(
w™hhash
)

598 
İtiÚ_Ëngth
++;

604 
	`addR•lyMuÉiBulkL’
(
c
, 
»tuºed_™ems
);

607 
i
;

608 
i
 = 0; i < 
»tuºed_™ems
; i++) {

609 
geoPošt
 *
gp
 = 
ga
->
¬¿y
+
i
;

610 
gp
->
di¡
 /ğ
cÚv”siÚ
;

615 ià(
İtiÚ_Ëngth
)

616 
	`addR•lyMuÉiBulkL’
(
c
, 
İtiÚ_Ëngth
 + 1);

618 
	`addR•lyBulkSds
(
c
,
gp
->
memb”
);

619 
gp
->
memb”
 = 
NULL
;

621 ià(
w™hdi¡
)

622 
	`addR•lyDoubËDi¡ªû
(
c
, 
gp
->
di¡
);

624 ià(
w™hhash
)

625 
	`addR•lyLÚgLÚg
(
c
, 
gp
->
scÜe
);

627 ià(
w™hcoÜds
) {

628 
	`addR•lyMuÉiBulkL’
(
c
, 2);

629 
	`addR•lyHumªLÚgDoubË
(
c
, 
gp
->
lÚg™ude
);

630 
	`addR•lyHumªLÚgDoubË
(
c
, 
gp
->
Ït™ude
);

635 
robj
 *
zobj
;

636 
z£t
 *
zs
;

637 
i
;

638 
size_t
 
max––’
 = 0;

640 ià(
»tuºed_™ems
) {

641 
zobj
 = 
	`ü—‹Z£tObjeù
();

642 
zs
 = 
zobj
->
±r
;

645 
i
 = 0; i < 
»tuºed_™ems
; i++) {

646 
zskli¡Node
 *
znode
;

647 
geoPošt
 *
gp
 = 
ga
->
¬¿y
+
i
;

648 
gp
->
di¡
 /ğ
cÚv”siÚ
;

649 
scÜe
 = 
¡Üedi¡
 ? 
gp
->
di¡
 : gp->score;

650 
size_t
 
––’
 = 
	`sd¦’
(
gp
->
memb”
);

652 ià(
max––’
 < 
––’
) maxelelen =ƒlelen;

653 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
gp
->
memb”
);

654 
	`£rv”As£¹
(
	`diùAdd
(
zs
->
diù
,
gp
->
memb”
,&
znode
->
scÜe
è=ğ
DICT_OK
);

655 
gp
->
memb”
 = 
NULL
;

658 ià(
»tuºed_™ems
) {

659 
	`z£tCÚv”tToZli¡IfN“ded
(
zobj
,
max––’
);

660 
	`£tKey
(
c
->
db
,
¡Üekey
,
zobj
);

661 
	`deüRefCouÁ
(
zobj
);

662 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"geÜadius¡Üe",
¡Üekey
,

663 
c
->
db
->
id
);

664 
£rv”
.
dœty
 +ğ
»tuºed_™ems
;

665 } ià(
	`dbD–‘e
(
c
->
db
,
¡Üekey
)) {

666 
	`sigÇlModif›dKey
(
c
->
db
,
¡Üekey
);

667 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
¡Üekey
,
c
->
db
->
id
);

668 
£rv”
.
dœty
++;

670 
	`addR•lyLÚgLÚg
(
c
, 
»tuºed_™ems
);

672 
	`geoA¼ayF»e
(
ga
);

673 
	}
}

676 
	$geÜadiusCommªd
(
ş›Á
 *
c
) {

677 
	`geÜadiusG’”ic
(
c
, 
RADIUS_COORDS
);

678 
	}
}

681 
	$geÜadiusbymemb”Commªd
(
ş›Á
 *
c
) {

682 
	`geÜadiusG’”ic
(
c
, 
RADIUS_MEMBER
);

683 
	}
}

686 
	$geÜadiu¤oCommªd
(
ş›Á
 *
c
) {

687 
	`geÜadiusG’”ic
(
c
, 
RADIUS_COORDS
|
RADIUS_NOSTORE
);

688 
	}
}

691 
	$geÜadiusbymemb”roCommªd
(
ş›Á
 *
c
) {

692 
	`geÜadiusG’”ic
(
c
, 
RADIUS_MEMBER
|
RADIUS_NOSTORE
);

693 
	}
}

699 
	$geohashCommªd
(
ş›Á
 *
c
) {

700 *
geßÍhab‘
= "0123456789bcdefghjkmnpqrstuvwxyz";

701 
j
;

704 
robj
 *
zobj
 = 
	`lookupKeyR—d
(
c
->
db
, c->
¬gv
[1]);

705 ià(
zobj
 && 
	`checkTy³
(
c
, zobj, 
OBJ_ZSET
)) ;

709 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-2);

710 
j
 = 2; j < 
c
->
¬gc
; j++) {

711 
scÜe
;

712 ià(!
zobj
 || 
	`z£tScÜe
(zobj, 
c
->
¬gv
[
j
]->
±r
, &
scÜe
è=ğ
C_ERR
) {

713 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

722 
xy
[2];

723 ià(!
	`decodeGeohash
(
scÜe
,
xy
)) {

724 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

729 
GeoHashRªge
 
r
[2];

730 
GeoHashB™s
 
hash
;

731 
r
[0].
mš
 = -180;

732 
r
[0].
max
 = 180;

733 
r
[1].
mš
 = -90;

734 
r
[1].
max
 = 90;

735 
	`geohashEncode
(&
r
[0],&r[1],
xy
[0],xy[1],26,&
hash
);

737 
buf
[12];

738 
i
;

739 
i
 = 0; i < 11; i++) {

740 
idx
 = (
hash
.
b™s
 >> (52-((
i
+1)*5))) & 0x1f;

741 
buf
[
i
] = 
geßÍhab‘
[
idx
];

743 
buf
[11] = '\0';

744 
	`addR•lyBulkCBufãr
(
c
,
buf
,11);

747 
	}
}

753 
	$geİosCommªd
(
ş›Á
 *
c
) {

754 
j
;

757 
robj
 *
zobj
 = 
	`lookupKeyR—d
(
c
->
db
, c->
¬gv
[1]);

758 ià(
zobj
 && 
	`checkTy³
(
c
, zobj, 
OBJ_ZSET
)) ;

762 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-2);

763 
j
 = 2; j < 
c
->
¬gc
; j++) {

764 
scÜe
;

765 ià(!
zobj
 || 
	`z£tScÜe
(zobj, 
c
->
¬gv
[
j
]->
±r
, &
scÜe
è=ğ
C_ERR
) {

766 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

769 
xy
[2];

770 ià(!
	`decodeGeohash
(
scÜe
,
xy
)) {

771 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

774 
	`addR•lyMuÉiBulkL’
(
c
,2);

775 
	`addR•lyHumªLÚgDoubË
(
c
,
xy
[0]);

776 
	`addR•lyHumªLÚgDoubË
(
c
,
xy
[1]);

779 
	}
}

786 
	$geodi¡Commªd
(
ş›Á
 *
c
) {

787 
to_m‘”
 = 1;

790 ià(
c
->
¬gc
 == 5) {

791 
to_m‘”
 = 
	`exŒaùUn™OrR•ly
(
c
,c->
¬gv
[4]);

792 ià(
to_m‘”
 < 0) ;

793 } ià(
c
->
¬gc
 > 5) {

794 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

799 
robj
 *
zobj
 = 
NULL
;

800 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, c->
¬gv
[1], 
sh¬ed
.
nuÎbulk
))

801 =ğ
NULL
 || 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) ;

804 
scÜe1
, 
scÜe2
, 
xyxy
[4];

805 ià(
	`z£tScÜe
(
zobj
, 
c
->
¬gv
[2]->
±r
, &
scÜe1
è=ğ
C_ERR
 ||

806 
	`z£tScÜe
(
zobj
, 
c
->
¬gv
[3]->
±r
, &
scÜe2
è=ğ
C_ERR
)

808 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

813 ià(!
	`decodeGeohash
(
scÜe1
,
xyxy
è|| !decodeGeohash(
scÜe2
,xyxy+2))

814 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

816 
	`addR•lyDoubËDi¡ªû
(
c
,

817 
	`geohashG‘Di¡ªû
(
xyxy
[0],xyxy[1],xyxy[2],xyxy[3]è/ 
to_m‘”
);

818 
	}
}

	@src/geo.h

1 #iâdeà
__GEO_H__


2 
	#__GEO_H__


	)

4 
	~"£rv”.h
"

8 
	sgeoPošt
 {

9 
	mlÚg™ude
;

10 
	mÏt™ude
;

11 
	mdi¡
;

12 
	mscÜe
;

13 *
	mmemb”
;

14 } 
	tgeoPošt
;

16 
	sgeoA¼ay
 {

17 
geoPošt
 *
	m¬¿y
;

18 
size_t
 
	mbuck‘s
;

19 
size_t
 
	mu£d
;

20 } 
	tgeoA¼ay
;

	@src/geohash.c

31 
	~"geohash.h
"

52 
šlše
 
ušt64_t
 
	$š‹¾—ve64
(
ušt32_t
 
xlo
, ušt32_ˆ
ylo
) {

53 cÚ¡ 
ušt64_t
 
B
[] = {0x5555555555555555ULL, 0x3333333333333333ULL,

56 cÚ¡ 
S
[] = {1, 2, 4, 8, 16};

58 
ušt64_t
 
x
 = 
xlo
;

59 
ušt64_t
 
y
 = 
ylo
;

61 
x
 = (x | (x << 
S
[4])è& 
B
[4];

62 
y
 = (y | (y << 
S
[4])è& 
B
[4];

64 
x
 = (x | (x << 
S
[3])è& 
B
[3];

65 
y
 = (y | (y << 
S
[3])è& 
B
[3];

67 
x
 = (x | (x << 
S
[2])è& 
B
[2];

68 
y
 = (y | (y << 
S
[2])è& 
B
[2];

70 
x
 = (x | (x << 
S
[1])è& 
B
[1];

71 
y
 = (y | (y << 
S
[1])è& 
B
[1];

73 
x
 = (x | (x << 
S
[0])è& 
B
[0];

74 
y
 = (y | (y << 
S
[0])è& 
B
[0];

76  
x
 | (
y
 << 1);

77 
	}
}

82 
šlše
 
ušt64_t
 
	$deš‹¾—ve64
(
ušt64_t
 
š‹¾—ved
) {

83 cÚ¡ 
ušt64_t
 
B
[] = {0x5555555555555555ULL, 0x3333333333333333ULL,

86 cÚ¡ 
S
[] = {0, 1, 2, 4, 8, 16};

88 
ušt64_t
 
x
 = 
š‹¾—ved
;

89 
ušt64_t
 
y
 = 
š‹¾—ved
 >> 1;

91 
x
 = (x | (x >> 
S
[0])è& 
B
[0];

92 
y
 = (y | (y >> 
S
[0])è& 
B
[0];

94 
x
 = (x | (x >> 
S
[1])è& 
B
[1];

95 
y
 = (y | (y >> 
S
[1])è& 
B
[1];

97 
x
 = (x | (x >> 
S
[2])è& 
B
[2];

98 
y
 = (y | (y >> 
S
[2])è& 
B
[2];

100 
x
 = (x | (x >> 
S
[3])è& 
B
[3];

101 
y
 = (y | (y >> 
S
[3])è& 
B
[3];

103 
x
 = (x | (x >> 
S
[4])è& 
B
[4];

104 
y
 = (y | (y >> 
S
[4])è& 
B
[4];

106 
x
 = (x | (x >> 
S
[5])è& 
B
[5];

107 
y
 = (y | (y >> 
S
[5])è& 
B
[5];

109  
x
 | (
y
 << 32);

110 
	}
}

112 
	$geohashG‘CoÜdRªge
(
GeoHashRªge
 *
lÚg_¿nge
, GeoHashRªg*
Ït_¿nge
) {

115 
lÚg_¿nge
->
max
 = 
GEO_LONG_MAX
;

116 
lÚg_¿nge
->
mš
 = 
GEO_LONG_MIN
;

117 
Ït_¿nge
->
max
 = 
GEO_LAT_MAX
;

118 
Ït_¿nge
->
mš
 = 
GEO_LAT_MIN
;

119 
	}
}

121 
	$geohashEncode
(cÚ¡ 
GeoHashRªge
 *
lÚg_¿nge
, cÚ¡ GeoHashRªg*
Ït_¿nge
,

122 
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

123 
GeoHashB™s
 *
hash
) {

125 ià(
hash
 =ğ
NULL
 || 
¡•
 > 32 || step == 0 ||

126 
	`RANGEPISZERO
(
Ït_¿nge
è|| RANGEPISZERO(
lÚg_¿nge
))  0;

130 ià(
lÚg™ude
 > 180 ||†ongitude < -180 ||

131 
Ït™ude
 > 85.05112878 ||†atitude < -85.05112878)  0;

133 
hash
->
b™s
 = 0;

134 
hash
->
¡•
 = step;

136 ià(
Ït™ude
 < 
Ït_¿nge
->
mš
 ||†©™ud>†©_¿nge->
max
 ||

137 
lÚg™ude
 < 
lÚg_¿nge
->
mš
 ||†Úg™ud>†Úg_¿nge->
max
) {

141 
Ït_off£t
 =

142 (
Ït™ude
 - 
Ït_¿nge
->
mš
è/ (Ït_¿nge->
max
 -†at_range->min);

143 
lÚg_off£t
 =

144 (
lÚg™ude
 - 
lÚg_¿nge
->
mš
è/ (lÚg_¿nge->
max
 -†ong_range->min);

147 
Ït_off£t
 *ğ(1 << 
¡•
);

148 
lÚg_off£t
 *ğ(1 << 
¡•
);

149 
hash
->
b™s
 = 
	`š‹¾—ve64
(
Ït_off£t
, 
lÚg_off£t
);

151 
	}
}

153 
	$geohashEncodeTy³
(
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
, 
GeoHashB™s
 *
hash
) {

154 
GeoHashRªge
 
r
[2] = {{0}};

155 
	`geohashG‘CoÜdRªge
(&
r
[0], &r[1]);

156  
	`geohashEncode
(&
r
[0], &r[1], 
lÚg™ude
, 
Ït™ude
, 
¡•
, 
hash
);

157 
	}
}

159 
	$geohashEncodeWGS84
(
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

160 
GeoHashB™s
 *
hash
) {

161  
	`geohashEncodeTy³
(
lÚg™ude
, 
Ït™ude
, 
¡•
, 
hash
);

162 
	}
}

164 
	$geohashDecode
(cÚ¡ 
GeoHashRªge
 
lÚg_¿nge
, cÚ¡ GeoHashRªg
Ït_¿nge
,

165 cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
) {

166 ià(
	`HASHISZERO
(
hash
è|| 
NULL
 =ğ
¬—
 || 
	`RANGEISZERO
(
Ït_¿nge
) ||

167 
	`RANGEISZERO
(
lÚg_¿nge
)) {

171 
¬—
->
hash
 = hash;

172 
ušt8_t
 
¡•
 = 
hash
.step;

173 
ušt64_t
 
hash_£p
 = 
	`deš‹¾—ve64
(
hash
.
b™s
);

175 
Ït_sÿË
 = 
Ït_¿nge
.
max
 -†©_¿nge.
mš
;

176 
lÚg_sÿË
 = 
lÚg_¿nge
.
max
 -†Úg_¿nge.
mš
;

178 
ušt32_t
 
©o
 = 
hash_£p
;

179 
ušt32_t
 
Úo
 = 
hash_£p
 >> 32;

184 
¬—
->
Ït™ude
.
mš
 =

185 
Ït_¿nge
.
mš
 + (
©o
 * 1.0 / (1uÎ << 
¡•
)è* 
Ït_sÿË
;

186 
¬—
->
Ït™ude
.
max
 =

187 
Ït_¿nge
.
mš
 + ((
©o
 + 1è* 1.0 / (1uÎ << 
¡•
)è* 
Ït_sÿË
;

188 
¬—
->
lÚg™ude
.
mš
 =

189 
lÚg_¿nge
.
mš
 + (
Úo
 * 1.0 / (1uÎ << 
¡•
)è* 
lÚg_sÿË
;

190 
¬—
->
lÚg™ude
.
max
 =

191 
lÚg_¿nge
.
mš
 + ((
Úo
 + 1è* 1.0 / (1uÎ << 
¡•
)è* 
lÚg_sÿË
;

194 
	}
}

196 
	$geohashDecodeTy³
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
) {

197 
GeoHashRªge
 
r
[2] = {{0}};

198 
	`geohashG‘CoÜdRªge
(&
r
[0], &r[1]);

199  
	`geohashDecode
(
r
[0],„[1], 
hash
, 
¬—
);

200 
	}
}

202 
	$geohashDecodeWGS84
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
) {

203  
	`geohashDecodeTy³
(
hash
, 
¬—
);

204 
	}
}

206 
	$geohashDecodeA»aToLÚgL©
(cÚ¡ 
GeoHashA»a
 *
¬—
, *
xy
) {

207 ià(!
xy
)  0;

208 
xy
[0] = (
¬—
->
lÚg™ude
.
mš
 +‡»a->lÚg™ude.
max
) / 2;

209 
xy
[1] = (
¬—
->
Ït™ude
.
mš
 +‡»a->Ït™ude.
max
) / 2;

211 
	}
}

213 
	$geohashDecodeToLÚgL©Ty³
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
) {

214 
GeoHashA»a
 
¬—
 = {{0}};

215 ià(!
xy
 || !
	`geohashDecodeTy³
(
hash
, &
¬—
))

217  
	`geohashDecodeA»aToLÚgL©
(&
¬—
, 
xy
);

218 
	}
}

220 
	$geohashDecodeToLÚgL©WGS84
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
) {

221  
	`geohashDecodeToLÚgL©Ty³
(
hash
, 
xy
);

222 
	}
}

224 
	$geohash_move_x
(
GeoHashB™s
 *
hash
, 
št8_t
 
d
) {

225 ià(
d
 == 0)

228 
ušt64_t
 
x
 = 
hash
->
b™s
 & 0xaaaaaaaaaaaaaaaaULL;

229 
ušt64_t
 
y
 = 
hash
->
b™s
 & 0x5555555555555555ULL;

231 
ušt64_t
 
zz
 = 0x5555555555555555ULL >> (64 - 
hash
->
¡•
 * 2);

233 ià(
d
 > 0) {

234 
x
 = x + (
zz
 + 1);

236 
x
 = x | 
zz
;

237 
x
 = x - (
zz
 + 1);

240 
x
 &ğ(0x¯¯¯¯¯¯¯¯ULL >> (64 - 
hash
->
¡•
 * 2));

241 
hash
->
b™s
 = (
x
 | 
y
);

242 
	}
}

244 
	$geohash_move_y
(
GeoHashB™s
 *
hash
, 
št8_t
 
d
) {

245 ià(
d
 == 0)

248 
ušt64_t
 
x
 = 
hash
->
b™s
 & 0xaaaaaaaaaaaaaaaaULL;

249 
ušt64_t
 
y
 = 
hash
->
b™s
 & 0x5555555555555555ULL;

251 
ušt64_t
 
zz
 = 0x¯¯¯¯¯¯¯¯ULL >> (64 - 
hash
->
¡•
 * 2);

252 ià(
d
 > 0) {

253 
y
 = y + (
zz
 + 1);

255 
y
 = y | 
zz
;

256 
y
 = y - (
zz
 + 1);

258 
y
 &ğ(0x5555555555555555ULL >> (64 - 
hash
->
¡•
 * 2));

259 
hash
->
b™s
 = (
x
 | 
y
);

260 
	}
}

262 
	$geohashNeighbÜs
(cÚ¡ 
GeoHashB™s
 *
hash
, 
GeoHashNeighbÜs
 *
ÃighbÜs
) {

263 
ÃighbÜs
->
—¡
 = *
hash
;

264 
ÃighbÜs
->
we¡
 = *
hash
;

265 
ÃighbÜs
->
nÜth
 = *
hash
;

266 
ÃighbÜs
->
south
 = *
hash
;

267 
ÃighbÜs
->
south_—¡
 = *
hash
;

268 
ÃighbÜs
->
south_we¡
 = *
hash
;

269 
ÃighbÜs
->
nÜth_—¡
 = *
hash
;

270 
ÃighbÜs
->
nÜth_we¡
 = *
hash
;

272 
	`geohash_move_x
(&
ÃighbÜs
->
—¡
, 1);

273 
	`geohash_move_y
(&
ÃighbÜs
->
—¡
, 0);

275 
	`geohash_move_x
(&
ÃighbÜs
->
we¡
, -1);

276 
	`geohash_move_y
(&
ÃighbÜs
->
we¡
, 0);

278 
	`geohash_move_x
(&
ÃighbÜs
->
south
, 0);

279 
	`geohash_move_y
(&
ÃighbÜs
->
south
, -1);

281 
	`geohash_move_x
(&
ÃighbÜs
->
nÜth
, 0);

282 
	`geohash_move_y
(&
ÃighbÜs
->
nÜth
, 1);

284 
	`geohash_move_x
(&
ÃighbÜs
->
nÜth_we¡
, -1);

285 
	`geohash_move_y
(&
ÃighbÜs
->
nÜth_we¡
, 1);

287 
	`geohash_move_x
(&
ÃighbÜs
->
nÜth_—¡
, 1);

288 
	`geohash_move_y
(&
ÃighbÜs
->
nÜth_—¡
, 1);

290 
	`geohash_move_x
(&
ÃighbÜs
->
south_—¡
, 1);

291 
	`geohash_move_y
(&
ÃighbÜs
->
south_—¡
, -1);

293 
	`geohash_move_x
(&
ÃighbÜs
->
south_we¡
, -1);

294 
	`geohash_move_y
(&
ÃighbÜs
->
south_we¡
, -1);

295 
	}
}

	@src/geohash.h

32 #iâdeà
GEOHASH_H_


33 
	#GEOHASH_H_


	)

35 
	~<¡ddef.h
>

36 
	~<¡dšt.h
>

37 
	~<¡dšt.h
>

39 #ià
defšed
(
__ılu¥lus
)

43 
	#HASHISZERO
(
r
è(!Ô).
b™s
 && !Ô).
¡•
)

	)

44 
	#RANGEISZERO
(
r
è(!Ô).
max
 && !Ô).
mš
)

	)

45 
	#RANGEPISZERO
(
r
èÔ =ğ
NULL
 || 
	`RANGEISZERO
(*r))

	)

47 
	#GEO_STEP_MAX
 26

	)

50 
	#GEO_LAT_MIN
 -85.05112878

	)

51 
	#GEO_LAT_MAX
 85.05112878

	)

52 
	#GEO_LONG_MIN
 -180

	)

53 
	#GEO_LONG_MAX
 180

	)

56 
GEOHASH_NORTH
 = 0,

57 
GEOHASH_EAST
,

58 
GEOHASH_WEST
,

59 
GEOHASH_SOUTH
,

60 
GEOHASH_SOUTH_WEST
,

61 
GEOHASH_SOUTH_EAST
,

62 
GEOHASH_NORT_WEST
,

63 
GEOHASH_NORT_EAST


64 } 
	tGeoDœeùiÚ
;

67 
ušt64_t
 
b™s
;

68 
ušt8_t
 
¡•
;

69 } 
	tGeoHashB™s
;

72 
mš
;

73 
max
;

74 } 
	tGeoHashRªge
;

77 
GeoHashB™s
 
hash
;

78 
GeoHashRªge
 
lÚg™ude
;

79 
GeoHashRªge
 
Ït™ude
;

80 } 
	tGeoHashA»a
;

83 
GeoHashB™s
 
nÜth
;

84 
GeoHashB™s
 
—¡
;

85 
GeoHashB™s
 
we¡
;

86 
GeoHashB™s
 
south
;

87 
GeoHashB™s
 
nÜth_—¡
;

88 
GeoHashB™s
 
south_—¡
;

89 
GeoHashB™s
 
nÜth_we¡
;

90 
GeoHashB™s
 
south_we¡
;

91 } 
	tGeoHashNeighbÜs
;

97 
geohashG‘CoÜdRªge
(
GeoHashRªge
 *
lÚg_¿nge
, GeoHashRªg*
Ït_¿nge
);

98 
geohashEncode
(cÚ¡ 
GeoHashRªge
 *
lÚg_¿nge
, cÚ¡ GeoHashRªg*
Ït_¿nge
,

99 
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

100 
GeoHashB™s
 *
hash
);

101 
geohashEncodeTy³
(
lÚg™ude
, 
Ït™ude
,

102 
ušt8_t
 
¡•
, 
GeoHashB™s
 *
hash
);

103 
geohashEncodeWGS84
(
lÚg™ude
, 
Ït™ude
, 
ušt8_t
 
¡•
,

104 
GeoHashB™s
 *
hash
);

105 
geohashDecode
(cÚ¡ 
GeoHashRªge
 
lÚg_¿nge
, cÚ¡ GeoHashRªg
Ït_¿nge
,

106 cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
);

107 
geohashDecodeTy³
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
);

108 
geohashDecodeWGS84
(cÚ¡ 
GeoHashB™s
 
hash
, 
GeoHashA»a
 *
¬—
);

109 
geohashDecodeA»aToLÚgL©
(cÚ¡ 
GeoHashA»a
 *
¬—
, *
xy
);

110 
geohashDecodeToLÚgL©Ty³
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
);

111 
geohashDecodeToLÚgL©WGS84
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
);

112 
geohashDecodeToLÚgL©M”ÿtÜ
(cÚ¡ 
GeoHashB™s
 
hash
, *
xy
);

113 
geohashNeighbÜs
(cÚ¡ 
GeoHashB™s
 *
hash
, 
GeoHashNeighbÜs
 *
ÃighbÜs
);

115 #ià
defšed
(
__ılu¥lus
)

	@src/geohash_helper.c

37 
	~"fmaüos.h
"

38 
	~"geohash_h–³r.h
"

39 
	~"debugmaüo.h
"

40 
	~<m©h.h
>

42 
	#D_R
 (
M_PI
 / 180.0)

	)

43 
	#R_MAJOR
 6378137.0

	)

44 
	#R_MINOR
 6356752.3142

	)

45 
	#RATIO
 (
R_MINOR
 / 
R_MAJOR
)

	)

46 
	#ECCENT
 (
	`sq¹
(1.0 - (
RATIO
 *RATIO)))

	)

47 
	#COM
 (0.5 * 
ECCENT
)

	)

50 cÚ¡ 
	gDEG_TO_RAD
 = 0.017453292519943295769236907684886;

52 cÚ¡ 
	gEARTH_RADIUS_IN_METERS
 = 6372797.560856;

54 cÚ¡ 
	gMERCATOR_MAX
 = 20037726.37;

55 cÚ¡ 
	gMERCATOR_MIN
 = -20037726.37;

57 
šlše
 
	$deg_¿d
(
ªg
è{ ‡ng * 
D_R
; 
	}
}

58 
šlše
 
	$¿d_deg
(
ªg
è{ ‡ng / 
D_R
; 
	}
}

62 
ušt8_t
 
	$geohashE¡im©eS‹psByRadius
(
¿nge_m‘”s
, 
Ït
) {

63 ià(
¿nge_m‘”s
 == 0)  26;

64 
¡•
 = 1;

65 
¿nge_m‘”s
 < 
MERCATOR_MAX
) {

66 
¿nge_m‘”s
 *= 2;

67 
¡•
++;

69 
¡•
 -= 2;

74 ià(
Ït
 > 66 ||†at < -66) {

75 
¡•
--;

76 ià(
Ït
 > 80 ||†© < -80è
¡•
--;

80 ià(
¡•
 < 1) step = 1;

81 ià(
¡•
 > 26) step = 26;

82  
¡•
;

83 
	}
}

103 
	$geohashBoundšgBox
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
,

104 *
bounds
) {

105 ià(!
bounds
)  0;

107 
bounds
[0] = 
lÚg™ude
 - 
	`¿d_deg
(
¿dius_m‘”s
/
EARTH_RADIUS_IN_METERS
/
	`cos
(
	`deg_¿d
(
Ït™ude
)));

108 
bounds
[2] = 
lÚg™ude
 + 
	`¿d_deg
(
¿dius_m‘”s
/
EARTH_RADIUS_IN_METERS
/
	`cos
(
	`deg_¿d
(
Ït™ude
)));

109 
bounds
[1] = 
Ït™ude
 - 
	`¿d_deg
(
¿dius_m‘”s
/
EARTH_RADIUS_IN_METERS
);

110 
bounds
[3] = 
Ït™ude
 + 
	`¿d_deg
(
¿dius_m‘”s
/
EARTH_RADIUS_IN_METERS
);

112 
	}
}

116 
GeoHashRadius
 
	$geohashG‘A»asByRadius
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
) {

117 
GeoHashRªge
 
lÚg_¿nge
, 
Ït_¿nge
;

118 
GeoHashRadius
 
¿dius
;

119 
GeoHashB™s
 
hash
;

120 
GeoHashNeighbÜs
 
ÃighbÜs
;

121 
GeoHashA»a
 
¬—
;

122 
mš_lÚ
, 
max_lÚ
, 
mš_Ït
, 
max_Ït
;

123 
bounds
[4];

124 
¡•s
;

126 
	`geohashBoundšgBox
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
, 
bounds
);

127 
mš_lÚ
 = 
bounds
[0];

128 
mš_Ït
 = 
bounds
[1];

129 
max_lÚ
 = 
bounds
[2];

130 
max_Ït
 = 
bounds
[3];

132 
¡•s
 = 
	`geohashE¡im©eS‹psByRadius
(
¿dius_m‘”s
,
Ït™ude
);

134 
	`geohashG‘CoÜdRªge
(&
lÚg_¿nge
,&
Ït_¿nge
);

135 
	`geohashEncode
(&
lÚg_¿nge
,&
Ït_¿nge
,
lÚg™ude
,
Ït™ude
,
¡•s
,&
hash
);

136 
	`geohashNeighbÜs
(&
hash
,&
ÃighbÜs
);

137 
	`geohashDecode
(
lÚg_¿nge
,
Ït_¿nge
,
hash
,&
¬—
);

144 
deü—£_¡•
 = 0;

146 
GeoHashA»a
 
nÜth
, 
south
, 
—¡
, 
we¡
;

148 
	`geohashDecode
(
lÚg_¿nge
, 
Ït_¿nge
, 
ÃighbÜs
.
nÜth
, &north);

149 
	`geohashDecode
(
lÚg_¿nge
, 
Ït_¿nge
, 
ÃighbÜs
.
south
, &south);

150 
	`geohashDecode
(
lÚg_¿nge
, 
Ït_¿nge
, 
ÃighbÜs
.
—¡
, &east);

151 
	`geohashDecode
(
lÚg_¿nge
, 
Ït_¿nge
, 
ÃighbÜs
.
we¡
, &west);

153 ià(
	`geohashG‘Di¡ªû
(
lÚg™ude
,
Ït™ude
,lÚg™ude,
nÜth
.Ït™ude.
max
)

154 < 
¿dius_m‘”s
è
deü—£_¡•
 = 1;

155 ià(
	`geohashG‘Di¡ªû
(
lÚg™ude
,
Ït™ude
,lÚg™ude,
south
.Ït™ude.
mš
)

156 < 
¿dius_m‘”s
è
deü—£_¡•
 = 1;

157 ià(
	`geohashG‘Di¡ªû
(
lÚg™ude
,
Ït™ude
,
—¡
.lÚg™ude.
max
,latitude)

158 < 
¿dius_m‘”s
è
deü—£_¡•
 = 1;

159 ià(
	`geohashG‘Di¡ªû
(
lÚg™ude
,
Ït™ude
,
we¡
.lÚg™ude.
mš
,latitude)

160 < 
¿dius_m‘”s
è
deü—£_¡•
 = 1;

163 ià(
¡•s
 > 1 && 
deü—£_¡•
) {

164 
¡•s
--;

165 
	`geohashEncode
(&
lÚg_¿nge
,&
Ït_¿nge
,
lÚg™ude
,
Ït™ude
,
¡•s
,&
hash
);

166 
	`geohashNeighbÜs
(&
hash
,&
ÃighbÜs
);

167 
	`geohashDecode
(
lÚg_¿nge
,
Ït_¿nge
,
hash
,&
¬—
);

171 ià(
¡•s
 >= 2) {

172 ià(
¬—
.
Ït™ude
.
mš
 < 
mš_Ït
) {

173 
	`GZERO
(
ÃighbÜs
.
south
);

174 
	`GZERO
(
ÃighbÜs
.
south_we¡
);

175 
	`GZERO
(
ÃighbÜs
.
south_—¡
);

177 ià(
¬—
.
Ït™ude
.
max
 > 
max_Ït
) {

178 
	`GZERO
(
ÃighbÜs
.
nÜth
);

179 
	`GZERO
(
ÃighbÜs
.
nÜth_—¡
);

180 
	`GZERO
(
ÃighbÜs
.
nÜth_we¡
);

182 ià(
¬—
.
lÚg™ude
.
mš
 < 
mš_lÚ
) {

183 
	`GZERO
(
ÃighbÜs
.
we¡
);

184 
	`GZERO
(
ÃighbÜs
.
south_we¡
);

185 
	`GZERO
(
ÃighbÜs
.
nÜth_we¡
);

187 ià(
¬—
.
lÚg™ude
.
max
 > 
max_lÚ
) {

188 
	`GZERO
(
ÃighbÜs
.
—¡
);

189 
	`GZERO
(
ÃighbÜs
.
south_—¡
);

190 
	`GZERO
(
ÃighbÜs
.
nÜth_—¡
);

193 
¿dius
.
hash
 = hash;

194 
¿dius
.
ÃighbÜs
 =‚eighbors;

195 
¿dius
.
¬—
 =‡rea;

196  
¿dius
;

197 
	}
}

199 
GeoHashRadius
 
	$geohashG‘A»asByRadiusWGS84
(
lÚg™ude
, 
Ït™ude
,

200 
¿dius_m‘”s
) {

201  
	`geohashG‘A»asByRadius
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
);

202 
	}
}

204 
GeoHashFix52B™s
 
	$geohashAlign52B™s
(cÚ¡ 
GeoHashB™s
 
hash
) {

205 
ušt64_t
 
b™s
 = 
hash
.bits;

206 
b™s
 <<ğ(52 - 
hash
.
¡•
 * 2);

207  
b™s
;

208 
	}
}

211 
	$geohashG‘Di¡ªû
(
lÚ1d
, 
Ït1d
, 
lÚ2d
, 
Ït2d
) {

212 
Ït1r
, 
lÚ1r
, 
Ït2r
, 
lÚ2r
, 
u
, 
v
;

213 
Ït1r
 = 
	`deg_¿d
(
Ït1d
);

214 
lÚ1r
 = 
	`deg_¿d
(
lÚ1d
);

215 
Ït2r
 = 
	`deg_¿d
(
Ït2d
);

216 
lÚ2r
 = 
	`deg_¿d
(
lÚ2d
);

217 
u
 = 
	`sš
((
Ït2r
 - 
Ït1r
) / 2);

218 
v
 = 
	`sš
((
lÚ2r
 - 
lÚ1r
) / 2);

219  2.0 * 
EARTH_RADIUS_IN_METERS
 *

220 
	`asš
(
	`sq¹
(
u
 * u + 
	`cos
(
Ït1r
è* cos(
Ït2r
è* 
v
 * v));

221 
	}
}

223 
	$geohashG‘Di¡ªûIfInRadius
(
x1
, 
y1
,

224 
x2
, 
y2
, 
¿dius
,

225 *
di¡ªû
) {

226 *
di¡ªû
 = 
	`geohashG‘Di¡ªû
(
x1
, 
y1
, 
x2
, 
y2
);

227 ià(*
di¡ªû
 > 
¿dius
)  0;

229 
	}
}

231 
	$geohashG‘Di¡ªûIfInRadiusWGS84
(
x1
, 
y1
, 
x2
,

232 
y2
, 
¿dius
,

233 *
di¡ªû
) {

234  
	`geohashG‘Di¡ªûIfInRadius
(
x1
, 
y1
, 
x2
, 
y2
, 
¿dius
, 
di¡ªû
);

235 
	}
}

	@src/geohash_helper.h

32 #iâdeà
GEOHASH_HELPER_HPP_


33 
	#GEOHASH_HELPER_HPP_


	)

35 
	~"geohash.h
"

37 
	#GZERO
(
s
ès.
b™s
 = s.
¡•
 = 0;

	)

38 
	#GISZERO
(
s
è(!s.
b™s
 && !s.
¡•
)

	)

39 
	#GISNOTZERO
(
s
è(s.
b™s
 || s.
¡•
)

	)

41 
ušt64_t
 
	tGeoHashFix52B™s
;

42 
ušt64_t
 
	tGeoHashV¬B™s
;

45 
GeoHashB™s
 
	mhash
;

46 
GeoHashA»a
 
	m¬—
;

47 
GeoHashNeighbÜs
 
	mÃighbÜs
;

48 } 
	tGeoHashRadius
;

50 
GeoHashB™sCom·¿tÜ
(cÚ¡ 
GeoHashB™s
 *
a
, cÚ¡ GeoHashB™ *
b
);

51 
ušt8_t
 
geohashE¡im©eS‹psByRadius
(
¿nge_m‘”s
, 
Ït
);

52 
geohashBoundšgBox
(
lÚg™ude
, 
Ït™ude
, 
¿dius_m‘”s
,

53 *
bounds
);

54 
GeoHashRadius
 
geohashG‘A»asByRadius
(
lÚg™ude
,

55 
Ït™ude
, 
¿dius_m‘”s
);

56 
GeoHashRadius
 
geohashG‘A»asByRadiusWGS84
(
lÚg™ude
, 
Ït™ude
,

57 
¿dius_m‘”s
);

58 
GeoHashRadius
 
geohashG‘A»asByRadiusM”ÿtÜ
(
lÚg™ude
, 
Ït™ude
,

59 
¿dius_m‘”s
);

60 
GeoHashFix52B™s
 
geohashAlign52B™s
(cÚ¡ 
GeoHashB™s
 
hash
);

61 
geohashG‘Di¡ªû
(
lÚ1d
, 
Ït1d
,

62 
lÚ2d
, 
Ït2d
);

63 
geohashG‘Di¡ªûIfInRadius
(
x1
, 
y1
,

64 
x2
, 
y2
, 
¿dius
,

65 *
di¡ªû
);

66 
geohashG‘Di¡ªûIfInRadiusWGS84
(
x1
, 
y1
, 
x2
,

67 
y2
, 
¿dius
,

68 *
di¡ªû
);

	@src/help.h

3 #iâdeà
__REDIS_HELP_H


4 
	#__REDIS_HELP_H


	)

6 *
	gcommªdGroups
[] = {

23 
	scommªdH–p
 {

24 *
	mÇme
;

25 *
	m·¿ms
;

26 *
	msumm¬y
;

27 
	mgroup
;

28 *
	msšû
;

29 } 
	gcommªdH–p
[] = {

	@src/hyperloglog.c

32 
	~"£rv”.h
"

34 
	~<¡dšt.h
>

35 
	~<m©h.h
>

182 
	shÎhdr
 {

183 
	mmagic
[4];

184 
ušt8_t
 
	m’codšg
;

185 
ušt8_t
 
	mnÙu£d
[3];

186 
ušt8_t
 
	mÿrd
[8];

187 
ušt8_t
 
	m»gi¡”s
[];

191 
	#HLL_INVALIDATE_CACHE
(
hdr
è(hdr)->
ÿrd
[7] |ğ(1<<7)

	)

192 
	#HLL_VALID_CACHE
(
hdr
è(((hdr)->
ÿrd
[7] & (1<<7)è=ğ0)

	)

194 
	#HLL_P
 14

	)

195 
	#HLL_REGISTERS
 (1<<
HLL_P
è

	)

196 
	#HLL_P_MASK
 (
HLL_REGISTERS
-1è

	)

197 
	#HLL_BITS
 6

	)

198 
	#HLL_REGISTER_MAX
 ((1<<
HLL_BITS
)-1)

	)

199 
	#HLL_HDR_SIZE
 (
hÎhdr
)

	)

200 
	#HLL_DENSE_SIZE
 (
HLL_HDR_SIZE
+((
HLL_REGISTERS
*
HLL_BITS
+7)/8))

	)

201 
	#HLL_DENSE
 0

	)

202 
	#HLL_SPARSE
 1

	)

203 
	#HLL_RAW
 255

	)

204 
	#HLL_MAX_ENCODING
 1

	)

206 *
	gšv®id_hÎ_”r
 = "-INVALIDOBJ Corrupted HLL object detected\r\n";

337 
	#HLL_DENSE_GET_REGISTER
(
rg‘
,
p
,
»gnum
) do { \

338 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

339 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

340 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

341 
_fb8
 = 8 - 
_fb
; \

342 
b0
 = 
_p
[
_by‹
]; \

343 
b1
 = 
_p
[
_by‹
+1]; \

344 
rg‘
 = ((
b0
 >> 
_fb
è| (
b1
 << 
_fb8
)è& 
HLL_REGISTER_MAX
; \

345 } 0)

	)

349 
	#HLL_DENSE_SET_REGISTER
(
p
,
»gnum
,
v®
) do { \

350 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

351 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

352 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

353 
_fb8
 = 8 - 
_fb
; \

354 
_v
 = 
v®
; \

355 
_p
[
_by‹
] &ğ~(
HLL_REGISTER_MAX
 << 
_fb
); \

356 
_p
[
_by‹
] |ğ
_v
 << 
_fb
; \

357 
_p
[
_by‹
+1] &ğ~(
HLL_REGISTER_MAX
 >> 
_fb8
); \

358 
_p
[
_by‹
+1] |ğ
_v
 >> 
_fb8
; \

359 } 0)

	)

363 
	#HLL_SPARSE_XZERO_BIT
 0x40

	)

364 
	#HLL_SPARSE_VAL_BIT
 0x80

	)

365 
	#HLL_SPARSE_IS_ZERO
(
p
è(((*Õ)è& 0xc0è=ğ0è

	)

366 
	#HLL_SPARSE_IS_XZERO
(
p
è(((*Õ)è& 0xc0è=ğ
HLL_SPARSE_XZERO_BIT
)

	)

367 
	#HLL_SPARSE_IS_VAL
(
p
è((*Õ)è& 
HLL_SPARSE_VAL_BIT
)

	)

368 
	#HLL_SPARSE_ZERO_LEN
(
p
è(((*Õ)è& 0x3f)+1)

	)

369 
	#HLL_SPARSE_XZERO_LEN
(
p
è(((((*Õ)è& 0x3fè<< 8è| (*(Õ)+1)))+1)

	)

370 
	#HLL_SPARSE_VAL_VALUE
(
p
è((((*Õ)è>> 2è& 0x1f)+1)

	)

371 
	#HLL_SPARSE_VAL_LEN
(
p
è(((*Õ)è& 0x3)+1)

	)

372 
	#HLL_SPARSE_VAL_MAX_VALUE
 32

	)

373 
	#HLL_SPARSE_VAL_MAX_LEN
 4

	)

374 
	#HLL_SPARSE_ZERO_MAX_LEN
 64

	)

375 
	#HLL_SPARSE_XZERO_MAX_LEN
 16384

	)

376 
	#HLL_SPARSE_VAL_SET
(
p
,
v®
,
Ën
) do { \

377 *(
p
èğ(((
v®
)-1)<<2|((
Ën
)-1))|
HLL_SPARSE_VAL_BIT
; \

378 } 0)

	)

379 
	#HLL_SPARSE_ZERO_SET
(
p
,
Ën
) do { \

380 *(
p
èğ(
Ën
)-1; \

381 } 0)

	)

382 
	#HLL_SPARSE_XZERO_SET
(
p
,
Ën
) do { \

383 
_l
 = (
Ën
)-1; \

384 *(
p
èğ(
_l
>>8è| 
HLL_SPARSE_XZERO_BIT
; \

385 *((
p
)+1èğ(
_l
&0xff); \

386 } 0)

	)

393 
ušt64_t
 
	$MurmurHash64A
 (cÚ¡ * 
key
, 
Ën
, 
£ed
) {

394 cÚ¡ 
ušt64_t
 
m
 = 0xc6a4a7935bd1e995;

395 cÚ¡ 
r
 = 47;

396 
ušt64_t
 
h
 = 
£ed
 ^ (
Ën
 * 
m
);

397 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*)
key
;

398 cÚ¡ 
ušt8_t
 *
’d
 = 
d©a
 + (
Ën
-(len&7));

400 
d©a
 !ğ
’d
) {

401 
ušt64_t
 
k
;

403 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

404 #ifdeà
USE_ALIGNED_ACCESS


405 
	`memıy
(&
k
,
d©a
,(
ušt64_t
));

407 
k
 = *((
ušt64_t
*)
d©a
);

410 
k
 = (
ušt64_t
è
d©a
[0];

411 
k
 |ğ(
ušt64_t
è
d©a
[1] << 8;

412 
k
 |ğ(
ušt64_t
è
d©a
[2] << 16;

413 
k
 |ğ(
ušt64_t
è
d©a
[3] << 24;

414 
k
 |ğ(
ušt64_t
è
d©a
[4] << 32;

415 
k
 |ğ(
ušt64_t
è
d©a
[5] << 40;

416 
k
 |ğ(
ušt64_t
è
d©a
[6] << 48;

417 
k
 |ğ(
ušt64_t
è
d©a
[7] << 56;

420 
k
 *ğ
m
;

421 
k
 ^ğk >> 
r
;

422 
k
 *ğ
m
;

423 
h
 ^ğ
k
;

424 
h
 *ğ
m
;

425 
d©a
 += 8;

428 
Ën
 & 7) {

429 7: 
h
 ^ğ(
ušt64_t
)
d©a
[6] << 48;

430 6: 
h
 ^ğ(
ušt64_t
)
d©a
[5] << 40;

431 5: 
h
 ^ğ(
ušt64_t
)
d©a
[4] << 32;

432 4: 
h
 ^ğ(
ušt64_t
)
d©a
[3] << 24;

433 3: 
h
 ^ğ(
ušt64_t
)
d©a
[2] << 16;

434 2: 
h
 ^ğ(
ušt64_t
)
d©a
[1] << 8;

435 1: 
h
 ^ğ(
ušt64_t
)
d©a
[0];

436 
h
 *ğ
m
;

439 
h
 ^ğh >> 
r
;

440 
h
 *ğ
m
;

441 
h
 ^ğh >> 
r
;

442  
h
;

443 
	}
}

448 
	$hÎP©L’
(*
–e
, 
size_t
 
–esize
, *
»gp
) {

449 
ušt64_t
 
hash
, 
b™
, 
šdex
;

450 
couÁ
;

463 
hash
 = 
	`MurmurHash64A
(
–e
,
–esize
,0xadc83b19ULL);

464 
šdex
 = 
hash
 & 
HLL_P_MASK
;

465 
hash
 |ğ((
ušt64_t
)1<<63);

466 
b™
 = 
HLL_REGISTERS
;

467 
couÁ
 = 1;

468 (
hash
 & 
b™
) == 0) {

469 
couÁ
++;

470 
b™
 <<= 1;

472 *
»gp
 = (è
šdex
;

473  
couÁ
;

474 
	}
}

488 
	$hÎD’£S‘
(
ušt8_t
 *
»gi¡”s
, 
šdex
, ušt8_ˆ
couÁ
) {

489 
ušt8_t
 
ŞdcouÁ
;

491 
	`HLL_DENSE_GET_REGISTER
(
ŞdcouÁ
,
»gi¡”s
,
šdex
);

492 ià(
couÁ
 > 
ŞdcouÁ
) {

493 
	`HLL_DENSE_SET_REGISTER
(
»gi¡”s
,
šdex
,
couÁ
);

498 
	}
}

506 
	$hÎD’£Add
(
ušt8_t
 *
»gi¡”s
, *
–e
, 
size_t
 
–esize
) {

507 
šdex
;

508 
ušt8_t
 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

510  
	`hÎD’£S‘
(
»gi¡”s
,
šdex
,
couÁ
);

511 
	}
}

517 
	$hÎD’£Sum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

518 
E
 = 0;

519 
j
, 
ez
 = 0;

524 ià(
HLL_REGISTERS
 =ğ16384 && 
HLL_BITS
 == 6) {

525 
ušt8_t
 *
r
 = 
»gi¡”s
;

526 
r0
, 
r1
, 
r2
, 
r3
, 
r4
, 
r5
, 
r6
, 
r7
, 
r8
, 
r9
,

527 
r10
, 
r11
, 
r12
, 
r13
, 
r14
, 
r15
;

528 
j
 = 0; j < 1024; j++) {

530 
r0
 = 
r
[0] & 63; iàÔ0 =ğ0è
ez
++;

531 
r1
 = (
r
[0] >> 6 |„[1] << 2è& 63; iàÔ1 =ğ0è
ez
++;

532 
r2
 = (
r
[1] >> 4 |„[2] << 4è& 63; iàÔ2 =ğ0è
ez
++;

533 
r3
 = (
r
[2] >> 2è& 63; iàÔ3 =ğ0è
ez
++;

534 
r4
 = 
r
[3] & 63; iàÔ4 =ğ0è
ez
++;

535 
r5
 = (
r
[3] >> 6 |„[4] << 2è& 63; iàÔ5 =ğ0è
ez
++;

536 
r6
 = (
r
[4] >> 4 |„[5] << 4è& 63; iàÔ6 =ğ0è
ez
++;

537 
r7
 = (
r
[5] >> 2è& 63; iàÔ7 =ğ0è
ez
++;

538 
r8
 = 
r
[6] & 63; iàÔ8 =ğ0è
ez
++;

539 
r9
 = (
r
[6] >> 6 |„[7] << 2è& 63; iàÔ9 =ğ0è
ez
++;

540 
r10
 = (
r
[7] >> 4 |„[8] << 4è& 63; iàÔ10 =ğ0è
ez
++;

541 
r11
 = (
r
[8] >> 2è& 63; iàÔ11 =ğ0è
ez
++;

542 
r12
 = 
r
[9] & 63; iàÔ12 =ğ0è
ez
++;

543 
r13
 = (
r
[9] >> 6 |„[10] << 2è& 63; iàÔ13 =ğ0è
ez
++;

544 
r14
 = (
r
[10] >> 4 |„[11] << 4è& 63; iàÔ14 =ğ0è
ez
++;

545 
r15
 = (
r
[11] >> 2è& 63; iàÔ15 =ğ0è
ez
++;

550 
E
 +ğ(
PE
[
r0
] + PE[
r1
]è+ (PE[
r2
] + PE[
r3
]è+ (PE[
r4
] + PE[
r5
]) +

551 (
PE
[
r6
] + PE[
r7
]è+ (PE[
r8
] + PE[
r9
]è+ (PE[
r10
] + PE[
r11
]) +

552 (
PE
[
r12
] + PE[
r13
]è+ (PE[
r14
] + PE[
r15
]);

553 
r
 += 12;

556 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

557 
»g
;

559 
	`HLL_DENSE_GET_REGISTER
(
»g
,
»gi¡”s
,
j
);

560 ià(
»g
 == 0) {

561 
ez
++;

564 
E
 +ğ
PE
[
»g
];

567 
E
 +ğ
ez
;

569 *
ezp
 = 
ez
;

570  
E
;

571 
	}
}

581 
	$hÎS·r£ToD’£
(
robj
 *
o
) {

582 
sds
 
¥¬£
 = 
o
->
±r
, 
d’£
;

583 
hÎhdr
 *
hdr
, *
Şdhdr
 = (hÎhdr*)
¥¬£
;

584 
idx
 = 0, 
ruÆ’
, 
»gv®
;

585 
ušt8_t
 *
p
 = (ušt8_t*)
¥¬£
, *
’d
 =…+
	`sd¦’
(sparse);

588 
hdr
 = (
hÎhdr
*è
¥¬£
;

589 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
è 
C_OK
;

594 
d’£
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

595 
hdr
 = (
hÎhdr
*è
d’£
;

596 *
hdr
 = *
Şdhdr
;

597 
hdr
->
’codšg
 = 
HLL_DENSE
;

601 
p
 +ğ
HLL_HDR_SIZE
;

602 
p
 < 
’d
) {

603 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

604 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

605 
idx
 +ğ
ruÆ’
;

606 
p
++;

607 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

608 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

609 
idx
 +ğ
ruÆ’
;

610 
p
 += 2;

612 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

613 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

614 
ruÆ’
--) {

615 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
idx
,
»gv®
);

616 
idx
++;

618 
p
++;

624 ià(
idx
 !ğ
HLL_REGISTERS
) {

625 
	`sdsä“
(
d’£
);

626  
C_ERR
;

630 
	`sdsä“
(
o
->
±r
);

631 
o
->
±r
 = 
d’£
;

632  
C_OK
;

633 
	}
}

650 
	$hÎS·r£S‘
(
robj
 *
o
, 
šdex
, 
ušt8_t
 
couÁ
) {

651 
hÎhdr
 *
hdr
;

652 
ušt8_t
 
ŞdcouÁ
, *
¥¬£
, *
’d
, *
p
, *
´ev
, *
Ãxt
;

653 
fœ¡
, 
¥ª
;

654 
is_z”o
 = 0, 
is_xz”o
 = 0, 
is_v®
 = 0, 
ruÆ’
 = 0;

658 ià(
couÁ
 > 
HLL_SPARSE_VAL_MAX_VALUE
è
´omÙe
;

665 
o
->
±r
 = 
	`sdsMakeRoomFÜ
(o->ptr,3);

669 
¥¬£
 = 
p
 = ((
ušt8_t
*)
o
->
±r
è+ 
HLL_HDR_SIZE
;

670 
’d
 = 
p
 + 
	`sd¦’
(
o
->
±r
è- 
HLL_HDR_SIZE
;

672 
fœ¡
 = 0;

673 
´ev
 = 
NULL
;

674 
Ãxt
 = 
NULL
;

675 
¥ª
 = 0;

676 
p
 < 
’d
) {

677 
İËn
;

684 
İËn
 = 1;

685 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

686 
¥ª
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

687 } ià(
	`HLL_SPARSE_IS_VAL
(
p
)) {

688 
¥ª
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

690 
¥ª
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

691 
İËn
 = 2;

694 ià(
šdex
 <ğ
fœ¡
+
¥ª
-1) ;

695 
´ev
 = 
p
;

696 
p
 +ğ
İËn
;

697 
fœ¡
 +ğ
¥ª
;

699 ià(
¥ª
 == 0)  -1;

701 
Ãxt
 = 
	`HLL_SPARSE_IS_XZERO
(
p
) ?…+2 :…+1;

702 ià(
Ãxt
 >ğ
’d
èÃxˆğ
NULL
;

707 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

708 
is_z”o
 = 1;

709 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

710 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

711 
is_xz”o
 = 1;

712 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

714 
is_v®
 = 1;

715 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

739 ià(
is_v®
) {

740 
ŞdcouÁ
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

742 ià(
ŞdcouÁ
 >ğ
couÁ
)  0;

745 ià(
ruÆ’
 == 1) {

746 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

747 
upd©ed
;

753 ià(
is_z”o
 && 
ruÆ’
 == 1) {

754 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

755 
upd©ed
;

773 
ušt8_t
 
£q
[5], *
n
 = seq;

774 
Ï¡
 = 
fœ¡
+
¥ª
-1;

775 
Ën
;

777 ià(
is_z”o
 || 
is_xz”o
) {

779 ià(
šdex
 !ğ
fœ¡
) {

780 
Ën
 = 
šdex
-
fœ¡
;

781 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

782 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

783 
n
 += 2;

785 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

786 
n
++;

789 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

790 
n
++;

791 ià(
šdex
 !ğ
Ï¡
) {

792 
Ën
 = 
Ï¡
-
šdex
;

793 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

794 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

795 
n
 += 2;

797 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

798 
n
++;

803 
curv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

805 ià(
šdex
 !ğ
fœ¡
) {

806 
Ën
 = 
šdex
-
fœ¡
;

807 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

808 
n
++;

810 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

811 
n
++;

812 ià(
šdex
 !ğ
Ï¡
) {

813 
Ën
 = 
Ï¡
-
šdex
;

814 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

815 
n
++;

823 
£qËn
 = 
n
-
£q
;

824 
ŞdËn
 = 
is_xz”o
 ? 2 : 1;

825 
d–Ën
 = 
£qËn
-
ŞdËn
;

827 ià(
d–Ën
 > 0 &&

828 
	`sd¦’
(
o
->
±r
)+
d–Ën
 > 
£rv”
.
hÎ_¥¬£_max_by‹s
è
´omÙe
;

829 ià(
d–Ën
 && 
Ãxt
è
	`memmove
Òext+d–Ën,Ãxt,
’d
-next);

830 
	`sdsInüL’
(
o
->
±r
,
d–Ën
);

831 
	`memıy
(
p
,
£q
,
£qËn
);

832 
’d
 +ğ
d–Ën
;

834 
upd©ed
:

840 
p
 = 
´ev
 ?…»v : 
¥¬£
;

841 
sÿÆ’
 = 5;

842 
p
 < 
’d
 && 
sÿÆ’
--) {

843 ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

844 
p
 += 2;

846 } ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

847 
p
++;

852 ià(
p
+1 < 
’d
 && 
	`HLL_SPARSE_IS_VAL
(p+1)) {

853 
v1
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

854 
v2
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
+1);

855 ià(
v1
 =ğ
v2
) {

856 
Ën
 = 
	`HLL_SPARSE_VAL_LEN
(
p
)+HLL_SPARSE_VAL_LEN(p+1);

857 ià(
Ën
 <ğ
HLL_SPARSE_VAL_MAX_LEN
) {

858 
	`HLL_SPARSE_VAL_SET
(
p
+1,
v1
,
Ën
);

859 
	`memmove
(
p
,p+1,
’d
-p);

860 
	`sdsInüL’
(
o
->
±r
,-1);

861 
’d
--;

869 
p
++;

873 
hdr
 = 
o
->
±r
;

874 
	`HLL_INVALIDATE_CACHE
(
hdr
);

877 
´omÙe
:

878 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
)  -1;

879 
hdr
 = 
o
->
±r
;

888 
d’£_»tv®
 = 
	`hÎD’£S‘
(
hdr
->
»gi¡”s
,
šdex
,
couÁ
);

889 
	`£rv”As£¹
(
d’£_»tv®
 == 1);

890  
d’£_»tv®
;

891 
	}
}

899 
	$hÎS·r£Add
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

900 
šdex
;

901 
ušt8_t
 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

903  
	`hÎS·r£S‘
(
o
,
šdex
,
couÁ
);

904 
	}
}

910 
	$hÎS·r£Sum
(
ušt8_t
 *
¥¬£
, 
¥¬£Ën
, *
PE
, *
ezp
, *
šv®id
) {

911 
E
 = 0;

912 
ez
 = 0, 
idx
 = 0, 
ruÆ’
, 
»gv®
;

913 
ušt8_t
 *
’d
 = 
¥¬£
+
¥¬£Ën
, *
p
 = sparse;

915 
p
 < 
’d
) {

916 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

917 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

918 
idx
 +ğ
ruÆ’
;

919 
ez
 +ğ
ruÆ’
;

921 
p
++;

922 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

923 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

924 
idx
 +ğ
ruÆ’
;

925 
ez
 +ğ
ruÆ’
;

927 
p
 += 2;

929 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

930 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

931 
idx
 +ğ
ruÆ’
;

932 
E
 +ğ
PE
[
»gv®
]*
ruÆ’
;

933 
p
++;

936 ià(
idx
 !ğ
HLL_REGISTERS
 && 
šv®id
) *invalid = 1;

937 
E
 +ğ
ez
;

938 *
ezp
 = 
ez
;

939  
E
;

940 
	}
}

950 
	$hÎRawSum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

951 
E
 = 0;

952 
j
, 
ez
 = 0;

953 
ušt64_t
 *
wÜd
 = (ušt64_t*è
»gi¡”s
;

954 
ušt8_t
 *
by‹s
;

956 
j
 = 0; j < 
HLL_REGISTERS
/8; j++) {

957 ià(*
wÜd
 == 0) {

958 
ez
 += 8;

960 
by‹s
 = (
ušt8_t
*è
wÜd
;

961 ià(
by‹s
[0]è
E
 +ğ
PE
[by‹s[0]]; 
ez
++;

962 ià(
by‹s
[1]è
E
 +ğ
PE
[by‹s[1]]; 
ez
++;

963 ià(
by‹s
[2]è
E
 +ğ
PE
[by‹s[2]]; 
ez
++;

964 ià(
by‹s
[3]è
E
 +ğ
PE
[by‹s[3]]; 
ez
++;

965 ià(
by‹s
[4]è
E
 +ğ
PE
[by‹s[4]]; 
ez
++;

966 ià(
by‹s
[5]è
E
 +ğ
PE
[by‹s[5]]; 
ez
++;

967 ià(
by‹s
[6]è
E
 +ğ
PE
[by‹s[6]]; 
ez
++;

968 ià(
by‹s
[7]è
E
 +ğ
PE
[by‹s[7]]; 
ez
++;

970 
wÜd
++;

972 
E
 +ğ
ez
;

974 *
ezp
 = 
ez
;

975  
E
;

976 
	}
}

989 
ušt64_t
 
	$hÎCouÁ
(
hÎhdr
 *
hdr
, *
šv®id
) {

990 
m
 = 
HLL_REGISTERS
;

991 
E
, 
®pha
 = 0.7213/(1+1.079/
m
);

992 
j
, 
ez
;

996 
š™Ÿlized
 = 0;

997 
PE
[64];

998 ià(!
š™Ÿlized
) {

999 
PE
[0] = 1;

1000 
j
 = 1; j < 64; j++) {

1002 
PE
[
j
] = 1.0/(1ULL << j);

1004 
š™Ÿlized
 = 1;

1008 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

1009 
E
 = 
	`hÎD’£Sum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

1010 } ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1011 
E
 = 
	`hÎS·r£Sum
(
hdr
->
»gi¡”s
,

1012 
	`sd¦’
((
sds
)
hdr
)-
HLL_HDR_SIZE
,
PE
,&
ez
,
šv®id
);

1013 } ià(
hdr
->
’codšg
 =ğ
HLL_RAW
) {

1014 
E
 = 
	`hÎRawSum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

1016 
	`£rv”Pªic
("Unknown HyperLogLogƒncoding in hllCount()");

1023 
zl
 = 
	`log
(
ez
 + 1);

1024 
b‘a
 = -0.370393911*
ez
 +

1025 0.070471823*
zl
 +

1026 0.17393686*
	`pow
(
zl
,2) +

1027 0.16339839*
	`pow
(
zl
,3) +

1028 -0.09237745*
	`pow
(
zl
,4) +

1029 0.03738027*
	`pow
(
zl
,5) +

1030 -0.005384159*
	`pow
(
zl
,6) +

1031 0.00042419*
	`pow
(
zl
,7);

1033 
E
 = 
	`Îroundl
(
®pha
*
m
*(m-
ez
)*(1/(E+
b‘a
)));

1034  (
ušt64_t
è
E
;

1035 
	}
}

1038 
	$hÎAdd
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

1039 
hÎhdr
 *
hdr
 = 
o
->
±r
;

1040 
hdr
->
’codšg
) {

1041 
HLL_DENSE
:  
	`hÎD’£Add
(
hdr
->
»gi¡”s
,
–e
,
–esize
);

1042 
HLL_SPARSE
:  
	`hÎS·r£Add
(
o
,
–e
,
–esize
);

1045 
	}
}

1055 
	$hÎM”ge
(
ušt8_t
 *
max
, 
robj
 *
hÎ
) {

1056 
hÎhdr
 *
hdr
 = 
hÎ
->
±r
;

1057 
i
;

1059 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

1060 
ušt8_t
 
v®
;

1062 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1063 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1064 ià(
v®
 > 
max
[
i
]) max[i] = val;

1067 
ušt8_t
 *
p
 = 
hÎ
->
±r
, *
’d
 =… + 
	`sd¦’
(hll->ptr);

1068 
ruÆ’
, 
»gv®
;

1070 
p
 +ğ
HLL_HDR_SIZE
;

1071 
i
 = 0;

1072 
p
 < 
’d
) {

1073 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1074 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1075 
i
 +ğ
ruÆ’
;

1076 
p
++;

1077 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1078 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1079 
i
 +ğ
ruÆ’
;

1080 
p
 += 2;

1082 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1083 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1084 
ruÆ’
--) {

1085 ià(
»gv®
 > 
max
[
i
]) max[i] =„egval;

1086 
i
++;

1088 
p
++;

1091 ià(
i
 !ğ
HLL_REGISTERS
è 
C_ERR
;

1093  
C_OK
;

1094 
	}
}

1100 
robj
 *
	$ü—‹HLLObjeù
() {

1101 
robj
 *
o
;

1102 
hÎhdr
 *
hdr
;

1103 
sds
 
s
;

1104 
ušt8_t
 *
p
;

1105 
¥¬£Ën
 = 
HLL_HDR_SIZE
 +

1106 (((
HLL_REGISTERS
+(
HLL_SPARSE_XZERO_MAX_LEN
-1)) /

1107 
HLL_SPARSE_XZERO_MAX_LEN
)*2);

1108 
aux
;

1112 
aux
 = 
HLL_REGISTERS
;

1113 
s
 = 
	`sd¢ewËn
(
NULL
,
¥¬£Ën
);

1114 
p
 = (
ušt8_t
*)
s
 + 
HLL_HDR_SIZE
;

1115 
aux
) {

1116 
xz”o
 = 
HLL_SPARSE_XZERO_MAX_LEN
;

1117 ià(
xz”o
 > 
aux
) xzero =‡ux;

1118 
	`HLL_SPARSE_XZERO_SET
(
p
,
xz”o
);

1119 
p
 += 2;

1120 
aux
 -ğ
xz”o
;

1122 
	`£rv”As£¹
((
p
-(
ušt8_t
*)
s
è=ğ
¥¬£Ën
);

1125 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

1126 
hdr
 = 
o
->
±r
;

1127 
	`memıy
(
hdr
->
magic
,"HYLL",4);

1128 
hdr
->
’codšg
 = 
HLL_SPARSE
;

1129  
o
;

1130 
	}
}

1135 
	$isHLLObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
) {

1136 
hÎhdr
 *
hdr
;

1139 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

1140  
C_ERR
;

1142 ià(!
	`sdsEncodedObjeù
(
o
)è
šv®id
;

1143 ià(
	`¡ršgObjeùL’
(
o
è< (*
hdr
)è
šv®id
;

1144 
hdr
 = 
o
->
±r
;

1147 ià(
hdr
->
magic
[0] != 'H' || hdr->magic[1] != 'Y' ||

1148 
hdr
->
magic
[2] !ğ'L' || hdr->magic[3] !ğ'L'è
šv®id
;

1150 ià(
hdr
->
’codšg
 > 
HLL_MAX_ENCODING
è
šv®id
;

1153 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
 &&

1154 
	`¡ršgObjeùL’
(
o
è!ğ
HLL_DENSE_SIZE
è
šv®id
;

1157  
C_OK
;

1159 
šv®id
:

1160 
	`addR•lySds
(
c
,

1161 
	`sd¢ew
("-WRONGTYPE Key is‚ot‡ valid "

1163  
C_ERR
;

1164 
	}
}

1167 
	$pçddCommªd
(
ş›Á
 *
c
) {

1168 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

1169 
hÎhdr
 *
hdr
;

1170 
upd©ed
 = 0, 
j
;

1172 ià(
o
 =ğ
NULL
) {

1176 
o
 = 
	`ü—‹HLLObjeù
();

1177 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1178 
upd©ed
++;

1180 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1181 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1184 
j
 = 2; j < 
c
->
¬gc
; j++) {

1185 
»tv®
 = 
	`hÎAdd
(
o
, (*)
c
->
¬gv
[
j
]->
±r
,

1186 
	`sd¦’
(
c
->
¬gv
[
j
]->
±r
));

1187 
»tv®
) {

1189 
upd©ed
++;

1192 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1196 
hdr
 = 
o
->
±r
;

1197 ià(
upd©ed
) {

1198 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1199 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1200 
£rv”
.
dœty
++;

1201 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1203 
	`addR•ly
(
c
, 
upd©ed
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1204 
	}
}

1207 
	$pfcouÁCommªd
(
ş›Á
 *
c
) {

1208 
robj
 *
o
;

1209 
hÎhdr
 *
hdr
;

1210 
ušt64_t
 
ÿrd
;

1216 ià(
c
->
¬gc
 > 2) {

1217 
ušt8_t
 
max
[
HLL_HDR_SIZE
+
HLL_REGISTERS
], *
»gi¡”s
;

1218 
j
;

1221 
	`mem£t
(
max
,0,(max));

1222 
hdr
 = (
hÎhdr
*è
max
;

1223 
hdr
->
’codšg
 = 
HLL_RAW
;

1224 
»gi¡”s
 = 
max
 + 
HLL_HDR_SIZE
;

1225 
j
 = 1; j < 
c
->
¬gc
; j++) {

1227 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1228 ià(
o
 =ğ
NULL
) ;

1229 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1233 ià(
	`hÎM”ge
(
»gi¡”s
,
o
è=ğ
C_ERR
) {

1234 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1240 
	`addR•lyLÚgLÚg
(
c
,
	`hÎCouÁ
(
hdr
,
NULL
));

1248 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

1249 ià(
o
 =ğ
NULL
) {

1252 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1254 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1255 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1258 
hdr
 = 
o
->
±r
;

1259 ià(
	`HLL_VALID_CACHE
(
hdr
)) {

1261 
ÿrd
 = (
ušt64_t
)
hdr
->card[0];

1262 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[1] << 8;

1263 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[2] << 16;

1264 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[3] << 24;

1265 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[4] << 32;

1266 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[5] << 40;

1267 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[6] << 48;

1268 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[7] << 56;

1270 
šv®id
 = 0;

1272 
ÿrd
 = 
	`hÎCouÁ
(
hdr
,&
šv®id
);

1273 ià(
šv®id
) {

1274 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1277 
hdr
->
ÿrd
[0] = card & 0xff;

1278 
hdr
->
ÿrd
[1] = (card >> 8) & 0xff;

1279 
hdr
->
ÿrd
[2] = (card >> 16) & 0xff;

1280 
hdr
->
ÿrd
[3] = (card >> 24) & 0xff;

1281 
hdr
->
ÿrd
[4] = (card >> 32) & 0xff;

1282 
hdr
->
ÿrd
[5] = (card >> 40) & 0xff;

1283 
hdr
->
ÿrd
[6] = (card >> 48) & 0xff;

1284 
hdr
->
ÿrd
[7] = (card >> 56) & 0xff;

1289 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1290 
£rv”
.
dœty
++;

1292 
	`addR•lyLÚgLÚg
(
c
,
ÿrd
);

1294 
	}
}

1297 
	$pfm”geCommªd
(
ş›Á
 *
c
) {

1298 
ušt8_t
 
max
[
HLL_REGISTERS
];

1299 
hÎhdr
 *
hdr
;

1300 
j
;

1301 
u£_d’£
 = 0;

1306 
	`mem£t
(
max
,0,(max));

1307 
j
 = 1; j < 
c
->
¬gc
; j++) {

1309 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1310 ià(
o
 =ğ
NULL
) ;

1311 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1315 
hdr
 = 
o
->
±r
;

1316 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
è
u£_d’£
 = 1;

1320 ià(
	`hÎM”ge
(
max
,
o
è=ğ
C_ERR
) {

1321 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1327 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

1328 ià(
o
 =ğ
NULL
) {

1332 
o
 = 
	`ü—‹HLLObjeù
();

1333 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1338 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1343 ià(
u£_d’£
 && 
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
) {

1344 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1350 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1351 ià(
max
[
j
] == 0) ;

1352 
hdr
 = 
o
->
±r
;

1353 
hdr
->
’codšg
) {

1354 
HLL_DENSE
: 
	`hÎD’£S‘
(
hdr
->
»gi¡”s
,
j
,
max
[j]); ;

1355 
HLL_SPARSE
: 
	`hÎS·r£S‘
(
o
,
j
,
max
[j]); ;

1358 
hdr
 = 
o
->
±r
;

1360 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1362 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1365 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1366 
£rv”
.
dœty
++;

1367 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1368 
	}
}

1375 
	#HLL_TEST_CYCLES
 1000

	)

1376 
	$pf£láe¡Commªd
(
ş›Á
 *
c
) {

1377 
j
, 
i
;

1378 
sds
 
b™couÁ”s
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

1379 
hÎhdr
 *
hdr
 = (hÎhdr*è
b™couÁ”s
, *
hdr2
;

1380 
robj
 *
o
 = 
NULL
;

1381 
ušt8_t
 
by‹couÁ”s
[
HLL_REGISTERS
];

1387 
j
 = 0; j < 
HLL_TEST_CYCLES
; j++) {

1390 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1391 
r
 = 
	`¿nd
(è& 
HLL_REGISTER_MAX
;

1393 
by‹couÁ”s
[
i
] = 
r
;

1394 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
i
,
r
);

1397 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1398 
v®
;

1400 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1401 ià(
v®
 !ğ
by‹couÁ”s
[
i
]) {

1402 
	`addR•lyE¼ÜFÜm©
(
c
,

1404 
i
, (è
by‹couÁ”s
[i], (è
v®
);

1405 
ş—nup
;

1420 
	`mem£t
(
hdr
->
»gi¡”s
,0,
HLL_DENSE_SIZE
-
HLL_HDR_SIZE
);

1421 
o
 = 
	`ü—‹HLLObjeù
();

1422 
»Ë¼
 = 1.04/
	`sq¹
(
HLL_REGISTERS
);

1423 
št64_t
 
checkpošt
 = 1;

1424 
ušt64_t
 
£ed
 = (ušt64_t)
	`¿nd
() | (uint64_t)rand() << 32;

1425 
ušt64_t
 
–e
;

1426 
j
 = 1; j <= 10000000; j++) {

1427 
–e
 = 
j
 ^ 
£ed
;

1428 
	`hÎD’£Add
(
hdr
->
»gi¡”s
,(*)&
–e
,(ele));

1429 
	`hÎAdd
(
o
,(*)&
–e
,(ele));

1433 ià(
j
 =ğ
checkpošt
 && j < 
£rv”
.
hÎ_¥¬£_max_by‹s
/2) {

1434 
hdr2
 = 
o
->
±r
;

1435 ià(
hdr2
->
’codšg
 !ğ
HLL_SPARSE
) {

1436 
	`addR•lyE¼Ü
(
c
, "TESTFAILED sparseƒncoding‚ot used");

1437 
ş—nup
;

1442 ià(
j
 =ğ
checkpošt
 && 
	`hÎCouÁ
(
hdr
,
NULL
è!ğhÎCouÁ(
o
->
±r
,NULL)) {

1443 
	`addR•lyE¼Ü
(
c
, "TESTFAILED dense/sparse disagree");

1444 
ş—nup
;

1448 ià(
j
 =ğ
checkpošt
) {

1449 
št64_t
 
ab£¼
 = 
checkpošt
 - (št64_t)
	`hÎCouÁ
(
hdr
,
NULL
);

1450 
ušt64_t
 
max”r
 = 
	`û
(
»Ë¼
*6*
checkpošt
);

1456 ià(
j
 =ğ10è
max”r
 = 1;

1458 ià(
ab£¼
 < 0)‡bserr = -abserr;

1459 ià(
ab£¼
 > (
št64_t
)
max”r
) {

1460 
	`addR•lyE¼ÜFÜm©
(
c
,

1462 (è
checkpošt
,

1463 (è
ab£¼
);

1464 
ş—nup
;

1466 
checkpošt
 *= 10;

1471 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1473 
ş—nup
:

1474 
	`sdsä“
(
b™couÁ”s
);

1475 ià(
o
è
	`deüRefCouÁ
(o);

1476 
	}
}

1480 
	$pfdebugCommªd
(
ş›Á
 *
c
) {

1481 *
cmd
 = 
c
->
¬gv
[1]->
±r
;

1482 
hÎhdr
 *
hdr
;

1483 
robj
 *
o
;

1484 
j
;

1486 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]);

1487 ià(
o
 =ğ
NULL
) {

1488 
	`addR•lyE¼Ü
(
c
,"The specified key does‚otƒxist");

1491 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
C_OK
) ;

1492 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[2],o);

1493 
hdr
 = 
o
->
±r
;

1496 ià(!
	`¡rÿ£cmp
(
cmd
,"getreg")) {

1497 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1499 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1500 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
) {

1501 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1504 
£rv”
.
dœty
++;

1507 
hdr
 = 
o
->
±r
;

1508 
	`addR•lyMuÉiBulkL’
(
c
,
HLL_REGISTERS
);

1509 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1510 
ušt8_t
 
v®
;

1512 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
j
);

1513 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1517 ià(!
	`¡rÿ£cmp
(
cmd
,"decode")) {

1518 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1520 
ušt8_t
 *
p
 = 
o
->
±r
, *
’d
 =…+
	`sd¦’
(o->ptr);

1521 
sds
 
decoded
 = 
	`sd£m±y
();

1523 ià(
hdr
->
’codšg
 !ğ
HLL_SPARSE
) {

1524 
	`addR•lyE¼Ü
(
c
,"HLLƒncoding is‚ot sparse");

1528 
p
 +ğ
HLL_HDR_SIZE
;

1529 
p
 < 
’d
) {

1530 
ruÆ’
, 
»gv®
;

1532 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1533 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1534 
p
++;

1535 
decoded
 = 
	`sdsÿrštf
(decoded,"z:%d ",
ruÆ’
);

1536 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1537 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1538 
p
 += 2;

1539 
decoded
 = 
	`sdsÿrštf
(decoded,"Z:%d ",
ruÆ’
);

1541 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1542 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1543 
p
++;

1544 
decoded
 = 
	`sdsÿrštf
(decoded,"v:%d,%d ",
»gv®
,
ruÆ’
);

1547 
decoded
 = 
	`sd¡rim
(decoded," ");

1548 
	`addR•lyBulkCBufãr
(
c
,
decoded
,
	`sd¦’
(decoded));

1549 
	`sdsä“
(
decoded
);

1552 ià(!
	`¡rÿ£cmp
(
cmd
,"encoding")) {

1553 *
’codšg¡r
[2] = {"dense","sparse"};

1554 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1556 
	`addR•lyStus
(
c
,
’codšg¡r
[
hdr
->
’codšg
]);

1559 ià(!
	`¡rÿ£cmp
(
cmd
,"todense")) {

1560 
cÚv
 = 0;

1561 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1563 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1564 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
C_ERR
) {

1565 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1568 
cÚv
 = 1;

1569 
£rv”
.
dœty
++;

1571 
	`addR•ly
(
c
,
cÚv
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1573 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀPFDEBUG subcommªd '%s'", 
cmd
);

1577 
¬™y”r
:

1578 
	`addR•lyE¼ÜFÜm©
(
c
,

1579 "WrÚg‚umb” oà¬gum’t fÜh'%s' subcommªd",
cmd
);

1580 
	}
}

	@src/intset.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<¡ršg.h
>

34 
	~"št£t.h
"

35 
	~"zm®loc.h
"

36 
	~"’dŸncÚv.h
"

40 
	#INTSET_ENC_INT16
 ((
št16_t
))

	)

41 
	#INTSET_ENC_INT32
 ((
št32_t
))

	)

42 
	#INTSET_ENC_INT64
 ((
št64_t
))

	)

45 
ušt8_t
 
	$_št£tV®ueEncodšg
(
št64_t
 
v
) {

46 ià(
v
 < 
INT32_MIN
 || v > 
INT32_MAX
)

47  
INTSET_ENC_INT64
;

48 ià(
v
 < 
INT16_MIN
 || v > 
INT16_MAX
)

49  
INTSET_ENC_INT32
;

51  
INTSET_ENC_INT16
;

52 
	}
}

55 
št64_t
 
	$_št£tG‘Encoded
(
št£t
 *
is
, 
pos
, 
ušt8_t
 
’c
) {

56 
št64_t
 
v64
;

57 
št32_t
 
v32
;

58 
št16_t
 
v16
;

60 ià(
’c
 =ğ
INTSET_ENC_INT64
) {

61 
	`memıy
(&
v64
,((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
,(v64));

62 
	`mem»v64ifbe
(&
v64
);

63  
v64
;

64 } ià(
’c
 =ğ
INTSET_ENC_INT32
) {

65 
	`memıy
(&
v32
,((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
,(v32));

66 
	`mem»v32ifbe
(&
v32
);

67  
v32
;

69 
	`memıy
(&
v16
,((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
,(v16));

70 
	`mem»v16ifbe
(&
v16
);

71  
v16
;

73 
	}
}

76 
št64_t
 
	$_št£tG‘
(
št£t
 *
is
, 
pos
) {

77  
	`_št£tG‘Encoded
(
is
,
pos
,
	`šŒev32ifbe
(is->
’codšg
));

78 
	}
}

81 
	$_št£tS‘
(
št£t
 *
is
, 
pos
, 
št64_t
 
v®ue
) {

82 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

84 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

85 ((
št64_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

86 
	`mem»v64ifbe
(((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
);

87 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

88 ((
št32_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

89 
	`mem»v32ifbe
(((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
);

91 ((
št16_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

92 
	`mem»v16ifbe
(((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
);

94 
	}
}

97 
št£t
 *
	$št£tNew
() {

98 
št£t
 *
is
 = 
	`zm®loc
((intset));

99 
is
->
’codšg
 = 
	`šŒev32ifbe
(
INTSET_ENC_INT16
);

100 
is
->
Ëngth
 = 0;

101  
is
;

102 
	}
}

105 
št£t
 *
	$št£tResize
(
št£t
 *
is
, 
ušt32_t
 
Ën
) {

106 
ušt32_t
 
size
 = 
Ën
*
	`šŒev32ifbe
(
is
->
’codšg
);

107 
is
 = 
	`z»®loc
(is,(
št£t
)+
size
);

108  
is
;

109 
	}
}

115 
ušt8_t
 
	$št£tS—rch
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt32_t
 *
pos
) {

116 
mš
 = 0, 
max
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-1, 
mid
 = -1;

117 
št64_t
 
cur
 = -1;

120 ià(
	`šŒev32ifbe
(
is
->
Ëngth
) == 0) {

121 ià(
pos
) *pos = 0;

126 ià(
v®ue
 > 
	`_št£tG‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
)-1)) {

127 ià(
pos
è*po ğ
	`šŒev32ifbe
(
is
->
Ëngth
);

129 } ià(
v®ue
 < 
	`_št£tG‘
(
is
,0)) {

130 ià(
pos
) *pos = 0;

135 
max
 >ğ
mš
) {

136 
mid
 = (()
mš
 + ()
max
) >> 1;

137 
cur
 = 
	`_št£tG‘
(
is
,
mid
);

138 ià(
v®ue
 > 
cur
) {

139 
mš
 = 
mid
+1;

140 } ià(
v®ue
 < 
cur
) {

141 
max
 = 
mid
-1;

147 ià(
v®ue
 =ğ
cur
) {

148 ià(
pos
è*po ğ
mid
;

151 ià(
pos
è*po ğ
mš
;

154 
	}
}

157 
št£t
 *
	$št£tUpg¿deAndAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

158 
ušt8_t
 
cu»nc
 = 
	`šŒev32ifbe
(
is
->
’codšg
);

159 
ušt8_t
 
Ãw’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

160 
Ëngth
 = 
	`šŒev32ifbe
(
is
->length);

161 
´•’d
 = 
v®ue
 < 0 ? 1 : 0;

164 
is
->
’codšg
 = 
	`šŒev32ifbe
(
Ãw’c
);

165 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

170 
Ëngth
--)

171 
	`_št£tS‘
(
is
,
Ëngth
+
´•’d
,
	`_št£tG‘Encoded
(is,Ëngth,
cu»nc
));

174 ià(
´•’d
)

175 
	`_št£tS‘
(
is
,0,
v®ue
);

177 
	`_št£tS‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
),
v®ue
);

178 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

179  
is
;

180 
	}
}

182 
	$št£tMoveTa
(
št£t
 *
is
, 
ušt32_t
 
äom
, ušt32_ˆ
to
) {

183 *
¤c
, *
d¡
;

184 
ušt32_t
 
by‹s
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-
äom
;

185 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

187 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

188 
¤c
 = (
št64_t
*)
is
->
cÚ‹Ás
+
äom
;

189 
d¡
 = (
št64_t
*)
is
->
cÚ‹Ás
+
to
;

190 
by‹s
 *ğ(
št64_t
);

191 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

192 
¤c
 = (
št32_t
*)
is
->
cÚ‹Ás
+
äom
;

193 
d¡
 = (
št32_t
*)
is
->
cÚ‹Ás
+
to
;

194 
by‹s
 *ğ(
št32_t
);

196 
¤c
 = (
št16_t
*)
is
->
cÚ‹Ás
+
äom
;

197 
d¡
 = (
št16_t
*)
is
->
cÚ‹Ás
+
to
;

198 
by‹s
 *ğ(
št16_t
);

200 
	`memmove
(
d¡
,
¤c
,
by‹s
);

201 
	}
}

204 
št£t
 *
	$št£tAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
) {

205 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

206 
ušt32_t
 
pos
;

207 ià(
sucûss
) *success = 1;

212 ià(
v®’c
 > 
	`šŒev32ifbe
(
is
->
’codšg
)) {

214  
	`št£tUpg¿deAndAdd
(
is
,
v®ue
);

219 ià(
	`št£tS—rch
(
is
,
v®ue
,&
pos
)) {

220 ià(
sucûss
) *success = 0;

221  
is
;

224 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

225 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)è
	`št£tMoveTa
(is,pos,pos+1);

228 
	`_št£tS‘
(
is
,
pos
,
v®ue
);

229 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

230  
is
;

231 
	}
}

234 
št£t
 *
	$št£tRemove
(
št£t
 *
is
, 
št64_t
 
v®ue
, *
sucûss
) {

235 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

236 
ušt32_t
 
pos
;

237 ià(
sucûss
) *success = 0;

239 ià(
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,&
pos
)) {

240 
ušt32_t
 
Ën
 = 
	`šŒev32ifbe
(
is
->
Ëngth
);

243 ià(
sucûss
) *success = 1;

246 ià(
pos
 < (
Ën
-1)è
	`št£tMoveTa
(
is
,pos+1,pos);

247 
is
 = 
	`št£tResize
(is,
Ën
-1);

248 
is
->
Ëngth
 = 
	`šŒev32ifbe
(
Ën
-1);

250  
is
;

251 
	}
}

254 
ušt8_t
 
	$št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

255 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

256  
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,
NULL
);

257 
	}
}

260 
št64_t
 
	$št£tRªdom
(
št£t
 *
is
) {

261  
	`_št£tG‘
(
is
,
	`¿nd
()%
	`šŒev32ifbe
(is->
Ëngth
));

262 
	}
}

266 
ušt8_t
 
	$št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
) {

267 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)) {

268 *
v®ue
 = 
	`_št£tG‘
(
is
,
pos
);

272 
	}
}

275 
ušt32_t
 
	$št£tL’
(cÚ¡ 
št£t
 *
is
) {

276  
	`šŒev32ifbe
(
is
->
Ëngth
);

277 
	}
}

280 
size_t
 
	$št£tBlobL’
(
št£t
 *
is
) {

281  (
št£t
)+
	`šŒev32ifbe
(
is
->
Ëngth
)*šŒev32ifbe(is->
’codšg
);

282 
	}
}

284 #ifdeà
REDIS_TEST


285 
	~<sys/time.h
>

286 
	~<time.h
>

289 
	$št£tR•r
(
št£t
 *
is
) {

290 
ušt32_t
 
i
 = 0; i < 
	`šŒev32ifbe
(
is
->
Ëngth
); i++) {

291 
	`´štf
("%Îd\n", (
ušt64_t
)
	`_št£tG‘
(
is
,
i
));

293 
	`´štf
("\n");

294 
	}
}

296 
	$”rÜ
(*
”r
) {

297 
	`´štf
("%s\n", 
”r
);

298 
	`ex™
(1);

299 
	}
}

302 
	$ok
() {

303 
	`´štf
("OK\n");

304 
	}
}

306 
	$u£c
() {

307 
timev®
 
tv
;

308 
	`g‘timeofday
(&
tv
,
NULL
);

309  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

310 
	}
}

312 
	#as£¹
(
_e
è((_e)?()0:(
	`_as£¹
(#_e,
__FILE__
,
__LINE__
),
	`ex™
(1)))

	)

313 
	$_as£¹
(*
e¡r
, *
fe
, 
lše
) {

314 
	`´štf
("\n\n=== ASSERTION FAILED ===\n");

315 
	`´štf
("==> %s:%d '%s' i nÙrue\n",
fe
,
lše
,
e¡r
);

316 
	}
}

318 
št£t
 *
	$ü—‹S‘
(
b™s
, 
size
) {

319 
ušt64_t
 
mask
 = (1<<
b™s
)-1;

320 
ušt64_t
 
v®ue
;

321 
št£t
 *
is
 = 
	`št£tNew
();

323 
i
 = 0; i < 
size
; i++) {

324 ià(
b™s
 > 32) {

325 
v®ue
 = (
	`¿nd
()*¿nd()è& 
mask
;

327 
v®ue
 = 
	`¿nd
(è& 
mask
;

329 
is
 = 
	`št£tAdd
(is,
v®ue
,
NULL
);

331  
is
;

332 
	}
}

334 
	$checkCÚsi¡’cy
(
št£t
 *
is
) {

335 
ušt32_t
 
i
 = 0; i < (
	`šŒev32ifbe
(
is
->
Ëngth
)-1); i++) {

336 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

338 ià(
’codšg
 =ğ
INTSET_ENC_INT16
) {

339 
št16_t
 *
i16
 = (št16_t*)
is
->
cÚ‹Ás
;

340 
	`as£¹
(
i16
[
i
] < i16[i+1]);

341 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

342 
št32_t
 *
i32
 = (št32_t*)
is
->
cÚ‹Ás
;

343 
	`as£¹
(
i32
[
i
] < i32[i+1]);

345 
št64_t
 *
i64
 = (št64_t*)
is
->
cÚ‹Ás
;

346 
	`as£¹
(
i64
[
i
] < i64[i+1]);

349 
	}
}

351 
	#UNUSED
(
x
è()(x)

	)

352 
	$št£tTe¡
(
¬gc
, **
¬gv
) {

353 
ušt8_t
 
sucûss
;

354 
i
;

355 
št£t
 *
is
;

356 
	`¤ªd
(
	`time
(
NULL
));

358 
	`UNUSED
(
¬gc
);

359 
	`UNUSED
(
¬gv
);

361 
	`´štf
("Valueƒncodings: "); {

362 
	`as£¹
(
	`_št£tV®ueEncodšg
(-32768è=ğ
INTSET_ENC_INT16
);

363 
	`as£¹
(
	`_št£tV®ueEncodšg
(+32767è=ğ
INTSET_ENC_INT16
);

364 
	`as£¹
(
	`_št£tV®ueEncodšg
(-32769è=ğ
INTSET_ENC_INT32
);

365 
	`as£¹
(
	`_št£tV®ueEncodšg
(+32768è=ğ
INTSET_ENC_INT32
);

366 
	`as£¹
(
	`_št£tV®ueEncodšg
(-2147483648è=ğ
INTSET_ENC_INT32
);

367 
	`as£¹
(
	`_št£tV®ueEncodšg
(+2147483647è=ğ
INTSET_ENC_INT32
);

368 
	`as£¹
(
	`_št£tV®ueEncodšg
(-2147483649è=ğ
INTSET_ENC_INT64
);

369 
	`as£¹
(
	`_št£tV®ueEncodšg
(+2147483648è=ğ
INTSET_ENC_INT64
);

370 
	`as£¹
(
	`_št£tV®ueEncodšg
(-9223372036854775808ull) ==

371 
INTSET_ENC_INT64
);

372 
	`as£¹
(
	`_št£tV®ueEncodšg
(+9223372036854775807ull) ==

373 
INTSET_ENC_INT64
);

374 
	`ok
();

377 
	`´štf
("Basic‡dding: "); {

378 
is
 = 
	`št£tNew
();

379 
is
 = 
	`št£tAdd
(is,5,&
sucûss
); 
	`as£¹
(success);

380 
is
 = 
	`št£tAdd
(is,6,&
sucûss
); 
	`as£¹
(success);

381 
is
 = 
	`št£tAdd
(is,4,&
sucûss
); 
	`as£¹
(success);

382 
is
 = 
	`št£tAdd
(is,4,&
sucûss
); 
	`as£¹
(!success);

383 
	`ok
();

386 
	`´štf
("Large‚umber of„andom‡dds: "); {

387 
ušt32_t
 
š£¹s
 = 0;

388 
is
 = 
	`št£tNew
();

389 
i
 = 0; i < 1024; i++) {

390 
is
 = 
	`št£tAdd
(is,
	`¿nd
()%0x800,&
sucûss
);

391 ià(
sucûss
è
š£¹s
++;

393 
	`as£¹
(
	`šŒev32ifbe
(
is
->
Ëngth
è=ğ
š£¹s
);

394 
	`checkCÚsi¡’cy
(
is
);

395 
	`ok
();

398 
	`´štf
("Upgrade from int16o int32: "); {

399 
is
 = 
	`št£tNew
();

400 
is
 = 
	`št£tAdd
(is,32,
NULL
);

401 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

402 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

403 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

404 
	`as£¹
(
	`št£tFšd
(
is
,32));

405 
	`as£¹
(
	`št£tFšd
(
is
,65535));

406 
	`checkCÚsi¡’cy
(
is
);

408 
is
 = 
	`št£tNew
();

409 
is
 = 
	`št£tAdd
(is,32,
NULL
);

410 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

411 
is
 = 
	`št£tAdd
(is,-65535,
NULL
);

412 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

413 
	`as£¹
(
	`št£tFšd
(
is
,32));

414 
	`as£¹
(
	`št£tFšd
(
is
,-65535));

415 
	`checkCÚsi¡’cy
(
is
);

416 
	`ok
();

419 
	`´štf
("Upgrade from int16o int64: "); {

420 
is
 = 
	`št£tNew
();

421 
is
 = 
	`št£tAdd
(is,32,
NULL
);

422 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

423 
is
 = 
	`št£tAdd
(is,4294967295,
NULL
);

424 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

425 
	`as£¹
(
	`št£tFšd
(
is
,32));

426 
	`as£¹
(
	`št£tFšd
(
is
,4294967295));

427 
	`checkCÚsi¡’cy
(
is
);

429 
is
 = 
	`št£tNew
();

430 
is
 = 
	`št£tAdd
(is,32,
NULL
);

431 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

432 
is
 = 
	`št£tAdd
(is,-4294967295,
NULL
);

433 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

434 
	`as£¹
(
	`št£tFšd
(
is
,32));

435 
	`as£¹
(
	`št£tFšd
(
is
,-4294967295));

436 
	`checkCÚsi¡’cy
(
is
);

437 
	`ok
();

440 
	`´štf
("Upgrade from int32o int64: "); {

441 
is
 = 
	`št£tNew
();

442 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

443 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

444 
is
 = 
	`št£tAdd
(is,4294967295,
NULL
);

445 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

446 
	`as£¹
(
	`št£tFšd
(
is
,65535));

447 
	`as£¹
(
	`št£tFšd
(
is
,4294967295));

448 
	`checkCÚsi¡’cy
(
is
);

450 
is
 = 
	`št£tNew
();

451 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

452 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

453 
is
 = 
	`št£tAdd
(is,-4294967295,
NULL
);

454 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

455 
	`as£¹
(
	`št£tFšd
(
is
,65535));

456 
	`as£¹
(
	`št£tFšd
(
is
,-4294967295));

457 
	`checkCÚsi¡’cy
(
is
);

458 
	`ok
();

461 
	`´štf
("Stress†ookups: "); {

462 
num
 = 100000, 
size
 = 10000;

463 
i
, 
b™s
 = 20;

464 
¡¬t
;

465 
is
 = 
	`ü—‹S‘
(
b™s
,
size
);

466 
	`checkCÚsi¡’cy
(
is
);

468 
¡¬t
 = 
	`u£c
();

469 
i
 = 0; i < 
num
; i++è
	`št£tS—rch
(
is
,
	`¿nd
(è% ((1<<
b™s
)-1),
NULL
);

470 
	`´štf
("%ld†ookups, %ldƒlement set, %lldusec\n",

471 
num
,
size
,
	`u£c
()-
¡¬t
);

474 
	`´štf
("Stress‡dd+delete: "); {

475 
i
, 
v1
, 
v2
;

476 
is
 = 
	`št£tNew
();

477 
i
 = 0; i < 0xffff; i++) {

478 
v1
 = 
	`¿nd
() % 0xfff;

479 
is
 = 
	`št£tAdd
(is,
v1
,
NULL
);

480 
	`as£¹
(
	`št£tFšd
(
is
,
v1
));

482 
v2
 = 
	`¿nd
() % 0xfff;

483 
is
 = 
	`št£tRemove
(is,
v2
,
NULL
);

484 
	`as£¹
(!
	`št£tFšd
(
is
,
v2
));

486 
	`checkCÚsi¡’cy
(
is
);

487 
	`ok
();

491 
	}
}

	@src/intset.h

31 #iâdeà
__INTSET_H


32 
	#__INTSET_H


	)

33 
	~<¡dšt.h
>

35 
	sšt£t
 {

36 
ušt32_t
 
	m’codšg
;

37 
ušt32_t
 
	mËngth
;

38 
št8_t
 
	mcÚ‹Ás
[];

39 } 
	tšt£t
;

41 
št£t
 *
št£tNew
();

42 
št£t
 *
št£tAdd
(št£ˆ*
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
);

43 
št£t
 *
št£tRemove
(št£ˆ*
is
, 
št64_t
 
v®ue
, *
sucûss
);

44 
ušt8_t
 
št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
);

45 
št64_t
 
št£tRªdom
(
št£t
 *
is
);

46 
ušt8_t
 
št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
);

47 
ušt32_t
 
št£tL’
(cÚ¡ 
št£t
 *
is
);

48 
size_t
 
št£tBlobL’
(
št£t
 *
is
);

50 #ifdeà
REDIS_TEST


51 
št£tTe¡
(
¬gc
, *
¬gv
[]);

	@src/latency.c

36 
	~"£rv”.h
"

39 
	$diùSŒšgKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

40 
	`UNUSED
(
´ivd©a
);

41  
	`¡rcmp
(
key1
,
key2
) == 0;

42 
	}
}

44 
ušt64_t
 
	$diùSŒšgHash
(cÚ¡ *
key
) {

45  
	`diùG’HashFunùiÚ
(
key
, 
	`¡¾’
(key));

46 
	}
}

48 
diùVªÏF»e
(*
´ivd©a
, *
v®
);

50 
diùTy³
 
	gÏ‹ncyTimeS”›sDiùTy³
 = {

51 
diùSŒšgHash
,

52 
NULL
,

53 
NULL
,

54 
diùSŒšgKeyCom·»
,

55 
diùVªÏF»e
,

56 
diùVªÏF»e


61 #ifdeà
__lšux__


64 
	$THPIsEÇbËd
() {

65 
buf
[1024];

67 
FILE
 *
å
 = 
	`fİ’
("/sys/kernel/mm/transparent_hugepage/enabled","r");

68 ià(!
å
)  0;

69 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

70 
	`fşo£
(
å
);

73 
	`fşo£
(
å
);

74  (
	`¡r¡r
(
buf
,"[Ãv”]"è=ğ
NULL
) ? 1 : 0;

75 
	}
}

81 
	$THPG‘AnÚHugePagesSize
() {

82  
	`zm®loc_g‘_sm­_by‹s_by_f›ld
("AnonHugePages:",-1);

83 
	}
}

90 
	$Ï‹ncyMÚ™ÜIn™
() {

91 
£rv”
.
Ï‹ncy_ev’ts
 = 
	`diùC»©e
(&
Ï‹ncyTimeS”›sDiùTy³
,
NULL
);

92 
	}
}

98 
	$Ï‹ncyAddSam¶e
(*
ev’t
, 
m¡ime_t
 
Ï‹ncy
) {

99 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
ev’t
);

100 
time_t
 
now
 = 
	`time
(
NULL
);

101 
´ev
;

104 ià(
ts
 =ğ
NULL
) {

105 
ts
 = 
	`zm®loc
((*ts));

106 
ts
->
idx
 = 0;

107 
ts
->
max
 = 0;

108 
	`mem£t
(
ts
->
§m¶es
,0,(ts->samples));

109 
	`diùAdd
(
£rv”
.
Ï‹ncy_ev’ts
,
	`z¡rdup
(
ev’t
),
ts
);

112 ià(
Ï‹ncy
 > 
ts
->
max
)s->max =†atency;

116 
´ev
 = (
ts
->
idx
 + 
LATENCY_TS_LEN
 - 1) % LATENCY_TS_LEN;

117 ià(
ts
->
§m¶es
[
´ev
].
time
 =ğ
now
) {

118 ià(
Ï‹ncy
 > 
ts
->
§m¶es
[
´ev
].latency)

119 
ts
->
§m¶es
[
´ev
].
Ï‹ncy
 =†atency;

123 
ts
->
§m¶es
[ts->
idx
].
time
 = 
	`time
(
NULL
);

124 
ts
->
§m¶es
[ts->
idx
].
Ï‹ncy
 =†atency;

126 
ts
->
idx
++;

127 ià(
ts
->
idx
 =ğ
LATENCY_TS_LEN
)s->idx = 0;

128 
	}
}

135 
	$Ï‹ncyRe£tEv’t
(*
ev’t_to_»£t
) {

136 
diùI‹¿tÜ
 *
di
;

137 
diùEÁry
 *
de
;

138 
»£ts
 = 0;

140 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

141 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

142 *
ev’t
 = 
	`diùG‘Key
(
de
);

144 ià(
ev’t_to_»£t
 =ğ
NULL
 || 
	`¡rÿ£cmp
(
ev’t
,event_to_reset) == 0) {

145 
	`diùD–‘e
(
£rv”
.
Ï‹ncy_ev’ts
, 
ev’t
);

146 
»£ts
++;

149 
	`diùR–—£I‹¿tÜ
(
di
);

150  
»£ts
;

151 
	}
}

160 
	$ª®yzeL©’cyFÜEv’t
(*
ev’t
, 
Ï‹ncySts
 *
ls
) {

161 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
ev’t
);

162 
j
;

163 
ušt64_t
 
sum
;

165 
ls
->
®l_time_high
 = 
ts
 ?s->
max
 : 0;

166 
ls
->
avg
 = 0;

167 
ls
->
mš
 = 0;

168 
ls
->
max
 = 0;

169 
ls
->
mad
 = 0;

170 
ls
->
§m¶es
 = 0;

171 
ls
->
³riod
 = 0;

172 ià(!
ts
) ;

175 
sum
 = 0;

176 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

177 ià(
ts
->
§m¶es
[
j
].
time
 == 0) ;

178 
ls
->
§m¶es
++;

179 ià(
ls
->
§m¶es
 == 1) {

180 
ls
->
mš
 =†s->
max
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

182 ià(
ls
->
mš
 > 
ts
->
§m¶es
[
j
].
Ï‹ncy
)

183 
ls
->
mš
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

184 ià(
ls
->
max
 < 
ts
->
§m¶es
[
j
].
Ï‹ncy
)

185 
ls
->
max
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

187 
sum
 +ğ
ts
->
§m¶es
[
j
].
Ï‹ncy
;

190 ià(
ls
->
³riod
 =ğ0 || 
ts
->
§m¶es
[
j
].
time
 <†s->period)

191 
ls
->
³riod
 = 
ts
->
§m¶es
[
j
].
time
;

197 ià(
ls
->
§m¶es
) {

198 
ls
->
avg
 = 
sum
 /†s->
§m¶es
;

199 
ls
->
³riod
 = 
	`time
(
NULL
) -†s->period;

200 ià(
ls
->
³riod
 == 0)†s->period = 1;

204 
sum
 = 0;

205 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

206 
št64_t
 
d–
;

208 ià(
ts
->
§m¶es
[
j
].
time
 == 0) ;

209 
d–
 = (
št64_t
)
ls
->
avg
 - 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

210 ià(
d–
 < 0) delta = -delta;

211 
sum
 +ğ
d–
;

213 ià(
ls
->
§m¶es
èls->
mad
 = 
sum
 /†s->samples;

214 
	}
}

217 
sds
 
	$ü—‹L©’cyR•Üt
() {

218 
sds
 
»pÜt
 = 
	`sd£m±y
();

219 
advi£_b‘‹r_vm
 = 0;

220 
advi£_¦owlog_’abËd
 = 0;

221 
advi£_¦owlog_tunšg
 = 0;

222 
advi£_¦owlog_š¥eù
 = 0;

223 
advi£_disk_cÚ‹ÁiÚ
 = 0;

224 
advi£_scheduËr
 = 0;

225 
advi£_d©a_wr™eback
 = 0;

226 
advi£_no_­³ndfsync
 = 0;

227 
advi£_loÿl_disk
 = 0;

228 
advi£_ssd
 = 0;

229 
advi£_wr™e_lßd_šfo
 = 0;

230 
advi£_hz
 = 0;

231 
advi£_Ïrge_objeùs
 = 0;

232 
advi£_mass_eviùiÚ
 = 0;

233 
advi£_»Ïx_fsync_pŞicy
 = 0;

234 
advi£_di§bË_thp
 = 0;

235 
adviûs
 = 0;

239 ià(
	`diùSize
(
£rv”
.
Ï‹ncy_ev’ts
) == 0 &&

240 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 == 0)

242 
»pÜt
 = 
	`sdsÿt
(report,"I'm sorry, Dave, I can't dohat. Latency monitoring is disabled inhis Redis instance. You may use \"CONFIG SET†atency-monitor-threshold <milliseconds>.\" in orderoƒnable it. If we weren't in‡ deep space mission I'd suggestoake‡†ook‡t http://redis.io/topics/latency-monitor.\n");

243  
»pÜt
;

248 
diùI‹¿tÜ
 *
di
;

249 
diùEÁry
 *
de
;

250 
ev’Šum
 = 0;

252 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

253 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

254 *
ev’t
 = 
	`diùG‘Key
(
de
);

255 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùG‘V®
(
de
);

256 
Ï‹ncySts
 
ls
;

258 ià(
ts
 =ğ
NULL
) ;

259 
ev’Šum
++;

260 ià(
ev’Šum
 == 1) {

261 
»pÜt
 = 
	`sdsÿt
(report,"Dave, I have observed†atency spikes inhis Redis instance. You don't mindalking‡bout it, do you Dave?\n\n");

263 
	`ª®yzeL©’cyFÜEv’t
(
ev’t
,&
ls
);

265 
»pÜt
 = 
	`sdsÿrštf
(report,

267 
ev’Šum
, 
ev’t
,

268 
ls
.
§m¶es
,

269 (è
ls
.
avg
,

270 (è
ls
.
mad
,

271 (è
ls
.
³riod
/ls.
§m¶es
,

272 (è
ts
->
max
);

275 ià(!
	`¡rÿ£cmp
(
ev’t
,"fork")) {

276 *
fÜk_qu®™y
;

277 ià(
£rv”
.
¡©_fÜk_¿‹
 < 10) {

278 
fÜk_qu®™y
 = "terrible";

279 
advi£_b‘‹r_vm
 = 1;

280 
adviûs
++;

281 } ià(
£rv”
.
¡©_fÜk_¿‹
 < 25) {

282 
fÜk_qu®™y
 = "poor";

283 
advi£_b‘‹r_vm
 = 1;

284 
adviûs
++;

285 } ià(
£rv”
.
¡©_fÜk_¿‹
 < 100) {

286 
fÜk_qu®™y
 = "good";

288 
fÜk_qu®™y
 = "excellent";

290 
»pÜt
 = 
	`sdsÿrštf
(report,

291 " FÜk„©i %.2àGB/£ø(%s).", 
£rv”
.
¡©_fÜk_¿‹
,

292 
fÜk_qu®™y
);

296 ià(!
	`¡rÿ£cmp
(
ev’t
,"command")) {

297 ià(
£rv”
.
¦owlog_log_¦ow”_thª
 == 0) {

298 
advi£_¦owlog_’abËd
 = 1;

299 
adviûs
++;

300 } ià(
£rv”
.
¦owlog_log_¦ow”_thª
/1000 >

301 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
)

303 
advi£_¦owlog_tunšg
 = 1;

304 
adviûs
++;

306 
advi£_¦owlog_š¥eù
 = 1;

307 
advi£_Ïrge_objeùs
 = 1;

308 
adviûs
 += 2;

312 ià(!
	`¡rÿ£cmp
(
ev’t
,"fast-command")) {

313 
advi£_scheduËr
 = 1;

314 
adviûs
++;

318 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-pending-fsync")) {

319 
advi£_loÿl_disk
 = 1;

320 
advi£_disk_cÚ‹ÁiÚ
 = 1;

321 
advi£_ssd
 = 1;

322 
advi£_d©a_wr™eback
 = 1;

323 
adviûs
 += 4;

326 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-active-child")) {

327 
advi£_no_­³ndfsync
 = 1;

328 
advi£_d©a_wr™eback
 = 1;

329 
advi£_ssd
 = 1;

330 
adviûs
 += 3;

333 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-alone")) {

334 
advi£_loÿl_disk
 = 1;

335 
advi£_d©a_wr™eback
 = 1;

336 
advi£_ssd
 = 1;

337 
adviûs
 += 3;

340 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-fsync-always")) {

341 
advi£_»Ïx_fsync_pŞicy
 = 1;

342 
adviûs
++;

345 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-fstat") ||

346 !
	`¡rÿ£cmp
(
ev’t
,"rdb-unlik-temp-file")) {

347 
advi£_disk_cÚ‹ÁiÚ
 = 1;

348 
advi£_loÿl_disk
 = 1;

349 
adviûs
 += 2;

352 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-rewrite-diff-write") ||

353 !
	`¡rÿ£cmp
(
ev’t
,"aof-rename")) {

354 
advi£_wr™e_lßd_šfo
 = 1;

355 
advi£_d©a_wr™eback
 = 1;

356 
advi£_ssd
 = 1;

357 
advi£_loÿl_disk
 = 1;

358 
adviûs
 += 4;

362 ià(!
	`¡rÿ£cmp
(
ev’t
,"expire-cycle")) {

363 
advi£_hz
 = 1;

364 
advi£_Ïrge_objeùs
 = 1;

365 
adviûs
 += 2;

369 ià(!
	`¡rÿ£cmp
(
ev’t
,"eviction-del")) {

370 
advi£_Ïrge_objeùs
 = 1;

371 
adviûs
++;

374 ià(!
	`¡rÿ£cmp
(
ev’t
,"eviction-cycle")) {

375 
advi£_mass_eviùiÚ
 = 1;

376 
adviûs
++;

379 
»pÜt
 = 
	`sdsÿ’
(report,"\n",1);

381 
	`diùR–—£I‹¿tÜ
(
di
);

384 ià(
	`THPG‘AnÚHugePagesSize
() > 0) {

385 
advi£_di§bË_thp
 = 1;

386 
adviûs
++;

389 ià(
ev’Šum
 =ğ0 && 
adviûs
 == 0) {

390 
»pÜt
 = 
	`sdsÿt
(report,"Dave,‚o†atency spike was observed duringhe†ifetime ofhis Redis instance,‚ot inhe slightest bit. I honestlyhink you oughto sit down calmly,ake‡ stress…ill,‡ndhinkhings over.\n");

391 } ià(
ev’Šum
 > 0 && 
adviûs
 == 0) {

392 
»pÜt
 = 
	`sdsÿt
(report,"\nWhilehere‡re†atencyƒvents†ogged, I'm‚ot‡bleo suggest‡nyƒasy fix. Please usehe Redis communityo get some help,…rovidinghis„eport in your help„equest.\n");

397 
»pÜt
 = 
	`sdsÿt
(report,"\nI have‡ few‡dvices for you:\n\n");

398 ià(
advi£_b‘‹r_vm
) {

399 
»pÜt
 = 
	`sdsÿt
(report,"- If you‡re using‡ virtual machine, consider upgrading it with‡ faster one using‡n hypervisiorhat…rovides†ess†atency during fork() calls. Xen is knowno have…oor fork()…erformance. Even inhe context ofhe same VM…rovider, certain kinds of instances canƒxecute fork fasterhan others.\n");

403 ià(
advi£_¦owlog_’abËd
) {

404 
»pÜt
 = 
	`sdsÿrštf
Ô•Üt,"- Th”¬Ï‹ncy issue w™h…Ù’tŸÎy slow commªd you‡» usšg. TryØ’abËhSlow Log Redi ã©u» usšghcommªd 'CONFIG SET slowlog-log-¦ow”-thª %Îu'. IàthSlow†og i di§bËd Redi i nÙ‡bËØlog slow commªd executiÚ fÜ you.\n", ()
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
*1000);

407 ià(
advi£_¦owlog_tunšg
) {

408 
»pÜt
 = 
	`sdsÿrštf
Ô•Üt,"- You¸cu¼’ˆSlow Log cÚfigu¿tiÚ oÆy†og ev’t th©‡» slow”hª you¸cÚfigu»d†©’cy mÚ™Üh»shŞd. PËa£ u£ 'CONFIG SET slowlog-log-¦ow”-thª %Îu'.\n", ()
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
*1000);

411 ià(
advi£_¦owlog_š¥eù
) {

412 
»pÜt
 = 
	`sdsÿt
(report,"- Check your Slow Logo understand what‡rehe commands you‡re„unning which‡reoo slowoƒxecute. Please check http://redis.io/commands/slowlog for more information.\n");

416 ià(
advi£_scheduËr
) {

417 
»pÜt
 = 
	`sdsÿt
(report,"- The system is slowoƒxecute Redis code…aths‚ot containing system calls. This usually meanshe system does‚ot…rovide Redis CPUimeo„un for†ong…eriods. You shouldryo:\n"

426 ià(
advi£_loÿl_disk
) {

427 
»pÜt
 = 
	`sdsÿt
(report,"- It is strongly‡dvisedo use†ocal disks for…ersistence,ƒspecially if you‡re using AOF. Remote disks…rovided by…latform-as-a-service…roviders‡re knowno be slow.\n");

430 ià(
advi£_ssd
) {

431 
»pÜt
 = 
	`sdsÿt
(report,"- SSD disks‡re‡bleo„educe fsync†atency,‡ndotalime‚eeded for snapshotting‡nd AOF†og„ewriting (resulting in smaller memory usage‡nd smaller final AOF„ewrite buffer flushes). Withƒxtremely high write†oad SSD disks can be‡ good option. However Redis should…erform„easonably with high†oad using‚ormal disks. Usehis‡dvice‡s‡†ast„esort.\n");

434 ià(
advi£_d©a_wr™eback
) {

435 
»pÜt
 = 
	`sdsÿt
(report,"- Mountingƒxt3/4 filesystems with data=writeback can…rovide‡…erformance boost comparedo data=ordered, howeverhis mode of operation…rovides†ess guarantees,‡nd sometimes it can happenhat‡fter‡ hard crashhe AOF file will have‡n half-written command‡theƒnd‡nd will„equireo be„epaired before Redis„estarts.\n");

438 ià(
advi£_disk_cÚ‹ÁiÚ
) {

439 
»pÜt
 = 
	`sdsÿt
(report,"- Tryo†owerhe disk contention. This is often caused by other disk intensive…rocesses„unning inhe same computer (including other Redis instances).\n");

442 ià(
advi£_no_­³ndfsync
) {

443 
»pÜt
 = 
	`sdsÿt
(report,"- Assuming fromhe…oint of view of data safetyhis is viable in yourƒnvironment, you couldryoƒnablehe 'no-appendfsync-on-rewrite' option, sohat fsync will‚ot be…erformed whilehere is‡ child„ewritinghe AOF file or…roducing‡n RDB file (the moment wherehere is high disk contention).\n");

446 ià(
advi£_»Ïx_fsync_pŞicy
 && 
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

447 
»pÜt
 = 
	`sdsÿt
(report,"- Your fsync…olicy is seto 'always'. It is very hardo get good…erformances with such‡ setup, if…ossibleryo„elaxhe fsync…olicyo 'onesec'.\n");

450 ià(
advi£_wr™e_lßd_šfo
) {

451 
»pÜt
 = 
	`sdsÿt
(report,"- Latency duringhe AOF‡tomic„ename operation or whenhe final difference is flushedohe AOF file‡theƒnd ofhe„ewrite, sometimes is caused by very high write†oad, causinghe AOF buffero get very†arge. If…ossibleryo send†ess commandso‡ccomplishhe same work, or use Lua scriptso group multiple operations into‡ single EVALSHA call.\n");

454 ià(
advi£_hz
 && 
£rv”
.
hz
 < 100) {

455 
»pÜt
 = 
	`sdsÿt
(report,"- In ordero makehe Redis keysƒxpiring…rocess more incremental,ryo sethe 'hz' configuration…arametero 100 using 'CONFIG SET hz 100'.\n");

458 ià(
advi£_Ïrge_objeùs
) {

459 
»pÜt
 = 
	`sdsÿt
(report,"- Deleting,ƒxpiring orƒvicting (because of maxmemory…olicy)†arge objects is‡ blocking operation. If you have very†arge objectshat‡re often deleted,ƒxpired, orƒvicted,ryo fragmenthose objects into multiple smaller objects.\n");

462 ià(
advi£_mass_eviùiÚ
) {

463 
»pÜt
 = 
	`sdsÿt
(report,"- Sudden changesohe 'maxmemory' setting via 'CONFIG SET', or‡llocation of†arge objects via sets or sorted sets intersections, STORE option of SORT, Redis Cluster†arge keys migrations (RESTORE command), may create sudden memory…ressure forcinghe servero blockryingoƒvict keys. \n");

466 ià(
advi£_di§bË_thp
) {

467 
»pÜt
 = 
	`sdsÿt
(report,"- I detected‡‚on zero‡mount of‡nonymous huge…ages used by your…rocess. This creates very serious†atencyƒvents in different conditions,ƒspecially when Redis is…ersisting on disk. To disable THP support usehe command 'echo‚ever > /sys/kernel/mm/transparent_hugepage/enabled', make sureo‡lso‡dd it into /etc/rc.local sohathe command will beƒxecuted‡gain‡fter‡„eboot. Notehatƒven if you have‡lready disabled THP, you still‚eedo„estarthe Redis…rocesso get„id ofhe huge…ages‡lready created.\n");

471  
»pÜt
;

472 
	}
}

478 
	$Ï‹ncyCommªdR•lyW™hSam¶es
(
ş›Á
 *
c
, 
Ï‹ncyTimeS”›s
 *
ts
) {

479 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

480 
§m¶es
 = 0, 
j
;

482 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

483 
i
 = (
ts
->
idx
 + 
j
è% 
LATENCY_TS_LEN
;

485 ià(
ts
->
§m¶es
[
i
].
time
 == 0) ;

486 
	`addR•lyMuÉiBulkL’
(
c
,2);

487 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
i
].
time
);

488 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
i
].
Ï‹ncy
);

489 
§m¶es
++;

491 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
§m¶es
);

492 
	}
}

496 
	$Ï‹ncyCommªdR•lyW™hL©e¡Ev’ts
(
ş›Á
 *
c
) {

497 
diùI‹¿tÜ
 *
di
;

498 
diùEÁry
 *
de
;

500 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
£rv”
.
Ï‹ncy_ev’ts
));

501 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

502 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

503 *
ev’t
 = 
	`diùG‘Key
(
de
);

504 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùG‘V®
(
de
);

505 
Ï¡
 = (
ts
->
idx
 + 
LATENCY_TS_LEN
 - 1) % LATENCY_TS_LEN;

507 
	`addR•lyMuÉiBulkL’
(
c
,4);

508 
	`addR•lyBulkCSŒšg
(
c
,
ev’t
);

509 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
Ï¡
].
time
);

510 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
Ï¡
].
Ï‹ncy
);

511 
	`addR•lyLÚgLÚg
(
c
,
ts
->
max
);

513 
	`diùR–—£I‹¿tÜ
(
di
);

514 
	}
}

516 
	#LATENCY_GRAPH_COLS
 80

	)

517 
sds
 
	$Ï‹ncyCommªdG’S·rk–še
(*
ev’t
, 
Ï‹ncyTimeS”›s
 *
ts
) {

518 
j
;

519 
£qu’û
 *
£q
 = 
	`ü—‹S·rklšeSequ’û
();

520 
sds
 
g¿ph
 = 
	`sd£m±y
();

521 
ušt32_t
 
mš
 = 0, 
max
 = 0;

523 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

524 
i
 = (
ts
->
idx
 + 
j
è% 
LATENCY_TS_LEN
;

525 
–­£d
;

526 
buf
[64];

528 ià(
ts
->
§m¶es
[
i
].
time
 == 0) ;

530 ià(
£q
->
Ëngth
 == 0) {

531 
mš
 = 
max
 = 
ts
->
§m¶es
[
i
].
Ï‹ncy
;

533 ià(
ts
->
§m¶es
[
i
].
Ï‹ncy
 > 
max
) max =s->samples[i].latency;

534 ià(
ts
->
§m¶es
[
i
].
Ï‹ncy
 < 
mš
) min =s->samples[i].latency;

538 
–­£d
 = 
	`time
(
NULL
è- 
ts
->
§m¶es
[
i
].
time
;

539 ià(
–­£d
 < 60)

540 
	`¢´štf
(
buf
,(buf),"%ds",
–­£d
);

541 ià(
–­£d
 < 3600)

542 
	`¢´štf
(
buf
,(buf),"%dm",
–­£d
/60);

543 ià(
–­£d
 < 3600*24)

544 
	`¢´štf
(
buf
,(buf),"%dh",
–­£d
/3600);

546 
	`¢´štf
(
buf
,(buf),"%dd",
–­£d
/(3600*24));

547 
	`¥¬klšeSequ’ûAddSam¶e
(
£q
,
ts
->
§m¶es
[
i
].
Ï‹ncy
,
buf
);

550 
g¿ph
 = 
	`sdsÿrštf
(graph,

551 "% - high %lu ms,†ow %lu m ×Îimhigh %lu ms)\n", 
ev’t
,

552 (è
max
, (è
mš
, (è
ts
->max);

553 
j
 = 0; j < 
LATENCY_GRAPH_COLS
; j++)

554 
g¿ph
 = 
	`sdsÿ’
(graph,"-",1);

555 
g¿ph
 = 
	`sdsÿ’
(graph,"\n",1);

556 
g¿ph
 = 
	`¥¬klšeR’d”
(g¿ph,
£q
,
LATENCY_GRAPH_COLS
,4,
SPARKLINE_FILL
);

557 
	`ä“S·rklšeSequ’û
(
£q
);

558  
g¿ph
;

559 
	}
}

568 
	$Ï‹ncyCommªd
(
ş›Á
 *
c
) {

569 
Ï‹ncyTimeS”›s
 *
ts
;

571 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"hi¡Üy"è&& c->
¬gc
 == 3) {

573 
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
c
->
¬gv
[2]->
±r
);

574 ià(
ts
 =ğ
NULL
) {

575 
	`addR•lyMuÉiBulkL’
(
c
,0);

577 
	`Ï‹ncyCommªdR•lyW™hSam¶es
(
c
,
ts
);

579 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g¿ph"è&& c->
¬gc
 == 3) {

581 
sds
 
g¿ph
;

582 
diùEÁry
 *
de
;

583 *
ev’t
;

585 
de
 = 
	`diùFšd
(
£rv”
.
Ï‹ncy_ev’ts
,
c
->
¬gv
[2]->
±r
);

586 ià(
de
 =ğ
NULL
è
nod©«¼
;

587 
ts
 = 
	`diùG‘V®
(
de
);

588 
ev’t
 = 
	`diùG‘Key
(
de
);

590 
g¿ph
 = 
	`Ï‹ncyCommªdG’S·rk–še
(
ev’t
,
ts
);

591 
	`addR•lyBulkCSŒšg
(
c
,
g¿ph
);

592 
	`sdsä“
(
g¿ph
);

593 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"Ï‹¡"è&& c->
¬gc
 == 2) {

595 
	`Ï‹ncyCommªdR•lyW™hL©e¡Ev’ts
(
c
);

596 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"doùÜ"è&& c->
¬gc
 == 2) {

598 
sds
 
»pÜt
 = 
	`ü—‹L©’cyR•Üt
();

600 
	`addR•lyBulkCBufãr
(
c
,
»pÜt
,
	`sd¦’
(report));

601 
	`sdsä“
(
»pÜt
);

602 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»£t"è&& c->
¬gc
 >= 2) {

604 ià(
c
->
¬gc
 == 2) {

605 
	`addR•lyLÚgLÚg
(
c
,
	`Ï‹ncyRe£tEv’t
(
NULL
));

607 
j
, 
»£ts
 = 0;

609 
j
 = 2; j < 
c
->
¬gc
; j++)

610 
»£ts
 +ğ
	`Ï‹ncyRe£tEv’t
(
c
->
¬gv
[
j
]->
±r
);

611 
	`addR•lyLÚgLÚg
(
c
,
»£ts
);

614 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

618 
nod©«¼
:

621 
	`addR•lyE¼ÜFÜm©
(
c
,

622 "NØ§m¶e avaabË fÜƒv’ˆ'%s'", (*è
c
->
¬gv
[2]->
±r
);

623 
	}
}

	@src/latency.h

34 #iâdeà
__LATENCY_H


35 
	#__LATENCY_H


	)

37 
	#LATENCY_TS_LEN
 160

	)

41 
	sÏ‹ncySam¶e
 {

42 
št32_t
 
	mtime
;

43 
ušt32_t
 
	mÏ‹ncy
;

47 
	sÏ‹ncyTimeS”›s
 {

48 
	midx
;

49 
ušt32_t
 
	mmax
;

50 
Ï‹ncySam¶e
 
	m§m¶es
[
LATENCY_TS_LEN
];

54 
	sÏ‹ncySts
 {

55 
ušt32_t
 
	m®l_time_high
;

56 
ušt32_t
 
	mavg
;

57 
ušt32_t
 
	mmš
;

58 
ušt32_t
 
	mmax
;

59 
ušt32_t
 
	mmad
;

60 
ušt32_t
 
	m§m¶es
;

61 
time_t
 
	m³riod
;

64 
Ï‹ncyMÚ™ÜIn™
();

65 
Ï‹ncyAddSam¶e
(*
ev’t
, 
m¡ime_t
 
Ï‹ncy
);

66 
THPIsEÇbËd
();

71 
	#Ï‹ncyS¹MÚ™Ü
(
v¬
èià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) { \

72 
v¬
 = 
	`m¡ime
(); \

74 
v¬
 = 0; \

75 }

	)

79 
	#Ï‹ncyEndMÚ™Ü
(
v¬
èià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) { \

80 
v¬
 = 
	`m¡ime
() - var; \

81 }

	)

84 
	#Ï‹ncyAddSam¶eIfN“ded
(
ev’t
,
v¬
) \

85 ià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 && \

86 (
v¬
è>ğ
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) \

87 
	`Ï‹ncyAddSam¶e
((
ev’t
),(
v¬
));

	)

90 
	#Ï‹ncyRemoveNe¡edEv’t
(
ev’t_v¬
,
Ã¡ed_v¬
) \

91 
ev’t_v¬
 +ğ
Ã¡ed_v¬
;

	)

	@src/lazyfree.c

1 
	~"£rv”.h
"

2 
	~"bio.h
"

3 
	~"©omicv¬.h
"

4 
	~"şu¡”.h
"

6 
size_t
 
	gÏzyä“_objeùs
 = 0;

7 
±h»ad_mu‹x_t
 
	gÏzyä“_objeùs_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

10 
size_t
 
	$Ïzyä“G‘P’dšgObjeùsCouÁ
() {

11 
size_t
 
aux
;

12 
	`©omicG‘
(
Ïzyä“_objeùs
,
aux
);

13  
aux
;

14 
	}
}

31 
size_t
 
	$Ïzyä“G‘F»eEffÜt
(
robj
 *
obj
) {

32 ià(
obj
->
ty³
 =ğ
OBJ_LIST
) {

33 
quickli¡
 *
ql
 = 
obj
->
±r
;

34  
ql
->
Ën
;

35 } ià(
obj
->
ty³
 =ğ
OBJ_SET
 && obj->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

36 
diù
 *
ht
 = 
obj
->
±r
;

37  
	`diùSize
(
ht
);

38 } ià(
obj
->
ty³
 =ğ
OBJ_ZSET
 && obj->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
){

39 
z£t
 *
zs
 = 
obj
->
±r
;

40  
zs
->
z¦
->
Ëngth
;

41 } ià(
obj
->
ty³
 =ğ
OBJ_HASH
 && obj->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

42 
diù
 *
ht
 = 
obj
->
±r
;

43  
	`diùSize
(
ht
);

47 
	}
}

53 
	#LAZYFREE_THRESHOLD
 64

	)

54 
	$dbAsyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

57 ià(
	`diùSize
(
db
->
expœes
è> 0è
	`diùD–‘e
(db->expœes,
key
->
±r
);

62 
diùEÁry
 *
de
 = 
	`diùUÆšk
(
db
->
diù
,
key
->
±r
);

63 ià(
de
) {

64 
robj
 *
v®
 = 
	`diùG‘V®
(
de
);

65 
size_t
 
ä“_effÜt
 = 
	`Ïzyä“G‘F»eEffÜt
(
v®
);

75 ià(
ä“_effÜt
 > 
LAZYFREE_THRESHOLD
 && 
v®
->
»fcouÁ
 == 1) {

76 
	`©omicInü
(
Ïzyä“_objeùs
,1);

77 
	`bioC»©eBackgroundJob
(
BIO_LAZY_FREE
,
v®
,
NULL
,NULL);

78 
	`diùS‘V®
(
db
->
diù
,
de
,
NULL
);

84 ià(
de
) {

85 
	`diùF»eUÆškedEÁry
(
db
->
diù
,
de
);

86 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyD–
(
key
);

91 
	}
}

96 
	$em±yDbAsync
(
»disDb
 *
db
) {

97 
diù
 *
Şdht1
 = 
db
->diù, *
Şdht2
 = db->
expœes
;

98 
db
->
diù
 = 
	`diùC»©e
(&
dbDiùTy³
,
NULL
);

99 
db
->
expœes
 = 
	`diùC»©e
(&
key±rDiùTy³
,
NULL
);

100 
	`©omicInü
(
Ïzyä“_objeùs
,
	`diùSize
(
Şdht1
));

101 
	`bioC»©eBackgroundJob
(
BIO_LAZY_FREE
,
NULL
,
Şdht1
,
Şdht2
);

102 
	}
}

106 
	$¦ÙToKeyFlushAsync
() {

107 
¿x
 *
Şd
 = 
£rv”
.
şu¡”
->
¦Ùs_to_keys
;

109 
£rv”
.
şu¡”
->
¦Ùs_to_keys
 = 
	`¿xNew
();

110 
	`mem£t
(
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
,0,

111 (
£rv”
.
şu¡”
->
¦Ùs_keys_couÁ
));

112 
	`©omicInü
(
Ïzyä“_objeùs
,
Şd
->
num–e
);

113 
	`bioC»©eBackgroundJob
(
BIO_LAZY_FREE
,
NULL
,NULL,
Şd
);

114 
	}
}

118 
	$Ïzyä“F»eObjeùFromBioTh»ad
(
robj
 *
o
) {

119 
	`deüRefCouÁ
(
o
);

120 
	`©omicDeü
(
Ïzyä“_objeùs
,1);

121 
	}
}

128 
	$Ïzyä“F»eD©aba£FromBioTh»ad
(
diù
 *
ht1
, diù *
ht2
) {

129 
size_t
 
numkeys
 = 
	`diùSize
(
ht1
);

130 
	`diùR–—£
(
ht1
);

131 
	`diùR–—£
(
ht2
);

132 
	`©omicDeü
(
Ïzyä“_objeùs
,
numkeys
);

133 
	}
}

137 
	$Ïzyä“F»eSlÙsM­FromBioTh»ad
(
¿x
 *
¹
) {

138 
size_t
 
Ën
 = 
¹
->
num–e
;

139 
	`¿xF»e
(
¹
);

140 
	`©omicDeü
(
Ïzyä“_objeùs
,
Ën
);

141 
	}
}

	@src/lzf.h

37 #iâdeà
LZF_H


38 
	#LZF_H


	)

49 
	#LZF_VERSION
 0x0105

	)

77 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

78 *
out_d©a
, 
out_Ën
);

96 
lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

97 *
out_d©a
, 
out_Ën
);

	@src/lzfP.h

37 #iâdeà
LZFP_h


38 
	#LZFP_h


	)

40 
	#STANDALONE
 1

	)

42 #iâdeà
STANDALONE


43 
	~"lzf.h
"

54 #iâdeà
HLOG


55 
	#HLOG
 16

	)

63 #iâdeà
VERY_FAST


64 
	#VERY_FAST
 1

	)

74 #iâdeà
ULTRA_FAST


75 
	#ULTRA_FAST
 0

	)

81 #iâdeà
STRICT_ALIGN


82 #ià!(
defšed
(
__i386
è|| defšed (
__amd64
))

83 
	#STRICT_ALIGN
 1

	)

85 
	#STRICT_ALIGN
 0

	)

94 #iâdeà
INIT_HTAB


95 
	#INIT_HTAB
 0

	)

103 #iâdeà
AVOID_ERRNO


104 
	#AVOID_ERRNO
 0

	)

112 #iâdeà
LZF_STATE_ARG


113 
	#LZF_STATE_ARG
 0

	)

124 #iâdeà
CHECK_INPUT


125 
	#CHECK_INPUT
 1

	)

138 #ifdeà
__ılu¥lus


139 
	~<c¡ršg
>

140 
	~<şim™s
>

141 
usšg
 
Çme¥aû
 
	g¡d
;

143 
	~<¡ršg.h
>

144 
	~<lim™s.h
>

147 #iâdeà
LZF_USE_OFFSETS


148 #ià
defšed
 (
WIN32
)

149 
	#LZF_USE_OFFSETS
 
	`defšed
(
_M_X64
)

	)

151 #ià
__ılu¥lus
 > 199711L

152 
	~<c¡dšt
>

154 
	~<¡dšt.h
>

156 
	#LZF_USE_OFFSETS
 (
UINTPTR_MAX
 > 0xffffffffU)

	)

160 
	tu8
;

162 #ià
LZF_USE_OFFSETS


163 
	#LZF_HSLOT_BIAS
 ((cÚ¡ 
u8
 *)
š_d©a
)

	)

164 
	tLZF_HSLOT
;

166 
	#LZF_HSLOT_BIAS
 0

	)

167 cÚ¡ 
	tu8
 *
	tLZF_HSLOT
;

170 
LZF_HSLOT
 
	tLZF_STATE
[1 << (
HLOG
)];

172 #ià!
STRICT_ALIGN


174 #ià
USHRT_MAX
 == 65535

175 
	tu16
;

176 #–ià
UINT_MAX
 == 65535

177 
	tu16
;

179 #undeà
STRICT_ALIGN


180 
	#STRICT_ALIGN
 1

	)

184 #ià
ULTRA_FAST


185 #undeà
VERY_FAST


	@src/lzf_c.c

37 
	~"lzfP.h
"

39 
	#HSIZE
 (1 << (
HLOG
))

	)

47 #iâdeà
FRST


48 
	#FRST
(
p
è((Õ[0]è<< 8è|…[1])

	)

49 
	#NEXT
(
v
,
p
è(((vè<< 8è|…[2])

	)

50 #ià
ULTRA_FAST


51 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h ) & (
HSIZE
 - 1))

	)

52 #–ià
VERY_FAST


53 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

55 
	#IDX
(
h
è((((h ^ (h << 5)è>> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

69 
	#FRST
(
p
èÕ[0] << 5è^…[1]

	)

70 
	#NEXT
(
v
,
p
è((vè<< 5è^…[2]

	)

71 
	#IDX
(
h
è((hè& (
HSIZE
 - 1))

	)

74 
	#MAX_LIT
 (1 << 5)

	)

75 
	#MAX_OFF
 (1 << 13)

	)

76 
	#MAX_REF
 ((1 << 8è+ (1 << 3))

	)

78 #ià
__GNUC__
 >= 3

79 
	#ex³ù
(
ex´
,
v®ue
è
	`__butš_ex³ù
 (Óx´),(v®ue))

	)

80 
	#šlše
 
šlše


	)

82 
	#ex³ù
(
ex´
,
v®ue
èÓx´)

	)

83 
	#šlše
 

	)

86 
	#ex³ù_çl£
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 0)

	)

87 
	#ex³ù_Œue
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 1)

	)

99 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

100 *
out_d©a
, 
out_Ën


101 #ià
LZF_STATE_ARG


102 , 
LZF_STATE
 
hb


106 #ià!
LZF_STATE_ARG


107 
LZF_STATE
 
	ghb
;

109 cÚ¡ 
u8
 *
	g
 = (cÚ¡ u8 *)
š_d©a
;

110 
u8
 *
	gİ
 = (u8 *)
out_d©a
;

111 cÚ¡ 
u8
 *
	gš_’d
 = 

 + 
š_Ën
;

112 
u8
 *
	gout_’d
 = 
İ
 + 
out_Ën
;

113 cÚ¡ 
u8
 *
	g»f
;

122 #ià
defšed
 (
WIN32
è&& defšed (
_M_X64
)

123 
_št64
 
	goff
;

125 
	goff
;

127 
	ghv®
;

128 
	gl™
;

130 ià(!
	gš_Ën
 || !
	gout_Ën
)

133 #ià
INIT_HTAB


134 
mem£t
 (
hb
, 0,  (htab));

137 
	gl™
 = 0; 
	gİ
++;

139 
	ghv®
 = 
FRST
 (

);

140 
	g
 < 
	gš_’d
 - 2)

142 
LZF_HSLOT
 *
	gh¦Ù
;

144 
	ghv®
 = 
NEXT
 (
hv®
, 

);

145 
	gh¦Ù
 = 
hb
 + 
IDX
 (
hv®
);

146 
	g»f
 = *
h¦Ù
 + 
LZF_HSLOT_BIAS
; *
	gh¦Ù
 = 

 - LZF_HSLOT_BIAS;

149 #ià
INIT_HTAB


150 && 
	g»f
 < 
	g


152 && (
	goff
 = 

 - 
»f
 - 1è< 
MAX_OFF


153 && 
»f
 > (
u8
 *)
š_d©a


154 && 
»f
[2] =ğ

[2]

155 #ià
STRICT_ALIGN


156 && ((
»f
[1] << 8è|„ef[0]è=ğ((

[1] << 8) | ip[0])

158 && *(
u16
 *)
»f
 =ğ*(u16 *)



163 
Ën
 = 2;

164 
	gmaxËn
 = 
š_’d
 - 

 - 
Ën
;

165 
	gmaxËn
 = 
maxËn
 > 
MAX_REF
 ? MAX_REF : maxlen;

167 ià(
ex³ù_çl£
 (
İ
 + 3 + 1 >ğ
out_’d
))

168 ià(
İ
 - !
l™
 + 3 + 1 >ğ
out_’d
)

171 
	gİ
 [- 
l™
 - 1] =†it - 1;

172 
	gİ
 -ğ!
l™
;

176 ià(
ex³ù_Œue
 (
maxËn
 > 16))

178 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

179 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

180 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

181 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

183 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

184 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

185 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

186 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

188 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

189 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

190 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

191 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

193 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

194 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

195 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

196 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

200 
	gËn
++;

201 
	gËn
 < 
	gmaxËn
 && 
	g»f
[
Ën
] =ğ

[len]);

206 
	gËn
 -= 2;

207 
	g
++;

209 ià(
	gËn
 < 7)

211 *
	gİ
++ = (
off
 >> 8è+ (
Ën
 << 5);

215 *
	gİ
++ = (
off
 >> 8) + ( 7 << 5);

216 *
	gİ
++ = 
Ën
 - 7;

219 *
	gİ
++ = 
off
;

221 
	gl™
 = 0; 
	gİ
++;

223 
	g
 +ğ
Ën
 + 1;

225 ià(
ex³ù_çl£
 (

 >ğ
š_’d
 - 2))

228 #ià
ULTRA_FAST
 || 
VERY_FAST


229 --
	g
;

230 #ià
VERY_FAST
 && !
ULTRA_FAST


231 --
	g
;

233 
	ghv®
 = 
FRST
 (

);

235 
	ghv®
 = 
NEXT
 (
hv®
, 

);

236 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

237 
	g
++;

239 #ià
VERY_FAST
 && !
ULTRA_FAST


240 
	ghv®
 = 
NEXT
 (
hv®
, 

);

241 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

242 
	g
++;

245 
	g
 -ğ
Ën
 + 1;

249 
	ghv®
 = 
NEXT
 (
hv®
, 

);

250 
	ghb
[
IDX
 (
hv®
)] = 

 - 
LZF_HSLOT_BIAS
;

251 
	g
++;

253 
	gËn
--);

259 ià(
ex³ù_çl£
 (
İ
 >ğ
out_’d
))

262 
	gl™
++; *
	gİ
++ = *

++;

264 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

266 
İ
 [- 
l™
 - 1] =†it - 1;

267 
	gl™
 = 0; 
	gİ
++;

272 ià(
	gİ
 + 3 > 
	gout_’d
)

275 
	g
 < 
	gš_’d
)

277 
	gl™
++; *
	gİ
++ = *

++;

279 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

281 
İ
 [- 
l™
 - 1] =†it - 1;

282 
	gl™
 = 0; 
	gİ
++;

286 
	gİ
 [- 
l™
 - 1] =†it - 1;

287 
	gİ
 -ğ!
l™
;

289  
	gİ
 - (
	gu8
 *)
	gout_d©a
;

	@src/lzf_d.c

37 
	~"lzfP.h
"

39 #ià
AVOID_ERRNO


40 
	#SET_ERRNO
(
n
)

	)

42 
	~<”ºo.h
>

43 
	#SET_ERRNO
(
n
è
”ºo
 = (n)

	)

46 #ià
USE_REP_MOVSB


47 #ià(
__i386
 || 
__amd64
è&& 
__GNUC__
 >= 3

48 
	#lzf_movsb
(
d¡
, 
¤c
, 
Ën
) \

49 
	`asm
 ("rep movsb" \

50 : "=D" (
d¡
), "=S" (
¤c
), "=c" (
Ën
) \

51 : "0" (
d¡
), "1" (
¤c
), "2" (
Ën
));

	)

56 
	$lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

57 *
out_d©a
, 
out_Ën
)

59 
u8
 cÚ¡ *

 = (cÚ¡ u8 *)
š_d©a
;

60 
u8
 *
İ
 = (u8 *)
out_d©a
;

61 
u8
 cÚ¡ *cÚ¡ 
š_’d
 = 

 + 
š_Ën
;

62 
u8
 *cÚ¡ 
out_’d
 = 
İ
 + 
out_Ën
;

66 
ù¾
 = *

++;

68 ià(
ù¾
 < (1 << 5))

70 
ù¾
++;

72 ià(
İ
 + 
ù¾
 > 
out_’d
)

74 
	`SET_ERRNO
 (
E2BIG
);

78 #ià
CHECK_INPUT


79 ià(

 + 
ù¾
 > 
š_’d
)

81 
	`SET_ERRNO
 (
EINVAL
);

86 #ifdeà
lzf_movsb


87 
	`lzf_movsb
 (
İ
, 

, 
ù¾
);

89 
ù¾
)

91 32: *
İ
++ = *

++; 31: *op++ = *ip++; 30: *op++ = *ip++; 29: *op++ = *ip++;

92 28: *
İ
++ = *

++; 27: *op++ = *ip++; 26: *op++ = *ip++; 25: *op++ = *ip++;

93 24: *
İ
++ = *

++; 23: *op++ = *ip++; 22: *op++ = *ip++; 21: *op++ = *ip++;

94 20: *
İ
++ = *

++; 19: *op++ = *ip++; 18: *op++ = *ip++; 17: *op++ = *ip++;

95 16: *
İ
++ = *

++; 15: *op++ = *ip++; 14: *op++ = *ip++; 13: *op++ = *ip++;

96 12: *
İ
++ = *

++; 11: *op++ = *ip++; 10: *op++ = *ip++; 9: *op++ = *ip++;

97 8: *
İ
++ = *

++; 7: *op++ = *ip++; 6: *op++ = *ip++; 5: *op++ = *ip++;

98 4: *
İ
++ = *

++; 3: *op++ = *ip++; 2: *op++ = *ip++; 1: *op++ = *ip++;

104 
Ën
 = 
ù¾
 >> 5;

106 
u8
 *
»f
 = 
İ
 - ((
ù¾
 & 0x1f) << 8) - 1;

108 #ià
CHECK_INPUT


109 ià(

 >ğ
š_’d
)

111 
	`SET_ERRNO
 (
EINVAL
);

115 ià(
Ën
 == 7)

117 
Ën
 +ğ*

++;

118 #ià
CHECK_INPUT


119 ià(

 >ğ
š_’d
)

121 
	`SET_ERRNO
 (
EINVAL
);

127 
»f
 -ğ*

++;

129 ià(
İ
 + 
Ën
 + 2 > 
out_’d
)

131 
	`SET_ERRNO
 (
E2BIG
);

135 ià(
»f
 < (
u8
 *)
out_d©a
)

137 
	`SET_ERRNO
 (
EINVAL
);

141 #ifdeà
lzf_movsb


142 
Ën
 += 2;

143 
	`lzf_movsb
 (
İ
, 
»f
, 
Ën
);

145 
Ën
)

148 
Ën
 += 2;

150 ià(
İ
 >ğ
»f
 + 
Ën
)

153 
	`memıy
 (
İ
, 
»f
, 
Ën
);

154 
İ
 +ğ
Ën
;

160 *
İ
++ = *
»f
++;

161 --
Ën
);

166 9: *
İ
++ = *
»f
++;

167 8: *
İ
++ = *
»f
++;

168 7: *
İ
++ = *
»f
++;

169 6: *
İ
++ = *
»f
++;

170 5: *
İ
++ = *
»f
++;

171 4: *
İ
++ = *
»f
++;

172 3: *
İ
++ = *
»f
++;

173 2: *
İ
++ = *
»f
++;

174 1: *
İ
++ = *
»f
++;

175 0: *
İ
++ = *
»f
++;

176 *
İ
++ = *
»f
++;

181 

 < 
š_’d
);

183  
İ
 - (
u8
 *)
out_d©a
;

184 
	}
}

	@src/memtest.c

29 
	~<¡dšt.h
>

30 
	~<¡dlib.h
>

31 
	~<¡dio.h
>

32 
	~<¡ršg.h
>

33 
	~<as£¹.h
>

34 
	~<lim™s.h
>

35 
	~<”ºo.h
>

36 
	~<‹rmios.h
>

37 
	~<sys/ioùl.h
>

38 #ià
defšed
(
__sun
)

39 
	~<¡rİts.h
>

41 
	~"cÚfig.h
"

43 #ià(
ULONG_MAX
 == 4294967295UL)

44 
	#MEMTEST_32BIT


	)

45 #–ià(
ULONG_MAX
 == 18446744073709551615ULL)

46 
	#MEMTEST_64BIT


	)

51 #ifdeà
MEMTEST_32BIT


52 
	#ULONG_ONEZERO
 0x¯¯¯¯UL

	)

53 
	#ULONG_ZEROONE
 0x55555555UL

	)

55 
	#ULONG_ONEZERO
 0x¯¯¯¯¯¯¯¯UL

	)

56 
	#ULONG_ZEROONE
 0x5555555555555555UL

	)

59 
wšsize
 
	gws
;

60 
size_t
 
	g´og»ss_´š‹d
;

61 
size_t
 
	g´og»ss_fuÎ
;

63 
	$mem‹¡_´og»ss_¡¬t
(*
t™Ë
, 
·ss
) {

64 
j
;

66 
	`´štf
("\x1b[H\x1b[2J");

68 
j
 = 0; j < 
ws
.
ws_cŞ
*(ws.
ws_row
-2); j++è
	`´štf
(".");

69 
	`´štf
("Please keepheest„unning several minutes…er GB of memory.\n");

70 
	`´štf
("Also check http://www.memtest86.com/‡nd http://pyropus.ca/software/memtester/");

71 
	`´štf
("\x1b[H\x1b[2K");

72 
	`´štf
("% [%d]\n", 
t™Ë
, 
·ss
);

73 
´og»ss_´š‹d
 = 0;

74 
´og»ss_fuÎ
 = 
ws
.
ws_cŞ
*(ws.
ws_row
-3);

75 
	`fæush
(
¡dout
);

76 
	}
}

78 
	$mem‹¡_´og»ss_’d
() {

79 
	`´štf
("\x1b[H\x1b[2J");

80 
	}
}

82 
	$mem‹¡_´og»ss_¡•
(
size_t
 
cu¼
, size_ˆ
size
, 
c
) {

83 
size_t
 
ch¬s
 = (()
cu¼
*
´og»ss_fuÎ
)/
size
, 
j
;

85 
j
 = 0; j < 
ch¬s
-
´og»ss_´š‹d
; j++è
	`´štf
("%c",
c
);

86 
´og»ss_´š‹d
 = 
ch¬s
;

87 
	`fæush
(
¡dout
);

88 
	}
}

93 
	$mem‹¡_add»ssšg
(*
l
, 
size_t
 
by‹s
, 
š‹¿ùive
) {

94 
wÜds
 = 
by‹s
/();

95 
j
, *
p
;

98 
p
 = 
l
;

99 
j
 = 0; j < 
wÜds
; j++) {

100 *
p
 = ()p;

101 
p
++;

102 ià((
j
 & 0xffffè=ğ0 && 
š‹¿ùive
)

103 
	`mem‹¡_´og»ss_¡•
(
j
,
wÜds
*2,'A');

106 
p
 = 
l
;

107 
j
 = 0; j < 
wÜds
; j++) {

108 ià(*
p
 != ()p) {

109 ià(
š‹¿ùive
) {

110 
	`´štf
("\n*** MEMORY ADDRESSING ERROR: %p contains %lu\n",

111 (*è
p
, *p);

112 
	`ex™
(1);

116 
p
++;

117 ià((
j
 & 0xffffè=ğ0 && 
š‹¿ùive
)

118 
	`mem‹¡_´og»ss_¡•
(
j
+
wÜds
,words*2,'A');

121 
	}
}

131 
	#xÜshiá64¡¬_Ãxt
() do { \

132 
r£ed
 ^=„seed >> 12; \

133 
r£ed
 ^=„seed << 25; \

134 
r£ed
 ^=„seed >> 27; \

135 
rout
 = 
r£ed
 * 
	`UINT64_C
(2685821657736338717); \

136 } 0)

	)

138 
	$mem‹¡_fl_¿ndom
(*
l
, 
size_t
 
by‹s
, 
š‹¿ùive
) {

139 
¡•
 = 4096/();

140 
wÜds
 = 
by‹s
/()/2;

141 
iwÜds
 = 
wÜds
/
¡•
;

142 
off
, 
w
, *
l1
, *
l2
;

143 
ušt64_t
 
r£ed
 = 
	`UINT64_C
(0xd13133de9afdb566);

144 
ušt64_t
 
rout
 = 0;

146 
	`as£¹
((
by‹s
 & 4095) == 0);

147 
off
 = 0; ofà< 
¡•
; off++) {

148 
l1
 = 
l
+
off
;

149 
l2
 = 
l1
+
wÜds
;

150 
w
 = 0; w < 
iwÜds
; w++) {

151 
	`xÜshiá64¡¬_Ãxt
();

152 *
l1
 = *
l2
 = (è
rout
;

153 
l1
 +ğ
¡•
;

154 
l2
 +ğ
¡•
;

155 ià((
w
 & 0xffffè=ğ0 && 
š‹¿ùive
)

156 
	`mem‹¡_´og»ss_¡•
(
w
+
iwÜds
*
off
,
wÜds
,'R');

159 
	}
}

163 
	$mem‹¡_fl_v®ue
(*
l
, 
size_t
 
by‹s
, 
v1
,

164 
v2
, 
sym
, 
š‹¿ùive
)

166 
¡•
 = 4096/();

167 
wÜds
 = 
by‹s
/()/2;

168 
iwÜds
 = 
wÜds
/
¡•
;

169 
off
, 
w
, *
l1
, *
l2
, 
v
;

171 
	`as£¹
((
by‹s
 & 4095) == 0);

172 
off
 = 0; ofà< 
¡•
; off++) {

173 
l1
 = 
l
+
off
;

174 
l2
 = 
l1
+
wÜds
;

175 
v
 = (
off
 & 1è? 
v2
 : 
v1
;

176 
w
 = 0; w < 
iwÜds
; w++) {

177 #ifdeà
MEMTEST_32BIT


178 *
l1
 = *
l2
 = ((è
v
) |

179 (((è
v
) << 16);

181 *
l1
 = *
l2
 = ((è
v
) |

182 (((è
v
) << 16) |

183 (((è
v
) << 32) |

184 (((è
v
) << 48);

186 
l1
 +ğ
¡•
;

187 
l2
 +ğ
¡•
;

188 ià((
w
 & 0xffffè=ğ0 && 
š‹¿ùive
)

189 
	`mem‹¡_´og»ss_¡•
(
w
+
iwÜds
*
off
,
wÜds
,
sym
);

192 
	}
}

194 
	$mem‹¡_com·»
(*
l
, 
size_t
 
by‹s
, 
š‹¿ùive
) {

195 
wÜds
 = 
by‹s
/()/2;

196 
w
, *
l1
, *
l2
;

198 
	`as£¹
((
by‹s
 & 4095) == 0);

199 
l1
 = 
l
;

200 
l2
 = 
l1
+
wÜds
;

201 
w
 = 0; w < 
wÜds
; w++) {

202 ià(*
l1
 !ğ*
l2
) {

203 ià(
š‹¿ùive
) {

204 
	`´štf
("\n*** MEMORY ERROR DETECTED: %p != %p (%lu vs %lu)\n",

205 (*)
l1
, (*)
l2
, *l1, *l2);

206 
	`ex™
(1);

210 
l1
 ++;

211 
l2
 ++;

212 ià((
w
 & 0xffffè=ğ0 && 
š‹¿ùive
)

213 
	`mem‹¡_´og»ss_¡•
(
w
,
wÜds
,'=');

216 
	}
}

218 
	$mem‹¡_com·»_times
(*
m
, 
size_t
 
by‹s
, 
·ss
, 
times
,

219 
š‹¿ùive
)

221 
j
;

222 
”rÜs
 = 0;

224 
j
 = 0; j < 
times
; j++) {

225 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Com·»",
·ss
);

226 
”rÜs
 +ğ
	`mem‹¡_com·»
(
m
,
by‹s
,
š‹¿ùive
);

227 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

229  
”rÜs
;

230 
	}
}

237 
	$mem‹¡_‹¡
(*
m
, 
size_t
 
by‹s
, 
·s£s
, 
š‹¿ùive
) {

238 
·ss
 = 0;

239 
”rÜs
 = 0;

241 
·ss
 !ğ
·s£s
) {

242 
·ss
++;

244 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Add»ssšge¡",
·ss
);

245 
”rÜs
 +ğ
	`mem‹¡_add»ssšg
(
m
,
by‹s
,
š‹¿ùive
);

246 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

248 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Rªdom fl",
·ss
);

249 
	`mem‹¡_fl_¿ndom
(
m
,
by‹s
,
š‹¿ùive
);

250 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

251 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4,
š‹¿ùive
);

253 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("SŞid fl",
·ss
);

254 
	`mem‹¡_fl_v®ue
(
m
,
by‹s
,0,()-1,'S',
š‹¿ùive
);

255 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

256 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4,
š‹¿ùive
);

258 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_¡¬t
("Check”bßrd fl",
·ss
);

259 
	`mem‹¡_fl_v®ue
(
m
,
by‹s
,
ULONG_ONEZERO
,
ULONG_ZEROONE
,'C',
š‹¿ùive
);

260 ià(
š‹¿ùive
è
	`mem‹¡_´og»ss_’d
();

261 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4,
š‹¿ùive
);

263  
”rÜs
;

264 
	}
}

275 
	#MEMTEST_BACKUP_WORDS
 (1024*(1024/()))

	)

279 
	#MEMTEST_DECACHE_SIZE
 (1024*8)

	)

280 
	$mem‹¡_´e£rvšg_‹¡
(*
m
, 
size_t
 
by‹s
, 
·s£s
) {

281 
backup
[
MEMTEST_BACKUP_WORDS
];

282 *
p
 = 
m
;

283 *
’d
 = (*è(((*)
m
)+(
by‹s
-
MEMTEST_DECACHE_SIZE
));

284 
size_t
 
Ëá
 = 
by‹s
;

285 
”rÜs
 = 0;

287 ià(
by‹s
 & 4095)  0;

288 ià(
by‹s
 < 4096*2)  0;

290 
Ëá
) {

294 ià(
Ëá
 == 4096) {

295 
Ëá
 += 4096;

296 
p
 -= 4096/();

299 
·ss
 = 0;

300 
size_t
 
Ën
 = (
Ëá
 > (
backup
)) ? (backup) :†eft;

303 ià(
Ën
/4096 % 2)†en -= 4096;

305 
	`memıy
(
backup
,
p
,
Ën
);

306 
·ss
 !ğ
·s£s
) {

307 
·ss
++;

308 
”rÜs
 +ğ
	`mem‹¡_add»ssšg
(
p
,
Ën
,0);

309 
	`mem‹¡_fl_¿ndom
(
p
,
Ën
,0);

310 ià(
by‹s
 >ğ
MEMTEST_DECACHE_SIZE
) {

311 
	`mem‹¡_com·»_times
(
m
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

312 
	`mem‹¡_com·»_times
(
’d
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

314 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
p
,
Ën
,
·ss
,4,0);

315 
	`mem‹¡_fl_v®ue
(
p
,
Ën
,0,()-1,'S',0);

316 ià(
by‹s
 >ğ
MEMTEST_DECACHE_SIZE
) {

317 
	`mem‹¡_com·»_times
(
m
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

318 
	`mem‹¡_com·»_times
(
’d
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

320 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
p
,
Ën
,
·ss
,4,0);

321 
	`mem‹¡_fl_v®ue
(
p
,
Ën
,
ULONG_ONEZERO
,
ULONG_ZEROONE
,'C',0);

322 ià(
by‹s
 >ğ
MEMTEST_DECACHE_SIZE
) {

323 
	`mem‹¡_com·»_times
(
m
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

324 
	`mem‹¡_com·»_times
(
’d
,
MEMTEST_DECACHE_SIZE
,
·ss
,1,0);

326 
”rÜs
 +ğ
	`mem‹¡_com·»_times
(
p
,
Ën
,
·ss
,4,0);

328 
	`memıy
(
p
,
backup
,
Ën
);

329 
Ëá
 -ğ
Ën
;

330 
p
 +ğ
Ën
/();

332  
”rÜs
;

333 
	}
}

336 
	$mem‹¡_®loc_ªd_‹¡
(
size_t
 
megaby‹s
, 
·s£s
) {

337 
size_t
 
by‹s
 = 
megaby‹s
*1024*1024;

338 *
m
 = 
	`m®loc
(
by‹s
);

340 ià(
m
 =ğ
NULL
) {

341 
	`årštf
(
¡d”r
,"Unableo‡llocate %zu megabytes: %s",

342 
megaby‹s
, 
	`¡»¼Ü
(
”ºo
));

343 
	`ex™
(1);

345 
	`mem‹¡_‹¡
(
m
,
by‹s
,
·s£s
,1);

346 
	`ä“
(
m
);

347 
	}
}

349 
	$mem‹¡
(
size_t
 
megaby‹s
, 
·s£s
) {

350 ià(
	`ioùl
(1, 
TIOCGWINSZ
, &
ws
) == -1) {

351 
ws
.
ws_cŞ
 = 80;

352 
ws
.
ws_row
 = 20;

354 
	`mem‹¡_®loc_ªd_‹¡
(
megaby‹s
,
·s£s
);

355 
	`´štf
("\nYour memory…assedhisest.\n");

356 
	`´štf
("Please if you‡re still in doubt usehe followingwoools:\n");

357 
	`´štf
("1) memtest86: http://www.memtest86.com/\n");

358 
	`´štf
("2) memtester: http://pyropus.ca/software/memtester/\n");

359 
	`ex™
(0);

360 
	}
}

	@src/module.c

30 
	~"£rv”.h
"

31 
	~"şu¡”.h
"

32 
	~<dlfú.h
>

34 
	#REDISMODULE_CORE
 1

	)

35 
	~"»dismoduË.h
"

44 
	sRedisModuË
 {

45 *
	mhªdË
;

46 *
	mÇme
;

47 
	mv”
;

48 
	m­iv”
;

49 
li¡
 *
	mty³s
;

51 
RedisModuË
 
	tRedisModuË
;

53 
diù
 *
	gmoduËs
;

57 
	sAutoMemEÁry
 {

58 *
	m±r
;

59 
	mty³
;

63 
	#REDISMODULE_AM_KEY
 0

	)

64 
	#REDISMODULE_AM_STRING
 1

	)

65 
	#REDISMODULE_AM_REPLY
 2

	)

66 
	#REDISMODULE_AM_FREED
 3

	)

81 
	#REDISMODULE_POOL_ALLOC_MIN_SIZE
 (1024*8)

	)

82 
	#REDISMODULE_POOL_ALLOC_ALIGN
 ((*))

	)

84 
	sRedisModuËPoŞAÎocBlock
 {

85 
ušt32_t
 
	msize
;

86 
ušt32_t
 
	mu£d
;

87 
RedisModuËPoŞAÎocBlock
 *
	mÃxt
;

88 
	mmemÜy
[];

89 } 
	tRedisModuËPoŞAÎocBlock
;

99 
	gRedisModuËBlockedCl›Á
;

101 
	sRedisModuËCtx
 {

102 *
	mg‘­ifunıŒ
;

103 
RedisModuË
 *
	mmoduË
;

104 
ş›Á
 *
	mş›Á
;

105 
RedisModuËBlockedCl›Á
 *
	mblocked_ş›Á
;

107 
AutoMemEÁry
 *
	mamqueue
;

108 
	mamqueue_Ën
;

109 
	mamqueue_u£d
;

110 
	mæags
;

111 **
	mpo¡pÚed_¬¿ys
;

112 
	mpo¡pÚed_¬¿ys_couÁ
;

113 *
	mblocked_´ivd©a
;

116 *
	mkeys_pos
;

117 
	mkeys_couÁ
;

119 
RedisModuËPoŞAÎocBlock
 *
	m·_h—d
;

121 
RedisModuËCtx
 
	tRedisModuËCtx
;

123 
	#REDISMODULE_CTX_INIT
 {(*)()&
RM_G‘Api
, 
NULL
, NULL, NULL, NULL, 0, 0, 0, NULL, 0, NULL, NULL, 0, NULL}

	)

124 
	#REDISMODULE_CTX_MULTI_EMITTED
 (1<<0)

	)

125 
	#REDISMODULE_CTX_AUTO_MEMORY
 (1<<1)

	)

126 
	#REDISMODULE_CTX_KEYS_POS_REQUEST
 (1<<2)

	)

127 
	#REDISMODULE_CTX_BLOCKED_REPLY
 (1<<3)

	)

128 
	#REDISMODULE_CTX_BLOCKED_TIMEOUT
 (1<<4)

	)

129 
	#REDISMODULE_CTX_THREAD_SAFE
 (1<<5)

	)

132 
	sRedisModuËKey
 {

133 
RedisModuËCtx
 *
	mùx
;

134 
»disDb
 *
	mdb
;

135 
robj
 *
	mkey
;

136 
robj
 *
	mv®ue
;

137 *
	m™”
;

138 
	mmode
;

141 
ušt32_t
 
	mzty³
;

142 
z¿nge¥ec
 
	mzrs
;

143 
zËx¿nge¥ec
 
	mzÌs
;

144 
ušt32_t
 
	mz¡¬t
;

145 
ušt32_t
 
	mz’d
;

146 *
	mzcu¼’t
;

147 
	mz”
;

150 
RedisModuËKey
 
	tRedisModuËKey
;

153 
	#REDISMODULE_ZSET_RANGE_NONE
 0

	)

154 
	#REDISMODULE_ZSET_RANGE_LEX
 1

	)

155 
	#REDISMODULE_ZSET_RANGE_SCORE
 2

	)

156 
	#REDISMODULE_ZSET_RANGE_POS
 3

	)

160 (*
	tRedisModuËCmdFunc
è(
	tRedisModuËCtx
 *
	tùx
, **
	t¬gv
, 
	t¬gc
);

163 
	sRedisModuËCommªdProxy
 {

164 
RedisModuË
 *
moduË
;

165 
RedisModuËCmdFunc
 
func
;

166 
»disCommªd
 *
»discmd
;

168 
RedisModuËCommªdProxy
 
	tRedisModuËCommªdProxy
;

170 
	#REDISMODULE_REPLYFLAG_NONE
 0

	)

171 
	#REDISMODULE_REPLYFLAG_TOPARSE
 (1<<0è

	)

172 
	#REDISMODULE_REPLYFLAG_NESTED
 (1<<1è

	)

178 
	sRedisModuËC®lR•ly
 {

179 
RedisModuËCtx
 *
ùx
;

180 
ty³
;

181 
æags
;

182 
size_t
 
Ën
;

183 *
´Ùo
;

184 
size_t
 
´ÙŞ’
;

186 cÚ¡ *
¡r
;

190 
Î
;

191 
RedisModuËC®lR•ly
 *
¬¿y
;

192 } 
v®
;

193 } 
	tRedisModuËC®lR•ly
;

197 
	sRedisModuËBlockedCl›Á
 {

198 
ş›Á
 *client;

200 
RedisModuË
 *
moduË
;

201 
RedisModuËCmdFunc
 
»¶y_ÿÎback
;

202 
RedisModuËCmdFunc
 
timeout_ÿÎback
;

203 (*
ä“_´ivd©a
)(*);

204 *
´ivd©a
;

207 
ş›Á
 *
»¶y_ş›Á
;

209 
dbid
;

210 } 
	tRedisModuËBlockedCl›Á
;

212 
±h»ad_mu‹x_t
 
moduËUnblockedCl›ÁsMu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

213 
li¡
 *
moduËUnblockedCl›Ás
;

217 
±h»ad_mu‹x_t
 
moduËGIL
 = 
PTHREAD_MUTEX_INITIALIZER
;

221 (*
	tRedisModuËNÙifiÿtiÚFunc
è(
	tRedisModuËCtx
 *
	tùx
, 
	tty³
, cÚ¡ *
	tev’t
, 
	tRedisModuËSŒšg
 *
	tkey
);

225 
	sRedisModuËKey¥aûSubsüib”
 {

227 
RedisModuË
 *
moduË
;

229 
RedisModuËNÙifiÿtiÚFunc
 
nÙify_ÿÎback
;

231 
ev’t_mask
;

234 
aùive
;

235 } 
	tRedisModuËKey¥aûSubsüib”
;

238 
li¡
 *
moduËKey¥aûSubsüib”s
;

242 
ş›Á
 *
moduËKey¥aûSubsüib”sCl›Á
;

248 
	`RM_F»eC®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
);

249 
	`RM_Clo£Key
(
RedisModuËKey
 *
key
);

250 
	`autoMemÜyCŞËù
(
RedisModuËCtx
 *
ùx
);

251 
robj
 **
	`moduËC»©eArgvFromU£rFÜm©
(cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, *
¬gı
, *
æags
, 
va_li¡
 
­
);

252 
	`moduËR•liÿ‹MuÉiIfN“ded
(
RedisModuËCtx
 *
ùx
);

253 
	`RM_Z£tRªgeStİ
(
RedisModuËKey
 *
kp
);

254 
	`z£tKeyRe£t
(
RedisModuËKey
 *
key
);

264 *
	$RM_AÎoc
(
size_t
 
by‹s
) {

265  
	`zm®loc
(
by‹s
);

266 
	}
}

272 *
	$RM_C®loc
(
size_t
 
nmemb
, size_ˆ
size
) {

273  
	`zÿÎoc
(
nmemb
*
size
);

274 
	}
}

277 * 
	$RM_R—Îoc
(*
±r
, 
size_t
 
by‹s
) {

278  
	`z»®loc
(
±r
,
by‹s
);

279 
	}
}

284 
	$RM_F»e
(*
±r
) {

285 
	`zä“
(
±r
);

286 
	}
}

289 *
	$RM_SŒdup
(cÚ¡ *
¡r
) {

290  
	`z¡rdup
(
¡r
);

291 
	}
}

298 
	$poŞAÎocR–—£
(
RedisModuËCtx
 *
ùx
) {

299 
RedisModuËPoŞAÎocBlock
 *
h—d
 = 
ùx
->
·_h—d
, *
Ãxt
;

301 
h—d
 !ğ
NULL
) {

302 
Ãxt
 = 
h—d
->next;

303 
	`zä“
(
h—d
);

304 
h—d
 = 
Ãxt
;

306 
ùx
->
·_h—d
 = 
NULL
;

307 
	}
}

321 *
	$RM_PoŞAÎoc
(
RedisModuËCtx
 *
ùx
, 
size_t
 
by‹s
) {

322 ià(
by‹s
 =ğ0è 
NULL
;

323 
RedisModuËPoŞAÎocBlock
 *
b
 = 
ùx
->
·_h—d
;

324 
size_t
 
Ëá
 = 
b
 ? b->
size
 - b->
u£d
 : 0;

327 ià(
Ëá
 >ğ
by‹s
) {

328 
size_t
 
®ignm’t
 = 
REDISMODULE_POOL_ALLOC_ALIGN
;

329 
by‹s
 < 
®ignm’t
 &&‡lignment/2 >= bytes)‡lignment /= 2;

330 ià(
b
->
u£d
 % 
®ignm’t
)

331 
b
->
u£d
 +ğ
®ignm’t
 - (b->used %‡lignment);

332 
Ëá
 = (
b
->
u£d
 > b->
size
) ? 0 : b->size - b->used;

336 ià(
Ëá
 < 
by‹s
) {

337 
size_t
 
blocksize
 = 
REDISMODULE_POOL_ALLOC_MIN_SIZE
;

338 ià(
blocksize
 < 
by‹s
) blocksize = bytes;

339 
b
 = 
	`zm®loc
((*bè+ 
blocksize
);

340 
b
->
size
 = 
blocksize
;

341 
b
->
u£d
 = 0;

342 
b
->
Ãxt
 = 
ùx
->
·_h—d
;

343 
ùx
->
·_h—d
 = 
b
;

346 *
»tv®
 = 
b
->
memÜy
 + b->
u£d
;

347 
b
->
u£d
 +ğ
by‹s
;

348  
»tv®
;

349 
	}
}

367 
	$moduËC»©eEm±yKey
(
RedisModuËKey
 *
key
, 
ty³
) {

368 
robj
 *
obj
;

371 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
v®ue
)

372  
REDISMODULE_ERR
;

374 
ty³
) {

375 
REDISMODULE_KEYTYPE_LIST
:

376 
obj
 = 
	`ü—‹Quickli¡Objeù
();

377 
	`quickli¡S‘O±iÚs
(
obj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

378 
£rv”
.
li¡_com´ess_d•th
);

380 
REDISMODULE_KEYTYPE_ZSET
:

381 
obj
 = 
	`ü—‹Z£tZli¡Objeù
();

383 
REDISMODULE_KEYTYPE_HASH
:

384 
obj
 = 
	`ü—‹HashObjeù
();

386 :  
REDISMODULE_ERR
;

388 
	`dbAdd
(
key
->
db
,key->key,
obj
);

389 
key
->
v®ue
 = 
obj
;

390  
REDISMODULE_OK
;

391 
	}
}

403 
	$moduËD–KeyIfEm±y
(
RedisModuËKey
 *
key
) {

404 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
v®ue
 =ğ
NULL
)  0;

405 
i£m±y
;

406 
robj
 *
o
 = 
key
->
v®ue
;

408 
o
->
ty³
) {

409 
OBJ_LIST
: 
i£m±y
 = 
	`li¡Ty³L’gth
(
o
) == 0; ;

410 
OBJ_SET
: 
i£m±y
 = 
	`£tTy³Size
(
o
) == 0; ;

411 
OBJ_ZSET
: 
i£m±y
 = 
	`z£tL’gth
(
o
) == 0; ;

412 
OBJ_HASH
 : 
i£m±y
 = 
	`hashTy³L’gth
(
o
) == 0; ;

413 : 
i£m±y
 = 0;

416 ià(
i£m±y
) {

417 
	`dbD–‘e
(
key
->
db
,key->key);

418 
key
->
v®ue
 = 
NULL
;

423 
	}
}

441 
	$RM_G‘Api
(cÚ¡ *
funúame
, **
rg‘PŒPŒ
) {

442 
diùEÁry
 *
he
 = 
	`diùFšd
(
£rv”
.
moduË­i
, 
funúame
);

443 ià(!
he
è 
REDISMODULE_ERR
;

444 *
rg‘PŒPŒ
 = 
	`diùG‘V®
(
he
);

445  
REDISMODULE_OK
;

446 
	}
}

449 
	$moduËF»eCÚ‹xt
(
RedisModuËCtx
 *
ùx
) {

450 
	`autoMemÜyCŞËù
(
ùx
);

451 
	`poŞAÎocR–—£
(
ùx
);

452 ià(
ùx
->
po¡pÚed_¬¿ys
) {

453 
	`zä“
(
ùx
->
po¡pÚed_¬¿ys
);

454 
ùx
->
po¡pÚed_¬¿ys_couÁ
 = 0;

455 
	`£rv”Log
(
LL_WARNING
,

460 
ùx
->
moduË
->
Çme
);

462 ià(
ùx
->
æags
 & 
REDISMODULE_CTX_THREAD_SAFE
è
	`ä“Cl›Á
(ùx->
ş›Á
);

463 
	}
}

467 
	$moduËHªdËPrİag©iÚAá”CommªdC®lback
(
RedisModuËCtx
 *
ùx
) {

468 
ş›Á
 *
c
 = 
ùx
->client;

470 ià(
c
->
æags
 & 
CLIENT_LUA
) ;

474 ià(
ùx
->
æags
 & 
REDISMODULE_CTX_MULTI_EMITTED
) {

475 
robj
 *
´İ¬gv
[1];

476 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("EXEC",4);

477 
	`®soPrİag©e
(
£rv”
.
execCommªd
,
c
->
db
->
id
,
´İ¬gv
,1,

478 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

479 
	`deüRefCouÁ
(
´İ¬gv
[0]);

481 
	}
}

485 
	$RedisModuËCommªdDi¥©ch”
(
ş›Á
 *
c
) {

486 
RedisModuËCommªdProxy
 *
ı
 = (*)()
c
->
cmd
->
g‘keys_´oc
;

487 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

489 
ùx
.
moduË
 = 
ı
->module;

490 
ùx
.
ş›Á
 = 
c
;

491 
ı
->
	`func
(&
ùx
,(**)
c
->
¬gv
,c->
¬gc
);

492 
	`moduËHªdËPrİag©iÚAá”CommªdC®lback
(&
ùx
);

493 
	`moduËF»eCÚ‹xt
(&
ùx
);

494 
	}
}

505 *
	$moduËG‘CommªdKeysVŸAPI
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

506 
RedisModuËCommªdProxy
 *
ı
 = (*)()
cmd
->
g‘keys_´oc
;

507 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

509 
ùx
.
moduË
 = 
ı
->module;

510 
ùx
.
ş›Á
 = 
NULL
;

511 
ùx
.
æags
 |ğ
REDISMODULE_CTX_KEYS_POS_REQUEST
;

512 
ı
->
	`func
(&
ùx
,(**)
¬gv
,
¬gc
);

513 *
»s
 = 
ùx
.
keys_pos
;

514 ià(
numkeys
è*numkey ğ
ùx
.
keys_couÁ
;

515 
	`moduËF»eCÚ‹xt
(&
ùx
);

516  
»s
;

517 
	}
}

522 
	$RM_IsKeysPos™iÚReque¡
(
RedisModuËCtx
 *
ùx
) {

523  (
ùx
->
æags
 & 
REDISMODULE_CTX_KEYS_POS_REQUEST
) != 0;

524 
	}
}

540 
	$RM_KeyAtPos
(
RedisModuËCtx
 *
ùx
, 
pos
) {

541 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_KEYS_POS_REQUEST
)) ;

542 ià(
pos
 <= 0) ;

543 
ùx
->
keys_pos
 = 
	`z»®loc
(ùx->keys_pos,()*(ùx->
keys_couÁ
+1));

544 
ùx
->
keys_pos
[ùx->
keys_couÁ
++] = 
pos
;

545 
	}
}

551 
	$commªdFÏgsFromSŒšg
(*
s
) {

552 
couÁ
, 
j
;

553 
æags
 = 0;

554 
sds
 *
tok’s
 = 
	`sds¥l™Ën
(
s
,
	`¡¾’
(s)," ",1,&
couÁ
);

555 
j
 = 0; j < 
couÁ
; j++) {

556 *
t
 = 
tok’s
[
j
];

557 ià(!
	`¡rÿ£cmp
(
t
,"wr™e")è
æags
 |ğ
CMD_WRITE
;

558 ià(!
	`¡rÿ£cmp
(
t
,"»adÚly")è
æags
 |ğ
CMD_READONLY
;

559 ià(!
	`¡rÿ£cmp
(
t
,"admš")è
æags
 |ğ
CMD_ADMIN
;

560 ià(!
	`¡rÿ£cmp
(
t
,"d’y-oom")è
æags
 |ğ
CMD_DENYOOM
;

561 ià(!
	`¡rÿ£cmp
(
t
,"d’y-süt")è
æags
 |ğ
CMD_NOSCRIPT
;

562 ià(!
	`¡rÿ£cmp
(
t
,"®low-lßdšg")è
æags
 |ğ
CMD_LOADING
;

563 ià(!
	`¡rÿ£cmp
(
t
,"pubsub")è
æags
 |ğ
CMD_PUBSUB
;

564 ià(!
	`¡rÿ£cmp
(
t
,"¿ndom")è
æags
 |ğ
CMD_RANDOM
;

565 ià(!
	`¡rÿ£cmp
(
t
,"®low-¡®e")è
æags
 |ğ
CMD_STALE
;

566 ià(!
	`¡rÿ£cmp
(
t
,"no-mÚ™Ü")è
æags
 |ğ
CMD_SKIP_MONITOR
;

567 ià(!
	`¡rÿ£cmp
(
t
,"ç¡")è
æags
 |ğ
CMD_FAST
;

568 ià(!
	`¡rÿ£cmp
(
t
,"g‘keys-­i")è
æags
 |ğ
CMD_MODULE_GETKEYS
;

569 ià(!
	`¡rÿ£cmp
(
t
,"no-şu¡”")è
æags
 |ğ
CMD_MODULE_NO_CLUSTER
;

572 
	`sdsä“¥l™»s
(
tok’s
,
couÁ
);

573 ià(
j
 !ğ
couÁ
)  -1;

574  
æags
;

575 
	}
}

630 
	$RM_C»©eCommªd
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
RedisModuËCmdFunc
 
cmdfunc
, cÚ¡ *
¡ræags
, 
fœ¡key
, 
Ï¡key
, 
key¡•
) {

631 
æags
 = 
¡ræags
 ? 
	`commªdFÏgsFromSŒšg
((*)strflags) : 0;

632 ià(
æags
 =ğ-1è 
REDISMODULE_ERR
;

633 ià((
æags
 & 
CMD_MODULE_NO_CLUSTER
è&& 
£rv”
.
şu¡”_’abËd
)

634  
REDISMODULE_ERR
;

636 
»disCommªd
 *
»discmd
;

637 
RedisModuËCommªdProxy
 *
ı
;

638 
sds
 
cmdÇme
 = 
	`sd¢ew
(
Çme
);

641 ià(
	`lookupCommªd
(
cmdÇme
è!ğ
NULL
) {

642 
	`sdsä“
(
cmdÇme
);

643  
REDISMODULE_ERR
;

653 
ı
 = 
	`zm®loc
((*cp));

654 
ı
->
moduË
 = 
ùx
->module;

655 
ı
->
func
 = 
cmdfunc
;

656 
ı
->
»discmd
 = 
	`zm®loc
((*rediscmd));

657 
ı
->
»discmd
->
Çme
 = 
cmdÇme
;

658 
ı
->
»discmd
->
´oc
 = 
RedisModuËCommªdDi¥©ch”
;

659 
ı
->
»discmd
->
¬™y
 = -1;

660 
ı
->
»discmd
->
æags
 = fÏg | 
CMD_MODULE
;

661 
ı
->
»discmd
->
g‘keys_´oc
 = (
»disG‘KeysProc
*)()cp;

662 
ı
->
»discmd
->
fœ¡key
 = firstkey;

663 
ı
->
»discmd
->
Ï¡key
 =†astkey;

664 
ı
->
»discmd
->
key¡•
 = keystep;

665 
ı
->
»discmd
->
miüo£cÚds
 = 0;

666 
ı
->
»discmd
->
ÿÎs
 = 0;

667 
	`diùAdd
(
£rv”
.
commªds
,
	`sdsdup
(
cmdÇme
),
ı
->
»discmd
);

668 
	`diùAdd
(
£rv”
.
Üig_commªds
,
	`sdsdup
(
cmdÇme
),
ı
->
»discmd
);

669  
REDISMODULE_OK
;

670 
	}
}

676 
	$RM_S‘ModuËA‰ribs
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
) {

677 
RedisModuË
 *
moduË
;

679 ià(
ùx
->
moduË
 !ğ
NULL
) ;

680 
moduË
 = 
	`zm®loc
((*module));

681 
moduË
->
Çme
 = 
	`sd¢ew
((*)name);

682 
moduË
->
v”
 = ver;

683 
moduË
->
­iv”
 =‡piver;

684 
moduË
->
ty³s
 = 
	`li¡C»©e
();

685 
ùx
->
moduË
 = module;

686 
	}
}

690 
	$RM_IsModuËNameBusy
(cÚ¡ *
Çme
) {

691 
sds
 
moduËÇme
 = 
	`sd¢ew
(
Çme
);

692 
diùEÁry
 *
de
 = 
	`diùFšd
(
moduËs
,
moduËÇme
);

693 
	`sdsä“
(
moduËÇme
);

694  
de
 !ğ
NULL
;

695 
	}
}

698 
	$RM_Mli£cÚds
() {

699  
	`m¡ime
();

700 
	}
}

710 
	$RM_AutoMemÜy
(
RedisModuËCtx
 *
ùx
) {

711 
ùx
->
æags
 |ğ
REDISMODULE_CTX_AUTO_MEMORY
;

712 
	}
}

715 
	$autoMemÜyAdd
(
RedisModuËCtx
 *
ùx
, 
ty³
, *
±r
) {

716 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_AUTO_MEMORY
)) ;

717 ià(
ùx
->
amqueue_u£d
 =ğùx->
amqueue_Ën
) {

718 
ùx
->
amqueue_Ën
 *= 2;

719 ià(
ùx
->
amqueue_Ën
 < 16) ctx->amqueue_len = 16;

720 
ùx
->
amqueue
 = 
	`z»®loc
(ùx->amqueue,(
AutoMemEÁry
)*ùx->
amqueue_Ën
);

722 
ùx
->
amqueue
[ùx->
amqueue_u£d
].
ty³
 =ype;

723 
ùx
->
amqueue
[ùx->
amqueue_u£d
].
±r
 =…tr;

724 
ùx
->
amqueue_u£d
++;

725 
	}
}

732 
	$autoMemÜyF»ed
(
RedisModuËCtx
 *
ùx
, 
ty³
, *
±r
) {

733 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_AUTO_MEMORY
))  0;

735 
couÁ
 = (
ùx
->
amqueue_u£d
+1)/2;

736 
j
 = 0; j < 
couÁ
; j++) {

737 
side
 = 0; side < 2; side++) {

740 
i
 = (
side
 =ğ0è? (
ùx
->
amqueue_u£d
 - 1 - 
j
) : j;

741 ià(
ùx
->
amqueue
[
i
].
ty³
 ==ype &&

742 
ùx
->
amqueue
[
i
].
±r
 ==…tr)

744 
ùx
->
amqueue
[
i
].
ty³
 = 
REDISMODULE_AM_FREED
;

748 ià(
i
 !ğ
ùx
->
amqueue_u£d
-1) {

749 
ùx
->
amqueue
[
i
] = ctx->amqueue[ùx->
amqueue_u£d
-1];

754 
ùx
->
amqueue_u£d
--;

760 
	}
}

763 
	$autoMemÜyCŞËù
(
RedisModuËCtx
 *
ùx
) {

764 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_AUTO_MEMORY
)) ;

768 
ùx
->
æags
 &ğ~
REDISMODULE_CTX_AUTO_MEMORY
;

769 
j
;

770 
j
 = 0; j < 
ùx
->
amqueue_u£d
; j++) {

771 *
±r
 = 
ùx
->
amqueue
[
j
].ptr;

772 
ùx
->
amqueue
[
j
].
ty³
) {

773 
REDISMODULE_AM_STRING
: 
	`deüRefCouÁ
(
±r
); ;

774 
REDISMODULE_AM_REPLY
: 
	`RM_F»eC®lR•ly
(
±r
); ;

775 
REDISMODULE_AM_KEY
: 
	`RM_Clo£Key
(
±r
); ;

778 
ùx
->
æags
 |ğ
REDISMODULE_CTX_AUTO_MEMORY
;

779 
	`zä“
(
ùx
->
amqueue
);

780 
ùx
->
amqueue
 = 
NULL
;

781 
ùx
->
amqueue_Ën
 = 0;

782 
ùx
->
amqueue_u£d
 = 0;

783 
	}
}

794 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšg
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
±r
, 
size_t
 
Ën
) {

795 
RedisModuËSŒšg
 *
o
 = 
	`ü—‹SŒšgObjeù
(
±r
,
Ën
);

796 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_STRING
,
o
);

797  
o
;

798 
	}
}

806 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšgPrštf
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
fmt
, ...) {

807 
sds
 
s
 = 
	`sd£m±y
();

809 
va_li¡
 
­
;

810 
	`va_¡¬t
(
­
, 
fmt
);

811 
s
 = 
	`sdsÿtv´štf
(s, 
fmt
, 
­
);

812 
	`va_’d
(
­
);

814 
RedisModuËSŒšg
 *
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
s
);

815 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_STRING
,
o
);

817  
o
;

818 
	}
}

826 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšgFromLÚgLÚg
(
RedisModuËCtx
 *
ùx
, 
Î
) {

827 
buf
[
LONG_STR_SIZE
];

828 
size_t
 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
Î
);

829  
	`RM_C»©eSŒšg
(
ùx
,
buf
,
Ën
);

830 
	}
}

837 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšgFromSŒšg
(
RedisModuËCtx
 *
ùx
, cÚ¡ 
RedisModuËSŒšg
 *
¡r
) {

838 
RedisModuËSŒšg
 *
o
 = 
	`dupSŒšgObjeù
(
¡r
);

839 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_STRING
,
o
);

840  
o
;

841 
	}
}

849 
	$RM_F»eSŒšg
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
) {

850 
	`deüRefCouÁ
(
¡r
);

851 
	`autoMemÜyF»ed
(
ùx
,
REDISMODULE_AM_STRING
,
¡r
);

852 
	}
}

876 
	$RM_R‘ašSŒšg
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
) {

877 ià(!
	`autoMemÜyF»ed
(
ùx
,
REDISMODULE_AM_STRING
,
¡r
)) {

887 
	`šüRefCouÁ
(
¡r
);

889 
	}
}

894 cÚ¡ *
	$RM_SŒšgPŒL’
(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, 
size_t
 *
Ën
) {

895 ià(
¡r
 =ğ
NULL
) {

896 cÚ¡ *
”rmsg
 = "(NULL string„eply„eferenced in module)";

897 ià(
Ën
è*ËÀğ
	`¡¾’
(
”rmsg
);

898  
”rmsg
;

900 ià(
Ën
è*ËÀğ
	`sd¦’
(
¡r
->
±r
);

901  
¡r
->
±r
;

902 
	}
}

912 
	$RM_SŒšgToLÚgLÚg
(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
Î
) {

913  
	`¡ršg2Î
(
¡r
->
±r
,
	`sd¦’
(¡r->±r),
Î
è? 
REDISMODULE_OK
 :

914 
REDISMODULE_ERR
;

915 
	}
}

920 
	$RM_SŒšgToDoubË
(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
d
) {

921 
»tv®
 = 
	`g‘DoubËFromObjeù
(
¡r
,
d
);

922  (
»tv®
 =ğ
C_OK
è? 
REDISMODULE_OK
 : 
REDISMODULE_ERR
;

923 
	}
}

928 
	$RM_SŒšgCom·»
(
RedisModuËSŒšg
 *
a
, RedisModuËSŒšg *
b
) {

929  
	`com·»SŒšgObjeùs
(
a
,
b
);

930 
	}
}

934 
RedisModuËSŒšg
 *
	$moduËAs£¹Unsh¬edSŒšg
(
RedisModuËSŒšg
 *
¡r
) {

935 ià(
¡r
->
»fcouÁ
 != 1) {

936 
	`£rv”Log
(
LL_WARNING
,

940  
NULL
;

942 ià(
¡r
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
) {

945 
¡r
->
±r
 = 
	`sd¢ewËn
(¡r->±r,
	`sd¦’
(str->ptr));

946 
¡r
->
’codšg
 = 
OBJ_ENCODING_RAW
;

947 } ià(
¡r
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

949 
¡r
->
±r
 = 
	`sdsäomlÚglÚg
(()str->ptr);

950 
¡r
->
’codšg
 = 
OBJ_ENCODING_RAW
;

952  
¡r
;

953 
	}
}

958 
	$RM_SŒšgAµ’dBufãr
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

959 
	`UNUSED
(
ùx
);

960 
¡r
 = 
	`moduËAs£¹Unsh¬edSŒšg
(str);

961 ià(
¡r
 =ğ
NULL
è 
REDISMODULE_ERR
;

962 
¡r
->
±r
 = 
	`sdsÿ’
(¡r->±r,
buf
,
Ën
);

963  
REDISMODULE_OK
;

964 
	}
}

983 
	$RM_WrÚgAr™y
(
RedisModuËCtx
 *
ùx
) {

984 
	`addR•lyE¼ÜFÜm©
(
ùx
->
ş›Á
,

986 (*)
ùx
->
ş›Á
->
¬gv
[0]->
±r
);

987  
REDISMODULE_OK
;

988 
	}
}

1003 
ş›Á
 *
	$moduËG‘R•lyCl›Á
(
RedisModuËCtx
 *
ùx
) {

1004 ià(!(
ùx
->
æags
 & 
REDISMODULE_CTX_THREAD_SAFE
è&& ctx->
ş›Á
)

1005  
ùx
->
ş›Á
;

1006 ià(
ùx
->
blocked_ş›Á
)

1007  
ùx
->
blocked_ş›Á
->
»¶y_ş›Á
;

1008  
NULL
;

1009 
	}
}

1013 
	$RM_R•lyW™hLÚgLÚg
(
RedisModuËCtx
 *
ùx
, 
Î
) {

1014 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1015 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1016 
	`addR•lyLÚgLÚg
(
c
,
Î
);

1017  
REDISMODULE_OK
;

1018 
	}
}

1023 
	$»¶yW™hStus
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
msg
, *
´efix
) {

1024 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1025 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1026 
sds
 
¡rmsg
 = 
	`sd¢ewËn
(
´efix
,1);

1027 
¡rmsg
 = 
	`sdsÿt
(¡rmsg,
msg
);

1028 
¡rmsg
 = 
	`sdsÿ’
(strmsg,"\r\n",2);

1029 
	`addR•lySds
(
c
,
¡rmsg
);

1030  
REDISMODULE_OK
;

1031 
	}
}

1047 
	$RM_R•lyW™hE¼Ü
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
”r
) {

1048  
	`»¶yW™hStus
(
ùx
,
”r
,"-");

1049 
	}
}

1056 
	$RM_R•lyW™hSim¶eSŒšg
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
msg
) {

1057  
	`»¶yW™hStus
(
ùx
,
msg
,"+");

1058 
	}
}

1071 
	$RM_R•lyW™hA¼ay
(
RedisModuËCtx
 *
ùx
, 
Ën
) {

1072 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1073 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1074 ià(
Ën
 =ğ
REDISMODULE_POSTPONED_ARRAY_LEN
) {

1075 
ùx
->
po¡pÚed_¬¿ys
 = 
	`z»®loc
(ctx->postponed_arrays,(*)*

1076 (
ùx
->
po¡pÚed_¬¿ys_couÁ
+1));

1077 
ùx
->
po¡pÚed_¬¿ys
[ùx->
po¡pÚed_¬¿ys_couÁ
] =

1078 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1079 
ùx
->
po¡pÚed_¬¿ys_couÁ
++;

1081 
	`addR•lyMuÉiBulkL’
(
c
,
Ën
);

1083  
REDISMODULE_OK
;

1084 
	}
}

1112 
	$RM_R•lyS‘A¼ayL’gth
(
RedisModuËCtx
 *
ùx
, 
Ën
) {

1113 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1114 ià(
c
 =ğ
NULL
) ;

1115 ià(
ùx
->
po¡pÚed_¬¿ys_couÁ
 == 0) {

1116 
	`£rv”Log
(
LL_WARNING
,

1120 "ÿÎ.", 
ùx
->
moduË
->
Çme
);

1123 
ùx
->
po¡pÚed_¬¿ys_couÁ
--;

1124 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,

1125 
ùx
->
po¡pÚed_¬¿ys
[ùx->
po¡pÚed_¬¿ys_couÁ
],

1126 
Ën
);

1127 ià(
ùx
->
po¡pÚed_¬¿ys_couÁ
 == 0) {

1128 
	`zä“
(
ùx
->
po¡pÚed_¬¿ys
);

1129 
ùx
->
po¡pÚed_¬¿ys
 = 
NULL
;

1131 
	}
}

1136 
	$RM_R•lyW™hSŒšgBufãr
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

1137 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1138 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1139 
	`addR•lyBulkCBufãr
(
c
,(*)
buf
,
Ën
);

1140  
REDISMODULE_OK
;

1141 
	}
}

1146 
	$RM_R•lyW™hSŒšg
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
) {

1147 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1148 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1149 
	`addR•lyBulk
(
c
,
¡r
);

1150  
REDISMODULE_OK
;

1151 
	}
}

1157 
	$RM_R•lyW™hNuÎ
(
RedisModuËCtx
 *
ùx
) {

1158 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1159 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1160 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1161  
REDISMODULE_OK
;

1162 
	}
}

1170 
	$RM_R•lyW™hC®lR•ly
(
RedisModuËCtx
 *
ùx
, 
RedisModuËC®lR•ly
 *
»¶y
) {

1171 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1172 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1173 
sds
 
´Ùo
 = 
	`sd¢ewËn
(
»¶y
->´Ùo,„•ly->
´ÙŞ’
);

1174 
	`addR•lySds
(
c
,
´Ùo
);

1175  
REDISMODULE_OK
;

1176 
	}
}

1184 
	$RM_R•lyW™hDoubË
(
RedisModuËCtx
 *
ùx
, 
d
) {

1185 
ş›Á
 *
c
 = 
	`moduËG‘R•lyCl›Á
(
ùx
);

1186 ià(
c
 =ğ
NULL
è 
REDISMODULE_OK
;

1187 
	`addR•lyDoubË
(
c
,
d
);

1188  
REDISMODULE_OK
;

1189 
	}
}

1198 
	$moduËR•liÿ‹MuÉiIfN“ded
(
RedisModuËCtx
 *
ùx
) {

1201 ià(
ùx
->
ş›Á
->
æags
 & (
CLIENT_MULTI
|
CLIENT_LUA
)) ;

1203 ià(
ùx
->
æags
 & 
REDISMODULE_CTX_MULTI_EMITTED
) ;

1207 ià(
ùx
->
æags
 & 
REDISMODULE_CTX_THREAD_SAFE
) ;

1208 
	`execCommªdPrİag©eMuÉi
(
ùx
->
ş›Á
);

1209 
ùx
->
æags
 |ğ
REDISMODULE_CTX_MULTI_EMITTED
;

1210 
	}
}

1231 
	$RM_R•liÿ‹
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...) {

1232 
»disCommªd
 *
cmd
;

1233 
robj
 **
¬gv
 = 
NULL
;

1234 
¬gc
 = 0, 
æags
 = 0, 
j
;

1235 
va_li¡
 
­
;

1237 
cmd
 = 
	`lookupCommªdByCSŒšg
((*)
cmdÇme
);

1238 ià(!
cmd
è 
REDISMODULE_ERR
;

1241 
	`va_¡¬t
(
­
, 
fmt
);

1242 
¬gv
 = 
	`moduËC»©eArgvFromU£rFÜm©
(
cmdÇme
,
fmt
,&
¬gc
,&
æags
,
­
);

1243 
	`va_’d
(
­
);

1244 ià(
¬gv
 =ğ
NULL
è 
REDISMODULE_ERR
;

1247 
	`moduËR•liÿ‹MuÉiIfN“ded
(
ùx
);

1248 
	`®soPrİag©e
(
cmd
,
ùx
->
ş›Á
->
db
->
id
,
¬gv
,
¬gc
,

1249 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

1252 
j
 = 0; j < 
¬gc
; j++è
	`deüRefCouÁ
(
¬gv
[j]);

1253 
	`zä“
(
¬gv
);

1254 
£rv”
.
dœty
++;

1255  
REDISMODULE_OK
;

1256 
	}
}

1269 
	$RM_R•liÿ‹V”b©im
(
RedisModuËCtx
 *
ùx
) {

1270 
	`®soPrİag©e
(
ùx
->
ş›Á
->
cmd
,ùx->ş›Á->
db
->
id
,

1271 
ùx
->
ş›Á
->
¬gv
,ùx->ş›Á->
¬gc
,

1272 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

1273 
£rv”
.
dœty
++;

1274  
REDISMODULE_OK
;

1275 
	}
}

1292 
	$RM_G‘Cl›ÁId
(
RedisModuËCtx
 *
ùx
) {

1293 ià(
ùx
->
ş›Á
 =ğ
NULL
)  0;

1294  
ùx
->
ş›Á
->
id
;

1295 
	}
}

1298 
	$RM_G‘S–eùedDb
(
RedisModuËCtx
 *
ùx
) {

1299  
ùx
->
ş›Á
->
db
->
id
;

1300 
	}
}

1330 
	$RM_G‘CÚ‹xtFÏgs
(
RedisModuËCtx
 *
ùx
) {

1332 
æags
 = 0;

1334 ià(
ùx
->
ş›Á
) {

1335 ià(
ùx
->
ş›Á
->
æags
 & 
CLIENT_LUA
)

1336 
æags
 |ğ
REDISMODULE_CTX_FLAGS_LUA
;

1337 ià(
ùx
->
ş›Á
->
æags
 & 
CLIENT_MULTI
)

1338 
æags
 |ğ
REDISMODULE_CTX_FLAGS_MULTI
;

1341 ià(
£rv”
.
şu¡”_’abËd
)

1342 
æags
 |ğ
REDISMODULE_CTX_FLAGS_CLUSTER
;

1345 ià(
£rv”
.
maxmemÜy
 > 0) {

1346 
æags
 |ğ
REDISMODULE_CTX_FLAGS_MAXMEMORY
;

1348 ià(
£rv”
.
maxmemÜy_pŞicy
 !ğ
MAXMEMORY_NO_EVICTION
)

1349 
æags
 |ğ
REDISMODULE_CTX_FLAGS_EVICT
;

1353 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
)

1354 
æags
 |ğ
REDISMODULE_CTX_FLAGS_AOF
;

1355 ià(
£rv”
.
§v•¬am¦’
 > 0)

1356 
æags
 |ğ
REDISMODULE_CTX_FLAGS_RDB
;

1359 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
) {

1360 
æags
 |ğ
REDISMODULE_CTX_FLAGS_MASTER
;

1362 
æags
 |ğ
REDISMODULE_CTX_FLAGS_SLAVE
;

1363 ià(
£rv”
.
»¶_¦ave_ro
)

1364 
æags
 |ğ
REDISMODULE_CTX_FLAGS_READONLY
;

1367  
æags
;

1368 
	}
}

1380 
	$RM_S–eùDb
(
RedisModuËCtx
 *
ùx
, 
Ãwid
) {

1381 
»tv®
 = 
	`£ËùDb
(
ùx
->
ş›Á
,
Ãwid
);

1382  (
»tv®
 =ğ
C_OK
è? 
REDISMODULE_OK
 : 
REDISMODULE_ERR
;

1383 
	}
}

1399 *
	$RM_O³nKey
(
RedisModuËCtx
 *
ùx
, 
robj
 *
keyÇme
, 
mode
) {

1400 
RedisModuËKey
 *
kp
;

1401 
robj
 *
v®ue
;

1403 ià(
mode
 & 
REDISMODULE_WRITE
) {

1404 
v®ue
 = 
	`lookupKeyWr™e
(
ùx
->
ş›Á
->
db
,
keyÇme
);

1406 
v®ue
 = 
	`lookupKeyR—d
(
ùx
->
ş›Á
->
db
,
keyÇme
);

1407 ià(
v®ue
 =ğ
NULL
) {

1408  
NULL
;

1413 
kp
 = 
	`zm®loc
((*kp));

1414 
kp
->
ùx
 = ctx;

1415 
kp
->
db
 = 
ùx
->
ş›Á
->db;

1416 
kp
->
key
 = 
keyÇme
;

1417 
	`šüRefCouÁ
(
keyÇme
);

1418 
kp
->
v®ue
 = value;

1419 
kp
->
™”
 = 
NULL
;

1420 
kp
->
mode
 = mode;

1421 
	`z£tKeyRe£t
(
kp
);

1422 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_KEY
,
kp
);

1423  (*)
kp
;

1424 
	}
}

1427 
	$RM_Clo£Key
(
RedisModuËKey
 *
key
) {

1428 ià(
key
 =ğ
NULL
) ;

1429 ià(
key
->
mode
 & 
REDISMODULE_WRITE
è
	`sigÇlModif›dKey
(key->
db
,key->key);

1431 
	`RM_Z£tRªgeStİ
(
key
);

1432 
	`deüRefCouÁ
(
key
->key);

1433 
	`autoMemÜyF»ed
(
key
->
ùx
,
REDISMODULE_AM_KEY
,key);

1434 
	`zä“
(
key
);

1435 
	}
}

1439 
	$RM_KeyTy³
(
RedisModuËKey
 *
key
) {

1440 ià(
key
 =ğ
NULL
 || key->
v®ue
 =ğNULLè 
REDISMODULE_KEYTYPE_EMPTY
;

1443 
key
->
v®ue
->
ty³
) {

1444 
OBJ_STRING
:  
REDISMODULE_KEYTYPE_STRING
;

1445 
OBJ_LIST
:  
REDISMODULE_KEYTYPE_LIST
;

1446 
OBJ_SET
:  
REDISMODULE_KEYTYPE_SET
;

1447 
OBJ_ZSET
:  
REDISMODULE_KEYTYPE_ZSET
;

1448 
OBJ_HASH
:  
REDISMODULE_KEYTYPE_HASH
;

1449 
OBJ_MODULE
:  
REDISMODULE_KEYTYPE_MODULE
;

1452 
	}
}

1459 
size_t
 
	$RM_V®ueL’gth
(
RedisModuËKey
 *
key
) {

1460 ià(
key
 =ğ
NULL
 || key->
v®ue
 == NULL)  0;

1461 
key
->
v®ue
->
ty³
) {

1462 
OBJ_STRING
:  
	`¡ršgObjeùL’
(
key
->
v®ue
);

1463 
OBJ_LIST
:  
	`li¡Ty³L’gth
(
key
->
v®ue
);

1464 
OBJ_SET
:  
	`£tTy³Size
(
key
->
v®ue
);

1465 
OBJ_ZSET
:  
	`z£tL’gth
(
key
->
v®ue
);

1466 
OBJ_HASH
:  
	`hashTy³L’gth
(
key
->
v®ue
);

1469 
	}
}

1475 
	$RM_D–‘eKey
(
RedisModuËKey
 *
key
) {

1476 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1477 ià(
key
->
v®ue
) {

1478 
	`dbD–‘e
(
key
->
db
,key->key);

1479 
key
->
v®ue
 = 
NULL
;

1481  
REDISMODULE_OK
;

1482 
	}
}

1489 
	$RM_UÆškKey
(
RedisModuËKey
 *
key
) {

1490 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1491 ià(
key
->
v®ue
) {

1492 
	`dbAsyncD–‘e
(
key
->
db
,key->key);

1493 
key
->
v®ue
 = 
NULL
;

1495  
REDISMODULE_OK
;

1496 
	}
}

1501 
m¡ime_t
 
	$RM_G‘Expœe
(
RedisModuËKey
 *
key
) {

1502 
m¡ime_t
 
expœe
 = 
	`g‘Expœe
(
key
->
db
,key->key);

1503 ià(
expœe
 =ğ-1 || 
key
->
v®ue
 =ğ
NULL
)  -1;

1504 
expœe
 -ğ
	`m¡ime
();

1505  
expœe
 >= 0 ?ƒxpire : 0;

1506 
	}
}

1517 
	$RM_S‘Expœe
(
RedisModuËKey
 *
key
, 
m¡ime_t
 
expœe
) {

1518 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
v®ue
 =ğ
NULL
)

1519  
REDISMODULE_ERR
;

1520 ià(
expœe
 !ğ
REDISMODULE_NO_EXPIRE
) {

1521 
expœe
 +ğ
	`m¡ime
();

1522 
	`£tExpœe
(
key
->
ùx
->
ş›Á
,key->
db
,key->key,
expœe
);

1524 
	`»moveExpœe
(
key
->
db
,key->key);

1526  
REDISMODULE_OK
;

1527 
	}
}

1537 
	$RM_SŒšgS‘
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
¡r
) {

1538 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
™”
è 
REDISMODULE_ERR
;

1539 
	`RM_D–‘eKey
(
key
);

1540 
	`£tKey
(
key
->
db
,key->key,
¡r
);

1541 
key
->
v®ue
 = 
¡r
;

1542  
REDISMODULE_OK
;

1543 
	}
}

1574 *
	$RM_SŒšgDMA
(
RedisModuËKey
 *
key
, 
size_t
 *
Ën
, 
mode
) {

1579 *
em±y¡ršg
 = "<dma-empty-string>";

1580 ià(
key
->
v®ue
 =ğ
NULL
) {

1581 *
Ën
 = 0;

1582  
em±y¡ršg
;

1585 ià(
key
->
v®ue
->
ty³
 !ğ
OBJ_STRING
è 
NULL
;

1589 ià((
mode
 & 
REDISMODULE_WRITE
è|| 
key
->
v®ue
->
’codšg
 !ğ
OBJ_ENCODING_RAW
)

1590 
key
->
v®ue
 = 
	`dbUnsh¬eSŒšgV®ue
(key->
db
, key->key, key->value);

1592 *
Ën
 = 
	`sd¦’
(
key
->
v®ue
->
±r
);

1593  
key
->
v®ue
->
±r
;

1594 
	}
}

1608 
	$RM_SŒšgTrunÿ‹
(
RedisModuËKey
 *
key
, 
size_t
 
ÃwËn
) {

1609 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1610 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_STRING
è 
REDISMODULE_ERR
;

1611 ià(
ÃwËn
 > 512*1024*1024è 
REDISMODULE_ERR
;

1615 ià(
key
->
v®ue
 =ğ
NULL
 && 
ÃwËn
 =ğ0è 
REDISMODULE_OK
;

1617 ià(
key
->
v®ue
 =ğ
NULL
) {

1619 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
ÃwËn
));

1620 
	`£tKey
(
key
->
db
,key->key,
o
);

1621 
key
->
v®ue
 = 
o
;

1622 
	`deüRefCouÁ
(
o
);

1625 
key
->
v®ue
 = 
	`dbUnsh¬eSŒšgV®ue
(key->
db
, key->key, key->value);

1626 
size_t
 
cu¾’
 = 
	`sd¦’
(
key
->
v®ue
->
±r
);

1627 ià(
ÃwËn
 > 
cu¾’
) {

1628 
key
->
v®ue
->
±r
 = 
	`sdsgrowz”o
(key->v®ue->±r,
ÃwËn
);

1629 } ià(
ÃwËn
 < 
cu¾’
) {

1630 
	`sd¤ªge
(
key
->
v®ue
->
±r
,0,
ÃwËn
-1);

1632 ià(
	`sd¦’
(
key
->
v®ue
->
±r
è< 
	`sd§va
(key->value->ptr))

1633 
key
->
v®ue
->
±r
 = 
	`sdsRemoveF»eS·û
(key->value->ptr);

1636  
REDISMODULE_OK
;

1637 
	}
}

1647 
	$RM_Li¡Push
(
RedisModuËKey
 *
key
, 
wh”e
, 
RedisModuËSŒšg
 *
–e
) {

1648 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1649 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_LIST
è 
REDISMODULE_ERR
;

1650 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_LIST
);

1651 
	`li¡Ty³Push
(
key
->
v®ue
, 
–e
,

1652 (
wh”e
 =ğ
REDISMODULE_LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
);

1653  
REDISMODULE_OK
;

1654 
	}
}

1663 
RedisModuËSŒšg
 *
	$RM_Li¡Pİ
(
RedisModuËKey
 *
key
, 
wh”e
) {

1664 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
) ||

1665 
key
->
v®ue
 =ğ
NULL
 ||

1666 
key
->
v®ue
->
ty³
 !ğ
OBJ_LIST
è 
NULL
;

1667 
robj
 *
–e
 = 
	`li¡Ty³Pİ
(
key
->
v®ue
,

1668 (
wh”e
 =ğ
REDISMODULE_LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
);

1669 
robj
 *
decoded
 = 
	`g‘DecodedObjeù
(
–e
);

1670 
	`deüRefCouÁ
(
–e
);

1671 
	`moduËD–KeyIfEm±y
(
key
);

1672 
	`autoMemÜyAdd
(
key
->
ùx
,
REDISMODULE_AM_STRING
,
decoded
);

1673  
decoded
;

1674 
	}
}

1682 
	$RM_Z£tAddFÏgsToCÜeFÏgs
(
æags
) {

1683 
»tæags
 = 0;

1684 ià(
æags
 & 
REDISMODULE_ZADD_XX
è
»tæags
 |ğ
ZADD_XX
;

1685 ià(
æags
 & 
REDISMODULE_ZADD_NX
è
»tæags
 |ğ
ZADD_NX
;

1686  
»tæags
;

1687 
	}
}

1690 
	$RM_Z£tAddFÏgsFromCÜeFÏgs
(
æags
) {

1691 
»tæags
 = 0;

1692 ià(
æags
 & 
ZADD_ADDED
è
»tæags
 |ğ
REDISMODULE_ZADD_ADDED
;

1693 ià(
æags
 & 
ZADD_UPDATED
è
»tæags
 |ğ
REDISMODULE_ZADD_UPDATED
;

1694 ià(
æags
 & 
ZADD_NOP
è
»tæags
 |ğ
REDISMODULE_ZADD_NOP
;

1695  
»tæags
;

1696 
	}
}

1726 
	$RM_Z£tAdd
(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
) {

1727 
æags
 = 0;

1728 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1729 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1730 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_ZSET
);

1731 ià(
æag¥Œ
è
æags
 = 
	`RM_Z£tAddFÏgsToCÜeFÏgs
(*flagsptr);

1732 ià(
	`z£tAdd
(
key
->
v®ue
,
scÜe
,
–e
->
±r
,&
æags
,
NULL
) == 0) {

1733 ià(
æag¥Œ
) *flagsptr = 0;

1734  
REDISMODULE_ERR
;

1736 ià(
æag¥Œ
è*æag¥Œ = 
	`RM_Z£tAddFÏgsFromCÜeFÏgs
(
æags
);

1737  
REDISMODULE_OK
;

1738 
	}
}

1753 
	$RM_Z£tInüby
(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
, *
ÃwscÜe
) {

1754 
æags
 = 0;

1755 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1756 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1757 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_ZSET
);

1758 ià(
æag¥Œ
è
æags
 = 
	`RM_Z£tAddFÏgsToCÜeFÏgs
(*flagsptr);

1759 
æags
 |ğ
ZADD_INCR
;

1760 ià(
	`z£tAdd
(
key
->
v®ue
,
scÜe
,
–e
->
±r
,&
æags
,
ÃwscÜe
) == 0) {

1761 ià(
æag¥Œ
) *flagsptr = 0;

1762  
REDISMODULE_ERR
;

1765 ià(
æag¥Œ
 && (*æag¥Œ & 
ZADD_NAN
)) {

1766 *
æag¥Œ
 = 0;

1767  
REDISMODULE_ERR
;

1769 ià(
æag¥Œ
è*æag¥Œ = 
	`RM_Z£tAddFÏgsFromCÜeFÏgs
(
æags
);

1770  
REDISMODULE_OK
;

1771 
	}
}

1791 
	$RM_Z£tRem
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
d–‘ed
) {

1792 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
)è 
REDISMODULE_ERR
;

1793 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1794 ià(
key
->
v®ue
 !ğ
NULL
 && 
	`z£tD–
(key->v®ue,
–e
->
±r
)) {

1795 ià(
d–‘ed
) *deleted = 1;

1797 ià(
d–‘ed
) *deleted = 0;

1799  
REDISMODULE_OK
;

1800 
	}
}

1810 
	$RM_Z£tScÜe
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
scÜe
) {

1811 ià(
key
->
v®ue
 =ğ
NULL
è 
REDISMODULE_ERR
;

1812 ià(
key
->
v®ue
->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1813 ià(
	`z£tScÜe
(
key
->
v®ue
,
–e
->
±r
,
scÜe
è=ğ
C_ERR
è 
REDISMODULE_ERR
;

1814  
REDISMODULE_OK
;

1815 
	}
}

1821 
	$z£tKeyRe£t
(
RedisModuËKey
 *
key
) {

1822 
key
->
zty³
 = 
REDISMODULE_ZSET_RANGE_NONE
;

1823 
key
->
zcu¼’t
 = 
NULL
;

1824 
key
->
z”
 = 1;

1825 
	}
}

1828 
	$RM_Z£tRªgeStİ
(
RedisModuËKey
 *
key
) {

1830 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
)

1831 
	`z¦F»eLexRªge
(&
key
->
zÌs
);

1835 
	`z£tKeyRe£t
(
key
);

1836 
	}
}

1839 
	$RM_Z£tRªgeEndR—ched
(
RedisModuËKey
 *
key
) {

1840  
key
->
z”
;

1841 
	}
}

1849 
	$z£tIn™ScÜeRªge
(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
, 
fœ¡
) {

1850 ià(!
key
->
v®ue
 || key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1852 
	`RM_Z£tRªgeStİ
(
key
);

1853 
key
->
zty³
 = 
REDISMODULE_ZSET_RANGE_SCORE
;

1854 
key
->
z”
 = 0;

1858 
z¿nge¥ec
 *
zrs
 = &
key
->zrs;

1859 
zrs
->
mš
 = min;

1860 
zrs
->
max
 = max;

1861 
zrs
->
mšex
 = minex;

1862 
zrs
->
maxex
 = maxex;

1864 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1865 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`zzlFœ¡InRªge
(key->
v®ue
->
±r
,
zrs
) :

1866 
	`zzlLa¡InRªge
(
key
->
v®ue
->
±r
,
zrs
);

1867 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1868 
z£t
 *
zs
 = 
key
->
v®ue
->
±r
;

1869 
zskli¡
 *
z¦
 = 
zs
->zsl;

1870 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`z¦Fœ¡InRªge
(
z¦
,
zrs
) :

1871 
	`z¦La¡InRªge
(
z¦
,
zrs
);

1873 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1875 ià(
key
->
zcu¼’t
 =ğ
NULL
èkey->
z”
 = 1;

1876  
REDISMODULE_OK
;

1877 
	}
}

1894 
	$RM_Z£tFœ¡InScÜeRªge
(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
) {

1895  
	`z£tIn™ScÜeRªge
(
key
,
mš
,
max
,
mšex
,
maxex
,1);

1896 
	}
}

1900 
	$RM_Z£tLa¡InScÜeRªge
(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
) {

1901  
	`z£tIn™ScÜeRªge
(
key
,
mš
,
max
,
mšex
,
maxex
,0);

1902 
	}
}

1913 
	$z£tIn™LexRªge
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
, 
fœ¡
) {

1914 ià(!
key
->
v®ue
 || key->v®ue->
ty³
 !ğ
OBJ_ZSET
è 
REDISMODULE_ERR
;

1916 
	`RM_Z£tRªgeStİ
(
key
);

1917 
key
->
z”
 = 0;

1921 
zËx¿nge¥ec
 *
zÌs
 = &
key
->zlrs;

1922 ià(
	`z¦P¬£LexRªge
(
mš
, 
max
, 
zÌs
è=ğ
C_ERR
è 
REDISMODULE_ERR
;

1926 
key
->
zty³
 = 
REDISMODULE_ZSET_RANGE_LEX
;

1928 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1929 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`zzlFœ¡InLexRªge
(key->
v®ue
->
±r
,
zÌs
) :

1930 
	`zzlLa¡InLexRªge
(
key
->
v®ue
->
±r
,
zÌs
);

1931 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1932 
z£t
 *
zs
 = 
key
->
v®ue
->
±r
;

1933 
zskli¡
 *
z¦
 = 
zs
->zsl;

1934 
key
->
zcu¼’t
 = 
fœ¡
 ? 
	`z¦Fœ¡InLexRªge
(
z¦
,
zÌs
) :

1935 
	`z¦La¡InLexRªge
(
z¦
,
zÌs
);

1937 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1939 ià(
key
->
zcu¼’t
 =ğ
NULL
èkey->
z”
 = 1;

1941  
REDISMODULE_OK
;

1942 
	}
}

1956 
	$RM_Z£tFœ¡InLexRªge
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
) {

1957  
	`z£tIn™LexRªge
(
key
,
mš
,
max
,1);

1958 
	}
}

1962 
	$RM_Z£tLa¡InLexRªge
(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
) {

1963  
	`z£tIn™LexRªge
(
key
,
mš
,
max
,0);

1964 
	}
}

1969 
RedisModuËSŒšg
 *
	$RM_Z£tRªgeCu¼’tEËm’t
(
RedisModuËKey
 *
key
, *
scÜe
) {

1970 
RedisModuËSŒšg
 *
¡r
;

1972 ià(
key
->
zcu¼’t
 =ğ
NULL
)  NULL;

1973 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1974 *
•Œ
, *
¥Œ
;

1975 
•Œ
 = 
key
->
zcu¼’t
;

1976 
sds
 
–e
 = 
	`zli¡G‘Objeù
(
•Œ
);

1977 ià(
scÜe
) {

1978 
¥Œ
 = 
	`zli¡Next
(
key
->
v®ue
->
±r
,
•Œ
);

1979 *
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1981 
¡r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
–e
);

1982 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1983 
zskli¡Node
 *
Ê
 = 
key
->
zcu¼’t
;

1984 ià(
scÜe
è*scÜğ
Ê
->score;

1985 
¡r
 = 
	`ü—‹SŒšgObjeù
(
Ê
->
–e
,
	`sd¦’
(ln->ele));

1987 
	`£rv”Pªic
("Unsupported zsetƒncoding");

1989 
	`autoMemÜyAdd
(
key
->
ùx
,
REDISMODULE_AM_STRING
,
¡r
);

1990  
¡r
;

1991 
	}
}

1996 
	$RM_Z£tRªgeNext
(
RedisModuËKey
 *
key
) {

1997 ià(!
key
->
zty³
 || !key->
zcu¼’t
)  0;

1999 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2000 *
zl
 = 
key
->
v®ue
->
±r
;

2001 *
•Œ
 = 
key
->
zcu¼’t
;

2002 *
Ãxt
;

2003 
Ãxt
 = 
	`zli¡Next
(
zl
,
•Œ
);

2004 ià(
Ãxt
èÃxˆğ
	`zli¡Next
(
zl
,next);

2005 ià(
Ãxt
 =ğ
NULL
) {

2006 
key
->
z”
 = 1;

2010 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
) {

2013 *
§ved_Ãxt
 = 
Ãxt
;

2014 
Ãxt
 = 
	`zli¡Next
(
zl
,next);

2015 
scÜe
 = 
	`zzlG‘ScÜe
(
Ãxt
);

2016 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
key
->
zrs
)) {

2017 
key
->
z”
 = 1;

2020 
Ãxt
 = 
§ved_Ãxt
;

2021 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

2022 ià(!
	`zzlLexV®ueL‹Max
(
Ãxt
,&
key
->
zÌs
)) {

2023 
key
->
z”
 = 1;

2027 
key
->
zcu¼’t
 = 
Ãxt
;

2030 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2031 
zskli¡Node
 *
Ê
 = 
key
->
zcu¼’t
, *
Ãxt
 =†n->
Ëv–
[0].
fÜw¬d
;

2032 ià(
Ãxt
 =ğ
NULL
) {

2033 
key
->
z”
 = 1;

2037 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
 &&

2038 !
	`z¦V®ueL‹Max
(
Ãxt
->
scÜe
,&
key
->
zrs
))

2040 
key
->
z”
 = 1;

2042 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

2043 ià(!
	`z¦LexV®ueL‹Max
(
Ãxt
->
–e
,&
key
->
zÌs
)) {

2044 
key
->
z”
 = 1;

2048 
key
->
zcu¼’t
 = 
Ãxt
;

2052 
	`£rv”Pªic
("Unsupported zsetƒncoding");

2054 
	}
}

2059 
	$RM_Z£tRªgeP»v
(
RedisModuËKey
 *
key
) {

2060 ià(!
key
->
zty³
 || !key->
zcu¼’t
)  0;

2062 ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2063 *
zl
 = 
key
->
v®ue
->
±r
;

2064 *
•Œ
 = 
key
->
zcu¼’t
;

2065 *
´ev
;

2066 
´ev
 = 
	`zli¡P»v
(
zl
,
•Œ
);

2067 ià(
´ev
è´ev = 
	`zli¡P»v
(
zl
,prev);

2068 ià(
´ev
 =ğ
NULL
) {

2069 
key
->
z”
 = 1;

2073 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
) {

2076 *
§ved_´ev
 = 
´ev
;

2077 
´ev
 = 
	`zli¡Next
(
zl
,prev);

2078 
scÜe
 = 
	`zzlG‘ScÜe
(
´ev
);

2079 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,&
key
->
zrs
)) {

2080 
key
->
z”
 = 1;

2083 
´ev
 = 
§ved_´ev
;

2084 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

2085 ià(!
	`zzlLexV®ueG‹Mš
(
´ev
,&
key
->
zÌs
)) {

2086 
key
->
z”
 = 1;

2090 
key
->
zcu¼’t
 = 
´ev
;

2093 } ià(
key
->
v®ue
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2094 
zskli¡Node
 *
Ê
 = 
key
->
zcu¼’t
, *
´ev
 =†n->
backw¬d
;

2095 ià(
´ev
 =ğ
NULL
) {

2096 
key
->
z”
 = 1;

2100 ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_SCORE
 &&

2101 !
	`z¦V®ueG‹Mš
(
´ev
->
scÜe
,&
key
->
zrs
))

2103 
key
->
z”
 = 1;

2105 } ià(
key
->
zty³
 =ğ
REDISMODULE_ZSET_RANGE_LEX
) {

2106 ià(!
	`z¦LexV®ueG‹Mš
(
´ev
->
–e
,&
key
->
zÌs
)) {

2107 
key
->
z”
 = 1;

2111 
key
->
zcu¼’t
 = 
´ev
;

2115 
	`£rv”Pªic
("Unsupported zsetƒncoding");

2117 
	}
}

2173 
	$RM_HashS‘
(
RedisModuËKey
 *
key
, 
æags
, ...) {

2174 
va_li¡
 
­
;

2175 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
))  0;

2176 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_HASH
)  0;

2177 ià(
key
->
v®ue
 =ğ
NULL
è
	`moduËC»©eEm±yKey
(key,
REDISMODULE_KEYTYPE_HASH
);

2179 
upd©ed
 = 0;

2180 
	`va_¡¬t
(
­
, 
æags
);

2182 
RedisModuËSŒšg
 *
f›ld
, *
v®ue
;

2184 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
) {

2185 *
cf›ld
 = 
	`va_¬g
(
­
,*);

2186 ià(
cf›ld
 =ğ
NULL
) ;

2187 
f›ld
 = 
	`ü—‹RawSŒšgObjeù
(
cf›ld
,
	`¡¾’
(cfield));

2189 
f›ld
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
*);

2190 ià(
f›ld
 =ğ
NULL
) ;

2192 
v®ue
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
*);

2195 ià(
æags
 & (
REDISMODULE_HASH_XX
|
REDISMODULE_HASH_NX
)) {

2196 
exi¡s
 = 
	`hashTy³Exi¡s
(
key
->
v®ue
, 
f›ld
->
±r
);

2197 ià(((
æags
 & 
REDISMODULE_HASH_XX
è&& !
exi¡s
) ||

2198 ((
æags
 & 
REDISMODULE_HASH_NX
è&& 
exi¡s
))

2200 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
è
	`deüRefCouÁ
(
f›ld
);

2206 ià(
v®ue
 =ğ
REDISMODULE_HASH_DELETE
) {

2207 
upd©ed
 +ğ
	`hashTy³D–‘e
(
key
->
v®ue
, 
f›ld
->
±r
);

2208 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
è
	`deüRefCouÁ
(
f›ld
);

2212 
low_æags
 = 
HASH_SET_COPY
;

2216 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
)

2217 
low_æags
 |ğ
HASH_SET_TAKE_FIELD
;

2218 
upd©ed
 +ğ
	`hashTy³S‘
(
key
->
v®ue
, 
f›ld
->
±r
, v®ue->±r, 
low_æags
);

2222 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
) {

2223 
f›ld
->
±r
 = 
NULL
;

2224 
	`deüRefCouÁ
(
f›ld
);

2227 
	`va_’d
(
­
);

2228 
	`moduËD–KeyIfEm±y
(
key
);

2229  
upd©ed
;

2230 
	}
}

2273 
	$RM_HashG‘
(
RedisModuËKey
 *
key
, 
æags
, ...) {

2274 
va_li¡
 
­
;

2275 ià(
key
->
v®ue
 && key->v®ue->
ty³
 !ğ
OBJ_HASH
è 
REDISMODULE_ERR
;

2277 
	`va_¡¬t
(
­
, 
æags
);

2279 
RedisModuËSŒšg
 *
f›ld
, **
v®u•Œ
;

2280 *
exi¡¥Œ
;

2282 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
) {

2283 *
cf›ld
 = 
	`va_¬g
(
­
,*);

2284 ià(
cf›ld
 =ğ
NULL
) ;

2285 
f›ld
 = 
	`ü—‹RawSŒšgObjeù
(
cf›ld
,
	`¡¾’
(cfield));

2287 
f›ld
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
*);

2288 ià(
f›ld
 =ğ
NULL
) ;

2292 ià(
æags
 & 
REDISMODULE_HASH_EXISTS
) {

2293 
exi¡¥Œ
 = 
	`va_¬g
(
­
,*);

2294 ià(
key
->
v®ue
)

2295 *
exi¡¥Œ
 = 
	`hashTy³Exi¡s
(
key
->
v®ue
,
f›ld
->
±r
);

2297 *
exi¡¥Œ
 = 0;

2299 
v®u•Œ
 = 
	`va_¬g
(
­
,
RedisModuËSŒšg
**);

2300 ià(
key
->
v®ue
) {

2301 *
v®u•Œ
 = 
	`hashTy³G‘V®ueObjeù
(
key
->
v®ue
,
f›ld
->
±r
);

2302 ià(*
v®u•Œ
) {

2303 
robj
 *
decoded
 = 
	`g‘DecodedObjeù
(*
v®u•Œ
);

2304 
	`deüRefCouÁ
(*
v®u•Œ
);

2305 *
v®u•Œ
 = 
decoded
;

2307 ià(*
v®u•Œ
)

2308 
	`autoMemÜyAdd
(
key
->
ùx
,
REDISMODULE_AM_STRING
,*
v®u•Œ
);

2310 *
v®u•Œ
 = 
NULL
;

2315 ià(
æags
 & 
REDISMODULE_HASH_CFIELDS
è
	`deüRefCouÁ
(
f›ld
);

2317 
	`va_’d
(
­
);

2318  
REDISMODULE_OK
;

2319 
	}
}

2329 
RedisModuËC®lR•ly
 *
	$moduËC»©eC®lR•lyFromPrÙo
(
RedisModuËCtx
 *
ùx
, 
sds
 
´Ùo
) {

2330 
RedisModuËC®lR•ly
 *
»¶y
 = 
	`zm®loc
((*reply));

2331 
»¶y
->
ùx
 = ctx;

2332 
»¶y
->
´Ùo
 =…roto;

2333 
»¶y
->
´ÙŞ’
 = 
	`sd¦’
(
´Ùo
);

2334 
»¶y
->
æags
 = 
REDISMODULE_REPLYFLAG_TOPARSE
;

2335 
´Ùo
[0]) {

2337 '+': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_STRING
; ;

2338 '-': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_ERROR
; ;

2339 ':': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_INTEGER
; ;

2340 '*': 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_ARRAY
; ;

2341 : 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_UNKNOWN
; ;

2343 ià((
´Ùo
[0] == '*' ||…roto[0] == '$') &&…roto[1] == '-')

2344 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_NULL
;

2345  
»¶y
;

2346 
	}
}

2348 
moduËP¬£C®lR•ly_IÁ
(
RedisModuËC®lR•ly
 *
»¶y
);

2349 
moduËP¬£C®lR•ly_BulkSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
);

2350 
moduËP¬£C®lR•ly_Sim¶eSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
);

2351 
moduËP¬£C®lR•ly_A¼ay
(
RedisModuËC®lR•ly
 *
»¶y
);

2356 
	$moduËP¬£C®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
) {

2357 ià(!(
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_TOPARSE
)) ;

2358 
»¶y
->
æags
 &ğ~
REDISMODULE_REPLYFLAG_TOPARSE
;

2360 
»¶y
->
´Ùo
[0]) {

2361 ':': 
	`moduËP¬£C®lR•ly_IÁ
(
»¶y
); ;

2362 '$': 
	`moduËP¬£C®lR•ly_BulkSŒšg
(
»¶y
); ;

2364 '+': 
	`moduËP¬£C®lR•ly_Sim¶eSŒšg
(
»¶y
); ;

2365 '*': 
	`moduËP¬£C®lR•ly_A¼ay
(
»¶y
); ;

2367 
	}
}

2369 
	$moduËP¬£C®lR•ly_IÁ
(
RedisModuËC®lR•ly
 *
»¶y
) {

2370 *
´Ùo
 = 
»¶y
->proto;

2371 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2373 
	`¡ršg2Î
(
´Ùo
+1,
p
-´Ùo-1,&
»¶y
->
v®
.
Î
);

2374 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2;

2375 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_INTEGER
;

2376 
	}
}

2378 
	$moduËP¬£C®lR•ly_BulkSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
) {

2379 *
´Ùo
 = 
»¶y
->proto;

2380 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2381 
bulkËn
;

2383 
	`¡ršg2Î
(
´Ùo
+1,
p
-´Ùo-1,&
bulkËn
);

2384 ià(
bulkËn
 == -1) {

2385 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2;

2386 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_NULL
;

2388 
»¶y
->
v®
.
¡r
 = 
p
+2;

2389 
»¶y
->
Ën
 = 
bulkËn
;

2390 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2+
bulkËn
+2;

2391 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_STRING
;

2393 
	}
}

2395 
	$moduËP¬£C®lR•ly_Sim¶eSŒšg
(
RedisModuËC®lR•ly
 *
»¶y
) {

2396 *
´Ùo
 = 
»¶y
->proto;

2397 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2399 
»¶y
->
v®
.
¡r
 = 
´Ùo
+1;

2400 
»¶y
->
Ën
 = 
p
-
´Ùo
-1;

2401 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
+2;

2402 
»¶y
->
ty³
 = 
´Ùo
[0] =ğ'+' ? 
REDISMODULE_REPLY_STRING
 :

2403 
REDISMODULE_REPLY_ERROR
;

2404 
	}
}

2406 
	$moduËP¬£C®lR•ly_A¼ay
(
RedisModuËC®lR•ly
 *
»¶y
) {

2407 *
´Ùo
 = 
»¶y
->proto;

2408 *
p
 = 
	`¡rchr
(
´Ùo
+1,'\r');

2409 
¬¿yËn
, 
j
;

2411 
	`¡ršg2Î
(
´Ùo
+1,
p
-´Ùo-1,&
¬¿yËn
);

2412 
p
 += 2;

2414 ià(
¬¿yËn
 == -1) {

2415 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
;

2416 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_NULL
;

2420 
»¶y
->
v®
.
¬¿y
 = 
	`zm®loc
((
RedisModuËC®lR•ly
)*
¬¿yËn
);

2421 
»¶y
->
Ën
 = 
¬¿yËn
;

2422 
j
 = 0; j < 
¬¿yËn
; j++) {

2423 
RedisModuËC®lR•ly
 *
–e
 = 
»¶y
->
v®
.
¬¿y
+
j
;

2424 
–e
->
æags
 = 
REDISMODULE_REPLYFLAG_NESTED
 |

2425 
REDISMODULE_REPLYFLAG_TOPARSE
;

2426 
–e
->
´Ùo
 = 
p
;

2427 
–e
->
ùx
 = 
»¶y
->ctx;

2428 
	`moduËP¬£C®lR•ly
(
–e
);

2429 
p
 +ğ
–e
->
´ÙŞ’
;

2431 
»¶y
->
´ÙŞ’
 = 
p
-
´Ùo
;

2432 
»¶y
->
ty³
 = 
REDISMODULE_REPLY_ARRAY
;

2433 
	}
}

2437 
	$RM_F»eC®lR•ly_Rec
(
RedisModuËC®lR•ly
 *
»¶y
, 
ä“Ã¡ed
){

2441 ià(!
ä“Ã¡ed
 && 
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_NESTED
) ;

2443 ià(!(
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_TOPARSE
)) {

2444 ià(
»¶y
->
ty³
 =ğ
REDISMODULE_REPLY_ARRAY
) {

2445 
size_t
 
j
;

2446 
j
 = 0; j < 
»¶y
->
Ën
; j++)

2447 
	`RM_F»eC®lR•ly_Rec
(
»¶y
->
v®
.
¬¿y
+
j
,1);

2448 
	`zä“
(
»¶y
->
v®
.
¬¿y
);

2456 ià(!(
»¶y
->
æags
 & 
REDISMODULE_REPLYFLAG_NESTED
)) {

2457 ià(
»¶y
->
´Ùo
è
	`sdsä“
(reply->proto);

2458 
	`zä“
(
»¶y
);

2460 
	}
}

2465 
	$RM_F»eC®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
) {

2467 
RedisModuËCtx
 *
ùx
 = 
»¶y
->ctx;

2468 
	`RM_F»eC®lR•ly_Rec
(
»¶y
,0);

2469 
	`autoMemÜyF»ed
(
ùx
,
REDISMODULE_AM_REPLY
,
»¶y
);

2470 
	}
}

2473 
	$RM_C®lR•lyTy³
(
RedisModuËC®lR•ly
 *
»¶y
) {

2474 ià(!
»¶y
è 
REDISMODULE_REPLY_UNKNOWN
;

2475  
»¶y
->
ty³
;

2476 
	}
}

2479 
size_t
 
	$RM_C®lR•lyL’gth
(
RedisModuËC®lR•ly
 *
»¶y
) {

2480 
	`moduËP¬£C®lR•ly
(
»¶y
);

2481 
»¶y
->
ty³
) {

2482 
REDISMODULE_REPLY_STRING
:

2483 
REDISMODULE_REPLY_ERROR
:

2484 
REDISMODULE_REPLY_ARRAY
:

2485  
»¶y
->
Ën
;

2489 
	}
}

2493 
RedisModuËC®lR•ly
 *
	$RM_C®lR•lyA¼ayEËm’t
(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 
idx
) {

2494 
	`moduËP¬£C®lR•ly
(
»¶y
);

2495 ià(
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_ARRAY
è 
NULL
;

2496 ià(
idx
 >ğ
»¶y
->
Ën
è 
NULL
;

2497  
»¶y
->
v®
.
¬¿y
+
idx
;

2498 
	}
}

2501 
	$RM_C®lR•lyIÁeg”
(
RedisModuËC®lR•ly
 *
»¶y
) {

2502 
	`moduËP¬£C®lR•ly
(
»¶y
);

2503 ià(
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_INTEGER
è 
LLONG_MIN
;

2504  
»¶y
->
v®
.
Î
;

2505 
	}
}

2508 cÚ¡ *
	$RM_C®lR•lySŒšgPŒ
(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
) {

2509 
	`moduËP¬£C®lR•ly
(
»¶y
);

2510 ià(
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_STRING
 &&

2511 
»¶y
->
ty³
 !ğ
REDISMODULE_REPLY_ERROR
è 
NULL
;

2512 ià(
Ën
è*ËÀğ
»¶y
->len;

2513  
»¶y
->
v®
.
¡r
;

2514 
	}
}

2518 
RedisModuËSŒšg
 *
	$RM_C»©eSŒšgFromC®lR•ly
(
RedisModuËC®lR•ly
 *
»¶y
) {

2519 
	`moduËP¬£C®lR•ly
(
»¶y
);

2520 
»¶y
->
ty³
) {

2521 
REDISMODULE_REPLY_STRING
:

2522 
REDISMODULE_REPLY_ERROR
:

2523  
	`RM_C»©eSŒšg
(
»¶y
->
ùx
,»¶y->
v®
.
¡r
,»¶y->
Ën
);

2524 
REDISMODULE_REPLY_INTEGER
: {

2525 
buf
[64];

2526 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
»¶y
->
v®
.
Î
);

2527  
	`RM_C»©eSŒšg
(
»¶y
->
ùx
,
buf
,
Ën
);

2529 :  
NULL
;

2531 
	}
}

2545 
	#REDISMODULE_ARGV_REPLICATE
 (1<<0)

	)

2547 
robj
 **
	$moduËC»©eArgvFromU£rFÜm©
(cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, *
¬gı
, *
æags
, 
va_li¡
 
­
) {

2548 
¬gc
 = 0, 
¬gv_size
, 
j
;

2549 
robj
 **
¬gv
 = 
NULL
;

2553 
¬gv_size
 = 
	`¡¾’
(
fmt
)+1;

2554 
¬gv
 = 
	`z»®loc
×rgv,(
robj
*)*
¬gv_size
);

2557 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
(
cmdÇme
,
	`¡¾’
(cmdname));

2558 
¬gc
++;

2561 cÚ¡ *
p
 = 
fmt
;

2562 *
p
) {

2563 ià(*
p
 == 'c') {

2564 *
c¡r
 = 
	`va_¬g
(
­
,*);

2565 
¬gv
[
¬gc
++] = 
	`ü—‹SŒšgObjeù
(
c¡r
,
	`¡¾’
(cstr));

2566 } ià(*
p
 == 's') {

2567 
robj
 *
obj
 = 
	`va_¬g
(
­
,*);

2568 
¬gv
[
¬gc
++] = 
obj
;

2569 
	`šüRefCouÁ
(
obj
);

2570 } ià(*
p
 == 'b') {

2571 *
buf
 = 
	`va_¬g
(
­
,*);

2572 
size_t
 
Ën
 = 
	`va_¬g
(
­
,size_t);

2573 
¬gv
[
¬gc
++] = 
	`ü—‹SŒšgObjeù
(
buf
,
Ën
);

2574 } ià(*
p
 == 'l') {

2575 
Î
 = 
	`va_¬g
(
­
,);

2576 
¬gv
[
¬gc
++] = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sdsäomlÚglÚg
(
Î
));

2577 } ià(*
p
 == 'v') {

2579 
robj
 **
v
 = 
	`va_¬g
(
­
, *);

2580 
size_t
 
vËn
 = 
	`va_¬g
(
­
, size_t);

2585 
¬gv_size
 +ğ
vËn
-1;

2586 
¬gv
 = 
	`z»®loc
×rgv,(
robj
*)*
¬gv_size
);

2588 
size_t
 
i
 = 0;

2589 
i
 = 0; i < 
vËn
; i++) {

2590 
	`šüRefCouÁ
(
v
[
i
]);

2591 
¬gv
[
¬gc
++] = 
v
[
i
];

2593 } ià(*
p
 == '!') {

2594 ià(
æags
è(*æagsè|ğ
REDISMODULE_ARGV_REPLICATE
;

2596 
fm‹¼
;

2598 
p
++;

2600 *
¬gı
 = 
¬gc
;

2601  
¬gv
;

2603 
fm‹¼
:

2604 
j
 = 0; j < 
¬gc
; j++)

2605 
	`deüRefCouÁ
(
¬gv
[
j
]);

2606 
	`zä“
(
¬gv
);

2607  
NULL
;

2608 
	}
}

2616 
RedisModuËC®lR•ly
 *
	$RM_C®l
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...) {

2617 
»disCommªd
 *
cmd
;

2618 
ş›Á
 *
c
 = 
NULL
;

2619 
robj
 **
¬gv
 = 
NULL
;

2620 
¬gc
 = 0, 
æags
 = 0;

2621 
va_li¡
 
­
;

2622 
RedisModuËC®lR•ly
 *
»¶y
 = 
NULL
;

2623 
»¶iÿ‹
 = 0;

2625 
cmd
 = 
	`lookupCommªdByCSŒšg
((*)
cmdÇme
);

2626 ià(!
cmd
) {

2627 
”ºo
 = 
EINVAL
;

2628  
NULL
;

2632 
	`va_¡¬t
(
­
, 
fmt
);

2633 
c
 = 
	`ü—‹Cl›Á
(-1);

2634 
¬gv
 = 
	`moduËC»©eArgvFromU£rFÜm©
(
cmdÇme
,
fmt
,&
¬gc
,&
æags
,
­
);

2635 
»¶iÿ‹
 = 
æags
 & 
REDISMODULE_ARGV_REPLICATE
;

2636 
	`va_’d
(
­
);

2639 
c
->
æags
 |ğ
CLIENT_MODULE
;

2640 
c
->
db
 = 
ùx
->
ş›Á
->db;

2641 
c
->
¬gv
 =‡rgv;

2642 
c
->
¬gc
 =‡rgc;

2643 
c
->
cmd
 = c->
Ï¡cmd
 = cmd;

2646 ià(
¬gv
 =ğ
NULL
è
ş—nup
;

2649 ià((
cmd
->
¬™y
 > 0 && cmd->¬™y !ğ
¬gc
) || (argc < -cmd->arity)) {

2650 
”ºo
 = 
EINVAL
;

2651 
ş—nup
;

2657 ià(
£rv”
.
şu¡”_’abËd
 && !(
ùx
->
ş›Á
->
æags
 & 
CLIENT_MASTER
)) {

2659 
c
->
æags
 &ğ~(
CLIENT_READONLY
|
CLIENT_ASKING
);

2660 
c
->
æags
 |ğ
ùx
->
ş›Á
->æag & (
CLIENT_READONLY
|
CLIENT_ASKING
);

2661 ià(
	`g‘NodeByQu”y
(
c
,c->
cmd
,c->
¬gv
,c->
¬gc
,
NULL
,NULL) !=

2662 
£rv”
.
şu¡”
->
my£lf
)

2664 
”ºo
 = 
EPERM
;

2665 
ş—nup
;

2672 ià(
»¶iÿ‹
è
	`moduËR•liÿ‹MuÉiIfN“ded
(
ùx
);

2675 
ÿÎ_æags
 = 
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
;

2676 ià(
»¶iÿ‹
) {

2677 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_AOF
;

2678 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_REPL
;

2680 
	`ÿÎ
(
c
,
ÿÎ_æags
);

2685 
sds
 
´Ùo
 = 
	`sd¢ewËn
(
c
->
buf
,c->
buåos
);

2686 
c
->
buåos
 = 0;

2687 
	`li¡L’gth
(
c
->
»¶y
)) {

2688 
sds
 
o
 = 
	`li¡NodeV®ue
(
	`li¡Fœ¡
(
c
->
»¶y
));

2690 
´Ùo
 = 
	`sdsÿtsds
ÕrÙo,
o
);

2691 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

2693 
»¶y
 = 
	`moduËC»©eC®lR•lyFromPrÙo
(
ùx
,
´Ùo
);

2694 
	`autoMemÜyAdd
(
ùx
,
REDISMODULE_AM_REPLY
,
»¶y
);

2696 
ş—nup
:

2697 
	`ä“Cl›Á
(
c
);

2698  
»¶y
;

2699 
	}
}

2703 cÚ¡ *
	$RM_C®lR•lyPrÙo
(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
) {

2704 ià(
»¶y
->
´Ùo
è*
Ën
 = 
	`sd¦’
(reply->proto);

2705  
»¶y
->
´Ùo
;

2706 
	}
}

2741 cÚ¡ *
	gModuËTy³NameCh¬S‘
 =

2746 
ušt64_t
 
	$moduËTy³EncodeId
(cÚ¡ *
Çme
, 
’cv”
) {

2749 cÚ¡ *
c£t
 = 
ModuËTy³NameCh¬S‘
;

2750 ià(
	`¡¾’
(
Çme
) != 9)  0;

2751 ià(
’cv”
 < 0 ||ƒncver > 1023)  0;

2753 
ušt64_t
 
id
 = 0;

2754 
j
 = 0; j < 9; j++) {

2755 *
p
 = 
	`¡rchr
(
c£t
,
Çme
[
j
]);

2756 ià(!
p
)  0;

2757 
pos
 = 
p
-
c£t
;

2758 
id
 = (id << 6è| 
pos
;

2760 
id
 = (id << 10è| 
’cv”
;

2761  
id
;

2762 
	}
}

2767 
moduËTy³
 *
	$moduËTy³LookupModuËByName
(cÚ¡ *
Çme
) {

2768 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
moduËs
);

2769 
diùEÁry
 *
de
;

2771 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2772 
RedisModuË
 *
moduË
 = 
	`diùG‘V®
(
de
);

2773 
li¡I‹r
 
li
;

2774 
li¡Node
 *
Ê
;

2776 
	`li¡Rewšd
(
moduË
->
ty³s
,&
li
);

2777 (
Ê
 = 
	`li¡Next
(&
li
))) {

2778 
moduËTy³
 *
mt
 = 
Ê
->
v®ue
;

2779 ià(
	`memcmp
(
Çme
,
mt
->name,(mt->name)) == 0) {

2780 
	`diùR–—£I‹¿tÜ
(
di
);

2781  
mt
;

2785 
	`diùR–—£I‹¿tÜ
(
di
);

2786  
NULL
;

2787 
	}
}

2792 
	#MODULE_LOOKUP_CACHE_SIZE
 3

	)

2794 
moduËTy³
 *
	$moduËTy³LookupModuËByID
(
ušt64_t
 
id
) {

2796 
ušt64_t
 
id
;

2797 
moduËTy³
 *
mt
;

2798 } 
ÿche
[
MODULE_LOOKUP_CACHE_SIZE
];

2801 
j
;

2802 
j
 = 0; j < 
MODULE_LOOKUP_CACHE_SIZE
 && 
ÿche
[j].
mt
 !ğ
NULL
; j++)

2803 ià(
ÿche
[
j
].
id
 =ğidè cache[j].
mt
;

2806 
moduËTy³
 *
mt
 = 
NULL
;

2807 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
moduËs
);

2808 
diùEÁry
 *
de
;

2810 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
 && 
mt
 == NULL) {

2811 
RedisModuË
 *
moduË
 = 
	`diùG‘V®
(
de
);

2812 
li¡I‹r
 
li
;

2813 
li¡Node
 *
Ê
;

2815 
	`li¡Rewšd
(
moduË
->
ty³s
,&
li
);

2816 (
Ê
 = 
	`li¡Next
(&
li
))) {

2817 
moduËTy³
 *
this_mt
 = 
Ê
->
v®ue
;

2820 ià(
this_mt
->
id
 >> 10 == id >> 10) {

2821 
mt
 = 
this_mt
;

2826 
	`diùR–—£I‹¿tÜ
(
di
);

2829 ià(
mt
 && 
j
 < 
MODULE_LOOKUP_CACHE_SIZE
) {

2830 
ÿche
[
j
].
id
 = id;

2831 
ÿche
[
j
].
mt
 = mt;

2833  
mt
;

2834 
	}
}

2840 
	$moduËTy³NameByID
(*
Çme
, 
ušt64_t
 
moduËid
) {

2841 cÚ¡ *
c£t
 = 
ModuËTy³NameCh¬S‘
;

2843 
Çme
[9] = '\0';

2844 *
p
 = 
Çme
+8;

2845 
moduËid
 >>= 10;

2846 
j
 = 0; j < 9; j++) {

2847 *
p
-- = 
c£t
[
moduËid
 & 63];

2848 
moduËid
 >>= 6;

2850 
	}
}

2916 
moduËTy³
 *
	$RM_C»©eD©aTy³
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
’cv”
, *
ty³m‘hods_±r
) {

2917 
ušt64_t
 
id
 = 
	`moduËTy³EncodeId
(
Çme
,
’cv”
);

2918 ià(
id
 =ğ0è 
NULL
;

2919 ià(
	`moduËTy³LookupModuËByName
(
Çme
è!ğ
NULL
)  NULL;

2921 
ty³m‘hods_v”siÚ
 = ((*)
ty³m‘hods_±r
)[0];

2922 ià(
ty³m‘hods_v”siÚ
 =ğ0è 
NULL
;

2924 
	sty³m‘hods
 {

2925 
ušt64_t
 
v”siÚ
;

2926 
moduËTy³LßdFunc
 
rdb_lßd
;

2927 
moduËTy³SaveFunc
 
rdb_§ve
;

2928 
moduËTy³Rewr™eFunc
 
aof_»wr™e
;

2929 
moduËTy³MemU§geFunc
 
mem_u§ge
;

2930 
moduËTy³Dige¡Func
 
dige¡
;

2931 
moduËTy³F»eFunc
 
ä“
;

2932 } *
tms
 = (
ty³m‘hods
*è
ty³m‘hods_±r
;

2934 
moduËTy³
 *
mt
 = 
	`zÿÎoc
((*mt));

2935 
mt
->
id
 = id;

2936 
mt
->
moduË
 = 
ùx
->module;

2937 
mt
->
rdb_lßd
 = 
tms
->rdb_load;

2938 
mt
->
rdb_§ve
 = 
tms
->rdb_save;

2939 
mt
->
aof_»wr™e
 = 
tms
->aof_rewrite;

2940 
mt
->
mem_u§ge
 = 
tms
->mem_usage;

2941 
mt
->
dige¡
 = 
tms
->digest;

2942 
mt
->
ä“
 = 
tms
->free;

2943 
	`memıy
(
mt
->
Çme
,name,(mt->name));

2944 
	`li¡AddNodeTa
(
ùx
->
moduË
->
ty³s
,
mt
);

2945  
mt
;

2946 
	}
}

2952 
	$RM_ModuËTy³S‘V®ue
(
RedisModuËKey
 *
key
, 
moduËTy³
 *
mt
, *
v®ue
) {

2953 ià(!(
key
->
mode
 & 
REDISMODULE_WRITE
è|| key->
™”
è 
REDISMODULE_ERR
;

2954 
	`RM_D–‘eKey
(
key
);

2955 
robj
 *
o
 = 
	`ü—‹ModuËObjeù
(
mt
,
v®ue
);

2956 
	`£tKey
(
key
->
db
,key->key,
o
);

2957 
	`deüRefCouÁ
(
o
);

2958 
key
->
v®ue
 = 
o
;

2959  
REDISMODULE_OK
;

2960 
	}
}

2967 
moduËTy³
 *
	$RM_ModuËTy³G‘Ty³
(
RedisModuËKey
 *
key
) {

2968 ià(
key
 =ğ
NULL
 ||

2969 
key
->
v®ue
 =ğ
NULL
 ||

2970 
	`RM_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_MODULE
è 
NULL
;

2971 
moduËV®ue
 *
mv
 = 
key
->
v®ue
->
±r
;

2972  
mv
->
ty³
;

2973 
	}
}

2981 *
	$RM_ModuËTy³G‘V®ue
(
RedisModuËKey
 *
key
) {

2982 ià(
key
 =ğ
NULL
 ||

2983 
key
->
v®ue
 =ğ
NULL
 ||

2984 
	`RM_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_MODULE
è 
NULL
;

2985 
moduËV®ue
 *
mv
 = 
key
->
v®ue
->
±r
;

2986  
mv
->
v®ue
;

2987 
	}
}

2995 
	$moduËRDBLßdE¼Ü
(
RedisModuËIO
 *
io
) {

2996 
	`£rv”Log
(
LL_WARNING
,

3000 
io
->
ty³
->
moduË
->
Çme
,

3001 
io
->
ty³
->
Çme
,

3002 ()
io
->
by‹s
);

3003 
	`ex™
(1);

3004 
	}
}

3009 
	$RM_SaveUnsigÃd
(
RedisModuËIO
 *
io
, 
ušt64_t
 
v®ue
) {

3010 ià(
io
->
”rÜ
) ;

3012 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
RDB_MODULE_OPCODE_UINT
);

3013 ià(
»tv®
 =ğ-1è
§v“¼
;

3014 
io
->
by‹s
 +ğ
»tv®
;

3016 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
v®ue
);

3017 ià(
»tv®
 =ğ-1è
§v“¼
;

3018 
io
->
by‹s
 +ğ
»tv®
;

3021 
§v“¼
:

3022 
io
->
”rÜ
 = 1;

3023 
	}
}

3028 
ušt64_t
 
	$RM_LßdUnsigÃd
(
RedisModuËIO
 *
io
) {

3029 ià(
io
->
v”
 == 2) {

3030 
ušt64_t
 
İcode
 = 
	`rdbLßdL’
(
io
->
rio
,
NULL
);

3031 ià(
İcode
 !ğ
RDB_MODULE_OPCODE_UINT
è
lßd”r
;

3033 
ušt64_t
 
v®ue
;

3034 
»tv®
 = 
	`rdbLßdL’ByRef
(
io
->
rio
, 
NULL
, &
v®ue
);

3035 ià(
»tv®
 =ğ-1è
lßd”r
;

3036  
v®ue
;

3038 
lßd”r
:

3039 
	`moduËRDBLßdE¼Ü
(
io
);

3041 
	}
}

3044 
	$RM_SaveSigÃd
(
RedisModuËIO
 *
io
, 
št64_t
 
v®ue
) {

3045 uniÚ {
ušt64_t
 
u
; 
št64_t
 
i
;} 
cÚv
;

3046 
cÚv
.
i
 = 
v®ue
;

3047 
	`RM_SaveUnsigÃd
(
io
,
cÚv
.
u
);

3048 
	}
}

3051 
št64_t
 
	$RM_LßdSigÃd
(
RedisModuËIO
 *
io
) {

3052 uniÚ {
ušt64_t
 
u
; 
št64_t
 
i
;} 
cÚv
;

3053 
cÚv
.
u
 = 
	`RM_LßdUnsigÃd
(
io
);

3054  
cÚv
.
i
;

3055 
	}
}

3063 
	$RM_SaveSŒšg
(
RedisModuËIO
 *
io
, 
RedisModuËSŒšg
 *
s
) {

3064 ià(
io
->
”rÜ
) ;

3066 
ssize_t
 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
RDB_MODULE_OPCODE_STRING
);

3067 ià(
»tv®
 =ğ-1è
§v“¼
;

3068 
io
->
by‹s
 +ğ
»tv®
;

3070 
»tv®
 = 
	`rdbSaveSŒšgObjeù
(
io
->
rio
, 
s
);

3071 ià(
»tv®
 =ğ-1è
§v“¼
;

3072 
io
->
by‹s
 +ğ
»tv®
;

3075 
§v“¼
:

3076 
io
->
”rÜ
 = 1;

3077 
	}
}

3081 
	$RM_SaveSŒšgBufãr
(
RedisModuËIO
 *
io
, cÚ¡ *
¡r
, 
size_t
 
Ën
) {

3082 ià(
io
->
”rÜ
) ;

3084 
ssize_t
 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
RDB_MODULE_OPCODE_STRING
);

3085 ià(
»tv®
 =ğ-1è
§v“¼
;

3086 
io
->
by‹s
 +ğ
»tv®
;

3088 
»tv®
 = 
	`rdbSaveRawSŒšg
(
io
->
rio
, (*)
¡r
,
Ën
);

3089 ià(
»tv®
 =ğ-1è
§v“¼
;

3090 
io
->
by‹s
 +ğ
»tv®
;

3093 
§v“¼
:

3094 
io
->
”rÜ
 = 1;

3095 
	}
}

3098 *
	$moduËLßdSŒšg
(
RedisModuËIO
 *
io
, 
¶aš
, 
size_t
 *
ËÅŒ
) {

3099 ià(
io
->
v”
 == 2) {

3100 
ušt64_t
 
İcode
 = 
	`rdbLßdL’
(
io
->
rio
,
NULL
);

3101 ià(
İcode
 !ğ
RDB_MODULE_OPCODE_STRING
è
lßd”r
;

3103 *
s
 = 
	`rdbG’”icLßdSŒšgObjeù
(
io
->
rio
,

3104 
¶aš
 ? 
RDB_LOAD_PLAIN
 : 
RDB_LOAD_NONE
, 
ËÅŒ
);

3105 ià(
s
 =ğ
NULL
è
lßd”r
;

3106  
s
;

3108 
lßd”r
:

3109 
	`moduËRDBLßdE¼Ü
(
io
);

3110  
NULL
;

3111 
	}
}

3122 
RedisModuËSŒšg
 *
	$RM_LßdSŒšg
(
RedisModuËIO
 *
io
) {

3123  
	`moduËLßdSŒšg
(
io
,0,
NULL
);

3124 
	}
}

3133 *
	$RM_LßdSŒšgBufãr
(
RedisModuËIO
 *
io
, 
size_t
 *
ËÅŒ
) {

3134  
	`moduËLßdSŒšg
(
io
,1,
ËÅŒ
);

3135 
	}
}

3140 
	$RM_SaveDoubË
(
RedisModuËIO
 *
io
, 
v®ue
) {

3141 ià(
io
->
”rÜ
) ;

3143 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
RDB_MODULE_OPCODE_DOUBLE
);

3144 ià(
»tv®
 =ğ-1è
§v“¼
;

3145 
io
->
by‹s
 +ğ
»tv®
;

3147 
»tv®
 = 
	`rdbSaveBš¬yDoubËV®ue
(
io
->
rio
, 
v®ue
);

3148 ià(
»tv®
 =ğ-1è
§v“¼
;

3149 
io
->
by‹s
 +ğ
»tv®
;

3152 
§v“¼
:

3153 
io
->
”rÜ
 = 1;

3154 
	}
}

3158 
	$RM_LßdDoubË
(
RedisModuËIO
 *
io
) {

3159 ià(
io
->
v”
 == 2) {

3160 
ušt64_t
 
İcode
 = 
	`rdbLßdL’
(
io
->
rio
,
NULL
);

3161 ià(
İcode
 !ğ
RDB_MODULE_OPCODE_DOUBLE
è
lßd”r
;

3163 
v®ue
;

3164 
»tv®
 = 
	`rdbLßdBš¬yDoubËV®ue
(
io
->
rio
, &
v®ue
);

3165 ià(
»tv®
 =ğ-1è
lßd”r
;

3166  
v®ue
;

3168 
lßd”r
:

3169 
	`moduËRDBLßdE¼Ü
(
io
);

3171 
	}
}

3176 
	$RM_SaveFlßt
(
RedisModuËIO
 *
io
, 
v®ue
) {

3177 ià(
io
->
”rÜ
) ;

3179 
»tv®
 = 
	`rdbSaveL’
(
io
->
rio
, 
RDB_MODULE_OPCODE_FLOAT
);

3180 ià(
»tv®
 =ğ-1è
§v“¼
;

3181 
io
->
by‹s
 +ğ
»tv®
;

3183 
»tv®
 = 
	`rdbSaveBš¬yFlßtV®ue
(
io
->
rio
, 
v®ue
);

3184 ià(
»tv®
 =ğ-1è
§v“¼
;

3185 
io
->
by‹s
 +ğ
»tv®
;

3188 
§v“¼
:

3189 
io
->
”rÜ
 = 1;

3190 
	}
}

3194 
	$RM_LßdFlßt
(
RedisModuËIO
 *
io
) {

3195 ià(
io
->
v”
 == 2) {

3196 
ušt64_t
 
İcode
 = 
	`rdbLßdL’
(
io
->
rio
,
NULL
);

3197 ià(
İcode
 !ğ
RDB_MODULE_OPCODE_FLOAT
è
lßd”r
;

3199 
v®ue
;

3200 
»tv®
 = 
	`rdbLßdBš¬yFlßtV®ue
(
io
->
rio
, &
v®ue
);

3201 ià(
»tv®
 =ğ-1è
lßd”r
;

3202  
v®ue
;

3204 
lßd”r
:

3205 
	`moduËRDBLßdE¼Ü
(
io
);

3207 
	}
}

3251 
	$RM_Dige¡AddSŒšgBufãr
(
RedisModuËDige¡
 *
md
, *
–e
, 
size_t
 
Ën
) {

3252 
	`mixDige¡
(
md
->
o
,
–e
,
Ën
);

3253 
	}
}

3257 
	$RM_Dige¡AddLÚgLÚg
(
RedisModuËDige¡
 *
md
, 
Î
) {

3258 
buf
[
LONG_STR_SIZE
];

3259 
size_t
 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
Î
);

3260 
	`mixDige¡
(
md
->
o
,
buf
,
Ën
);

3261 
	}
}

3264 
	$RM_Dige¡EndSequ’û
(
RedisModuËDige¡
 *
md
) {

3265 
	`xÜDige¡
(
md
->
x
,md->
o
,(md->o));

3266 
	`mem£t
(
md
->
o
,0,(md->o));

3267 
	}
}

3278 
	$RM_Em™AOF
(
RedisModuËIO
 *
io
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...) {

3279 ià(
io
->
”rÜ
) ;

3280 
»disCommªd
 *
cmd
;

3281 
robj
 **
¬gv
 = 
NULL
;

3282 
¬gc
 = 0, 
æags
 = 0, 
j
;

3283 
va_li¡
 
­
;

3285 
cmd
 = 
	`lookupCommªdByCSŒšg
((*)
cmdÇme
);

3286 ià(!
cmd
) {

3287 
	`£rv”Log
(
LL_WARNING
,

3290 
io
->
ty³
->
Çme
, 
cmdÇme
);

3291 
io
->
”rÜ
 = 1;

3292 
”ºo
 = 
EINVAL
;

3297 
	`va_¡¬t
(
­
, 
fmt
);

3298 
¬gv
 = 
	`moduËC»©eArgvFromU£rFÜm©
(
cmdÇme
,
fmt
,&
¬gc
,&
æags
,
­
);

3299 
	`va_’d
(
­
);

3300 ià(
¬gv
 =ğ
NULL
) {

3301 
	`£rv”Log
(
LL_WARNING
,

3304 
io
->
ty³
->
Çme
, 
fmt
);

3305 
io
->
”rÜ
 = 1;

3306 
”ºo
 = 
EINVAL
;

3311 ià(!
io
->
”rÜ
 && 
	`rioWr™eBulkCouÁ
(io->
rio
,'*',
¬gc
) == 0)

3312 
io
->
”rÜ
 = 1;

3315 
j
 = 0; j < 
¬gc
; j++) {

3316 ià(!
io
->
”rÜ
 && 
	`rioWr™eBulkObjeù
(io->
rio
,
¬gv
[
j
]) == 0)

3317 
io
->
”rÜ
 = 1;

3318 
	`deüRefCouÁ
(
¬gv
[
j
]);

3320 
	`zä“
(
¬gv
);

3322 
	}
}

3328 
RedisModuËCtx
 *
	$RM_G‘CÚ‹xtFromIO
(
RedisModuËIO
 *
io
) {

3329 ià(
io
->
ùx
)  io->ctx;

3330 
RedisModuËCtx
 
ùx‹m¶©e
 = 
REDISMODULE_CTX_INIT
;

3331 
io
->
ùx
 = 
	`zm®loc
((
RedisModuËCtx
));

3332 *(
io
->
ùx
èğ
ùx‹m¶©e
;

3333 
io
->
ùx
->
moduË
 = io->
ty³
->module;

3334 
io
->
ùx
->
ş›Á
 = 
NULL
;

3335  
io
->
ùx
;

3336 
	}
}

3348 
	$RM_LogRaw
(
RedisModuË
 *
moduË
, cÚ¡ *
Ëv–¡r
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

3349 
msg
[
LOG_MAX_LEN
];

3350 
size_t
 
Çme_Ën
;

3351 
Ëv–
;

3353 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"debug")è
Ëv–
 = 
LL_DEBUG
;

3354 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"v”bo£")è
Ëv–
 = 
LL_VERBOSE
;

3355 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"nÙiû")è
Ëv–
 = 
LL_NOTICE
;

3356 ià(!
	`¡rÿ£cmp
(
Ëv–¡r
,"w¬nšg")è
Ëv–
 = 
LL_WARNING
;

3357 
Ëv–
 = 
LL_VERBOSE
;

3359 
Çme_Ën
 = 
	`¢´štf
(
msg
, (msg),"<%s> ", 
moduË
->
Çme
);

3360 
	`v¢´štf
(
msg
 + 
Çme_Ën
, (msgè-‚ame_Ën, 
fmt
, 
­
);

3361 
	`£rv”LogRaw
(
Ëv–
,
msg
);

3362 
	}
}

3378 
	$RM_Log
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Ëv–¡r
, cÚ¡ *
fmt
, ...) {

3379 ià(!
ùx
->
moduË
) ;

3381 
va_li¡
 
­
;

3382 
	`va_¡¬t
(
­
, 
fmt
);

3383 
	`RM_LogRaw
(
ùx
->
moduË
,
Ëv–¡r
,
fmt
,
­
);

3384 
	`va_’d
(
­
);

3385 
	}
}

3392 
	$RM_LogIOE¼Ü
(
RedisModuËIO
 *
io
, cÚ¡ *
Ëv–¡r
, cÚ¡ *
fmt
, ...) {

3393 
va_li¡
 
­
;

3394 
	`va_¡¬t
(
­
, 
fmt
);

3395 
	`RM_LogRaw
(
io
->
ty³
->
moduË
,
Ëv–¡r
,
fmt
,
­
);

3396 
	`va_’d
(
­
);

3397 
	}
}

3407 
	$moduËBlockedCl›ÁPeR—dabË
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

3408 
	`UNUSED
(
–
);

3409 
	`UNUSED
(
fd
);

3410 
	`UNUSED
(
mask
);

3411 
	`UNUSED
(
´ivd©a
);

3412 
	}
}

3426 
	$unblockCl›ÁFromModuË
(
ş›Á
 *
c
) {

3427 
RedisModuËBlockedCl›Á
 *
bc
 = 
c
->
bpİ
.
moduË_blocked_hªdË
;

3428 
bc
->
ş›Á
 = 
NULL
;

3433 
	`»£tCl›Á
(
c
);

3434 
	}
}

3452 
RedisModuËBlockedCl›Á
 *
	$RM_BlockCl›Á
(
RedisModuËCtx
 *
ùx
, 
RedisModuËCmdFunc
 
»¶y_ÿÎback
, RedisModuËCmdFunø
timeout_ÿÎback
, (*
ä“_´ivd©a
)(*), 
timeout_ms
) {

3453 
ş›Á
 *
c
 = 
ùx
->client;

3454 
i¦ua
 = 
c
->
æags
 & 
CLIENT_LUA
;

3455 
ismuÉi
 = 
c
->
æags
 & 
CLIENT_MULTI
;

3457 
c
->
bpİ
.
moduË_blocked_hªdË
 = 
	`zm®loc
((
RedisModuËBlockedCl›Á
));

3458 
RedisModuËBlockedCl›Á
 *
bc
 = 
c
->
bpİ
.
moduË_blocked_hªdË
;

3464 
bc
->
ş›Á
 = (
i¦ua
 || 
ismuÉi
è? 
NULL
 : 
c
;

3465 
bc
->
moduË
 = 
ùx
->module;

3466 
bc
->
»¶y_ÿÎback
 =„eply_callback;

3467 
bc
->
timeout_ÿÎback
 =imeout_callback;

3468 
bc
->
ä“_´ivd©a
 = free_privdata;

3469 
bc
->
´ivd©a
 = 
NULL
;

3470 
bc
->
»¶y_ş›Á
 = 
	`ü—‹Cl›Á
(-1);

3471 
bc
->
»¶y_ş›Á
->
æags
 |ğ
CLIENT_MODULE
;

3472 
bc
->
dbid
 = 
c
->
db
->
id
;

3473 
c
->
bpİ
.
timeout
 = 
timeout_ms
 ? (
	`m¡ime
()+timeout_ms) : 0;

3475 ià(
i¦ua
 || 
ismuÉi
) {

3476 
c
->
bpİ
.
moduË_blocked_hªdË
 = 
NULL
;

3477 
	`addR•lyE¼Ü
(
c
, 
i¦ua
 ?

3481 
	`blockCl›Á
(
c
,
BLOCKED_MODULE
);

3483  
bc
;

3484 
	}
}

3497 
	$RM_UnblockCl›Á
(
RedisModuËBlockedCl›Á
 *
bc
, *
´ivd©a
) {

3498 
	`±h»ad_mu‹x_lock
(&
moduËUnblockedCl›ÁsMu‹x
);

3499 
bc
->
´ivd©a
 =…rivdata;

3500 
	`li¡AddNodeTa
(
moduËUnblockedCl›Ás
,
bc
);

3501 ià(
	`wr™e
(
£rv”
.
moduË_blocked_pe
[1],"A",1) != 1) {

3504 
	`±h»ad_mu‹x_uÆock
(&
moduËUnblockedCl›ÁsMu‹x
);

3505  
REDISMODULE_OK
;

3506 
	}
}

3510 
	$RM_AbÜtBlock
(
RedisModuËBlockedCl›Á
 *
bc
) {

3511 
bc
->
»¶y_ÿÎback
 = 
NULL
;

3512  
	`RM_UnblockCl›Á
(
bc
,
NULL
);

3513 
	}
}

3523 
	$moduËHªdËBlockedCl›Ás
() {

3524 
li¡Node
 *
Ê
;

3525 
RedisModuËBlockedCl›Á
 *
bc
;

3527 
	`±h»ad_mu‹x_lock
(&
moduËUnblockedCl›ÁsMu‹x
);

3530 
buf
[1];

3531 
	`»ad
(
£rv”
.
moduË_blocked_pe
[0],
buf
,1) == 1);

3532 
	`li¡L’gth
(
moduËUnblockedCl›Ás
)) {

3533 
Ê
 = 
	`li¡Fœ¡
(
moduËUnblockedCl›Ás
);

3534 
bc
 = 
Ê
->
v®ue
;

3535 
ş›Á
 *
c
 = 
bc
->client;

3536 
	`li¡D–Node
(
moduËUnblockedCl›Ás
,
Ê
);

3537 
	`±h»ad_mu‹x_uÆock
(&
moduËUnblockedCl›ÁsMu‹x
);

3544 ià(
c
 && 
bc
->
»¶y_ÿÎback
) {

3545 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

3546 
ùx
.
æags
 |ğ
REDISMODULE_CTX_BLOCKED_REPLY
;

3547 
ùx
.
blocked_´ivd©a
 = 
bc
->
´ivd©a
;

3548 
ùx
.
moduË
 = 
bc
->module;

3549 
ùx
.
ş›Á
 = 
bc
->client;

3550 
bc
->
	`»¶y_ÿÎback
(&
ùx
,(**)
c
->
¬gv
,c->
¬gc
);

3551 
	`moduËHªdËPrİag©iÚAá”CommªdC®lback
(&
ùx
);

3552 
	`moduËF»eCÚ‹xt
(&
ùx
);

3556 ià(
bc
->
´ivd©a
 && bc->
ä“_´ivd©a
)

3557 
bc
->
	`ä“_´ivd©a
(bc->
´ivd©a
);

3563 ià(
c
) {

3564 ià(
bc
->
»¶y_ş›Á
->
buåos
)

3565 
	`addR•lySŒšg
(
c
,
bc
->
»¶y_ş›Á
->
buf
,

3566 
bc
->
»¶y_ş›Á
->
buåos
);

3567 ià(
	`li¡L’gth
(
bc
->
»¶y_ş›Á
->
»¶y
))

3568 
	`li¡Još
(
c
->
»¶y
,
bc
->
»¶y_ş›Á
->reply);

3569 
c
->
»¶y_by‹s
 +ğ
bc
->
»¶y_ş›Á
->reply_bytes;

3571 
	`ä“Cl›Á
(
bc
->
»¶y_ş›Á
);

3573 ià(
c
 !ğ
NULL
) {

3574 
	`unblockCl›Á
(
c
);

3578 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

3579 !(
c
->
æags
 & 
CLIENT_PENDING_WRITE
))

3581 
c
->
æags
 |ğ
CLIENT_PENDING_WRITE
;

3582 
	`li¡AddNodeH—d
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
c
);

3589 
	`zä“
(
bc
);

3592 
	`±h»ad_mu‹x_lock
(&
moduËUnblockedCl›ÁsMu‹x
);

3594 
	`±h»ad_mu‹x_uÆock
(&
moduËUnblockedCl›ÁsMu‹x
);

3595 
	}
}

3601 
	$moduËBlockedCl›ÁTimedOut
(
ş›Á
 *
c
) {

3602 
RedisModuËBlockedCl›Á
 *
bc
 = 
c
->
bpİ
.
moduË_blocked_hªdË
;

3603 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

3604 
ùx
.
æags
 |ğ
REDISMODULE_CTX_BLOCKED_TIMEOUT
;

3605 
ùx
.
moduË
 = 
bc
->module;

3606 
ùx
.
ş›Á
 = 
bc
->client;

3607 
bc
->
	`timeout_ÿÎback
(&
ùx
,(**)
c
->
¬gv
,c->
¬gc
);

3608 
	`moduËF»eCÚ‹xt
(&
ùx
);

3609 
	}
}

3613 
	$RM_IsBlockedR•lyReque¡
(
RedisModuËCtx
 *
ùx
) {

3614  (
ùx
->
æags
 & 
REDISMODULE_CTX_BLOCKED_REPLY
) != 0;

3615 
	}
}

3619 
	$RM_IsBlockedTimeoutReque¡
(
RedisModuËCtx
 *
ùx
) {

3620  (
ùx
->
æags
 & 
REDISMODULE_CTX_BLOCKED_TIMEOUT
) != 0;

3621 
	}
}

3624 *
	$RM_G‘BlockedCl›ÁPriv©eD©a
(
RedisModuËCtx
 *
ùx
) {

3625  
ùx
->
blocked_´ivd©a
;

3626 
	}
}

3651 
RedisModuËCtx
 *
	$RM_G‘Th»adSaãCÚ‹xt
(
RedisModuËBlockedCl›Á
 *
bc
) {

3652 
RedisModuËCtx
 *
ùx
 = 
	`zm®loc
((*ctx));

3653 
RedisModuËCtx
 
em±y
 = 
REDISMODULE_CTX_INIT
;

3654 
	`memıy
(
ùx
,&
em±y
,(empty));

3655 ià(
bc
) {

3656 
ùx
->
blocked_ş›Á
 = 
bc
;

3657 
ùx
->
moduË
 = 
bc
->module;

3659 
ùx
->
æags
 |ğ
REDISMODULE_CTX_THREAD_SAFE
;

3664 
ùx
->
ş›Á
 = 
	`ü—‹Cl›Á
(-1);

3665 ià(
bc
è
	`£ËùDb
(
ùx
->
ş›Á
,bc->
dbid
);

3666  
ùx
;

3667 
	}
}

3670 
	$RM_F»eTh»adSaãCÚ‹xt
(
RedisModuËCtx
 *
ùx
) {

3671 
	`moduËF»eCÚ‹xt
(
ùx
);

3672 
	`zä“
(
ùx
);

3673 
	}
}

3678 
	$RM_Th»adSaãCÚ‹xtLock
(
RedisModuËCtx
 *
ùx
) {

3679 
	`DICT_NOTUSED
(
ùx
);

3680 
	`moduËAcquœeGIL
();

3681 
	}
}

3684 
	$RM_Th»adSaãCÚ‹xtUÆock
(
RedisModuËCtx
 *
ùx
) {

3685 
	`DICT_NOTUSED
(
ùx
);

3686 
	`moduËR–—£GIL
();

3687 
	}
}

3689 
	$moduËAcquœeGIL
() {

3690 
	`±h»ad_mu‹x_lock
(&
moduËGIL
);

3691 
	}
}

3693 
	$moduËR–—£GIL
() {

3694 
	`±h»ad_mu‹x_uÆock
(&
moduËGIL
);

3695 
	}
}

3751 
	$RM_SubsüibeToKey¥aûEv’ts
(
RedisModuËCtx
 *
ùx
, 
ty³s
, 
RedisModuËNÙifiÿtiÚFunc
 
ÿÎback
) {

3752 
RedisModuËKey¥aûSubsüib”
 *
sub
 = 
	`zm®loc
((*sub));

3753 
sub
->
moduË
 = 
ùx
->module;

3754 
sub
->
ev’t_mask
 = 
ty³s
;

3755 
sub
->
nÙify_ÿÎback
 = 
ÿÎback
;

3756 
sub
->
aùive
 = 0;

3758 
	`li¡AddNodeTa
(
moduËKey¥aûSubsüib”s
, 
sub
);

3759  
REDISMODULE_OK
;

3760 
	}
}

3765 
	$moduËNÙifyKey¥aûEv’t
(
ty³
, cÚ¡ *
ev’t
, 
robj
 *
key
, 
dbid
) {

3767 ià(
	`li¡L’gth
(
moduËKey¥aûSubsüib”s
) == 0) ;

3769 
li¡I‹r
 
li
;

3770 
li¡Node
 *
Ê
;

3771 
	`li¡Rewšd
(
moduËKey¥aûSubsüib”s
,&
li
);

3774 
ty³
 &ğ~(
NOTIFY_KEYEVENT
 | 
NOTIFY_KEYSPACE
);

3776 (
Ê
 = 
	`li¡Next
(&
li
))) {

3777 
RedisModuËKey¥aûSubsüib”
 *
sub
 = 
Ê
->
v®ue
;

3780 ià((
sub
->
ev’t_mask
 & 
ty³
è&& sub->
aùive
 == 0) {

3781 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

3782 
ùx
.
moduË
 = 
sub
->module;

3783 
ùx
.
ş›Á
 = 
moduËKey¥aûSubsüib”sCl›Á
;

3784 
	`£ËùDb
(
ùx
.
ş›Á
, 
dbid
);

3789 
sub
->
aùive
 = 1;

3790 
sub
->
	`nÙify_ÿÎback
(&
ùx
, 
ty³
, 
ev’t
, 
key
);

3791 
sub
->
aùive
 = 0;

3792 
	`moduËF»eCÚ‹xt
(&
ùx
);

3795 
	}
}

3798 
	$moduËUnsubsüibeNÙifiÿtiÚs
(
RedisModuË
 *
moduË
) {

3799 
li¡I‹r
 
li
;

3800 
li¡Node
 *
Ê
;

3801 
	`li¡Rewšd
(
moduËKey¥aûSubsüib”s
,&
li
);

3802 (
Ê
 = 
	`li¡Next
(&
li
))) {

3803 
RedisModuËKey¥aûSubsüib”
 *
sub
 = 
Ê
->
v®ue
;

3804 ià(
sub
->
moduË
 == module) {

3805 
	`li¡D–Node
(
moduËKey¥aûSubsüib”s
, 
Ê
);

3806 
	`zä“
(
sub
);

3809 
	}
}

3818 
ušt64_t
 
	$diùCSŒšgKeyHash
(cÚ¡ *
key
) {

3819  
	`diùG’HashFunùiÚ
((*)
key
, 
	`¡¾’
((*)key));

3820 
	}
}

3822 
	$diùCSŒšgKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

3823 
	`DICT_NOTUSED
(
´ivd©a
);

3824  
	`¡rcmp
(
key1
,
key2
) == 0;

3825 
	}
}

3827 
diùTy³
 
	gmoduËAPIDiùTy³
 = {

3828 
diùCSŒšgKeyHash
,

3829 
NULL
,

3830 
NULL
,

3831 
diùCSŒšgKeyCom·»
,

3832 
NULL
,

3833 
NULL


3836 
	$moduËRegi¡”Api
(cÚ¡ *
funúame
, *
funıŒ
) {

3837  
	`diùAdd
(
£rv”
.
moduË­i
, (*)
funúame
, 
funıŒ
);

3838 
	}
}

3840 
	#REGISTER_API
(
Çme
) \

3841 
	`moduËRegi¡”Api
("RedisModuË_" #Çme, (*)()
RM_
 ## 
Çme
)

	)

3844 
moduËRegi¡”CÜeAPI
();

3846 
	$moduËIn™ModuËsSy¡em
() {

3847 
moduËUnblockedCl›Ás
 = 
	`li¡C»©e
();

3848 
£rv”
.
lßdmoduË_queue
 = 
	`li¡C»©e
();

3849 
moduËs
 = 
	`diùC»©e
(&
moduËsDiùTy³
,
NULL
);

3852 
moduËKey¥aûSubsüib”s
 = 
	`li¡C»©e
();

3853 
moduËKey¥aûSubsüib”sCl›Á
 = 
	`ü—‹Cl›Á
(-1);

3854 
moduËKey¥aûSubsüib”sCl›Á
->
æags
 |ğ
CLIENT_MODULE
;

3856 
	`moduËRegi¡”CÜeAPI
();

3857 ià(
	`pe
(
£rv”
.
moduË_blocked_pe
) == -1) {

3858 
	`£rv”Log
(
LL_WARNING
,

3860 
	`¡»¼Ü
(
”ºo
));

3861 
	`ex™
(1);

3865 
	`ª‘NÚBlock
(
NULL
,
£rv”
.
moduË_blocked_pe
[0]);

3866 
	`ª‘NÚBlock
(
NULL
,
£rv”
.
moduË_blocked_pe
[1]);

3870 
	`±h»ad_mu‹x_lock
(&
moduËGIL
);

3871 
	}
}

3882 
	$moduËLßdFromQueue
() {

3883 
li¡I‹r
 
li
;

3884 
li¡Node
 *
Ê
;

3886 
	`li¡Rewšd
(
£rv”
.
lßdmoduË_queue
,&
li
);

3887 (
Ê
 = 
	`li¡Next
(&
li
))) {

3888 
moduËLßdQueueEÁry
 *
lßdmod
 = 
Ê
->
v®ue
;

3889 ià(
	`moduËLßd
(
lßdmod
->
·th
,(**îßdmod->
¬gv
,lßdmod->
¬gc
)

3890 =ğ
C_ERR
)

3892 
	`£rv”Log
(
LL_WARNING
,

3894 
lßdmod
->
·th
);

3895 
	`ex™
(1);

3898 
	}
}

3900 
	$moduËF»eModuËSŒuùu»
(
RedisModuË
 *
moduË
) {

3901 
	`li¡R–—£
(
moduË
->
ty³s
);

3902 
	`sdsä“
(
moduË
->
Çme
);

3903 
	`zä“
(
moduË
);

3904 
	}
}

3906 
	$moduËUÄegi¡”Commªds
(
RedisModuË
 *
moduË
) {

3908 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
commªds
);

3909 
diùEÁry
 *
de
;

3910 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3911 
»disCommªd
 *
cmd
 = 
	`diùG‘V®
(
de
);

3912 ià(
cmd
->
´oc
 =ğ
RedisModuËCommªdDi¥©ch”
) {

3913 
RedisModuËCommªdProxy
 *
ı
 =

3914 (*)()
cmd
->
g‘keys_´oc
;

3915 
sds
 
cmdÇme
 = 
ı
->
»discmd
->
Çme
;

3916 ià(
ı
->
moduË
 == module) {

3917 
	`diùD–‘e
(
£rv”
.
commªds
,
cmdÇme
);

3918 
	`diùD–‘e
(
£rv”
.
Üig_commªds
,
cmdÇme
);

3919 
	`sdsä“
(
cmdÇme
);

3920 
	`zä“
(
ı
->
»discmd
);

3921 
	`zä“
(
ı
);

3925 
	`diùR–—£I‹¿tÜ
(
di
);

3926 
	}
}

3930 
	$moduËLßd
(cÚ¡ *
·th
, **
moduË_¬gv
, 
moduË_¬gc
) {

3931 (*
Úlßd
)(*, **, );

3932 *
hªdË
;

3933 
RedisModuËCtx
 
ùx
 = 
REDISMODULE_CTX_INIT
;

3935 
hªdË
 = 
	`dlİ’
(
·th
,
RTLD_NOW
|
RTLD_LOCAL
);

3936 ià(
hªdË
 =ğ
NULL
) {

3937 
	`£rv”Log
(
LL_WARNING
, "ModuË % çedØlßd: %s", 
·th
, 
	`dË¼Ü
());

3938  
C_ERR
;

3940 
Úlßd
 = ((*)(*, **, ))(è
	`dlsym
(
hªdË
,"RedisModule_OnLoad");

3941 ià(
Úlßd
 =ğ
NULL
) {

3942 
	`£rv”Log
(
LL_WARNING
,

3944 "symbŞ. ModuË‚Ù†ßded.",
·th
);

3945  
C_ERR
;

3947 ià(
	`Úlßd
((*)&
ùx
,
moduË_¬gv
,
moduË_¬gc
è=ğ
REDISMODULE_ERR
) {

3948 ià(
ùx
.
moduË
) {

3949 
	`moduËUÄegi¡”Commªds
(
ùx
.
moduË
);

3950 
	`moduËF»eModuËSŒuùu»
(
ùx
.
moduË
);

3952 
	`dlşo£
(
hªdË
);

3953 
	`£rv”Log
(
LL_WARNING
,

3954 "ModuË % š™Ÿliz©iÚ faed. ModuË‚Ù†ßded",
·th
);

3955  
C_ERR
;

3959 
	`diùAdd
(
moduËs
,
ùx
.
moduË
->
Çme
,ctx.module);

3960 
ùx
.
moduË
->
hªdË
 = handle;

3961 
	`£rv”Log
(
LL_NOTICE
,"ModuË '%s'†ßded from %s",
ùx
.
moduË
->
Çme
,
·th
);

3962 
	`moduËF»eCÚ‹xt
(&
ùx
);

3963  
C_OK
;

3964 
	}
}

3973 
	$moduËUÆßd
(
sds
 
Çme
) {

3974 
RedisModuË
 *
moduË
 = 
	`diùF‘chV®ue
(
moduËs
,
Çme
);

3976 ià(
moduË
 =ğ
NULL
) {

3977 
”ºo
 = 
ENOENT
;

3978  
REDISMODULE_ERR
;

3981 ià(
	`li¡L’gth
(
moduË
->
ty³s
)) {

3982 
”ºo
 = 
EBUSY
;

3983  
REDISMODULE_ERR
;

3986 
	`moduËUÄegi¡”Commªds
(
moduË
);

3989 
	`moduËUnsubsüibeNÙifiÿtiÚs
(
moduË
);

3994 ià(
	`dlşo£
(
moduË
->
hªdË
) == -1) {

3995 *
”rÜ
 = 
	`dË¼Ü
();

3996 ià(
”rÜ
 =ğ
NULL
)ƒrror = "Unknownƒrror";

3997 
	`£rv”Log
(
LL_WARNING
,"Error whenryingo closehe %s module: %s",

3998 
moduË
->
Çme
, 
”rÜ
);

4002 
	`£rv”Log
(
LL_NOTICE
,"ModuË % uÆßded",
moduË
->
Çme
);

4003 
	`diùD–‘e
(
moduËs
,
moduË
->
Çme
);

4004 
moduË
->
Çme
 = 
NULL
;

4005 
	`moduËF»eModuËSŒuùu»
(
moduË
);

4007  
REDISMODULE_OK
;

4008 
	}
}

4013 
	$moduËCommªd
(
ş›Á
 *
c
) {

4014 *
subcmd
 = 
c
->
¬gv
[1]->
±r
;

4016 ià(!
	`¡rÿ£cmp
(
subcmd
,"lßd"è&& 
c
->
¬gc
 >= 3) {

4017 
robj
 **
¬gv
 = 
NULL
;

4018 
¬gc
 = 0;

4020 ià(
c
->
¬gc
 > 3) {

4021 
¬gc
 = 
c
->argc - 3;

4022 
¬gv
 = &
c
->argv[3];

4025 ià(
	`moduËLßd
(
c
->
¬gv
[2]->
±r
,(**ïrgv,
¬gc
è=ğ
C_OK
)

4026 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4028 
	`addR•lyE¼Ü
(
c
,

4030 } ià(!
	`¡rÿ£cmp
(
subcmd
,"uÆßd"è&& 
c
->
¬gc
 == 3) {

4031 ià(
	`moduËUÆßd
(
c
->
¬gv
[2]->
±r
è=ğ
C_OK
)

4032 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4034 *
”rmsg
;

4035 
”ºo
) {

4036 
ENOENT
:

4037 
”rmsg
 = "no such module withhat‚ame";

4039 
EBUSY
:

4040 
”rmsg
 = "the moduleƒxports one or more module-side dataypes, can't unload";

4043 
”rmsg
 = "operation‚ot…ossible.";

4046 
	`addR•lyE¼ÜFÜm©
(
c
,"E¼Ü uÆßdšg moduË: %s",
”rmsg
);

4048 } ià(!
	`¡rÿ£cmp
(
subcmd
,"li¡"è&& 
c
->
¬gc
 == 2) {

4049 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
moduËs
);

4050 
diùEÁry
 *
de
;

4052 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
moduËs
));

4053 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4054 
sds
 
Çme
 = 
	`diùG‘Key
(
de
);

4055 
RedisModuË
 *
moduË
 = 
	`diùG‘V®
(
de
);

4056 
	`addR•lyMuÉiBulkL’
(
c
,4);

4057 
	`addR•lyBulkCSŒšg
(
c
,"name");

4058 
	`addR•lyBulkCBufãr
(
c
,
Çme
,
	`sd¦’
(name));

4059 
	`addR•lyBulkCSŒšg
(
c
,"ver");

4060 
	`addR•lyLÚgLÚg
(
c
,
moduË
->
v”
);

4062 
	`diùR–—£I‹¿tÜ
(
di
);

4064 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4066 
	}
}

4069 
size_t
 
	$moduËCouÁ
() {

4070  
	`diùSize
(
moduËs
);

4071 
	}
}

4075 
	$moduËRegi¡”CÜeAPI
() {

4076 
£rv”
.
moduË­i
 = 
	`diùC»©e
(&
moduËAPIDiùTy³
,
NULL
);

4077 
	`REGISTER_API
(
AÎoc
);

4078 
	`REGISTER_API
(
C®loc
);

4079 
	`REGISTER_API
(
R—Îoc
);

4080 
	`REGISTER_API
(
F»e
);

4081 
	`REGISTER_API
(
SŒdup
);

4082 
	`REGISTER_API
(
C»©eCommªd
);

4083 
	`REGISTER_API
(
S‘ModuËA‰ribs
);

4084 
	`REGISTER_API
(
IsModuËNameBusy
);

4085 
	`REGISTER_API
(
WrÚgAr™y
);

4086 
	`REGISTER_API
(
R•lyW™hLÚgLÚg
);

4087 
	`REGISTER_API
(
R•lyW™hE¼Ü
);

4088 
	`REGISTER_API
(
R•lyW™hSim¶eSŒšg
);

4089 
	`REGISTER_API
(
R•lyW™hA¼ay
);

4090 
	`REGISTER_API
(
R•lyS‘A¼ayL’gth
);

4091 
	`REGISTER_API
(
R•lyW™hSŒšg
);

4092 
	`REGISTER_API
(
R•lyW™hSŒšgBufãr
);

4093 
	`REGISTER_API
(
R•lyW™hNuÎ
);

4094 
	`REGISTER_API
(
R•lyW™hC®lR•ly
);

4095 
	`REGISTER_API
(
R•lyW™hDoubË
);

4096 
	`REGISTER_API
(
G‘S–eùedDb
);

4097 
	`REGISTER_API
(
S–eùDb
);

4098 
	`REGISTER_API
(
O³nKey
);

4099 
	`REGISTER_API
(
Clo£Key
);

4100 
	`REGISTER_API
(
KeyTy³
);

4101 
	`REGISTER_API
(
V®ueL’gth
);

4102 
	`REGISTER_API
(
Li¡Push
);

4103 
	`REGISTER_API
(
Li¡Pİ
);

4104 
	`REGISTER_API
(
SŒšgToLÚgLÚg
);

4105 
	`REGISTER_API
(
SŒšgToDoubË
);

4106 
	`REGISTER_API
(
C®l
);

4107 
	`REGISTER_API
(
C®lR•lyPrÙo
);

4108 
	`REGISTER_API
(
F»eC®lR•ly
);

4109 
	`REGISTER_API
(
C®lR•lyIÁeg”
);

4110 
	`REGISTER_API
(
C®lR•lyTy³
);

4111 
	`REGISTER_API
(
C®lR•lyL’gth
);

4112 
	`REGISTER_API
(
C®lR•lyA¼ayEËm’t
);

4113 
	`REGISTER_API
(
C®lR•lySŒšgPŒ
);

4114 
	`REGISTER_API
(
C»©eSŒšgFromC®lR•ly
);

4115 
	`REGISTER_API
(
C»©eSŒšg
);

4116 
	`REGISTER_API
(
C»©eSŒšgFromLÚgLÚg
);

4117 
	`REGISTER_API
(
C»©eSŒšgFromSŒšg
);

4118 
	`REGISTER_API
(
C»©eSŒšgPrštf
);

4119 
	`REGISTER_API
(
F»eSŒšg
);

4120 
	`REGISTER_API
(
SŒšgPŒL’
);

4121 
	`REGISTER_API
(
AutoMemÜy
);

4122 
	`REGISTER_API
(
R•liÿ‹
);

4123 
	`REGISTER_API
(
R•liÿ‹V”b©im
);

4124 
	`REGISTER_API
(
D–‘eKey
);

4125 
	`REGISTER_API
(
UÆškKey
);

4126 
	`REGISTER_API
(
SŒšgS‘
);

4127 
	`REGISTER_API
(
SŒšgDMA
);

4128 
	`REGISTER_API
(
SŒšgTrunÿ‹
);

4129 
	`REGISTER_API
(
S‘Expœe
);

4130 
	`REGISTER_API
(
G‘Expœe
);

4131 
	`REGISTER_API
(
Z£tAdd
);

4132 
	`REGISTER_API
(
Z£tInüby
);

4133 
	`REGISTER_API
(
Z£tScÜe
);

4134 
	`REGISTER_API
(
Z£tRem
);

4135 
	`REGISTER_API
(
Z£tRªgeStİ
);

4136 
	`REGISTER_API
(
Z£tFœ¡InScÜeRªge
);

4137 
	`REGISTER_API
(
Z£tLa¡InScÜeRªge
);

4138 
	`REGISTER_API
(
Z£tFœ¡InLexRªge
);

4139 
	`REGISTER_API
(
Z£tLa¡InLexRªge
);

4140 
	`REGISTER_API
(
Z£tRªgeCu¼’tEËm’t
);

4141 
	`REGISTER_API
(
Z£tRªgeNext
);

4142 
	`REGISTER_API
(
Z£tRªgeP»v
);

4143 
	`REGISTER_API
(
Z£tRªgeEndR—ched
);

4144 
	`REGISTER_API
(
HashS‘
);

4145 
	`REGISTER_API
(
HashG‘
);

4146 
	`REGISTER_API
(
IsKeysPos™iÚReque¡
);

4147 
	`REGISTER_API
(
KeyAtPos
);

4148 
	`REGISTER_API
(
G‘Cl›ÁId
);

4149 
	`REGISTER_API
(
G‘CÚ‹xtFÏgs
);

4150 
	`REGISTER_API
(
PoŞAÎoc
);

4151 
	`REGISTER_API
(
C»©eD©aTy³
);

4152 
	`REGISTER_API
(
ModuËTy³S‘V®ue
);

4153 
	`REGISTER_API
(
ModuËTy³G‘Ty³
);

4154 
	`REGISTER_API
(
ModuËTy³G‘V®ue
);

4155 
	`REGISTER_API
(
SaveUnsigÃd
);

4156 
	`REGISTER_API
(
LßdUnsigÃd
);

4157 
	`REGISTER_API
(
SaveSigÃd
);

4158 
	`REGISTER_API
(
LßdSigÃd
);

4159 
	`REGISTER_API
(
SaveSŒšg
);

4160 
	`REGISTER_API
(
SaveSŒšgBufãr
);

4161 
	`REGISTER_API
(
LßdSŒšg
);

4162 
	`REGISTER_API
(
LßdSŒšgBufãr
);

4163 
	`REGISTER_API
(
SaveDoubË
);

4164 
	`REGISTER_API
(
LßdDoubË
);

4165 
	`REGISTER_API
(
SaveFlßt
);

4166 
	`REGISTER_API
(
LßdFlßt
);

4167 
	`REGISTER_API
(
Em™AOF
);

4168 
	`REGISTER_API
(
Log
);

4169 
	`REGISTER_API
(
LogIOE¼Ü
);

4170 
	`REGISTER_API
(
SŒšgAµ’dBufãr
);

4171 
	`REGISTER_API
(
R‘ašSŒšg
);

4172 
	`REGISTER_API
(
SŒšgCom·»
);

4173 
	`REGISTER_API
(
G‘CÚ‹xtFromIO
);

4174 
	`REGISTER_API
(
BlockCl›Á
);

4175 
	`REGISTER_API
(
UnblockCl›Á
);

4176 
	`REGISTER_API
(
IsBlockedR•lyReque¡
);

4177 
	`REGISTER_API
(
IsBlockedTimeoutReque¡
);

4178 
	`REGISTER_API
(
G‘BlockedCl›ÁPriv©eD©a
);

4179 
	`REGISTER_API
(
AbÜtBlock
);

4180 
	`REGISTER_API
(
Mli£cÚds
);

4181 
	`REGISTER_API
(
G‘Th»adSaãCÚ‹xt
);

4182 
	`REGISTER_API
(
F»eTh»adSaãCÚ‹xt
);

4183 
	`REGISTER_API
(
Th»adSaãCÚ‹xtLock
);

4184 
	`REGISTER_API
(
Th»adSaãCÚ‹xtUÆock
);

4185 
	`REGISTER_API
(
Dige¡AddSŒšgBufãr
);

4186 
	`REGISTER_API
(
Dige¡AddLÚgLÚg
);

4187 
	`REGISTER_API
(
Dige¡EndSequ’û
);

4188 
	`REGISTER_API
(
SubsüibeToKey¥aûEv’ts
);

4189 
	}
}

	@src/modules/helloblock.c

34 
	#REDISMODULE_EXPERIMENTAL_API


	)

35 
	~"../»dismoduË.h
"

36 
	~<¡dio.h
>

37 
	~<¡dlib.h
>

38 
	~<±h»ad.h
>

39 
	~<uni¡d.h
>

42 
	$H–loBlock_R•ly
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

43 
	`REDISMODULE_NOT_USED
(
¬gv
);

44 
	`REDISMODULE_NOT_USED
(
¬gc
);

45 *
myšt
 = 
	`RedisModuË_G‘BlockedCl›ÁPriv©eD©a
(
ùx
);

46  
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,*
myšt
);

47 
	}
}

50 
	$H–loBlock_Timeout
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

51 
	`REDISMODULE_NOT_USED
(
¬gv
);

52 
	`REDISMODULE_NOT_USED
(
¬gc
);

53  
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"Requestimedout");

54 
	}
}

57 
	$H–loBlock_F»eD©a
(*
´ivd©a
) {

58 
	`RedisModuË_F»e
(
´ivd©a
);

59 
	}
}

63 *
	$H–loBlock_Th»adMaš
(*
¬g
) {

64 **
rg
 = 
¬g
;

65 
RedisModuËBlockedCl›Á
 *
bc
 = 
rg
[0];

66 
d–ay
 = ()
rg
[1];

67 
	`RedisModuË_F»e
(
rg
);

69 
	`¦“p
(
d–ay
);

70 *
r
 = 
	`RedisModuË_AÎoc
(());

71 *
r
 = 
	`¿nd
();

72 
	`RedisModuË_UnblockCl›Á
(
bc
,
r
);

73  
NULL
;

74 
	}
}

79 
	$H–loBlock_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

80 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

81 
d–ay
;

82 
timeout
;

84 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[1],&
d–ay
è!ğ
REDISMODULE_OK
) {

85  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

88 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
timeout
è!ğ
REDISMODULE_OK
) {

89  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

92 
±h»ad_t
 
tid
;

93 
RedisModuËBlockedCl›Á
 *
bc
 = 
	`RedisModuË_BlockCl›Á
(
ùx
,
H–loBlock_R•ly
,
H–loBlock_Timeout
,
H–loBlock_F»eD©a
,
timeout
);

98 **
rg
 = 
	`RedisModuË_AÎoc
((*)*2);

99 
rg
[0] = 
bc
;

100 
rg
[1] = (*)(è
d–ay
;

102 ià(
	`±h»ad_ü—‹
(&
tid
,
NULL
,
H–loBlock_Th»adMaš
,
rg
) != 0) {

103 
	`RedisModuË_AbÜtBlock
(
bc
);

104  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"-ERR Can't starthread");

106  
REDISMODULE_OK
;

107 
	}
}

116 *
	$H–loKeys_Th»adMaš
(*
¬g
) {

117 
RedisModuËBlockedCl›Á
 *
bc
 = 
¬g
;

118 
RedisModuËCtx
 *
ùx
 = 
	`RedisModuË_G‘Th»adSaãCÚ‹xt
(
bc
);

119 
cursÜ
 = 0;

120 
size_t
 
»¶yËn
 = 0;

122 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,
REDISMODULE_POSTPONED_ARRAY_LEN
);

124 
	`RedisModuË_Th»adSaãCÚ‹xtLock
(
ùx
);

125 
RedisModuËC®lR•ly
 *
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,

126 "SCAN","l",()
cursÜ
);

127 
	`RedisModuË_Th»adSaãCÚ‹xtUÆock
(
ùx
);

129 
RedisModuËC®lR•ly
 *
ü_cursÜ
 =

130 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
»¶y
,0);

131 
RedisModuËC®lR•ly
 *
ü_keys
 =

132 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
»¶y
,1);

134 
RedisModuËSŒšg
 *
s
 = 
	`RedisModuË_C»©eSŒšgFromC®lR•ly
(
ü_cursÜ
);

135 
	`RedisModuË_SŒšgToLÚgLÚg
(
s
,&
cursÜ
);

136 
	`RedisModuË_F»eSŒšg
(
ùx
,
s
);

138 
size_t
 
™ems
 = 
	`RedisModuË_C®lR•lyL’gth
(
ü_keys
);

139 
size_t
 
j
 = 0; j < 
™ems
; j++) {

140 
RedisModuËC®lR•ly
 *
–e
 =

141 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
ü_keys
,
j
);

142 
	`RedisModuË_R•lyW™hC®lR•ly
(
ùx
,
–e
);

143 
»¶yËn
++;

145 
	`RedisModuË_F»eC®lR•ly
(
»¶y
);

146 } 
cursÜ
 != 0);

147 
	`RedisModuË_R•lyS‘A¼ayL’gth
(
ùx
,
»¶yËn
);

149 
	`RedisModuË_F»eTh»adSaãCÚ‹xt
(
ùx
);

150 
	`RedisModuË_UnblockCl›Á
(
bc
,
NULL
);

151  
NULL
;

152 
	}
}

158 
	$H–loKeys_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

159 
	`REDISMODULE_NOT_USED
(
¬gv
);

160 ià(
¬gc
 !ğ1è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

162 
±h»ad_t
 
tid
;

167 
RedisModuËBlockedCl›Á
 *
bc
 = 
	`RedisModuË_BlockCl›Á
(
ùx
,
NULL
,NULL,NULL,0);

172 ià(
	`±h»ad_ü—‹
(&
tid
,
NULL
,
H–loKeys_Th»adMaš
,
bc
) != 0) {

173 
	`RedisModuË_AbÜtBlock
(
bc
);

174  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"-ERR Can't starthread");

176  
REDISMODULE_OK
;

177 
	}
}

181 
	$RedisModuË_OnLßd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

182 
	`REDISMODULE_NOT_USED
(
¬gv
);

183 
	`REDISMODULE_NOT_USED
(
¬gc
);

185 ià(
	`RedisModuË_In™
(
ùx
,"h–loblock",1,
REDISMODULE_APIVER_1
)

186 =ğ
REDISMODULE_ERR
)  REDISMODULE_ERR;

188 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.block",

189 
H–loBlock_RedisCommªd
,"",0,0,0è=ğ
REDISMODULE_ERR
)

190  
REDISMODULE_ERR
;

191 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.keys",

192 
H–loKeys_RedisCommªd
,"",0,0,0è=ğ
REDISMODULE_ERR
)

193  
REDISMODULE_ERR
;

195  
REDISMODULE_OK
;

196 
	}
}

	@src/modules/hellotype.c

38 
	~"../»dismoduË.h
"

39 
	~<¡dio.h
>

40 
	~<¡dlib.h
>

41 
	~<ùy³.h
>

42 
	~<¡ršg.h
>

43 
	~<¡dšt.h
>

45 
RedisModuËTy³
 *
	gH–loTy³
;

53 
	sH–loTy³Node
 {

54 
št64_t
 
	mv®ue
;

55 
H–loTy³Node
 *
	mÃxt
;

58 
	sH–loTy³Objeù
 {

59 
H–loTy³Node
 *
	mh—d
;

60 
size_t
 
	mËn
;

63 
H–loTy³Objeù
 *
	$ü—‹H–loTy³Objeù
() {

64 
H–loTy³Objeù
 *
o
;

65 
o
 = 
	`RedisModuË_AÎoc
((*o));

66 
o
->
h—d
 = 
NULL
;

67 
o
->
Ën
 = 0;

68  
o
;

69 
	}
}

71 
	$H–loTy³In£¹
(
H–loTy³Objeù
 *
o
, 
št64_t
 
–e
) {

72 
H–loTy³Node
 *
Ãxt
 = 
o
->
h—d
, *
Ãwnode
, *
´ev
 = 
NULL
;

74 
Ãxt
 &&‚ext->
v®ue
 < 
–e
) {

75 
´ev
 = 
Ãxt
;

76 
Ãxt
 =‚ext->next;

78 
Ãwnode
 = 
	`RedisModuË_AÎoc
((*newnode));

79 
Ãwnode
->
v®ue
 = 
–e
;

80 
Ãwnode
->
Ãxt
 =‚ext;

81 ià(
´ev
) {

82 
´ev
->
Ãxt
 = 
Ãwnode
;

84 
o
->
h—d
 = 
Ãwnode
;

86 
o
->
Ën
++;

87 
	}
}

89 
	$H–loTy³R–—£Objeù
(
H–loTy³Objeù
 *
o
) {

90 
H–loTy³Node
 *
cur
, *
Ãxt
;

91 
cur
 = 
o
->
h—d
;

92 
cur
) {

93 
Ãxt
 = 
cur
->next;

94 
	`RedisModuË_F»e
(
cur
);

95 
cur
 = 
Ãxt
;

97 
	`RedisModuË_F»e
(
o
);

98 
	}
}

103 
	$H–loTy³In£¹_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

104 
	`RedisModuË_AutoMemÜy
(
ùx
);

106 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

107 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

108 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

109 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

110 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
 &&

111 
	`RedisModuË_ModuËTy³G‘Ty³
(
key
è!ğ
H–loTy³
)

113  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

116 
v®ue
;

117 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
v®ue
è!ğ
REDISMODULE_OK
)) {

118  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid value: must be‡ signed 64 bit integer");

122 
H–loTy³Objeù
 *
hto
;

123 ià(
ty³
 =ğ
REDISMODULE_KEYTYPE_EMPTY
) {

124 
hto
 = 
	`ü—‹H–loTy³Objeù
();

125 
	`RedisModuË_ModuËTy³S‘V®ue
(
key
,
H–loTy³
,
hto
);

127 
hto
 = 
	`RedisModuË_ModuËTy³G‘V®ue
(
key
);

131 
	`H–loTy³In£¹
(
hto
,
v®ue
);

133 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
hto
->
Ën
);

134 
	`RedisModuË_R•liÿ‹V”b©im
(
ùx
);

135  
REDISMODULE_OK
;

136 
	}
}

139 
	$H–loTy³Rªge_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

140 
	`RedisModuË_AutoMemÜy
(
ùx
);

142 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

143 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

144 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

145 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

146 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
 &&

147 
	`RedisModuË_ModuËTy³G‘Ty³
(
key
è!ğ
H–loTy³
)

149  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

152 
fœ¡
, 
couÁ
;

153 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
fœ¡
è!ğ
REDISMODULE_OK
 ||

154 
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[3],&
couÁ
è!ğ
REDISMODULE_OK
 ||

155 
fœ¡
 < 0 || 
couÁ
 < 0)

157  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,

161 
H–loTy³Objeù
 *
hto
 = 
	`RedisModuË_ModuËTy³G‘V®ue
(
key
);

162 
H–loTy³Node
 *
node
 = 
hto
 ? hto->
h—d
 : 
NULL
;

163 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,
REDISMODULE_POSTPONED_ARRAY_LEN
);

164 
¬¿yËn
 = 0;

165 
node
 && 
couÁ
--) {

166 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
node
->
v®ue
);

167 
¬¿yËn
++;

168 
node
 =‚ode->
Ãxt
;

170 
	`RedisModuË_R•lyS‘A¼ayL’gth
(
ùx
,
¬¿yËn
);

171  
REDISMODULE_OK
;

172 
	}
}

175 
	$H–loTy³L’_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

176 
	`RedisModuË_AutoMemÜy
(
ùx
);

178 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

179 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

180 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

181 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

182 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
 &&

183 
	`RedisModuË_ModuËTy³G‘Ty³
(
key
è!ğ
H–loTy³
)

185  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

188 
H–loTy³Objeù
 *
hto
 = 
	`RedisModuË_ModuËTy³G‘V®ue
(
key
);

189 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
hto
 ? hto->
Ën
 : 0);

190  
REDISMODULE_OK
;

191 
	}
}

196 *
	$H–loTy³RdbLßd
(
RedisModuËIO
 *
rdb
, 
’cv”
) {

197 ià(
’cv”
 != 0) {

199  
NULL
;

201 
ušt64_t
 
–em’ts
 = 
	`RedisModuË_LßdUnsigÃd
(
rdb
);

202 
H–loTy³Objeù
 *
hto
 = 
	`ü—‹H–loTy³Objeù
();

203 
–em’ts
--) {

204 
št64_t
 
–e
 = 
	`RedisModuË_LßdSigÃd
(
rdb
);

205 
	`H–loTy³In£¹
(
hto
,
–e
);

207  
hto
;

208 
	}
}

210 
	$H–loTy³RdbSave
(
RedisModuËIO
 *
rdb
, *
v®ue
) {

211 
H–loTy³Objeù
 *
hto
 = 
v®ue
;

212 
H–loTy³Node
 *
node
 = 
hto
->
h—d
;

213 
	`RedisModuË_SaveUnsigÃd
(
rdb
,
hto
->
Ën
);

214 
node
) {

215 
	`RedisModuË_SaveSigÃd
(
rdb
,
node
->
v®ue
);

216 
node
 =‚ode->
Ãxt
;

218 
	}
}

220 
	$H–loTy³AofRewr™e
(
RedisModuËIO
 *
aof
, 
RedisModuËSŒšg
 *
key
, *
v®ue
) {

221 
H–loTy³Objeù
 *
hto
 = 
v®ue
;

222 
H–loTy³Node
 *
node
 = 
hto
->
h—d
;

223 
node
) {

224 
	`RedisModuË_Em™AOF
(
aof
,"HELLOTYPE.INSERT","¦",
key
,
node
->
v®ue
);

225 
node
 =‚ode->
Ãxt
;

227 
	}
}

231 
size_t
 
	$H–loTy³MemU§ge
(cÚ¡ *
v®ue
) {

232 cÚ¡ 
H–loTy³Objeù
 *
hto
 = 
v®ue
;

233 
H–loTy³Node
 *
node
 = 
hto
->
h—d
;

234  (*
hto
è+ (*
node
)*hto->
Ën
;

235 
	}
}

237 
	$H–loTy³F»e
(*
v®ue
) {

238 
	`H–loTy³R–—£Objeù
(
v®ue
);

239 
	}
}

241 
	$H–loTy³Dige¡
(
RedisModuËDige¡
 *
md
, *
v®ue
) {

242 
H–loTy³Objeù
 *
hto
 = 
v®ue
;

243 
H–loTy³Node
 *
node
 = 
hto
->
h—d
;

244 
node
) {

245 
	`RedisModuË_Dige¡AddLÚgLÚg
(
md
,
node
->
v®ue
);

246 
node
 =‚ode->
Ãxt
;

248 
	`RedisModuË_Dige¡EndSequ’û
(
md
);

249 
	}
}

253 
	$RedisModuË_OnLßd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

254 
	`REDISMODULE_NOT_USED
(
¬gv
);

255 
	`REDISMODULE_NOT_USED
(
¬gc
);

257 ià(
	`RedisModuË_In™
(
ùx
,"h–lÙy³",1,
REDISMODULE_APIVER_1
)

258 =ğ
REDISMODULE_ERR
)  REDISMODULE_ERR;

260 
RedisModuËTy³M‘hods
 
tm
 = {

261 .
v”siÚ
 = 
REDISMODULE_TYPE_METHOD_VERSION
,

262 .
rdb_lßd
 = 
H–loTy³RdbLßd
,

263 .
rdb_§ve
 = 
H–loTy³RdbSave
,

264 .
aof_»wr™e
 = 
H–loTy³AofRewr™e
,

265 .
mem_u§ge
 = 
H–loTy³MemU§ge
,

266 .
ä“
 = 
H–loTy³F»e
,

267 .
dige¡
 = 
H–loTy³Dige¡


270 
H–loTy³
 = 
	`RedisModuË_C»©eD©aTy³
(
ùx
,"h–lÙy³",0,&
tm
);

271 ià(
H–loTy³
 =ğ
NULL
è 
REDISMODULE_ERR
;

273 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hellotype.insert",

274 
H–loTy³In£¹_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

275  
REDISMODULE_ERR
;

277 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hellotype.range",

278 
H–loTy³Rªge_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

279  
REDISMODULE_ERR
;

281 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hellotype.len",

282 
H–loTy³L’_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

283  
REDISMODULE_ERR
;

285  
REDISMODULE_OK
;

286 
	}
}

	@src/modules/helloworld.c

37 
	~"../»dismoduË.h
"

38 
	~<¡dio.h
>

39 
	~<¡dlib.h
>

40 
	~<ùy³.h
>

41 
	~<¡ršg.h
>

48 
	$H–loSim¶e_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

49 
	`REDISMODULE_NOT_USED
(
¬gv
);

50 
	`REDISMODULE_NOT_USED
(
¬gc
);

51 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
	`RedisModuË_G‘S–eùedDb
(ctx));

52  
REDISMODULE_OK
;

53 
	}
}

61 
	$H–loPushN©ive_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

63 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

65 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

66 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

68 
	`RedisModuË_Li¡Push
(
key
,
REDISMODULE_LIST_TAIL
,
¬gv
[2]);

69 
size_t
 
ÃwËn
 = 
	`RedisModuË_V®ueL’gth
(
key
);

70 
	`RedisModuË_Clo£Key
(
key
);

71 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
ÃwËn
);

72  
REDISMODULE_OK
;

73 
	}
}

80 
	$H–loPushC®l_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

82 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

84 
RedisModuËC®lR•ly
 *
»¶y
;

86 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"RPUSH","ss",
¬gv
[1],argv[2]);

87 
Ën
 = 
	`RedisModuË_C®lR•lyIÁeg”
(
»¶y
);

88 
	`RedisModuË_F»eC®lR•ly
(
»¶y
);

89 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Ën
);

90  
REDISMODULE_OK
;

91 
	}
}

96 
	$H–loPushC®l2_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

98 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

100 
RedisModuËC®lR•ly
 *
»¶y
;

102 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"RPUSH","ss",
¬gv
[1],argv[2]);

103 
	`RedisModuË_R•lyW™hC®lR•ly
(
ùx
,
»¶y
);

104 
	`RedisModuË_F»eC®lR•ly
(
»¶y
);

105  
REDISMODULE_OK
;

106 
	}
}

111 
	$H–loLi¡SumL’_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

113 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

115 
RedisModuËC®lR•ly
 *
»¶y
;

117 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"LRANGE","¦l",
¬gv
[1],()0,()-1);

118 
size_t
 
¡¾’
 = 0;

119 
size_t
 
™ems
 = 
	`RedisModuË_C®lR•lyL’gth
(
»¶y
);

120 
size_t
 
j
;

121 
j
 = 0; j < 
™ems
; j++) {

122 
RedisModuËC®lR•ly
 *
–e
 = 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
»¶y
,
j
);

123 
¡¾’
 +ğ
	`RedisModuË_C®lR•lyL’gth
(
–e
);

125 
	`RedisModuË_F»eC®lR•ly
(
»¶y
);

126 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
¡¾’
);

127  
REDISMODULE_OK
;

128 
	}
}

134 
	$H–loLi¡S¶iû_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

135 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

137 
RedisModuËKey
 *
¤ckey
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

138 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

139 
RedisModuËKey
 *
d¡key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[2],

140 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

143 ià((
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

144 
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_EMPTY
) ||

145 (
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

146 
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_EMPTY
))

148 
	`RedisModuË_Clo£Key
(
¤ckey
);

149 
	`RedisModuË_Clo£Key
(
d¡key
);

150  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

153 
couÁ
;

154 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[3],&
couÁ
è!ğ
REDISMODULE_OK
) ||

155 (
couÁ
 < 0)) {

156 
	`RedisModuË_Clo£Key
(
¤ckey
);

157 
	`RedisModuË_Clo£Key
(
d¡key
);

158  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

161 
couÁ
-- > 0) {

162 
RedisModuËSŒšg
 *
–e
;

164 
–e
 = 
	`RedisModuË_Li¡Pİ
(
¤ckey
,
REDISMODULE_LIST_TAIL
);

165 ià(
–e
 =ğ
NULL
) ;

166 
	`RedisModuË_Li¡Push
(
d¡key
,
REDISMODULE_LIST_HEAD
,
–e
);

167 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

170 
size_t
 
Ën
 = 
	`RedisModuË_V®ueL’gth
(
¤ckey
);

171 
	`RedisModuË_Clo£Key
(
¤ckey
);

172 
	`RedisModuË_Clo£Key
(
d¡key
);

173 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Ën
);

174  
REDISMODULE_OK
;

175 
	}
}

179 
	$H–loLi¡S¶iûAuto_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

180 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

182 
	`RedisModuË_AutoMemÜy
(
ùx
);

184 
RedisModuËKey
 *
¤ckey
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

185 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

186 
RedisModuËKey
 *
d¡key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[2],

187 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

190 ià((
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

191 
	`RedisModuË_KeyTy³
(
¤ckey
è!ğ
REDISMODULE_KEYTYPE_EMPTY
) ||

192 (
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_LIST
 &&

193 
	`RedisModuË_KeyTy³
(
d¡key
è!ğ
REDISMODULE_KEYTYPE_EMPTY
))

195  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

198 
couÁ
;

199 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[3],&
couÁ
è!ğ
REDISMODULE_OK
) ||

200 (
couÁ
 < 0))

202  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

205 
couÁ
-- > 0) {

206 
RedisModuËSŒšg
 *
–e
;

208 
–e
 = 
	`RedisModuË_Li¡Pİ
(
¤ckey
,
REDISMODULE_LIST_TAIL
);

209 ià(
–e
 =ğ
NULL
) ;

210 
	`RedisModuË_Li¡Push
(
d¡key
,
REDISMODULE_LIST_HEAD
,
–e
);

213 
size_t
 
Ën
 = 
	`RedisModuË_V®ueL’gth
(
¤ckey
);

214 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Ën
);

215  
REDISMODULE_OK
;

216 
	}
}

221 
	$H–loRªdA¼ay_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

222 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

223 
couÁ
;

224 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[1],&
couÁ
è!ğ
REDISMODULE_OK
 ||

225 
couÁ
 < 0)

226  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid count");

231 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,
couÁ
);

232 
couÁ
--è
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
	`¿nd
());

233  
REDISMODULE_OK
;

234 
	}
}

240 
	$H–loR•l1_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
)

242 
	`REDISMODULE_NOT_USED
(
¬gv
);

243 
	`REDISMODULE_NOT_USED
(
¬gc
);

244 
	`RedisModuË_AutoMemÜy
(
ùx
);

256 
	`RedisModuË_R•liÿ‹
(
ùx
,"ECHO","c","foo");

260 
	`RedisModuË_C®l
(
ùx
,"INCR","c!","foo");

261 
	`RedisModuË_C®l
(
ùx
,"INCR","c!","bar");

263 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,0);

265  
REDISMODULE_OK
;

266 
	}
}

278 
	$H–loR•l2_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

279 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

281 
	`RedisModuË_AutoMemÜy
(
ùx
);

282 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

283 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

285 ià(
	`RedisModuË_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_LIST
)

286  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

288 
size_t
 
li¡Ën
 = 
	`RedisModuË_V®ueL’gth
(
key
);

289 
sum
 = 0;

292 
li¡Ën
--) {

293 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Li¡Pİ
(
key
,
REDISMODULE_LIST_TAIL
);

294 
v®
;

295 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
–e
,&
v®
è!ğ
REDISMODULE_OK
) val = 0;

296 
v®
++;

297 
sum
 +ğ
v®
;

298 
RedisModuËSŒšg
 *
Ãw–e
 = 
	`RedisModuË_C»©eSŒšgFromLÚgLÚg
(
ùx
,
v®
);

299 
	`RedisModuË_Li¡Push
(
key
,
REDISMODULE_LIST_HEAD
,
Ãw–e
);

301 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
sum
);

302 
	`RedisModuË_R•liÿ‹V”b©im
(
ùx
);

303  
REDISMODULE_OK
;

304 
	}
}

314 
	$H–loToggËCa£_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

315 ià(
¬gc
 !ğ2è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

317 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

318 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

320 
keyty³
 = 
	`RedisModuË_KeyTy³
(
key
);

321 ià(
keyty³
 !ğ
REDISMODULE_KEYTYPE_STRING
 &&

322 
keyty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
)

324 
	`RedisModuË_Clo£Key
(
key
);

325  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

328 ià(
keyty³
 =ğ
REDISMODULE_KEYTYPE_STRING
) {

329 
size_t
 
Ën
, 
j
;

330 *
s
 = 
	`RedisModuË_SŒšgDMA
(
key
,&
Ën
,
REDISMODULE_WRITE
);

331 
j
 = 0; j < 
Ën
; j++) {

332 ià(
	`isuµ”
(
s
[
j
])) {

333 
s
[
j
] = 
	`tŞow”
(s[j]);

335 
s
[
j
] = 
	`touµ”
(s[j]);

340 
	`RedisModuË_Clo£Key
(
key
);

341 
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"OK");

342 
	`RedisModuË_R•liÿ‹V”b©im
(
ùx
);

343  
REDISMODULE_OK
;

344 
	}
}

350 
	$H–loMÜeExpœe_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

351 
	`RedisModuË_AutoMemÜy
(
ùx
);

352 ià(
¬gc
 !ğ3è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

354 
m¡ime_t
 
addms
, 
expœe
;

356 ià(
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
addms
è!ğ
REDISMODULE_OK
)

357  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalidƒxpireime");

359 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

360 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

361 
expœe
 = 
	`RedisModuË_G‘Expœe
(
key
);

362 ià(
expœe
 !ğ
REDISMODULE_NO_EXPIRE
) {

363 
expœe
 +ğ
addms
;

364 
	`RedisModuË_S‘Expœe
(
key
,
expœe
);

366  
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"OK");

367 
	}
}

375 
	$H–loZsumRªge_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

376 
scÜe_¡¬t
, 
scÜe_’d
;

377 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

379 ià(
	`RedisModuË_SŒšgToDoubË
(
¬gv
[2],&
scÜe_¡¬t
è!ğ
REDISMODULE_OK
 ||

380 
	`RedisModuË_SŒšgToDoubË
(
¬gv
[3],&
scÜe_’d
è!ğ
REDISMODULE_OK
)

382  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid„ange");

385 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

386 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

387 ià(
	`RedisModuË_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_ZSET
) {

388  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

391 
scÜesum_a
 = 0;

392 
scÜesum_b
 = 0;

394 
	`RedisModuË_Z£tFœ¡InScÜeRªge
(
key
,
scÜe_¡¬t
,
scÜe_’d
,0,0);

395 !
	`RedisModuË_Z£tRªgeEndR—ched
(
key
)) {

396 
scÜe
;

397 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Z£tRªgeCu¼’tEËm’t
(
key
,&
scÜe
);

398 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

399 
scÜesum_a
 +ğ
scÜe
;

400 
	`RedisModuË_Z£tRªgeNext
(
key
);

402 
	`RedisModuË_Z£tRªgeStİ
(
key
);

404 
	`RedisModuË_Z£tLa¡InScÜeRªge
(
key
,
scÜe_¡¬t
,
scÜe_’d
,0,0);

405 !
	`RedisModuË_Z£tRªgeEndR—ched
(
key
)) {

406 
scÜe
;

407 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Z£tRªgeCu¼’tEËm’t
(
key
,&
scÜe
);

408 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

409 
scÜesum_b
 +ğ
scÜe
;

410 
	`RedisModuË_Z£tRªgeP»v
(
key
);

413 
	`RedisModuË_Z£tRªgeStİ
(
key
);

415 
	`RedisModuË_Clo£Key
(
key
);

417 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,2);

418 
	`RedisModuË_R•lyW™hDoubË
(
ùx
,
scÜesum_a
);

419 
	`RedisModuË_R•lyW™hDoubË
(
ùx
,
scÜesum_b
);

420  
REDISMODULE_OK
;

421 
	}
}

430 
	$H–loLexRªge_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

431 
	`RedisModuË_AutoMemÜy
(
ùx
);

433 ià(
¬gc
 !ğ6è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

435 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

436 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

437 ià(
	`RedisModuË_KeyTy³
(
key
è!ğ
REDISMODULE_KEYTYPE_ZSET
) {

438  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

441 ià(
	`RedisModuË_Z£tFœ¡InLexRªge
(
key
,
¬gv
[2],¬gv[3]è!ğ
REDISMODULE_OK
) {

442  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"invalid„ange");

445 
¬¿yËn
 = 0;

446 
	`RedisModuË_R•lyW™hA¼ay
(
ùx
,
REDISMODULE_POSTPONED_ARRAY_LEN
);

447 !
	`RedisModuË_Z£tRªgeEndR—ched
(
key
)) {

448 
scÜe
;

449 
RedisModuËSŒšg
 *
–e
 = 
	`RedisModuË_Z£tRªgeCu¼’tEËm’t
(
key
,&
scÜe
);

450 
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
–e
);

451 
	`RedisModuË_F»eSŒšg
(
ùx
,
–e
);

452 
	`RedisModuË_Z£tRªgeNext
(
key
);

453 
¬¿yËn
++;

455 
	`RedisModuË_Z£tRªgeStİ
(
key
);

456 
	`RedisModuË_R•lyS‘A¼ayL’gth
(
ùx
,
¬¿yËn
);

457 
	`RedisModuË_Clo£Key
(
key
);

458  
REDISMODULE_OK
;

459 
	}
}

468 
	$H–loHCİy_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

469 
	`RedisModuË_AutoMemÜy
(
ùx
);

471 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

472 
RedisModuËKey
 *
key
 = 
	`RedisModuË_O³nKey
(
ùx
,
¬gv
[1],

473 
REDISMODULE_READ
|
REDISMODULE_WRITE
);

474 
ty³
 = 
	`RedisModuË_KeyTy³
(
key
);

475 ià(
ty³
 !ğ
REDISMODULE_KEYTYPE_HASH
 &&

476 
ty³
 !ğ
REDISMODULE_KEYTYPE_EMPTY
)

478  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,
REDISMODULE_ERRORMSG_WRONGTYPE
);

482 
RedisModuËSŒšg
 *
Şdv®
;

483 
	`RedisModuË_HashG‘
(
key
,
REDISMODULE_HASH_NONE
,
¬gv
[2],&
Şdv®
,
NULL
);

484 ià(
Şdv®
) {

485 
	`RedisModuË_HashS‘
(
key
,
REDISMODULE_HASH_NONE
,
¬gv
[3],
Şdv®
,
NULL
);

487 
	`RedisModuË_R•lyW™hLÚgLÚg
(
ùx
,
Şdv®
 !ğ
NULL
);

488  
REDISMODULE_OK
;

489 
	}
}

509 
	$H–loLeáPad_RedisCommªd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

510 
	`RedisModuË_AutoMemÜy
(
ùx
);

511 
·dËn
;

513 ià(
¬gc
 !ğ4è 
	`RedisModuË_WrÚgAr™y
(
ùx
);

515 ià((
	`RedisModuË_SŒšgToLÚgLÚg
(
¬gv
[2],&
·dËn
è!ğ
REDISMODULE_OK
) ||

516 (
·dËn
< 0)) {

517  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,"ERR invalid…adding†ength");

519 
size_t
 
¡¾’
, 
chËn
;

520 cÚ¡ *
¡r
 = 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[1], &
¡¾’
);

521 cÚ¡ *
ch
 = 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[3], &
chËn
);

525 ià(
¡¾’
 >ğ(
size_t
)
·dËn
)

526  
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
¬gv
[1]);

529 ià(
chËn
 != 1)

530  
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
,

534 
·dËn
 -ğ
¡¾’
;

535 *
buf
 = 
	`RedisModuË_PoŞAÎoc
(
ùx
,
·dËn
+
¡¾’
);

536 
j
 = 0; j < 
·dËn
; j++è
buf
[j] = *
ch
;

537 
	`memıy
(
buf
+
·dËn
,
¡r
,
¡¾’
);

539 
	`RedisModuË_R•lyW™hSŒšgBufãr
(
ùx
,
buf
,
·dËn
+
¡¾’
);

540  
REDISMODULE_OK
;

541 
	}
}

545 
	$RedisModuË_OnLßd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

546 ià(
	`RedisModuË_In™
(
ùx
,"h–lowÜld",1,
REDISMODULE_APIVER_1
)

547 =ğ
REDISMODULE_ERR
)  REDISMODULE_ERR;

550 
j
 = 0; j < 
¬gc
; j++) {

551 cÚ¡ *
s
 = 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[
j
],
NULL
);

552 
	`´štf
("ModuË†ßded w™h ARGV[%d] = %s\n", 
j
, 
s
);

555 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.simple",

556 
H–loSim¶e_RedisCommªd
,"»adÚly",0,0,0è=ğ
REDISMODULE_ERR
)

557  
REDISMODULE_ERR
;

559 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.push.native",

560 
H–loPushN©ive_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

561  
REDISMODULE_ERR
;

563 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.push.call",

564 
H–loPushC®l_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

565  
REDISMODULE_ERR
;

567 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.push.call2",

568 
H–loPushC®l2_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

569  
REDISMODULE_ERR
;

571 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.list.sum.len",

572 
H–loLi¡SumL’_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

573  
REDISMODULE_ERR
;

575 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.list.splice",

576 
H–loLi¡S¶iû_RedisCommªd
,"wr™d’y-oom",1,2,1è=ğ
REDISMODULE_ERR
)

577  
REDISMODULE_ERR
;

579 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.list.splice.auto",

580 
H–loLi¡S¶iûAuto_RedisCommªd
,

581 "wr™d’y-oom",1,2,1è=ğ
REDISMODULE_ERR
)

582  
REDISMODULE_ERR
;

584 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.rand.array",

585 
H–loRªdA¼ay_RedisCommªd
,"»adÚly",0,0,0è=ğ
REDISMODULE_ERR
)

586  
REDISMODULE_ERR
;

588 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.repl1",

589 
H–loR•l1_RedisCommªd
,"wr™e",0,0,0è=ğ
REDISMODULE_ERR
)

590  
REDISMODULE_ERR
;

592 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.repl2",

593 
H–loR•l2_RedisCommªd
,"wr™e",1,1,1è=ğ
REDISMODULE_ERR
)

594  
REDISMODULE_ERR
;

596 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.toggle.case",

597 
H–loToggËCa£_RedisCommªd
,"wr™e",1,1,1è=ğ
REDISMODULE_ERR
)

598  
REDISMODULE_ERR
;

600 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.more.expire",

601 
H–loMÜeExpœe_RedisCommªd
,"wr™e",1,1,1è=ğ
REDISMODULE_ERR
)

602  
REDISMODULE_ERR
;

604 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.zsumrange",

605 
H–loZsumRªge_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

606  
REDISMODULE_ERR
;

608 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.lexrange",

609 
H–loLexRªge_RedisCommªd
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

610  
REDISMODULE_ERR
;

612 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.hcopy",

613 
H–loHCİy_RedisCommªd
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

614  
REDISMODULE_ERR
;

616 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"hello.leftpad",

617 
H–loLeáPad_RedisCommªd
,"",1,1,1è=ğ
REDISMODULE_ERR
)

618  
REDISMODULE_ERR
;

620  
REDISMODULE_OK
;

621 
	}
}

	@src/modules/testmodule.c

33 
	#REDISMODULE_EXPERIMENTAL_API


	)

34 
	~"../»dismoduË.h
"

35 
	~<¡ršg.h
>

40 
	$Te¡M©chR•ly
(
RedisModuËC®lR•ly
 *
»¶y
, *
¡r
) {

41 
RedisModuËSŒšg
 *
my¡r
;

42 
my¡r
 = 
	`RedisModuË_C»©eSŒšgFromC®lR•ly
(
»¶y
);

43 ià(!
my¡r
)  0;

44 cÚ¡ *
±r
 = 
	`RedisModuË_SŒšgPŒL’
(
my¡r
,
NULL
);

45  
	`¡rcmp
(
±r
,
¡r
) == 0;

46 
	}
}

51 
	$Te¡C®l
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

52 
	`REDISMODULE_NOT_USED
(
¬gv
);

53 
	`REDISMODULE_NOT_USED
(
¬gc
);

55 
	`RedisModuË_AutoMemÜy
(
ùx
);

56 
RedisModuËC®lR•ly
 *
»¶y
;

58 
	`RedisModuË_C®l
(
ùx
,"DEL","c","mylist");

59 
RedisModuËSŒšg
 *
my¡r
 = 
	`RedisModuË_C»©eSŒšg
(
ùx
,"foo",3);

60 
	`RedisModuË_C®l
(
ùx
,"RPUSH","c¦","myli¡",
my¡r
,()1234);

61 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,"LRANGE","ccc","mylist","0","-1");

62 
™ems
 = 
	`RedisModuË_C®lR•lyL’gth
(
»¶y
);

63 ià(
™ems
 !ğ2è
ç
;

65 
RedisModuËC®lR•ly
 *
™em0
, *
™em1
;

67 
™em0
 = 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
»¶y
,0);

68 
™em1
 = 
	`RedisModuË_C®lR•lyA¼ayEËm’t
(
»¶y
,1);

69 ià(!
	`Te¡M©chR•ly
(
™em0
,"foo")è
ç
;

70 ià(!
	`Te¡M©chR•ly
(
™em1
,"1234")è
ç
;

72 
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"OK");

73  
REDISMODULE_OK
;

75 
ç
:

76 
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"ERR");

77  
REDISMODULE_OK
;

78 
	}
}

81 
	$Te¡SŒšgAµ’d
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

82 
	`REDISMODULE_NOT_USED
(
¬gv
);

83 
	`REDISMODULE_NOT_USED
(
¬gc
);

85 
RedisModuËSŒšg
 *
s
 = 
	`RedisModuË_C»©eSŒšg
(
ùx
,"foo",3);

86 
	`RedisModuË_SŒšgAµ’dBufãr
(
ùx
,
s
,"bar",3);

87 
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
s
);

88 
	`RedisModuË_F»eSŒšg
(
ùx
,
s
);

89  
REDISMODULE_OK
;

90 
	}
}

93 
	$Te¡SŒšgAµ’dAM
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

94 
	`REDISMODULE_NOT_USED
(
¬gv
);

95 
	`REDISMODULE_NOT_USED
(
¬gc
);

97 
	`RedisModuË_AutoMemÜy
(
ùx
);

98 
RedisModuËSŒšg
 *
s
 = 
	`RedisModuË_C»©eSŒšg
(
ùx
,"foo",3);

99 
	`RedisModuË_R‘ašSŒšg
(
ùx
,
s
);

100 
	`RedisModuË_SŒšgAµ’dBufãr
(
ùx
,
s
,"bar",3);

101 
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
s
);

102 
	`RedisModuË_F»eSŒšg
(
ùx
,
s
);

103  
REDISMODULE_OK
;

104 
	}
}

107 
	$Te¡SŒšgPrštf
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

108 
	`RedisModuË_AutoMemÜy
(
ùx
);

109 ià(
¬gc
 < 3) {

110  
	`RedisModuË_WrÚgAr™y
(
ùx
);

112 
RedisModuËSŒšg
 *
s
 = 
	`RedisModuË_C»©eSŒšgPrštf
(
ùx
,

114 
¬gc
,

115 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[1], 
NULL
),

116 
	`RedisModuË_SŒšgPŒL’
(
¬gv
[2], 
NULL
)

119 
	`RedisModuË_R•lyW™hSŒšg
(
ùx
,
s
);

121  
REDISMODULE_OK
;

122 
	}
}

124 
	$çTe¡
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
msg
) {

125 
	`RedisModuË_R•lyW™hE¼Ü
(
ùx
, 
msg
);

126  
REDISMODULE_ERR
;

127 
	}
}

129 
	$Te¡UÆšk
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

130 
	`RedisModuË_AutoMemÜy
(
ùx
);

131 
	`REDISMODULE_NOT_USED
(
¬gv
);

132 
	`REDISMODULE_NOT_USED
(
¬gc
);

134 
RedisModuËKey
 *
k
 = 
	`RedisModuË_O³nKey
(
ùx
, 
	`RedisModuË_C»©eSŒšgPrštf
(ùx, "uÆšked"), 
REDISMODULE_WRITE
 | 
REDISMODULE_READ
);

135 ià(!
k
è 
	`çTe¡
(
ùx
, "Could‚ot create key");

137 ià(
REDISMODULE_ERR
 =ğ
	`RedisModuË_SŒšgS‘
(
k
, 
	`RedisModuË_C»©eSŒšgPrštf
(
ùx
, "Foobar"))) {

138  
	`çTe¡
(
ùx
, "Could‚ot set string value");

141 
RedisModuËC®lR•ly
 *
»p
 = 
	`RedisModuË_C®l
(
ùx
, "EXISTS", "c", "unlinked");

142 ià(!
»p
 || 
	`RedisModuË_C®lR•lyIÁeg”
(rep) != 1) {

143  
	`çTe¡
(
ùx
, "Key does‚otƒxist before unlink");

146 ià(
REDISMODULE_ERR
 =ğ
	`RedisModuË_UÆškKey
(
k
)) {

147  
	`çTe¡
(
ùx
, "Could‚ot unlink key");

150 
»p
 = 
	`RedisModuË_C®l
(
ùx
, "EXISTS", "c", "unlinked");

151 ià(!
»p
 || 
	`RedisModuË_C®lR•lyIÁeg”
(rep) != 0) {

152  
	`çTe¡
(
ùx
, "Could‚ot verify keyo be unlinked");

154  
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
, "OK");

156 
	}
}

158 
	$NÙifyC®lback
(
RedisModuËCtx
 *
ùx
, 
ty³
, cÚ¡ *
ev’t
,

159 
RedisModuËSŒšg
 *
key
) {

162 
	`RedisModuË_Log
(
ùx
, "nÙiû", "GÙƒv’ˆty³ %d,ƒv’ˆ%s, key %s", 
ty³
,

163 
ev’t
, 
	`RedisModuË_SŒšgPŒL’
(
key
, 
NULL
));

165 
	`RedisModuË_C®l
(
ùx
, "HINCRBY", "csc", "nÙifiÿtiÚs", 
key
, "1");

166  
REDISMODULE_OK
;

167 
	}
}

170 
	$Te¡NÙifiÿtiÚs
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

171 
	`REDISMODULE_NOT_USED
(
¬gv
);

172 
	`REDISMODULE_NOT_USED
(
¬gc
);

174 
	#FAIL
(
msg
, ...) \

176 
	`RedisModuË_Log
(
ùx
, "w¬nšg", "Faed NOTIFY Te¡. R—sÚ: " #msg, ##
__VA_ARGS__
); \

177 
”r
; \

178 }

	)

179 
	`RedisModuË_C®l
(
ùx
, "FLUSHDB", "");

181 
	`RedisModuË_C®l
(
ùx
, "SET", "cc", "foo", "bar");

182 
	`RedisModuË_C®l
(
ùx
, "SET", "cc", "foo", "baz");

183 
	`RedisModuË_C®l
(
ùx
, "SADD", "cc", "bar", "x");

184 
	`RedisModuË_C®l
(
ùx
, "SADD", "cc", "bar", "y");

186 
	`RedisModuË_C®l
(
ùx
, "HSET", "ccc", "baz", "x", "y");

188 
	`RedisModuË_C®l
(
ùx
, "LPUSH", "cc", "l", "y");

189 
	`RedisModuË_C®l
(
ùx
, "LPUSH", "cc", "l", "y");

191 
size_t
 
sz
;

192 cÚ¡ *
»p
;

193 
RedisModuËC®lR•ly
 *
r
 = 
	`RedisModuË_C®l
(
ùx
, "HGET", "cc", "notifications", "foo");

194 ià(
r
 =ğ
NULL
 || 
	`RedisModuË_C®lR•lyTy³
Ôè!ğ
REDISMODULE_REPLY_STRING
) {

195 
	`FAIL
("Wrong or‚o„eply for foo");

197 
»p
 = 
	`RedisModuË_C®lR•lySŒšgPŒ
(
r
, &
sz
);

198 ià(
sz
 !ğ1 || *
»p
 != '2') {

199 
	`FAIL
("GÙ„•ly '%s'.ƒx³ùed '2'", 
	`RedisModuË_C®lR•lySŒšgPŒ
(
r
, 
NULL
));

203 
r
 = 
	`RedisModuË_C®l
(
ùx
, "HGET", "cc", "notifications", "bar");

204 ià(
r
 =ğ
NULL
 || 
	`RedisModuË_C®lR•lyTy³
Ôè!ğ
REDISMODULE_REPLY_STRING
) {

205 
	`FAIL
("Wrong or‚o„eply for bar");

207 
»p
 = 
	`RedisModuË_C®lR•lySŒšgPŒ
(
r
, &
sz
);

208 ià(
sz
 !ğ1 || *
»p
 != '2') {

209 
	`FAIL
("GÙ„•ly '%s'.ƒx³ùed '2'", 
»p
);

213 
r
 = 
	`RedisModuË_C®l
(
ùx
, "HGET", "cc", "notifications", "baz");

214 ià(
r
 =ğ
NULL
 || 
	`RedisModuË_C®lR•lyTy³
Ôè!ğ
REDISMODULE_REPLY_STRING
) {

215 
	`FAIL
("Wrong or‚o„eply for baz");

217 
»p
 = 
	`RedisModuË_C®lR•lySŒšgPŒ
(
r
, &
sz
);

218 ià(
sz
 !ğ1 || *
»p
 != '1') {

219 
	`FAIL
("GÙ„•ly '%.*s'.ƒx³ùed '1'", 
sz
, 
»p
);

223 
r
 = 
	`RedisModuË_C®l
(
ùx
, "HGET", "cc", "notifications", "l");

224 ià(
r
 =ğ
NULL
 || 
	`RedisModuË_C®lR•lyTy³
Ôè!ğ
REDISMODULE_REPLY_NULL
) {

225 
	`FAIL
("Wrong„eply for†");

228 
	`RedisModuË_C®l
(
ùx
, "FLUSHDB", "");

230  
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
, "OK");

231 
”r
:

232 
	`RedisModuË_C®l
(
ùx
, "FLUSHDB", "");

234  
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
, "ERR");

235 
	}
}

238 
	$Te¡CtxFÏgs
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

239 
	`REDISMODULE_NOT_USED
(
¬gc
);

240 
	`REDISMODULE_NOT_USED
(
¬gv
);

242 
	`RedisModuË_AutoMemÜy
(
ùx
);

244 
ok
 = 1;

245 cÚ¡ *
”rSŒšg
 = 
NULL
;

246 #undeà
FAIL


247 
	#FAIL
(
msg
) \

249 
ok
 = 0; \

250 
”rSŒšg
 = 
msg
; \

251 
’d
; \

252 }

	)

254 
æags
 = 
	`RedisModuË_G‘CÚ‹xtFÏgs
(
ùx
);

255 ià(
æags
 == 0) {

256 
	`FAIL
("Got‚o flags");

259 ià(
æags
 & 
REDISMODULE_CTX_FLAGS_LUA
è
	`FAIL
("Lua flag was set");

260 ià(
æags
 & 
REDISMODULE_CTX_FLAGS_MULTI
è
	`FAIL
("Multi flag was set");

262 ià(
æags
 & 
REDISMODULE_CTX_FLAGS_AOF
è
	`FAIL
("AOF Flag was set")

264 
	`RedisModuË_C®l
(
ùx
, "config", "ccc", "set", "appendonly", "yes");

265 
æags
 = 
	`RedisModuË_G‘CÚ‹xtFÏgs
(
ùx
);

266 ià(!(
æags
 & 
REDISMODULE_CTX_FLAGS_AOF
)è
	`FAIL
("AOF Flag‚ot set‡fter config set");

268 ià(
æags
 & 
REDISMODULE_CTX_FLAGS_RDB
è
	`FAIL
("RDB Flag was set");

270 
	`RedisModuË_C®l
(
ùx
, "config", "ccc", "set", "save", "900 1");

271 
æags
 = 
	`RedisModuË_G‘CÚ‹xtFÏgs
(
ùx
);

272 ià(!(
æags
 & 
REDISMODULE_CTX_FLAGS_RDB
)è
	`FAIL
("RDB Flag was‚ot set‡fter config set");

274 ià(!(
æags
 & 
REDISMODULE_CTX_FLAGS_MASTER
)è
	`FAIL
("Master flag was‚ot set");

275 ià(
æags
 & 
REDISMODULE_CTX_FLAGS_SLAVE
è
	`FAIL
("Slave flag was set");

276 ià(
æags
 & 
REDISMODULE_CTX_FLAGS_READONLY
è
	`FAIL
("Read-only flag was set");

277 ià(
æags
 & 
REDISMODULE_CTX_FLAGS_CLUSTER
è
	`FAIL
("Cluster flag was set");

279 ià(
æags
 & 
REDISMODULE_CTX_FLAGS_MAXMEMORY
è
	`FAIL
("Maxmemory flag was set");

281 
	`RedisModuË_C®l
(
ùx
, "config", "ccc", "set", "maxmemory", "100000000");

282 
æags
 = 
	`RedisModuË_G‘CÚ‹xtFÏgs
(
ùx
);

283 ià(!(
æags
 & 
REDISMODULE_CTX_FLAGS_MAXMEMORY
))

284 
	`FAIL
("Maxmemory flag was‚ot set‡fter config set");

286 ià(
æags
 & 
REDISMODULE_CTX_FLAGS_EVICT
è
	`FAIL
("Eviction flag was set");

287 
	`RedisModuË_C®l
(
ùx
, "config", "ccc", "set", "maxmemory-policy", "allkeys-lru");

288 
æags
 = 
	`RedisModuË_G‘CÚ‹xtFÏgs
(
ùx
);

289 ià(!(
æags
 & 
REDISMODULE_CTX_FLAGS_EVICT
)è
	`FAIL
("Eviction flag was‚ot set‡fter config set");

291 
’d
:

293 
	`RedisModuË_C®l
(
ùx
, "config", "ccc", "set", "appendonly", "no");

294 
	`RedisModuË_C®l
(
ùx
, "config", "ccc", "set", "save", "");

295 
	`RedisModuË_C®l
(
ùx
, "config", "ccc", "set", "maxmemory", "0");

296 
	`RedisModuË_C®l
(
ùx
, "config", "ccc", "set", "maxmemory-policy", "noeviction");

298 ià(!
ok
) {

299 
	`RedisModuË_Log
(
ùx
, "w¬nšg", "Faed CTXFLAGS Te¡. R—sÚ: %s", 
”rSŒšg
);

300  
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
, "ERR");

303  
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
, "OK");

304 
	}
}

310 
	$Te¡As£¹SŒšgR•ly
(
RedisModuËCtx
 *
ùx
, 
RedisModuËC®lR•ly
 *
»¶y
, *
¡r
, 
size_t
 
Ën
) {

311 
RedisModuËSŒšg
 *
my¡r
, *
ex³ùed
;

313 ià(
	`RedisModuË_C®lR•lyTy³
(
»¶y
è!ğ
REDISMODULE_REPLY_STRING
) {

314 
	`RedisModuË_Log
(
ùx
,"warning","Unexpected„eplyype %d",

315 
	`RedisModuË_C®lR•lyTy³
(
»¶y
));

318 
my¡r
 = 
	`RedisModuË_C»©eSŒšgFromC®lR•ly
(
»¶y
);

319 
ex³ùed
 = 
	`RedisModuË_C»©eSŒšg
(
ùx
,
¡r
,
Ën
);

320 ià(
	`RedisModuË_SŒšgCom·»
(
my¡r
,
ex³ùed
) != 0) {

321 cÚ¡ *
my¡r_±r
 = 
	`RedisModuË_SŒšgPŒL’
(
my¡r
,
NULL
);

322 cÚ¡ *
ex³ùed_±r
 = 
	`RedisModuË_SŒšgPŒL’
(
ex³ùed
,
NULL
);

323 
	`RedisModuË_Log
(
ùx
,"warning",

325 
my¡r_±r
, 
ex³ùed_±r
);

329 
	}
}

333 
	$Te¡As£¹IÁeg”R•ly
(
RedisModuËCtx
 *
ùx
, 
RedisModuËC®lR•ly
 *
»¶y
, 
ex³ùed
) {

334 ià(
	`RedisModuË_C®lR•lyTy³
(
»¶y
è!ğ
REDISMODULE_REPLY_INTEGER
) {

335 
	`RedisModuË_Log
(
ùx
,"warning","Unexpected„eplyype %d",

336 
	`RedisModuË_C®lR•lyTy³
(
»¶y
));

339 
v®
 = 
	`RedisModuË_C®lR•lyIÁeg”
(
»¶y
);

340 ià(
v®
 !ğ
ex³ùed
) {

341 
	`RedisModuË_Log
(
ùx
,"warning",

343 
v®
, 
ex³ùed
);

347 
	}
}

349 
	#T
(
Çme
,...) \

351 
	`RedisModuË_Log
(
ùx
,"w¬nšg","Te¡šg %s", 
Çme
); \

352 
»¶y
 = 
	`RedisModuË_C®l
(
ùx
,
Çme
,
__VA_ARGS__
); \

353 } 0);

	)

356 
	$Te¡It
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

357 
	`REDISMODULE_NOT_USED
(
¬gv
);

358 
	`REDISMODULE_NOT_USED
(
¬gc
);

360 
	`RedisModuË_AutoMemÜy
(
ùx
);

361 
RedisModuËC®lR•ly
 *
»¶y
;

364 
	`T
("dbsize","");

365 ià(!
	`Te¡As£¹IÁeg”R•ly
(
ùx
,
»¶y
,0)è
ç
;

367 
	`T
("ping","");

368 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"PONG",4)è
ç
;

370 
	`T
("test.call","");

371 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"OK",2)è
ç
;

373 
	`T
("test.ctxflags","");

374 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"OK",2)è
ç
;

376 
	`T
("test.string.append","");

377 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"foob¬",6)è
ç
;

379 
	`T
("test.unlink","");

380 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"OK",2)è
ç
;

382 
	`T
("test.string.append.am","");

383 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"foob¬",6)è
ç
;

385 
	`T
("test.string.printf", "cc", "foo", "bar");

386 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"GÙ 3‡rgs.‡rgv[1]: foo,‡rgv[2]: b¬",38)è
ç
;

388 
	`T
("test.notify", "");

389 ià(!
	`Te¡As£¹SŒšgR•ly
(
ùx
,
»¶y
,"OK",2)è
ç
;

391 
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,"ALL TESTS PASSED");

392  
REDISMODULE_OK
;

394 
ç
:

395 
	`RedisModuË_R•lyW™hSim¶eSŒšg
(
ùx
,

397  
REDISMODULE_OK
;

398 
	}
}

400 
	$RedisModuË_OnLßd
(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 **
¬gv
, 
¬gc
) {

401 
	`REDISMODULE_NOT_USED
(
¬gv
);

402 
	`REDISMODULE_NOT_USED
(
¬gc
);

404 ià(
	`RedisModuË_In™
(
ùx
,"‹¡",1,
REDISMODULE_APIVER_1
)

405 =ğ
REDISMODULE_ERR
)  REDISMODULE_ERR;

407 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.call",

408 
Te¡C®l
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

409  
REDISMODULE_ERR
;

411 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.string.append",

412 
Te¡SŒšgAµ’d
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

413  
REDISMODULE_ERR
;

415 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.string.append.am",

416 
Te¡SŒšgAµ’dAM
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

417  
REDISMODULE_ERR
;

419 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.string.printf",

420 
Te¡SŒšgPrštf
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

421  
REDISMODULE_ERR
;

423 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.ctxflags",

424 
Te¡CtxFÏgs
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

425  
REDISMODULE_ERR
;

427 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.unlink",

428 
Te¡UÆšk
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

429  
REDISMODULE_ERR
;

431 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.it",

432 
Te¡It
,"»adÚly",1,1,1è=ğ
REDISMODULE_ERR
)

433  
REDISMODULE_ERR
;

435 
	`RedisModuË_SubsüibeToKey¥aûEv’ts
(
ùx
,

436 
REDISMODULE_NOTIFY_HASH
 |

437 
REDISMODULE_NOTIFY_SET
 |

438 
REDISMODULE_NOTIFY_STRING
,

439 
NÙifyC®lback
);

440 ià(
	`RedisModuË_C»©eCommªd
(
ùx
,"test.notify",

441 
Te¡NÙifiÿtiÚs
,"wr™d’y-oom",1,1,1è=ğ
REDISMODULE_ERR
)

442  
REDISMODULE_ERR
;

444  
REDISMODULE_OK
;

445 
	}
}

	@src/multi.c

30 
	~"£rv”.h
"

35 
	$š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

36 
c
->
m¡©e
.
commªds
 = 
NULL
;

37 
c
->
m¡©e
.
couÁ
 = 0;

38 
	}
}

41 
	$ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
) {

42 
j
;

44 
j
 = 0; j < 
c
->
m¡©e
.
couÁ
; j++) {

45 
i
;

46 
muÉiCmd
 *
mc
 = 
c
->
m¡©e
.
commªds
+
j
;

48 
i
 = 0; i < 
mc
->
¬gc
; i++)

49 
	`deüRefCouÁ
(
mc
->
¬gv
[
i
]);

50 
	`zä“
(
mc
->
¬gv
);

52 
	`zä“
(
c
->
m¡©e
.
commªds
);

53 
	}
}

56 
	$queueMuÉiCommªd
(
ş›Á
 *
c
) {

57 
muÉiCmd
 *
mc
;

58 
j
;

60 
c
->
m¡©e
.
commªds
 = 
	`z»®loc
(c->mstate.commands,

61 (
muÉiCmd
)*(
c
->
m¡©e
.
couÁ
+1));

62 
mc
 = 
c
->
m¡©e
.
commªds
+c->m¡©e.
couÁ
;

63 
mc
->
cmd
 = 
c
->cmd;

64 
mc
->
¬gc
 = 
c
->argc;

65 
mc
->
¬gv
 = 
	`zm®loc
((
robj
*)*
c
->
¬gc
);

66 
	`memıy
(
mc
->
¬gv
,
c
->¬gv,(
robj
*)*c->
¬gc
);

67 
j
 = 0; j < 
c
->
¬gc
; j++)

68 
	`šüRefCouÁ
(
mc
->
¬gv
[
j
]);

69 
c
->
m¡©e
.
couÁ
++;

70 
	}
}

72 
	$disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
) {

73 
	`ä“Cl›ÁMuÉiS‹
(
c
);

74 
	`š™Cl›ÁMuÉiS‹
(
c
);

75 
c
->
æags
 &ğ~(
CLIENT_MULTI
|
CLIENT_DIRTY_CAS
|
CLIENT_DIRTY_EXEC
);

76 
	`unw©chAÎKeys
(
c
);

77 
	}
}

81 
	$æagT¿n§ùiÚ
(
ş›Á
 *
c
) {

82 ià(
c
->
æags
 & 
CLIENT_MULTI
)

83 
c
->
æags
 |ğ
CLIENT_DIRTY_EXEC
;

84 
	}
}

86 
	$muÉiCommªd
(
ş›Á
 *
c
) {

87 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

88 
	`addR•lyE¼Ü
(
c
,"MULTI calls can‚ot be‚ested");

91 
c
->
æags
 |ğ
CLIENT_MULTI
;

92 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

93 
	}
}

95 
	$disÿrdCommªd
(
ş›Á
 *
c
) {

96 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)) {

97 
	`addR•lyE¼Ü
(
c
,"DISCARD without MULTI");

100 
	`disÿrdT¿n§ùiÚ
(
c
);

101 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

102 
	}
}

106 
	$execCommªdPrİag©eMuÉi
(
ş›Á
 *
c
) {

107 
robj
 *
muÉi¡ršg
 = 
	`ü—‹SŒšgObjeù
("MULTI",5);

109 
	`´İag©e
(
£rv”
.
muÉiCommªd
,
c
->
db
->
id
,&
muÉi¡ršg
,1,

110 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

111 
	`deüRefCouÁ
(
muÉi¡ršg
);

112 
	}
}

114 
	$execCommªd
(
ş›Á
 *
c
) {

115 
j
;

116 
robj
 **
Üig_¬gv
;

117 
Üig_¬gc
;

118 
»disCommªd
 *
Üig_cmd
;

119 
mu¡_´İag©e
 = 0;

120 
was_ma¡”
 = 
£rv”
.
ma¡”ho¡
 =ğ
NULL
;

122 ià(!(
c
->
æags
 & 
CLIENT_MULTI
)) {

123 
	`addR•lyE¼Ü
(
c
,"EXEC without MULTI");

133 ià(
c
->
æags
 & (
CLIENT_DIRTY_CAS
|
CLIENT_DIRTY_EXEC
)) {

134 
	`addR•ly
(
c
, c->
æags
 & 
CLIENT_DIRTY_EXEC
 ? 
sh¬ed
.
exeÿbÜ‹¼
 :

135 
sh¬ed
.
nuÎmuÉibulk
);

136 
	`disÿrdT¿n§ùiÚ
(
c
);

137 
hªdË_mÚ™Ü
;

141 
	`unw©chAÎKeys
(
c
);

142 
Üig_¬gv
 = 
c
->
¬gv
;

143 
Üig_¬gc
 = 
c
->
¬gc
;

144 
Üig_cmd
 = 
c
->
cmd
;

145 
	`addR•lyMuÉiBulkL’
(
c
,c->
m¡©e
.
couÁ
);

146 
j
 = 0; j < 
c
->
m¡©e
.
couÁ
; j++) {

147 
c
->
¬gc
 = c->
m¡©e
.
commªds
[
j
].argc;

148 
c
->
¬gv
 = c->
m¡©e
.
commªds
[
j
].argv;

149 
c
->
cmd
 = c->
m¡©e
.
commªds
[
j
].cmd;

156 ià(!
mu¡_´İag©e
 && !(
c
->
cmd
->
æags
 & (
CMD_READONLY
|
CMD_ADMIN
))) {

157 
	`execCommªdPrİag©eMuÉi
(
c
);

158 
mu¡_´İag©e
 = 1;

161 
	`ÿÎ
(
c
,
CMD_CALL_FULL
);

164 
c
->
m¡©e
.
commªds
[
j
].
¬gc
 = c->argc;

165 
c
->
m¡©e
.
commªds
[
j
].
¬gv
 = c->argv;

166 
c
->
m¡©e
.
commªds
[
j
].
cmd
 = c->cmd;

168 
c
->
¬gv
 = 
Üig_¬gv
;

169 
c
->
¬gc
 = 
Üig_¬gc
;

170 
c
->
cmd
 = 
Üig_cmd
;

171 
	`disÿrdT¿n§ùiÚ
(
c
);

175 ià(
mu¡_´İag©e
) {

176 
is_ma¡”
 = 
£rv”
.
ma¡”ho¡
 =ğ
NULL
;

177 
£rv”
.
dœty
++;

183 ià(
£rv”
.
»¶_backlog
 && 
was_ma¡”
 && !
is_ma¡”
) {

184 *
execcmd
 = "*1\r\n$4\r\nEXEC\r\n";

185 
	`ãedR•liÿtiÚBacklog
(
execcmd
,
	`¡¾’
(execcmd));

189 
hªdË_mÚ™Ü
:

195 ià(
	`li¡L’gth
(
£rv”
.
mÚ™Üs
è&& !£rv”.
lßdšg
)

196 
	`»¶iÿtiÚF“dMÚ™Üs
(
c
,
£rv”
.
mÚ™Üs
,c->
db
->
id
,c->
¬gv
,c->
¬gc
);

197 
	}
}

211 
	sw©chedKey
 {

212 
robj
 *
	mkey
;

213 
»disDb
 *
	mdb
;

214 } 
	tw©chedKey
;

217 
	$w©chFÜKey
(
ş›Á
 *
c
, 
robj
 *
key
) {

218 
li¡
 *
ş›Ás
 = 
NULL
;

219 
li¡I‹r
 
li
;

220 
li¡Node
 *
Ê
;

221 
w©chedKey
 *
wk
;

224 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li
);

225 (
Ê
 = 
	`li¡Next
(&
li
))) {

226 
wk
 = 
	`li¡NodeV®ue
(
Ê
);

227 ià(
wk
->
db
 =ğ
c
->db && 
	`equ®SŒšgObjeùs
(
key
,wk->key))

231 
ş›Ás
 = 
	`diùF‘chV®ue
(
c
->
db
->
w©ched_keys
,
key
);

232 ià(!
ş›Ás
) {

233 
ş›Ás
 = 
	`li¡C»©e
();

234 
	`diùAdd
(
c
->
db
->
w©ched_keys
,
key
,
ş›Ás
);

235 
	`šüRefCouÁ
(
key
);

237 
	`li¡AddNodeTa
(
ş›Ás
,
c
);

239 
wk
 = 
	`zm®loc
((*wk));

240 
wk
->
key
 = key;

241 
wk
->
db
 = 
c
->db;

242 
	`šüRefCouÁ
(
key
);

243 
	`li¡AddNodeTa
(
c
->
w©ched_keys
,
wk
);

244 
	}
}

248 
	$unw©chAÎKeys
(
ş›Á
 *
c
) {

249 
li¡I‹r
 
li
;

250 
li¡Node
 *
Ê
;

252 ià(
	`li¡L’gth
(
c
->
w©ched_keys
) == 0) ;

253 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li
);

254 (
Ê
 = 
	`li¡Next
(&
li
))) {

255 
li¡
 *
ş›Ás
;

256 
w©chedKey
 *
wk
;

260 
wk
 = 
	`li¡NodeV®ue
(
Ê
);

261 
ş›Ás
 = 
	`diùF‘chV®ue
(
wk
->
db
->
w©ched_keys
, wk->
key
);

262 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
ş›Ás
 != NULL);

263 
	`li¡D–Node
(
ş›Ás
,
	`li¡S—rchKey
(ş›Ás,
c
));

265 ià(
	`li¡L’gth
(
ş›Ás
) == 0)

266 
	`diùD–‘e
(
wk
->
db
->
w©ched_keys
, wk->
key
);

268 
	`li¡D–Node
(
c
->
w©ched_keys
,
Ê
);

269 
	`deüRefCouÁ
(
wk
->
key
);

270 
	`zä“
(
wk
);

272 
	}
}

276 
	$touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
) {

277 
li¡
 *
ş›Ás
;

278 
li¡I‹r
 
li
;

279 
li¡Node
 *
Ê
;

281 ià(
	`diùSize
(
db
->
w©ched_keys
) == 0) ;

282 
ş›Ás
 = 
	`diùF‘chV®ue
(
db
->
w©ched_keys
, 
key
);

283 ià(!
ş›Ás
) ;

287 
	`li¡Rewšd
(
ş›Ás
,&
li
);

288 (
Ê
 = 
	`li¡Next
(&
li
))) {

289 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

291 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

293 
	}
}

299 
	$touchW©chedKeysOnFlush
(
dbid
) {

300 
li¡I‹r
 
li1
, 
li2
;

301 
li¡Node
 *
Ê
;

304 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li1
);

305 (
Ê
 = 
	`li¡Next
(&
li1
))) {

306 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

307 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li2
);

308 (
Ê
 = 
	`li¡Next
(&
li2
))) {

309 
w©chedKey
 *
wk
 = 
	`li¡NodeV®ue
(
Ê
);

314 ià(
dbid
 =ğ-1 || 
wk
->
db
->
id
 == dbid) {

315 ià(
	`diùFšd
(
wk
->
db
->
diù
, wk->
key
->
±r
è!ğ
NULL
)

316 
c
->
æags
 |ğ
CLIENT_DIRTY_CAS
;

320 
	}
}

322 
	$w©chCommªd
(
ş›Á
 *
c
) {

323 
j
;

325 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

326 
	`addR•lyE¼Ü
(
c
,"WATCH inside MULTI is‚ot‡llowed");

329 
j
 = 1; j < 
c
->
¬gc
; j++)

330 
	`w©chFÜKey
(
c
,c->
¬gv
[
j
]);

331 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

332 
	}
}

334 
	$unw©chCommªd
(
ş›Á
 *
c
) {

335 
	`unw©chAÎKeys
(
c
);

336 
c
->
æags
 &ğ(~
CLIENT_DIRTY_CAS
);

337 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

338 
	}
}

	@src/networking.c

30 
	~"£rv”.h
"

31 
	~"©omicv¬.h
"

32 
	~<sys/uio.h
>

33 
	~<m©h.h
>

34 
	~<ùy³.h
>

36 
£tPrÙocŞE¼Ü
(cÚ¡ *
”r¡r
, 
ş›Á
 *
c
, 
pos
);

41 
size_t
 
	$sdsZm®locSize
(
sds
 
s
) {

42 *
sh
 = 
	`sdsAÎocPŒ
(
s
);

43  
	`zm®loc_size
(
sh
);

44 
	}
}

48 
size_t
 
	$g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
) {

49 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

50 
o
->
’codšg
) {

51 
OBJ_ENCODING_RAW
:  
	`sdsZm®locSize
(
o
->
±r
);

52 
OBJ_ENCODING_EMBSTR
:  
	`zm®loc_size
(
o
)-(
robj
);

55 
	}
}

58 *
	$dupCl›ÁR•lyV®ue
(*
o
) {

59  
	`sdsdup
(
o
);

60 
	}
}

62 
	$ä“Cl›ÁR•lyV®ue
(*
o
) {

63 
	`sdsä“
(
o
);

64 
	}
}

66 
	$li¡M©chObjeùs
(*
a
, *
b
) {

67  
	`equ®SŒšgObjeùs
(
a
,
b
);

68 
	}
}

70 
ş›Á
 *
	$ü—‹Cl›Á
(
fd
) {

71 
ş›Á
 *
c
 = 
	`zm®loc
((client));

77 ià(
fd
 != -1) {

78 
	`ª‘NÚBlock
(
NULL
,
fd
);

79 
	`ª‘EÇbËTıNoD–ay
(
NULL
,
fd
);

80 ià(
£rv”
.
tık“·live
)

81 
	`ª‘K“pAlive
(
NULL
,
fd
,
£rv”
.
tık“·live
);

82 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
,

83 
»adQu”yFromCl›Á
, 
c
è=ğ
AE_ERR
)

85 
	`şo£
(
fd
);

86 
	`zä“
(
c
);

87  
NULL
;

91 
	`£ËùDb
(
c
,0);

92 
ušt64_t
 
ş›Á_id
;

93 
	`©omicG‘Inü
(
£rv”
.
Ãxt_ş›Á_id
,
ş›Á_id
,1);

94 
c
->
id
 = 
ş›Á_id
;

95 
c
->
fd
 = fd;

96 
c
->
Çme
 = 
NULL
;

97 
c
->
buåos
 = 0;

98 
c
->
qu”ybuf
 = 
	`sd£m±y
();

99 
c
->
³ndšg_qu”ybuf
 = 
	`sd£m±y
();

100 
c
->
qu”ybuf_³ak
 = 0;

101 
c
->
»qty³
 = 0;

102 
c
->
¬gc
 = 0;

103 
c
->
¬gv
 = 
NULL
;

104 
c
->
cmd
 = c->
Ï¡cmd
 = 
NULL
;

105 
c
->
muÉibulkËn
 = 0;

106 
c
->
bulkËn
 = -1;

107 
c
->
£ÁËn
 = 0;

108 
c
->
æags
 = 0;

109 
c
->
ùime
 = c->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

110 
c
->
auth’tiÿ‹d
 = 0;

111 
c
->
»¶¡©e
 = 
REPL_STATE_NONE
;

112 
c
->
»¶_put_Úlše_Ú_ack
 = 0;

113 
c
->
»¶off
 = 0;

114 
c
->
»ad_»¶off
 = 0;

115 
c
->
»¶_ack_off
 = 0;

116 
c
->
»¶_ack_time
 = 0;

117 
c
->
¦ave_li¡’šg_pÜt
 = 0;

118 
c
->
¦ave_
[0] = '\0';

119 
c
->
¦ave_ÿ·
 = 
SLAVE_CAPA_NONE
;

120 
c
->
»¶y
 = 
	`li¡C»©e
();

121 
c
->
»¶y_by‹s
 = 0;

122 
c
->
obuf_soá_lim™_»ached_time
 = 0;

123 
	`li¡S‘F»eM‘hod
(
c
->
»¶y
,
ä“Cl›ÁR•lyV®ue
);

124 
	`li¡S‘DupM‘hod
(
c
->
»¶y
,
dupCl›ÁR•lyV®ue
);

125 
c
->
bty³
 = 
BLOCKED_NONE
;

126 
c
->
bpİ
.
timeout
 = 0;

127 
c
->
bpİ
.
keys
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

128 
c
->
bpİ
.
rg‘
 = 
NULL
;

129 
c
->
bpİ
.
num»¶iÿs
 = 0;

130 
c
->
bpİ
.
»¶off£t
 = 0;

131 
c
->
woff
 = 0;

132 
c
->
w©ched_keys
 = 
	`li¡C»©e
();

133 
c
->
pubsub_chªÃls
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

134 
c
->
pubsub_·‰”ns
 = 
	`li¡C»©e
();

135 
c
->
³”id
 = 
NULL
;

136 
	`li¡S‘F»eM‘hod
(
c
->
pubsub_·‰”ns
,
deüRefCouÁVoid
);

137 
	`li¡S‘M©chM‘hod
(
c
->
pubsub_·‰”ns
,
li¡M©chObjeùs
);

138 ià(
fd
 !ğ-1è
	`li¡AddNodeTa
(
£rv”
.
ş›Ás
,
c
);

139 
	`š™Cl›ÁMuÉiS‹
(
c
);

140  
c
;

141 
	}
}

165 
	$´•¬eCl›ÁToWr™e
(
ş›Á
 *
c
) {

168 ià(
c
->
æags
 & (
CLIENT_LUA
|
CLIENT_MODULE
)è 
C_OK
;

171 ià(
c
->
æags
 & (
CLIENT_REPLY_OFF
|
CLIENT_REPLY_SKIP
)è 
C_ERR
;

175 ià((
c
->
æags
 & 
CLIENT_MASTER
) &&

176 !(
c
->
æags
 & 
CLIENT_MASTER_FORCE_REPLY
)è 
C_ERR
;

178 ià(
c
->
fd
 <ğ0è 
C_ERR
;

184 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
) &&

185 !(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) &&

186 (
c
->
»¶¡©e
 =ğ
REPL_STATE_NONE
 ||

187 (
c
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 && !c->
»¶_put_Úlše_Ú_ack
)))

195 
c
->
æags
 |ğ
CLIENT_PENDING_WRITE
;

196 
	`li¡AddNodeH—d
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
c
);

200  
C_OK
;

201 
	}
}

207 
	$_addR•lyToBufãr
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

208 
size_t
 
avaabË
 = (
c
->
buf
)-c->
buåos
;

210 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è 
C_OK
;

214 ià(
	`li¡L’gth
(
c
->
»¶y
è> 0è 
C_ERR
;

217 ià(
Ën
 > 
avaabË
è 
C_ERR
;

219 
	`memıy
(
c
->
buf
+c->
buåos
,
s
,
Ën
);

220 
c
->
buåos
+=
Ën
;

221  
C_OK
;

222 
	}
}

224 
	$_addR•lyObjeùToLi¡
(
ş›Á
 *
c
, 
robj
 *
o
) {

225 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

227 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

228 
sds
 
s
 = 
	`sdsdup
(
o
->
±r
);

229 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

230 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

232 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
c
->
»¶y
);

233 
sds
 

 = 
	`li¡NodeV®ue
(
Ê
);

237 ià(

 && 
	`sd¦’
Ña)+sd¦’(
o
->
±r
è<ğ
PROTO_REPLY_CHUNK_BYTES
) {

238 

 = 
	`sdsÿtsds
Ña,
o
->
±r
);

239 
	`li¡NodeV®ue
(
Ê
èğ

;

240 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
o
->
±r
);

242 
sds
 
s
 = 
	`sdsdup
(
o
->
±r
);

243 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

244 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

247 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

248 
	}
}

252 
	$_addR•lySdsToLi¡
(
ş›Á
 *
c
, 
sds
 
s
) {

253 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

254 
	`sdsä“
(
s
);

258 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

259 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

260 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

262 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
c
->
»¶y
);

263 
sds
 

 = 
	`li¡NodeV®ue
(
Ê
);

267 ià(

 && 
	`sd¦’
Ña)+sd¦’(
s
è<ğ
PROTO_REPLY_CHUNK_BYTES
) {

268 

 = 
	`sdsÿtsds
Ña,
s
);

269 
	`li¡NodeV®ue
(
Ê
èğ

;

270 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

271 
	`sdsä“
(
s
);

273 
	`li¡AddNodeTa
(
c
->
»¶y
,
s
);

274 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
s
);

277 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

278 
	}
}

280 
	$_addR•lySŒšgToLi¡
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

281 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) ;

283 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

284 
sds
 
node
 = 
	`sd¢ewËn
(
s
,
Ën
);

285 
	`li¡AddNodeTa
(
c
->
»¶y
,
node
);

286 
c
->
»¶y_by‹s
 +ğ
Ën
;

288 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
c
->
»¶y
);

289 
sds
 

 = 
	`li¡NodeV®ue
(
Ê
);

293 ià(

 && 
	`sd¦’
Ña)+
Ën
 <ğ
PROTO_REPLY_CHUNK_BYTES
) {

294 

 = 
	`sdsÿ’
Ña,
s
,
Ën
);

295 
	`li¡NodeV®ue
(
Ê
èğ

;

296 
c
->
»¶y_by‹s
 +ğ
Ën
;

298 
sds
 
node
 = 
	`sd¢ewËn
(
s
,
Ën
);

299 
	`li¡AddNodeTa
(
c
->
»¶y
,
node
);

300 
c
->
»¶y_by‹s
 +ğ
Ën
;

303 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

304 
	}
}

311 
	$addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
) {

312 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
) ;

321 ià(
	`sdsEncodedObjeù
(
obj
)) {

322 ià(
	`_addR•lyToBufãr
(
c
,
obj
->
±r
,
	`sd¦’
(obj->±r)è!ğ
C_OK
)

323 
	`_addR•lyObjeùToLi¡
(
c
,
obj
);

324 } ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

328 ià(
	`li¡L’gth
(
c
->
»¶y
è=ğ0 && ((c->
buf
è- c->
buåos
) >= 32) {

329 
buf
[32];

330 
Ën
;

332 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
obj
->
±r
);

333 ià(
	`_addR•lyToBufãr
(
c
,
buf
,
Ën
è=ğ
C_OK
)

338 
obj
 = 
	`g‘DecodedObjeù
(obj);

339 ià(
	`_addR•lyToBufãr
(
c
,
obj
->
±r
,
	`sd¦’
(obj->±r)è!ğ
C_OK
)

340 
	`_addR•lyObjeùToLi¡
(
c
,
obj
);

341 
	`deüRefCouÁ
(
obj
);

343 
	`£rv”Pªic
("Wrong obj->encoding in‡ddReply()");

345 
	}
}

347 
	$addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
) {

348 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
) {

350 
	`sdsä“
(
s
);

353 ià(
	`_addR•lyToBufãr
(
c
,
s
,
	`sd¦’
(s)è=ğ
C_OK
) {

354 
	`sdsä“
(
s
);

357 
	`_addR•lySdsToLi¡
(
c
,
s
);

359 
	}
}

369 
	$addR•lySŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

370 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
) ;

371 ià(
	`_addR•lyToBufãr
(
c
,
s
,
Ën
è!ğ
C_OK
)

372 
	`_addR•lySŒšgToLi¡
(
c
,
s
,
Ën
);

373 
	}
}

375 
	$addR•lyE¼ÜL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

376 
	`addR•lySŒšg
(
c
,"-ERR ",5);

377 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

378 
	`addR•lySŒšg
(
c
,"\r\n",2);

379 ià(
c
->
æags
 & 
CLIENT_MASTER
) {

380 *
cmdÇme
 = 
c
->
Ï¡cmd
 ? c->Ï¡cmd->
Çme
 : "<unknown>";

381 
	`£rv”Log
(
LL_WARNING
,"== CRITICAL == This slave is sending‡nƒrror "

383 "'%s'", 
s
, 
cmdÇme
);

385 
	}
}

387 
	$addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
) {

388 
	`addR•lyE¼ÜL’gth
(
c
,
”r
,
	`¡¾’
(err));

389 
	}
}

391 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

392 
size_t
 
l
, 
j
;

393 
va_li¡
 
­
;

394 
	`va_¡¬t
(
­
,
fmt
);

395 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

396 
	`va_’d
(
­
);

399 
l
 = 
	`sd¦’
(
s
);

400 
j
 = 0; j < 
l
; j++) {

401 ià(
s
[
j
] == '\r' || s[j] == '\n') s[j] = ' ';

403 
	`addR•lyE¼ÜL’gth
(
c
,
s
,
	`sd¦’
(s));

404 
	`sdsä“
(
s
);

405 
	}
}

407 
	$addR•lyStusL’gth
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
) {

408 
	`addR•lySŒšg
(
c
,"+",1);

409 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

410 
	`addR•lySŒšg
(
c
,"\r\n",2);

411 
	}
}

413 
	$addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
) {

414 
	`addR•lyStusL’gth
(
c
,
¡©us
,
	`¡¾’
(status));

415 
	}
}

417 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...) {

418 
va_li¡
 
­
;

419 
	`va_¡¬t
(
­
,
fmt
);

420 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

421 
	`va_’d
(
­
);

422 
	`addR•lyStusL’gth
(
c
,
s
,
	`sd¦’
(s));

423 
	`sdsä“
(
s
);

424 
	}
}

428 *
	$addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
) {

432 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
C_OK
è 
NULL
;

433 
	`li¡AddNodeTa
(
c
->
»¶y
,
NULL
);

434  
	`li¡La¡
(
c
->
»¶y
);

435 
	}
}

438 
	$£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
) {

439 
li¡Node
 *
Ê
 = (li¡Node*)
node
;

440 
sds
 
Ën
, 
Ãxt
;

444 ià(
node
 =ğ
NULL
) ;

446 
Ën
 = 
	`sdsÿrštf
(
	`sd¢ewËn
("*",1),"%ld\r\n",
Ëngth
);

447 
	`li¡NodeV®ue
(
Ê
èğ
Ën
;

448 
c
->
»¶y_by‹s
 +ğ
	`sd¦’
(
Ën
);

449 ià(
Ê
->
Ãxt
 !ğ
NULL
) {

450 
Ãxt
 = 
	`li¡NodeV®ue
(
Ê
->next);

453 ià(
Ãxt
 !ğ
NULL
) {

454 
Ën
 = 
	`sdsÿtsds
Ö’,
Ãxt
);

455 
	`li¡D–Node
(
c
->
»¶y
,
Ê
->
Ãxt
);

456 
	`li¡NodeV®ue
(
Ê
èğ
Ën
;

461 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

462 
	}
}

465 
	$addR•lyDoubË
(
ş›Á
 *
c
, 
d
) {

466 
dbuf
[128], 
sbuf
[128];

467 
dËn
, 
¦’
;

468 ià(
	`isšf
(
d
)) {

471 
	`addR•lyBulkCSŒšg
(
c
, 
d
 > 0 ? "inf" : "-inf");

473 
dËn
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",
d
);

474 
¦’
 = 
	`¢´štf
(
sbuf
,(sbuf),"$%d\r\n%s\r\n",
dËn
,
dbuf
);

475 
	`addR•lySŒšg
(
c
,
sbuf
,
¦’
);

477 
	}
}

482 
	$addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
) {

483 
robj
 *
o
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
d
,1);

484 
	`addR•lyBulk
(
c
,
o
);

485 
	`deüRefCouÁ
(
o
);

486 
	}
}

490 
	$addR•lyLÚgLÚgW™hP»fix
(
ş›Á
 *
c
, 
Î
, 
´efix
) {

491 
buf
[128];

492 
Ën
;

497 ià(
´efix
 =ğ'*' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

498 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Î
]);

500 } ià(
´efix
 =ğ'$' && 
Î
 < 
OBJ_SHARED_BULKHDR_LEN
 &&†l >= 0) {

501 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Î
]);

505 
buf
[0] = 
´efix
;

506 
Ën
 = 
	`Î2¡ršg
(
buf
+1,(buf)-1,
Î
);

507 
buf
[
Ën
+1] = '\r';

508 
buf
[
Ën
+2] = '\n';

509 
	`addR•lySŒšg
(
c
,
buf
,
Ën
+3);

510 
	}
}

512 
	$addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

513 ià(
Î
 == 0)

514 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

515 ià(
Î
 == 1)

516 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

518 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Î
,':');

519 
	}
}

521 
	$addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
) {

522 ià(
Ëngth
 < 
OBJ_SHARED_BULKHDR_LEN
)

523 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Ëngth
]);

525 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ëngth
,'*');

526 
	}
}

529 
	$addR•lyBulkL’
(
ş›Á
 *
c
, 
robj
 *
obj
) {

530 
size_t
 
Ën
;

532 ià(
	`sdsEncodedObjeù
(
obj
)) {

533 
Ën
 = 
	`sd¦’
(
obj
->
±r
);

535 
n
 = ()
obj
->
±r
;

538 
Ën
 = 1;

539 ià(
n
 < 0) {

540 
Ën
++;

541 
n
 = -n;

543 (
n
 =‚/10) != 0) {

544 
Ën
++;

548 ià(
Ën
 < 
OBJ_SHARED_BULKHDR_LEN
)

549 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Ën
]);

551 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

552 
	}
}

555 
	$addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
) {

556 
	`addR•lyBulkL’
(
c
,
obj
);

557 
	`addR•ly
(
c
,
obj
);

558 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

559 
	}
}

562 
	$addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
) {

563 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

564 
	`addR•lySŒšg
(
c
,
p
,
Ën
);

565 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

566 
	}
}

569 
	$addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
) {

570 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
	`sd¦’
(
s
),'$');

571 
	`addR•lySds
(
c
,
s
);

572 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

573 
	}
}

576 
	$addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
) {

577 ià(
s
 =ğ
NULL
) {

578 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

580 
	`addR•lyBulkCBufãr
(
c
,
s
,
	`¡¾’
(s));

582 
	}
}

585 
	$addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
) {

586 
buf
[64];

587 
Ën
;

589 
Ën
 = 
	`Î2¡ršg
(
buf
,64,
Î
);

590 
	`addR•lyBulkCBufãr
(
c
,
buf
,
Ën
);

591 
	}
}

596 
	$cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
) {

597 
	`li¡R–—£
(
d¡
->
»¶y
);

598 
d¡
->
»¶y
 = 
	`li¡Dup
(
¤c
->reply);

599 
	`memıy
(
d¡
->
buf
,
¤c
->buf,¤c->
buåos
);

600 
d¡
->
buåos
 = 
¤c
->bufpos;

601 
d¡
->
»¶y_by‹s
 = 
¤c
->reply_bytes;

602 
	}
}

606 
	$ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
) {

607  
c
->
buåos
 || 
	`li¡L’gth
(c->
»¶y
);

608 
	}
}

610 
	#MAX_ACCEPTS_PER_CALL
 1000

	)

611 
	$acû±CommÚHªdËr
(
fd
, 
æags
, *

) {

612 
ş›Á
 *
c
;

613 ià((
c
 = 
	`ü—‹Cl›Á
(
fd
)è=ğ
NULL
) {

614 
	`£rv”Log
(
LL_WARNING
,

616 
	`¡»¼Ü
(
”ºo
),
fd
);

617 
	`şo£
(
fd
);

624 ià(
	`li¡L’gth
(
£rv”
.
ş›Ás
è> s”v”.
maxş›Ás
) {

625 *
”r
 = "-ERR max‚umber of clients„eached\r\n";

628 ià(
	`wr™e
(
c
->
fd
,
”r
,
	`¡¾’
(err)) == -1) {

631 
£rv”
.
¡©_»jeùed_cÚn
++;

632 
	`ä“Cl›Á
(
c
);

640 ià(
£rv”
.
´Ùeùed_mode
 &&

641 
£rv”
.
bšdaddr_couÁ
 == 0 &&

642 
£rv”
.
»quœ•ass
 =ğ
NULL
 &&

643 !(
æags
 & 
CLIENT_UNIX_SOCKET
) &&

644 

 !ğ
NULL
)

646 ià(
	`¡rcmp
(

,"127.0.0.1") && strcmp(ip,"::1")) {

647 *
”r
 =

668 ià(
	`wr™e
(
c
->
fd
,
”r
,
	`¡¾’
(err)) == -1) {

671 
£rv”
.
¡©_»jeùed_cÚn
++;

672 
	`ä“Cl›Á
(
c
);

677 
£rv”
.
¡©_numcÚÃùiÚs
++;

678 
c
->
æags
 |= flags;

679 
	}
}

681 
	$acû±TıHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

682 
ıÜt
, 
cfd
, 
max
 = 
MAX_ACCEPTS_PER_CALL
;

683 
c
[
NET_IP_STR_LEN
];

684 
	`UNUSED
(
–
);

685 
	`UNUSED
(
mask
);

686 
	`UNUSED
(
´ivd©a
);

688 
max
--) {

689 
cfd
 = 
	`ª‘TıAcû±
(
£rv”
.
Ã‹¼
, 
fd
, 
c
, (c), &
ıÜt
);

690 ià(
cfd
 =ğ
ANET_ERR
) {

691 ià(
”ºo
 !ğ
EWOULDBLOCK
)

692 
	`£rv”Log
(
LL_WARNING
,

693 "Acû±šg cl›Á cÚÃùiÚ: %s", 
£rv”
.
Ã‹¼
);

696 
	`£rv”Log
(
LL_VERBOSE
,"Acû±ed %s:%d", 
c
, 
ıÜt
);

697 
	`acû±CommÚHªdËr
(
cfd
,0,
c
);

699 
	}
}

701 
	$acû±UnixHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

702 
cfd
, 
max
 = 
MAX_ACCEPTS_PER_CALL
;

703 
	`UNUSED
(
–
);

704 
	`UNUSED
(
mask
);

705 
	`UNUSED
(
´ivd©a
);

707 
max
--) {

708 
cfd
 = 
	`ª‘UnixAcû±
(
£rv”
.
Ã‹¼
, 
fd
);

709 ià(
cfd
 =ğ
ANET_ERR
) {

710 ià(
”ºo
 !ğ
EWOULDBLOCK
)

711 
	`£rv”Log
(
LL_WARNING
,

712 "Acû±šg cl›Á cÚÃùiÚ: %s", 
£rv”
.
Ã‹¼
);

715 
	`£rv”Log
(
LL_VERBOSE
,"Acû±ed cÚÃùiÚØ%s", 
£rv”
.
unixsock‘
);

716 
	`acû±CommÚHªdËr
(
cfd
,
CLIENT_UNIX_SOCKET
,
NULL
);

718 
	}
}

720 
	$ä“Cl›ÁArgv
(
ş›Á
 *
c
) {

721 
j
;

722 
j
 = 0; j < 
c
->
¬gc
; j++)

723 
	`deüRefCouÁ
(
c
->
¬gv
[
j
]);

724 
c
->
¬gc
 = 0;

725 
c
->
cmd
 = 
NULL
;

726 
	}
}

731 
	$discÚÃùSÏves
() {

732 
	`li¡L’gth
(
£rv”
.
¦aves
)) {

733 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
¦aves
);

734 
	`ä“Cl›Á
((
ş›Á
*)
Ê
->
v®ue
);

736 
	}
}

741 
	$uÆškCl›Á
(
ş›Á
 *
c
) {

742 
li¡Node
 *
Ê
;

745 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
c
è£rv”.cu¼’t_ş›Á = 
NULL
;

750 ià(
c
->
fd
 != -1) {

752 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás
,
c
);

753 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

754 
	`li¡D–Node
(
£rv”
.
ş›Ás
,
Ê
);

757 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_READABLE
);

758 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_WRITABLE
);

759 
	`şo£
(
c
->
fd
);

760 
c
->
fd
 = -1;

764 ià(
c
->
æags
 & 
CLIENT_PENDING_WRITE
) {

765 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
c
);

766 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

767 
	`li¡D–Node
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
Ê
);

768 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

773 ià(
c
->
æags
 & 
CLIENT_UNBLOCKED
) {

774 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
unblocked_ş›Ás
,
c
);

775 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

776 
	`li¡D–Node
(
£rv”
.
unblocked_ş›Ás
,
Ê
);

777 
c
->
æags
 &ğ~
CLIENT_UNBLOCKED
;

779 
	}
}

781 
	$ä“Cl›Á
(
ş›Á
 *
c
) {

782 
li¡Node
 *
Ê
;

789 ià(
£rv”
.
ma¡”
 && 
c
->
æags
 & 
CLIENT_MASTER
) {

790 
	`£rv”Log
(
LL_WARNING
,"Connection with master†ost.");

791 ià(!(
c
->
æags
 & (
CLIENT_CLOSE_AFTER_REPLY
|

792 
CLIENT_CLOSE_ASAP
|

793 
CLIENT_BLOCKED
|

794 
CLIENT_UNBLOCKED
)))

796 
	`»¶iÿtiÚCacheMa¡”
(
c
);

802 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
)) {

803 
	`£rv”Log
(
LL_WARNING
,"Connection with slave %s†ost.",

804 
	`»¶iÿtiÚG‘SÏveName
(
c
));

808 
	`sdsä“
(
c
->
qu”ybuf
);

809 
	`sdsä“
(
c
->
³ndšg_qu”ybuf
);

810 
c
->
qu”ybuf
 = 
NULL
;

813 ià(
c
->
æags
 & 
CLIENT_BLOCKED
è
	`unblockCl›Á
(c);

814 
	`diùR–—£
(
c
->
bpİ
.
keys
);

817 
	`unw©chAÎKeys
(
c
);

818 
	`li¡R–—£
(
c
->
w©ched_keys
);

821 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,0);

822 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,0);

823 
	`diùR–—£
(
c
->
pubsub_chªÃls
);

824 
	`li¡R–—£
(
c
->
pubsub_·‰”ns
);

827 
	`li¡R–—£
(
c
->
»¶y
);

828 
	`ä“Cl›ÁArgv
(
c
);

833 
	`uÆškCl›Á
(
c
);

837 ià(
c
->
æags
 & 
CLIENT_SLAVE
) {

838 ià(
c
->
»¶¡©e
 =ğ
SLAVE_STATE_SEND_BULK
) {

839 ià(
c
->
»¶dbfd
 !ğ-1è
	`şo£
(c->repldbfd);

840 ià(
c
->
»¶´—mbË
è
	`sdsä“
(c->replpreamble);

842 
li¡
 *
l
 = (
c
->
æags
 & 
CLIENT_MONITOR
è? 
£rv”
.
mÚ™Üs
 : s”v”.
¦aves
;

843 
Ê
 = 
	`li¡S—rchKey
(
l
,
c
);

844 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

845 
	`li¡D–Node
(
l
,
Ê
);

849 ià(
c
->
æags
 & 
CLIENT_SLAVE
 && 
	`li¡L’gth
(
£rv”
.
¦aves
) == 0)

850 
£rv”
.
»¶_no_¦aves_sšû
 = s”v”.
unixtime
;

851 
	`»äeshGoodSÏvesCouÁ
();

856 ià(
c
->
æags
 & 
CLIENT_MASTER
è
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

860 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
) {

861 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás_to_şo£
,
c
);

862 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

863 
	`li¡D–Node
(
£rv”
.
ş›Ás_to_şo£
,
Ê
);

868 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

869 
	`zä“
(
c
->
¬gv
);

870 
	`ä“Cl›ÁMuÉiS‹
(
c
);

871 
	`sdsä“
(
c
->
³”id
);

872 
	`zä“
(
c
);

873 
	}
}

879 
	$ä“Cl›ÁAsync
(
ş›Á
 *
c
) {

880 ià(
c
->
æags
 & 
CLIENT_CLOSE_ASAP
 || c->æag & 
CLIENT_LUA
) ;

881 
c
->
æags
 |ğ
CLIENT_CLOSE_ASAP
;

882 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás_to_şo£
,
c
);

883 
	}
}

885 
	$ä“Cl›ÁsInAsyncF»eQueue
() {

886 
	`li¡L’gth
(
£rv”
.
ş›Ás_to_şo£
)) {

887 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
ş›Ás_to_şo£
);

888 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

890 
c
->
æags
 &ğ~
CLIENT_CLOSE_ASAP
;

891 
	`ä“Cl›Á
(
c
);

892 
	`li¡D–Node
(
£rv”
.
ş›Ás_to_şo£
,
Ê
);

894 
	}
}

898 
	$wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
) {

899 
ssize_t
 
nwr™‹n
 = 0, 
tÙwr™‹n
 = 0;

900 
size_t
 
objËn
;

901 
sds
 
o
;

903 
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

904 ià(
c
->
buåos
 > 0) {

905 
nwr™‹n
 = 
	`wr™e
(
fd
,
c
->
buf
+c->
£ÁËn
,c->
buåos
-c->sentlen);

906 ià(
nwr™‹n
 <= 0) ;

907 
c
->
£ÁËn
 +ğ
nwr™‹n
;

908 
tÙwr™‹n
 +ğ
nwr™‹n
;

912 ià(()
c
->
£ÁËn
 =ğc->
buåos
) {

913 
c
->
buåos
 = 0;

914 
c
->
£ÁËn
 = 0;

917 
o
 = 
	`li¡NodeV®ue
(
	`li¡Fœ¡
(
c
->
»¶y
));

918 
objËn
 = 
	`sd¦’
(
o
);

920 ià(
objËn
 == 0) {

921 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

925 
nwr™‹n
 = 
	`wr™e
(
fd
, 
o
 + 
c
->
£ÁËn
, 
objËn
 - c->sentlen);

926 ià(
nwr™‹n
 <= 0) ;

927 
c
->
£ÁËn
 +ğ
nwr™‹n
;

928 
tÙwr™‹n
 +ğ
nwr™‹n
;

931 ià(
c
->
£ÁËn
 =ğ
objËn
) {

932 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

933 
c
->
£ÁËn
 = 0;

934 
c
->
»¶y_by‹s
 -ğ
objËn
;

937 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0)

938 
	`£rv”As£¹
(
c
->
»¶y_by‹s
 == 0);

953 ià(
tÙwr™‹n
 > 
NET_MAX_WRITES_PER_EVENT
 &&

954 (
£rv”
.
maxmemÜy
 == 0 ||

955 
	`zm®loc_u£d_memÜy
(è< 
£rv”
.
maxmemÜy
) &&

956 !(
c
->
æags
 & 
CLIENT_SLAVE
)) ;

958 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
tÙwr™‹n
;

959 ià(
nwr™‹n
 == -1) {

960 ià(
”ºo
 =ğ
EAGAIN
) {

961 
nwr™‹n
 = 0;

963 
	`£rv”Log
(
LL_VERBOSE
,

964 "E¼Ü wr™šgØş›Á: %s", 
	`¡»¼Ü
(
”ºo
));

965 
	`ä“Cl›Á
(
c
);

966  
C_ERR
;

969 ià(
tÙwr™‹n
 > 0) {

974 ià(!(
c
->
æags
 & 
CLIENT_MASTER
)èc->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

976 ià(!
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

977 
c
->
£ÁËn
 = 0;

978 ià(
hªdËr_š¡®Ëd
è
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_WRITABLE
);

981 ià(
c
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
) {

982 
	`ä“Cl›Á
(
c
);

983  
C_ERR
;

986  
C_OK
;

987 
	}
}

990 
	$£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

991 
	`UNUSED
(
–
);

992 
	`UNUSED
(
mask
);

993 
	`wr™eToCl›Á
(
fd
,
´ivd©a
,1);

994 
	}
}

1000 
	$hªdËCl›ÁsW™hP’dšgWr™es
() {

1001 
li¡I‹r
 
li
;

1002 
li¡Node
 *
Ê
;

1003 
´oûs£d
 = 
	`li¡L’gth
(
£rv”
.
ş›Ás_³ndšg_wr™e
);

1005 
	`li¡Rewšd
(
£rv”
.
ş›Ás_³ndšg_wr™e
,&
li
);

1006 (
Ê
 = 
	`li¡Next
(&
li
))) {

1007 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

1008 
c
->
æags
 &ğ~
CLIENT_PENDING_WRITE
;

1009 
	`li¡D–Node
(
£rv”
.
ş›Ás_³ndšg_wr™e
,
Ê
);

1012 ià(
	`wr™eToCl›Á
(
c
->
fd
,c,0è=ğ
C_ERR
) ;

1016 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

1017 
«_æags
 = 
AE_WRITABLE
;

1023 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
 &&

1024 
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
)

1026 
«_æags
 |ğ
AE_BARRIER
;

1028 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
c
->
fd
, 
«_æags
,

1029 
£ndR•lyToCl›Á
, 
c
è=ğ
AE_ERR
)

1031 
	`ä“Cl›ÁAsync
(
c
);

1035  
´oûs£d
;

1036 
	}
}

1039 
	$»£tCl›Á
(
ş›Á
 *
c
) {

1040 
»disCommªdProc
 *
´evcmd
 = 
c
->
cmd
 ? c->cmd->
´oc
 : 
NULL
;

1042 
	`ä“Cl›ÁArgv
(
c
);

1043 
c
->
»qty³
 = 0;

1044 
c
->
muÉibulkËn
 = 0;

1045 
c
->
bulkËn
 = -1;

1049 ià(!(
c
->
æags
 & 
CLIENT_MULTI
è&& 
´evcmd
 !ğ
askšgCommªd
)

1050 
c
->
æags
 &ğ~
CLIENT_ASKING
;

1055 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP
;

1056 ià(
c
->
æags
 & 
CLIENT_REPLY_SKIP_NEXT
) {

1057 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP
;

1058 
c
->
æags
 &ğ~
CLIENT_REPLY_SKIP_NEXT
;

1060 
	}
}

1069 
	$´oûssIÆšeBufãr
(
ş›Á
 *
c
) {

1070 *
Ãwlše
;

1071 
¬gc
, 
j
;

1072 
sds
 *
¬gv
, 
aux
;

1073 
size_t
 
qu”yËn
;

1076 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\n');

1079 ià(
Ãwlše
 =ğ
NULL
) {

1080 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1081 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big inline„equest");

1082 
	`£tPrÙocŞE¼Ü
("toØbig iÆš»que¡",
c
,0);

1084  
C_ERR
;

1088 ià(
Ãwlše
 &&‚ewlš!ğ
c
->
qu”ybuf
 && *(newline-1) == '\r')

1089 
Ãwlše
--;

1092 
qu”yËn
 = 
Ãwlše
-(
c
->
qu”ybuf
);

1093 
aux
 = 
	`sd¢ewËn
(
c
->
qu”ybuf
,
qu”yËn
);

1094 
¬gv
 = 
	`sds¥l™¬gs
(
aux
,&
¬gc
);

1095 
	`sdsä“
(
aux
);

1096 ià(
¬gv
 =ğ
NULL
) {

1097 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: unbalanced quotes in„equest");

1098 
	`£tPrÙocŞE¼Ü
("unb®ªûd quÙe š iÆš»que¡",
c
,0);

1099  
C_ERR
;

1105 ià(
qu”yËn
 =ğ0 && 
c
->
æags
 & 
CLIENT_SLAVE
)

1106 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

1109 
	`sd¤ªge
(
c
->
qu”ybuf
,
qu”yËn
+2,-1);

1112 ià(
¬gc
) {

1113 ià(
c
->
¬gv
è
	`zä“
(c->argv);

1114 
c
->
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

1118 
c
->
¬gc
 = 0, 
j
 = 0; j <‡rgc; j++) {

1119 ià(
	`sd¦’
(
¬gv
[
j
])) {

1120 
c
->
¬gv
[c->
¬gc
] = 
	`ü—‹Objeù
(
OBJ_STRING
,¬gv[
j
]);

1121 
c
->
¬gc
++;

1123 
	`sdsä“
(
¬gv
[
j
]);

1126 
	`zä“
(
¬gv
);

1127  
C_OK
;

1128 
	}
}

1132 
	#PROTO_DUMP_LEN
 128

	)

1133 
	$£tPrÙocŞE¼Ü
(cÚ¡ *
”r¡r
, 
ş›Á
 *
c
, 
pos
) {

1134 ià(
£rv”
.
v”bos™y
 <ğ
LL_VERBOSE
) {

1135 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1138 
buf
[256];

1139 ià(
	`sd¦’
(
c
->
qu”ybuf
è< 
PROTO_DUMP_LEN
) {

1140 
	`¢´štf
(
buf
,(buf),"Qu”y bufã¸duršg…rÙocŞƒ¼Ü: '%s'", 
c
->
qu”ybuf
);

1142 
	`¢´štf
(
buf
,(buf),"Qu”y bufã¸duršg…rÙocŞƒ¼Ü: '%.*s' (... mÜ%zu by‹ ...è'%.*s'", 
PROTO_DUMP_LEN
/2, 
c
->
qu”ybuf
, 
	`sd¦’
(c->querybuf)-PROTO_DUMP_LEN, PROTO_DUMP_LEN/2, c->querybuf+sdslen(c->querybuf)-PROTO_DUMP_LEN/2);

1146 *
p
 = 
buf
;

1147 *
p
 != '\0') {

1148 ià(!
	`i¥ršt
(*
p
)) *p = '.';

1149 
p
++;

1153 
	`£rv”Log
(
LL_VERBOSE
,

1154 "PrÙocŞƒ¼Ü (%sèäom cl›Á: %s. %s", 
”r¡r
, 
ş›Á
, 
buf
);

1155 
	`sdsä“
(
ş›Á
);

1157 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1158 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1159 
	}
}

1172 
	$´oûssMuÉibulkBufãr
(
ş›Á
 *
c
) {

1173 *
Ãwlše
 = 
NULL
;

1174 
pos
 = 0;

1175 
ok
;

1176 
Î
;

1178 ià(
c
->
muÉibulkËn
 == 0) {

1180 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
¬gc
 == 0);

1183 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\r');

1184 ià(
Ãwlše
 =ğ
NULL
) {

1185 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1186 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big mbulk count string");

1187 
	`£tPrÙocŞE¼Ü
("toØbig mbulk couÁ sŒšg",
c
,0);

1189  
C_ERR
;

1193 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1194  
C_ERR
;

1198 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
qu”ybuf
[0] == '*');

1199 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+1,
Ãwlše
-(c->qu”ybuf+1),&
Î
);

1200 ià(!
ok
 || 
Î
 > 1024*1024) {

1201 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid multibulk†ength");

1202 
	`£tPrÙocŞE¼Ü
("šv®id mbulk couÁ",
c
,
pos
);

1203  
C_ERR
;

1206 
pos
 = (
Ãwlše
-
c
->
qu”ybuf
)+2;

1207 ià(
Î
 <= 0) {

1208 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1209  
C_OK
;

1212 
c
->
muÉibulkËn
 = 
Î
;

1215 ià(
c
->
¬gv
è
	`zä“
(c->argv);

1216 
c
->
¬gv
 = 
	`zm®loc
((
robj
*)*c->
muÉibulkËn
);

1219 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
muÉibulkËn
 > 0);

1220 
c
->
muÉibulkËn
) {

1222 ià(
c
->
bulkËn
 == -1) {

1223 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
+
pos
,'\r');

1224 ià(
Ãwlše
 =ğ
NULL
) {

1225 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
PROTO_INLINE_MAX_SIZE
) {

1226 
	`addR•lyE¼Ü
(
c
,

1228 
	`£tPrÙocŞE¼Ü
("toØbig bulk couÁ sŒšg",
c
,0);

1229  
C_ERR
;

1235 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1238 ià(
c
->
qu”ybuf
[
pos
] != '$') {

1239 
	`addR•lyE¼ÜFÜm©
(
c
,

1241 
c
->
qu”ybuf
[
pos
]);

1242 
	`£tPrÙocŞE¼Ü
("ex³ùed $ buˆgÙ som‘hšgƒl£",
c
,
pos
);

1243  
C_ERR
;

1246 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+
pos
+1,
Ãwlše
-(c->qu”ybuf+pos+1),&
Î
);

1247 ià(!
ok
 || 
Î
 < 0 ||†È> 
£rv”
.
´Ùo_max_bulk_Ën
) {

1248 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid bulk†ength");

1249 
	`£tPrÙocŞE¼Ü
("šv®id bulk†’gth",
c
,
pos
);

1250  
C_ERR
;

1253 
pos
 +ğ
Ãwlše
-(
c
->
qu”ybuf
+pos)+2;

1254 ià(
Î
 >ğ
PROTO_MBULK_BIG_ARG
) {

1255 
size_t
 
qbËn
;

1261 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1262 
pos
 = 0;

1263 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1266 ià(
qbËn
 < (
size_t
)
Î
+2)

1267 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf,
Î
+2-
qbËn
);

1269 
c
->
bulkËn
 = 
Î
;

1273 ià(
	`sd¦’
(
c
->
qu”ybuf
)-
pos
 < (
size_t
)(c->
bulkËn
+2)) {

1280 ià(
pos
 == 0 &&

1281 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
 &&

1282 
	`sd¦’
(
c
->
qu”ybuf
è=ğ(
size_t
)(c->
bulkËn
+2))

1284 
c
->
¬gv
[c->
¬gc
++] = 
	`ü—‹Objeù
(
OBJ_STRING
,c->
qu”ybuf
);

1285 
	`sdsInüL’
(
c
->
qu”ybuf
,-2);

1288 
c
->
qu”ybuf
 = 
	`sd¢ewËn
(
NULL
,c->
bulkËn
+2);

1289 
	`sdsş—r
(
c
->
qu”ybuf
);

1290 
pos
 = 0;

1292 
c
->
¬gv
[c->
¬gc
++] =

1293 
	`ü—‹SŒšgObjeù
(
c
->
qu”ybuf
+
pos
,c->
bulkËn
);

1294 
pos
 +ğ
c
->
bulkËn
+2;

1296 
c
->
bulkËn
 = -1;

1297 
c
->
muÉibulkËn
--;

1302 ià(
pos
è
	`sd¤ªge
(
c
->
qu”ybuf
,pos,-1);

1305 ià(
c
->
muÉibulkËn
 =ğ0è 
C_OK
;

1308  
C_ERR
;

1309 
	}
}

1315 
	$´oûssIÅutBufãr
(
ş›Á
 *
c
) {

1316 
£rv”
.
cu¼’t_ş›Á
 = 
c
;

1318 
	`sd¦’
(
c
->
qu”ybuf
)) {

1320 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
è&& 
	`ş›ÁsA»Pau£d
()) ;

1323 ià(
c
->
æags
 & 
CLIENT_BLOCKED
) ;

1330 ià(
c
->
æags
 & (
CLIENT_CLOSE_AFTER_REPLY
|
CLIENT_CLOSE_ASAP
)) ;

1333 ià(!
c
->
»qty³
) {

1334 ià(
c
->
qu”ybuf
[0] == '*') {

1335 
c
->
»qty³
 = 
PROTO_REQ_MULTIBULK
;

1337 
c
->
»qty³
 = 
PROTO_REQ_INLINE
;

1341 ià(
c
->
»qty³
 =ğ
PROTO_REQ_INLINE
) {

1342 ià(
	`´oûssIÆšeBufãr
(
c
è!ğ
C_OK
) ;

1343 } ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
) {

1344 ià(
	`´oûssMuÉibulkBufãr
(
c
è!ğ
C_OK
) ;

1346 
	`£rv”Pªic
("Unknown„equestype");

1350 ià(
c
->
¬gc
 == 0) {

1351 
	`»£tCl›Á
(
c
);

1354 ià(
	`´oûssCommªd
(
c
è=ğ
C_OK
) {

1355 ià(
c
->
æags
 & 
CLIENT_MASTER
 && !(c->æag & 
CLIENT_MULTI
)) {

1357 
c
->
»¶off
 = c->
»ad_»¶off
 - 
	`sd¦’
(c->
qu”ybuf
);

1364 ià(!(
c
->
æags
 & 
CLIENT_BLOCKED
è|| c->
bty³
 !ğ
BLOCKED_MODULE
)

1365 
	`»£tCl›Á
(
c
);

1370 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
NULL
) ;

1373 
£rv”
.
cu¼’t_ş›Á
 = 
NULL
;

1374 
	}
}

1376 
	$»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1377 
ş›Á
 *
c
 = (ş›Á*è
´ivd©a
;

1378 
Ä—d
, 
»adËn
;

1379 
size_t
 
qbËn
;

1380 
	`UNUSED
(
–
);

1381 
	`UNUSED
(
mask
);

1383 
»adËn
 = 
PROTO_IOBUF_LEN
;

1390 ià(
c
->
»qty³
 =ğ
PROTO_REQ_MULTIBULK
 && c->
muÉibulkËn
 && c->
bulkËn
 != -1

1391 && 
c
->
bulkËn
 >ğ
PROTO_MBULK_BIG_ARG
)

1393 
ssize_t
 
»maššg
 = (
size_t
)(
c
->
bulkËn
+2)-
	`sd¦’
(c->
qu”ybuf
);

1395 ià(
»maššg
 < 
»adËn
)„eadlen =„emaining;

1398 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1399 ià(
c
->
qu”ybuf_³ak
 < 
qbËn
) c->querybuf_peak = qblen;

1400 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf, 
»adËn
);

1402 
Ä—d
 = 
	`»ad
(
fd
, 
c
->
qu”ybuf
+
qbËn
, 
»adËn
);

1404 ià(
Ä—d
 == -1) {

1405 ià(
”ºo
 =ğ
EAGAIN
) {

1408 
	`£rv”Log
(
LL_VERBOSE
, "R—dšg from cl›Á: %s",
	`¡»¼Ü
(
”ºo
));

1409 
	`ä“Cl›Á
(
c
);

1412 } ià(
Ä—d
 == 0) {

1413 
	`£rv”Log
(
LL_VERBOSE
, "Client closed connection");

1414 
	`ä“Cl›Á
(
c
);

1416 } ià(
c
->
æags
 & 
CLIENT_MASTER
) {

1420 
c
->
³ndšg_qu”ybuf
 = 
	`sdsÿ’
(c->pending_querybuf,

1421 
c
->
qu”ybuf
+
qbËn
,
Ä—d
);

1424 
	`sdsInüL’
(
c
->
qu”ybuf
,
Ä—d
);

1425 
c
->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

1426 ià(
c
->
æags
 & 
CLIENT_MASTER
èc->
»ad_»¶off
 +ğ
Ä—d
;

1427 
£rv”
.
¡©_Ãt_šput_by‹s
 +ğ
Ä—d
;

1428 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
£rv”
.
ş›Á_max_qu”ybuf_Ën
) {

1429 
sds
 
ci
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
), 
by‹s
 = sdsempty();

1431 
by‹s
 = 
	`sdsÿŒ•r
(by‹s,
c
->
qu”ybuf
,64);

1432 
	`£rv”Log
(
LL_WARNING
,"Closšg cl›Áh©„—ched max qu”y bufã¸Ëngth: % (qbuàš™ŸÈby‹s: %s)", 
ci
, 
by‹s
);

1433 
	`sdsä“
(
ci
);

1434 
	`sdsä“
(
by‹s
);

1435 
	`ä“Cl›Á
(
c
);

1445 ià(!(
c
->
æags
 & 
CLIENT_MASTER
)) {

1446 
	`´oûssIÅutBufãr
(
c
);

1448 
size_t
 
´ev_off£t
 = 
c
->
»¶off
;

1449 
	`´oûssIÅutBufãr
(
c
);

1450 
size_t
 
­¶›d
 = 
c
->
»¶off
 - 
´ev_off£t
;

1451 ià(
­¶›d
) {

1452 
	`»¶iÿtiÚF“dSÏvesFromMa¡”SŒ—m
(
£rv”
.
¦aves
,

1453 
c
->
³ndšg_qu”ybuf
, 
­¶›d
);

1454 
	`sd¤ªge
(
c
->
³ndšg_qu”ybuf
,
­¶›d
,-1);

1457 
	}
}

1459 
	$g‘Cl›ÁsMaxBufãrs
(*
lÚge¡_ouut_li¡
,

1460 *
bigge¡_šput_bufãr
) {

1461 
ş›Á
 *
c
;

1462 
li¡Node
 *
Ê
;

1463 
li¡I‹r
 
li
;

1464 
lŞ
 = 0, 
bib
 = 0;

1466 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1467 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1468 
c
 = 
	`li¡NodeV®ue
(
Ê
);

1470 ià(
	`li¡L’gth
(
c
->
»¶y
è> 
lŞ
)†ol =†istLength(c->reply);

1471 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
bib
) bib = sdslen(c->querybuf);

1473 *
lÚge¡_ouut_li¡
 = 
lŞ
;

1474 *
bigge¡_šput_bufãr
 = 
bib
;

1475 
	}
}

1488 
	$g’Cl›ÁP“rId
(
ş›Á
 *ş›Á, *
³”id
,

1489 
size_t
 
³”id_Ën
) {

1490 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

1492 
	`¢´štf
(
³”id
,
³”id_Ën
,"%s:0",
£rv”
.
unixsock‘
);

1495 
	`ª‘FÜm©P“r
(
ş›Á
->
fd
,
³”id
,
³”id_Ën
);

1497 
	}
}

1503 *
	$g‘Cl›ÁP“rId
(
ş›Á
 *
c
) {

1504 
³”id
[
NET_PEER_ID_LEN
];

1506 ià(
c
->
³”id
 =ğ
NULL
) {

1507 
	`g’Cl›ÁP“rId
(
c
,
³”id
,(peerid));

1508 
c
->
³”id
 = 
	`sd¢ew
(peerid);

1510  
c
->
³”id
;

1511 
	}
}

1515 
sds
 
	$ÿtCl›ÁInfoSŒšg
(
sds
 
s
, 
ş›Á
 *client) {

1516 
æags
[16], 
ev’ts
[3], *
p
;

1517 
emask
;

1519 
p
 = 
æags
;

1520 ià(
ş›Á
->
æags
 & 
CLIENT_SLAVE
) {

1521 ià(
ş›Á
->
æags
 & 
CLIENT_MONITOR
)

1522 *
p
++ = 'O';

1524 *
p
++ = 'S';

1526 ià(
ş›Á
->
æags
 & 
CLIENT_MASTER
è*
p
++ = 'M';

1527 ià(
ş›Á
->
æags
 & 
CLIENT_MULTI
è*
p
++ = 'x';

1528 ià(
ş›Á
->
æags
 & 
CLIENT_BLOCKED
è*
p
++ = 'b';

1529 ià(
ş›Á
->
æags
 & 
CLIENT_DIRTY_CAS
è*
p
++ = 'd';

1530 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_AFTER_REPLY
è*
p
++ = 'c';

1531 ià(
ş›Á
->
æags
 & 
CLIENT_UNBLOCKED
è*
p
++ = 'u';

1532 ià(
ş›Á
->
æags
 & 
CLIENT_CLOSE_ASAP
è*
p
++ = 'A';

1533 ià(
ş›Á
->
æags
 & 
CLIENT_UNIX_SOCKET
è*
p
++ = 'U';

1534 ià(
ş›Á
->
æags
 & 
CLIENT_READONLY
è*
p
++ = 'r';

1535 ià(
p
 =ğ
æags
) *p++ = 'N';

1536 *
p
++ = '\0';

1538 
emask
 = 
ş›Á
->
fd
 =ğ-1 ? 0 : 
	`«G‘FeEv’ts
(
£rv”
.
–
,client->fd);

1539 
p
 = 
ev’ts
;

1540 ià(
emask
 & 
AE_READABLE
è*
p
++ = 'r';

1541 ià(
emask
 & 
AE_WRITABLE
è*
p
++ = 'w';

1542 *
p
 = '\0';

1543  
	`sdsÿtfmt
(
s
,

1545 (è
ş›Á
->
id
,

1546 
	`g‘Cl›ÁP“rId
(
ş›Á
),

1547 
ş›Á
->
fd
,

1548 
ş›Á
->
Çme
 ? (*)ş›Á->Çme->
±r
 : "",

1549 ()(
£rv”
.
unixtime
 - 
ş›Á
->
ùime
),

1550 ()(
£rv”
.
unixtime
 - 
ş›Á
->
Ï¡š‹¿ùiÚ
),

1551 
æags
,

1552 
ş›Á
->
db
->
id
,

1553 (è
	`diùSize
(
ş›Á
->
pubsub_chªÃls
),

1554 (è
	`li¡L’gth
(
ş›Á
->
pubsub_·‰”ns
),

1555 (
ş›Á
->
æags
 & 
CLIENT_MULTI
è? cl›Á->
m¡©e
.
couÁ
 : -1,

1556 (è
	`sd¦’
(
ş›Á
->
qu”ybuf
),

1557 (è
	`sd§va
(
ş›Á
->
qu”ybuf
),

1558 (è
ş›Á
->
buåos
,

1559 (è
	`li¡L’gth
(
ş›Á
->
»¶y
),

1560 (è
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
),

1561 
ev’ts
,

1562 
ş›Á
->
Ï¡cmd
 ? cl›Á->Ï¡cmd->
Çme
 : "NULL");

1563 
	}
}

1565 
sds
 
	$g‘AÎCl›ÁsInfoSŒšg
() {

1566 
li¡Node
 *
Ê
;

1567 
li¡I‹r
 
li
;

1568 
ş›Á
 *client;

1569 
sds
 
o
 = 
	`sd¢ewËn
(
NULL
,200*
	`li¡L’gth
(
£rv”
.
ş›Ás
));

1570 
	`sdsş—r
(
o
);

1571 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1572 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1573 
ş›Á
 = 
	`li¡NodeV®ue
(
Ê
);

1574 
o
 = 
	`ÿtCl›ÁInfoSŒšg
(o,
ş›Á
);

1575 
o
 = 
	`sdsÿ’
(o,"\n",1);

1577  
o
;

1578 
	}
}

1580 
	$ş›ÁCommªd
(
ş›Á
 *
c
) {

1581 
li¡Node
 *
Ê
;

1582 
li¡I‹r
 
li
;

1583 
ş›Á
 *client;

1585 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"li¡"è&& c->
¬gc
 == 2) {

1587 
sds
 
o
 = 
	`g‘AÎCl›ÁsInfoSŒšg
();

1588 
	`addR•lyBulkCBufãr
(
c
,
o
,
	`sd¦’
(o));

1589 
	`sdsä“
(
o
);

1590 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»¶y"è&& c->
¬gc
 == 3) {

1592 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"on")) {

1593 
c
->
æags
 &ğ~(
CLIENT_REPLY_SKIP
|
CLIENT_REPLY_OFF
);

1594 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1595 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"off")) {

1596 
c
->
æags
 |ğ
CLIENT_REPLY_OFF
;

1597 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"skip")) {

1598 ià(!(
c
->
æags
 & 
CLIENT_REPLY_OFF
))

1599 
c
->
æags
 |ğ
CLIENT_REPLY_SKIP_NEXT
;

1601 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1604 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"kill")) {

1607 *
addr
 = 
NULL
;

1608 
ty³
 = -1;

1609 
ušt64_t
 
id
 = 0;

1610 
skme
 = 1;

1611 
kËd
 = 0, 
şo£_this_ş›Á
 = 0;

1613 ià(
c
->
¬gc
 == 3) {

1615 
addr
 = 
c
->
¬gv
[2]->
±r
;

1616 
skme
 = 0;

1617 } ià(
c
->
¬gc
 > 3) {

1618 
i
 = 2;

1621 
i
 < 
c
->
¬gc
) {

1622 
mÜ—rgs
 = 
c
->
¬gc
 > 
i
+1;

1624 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"id"è&& 
mÜ—rgs
) {

1625 
tmp
;

1627 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
i
+1],&
tmp
,
NULL
)

1628 !ğ
C_OK
) ;

1629 
id
 = 
tmp
;

1630 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"ty³"è&& 
mÜ—rgs
) {

1631 
ty³
 = 
	`g‘Cl›ÁTy³ByName
(
c
->
¬gv
[
i
+1]->
±r
);

1632 ià(
ty³
 == -1) {

1633 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown clientype '%s'",

1634 (*è
c
->
¬gv
[
i
+1]->
±r
);

1637 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"addr"è&& 
mÜ—rgs
) {

1638 
addr
 = 
c
->
¬gv
[
i
+1]->
±r
;

1639 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"skme"è&& 
mÜ—rgs
) {

1640 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"yes")) {

1641 
skme
 = 1;

1642 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"no")) {

1643 
skme
 = 0;

1645 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1649 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1652 
i
 += 2;

1655 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1660 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1661 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1662 
ş›Á
 = 
	`li¡NodeV®ue
(
Ê
);

1663 ià(
addr
 && 
	`¡rcmp
(
	`g‘Cl›ÁP“rId
(
ş›Á
),addr) != 0) ;

1664 ià(
ty³
 !ğ-1 && 
	`g‘Cl›ÁTy³
(
ş›Á
) !=ype) ;

1665 ià(
id
 !ğ0 && 
ş›Á
->id != id) ;

1666 ià(
c
 =ğ
ş›Á
 && 
skme
) ;

1669 ià(
c
 =ğ
ş›Á
) {

1670 
şo£_this_ş›Á
 = 1;

1672 
	`ä“Cl›Á
(
ş›Á
);

1674 
kËd
++;

1678 ià(
c
->
¬gc
 == 3) {

1679 ià(
kËd
 == 0)

1680 
	`addR•lyE¼Ü
(
c
,"No such client");

1682 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1684 
	`addR•lyLÚgLÚg
(
c
,
kËd
);

1689 ià(
şo£_this_ş›Á
è
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1690 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£Šame"è&& c->
¬gc
 == 3) {

1691 
j
, 
Ën
 = 
	`sd¦’
(
c
->
¬gv
[2]->
±r
);

1692 *
p
 = 
c
->
¬gv
[2]->
±r
;

1696 ià(
Ën
 == 0) {

1697 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

1698 
c
->
Çme
 = 
NULL
;

1699 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1706 
j
 = 0; j < 
Ën
; j++) {

1707 ià(
p
[
j
] < '!' ||…[j] > '~') {

1708 
	`addR•lyE¼Ü
(
c
,

1714 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

1715 
c
->
Çme
 = c->
¬gv
[2];

1716 
	`šüRefCouÁ
(
c
->
Çme
);

1717 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1718 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘Çme"è&& c->
¬gc
 == 2) {

1719 ià(
c
->
Çme
)

1720 
	`addR•lyBulk
(
c
,c->
Çme
);

1722 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1723 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"·u£"è&& c->
¬gc
 == 3) {

1724 
du¿tiÚ
;

1726 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
du¿tiÚ
,
UNIT_MILLISECONDS
)

1727 !ğ
C_OK
) ;

1728 
	`·u£Cl›Ás
(
du¿tiÚ
);

1729 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1731 
	`addR•lyE¼Ü
(
c
, "Syntaxƒrror,ry CLIENT (LIST | KILL | GETNAME | SETNAME | PAUSE | REPLY)");

1733 
	}
}

1744 
	$£cur™yW¬nšgCommªd
(
ş›Á
 *
c
) {

1745 
time_t
 
logged_time
;

1746 
time_t
 
now
 = 
	`time
(
NULL
);

1748 ià(
	`Ïbs
(
now
-
logged_time
) > 60) {

1749 
	`£rv”Log
(
LL_WARNING
,"Possible SECURITY ATTACK detected. It†ooks†ike somebody is sending POST or Host: commandso Redis. This is†ikely dueo‡n‡ttacker‡ttemptingo use Cross Protocol Scriptingo compromise your Redis instance. Connection‡borted.");

1750 
logged_time
 = 
now
;

1752 
	`ä“Cl›ÁAsync
(
c
);

1753 
	}
}

1758 
	$»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...) {

1759 
va_li¡
 
­
;

1760 
j
;

1761 
robj
 **
¬gv
;

1763 
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

1764 
	`va_¡¬t
(
­
,
¬gc
);

1765 
j
 = 0; j < 
¬gc
; j++) {

1766 
robj
 *
a
;

1768 
a
 = 
	`va_¬g
(
­
, 
robj
*);

1769 
¬gv
[
j
] = 
a
;

1770 
	`šüRefCouÁ
(
a
);

1775 
j
 = 0; j < 
c
->
¬gc
; j++è
	`deüRefCouÁ
(c->
¬gv
[j]);

1776 
	`zä“
(
c
->
¬gv
);

1778 
c
->
¬gv
 =‡rgv;

1779 
c
->
¬gc
 =‡rgc;

1780 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1781 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1782 
	`va_’d
(
­
);

1783 
	}
}

1786 
	$»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
) {

1787 
	`ä“Cl›ÁArgv
(
c
);

1788 
	`zä“
(
c
->
¬gv
);

1789 
c
->
¬gv
 =‡rgv;

1790 
c
->
¬gc
 =‡rgc;

1791 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1792 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1793 
	}
}

1806 
	$»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
) {

1807 
robj
 *
Şdv®
;

1809 ià(
i
 >ğ
c
->
¬gc
) {

1810 
c
->
¬gv
 = 
	`z»®loc
(c->¬gv,(
robj
*)*(
i
+1));

1811 
c
->
¬gc
 = 
i
+1;

1812 
c
->
¬gv
[
i
] = 
NULL
;

1814 
Şdv®
 = 
c
->
¬gv
[
i
];

1815 
c
->
¬gv
[
i
] = 
Ãwv®
;

1816 
	`šüRefCouÁ
(
Ãwv®
);

1817 ià(
Şdv®
è
	`deüRefCouÁ
(oldval);

1820 ià(
i
 == 0) {

1821 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1822 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1824 
	}
}

1839 
	$g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
) {

1840 
li¡_™em_size
 = (
li¡Node
)+5;

1844  
c
->
»¶y_by‹s
 + (
li¡_™em_size
*
	`li¡L’gth
(c->
»¶y
));

1845 
	}
}

1856 
	$g‘Cl›ÁTy³
(
ş›Á
 *
c
) {

1857 ià(
c
->
æags
 & 
CLIENT_MASTER
è 
CLIENT_TYPE_MASTER
;

1858 ià((
c
->
æags
 & 
CLIENT_SLAVE
è&& !(c->æag & 
CLIENT_MONITOR
))

1859  
CLIENT_TYPE_SLAVE
;

1860 ià(
c
->
æags
 & 
CLIENT_PUBSUB
è 
CLIENT_TYPE_PUBSUB
;

1861  
CLIENT_TYPE_NORMAL
;

1862 
	}
}

1864 
	$g‘Cl›ÁTy³ByName
(*
Çme
) {

1865 ià(!
	`¡rÿ£cmp
(
Çme
,"nÜm®")è 
CLIENT_TYPE_NORMAL
;

1866 ià(!
	`¡rÿ£cmp
(
Çme
,"¦ave")è 
CLIENT_TYPE_SLAVE
;

1867 ià(!
	`¡rÿ£cmp
(
Çme
,"pubsub")è 
CLIENT_TYPE_PUBSUB
;

1868 ià(!
	`¡rÿ£cmp
(
Çme
,"ma¡”")è 
CLIENT_TYPE_MASTER
;

1870 
	}
}

1872 *
	$g‘Cl›ÁTy³Name
(
şass
) {

1873 
şass
) {

1874 
CLIENT_TYPE_NORMAL
:  "normal";

1875 
CLIENT_TYPE_SLAVE
:  "slave";

1876 
CLIENT_TYPE_PUBSUB
:  "pubsub";

1877 
CLIENT_TYPE_MASTER
:  "master";

1878 :  
NULL
;

1880 
	}
}

1888 
	$checkCl›ÁOuutBufãrLim™s
(
ş›Á
 *
c
) {

1889 
soá
 = 0, 
h¬d
 = 0, 
şass
;

1890 
u£d_mem
 = 
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
c
);

1892 
şass
 = 
	`g‘Cl›ÁTy³
(
c
);

1895 ià(
şass
 =ğ
CLIENT_TYPE_MASTER
èşas ğ
CLIENT_TYPE_NORMAL
;

1897 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 &&

1898 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
)

1899 
h¬d
 = 1;

1900 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 &&

1901 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
)

1902 
soá
 = 1;

1906 ià(
soá
) {

1907 ià(
c
->
obuf_soá_lim™_»ached_time
 == 0) {

1908 
c
->
obuf_soá_lim™_»ached_time
 = 
£rv”
.
unixtime
;

1909 
soá
 = 0;

1911 
time_t
 
–­£d
 = 
£rv”
.
unixtime
 - 
c
->
obuf_soá_lim™_»ached_time
;

1913 ià(
–­£d
 <=

1914 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
) {

1915 
soá
 = 0;

1921 
c
->
obuf_soá_lim™_»ached_time
 = 0;

1923  
soá
 || 
h¬d
;

1924 
	}
}

1933 
	$asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
) {

1934 
	`£rv”As£¹
(
c
->
»¶y_by‹s
 < 
SIZE_MAX
-(1024*64));

1935 ià(
c
->
»¶y_by‹s
 =ğ0 || c->
æags
 & 
CLIENT_CLOSE_ASAP
) ;

1936 ià(
	`checkCl›ÁOuutBufãrLim™s
(
c
)) {

1937 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1939 
	`ä“Cl›ÁAsync
(
c
);

1940 
	`£rv”Log
(
LL_WARNING
,"Cl›Á % scheduËdØbşo£d ASAP fÜ ov”comšg oàouuˆbufã¸lim™s.", 
ş›Á
);

1941 
	`sdsä“
(
ş›Á
);

1943 
	}
}

1949 
	$æushSÏvesOuutBufãrs
() {

1950 
li¡I‹r
 
li
;

1951 
li¡Node
 *
Ê
;

1953 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1954 (
Ê
 = 
	`li¡Next
(&
li
))) {

1955 
ş›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

1956 
ev’ts
;

1964 
ev’ts
 = 
	`«G‘FeEv’ts
(
£rv”
.
–
,
¦ave
->
fd
);

1965 ià(
ev’ts
 & 
AE_WRITABLE
 &&

1966 
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

1967 
	`ş›ÁHasP’dšgR•l›s
(
¦ave
))

1969 
	`wr™eToCl›Á
(
¦ave
->
fd
,slave,0);

1972 
	}
}

1991 
	$·u£Cl›Ás
(
m¡ime_t
 
’d
) {

1992 ià(!
£rv”
.
ş›Ás_·u£d
 || 
’d
 > s”v”.
ş›Ás_·u£_’d_time
)

1993 
£rv”
.
ş›Ás_·u£_’d_time
 = 
’d
;

1994 
£rv”
.
ş›Ás_·u£d
 = 1;

1995 
	}
}

1999 
	$ş›ÁsA»Pau£d
() {

2000 ià(
£rv”
.
ş›Ás_·u£d
 &&

2001 
£rv”
.
ş›Ás_·u£_’d_time
 < s”v”.
m¡ime
)

2003 
li¡Node
 *
Ê
;

2004 
li¡I‹r
 
li
;

2005 
ş›Á
 *
c
;

2007 
£rv”
.
ş›Ás_·u£d
 = 0;

2011 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

2012 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

2013 
c
 = 
	`li¡NodeV®ue
(
Ê
);

2017 ià(
c
->
æags
 & (
CLIENT_SLAVE
|
CLIENT_BLOCKED
)) ;

2018 
c
->
æags
 |ğ
CLIENT_UNBLOCKED
;

2019 
	`li¡AddNodeTa
(
£rv”
.
unblocked_ş›Ás
,
c
);

2022  
£rv”
.
ş›Ás_·u£d
;

2023 
	}
}

2037 
	$´oûssEv’tsWheBlocked
() {

2038 
™”©iÚs
 = 4;

2039 
couÁ
 = 0;

2040 
™”©iÚs
--) {

2041 
ev’ts
 = 0;

2042 
ev’ts
 +ğ
	`«ProûssEv’ts
(
£rv”
.
–
, 
AE_FILE_EVENTS
|
AE_DONT_WAIT
);

2043 
ev’ts
 +ğ
	`hªdËCl›ÁsW™hP’dšgWr™es
();

2044 ià(!
ev’ts
) ;

2045 
couÁ
 +ğ
ev’ts
;

2047  
couÁ
;

2048 
	}
}

	@src/notify.c

30 
	~"£rv”.h
"

40 
	$key¥aûEv’tsSŒšgToFÏgs
(*
şas£s
) {

41 *
p
 = 
şas£s
;

42 
c
, 
æags
 = 0;

44 (
c
 = *
p
++) != '\0') {

45 
c
) {

46 'A': 
æags
 |ğ
NOTIFY_ALL
; ;

47 'g': 
æags
 |ğ
NOTIFY_GENERIC
; ;

48 '$': 
æags
 |ğ
NOTIFY_STRING
; ;

49 'l': 
æags
 |ğ
NOTIFY_LIST
; ;

50 's': 
æags
 |ğ
NOTIFY_SET
; ;

51 'h': 
æags
 |ğ
NOTIFY_HASH
; ;

52 'z': 
æags
 |ğ
NOTIFY_ZSET
; ;

53 'x': 
æags
 |ğ
NOTIFY_EXPIRED
; ;

54 'e': 
æags
 |ğ
NOTIFY_EVICTED
; ;

55 'K': 
æags
 |ğ
NOTIFY_KEYSPACE
; ;

56 'E': 
æags
 |ğ
NOTIFY_KEYEVENT
; ;

60  
æags
;

61 
	}
}

67 
sds
 
	$key¥aûEv’tsFÏgsToSŒšg
(
æags
) {

68 
sds
 
»s
;

70 
»s
 = 
	`sd£m±y
();

71 ià((
æags
 & 
NOTIFY_ALL
) == NOTIFY_ALL) {

72 
»s
 = 
	`sdsÿ’
(res,"A",1);

74 ià(
æags
 & 
NOTIFY_GENERIC
è
»s
 = 
	`sdsÿ’
(res,"g",1);

75 ià(
æags
 & 
NOTIFY_STRING
è
»s
 = 
	`sdsÿ’
(res,"$",1);

76 ià(
æags
 & 
NOTIFY_LIST
è
»s
 = 
	`sdsÿ’
(res,"l",1);

77 ià(
æags
 & 
NOTIFY_SET
è
»s
 = 
	`sdsÿ’
(res,"s",1);

78 ià(
æags
 & 
NOTIFY_HASH
è
»s
 = 
	`sdsÿ’
(res,"h",1);

79 ià(
æags
 & 
NOTIFY_ZSET
è
»s
 = 
	`sdsÿ’
(res,"z",1);

80 ià(
æags
 & 
NOTIFY_EXPIRED
è
»s
 = 
	`sdsÿ’
(res,"x",1);

81 ià(
æags
 & 
NOTIFY_EVICTED
è
»s
 = 
	`sdsÿ’
(res,"e",1);

83 ià(
æags
 & 
NOTIFY_KEYSPACE
è
»s
 = 
	`sdsÿ’
(res,"K",1);

84 ià(
æags
 & 
NOTIFY_KEYEVENT
è
»s
 = 
	`sdsÿ’
(res,"E",1);

85  
»s
;

86 
	}
}

95 
	$nÙifyKey¥aûEv’t
(
ty³
, *
ev’t
, 
robj
 *
key
, 
dbid
) {

96 
sds
 
chª
;

97 
robj
 *
chªobj
, *
ev’tobj
;

98 
Ën
 = -1;

99 
buf
[24];

105 
	`moduËNÙifyKey¥aûEv’t
(
ty³
, 
ev’t
, 
key
, 
dbid
);

108 ià(!(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
ty³
)) ;

110 
ev’tobj
 = 
	`ü—‹SŒšgObjeù
(
ev’t
,
	`¡¾’
(event));

113 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYSPACE
) {

114 
chª
 = 
	`sd¢ewËn
("__keyspace@",11);

115 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
dbid
);

116 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

117 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

118 
chª
 = 
	`sdsÿtsds
(chª, 
key
->
±r
);

119 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

120 
	`pubsubPublishMes§ge
(
chªobj
, 
ev’tobj
);

121 
	`deüRefCouÁ
(
chªobj
);

125 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
NOTIFY_KEYEVENT
) {

126 
chª
 = 
	`sd¢ewËn
("__keyevent@",11);

127 ià(
Ën
 =ğ-1èËÀğ
	`Î2¡ršg
(
buf
,(buf),
dbid
);

128 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

129 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

130 
chª
 = 
	`sdsÿtsds
(chª, 
ev’tobj
->
±r
);

131 
chªobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
chª
);

132 
	`pubsubPublishMes§ge
(
chªobj
, 
key
);

133 
	`deüRefCouÁ
(
chªobj
);

135 
	`deüRefCouÁ
(
ev’tobj
);

136 
	}
}

	@src/object.c

31 
	~"£rv”.h
"

32 
	~<m©h.h
>

33 
	~<ùy³.h
>

35 #ifdeà
__CYGWIN__


36 
	#¡¹Şd
(
a
,
b
è(()
	`¡¹od
(×),(b)))

	)

41 
robj
 *
	$ü—‹Objeù
(
ty³
, *
±r
) {

42 
robj
 *
o
 = 
	`zm®loc
((*o));

43 
o
->
ty³
 =ype;

44 
o
->
’codšg
 = 
OBJ_ENCODING_RAW
;

45 
o
->
±r
 =…tr;

46 
o
->
»fcouÁ
 = 1;

50 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

51 
o
->
Ìu
 = (
	`LFUG‘TimeInMšu‹s
()<<8è| 
LFU_INIT_VAL
;

53 
o
->
Ìu
 = 
	`LRU_CLOCK
();

55  
o
;

56 
	}
}

69 
robj
 *
	$makeObjeùSh¬ed
(
robj
 *
o
) {

70 
	`£rv”As£¹
(
o
->
»fcouÁ
 == 1);

71 
o
->
»fcouÁ
 = 
OBJ_SHARED_REFCOUNT
;

72  
o
;

73 
	}
}

77 
robj
 *
	$ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

78  
	`ü—‹Objeù
(
OBJ_STRING
, 
	`sd¢ewËn
(
±r
,
Ën
));

79 
	}
}

84 
robj
 *
	$ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

85 
robj
 *
o
 = 
	`zm®loc
(Ôobj)+(
sdshdr8
)+
Ën
+1);

86 
sdshdr8
 *
sh
 = (*)(
o
+1);

88 
o
->
ty³
 = 
OBJ_STRING
;

89 
o
->
’codšg
 = 
OBJ_ENCODING_EMBSTR
;

90 
o
->
±r
 = 
sh
+1;

91 
o
->
»fcouÁ
 = 1;

92 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

93 
o
->
Ìu
 = (
	`LFUG‘TimeInMšu‹s
()<<8è| 
LFU_INIT_VAL
;

95 
o
->
Ìu
 = 
	`LRU_CLOCK
();

98 
sh
->
Ën
 =†en;

99 
sh
->
®loc
 = 
Ën
;

100 
sh
->
æags
 = 
SDS_TYPE_8
;

101 ià(
±r
) {

102 
	`memıy
(
sh
->
buf
,
±r
,
Ën
);

103 
sh
->
buf
[
Ën
] = '\0';

105 
	`mem£t
(
sh
->
buf
,0,
Ën
+1);

107  
o
;

108 
	}
}

116 
	#OBJ_ENCODING_EMBSTR_SIZE_LIMIT
 44

	)

117 
robj
 *
	$ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

118 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
)

119  
	`ü—‹EmbeddedSŒšgObjeù
(
±r
,
Ën
);

121  
	`ü—‹RawSŒšgObjeù
(
±r
,
Ën
);

122 
	}
}

124 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
) {

125 
robj
 *
o
;

126 ià(
v®ue
 >ğ0 && v®u< 
OBJ_SHARED_INTEGERS
) {

127 
	`šüRefCouÁ
(
sh¬ed
.
š‹g”s
[
v®ue
]);

128 
o
 = 
sh¬ed
.
š‹g”s
[
v®ue
];

130 ià(
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
) {

131 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

132 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

133 
o
->
±r
 = (*)(()
v®ue
);

135 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sdsäomlÚglÚg
(
v®ue
));

138  
o
;

139 
	}
}

147 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
) {

148 
buf
[
MAX_LONG_DOUBLE_CHARS
];

149 
Ën
 = 
	`ld2¡ršg
(
buf
,(buf),
v®ue
,
humªä›ndly
);

150  
	`ü—‹SŒšgObjeù
(
buf
,
Ën
);

151 
	}
}

161 
robj
 *
	$dupSŒšgObjeù
(cÚ¡ 
robj
 *
o
) {

162 
robj
 *
d
;

164 
	`£rv”As£¹
(
o
->
ty³
 =ğ
OBJ_STRING
);

166 
o
->
’codšg
) {

167 
OBJ_ENCODING_RAW
:

168  
	`ü—‹RawSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

169 
OBJ_ENCODING_EMBSTR
:

170  
	`ü—‹EmbeddedSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

171 
OBJ_ENCODING_INT
:

172 
d
 = 
	`ü—‹Objeù
(
OBJ_STRING
, 
NULL
);

173 
d
->
’codšg
 = 
OBJ_ENCODING_INT
;

174 
d
->
±r
 = 
o
->ptr;

175  
d
;

177 
	`£rv”Pªic
("Wrongƒncoding.");

180 
	}
}

182 
robj
 *
	$ü—‹Quickli¡Objeù
() {

183 
quickli¡
 *
l
 = 
	`quickli¡C»©e
();

184 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
l
);

185 
o
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

186  
o
;

187 
	}
}

189 
robj
 *
	$ü—‹Zli¡Objeù
() {

190 *
zl
 = 
	`zli¡New
();

191 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_LIST
,
zl
);

192 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

193  
o
;

194 
	}
}

196 
robj
 *
	$ü—‹S‘Objeù
() {

197 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

198 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
d
);

199 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

200  
o
;

201 
	}
}

203 
robj
 *
	$ü—‹IÁ£tObjeù
() {

204 
št£t
 *
is
 = 
	`št£tNew
();

205 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_SET
,
is
);

206 
o
->
’codšg
 = 
OBJ_ENCODING_INTSET
;

207  
o
;

208 
	}
}

210 
robj
 *
	$ü—‹HashObjeù
() {

211 *
zl
 = 
	`zli¡New
();

212 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_HASH
, 
zl
);

213 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

214  
o
;

215 
	}
}

217 
robj
 *
	$ü—‹Z£tObjeù
() {

218 
z£t
 *
zs
 = 
	`zm®loc
((*zs));

219 
robj
 *
o
;

221 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

222 
zs
->
z¦
 = 
	`z¦C»©e
();

223 
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zs
);

224 
o
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

225  
o
;

226 
	}
}

228 
robj
 *
	$ü—‹Z£tZli¡Objeù
() {

229 *
zl
 = 
	`zli¡New
();

230 
robj
 *
o
 = 
	`ü—‹Objeù
(
OBJ_ZSET
,
zl
);

231 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

232  
o
;

233 
	}
}

235 
robj
 *
	$ü—‹ModuËObjeù
(
moduËTy³
 *
mt
, *
v®ue
) {

236 
moduËV®ue
 *
mv
 = 
	`zm®loc
((*mv));

237 
mv
->
ty³
 = 
mt
;

238 
mv
->
v®ue
 = value;

239  
	`ü—‹Objeù
(
OBJ_MODULE
,
mv
);

240 
	}
}

242 
	$ä“SŒšgObjeù
(
robj
 *
o
) {

243 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
) {

244 
	`sdsä“
(
o
->
±r
);

246 
	}
}

248 
	$ä“Li¡Objeù
(
robj
 *
o
) {

249 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

250 
	`quickli¡R–—£
(
o
->
±r
);

252 
	`£rv”Pªic
("Unknown†istƒncodingype");

254 
	}
}

256 
	$ä“S‘Objeù
(
robj
 *
o
) {

257 
o
->
’codšg
) {

258 
OBJ_ENCODING_HT
:

259 
	`diùR–—£
((
diù
*è
o
->
±r
);

261 
OBJ_ENCODING_INTSET
:

262 
	`zä“
(
o
->
±r
);

265 
	`£rv”Pªic
("Unknown setƒncodingype");

267 
	}
}

269 
	$ä“Z£tObjeù
(
robj
 *
o
) {

270 
z£t
 *
zs
;

271 
o
->
’codšg
) {

272 
OBJ_ENCODING_SKIPLIST
:

273 
zs
 = 
o
->
±r
;

274 
	`diùR–—£
(
zs
->
diù
);

275 
	`z¦F»e
(
zs
->
z¦
);

276 
	`zä“
(
zs
);

278 
OBJ_ENCODING_ZIPLIST
:

279 
	`zä“
(
o
->
±r
);

282 
	`£rv”Pªic
("Unknown sorted setƒncoding");

284 
	}
}

286 
	$ä“HashObjeù
(
robj
 *
o
) {

287 
o
->
’codšg
) {

288 
OBJ_ENCODING_HT
:

289 
	`diùR–—£
((
diù
*è
o
->
±r
);

291 
OBJ_ENCODING_ZIPLIST
:

292 
	`zä“
(
o
->
±r
);

295 
	`£rv”Pªic
("Unknown hashƒncodingype");

298 
	}
}

300 
	$ä“ModuËObjeù
(
robj
 *
o
) {

301 
moduËV®ue
 *
mv
 = 
o
->
±r
;

302 
mv
->
ty³
->
	`ä“
(mv->
v®ue
);

303 
	`zä“
(
mv
);

304 
	}
}

306 
	$šüRefCouÁ
(
robj
 *
o
) {

307 ià(
o
->
»fcouÁ
 !ğ
OBJ_SHARED_REFCOUNT
) o->refcount++;

308 
	}
}

310 
	$deüRefCouÁ
(
robj
 *
o
) {

311 ià(
o
->
»fcouÁ
 == 1) {

312 
o
->
ty³
) {

313 
OBJ_STRING
: 
	`ä“SŒšgObjeù
(
o
); ;

314 
OBJ_LIST
: 
	`ä“Li¡Objeù
(
o
); ;

315 
OBJ_SET
: 
	`ä“S‘Objeù
(
o
); ;

316 
OBJ_ZSET
: 
	`ä“Z£tObjeù
(
o
); ;

317 
OBJ_HASH
: 
	`ä“HashObjeù
(
o
); ;

318 
OBJ_MODULE
: 
	`ä“ModuËObjeù
(
o
); ;

319 : 
	`£rv”Pªic
("Unknown objectype"); ;

321 
	`zä“
(
o
);

323 ià(
o
->
»fcouÁ
 <ğ0è
	`£rv”Pªic
("decrRefCount‡gainst„efcount <= 0");

324 ià(
o
->
»fcouÁ
 !ğ
OBJ_SHARED_REFCOUNT
) o->refcount--;

326 
	}
}

331 
	$deüRefCouÁVoid
(*
o
) {

332 
	`deüRefCouÁ
(
o
);

333 
	}
}

347 
robj
 *
	$»£tRefCouÁ
(
robj
 *
obj
) {

348 
obj
->
»fcouÁ
 = 0;

349  
obj
;

350 
	}
}

352 
	$checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
) {

353 ià(
o
->
ty³
 !=ype) {

354 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

358 
	}
}

360 
	$isSdsR•»£ÁabËAsLÚgLÚg
(
sds
 
s
, *
Îv®
) {

361  
	`¡ršg2Î
(
s
,
	`sd¦’
(s),
Îv®
è? 
C_OK
 : 
C_ERR
;

362 
	}
}

364 
	$isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
Îv®
) {

365 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

366 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

367 ià(
Îv®
è*Îv® = (è
o
->
±r
;

368  
C_OK
;

370  
	`isSdsR•»£ÁabËAsLÚgLÚg
(
o
->
±r
,
Îv®
);

372 
	}
}

375 
robj
 *
	$ŒyObjeùEncodšg
(
robj
 *
o
) {

376 
v®ue
;

377 
sds
 
s
 = 
o
->
±r
;

378 
size_t
 
Ën
;

384 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

389 ià(!
	`sdsEncodedObjeù
(
o
))  o;

394 ià(
o
->
»fcouÁ
 > 1)  o;

399 
Ën
 = 
	`sd¦’
(
s
);

400 ià(
Ën
 <ğ20 && 
	`¡ršg2l
(
s
,Ën,&
v®ue
)) {

405 ià((
£rv”
.
maxmemÜy
 == 0 ||

406 !(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_NO_SHARED_INTEGERS
)) &&

407 
v®ue
 >= 0 &&

408 
v®ue
 < 
OBJ_SHARED_INTEGERS
)

410 
	`deüRefCouÁ
(
o
);

411 
	`šüRefCouÁ
(
sh¬ed
.
š‹g”s
[
v®ue
]);

412  
sh¬ed
.
š‹g”s
[
v®ue
];

414 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
è
	`sdsä“
(o->
±r
);

415 
o
->
’codšg
 = 
OBJ_ENCODING_INT
;

416 
o
->
±r
 = (*è
v®ue
;

417  
o
;

425 ià(
Ën
 <ğ
OBJ_ENCODING_EMBSTR_SIZE_LIMIT
) {

426 
robj
 *
emb
;

428 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
)  o;

429 
emb
 = 
	`ü—‹EmbeddedSŒšgObjeù
(
s
,
	`sd¦’
(s));

430 
	`deüRefCouÁ
(
o
);

431  
emb
;

443 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
 &&

444 
	`sd§va
(
s
è> 
Ën
/10)

446 
o
->
±r
 = 
	`sdsRemoveF»eS·û
(o->ptr);

450  
o
;

451 
	}
}

455 
robj
 *
	$g‘DecodedObjeù
(
robj
 *
o
) {

456 
robj
 *
dec
;

458 ià(
	`sdsEncodedObjeù
(
o
)) {

459 
	`šüRefCouÁ
(
o
);

460  
o
;

462 ià(
o
->
ty³
 =ğ
OBJ_STRING
 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

463 
buf
[32];

465 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

466 
dec
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

467  
dec
;

469 
	`£rv”Pªic
("Unknownƒncodingype");

471 
	}
}

481 
	#REDIS_COMPARE_BINARY
 (1<<0)

	)

482 
	#REDIS_COMPARE_COLL
 (1<<1)

	)

484 
	$com·»SŒšgObjeùsW™hFÏgs
(
robj
 *
a
,„obj *
b
, 
æags
) {

485 
	`£rv”As£¹W™hInfo
(
NULL
,
a
,a->
ty³
 =ğ
OBJ_STRING
 && 
b
->type == OBJ_STRING);

486 
buç
[128], 
bufb
[128], *
a¡r
, *
b¡r
;

487 
size_t
 
®’
, 
bËn
, 
mšËn
;

489 ià(
a
 =ğ
b
)  0;

490 ià(
	`sdsEncodedObjeù
(
a
)) {

491 
a¡r
 = 
a
->
±r
;

492 
®’
 = 
	`sd¦’
(
a¡r
);

494 
®’
 = 
	`Î2¡ršg
(
buç
,(buç),(è
a
->
±r
);

495 
a¡r
 = 
buç
;

497 ià(
	`sdsEncodedObjeù
(
b
)) {

498 
b¡r
 = 
b
->
±r
;

499 
bËn
 = 
	`sd¦’
(
b¡r
);

501 
bËn
 = 
	`Î2¡ršg
(
bufb
,(bufb),(è
b
->
±r
);

502 
b¡r
 = 
bufb
;

504 ià(
æags
 & 
REDIS_COMPARE_COLL
) {

505  
	`¡rcŞl
(
a¡r
,
b¡r
);

507 
cmp
;

509 
mšËn
 = (
®’
 < 
bËn
) ?‡len : blen;

510 
cmp
 = 
	`memcmp
(
a¡r
,
b¡r
,
mšËn
);

511 ià(
cmp
 =ğ0è 
®’
-
bËn
;

512  
cmp
;

514 
	}
}

517 
	$com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

518  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_BINARY
);

519 
	}
}

522 
	$cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

523  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_COLL
);

524 
	}
}

530 
	$equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

531 ià(
a
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

532 
b
->
’codšg
 =ğ
OBJ_ENCODING_INT
){

535  
a
->
±r
 =ğ
b
->ptr;

537  
	`com·»SŒšgObjeùs
(
a
,
b
) == 0;

539 
	}
}

541 
size_t
 
	$¡ršgObjeùL’
(
robj
 *
o
) {

542 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

543 ià(
	`sdsEncodedObjeù
(
o
)) {

544  
	`sd¦’
(
o
->
±r
);

546  
	`sdig™s10
(()
o
->
±r
);

548 
	}
}

550 
	$g‘DoubËFromObjeù
(cÚ¡ 
robj
 *
o
, *
rg‘
) {

551 
v®ue
;

552 *
•Œ
;

554 ià(
o
 =ğ
NULL
) {

555 
v®ue
 = 0;

557 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

558 ià(
	`sdsEncodedObjeù
(
o
)) {

559 
”ºo
 = 0;

560 
v®ue
 = 
	`¡¹od
(
o
->
±r
, &
•Œ
);

561 ià(
	`sd¦’
(
o
->
±r
) == 0 ||

562 
	`is¥aû
(((cÚ¡ *)
o
->
±r
)[0]) ||

563 (
size_t
)(
•Œ
-(*)
o
->
±r
è!ğ
	`sd¦’
(o->ptr) ||

564 (
”ºo
 =ğ
ERANGE
 &&

565 (
v®ue
 =ğ
HUGE_VAL
 || value == -HUGE_VAL || value == 0)) ||

566 
	`i¢ª
(
v®ue
))

567  
C_ERR
;

568 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

569 
v®ue
 = ()
o
->
±r
;

571 
	`£rv”Pªic
("Unknown stringƒncoding");

574 *
rg‘
 = 
v®ue
;

575  
C_OK
;

576 
	}
}

578 
	$g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

579 
v®ue
;

580 ià(
	`g‘DoubËFromObjeù
(
o
, &
v®ue
è!ğ
C_OK
) {

581 ià(
msg
 !ğ
NULL
) {

582 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

584 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

586  
C_ERR
;

588 *
rg‘
 = 
v®ue
;

589  
C_OK
;

590 
	}
}

592 
	$g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
) {

593 
v®ue
;

594 *
•Œ
;

596 ià(
o
 =ğ
NULL
) {

597 
v®ue
 = 0;

599 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

600 ià(
	`sdsEncodedObjeù
(
o
)) {

601 
”ºo
 = 0;

602 
v®ue
 = 
	`¡¹Şd
(
o
->
±r
, &
•Œ
);

603 ià(
	`sd¦’
(
o
->
±r
) == 0 ||

604 
	`is¥aû
(((cÚ¡ *)
o
->
±r
)[0]) ||

605 (
size_t
)(
•Œ
-(*)
o
->
±r
è!ğ
	`sd¦’
(o->ptr) ||

606 (
”ºo
 =ğ
ERANGE
 &&

607 (
v®ue
 =ğ
HUGE_VAL
 || value == -HUGE_VAL || value == 0)) ||

608 
	`i¢ª
(
v®ue
))

609  
C_ERR
;

610 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

611 
v®ue
 = ()
o
->
±r
;

613 
	`£rv”Pªic
("Unknown stringƒncoding");

616 *
rg‘
 = 
v®ue
;

617  
C_OK
;

618 
	}
}

620 
	$g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

621 
v®ue
;

622 ià(
	`g‘LÚgDoubËFromObjeù
(
o
, &
v®ue
è!ğ
C_OK
) {

623 ià(
msg
 !ğ
NULL
) {

624 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

626 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

628  
C_ERR
;

630 *
rg‘
 = 
v®ue
;

631  
C_OK
;

632 
	}
}

634 
	$g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
) {

635 
v®ue
;

637 ià(
o
 =ğ
NULL
) {

638 
v®ue
 = 0;

640 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
OBJ_STRING
);

641 ià(
	`sdsEncodedObjeù
(
o
)) {

642 ià(
	`¡ršg2Î
(
o
->
±r
,
	`sd¦’
(o->±r),&
v®ue
è=ğ0è 
C_ERR
;

643 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

644 
v®ue
 = ()
o
->
±r
;

646 
	`£rv”Pªic
("Unknown stringƒncoding");

649 ià(
rg‘
è*rg‘ = 
v®ue
;

650  
C_OK
;

651 
	}
}

653 
	$g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

654 
v®ue
;

655 ià(
	`g‘LÚgLÚgFromObjeù
(
o
, &
v®ue
è!ğ
C_OK
) {

656 ià(
msg
 !ğ
NULL
) {

657 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

659 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡n integer or out of„ange");

661  
C_ERR
;

663 *
rg‘
 = 
v®ue
;

664  
C_OK
;

665 
	}
}

667 
	$g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

668 
v®ue
;

670 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
o
, &
v®ue
, 
msg
è!ğ
C_OK
è 
C_ERR
;

671 ià(
v®ue
 < 
LONG_MIN
 || v®u> 
LONG_MAX
) {

672 ià(
msg
 !ğ
NULL
) {

673 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

675 
	`addR•lyE¼Ü
(
c
,"value is out of„ange");

677  
C_ERR
;

679 *
rg‘
 = 
v®ue
;

680  
C_OK
;

681 
	}
}

683 *
	$¡rEncodšg
(
’codšg
) {

684 
’codšg
) {

685 
OBJ_ENCODING_RAW
:  "raw";

686 
OBJ_ENCODING_INT
:  "int";

687 
OBJ_ENCODING_HT
:  "hashtable";

688 
OBJ_ENCODING_QUICKLIST
:  "quicklist";

689 
OBJ_ENCODING_ZIPLIST
:  "ziplist";

690 
OBJ_ENCODING_INTSET
:  "intset";

691 
OBJ_ENCODING_SKIPLIST
:  "skiplist";

692 
OBJ_ENCODING_EMBSTR
:  "embstr";

695 
	}
}

703 
	#OBJ_COMPUTE_SIZE_DEF_SAMPLES
 5

	)

704 
size_t
 
	$objeùCompu‹Size
(
robj
 *
o
, 
size_t
 
§m¶e_size
) {

705 
sds
 
–e
, 
–e2
;

706 
diù
 *
d
;

707 
diùI‹¿tÜ
 *
di
;

708 
diùEÁry
 *
de
;

709 
size_t
 
asize
 = 0, 
–esize
 = 0, 
§m¶es
 = 0;

711 ià(
o
->
ty³
 =ğ
OBJ_STRING
) {

712 if(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

713 
asize
 = (*
o
);

714 } if(
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
) {

715 
asize
 = 
	`sdsAÎocSize
(
o
->
±r
)+(*o);

716 } if(
o
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
) {

717 
asize
 = 
	`sd¦’
(
o
->
±r
)+2+(*o);

719 
	`£rv”Pªic
("Unknown stringƒncoding");

721 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

722 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

723 
quickli¡
 *
ql
 = 
o
->
±r
;

724 
quickli¡Node
 *
node
 = 
ql
->
h—d
;

725 
asize
 = (*
o
)+(
quickli¡
);

727 
–esize
 +ğ(
quickli¡Node
)+
	`zli¡BlobL’
(
node
->
zl
);

728 
§m¶es
++;

729 } (
node
 =‚ode->
Ãxt
è&& 
§m¶es
 < 
§m¶e_size
);

730 
asize
 +ğ()
–esize
/
§m¶es
*
ql
->
Ën
;

731 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

732 
asize
 = (*
o
)+
	`zli¡BlobL’
(o->
±r
);

734 
	`£rv”Pªic
("Unknown†istƒncoding");

736 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

737 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

738 
d
 = 
o
->
±r
;

739 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

740 
asize
 = (*
o
)+(
diù
)+((
diùEÁry
*)*
	`diùSlÙs
(
d
));

741 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
 && 
§m¶es
 < 
§m¶e_size
) {

742 
–e
 = 
	`diùG‘Key
(
de
);

743 
–esize
 +ğ(
diùEÁry
è+ 
	`sdsAÎocSize
(
–e
);

744 
§m¶es
++;

746 
	`diùR–—£I‹¿tÜ
(
di
);

747 ià(
§m¶es
è
asize
 +ğ()
–esize
/§m¶es*
	`diùSize
(
d
);

748 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

749 
št£t
 *
is
 = 
o
->
±r
;

750 
asize
 = (*
o
)+(*
is
)+is->
’codšg
*is->
Ëngth
;

752 
	`£rv”Pªic
("Unknown setƒncoding");

754 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

755 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

756 
asize
 = (*
o
)+(
	`zli¡BlobL’
(o->
±r
));

757 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

758 
d
 = ((
z£t
*)
o
->
±r
)->
diù
;

759 
zskli¡
 *
z¦
 = ((
z£t
*)
o
->
±r
)->zsl;

760 
zskli¡Node
 *
znode
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

761 
asize
 = (*
o
)+(
z£t
)+((
diùEÁry
*)*
	`diùSlÙs
(
d
));

762 
znode
 !ğ
NULL
 && 
§m¶es
 < 
§m¶e_size
) {

763 
–esize
 +ğ
	`sdsAÎocSize
(
znode
->
–e
);

764 
–esize
 +ğ(
diùEÁry
è+ 
	`zm®loc_size
(
znode
);

765 
§m¶es
++;

766 
znode
 = znode->
Ëv–
[0].
fÜw¬d
;

768 ià(
§m¶es
è
asize
 +ğ()
–esize
/§m¶es*
	`diùSize
(
d
);

770 
	`£rv”Pªic
("Unknown sorted setƒncoding");

772 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

773 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

774 
asize
 = (*
o
)+(
	`zli¡BlobL’
(o->
±r
));

775 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

776 
d
 = 
o
->
±r
;

777 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

778 
asize
 = (*
o
)+(
diù
)+((
diùEÁry
*)*
	`diùSlÙs
(
d
));

779 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
 && 
§m¶es
 < 
§m¶e_size
) {

780 
–e
 = 
	`diùG‘Key
(
de
);

781 
–e2
 = 
	`diùG‘V®
(
de
);

782 
–esize
 +ğ
	`sdsAÎocSize
(
–e
è+ sdsAÎocSize(
–e2
);

783 
–esize
 +ğ(
diùEÁry
);

784 
§m¶es
++;

786 
	`diùR–—£I‹¿tÜ
(
di
);

787 ià(
§m¶es
è
asize
 +ğ()
–esize
/§m¶es*
	`diùSize
(
d
);

789 
	`£rv”Pªic
("Unknown hashƒncoding");

791 } ià(
o
->
ty³
 =ğ
OBJ_MODULE
) {

792 
moduËV®ue
 *
mv
 = 
o
->
±r
;

793 
moduËTy³
 *
mt
 = 
mv
->
ty³
;

794 ià(
mt
->
mem_u§ge
 !ğ
NULL
) {

795 
asize
 = 
mt
->
	`mem_u§ge
(
mv
->
v®ue
);

797 
asize
 = 0;

800 
	`£rv”Pªic
("Unknown objectype");

802  
asize
;

803 
	}
}

806 
	$ä“MemÜyOv”h—dD©a
(
»disMemOv”h—d
 *
mh
) {

807 
	`zä“
(
mh
->
db
);

808 
	`zä“
(
mh
);

809 
	}
}

814 
»disMemOv”h—d
 *
	$g‘MemÜyOv”h—dD©a
() {

815 
j
;

816 
size_t
 
mem_tÙ®
 = 0;

817 
size_t
 
mem
 = 0;

818 
size_t
 
zm®loc_u£d
 = 
	`zm®loc_u£d_memÜy
();

819 
»disMemOv”h—d
 *
mh
 = 
	`zÿÎoc
((*mh));

821 
mh
->
tÙ®_®loÿ‹d
 = 
zm®loc_u£d
;

822 
mh
->
¡¬tup_®loÿ‹d
 = 
£rv”
.
š™Ÿl_memÜy_u§ge
;

823 
mh
->
³ak_®loÿ‹d
 = 
£rv”
.
¡©_³ak_memÜy
;

824 
mh
->
äagm’tiÚ
 =

825 
	`zm®loc_g‘_äagm’tiÚ_¿tio
(
£rv”
.
»sid’t_£t_size
);

826 
mem_tÙ®
 +ğ
£rv”
.
š™Ÿl_memÜy_u§ge
;

828 
mem
 = 0;

829 ià(
£rv”
.
»¶_backlog
)

830 
mem
 +ğ
	`zm®loc_size
(
£rv”
.
»¶_backlog
);

831 
mh
->
»¶_backlog
 = 
mem
;

832 
mem_tÙ®
 +ğ
mem
;

834 
mem
 = 0;

835 ià(
	`li¡L’gth
(
£rv”
.
¦aves
)) {

836 
li¡I‹r
 
li
;

837 
li¡Node
 *
Ê
;

839 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

840 (
Ê
 = 
	`li¡Next
(&
li
))) {

841 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

842 
mem
 +ğ
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
c
);

843 
mem
 +ğ
	`sdsAÎocSize
(
c
->
qu”ybuf
);

844 
mem
 +ğ(
ş›Á
);

847 
mh
->
ş›Ás_¦aves
 = 
mem
;

848 
mem_tÙ®
+=
mem
;

850 
mem
 = 0;

851 ià(
	`li¡L’gth
(
£rv”
.
ş›Ás
)) {

852 
li¡I‹r
 
li
;

853 
li¡Node
 *
Ê
;

855 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

856 (
Ê
 = 
	`li¡Next
(&
li
))) {

857 
ş›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

858 ià(
c
->
æags
 & 
CLIENT_SLAVE
)

860 
mem
 +ğ
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
c
);

861 
mem
 +ğ
	`sdsAÎocSize
(
c
->
qu”ybuf
);

862 
mem
 +ğ(
ş›Á
);

865 
mh
->
ş›Ás_nÜm®
 = 
mem
;

866 
mem_tÙ®
+=
mem
;

868 
mem
 = 0;

869 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

870 
mem
 +ğ
	`sd¦’
(
£rv”
.
aof_buf
);

871 
mem
 +ğ
	`aofRewr™eBufãrSize
();

873 
mh
->
aof_bufãr
 = 
mem
;

874 
mem_tÙ®
+=
mem
;

876 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

877 
»disDb
 *
db
 = 
£rv”
.db+
j
;

878 
keyscouÁ
 = 
	`diùSize
(
db
->
diù
);

879 ià(
keyscouÁ
==0) ;

881 
mh
->
tÙ®_keys
 +ğ
keyscouÁ
;

882 
mh
->
db
 = 
	`z»®loc
(mh->db,(mh->db[0])*(mh->
num_dbs
+1));

883 
mh
->
db
[mh->
num_dbs
].
dbid
 = 
j
;

885 
mem
 = 
	`diùSize
(
db
->
diù
è* (
diùEÁry
) +

886 
	`diùSlÙs
(
db
->
diù
è* (
diùEÁry
*) +

887 
	`diùSize
(
db
->
diù
è* (
robj
);

888 
mh
->
db
[mh->
num_dbs
].
ov”h—d_ht_maš
 = 
mem
;

889 
mem_tÙ®
+=
mem
;

891 
mem
 = 
	`diùSize
(
db
->
expœes
è* (
diùEÁry
) +

892 
	`diùSlÙs
(
db
->
expœes
è* (
diùEÁry
*);

893 
mh
->
db
[mh->
num_dbs
].
ov”h—d_ht_expœes
 = 
mem
;

894 
mem_tÙ®
+=
mem
;

896 
mh
->
num_dbs
++;

899 
mh
->
ov”h—d_tÙ®
 = 
mem_tÙ®
;

900 
mh
->
d©a£t
 = 
zm®loc_u£d
 - 
mem_tÙ®
;

901 
mh
->
³ak_³rc
 = ()
zm®loc_u£d
*100/mh->
³ak_®loÿ‹d
;

905 
size_t
 
Ãt_u§ge
 = 1;

906 ià(
zm®loc_u£d
 > 
mh
->
¡¬tup_®loÿ‹d
)

907 
Ãt_u§ge
 = 
zm®loc_u£d
 - 
mh
->
¡¬tup_®loÿ‹d
;

908 
mh
->
d©a£t_³rc
 = ()mh->
d©a£t
*100/
Ãt_u§ge
;

909 
mh
->
by‹s_³r_key
 = mh->
tÙ®_keys
 ? (
Ãt_u§ge
 / mh->total_keys) : 0;

911  
mh
;

912 
	}
}

916 
	$šputC©Sds
(*
»suÉ
, cÚ¡ *
¡r
) {

918 
sds
 *
šfo
 = (sd *)
»suÉ
;

919 *
šfo
 = 
	`sdsÿt
(*šfo, 
¡r
);

920 
	}
}

924 
sds
 
	$g‘MemÜyDoùÜR•Üt
() {

925 
em±y
 = 0;

926 
big_³ak
 = 0;

927 
high_äag
 = 0;

928 
big_¦ave_buf
 = 0;

929 
big_ş›Á_buf
 = 0;

930 
num_»pÜts
 = 0;

931 
»disMemOv”h—d
 *
mh
 = 
	`g‘MemÜyOv”h—dD©a
();

933 ià(
mh
->
tÙ®_®loÿ‹d
 < (1024*1024*5)) {

934 
em±y
 = 1;

935 
num_»pÜts
++;

938 ià((()
mh
->
³ak_®loÿ‹d
 / mh->
tÙ®_®loÿ‹d
) > 1.5) {

939 
big_³ak
 = 1;

940 
num_»pÜts
++;

944 ià(
mh
->
äagm’tiÚ
 > 1.4) {

945 
high_äag
 = 1;

946 
num_»pÜts
++;

950 
num¦aves
 = 
	`li¡L’gth
(
£rv”
.
¦aves
);

951 
numş›Ás
 = 
	`li¡L’gth
(
£rv”
.
ş›Ás
)-
num¦aves
;

952 ià(
mh
->
ş›Ás_nÜm®
 / 
numş›Ás
 > (1024*200)) {

953 
big_ş›Á_buf
 = 1;

954 
num_»pÜts
++;

958 ià(
num¦aves
 > 0 && 
mh
->
ş›Ás_¦aves
 /‚umslaves > (1024*1024*10)) {

959 
big_¦ave_buf
 = 1;

960 
num_»pÜts
++;

964 
sds
 
s
;

965 ià(
num_»pÜts
 == 0) {

966 
s
 = 
	`sd¢ew
(

969 } ià(
em±y
 == 1) {

970 
s
 = 
	`sd¢ew
(

977 
s
 = 
	`sd¢ew
("Sam, I detected‡ few issues inhis Redis instance memory implants:\n\n");

978 ià(
big_³ak
) {

979 
s
 = 
	`sdsÿt
(s," * Peak memory: Inhe…asthis instance used morehan 150%he memoryhat is currently using. The‡llocator is‚ormally‚ot‡bleo„elease memory‡fter‡…eak, so you canƒxpecto see‡ big fragmentation„atio, howeverhis is‡ctually harmless‡nd is only dueohe memory…eak,‡nd ifhe Redis instance Resident Set Size (RSS) is currently biggerhanƒxpected,he memory will be used‡s soon‡s you fillhe Redis instance with more data. Ifhe memory…eak was only occasional‡nd you wantoryo„eclaim memory,…leaseryhe MEMORY PURGE command, otherwisehe only other option iso shutdown‡nd„estarthe instance.\n\n");

981 ià(
high_äag
) {

982 
s
 = 
	`sdsÿrštf
(s," * High f¿gm’tiÚ: Thi š¡ªû ha ¨memÜy f¿gm’tiÚ g»©”hª 1.4 (thi m—n th©hResid’ˆS‘ SizoàthRedi ´oûs i much†¬g”hªhsum oàthlogiÿÈ®loÿtiÚ Redi ³rfÜmed). Thi ´obËm i usu®ly due™h”Ø¨Ïrg³ak memÜy (check iàth”i ¨³ak memÜyƒÁry‡bovšh»pÜtèÜ may„esuÉ from‡ wÜklßdh© cau£ th®loÿtÜØäagm’ˆmemÜy‡†Ù. Iàth´obËm i ¨Ïrg³ak memÜy,h’h”i nØissue. Oth”wi£, maksu» you‡» usšghJem®loø®loÿtÜ‡nd‚ÙhdeçuÉ†ibøm®loc. NÙe: Thcu¼’y u£d‡ÎoÿtÜ i \"%s\".\n\n", 
ZMALLOC_LIB
);

984 ià(
big_¦ave_buf
) {

985 
s
 = 
	`sdsÿt
(s," * Big slave buffers: The slave output buffers inhis instance‡re greaterhan 10MB forƒach slave (on‡verage). This†ikely meanshathere is some slave instancehat is struggling„eceiving data,ƒither because it isoo slow or because of‚etworking issues. As‡„esult, data…iles onhe master output buffers. Pleaseryo identify what slave is‚ot„eceiving data correctly‡nd why. You can usehe INFO output in ordero checkhe slaves delays‡ndhe CLIENT LIST commando checkhe output buffers ofƒach slave.\n\n");

987 ià(
big_ş›Á_buf
) {

988 
s
 = 
	`sdsÿt
(s," * Big client buffers: The clients output buffers inhis instance‡re greaterhan 200K…er client (on‡verage). This may„esult from different causes,†ike Pub/Sub clients subscribedo channels bot‚ot„eceiving data fastƒnough, sohat data…iles onhe Redis instance output buffer, or clients sending commands with†arge„eplies or very†arge sequences of commands inhe same…ipeline. Please usehe CLIENT LIST command in ordero investigatehe issue if it causes…roblems in your instance, oro understand better why certain clients‡re using‡ big‡mount of memory.\n\n");

990 
s
 = 
	`sdsÿt
(s,"I'm hereo keep you safe, Sam. I wanto help you.\n");

992 
	`ä“MemÜyOv”h—dD©a
(
mh
);

993  
s
;

994 
	}
}

1000 
robj
 *
	$objeùCommªdLookup
(
ş›Á
 *
c
, 
robj
 *
key
) {

1001 
diùEÁry
 *
de
;

1003 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,
key
->
±r
)è=ğ
NULL
)  NULL;

1004  (
robj
*è
	`diùG‘V®
(
de
);

1005 
	}
}

1007 
robj
 *
	$objeùCommªdLookupOrR•ly
(
ş›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

1008 
robj
 *
o
 = 
	`objeùCommªdLookup
(
c
,
key
);

1010 ià(!
o
è
	`addR•ly
(
c
, 
»¶y
);

1011  
o
;

1012 
	}
}

1016 
	$objeùCommªd
(
ş›Á
 *
c
) {

1017 
robj
 *
o
;

1019 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"h–p"è&& c->
¬gc
 == 2) {

1020 *
bËÅ
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1021 
bËn
 = 0;

1022 
bËn
++; 
	`addR•lyStus
(
c
,

1024 
bËn
++; 
	`addR•lyStus
(
c
,

1026 
bËn
++; 
	`addR•lyStus
(
c
,

1028 
bËn
++; 
	`addR•lyStus
(
c
,

1030 
bËn
++; 
	`addR•lyStus
(
c
,

1032 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
bËÅ
,
bËn
);

1033 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»fcouÁ"è&& c->
¬gc
 == 3) {

1034 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

1035 =ğ
NULL
) ;

1036 
	`addR•lyLÚgLÚg
(
c
,
o
->
»fcouÁ
);

1037 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"’codšg"è&& c->
¬gc
 == 3) {

1038 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

1039 =ğ
NULL
) ;

1040 
	`addR•lyBulkCSŒšg
(
c
,
	`¡rEncodšg
(
o
->
’codšg
));

1041 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"idËtime"è&& c->
¬gc
 == 3) {

1042 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

1043 =ğ
NULL
) ;

1044 ià(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
) {

1045 
	`addR•lyE¼Ü
(
c
,"An LFU maxmemory…olicy is selected, idleime‚otracked. Please‚otehat when switching between…olicies‡t„untime LRU‡nd LFU data willake someimeo‡djust.");

1048 
	`addR•lyLÚgLÚg
(
c
,
	`e¡im©eObjeùIdËTime
(
o
)/1000);

1049 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"äeq"è&& c->
¬gc
 == 3) {

1050 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

1051 =ğ
NULL
) ;

1052 ià(!(
£rv”
.
maxmemÜy_pŞicy
 & 
MAXMEMORY_FLAG_LFU
)) {

1053 
	`addR•lyE¼Ü
(
c
,"An LFU maxmemory…olicy is‚ot selected,‡ccess frequency‚otracked. Please‚otehat when switching between…olicies‡t„untime LRU‡nd LFU data willake someimeo‡djust.");

1060 
	`addR•lyLÚgLÚg
(
c
,
	`LFUDeüAndR‘uº
(
o
));

1062 
	`addR•lyE¼ÜFÜm©
(
c
, "Unknown subcommand or wrong‚umber of‡rguments for '%s'. Try OBJECT help",

1063 (*)
c
->
¬gv
[1]->
±r
);

1065 
	}
}

1071 
	$memÜyCommªd
(
ş›Á
 *
c
) {

1072 
robj
 *
o
;

1074 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"u§ge"è&& c->
¬gc
 >= 3) {

1075 
§m¶es
 = 
OBJ_COMPUTE_SIZE_DEF_SAMPLES
;

1076 
j
 = 3; j < 
c
->
¬gc
; j++) {

1077 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"samples") &&

1078 
j
+1 < 
c
->
¬gc
)

1080 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+1],&
§m¶es
,
NULL
)

1081 =ğ
C_ERR
) ;

1082 ià(
§m¶es
 < 0) {

1083 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1086 ià(
§m¶es
 =ğ0è§m¶e ğ
LLONG_MAX
;;

1087 
j
++;

1089 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1093 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

1094 =ğ
NULL
) ;

1095 
size_t
 
u§ge
 = 
	`objeùCompu‹Size
(
o
,
§m¶es
);

1096 
u§ge
 +ğ
	`sdsAÎocSize
(
c
->
¬gv
[2]->
±r
);

1097 
u§ge
 +ğ(
diùEÁry
);

1098 
	`addR•lyLÚgLÚg
(
c
,
u§ge
);

1099 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¡©s"è&& c->
¬gc
 == 2) {

1100 
»disMemOv”h—d
 *
mh
 = 
	`g‘MemÜyOv”h—dD©a
();

1102 
	`addR•lyMuÉiBulkL’
(
c
,(14+
mh
->
num_dbs
)*2);

1104 
	`addR•lyBulkCSŒšg
(
c
,"peak.allocated");

1105 
	`addR•lyLÚgLÚg
(
c
,
mh
->
³ak_®loÿ‹d
);

1107 
	`addR•lyBulkCSŒšg
(
c
,"total.allocated");

1108 
	`addR•lyLÚgLÚg
(
c
,
mh
->
tÙ®_®loÿ‹d
);

1110 
	`addR•lyBulkCSŒšg
(
c
,"startup.allocated");

1111 
	`addR•lyLÚgLÚg
(
c
,
mh
->
¡¬tup_®loÿ‹d
);

1113 
	`addR•lyBulkCSŒšg
(
c
,"replication.backlog");

1114 
	`addR•lyLÚgLÚg
(
c
,
mh
->
»¶_backlog
);

1116 
	`addR•lyBulkCSŒšg
(
c
,"clients.slaves");

1117 
	`addR•lyLÚgLÚg
(
c
,
mh
->
ş›Ás_¦aves
);

1119 
	`addR•lyBulkCSŒšg
(
c
,"clients.normal");

1120 
	`addR•lyLÚgLÚg
(
c
,
mh
->
ş›Ás_nÜm®
);

1122 
	`addR•lyBulkCSŒšg
(
c
,"aof.buffer");

1123 
	`addR•lyLÚgLÚg
(
c
,
mh
->
aof_bufãr
);

1125 
size_t
 
j
 = 0; j < 
mh
->
num_dbs
; j++) {

1126 
dbÇme
[32];

1127 
	`¢´štf
(
dbÇme
,(dbÇme),"db.%zd",
mh
->
db
[
j
].
dbid
);

1128 
	`addR•lyBulkCSŒšg
(
c
,
dbÇme
);

1129 
	`addR•lyMuÉiBulkL’
(
c
,4);

1131 
	`addR•lyBulkCSŒšg
(
c
,"overhead.hashtable.main");

1132 
	`addR•lyLÚgLÚg
(
c
,
mh
->
db
[
j
].
ov”h—d_ht_maš
);

1134 
	`addR•lyBulkCSŒšg
(
c
,"overhead.hashtable.expires");

1135 
	`addR•lyLÚgLÚg
(
c
,
mh
->
db
[
j
].
ov”h—d_ht_expœes
);

1138 
	`addR•lyBulkCSŒšg
(
c
,"overhead.total");

1139 
	`addR•lyLÚgLÚg
(
c
,
mh
->
ov”h—d_tÙ®
);

1141 
	`addR•lyBulkCSŒšg
(
c
,"keys.count");

1142 
	`addR•lyLÚgLÚg
(
c
,
mh
->
tÙ®_keys
);

1144 
	`addR•lyBulkCSŒšg
(
c
,"keys.bytes-per-key");

1145 
	`addR•lyLÚgLÚg
(
c
,
mh
->
by‹s_³r_key
);

1147 
	`addR•lyBulkCSŒšg
(
c
,"dataset.bytes");

1148 
	`addR•lyLÚgLÚg
(
c
,
mh
->
d©a£t
);

1150 
	`addR•lyBulkCSŒšg
(
c
,"dataset.percentage");

1151 
	`addR•lyDoubË
(
c
,
mh
->
d©a£t_³rc
);

1153 
	`addR•lyBulkCSŒšg
(
c
,"peak.percentage");

1154 
	`addR•lyDoubË
(
c
,
mh
->
³ak_³rc
);

1156 
	`addR•lyBulkCSŒšg
(
c
,"fragmentation");

1157 
	`addR•lyDoubË
(
c
,
mh
->
äagm’tiÚ
);

1159 
	`ä“MemÜyOv”h—dD©a
(
mh
);

1160 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"m®loc-¡©s"è&& c->
¬gc
 == 2) {

1161 #ià
	`defšed
(
USE_JEMALLOC
)

1162 
sds
 
šfo
 = 
	`sd£m±y
();

1163 
	`je_m®loc_¡©s_´št
(
šputC©Sds
, &
šfo
, 
NULL
);

1164 
	`addR•lyBulkSds
(
c
, 
šfo
);

1166 
	`addR•lyBulkCSŒšg
(
c
,"Stats‚ot supported forhe current‡llocator");

1168 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"doùÜ"è&& c->
¬gc
 == 2) {

1169 
sds
 
»pÜt
 = 
	`g‘MemÜyDoùÜR•Üt
();

1170 
	`addR•lyBulkSds
(
c
,
»pÜt
);

1171 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"purge"è&& c->
¬gc
 == 2) {

1172 #ià
	`defšed
(
USE_JEMALLOC
)

1173 
tmp
[32];

1174 
Ç»Çs
 = 0;

1175 
size_t
 
sz
 = ();

1176 ià(!
	`je_m®lùl
("¬’as.Ç»Çs", &
Ç»Çs
, &
sz
, 
NULL
, 0)) {

1177 
	`¥rštf
(
tmp
, "¬’a.%d.purge", 
Ç»Çs
);

1178 ià(!
	`je_m®lùl
(
tmp
, 
NULL
, 0, NULL, 0)) {

1179 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

1183 
	`addR•lyE¼Ü
(
c
, "Error…urging dirty…ages");

1185 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

1188 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"h–p"è&& c->
¬gc
 == 2) {

1189 
	`addR•lyMuÉiBulkL’
(
c
,5);

1190 
	`addR•lyBulkCSŒšg
(
c
,

1192 
	`addR•lyBulkCSŒšg
(
c
,

1194 
	`addR•lyBulkCSŒšg
(
c
,

1196 
	`addR•lyBulkCSŒšg
(
c
,

1198 
	`addR•lyBulkCSŒšg
(
c
,

1201 
	`addR•lyE¼Ü
(
c
,"Syntaxƒrror. Try MEMORY HELP");

1203 
	}
}

	@src/pqsort.c

40 
	~<sys/ty³s.h
>

42 
	~<”ºo.h
>

43 
	~<¡dlib.h
>

45 
šlše
 *
med3
 (*, *, *,

47 
šlše
 
	`sw­func
 (*, *, 
size_t
, );

49 
	#mš
(
a
, 
b
è×è< (bè?‡ : 
	)
b

54 
	#sw­code
(
TYPE
, 
·rmi
, 
·rmj
, 
n
) { \

55 
size_t
 
i
 = (
n
è/  (
TYPE
); \

56 
TYPE
 *
pi
 = (TYPE *)(*)(
·rmi
); \

57 
TYPE
 *
pj
 = (TYPE *)(*)(
·rmj
); \

59 
TYPE
 
t
 = *
pi
; \

60 *
pi
++ = *
pj
; \

61 *
pj
++ = 
t
; \

62 } --
i
 > 0); \

63 
	}

	)
}

65 
	#SWAPINIT
(
a
, 
es
è
sw­ty³
 = ((*)a - (*)0) % () || \

66 
es
 % (è? 2 :ƒ =ğ()? 0 : 1;

	)

68 
šlše
 

69 
	$sw­func
(*
a
, *
b
, 
size_t
 
n
, 
sw­ty³
)

72 ià(
sw­ty³
 <= 1)

73 
	`sw­code
(, 
a
, 
b
, 
n
)

75 
	`sw­code
(, 
a
, 
b
, 
n
)

76 
	}
}

78 
	#sw­
(
a
, 
b
) \

79 ià(
sw­ty³
 == 0) { \

80 
t
 = *(*)(*)(
a
); \

81 *(*)(*)(
a
èğ*(*)(*)(
b
); \

82 *(*)(*)(
b
èğ
t
; \

84 
	`sw­func
(
a
, 
b
, 
es
, 
sw­ty³
)

	)

86 
	#vecsw­
(
a
, 
b
, 
n
èià(Òè> 0è
	`sw­func
(×), (b), (
size_t
)Ò), 
sw­ty³
)

	)

88 
šlše
 *

89 
	$med3
(*
a
, *
b
, *
c
,

90 (*
cmp
) (const *, const *))

93  
	`cmp
(
a
, 
b
) < 0 ?

94 (
	`cmp
(
b
, 
c
è< 0 ? b : (cmp(
a
, c) < 0 ? c :‡ ))

95 :(
	`cmp
(
b
, 
c
è> 0 ? b : (cmp(
a
, c) < 0 ?‡ : c ));

96 
	}
}

99 
	$_pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

100 (*
cmp
è(cÚ¡ *, cÚ¡ *), *
Ìªge
, *
¼ªge
)

102 *
·
, *
pb
, *
pc
, *
pd
, *
¶
, *
pm
, *
²
;

103 
size_t
 
d
, 
r
;

104 
sw­ty³
, 
cmp_»suÉ
;

106 
loİ
: 
	`SWAPINIT
(
a
, 
es
);

107 ià(
n
 < 7) {

108 
pm
 = (*è
a
 + 
es
;…m < (*è¨+ 
n
 *ƒs;…m +=ƒs)

109 
¶
 = 
pm
;…È> (*è
a
 && 
	`cmp
ÕÈ- 
es
,…l) > 0;

110 
¶
 -ğ
es
)

111 
	`sw­
(
¶
,…È- 
es
);

114 
pm
 = (*è
a
 + (
n
 / 2è* 
es
;

115 ià(
n
 > 7) {

116 
¶
 = (*è
a
;

117 
²
 = (*è
a
 + (
n
 - 1è* 
es
;

118 ià(
n
 > 40) {

119 
d
 = (
n
 / 8è* 
es
;

120 
¶
 = 
	`med3
Õl,…È+ 
d
,…È+ 2 * d, 
cmp
);

121 
pm
 = 
	`med3
Õm - 
d
,…m,…m + d, 
cmp
);

122 
²
 = 
	`med3
ÕÀ- 2 * 
d
,…À- d,…n, 
cmp
);

124 
pm
 = 
	`med3
(
¶
,…m, 
²
, 
cmp
);

126 
	`sw­
(
a
, 
pm
);

127 
·
 = 
pb
 = (*è
a
 + 
es
;

129 
pc
 = 
pd
 = (*è
a
 + (
n
 - 1è* 
es
;

131 
pb
 <ğ
pc
 && (
cmp_»suÉ
 = 
	`cmp
Õb, 
a
)) <= 0) {

132 ià(
cmp_»suÉ
 == 0) {

133 
	`sw­
(
·
, 
pb
);

134 
·
 +ğ
es
;

136 
pb
 +ğ
es
;

138 
pb
 <ğ
pc
 && (
cmp_»suÉ
 = 
	`cmp
Õc, 
a
)) >= 0) {

139 ià(
cmp_»suÉ
 == 0) {

140 
	`sw­
(
pc
, 
pd
);

141 
pd
 -ğ
es
;

143 
pc
 -ğ
es
;

145 ià(
pb
 > 
pc
)

147 
	`sw­
(
pb
, 
pc
);

148 
pb
 +ğ
es
;

149 
pc
 -ğ
es
;

152 
²
 = (*è
a
 + 
n
 * 
es
;

153 
r
 = 
	`mš
(
·
 - (*è
a
, 
pb
 -…a);

154 
	`vecsw­
(
a
, 
pb
 - 
r
,„);

155 
r
 = 
	`mš
((
size_t
)(
pd
 - 
pc
), 
²
 -…d - 
es
);

156 
	`vecsw­
(
pb
, 
²
 - 
r
,„);

157 ià((
r
 = 
pb
 - 
·
è> 
es
) {

158 *
_l
 = 
a
, *
_r
 = ((*ï)+
r
-1;

159 ià(!((
Ìªge
 < 
_l
 && 
¼ªge
 < _l) ||

160 (
Ìªge
 > 
_r
 && 
¼ªge
 > _r)))

161 
	`_pqsÜt
(
a
, 
r
 / 
es
,ƒs, 
cmp
, 
Ìªge
, 
¼ªge
);

163 ià((
r
 = 
pd
 - 
pc
è> 
es
) {

164 *
_l
, *
_r
;

167 
a
 = 
²
 - 
r
;

168 
n
 = 
r
 / 
es
;

170 
_l
 = 
a
;

171 
_r
 = ((*)
a
)+
r
-1;

172 ià(!((
Ìªge
 < 
_l
 && 
¼ªge
 < _l) ||

173 (
Ìªge
 > 
_r
 && 
¼ªge
 > _r)))

174 
loİ
;

177 
	}
}

180 
	$pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

181 (*
cmp
è(cÚ¡ *, cÚ¡ *), 
size_t
 
Ìªge
, size_ˆ
¼ªge
)

183 
	`_pqsÜt
(
a
,
n
,
es
,
cmp
,((*ï)+(
Ìªge
*es),

184 ((*)
a
)+((
¼ªge
+1)*
es
)-1);

185 
	}
}

	@src/pqsort.h

33 #iâdeà
__PQSORT_H


34 
	#__PQSORT_H


	)

37 
pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

38 (*
cmp
è(cÚ¡ *, cÚ¡ *), 
size_t
 
Ìªge
, size_ˆ
¼ªge
);

	@src/pubsub.c

30 
	~"£rv”.h
"

36 
	$ä“PubsubP©‹º
(*
p
) {

37 
pubsubP©‹º
 *
·t
 = 
p
;

39 
	`deüRefCouÁ
(
·t
->
·‰”n
);

40 
	`zä“
(
·t
);

41 
	}
}

43 
	$li¡M©chPubsubP©‹º
(*
a
, *
b
) {

44 
pubsubP©‹º
 *
·
 = 
a
, *
pb
 = 
b
;

46  (
·
->
ş›Á
 =ğ
pb
->client) &&

47 (
	`equ®SŒšgObjeùs
(
·
->
·‰”n
,
pb
->pattern));

48 
	}
}

51 
	$ş›ÁSubsütiÚsCouÁ
(
ş›Á
 *
c
) {

52  
	`diùSize
(
c
->
pubsub_chªÃls
)+

53 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
);

54 
	}
}

58 
	$pubsubSubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
) {

59 
diùEÁry
 *
de
;

60 
li¡
 *
ş›Ás
 = 
NULL
;

61 
»tv®
 = 0;

64 ià(
	`diùAdd
(
c
->
pubsub_chªÃls
,
chªÃl
,
NULL
è=ğ
DICT_OK
) {

65 
»tv®
 = 1;

66 
	`šüRefCouÁ
(
chªÃl
);

68 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

69 ià(
de
 =ğ
NULL
) {

70 
ş›Ás
 = 
	`li¡C»©e
();

71 
	`diùAdd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
,
ş›Ás
);

72 
	`šüRefCouÁ
(
chªÃl
);

74 
ş›Ás
 = 
	`diùG‘V®
(
de
);

76 
	`li¡AddNodeTa
(
ş›Ás
,
c
);

79 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

80 
	`addR•ly
(
c
,
sh¬ed
.
subsüibebulk
);

81 
	`addR•lyBulk
(
c
,
chªÃl
);

82 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

83  
»tv®
;

84 
	}
}

88 
	$pubsubUnsubsüibeChªÃl
(
ş›Á
 *
c
, 
robj
 *
chªÃl
, 
nÙify
) {

89 
diùEÁry
 *
de
;

90 
li¡
 *
ş›Ás
;

91 
li¡Node
 *
Ê
;

92 
»tv®
 = 0;

95 
	`šüRefCouÁ
(
chªÃl
);

97 ià(
	`diùD–‘e
(
c
->
pubsub_chªÃls
,
chªÃl
è=ğ
DICT_OK
) {

98 
»tv®
 = 1;

100 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

101 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
de
 != NULL);

102 
ş›Ás
 = 
	`diùG‘V®
(
de
);

103 
Ê
 = 
	`li¡S—rchKey
(
ş›Ás
,
c
);

104 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
Ê
 != NULL);

105 
	`li¡D–Node
(
ş›Ás
,
Ê
);

106 ià(
	`li¡L’gth
(
ş›Ás
) == 0) {

110 
	`diùD–‘e
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

114 ià(
nÙify
) {

115 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

116 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

117 
	`addR•lyBulk
(
c
,
chªÃl
);

118 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

119 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

122 
	`deüRefCouÁ
(
chªÃl
);

123  
»tv®
;

124 
	}
}

127 
	$pubsubSubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
) {

128 
»tv®
 = 0;

130 ià(
	`li¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
è=ğ
NULL
) {

131 
»tv®
 = 1;

132 
pubsubP©‹º
 *
·t
;

133 
	`li¡AddNodeTa
(
c
->
pubsub_·‰”ns
,
·‰”n
);

134 
	`šüRefCouÁ
(
·‰”n
);

135 
·t
 = 
	`zm®loc
((*pat));

136 
·t
->
·‰”n
 = 
	`g‘DecodedObjeù
(pattern);

137 
·t
->
ş›Á
 = 
c
;

138 
	`li¡AddNodeTa
(
£rv”
.
pubsub_·‰”ns
,
·t
);

141 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

142 
	`addR•ly
(
c
,
sh¬ed
.
psubsüibebulk
);

143 
	`addR•lyBulk
(
c
,
·‰”n
);

144 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

145  
»tv®
;

146 
	}
}

150 
	$pubsubUnsubsüibeP©‹º
(
ş›Á
 *
c
, 
robj
 *
·‰”n
, 
nÙify
) {

151 
li¡Node
 *
Ê
;

152 
pubsubP©‹º
 
·t
;

153 
»tv®
 = 0;

155 
	`šüRefCouÁ
(
·‰”n
);

156 ià((
Ê
 = 
	`li¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
)è!ğ
NULL
) {

157 
»tv®
 = 1;

158 
	`li¡D–Node
(
c
->
pubsub_·‰”ns
,
Ê
);

159 
·t
.
ş›Á
 = 
c
;

160 
·t
.
·‰”n
 =…attern;

161 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
pubsub_·‰”ns
,&
·t
);

162 
	`li¡D–Node
(
£rv”
.
pubsub_·‰”ns
,
Ê
);

165 ià(
nÙify
) {

166 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

167 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

168 
	`addR•lyBulk
(
c
,
·‰”n
);

169 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

170 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

172 
	`deüRefCouÁ
(
·‰”n
);

173  
»tv®
;

174 
	}
}

178 
	$pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
) {

179 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
pubsub_chªÃls
);

180 
diùEÁry
 *
de
;

181 
couÁ
 = 0;

183 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

184 
robj
 *
chªÃl
 = 
	`diùG‘Key
(
de
);

186 
couÁ
 +ğ
	`pubsubUnsubsüibeChªÃl
(
c
,
chªÃl
,
nÙify
);

189 ià(
nÙify
 && 
couÁ
 == 0) {

190 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

191 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

192 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

193 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

194 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

196 
	`diùR–—£I‹¿tÜ
(
di
);

197  
couÁ
;

198 
	}
}

202 
	$pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
) {

203 
li¡Node
 *
Ê
;

204 
li¡I‹r
 
li
;

205 
couÁ
 = 0;

207 
	`li¡Rewšd
(
c
->
pubsub_·‰”ns
,&
li
);

208 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

209 
robj
 *
·‰”n
 = 
Ê
->
v®ue
;

211 
couÁ
 +ğ
	`pubsubUnsubsüibeP©‹º
(
c
,
·‰”n
,
nÙify
);

213 ià(
nÙify
 && 
couÁ
 == 0) {

215 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

216 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

217 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

218 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

219 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

221  
couÁ
;

222 
	}
}

225 
	$pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
) {

226 
»ûiv”s
 = 0;

227 
diùEÁry
 *
de
;

228 
li¡Node
 *
Ê
;

229 
li¡I‹r
 
li
;

232 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

233 ià(
de
) {

234 
li¡
 *li¡ = 
	`diùG‘V®
(
de
);

235 
li¡Node
 *
Ê
;

236 
li¡I‹r
 
li
;

238 
	`li¡Rewšd
(
li¡
,&
li
);

239 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

240 
ş›Á
 *
c
 = 
Ê
->
v®ue
;

242 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

243 
	`addR•ly
(
c
,
sh¬ed
.
mes§gebulk
);

244 
	`addR•lyBulk
(
c
,
chªÃl
);

245 
	`addR•lyBulk
(
c
,
mes§ge
);

246 
»ûiv”s
++;

250 ià(
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
)) {

251 
	`li¡Rewšd
(
£rv”
.
pubsub_·‰”ns
,&
li
);

252 
chªÃl
 = 
	`g‘DecodedObjeù
(channel);

253 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

254 
pubsubP©‹º
 *
·t
 = 
Ê
->
v®ue
;

256 ià(
	`¡ršgm©chËn
((*)
·t
->
·‰”n
->
±r
,

257 
	`sd¦’
(
·t
->
·‰”n
->
±r
),

258 (*)
chªÃl
->
±r
,

259 
	`sd¦’
(
chªÃl
->
±r
),0)) {

260 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
mbulkhdr
[4]);

261 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
pmes§gebulk
);

262 
	`addR•lyBulk
(
·t
->
ş›Á
,·t->
·‰”n
);

263 
	`addR•lyBulk
(
·t
->
ş›Á
,
chªÃl
);

264 
	`addR•lyBulk
(
·t
->
ş›Á
,
mes§ge
);

265 
»ûiv”s
++;

268 
	`deüRefCouÁ
(
chªÃl
);

270  
»ûiv”s
;

271 
	}
}

277 
	$subsüibeCommªd
(
ş›Á
 *
c
) {

278 
j
;

280 
j
 = 1; j < 
c
->
¬gc
; j++)

281 
	`pubsubSubsüibeChªÃl
(
c
,c->
¬gv
[
j
]);

282 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

283 
	}
}

285 
	$unsubsüibeCommªd
(
ş›Á
 *
c
) {

286 ià(
c
->
¬gc
 == 1) {

287 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,1);

289 
j
;

291 
j
 = 1; j < 
c
->
¬gc
; j++)

292 
	`pubsubUnsubsüibeChªÃl
(
c
,c->
¬gv
[
j
],1);

294 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

295 
	}
}

297 
	$psubsüibeCommªd
(
ş›Á
 *
c
) {

298 
j
;

300 
j
 = 1; j < 
c
->
¬gc
; j++)

301 
	`pubsubSubsüibeP©‹º
(
c
,c->
¬gv
[
j
]);

302 
c
->
æags
 |ğ
CLIENT_PUBSUB
;

303 
	}
}

305 
	$punsubsüibeCommªd
(
ş›Á
 *
c
) {

306 ià(
c
->
¬gc
 == 1) {

307 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,1);

309 
j
;

311 
j
 = 1; j < 
c
->
¬gc
; j++)

312 
	`pubsubUnsubsüibeP©‹º
(
c
,c->
¬gv
[
j
],1);

314 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
CLIENT_PUBSUB
;

315 
	}
}

317 
	$publishCommªd
(
ş›Á
 *
c
) {

318 
»ûiv”s
 = 
	`pubsubPublishMes§ge
(
c
->
¬gv
[1],c->argv[2]);

319 ià(
£rv”
.
şu¡”_’abËd
)

320 
	`şu¡”Prİag©ePublish
(
c
->
¬gv
[1],c->argv[2]);

322 
	`fÜûCommªdPrİag©iÚ
(
c
,
PROPAGATE_REPL
);

323 
	`addR•lyLÚgLÚg
(
c
,
»ûiv”s
);

324 
	}
}

327 
	$pubsubCommªd
(
ş›Á
 *
c
) {

328 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"channels") &&

329 (
c
->
¬gc
 == 2 || c->argc ==3))

332 
sds
 
·t
 = (
c
->
¬gc
 =ğ2è? 
NULL
 : c->
¬gv
[2]->
±r
;

333 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
pubsub_chªÃls
);

334 
diùEÁry
 *
de
;

335 
mbËn
 = 0;

336 *
»¶yËn
;

338 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

339 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

340 
robj
 *
cobj
 = 
	`diùG‘Key
(
de
);

341 
sds
 
chªÃl
 = 
cobj
->
±r
;

343 ià(!
·t
 || 
	`¡ršgm©chËn
Õ©, 
	`sd¦’
(pat),

344 
chªÃl
, 
	`sd¦’
(channel),0))

346 
	`addR•lyBulk
(
c
,
cobj
);

347 
mbËn
++;

350 
	`diùR–—£I‹¿tÜ
(
di
);

351 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
mbËn
);

352 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"numsub"è&& c->
¬gc
 >= 2) {

354 
j
;

356 
	`addR•lyMuÉiBulkL’
(
c
,(c->
¬gc
-2)*2);

357 
j
 = 2; j < 
c
->
¬gc
; j++) {

358 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
£rv”
.
pubsub_chªÃls
,
c
->
¬gv
[
j
]);

360 
	`addR•lyBulk
(
c
,c->
¬gv
[
j
]);

361 
	`addR•lyLÚgLÚg
(
c
,
l
 ? 
	`li¡L’gth
(l) : 0);

363 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"num·t"è&& c->
¬gc
 == 2) {

365 
	`addR•lyLÚgLÚg
(
c
,
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
));

367 
	`addR•lyE¼ÜFÜm©
(
c
,

369 (*)
c
->
¬gv
[1]->
±r
);

371 
	}
}

	@src/quicklist.c

31 
	~<¡ršg.h
>

32 
	~"quickli¡.h
"

33 
	~"zm®loc.h
"

34 
	~"zli¡.h
"

35 
	~"ut.h
"

36 
	~"lzf.h
"

38 #ià
defšed
(
REDIS_TEST
è|| defšed(
REDIS_TEST_VERBOSE
)

39 
	~<¡dio.h
>

42 #iâdeà
REDIS_STATIC


43 
	#REDIS_STATIC
 

	)

47 cÚ¡ 
size_t
 
	gİtimiz©iÚ_Ëv–
[] = {4096, 8192, 16384, 32768, 65536};

51 
	#SIZE_SAFETY_LIMIT
 8192

	)

54 
	#MIN_COMPRESS_BYTES
 48

	)

59 
	#MIN_COMPRESS_IMPROVE
 8

	)

62 #iâdeà
REDIS_TEST_VERBOSE


63 
	#D
(...)

	)

65 
	#D
(...) \

67 
	`´štf
("%s:%s:%d:\t", 
__FILE__
, 
__FUNCTION__
, 
__LINE__
); \

68 
	`´štf
(
__VA_ARGS__
); \

69 
	`´štf
("\n"); \

70 } 0);

	)

74 
	#š™EÁry
(
e
) \

76 (
e
)->
zi
 = (e)->
v®ue
 = 
NULL
; \

77 (
e
)->
lÚgv®
 = -123456789; \

78 (
e
)->
quickli¡
 = 
NULL
; \

79 (
e
)->
node
 = 
NULL
; \

80 (
e
)->
off£t
 = 123456789; \

81 (
e
)->
sz
 = 0; \

82 } 0)

	)

84 #ià
__GNUC__
 >= 3

85 
	#lik–y
(
x
è
	`__butš_ex³ù
(!!(x), 1)

	)

86 
	#uÆik–y
(
x
è
	`__butš_ex³ù
(!!(x), 0)

	)

88 
	#lik–y
(
x
è(x)

	)

89 
	#uÆik–y
(
x
è(x)

	)

94 
quickli¡
 *
	$quickli¡C»©e
() {

95 
quickli¡
 *quicklist;

97 
quickli¡
 = 
	`zm®loc
((*quicklist));

98 
quickli¡
->
h—d
 = quickli¡->

 = 
NULL
;

99 
quickli¡
->
Ën
 = 0;

100 
quickli¡
->
couÁ
 = 0;

101 
quickli¡
->
com´ess
 = 0;

102 
quickli¡
->
fl
 = -2;

103  
quickli¡
;

104 
	}
}

106 
	#COMPRESS_MAX
 (1 << 16)

	)

107 
	$quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
com´ess
) {

108 ià(
com´ess
 > 
COMPRESS_MAX
) {

109 
com´ess
 = 
COMPRESS_MAX
;

110 } ià(
com´ess
 < 0) {

111 
com´ess
 = 0;

113 
quickli¡
->
com´ess
 = compress;

114 
	}
}

116 
	#FILL_MAX
 (1 << 15)

	)

117 
	$quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
) {

118 ià(
fl
 > 
FILL_MAX
) {

119 
fl
 = 
FILL_MAX
;

120 } ià(
fl
 < -5) {

121 
fl
 = -5;

123 
quickli¡
->
fl
 = fill;

124 
	}
}

126 
	$quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
) {

127 
	`quickli¡S‘Fl
(
quickli¡
, 
fl
);

128 
	`quickli¡S‘Com´essD•th
(
quickli¡
, 
d•th
);

129 
	}
}

132 
quickli¡
 *
	$quickli¡New
(
fl
, 
com´ess
) {

133 
quickli¡
 *quickli¡ = 
	`quickli¡C»©e
();

134 
	`quickli¡S‘O±iÚs
(
quickli¡
, 
fl
, 
com´ess
);

135  
quickli¡
;

136 
	}
}

138 
REDIS_STATIC
 
quickli¡Node
 *
	$quickli¡C»©eNode
() {

139 
quickli¡Node
 *
node
;

140 
node
 = 
	`zm®loc
((*node));

141 
node
->
zl
 = 
NULL
;

142 
node
->
couÁ
 = 0;

143 
node
->
sz
 = 0;

144 
node
->
Ãxt
 =‚ode->
´ev
 = 
NULL
;

145 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

146 
node
->
cÚš”
 = 
QUICKLIST_NODE_CONTAINER_ZIPLIST
;

147 
node
->
»com´ess
 = 0;

148  
node
;

149 
	}
}

152 
	$quickli¡CouÁ
(cÚ¡ 
quickli¡
 *
ql
è{  ql->
couÁ
; 
	}
}

155 
	$quickli¡R–—£
(
quickli¡
 *quicklist) {

156 
Ën
;

157 
quickli¡Node
 *
cu¼’t
, *
Ãxt
;

159 
cu¼’t
 = 
quickli¡
->
h—d
;

160 
Ën
 = 
quickli¡
->len;

161 
Ën
--) {

162 
Ãxt
 = 
cu¼’t
->next;

164 
	`zä“
(
cu¼’t
->
zl
);

165 
quickli¡
->
couÁ
 -ğ
cu¼’t
->count;

167 
	`zä“
(
cu¼’t
);

169 
quickli¡
->
Ën
--;

170 
cu¼’t
 = 
Ãxt
;

172 
	`zä“
(
quickli¡
);

173 
	}
}

178 
REDIS_STATIC
 
	$__quickli¡Com´essNode
(
quickli¡Node
 *
node
) {

179 #ifdeà
REDIS_TEST


180 
node
->
©‹m±ed_com´ess
 = 1;

184 ià(
node
->
sz
 < 
MIN_COMPRESS_BYTES
)

187 
quickli¡LZF
 *
lzf
 = 
	`zm®loc
((*lzfè+ 
node
->
sz
);

190 ià(((
lzf
->
sz
 = 
	`lzf_com´ess
(
node
->
zl
,‚ode->sz,†zf->
com´es£d
,

191 
node
->
sz
)) == 0) ||

192 
lzf
->
sz
 + 
MIN_COMPRESS_IMPROVE
 >ğ
node
->sz) {

194 
	`zä“
(
lzf
);

197 
lzf
 = 
	`z»®loc
Özf, (*lzfè+†zf->
sz
);

198 
	`zä“
(
node
->
zl
);

199 
node
->
zl
 = (*)
lzf
;

200 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_LZF
;

201 
node
->
»com´ess
 = 0;

203 
	}
}

206 
	#quickli¡Com´essNode
(
_node
) \

208 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) { \

209 
	`__quickli¡Com´essNode
((
_node
)); \

211 } 0)

	)

215 
REDIS_STATIC
 
	$__quickli¡Decom´essNode
(
quickli¡Node
 *
node
) {

216 #ifdeà
REDIS_TEST


217 
node
->
©‹m±ed_com´ess
 = 0;

220 *
decom´es£d
 = 
	`zm®loc
(
node
->
sz
);

221 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

222 ià(
	`lzf_decom´ess
(
lzf
->
com´es£d
,†zf->
sz
, 
decom´es£d
, 
node
->sz) == 0) {

224 
	`zä“
(
decom´es£d
);

227 
	`zä“
(
lzf
);

228 
node
->
zl
 = 
decom´es£d
;

229 
node
->
’codšg
 = 
QUICKLIST_NODE_ENCODING_RAW
;

231 
	}
}

234 
	#quickli¡Decom´essNode
(
_node
) \

236 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

237 
	`__quickli¡Decom´essNode
((
_node
)); \

239 } 0)

	)

242 
	#quickli¡Decom´essNodeFÜU£
(
_node
) \

244 ià((
_node
è&& (_node)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) { \

245 
	`__quickli¡Decom´essNode
((
_node
)); \

246 (
_node
)->
»com´ess
 = 1; \

248 } 0)

	)

253 
size_t
 
	$quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
) {

254 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
node
->
zl
;

255 *
d©a
 = 
lzf
->
com´es£d
;

256  
lzf
->
sz
;

257 
	}
}

259 
	#quickli¡AÎowsCom´essiÚ
(
_ql
è((_ql)->
com´ess
 !ğ0)

	)

265 
REDIS_STATIC
 
	$__quickli¡Com´ess
(cÚ¡ 
quickli¡
 *quicklist,

266 
quickli¡Node
 *
node
) {

269 ià(!
	`quickli¡AÎowsCom´essiÚ
(
quickli¡
) ||

270 
quickli¡
->
Ën
 < ()(quickli¡->
com´ess
 * 2))

275 ià(
quickli¡
->
com´ess
 == 1) {

276 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
t
 = quickli¡->

;

277 
	`quickli¡Decom´essNode
(
h
);

278 
	`quickli¡Decom´essNode
(
t
);

279 ià(
h
 !ğ
node
 && 
t
 !=‚ode)

280 
	`quickli¡Com´essNode
(
node
);

282 } ià(
quickli¡
->
com´ess
 == 2) {

283 
quickli¡Node
 *
h
 = 
quickli¡
->
h—d
, *
hn
 = h->
Ãxt
, *
hÂ
 = hn->next;

284 
quickli¡Node
 *
t
 = 
quickli¡
->

, *

 =->
´ev
, *
p
 =p->prev;

285 
	`quickli¡Decom´essNode
(
h
);

286 
	`quickli¡Decom´essNode
(
hn
);

287 
	`quickli¡Decom´essNode
(
t
);

288 
	`quickli¡Decom´essNode
(

);

289 ià(
h
 !ğ
node
 && 
hn
 !ğnod&& 
t
 !ğnod&& 

 !=‚ode) {

290 
	`quickli¡Com´essNode
(
node
);

292 ià(
hÂ
 !ğ
t
) {

293 
	`quickli¡Com´essNode
(
hÂ
);

295 ià(
p
 !ğ
h
) {

296 
	`quickli¡Com´essNode
(
p
);

305 
quickli¡Node
 *
fÜw¬d
 = 
quickli¡
->
h—d
;

306 
quickli¡Node
 *
»v”£
 = 
quickli¡
->

;

307 
d•th
 = 0;

308 
š_d•th
 = 0;

309 
d•th
++ < 
quickli¡
->
com´ess
) {

310 
	`quickli¡Decom´essNode
(
fÜw¬d
);

311 
	`quickli¡Decom´essNode
(
»v”£
);

313 ià(
fÜw¬d
 =ğ
node
 || 
»v”£
 ==‚ode)

314 
š_d•th
 = 1;

316 ià(
fÜw¬d
 =ğ
»v”£
)

319 
fÜw¬d
 = fÜw¬d->
Ãxt
;

320 
»v”£
 =„ev”£->
´ev
;

323 ià(!
š_d•th
)

324 
	`quickli¡Com´essNode
(
node
);

326 ià(
d•th
 > 2) {

328 
	`quickli¡Com´essNode
(
fÜw¬d
);

329 
	`quickli¡Com´essNode
(
»v”£
);

331 
	}
}

333 
	#quickli¡Com´ess
(
_ql
, 
_node
) \

335 ià((
_node
)->
»com´ess
) \

336 
	`quickli¡Com´essNode
((
_node
)); \

338 
	`__quickli¡Com´ess
((
_ql
), (
_node
)); \

339 } 0)

	)

342 
	#quickli¡Recom´essOÆy
(
_ql
, 
_node
) \

344 ià((
_node
)->
»com´ess
) \

345 
	`quickli¡Com´essNode
((
_node
)); \

346 } 0)

	)

352 
REDIS_STATIC
 
	$__quickli¡In£¹Node
(
quickli¡
 *quicklist,

353 
quickli¡Node
 *
Şd_node
,

354 
quickli¡Node
 *
Ãw_node
, 
aá”
) {

355 ià(
aá”
) {

356 
Ãw_node
->
´ev
 = 
Şd_node
;

357 ià(
Şd_node
) {

358 
Ãw_node
->
Ãxt
 = 
Şd_node
->next;

359 ià(
Şd_node
->
Ãxt
)

360 
Şd_node
->
Ãxt
->
´ev
 = 
Ãw_node
;

361 
Şd_node
->
Ãxt
 = 
Ãw_node
;

363 ià(
quickli¡
->

 =ğ
Şd_node
)

364 
quickli¡
->

 = 
Ãw_node
;

366 
Ãw_node
->
Ãxt
 = 
Şd_node
;

367 ià(
Şd_node
) {

368 
Ãw_node
->
´ev
 = 
Şd_node
->prev;

369 ià(
Şd_node
->
´ev
)

370 
Şd_node
->
´ev
->
Ãxt
 = 
Ãw_node
;

371 
Şd_node
->
´ev
 = 
Ãw_node
;

373 ià(
quickli¡
->
h—d
 =ğ
Şd_node
)

374 
quickli¡
->
h—d
 = 
Ãw_node
;

377 ià(
quickli¡
->
Ën
 == 0) {

378 
quickli¡
->
h—d
 = quickli¡->

 = 
Ãw_node
;

381 ià(
Şd_node
)

382 
	`quickli¡Com´ess
(
quickli¡
, 
Şd_node
);

384 
quickli¡
->
Ën
++;

385 
	}
}

388 
REDIS_STATIC
 
	$_quickli¡In£¹NodeBefÜe
(
quickli¡
 *quicklist,

389 
quickli¡Node
 *
Şd_node
,

390 
quickli¡Node
 *
Ãw_node
) {

391 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 0);

392 
	}
}

394 
REDIS_STATIC
 
	$_quickli¡In£¹NodeAá”
(
quickli¡
 *quicklist,

395 
quickli¡Node
 *
Şd_node
,

396 
quickli¡Node
 *
Ãw_node
) {

397 
	`__quickli¡In£¹Node
(
quickli¡
, 
Şd_node
, 
Ãw_node
, 1);

398 
	}
}

400 
REDIS_STATIC
 

401 
	$_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(cÚ¡ 
size_t
 
sz
,

402 cÚ¡ 
fl
) {

403 ià(
fl
 >= 0)

406 
size_t
 
off£t
 = (-
fl
) - 1;

407 ià(
off£t
 < ((
İtimiz©iÚ_Ëv–
) / (*optimization_level))) {

408 ià(
sz
 <ğ
İtimiz©iÚ_Ëv–
[
off£t
]) {

416 
	}
}

418 
	#sizeM“tsSaãtyLim™
(
sz
è((szè<ğ
SIZE_SAFETY_LIMIT
)

	)

420 
REDIS_STATIC
 
	$_quickli¡NodeAÎowIn£¹
(cÚ¡ 
quickli¡Node
 *
node
,

421 cÚ¡ 
fl
, cÚ¡ 
size_t
 
sz
) {

422 ià(
	`uÆik–y
(!
node
))

425 
zli¡_ov”h—d
;

427 ià(
sz
 < 254)

428 
zli¡_ov”h—d
 = 1;

430 
zli¡_ov”h—d
 = 5;

433 ià(
sz
 < 64)

434 
zli¡_ov”h—d
 += 1;

435 ià(
	`lik–y
(
sz
 < 16384))

436 
zli¡_ov”h—d
 += 2;

438 
zli¡_ov”h—d
 += 5;

441 
Ãw_sz
 = 
node
->
sz
 + sz + 
zli¡_ov”h—d
;

442 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
Ãw_sz
, 
fl
)))

444 ià(!
	`sizeM“tsSaãtyLim™
(
Ãw_sz
))

446 ià(()
node
->
couÁ
 < 
fl
)

450 
	}
}

452 
REDIS_STATIC
 
	$_quickli¡NodeAÎowM”ge
(cÚ¡ 
quickli¡Node
 *
a
,

453 cÚ¡ 
quickli¡Node
 *
b
,

454 cÚ¡ 
fl
) {

455 ià(!
a
 || !
b
)

460 
m”ge_sz
 = 
a
->
sz
 + 
b
->sz - 11;

461 ià(
	`lik–y
(
	`_quickli¡NodeSizeM“tsO±imiz©iÚRequœem’t
(
m”ge_sz
, 
fl
)))

463 ià(!
	`sizeM“tsSaãtyLim™
(
m”ge_sz
))

465 ià(()(
a
->
couÁ
 + 
b
->couÁè<ğ
fl
)

469 
	}
}

471 
	#quickli¡NodeUpd©eSz
(
node
) \

473 (
node
)->
sz
 = 
	`zli¡BlobL’
(Òode)->
zl
); \

474 } 0)

	)

480 
	$quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

481 
quickli¡Node
 *
Üig_h—d
 = 
quickli¡
->
h—d
;

482 ià(
	`lik–y
(

483 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->
h—d
, quickli¡->
fl
, 
sz
))) {

484 
quickli¡
->
h—d
->
zl
 =

485 
	`zli¡Push
(
quickli¡
->
h—d
->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

486 
	`quickli¡NodeUpd©eSz
(
quickli¡
->
h—d
);

488 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

489 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

491 
	`quickli¡NodeUpd©eSz
(
node
);

492 
	`_quickli¡In£¹NodeBefÜe
(
quickli¡
, quickli¡->
h—d
, 
node
);

494 
quickli¡
->
couÁ
++;

495 
quickli¡
->
h—d
->
couÁ
++;

496  (
Üig_h—d
 !ğ
quickli¡
->
h—d
);

497 
	}
}

503 
	$quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, 
size_t
 
sz
) {

504 
quickli¡Node
 *
Üig_
 = 
quickli¡
->

;

505 ià(
	`lik–y
(

506 
	`_quickli¡NodeAÎowIn£¹
(
quickli¡
->

, quickli¡->
fl
, 
sz
))) {

507 
quickli¡
->

->
zl
 =

508 
	`zli¡Push
(
quickli¡
->

->
zl
, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

509 
	`quickli¡NodeUpd©eSz
(
quickli¡
->

);

511 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

512 
node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

514 
	`quickli¡NodeUpd©eSz
(
node
);

515 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

517 
quickli¡
->
couÁ
++;

518 
quickli¡
->

->
couÁ
++;

519  (
Üig_
 !ğ
quickli¡
->

);

520 
	}
}

525 
	$quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
) {

526 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

528 
node
->
zl
 = zl;

529 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

530 
node
->
sz
 = 
	`zli¡BlobL’
(
zl
);

532 
	`_quickli¡In£¹NodeAá”
(
quickli¡
, quickli¡->

, 
node
);

533 
quickli¡
->
couÁ
 +ğ
node
->count;

534 
	}
}

542 
quickli¡
 *
	$quickli¡Aµ’dV®uesFromZli¡
(
quickli¡
 *quicklist,

543 *
zl
) {

544 *
v®ue
;

545 
sz
;

546 
lÚgv®
;

547 
lÚg¡r
[32] = {0};

549 *
p
 = 
	`zli¡Index
(
zl
, 0);

550 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
)) {

551 ià(!
v®ue
) {

553 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

554 
v®ue
 = (*)
lÚg¡r
;

556 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

557 
p
 = 
	`zli¡Next
(
zl
,…);

559 
	`zä“
(
zl
);

560  
quickli¡
;

561 
	}
}

566 
quickli¡
 *
	$quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

567 *
zl
) {

568  
	`quickli¡Aµ’dV®uesFromZli¡
(
	`quickli¡New
(
fl
, 
com´ess
), 
zl
);

569 
	}
}

571 
	#quickli¡D–‘eIfEm±y
(
ql
, 
n
) \

573 ià((
n
)->
couÁ
 == 0) { \

574 
	`__quickli¡D–Node
((
ql
), (
n
)); \

575 (
n
èğ
NULL
; \

577 } 0)

	)

579 
REDIS_STATIC
 
	$__quickli¡D–Node
(
quickli¡
 *quicklist,

580 
quickli¡Node
 *
node
) {

581 ià(
node
->
Ãxt
)

582 
node
->
Ãxt
->
´ev
 =‚ode->prev;

583 ià(
node
->
´ev
)

584 
node
->
´ev
->
Ãxt
 =‚ode->next;

586 ià(
node
 =ğ
quickli¡
->

) {

587 
quickli¡
->

 = 
node
->
´ev
;

590 ià(
node
 =ğ
quickli¡
->
h—d
) {

591 
quickli¡
->
h—d
 = 
node
->
Ãxt
;

596 
	`__quickli¡Com´ess
(
quickli¡
, 
NULL
);

598 
quickli¡
->
couÁ
 -ğ
node
->count;

600 
	`zä“
(
node
->
zl
);

601 
	`zä“
(
node
);

602 
quickli¡
->
Ën
--;

603 
	}
}

613 
REDIS_STATIC
 
	$quickli¡D–Index
(
quickli¡
 *quickli¡, 
quickli¡Node
 *
node
,

614 **
p
) {

615 
gÚe
 = 0;

617 
node
->
zl
 = 
	`zli¡D–‘e
Òode->zl, 
p
);

618 
node
->
couÁ
--;

619 ià(
node
->
couÁ
 == 0) {

620 
gÚe
 = 1;

621 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

623 
	`quickli¡NodeUpd©eSz
(
node
);

625 
quickli¡
->
couÁ
--;

627  
gÚe
 ? 1 : 0;

628 
	}
}

634 
	$quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

635 
quickli¡Node
 *
´ev
 = 
’Œy
->
node
->prev;

636 
quickli¡Node
 *
Ãxt
 = 
’Œy
->
node
->next;

637 
d–‘ed_node
 = 
	`quickli¡D–Index
((
quickli¡
 *)
’Œy
->quicklist,

638 
’Œy
->
node
, &’Œy->
zi
);

641 
™”
->
zi
 = 
NULL
;

644 ià(
d–‘ed_node
) {

645 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

646 
™”
->
cu¼’t
 = 
Ãxt
;

647 
™”
->
off£t
 = 0;

648 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

649 
™”
->
cu¼’t
 = 
´ev
;

650 
™”
->
off£t
 = -1;

661 
	}
}

667 
	$quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

668 
sz
) {

669 
quickli¡EÁry
 
’Œy
;

670 ià(
	`lik–y
(
	`quickli¡Index
(
quickli¡
, 
šdex
, &
’Œy
))) {

672 
’Œy
.
node
->
zl
 = 
	`zli¡D–‘e
ÓÁry.node->zl, &’Œy.
zi
);

673 
’Œy
.
node
->
zl
 = 
	`zli¡In£¹
ÓÁry.node->zl,ƒÁry.
zi
, 
d©a
, 
sz
);

674 
	`quickli¡NodeUpd©eSz
(
’Œy
.
node
);

675 
	`quickli¡Com´ess
(
quickli¡
, 
’Œy
.
node
);

680 
	}
}

695 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡Zli¡M”ge
(
quickli¡
 *quicklist,

696 
quickli¡Node
 *
a
,

697 
quickli¡Node
 *
b
) {

698 
	`D
("Reque¡ed m”g×,bè(%u, %u)", 
a
->
couÁ
, 
b
->count);

700 
	`quickli¡Decom´essNode
(
a
);

701 
	`quickli¡Decom´essNode
(
b
);

702 ià((
	`zli¡M”ge
(&
a
->
zl
, &
b
->zl))) {

704 
quickli¡Node
 *
k“p
 = 
NULL
, *
nok“p
 = NULL;

705 ià(!
a
->
zl
) {

706 
nok“p
 = 
a
;

707 
k“p
 = 
b
;

708 } ià(!
b
->
zl
) {

709 
nok“p
 = 
b
;

710 
k“p
 = 
a
;

712 
k“p
->
couÁ
 = 
	`zli¡L’
(k“p->
zl
);

713 
	`quickli¡NodeUpd©eSz
(
k“p
);

715 
nok“p
->
couÁ
 = 0;

716 
	`__quickli¡D–Node
(
quickli¡
, 
nok“p
);

717 
	`quickli¡Com´ess
(
quickli¡
, 
k“p
);

718  
k“p
;

721  
NULL
;

723 
	}
}

733 
REDIS_STATIC
 
	$_quickli¡M”geNodes
(
quickli¡
 *quicklist,

734 
quickli¡Node
 *
ûÁ”
) {

735 
fl
 = 
quickli¡
->fill;

736 
quickli¡Node
 *
´ev
, *
´ev_´ev
, *
Ãxt
, *
Ãxt_Ãxt
, *
rg‘
;

737 
´ev
 = 
´ev_´ev
 = 
Ãxt
 = 
Ãxt_Ãxt
 = 
rg‘
 = 
NULL
;

739 ià(
ûÁ”
->
´ev
) {

740 
´ev
 = 
ûÁ”
->prev;

741 ià(
ûÁ”
->
´ev
->prev)

742 
´ev_´ev
 = 
ûÁ”
->
´ev
->prev;

745 ià(
ûÁ”
->
Ãxt
) {

746 
Ãxt
 = 
ûÁ”
->next;

747 ià(
ûÁ”
->
Ãxt
->next)

748 
Ãxt_Ãxt
 = 
ûÁ”
->
Ãxt
->next;

752 ià(
	`_quickli¡NodeAÎowM”ge
(
´ev
, 
´ev_´ev
, 
fl
)) {

753 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
´ev_´ev
, 
´ev
);

754 
´ev_´ev
 = 
´ev
 = 
NULL
;

758 ià(
	`_quickli¡NodeAÎowM”ge
(
Ãxt
, 
Ãxt_Ãxt
, 
fl
)) {

759 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
Ãxt
, 
Ãxt_Ãxt
);

760 
Ãxt
 = 
Ãxt_Ãxt
 = 
NULL
;

764 ià(
	`_quickli¡NodeAÎowM”ge
(
ûÁ”
, c’‹r->
´ev
, 
fl
)) {

765 
rg‘
 = 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
ûÁ”
->
´ev
, center);

766 
ûÁ”
 = 
NULL
;

769 
rg‘
 = 
ûÁ”
;

773 ià(
	`_quickli¡NodeAÎowM”ge
(
rg‘
,¬g‘->
Ãxt
, 
fl
)) {

774 
	`_quickli¡Zli¡M”ge
(
quickli¡
, 
rg‘
,¬g‘->
Ãxt
);

776 
	}
}

797 
REDIS_STATIC
 
quickli¡Node
 *
	$_quickli¡S¶™Node
(
quickli¡Node
 *
node
, 
off£t
,

798 
aá”
) {

799 
size_t
 
zl_sz
 = 
node
->
sz
;

801 
quickli¡Node
 *
Ãw_node
 = 
	`quickli¡C»©eNode
();

802 
Ãw_node
->
zl
 = 
	`zm®loc
(
zl_sz
);

805 
	`memıy
(
Ãw_node
->
zl
, 
node
->zl, 
zl_sz
);

808 
Üig_¡¬t
 = 
aá”
 ? 
off£t
 + 1 : 0;

809 
Üig_ex‹Á
 = 
aá”
 ? -1 : 
off£t
;

810 
Ãw_¡¬t
 = 
aá”
 ? 0 : 
off£t
;

811 
Ãw_ex‹Á
 = 
aá”
 ? 
off£t
 + 1 : -1;

813 
	`D
("Aá” %d (%d);„ªges: [%d, %d], [%d, %d]", 
aá”
, 
off£t
, 
Üig_¡¬t
,

814 
Üig_ex‹Á
, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

816 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
Üig_¡¬t
, 
Üig_ex‹Á
);

817 
node
->
couÁ
 = 
	`zli¡L’
Òode->
zl
);

818 
	`quickli¡NodeUpd©eSz
(
node
);

820 
Ãw_node
->
zl
 = 
	`zli¡D–‘eRªge
Òew_node->zl, 
Ãw_¡¬t
, 
Ãw_ex‹Á
);

821 
Ãw_node
->
couÁ
 = 
	`zli¡L’
Òew_node->
zl
);

822 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

824 
	`D
("Aá” s¶™†’gths: orig (%d),‚ew (%d)", 
node
->
couÁ
, 
Ãw_node
->count);

825  
Ãw_node
;

826 
	}
}

832 
REDIS_STATIC
 
	$_quickli¡In£¹
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

833 *
v®ue
, cÚ¡ 
size_t
 
sz
, 
aá”
) {

834 
fuÎ
 = 0, 
©_
 = 0, 
©_h—d
 = 0, 
fuÎ_Ãxt
 = 0, 
fuÎ_´ev
 = 0;

835 
fl
 = 
quickli¡
->fill;

836 
quickli¡Node
 *
node
 = 
’Œy
->node;

837 
quickli¡Node
 *
Ãw_node
 = 
NULL
;

839 ià(!
node
) {

841 
	`D
("No‚ode given!");

842 
Ãw_node
 = 
	`quickli¡C»©eNode
();

843 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

844 
	`__quickli¡In£¹Node
(
quickli¡
, 
NULL
, 
Ãw_node
, 
aá”
);

845 
Ãw_node
->
couÁ
++;

846 
quickli¡
->
couÁ
++;

851 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
, 
fl
, 
sz
)) {

852 
	`D
("Current‚ode is full with count %d with„equested fill %lu",

853 
node
->
couÁ
, 
fl
);

854 
fuÎ
 = 1;

857 ià(
aá”
 && (
’Œy
->
off£t
 =ğ
node
->
couÁ
)) {

858 
	`D
("At Tail of current ziplist");

859 
©_
 = 1;

860 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
Ãxt
, 
fl
, 
sz
)) {

861 
	`D
("Next‚ode is fulloo.");

862 
fuÎ_Ãxt
 = 1;

866 ià(!
aá”
 && (
’Œy
->
off£t
 == 0)) {

867 
	`D
("At Head");

868 
©_h—d
 = 1;

869 ià(!
	`_quickli¡NodeAÎowIn£¹
(
node
->
´ev
, 
fl
, 
sz
)) {

870 
	`D
("Prev‚ode is fulloo.");

871 
fuÎ_´ev
 = 1;

876 ià(!
fuÎ
 && 
aá”
) {

877 
	`D
("Not full, inserting‡fter current…osition.");

878 
	`quickli¡Decom´essNodeFÜU£
(
node
);

879 *
Ãxt
 = 
	`zli¡Next
(
node
->
zl
, 
’Œy
->
zi
);

880 ià(
Ãxt
 =ğ
NULL
) {

881 
node
->
zl
 = 
	`zli¡Push
Òode->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

883 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
Ãxt
, 
v®ue
, 
sz
);

885 
node
->
couÁ
++;

886 
	`quickli¡NodeUpd©eSz
(
node
);

887 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

888 } ià(!
fuÎ
 && !
aá”
) {

889 
	`D
("Not full, inserting before current…osition.");

890 
	`quickli¡Decom´essNodeFÜU£
(
node
);

891 
node
->
zl
 = 
	`zli¡In£¹
Òode->zl, 
’Œy
->
zi
, 
v®ue
, 
sz
);

892 
node
->
couÁ
++;

893 
	`quickli¡NodeUpd©eSz
(
node
);

894 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

895 } ià(
fuÎ
 && 
©_
 && 
node
->
Ãxt
 && !
fuÎ_Ãxt
 && 
aá”
) {

898 
	`D
("Full‡ndail, but‚ext isn't full; inserting‚ext‚ode head");

899 
Ãw_node
 = 
node
->
Ãxt
;

900 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

901 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

902 
Ãw_node
->
couÁ
++;

903 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

904 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

905 } ià(
fuÎ
 && 
©_h—d
 && 
node
->
´ev
 && !
fuÎ_´ev
 && !
aá”
) {

908 
	`D
("Full‡nd head, but…rev isn't full, inserting…rev‚odeail");

909 
Ãw_node
 = 
node
->
´ev
;

910 
	`quickli¡Decom´essNodeFÜU£
(
Ãw_node
);

911 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
, 
ZIPLIST_TAIL
);

912 
Ãw_node
->
couÁ
++;

913 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

914 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
Ãw_node
);

915 } ià(
fuÎ
 && ((
©_
 && 
node
->
Ãxt
 && 
fuÎ_Ãxt
 && 
aá”
) ||

916 (
©_h—d
 && 
node
->
´ev
 && 
fuÎ_´ev
 && !
aá”
))) {

919 
	`D
("\tprovisioning‚ew‚ode...");

920 
Ãw_node
 = 
	`quickli¡C»©eNode
();

921 
Ãw_node
->
zl
 = 
	`zli¡Push
(
	`zli¡New
(), 
v®ue
, 
sz
, 
ZIPLIST_HEAD
);

922 
Ãw_node
->
couÁ
++;

923 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

924 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

925 } ià(
fuÎ
) {

928 
	`D
("\tsplitting‚ode...");

929 
	`quickli¡Decom´essNodeFÜU£
(
node
);

930 
Ãw_node
 = 
	`_quickli¡S¶™Node
(
node
, 
’Œy
->
off£t
, 
aá”
);

931 
Ãw_node
->
zl
 = 
	`zli¡Push
Òew_node->zl, 
v®ue
, 
sz
,

932 
aá”
 ? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
);

933 
Ãw_node
->
couÁ
++;

934 
	`quickli¡NodeUpd©eSz
(
Ãw_node
);

935 
	`__quickli¡In£¹Node
(
quickli¡
, 
node
, 
Ãw_node
, 
aá”
);

936 
	`_quickli¡M”geNodes
(
quickli¡
, 
node
);

939 
quickli¡
->
couÁ
++;

940 
	}
}

942 
	$quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

943 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

944 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 0);

945 
	}
}

947 
	$quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
’Œy
,

948 *
v®ue
, cÚ¡ 
size_t
 
sz
) {

949 
	`_quickli¡In£¹
(
quickli¡
, 
’Œy
, 
v®ue
, 
sz
, 1);

950 
	}
}

958 
	$quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
,

959 cÚ¡ 
couÁ
) {

960 ià(
couÁ
 <= 0)

963 
ex‹Á
 = 
couÁ
;

965 ià(
¡¬t
 >ğ0 && 
ex‹Á
 > (
quickli¡
->
couÁ
 - start)) {

967 
ex‹Á
 = 
quickli¡
->
couÁ
 - 
¡¬t
;

968 } ià(
¡¬t
 < 0 && 
ex‹Á
 > ()(-start)) {

970 
ex‹Á
 = -
¡¬t
;

973 
quickli¡EÁry
 
’Œy
;

974 ià(!
	`quickli¡Index
(
quickli¡
, 
¡¬t
, &
’Œy
))

977 
	`D
("Quickli¡ d–‘»que¡ fÜ s¹ %ld, couÁ %ld,ƒx‹Á: %ld", 
¡¬t
,

978 
couÁ
, 
ex‹Á
);

979 
quickli¡Node
 *
node
 = 
’Œy
.node;

982 
ex‹Á
) {

983 
quickli¡Node
 *
Ãxt
 = 
node
->next;

985 
d–
;

986 
d–‘e_’tœe_node
 = 0;

987 ià(
’Œy
.
off£t
 =ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

990 
d–‘e_’tœe_node
 = 1;

991 
d–
 = 
node
->
couÁ
;

992 } ià(
’Œy
.
off£t
 >ğ0 && 
ex‹Á
 >ğ
node
->
couÁ
) {

995 
d–
 = 
node
->
couÁ
 - 
’Œy
.
off£t
;

996 } ià(
’Œy
.
off£t
 < 0) {

1002 
d–
 = -
’Œy
.
off£t
;

1007 ià(
d–
 > 
ex‹Á
)

1008 
d–
 = 
ex‹Á
;

1012 
d–
 = 
ex‹Á
;

1015 
	`D
("[%ld]:‡skingo del: %ld because offset: %d; (ENTIRE NODE: %d), "

1017 
ex‹Á
, 
d–
, 
’Œy
.
off£t
, 
d–‘e_’tœe_node
, 
node
->
couÁ
);

1019 ià(
d–‘e_’tœe_node
) {

1020 
	`__quickli¡D–Node
(
quickli¡
, 
node
);

1022 
	`quickli¡Decom´essNodeFÜU£
(
node
);

1023 
node
->
zl
 = 
	`zli¡D–‘eRªge
Òode->zl, 
’Œy
.
off£t
, 
d–
);

1024 
	`quickli¡NodeUpd©eSz
(
node
);

1025 
node
->
couÁ
 -ğ
d–
;

1026 
quickli¡
->
couÁ
 -ğ
d–
;

1027 
	`quickli¡D–‘eIfEm±y
(
quickli¡
, 
node
);

1028 ià(
node
)

1029 
	`quickli¡Recom´essOÆy
(
quickli¡
, 
node
);

1032 
ex‹Á
 -ğ
d–
;

1034 
node
 = 
Ãxt
;

1036 
’Œy
.
off£t
 = 0;

1039 
	}
}

1042 
	$quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
) {

1043  
	`zli¡Com·»
(
p1
, 
p2
, 
p2_Ën
);

1044 
	}
}

1048 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
) {

1049 
quickli¡I‹r
 *
™”
;

1051 
™”
 = 
	`zm®loc
((*iter));

1053 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1054 
™”
->
cu¼’t
 = 
quickli¡
->
h—d
;

1055 
™”
->
off£t
 = 0;

1056 } ià(
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1057 
™”
->
cu¼’t
 = 
quickli¡
->

;

1058 
™”
->
off£t
 = -1;

1061 
™”
->
dœeùiÚ
 = direction;

1062 
™”
->
quickli¡
 = quicklist;

1064 
™”
->
zi
 = 
NULL
;

1066  
™”
;

1067 
	}
}

1071 
quickli¡I‹r
 *
	$quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

1072 cÚ¡ 
dœeùiÚ
,

1073 cÚ¡ 
idx
) {

1074 
quickli¡EÁry
 
’Œy
;

1076 ià(
	`quickli¡Index
(
quickli¡
, 
idx
, &
’Œy
)) {

1077 
quickli¡I‹r
 *
ba£
 = 
	`quickli¡G‘I‹¿tÜ
(
quickli¡
, 
dœeùiÚ
);

1078 
ba£
->
zi
 = 
NULL
;

1079 
ba£
->
cu¼’t
 = 
’Œy
.
node
;

1080 
ba£
->
off£t
 = 
’Œy
.offset;

1081  
ba£
;

1083  
NULL
;

1085 
	}
}

1089 
	$quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
) {

1090 ià(
™”
->
cu¼’t
)

1091 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1093 
	`zä“
(
™”
);

1094 
	}
}

1117 
	$quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
) {

1118 
	`š™EÁry
(
’Œy
);

1120 ià(!
™”
) {

1121 
	`D
("Returning because‚o iter!");

1125 
’Œy
->
quickli¡
 = 
™”
->quicklist;

1126 
’Œy
->
node
 = 
™”
->
cu¼’t
;

1128 ià(!
™”
->
cu¼’t
) {

1129 
	`D
("Returning because current‚ode is NULL")

1133 *(*
ÃxtFn
)(*, *èğ
NULL
;

1134 
off£t_upd©e
 = 0;

1136 ià(!
™”
->
zi
) {

1138 
	`quickli¡Decom´essNodeFÜU£
(
™”
->
cu¼’t
);

1139 
™”
->
zi
 = 
	`zli¡Index
(™”->
cu¼’t
->
zl
, i‹r->
off£t
);

1142 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1143 
ÃxtFn
 = 
zli¡Next
;

1144 
off£t_upd©e
 = 1;

1145 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1146 
ÃxtFn
 = 
zli¡P»v
;

1147 
off£t_upd©e
 = -1;

1149 
™”
->
zi
 = 
	`ÃxtFn
(™”->
cu¼’t
->
zl
, iter->zi);

1150 
™”
->
off£t
 +ğ
off£t_upd©e
;

1153 
’Œy
->
zi
 = 
™”
->zi;

1154 
’Œy
->
off£t
 = 
™”
->offset;

1156 ià(
™”
->
zi
) {

1158 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1163 
	`quickli¡Com´ess
(
™”
->
quickli¡
, i‹r->
cu¼’t
);

1164 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
) {

1166 
	`D
("Jumpingo start of‚ext‚ode");

1167 
™”
->
cu¼’t
 = i‹r->cu¼’t->
Ãxt
;

1168 
™”
->
off£t
 = 0;

1169 } ià(
™”
->
dœeùiÚ
 =ğ
AL_START_TAIL
) {

1171 
	`D
("Jumpingoƒnd of…revious‚ode");

1172 
™”
->
cu¼’t
 = i‹r->cu¼’t->
´ev
;

1173 
™”
->
off£t
 = -1;

1175 
™”
->
zi
 = 
NULL
;

1176  
	`quickli¡Next
(
™”
, 
’Œy
);

1178 
	}
}

1186 
quickli¡
 *
	$quickli¡Dup
(
quickli¡
 *
Üig
) {

1187 
quickli¡
 *
cİy
;

1189 
cİy
 = 
	`quickli¡New
(
Üig
->
fl
, orig->
com´ess
);

1191 
quickli¡Node
 *
cu¼’t
 = 
Üig
->
h—d
; current;

1192 
cu¼’t
 = cu¼’t->
Ãxt
) {

1193 
quickli¡Node
 *
node
 = 
	`quickli¡C»©eNode
();

1195 ià(
cu¼’t
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
) {

1196 
quickli¡LZF
 *
lzf
 = (quickli¡LZF *)
cu¼’t
->
zl
;

1197 
size_t
 
lzf_sz
 = (*
lzf
è+†zf->
sz
;

1198 
node
->
zl
 = 
	`zm®loc
(
lzf_sz
);

1199 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, 
lzf_sz
);

1200 } ià(
cu¼’t
->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_RAW
) {

1201 
node
->
zl
 = 
	`zm®loc
(
cu¼’t
->
sz
);

1202 
	`memıy
(
node
->
zl
, 
cu¼’t
->zl, cu¼’t->
sz
);

1205 
node
->
couÁ
 = 
cu¼’t
->count;

1206 
cİy
->
couÁ
 +ğ
node
->count;

1207 
node
->
sz
 = 
cu¼’t
->sz;

1208 
node
->
’codšg
 = 
cu¼’t
->encoding;

1210 
	`_quickli¡In£¹NodeAá”
(
cİy
, cİy->

, 
node
);

1214  
cİy
;

1215 
	}
}

1225 
	$quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
idx
,

1226 
quickli¡EÁry
 *
’Œy
) {

1227 
quickli¡Node
 *
n
;

1228 
accum
 = 0;

1229 
šdex
;

1230 
fÜw¬d
 = 
idx
 < 0 ? 0 : 1;

1232 
	`š™EÁry
(
’Œy
);

1233 
’Œy
->
quickli¡
 = quicklist;

1235 ià(!
fÜw¬d
) {

1236 
šdex
 = (-
idx
) - 1;

1237 
n
 = 
quickli¡
->

;

1239 
šdex
 = 
idx
;

1240 
n
 = 
quickli¡
->
h—d
;

1243 ià(
šdex
 >ğ
quickli¡
->
couÁ
)

1246 
	`lik–y
(
n
)) {

1247 ià((
accum
 + 
n
->
couÁ
è> 
šdex
) {

1250 
	`D
("Skpšg ov” (%pè%u‡ˆaccum %Îd", (*)
n
,‚->
couÁ
,

1251 
accum
);

1252 
accum
 +ğ
n
->
couÁ
;

1253 
n
 = 
fÜw¬d
 ?‚->
Ãxt
 :‚->
´ev
;

1257 ià(!
n
)

1260 
	`D
("Found‚ode: %°©‡ccum %Îu, idx %Îu, sub+ %Îu, sub- %Îu", (*)
n
,

1261 
accum
, 
šdex
, index -‡ccum, (-index) - 1 +‡ccum);

1263 
’Œy
->
node
 = 
n
;

1264 ià(
fÜw¬d
) {

1266 
’Œy
->
off£t
 = 
šdex
 - 
accum
;

1270 
’Œy
->
off£t
 = (-
šdex
è- 1 + 
accum
;

1273 
	`quickli¡Decom´essNodeFÜU£
(
’Œy
->
node
);

1274 
’Œy
->
zi
 = 
	`zli¡Index
ÓÁry->
node
->
zl
,ƒÁry->
off£t
);

1275 
	`zli¡G‘
(
’Œy
->
zi
, &’Œy->
v®ue
, &’Œy->
sz
, &’Œy->
lÚgv®
);

1279 
	}
}

1282 
	$quickli¡RÙ©e
(
quickli¡
 *quicklist) {

1283 ià(
quickli¡
->
couÁ
 <= 1)

1287 *
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1288 *
v®ue
;

1289 
lÚgv®
;

1290 
sz
;

1291 
lÚg¡r
[32] = {0};

1292 
	`zli¡G‘
(
p
, &
v®ue
, &
sz
, &
lÚgv®
);

1295 ià(!
v®ue
) {

1297 
sz
 = 
	`Î2¡ršg
(
lÚg¡r
, ÖÚg¡r), 
lÚgv®
);

1298 
v®ue
 = (*)
lÚg¡r
;

1302 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1307 ià(
quickli¡
->
Ën
 == 1) {

1308 
p
 = 
	`zli¡Index
(
quickli¡
->

->
zl
, -1);

1312 
	`quickli¡D–Index
(
quickli¡
, quickli¡->

, &
p
);

1313 
	}
}

1324 
	$quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1325 *
sz
, *
sv®
,

1326 *(*
§v”
)(*
d©a
, 
sz
)) {

1327 *
p
;

1328 *
v¡r
;

1329 
vËn
;

1330 
vlÚg
;

1331 
pos
 = (
wh”e
 =ğ
QUICKLIST_HEAD
) ? 0 : -1;

1333 ià(
quickli¡
->
couÁ
 == 0)

1336 ià(
d©a
)

1337 *
d©a
 = 
NULL
;

1338 ià(
sz
)

1339 *
sz
 = 0;

1340 ià(
sv®
)

1341 *
sv®
 = -123456789;

1343 
quickli¡Node
 *
node
;

1344 ià(
wh”e
 =ğ
QUICKLIST_HEAD
 && 
quickli¡
->
h—d
) {

1345 
node
 = 
quickli¡
->
h—d
;

1346 } ià(
wh”e
 =ğ
QUICKLIST_TAIL
 && 
quickli¡
->

) {

1347 
node
 = 
quickli¡
->

;

1352 
p
 = 
	`zli¡Index
(
node
->
zl
, 
pos
);

1353 ià(
	`zli¡G‘
(
p
, &
v¡r
, &
vËn
, &
vlÚg
)) {

1354 ià(
v¡r
) {

1355 ià(
d©a
)

1356 *
d©a
 = 
	`§v”
(
v¡r
, 
vËn
);

1357 ià(
sz
)

1358 *
sz
 = 
vËn
;

1360 ià(
d©a
)

1361 *
d©a
 = 
NULL
;

1362 ià(
sv®
)

1363 *
sv®
 = 
vlÚg
;

1365 
	`quickli¡D–Index
(
quickli¡
, 
node
, &
p
);

1369 
	}
}

1372 
REDIS_STATIC
 *
	$_quickli¡Sav”
(*
d©a
, 
sz
) {

1373 *
v¡r
;

1374 ià(
d©a
) {

1375 
v¡r
 = 
	`zm®loc
(
sz
);

1376 
	`memıy
(
v¡r
, 
d©a
, 
sz
);

1377  
v¡r
;

1379  
NULL
;

1380 
	}
}

1385 
	$quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

1386 *
sz
, *
¦Úg
) {

1387 *
v¡r
;

1388 
vËn
;

1389 
vlÚg
;

1390 ià(
quickli¡
->
couÁ
 == 0)

1392 
»t
 = 
	`quickli¡PİCu¡om
(
quickli¡
, 
wh”e
, &
v¡r
, &
vËn
, &
vlÚg
,

1393 
_quickli¡Sav”
);

1394 ià(
d©a
)

1395 *
d©a
 = 
v¡r
;

1396 ià(
¦Úg
)

1397 *
¦Úg
 = 
vlÚg
;

1398 ià(
sz
)

1399 *
sz
 = 
vËn
;

1400  
»t
;

1401 
	}
}

1404 
	$quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

1405 
wh”e
) {

1406 ià(
wh”e
 =ğ
QUICKLIST_HEAD
) {

1407 
	`quickli¡PushH—d
(
quickli¡
, 
v®ue
, 
sz
);

1408 } ià(
wh”e
 =ğ
QUICKLIST_TAIL
) {

1409 
	`quickli¡PushTa
(
quickli¡
, 
v®ue
, 
sz
);

1411 
	}
}

1414 #ifdeà
REDIS_TEST


1415 
	~<¡dšt.h
>

1416 
	~<sys/time.h
>

1418 
	#as£¹
(
_e
) \

1420 ià(!(
_e
)) { \

1421 
	`´štf
("\n\n=== ASSERTION FAILED ===\n"); \

1422 
	`´štf
("==> %s:%d '%s' i nÙrue\n", 
__FILE__
, 
__LINE__
, #_e); \

1423 
”r
++; \

1425 } 0)

	)

1427 
	#y–l
(
¡r
, ...è
	`´štf
("ERROR! " sŒ "\n\n", 
__VA_ARGS__
)

	)

1429 
	#OK
 
	`´štf
("\tOK\n")

	)

1431 
	#ERROR
 \

1433 
	`´štf
("\tERROR!\n"); \

1434 
”r
++; \

1435 } 0)

	)

1437 
	#ERR
(
x
, ...) \

1439 
	`´štf
("%s:%s:%d:\t", 
__FILE__
, 
__FUNCTION__
, 
__LINE__
); \

1440 
	`´štf
("ERROR! " 
x
 "\n", 
__VA_ARGS__
); \

1441 
”r
++; \

1442 } 0)

	)

1444 
	#TEST
(
Çme
è
	`´štf
("‹¡ â€” %s\n",‚ame);

	)

1445 
	#TEST_DESC
(
Çme
, ...è
	`´štf
("‹¡ â€” "‚am"\n", 
__VA_ARGS__
);

	)

1447 
	#QL_TEST_VERBOSE
 0

	)

1449 
	#UNUSED
(
x
è()(x)

	)

1450 
	$ql_šfo
(
quickli¡
 *
ql
) {

1451 #ià
QL_TEST_VERBOSE


1452 
	`´štf
("CÚš”†’gth: %lu\n", 
ql
->
Ën
);

1453 
	`´štf
("CÚš” size: %lu\n", 
ql
->
couÁ
);

1454 ià(
ql
->
h—d
)

1455 
	`´štf
("\t(zsizh—d: %d)\n", 
	`zli¡L’
(
ql
->
h—d
->
zl
));

1456 ià(
ql
->

)

1457 
	`´štf
("\t(zsiz: %d)\n", 
	`zli¡L’
(
ql
->

->
zl
));

1458 
	`´štf
("\n");

1460 
	`UNUSED
(
ql
);

1462 
	}
}

1465 
	$u¡ime
() {

1466 
timev®
 
tv
;

1467 
u¡
;

1469 
	`g‘timeofday
(&
tv
, 
NULL
);

1470 
u¡
 = (()
tv
.
tv_£c
) * 1000000;

1471 
u¡
 +ğ
tv
.
tv_u£c
;

1472  
u¡
;

1473 
	}
}

1476 
	$m¡ime
(è{  
	`u¡ime
(è/ 1000; 
	}
}

1482 
	$_™½ršŒ
(
quickli¡
 *
ql
, 
´št
, 
fÜw¬d
) {

1483 
quickli¡I‹r
 *
™”
 =

1484 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
fÜw¬d
 ? 
AL_START_HEAD
 : 
AL_START_TAIL
);

1485 
quickli¡EÁry
 
’Œy
;

1486 
i
 = 0;

1487 
p
 = 0;

1488 
quickli¡Node
 *
´ev
 = 
NULL
;

1489 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1490 ià(
’Œy
.
node
 !ğ
´ev
) {

1492 
p
++;

1493 
´ev
 = 
’Œy
.
node
;

1495 ià(
´št
) {

1496 
	`´štf
("[%3d (%2d)]: [%.*s] (%Îd)\n", 
i
, 
p
, 
’Œy
.
sz
,

1497 (*)
’Œy
.
v®ue
,ƒÁry.
lÚgv®
);

1499 
i
++;

1501 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1502  
i
;

1503 
	}
}

1504 
	$™½ršŒ
(
quickli¡
 *
ql
, 
´št
) {

1505  
	`_™½ršŒ
(
ql
, 
´št
, 1);

1506 
	}
}

1508 
	$™½ršŒ_»v
(
quickli¡
 *
ql
, 
´št
) {

1509  
	`_™½ršŒ
(
ql
, 
´št
, 0);

1510 
	}
}

1512 
	#ql_v”ify
(
a
, 
b
, 
c
, 
d
, 
e
) \

1514 
”r
 +ğ
	`_ql_v”ify
((
a
), (
b
), (
c
), (
d
), (
e
)); \

1515 } 0)

	)

1518 
	$_ql_v”ify
(
quickli¡
 *
ql
, 
ušt32_t
 
Ën
, ušt32_ˆ
couÁ
,

1519 
ušt32_t
 
h—d_couÁ
, ušt32_ˆ
_couÁ
) {

1520 
”rÜs
 = 0;

1522 
	`ql_šfo
(
ql
);

1523 ià(
Ën
 !ğ
ql
->len) {

1524 
	`y–l
("quickli¡†’gth wrÚg:ƒx³ùed %d, gÙ %u", 
Ën
, 
ql
->len);

1525 
”rÜs
++;

1528 ià(
couÁ
 !ğ
ql
->count) {

1529 
	`y–l
("quickli¡ couÁ wrÚg:ƒx³ùed %d, gÙ %lu", 
couÁ
, 
ql
->count);

1530 
”rÜs
++;

1533 
loİr
 = 
	`™½ršŒ
(
ql
, 0);

1534 ià(
loİr
 !ğ()
ql
->
couÁ
) {

1535 
	`y–l
("quicklist cached count‚ot match‡ctual count:ƒxpected %lu, got "

1537 
ql
->
couÁ
, 
loİr
);

1538 
”rÜs
++;

1541 
¾oİr
 = 
	`™½ršŒ_»v
(
ql
, 0);

1542 ià(
loİr
 !ğ
¾oİr
) {

1543 
	`y–l
("quicklist has different forward counthan„everse count! "

1545 
loİr
, 
¾oİr
);

1546 
”rÜs
++;

1549 ià(
ql
->
Ën
 =ğ0 && !
”rÜs
) {

1550 
OK
;

1551  
”rÜs
;

1554 ià(
ql
->
h—d
 && 
h—d_couÁ
 !ğql->h—d->
couÁ
 &&

1555 
h—d_couÁ
 !ğ
	`zli¡L’
(
ql
->
h—d
->
zl
)) {

1556 
	`y–l
("quicklist head count wrong:ƒxpected %d, "

1558 
h—d_couÁ
, 
ql
->
h—d
->
couÁ
, 
	`zli¡L’
(ql->h—d->
zl
));

1559 
”rÜs
++;

1562 ià(
ql
->

 && 
_couÁ
 !ğql->->
couÁ
 &&

1563 
_couÁ
 !ğ
	`zli¡L’
(
ql
->

->
zl
)) {

1564 
	`y–l
("quicklistail count wrong:ƒxpected %d, "

1566 
_couÁ
, 
ql
->

->
couÁ
, 
	`zli¡L’
(ql->->
zl
));

1567 
”rÜs
++;

1570 ià(
	`quickli¡AÎowsCom´essiÚ
(
ql
)) {

1571 
quickli¡Node
 *
node
 = 
ql
->
h—d
;

1572 
low_¿w
 = 
ql
->
com´ess
;

1573 
high_¿w
 = 
ql
->
Ën
 - ql->
com´ess
;

1575 
©
 = 0;‡ˆ< 
ql
->
Ën
;‡t++, 
node
 =‚ode->
Ãxt
) {

1576 ià(
node
 && (
©
 < 
low_¿w
 ||‡ˆ>ğ
high_¿w
)) {

1577 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_RAW
) {

1578 
	`y–l
("Incorrect compression:‚ode %d is "

1581 
©
, 
ql
->
com´ess
, 
low_¿w
, 
high_¿w
, ql->
Ën
, 
node
->
sz
,

1582 
node
->
»com´ess
);

1583 
”rÜs
++;

1586 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_LZF
 &&

1587 !
node
->
©‹m±ed_com´ess
) {

1588 
	`y–l
("Incorrect‚on-compression:‚ode %d is NOT "

1591 
©
, 
ql
->
com´ess
, 
low_¿w
, 
high_¿w
, ql->
Ën
, 
node
->
sz
,

1592 
node
->
»com´ess
,‚ode->
©‹m±ed_com´ess
);

1593 
”rÜs
++;

1599 ià(!
”rÜs
)

1600 
OK
;

1601  
”rÜs
;

1602 
	}
}

1605 *
	$g’¡r
(*
´efix
, 
i
) {

1606 
»suÉ
[64] = {0};

1607 
	`¢´štf
(
»suÉ
, ÔesuÉ), "%s%d", 
´efix
, 
i
);

1608  
»suÉ
;

1609 
	}
}

1612 
	$quickli¡Te¡
(
¬gc
, *
¬gv
[]) {

1613 
	`UNUSED
(
¬gc
);

1614 
	`UNUSED
(
¬gv
);

1616 
”r
 = 0;

1617 
İtimize_¡¬t
 =

1618 -()((
İtimiz©iÚ_Ëv–
) / (*optimization_level));

1620 
	`´štf
("S¹šg o±imiz©iÚ off£ˆ©: %d\n", 
İtimize_¡¬t
);

1622 
İtiÚs
[] = {0, 1, 2, 3, 4, 5, 6, 10};

1623 
size_t
 
İtiÚ_couÁ
 = (
İtiÚs
) / (*options);

1624 
ruÁime
[
İtiÚ_couÁ
];

1626 
_i
 = 0; _˜< ()
İtiÚ_couÁ
; _i++) {

1627 
	`´štf
("Te¡šg O±iÚ %d\n", 
İtiÚs
[
_i
]);

1628 
¡¬t
 = 
	`m¡ime
();

1630 
	`TEST
("create†ist") {

1631 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1632 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1633 
	`quickli¡R–—£
(
ql
);

1636 
	`TEST
("addoail ofƒmpty†ist") {

1637 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1638 
	`quickli¡PushTa
(
ql
, "hello", 6);

1640 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1641 
	`quickli¡R–—£
(
ql
);

1644 
	`TEST
("addo head ofƒmpty†ist") {

1645 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1646 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1648 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1649 
	`quickli¡R–—£
(
ql
);

1652 
f
 = 
İtimize_¡¬t
; f < 32; f++) {

1653 
	`TEST_DESC
("addØ 5x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1654 
İtiÚs
[
_i
]) {

1655 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1656 
i
 = 0; i < 5; i++)

1657 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1658 ià(
ql
->
couÁ
 != 5)

1659 
ERROR
;

1660 ià(
f
 == 32)

1661 
	`ql_v”ify
(
ql
, 1, 5, 5, 5);

1662 
	`quickli¡R–—£
(
ql
);

1666 
f
 = 
İtimize_¡¬t
; f < 32; f++) {

1667 
	`TEST_DESC
("addØh—d 5x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1668 
İtiÚs
[
_i
]) {

1669 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1670 
i
 = 0; i < 5; i++)

1671 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1672 ià(
ql
->
couÁ
 != 5)

1673 
ERROR
;

1674 ià(
f
 == 32)

1675 
	`ql_v”ify
(
ql
, 1, 5, 5, 5);

1676 
	`quickli¡R–—£
(
ql
);

1680 
f
 = 
İtimize_¡¬t
; f < 512; f++) {

1681 
	`TEST_DESC
("addØ 500x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1682 
İtiÚs
[
_i
]) {

1683 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1684 
i
 = 0; i < 500; i++)

1685 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
), 64);

1686 ià(
ql
->
couÁ
 != 500)

1687 
ERROR
;

1688 ià(
f
 == 32)

1689 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

1690 
	`quickli¡R–—£
(
ql
);

1694 
f
 = 
İtimize_¡¬t
; f < 512; f++) {

1695 
	`TEST_DESC
("addØh—d 500x‡ˆfÈ%d‡ˆcom´es %d", 
f
,

1696 
İtiÚs
[
_i
]) {

1697 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1698 
i
 = 0; i < 500; i++)

1699 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1700 ià(
ql
->
couÁ
 != 500)

1701 
ERROR
;

1702 ià(
f
 == 32)

1703 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

1704 
	`quickli¡R–—£
(
ql
);

1708 
	`TEST
("rotateƒmpty") {

1709 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1710 
	`quickli¡RÙ©e
(
ql
);

1711 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1712 
	`quickli¡R–—£
(
ql
);

1715 
f
 = 
İtimize_¡¬t
; f < 32; f++) {

1716 
	`TEST
("rotate one val once") {

1717 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1718 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1719 
	`quickli¡RÙ©e
(
ql
);

1722 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1723 
	`quickli¡R–—£
(
ql
);

1727 
f
 = 
İtimize_¡¬t
; f < 3; f++) {

1728 
	`TEST_DESC
("rÙ©500 v® 5000ime © fÈ%d‡ˆcom´es %d", 
f
,

1729 
İtiÚs
[
_i
]) {

1730 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1731 
	`quickli¡PushH—d
(
ql
, "900", 3);

1732 
	`quickli¡PushH—d
(
ql
, "7000", 4);

1733 
	`quickli¡PushH—d
(
ql
, "-1200", 5);

1734 
	`quickli¡PushH—d
(
ql
, "42", 2);

1735 
i
 = 0; i < 500; i++)

1736 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 64);

1737 
	`ql_šfo
(
ql
);

1738 
i
 = 0; i < 5000; i++) {

1739 
	`ql_šfo
(
ql
);

1740 
	`quickli¡RÙ©e
(
ql
);

1742 ià(
f
 == 1)

1743 
	`ql_v”ify
(
ql
, 504, 504, 1, 1);

1744 ià(
f
 == 2)

1745 
	`ql_v”ify
(
ql
, 252, 504, 2, 2);

1746 ià(
f
 == 32)

1747 
	`ql_v”ify
(
ql
, 16, 504, 32, 24);

1748 
	`quickli¡R–—£
(
ql
);

1752 
	`TEST
("popƒmpty") {

1753 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1754 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, 
NULL
, NULL, NULL);

1755 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1756 
	`quickli¡R–—£
(
ql
);

1759 
	`TEST
("pop 1 string from 1") {

1760 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1761 *
pİuÏ‹
 = 
	`g’¡r
("hello", 331);

1762 
	`quickli¡PushH—d
(
ql
, 
pİuÏ‹
, 32);

1763 *
d©a
;

1764 
sz
;

1765 
lv
;

1766 
	`ql_šfo
(
ql
);

1767 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1768 
	`as£¹
(
d©a
 !ğ
NULL
);

1769 
	`as£¹
(
sz
 == 32);

1770 ià(
	`¡rcmp
(
pİuÏ‹
, (*)
d©a
))

1771 
	`ERR
("Pİ'd v®u(%.*sèdidn'ˆequ® origš® v®u(%s)", 
sz
,

1772 
d©a
, 
pİuÏ‹
);

1773 
	`zä“
(
d©a
);

1774 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1775 
	`quickli¡R–—£
(
ql
);

1778 
	`TEST
("pop head 1‚umber from 1") {

1779 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1780 
	`quickli¡PushH—d
(
ql
, "55513", 5);

1781 *
d©a
;

1782 
sz
;

1783 
lv
;

1784 
	`ql_šfo
(
ql
);

1785 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1786 
	`as£¹
(
d©a
 =ğ
NULL
);

1787 
	`as£¹
(
lv
 == 55513);

1788 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1789 
	`quickli¡R–—£
(
ql
);

1792 
	`TEST
("pop head 500 from 500") {

1793 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1794 
i
 = 0; i < 500; i++)

1795 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1796 
	`ql_šfo
(
ql
);

1797 
i
 = 0; i < 500; i++) {

1798 *
d©a
;

1799 
sz
;

1800 
lv
;

1801 
»t
 = 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1802 
	`as£¹
(
»t
 == 1);

1803 
	`as£¹
(
d©a
 !ğ
NULL
);

1804 
	`as£¹
(
sz
 == 32);

1805 ià(
	`¡rcmp
(
	`g’¡r
("h–lo", 499 - 
i
), (*)
d©a
))

1806 
	`ERR
("Pop'd value (%.*s) didn'tƒqual original value (%s)",

1807 
sz
, 
d©a
, 
	`g’¡r
("h–lo", 499 - 
i
));

1808 
	`zä“
(
d©a
);

1810 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1811 
	`quickli¡R–—£
(
ql
);

1814 
	`TEST
("pop head 5000 from 500") {

1815 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1816 
i
 = 0; i < 500; i++)

1817 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1818 
i
 = 0; i < 5000; i++) {

1819 *
d©a
;

1820 
sz
;

1821 
lv
;

1822 
»t
 = 
	`quickli¡Pİ
(
ql
, 
QUICKLIST_HEAD
, &
d©a
, &
sz
, &
lv
);

1823 ià(
i
 < 500) {

1824 
	`as£¹
(
»t
 == 1);

1825 
	`as£¹
(
d©a
 !ğ
NULL
);

1826 
	`as£¹
(
sz
 == 32);

1827 ià(
	`¡rcmp
(
	`g’¡r
("h–lo", 499 - 
i
), (*)
d©a
))

1828 
	`ERR
("Pop'd value (%.*s) didn'tƒqual original value "

1830 
sz
, 
d©a
, 
	`g’¡r
("h–lo", 499 - 
i
));

1831 
	`zä“
(
d©a
);

1833 
	`as£¹
(
»t
 == 0);

1836 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

1837 
	`quickli¡R–—£
(
ql
);

1840 
	`TEST
("iterate forward over 500†ist") {

1841 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1842 
	`quickli¡S‘Fl
(
ql
, 32);

1843 
i
 = 0; i < 500; i++)

1844 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1845 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

1846 
quickli¡EÁry
 
’Œy
;

1847 
i
 = 499, 
couÁ
 = 0;

1848 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1849 *
h
 = 
	`g’¡r
("h–lo", 
i
);

1850 ià(
	`¡rcmp
((*)
’Œy
.
v®ue
, 
h
))

1851 
	`ERR
("value [%s] didn't match [%s]‡t…osition %d",

1852 
’Œy
.
v®ue
, 
h
, 
i
);

1853 
i
--;

1854 
couÁ
++;

1856 ià(
couÁ
 != 500)

1857 
	`ERR
("Didn'ˆ™”©ov”ƒxaùly 500ƒËm’t (%d)", 
i
);

1858 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

1859 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1860 
	`quickli¡R–—£
(
ql
);

1863 
	`TEST
("iterate„everse over 500†ist") {

1864 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1865 
	`quickli¡S‘Fl
(
ql
, 32);

1866 
i
 = 0; i < 500; i++)

1867 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1868 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

1869 
quickli¡EÁry
 
’Œy
;

1870 
i
 = 0;

1871 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1872 *
h
 = 
	`g’¡r
("h–lo", 
i
);

1873 ià(
	`¡rcmp
((*)
’Œy
.
v®ue
, 
h
))

1874 
	`ERR
("value [%s] didn't match [%s]‡t…osition %d",

1875 
’Œy
.
v®ue
, 
h
, 
i
);

1876 
i
++;

1878 ià(
i
 != 500)

1879 
	`ERR
("Didn'ˆ™”©ov”ƒxaùly 500ƒËm’t (%d)", 
i
);

1880 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

1881 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1882 
	`quickli¡R–—£
(
ql
);

1885 
	`TEST
("insert before with 0ƒlements") {

1886 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1887 
quickli¡EÁry
 
’Œy
;

1888 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1889 
	`quickli¡In£¹BefÜe
(
ql
, &
’Œy
, "abc", 4);

1890 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1891 
	`quickli¡R–—£
(
ql
);

1894 
	`TEST
("insert‡fter with 0ƒlements") {

1895 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1896 
quickli¡EÁry
 
’Œy
;

1897 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1898 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, "abc", 4);

1899 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

1900 
	`quickli¡R–—£
(
ql
);

1903 
	`TEST
("insert‡fter 1ƒlement") {

1904 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1905 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1906 
quickli¡EÁry
 
’Œy
;

1907 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1908 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, "abc", 4);

1909 
	`ql_v”ify
(
ql
, 1, 2, 2, 2);

1910 
	`quickli¡R–—£
(
ql
);

1913 
	`TEST
("insert before 1ƒlement") {

1914 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

1915 
	`quickli¡PushH—d
(
ql
, "hello", 6);

1916 
quickli¡EÁry
 
’Œy
;

1917 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1918 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, "abc", 4);

1919 
	`ql_v”ify
(
ql
, 1, 2, 2, 2);

1920 
	`quickli¡R–—£
(
ql
);

1923 
f
 = 
İtimize_¡¬t
; f < 12; f++) {

1924 
	`TEST_DESC
("insert once inƒlements while iterating‡t fill %d‡t "

1926 
f
, 
İtiÚs
[
_i
]) {

1927 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1928 
	`quickli¡PushTa
(
ql
, "abc", 3);

1929 
	`quickli¡S‘Fl
(
ql
, 1);

1930 
	`quickli¡PushTa
(
ql
, "def", 3);

1931 
	`quickli¡S‘Fl
(
ql
, 
f
);

1932 
	`quickli¡PushTa
(
ql
, "bob", 3);

1933 
	`quickli¡PushTa
(
ql
, "foo", 3);

1934 
	`quickli¡PushTa
(
ql
, "zoo", 3);

1936 
	`™½ršŒ
(
ql
, 0);

1938 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

1939 
quickli¡EÁry
 
’Œy
;

1940 
	`quickli¡Next
(
™”
, &
’Œy
)) {

1941 ià(!
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bob", 3)) {

1943 
	`quickli¡In£¹BefÜe
(
ql
, &
’Œy
, "bar", 3);

1947 
	`™½ršŒ
(
ql
, 0);

1950 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

1951 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "abc", 3))

1952 
	`ERR
("V®u0 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1953 
’Œy
.
v®ue
);

1954 
	`quickli¡Index
(
ql
, 1, &
’Œy
);

1955 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "def", 3))

1956 
	`ERR
("V®u1 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1957 
’Œy
.
v®ue
);

1958 
	`quickli¡Index
(
ql
, 2, &
’Œy
);

1959 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bar", 3))

1960 
	`ERR
("V®u2 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1961 
’Œy
.
v®ue
);

1962 
	`quickli¡Index
(
ql
, 3, &
’Œy
);

1963 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bob", 3))

1964 
	`ERR
("V®u3 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1965 
’Œy
.
v®ue
);

1966 
	`quickli¡Index
(
ql
, 4, &
’Œy
);

1967 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "foo", 3))

1968 
	`ERR
("V®u4 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1969 
’Œy
.
v®ue
);

1970 
	`quickli¡Index
(
ql
, 5, &
’Œy
);

1971 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "zoo", 3))

1972 
	`ERR
("V®u5 didn'ˆm©ch, in¡—d gÙ: %.*s", 
’Œy
.
sz
,

1973 
’Œy
.
v®ue
);

1974 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

1975 
	`quickli¡R–—£
(
ql
);

1979 
f
 = 
İtimize_¡¬t
; f < 1024; f++) {

1980 
	`TEST_DESC
(

1983 
f
, 
İtiÚs
[
_i
]) {

1984 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

1985 
i
 = 0; i < 500; i++)

1986 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

1987 
i
 = 0; i < 250; i++) {

1988 
quickli¡EÁry
 
’Œy
;

1989 
	`quickli¡Index
(
ql
, 250, &
’Œy
);

1990 
	`quickli¡In£¹BefÜe
(
ql
, &
’Œy
, 
	`g’¡r
("abc", 
i
), 32);

1992 ià(
f
 == 32)

1993 
	`ql_v”ify
(
ql
, 25, 750, 32, 20);

1994 
	`quickli¡R–—£
(
ql
);

1998 
f
 = 
İtimize_¡¬t
; f < 1024; f++) {

1999 
	`TEST_DESC
("insert [after] 250‚ew in middle of 500ƒlements‡t "

2001 
f
, 
İtiÚs
[
_i
]) {

2002 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2003 
i
 = 0; i < 500; i++)

2004 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2005 
i
 = 0; i < 250; i++) {

2006 
quickli¡EÁry
 
’Œy
;

2007 
	`quickli¡Index
(
ql
, 250, &
’Œy
);

2008 
	`quickli¡In£¹Aá”
(
ql
, &
’Œy
, 
	`g’¡r
("abc", 
i
), 32);

2011 ià(
ql
->
couÁ
 != 750)

2012 
	`ERR
("Li¡ siznÙ 750, buˆ¿th” %ld", 
ql
->
couÁ
);

2014 ià(
f
 == 32)

2015 
	`ql_v”ify
(
ql
, 26, 750, 20, 32);

2016 
	`quickli¡R–—£
(
ql
);

2020 
	`TEST
("duplicateƒmpty†ist") {

2021 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2022 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2023 
quickli¡
 *
cİy
 = 
	`quickli¡Dup
(
ql
);

2024 
	`ql_v”ify
(
cİy
, 0, 0, 0, 0);

2025 
	`quickli¡R–—£
(
ql
);

2026 
	`quickli¡R–—£
(
cİy
);

2029 
	`TEST
("duplicate†ist of 1ƒlement") {

2030 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2031 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("hello", 3), 32);

2032 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

2033 
quickli¡
 *
cİy
 = 
	`quickli¡Dup
(
ql
);

2034 
	`ql_v”ify
(
cİy
, 1, 1, 1, 1);

2035 
	`quickli¡R–—£
(
ql
);

2036 
	`quickli¡R–—£
(
cİy
);

2039 
	`TEST
("duplicate†ist of 500") {

2040 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2041 
	`quickli¡S‘Fl
(
ql
, 32);

2042 
i
 = 0; i < 500; i++)

2043 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2044 
	`ql_v”ify
(
ql
, 16, 500, 20, 32);

2046 
quickli¡
 *
cİy
 = 
	`quickli¡Dup
(
ql
);

2047 
	`ql_v”ify
(
cİy
, 16, 500, 20, 32);

2048 
	`quickli¡R–—£
(
ql
);

2049 
	`quickli¡R–—£
(
cİy
);

2052 
f
 = 
İtimize_¡¬t
; f < 512; f++) {

2053 
	`TEST_DESC
("šdex 1,200 from 500†i¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2054 
İtiÚs
[
_i
]) {

2055 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2056 
i
 = 0; i < 500; i++)

2057 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2058 
quickli¡EÁry
 
’Œy
;

2059 
	`quickli¡Index
(
ql
, 1, &
’Œy
);

2060 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello2"))

2061 
OK
;

2063 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2064 
	`quickli¡Index
(
ql
, 200, &
’Œy
);

2065 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello201"))

2066 
OK
;

2068 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2069 
	`quickli¡R–—£
(
ql
);

2072 
	`TEST_DESC
("šdex -1,-2 from 500†i¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2073 
İtiÚs
[
_i
]) {

2074 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2075 
i
 = 0; i < 500; i++)

2076 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2077 
quickli¡EÁry
 
’Œy
;

2078 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2079 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello500"))

2080 
OK
;

2082 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2083 
	`quickli¡Index
(
ql
, -2, &
’Œy
);

2084 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello499"))

2085 
OK
;

2087 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2088 
	`quickli¡R–—£
(
ql
);

2091 
	`TEST_DESC
("šdex -100 from 500†i¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2092 
İtiÚs
[
_i
]) {

2093 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2094 
i
 = 0; i < 500; i++)

2095 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2096 
quickli¡EÁry
 
’Œy
;

2097 
	`quickli¡Index
(
ql
, -100, &
’Œy
);

2098 ià(!
	`¡rcmp
((*)
’Œy
.
v®ue
, "hello401"))

2099 
OK
;

2101 
	`ERR
("V®ue: %s", 
’Œy
.
v®ue
);

2102 
	`quickli¡R–—£
(
ql
);

2105 
	`TEST_DESC
("indexoo big +1 from 50†ist‡t fill %d‡t compress %d",

2106 
f
, 
İtiÚs
[
_i
]) {

2107 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2108 
i
 = 0; i < 50; i++)

2109 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2110 
quickli¡EÁry
 
’Œy
;

2111 ià(
	`quickli¡Index
(
ql
, 50, &
’Œy
))

2112 
	`ERR
("Index found‡ˆ50 w™h 50†i¡: %.*s", 
’Œy
.
sz
,

2113 
’Œy
.
v®ue
);

2115 
OK
;

2116 
	`quickli¡R–—£
(
ql
);

2120 
	`TEST
("delete„angeƒmpty†ist") {

2121 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2122 
	`quickli¡D–Rªge
(
ql
, 5, 20);

2123 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2124 
	`quickli¡R–—£
(
ql
);

2127 
	`TEST
("delete„ange ofƒntire‚ode in†ist of one‚ode") {

2128 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2129 
i
 = 0; i < 32; i++)

2130 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2131 
	`ql_v”ify
(
ql
, 1, 32, 32, 32);

2132 
	`quickli¡D–Rªge
(
ql
, 0, 32);

2133 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2134 
	`quickli¡R–—£
(
ql
);

2137 
	`TEST
("delete„ange ofƒntire‚ode with overflow counts") {

2138 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2139 
i
 = 0; i < 32; i++)

2140 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lo", 
i
), 32);

2141 
	`ql_v”ify
(
ql
, 1, 32, 32, 32);

2142 
	`quickli¡D–Rªge
(
ql
, 0, 128);

2143 
	`ql_v”ify
(
ql
, 0, 0, 0, 0);

2144 
	`quickli¡R–—£
(
ql
);

2147 
	`TEST
("delete middle 100 of 500†ist") {

2148 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2149 
	`quickli¡S‘Fl
(
ql
, 32);

2150 
i
 = 0; i < 500; i++)

2151 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2152 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

2153 
	`quickli¡D–Rªge
(
ql
, 200, 100);

2154 
	`ql_v”ify
(
ql
, 14, 400, 32, 20);

2155 
	`quickli¡R–—£
(
ql
);

2158 
	`TEST
("delete‚egative 1 from 500†ist") {

2159 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2160 
	`quickli¡S‘Fl
(
ql
, 32);

2161 
i
 = 0; i < 500; i++)

2162 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2163 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

2164 
	`quickli¡D–Rªge
(
ql
, -1, 1);

2165 
	`ql_v”ify
(
ql
, 16, 499, 32, 19);

2166 
	`quickli¡R–—£
(
ql
);

2169 
	`TEST
("delete‚egative 1 from 500†ist with overflow counts") {

2170 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2171 
	`quickli¡S‘Fl
(
ql
, 32);

2172 
i
 = 0; i < 500; i++)

2173 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2174 
	`ql_v”ify
(
ql
, 16, 500, 32, 20);

2175 
	`quickli¡D–Rªge
(
ql
, -1, 128);

2176 
	`ql_v”ify
(
ql
, 16, 499, 32, 19);

2177 
	`quickli¡R–—£
(
ql
);

2180 
	`TEST
("delete‚egative 100 from 500†ist") {

2181 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2182 
	`quickli¡S‘Fl
(
ql
, 32);

2183 
i
 = 0; i < 500; i++)

2184 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2185 
	`quickli¡D–Rªge
(
ql
, -100, 100);

2186 
	`ql_v”ify
(
ql
, 13, 400, 32, 16);

2187 
	`quickli¡R–—£
(
ql
);

2190 
	`TEST
("delete -10 count 5 from 50†ist") {

2191 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2192 
	`quickli¡S‘Fl
(
ql
, 32);

2193 
i
 = 0; i < 50; i++)

2194 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lo", 
i
 + 1), 32);

2195 
	`ql_v”ify
(
ql
, 2, 50, 32, 18);

2196 
	`quickli¡D–Rªge
(
ql
, -10, 5);

2197 
	`ql_v”ify
(
ql
, 2, 45, 32, 13);

2198 
	`quickli¡R–—£
(
ql
);

2201 
	`TEST
("numbers only†ist„ead") {

2202 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2203 
	`quickli¡PushTa
(
ql
, "1111", 4);

2204 
	`quickli¡PushTa
(
ql
, "2222", 4);

2205 
	`quickli¡PushTa
(
ql
, "3333", 4);

2206 
	`quickli¡PushTa
(
ql
, "4444", 4);

2207 
	`ql_v”ify
(
ql
, 1, 4, 4, 4);

2208 
quickli¡EÁry
 
’Œy
;

2209 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

2210 ià(
’Œy
.
lÚgv®
 != 1111)

2211 
	`ERR
("NÙ 1111, %Îd", 
’Œy
.
lÚgv®
);

2212 
	`quickli¡Index
(
ql
, 1, &
’Œy
);

2213 ià(
’Œy
.
lÚgv®
 != 2222)

2214 
	`ERR
("NÙ 2222, %Îd", 
’Œy
.
lÚgv®
);

2215 
	`quickli¡Index
(
ql
, 2, &
’Œy
);

2216 ià(
’Œy
.
lÚgv®
 != 3333)

2217 
	`ERR
("NÙ 3333, %Îd", 
’Œy
.
lÚgv®
);

2218 
	`quickli¡Index
(
ql
, 3, &
’Œy
);

2219 ià(
’Œy
.
lÚgv®
 != 4444)

2220 
	`ERR
("NÙ 4444, %Îd", 
’Œy
.
lÚgv®
);

2221 ià(
	`quickli¡Index
(
ql
, 4, &
’Œy
))

2222 
	`ERR
("Index…a¡ƒËm’ts: %Îd", 
’Œy
.
lÚgv®
);

2223 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2224 ià(
’Œy
.
lÚgv®
 != 4444)

2225 
	`ERR
("NÙ 4444 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2226 
	`quickli¡Index
(
ql
, -2, &
’Œy
);

2227 ià(
’Œy
.
lÚgv®
 != 3333)

2228 
	`ERR
("NÙ 3333 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2229 
	`quickli¡Index
(
ql
, -3, &
’Œy
);

2230 ià(
’Œy
.
lÚgv®
 != 2222)

2231 
	`ERR
("NÙ 2222 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2232 
	`quickli¡Index
(
ql
, -4, &
’Œy
);

2233 ià(
’Œy
.
lÚgv®
 != 1111)

2234 
	`ERR
("NÙ 1111 (»v”£), %Îd", 
’Œy
.
lÚgv®
);

2235 ià(
	`quickli¡Index
(
ql
, -5, &
’Œy
))

2236 
	`ERR
("Index…a¡ƒËm’t Ôev”£), %Îd", 
’Œy
.
lÚgv®
);

2237 
	`quickli¡R–—£
(
ql
);

2240 
	`TEST
("numbers†arger†ist„ead") {

2241 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2242 
	`quickli¡S‘Fl
(
ql
, 32);

2243 
num
[32];

2244 
nums
[5000];

2245 
i
 = 0; i < 5000; i++) {

2246 
nums
[
i
] = -5157318210846258176 + i;

2247 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2248 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2250 
	`quickli¡PushTa
(
ql
, "xxxxxxxxxxxxxxxxxxxx", 20);

2251 
quickli¡EÁry
 
’Œy
;

2252 
i
 = 0; i < 5000; i++) {

2253 
	`quickli¡Index
(
ql
, 
i
, &
’Œy
);

2254 ià(
’Œy
.
lÚgv®
 !ğ
nums
[
i
])

2255 
	`ERR
("[%d] NÙ†Úgv® %Îd buˆ¿th” %Îd", 
i
, 
nums
[i],

2256 
’Œy
.
lÚgv®
);

2257 
’Œy
.
lÚgv®
 = 0xdeadbeef;

2259 
	`quickli¡Index
(
ql
, 5000, &
’Œy
);

2260 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "xxxxxxxxxxxxxxxxxxxx", 20))

2261 
	`ERR
("SŒšg v®‚Ù m©ch: %s", 
’Œy
.
v®ue
);

2262 
	`ql_v”ify
(
ql
, 157, 5001, 32, 9);

2263 
	`quickli¡R–—£
(
ql
);

2266 
	`TEST
("numbers†arger†ist„ead B") {

2267 
quickli¡
 *
ql
 = 
	`quickli¡New
(-2, 
İtiÚs
[
_i
]);

2268 
	`quickli¡PushTa
(
ql
, "99", 2);

2269 
	`quickli¡PushTa
(
ql
, "98", 2);

2270 
	`quickli¡PushTa
(
ql
, "xxxxxxxxxxxxxxxxxxxx", 20);

2271 
	`quickli¡PushTa
(
ql
, "96", 2);

2272 
	`quickli¡PushTa
(
ql
, "95", 2);

2273 
	`quickli¡R•ÏûAtIndex
(
ql
, 1, "foo", 3);

2274 
	`quickli¡R•ÏûAtIndex
(
ql
, -1, "bar", 3);

2275 
	`quickli¡R–—£
(
ql
);

2276 
OK
;

2279 
f
 = 
İtimize_¡¬t
; f < 16; f++) {

2280 
	`TEST_DESC
("Ìeme¡‡ˆfÈ%d‡ˆcom´es %d", 
f
, 
İtiÚs
[
_i
]) {

2281 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2282 *
wÜds
[] = {"abc", "foo", "bar", "foobar", "foobared",

2284 *
»suÉ
[] = {"abc", "foo", "foobar", "foobared",

2286 *
»suÉB
[] = {"abc", "foo", "foobar",

2288 
i
 = 0; i < 9; i++)

2289 
	`quickli¡PushTa
(
ql
, 
wÜds
[
i
], 
	`¡¾’
(words[i]));

2292 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

2293 
quickli¡EÁry
 
’Œy
;

2294 
i
 = 0;

2295 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2296 ià(
	`quickli¡Com·»
(
’Œy
.
zi
, (*)"bar", 3)) {

2297 
	`quickli¡D–EÁry
(
™”
, &
’Œy
);

2299 
i
++;

2301 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2304 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

2305 
i
 = 0;

2306 
ok
 = 1;

2307 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2310 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, 
»suÉ
[
i
],ƒÁry.
sz
)) {

2311 
	`ERR
("No match‡t…osition %d, got %.*s instead of %s",

2312 
i
, 
’Œy
.
sz
,ƒÁry.
v®ue
, 
»suÉ
[i]);

2313 
ok
 = 0;

2315 
i
++;

2317 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2319 
	`quickli¡PushTa
(
ql
, "foo", 3);

2322 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

2323 
i
 = 0;

2324 
d–
 = 2;

2325 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2326 ià(
	`quickli¡Com·»
(
’Œy
.
zi
, (*)"foo", 3)) {

2327 
	`quickli¡D–EÁry
(
™”
, &
’Œy
);

2328 
d–
--;

2330 ià(!
d–
)

2332 
i
++;

2334 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2340 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

2341 
i
 = 0;

2342 
size_t
 
»sB
 = (
»suÉB
) / (*resultB);

2343 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2346 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, 
»suÉB
[
»sB
 - 1 - 
i
],

2347 
’Œy
.
sz
)) {

2348 
	`ERR
("No match‡t…osition %d, got %.*s instead of %s",

2349 
i
, 
’Œy
.
sz
,ƒÁry.
v®ue
, 
»suÉB
[
»sB
 - 1 - i]);

2350 
ok
 = 0;

2352 
i
++;

2355 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2357 ià(
ok
)

2358 
OK
;

2359 
	`quickli¡R–—£
(
ql
);

2363 
f
 = 
İtimize_¡¬t
; f < 16; f++) {

2364 
	`TEST_DESC
("™”©»v”£ + d–‘© fÈ%d‡ˆcom´es %d", 
f
,

2365 
İtiÚs
[
_i
]) {

2366 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2367 
	`quickli¡PushTa
(
ql
, "abc", 3);

2368 
	`quickli¡PushTa
(
ql
, "def", 3);

2369 
	`quickli¡PushTa
(
ql
, "hij", 3);

2370 
	`quickli¡PushTa
(
ql
, "jkl", 3);

2371 
	`quickli¡PushTa
(
ql
, "oop", 3);

2373 
quickli¡EÁry
 
’Œy
;

2374 
quickli¡I‹r
 *
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_TAIL
);

2375 
i
 = 0;

2376 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2377 ià(
	`quickli¡Com·»
(
’Œy
.
zi
, (*)"hij", 3)) {

2378 
	`quickli¡D–EÁry
(
™”
, &
’Œy
);

2380 
i
++;

2382 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2384 ià(
i
 != 5)

2385 
	`ERR
("Didn'ˆ™”©5imes, i‹¿‹d %dimes.", 
i
);

2388 
™”
 = 
	`quickli¡G‘I‹¿tÜ
(
ql
, 
AL_START_HEAD
);

2389 
i
 = 0;

2390 *
v®s
[] = {"abc", "def", "jkl", "oop"};

2391 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2392 ià(!
	`quickli¡Com·»
(
’Œy
.
zi
, (*)
v®s
[
i
],

2394 
	`ERR
("V®u© %d didn'ˆm©ch %s\n", 
i
, 
v®s
[i]);

2396 
i
++;

2398 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2399 
	`quickli¡R–—£
(
ql
);

2403 
f
 = 
İtimize_¡¬t
; f < 800; f++) {

2404 
	`TEST_DESC
("™”©Ü‡ˆšdexe¡‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2405 
İtiÚs
[
_i
]) {

2406 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2407 
num
[32];

2408 
nums
[5000];

2409 
i
 = 0; i < 760; i++) {

2410 
nums
[
i
] = -5157318210846258176 + i;

2411 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2412 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2415 
quickli¡EÁry
 
’Œy
;

2416 
quickli¡I‹r
 *
™”
 =

2417 
	`quickli¡G‘I‹¿tÜAtIdx
(
ql
, 
AL_START_HEAD
, 437);

2418 
i
 = 437;

2419 
	`quickli¡Next
(
™”
, &
’Œy
)) {

2420 ià(
’Œy
.
lÚgv®
 !ğ
nums
[
i
])

2421 
	`ERR
("Ex³ùed %Îd, buˆgÙ %Îd", 
’Œy
.
lÚgv®
,

2422 
nums
[
i
]);

2423 
i
++;

2425 
	`quickli¡R–—£I‹¿tÜ
(
™”
);

2426 
	`quickli¡R–—£
(
ql
);

2430 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2431 
	`TEST_DESC
("Érime¡ A‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2432 
İtiÚs
[
_i
]) {

2433 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2434 
num
[32];

2435 
nums
[5000];

2436 
i
 = 0; i < 32; i++) {

2437 
nums
[
i
] = -5157318210846258176 + i;

2438 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2439 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2441 ià(
f
 == 32)

2442 
	`ql_v”ify
(
ql
, 1, 32, 32, 32);

2444 
	`quickli¡D–Rªge
(
ql
, 0, 25);

2445 
	`quickli¡D–Rªge
(
ql
, 0, 0);

2446 
quickli¡EÁry
 
’Œy
;

2447 
i
 = 0; i < 7; i++) {

2448 
	`quickli¡Index
(
ql
, 
i
, &
’Œy
);

2449 ià(
’Œy
.
lÚgv®
 !ğ
nums
[25 + 
i
])

2450 
	`ERR
("Deleted invalid„ange! Expected %lld but got "

2452 
’Œy
.
lÚgv®
, 
nums
[25 + 
i
]);

2454 ià(
f
 == 32)

2455 
	`ql_v”ify
(
ql
, 1, 7, 7, 7);

2456 
	`quickli¡R–—£
(
ql
);

2460 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2461 
	`TEST_DESC
("Érime¡ B‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2462 
İtiÚs
[
_i
]) {

2465 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
QUICKLIST_NOCOMPRESS
);

2466 
num
[32];

2467 
nums
[5000];

2468 
i
 = 0; i < 33; i++) {

2469 
nums
[
i
] = i;

2470 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2471 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2473 ià(
f
 == 32)

2474 
	`ql_v”ify
(
ql
, 2, 33, 32, 1);

2476 
	`quickli¡D–Rªge
(
ql
, 0, 5);

2477 
	`quickli¡D–Rªge
(
ql
, -16, 16);

2478 ià(
f
 == 32)

2479 
	`ql_v”ify
(
ql
, 1, 12, 12, 12);

2480 
quickli¡EÁry
 
’Œy
;

2481 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

2482 ià(
’Œy
.
lÚgv®
 != 5)

2483 
	`ERR
("A:†Úgv®‚Ù 5, buˆ%Îd", 
’Œy
.
lÚgv®
);

2485 
OK
;

2486 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2487 ià(
’Œy
.
lÚgv®
 != 16)

2488 
	`ERR
("B! gÙ in¡—d: %Îd", 
’Œy
.
lÚgv®
);

2490 
OK
;

2491 
	`quickli¡PushTa
(
ql
, "bobobob", 7);

2492 
	`quickli¡Index
(
ql
, -1, &
’Œy
);

2493 ià(
	`¡ºcmp
((*)
’Œy
.
v®ue
, "bobobob", 7))

2494 
	`ERR
("Tail doesn't match bobobob, it's %.*s instead",

2495 
’Œy
.
sz
,ƒÁry.
v®ue
);

2496 
i
 = 0; i < 12; i++) {

2497 
	`quickli¡Index
(
ql
, 
i
, &
’Œy
);

2498 ià(
’Œy
.
lÚgv®
 !ğ
nums
[5 + 
i
])

2499 
	`ERR
("Deleted invalid„ange! Expected %lld but got "

2501 
’Œy
.
lÚgv®
, 
nums
[5 + 
i
]);

2503 
	`quickli¡R–—£
(
ql
);

2507 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2508 
	`TEST_DESC
("Érime¡ C‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2509 
İtiÚs
[
_i
]) {

2510 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2511 
num
[32];

2512 
nums
[5000];

2513 
i
 = 0; i < 33; i++) {

2514 
nums
[
i
] = -5157318210846258176 + i;

2515 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2516 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2518 ià(
f
 == 32)

2519 
	`ql_v”ify
(
ql
, 2, 33, 32, 1);

2521 
	`quickli¡D–Rªge
(
ql
, 0, 3);

2522 
	`quickli¡D–Rªge
(
ql
, -29,

2524 ià(
f
 == 32)

2525 
	`ql_v”ify
(
ql
, 1, 1, 1, 1);

2526 
quickli¡EÁry
 
’Œy
;

2527 
	`quickli¡Index
(
ql
, 0, &
’Œy
);

2528 ià(
’Œy
.
lÚgv®
 != -5157318210846258173)

2529 
ERROR
;

2531 
OK
;

2532 
	`quickli¡R–—£
(
ql
);

2536 
f
 = 
İtimize_¡¬t
; f < 40; f++) {

2537 
	`TEST_DESC
("Érime¡ D‡ˆfÈ%d‡ˆcom´es %d", 
f
,

2538 
İtiÚs
[
_i
]) {

2539 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
İtiÚs
[
_i
]);

2540 
num
[32];

2541 
nums
[5000];

2542 
i
 = 0; i < 33; i++) {

2543 
nums
[
i
] = -5157318210846258176 + i;

2544 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2545 
	`quickli¡PushTa
(
ql
, 
num
, 
sz
);

2547 ià(
f
 == 32)

2548 
	`ql_v”ify
(
ql
, 2, 33, 32, 1);

2549 
	`quickli¡D–Rªge
(
ql
, -12, 3);

2550 ià(
ql
->
couÁ
 != 30)

2551 
	`ERR
("Didn't deleteƒxactlyhreeƒlements! Count is: %lu",

2552 
ql
->
couÁ
);

2553 
	`quickli¡R–—£
(
ql
);

2557 
f
 = 
İtimize_¡¬t
; f < 72; f++) {

2558 
	`TEST_DESC
("create quicklist from ziplist‡t fill %d‡t compress %d",

2559 
f
, 
İtiÚs
[
_i
]) {

2560 *
zl
 = 
	`zli¡New
();

2561 
nums
[64];

2562 
num
[64];

2563 
i
 = 0; i < 33; i++) {

2564 
nums
[
i
] = -5157318210846258176 + i;

2565 
sz
 = 
	`Î2¡ršg
(
num
, Òum), 
nums
[
i
]);

2566 
zl
 =

2567 
	`zli¡Push
(
zl
, (*)
num
, 
sz
, 
ZIPLIST_TAIL
);

2569 
i
 = 0; i < 33; i++) {

2570 
zl
 = 
	`zli¡Push
(zl, (*)
	`g’¡r
("h–lo", 
i
),

2571 32, 
ZIPLIST_TAIL
);

2573 
quickli¡
 *
ql
 = 
	`quickli¡C»©eFromZli¡
(
f
, 
İtiÚs
[
_i
], 
zl
);

2574 ià(
f
 == 1)

2575 
	`ql_v”ify
(
ql
, 66, 66, 1, 1);

2576 ià(
f
 == 32)

2577 
	`ql_v”ify
(
ql
, 3, 66, 32, 2);

2578 ià(
f
 == 66)

2579 
	`ql_v”ify
(
ql
, 1, 66, 66, 66);

2580 
	`quickli¡R–—£
(
ql
);

2584 
¡İ
 = 
	`m¡ime
();

2585 
ruÁime
[
_i
] = 
¡İ
 - 
¡¬t
;

2589 
li¡_sizes
[] = {250, 251, 500, 999, 1000};

2590 
¡¬t
 = 
	`m¡ime
();

2591 
li¡
 = 0;†i¡ < ()((
li¡_sizes
) / (*list_sizes));

2592 
li¡
++) {

2593 
f
 = 
İtimize_¡¬t
; f < 128; f++) {

2594 
d•th
 = 1; depth < 40; depth++) {

2596 
	`TEST_DESC
("verify specific compression of interior‚odes with "

2599 
li¡_sizes
[
li¡
], 
f
, 
d•th
) {

2600 
quickli¡
 *
ql
 = 
	`quickli¡New
(
f
, 
d•th
);

2601 
i
 = 0; i < 
li¡_sizes
[
li¡
]; i++) {

2602 
	`quickli¡PushTa
(
ql
, 
	`g’¡r
("h–lØTAIL", 
i
 + 1), 64);

2603 
	`quickli¡PushH—d
(
ql
, 
	`g’¡r
("h–lØHEAD", 
i
 + 1), 64);

2606 
quickli¡Node
 *
node
 = 
ql
->
h—d
;

2607 
low_¿w
 = 
ql
->
com´ess
;

2608 
high_¿w
 = 
ql
->
Ën
 - ql->
com´ess
;

2610 
©
 = 0;‡ˆ< 
ql
->
Ën
;

2611 
©
++, 
node
 =‚ode->
Ãxt
) {

2612 ià(
©
 < 
low_¿w
 ||‡ˆ>ğ
high_¿w
) {

2613 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_RAW
) {

2614 
	`ERR
("Incorrect compression:‚ode %d is "

2617 
©
, 
d•th
, 
low_¿w
, 
high_¿w
, 
ql
->
Ën
,

2618 
node
->
sz
);

2621 ià(
node
->
’codšg
 !ğ
QUICKLIST_NODE_ENCODING_LZF
) {

2622 
	`ERR
("Incorrect‚on-compression:‚ode %d is NOT "

2625 
©
, 
d•th
, 
low_¿w
, 
high_¿w
, 
ql
->
Ën
,

2626 
node
->
sz
,‚ode->
©‹m±ed_com´ess
);

2630 
	`quickli¡R–—£
(
ql
);

2635 
¡İ
 = 
	`m¡ime
();

2637 
	`´štf
("\n");

2638 
size_t
 
i
 = 0; i < 
İtiÚ_couÁ
; i++)

2639 
	`´štf
("Te¡ Loİ %02d: %0.2à£cÚds.\n", 
İtiÚs
[
i
],

2640 ()
ruÁime
[
i
] / 1000);

2641 
	`´štf
("Com´essiÚs: %0.2à£cÚds.\n", ()(
¡İ
 - 
¡¬t
) / 1000);

2642 
	`´štf
("\n");

2644 ià(!
”r
)

2645 
	`´štf
("ALL TESTS PASSED!\n");

2647 
	`ERR
("SÜry,‚Ù‡Îe¡ ·s£d! IÀçù, %de¡ çed.", 
”r
);

2649  
”r
;

2650 
	}
}

	@src/quicklist.h

31 #iâdeà
__QUICKLIST_H__


32 
	#__QUICKLIST_H__


	)

44 
	squickli¡Node
 {

45 
quickli¡Node
 *
	m´ev
;

46 
quickli¡Node
 *
	mÃxt
;

47 *
	mzl
;

48 
	msz
;

49 
	mcouÁ
 : 16;

50 
	m’codšg
 : 2;

51 
	mcÚš”
 : 2;

52 
	m»com´ess
 : 1;

53 
	m©‹m±ed_com´ess
 : 1;

54 
	mexŒa
 : 10;

55 } 
	tquickli¡Node
;

62 
	squickli¡LZF
 {

63 
	msz
;

64 
	mcom´es£d
[];

65 } 
	tquickli¡LZF
;

73 
	squickli¡
 {

74 
quickli¡Node
 *
	mh—d
;

75 
quickli¡Node
 *
	m
;

76 
	mcouÁ
;

77 
	mËn
;

78 
	mfl
 : 16;

79 
	mcom´ess
 : 16;

80 } 
	tquickli¡
;

82 
	squickli¡I‹r
 {

83 cÚ¡ 
quickli¡
 *
	mquickli¡
;

84 
quickli¡Node
 *
	mcu¼’t
;

85 *
	mzi
;

86 
	moff£t
;

87 
	mdœeùiÚ
;

88 } 
	tquickli¡I‹r
;

90 
	squickli¡EÁry
 {

91 cÚ¡ 
quickli¡
 *
	mquickli¡
;

92 
quickli¡Node
 *
	mnode
;

93 *
	mzi
;

94 *
	mv®ue
;

95 
	mlÚgv®
;

96 
	msz
;

97 
	moff£t
;

98 } 
	tquickli¡EÁry
;

100 
	#QUICKLIST_HEAD
 0

	)

101 
	#QUICKLIST_TAIL
 -1

	)

104 
	#QUICKLIST_NODE_ENCODING_RAW
 1

	)

105 
	#QUICKLIST_NODE_ENCODING_LZF
 2

	)

108 
	#QUICKLIST_NOCOMPRESS
 0

	)

111 
	#QUICKLIST_NODE_CONTAINER_NONE
 1

	)

112 
	#QUICKLIST_NODE_CONTAINER_ZIPLIST
 2

	)

114 
	#quickli¡NodeIsCom´es£d
(
node
) \

115 ((
node
)->
’codšg
 =ğ
QUICKLIST_NODE_ENCODING_LZF
)

	)

118 
quickli¡
 *
quickli¡C»©e
();

119 
quickli¡
 *
quickli¡New
(
fl
, 
com´ess
);

120 
quickli¡S‘Com´essD•th
(
quickli¡
 *quickli¡, 
d•th
);

121 
quickli¡S‘Fl
(
quickli¡
 *quickli¡, 
fl
);

122 
quickli¡S‘O±iÚs
(
quickli¡
 *quickli¡, 
fl
, 
d•th
);

123 
quickli¡R–—£
(
quickli¡
 *quicklist);

124 
quickli¡PushH—d
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

125 
quickli¡PushTa
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
);

126 
quickli¡Push
(
quickli¡
 *quickli¡, *
v®ue
, cÚ¡ 
size_t
 
sz
,

127 
wh”e
);

128 
quickli¡Aµ’dZli¡
(
quickli¡
 *quickli¡, *
zl
);

129 
quickli¡
 *
quickli¡Aµ’dV®uesFromZli¡
(quicklist *quicklist,

130 *
zl
);

131 
quickli¡
 *
quickli¡C»©eFromZli¡
(
fl
, 
com´ess
,

132 *
zl
);

133 
quickli¡In£¹Aá”
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

134 *
v®ue
, cÚ¡ 
size_t
 
sz
);

135 
quickli¡In£¹BefÜe
(
quickli¡
 *quickli¡, 
quickli¡EÁry
 *
node
,

136 *
v®ue
, cÚ¡ 
size_t
 
sz
);

137 
quickli¡D–EÁry
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
’Œy
);

138 
quickli¡R•ÏûAtIndex
(
quickli¡
 *quickli¡, 
šdex
, *
d©a
,

139 
sz
);

140 
quickli¡D–Rªge
(
quickli¡
 *quickli¡, cÚ¡ 
¡¬t
, cÚ¡ 
¡İ
);

141 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜ
(cÚ¡ 
quickli¡
 *quickli¡, 
dœeùiÚ
);

142 
quickli¡I‹r
 *
quickli¡G‘I‹¿tÜAtIdx
(cÚ¡ 
quickli¡
 *quicklist,

143 
dœeùiÚ
, cÚ¡ 
idx
);

144 
quickli¡Next
(
quickli¡I‹r
 *
™”
, 
quickli¡EÁry
 *
node
);

145 
quickli¡R–—£I‹¿tÜ
(
quickli¡I‹r
 *
™”
);

146 
quickli¡
 *
quickli¡Dup
(quickli¡ *
Üig
);

147 
quickli¡Index
(cÚ¡ 
quickli¡
 *quickli¡, cÚ¡ 
šdex
,

148 
quickli¡EÁry
 *
’Œy
);

149 
quickli¡Rewšd
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

150 
quickli¡RewšdTa
(
quickli¡
 *quickli¡, 
quickli¡I‹r
 *
li
);

151 
quickli¡RÙ©e
(
quickli¡
 *quicklist);

152 
quickli¡PİCu¡om
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

153 *
sz
, *
sv®
,

154 *(*
§v”
)(*
d©a
, 
sz
));

155 
quickli¡Pİ
(
quickli¡
 *quickli¡, 
wh”e
, **
d©a
,

156 *
sz
, *
¦Úg
);

157 
quickli¡CouÁ
(cÚ¡ 
quickli¡
 *
ql
);

158 
quickli¡Com·»
(*
p1
, *
p2
, 
p2_Ën
);

159 
size_t
 
quickli¡G‘Lzf
(cÚ¡ 
quickli¡Node
 *
node
, **
d©a
);

161 #ifdeà
REDIS_TEST


162 
quickli¡Te¡
(
¬gc
, *
¬gv
[]);

166 
	#AL_START_HEAD
 0

	)

167 
	#AL_START_TAIL
 1

	)

	@src/rand.c

44 
	~<¡dšt.h
>

46 
	#N
 16

	)

47 
	#MASK
 ((1 << (
N
 - 1)è+ (1 << (N - 1)è- 1)

	)

48 
	#LOW
(
x
è(()(xè& 
MASK
)

	)

49 
	#HIGH
(
x
è
	`LOW
((xè>> 
N
)

	)

50 
	#MUL
(
x
, 
y
, 
z
è{ 
št32_t
 
l
 = ()(x) * ()(y); \

51 (
z
)[0] = 
	`LOW
(
l
); (z)[1] = 
	`HIGH
Ö); }

	)

52 
	#CARRY
(
x
, 
y
è((
št32_t
)(xè+ ()(yè> 
MASK
)

	)

53 
	#ADDEQU
(
x
, 
y
, 
z
è(z = 
	`CARRY
(x, (y)), x = 
	`LOW
(x + (y)))

	)

54 
	#X0
 0x330E

	)

55 
	#X1
 0xABCD

	)

56 
	#X2
 0x1234

	)

57 
	#A0
 0xE66D

	)

58 
	#A1
 0xDEEC

	)

59 
	#A2
 0x5

	)

60 
	#C
 0xB

	)

61 
	#SET3
(
x
, 
x0
, 
x1
, 
x2
è((x)[0] = (x0), (x)[1] = (x1), (x)[2] = (x2))

	)

62 
	#SETLOW
(
x
, 
y
, 
n
è
	`SET3
(x, 
	`LOW
((y)[n]), LOW((y)[Ò)+1]), LOW((y)[Ò)+2]))

	)

63 
	#SEED
(
x0
, 
x1
, 
x2
è(
	`SET3
(
x
, x0, x1, x2), SET3(
a
, 
A0
, 
A1
, 
A2
), 
c
 = 
C
)

	)

64 
	#REST
(
v
è
i
 = 0; i < 3; i++è{ 
xsubi
[i] = 
x
[i]; x[i] = 
‹mp
[i]; } \

65  (
v
);

	)

66 
	#HI_BIT
 (1L << (2 * 
N
 - 1))

	)

68 
ušt32_t
 
	gx
[3] = { 
X0
, 
X1
, 
X2
 }, 
	ga
[3] = { 
A0
, 
A1
, 
A2
 }, 
	gc
 = 
C
;

69 
Ãxt
();

71 
št32_t
 
	$»disL¿nd48
() {

72 
	`Ãxt
();

73  (((
št32_t
)
x
[2] << (
N
 - 1)) + (x[1] >> 1));

74 
	}
}

76 
	$»disS¿nd48
(
št32_t
 
£edv®
) {

77 
	`SEED
(
X0
, 
	`LOW
(
£edv®
), 
	`HIGH
(seedval));

78 
	}
}

80 
	$Ãxt
() {

81 
ušt32_t
 
p
[2], 
q
[2], 
r
[2], 
ÿ¼y0
, 
ÿ¼y1
;

83 
	`MUL
(
a
[0], 
x
[0], 
p
);

84 
	`ADDEQU
(
p
[0], 
c
, 
ÿ¼y0
);

85 
	`ADDEQU
(
p
[1], 
ÿ¼y0
, 
ÿ¼y1
);

86 
	`MUL
(
a
[0], 
x
[1], 
q
);

87 
	`ADDEQU
(
p
[1], 
q
[0], 
ÿ¼y0
);

88 
	`MUL
(
a
[1], 
x
[0], 
r
);

89 
x
[2] = 
	`LOW
(
ÿ¼y0
 + 
ÿ¼y1
 + 
	`CARRY
(
p
[1], 
r
[0]è+ 
q
[1] +„[1] +

90 
a
[0] * 
x
[2] +‡[1] * x[1] +‡[2] * x[0]);

91 
x
[1] = 
	`LOW
(
p
[1] + 
r
[0]);

92 
x
[0] = 
	`LOW
(
p
[0]);

93 
	}
}

	@src/rand.h

30 #iâdeà
REDIS_RANDOM_H


31 
	#REDIS_RANDOM_H


	)

33 
št32_t
 
»disL¿nd48
();

34 
»disS¿nd48
(
št32_t
 
£edv®
);

36 
	#REDIS_LRAND48_MAX
 
INT32_MAX


	)

	@src/rax.c

31 
	~<¡dlib.h
>

32 
	~<¡ršg.h
>

33 
	~<as£¹.h
>

34 
	~<¡dio.h
>

35 
	~<”ºo.h
>

36 
	~<m©h.h
>

37 
	~"¿x.h
"

39 #iâdeà
RAX_MALLOC_INCLUDE


40 
	#RAX_MALLOC_INCLUDE
 "¿x_m®loc.h"

	)

43 #šşud
RAX_MALLOC_INCLUDE


48 *
	g¿xNÙFound
 = (*)"rax-not-found-pointer";

52 
¿xDebugShowNode
(cÚ¡ *
msg
, 
¿xNode
 *
n
);

56 
	#debugf
(...) \

58 
	`´štf
("%s:%s:%d:\t", 
__FILE__
, 
__FUNCTION__
, 
__LINE__
); \

59 
	`´štf
(
__VA_ARGS__
); \

60 
	`fæush
(
¡dout
); \

61 } 0);

	)

63 
	#debugnode
(
msg
,
n
è
	`¿xDebugShowNode
(msg,n)

	)

65 
	#debugf
(...)

	)

66 
	#debugnode
(
msg
,
n
)

	)

78 
šlše
 
	$¿xSckIn™
(
¿xSck
 *
ts
) {

79 
ts
->
¡ack
 =s->
¡©ic_™ems
;

80 
ts
->
™ems
 = 0;

81 
ts
->
max™ems
 = 
RAX_STACK_STATIC_ITEMS
;

82 
ts
->
oom
 = 0;

83 
	}
}

86 
šlše
 
	$¿xSckPush
(
¿xSck
 *
ts
, *
±r
) {

87 ià(
ts
->
™ems
 =ğts->
max™ems
) {

88 ià(
ts
->
¡ack
 =ğts->
¡©ic_™ems
) {

89 
ts
->
¡ack
 = 
	`¿x_m®loc
((*)*ts->
max™ems
*2);

90 ià(
ts
->
¡ack
 =ğ
NULL
) {

91 
ts
->
¡ack
 =s->
¡©ic_™ems
;

92 
ts
->
oom
 = 1;

93 
”ºo
 = 
ENOMEM
;

96 
	`memıy
(
ts
->
¡ack
,ts->
¡©ic_™ems
,(*)*ts->
max™ems
);

98 **
Ãw®loc
 = 
	`¿x_»®loc
(
ts
->
¡ack
,(*)*ts->
max™ems
*2);

99 ià(
Ãw®loc
 =ğ
NULL
) {

100 
ts
->
oom
 = 1;

101 
”ºo
 = 
ENOMEM
;

104 
ts
->
¡ack
 = 
Ãw®loc
;

106 
ts
->
max™ems
 *= 2;

108 
ts
->
¡ack
[ts->
™ems
] = 
±r
;

109 
ts
->
™ems
++;

111 
	}
}

115 
šlše
 *
	$¿xSckPİ
(
¿xSck
 *
ts
) {

116 ià(
ts
->
™ems
 =ğ0è 
NULL
;

117 
ts
->
™ems
--;

118  
ts
->
¡ack
[ts->
™ems
];

119 
	}
}

123 
šlše
 *
	$¿xSckP“k
(
¿xSck
 *
ts
) {

124 ià(
ts
->
™ems
 =ğ0è 
NULL
;

125  
ts
->
¡ack
[ts->
™ems
-1];

126 
	}
}

129 
šlše
 
	$¿xSckF»e
(
¿xSck
 *
ts
) {

130 ià(
ts
->
¡ack
 !ğts->
¡©ic_™ems
è
	`¿x_ä“
(ts->stack);

131 
	}
}

141 
¿xNode
 *
	$¿xNewNode
(
size_t
 
chd»n
, 
d©af›ld
) {

142 
size_t
 
nodesize
 = (
¿xNode
)+
chd»n
+

143 (
¿xNode
*)*
chd»n
;

144 ià(
d©af›ld
è
nodesize
 += (*);

145 
¿xNode
 *
node
 = 
	`¿x_m®loc
(
nodesize
);

146 ià(
node
 =ğ
NULL
)  NULL;

147 
node
->
iskey
 = 0;

148 
node
->
i¢uÎ
 = 0;

149 
node
->
iscom´
 = 0;

150 
node
->
size
 = 
chd»n
;

151  
node
;

152 
	}
}

156 
¿x
 *
	$¿xNew
() {

157 
¿x
 *¿x = 
	`¿x_m®loc
((*rax));

158 ià(
¿x
 =ğ
NULL
)  NULL;

159 
¿x
->
num–e
 = 0;

160 
¿x
->
numnodes
 = 1;

161 
¿x
->
h—d
 = 
	`¿xNewNode
(0,0);

162 ià(
¿x
->
h—d
 =ğ
NULL
) {

163 
	`¿x_ä“
(
¿x
);

164  
NULL
;

166  
¿x
;

168 
	}
}

171 
	#¿xNodeCu¼’tL’gth
(
n
) ( \

172 (
¿xNode
)+(
n
)->
size
+ \

173 ((
n
)->
iscom´
 ? (
¿xNode
*è: ÔaxNode*)*Ò)->
size
)+ \

174 (((
n
)->
iskey
 && !Ò)->
i¢uÎ
)*(*)) \

175 )

	)

179 
¿xNode
 *
	$¿xR—ÎocFÜD©a
(
¿xNode
 *
n
, *
d©a
) {

180 ià(
d©a
 =ğ
NULL
è 
n
;

181 
size_t
 
cu¾’
 = 
	`¿xNodeCu¼’tL’gth
(
n
);

182  
	`¿x_»®loc
(
n
,
cu¾’
+(*));

183 
	}
}

186 
	$¿xS‘D©a
(
¿xNode
 *
n
, *
d©a
) {

187 
n
->
iskey
 = 1;

188 ià(
d©a
 !ğ
NULL
) {

189 
n
->
i¢uÎ
 = 0;

190 **
nd©a
 = (**)

191 ((*)
n
+
	`¿xNodeCu¼’tL’gth
(n)-(*));

192 
	`memıy
(
nd©a
,&
d©a
,(data));

194 
n
->
i¢uÎ
 = 1;

196 
	}
}

199 *
	$¿xG‘D©a
(
¿xNode
 *
n
) {

200 ià(
n
->
i¢uÎ
è 
NULL
;

201 **
nd©a
 =(**)((*)
n
+
	`¿xNodeCu¼’tL’gth
(n)-(*));

202 *
d©a
;

203 
	`memıy
(&
d©a
,
nd©a
,(data));

204  
d©a
;

205 
	}
}

216 
¿xNode
 *
	$¿xAddChd
(
¿xNode
 *
n
, 
c
,„axNod**
chd±r
,„axNod***
·»Álšk
) {

217 
	`as£¹
(
n
->
iscom´
 == 0);

219 
size_t
 
cu¾’
 = (
¿xNode
)+

220 
n
->
size
+

221 (
¿xNode
*)*
n
->
size
;

222 
size_t
 
ÃwËn
;

225 
¿xNode
 *
chd
 = 
	`¿xNewNode
(0,0);

226 ià(
chd
 =ğ
NULL
)  NULL;

229 ià(
n
->
iskey
è
cu¾’
 += (*);

230 
ÃwËn
 = 
cu¾’
+(
¿xNode
*)+1;

231 
¿xNode
 *
Ãwn
 = 
	`¿x_»®loc
(
n
,
ÃwËn
);

232 ià(
Ãwn
 =ğ
NULL
) {

233 
	`¿x_ä“
(
chd
);

234  
NULL
;

236 
n
 = 
Ãwn
;

246 
pos
;

247 
pos
 = 0;…o < 
n
->
size
;…os++) {

248 ià(
n
->
d©a
[
pos
] > 
c
) ;

256 *
¤c
;

257 ià(
n
->
iskey
 && !n->
i¢uÎ
) {

258 
¤c
 = 
n
->
d©a
+n->
size
+(
¿xNode
*)*n->size;

259 
	`memmove
(
¤c
+1+(
¿xNode
*),src,(*));

268 
¤c
 = 
n
->
d©a
+n->
size
+(
¿xNode
*)*
pos
;

269 
	`memmove
(
¤c
+1+(
¿xNode
*),¤c,ÔaxNode*)*(
n
->
size
-
pos
));

276 
¤c
 = 
n
->
d©a
+
pos
;

277 
	`memmove
(
¤c
+1,¤c,
n
->
size
-
pos
+(
¿xNode
*)*pos);

283 
n
->
d©a
[
pos
] = 
c
;

284 
n
->
size
++;

285 
¿xNode
 **
chdf›ld
 = (¿xNode**)(
n
->
d©a
+n->
size
+ÔaxNode*)*
pos
);

286 
	`memıy
(
chdf›ld
,&
chd
,(child));

287 *
chd±r
 = 
chd
;

288 *
·»Álšk
 = 
chdf›ld
;

289  
n
;

290 
	}
}

294 
	#¿xNodeLa¡ChdPŒ
(
n
è((
¿xNode
**) ( \

295 ((*)(
n
)) + \

296 
	`¿xNodeCu¼’tL’gth
(
n
) - \

297 (
¿xNode
*) - \

298 (((
n
)->
iskey
 && !Ò)->
i¢uÎ
) ? (*) : 0) \

299 ))

	)

302 
	#¿xNodeFœ¡ChdPŒ
(
n
è((
¿xNode
**)(Ò)->
d©a
+Ò)->
size
))

	)

312 
¿xNode
 *
	$¿xCom´essNode
(
¿xNode
 *
n
, *
s
, 
size_t
 
Ën
,„axNod**
chd
) {

313 
	`as£¹
(
n
->
size
 =ğ0 &&‚->
iscom´
 == 0);

314 *
d©a
 = 
NULL
;

315 
size_t
 
Ãwsize
;

317 
	`debugf
("Com´es node: %.*s\n", ()
Ën
,
s
);

320 *
chd
 = 
	`¿xNewNode
(0,0);

321 ià(*
chd
 =ğ
NULL
)  NULL;

324 
Ãwsize
 = (
¿xNode
)+
Ën
+(raxNode*);

325 ià(
n
->
iskey
) {

326 
d©a
 = 
	`¿xG‘D©a
(
n
);

327 ià(!
n
->
i¢uÎ
è
Ãwsize
 += (*);

329 
¿xNode
 *
Ãwn
 = 
	`¿x_»®loc
(
n
,
Ãwsize
);

330 ià(
Ãwn
 =ğ
NULL
) {

331 
	`¿x_ä“
(*
chd
);

332  
NULL
;

334 
n
 = 
Ãwn
;

336 
n
->
iscom´
 = 1;

337 
n
->
size
 = 
Ën
;

338 
	`memıy
(
n
->
d©a
,
s
,
Ën
);

339 ià(
n
->
iskey
è
	`¿xS‘D©a
Ò,
d©a
);

340 
¿xNode
 **
chdf›ld
 = 
	`¿xNodeLa¡ChdPŒ
(
n
);

341 
	`memıy
(
chdf›ld
,
chd
,(*child));

342  
n
;

343 
	}
}

363 
šlše
 
size_t
 
	$¿xLowW®k
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
, 
¿xNode
 **
¡İnode
,„axNod***
¶šk
, *
¥l™pos
, 
¿xSck
 *
ts
) {

364 
¿xNode
 *
h
 = 
¿x
->
h—d
;

365 
¿xNode
 **
·»Álšk
 = &
¿x
->
h—d
;

367 
size_t
 
i
 = 0;

368 
size_t
 
j
 = 0;

369 
h
->
size
 && 
i
 < 
Ën
) {

370 
	`debugnode
("Looku°cu¼’ˆnode",
h
);

371 *
v
 = 
h
->
d©a
;

373 ià(
h
->
iscom´
) {

374 
j
 = 0; j < 
h
->
size
 && 
i
 < 
Ën
; j++, i++) {

375 ià(
v
[
j
] !ğ
s
[
i
]) ;

377 ià(
j
 !ğ
h
->
size
) ;

382 
j
 = 0; j < 
h
->
size
; j++) {

383 ià(
v
[
j
] =ğ
s
[
i
]) ;

385 ià(
j
 =ğ
h
->
size
) ;

386 
i
++;

389 ià(
ts
è
	`¿xSckPush
Ñs,
h
);

390 
¿xNode
 **
chd»n
 = 
	`¿xNodeFœ¡ChdPŒ
(
h
);

391 ià(
h
->
iscom´
è
j
 = 0;

392 
	`memıy
(&
h
,
chd»n
+
j
,(h));

393 
·»Álšk
 = 
chd»n
+
j
;

394 
j
 = 0;

399 
	`debugnode
("Looku°¡İ‚odis",
h
);

400 ià(
¡İnode
è*¡İnodğ
h
;

401 ià(
¶šk
è*¶šk = 
·»Álšk
;

402 ià(
¥l™pos
 && 
h
->
iscom´
è*¥l™po ğ
j
;

403  
i
;

404 
	}
}

411 
	$¿xIn£¹
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
, *
d©a
, **
Şd
) {

412 
size_t
 
i
;

413 
j
 = 0;

417 
¿xNode
 *
h
, **
·»Álšk
;

419 
	`debugf
("### In£¹ %.* w™h v®u%p\n", ()
Ën
, 
s
, 
d©a
);

420 
i
 = 
	`¿xLowW®k
(
¿x
,
s
,
Ën
,&
h
,&
·»Álšk
,&
j
,
NULL
);

427 ià(
i
 =ğ
Ën
 && (!
h
->
iscom´
 || 
j
 == 0 )) {

428 
	`debugf
("### Insert:‚ode„epresenting keyƒxists\n");

429 ià(!
h
->
iskey
 || h->
i¢uÎ
) {

430 
h
 = 
	`¿xR—ÎocFÜD©a
(h,
d©a
);

431 ià(
h
è
	`memıy
(
·»Álšk
,&h,(h));

433 ià(
h
 =ğ
NULL
) {

434 
”ºo
 = 
ENOMEM
;

437 ià(
h
->
iskey
) {

438 ià(
Şd
è*Şd = 
	`¿xG‘D©a
(
h
);

439 
	`¿xS‘D©a
(
h
,
d©a
);

440 
”ºo
 = 0;

443 
	`¿xS‘D©a
(
h
,
d©a
);

444 
¿x
->
num–e
++;

573 ià(
h
->
iscom´
 && 
i
 !ğ
Ën
) {

574 
	`debugf
("ALGO 1: Stopped‡t compressed‚ode %.*s (%p)\n",

575 
h
->
size
, h->
d©a
, (*)h);

576 
	`debugf
("StÈtØš£¹: %.*s\n", ()(
Ën
-
i
), 
s
+i);

577 
	`debugf
("S¶™tšg‡ˆ%d: '%c'\n", 
j
, ((*)
h
->
d©a
)[j]);

578 
	`debugf
("Oth” (keyèË‰” i '%c'\n", 
s
[
i
]);

581 
¿xNode
 **
chdf›ld
 = 
	`¿xNodeLa¡ChdPŒ
(
h
);

582 
¿xNode
 *
Ãxt
;

583 
	`memıy
(&
Ãxt
,
chdf›ld
,(next));

584 
	`debugf
("Nexˆi %p\n", (*)
Ãxt
);

585 
	`debugf
("iskey %d\n", 
h
->
iskey
);

586 ià(
h
->
iskey
) {

587 
	`debugf
("key v®ui %p\n", 
	`¿xG‘D©a
(
h
));

591 
size_t
 
ŒimmedËn
 = 
j
;

592 
size_t
 
po¡fixËn
 = 
h
->
size
 - 
j
 - 1;

593 
¥l™_node_is_key
 = !
ŒimmedËn
 && 
h
->
iskey
 && !h->
i¢uÎ
;

594 
size_t
 
nodesize
;

598 
¿xNode
 *
¥l™node
 = 
	`¿xNewNode
(1, 
¥l™_node_is_key
);

599 
¿xNode
 *
Œimmed
 = 
NULL
;

600 
¿xNode
 *
po¡fix
 = 
NULL
;

602 ià(
ŒimmedËn
) {

603 
nodesize
 = (
¿xNode
)+
ŒimmedËn
+(raxNode*);

604 ià(
h
->
iskey
 && !h->
i¢uÎ
è
nodesize
 += (*);

605 
Œimmed
 = 
	`¿x_m®loc
(
nodesize
);

608 ià(
po¡fixËn
) {

609 
nodesize
 = (
¿xNode
)+
po¡fixËn
+

610 (
¿xNode
*);

611 
po¡fix
 = 
	`¿x_m®loc
(
nodesize
);

615 ià(
¥l™node
 =ğ
NULL
 ||

616 (
ŒimmedËn
 && 
Œimmed
 =ğ
NULL
) ||

617 (
po¡fixËn
 && 
po¡fix
 =ğ
NULL
))

619 
	`¿x_ä“
(
¥l™node
);

620 
	`¿x_ä“
(
Œimmed
);

621 
	`¿x_ä“
(
po¡fix
);

622 
”ºo
 = 
ENOMEM
;

625 
¥l™node
->
d©a
[0] = 
h
->d©a[
j
];

627 ià(
j
 == 0) {

629 ià(
h
->
iskey
) {

630 *
nd©a
 = 
	`¿xG‘D©a
(
h
);

631 
	`¿xS‘D©a
(
¥l™node
,
nd©a
);

633 
	`memıy
(
·»Álšk
,&
¥l™node
,(splitnode));

636 
Œimmed
->
size
 = 
j
;

637 
	`memıy
(
Œimmed
->
d©a
,
h
->d©a,
j
);

638 
Œimmed
->
iscom´
 = 
j
 > 1 ? 1 : 0;

639 
Œimmed
->
iskey
 = 
h
->iskey;

640 
Œimmed
->
i¢uÎ
 = 
h
->isnull;

641 ià(
h
->
iskey
 && !h->
i¢uÎ
) {

642 *
nd©a
 = 
	`¿xG‘D©a
(
h
);

643 
	`¿xS‘D©a
(
Œimmed
,
nd©a
);

645 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
Œimmed
);

646 
	`memıy
(
ı
,&
¥l™node
,(splitnode));

647 
	`memıy
(
·»Álšk
,&
Œimmed
,(trimmed));

648 
·»Álšk
 = 
ı
;

649 
¿x
->
numnodes
++;

654 ià(
po¡fixËn
) {

656 
po¡fix
->
iskey
 = 0;

657 
po¡fix
->
i¢uÎ
 = 0;

658 
po¡fix
->
size
 = 
po¡fixËn
;

659 
po¡fix
->
iscom´
 = 
po¡fixËn
 > 1;

660 
	`memıy
(
po¡fix
->
d©a
,
h
->d©a+
j
+1,
po¡fixËn
);

661 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
po¡fix
);

662 
	`memıy
(
ı
,&
Ãxt
,(next));

663 
¿x
->
numnodes
++;

666 
po¡fix
 = 
Ãxt
;

670 
¿xNode
 **
¥l™chd
 = 
	`¿xNodeLa¡ChdPŒ
(
¥l™node
);

671 
	`memıy
(
¥l™chd
,&
po¡fix
,(postfix));

676 
	`¿x_ä“
(
h
);

677 
h
 = 
¥l™node
;

678 } ià(
h
->
iscom´
 && 
i
 =ğ
Ën
) {

680 
	`debugf
("ALGO 2: Stopped‡t compressed‚ode %.*s (%p) j = %d\n",

681 
h
->
size
, h->
d©a
, (*)h, 
j
);

684 
size_t
 
po¡fixËn
 = 
h
->
size
 - 
j
;

685 
size_t
 
nodesize
 = (
¿xNode
)+
po¡fixËn
+(raxNode*);

686 ià(
d©a
 !ğ
NULL
è
nodesize
 += (*);

687 
¿xNode
 *
po¡fix
 = 
	`¿x_m®loc
(
nodesize
);

689 
nodesize
 = (
¿xNode
)+
j
+(raxNode*);

690 ià(
h
->
iskey
 && !h->
i¢uÎ
è
nodesize
 += (*);

691 
¿xNode
 *
Œimmed
 = 
	`¿x_m®loc
(
nodesize
);

693 ià(
po¡fix
 =ğ
NULL
 || 
Œimmed
 == NULL) {

694 
	`¿x_ä“
(
po¡fix
);

695 
	`¿x_ä“
(
Œimmed
);

696 
”ºo
 = 
ENOMEM
;

701 
¿xNode
 **
chdf›ld
 = 
	`¿xNodeLa¡ChdPŒ
(
h
);

702 
¿xNode
 *
Ãxt
;

703 
	`memıy
(&
Ãxt
,
chdf›ld
,(next));

706 
po¡fix
->
size
 = 
po¡fixËn
;

707 
po¡fix
->
iscom´
 = 
po¡fixËn
 > 1;

708 
po¡fix
->
iskey
 = 1;

709 
po¡fix
->
i¢uÎ
 = 0;

710 
	`memıy
(
po¡fix
->
d©a
,
h
->d©a+
j
,
po¡fixËn
);

711 
	`¿xS‘D©a
(
po¡fix
,
d©a
);

712 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
po¡fix
);

713 
	`memıy
(
ı
,&
Ãxt
,(next));

714 
¿x
->
numnodes
++;

717 
Œimmed
->
size
 = 
j
;

718 
Œimmed
->
iscom´
 = 
j
 > 1;

719 
Œimmed
->
iskey
 = 0;

720 
Œimmed
->
i¢uÎ
 = 0;

721 
	`memıy
(
Œimmed
->
d©a
,
h
->d©a,
j
);

722 
	`memıy
(
·»Álšk
,&
Œimmed
,(trimmed));

723 ià(
h
->
iskey
) {

724 *
aux
 = 
	`¿xG‘D©a
(
h
);

725 
	`¿xS‘D©a
(
Œimmed
,
aux
);

730 
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
Œimmed
);

731 
	`memıy
(
ı
,&
po¡fix
,(postfix));

735 
¿x
->
num–e
++;

736 
	`¿x_ä“
(
h
);

742 
i
 < 
Ën
) {

743 
¿xNode
 *
chd
;

748 ià(
h
->
size
 =ğ0 && 
Ën
-
i
 > 1) {

749 
	`debugf
("Inserting compressed‚ode\n");

750 
size_t
 
com´size
 = 
Ën
-
i
;

751 ià(
com´size
 > 
RAX_NODE_MAX_SIZE
)

752 
com´size
 = 
RAX_NODE_MAX_SIZE
;

753 
¿xNode
 *
Ãwh
 = 
	`¿xCom´essNode
(
h
,
s
+
i
,
com´size
,&
chd
);

754 ià(
Ãwh
 =ğ
NULL
è
oom
;

755 
h
 = 
Ãwh
;

756 
	`memıy
(
·»Álšk
,&
h
,(h));

757 
·»Álšk
 = 
	`¿xNodeLa¡ChdPŒ
(
h
);

758 
i
 +ğ
com´size
;

760 
	`debugf
("Inserting‚ormal‚ode\n");

761 
¿xNode
 **
Ãw_·»Álšk
;

762 
¿xNode
 *
Ãwh
 = 
	`¿xAddChd
(
h
,
s
[
i
],&
chd
,&
Ãw_·»Álšk
);

763 ià(
Ãwh
 =ğ
NULL
è
oom
;

764 
h
 = 
Ãwh
;

765 
	`memıy
(
·»Álšk
,&
h
,(h));

766 
·»Álšk
 = 
Ãw_·»Álšk
;

767 
i
++;

769 
¿x
->
numnodes
++;

770 
h
 = 
chd
;

772 
¿xNode
 *
Ãwh
 = 
	`¿xR—ÎocFÜD©a
(
h
,
d©a
);

773 ià(
Ãwh
 =ğ
NULL
è
oom
;

774 
h
 = 
Ãwh
;

775 ià(!
h
->
iskey
è
¿x
->
num–e
++;

776 
	`¿xS‘D©a
(
h
,
d©a
);

777 
	`memıy
(
·»Álšk
,&
h
,(h));

780 
oom
:

786 ià(
h
->
size
 == 0) {

787 
h
->
i¢uÎ
 = 1;

788 
h
->
iskey
 = 1;

789 
¿x
->
num–e
++;

790 
	`as£¹
(
	`¿xRemove
(
¿x
,
s
,
i
,
NULL
) != 0);

792 
”ºo
 = 
ENOMEM
;

794 
	}
}

799 *
	$¿xFšd
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
) {

800 
¿xNode
 *
h
;

802 
	`debugf
("### Lookup: %.*s\n", ()
Ën
, 
s
);

803 
¥l™pos
 = 0;

804 
size_t
 
i
 = 
	`¿xLowW®k
(
¿x
,
s
,
Ën
,&
h
,
NULL
,&
¥l™pos
,NULL);

805 ià(
i
 !ğ
Ën
 || (
h
->
iscom´
 && 
¥l™pos
 !ğ0è|| !h->
iskey
)

806  
¿xNÙFound
;

807  
	`¿xG‘D©a
(
h
);

808 
	}
}

815 
¿xNode
 **
	$¿xFšdP¬’tLšk
(
¿xNode
 *
·»Á
,„axNod*
chd
) {

816 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
·»Á
);

817 
¿xNode
 *
c
;

819 
	`memıy
(&
c
,
ı
,(c));

820 ià(
c
 =ğ
chd
) ;

821 
ı
++;

823  
ı
;

824 
	}
}

830 
¿xNode
 *
	$¿xRemoveChd
(
¿xNode
 *
·»Á
,„axNod*
chd
) {

831 
	`debugnode
("¿xRemoveChd befÜe", 
·»Á
);

835 ià(
·»Á
->
iscom´
) {

836 *
d©a
 = 
NULL
;

837 ià(
·»Á
->
iskey
è
d©a
 = 
	`¿xG‘D©a
(parent);

838 
·»Á
->
i¢uÎ
 = 0;

839 
·»Á
->
iscom´
 = 0;

840 
·»Á
->
size
 = 0;

841 ià(
·»Á
->
iskey
è
	`¿xS‘D©a
Õ¬’t,
d©a
);

842 
	`debugnode
("¿xRemoveChd‡á”", 
·»Á
);

843  
·»Á
;

851 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
·»Á
);

852 
¿xNode
 **
c
 = 
ı
;

853 *
e
 = 
·»Á
->
d©a
;

858 
¿xNode
 *
aux
;

859 
	`memıy
(&
aux
,
c
,(aux));

860 ià(
aux
 =ğ
chd
) ;

861 
c
++;

862 
e
++;

867 
Ën
 = 
·»Á
->
size
 - (
e
 -…¬’t->
d©a
) - 1;

868 
	`debugf
("¿xRemoveChda†’: %d\n", 
Ën
);

869 
	`memmove
(
e
,e+1,
Ën
);

873 
	`memmove
(((*)
ı
)-1,ı,(
·»Á
->
size
-
Ën
-1)*(
¿xNode
**));

876 
size_t
 
v®u–’
 = (
·»Á
->
iskey
 && !·»Á->
i¢uÎ
) ? (*) : 0;

877 
	`memmove
(((*)
c
)-1,c+1,
Ën
*(
¿xNode
**)+
v®u–’
);

880 
·»Á
->
size
--;

884 
¿xNode
 *
Ãwnode
 = 
	`¿x_»®loc
(
·»Á
,
	`¿xNodeCu¼’tL’gth
(parent));

885 ià(
Ãwnode
) {

886 
	`debugnode
("¿xRemoveChd‡á”", 
Ãwnode
);

890  
Ãwnode
 ?‚ewnod: 
·»Á
;

891 
	}
}

895 
	$¿xRemove
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
, **
Şd
) {

896 
¿xNode
 *
h
;

897 
¿xSck
 
ts
;

899 
	`debugf
("### D–‘e: %.*s\n", ()
Ën
, 
s
);

900 
	`¿xSckIn™
(&
ts
);

901 
¥l™pos
 = 0;

902 
size_t
 
i
 = 
	`¿xLowW®k
(
¿x
,
s
,
Ën
,&
h
,
NULL
,&
¥l™pos
,&
ts
);

903 ià(
i
 !ğ
Ën
 || (
h
->
iscom´
 && 
¥l™pos
 !ğ0è|| !h->
iskey
) {

904 
	`¿xSckF»e
(&
ts
);

907 ià(
Şd
è*Şd = 
	`¿xG‘D©a
(
h
);

908 
h
->
iskey
 = 0;

909 
¿x
->
num–e
--;

917 
Œycom´ess
 = 0;

920 ià(
h
->
size
 == 0) {

921 
	`debugf
("Key deleted in‚ode without children. Cleanup‚eeded.\n");

922 
¿xNode
 *
chd
 = 
NULL
;

923 
h
 !ğ
¿x
->
h—d
) {

924 
chd
 = 
h
;

925 
	`debugf
("F»ešg chd %°[%.*s] key:%d\n", (*)
chd
,

926 ()
chd
->
size
, (*)chd->
d©a
, chd->
iskey
);

927 
	`¿x_ä“
(
chd
);

928 
¿x
->
numnodes
--;

929 
h
 = 
	`¿xSckPİ
(&
ts
);

932 ià(
h
->
iskey
 || (!h->
iscom´
 && h->
size
 != 1)) ;

934 ià(
chd
) {

935 
	`debugf
("Unlinking child %p from…arent %p\n",

936 (*)
chd
, (*)
h
);

937 
¿xNode
 *
Ãw
 = 
	`¿xRemoveChd
(
h
,
chd
);

938 ià(
Ãw
 !ğ
h
) {

939 
¿xNode
 *
·»Á
 = 
	`¿xSckP“k
(&
ts
);

940 
¿xNode
 **
·»Álšk
;

941 ià(
·»Á
 =ğ
NULL
) {

942 
·»Álšk
 = &
¿x
->
h—d
;

944 
·»Álšk
 = 
	`¿xFšdP¬’tLšk
(
·»Á
,
h
);

946 
	`memıy
(
·»Álšk
,&
Ãw
,(new));

951 ià(
Ãw
->
size
 =ğ1 &&‚ew->
iskey
 == 0) {

952 
Œycom´ess
 = 1;

953 
h
 = 
Ãw
;

956 } ià(
h
->
size
 == 1) {

959 
Œycom´ess
 = 1;

964 ià(
Œycom´ess
 && 
ts
.
oom
)rycompress = 0;

1009 ià(
Œycom´ess
) {

1010 
	`debugf
("Aá”„emovšg %.*s:\n", ()
Ën
, 
s
);

1011 
	`debugnode
("Com´essiÚ may bÃeded",
h
);

1012 
	`debugf
("Seek start‚ode\n");

1017 
¿xNode
 *
·»Á
;

1019 
·»Á
 = 
	`¿xSckPİ
(&
ts
);

1020 ià(!
·»Á
 ||…¬’t->
iskey
 ||

1021 (!
·»Á
->
iscom´
 &&…¬’t->
size
 != 1)) ;

1022 
h
 = 
·»Á
;

1023 
	`debugnode
("Gošg u°to",
h
);

1025 
¿xNode
 *
¡¬t
 = 
h
;

1028 
size_t
 
com´size
 = 
h
->
size
;

1029 
nodes
 = 1;

1030 
h
->
size
 != 0) {

1031 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
h
);

1032 
	`memıy
(&
h
,
ı
,(h));

1033 ià(
h
->
iskey
 || (!h->
iscom´
 && h->
size
 != 1)) ;

1036 ià(
com´size
 + 
h
->
size
 > 
RAX_NODE_MAX_SIZE
) ;

1037 
nodes
++;

1038 
com´size
 +ğ
h
->
size
;

1040 ià(
nodes
 > 1) {

1042 
size_t
 
nodesize
 =

1043 (
¿xNode
)+
com´size
+(raxNode*);

1044 
¿xNode
 *
Ãw
 = 
	`¿x_m®loc
(
nodesize
);

1047 ià(
Ãw
 =ğ
NULL
) {

1048 
	`¿xSckF»e
(&
ts
);

1051 
Ãw
->
iskey
 = 0;

1052 
Ãw
->
i¢uÎ
 = 0;

1053 
Ãw
->
iscom´
 = 1;

1054 
Ãw
->
size
 = 
com´size
;

1055 
¿x
->
numnodes
++;

1060 
com´size
 = 0;

1061 
h
 = 
¡¬t
;

1062 
h
->
size
 != 0) {

1063 
	`memıy
(
Ãw
->
d©a
+
com´size
,
h
->d©a,h->
size
);

1064 
com´size
 +ğ
h
->
size
;

1065 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
h
);

1066 
¿xNode
 *
toä“
 = 
h
;

1067 
	`memıy
(&
h
,
ı
,(h));

1068 
	`¿x_ä“
(
toä“
); 
¿x
->
numnodes
--;

1069 ià(
h
->
iskey
 || (!h->
iscom´
 && h->
size
 != 1)) ;

1071 
	`debugnode
("New‚ode",
Ãw
);

1075 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
Ãw
);

1076 
	`memıy
(
ı
,&
h
,(h));

1079 ià(
·»Á
) {

1080 
¿xNode
 **
·»Álšk
 = 
	`¿xFšdP¬’tLšk
(
·»Á
,
¡¬t
);

1081 
	`memıy
(
·»Álšk
,&
Ãw
,(new));

1083 
¿x
->
h—d
 = 
Ãw
;

1086 
	`debugf
("Compressed %d‚odes, %dotal bytes\n",

1087 
nodes
, ()
com´size
);

1090 
	`¿xSckF»e
(&
ts
);

1092 
	}
}

1096 
	$¿xRecursiveF»e
(
¿x
 *¿x, 
¿xNode
 *
n
, (*
ä“_ÿÎback
)(*)) {

1097 
	`debugnode
("ä“¿v”sšg",
n
);

1098 
numchd»n
 = 
n
->
iscom´
 ? 1 :‚->
size
;

1099 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
n
);

1100 
numchd»n
--) {

1101 
¿xNode
 *
chd
;

1102 
	`memıy
(&
chd
,
ı
,(child));

1103 
	`¿xRecursiveF»e
(
¿x
,
chd
,
ä“_ÿÎback
);

1104 
ı
--;

1106 
	`debugnode
("ä“ d•th-fœ¡",
n
);

1107 ià(
ä“_ÿÎback
 && 
n
->
iskey
 && !n->
i¢uÎ
)

1108 
	`ä“_ÿÎback
(
	`¿xG‘D©a
(
n
));

1109 
	`¿x_ä“
(
n
);

1110 
¿x
->
numnodes
--;

1111 
	}
}

1115 
	$¿xF»eW™hC®lback
(
¿x
 *¿x, (*
ä“_ÿÎback
)(*)) {

1116 
	`¿xRecursiveF»e
(
¿x
,¿x->
h—d
,
ä“_ÿÎback
);

1117 
	`as£¹
(
¿x
->
numnodes
 == 0);

1118 
	`¿x_ä“
(
¿x
);

1119 
	}
}

1122 
	$¿xF»e
(
¿x
 *rax) {

1123 
	`¿xF»eW™hC®lback
(
¿x
,
NULL
);

1124 
	}
}

1131 
	$¿xS¹
(
¿xI‹¿tÜ
 *
™
, 
¿x
 *
¹
) {

1132 
™
->
æags
 = 
RAX_ITER_EOF
;

1133 
™
->
¹
 =„t;

1134 
™
->
key_Ën
 = 0;

1135 
™
->
key
 = it->
key_¡©ic_¡ršg
;

1136 
™
->
key_max
 = 
RAX_ITER_STATIC_LEN
;

1137 
™
->
d©a
 = 
NULL
;

1138 
	`¿xSckIn™
(&
™
->
¡ack
);

1139 
	}
}

1144 
	$¿xI‹¿tÜAddCh¬s
(
¿xI‹¿tÜ
 *
™
, *
s
, 
size_t
 
Ën
) {

1145 ià(
™
->
key_max
 < it->
key_Ën
+
Ën
) {

1146 *
Şd
 = (
™
->
key
 =ğ™->
key_¡©ic_¡ršg
è? 
NULL
 :

1147 
™
->
key
;

1148 
size_t
 
Ãw_max
 = (
™
->
key_Ën
+
Ën
)*2;

1149 
™
->
key
 = 
	`¿x_»®loc
(
Şd
,
Ãw_max
);

1150 ià(
™
->
key
 =ğ
NULL
) {

1151 
™
->
key
 = (!
Şd
è? it->
key_¡©ic_¡ršg
 : old;

1152 
”ºo
 = 
ENOMEM
;

1155 ià(
Şd
 =ğ
NULL
è
	`memıy
(
™
->
key
,™->
key_¡©ic_¡ršg
,™->
key_Ën
);

1156 
™
->
key_max
 = 
Ãw_max
;

1160 
	`memmove
(
™
->
key
+™->
key_Ën
,
s
,
Ën
);

1161 
™
->
key_Ën
 +ğ
Ën
;

1163 
	}
}

1167 
	$¿xI‹¿tÜD–Ch¬s
(
¿xI‹¿tÜ
 *
™
, 
size_t
 
couÁ
) {

1168 
™
->
key_Ën
 -ğ
couÁ
;

1169 
	}
}

1185 
	$¿xI‹¿tÜNextS‹p
(
¿xI‹¿tÜ
 *
™
, 
noup
) {

1186 ià(
™
->
æags
 & 
RAX_ITER_EOF
) {

1188 } ià(
™
->
æags
 & 
RAX_ITER_JUST_SEEKED
) {

1189 
™
->
æags
 &ğ~
RAX_ITER_JUST_SEEKED
;

1195 
size_t
 
Üig_key_Ën
 = 
™
->
key_Ën
;

1196 
size_t
 
Üig_¡ack_™ems
 = 
™
->
¡ack
.
™ems
;

1197 
¿xNode
 *
Üig_node
 = 
™
->
node
;

1200 
chd»n
 = 
™
->
node
->
iscom´
 ? 1 : it->node->
size
;

1201 ià(!
noup
 && 
chd»n
) {

1202 
	`debugf
("GO DEEPER\n");

1206 ià(!
	`¿xSckPush
(&
™
->
¡ack
,™->
node
))  0;

1207 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
™
->
node
);

1208 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
,

1209 
™
->
node
->
iscom´
 ? it->node->
size
 : 1))  0;

1210 
	`memıy
(&
™
->
node
,
ı
,(it->node));

1214 ià(
™
->
node
->
iskey
) {

1215 
™
->
d©a
 = 
	`¿xG‘D©a
(™->
node
);

1224 
Şd_noup
 = 
noup
;

1227 ià(!
noup
 && 
™
->
node
 =ğ™->
¹
->
h—d
) {

1228 
™
->
æags
 |ğ
RAX_ITER_EOF
;

1229 
™
->
¡ack
.
™ems
 = 
Üig_¡ack_™ems
;

1230 
™
->
key_Ën
 = 
Üig_key_Ën
;

1231 
™
->
node
 = 
Üig_node
;

1236 
´evchd
 = 
™
->
key
[™->
key_Ën
-1];

1237 ià(!
noup
) {

1238 
™
->
node
 = 
	`¿xSckPİ
(&™->
¡ack
);

1240 
noup
 = 0;

1244 
tod–
 = 
™
->
node
->
iscom´
 ? it->node->
size
 : 1;

1245 
	`¿xI‹¿tÜD–Ch¬s
(
™
,
tod–
);

1249 ià(!
™
->
node
->
iscom´
 && it->node->
size
 > (
Şd_noup
 ? 0 : 1)) {

1250 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
™
->
node
);

1251 
i
 = 0;

1252 
i
 < 
™
->
node
->
size
) {

1253 
	`debugf
("SCAN NEXT %c\n", 
™
->
node
->
d©a
[
i
]);

1254 ià(
™
->
node
->
d©a
[
i
] > 
´evchd
) ;

1255 
i
++;

1256 
ı
++;

1258 ià(
i
 !ğ
™
->
node
->
size
) {

1259 
	`debugf
("SCAN found‡‚ew‚ode\n");

1260 
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
+
i
,1);

1261 ià(!
	`¿xSckPush
(&
™
->
¡ack
,™->
node
))  0;

1262 
	`memıy
(&
™
->
node
,
ı
,(it->node));

1263 ià(
™
->
node
->
iskey
) {

1264 
™
->
d©a
 = 
	`¿xG‘D©a
(™->
node
);

1273 
	}
}

1278 
	$¿xS“kG»©e¡
(
¿xI‹¿tÜ
 *
™
) {

1279 
™
->
node
->
size
) {

1280 ià(
™
->
node
->
iscom´
) {

1281 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
,

1282 
™
->
node
->
size
))  0;

1284 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
+™->node->
size
-1,1))

1287 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
™
->
node
);

1288 ià(!
	`¿xSckPush
(&
™
->
¡ack
,™->
node
))  0;

1289 
	`memıy
(&
™
->
node
,
ı
,(it->node));

1292 
	}
}

1297 
	$¿xI‹¿tÜP»vS‹p
(
¿xI‹¿tÜ
 *
™
, 
noup
) {

1298 ià(
™
->
æags
 & 
RAX_ITER_EOF
) {

1300 } ià(
™
->
æags
 & 
RAX_ITER_JUST_SEEKED
) {

1301 
™
->
æags
 &ğ~
RAX_ITER_JUST_SEEKED
;

1307 
size_t
 
Üig_key_Ën
 = 
™
->
key_Ën
;

1308 
size_t
 
Üig_¡ack_™ems
 = 
™
->
¡ack
.
™ems
;

1309 
¿xNode
 *
Üig_node
 = 
™
->
node
;

1312 
Şd_noup
 = 
noup
;

1315 ià(!
noup
 && 
™
->
node
 =ğ™->
¹
->
h—d
) {

1316 
™
->
æags
 |ğ
RAX_ITER_EOF
;

1317 
™
->
¡ack
.
™ems
 = 
Üig_¡ack_™ems
;

1318 
™
->
key_Ën
 = 
Üig_key_Ën
;

1319 
™
->
node
 = 
Üig_node
;

1323 
´evchd
 = 
™
->
key
[™->
key_Ën
-1];

1324 ià(!
noup
) {

1325 
™
->
node
 = 
	`¿xSckPİ
(&™->
¡ack
);

1327 
noup
 = 0;

1332 
tod–
 = 
™
->
node
->
iscom´
 ? it->node->
size
 : 1;

1333 
	`¿xI‹¿tÜD–Ch¬s
(
™
,
tod–
);

1337 ià(!
™
->
node
->
iscom´
 && it->node->
size
 > (
Şd_noup
 ? 0 : 1)) {

1338 
¿xNode
 **
ı
 = 
	`¿xNodeLa¡ChdPŒ
(
™
->
node
);

1339 
i
 = 
™
->
node
->
size
-1;

1340 
i
 >= 0) {

1341 
	`debugf
("SCAN PREV %c\n", 
™
->
node
->
d©a
[
i
]);

1342 ià(
™
->
node
->
d©a
[
i
] < 
´evchd
) ;

1343 
i
--;

1344 
ı
--;

1349 ià(
i
 != -1) {

1350 
	`debugf
("SCAN found‡‚ew‚ode\n");

1352 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
+
i
,1))  0;

1353 ià(!
	`¿xSckPush
(&
™
->
¡ack
,™->
node
))  0;

1354 
	`memıy
(&
™
->
node
,
ı
,(it->node));

1356 ià(!
	`¿xS“kG»©e¡
(
™
))  0;

1363 ià(
™
->
node
->
iskey
) {

1364 
™
->
d©a
 = 
	`¿xG‘D©a
(™->
node
);

1368 
	}
}

1374 
	$¿xS“k
(
¿xI‹¿tÜ
 *
™
, cÚ¡ *
İ
, *
–e
, 
size_t
 
Ën
) {

1375 
eq
 = 0, 
É
 = 0, 
gt
 = 0, 
fœ¡
 = 0, 
Ï¡
 = 0;

1377 
™
->
¡ack
.
™ems
 = 0;

1378 
™
->
æags
 |ğ
RAX_ITER_JUST_SEEKED
;

1379 
™
->
æags
 &ğ~
RAX_ITER_EOF
;

1380 
™
->
key_Ën
 = 0;

1381 
™
->
node
 = 
NULL
;

1384 ià(
İ
[0] == '>') {

1385 
gt
 = 1;

1386 ià(
İ
[1] =ğ'='è
eq
 = 1;

1387 } ià(
İ
[0] == '<') {

1388 
É
 = 1;

1389 ià(
İ
[1] =ğ'='è
eq
 = 1;

1390 } ià(
İ
[0] == '=') {

1391 
eq
 = 1;

1392 } ià(
İ
[0] == '^') {

1393 
fœ¡
 = 1;

1394 } ià(
İ
[0] == '$') {

1395 
Ï¡
 = 1;

1397 
”ºo
 = 0;

1403 ià(
™
->
¹
->
num–e
 == 0) {

1404 
™
->
æags
 |ğ
RAX_ITER_EOF
;

1408 ià(
fœ¡
) {

1411  
	`¿xS“k
(
™
,">=",
NULL
,0);

1414 ià(
Ï¡
) {

1417 
™
->
node
 = it->
¹
->
h—d
;

1418 ià(!
	`¿xS“kG»©e¡
(
™
))  0;

1419 
	`as£¹
(
™
->
node
->
iskey
);

1420 
™
->
d©a
 = 
	`¿xG‘D©a
(™->
node
);

1427 
¥l™pos
 = 0;

1428 
size_t
 
i
 = 
	`¿xLowW®k
(
™
->
¹
,
–e
,
Ën
,&™->
node
,
NULL
,&
¥l™pos
,&™->
¡ack
);

1431 ià(
™
->
¡ack
.
oom
)  0;

1433 ià(
eq
 && 
i
 =ğ
Ën
 && (!
™
->
node
->
iscom´
 || 
¥l™pos
 == 0) &&

1434 
™
->
node
->
iskey
)

1438 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
–e
,
Ën
))  0;

1439 
™
->
d©a
 = 
	`¿xG‘D©a
(™->
node
);

1440 } ià(
É
 || 
gt
) {

1446 ià(!
	`¿xSckPush
(&
™
->
¡ack
,™->
node
))  0;

1447 
size_t
 
j
 = 1; j < 
™
->
¡ack
.
™ems
; j++) {

1448 
¿xNode
 *
·»Á
 = 
™
->
¡ack
.¡ack[
j
-1];

1449 
¿xNode
 *
chd
 = 
™
->
¡ack
.¡ack[
j
];

1450 ià(
·»Á
->
iscom´
) {

1451 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
·»Á
->
d©a
,·»Á->
size
))

1454 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
·»Á
);

1455 *
p
 = 
·»Á
->
d©a
;

1457 
¿xNode
 *
aux
;

1458 
	`memıy
(&
aux
,
ı
,(aux));

1459 ià(
aux
 =ğ
chd
) ;

1460 
ı
++;

1461 
p
++;

1463 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
p
,1))  0;

1466 
	`¿xSckPİ
(&
™
->
¡ack
);

1470 
	`debugf
("After initial seek: i=%d†en=%d key=%.*s\n",

1471 ()
i
, ()
Ën
, ()
™
->
key_Ën
, it->
key
);

1472 ià(
i
 !ğ
Ën
 && !
™
->
node
->
iscom´
) {

1478 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
–e
+
i
,1))  0;

1479 
	`debugf
("Seek‚ormal‚ode on mismatch: %.*s\n",

1480 ()
™
->
key_Ën
, (*)™->
key
);

1482 
™
->
æags
 &ğ~
RAX_ITER_JUST_SEEKED
;

1483 ià(
É
 && !
	`¿xI‹¿tÜP»vS‹p
(
™
,1))  0;

1484 ià(
gt
 && !
	`¿xI‹¿tÜNextS‹p
(
™
,1))  0;

1485 
™
->
æags
 |ğ
RAX_ITER_JUST_SEEKED
;

1486 } ià(
i
 !ğ
Ën
 && 
™
->
node
->
iscom´
) {

1487 
	`debugf
("Compressed mismatch: %.*s\n",

1488 ()
™
->
key_Ën
, (*)™->
key
);

1490 
nodech¬
 = 
™
->
node
->
d©a
[
¥l™pos
];

1491 
keych¬
 = 
–e
[
i
];

1492 
™
->
æags
 &ğ~
RAX_ITER_JUST_SEEKED
;

1493 ià(
gt
) {

1497 ià(
nodech¬
 > 
keych¬
) {

1498 ià(!
	`¿xI‹¿tÜNextS‹p
(
™
,0))  0;

1500 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
,™->node->
size
))

1502 ià(!
	`¿xI‹¿tÜNextS‹p
(
™
,1))  0;

1505 ià(
É
) {

1510 ià(
nodech¬
 < 
keych¬
) {

1511 ià(!
	`¿xS“kG»©e¡
(
™
))  0;

1512 
™
->
d©a
 = 
	`¿xG‘D©a
(™->
node
);

1514 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,™->
node
->
d©a
,™->node->
size
))

1516 ià(!
	`¿xI‹¿tÜP»vS‹p
(
™
,1))  0;

1519 
™
->
æags
 |ğ
RAX_ITER_JUST_SEEKED
;

1521 
	`debugf
("No mismatch: %.*s\n",

1522 ()
™
->
key_Ën
, (*)™->
key
);

1528 
™
->
æags
 &ğ~
RAX_ITER_JUST_SEEKED
;

1529 ià(
gt
 && !
	`¿xI‹¿tÜNextS‹p
(
™
,0))  0;

1530 ià(
É
 && !
	`¿xI‹¿tÜP»vS‹p
(
™
,0))  0;

1531 
™
->
æags
 |ğ
RAX_ITER_JUST_SEEKED
;

1535 
™
->
æags
 |ğ
RAX_ITER_EOF
;

1539 
	}
}

1544 
	$¿xNext
(
¿xI‹¿tÜ
 *
™
) {

1545 ià(!
	`¿xI‹¿tÜNextS‹p
(
™
,0)) {

1546 
”ºo
 = 
ENOMEM
;

1549 ià(
™
->
æags
 & 
RAX_ITER_EOF
) {

1550 
”ºo
 = 0;

1554 
	}
}

1559 
	$¿xP»v
(
¿xI‹¿tÜ
 *
™
) {

1560 ià(!
	`¿xI‹¿tÜP»vS‹p
(
™
,0)) {

1561 
”ºo
 = 
ENOMEM
;

1564 ià(
™
->
æags
 & 
RAX_ITER_EOF
) {

1565 
”ºo
 = 0;

1569 
	}
}

1583 
	$¿xRªdomW®k
(
¿xI‹¿tÜ
 *
™
, 
size_t
 
¡•s
) {

1584 ià(
™
->
¹
->
num–e
 == 0) {

1585 
™
->
æags
 |ğ
RAX_ITER_EOF
;

1589 ià(
¡•s
 == 0) {

1590 
size_t
 
æe
 = 
	`æoÜ
(
	`log
(
™
->
¹
->
num–e
));

1591 
æe
 *= 2;

1592 
¡•s
 = 1 + 
	`¿nd
(è% 
æe
;

1595 
¿xNode
 *
n
 = 
™
->
node
;

1596 
¡•s
 > 0 || !
n
->
iskey
) {

1597 
numchd»n
 = 
n
->
iscom´
 ? 1 :‚->
size
;

1598 
r
 = 
	`¿nd
(è% (
numchd»n
+(
n
 !ğ
™
->
¹
->
h—d
));

1600 ià(
r
 =ğ
numchd»n
) {

1602 
n
 = 
	`¿xSckPİ
(&
™
->
¡ack
);

1603 
tod–
 = 
n
->
iscom´
 ?‚->
size
 : 1;

1604 
	`¿xI‹¿tÜD–Ch¬s
(
™
,
tod–
);

1607 ià(
n
->
iscom´
) {

1608 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
n
->
d©a
,n->
size
))  0;

1610 ià(!
	`¿xI‹¿tÜAddCh¬s
(
™
,
n
->
d©a
+
r
,1))  0;

1612 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
n
)+
r
;

1613 ià(!
	`¿xSckPush
(&
™
->
¡ack
,
n
))  0;

1614 
	`memıy
(&
n
,
ı
,(n));

1616 ià(
n
->
iskey
è
¡•s
--;

1618 
™
->
node
 = 
n
;

1620 
	}
}

1625 
	$¿xCom·»
(
¿xI‹¿tÜ
 *
™”
, cÚ¡ *
İ
, *
key
, 
size_t
 
key_Ën
) {

1626 
eq
 = 0, 
É
 = 0, 
gt
 = 0;

1628 ià(
İ
[0] =ğ'=' || op[1] =ğ'='è
eq
 = 1;

1629 ià(
İ
[0] =ğ'>'è
gt
 = 1;

1630 ià(
İ
[0] =ğ'<'è
É
 = 1;

1631 ià(
İ
[1] != '=')  0;

1633 
size_t
 
mšËn
 = 
key_Ën
 < 
™”
->key_len ? key_len : iter->key_len;

1634 
cmp
 = 
	`memcmp
(
™”
->
key
,key,
mšËn
);

1637 ià(
É
 =ğ0 && 
gt
 =ğ0è 
cmp
 =ğ0 && 
key_Ën
 =ğ
™”
->key_len;

1640 ià(
cmp
 == 0) {

1642 ià(
eq
 && 
key_Ën
 =ğ
™”
->key_len)  1;

1643 ià(
É
è 
™”
->
key_Ën
 < key_len;

1644 ià(
gt
è 
™”
->
key_Ën
 > key_len;

1645 } ià(
cmp
 > 0) {

1646  
gt
 ? 1 : 0;

1648  
É
 ? 1 : 0;

1650 
	}
}

1653 
	$¿xStİ
(
¿xI‹¿tÜ
 *
™
) {

1654 ià(
™
->
key
 !ğ™->
key_¡©ic_¡ršg
è
	`¿x_ä“
(it->key);

1655 
	`¿xSckF»e
(&
™
->
¡ack
);

1656 
	}
}

1662 
	$¿xEOF
(
¿xI‹¿tÜ
 *
™
) {

1663  
™
->
æags
 & 
RAX_ITER_EOF
;

1664 
	}
}

1667 
ušt64_t
 
	$¿xSize
(
¿x
 *rax) {

1668  
¿x
->
num–e
;

1669 
	}
}

1699 
	$¿xRecursiveShow
(
Ëv–
, 
Íad
, 
¿xNode
 *
n
) {

1700 
s
 = 
n
->
iscom´
 ? '"' : '[';

1701 
e
 = 
n
->
iscom´
 ? '"' : ']';

1703 
numch¬s
 = 
	`´štf
("%c%.*s%c", 
s
, 
n
->
size
,‚->
d©a
, 
e
);

1704 ià(
n
->
iskey
) {

1705 
numch¬s
 +ğ
	`´štf
("=%p",
	`¿xG‘D©a
(
n
));

1708 
numchd»n
 = 
n
->
iscom´
 ? 1 :‚->
size
;

1711 ià(
Ëv–
) {

1712 
Íad
 +ğ(
numchd»n
 > 1) ? 7 : 4;

1713 ià(
numchd»n
 =ğ1è
Íad
 +ğ
numch¬s
;

1715 
¿xNode
 **
ı
 = 
	`¿xNodeFœ¡ChdPŒ
(
n
);

1716 
i
 = 0; i < 
numchd»n
; i++) {

1717 *
b¿nch
 = " `-(%c) ";

1718 ià(
numchd»n
 > 1) {

1719 
	`´štf
("\n");

1720 
j
 = 0; j < 
Íad
; j++è
	`putch¬
(' ');

1721 
	`´štf
(
b¿nch
,
n
->
d©a
[
i
]);

1723 
	`´štf
(" -> ");

1725 
¿xNode
 *
chd
;

1726 
	`memıy
(&
chd
,
ı
,(child));

1727 
	`¿xRecursiveShow
(
Ëv–
+1,
Íad
,
chd
);

1728 
ı
++;

1730 
	}
}

1733 
	$¿xShow
(
¿x
 *rax) {

1734 
	`¿xRecursiveShow
(0,0,
¿x
->
h—d
);

1735 
	`putch¬
('\n');

1736 
	}
}

1739 
	$¿xDebugShowNode
(cÚ¡ *
msg
, 
¿xNode
 *
n
) {

1740 
	`´štf
("%s: %p [%.*s] key:%d size:%d children:",

1741 
msg
, (*)
n
, (ê->
size
, (*ê->
d©a
,‚->
iskey
,‚->size);

1742 
numşd
 = 
n
->
iscom´
 ? 1 :‚->
size
;

1743 
¿xNode
 **
şd±r
 = 
	`¿xNodeLa¡ChdPŒ
(
n
è- (
numşd
-1);

1744 
numşd
--) {

1745 
¿xNode
 *
chd
;

1746 
	`memıy
(&
chd
,
şd±r
,(child));

1747 
şd±r
++;

1748 
	`´štf
("%°", (*)
chd
);

1750 
	`´štf
("\n");

1751 
	`fæush
(
¡dout
);

1752 
	}
}

	@src/rax.h

1 #iâdeà
RAX_H


2 
	#RAX_H


	)

4 
	~<¡dšt.h
>

67 
	#RAX_NODE_MAX_SIZE
 ((1<<29)-1)

	)

68 
	s¿xNode
 {

69 
ušt32_t
 
	miskey
:1;

70 
ušt32_t
 
	mi¢uÎ
:1;

71 
ušt32_t
 
	miscom´
:1;

72 
ušt32_t
 
	msize
:29;

100 
	md©a
[];

101 } 
	t¿xNode
;

103 
	s¿x
 {

104 
¿xNode
 *
	mh—d
;

105 
ušt64_t
 
	mnum–e
;

106 
ušt64_t
 
	mnumnodes
;

107 } 
	t¿x
;

112 
	#RAX_STACK_STATIC_ITEMS
 32

	)

113 
	s¿xSck
 {

114 **
	m¡ack
;

115 
size_t
 
	m™ems
, 
	mmax™ems
;

118 *
	m¡©ic_™ems
[
RAX_STACK_STATIC_ITEMS
];

119 
	moom
;

120 } 
	t¿xSck
;

123 
	#RAX_ITER_STATIC_LEN
 128

	)

124 
	#RAX_ITER_JUST_SEEKED
 (1<<0è

	)

127 
	#RAX_ITER_EOF
 (1<<1è

	)

128 
	#RAX_ITER_SAFE
 (1<<2è

	)

130 
	s¿xI‹¿tÜ
 {

131 
	mæags
;

132 
¿x
 *
	m¹
;

133 *
	mkey
;

134 *
	md©a
;

135 
size_t
 
	mkey_Ën
;

136 
size_t
 
	mkey_max
;

137 
	mkey_¡©ic_¡ršg
[
RAX_ITER_STATIC_LEN
];

138 
¿xNode
 *
	mnode
;

139 
¿xSck
 
	m¡ack
;

140 } 
	t¿xI‹¿tÜ
;

143 *
¿xNÙFound
;

146 
¿x
 *
¿xNew
();

147 
¿xIn£¹
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
, *
d©a
, **
Şd
);

148 
¿xRemove
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
, **
Şd
);

149 *
¿xFšd
(
¿x
 *¿x, *
s
, 
size_t
 
Ën
);

150 
¿xF»e
(
¿x
 *rax);

151 
¿xF»eW™hC®lback
(
¿x
 *¿x, (*
ä“_ÿÎback
)(*));

152 
	`¿xS¹
(
¿xI‹¿tÜ
 *
™
, 
¿x
 *
¹
);

153 
	`¿xS“k
(
¿xI‹¿tÜ
 *
™
, cÚ¡ *
İ
, *
–e
, 
size_t
 
Ën
);

154 
	`¿xNext
(
¿xI‹¿tÜ
 *
™
);

155 
	`¿xP»v
(
¿xI‹¿tÜ
 *
™
);

156 
	`¿xRªdomW®k
(
¿xI‹¿tÜ
 *
™
, 
size_t
 
¡•s
);

157 
	`¿xCom·»
(
¿xI‹¿tÜ
 *
™”
, cÚ¡ *
İ
, *
key
, 
size_t
 
key_Ën
);

158 
	`¿xStİ
(
¿xI‹¿tÜ
 *
™
);

159 
	`¿xEOF
(
¿xI‹¿tÜ
 *
™
);

160 
	`¿xShow
(
¿x
 *rax);

161 
ušt64_t
 
	`¿xSize
(
¿x
 *rax);

	@src/rax_malloc.h

38 #iâdeà
RAX_ALLOC_H


39 
	#RAX_ALLOC_H


	)

40 
	~"zm®loc.h
"

41 
	#¿x_m®loc
 
zm®loc


	)

42 
	#¿x_»®loc
 
z»®loc


	)

43 
	#¿x_ä“
 
zä“


	)

	@src/rdb.c

30 
	~"£rv”.h
"

31 
	~"lzf.h
"

32 
	~"zm­.h
"

33 
	~"’dŸncÚv.h
"

35 
	~<fú.h
>

36 
	~<m©h.h
>

37 
	~<sys/ty³s.h
>

38 
	~<sys/time.h
>

39 
	~<sys/»sourû.h
>

40 
	~<sys/wa™.h
>

41 
	~<¬·/š‘.h
>

42 
	~<sys/¡©.h
>

43 
	~<sys/·¿m.h
>

45 
	#rdbEx™R•ÜtCÜru±RDB
(...è
	`rdbCheckTh’Ex™
(
__LINE__
,
__VA_ARGS__
)

	)

47 
rdbCheckMode
;

48 
rdbCheckE¼Ü
(cÚ¡ *
fmt
, ...);

49 
rdbCheckS‘E¼Ü
(cÚ¡ *
fmt
, ...);

51 
	$rdbCheckTh’Ex™
(
lš’um
, *
»asÚ
, ...) {

52 
va_li¡
 
­
;

53 
msg
[1024];

54 
Ën
;

56 
Ën
 = 
	`¢´štf
(
msg
,(msg),

57 "IÁ”ÇÈ”rÜ iÀRDB„—dšg funùiÚ‡ˆrdb.c:%d -> ", 
lš’um
);

58 
	`va_¡¬t
(
­
,
»asÚ
);

59 
	`v¢´štf
(
msg
+
Ën
,(msg)-Ën,
»asÚ
,
­
);

60 
	`va_’d
(
­
);

62 ià(!
rdbCheckMode
) {

63 
	`£rv”Log
(
LL_WARNING
, "%s", 
msg
);

64 *
¬gv
[2] = {"",
£rv”
.
rdb_f’ame
};

65 
	`»dis_check_rdb_maš
(2,
¬gv
,
NULL
);

67 
	`rdbCheckE¼Ü
("%s",
msg
);

69 
	`ex™
(1);

70 
	}
}

72 
	$rdbWr™eRaw
(
rio
 *
rdb
, *
p
, 
size_t
 
Ën
) {

73 ià(
rdb
 && 
	`rioWr™e
Ôdb,
p
,
Ën
) == 0)

75  
Ën
;

76 
	}
}

78 
	$rdbSaveTy³
(
rio
 *
rdb
, 
ty³
) {

79  
	`rdbWr™eRaw
(
rdb
,&
ty³
,1);

80 
	}
}

85 
	$rdbLßdTy³
(
rio
 *
rdb
) {

86 
ty³
;

87 ià(
	`rioR—d
(
rdb
,&
ty³
,1) == 0)  -1;

88  
ty³
;

89 
	}
}

91 
time_t
 
	$rdbLßdTime
(
rio
 *
rdb
) {

92 
št32_t
 
t32
;

93 ià(
	`rioR—d
(
rdb
,&
t32
,4) == 0)  -1;

94  (
time_t
)
t32
;

95 
	}
}

97 
	$rdbSaveMli£cÚdTime
(
rio
 *
rdb
, 
t
) {

98 
št64_t
 
t64
 = (št64_tè
t
;

99  
	`rdbWr™eRaw
(
rdb
,&
t64
,8);

100 
	}
}

102 
	$rdbLßdMli£cÚdTime
(
rio
 *
rdb
) {

103 
št64_t
 
t64
;

104 ià(
	`rioR—d
(
rdb
,&
t64
,8) == 0)  -1;

105  ()
t64
;

106 
	}
}

111 
	$rdbSaveL’
(
rio
 *
rdb
, 
ušt64_t
 
Ën
) {

112 
buf
[2];

113 
size_t
 
nwr™‹n
;

115 ià(
Ën
 < (1<<6)) {

117 
buf
[0] = (
Ën
&0xFF)|(
RDB_6BITLEN
<<6);

118 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,1) == -1)  -1;

119 
nwr™‹n
 = 1;

120 } ià(
Ën
 < (1<<14)) {

122 
buf
[0] = ((
Ën
>>8)&0xFF)|(
RDB_14BITLEN
<<6);

123 
buf
[1] = 
Ën
&0xFF;

124 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,2) == -1)  -1;

125 
nwr™‹n
 = 2;

126 } ià(
Ën
 <ğ
UINT32_MAX
) {

128 
buf
[0] = 
RDB_32BITLEN
;

129 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,1) == -1)  -1;

130 
ušt32_t
 
Ën32
 = 
	`htÚl
(
Ën
);

131 ià(
	`rdbWr™eRaw
(
rdb
,&
Ën32
,4) == -1)  -1;

132 
nwr™‹n
 = 1+4;

135 
buf
[0] = 
RDB_64BITLEN
;

136 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,1) == -1)  -1;

137 
Ën
 = 
	`htÚu64
(len);

138 ià(
	`rdbWr™eRaw
(
rdb
,&
Ën
,8) == -1)  -1;

139 
nwr™‹n
 = 1+8;

141  
nwr™‹n
;

142 
	}
}

154 
	$rdbLßdL’ByRef
(
rio
 *
rdb
, *
i£ncoded
, 
ušt64_t
 *
ËÅŒ
) {

155 
buf
[2];

156 
ty³
;

158 ià(
i£ncoded
) *isencoded = 0;

159 ià(
	`rioR—d
(
rdb
,
buf
,1) == 0)  -1;

160 
ty³
 = (
buf
[0]&0xC0)>>6;

161 ià(
ty³
 =ğ
RDB_ENCVAL
) {

163 ià(
i£ncoded
) *isencoded = 1;

164 *
ËÅŒ
 = 
buf
[0]&0x3F;

165 } ià(
ty³
 =ğ
RDB_6BITLEN
) {

167 *
ËÅŒ
 = 
buf
[0]&0x3F;

168 } ià(
ty³
 =ğ
RDB_14BITLEN
) {

170 ià(
	`rioR—d
(
rdb
,
buf
+1,1) == 0)  -1;

171 *
ËÅŒ
 = ((
buf
[0]&0x3F)<<8)|buf[1];

172 } ià(
buf
[0] =ğ
RDB_32BITLEN
) {

174 
ušt32_t
 
Ën
;

175 ià(
	`rioR—d
(
rdb
,&
Ën
,4) == 0)  -1;

176 *
ËÅŒ
 = 
	`Áohl
(
Ën
);

177 } ià(
buf
[0] =ğ
RDB_64BITLEN
) {

179 
ušt64_t
 
Ën
;

180 ià(
	`rioR—d
(
rdb
,&
Ën
,8) == 0)  -1;

181 *
ËÅŒ
 = 
	`Áohu64
(
Ën
);

183 
	`rdbEx™R•ÜtCÜru±RDB
(

184 "UnknowÀËngthƒncodšg %d iÀrdbLßdL’()",
ty³
);

188 
	}
}

194 
ušt64_t
 
	$rdbLßdL’
(
rio
 *
rdb
, *
i£ncoded
) {

195 
ušt64_t
 
Ën
;

197 ià(
	`rdbLßdL’ByRef
(
rdb
,
i£ncoded
,&
Ën
è=ğ-1è 
RDB_LENERR
;

198  
Ën
;

199 
	}
}

205 
	$rdbEncodeIÁeg”
(
v®ue
, *
’c
) {

206 ià(
v®ue
 >= -(1<<7) && value <= (1<<7)-1) {

207 
’c
[0] = (
RDB_ENCVAL
<<6)|
RDB_ENC_INT8
;

208 
’c
[1] = 
v®ue
&0xFF;

210 } ià(
v®ue
 >= -(1<<15) && value <= (1<<15)-1) {

211 
’c
[0] = (
RDB_ENCVAL
<<6)|
RDB_ENC_INT16
;

212 
’c
[1] = 
v®ue
&0xFF;

213 
’c
[2] = (
v®ue
>>8)&0xFF;

215 } ià(
v®ue
 >= -(()1<<31) && value <= (()1<<31)-1) {

216 
’c
[0] = (
RDB_ENCVAL
<<6)|
RDB_ENC_INT32
;

217 
’c
[1] = 
v®ue
&0xFF;

218 
’c
[2] = (
v®ue
>>8)&0xFF;

219 
’c
[3] = (
v®ue
>>16)&0xFF;

220 
’c
[4] = (
v®ue
>>24)&0xFF;

225 
	}
}

230 *
	$rdbLßdIÁeg”Objeù
(
rio
 *
rdb
, 
’ùy³
, 
æags
, 
size_t
 *
ËÅŒ
) {

231 
¶aš
 = 
æags
 & 
RDB_LOAD_PLAIN
;

232 
sds
 = 
æags
 & 
RDB_LOAD_SDS
;

233 
’code
 = 
æags
 & 
RDB_LOAD_ENC
;

234 
’c
[4];

235 
v®
;

237 ià(
’ùy³
 =ğ
RDB_ENC_INT8
) {

238 ià(
	`rioR—d
(
rdb
,
’c
,1è=ğ0è 
NULL
;

239 
v®
 = (sigÃd )
’c
[0];

240 } ià(
’ùy³
 =ğ
RDB_ENC_INT16
) {

241 
ušt16_t
 
v
;

242 ià(
	`rioR—d
(
rdb
,
’c
,2è=ğ0è 
NULL
;

243 
v
 = 
’c
[0]|(enc[1]<<8);

244 
v®
 = (
št16_t
)
v
;

245 } ià(
’ùy³
 =ğ
RDB_ENC_INT32
) {

246 
ušt32_t
 
v
;

247 ià(
	`rioR—d
(
rdb
,
’c
,4è=ğ0è 
NULL
;

248 
v
 = 
’c
[0]|(enc[1]<<8)|(enc[2]<<16)|(enc[3]<<24);

249 
v®
 = (
št32_t
)
v
;

251 
v®
 = 0;

252 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDB iÁeg”ƒncodšgy³ %d",
’ùy³
);

254 ià(
¶aš
 || 
sds
) {

255 
buf
[
LONG_STR_SIZE
], *
p
;

256 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
v®
);

257 ià(
ËÅŒ
è*ËÅŒ = 
Ën
;

258 
p
 = 
¶aš
 ? 
	`zm®loc
(
Ën
è: 
	`sd¢ewËn
(
NULL
,len);

259 
	`memıy
(
p
,
buf
,
Ën
);

260  
p
;

261 } ià(
’code
) {

262  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®
);

264  
	`ü—‹Objeù
(
OBJ_STRING
,
	`sdsäomlÚglÚg
(
v®
));

266 
	}
}

271 
	$rdbTryIÁeg”Encodšg
(*
s
, 
size_t
 
Ën
, *
’c
) {

272 
v®ue
;

273 *
’d±r
, 
buf
[32];

276 
v®ue
 = 
	`¡¹Şl
(
s
, &
’d±r
, 10);

277 ià(
’d±r
[0] != '\0')  0;

278 
	`Î2¡ršg
(
buf
,32,
v®ue
);

282 ià(
	`¡¾’
(
buf
è!ğ
Ën
 || 
	`memcmp
(buf,
s
,len))  0;

284  
	`rdbEncodeIÁeg”
(
v®ue
,
’c
);

285 
	}
}

287 
ssize_t
 
	$rdbSaveLzfBlob
(
rio
 *
rdb
, *
d©a
, 
size_t
 
com´ess_Ën
,

288 
size_t
 
Üigš®_Ën
) {

289 
by‹
;

290 
ssize_t
 
n
, 
nwr™‹n
 = 0;

293 
by‹
 = (
RDB_ENCVAL
<<6)|
RDB_ENC_LZF
;

294 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,&
by‹
,1)è=ğ-1è
wr™“¼
;

295 
nwr™‹n
 +ğ
n
;

297 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
com´ess_Ën
)è=ğ-1è
wr™“¼
;

298 
nwr™‹n
 +ğ
n
;

300 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
Üigš®_Ën
)è=ğ-1è
wr™“¼
;

301 
nwr™‹n
 +ğ
n
;

303 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,
d©a
,
com´ess_Ën
)è=ğ-1è
wr™“¼
;

304 
nwr™‹n
 +ğ
n
;

306  
nwr™‹n
;

308 
wr™“¼
:

310 
	}
}

312 
ssize_t
 
	$rdbSaveLzfSŒšgObjeù
(
rio
 *
rdb
, *
s
, 
size_t
 
Ën
) {

313 
size_t
 
com´Ën
, 
ou’
;

314 *
out
;

317 ià(
Ën
 <= 4)  0;

318 
ou’
 = 
Ën
-4;

319 ià((
out
 = 
	`zm®loc
(
ou’
+1)è=ğ
NULL
)  0;

320 
com´Ën
 = 
	`lzf_com´ess
(
s
, 
Ën
, 
out
, 
ou’
);

321 ià(
com´Ën
 == 0) {

322 
	`zä“
(
out
);

325 
ssize_t
 
nwr™‹n
 = 
	`rdbSaveLzfBlob
(
rdb
, 
out
, 
com´Ën
, 
Ën
);

326 
	`zä“
(
out
);

327  
nwr™‹n
;

328 
	}
}

333 *
	$rdbLßdLzfSŒšgObjeù
(
rio
 *
rdb
, 
æags
, 
size_t
 *
ËÅŒ
) {

334 
¶aš
 = 
æags
 & 
RDB_LOAD_PLAIN
;

335 
sds
 = 
æags
 & 
RDB_LOAD_SDS
;

336 
ušt64_t
 
Ën
, 
ş’
;

337 *
c
 = 
NULL
;

338 *
v®
 = 
NULL
;

340 ià((
ş’
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

341 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

342 ià((
c
 = 
	`zm®loc
(
ş’
)è=ğ
NULL
è
”r
;

345 ià(
¶aš
) {

346 
v®
 = 
	`zm®loc
(
Ën
);

347 ià(
ËÅŒ
è*ËÅŒ = 
Ën
;

349 
v®
 = 
	`sd¢ewËn
(
NULL
,
Ën
);

353 ià(
	`rioR—d
(
rdb
,
c
,
ş’
è=ğ0è
”r
;

354 ià(
	`lzf_decom´ess
(
c
,
ş’
,
v®
,
Ën
) == 0) {

355 ià(
rdbCheckMode
è
	`rdbCheckS‘E¼Ü
("Invalid LZF compressed string");

356 
”r
;

358 
	`zä“
(
c
);

360 ià(
¶aš
 || 
sds
) {

361  
v®
;

363  
	`ü—‹Objeù
(
OBJ_STRING
,
v®
);

365 
”r
:

366 
	`zä“
(
c
);

367 ià(
¶aš
)

368 
	`zä“
(
v®
);

370 
	`sdsä“
(
v®
);

371  
NULL
;

372 
	}
}

376 
ssize_t
 
	$rdbSaveRawSŒšg
(
rio
 *
rdb
, *
s
, 
size_t
 
Ën
) {

377 
’ş’
;

378 
ssize_t
 
n
, 
nwr™‹n
 = 0;

381 ià(
Ën
 <= 11) {

382 
buf
[5];

383 ià((
’ş’
 = 
	`rdbTryIÁeg”Encodšg
((*)
s
,
Ën
,
buf
)) > 0) {

384 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
) == -1)  -1;

385  
’ş’
;

391 ià(
£rv”
.
rdb_com´essiÚ
 && 
Ën
 > 20) {

392 
n
 = 
	`rdbSaveLzfSŒšgObjeù
(
rdb
,
s
,
Ën
);

393 ià(
n
 == -1)  -1;

394 ià(
n
 > 0) ‚;

399 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
Ën
)) == -1)  -1;

400 
nwr™‹n
 +ğ
n
;

401 ià(
Ën
 > 0) {

402 ià(
	`rdbWr™eRaw
(
rdb
,
s
,
Ën
) == -1)  -1;

403 
nwr™‹n
 +ğ
Ën
;

405  
nwr™‹n
;

406 
	}
}

409 
ssize_t
 
	$rdbSaveLÚgLÚgAsSŒšgObjeù
(
rio
 *
rdb
, 
v®ue
) {

410 
buf
[32];

411 
ssize_t
 
n
, 
nwr™‹n
 = 0;

412 
’ş’
 = 
	`rdbEncodeIÁeg”
(
v®ue
,
buf
);

413 ià(
’ş’
 > 0) {

414  
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
);

417 
’ş’
 = 
	`Î2¡ršg
((*)
buf
,32,
v®ue
);

418 
	`£rv”As£¹
(
’ş’
 < 32);

419 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
’ş’
)) == -1)  -1;

420 
nwr™‹n
 +ğ
n
;

421 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
)) == -1)  -1;

422 
nwr™‹n
 +ğ
n
;

424  
nwr™‹n
;

425 
	}
}

428 
ssize_t
 
	$rdbSaveSŒšgObjeù
(
rio
 *
rdb
, 
robj
 *
obj
) {

431 ià(
obj
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

432  
	`rdbSaveLÚgLÚgAsSŒšgObjeù
(
rdb
,()
obj
->
±r
);

434 
	`£rv”As£¹W™hInfo
(
NULL
,
obj
,
	`sdsEncodedObjeù
(obj));

435  
	`rdbSaveRawSŒšg
(
rdb
,
obj
->
±r
,
	`sd¦’
(obj->ptr));

437 
	}
}

452 *
	$rdbG’”icLßdSŒšgObjeù
(
rio
 *
rdb
, 
æags
, 
size_t
 *
ËÅŒ
) {

453 
’code
 = 
æags
 & 
RDB_LOAD_ENC
;

454 
¶aš
 = 
æags
 & 
RDB_LOAD_PLAIN
;

455 
sds
 = 
æags
 & 
RDB_LOAD_SDS
;

456 
i£ncoded
;

457 
ušt64_t
 
Ën
;

459 
Ën
 = 
	`rdbLßdL’
(
rdb
,&
i£ncoded
);

460 ià(
i£ncoded
) {

461 
Ën
) {

462 
RDB_ENC_INT8
:

463 
RDB_ENC_INT16
:

464 
RDB_ENC_INT32
:

465  
	`rdbLßdIÁeg”Objeù
(
rdb
,
Ën
,
æags
,
ËÅŒ
);

466 
RDB_ENC_LZF
:

467  
	`rdbLßdLzfSŒšgObjeù
(
rdb
,
æags
,
ËÅŒ
);

469 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDB sŒšgƒncodšgy³ %d",
Ën
);

473 ià(
Ën
 =ğ
RDB_LENERR
è 
NULL
;

474 ià(
¶aš
 || 
sds
) {

475 *
buf
 = 
¶aš
 ? 
	`zm®loc
(
Ën
è: 
	`sd¢ewËn
(
NULL
,len);

476 ià(
ËÅŒ
è*ËÅŒ = 
Ën
;

477 ià(
Ën
 && 
	`rioR—d
(
rdb
,
buf
,len) == 0) {

478 ià(
¶aš
)

479 
	`zä“
(
buf
);

481 
	`sdsä“
(
buf
);

482  
NULL
;

484  
buf
;

486 
robj
 *
o
 = 
’code
 ? 
	`ü—‹SŒšgObjeù
(
NULL
,
Ën
) :

487 
	`ü—‹RawSŒšgObjeù
(
NULL
,
Ën
);

488 ià(
Ën
 && 
	`rioR—d
(
rdb
,
o
->
±r
,len) == 0) {

489 
	`deüRefCouÁ
(
o
);

490  
NULL
;

492  
o
;

494 
	}
}

496 
robj
 *
	$rdbLßdSŒšgObjeù
(
rio
 *
rdb
) {

497  
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_NONE
,
NULL
);

498 
	}
}

500 
robj
 *
	$rdbLßdEncodedSŒšgObjeù
(
rio
 *
rdb
) {

501  
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_ENC
,
NULL
);

502 
	}
}

512 
	$rdbSaveDoubËV®ue
(
rio
 *
rdb
, 
v®
) {

513 
buf
[128];

514 
Ën
;

516 ià(
	`i¢ª
(
v®
)) {

517 
buf
[0] = 253;

518 
Ën
 = 1;

519 } ià(!
	`isfš™e
(
v®
)) {

520 
Ën
 = 1;

521 
buf
[0] = (
v®
 < 0) ? 255 : 254;

523 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

533 
mš
 = -4503599627370495;

534 
max
 = 4503599627370496;

535 ià(
v®
 > 
mš
 && v® < 
max
 && val == (()(()val)))

536 
	`Î2¡ršg
((*)
buf
+1,(buf)-1,()
v®
);

539 
	`¢´štf
((*)
buf
+1,(buf)-1,"%.17g",
v®
);

540 
buf
[0] = 
	`¡¾’
((*)buf+1);

541 
Ën
 = 
buf
[0]+1;

543  
	`rdbWr™eRaw
(
rdb
,
buf
,
Ën
);

544 
	}
}

547 
	$rdbLßdDoubËV®ue
(
rio
 *
rdb
, *
v®
) {

548 
buf
[256];

549 
Ën
;

551 ià(
	`rioR—d
(
rdb
,&
Ën
,1) == 0)  -1;

552 
Ën
) {

553 255: *
v®
 = 
R_NegInf
;  0;

554 254: *
v®
 = 
R_PosInf
;  0;

555 253: *
v®
 = 
R_Nª
;  0;

557 ià(
	`rioR—d
(
rdb
,
buf
,
Ën
) == 0)  -1;

558 
buf
[
Ën
] = '\0';

559 
	`ssÿnf
(
buf
, "%lg", 
v®
);

562 
	}
}

569 
	$rdbSaveBš¬yDoubËV®ue
(
rio
 *
rdb
, 
v®
) {

570 
	`mem»v64ifbe
(&
v®
);

571  
	`rdbWr™eRaw
(
rdb
,&
v®
,(val));

572 
	}
}

576 
	$rdbLßdBš¬yDoubËV®ue
(
rio
 *
rdb
, *
v®
) {

577 ià(
	`rioR—d
(
rdb
,
v®
,(*val)) == 0)  -1;

578 
	`mem»v64ifbe
(
v®
);

580 
	}
}

583 
	$rdbSaveBš¬yFlßtV®ue
(
rio
 *
rdb
, 
v®
) {

584 
	`mem»v32ifbe
(&
v®
);

585  
	`rdbWr™eRaw
(
rdb
,&
v®
,(val));

586 
	}
}

589 
	$rdbLßdBš¬yFlßtV®ue
(
rio
 *
rdb
, *
v®
) {

590 ià(
	`rioR—d
(
rdb
,
v®
,(*val)) == 0)  -1;

591 
	`mem»v32ifbe
(
v®
);

593 
	}
}

596 
	$rdbSaveObjeùTy³
(
rio
 *
rdb
, 
robj
 *
o
) {

597 
o
->
ty³
) {

598 
OBJ_STRING
:

599  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_STRING
);

600 
OBJ_LIST
:

601 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
)

602  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_LIST_QUICKLIST
);

604 
	`£rv”Pªic
("Unknown†istƒncoding");

605 
OBJ_SET
:

606 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
)

607  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_SET_INTSET
);

608 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

609  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_SET
);

611 
	`£rv”Pªic
("Unknown setƒncoding");

612 
OBJ_ZSET
:

613 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
)

614  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_ZSET_ZIPLIST
);

615 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
)

616  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_ZSET_2
);

618 
	`£rv”Pªic
("Unknown sorted setƒncoding");

619 
OBJ_HASH
:

620 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
)

621  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_HASH_ZIPLIST
);

622 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

623  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_HASH
);

625 
	`£rv”Pªic
("Unknown hashƒncoding");

626 
OBJ_MODULE
:

627  
	`rdbSaveTy³
(
rdb
,
RDB_TYPE_MODULE_2
);

629 
	`£rv”Pªic
("Unknown objectype");

632 
	}
}

636 
	$rdbLßdObjeùTy³
(
rio
 *
rdb
) {

637 
ty³
;

638 ià((
ty³
 = 
	`rdbLßdTy³
(
rdb
)) == -1)  -1;

639 ià(!
	`rdbIsObjeùTy³
(
ty³
))  -1;

640  
ty³
;

641 
	}
}

644 
ssize_t
 
	$rdbSaveObjeù
(
rio
 *
rdb
, 
robj
 *
o
) {

645 
ssize_t
 
n
 = 0, 
nwr™‹n
 = 0;

647 ià(
o
->
ty³
 =ğ
OBJ_STRING
) {

649 ià((
n
 = 
	`rdbSaveSŒšgObjeù
(
rdb
,
o
)) == -1)  -1;

650 
nwr™‹n
 +ğ
n
;

651 } ià(
o
->
ty³
 =ğ
OBJ_LIST
) {

653 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

654 
quickli¡
 *
ql
 = 
o
->
±r
;

655 
quickli¡Node
 *
node
 = 
ql
->
h—d
;

657 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
ql
->
Ën
)) == -1)  -1;

658 
nwr™‹n
 +ğ
n
;

660 
node
) {

661 ià(
	`quickli¡NodeIsCom´es£d
(
node
)) {

662 *
d©a
;

663 
size_t
 
com´ess_Ën
 = 
	`quickli¡G‘Lzf
(
node
, &
d©a
);

664 ià((
n
 = 
	`rdbSaveLzfBlob
(
rdb
,
d©a
,
com´ess_Ën
,
node
->
sz
)) == -1)  -1;

665 
nwr™‹n
 +ğ
n
;

667 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
node
->
zl
,node->
sz
)) == -1)  -1;

668 
nwr™‹n
 +ğ
n
;

670 
node
 =‚ode->
Ãxt
;

673 
	`£rv”Pªic
("Unknown†istƒncoding");

675 } ià(
o
->
ty³
 =ğ
OBJ_SET
) {

677 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

678 
diù
 *
£t
 = 
o
->
±r
;

679 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
£t
);

680 
diùEÁry
 *
de
;

682 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
	`diùSize
(
£t
))) == -1)  -1;

683 
nwr™‹n
 +ğ
n
;

685 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

686 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

687 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,(*)
–e
,
	`sd¦’
(ele)))

689 
nwr™‹n
 +ğ
n
;

691 
	`diùR–—£I‹¿tÜ
(
di
);

692 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

693 
size_t
 
l
 = 
	`št£tBlobL’
((
št£t
*)
o
->
±r
);

695 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

696 
nwr™‹n
 +ğ
n
;

698 
	`£rv”Pªic
("Unknown setƒncoding");

700 } ià(
o
->
ty³
 =ğ
OBJ_ZSET
) {

702 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

703 
size_t
 
l
 = 
	`zli¡BlobL’
((*)
o
->
±r
);

705 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

706 
nwr™‹n
 +ğ
n
;

707 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

708 
z£t
 *
zs
 = 
o
->
±r
;

709 
zskli¡
 *
z¦
 = 
zs
->zsl;

711 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
z¦
->
Ëngth
)) == -1)  -1;

712 
nwr™‹n
 +ğ
n
;

720 
zskli¡Node
 *
zn
 = 
z¦
->

;

721 
zn
 !ğ
NULL
) {

722 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,

723 (*)
zn
->
–e
,
	`sd¦’
(zn->ele))) == -1)

727 
nwr™‹n
 +ğ
n
;

728 ià((
n
 = 
	`rdbSaveBš¬yDoubËV®ue
(
rdb
,
zn
->
scÜe
)) == -1)

730 
nwr™‹n
 +ğ
n
;

731 
zn
 = zn->
backw¬d
;

734 
	`£rv”Pªic
("Unknown sorted setƒncoding");

736 } ià(
o
->
ty³
 =ğ
OBJ_HASH
) {

738 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

739 
size_t
 
l
 = 
	`zli¡BlobL’
((*)
o
->
±r
);

741 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

742 
nwr™‹n
 +ğ
n
;

744 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

745 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
o
->
±r
);

746 
diùEÁry
 *
de
;

748 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
	`diùSize
((
diù
*)
o
->
±r
))) == -1)  -1;

749 
nwr™‹n
 +ğ
n
;

751 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

752 
sds
 
f›ld
 = 
	`diùG‘Key
(
de
);

753 
sds
 
v®ue
 = 
	`diùG‘V®
(
de
);

755 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,(*)
f›ld
,

756 
	`sd¦’
(
f›ld
))) == -1)  -1;

757 
nwr™‹n
 +ğ
n
;

758 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,(*)
v®ue
,

759 
	`sd¦’
(
v®ue
))) == -1)  -1;

760 
nwr™‹n
 +ğ
n
;

762 
	`diùR–—£I‹¿tÜ
(
di
);

764 
	`£rv”Pªic
("Unknown hashƒncoding");

767 } ià(
o
->
ty³
 =ğ
OBJ_MODULE
) {

769 
RedisModuËIO
 
io
;

770 
moduËV®ue
 *
mv
 = 
o
->
±r
;

771 
moduËTy³
 *
mt
 = 
mv
->
ty³
;

772 
	`moduËIn™IOCÚ‹xt
(
io
,
mt
,
rdb
);

776 
»tv®
 = 
	`rdbSaveL’
(
rdb
,
mt
->
id
);

777 ià(
»tv®
 == -1)  -1;

778 
io
.
by‹s
 +ğ
»tv®
;

781 
mt
->
	`rdb_§ve
(&
io
,
mv
->
v®ue
);

782 
»tv®
 = 
	`rdbSaveL’
(
rdb
,
RDB_MODULE_OPCODE_EOF
);

783 ià(
»tv®
 == -1)  -1;

784 
io
.
by‹s
 +ğ
»tv®
;

786 ià(
io
.
ùx
) {

787 
	`moduËF»eCÚ‹xt
(
io
.
ùx
);

788 
	`zä“
(
io
.
ùx
);

790  
io
.
”rÜ
 ? -1 : (
ssize_t
)io.
by‹s
;

792 
	`£rv”Pªic
("Unknown objectype");

794  
nwr™‹n
;

795 
	}
}

801 
size_t
 
	$rdbSavedObjeùL’
(
robj
 *
o
) {

802 
ssize_t
 
Ën
 = 
	`rdbSaveObjeù
(
NULL
,
o
);

803 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,
Ën
 != -1);

804  
Ën
;

805 
	}
}

811 
	$rdbSaveKeyV®uePaœ
(
rio
 *
rdb
, 
robj
 *
key
,„obj *
v®
, 
expœ‘ime
)

814 ià(
expœ‘ime
 != -1) {

815 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_EXPIRETIME_MS
) == -1)  -1;

816 ià(
	`rdbSaveMli£cÚdTime
(
rdb
,
expœ‘ime
) == -1)  -1;

820 ià(
	`rdbSaveObjeùTy³
(
rdb
,
v®
) == -1)  -1;

821 ià(
	`rdbSaveSŒšgObjeù
(
rdb
,
key
) == -1)  -1;

822 ià(
	`rdbSaveObjeù
(
rdb
,
v®
) == -1)  -1;

824 
	}
}

827 
ssize_t
 
	$rdbSaveAuxF›ld
(
rio
 *
rdb
, *
key
, 
size_t
 
keyËn
, *
v®
, size_ˆ
v®Ën
) {

828 
ssize_t
 
»t
, 
Ën
 = 0;

829 ià((
»t
 = 
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_AUX
)) == -1)  -1;

830 
Ën
 +ğ
»t
;

831 ià((
»t
 = 
	`rdbSaveRawSŒšg
(
rdb
,
key
,
keyËn
)) == -1)  -1;

832 
Ën
 +ğ
»t
;

833 ià((
»t
 = 
	`rdbSaveRawSŒšg
(
rdb
,
v®
,
v®Ën
)) == -1)  -1;

834 
Ën
 +ğ
»t
;

835  
Ën
;

836 
	}
}

840 
ssize_t
 
	$rdbSaveAuxF›ldSŒSŒ
(
rio
 *
rdb
, *
key
, *
v®
) {

841  
	`rdbSaveAuxF›ld
(
rdb
,
key
,
	`¡¾’
(key),
v®
,strlen(val));

842 
	}
}

845 
ssize_t
 
	$rdbSaveAuxF›ldSŒIÁ
(
rio
 *
rdb
, *
key
, 
v®
) {

846 
buf
[
LONG_STR_SIZE
];

847 
vËn
 = 
	`Î2¡ršg
(
buf
,(buf),
v®
);

848  
	`rdbSaveAuxF›ld
(
rdb
,
key
,
	`¡¾’
(key),
buf
,
vËn
);

849 
	}
}

852 
	$rdbSaveInfoAuxF›lds
(
rio
 *
rdb
, 
æags
, 
rdbSaveInfo
 *
rsi
) {

853 
»dis_b™s
 = ((*) == 8) ? 64 : 32;

854 
aof_´—mbË
 = (
æags
 & 
RDB_SAVE_AOF_PREAMBLE
) != 0;

857 ià(
	`rdbSaveAuxF›ldSŒSŒ
(
rdb
,"»dis-v”",
REDIS_VERSION
) == -1)  -1;

858 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"»dis-b™s",
»dis_b™s
) == -1)  -1;

859 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"ùime",
	`time
(
NULL
)) == -1)  -1;

860 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"u£d-mem",
	`zm®loc_u£d_memÜy
()) == -1)  -1;

863 ià(
rsi
) {

864 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"»¶-¡»am-db",
rsi
->
»¶_¡»am_db
)

866 ià(
	`rdbSaveAuxF›ldSŒSŒ
(
rdb
,"»¶-id",
£rv”
.
»¶id
)

868 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"»¶-off£t",
£rv”
.
ma¡”_»¶_off£t
)

871 ià(
	`rdbSaveAuxF›ldSŒIÁ
(
rdb
,"aof-´—mbË",
aof_´—mbË
) == -1)  -1;

873 
	}
}

883 
	$rdbSaveRio
(
rio
 *
rdb
, *
”rÜ
, 
æags
, 
rdbSaveInfo
 *
rsi
) {

884 
diùI‹¿tÜ
 *
di
 = 
NULL
;

885 
diùEÁry
 *
de
;

886 
magic
[10];

887 
j
;

888 
ušt64_t
 
cksum
;

889 
size_t
 
´oûs£d
 = 0;

891 ià(
£rv”
.
rdb_checksum
)

892 
rdb
->
upd©e_cksum
 = 
rioG’”icUpd©eChecksum
;

893 
	`¢´štf
(
magic
,(magic),"REDIS%04d",
RDB_VERSION
);

894 ià(
	`rdbWr™eRaw
(
rdb
,
magic
,9è=ğ-1è
w”r
;

895 ià(
	`rdbSaveInfoAuxF›lds
(
rdb
,
æags
,
rsi
è=ğ-1è
w”r
;

897 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

898 
»disDb
 *
db
 = 
£rv”
.db+
j
;

899 
diù
 *
d
 = 
db
->dict;

900 ià(
	`diùSize
(
d
) == 0) ;

901 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
d
);

902 ià(!
di
è 
C_ERR
;

905 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_SELECTDB
è=ğ-1è
w”r
;

906 ià(
	`rdbSaveL’
(
rdb
,
j
è=ğ-1è
w”r
;

912 
ušt32_t
 
db_size
, 
expœes_size
;

913 
db_size
 = (
	`diùSize
(
db
->
diù
è<ğ
UINT32_MAX
) ?

914 
	`diùSize
(
db
->
diù
) :

915 
UINT32_MAX
;

916 
expœes_size
 = (
	`diùSize
(
db
->
expœes
è<ğ
UINT32_MAX
) ?

917 
	`diùSize
(
db
->
expœes
) :

918 
UINT32_MAX
;

919 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_RESIZEDB
è=ğ-1è
w”r
;

920 ià(
	`rdbSaveL’
(
rdb
,
db_size
è=ğ-1è
w”r
;

921 ià(
	`rdbSaveL’
(
rdb
,
expœes_size
è=ğ-1è
w”r
;

924 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

925 
sds
 
key¡r
 = 
	`diùG‘Key
(
de
);

926 
robj
 
key
, *
o
 = 
	`diùG‘V®
(
de
);

927 
expœe
;

929 
	`š™SticSŒšgObjeù
(
key
,
key¡r
);

930 
expœe
 = 
	`g‘Expœe
(
db
,&
key
);

931 ià(
	`rdbSaveKeyV®uePaœ
(
rdb
,&
key
,
o
,
expœe
è=ğ-1è
w”r
;

936 ià(
æags
 & 
RDB_SAVE_AOF_PREAMBLE
 &&

937 
rdb
->
´oûs£d_by‹s
 > 
´oûs£d
+
AOF_READ_DIFF_INTERVAL_BYTES
)

939 
´oûs£d
 = 
rdb
->
´oûs£d_by‹s
;

940 
	`aofR—dDiffFromP¬’t
();

943 
	`diùR–—£I‹¿tÜ
(
di
);

945 
di
 = 
NULL
;

951 ià(
rsi
 && 
	`diùSize
(
£rv”
.
lua_süts
)) {

952 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
lua_süts
);

953 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

954 
robj
 *
body
 = 
	`diùG‘V®
(
de
);

955 ià(
	`rdbSaveAuxF›ld
(
rdb
,"lua",3,
body
->
±r
,
	`sd¦’
(body->ptr)) == -1)

956 
w”r
;

958 
	`diùR–—£I‹¿tÜ
(
di
);

962 ià(
	`rdbSaveTy³
(
rdb
,
RDB_OPCODE_EOF
è=ğ-1è
w”r
;

966 
cksum
 = 
rdb
->cksum;

967 
	`mem»v64ifbe
(&
cksum
);

968 ià(
	`rioWr™e
(
rdb
,&
cksum
,8è=ğ0è
w”r
;

969  
C_OK
;

971 
w”r
:

972 ià(
”rÜ
è*”rÜ = 
”ºo
;

973 ià(
di
è
	`diùR–—£I‹¿tÜ
(di);

974  
C_ERR
;

975 
	}
}

985 
	$rdbSaveRioW™hEOFM¬k
(
rio
 *
rdb
, *
”rÜ
, 
rdbSaveInfo
 *
rsi
) {

986 
eofm¬k
[
RDB_EOF_MARK_SIZE
];

988 
	`g‘RªdomHexCh¬s
(
eofm¬k
,
RDB_EOF_MARK_SIZE
);

989 ià(
”rÜ
) *error = 0;

990 ià(
	`rioWr™e
(
rdb
,"$EOF:",5è=ğ0è
w”r
;

991 ià(
	`rioWr™e
(
rdb
,
eofm¬k
,
RDB_EOF_MARK_SIZE
è=ğ0è
w”r
;

992 ià(
	`rioWr™e
(
rdb
,"\r\n",2è=ğ0è
w”r
;

993 ià(
	`rdbSaveRio
(
rdb
,
”rÜ
,
RDB_SAVE_NONE
,
rsi
è=ğ
C_ERR
è
w”r
;

994 ià(
	`rioWr™e
(
rdb
,
eofm¬k
,
RDB_EOF_MARK_SIZE
è=ğ0è
w”r
;

995  
C_OK
;

997 
w”r
:

999 ià(
”rÜ
 && *”rÜ =ğ0è*”rÜ = 
”ºo
;

1000  
C_ERR
;

1001 
	}
}

1004 
	$rdbSave
(*
f’ame
, 
rdbSaveInfo
 *
rsi
) {

1005 
tmpfe
[256];

1006 
cwd
[
MAXPATHLEN
];

1007 
FILE
 *
å
, *
å2
;

1008 
fd
;

1009 
rio
 
rdb
;

1010 
”rÜ
 = 0;

1012 
	`¢´štf
(
tmpfe
,256,"‹mp-%d.rdb", (è
	`g‘pid
());

1013 
	`´štf
("%s: c®lšg fİ’ h”e\n", 
__func__
);

1015 
å
 = 
	`fİ’
(
tmpfe
, "w+");

1017 ià(!
å
) {

1018 *
cwdp
 = 
	`g‘cwd
(
cwd
,
MAXPATHLEN
);

1019 
	`£rv”Log
(
LL_WARNING
,

1022 
f’ame
,

1023 
cwdp
 ? cwdp : "unknown",

1024 
	`¡»¼Ü
(
”ºo
));

1025  
C_ERR
;

1028 
	`rioIn™W™hFe
(&
rdb
,
å
);

1029 ià(
	`rdbSaveRio
(&
rdb
,&
”rÜ
,
RDB_SAVE_NONE
,
rsi
è=ğ
C_ERR
) {

1030 
”ºo
 = 
”rÜ
;

1031 
w”r
;

1035 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

1036 
	`´štf
("%s: došg fsynøw™h fd = %d\n", 
__func__
, 
	`f’o
(
å
));

1037 ià(
	`fsync
(
	`f’o
(
å
)) == -1) {

1038 
	`´štf
("%s: fsynøçed!, fd = %d\n", 
__func__
, 
	`f’o
(
å
));

1039 
w”r
;

1041 
	`´štf
("%s: closšg fw™h fd = %d\n", 
__func__
, 
	`f’o
(
å
));

1042 ià(
	`fşo£
(
å
è=ğ
EOF
è
w”r
;

1046 ià(
	`»Çme
(
tmpfe
,
f’ame
) == -1) {

1047 *
cwdp
 = 
	`g‘cwd
(
cwd
,
MAXPATHLEN
);

1048 
	`£rv”Log
(
LL_WARNING
,

1051 
tmpfe
,

1052 
f’ame
,

1053 
cwdp
 ? cwdp : "unknown",

1054 
	`¡»¼Ü
(
”ºo
));

1055 
	`uÆšk
(
tmpfe
);

1056  
C_ERR
;

1059 
	`£rv”Log
(
LL_NOTICE
,"DB saved on disk");

1060 
£rv”
.
dœty
 = 0;

1061 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

1062 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_OK
;

1063  
C_OK
;

1065 
w”r
:

1066 
	`£rv”Log
(
LL_WARNING
,"Wr™”rÜ savšg DB oÀdisk: %s", 
	`¡»¼Ü
(
”ºo
));

1067 
	`fşo£
(
å
);

1068 
	`uÆšk
(
tmpfe
);

1069  
C_ERR
;

1070 
	}
}

1072 
	$rdbSaveBackground
(*
f’ame
, 
rdbSaveInfo
 *
rsi
) {

1073 
pid_t
 
chdpid
;

1074 
¡¬t
;

1076 ià(
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 !ğ-1è 
C_ERR
;

1078 
£rv”
.
dœty_befÜe_bg§ve
 = s”v”.
dœty
;

1079 
£rv”
.
Ï¡bg§ve_Œy
 = 
	`time
(
NULL
);

1080 
	`İ’ChdInfoPe
();

1082 
¡¬t
 = 
	`u¡ime
();

1083 ià((
chdpid
 = 
	`fÜk
()) == 0) {

1084 
»tv®
;

1087 
	`şo£Li¡’šgSock‘s
(0);

1088 
	`»disS‘ProcT™Ë
("redis-rdb-bgsave");

1089 
»tv®
 = 
	`rdbSave
(
f’ame
,
rsi
);

1090 ià(
»tv®
 =ğ
C_OK
) {

1091 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
(-1);

1093 ià(
´iv©e_dœty
) {

1094 
	`£rv”Log
(
LL_NOTICE
,

1096 
´iv©e_dœty
/(1024*1024));

1099 
£rv”
.
chd_šfo_d©a
.
cow_size
 = 
´iv©e_dœty
;

1100 
	`£ndChdInfo
(
CHILD_INFO_TYPE_RDB
);

1102 
	`ex™FromChd
((
»tv®
 =ğ
C_OK
) ? 0 : 1);

1105 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

1106 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

1107 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

1108 ià(
chdpid
 == -1) {

1109 
	`şo£ChdInfoPe
();

1110 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_ERR
;

1111 
	`£rv”Log
(
LL_WARNING
,"Can't save in background: fork: %s",

1112 
	`¡»¼Ü
(
”ºo
));

1113  
C_ERR
;

1115 
	`£rv”Log
(
LL_NOTICE
,"Background savšg s¹ed by…id %d",
chdpid
);

1116 
£rv”
.
rdb_§ve_time_¡¬t
 = 
	`time
(
NULL
);

1117 
£rv”
.
rdb_chd_pid
 = 
chdpid
;

1118 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_DISK
;

1119 
	`upd©eDiùResizePŞicy
();

1120  
C_OK
;

1122  
C_OK
;

1123 
	}
}

1125 
	$rdbRemoveTempFe
(
pid_t
 
chdpid
) {

1126 
tmpfe
[256];

1128 
	`¢´štf
(
tmpfe
,Ñmpfe),"‹mp-%d.rdb", (è
chdpid
);

1129 
	`uÆšk
(
tmpfe
);

1130 
	}
}

1136 
robj
 *
	$rdbLßdCheckModuËV®ue
(
rio
 *
rdb
, *
moduËÇme
) {

1137 
ušt64_t
 
İcode
;

1138 (
İcode
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è!ğ
RDB_MODULE_OPCODE_EOF
) {

1139 ià(
İcode
 =ğ
RDB_MODULE_OPCODE_SINT
 ||

1140 
İcode
 =ğ
RDB_MODULE_OPCODE_UINT
)

1142 
ušt64_t
 
Ën
;

1143 ià(
	`rdbLßdL’ByRef
(
rdb
,
NULL
,&
Ën
) == -1) {

1144 
	`rdbEx™R•ÜtCÜru±RDB
(

1145 "E¼Ü„—dšg iÁeg” from moduË % v®ue", 
moduËÇme
);

1147 } ià(
İcode
 =ğ
RDB_MODULE_OPCODE_STRING
) {

1148 
robj
 *
o
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_NONE
,
NULL
);

1149 ià(
o
 =ğ
NULL
) {

1150 
	`rdbEx™R•ÜtCÜru±RDB
(

1151 "E¼Ü„—dšg sŒšg from moduË % v®ue", 
moduËÇme
);

1153 
	`deüRefCouÁ
(
o
);

1154 } ià(
İcode
 =ğ
RDB_MODULE_OPCODE_FLOAT
) {

1155 
v®
;

1156 ià(
	`rdbLßdBš¬yFlßtV®ue
(
rdb
,&
v®
) == -1) {

1157 
	`rdbEx™R•ÜtCÜru±RDB
(

1158 "E¼Ü„—dšg flßˆäom moduË % v®ue", 
moduËÇme
);

1160 } ià(
İcode
 =ğ
RDB_MODULE_OPCODE_DOUBLE
) {

1161 
v®
;

1162 ià(
	`rdbLßdBš¬yDoubËV®ue
(
rdb
,&
v®
) == -1) {

1163 
	`rdbEx™R•ÜtCÜru±RDB
(

1164 "E¼Ü„—dšg doubË from moduË % v®ue", 
moduËÇme
);

1168  
	`ü—‹SŒšgObjeù
("module-dummy-value",18);

1169 
	}
}

1173 
robj
 *
	$rdbLßdObjeù
(
rdbty³
, 
rio
 *
rdb
) {

1174 
robj
 *
o
 = 
NULL
, *
–e
, *
dec
;

1175 
ušt64_t
 
Ën
;

1176 
i
;

1178 ià(
rdbty³
 =ğ
RDB_TYPE_STRING
) {

1180 ià((
o
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
)è=ğ
NULL
)  NULL;

1181 
o
 = 
	`ŒyObjeùEncodšg
(o);

1182 } ià(
rdbty³
 =ğ
RDB_TYPE_LIST
) {

1184 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1186 
o
 = 
	`ü—‹Quickli¡Objeù
();

1187 
	`quickli¡S‘O±iÚs
(
o
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

1188 
£rv”
.
li¡_com´ess_d•th
);

1191 
Ën
--) {

1192 ià((
–e
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
)è=ğ
NULL
)  NULL;

1193 
dec
 = 
	`g‘DecodedObjeù
(
–e
);

1194 
size_t
 
Ën
 = 
	`sd¦’
(
dec
->
±r
);

1195 
	`quickli¡PushTa
(
o
->
±r
, 
dec
->±r, 
Ën
);

1196 
	`deüRefCouÁ
(
dec
);

1197 
	`deüRefCouÁ
(
–e
);

1199 } ià(
rdbty³
 =ğ
RDB_TYPE_SET
) {

1201 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1204 ià(
Ën
 > 
£rv”
.
£t_max_št£t_’Œ›s
) {

1205 
o
 = 
	`ü—‹S‘Objeù
();

1208 ià(
Ën
 > 
DICT_HT_INITIAL_SIZE
)

1209 
	`diùEx·nd
(
o
->
±r
,
Ën
);

1211 
o
 = 
	`ü—‹IÁ£tObjeù
();

1215 
i
 = 0; i < 
Ën
; i++) {

1216 
Îv®
;

1217 
sds
 
sd£Ë
;

1219 ià((
sd£Ë
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1220 =ğ
NULL
)  NULL;

1222 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1224 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
sd£Ë
,&
Îv®
è=ğ
C_OK
) {

1225 
o
->
±r
 = 
	`št£tAdd
(o->±r,
Îv®
,
NULL
);

1227 
	`£tTy³CÚv”t
(
o
,
OBJ_ENCODING_HT
);

1228 
	`diùEx·nd
(
o
->
±r
,
Ën
);

1234 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1235 
	`diùAdd
((
diù
*)
o
->
±r
,
sd£Ë
,
NULL
);

1237 
	`sdsä“
(
sd£Ë
);

1240 } ià(
rdbty³
 =ğ
RDB_TYPE_ZSET_2
 ||„dbty³ =ğ
RDB_TYPE_ZSET
) {

1242 
ušt64_t
 
z£’
;

1243 
size_t
 
max––’
 = 0;

1244 
z£t
 *
zs
;

1246 ià((
z£’
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1247 
o
 = 
	`ü—‹Z£tObjeù
();

1248 
zs
 = 
o
->
±r
;

1251 
z£’
--) {

1252 
sds
 
sd£Ë
;

1253 
scÜe
;

1254 
zskli¡Node
 *
znode
;

1256 ià((
sd£Ë
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1257 =ğ
NULL
)  NULL;

1259 ià(
rdbty³
 =ğ
RDB_TYPE_ZSET_2
) {

1260 ià(
	`rdbLßdBš¬yDoubËV®ue
(
rdb
,&
scÜe
è=ğ-1è 
NULL
;

1262 ià(
	`rdbLßdDoubËV®ue
(
rdb
,&
scÜe
è=ğ-1è 
NULL
;

1266 ià(
	`sd¦’
(
sd£Ë
è> 
max––’
) maxelelen = sdslen(sdsele);

1268 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
sd£Ë
);

1269 
	`diùAdd
(
zs
->
diù
,
sd£Ë
,&
znode
->
scÜe
);

1273 ià(
	`z£tL’gth
(
o
è<ğ
£rv”
.
z£t_max_zli¡_’Œ›s
 &&

1274 
max––’
 <ğ
£rv”
.
z£t_max_zli¡_v®ue
)

1275 
	`z£tCÚv”t
(
o
,
OBJ_ENCODING_ZIPLIST
);

1276 } ià(
rdbty³
 =ğ
RDB_TYPE_HASH
) {

1277 
ušt64_t
 
Ën
;

1278 
»t
;

1279 
sds
 
f›ld
, 
v®ue
;

1281 
Ën
 = 
	`rdbLßdL’
(
rdb
, 
NULL
);

1282 ià(
Ën
 =ğ
RDB_LENERR
è 
NULL
;

1284 
o
 = 
	`ü—‹HashObjeù
();

1287 ià(
Ën
 > 
£rv”
.
hash_max_zli¡_’Œ›s
)

1288 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1291 
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
 && 
Ën
 > 0) {

1292 
Ën
--;

1294 ià((
f›ld
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1295 =ğ
NULL
)  NULL;

1296 ià((
v®ue
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1297 =ğ
NULL
)  NULL;

1300 
o
->
±r
 = 
	`zli¡Push
(o->±r, (*)
f›ld
,

1301 
	`sd¦’
(
f›ld
), 
ZIPLIST_TAIL
);

1302 
o
->
±r
 = 
	`zli¡Push
(o->±r, (*)
v®ue
,

1303 
	`sd¦’
(
v®ue
), 
ZIPLIST_TAIL
);

1306 ià(
	`sd¦’
(
f›ld
è> 
£rv”
.
hash_max_zli¡_v®ue
 ||

1307 
	`sd¦’
(
v®ue
è> 
£rv”
.
hash_max_zli¡_v®ue
)

1309 
	`sdsä“
(
f›ld
);

1310 
	`sdsä“
(
v®ue
);

1311 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1314 
	`sdsä“
(
f›ld
);

1315 
	`sdsä“
(
v®ue
);

1319 
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
 && 
Ën
 > 0) {

1320 
Ën
--;

1322 ià((
f›ld
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1323 =ğ
NULL
)  NULL;

1324 ià((
v®ue
 = 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_SDS
,
NULL
))

1325 =ğ
NULL
)  NULL;

1328 
»t
 = 
	`diùAdd
((
diù
*)
o
->
±r
, 
f›ld
, 
v®ue
);

1329 ià(
»t
 =ğ
DICT_ERR
) {

1330 
	`rdbEx™R•ÜtCÜru±RDB
("Duplicate keys detected");

1335 
	`£rv”As£¹
(
Ën
 == 0);

1336 } ià(
rdbty³
 =ğ
RDB_TYPE_LIST_QUICKLIST
) {

1337 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)  NULL;

1338 
o
 = 
	`ü—‹Quickli¡Objeù
();

1339 
	`quickli¡S‘O±iÚs
(
o
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

1340 
£rv”
.
li¡_com´ess_d•th
);

1342 
Ën
--) {

1343 *
zl
 =

1344 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_PLAIN
,
NULL
);

1345 ià(
zl
 =ğ
NULL
)  NULL;

1346 
	`quickli¡Aµ’dZli¡
(
o
->
±r
, 
zl
);

1348 } ià(
rdbty³
 =ğ
RDB_TYPE_HASH_ZIPMAP
 ||

1349 
rdbty³
 =ğ
RDB_TYPE_LIST_ZIPLIST
 ||

1350 
rdbty³
 =ğ
RDB_TYPE_SET_INTSET
 ||

1351 
rdbty³
 =ğ
RDB_TYPE_ZSET_ZIPLIST
 ||

1352 
rdbty³
 =ğ
RDB_TYPE_HASH_ZIPLIST
)

1354 *
’coded
 =

1355 
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,
RDB_LOAD_PLAIN
,
NULL
);

1356 ià(
’coded
 =ğ
NULL
)  NULL;

1357 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
’coded
);

1365 
rdbty³
) {

1366 
RDB_TYPE_HASH_ZIPMAP
:

1370 *
zl
 = 
	`zli¡New
();

1371 *
zi
 = 
	`zm­Rewšd
(
o
->
±r
);

1372 *
f¡r
, *
v¡r
;

1373 
æ’
, 
vËn
;

1374 
maxËn
 = 0;

1376 (
zi
 = 
	`zm­Next
(zi, &
f¡r
, &
æ’
, &
v¡r
, &
vËn
)è!ğ
NULL
) {

1377 ià(
æ’
 > 
maxËn
) maxlen = flen;

1378 ià(
vËn
 > 
maxËn
) maxlen = vlen;

1379 
zl
 = 
	`zli¡Push
(zl, 
f¡r
, 
æ’
, 
ZIPLIST_TAIL
);

1380 
zl
 = 
	`zli¡Push
(zl, 
v¡r
, 
vËn
, 
ZIPLIST_TAIL
);

1383 
	`zä“
(
o
->
±r
);

1384 
o
->
±r
 = 
zl
;

1385 
o
->
ty³
 = 
OBJ_HASH
;

1386 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1388 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
 ||

1389 
maxËn
 > 
£rv”
.
hash_max_zli¡_v®ue
)

1391 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1395 
RDB_TYPE_LIST_ZIPLIST
:

1396 
o
->
ty³
 = 
OBJ_LIST
;

1397 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1398 
	`li¡Ty³CÚv”t
(
o
,
OBJ_ENCODING_QUICKLIST
);

1400 
RDB_TYPE_SET_INTSET
:

1401 
o
->
ty³
 = 
OBJ_SET
;

1402 
o
->
’codšg
 = 
OBJ_ENCODING_INTSET
;

1403 ià(
	`št£tL’
(
o
->
±r
è> 
£rv”
.
£t_max_št£t_’Œ›s
)

1404 
	`£tTy³CÚv”t
(
o
,
OBJ_ENCODING_HT
);

1406 
RDB_TYPE_ZSET_ZIPLIST
:

1407 
o
->
ty³
 = 
OBJ_ZSET
;

1408 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1409 ià(
	`z£tL’gth
(
o
è> 
£rv”
.
z£t_max_zli¡_’Œ›s
)

1410 
	`z£tCÚv”t
(
o
,
OBJ_ENCODING_SKIPLIST
);

1412 
RDB_TYPE_HASH_ZIPLIST
:

1413 
o
->
ty³
 = 
OBJ_HASH
;

1414 
o
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1415 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
)

1416 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

1419 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDBƒncodšgy³ %d",
rdbty³
);

1422 } ià(
rdbty³
 =ğ
RDB_TYPE_MODULE
 ||„dbty³ =ğ
RDB_TYPE_MODULE_2
) {

1423 
ušt64_t
 
moduËid
 = 
	`rdbLßdL’
(
rdb
,
NULL
);

1424 
moduËTy³
 *
mt
 = 
	`moduËTy³LookupModuËByID
(
moduËid
);

1425 
Çme
[10];

1427 ià(
rdbCheckMode
 && 
rdbty³
 =ğ
RDB_TYPE_MODULE_2
)

1428  
	`rdbLßdCheckModuËV®ue
(
rdb
,
Çme
);

1430 ià(
mt
 =ğ
NULL
) {

1431 
	`moduËTy³NameByID
(
Çme
,
moduËid
);

1432 
	`£rv”Log
(
LL_WARNING
,"ThRDB fcÚš moduË d©¨I cª'ˆlßd:‚Øm©chšg moduË '%s'", 
Çme
);

1433 
	`ex™
(1);

1435 
RedisModuËIO
 
io
;

1436 
	`moduËIn™IOCÚ‹xt
(
io
,
mt
,
rdb
);

1437 
io
.
v”
 = (
rdbty³
 =ğ
RDB_TYPE_MODULE
) ? 1 : 2;

1440 *
±r
 = 
mt
->
	`rdb_lßd
(&
io
,
moduËid
&1023);

1441 ià(
io
.
ùx
) {

1442 
	`moduËF»eCÚ‹xt
(
io
.
ùx
);

1443 
	`zä“
(
io
.
ùx
);

1447 ià(
io
.
v”
 == 2) {

1448 
ušt64_t
 
eof
 = 
	`rdbLßdL’
(
rdb
,
NULL
);

1449 ià(
eof
 !ğ
RDB_MODULE_OPCODE_EOF
) {

1450 
	`£rv”Log
(
LL_WARNING
,"ThRDB fcÚš moduË d©¨fÜhmoduË '%s'h© i nÙ”mš©ed byh´İ” moduË v®uEOF m¬k”", 
Çme
);

1451 
	`ex™
(1);

1455 ià(
±r
 =ğ
NULL
) {

1456 
	`moduËTy³NameByID
(
Çme
,
moduËid
);

1457 
	`£rv”Log
(
LL_WARNING
,"ThRDB fcÚš moduË d©¨fÜhmoduËy³ '%s',h©h»¥ÚsibË moduË i nÙ‡bËØlßd. Check fÜ moduË log‡bovfÜ‡dd™iÚ® clues.", 
Çme
);

1458 
	`ex™
(1);

1460 
o
 = 
	`ü—‹ModuËObjeù
(
mt
,
±r
);

1462 
	`rdbEx™R•ÜtCÜru±RDB
("UnknowÀRDBƒncodšgy³ %d",
rdbty³
);

1464  
o
;

1465 
	}
}

1469 
	$¡¬tLßdšg
(
FILE
 *
å
) {

1470 
¡©
 
sb
;

1473 
£rv”
.
lßdšg
 = 1;

1474 
£rv”
.
lßdšg_¡¬t_time
 = 
	`time
(
NULL
);

1475 
£rv”
.
lßdšg_lßded_by‹s
 = 0;

1476 ià(
	`f¡©
(
	`f’o
(
å
), &
sb
) == -1) {

1477 
£rv”
.
lßdšg_tÙ®_by‹s
 = 0;

1479 
£rv”
.
lßdšg_tÙ®_by‹s
 = 
sb
.
¡_size
;

1481 
	}
}

1484 
	$lßdšgProg»ss
(
off_t
 
pos
) {

1485 
£rv”
.
lßdšg_lßded_by‹s
 = 
pos
;

1486 ià(
£rv”
.
¡©_³ak_memÜy
 < 
	`zm®loc_u£d_memÜy
())

1487 
£rv”
.
¡©_³ak_memÜy
 = 
	`zm®loc_u£d_memÜy
();

1488 
	}
}

1491 
	$¡İLßdšg
() {

1492 
£rv”
.
lßdšg
 = 0;

1493 
	}
}

1497 
	$rdbLßdProg»ssC®lback
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

1498 ià(
£rv”
.
rdb_checksum
)

1499 
	`rioG’”icUpd©eChecksum
(
r
, 
buf
, 
Ën
);

1500 ià(
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 &&

1501 (
r
->
´oûs£d_by‹s
 + 
Ën
)/
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 >„->processed_bytes/server.loading_process_events_interval_bytes)

1506 
	`upd©eCachedTime
();

1507 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
)

1508 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

1509 
	`lßdšgProg»ss
(
r
->
´oûs£d_by‹s
);

1510 
	`´oûssEv’tsWheBlocked
();

1512 
	}
}

1516 
	$rdbLßdRio
(
rio
 *
rdb
, 
rdbSaveInfo
 *
rsi
, 
lßdšg_aof
) {

1517 
ušt64_t
 
dbid
;

1518 
ty³
, 
rdbv”
;

1519 
»disDb
 *
db
 = 
£rv”
.db+0;

1520 
buf
[1024];

1521 
expœ‘ime
, 
now
 = 
	`m¡ime
();

1523 
rdb
->
upd©e_cksum
 = 
rdbLßdProg»ssC®lback
;

1524 
rdb
->
max_´oûssšg_chunk
 = 
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
;

1525 ià(
	`rioR—d
(
rdb
,
buf
,9è=ğ0è
eoã¼
;

1526 
buf
[9] = '\0';

1527 ià(
	`memcmp
(
buf
,"REDIS",5) != 0) {

1528 
	`£rv”Log
(
LL_WARNING
,"Wrong signatureryingo†oad DB from file");

1529 
”ºo
 = 
EINVAL
;

1530  
C_ERR
;

1532 
rdbv”
 = 
	`©oi
(
buf
+5);

1533 ià(
rdbv”
 < 1 ||„dbv” > 
RDB_VERSION
) {

1534 
	`£rv”Log
(
LL_WARNING
,"Cª'ˆhªdË RDB fÜm© v”siÚ %d",
rdbv”
);

1535 
”ºo
 = 
EINVAL
;

1536  
C_ERR
;

1540 
robj
 *
key
, *
v®
;

1541 
expœ‘ime
 = -1;

1544 ià((
ty³
 = 
	`rdbLßdTy³
(
rdb
)è=ğ-1è
eoã¼
;

1547 ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME
) {

1551 ià((
expœ‘ime
 = 
	`rdbLßdTime
(
rdb
)è=ğ-1è
eoã¼
;

1553 ià((
ty³
 = 
	`rdbLßdTy³
(
rdb
)è=ğ-1è
eoã¼
;

1556 
expœ‘ime
 *= 1000;

1557 } ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME_MS
) {

1560 ià((
expœ‘ime
 = 
	`rdbLßdMli£cÚdTime
(
rdb
)è=ğ-1è
eoã¼
;

1562 ià((
ty³
 = 
	`rdbLßdTy³
(
rdb
)è=ğ-1è
eoã¼
;

1563 } ià(
ty³
 =ğ
RDB_OPCODE_EOF
) {

1566 } ià(
ty³
 =ğ
RDB_OPCODE_SELECTDB
) {

1568 ià((
dbid
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)

1569 
eoã¼
;

1570 ià(
dbid
 >ğ()
£rv”
.
dbnum
) {

1571 
	`£rv”Log
(
LL_WARNING
,

1574 "d©aba£s. Ex™šg\n", 
£rv”
.
dbnum
);

1575 
	`ex™
(1);

1577 
db
 = 
£rv”
.db+
dbid
;

1579 } ià(
ty³
 =ğ
RDB_OPCODE_RESIZEDB
) {

1582 
ušt64_t
 
db_size
, 
expœes_size
;

1583 ià((
db_size
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)

1584 
eoã¼
;

1585 ià((
expœes_size
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
RDB_LENERR
)

1586 
eoã¼
;

1587 
	`diùEx·nd
(
db
->
diù
,
db_size
);

1588 
	`diùEx·nd
(
db
->
expœes
,
expœes_size
);

1590 } ià(
ty³
 =ğ
RDB_OPCODE_AUX
) {

1596 
robj
 *
auxkey
, *
auxv®
;

1597 ià((
auxkey
 = 
	`rdbLßdSŒšgObjeù
(
rdb
)è=ğ
NULL
è
eoã¼
;

1598 ià((
auxv®
 = 
	`rdbLßdSŒšgObjeù
(
rdb
)è=ğ
NULL
è
eoã¼
;

1600 ià(((*)
auxkey
->
±r
)[0] == '%') {

1604 
	`£rv”Log
(
LL_NOTICE
,"RDB '%s': %s",

1605 (*)
auxkey
->
±r
,

1606 (*)
auxv®
->
±r
);

1607 } ià(!
	`¡rÿ£cmp
(
auxkey
->
±r
,"repl-stream-db")) {

1608 ià(
rsi
èrsi->
»¶_¡»am_db
 = 
	`©oi
(
auxv®
->
±r
);

1609 } ià(!
	`¡rÿ£cmp
(
auxkey
->
±r
,"repl-id")) {

1610 ià(
rsi
 && 
	`sd¦’
(
auxv®
->
±r
è=ğ
CONFIG_RUN_ID_SIZE
) {

1611 
	`memıy
(
rsi
->
»¶_id
,
auxv®
->
±r
,
CONFIG_RUN_ID_SIZE
+1);

1612 
rsi
->
»¶_id_is_£t
 = 1;

1614 } ià(!
	`¡rÿ£cmp
(
auxkey
->
±r
,"repl-offset")) {

1615 ià(
rsi
èrsi->
»¶_off£t
 = 
	`¡¹Şl
(
auxv®
->
±r
,
NULL
,10);

1616 } ià(!
	`¡rÿ£cmp
(
auxkey
->
±r
,"lua")) {

1618 ià(
	`luaC»©eFunùiÚ
(
NULL
,
£rv”
.
lua
,
auxv®
) == NULL) {

1619 
	`rdbEx™R•ÜtCÜru±RDB
(

1621 "BODY: %s", 
auxv®
->
±r
);

1626 
	`£rv”Log
(
LL_DEBUG
,"Unrecognized RDB AUX field: '%s'",

1627 (*)
auxkey
->
±r
);

1630 
	`deüRefCouÁ
(
auxkey
);

1631 
	`deüRefCouÁ
(
auxv®
);

1636 ià((
key
 = 
	`rdbLßdSŒšgObjeù
(
rdb
)è=ğ
NULL
è
eoã¼
;

1638 ià((
v®
 = 
	`rdbLßdObjeù
(
ty³
,
rdb
)è=ğ
NULL
è
eoã¼
;

1644 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 && !
lßdšg_aof
 && 
expœ‘ime
 !ğ-1 &&ƒxpœ‘im< 
now
) {

1645 
	`deüRefCouÁ
(
key
);

1646 
	`deüRefCouÁ
(
v®
);

1650 
	`dbAdd
(
db
,
key
,
v®
);

1653 ià(
expœ‘ime
 !ğ-1è
	`£tExpœe
(
NULL
,
db
,
key
,expiretime);

1655 
	`deüRefCouÁ
(
key
);

1658 ià(
rdbv”
 >= 5) {

1659 
ušt64_t
 
cksum
, 
ex³ùed
 = 
rdb
->cksum;

1661 ià(
	`rioR—d
(
rdb
,&
cksum
,8è=ğ0è
eoã¼
;

1662 ià(
£rv”
.
rdb_checksum
) {

1663 
	`mem»v64ifbe
(&
cksum
);

1664 ià(
cksum
 == 0) {

1665 
	`£rv”Log
(
LL_WARNING
,"RDB file was saved with checksum disabled:‚o check…erformed.");

1666 } ià(
cksum
 !ğ
ex³ùed
) {

1667 
	`£rv”Log
(
LL_WARNING
,"Wrong RDB checksum. Aborting‚ow.");

1668 
	`rdbEx™R•ÜtCÜru±RDB
("RDB CRCƒrror");

1672  
C_OK
;

1674 
eoã¼
:

1675 
	`£rv”Log
(
LL_WARNING
,"Short„ead or OOM†oading DB. Unrecoverableƒrror,‡borting‚ow.");

1676 
	`rdbEx™R•ÜtCÜru±RDB
("Unexpected EOF„eading RDB file");

1677  
C_ERR
;

1678 
	}
}

1687 
	$rdbLßd
(*
f’ame
, 
rdbSaveInfo
 *
rsi
) {

1688 
FILE
 *
å
;

1689 
rio
 
rdb
;

1690 
»tv®
;

1692 ià((
å
 = 
	`fİ’
(
f’ame
,"r")è=ğ
NULL
è 
C_ERR
;

1693 
	`¡¬tLßdšg
(
å
);

1694 
	`rioIn™W™hFe
(&
rdb
,
å
);

1695 
»tv®
 = 
	`rdbLßdRio
(&
rdb
,
rsi
,0);

1696 
	`fşo£
(
å
);

1697 
	`¡İLßdšg
();

1698  
»tv®
;

1699 
	}
}

1703 
	$backgroundSaveDÚeHªdËrDisk
(
ex™code
, 
bysigÇl
) {

1704 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1705 
	`£rv”Log
(
LL_NOTICE
,

1707 
£rv”
.
dœty
 = s”v”.dœty - s”v”.
dœty_befÜe_bg§ve
;

1708 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

1709 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_OK
;

1710 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1711 
	`£rv”Log
(
LL_WARNING
, "Background savingƒrror");

1712 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_ERR
;

1714 
m¡ime_t
 
Ï‹ncy
;

1716 
	`£rv”Log
(
LL_WARNING
,

1717 "Background savšg”mš©ed by sigÇÈ%d", 
bysigÇl
);

1718 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1719 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

1720 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1721 
	`Ï‹ncyAddSam¶eIfN“ded
("rdb-uÆšk-‹mp-fe",
Ï‹ncy
);

1724 ià(
bysigÇl
 !ğ
SIGUSR1
)

1725 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_ERR
;

1727 
£rv”
.
rdb_chd_pid
 = -1;

1728 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_NONE
;

1729 
£rv”
.
rdb_§ve_time_Ï¡
 = 
	`time
(
NULL
)-£rv”.
rdb_§ve_time_¡¬t
;

1730 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1733 
	`upd©eSÏvesWa™šgBg§ve
((!
bysigÇl
 && 
ex™code
 =ğ0è? 
C_OK
 : 
C_ERR
, 
RDB_CHILD_TYPE_DISK
);

1734 
	}
}

1739 
	$backgroundSaveDÚeHªdËrSock‘
(
ex™code
, 
bysigÇl
) {

1740 
ušt64_t
 *
ok_¦aves
;

1742 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1743 
	`£rv”Log
(
LL_NOTICE
,

1745 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1746 
	`£rv”Log
(
LL_WARNING
, "Backgroundransferƒrror");

1748 
	`£rv”Log
(
LL_WARNING
,

1749 "Background¿nsã¸‹rmš©ed by sigÇÈ%d", 
bysigÇl
);

1751 
£rv”
.
rdb_chd_pid
 = -1;

1752 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_NONE
;

1753 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1762 
ok_¦aves
 = 
	`zm®loc
((
ušt64_t
));

1763 
ok_¦aves
[0] = 0;

1764 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1765 
»adËn
 = (
ušt64_t
);

1767 ià(
	`»ad
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
, 
ok_¦aves
, 
»adËn
) ==

1768 
»adËn
)

1770 
»adËn
 = 
ok_¦aves
[0]*(
ušt64_t
)*2;

1774 
ok_¦aves
 = 
	`z»®loc
(ok_¦aves,(
ušt64_t
)+
»adËn
);

1775 ià(
»adËn
 &&

1776 
	`»ad
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
, 
ok_¦aves
+1,

1777 
»adËn
) !=„eadlen)

1779 
ok_¦aves
[0] = 0;

1784 
	`şo£
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
);

1785 
	`şo£
(
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
);

1789 
li¡Node
 *
Ê
;

1790 
li¡I‹r
 
li
;

1792 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1793 (
Ê
 = 
	`li¡Next
(&
li
))) {

1794 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1796 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
) {

1797 
ušt64_t
 
j
;

1798 
”rÜcode
 = 0;

1803 
j
 = 0; j < 
ok_¦aves
[0]; j++) {

1804 ià(
¦ave
->
id
 =ğ
ok_¦aves
[2*
j
+1]) {

1805 
”rÜcode
 = 
ok_¦aves
[2*
j
+2];

1809 ià(
j
 =ğ
ok_¦aves
[0] || 
”rÜcode
 != 0) {

1810 
	`£rv”Log
(
LL_WARNING
,

1812 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
),

1813 (
”rÜcode
 == 0) ? "RDBransfer child‡borted"

1814 : 
	`¡»¼Ü
(
”rÜcode
));

1815 
	`ä“Cl›Á
(
¦ave
);

1817 
	`£rv”Log
(
LL_WARNING
,

1819 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

1821 
	`ª‘NÚBlock
(
NULL
,
¦ave
->
fd
);

1822 
	`ª‘S’dTimeout
(
NULL
,
¦ave
->
fd
,0);

1826 
	`zä“
(
ok_¦aves
);

1828 
	`upd©eSÏvesWa™šgBg§ve
((!
bysigÇl
 && 
ex™code
 =ğ0è? 
C_OK
 : 
C_ERR
, 
RDB_CHILD_TYPE_SOCKET
);

1829 
	}
}

1832 
	$backgroundSaveDÚeHªdËr
(
ex™code
, 
bysigÇl
) {

1833 
£rv”
.
rdb_chd_ty³
) {

1834 
RDB_CHILD_TYPE_DISK
:

1835 
	`backgroundSaveDÚeHªdËrDisk
(
ex™code
,
bysigÇl
);

1837 
RDB_CHILD_TYPE_SOCKET
:

1838 
	`backgroundSaveDÚeHªdËrSock‘
(
ex™code
,
bysigÇl
);

1841 
	`£rv”Pªic
("Unknown RDB childype.");

1844 
	}
}

1848 
	$rdbSaveToSÏvesSock‘s
(
rdbSaveInfo
 *
rsi
) {

1849 *
fds
;

1850 
ušt64_t
 *
ş›Áids
;

1851 
numfds
;

1852 
li¡Node
 *
Ê
;

1853 
li¡I‹r
 
li
;

1854 
pid_t
 
chdpid
;

1855 
¡¬t
;

1856 
pefds
[2];

1858 ià(
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 !ğ-1è 
C_ERR
;

1863 ià(
	`pe
(
pefds
è=ğ-1è 
C_ERR
;

1864 
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
 = 
pefds
[0];

1865 
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
 = 
pefds
[1];

1869 
fds
 = 
	`zm®loc
(()*
	`li¡L’gth
(
£rv”
.
¦aves
));

1873 
ş›Áids
 = 
	`zm®loc
((
ušt64_t
)*
	`li¡L’gth
(
£rv”
.
¦aves
));

1874 
numfds
 = 0;

1876 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1877 (
Ê
 = 
	`li¡Next
(&
li
))) {

1878 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1880 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

1881 
ş›Áids
[
numfds
] = 
¦ave
->
id
;

1882 
fds
[
numfds
++] = 
¦ave
->
fd
;

1883 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
¦ave
,
	`g‘PsyncIn™ŸlOff£t
());

1887 
	`ª‘Block
(
NULL
,
¦ave
->
fd
);

1888 
	`ª‘S’dTimeout
(
NULL
,
¦ave
->
fd
,
£rv”
.
»¶_timeout
*1000);

1893 
	`İ’ChdInfoPe
();

1894 
¡¬t
 = 
	`u¡ime
();

1895 ià((
chdpid
 = 
	`fÜk
()) == 0) {

1897 
»tv®
;

1898 
rio
 
¦ave_sock‘s
;

1900 
	`rioIn™W™hFd£t
(&
¦ave_sock‘s
,
fds
,
numfds
);

1901 
	`zä“
(
fds
);

1903 
	`şo£Li¡’šgSock‘s
(0);

1904 
	`»disS‘ProcT™Ë
("redis-rdb-to-slaves");

1906 
»tv®
 = 
	`rdbSaveRioW™hEOFM¬k
(&
¦ave_sock‘s
,
NULL
,
rsi
);

1907 ià(
»tv®
 =ğ
C_OK
 && 
	`rioFlush
(&
¦ave_sock‘s
) == 0)

1908 
»tv®
 = 
C_ERR
;

1910 ià(
»tv®
 =ğ
C_OK
) {

1911 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
(-1);

1913 ià(
´iv©e_dœty
) {

1914 
	`£rv”Log
(
LL_NOTICE
,

1916 
´iv©e_dœty
/(1024*1024));

1919 
£rv”
.
chd_šfo_d©a
.
cow_size
 = 
´iv©e_dœty
;

1920 
	`£ndChdInfo
(
CHILD_INFO_TYPE_RDB
);

1937 *
msg
 = 
	`zm®loc
((
ušt64_t
)*(1+2*
numfds
));

1938 
ušt64_t
 *
Ën
 = 
msg
;

1939 
ušt64_t
 *
ids
 = 
Ën
+1;

1940 
j
, 
msgËn
;

1942 *
Ën
 = 
numfds
;

1943 
j
 = 0; j < 
numfds
; j++) {

1944 *
ids
++ = 
ş›Áids
[
j
];

1945 *
ids
++ = 
¦ave_sock‘s
.
io
.
fd£t
.
¡©e
[
j
];

1952 
msgËn
 = (
ušt64_t
)*(1+2*
numfds
);

1953 ià(*
Ën
 == 0 ||

1954 
	`wr™e
(
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
,
msg
,
msgËn
)

1955 !ğ
msgËn
)

1957 
»tv®
 = 
C_ERR
;

1959 
	`zä“
(
msg
);

1961 
	`zä“
(
ş›Áids
);

1962 
	`rioF»eFd£t
(&
¦ave_sock‘s
);

1963 
	`ex™FromChd
((
»tv®
 =ğ
C_OK
) ? 0 : 1);

1966 ià(
chdpid
 == -1) {

1967 
	`£rv”Log
(
LL_WARNING
,"Can't save in background: fork: %s",

1968 
	`¡»¼Ü
(
”ºo
));

1973 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1974 (
Ê
 = 
	`li¡Next
(&
li
))) {

1975 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1976 
j
;

1978 
j
 = 0; j < 
numfds
; j++) {

1979 ià(
¦ave
->
id
 =ğ
ş›Áids
[
j
]) {

1980 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_START
;

1985 
	`şo£
(
pefds
[0]);

1986 
	`şo£
(
pefds
[1]);

1987 
	`şo£ChdInfoPe
();

1989 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

1990 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

1991 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

1993 
	`£rv”Log
(
LL_NOTICE
,"Background RDBransfer started by…id %d",

1994 
chdpid
);

1995 
£rv”
.
rdb_§ve_time_¡¬t
 = 
	`time
(
NULL
);

1996 
£rv”
.
rdb_chd_pid
 = 
chdpid
;

1997 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_SOCKET
;

1998 
	`upd©eDiùResizePŞicy
();

2000 
	`zä“
(
ş›Áids
);

2001 
	`zä“
(
fds
);

2002  (
chdpid
 =ğ-1è? 
C_ERR
 : 
C_OK
;

2004  
C_OK
;

2005 
	}
}

2007 
	$§veCommªd
(
ş›Á
 *
c
) {

2008 ià(
£rv”
.
rdb_chd_pid
 != -1) {

2009 
	`addR•lyE¼Ü
(
c
,"Background save‡lready in…rogress");

2012 
rdbSaveInfo
 
rsi
, *
rsŒ
;

2013 
rsŒ
 = 
	`rdbPİuÏ‹SaveInfo
(&
rsi
);

2014 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
,
rsŒ
è=ğ
C_OK
) {

2015 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2017 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

2019 
	}
}

2022 
	$bg§veCommªd
(
ş›Á
 *
c
) {

2023 
scheduË
 = 0;

2027 ià(
c
->
¬gc
 > 1) {

2028 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"schedule")) {

2029 
scheduË
 = 1;

2031 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2036 
rdbSaveInfo
 
rsi
, *
rsŒ
;

2037 
rsŒ
 = 
	`rdbPİuÏ‹SaveInfo
(&
rsi
);

2039 ià(
£rv”
.
rdb_chd_pid
 != -1) {

2040 
	`addR•lyE¼Ü
(
c
,"Background save‡lready in…rogress");

2041 } ià(
£rv”
.
aof_chd_pid
 != -1) {

2042 ià(
scheduË
) {

2043 
£rv”
.
rdb_bg§ve_scheduËd
 = 1;

2044 
	`addR•lyStus
(
c
,"Background saving scheduled");

2046 
	`addR•lyE¼Ü
(
c
,

2051 } ià(
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
,
rsŒ
è=ğ
C_OK
) {

2052 
	`addR•lyStus
(
c
,"Background saving started");

2054 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

2056 
	}
}

2067 
rdbSaveInfo
 *
	$rdbPİuÏ‹SaveInfo
(
rdbSaveInfo
 *
rsi
) {

2068 
rdbSaveInfo
 
rsi_š™
 = 
RDB_SAVE_INFO_INIT
;

2069 *
rsi
 = 
rsi_š™
;

2078 ià(!
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_backlog
) {

2084 
rsi
->
»¶_¡»am_db
 = 
£rv”
.
¦ave£ldb
 == -1 ? 0 : server.slaveseldb;

2085  
rsi
;

2090 ià(
£rv”
.
ma¡”
) {

2091 
rsi
->
»¶_¡»am_db
 = 
£rv”
.
ma¡”
->
db
->
id
;

2092  
rsi
;

2100 ià(
£rv”
.
ÿched_ma¡”
) {

2101 
rsi
->
»¶_¡»am_db
 = 
£rv”
.
ÿched_ma¡”
->
db
->
id
;

2102  
rsi
;

2104  
NULL
;

2105 
	}
}

	@src/rdb.h

30 #iâdeà
__RDB_H


31 
	#__RDB_H


	)

33 
	~<¡dio.h
>

34 
	~"rio.h
"

37 
	~"£rv”.h
"

41 
	#RDB_VERSION
 8

	)

57 
	#RDB_6BITLEN
 0

	)

58 
	#RDB_14BITLEN
 1

	)

59 
	#RDB_32BITLEN
 0x80

	)

60 
	#RDB_64BITLEN
 0x81

	)

61 
	#RDB_ENCVAL
 3

	)

62 
	#RDB_LENERR
 
UINT64_MAX


	)

67 
	#RDB_ENC_INT8
 0

	)

68 
	#RDB_ENC_INT16
 1

	)

69 
	#RDB_ENC_INT32
 2

	)

70 
	#RDB_ENC_LZF
 3

	)

74 
	#RDB_TYPE_STRING
 0

	)

75 
	#RDB_TYPE_LIST
 1

	)

76 
	#RDB_TYPE_SET
 2

	)

77 
	#RDB_TYPE_ZSET
 3

	)

78 
	#RDB_TYPE_HASH
 4

	)

79 
	#RDB_TYPE_ZSET_2
 5

	)

80 
	#RDB_TYPE_MODULE
 6

	)

81 
	#RDB_TYPE_MODULE_2
 7

	)

86 
	#RDB_TYPE_HASH_ZIPMAP
 9

	)

87 
	#RDB_TYPE_LIST_ZIPLIST
 10

	)

88 
	#RDB_TYPE_SET_INTSET
 11

	)

89 
	#RDB_TYPE_ZSET_ZIPLIST
 12

	)

90 
	#RDB_TYPE_HASH_ZIPLIST
 13

	)

91 
	#RDB_TYPE_LIST_QUICKLIST
 14

	)

95 
	#rdbIsObjeùTy³
(
t
è(Ñ >ğ0 && <ğ7è|| (ˆ>ğ9 && <ğ14))

	)

98 
	#RDB_OPCODE_AUX
 250

	)

99 
	#RDB_OPCODE_RESIZEDB
 251

	)

100 
	#RDB_OPCODE_EXPIRETIME_MS
 252

	)

101 
	#RDB_OPCODE_EXPIRETIME
 253

	)

102 
	#RDB_OPCODE_SELECTDB
 254

	)

103 
	#RDB_OPCODE_EOF
 255

	)

106 
	#RDB_MODULE_OPCODE_EOF
 0

	)

107 
	#RDB_MODULE_OPCODE_SINT
 1

	)

108 
	#RDB_MODULE_OPCODE_UINT
 2

	)

109 
	#RDB_MODULE_OPCODE_FLOAT
 3

	)

110 
	#RDB_MODULE_OPCODE_DOUBLE
 4

	)

111 
	#RDB_MODULE_OPCODE_STRING
 5

	)

114 
	#RDB_LOAD_NONE
 0

	)

115 
	#RDB_LOAD_ENC
 (1<<0)

	)

116 
	#RDB_LOAD_PLAIN
 (1<<1)

	)

117 
	#RDB_LOAD_SDS
 (1<<2)

	)

119 
	#RDB_SAVE_NONE
 0

	)

120 
	#RDB_SAVE_AOF_PREAMBLE
 (1<<0)

	)

122 
rdbSaveTy³
(
rio
 *
rdb
, 
ty³
);

123 
rdbLßdTy³
(
rio
 *
rdb
);

124 
rdbSaveTime
(
rio
 *
rdb
, 
time_t
 
t
);

125 
time_t
 
rdbLßdTime
(
rio
 *
rdb
);

126 
rdbSaveL’
(
rio
 *
rdb
, 
ušt64_t
 
Ën
);

127 
ušt64_t
 
rdbLßdL’
(
rio
 *
rdb
, *
i£ncoded
);

128 
rdbLßdL’ByRef
(
rio
 *
rdb
, *
i£ncoded
, 
ušt64_t
 *
ËÅŒ
);

129 
rdbSaveObjeùTy³
(
rio
 *
rdb
, 
robj
 *
o
);

130 
rdbLßdObjeùTy³
(
rio
 *
rdb
);

131 
rdbLßd
(*
f’ame
, 
rdbSaveInfo
 *
rsi
);

132 
rdbSaveBackground
(*
f’ame
, 
rdbSaveInfo
 *
rsi
);

133 
rdbSaveToSÏvesSock‘s
(
rdbSaveInfo
 *
rsi
);

134 
rdbRemoveTempFe
(
pid_t
 
chdpid
);

135 
rdbSave
(*
f’ame
, 
rdbSaveInfo
 *
rsi
);

136 
ssize_t
 
rdbSaveObjeù
(
rio
 *
rdb
, 
robj
 *
o
);

137 
size_t
 
rdbSavedObjeùL’
(
robj
 *
o
);

138 
robj
 *
rdbLßdObjeù
(
ty³
, 
rio
 *
rdb
);

139 
backgroundSaveDÚeHªdËr
(
ex™code
, 
bysigÇl
);

140 
rdbSaveKeyV®uePaœ
(
rio
 *
rdb
, 
robj
 *
key
,„obj *
v®
, 
expœ‘ime
);

141 
robj
 *
rdbLßdSŒšgObjeù
(
rio
 *
rdb
);

142 
ssize_t
 
rdbSaveSŒšgObjeù
(
rio
 *
rdb
, 
robj
 *
obj
);

143 
ssize_t
 
rdbSaveRawSŒšg
(
rio
 *
rdb
, *
s
, 
size_t
 
Ën
);

144 *
rdbG’”icLßdSŒšgObjeù
(
rio
 *
rdb
, 
æags
, 
size_t
 *
ËÅŒ
);

145 
rdbSaveBš¬yDoubËV®ue
(
rio
 *
rdb
, 
v®
);

146 
rdbLßdBš¬yDoubËV®ue
(
rio
 *
rdb
, *
v®
);

147 
rdbSaveBš¬yFlßtV®ue
(
rio
 *
rdb
, 
v®
);

148 
rdbLßdBš¬yFlßtV®ue
(
rio
 *
rdb
, *
v®
);

149 
rdbLßdRio
(
rio
 *
rdb
, 
rdbSaveInfo
 *
rsi
, 
lßdšg_aof
);

150 
rdbSaveInfo
 *
rdbPİuÏ‹SaveInfo
ÔdbSaveInfØ*
rsi
);

	@src/redis-benchmark.c

31 
	~"fmaüos.h
"

33 
	~<¡dio.h
>

34 
	~<¡ršg.h
>

35 
	~<¡dlib.h
>

36 
	~<uni¡d.h
>

37 
	~<”ºo.h
>

38 
	~<time.h
>

39 
	~<sys/time.h
>

40 
	~<sigÇl.h
>

41 
	~<as£¹.h
>

43 
	~<sds.h
>

44 
	~"«.h
"

45 
	~"hœedis.h
"

46 
	~"adli¡.h
"

47 
	~"zm®loc.h
"

49 
	#UNUSED
(
V
è((èV)

	)

50 
	#RANDPTR_INITIAL_SIZE
 8

	)

52 
	scÚfig
 {

53 
«Ev’tLoİ
 *
	m–
;

54 cÚ¡ *
	mho¡
;

55 
	mho¡pÜt
;

56 cÚ¡ *
	mho¡sock‘
;

57 
	mnumş›Ás
;

58 
	mliveş›Ás
;

59 
	m»que¡s
;

60 
	m»que¡s_issued
;

61 
	m»que¡s_fšished
;

62 
	mkeysize
;

63 
	md©asize
;

64 
	m¿ndomkeys
;

65 
	m¿ndomkeys_key¥aûËn
;

66 
	mk“·live
;

67 
	mp–še
;

68 
	mshow”rÜs
;

69 
	m¡¬t
;

70 
	mtÙÏ‹ncy
;

71 *
	mÏ‹ncy
;

72 cÚ¡ *
	mt™Ë
;

73 
li¡
 *
	mş›Ás
;

74 
	mqu›t
;

75 
	mcsv
;

76 
	mloİ
;

77 
	midËmode
;

78 
	mdbnum
;

79 
sds
 
	mdbnum¡r
;

80 *
	m‹¡s
;

81 *
	mauth
;

82 } 
	gcÚfig
;

84 
	s_ş›Á
 {

85 
»disCÚ‹xt
 *
	mcÚ‹xt
;

86 
sds
 
	mobuf
;

87 **
	m¿nd±r
;

88 
size_t
 
	m¿ndËn
;

89 
size_t
 
	m¿ndä“
;

90 
size_t
 
	mwr™‹n
;

91 
	m¡¬t
;

92 
	mÏ‹ncy
;

93 
	m³ndšg
;

94 
	m´efix_³ndšg
;

97 
	m´efixËn
;

98 } *
	tş›Á
;

101 
wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

102 
ü—‹MissšgCl›Ás
(
ş›Á
 
c
);

105 
	$u¡ime
() {

106 
timev®
 
tv
;

107 
u¡
;

109 
	`g‘timeofday
(&
tv
, 
NULL
);

110 
u¡
 = (()
tv
.
tv_£c
)*1000000;

111 
u¡
 +ğ
tv
.
tv_u£c
;

112  
u¡
;

113 
	}
}

115 
	$m¡ime
() {

116 
timev®
 
tv
;

117 
m¡
;

119 
	`g‘timeofday
(&
tv
, 
NULL
);

120 
m¡
 = (()
tv
.
tv_£c
)*1000;

121 
m¡
 +ğ
tv
.
tv_u£c
/1000;

122  
m¡
;

123 
	}
}

125 
	$ä“Cl›Á
(
ş›Á
 
c
) {

126 
li¡Node
 *
Ê
;

127 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

128 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
);

129 
	`»disF»e
(
c
->
cÚ‹xt
);

130 
	`sdsä“
(
c
->
obuf
);

131 
	`zä“
(
c
->
¿nd±r
);

132 
	`zä“
(
c
);

133 
cÚfig
.
liveş›Ás
--;

134 
Ê
 = 
	`li¡S—rchKey
(
cÚfig
.
ş›Ás
,
c
);

135 
	`as£¹
(
Ê
 !ğ
NULL
);

136 
	`li¡D–Node
(
cÚfig
.
ş›Ás
,
Ê
);

137 
	}
}

139 
	$ä“AÎCl›Ás
() {

140 
li¡Node
 *
Ê
 = 
cÚfig
.
ş›Ás
->
h—d
, *
Ãxt
;

142 
Ê
) {

143 
Ãxt
 = 
Ê
->next;

144 
	`ä“Cl›Á
(
Ê
->
v®ue
);

145 
Ê
 = 
Ãxt
;

147 
	}
}

149 
	$»£tCl›Á
(
ş›Á
 
c
) {

150 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

151 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
);

152 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

153 
c
->
wr™‹n
 = 0;

154 
c
->
³ndšg
 = 
cÚfig
.
p–še
;

155 
	}
}

157 
	$¿ndomizeCl›ÁKey
(
ş›Á
 
c
) {

158 
size_t
 
i
;

160 
i
 = 0; i < 
c
->
¿ndËn
; i++) {

161 *
p
 = 
c
->
¿nd±r
[
i
]+11;

162 
size_t
 
r
 = 
	`¿ndom
(è% 
cÚfig
.
¿ndomkeys_key¥aûËn
;

163 
size_t
 
j
;

165 
j
 = 0; j < 12; j++) {

166 *
p
 = '0'+
r
%10;

167 
r
/=10;

168 
p
--;

171 
	}
}

173 
	$ş›ÁDÚe
(
ş›Á
 
c
) {

174 ià(
cÚfig
.
»que¡s_fšished
 =ğcÚfig.
»que¡s
) {

175 
	`ä“Cl›Á
(
c
);

176 
	`«Stİ
(
cÚfig
.
–
);

179 ià(
cÚfig
.
k“·live
) {

180 
	`»£tCl›Á
(
c
);

182 
cÚfig
.
liveş›Ás
--;

183 
	`ü—‹MissšgCl›Ás
(
c
);

184 
cÚfig
.
liveş›Ás
++;

185 
	`ä“Cl›Á
(
c
);

187 
	}
}

189 
	$»adHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

190 
ş›Á
 
c
 = 
´ivd©a
;

191 *
»¶y
 = 
NULL
;

192 
	`UNUSED
(
–
);

193 
	`UNUSED
(
fd
);

194 
	`UNUSED
(
mask
);

199 ià(
c
->
Ï‹ncy
 < 0èc->Ï‹ncy = 
	`u¡ime
()-(c->
¡¬t
);

201 ià(
	`»disBufãrR—d
(
c
->
cÚ‹xt
è!ğ
REDIS_OK
) {

202 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
cÚ‹xt
->
”r¡r
);

203 
	`ex™
(1);

205 
c
->
³ndšg
) {

206 ià(
	`»disG‘R•ly
(
c
->
cÚ‹xt
,&
»¶y
è!ğ
REDIS_OK
) {

207 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
cÚ‹xt
->
”r¡r
);

208 
	`ex™
(1);

210 ià(
»¶y
 !ğ
NULL
) {

211 ià(
»¶y
 =ğ(*)
REDIS_REPLY_ERROR
) {

212 
	`årštf
(
¡d”r
,"Unexpectedƒrror„eply,ƒxiting...\n");

213 
	`ex™
(1);

216 ià(
cÚfig
.
show”rÜs
) {

217 
time_t
 
Ï¡”r_time
 = 0;

218 
time_t
 
now
 = 
	`time
(
NULL
);

219 
»disR•ly
 *
r
 = 
»¶y
;

220 ià(
r
->
ty³
 =ğ
REDIS_REPLY_ERROR
 && 
Ï¡”r_time
 !ğ
now
) {

221 
Ï¡”r_time
 = 
now
;

222 
	`´štf
("E¼Ü from s”v”: %s\n", 
r
->
¡r
);

226 
	`ä“R•lyObjeù
(
»¶y
);

228 ià(
c
->
´efix_³ndšg
 > 0) {

229 
c
->
´efix_³ndšg
--;

230 
c
->
³ndšg
--;

232 ià(
c
->
´efixËn
 > 0) {

233 
size_t
 
j
;

234 
	`sd¤ªge
(
c
->
obuf
, c->
´efixËn
, -1);

237 
j
 = 0; j < 
c
->
¿ndËn
; j++)

238 
c
->
¿nd±r
[
j
] -ğc->
´efixËn
;

239 
c
->
´efixËn
 = 0;

244 ià(
cÚfig
.
»que¡s_fšished
 < cÚfig.
»que¡s
)

245 
cÚfig
.
Ï‹ncy
[cÚfig.
»que¡s_fšished
++] = 
c
->latency;

246 
c
->
³ndšg
--;

247 ià(
c
->
³ndšg
 == 0) {

248 
	`ş›ÁDÚe
(
c
);

256 
	}
}

258 
	$wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

259 
ş›Á
 
c
 = 
´ivd©a
;

260 
	`UNUSED
(
–
);

261 
	`UNUSED
(
fd
);

262 
	`UNUSED
(
mask
);

265 ià(
c
->
wr™‹n
 == 0) {

267 ià(
cÚfig
.
»que¡s_issued
++ >ğcÚfig.
»que¡s
) {

268 
	`ä“Cl›Á
(
c
);

273 ià(
cÚfig
.
¿ndomkeys
è
	`¿ndomizeCl›ÁKey
(
c
);

274 
c
->
¡¬t
 = 
	`u¡ime
();

275 
c
->
Ï‹ncy
 = -1;

278 ià(
	`sd¦’
(
c
->
obuf
è> c->
wr™‹n
) {

279 *
±r
 = 
c
->
obuf
+c->
wr™‹n
;

280 
ssize_t
 
nwr™‹n
 = 
	`wr™e
(
c
->
cÚ‹xt
->
fd
,
±r
,
	`sd¦’
(c->
obuf
)-c->
wr™‹n
);

281 ià(
nwr™‹n
 == -1) {

282 ià(
”ºo
 !ğ
EPIPE
)

283 
	`årštf
(
¡d”r
, "Wr™šgØsock‘: %s\n", 
	`¡»¼Ü
(
”ºo
));

284 
	`ä“Cl›Á
(
c
);

287 
c
->
wr™‹n
 +ğ
nwr™‹n
;

288 ià(
	`sd¦’
(
c
->
obuf
è=ğc->
wr™‹n
) {

289 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

290 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
,
»adHªdËr
,c);

293 
	}
}

316 
ş›Á
 
	$ü—‹Cl›Á
(*
cmd
, 
size_t
 
Ën
, 
ş›Á
 
äom
) {

317 
j
;

318 
ş›Á
 
c
 = 
	`zm®loc
((
_ş›Á
));

320 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
) {

321 
c
->
cÚ‹xt
 = 
	`»disCÚÃùNÚBlock
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

323 
c
->
cÚ‹xt
 = 
	`»disCÚÃùUnixNÚBlock
(
cÚfig
.
ho¡sock‘
);

325 ià(
c
->
cÚ‹xt
->
”r
) {

326 
	`årštf
(
¡d”r
,"Could‚ot connecto Redis‡t ");

327 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
)

328 
	`årštf
(
¡d”r
,"%s:%d: %s\n",
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
,
c
->
cÚ‹xt
->
”r¡r
);

330 
	`årštf
(
¡d”r
,"%s: %s\n",
cÚfig
.
ho¡sock‘
,
c
->
cÚ‹xt
->
”r¡r
);

331 
	`ex™
(1);

334 
c
->
cÚ‹xt
->
»ad”
->
maxbuf
 = 0;

339 
c
->
obuf
 = 
	`sd£m±y
();

343 
c
->
´efix_³ndšg
 = 0;

344 ià(
cÚfig
.
auth
) {

345 *
buf
 = 
NULL
;

346 
Ën
 = 
	`»disFÜm©Commªd
(&
buf
, "AUTH %s", 
cÚfig
.
auth
);

347 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf, 
buf
, 
Ën
);

348 
	`ä“
(
buf
);

349 
c
->
´efix_³ndšg
++;

356 ià(
cÚfig
.
dbnum
 != 0) {

357 
c
->
obuf
 = 
	`sdsÿrštf
(c->obuf,"*2\r\n$6\r\nSELECT\r\n$%d\r\n%s\r\n",

358 ()
	`sd¦’
(
cÚfig
.
dbnum¡r
),config.dbnumstr);

359 
c
->
´efix_³ndšg
++;

361 
c
->
´efixËn
 = 
	`sd¦’
(c->
obuf
);

363 ià(
äom
) {

364 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,

365 
äom
->
obuf
+äom->
´efixËn
,

366 
	`sd¦’
(
äom
->
obuf
)-äom->
´efixËn
);

368 
j
 = 0; j < 
cÚfig
.
p–še
; j++)

369 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,
cmd
,
Ën
);

372 
c
->
wr™‹n
 = 0;

373 
c
->
³ndšg
 = 
cÚfig
.
p–še
+c->
´efix_³ndšg
;

374 
c
->
¿nd±r
 = 
NULL
;

375 
c
->
¿ndËn
 = 0;

378 ià(
cÚfig
.
¿ndomkeys
) {

379 ià(
äom
) {

380 
c
->
¿ndËn
 = 
äom
->randlen;

381 
c
->
¿ndä“
 = 0;

382 
c
->
¿nd±r
 = 
	`zm®loc
((*)*c->
¿ndËn
);

384 
j
 = 0; j < ()
c
->
¿ndËn
; j++) {

385 
c
->
¿nd±r
[
j
] = c->
obuf
 + (
äom
->randptr[j]-from->obuf);

387 
c
->
¿nd±r
[
j
] +ğc->
´efixËn
 - 
äom
->prefixlen;

390 *
p
 = 
c
->
obuf
;

392 
c
->
¿ndËn
 = 0;

393 
c
->
¿ndä“
 = 
RANDPTR_INITIAL_SIZE
;

394 
c
->
¿nd±r
 = 
	`zm®loc
((*)*c->
¿ndä“
);

395 (
p
 = 
	`¡r¡r
Õ,"__¿nd_št__")è!ğ
NULL
) {

396 ià(
c
->
¿ndä“
 == 0) {

397 
c
->
¿nd±r
 = 
	`z»®loc
(c->¿nd±r,(*)*c->
¿ndËn
*2);

398 
c
->
¿ndä“
 +ğc->
¿ndËn
;

400 
c
->
¿nd±r
[c->
¿ndËn
++] = 
p
;

401 
c
->
¿ndä“
--;

402 
p
 += 12;

406 ià(
cÚfig
.
idËmode
 == 0)

407 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

408 
	`li¡AddNodeTa
(
cÚfig
.
ş›Ás
,
c
);

409 
cÚfig
.
liveş›Ás
++;

410  
c
;

411 
	}
}

413 
	$ü—‹MissšgCl›Ás
(
ş›Á
 
c
) {

414 
n
 = 0;

416 
cÚfig
.
liveş›Ás
 < cÚfig.
numş›Ás
) {

417 
	`ü—‹Cl›Á
(
NULL
,0,
c
);

420 ià(++
n
 > 64) {

421 
	`u¦“p
(50000);

422 
n
 = 0;

425 
	}
}

427 
	$com·»L©’cy
(cÚ¡ *
a
, cÚ¡ *
b
) {

428  (*(*)
a
)-(*(*)
b
);

429 
	}
}

431 
	$showL©’cyR•Üt
() {

432 
i
, 
cu¾©
 = 0;

433 
³rc
, 
»q³r£c
;

435 
»q³r£c
 = ()
cÚfig
.
»que¡s_fšished
/(()cÚfig.
tÙÏ‹ncy
/1000);

436 ià(!
cÚfig
.
qu›t
 && !cÚfig.
csv
) {

437 
	`´štf
("=====ğ% ======\n", 
cÚfig
.
t™Ë
);

438 
	`´štf
(" %d„eque¡ com¶‘ed iÀ%.2à£cÚds\n", 
cÚfig
.
»que¡s_fšished
,

439 ()
cÚfig
.
tÙÏ‹ncy
/1000);

440 
	`´štf
(" %d…¬®ËÈş›Ás\n", 
cÚfig
.
numş›Ás
);

441 
	`´štf
(" %d by‹ ·ylßd\n", 
cÚfig
.
d©asize
);

442 
	`´štf
(" k“°®ive: %d\n", 
cÚfig
.
k“·live
);

443 
	`´štf
("\n");

445 
	`qsÜt
(
cÚfig
.
Ï‹ncy
,cÚfig.
»que¡s
,(),
com·»L©’cy
);

446 
i
 = 0; i < 
cÚfig
.
»que¡s
; i++) {

447 ià(
cÚfig
.
Ï‹ncy
[
i
]/1000 !ğ
cu¾©
 || i =ğ(cÚfig.
»que¡s
-1)) {

448 
cu¾©
 = 
cÚfig
.
Ï‹ncy
[
i
]/1000;

449 
³rc
 = (()(
i
+1)*100)/
cÚfig
.
»que¡s
;

450 
	`´štf
("%.2f%% <ğ%d mli£cÚds\n", 
³rc
, 
cu¾©
);

453 
	`´štf
("%.2à»que¡ ³¸£cÚd\n\n", 
»q³r£c
);

454 } ià(
cÚfig
.
csv
) {

455 
	`´štf
("\"%s\",\"%.2f\"\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

457 
	`´štf
("%s: %.2à»que¡ ³¸£cÚd\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

459 
	}
}

461 
	$b’chm¬k
(*
t™Ë
, *
cmd
, 
Ën
) {

462 
ş›Á
 
c
;

464 
cÚfig
.
t™Ë
 =itle;

465 
cÚfig
.
»que¡s_issued
 = 0;

466 
cÚfig
.
»que¡s_fšished
 = 0;

468 
c
 = 
	`ü—‹Cl›Á
(
cmd
,
Ën
,
NULL
);

469 
	`ü—‹MissšgCl›Ás
(
c
);

471 
cÚfig
.
¡¬t
 = 
	`m¡ime
();

472 
	`«Maš
(
cÚfig
.
–
);

473 
cÚfig
.
tÙÏ‹ncy
 = 
	`m¡ime
()-cÚfig.
¡¬t
;

475 
	`showL©’cyR•Üt
();

476 
	`ä“AÎCl›Ás
();

477 
	}
}

480 
	$·r£O±iÚs
(
¬gc
, cÚ¡ **
¬gv
) {

481 
i
;

482 
Ï¡¬g
;

483 
ex™_¡©us
 = 1;

485 
i
 = 1; i < 
¬gc
; i++) {

486 
Ï¡¬g
 = (
i
 =ğ(
¬gc
-1));

488 ià(!
	`¡rcmp
(
¬gv
[
i
],"-c")) {

489 ià(
Ï¡¬g
è
šv®id
;

490 
cÚfig
.
numş›Ás
 = 
	`©oi
(
¬gv
[++
i
]);

491 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-n")) {

492 ià(
Ï¡¬g
è
šv®id
;

493 
cÚfig
.
»que¡s
 = 
	`©oi
(
¬gv
[++
i
]);

494 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-k")) {

495 ià(
Ï¡¬g
è
šv®id
;

496 
cÚfig
.
k“·live
 = 
	`©oi
(
¬gv
[++
i
]);

497 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-h")) {

498 ià(
Ï¡¬g
è
šv®id
;

499 
cÚfig
.
ho¡
 = 
	`¡rdup
(
¬gv
[++
i
]);

500 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-p")) {

501 ià(
Ï¡¬g
è
šv®id
;

502 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[++
i
]);

503 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-s")) {

504 ià(
Ï¡¬g
è
šv®id
;

505 
cÚfig
.
ho¡sock‘
 = 
	`¡rdup
(
¬gv
[++
i
]);

506 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-a") ) {

507 ià(
Ï¡¬g
è
šv®id
;

508 
cÚfig
.
auth
 = 
	`¡rdup
(
¬gv
[++
i
]);

509 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-d")) {

510 ià(
Ï¡¬g
è
šv®id
;

511 
cÚfig
.
d©asize
 = 
	`©oi
(
¬gv
[++
i
]);

512 ià(
cÚfig
.
d©asize
 < 1) config.datasize=1;

513 ià(
cÚfig
.
d©asize
 > 1024*1024*1024) config.datasize = 1024*1024*1024;

514 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-P")) {

515 ià(
Ï¡¬g
è
šv®id
;

516 
cÚfig
.
p–še
 = 
	`©oi
(
¬gv
[++
i
]);

517 ià(
cÚfig
.
p–še
 <= 0) config.pipeline=1;

518 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-r")) {

519 ià(
Ï¡¬g
è
šv®id
;

520 
cÚfig
.
¿ndomkeys
 = 1;

521 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 
	`©oi
(
¬gv
[++
i
]);

522 ià(
cÚfig
.
¿ndomkeys_key¥aûËn
 < 0)

523 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

524 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-q")) {

525 
cÚfig
.
qu›t
 = 1;

526 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--csv")) {

527 
cÚfig
.
csv
 = 1;

528 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-l")) {

529 
cÚfig
.
loİ
 = 1;

530 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-I")) {

531 
cÚfig
.
idËmode
 = 1;

532 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-e")) {

533 
cÚfig
.
show”rÜs
 = 1;

534 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-t")) {

535 ià(
Ï¡¬g
è
šv®id
;

541 
cÚfig
.
‹¡s
 = 
	`sd¢ew
(",");

542 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(cÚfig.‹¡s,(*)
¬gv
[++
i
]);

543 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(config.tests,",");

544 
	`sd¡Şow”
(
cÚfig
.
‹¡s
);

545 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--dbnum")) {

546 ià(
Ï¡¬g
è
šv®id
;

547 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[++
i
]);

548 
cÚfig
.
dbnum¡r
 = 
	`sdsäomlÚglÚg
(cÚfig.
dbnum
);

549 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--help")) {

550 
ex™_¡©us
 = 0;

551 
u§ge
;

556 ià(
¬gv
[
i
][0] =ğ'-'è
šv®id
;

557  
i
;

561  
i
;

563 
šv®id
:

564 
	`´štf
("Inv®id o±iÚ \"%s\" o¸İtiÚ‡rgum’ˆmissšg\n\n",
¬gv
[
i
]);

566 
u§ge
:

567 
	`´štf
(

609 
	`ex™
(
ex™_¡©us
);

610 
	}
}

612 
	$showThroughput
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

613 
	`UNUSED
(
ev’tLoİ
);

614 
	`UNUSED
(
id
);

615 
	`UNUSED
(
ş›ÁD©a
);

617 ià(
cÚfig
.
liveş›Ás
 =ğ0 && cÚfig.
»que¡s_fšished
 !ğcÚfig.
»que¡s
) {

618 
	`årštf
(
¡d”r
,"All clients disconnected...‡borting.\n");

619 
	`ex™
(1);

621 ià(
cÚfig
.
csv
)  250;

622 ià(
cÚfig
.
idËmode
 == 1) {

623 
	`´štf
("ş›Ás: %d\r", 
cÚfig
.
liveş›Ás
);

624 
	`fæush
(
¡dout
);

627 
dt
 = ()(
	`m¡ime
()-
cÚfig
.
¡¬t
)/1000.0;

628 
½s
 = ()
cÚfig
.
»que¡s_fšished
/
dt
;

629 
	`´štf
("%s: %.2f\r", 
cÚfig
.
t™Ë
, 
½s
);

630 
	`fæush
(
¡dout
);

632 
	}
}

636 
	$‹¡_is_£Ëùed
(*
Çme
) {

637 
buf
[256];

638 
l
 = 
	`¡¾’
(
Çme
);

640 ià(
cÚfig
.
‹¡s
 =ğ
NULL
)  1;

641 
buf
[0] = ',';

642 
	`memıy
(
buf
+1,
Çme
,
l
);

643 
buf
[
l
+1] = ',';

644 
buf
[
l
+2] = '\0';

645  
	`¡r¡r
(
cÚfig
.
‹¡s
,
buf
è!ğ
NULL
;

646 
	}
}

648 
	$maš
(
¬gc
, cÚ¡ **
¬gv
) {

649 
i
;

650 *
d©a
, *
cmd
;

651 
Ën
;

653 
ş›Á
 
c
;

655 
	`¤ªdom
(
	`time
(
NULL
));

656 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

657 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

659 
cÚfig
.
numş›Ás
 = 50;

660 
cÚfig
.
»que¡s
 = 100000;

661 
cÚfig
.
liveş›Ás
 = 0;

662 
cÚfig
.
–
 = 
	`«C»©eEv’tLoİ
(1024*10);

663 
	`«C»©eTimeEv’t
(
cÚfig
.
–
,1,
showThroughput
,
NULL
,NULL);

664 
cÚfig
.
k“·live
 = 1;

665 
cÚfig
.
d©asize
 = 3;

666 
cÚfig
.
p–še
 = 1;

667 
cÚfig
.
show”rÜs
 = 0;

668 
cÚfig
.
¿ndomkeys
 = 0;

669 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

670 
cÚfig
.
qu›t
 = 0;

671 
cÚfig
.
csv
 = 0;

672 
cÚfig
.
loİ
 = 0;

673 
cÚfig
.
idËmode
 = 0;

674 
cÚfig
.
Ï‹ncy
 = 
NULL
;

675 
cÚfig
.
ş›Ás
 = 
	`li¡C»©e
();

676 
cÚfig
.
ho¡
 = "127.0.0.1";

677 
cÚfig
.
ho¡pÜt
 = 6379;

678 
cÚfig
.
ho¡sock‘
 = 
NULL
;

679 
cÚfig
.
‹¡s
 = 
NULL
;

680 
cÚfig
.
dbnum
 = 0;

681 
cÚfig
.
auth
 = 
NULL
;

683 
i
 = 
	`·r£O±iÚs
(
¬gc
,
¬gv
);

684 
¬gc
 -ğ
i
;

685 
¬gv
 +ğ
i
;

687 
cÚfig
.
Ï‹ncy
 = 
	`zm®loc
(()*cÚfig.
»que¡s
);

689 ià(
cÚfig
.
k“·live
 == 0) {

690 
	`´štf
("WARNING: keepalive disabled, you…robably‚eed 'echo 1 > /proc/sys/net/ipv4/tcp_tw_reuse' for Linux‡nd 'sudo sysctl -w‚et.inet.tcp.msl=1000' for Mac OS X in ordero use‡†ot of clients/requests\n");

693 ià(
cÚfig
.
idËmode
) {

694 
	`´štf
("C»©šg %d idË cÚÃùiÚ ªd wa™šg fÜev” (CŒl+C wh’ dÚe)\n", 
cÚfig
.
numş›Ás
);

695 
c
 = 
	`ü—‹Cl›Á
("",0,
NULL
);

696 
	`ü—‹MissšgCl›Ás
(
c
);

697 
	`«Maš
(
cÚfig
.
–
);

702 ià(
¬gc
) {

703 
sds
 
t™Ë
 = 
	`sd¢ew
(
¬gv
[0]);

704 
i
 = 1; i < 
¬gc
; i++) {

705 
t™Ë
 = 
	`sdsÿ’
(title, " ", 1);

706 
t™Ë
 = 
	`sdsÿ’
Ñ™Ë, (*)
¬gv
[
i
], 
	`¡¾’
(argv[i]));

710 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

711 
	`b’chm¬k
(
t™Ë
,
cmd
,
Ën
);

712 
	`ä“
(
cmd
);

713 } 
cÚfig
.
loİ
);

719 
d©a
 = 
	`zm®loc
(
cÚfig
.
d©asize
+1);

721 
	`mem£t
(
d©a
,'x',
cÚfig
.
d©asize
);

722 
d©a
[
cÚfig
.
d©asize
] = '\0';

724 ià(
	`‹¡_is_£Ëùed
("ping_inline") ||est_is_selected("ping"))

725 
	`b’chm¬k
("PING_INLINE","PING\r\n",6);

727 ià(
	`‹¡_is_£Ëùed
("ping_mbulk") ||est_is_selected("ping")) {

728 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"PING");

729 
	`b’chm¬k
("PING_BULK",
cmd
,
Ën
);

730 
	`ä“
(
cmd
);

733 ià(
	`‹¡_is_£Ëùed
("set")) {

734 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET key:__¿nd_št__ %s",
d©a
);

735 
	`b’chm¬k
("SET",
cmd
,
Ën
);

736 
	`ä“
(
cmd
);

739 ià(
	`‹¡_is_£Ëùed
("get")) {

740 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"GET key:__rand_int__");

741 
	`b’chm¬k
("GET",
cmd
,
Ën
);

742 
	`ä“
(
cmd
);

745 ià(
	`‹¡_is_£Ëùed
("incr")) {

746 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"INCR counter:__rand_int__");

747 
	`b’chm¬k
("INCR",
cmd
,
Ën
);

748 
	`ä“
(
cmd
);

751 ià(
	`‹¡_is_£Ëùed
("lpush")) {

752 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

753 
	`b’chm¬k
("LPUSH",
cmd
,
Ën
);

754 
	`ä“
(
cmd
);

757 ià(
	`‹¡_is_£Ëùed
("rpush")) {

758 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPUSH myli¡ %s",
d©a
);

759 
	`b’chm¬k
("RPUSH",
cmd
,
Ën
);

760 
	`ä“
(
cmd
);

763 ià(
	`‹¡_is_£Ëùed
("lpop")) {

764 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPOP mylist");

765 
	`b’chm¬k
("LPOP",
cmd
,
Ën
);

766 
	`ä“
(
cmd
);

769 ià(
	`‹¡_is_£Ëùed
("rpop")) {

770 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"RPOP mylist");

771 
	`b’chm¬k
("RPOP",
cmd
,
Ën
);

772 
	`ä“
(
cmd
);

775 ià(
	`‹¡_is_£Ëùed
("sadd")) {

776 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,

778 
	`b’chm¬k
("SADD",
cmd
,
Ën
);

779 
	`ä“
(
cmd
);

782 ià(
	`‹¡_is_£Ëùed
("hset")) {

783 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,

784 "HSET my£t:__¿nd_št__ƒËm’t:__¿nd_št__ %s",
d©a
);

785 
	`b’chm¬k
("HSET",
cmd
,
Ën
);

786 
	`ä“
(
cmd
);

789 ià(
	`‹¡_is_£Ëùed
("spop")) {

790 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SPOP myset");

791 
	`b’chm¬k
("SPOP",
cmd
,
Ën
);

792 
	`ä“
(
cmd
);

795 ià(
	`‹¡_is_£Ëùed
("lrange") ||

796 
	`‹¡_is_£Ëùed
("lrange_100") ||

797 
	`‹¡_is_£Ëùed
("lrange_300") ||

798 
	`‹¡_is_£Ëùed
("lrange_500") ||

799 
	`‹¡_is_£Ëùed
("lrange_600"))

801 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

802 
	`b’chm¬k
("LPUSH (ÃededØb’chm¬k LRANGE)",
cmd
,
Ën
);

803 
	`ä“
(
cmd
);

806 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_100")) {

807 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 99");

808 
	`b’chm¬k
("LRANGE_100 (fœ¡ 100ƒËm’ts)",
cmd
,
Ën
);

809 
	`ä“
(
cmd
);

812 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_300")) {

813 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 299");

814 
	`b’chm¬k
("LRANGE_300 (fœ¡ 300ƒËm’ts)",
cmd
,
Ën
);

815 
	`ä“
(
cmd
);

818 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_500")) {

819 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 449");

820 
	`b’chm¬k
("LRANGE_500 (fœ¡ 450ƒËm’ts)",
cmd
,
Ën
);

821 
	`ä“
(
cmd
);

824 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_600")) {

825 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 599");

826 
	`b’chm¬k
("LRANGE_600 (fœ¡ 600ƒËm’ts)",
cmd
,
Ën
);

827 
	`ä“
(
cmd
);

830 ià(
	`‹¡_is_£Ëùed
("mset")) {

831 cÚ¡ *
¬gv
[21];

832 
¬gv
[0] = "MSET";

833 
i
 = 1; i < 21; i += 2) {

834 
¬gv
[
i
] = "key:__rand_int__";

835 
¬gv
[
i
+1] = 
d©a
;

837 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,21,
¬gv
,
NULL
);

838 
	`b’chm¬k
("MSET (10 keys)",
cmd
,
Ën
);

839 
	`ä“
(
cmd
);

842 ià(!
cÚfig
.
csv
è
	`´štf
("\n");

843 } 
cÚfig
.
loİ
);

846 
	}
}

	@src/redis-check-aof.c

31 
	~"£rv”.h
"

32 
	~<sys/¡©.h
>

34 
	#ERROR
(...) { \

35 
__buf
[1024]; \

36 
	`¥rštf
(
__buf
, 
__VA_ARGS__
); \

37 
	`¥rštf
(
”rÜ
, "0x%16Îx: %s", ()
•os
, 
__buf
); \

38 }

	)

40 
	g”rÜ
[1024];

41 
off_t
 
	g•os
;

43 
	$cÚsumeNewlše
(*
buf
) {

44 ià(
	`¡ºcmp
(
buf
,"\r\n",2) != 0) {

45 
	`ERROR
("Ex³ùed \\r\\n, gÙ: %02x%02x",
buf
[0],buf[1]);

49 
	}
}

51 
	$»adLÚg
(
FILE
 *
å
, 
´efix
, *
rg‘
) {

52 
buf
[128], *
•Œ
;

53 
•os
 = 
	`á–lo
(
å
);

54 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

57 ià(
buf
[0] !ğ
´efix
) {

58 
	`ERROR
("Ex³ùed…»fix '%c', gÙ: '%c'",
´efix
,
buf
[0]);

61 *
rg‘
 = 
	`¡¹Ş
(
buf
+1,&
•Œ
,10);

62  
	`cÚsumeNewlše
(
•Œ
);

63 
	}
}

65 
	$»adBy‹s
(
FILE
 *
å
, *
rg‘
, 
Ëngth
) {

66 
»®
;

68 
•os
 = 
	`á–lo
(
å
);

70 
»®
 = 
	`ä—d
(
rg‘
,1,
Ëngth
,
å
);

71 ià(
»®
 !ğ
Ëngth
) {

72 
	`ERROR
("Ex³ùedØ»ad %ld by‹s, gÙ %ld by‹s",
Ëngth
,
»®
);

76 
	}
}

78 
	$»adSŒšg
(
FILE
 *
å
, ** 
rg‘
) {

79 
Ën
;

80 *
rg‘
 = 
NULL
;

81 ià(!
	`»adLÚg
(
å
,'$',&
Ën
)) {

86 
Ën
 += 2;

87 *
rg‘
 = (*)
	`zm®loc
(
Ën
);

88 ià(!
	`»adBy‹s
(
å
,*
rg‘
,
Ën
)) {

91 ià(!
	`cÚsumeNewlše
(*
rg‘
+
Ën
-2)) {

94 (*
rg‘
)[
Ën
-2] = '\0';

96 
	}
}

98 
	$»adArgc
(
FILE
 *
å
, *
rg‘
) {

99  
	`»adLÚg
(
å
,'*',
rg‘
);

100 
	}
}

102 
off_t
 
	$´oûss
(
FILE
 *
å
) {

103 
¬gc
;

104 
off_t
 
pos
 = 0;

105 
i
, 
muÉi
 = 0;

106 *
¡r
;

109 ià(!
muÉi
è
pos
 = 
	`á–lo
(
å
);

110 ià(!
	`»adArgc
(
å
, &
¬gc
)) ;

112 
i
 = 0; i < 
¬gc
; i++) {

113 ià(!
	`»adSŒšg
(
å
,&
¡r
)) ;

114 ià(
i
 == 0) {

115 ià(
	`¡rÿ£cmp
(
¡r
, "multi") == 0) {

116 ià(
muÉi
++) {

117 
	`ERROR
("Unexpected MULTI");

120 } ià(
	`¡rÿ£cmp
(
¡r
, "exec") == 0) {

121 ià(--
muÉi
) {

122 
	`ERROR
("Unexpected EXEC");

127 
	`zä“
(
¡r
);

131 ià(
i
 < 
¬gc
) {

132 ià(
¡r
è
	`zä“
(str);

137 ià(
	`ãof
(
å
è&& 
muÉi
 && 
	`¡¾’
(
”rÜ
) == 0) {

138 
	`ERROR
("Reached EOF before„eading EXEC for MULTI");

140 ià(
	`¡¾’
(
”rÜ
) > 0) {

141 
	`´štf
("%s\n", 
”rÜ
);

143  
pos
;

144 
	}
}

146 
	$»dis_check_aof_maš
(
¬gc
, **
¬gv
) {

147 *
f’ame
;

148 
fix
 = 0;

150 ià(
¬gc
 < 2) {

151 
	`´štf
("U§ge: % [--fix] <fe.aof>\n", 
¬gv
[0]);

152 
	`ex™
(1);

153 } ià(
¬gc
 == 2) {

154 
f’ame
 = 
¬gv
[1];

155 } ià(
¬gc
 == 3) {

156 ià(
	`¡rcmp
(
¬gv
[1],"--fix") != 0) {

157 
	`´štf
("Inv®id‡rgum’t: %s\n", 
¬gv
[1]);

158 
	`ex™
(1);

160 
f’ame
 = 
¬gv
[2];

161 
fix
 = 1;

163 
	`´štf
("Invalid‡rguments\n");

164 
	`ex™
(1);

167 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r+");

168 ià(
å
 =ğ
NULL
) {

169 
	`´štf
("CªnÙ o³Àfe: %s\n", 
f’ame
);

170 
	`ex™
(1);

173 
»dis_¡©
 
sb
;

174 ià(
	`»dis_f¡©
(
	`f’o
(
å
),&
sb
) == -1) {

175 
	`´štf
("CªnÙ sˆfe: %s\n", 
f’ame
);

176 
	`ex™
(1);

179 
off_t
 
size
 = 
sb
.
¡_size
;

180 ià(
size
 == 0) {

181 
	`´štf
("Em±y fe: %s\n", 
f’ame
);

182 
	`ex™
(1);

187 ià(
size
 >= 8) {

188 
sig
[5];

189 
has_´—mbË
 = 
	`ä—d
(
sig
,(sig),1,
å
) == 1 &&

190 
	`memcmp
(
sig
,"REDIS",(sig)) == 0;

191 
	`»wšd
(
å
);

192 ià(
has_´—mbË
) {

193 
	`´štf
("The AOF‡ppearso start with‡n RDB…reamble.\n"

195 ià(
	`»dis_check_rdb_maš
(
¬gc
,
¬gv
,
å
è=ğ
C_ERR
) {

196 
	`´štf
("RDB…reamble of AOF file is‚ot sane,‡borting.\n");

197 
	`ex™
(1);

199 
	`´štf
("RDB…reamble is OK,…roceeding with AOFail...\n");

204 
off_t
 
pos
 = 
	`´oûss
(
å
);

205 
off_t
 
diff
 = 
size
-
pos
;

206 
	`´štf
("AOF‡nalyzed: size=%lld, ok_up_to=%lld, diff=%lld\n",

207 (è
size
, (è
pos
, (è
diff
);

208 ià(
diff
 > 0) {

209 ià(
fix
) {

210 
buf
[2];

211 
	`´štf
("Thi wÈshrškhAOF from %Îd by‹s, w™h %Îd by‹s,Ø%Îd by‹s\n",()
size
,()
diff
,()
pos
);

212 
	`´štf
("Continue? [y/N]: ");

213 ià(
	`fg‘s
(
buf
,(buf),
¡dš
è=ğ
NULL
 ||

214 
	`¡ºÿ£cmp
(
buf
,"y",1) != 0) {

215 
	`´štf
("Aborting...\n");

216 
	`ex™
(1);

218 ià(
	`árunÿ‹
(
	`f’o
(
å
), 
pos
) == -1) {

219 
	`´štf
("Failedoruncate AOF\n");

220 
	`ex™
(1);

222 
	`´štf
("Successfullyruncated AOF\n");

225 
	`´štf
("AOF is‚ot valid. "

227 
	`ex™
(1);

230 
	`´štf
("AOF is valid\n");

233 
	`fşo£
(
å
);

234 
	`ex™
(0);

235 
	}
}

	@src/redis-check-rdb.c

30 
	~"£rv”.h
"

31 
	~"rdb.h
"

33 
	~<¡d¬g.h
>

35 
ü—‹Sh¬edObjeùs
();

36 
rdbLßdProg»ssC®lback
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

37 
rdbLßdMli£cÚdTime
(
rio
 *
rdb
);

38 
	grdbCheckMode
 = 0;

41 
rio
 *
	mrio
;

42 
robj
 *
	mkey
;

43 
	mkey_ty³
;

44 
	mkeys
;

45 
	mexpœes
;

46 
	m®»ady_expœed
;

47 
	mdošg
;

48 
	m”rÜ_£t
;

49 
	m”rÜ
[1024];

50 } 
	grdb¡©e
;

54 
	#RDB_CHECK_DOING_START
 0

	)

55 
	#RDB_CHECK_DOING_READ_TYPE
 1

	)

56 
	#RDB_CHECK_DOING_READ_EXPIRE
 2

	)

57 
	#RDB_CHECK_DOING_READ_KEY
 3

	)

58 
	#RDB_CHECK_DOING_READ_OBJECT_VALUE
 4

	)

59 
	#RDB_CHECK_DOING_CHECK_SUM
 5

	)

60 
	#RDB_CHECK_DOING_READ_LEN
 6

	)

61 
	#RDB_CHECK_DOING_READ_AUX
 7

	)

63 *
	grdb_check_došg_¡ršg
[] = {

74 *
	grdb_ty³_¡ršg
[] = {

92 
	$rdbShowG’”icInfo
() {

93 
	`´štf
("[šfo] %lu key »ad\n", 
rdb¡©e
.
keys
);

94 
	`´štf
("[šfo] %luƒxpœes\n", 
rdb¡©e
.
expœes
);

95 
	`´štf
("[šfo] %lu‡Ì—dyƒxpœed\n", 
rdb¡©e
.
®»ady_expœed
);

96 
	}
}

100 
	$rdbCheckE¼Ü
(cÚ¡ *
fmt
, ...) {

101 
msg
[1024];

102 
va_li¡
 
­
;

104 
	`va_¡¬t
(
­
, 
fmt
);

105 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
­
);

106 
	`va_’d
(
­
);

108 
	`´štf
("--- RDB ERROR DETECTED ---\n");

109 
	`´štf
("[offset %llu] %s\n",

110 (è(
rdb¡©e
.
rio
 ?

111 
rdb¡©e
.
rio
->
´oûs£d_by‹s
 : 0), 
msg
);

112 
	`´štf
("[additional info] While doing: %s\n",

113 
rdb_check_došg_¡ršg
[
rdb¡©e
.
došg
]);

114 ià(
rdb¡©e
.
key
)

115 
	`´štf
("[additional info] Reading key '%s'\n",

116 (*)
rdb¡©e
.
key
->
±r
);

117 ià(
rdb¡©e
.
key_ty³
 != -1)

118 
	`´štf
("[additional info] Readingype %d (%s)\n",

119 
rdb¡©e
.
key_ty³
,

120 (()
rdb¡©e
.
key_ty³
 <

121 (
rdb_ty³_¡ršg
)/(*)) ?

122 
rdb_ty³_¡ršg
[
rdb¡©e
.
key_ty³
] : "unknown");

123 
	`rdbShowG’”icInfo
();

124 
	}
}

127 
	$rdbCheckInfo
(cÚ¡ *
fmt
, ...) {

128 
msg
[1024];

129 
va_li¡
 
­
;

131 
	`va_¡¬t
(
­
, 
fmt
);

132 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
­
);

133 
	`va_’d
(
­
);

135 
	`´štf
("[offset %llu] %s\n",

136 (è(
rdb¡©e
.
rio
 ?

137 
rdb¡©e
.
rio
->
´oûs£d_by‹s
 : 0), 
msg
);

138 
	}
}

142 
	$rdbCheckS‘E¼Ü
(cÚ¡ *
fmt
, ...) {

143 
va_li¡
 
­
;

145 
	`va_¡¬t
(
­
, 
fmt
);

146 
	`v¢´štf
(
rdb¡©e
.
”rÜ
, Ôdb¡©e.”rÜ), 
fmt
, 
­
);

147 
	`va_’d
(
­
);

148 
rdb¡©e
.
”rÜ_£t
 = 1;

149 
	}
}

154 
	$rdbCheckHªdËC¿sh
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
) {

155 
	`UNUSED
(
sig
);

156 
	`UNUSED
(
šfo
);

157 
	`UNUSED
(
£ü‘
);

159 
	`rdbCheckE¼Ü
("Server crash checkinghe specified RDB file!");

160 
	`ex™
(1);

161 
	}
}

163 
	$rdbCheckS‘upSigÇls
() {

164 
sigaùiÚ
 
aù
;

166 
	`sigem±y£t
(&
aù
.
§_mask
);

167 
aù
.
§_æags
 = 
SA_NODEFER
 | 
SA_RESETHAND
 | 
SA_SIGINFO
;

168 
aù
.
§_sigaùiÚ
 = 
rdbCheckHªdËC¿sh
;

169 
	`sigaùiÚ
(
SIGSEGV
, &
aù
, 
NULL
);

170 
	`sigaùiÚ
(
SIGBUS
, &
aù
, 
NULL
);

171 
	`sigaùiÚ
(
SIGFPE
, &
aù
, 
NULL
);

172 
	`sigaùiÚ
(
SIGILL
, &
aù
, 
NULL
);

173 
	}
}

179 
	$»dis_check_rdb
(*
rdbf’ame
, 
FILE
 *
å
) {

180 
ušt64_t
 
dbid
;

181 
ty³
, 
rdbv”
;

182 
buf
[1024];

183 
expœ‘ime
, 
now
 = 
	`m¡ime
();

184 
rio
 
rdb
;

186 
şo£fe
 = (
å
 =ğ
NULL
);

187 ià(
å
 =ğ
NULL
 && (å = 
	`fİ’
(
rdbf’ame
,"r")) == NULL)  1;

189 
	`rioIn™W™hFe
(&
rdb
,
å
);

190 
rdb¡©e
.
rio
 = &
rdb
;

191 
rdb
.
upd©e_cksum
 = 
rdbLßdProg»ssC®lback
;

192 ià(
	`rioR—d
(&
rdb
,
buf
,9è=ğ0è
eoã¼
;

193 
buf
[9] = '\0';

194 ià(
	`memcmp
(
buf
,"REDIS",5) != 0) {

195 
	`rdbCheckE¼Ü
("Wrong signatureryingo†oad DB from file");

196 
”r
;

198 
rdbv”
 = 
	`©oi
(
buf
+5);

199 ià(
rdbv”
 < 1 ||„dbv” > 
RDB_VERSION
) {

200 
	`rdbCheckE¼Ü
("Cª'ˆhªdË RDB fÜm© v”siÚ %d",
rdbv”
);

201 
”r
;

204 
	`¡¬tLßdšg
(
å
);

206 
robj
 *
key
, *
v®
;

207 
expœ‘ime
 = -1;

210 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_TYPE
;

211 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

214 ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME
) {

215 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_EXPIRE
;

219 ià((
expœ‘ime
 = 
	`rdbLßdTime
(&
rdb
)è=ğ-1è
eoã¼
;

221 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_TYPE
;

222 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

225 
expœ‘ime
 *= 1000;

226 } ià(
ty³
 =ğ
RDB_OPCODE_EXPIRETIME_MS
) {

229 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_EXPIRE
;

230 ià((
expœ‘ime
 = 
	`rdbLßdMli£cÚdTime
(&
rdb
)è=ğ-1è
eoã¼
;

232 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_TYPE
;

233 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

234 } ià(
ty³
 =ğ
RDB_OPCODE_EOF
) {

237 } ià(
ty³
 =ğ
RDB_OPCODE_SELECTDB
) {

239 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_LEN
;

240 ià((
dbid
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

241 
eoã¼
;

242 
	`rdbCheckInfo
("S–eùšg DB ID %d", 
dbid
);

244 } ià(
ty³
 =ğ
RDB_OPCODE_RESIZEDB
) {

247 
ušt64_t
 
db_size
, 
expœes_size
;

248 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_LEN
;

249 ià((
db_size
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

250 
eoã¼
;

251 ià((
expœes_size
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
RDB_LENERR
)

252 
eoã¼
;

254 } ià(
ty³
 =ğ
RDB_OPCODE_AUX
) {

260 
robj
 *
auxkey
, *
auxv®
;

261 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_AUX
;

262 ià((
auxkey
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

263 ià((
auxv®
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

265 
	`rdbCheckInfo
("AUX FIELD %s = '%s'",

266 (*)
auxkey
->
±r
, (*)
auxv®
->ptr);

267 
	`deüRefCouÁ
(
auxkey
);

268 
	`deüRefCouÁ
(
auxv®
);

271 ià(!
	`rdbIsObjeùTy³
(
ty³
)) {

272 
	`rdbCheckE¼Ü
("Inv®id objeùy³: %d", 
ty³
);

273 
”r
;

275 
rdb¡©e
.
key_ty³
 = 
ty³
;

279 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_KEY
;

280 ià((
key
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

281 
rdb¡©e
.
key
 = key;

282 
rdb¡©e
.
keys
++;

284 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_READ_OBJECT_VALUE
;

285 ià((
v®
 = 
	`rdbLßdObjeù
(
ty³
,&
rdb
)è=ğ
NULL
è
eoã¼
;

291 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 && 
expœ‘ime
 !ğ-1 &&ƒxpœ‘im< 
now
)

292 
rdb¡©e
.
®»ady_expœed
++;

293 ià(
expœ‘ime
 !ğ-1è
rdb¡©e
.
expœes
++;

294 
rdb¡©e
.
key
 = 
NULL
;

295 
	`deüRefCouÁ
(
key
);

296 
	`deüRefCouÁ
(
v®
);

297 
rdb¡©e
.
key_ty³
 = -1;

300 ià(
rdbv”
 >ğ5 && 
£rv”
.
rdb_checksum
) {

301 
ušt64_t
 
cksum
, 
ex³ùed
 = 
rdb
.cksum;

303 
rdb¡©e
.
došg
 = 
RDB_CHECK_DOING_CHECK_SUM
;

304 ià(
	`rioR—d
(&
rdb
,&
cksum
,8è=ğ0è
eoã¼
;

305 
	`mem»v64ifbe
(&
cksum
);

306 ià(
cksum
 == 0) {

307 
	`rdbCheckInfo
("RDB file was saved with checksum disabled:‚o check…erformed.");

308 } ià(
cksum
 !ğ
ex³ùed
) {

309 
	`rdbCheckE¼Ü
("RDB CRCƒrror");

310 
”r
;

312 
	`rdbCheckInfo
("Checksum OK");

316 ià(
şo£fe
è
	`fşo£
(
å
);

319 
eoã¼
:

320 ià(
rdb¡©e
.
”rÜ_£t
) {

321 
	`rdbCheckE¼Ü
(
rdb¡©e
.
”rÜ
);

323 
	`rdbCheckE¼Ü
("Unexpected EOF„eading RDB file");

325 
”r
:

326 ià(
şo£fe
è
	`fşo£
(
å
);

328 
	}
}

342 
	$»dis_check_rdb_maš
(
¬gc
, **
¬gv
, 
FILE
 *
å
) {

343 ià(
¬gc
 !ğ2 && 
å
 =ğ
NULL
) {

344 
	`årštf
(
¡d”r
, "U§ge: % <rdb-fe-Çme>\n", 
¬gv
[0]);

345 
	`ex™
(1);

350 ià(
sh¬ed
.
š‹g”s
[0] =ğ
NULL
)

351 
	`ü—‹Sh¬edObjeùs
();

352 
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 = 0;

353 
rdbCheckMode
 = 1;

354 
	`rdbCheckInfo
("Checkšg RDB f%s", 
¬gv
[1]);

355 
	`rdbCheckS‘upSigÇls
();

356 
»tv®
 = 
	`»dis_check_rdb
(
¬gv
[1],
å
);

357 ià(
»tv®
 == 0) {

358 
	`rdbCheckInfo
("\\o/ RDB†ooks OK! \\o/");

359 
	`rdbShowG’”icInfo
();

361 ià(
å
è (
»tv®
 =ğ0è? 
C_OK
 : 
C_ERR
;

362 
	`ex™
(
»tv®
);

363 
	}
}

	@src/redis-cli.c

31 
	~"fmaüos.h
"

32 
	~"v”siÚ.h
"

34 
	~<¡dio.h
>

35 
	~<¡ršg.h
>

36 
	~<¡dlib.h
>

37 
	~<sigÇl.h
>

38 
	~<uni¡d.h
>

39 
	~<time.h
>

40 
	~<ùy³.h
>

41 
	~<”ºo.h
>

42 
	~<sys/¡©.h
>

43 
	~<sys/time.h
>

44 
	~<as£¹.h
>

45 
	~<fú.h
>

46 
	~<lim™s.h
>

47 
	~<m©h.h
>

49 
	~<hœedis.h
>

50 
	~<sds.h
>

51 
	~"zm®loc.h
"

52 
	~"lš’oi£.h
"

53 
	~"h–p.h
"

54 
	~"ª‘.h
"

55 
	~"«.h
"

57 
	#UNUSED
(
V
è((èV)

	)

59 
	#OUTPUT_STANDARD
 0

	)

60 
	#OUTPUT_RAW
 1

	)

61 
	#OUTPUT_CSV
 2

	)

62 
	#REDIS_CLI_KEEPALIVE_INTERVAL
 15

	)

63 
	#REDIS_CLI_DEFAULT_PIPE_TIMEOUT
 30

	)

64 
	#REDIS_CLI_HISTFILE_ENV
 "REDISCLI_HISTFILE"

	)

65 
	#REDIS_CLI_HISTFILE_DEFAULT
 ".»disşi_hi¡Üy"

	)

66 
	#REDIS_CLI_RCFILE_ENV
 "REDISCLI_RCFILE"

	)

67 
	#REDIS_CLI_RCFILE_DEFAULT
 ".»disşœc"

	)

70 
	g¥eùrum_·Ë‰e_cŞÜ_size
 = 19;

71 
	g¥eùrum_·Ë‰e_cŞÜ
[] = {0,233,234,235,237,239,241,243,245,247,144,143,142,184,226,214,208,202,196};

73 
	g¥eùrum_·Ë‰e_mÚo_size
 = 13;

74 
	g¥eùrum_·Ë‰e_mÚo
[] = {0,233,234,235,237,239,241,243,245,247,249,251,253};

77 *
	g¥eùrum_·Ë‰e
;

78 
	g¥eùrum_·Ë‰e_size
;

80 
»disCÚ‹xt
 *
	gcÚ‹xt
;

81 
	scÚfig
 {

82 *
	mho¡
;

83 
	mho¡pÜt
;

84 *
	mho¡sock‘
;

85 
	m»³©
;

86 
	mš‹rv®
;

87 
	mdbnum
;

88 
	mš‹¿ùive
;

89 
	mshutdown
;

90 
	mmÚ™Ü_mode
;

91 
	mpubsub_mode
;

92 
	mÏ‹ncy_mode
;

93 
	mÏ‹ncy_di¡_mode
;

94 
	mÏ‹ncy_hi¡Üy
;

95 
	mÌu_‹¡_mode
;

96 
	mÌu_‹¡_§m¶e_size
;

97 
	mşu¡”_mode
;

98 
	mşu¡”_»issue_commªd
;

99 
	m¦ave_mode
;

100 
	mpe_mode
;

101 
	mpe_timeout
;

102 
	mg‘rdb_mode
;

103 
	m¡©_mode
;

104 
	msÿn_mode
;

105 
	mšŒšsic_Ï‹ncy_mode
;

106 
	mšŒšsic_Ï‹ncy_du¿tiÚ
;

107 *
	m·‰”n
;

108 *
	mrdb_f’ame
;

109 
	mbigkeys
;

110 
	mhÙkeys
;

111 
	m¡dš¬g
;

112 *
	mauth
;

113 
	mouut
;

114 
sds
 
	mmb_d–im
;

115 
	m´om±
[128];

116 *
	mev®
;

117 
	mev®_ldb
;

118 
	mev®_ldb_sync
;

119 
	mev®_ldb_’d
;

120 
	m’abË_ldb_Ú_ev®
;

121 
	mÏ¡_cmd_ty³
;

122 } 
	gcÚfig
;

125 
	s´ef
 {

126 
	mhšts
;

127 } 
	g´ef
;

129 vŞ©
sig_©omic_t
 
	gfÜû_ÿnûl_loİ
 = 0;

130 
u§ge
();

131 
¦aveMode
();

132 *
»disG™SHA1
();

133 *
»disG™Dœty
();

134 
şiCÚÃù
(
fÜû
);

140 
	$u¡ime
() {

141 
timev®
 
tv
;

142 
u¡
;

144 
	`g‘timeofday
(&
tv
, 
NULL
);

145 
u¡
 = (()
tv
.
tv_£c
)*1000000;

146 
u¡
 +ğ
tv
.
tv_u£c
;

147  
u¡
;

148 
	}
}

150 
	$m¡ime
() {

151  
	`u¡ime
()/1000;

152 
	}
}

154 
	$şiReäeshProm±
() {

155 ià(
cÚfig
.
ev®_ldb
) ;

157 
sds
 
´om±
 = 
	`sd£m±y
();

158 ià(
cÚfig
.
ho¡sock‘
 !ğ
NULL
) {

159 
´om±
 = 
	`sdsÿtfmt
Õrom±,"»di %s",
cÚfig
.
ho¡sock‘
);

161 
addr
[256];

162 
	`ª‘FÜm©Addr
(
addr
, ×ddr), 
cÚfig
.
ho¡
, cÚfig.
ho¡pÜt
);

163 
´om±
 = 
	`sdsÿ’
Õrom±,
addr
,
	`¡¾’
(addr));

167 ià(
cÚfig
.
dbnum
 != 0)

168 
´om±
 = 
	`sdsÿtfmt
Õrom±,"[%i]",
cÚfig
.
dbnum
);

171 
´om±
 = 
	`sdsÿ’
(prompt,"> ",2);

172 
	`¢´štf
(
cÚfig
.
´om±
,(config.prompt),"%s",prompt);

173 
	`sdsä“
(
´om±
);

174 
	}
}

184 
sds
 
	$g‘DÙfeP©h
(*
’vov”ride
, *
dÙf’ame
) {

185 *
·th
 = 
NULL
;

186 
sds
 
dÙP©h
 = 
NULL
;

189 
·th
 = 
	`g‘’v
(
’vov”ride
);

190 ià(
·th
 !ğ
NULL
 && *path != '\0') {

191 ià(!
	`¡rcmp
("/dev/nuÎ", 
·th
)) {

192  
NULL
;

196 
dÙP©h
 = 
	`sd¢ew
(
·th
);

198 *
home
 = 
	`g‘’v
("HOME");

199 ià(
home
 !ğ
NULL
 && *home != '\0') {

201 
dÙP©h
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s/%s", 
home
, 
dÙf’ame
);

204  
dÙP©h
;

205 
	}
}

208 
	#isHexCh¬
(
c
è(
	`isdig™
(cè|| (ø>ğ'a' && c <ğ'f'))

	)

209 
	#decodeHexCh¬
(
c
è(
	`isdig™
(cè? c - '0' : c - 'a' + 10)

	)

210 
	#decodeHex
(
h
, 
l
è((
	`decodeHexCh¬
(hè<< 4è+ decodeHexCh¬Ö))

	)

212 
sds
 
	$³rûÁDecode
(cÚ¡ *
³
, 
size_t
 
Ën
) {

213 cÚ¡ *
’d
 = 
³
 + 
Ën
;

214 
sds
 
»t
 = 
	`sd£m±y
();

215 cÚ¡ *
cu¼
 = 
³
;

217 
cu¼
 < 
’d
) {

218 ià(*
cu¼
 == '%') {

219 ià((
’d
 - 
cu¼
) < 2) {

220 
	`årštf
(
¡d”r
, "Incomplete URIƒncoding\n");

221 
	`ex™
(1);

224 
h
 = 
	`tŞow”
(*(++
cu¼
));

225 
l
 = 
	`tŞow”
(*(++
cu¼
));

226 ià(!
	`isHexCh¬
(
h
è|| !isHexCh¬(
l
)) {

227 
	`årštf
(
¡d”r
, "Illegal character in URIƒncoding\n");

228 
	`ex™
(1);

230 
c
 = 
	`decodeHex
(
h
, 
l
);

231 
»t
 = 
	`sdsÿ’
Ô‘, &
c
, 1);

232 
cu¼
++;

234 
»t
 = 
	`sdsÿ’
Ô‘, 
cu¼
++, 1);

238  
»t
;

239 
	}
}

249 
	$·r£RedisUri
(cÚ¡ *
uri
) {

251 cÚ¡ *
scheme
 = "redis://";

252 cÚ¡ *
cu¼
 = 
uri
;

253 cÚ¡ *
’d
 = 
uri
 + 
	`¡¾’
(uri);

254 cÚ¡ *
u£ršfo
, *
u£ºame
, *
pÜt
, *
ho¡
, *
·th
;

257 ià(
	`¡ºÿ£cmp
(
scheme
, 
cu¼
, 
	`¡¾’
(scheme))) {

258 
	`årštf
(
¡d”r
,"Invalid URI scheme\n");

259 
	`ex™
(1);

261 
cu¼
 +ğ
	`¡¾’
(
scheme
);

262 ià(
cu¼
 =ğ
’d
) ;

265 ià((
u£ršfo
 = 
	`¡rchr
(
cu¼
,'@'))) {

266 ià((
u£ºame
 = 
	`¡rchr
(
cu¼
, ':')è&& u£ºam< 
u£ršfo
) {

268 
cu¼
 = 
u£ºame
 + 1;

271 
cÚfig
.
auth
 = 
	`³rûÁDecode
(
cu¼
, 
u£ršfo
 - curr);

272 
cu¼
 = 
u£ršfo
 + 1;

274 ià(
cu¼
 =ğ
’d
) ;

277 
·th
 = 
	`¡rchr
(
cu¼
, '/');

278 ià(*
cu¼
 != '/') {

279 
ho¡
 = 
·th
 ?…©h - 1 : 
’d
;

280 ià((
pÜt
 = 
	`¡rchr
(
cu¼
, ':'))) {

281 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
pÜt
 + 1);

282 
ho¡
 = 
pÜt
 - 1;

284 
cÚfig
.
ho¡
 = 
	`sd¢ewËn
(
cu¼
, 
ho¡
 - curr + 1);

286 
cu¼
 = 
·th
 ?…©h + 1 : 
’d
;

287 ià(
cu¼
 =ğ
’d
) ;

290 
cÚfig
.
dbnum
 = 
	`©oi
(
cu¼
);

291 
	}
}

297 
	#CLI_HELP_COMMAND
 1

	)

298 
	#CLI_HELP_GROUP
 2

	)

301 
	mty³
;

302 
	m¬gc
;

303 
sds
 *
	m¬gv
;

304 
sds
 
	mfuÎ
;

307 
commªdH–p
 *
	mÜg
;

308 } 
	th–pEÁry
;

310 
h–pEÁry
 *
	gh–pEÁr›s
;

311 
	gh–pEÁr›sL’
;

313 
sds
 
	$şiV”siÚ
() {

314 
sds
 
v”siÚ
;

315 
v”siÚ
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s", 
REDIS_VERSION
);

318 ià(
	`¡¹Şl
(
	`»disG™SHA1
(),
NULL
,16)) {

319 
v”siÚ
 = 
	`sdsÿrštf
(v”siÚ, " (g™:%s", 
	`»disG™SHA1
());

320 ià(
	`¡¹Şl
(
	`»disG™Dœty
(),
NULL
,10))

321 
v”siÚ
 = 
	`sdsÿrštf
(version, "-dirty");

322 
v”siÚ
 = 
	`sdsÿt
(version, ")");

324  
v”siÚ
;

325 
	}
}

327 
	$şiIn™H–p
() {

328 
commªd¦’
 = (
commªdH–p
)/(commandHelp);

329 
group¦’
 = (
commªdGroups
)/(*);

330 
i
, 
Ën
, 
pos
 = 0;

331 
h–pEÁry
 
tmp
;

333 
h–pEÁr›sL’
 = 
Ën
 = 
commªd¦’
+
group¦’
;

334 
h–pEÁr›s
 = 
	`zm®loc
((
h–pEÁry
)*
Ën
);

336 
i
 = 0; i < 
group¦’
; i++) {

337 
tmp
.
¬gc
 = 1;

338 
tmp
.
¬gv
 = 
	`zm®loc
((
sds
));

339 
tmp
.
¬gv
[0] = 
	`sdsÿrštf
(
	`sd£m±y
(),"@%s",
commªdGroups
[
i
]);

340 
tmp
.
fuÎ
 =mp.
¬gv
[0];

341 
tmp
.
ty³
 = 
CLI_HELP_GROUP
;

342 
tmp
.
Üg
 = 
NULL
;

343 
h–pEÁr›s
[
pos
++] = 
tmp
;

346 
i
 = 0; i < 
commªd¦’
; i++) {

347 
tmp
.
¬gv
 = 
	`sds¥l™¬gs
(
commªdH–p
[
i
].
Çme
,&tmp.
¬gc
);

348 
tmp
.
fuÎ
 = 
	`sd¢ew
(
commªdH–p
[
i
].
Çme
);

349 
tmp
.
ty³
 = 
CLI_HELP_COMMAND
;

350 
tmp
.
Üg
 = &
commªdH–p
[
i
];

351 
h–pEÁr›s
[
pos
++] = 
tmp
;

353 
	}
}

360 
	$şiIÁeg¿‹H–p
() {

361 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
) ;

363 
»disR•ly
 *
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
, "COMMAND");

364 if(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_ARRAY
) ;

368 
size_t
 
j
 = 0; j < 
»¶y
->
–em’ts
; j++) {

369 
»disR•ly
 *
’Œy
 = 
»¶y
->
–em’t
[
j
];

370 ià(
’Œy
->
ty³
 !ğ
REDIS_REPLY_ARRAY
 ||ƒÁry->
–em’ts
 < 4 ||

371 
’Œy
->
–em’t
[0]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

372 
’Œy
->
–em’t
[1]->
ty³
 !ğ
REDIS_REPLY_INTEGER
 ||

373 
’Œy
->
–em’t
[3]->
ty³
 !ğ
REDIS_REPLY_INTEGER
) ;

374 *
cmdÇme
 = 
’Œy
->
–em’t
[0]->
¡r
;

375 
i
;

377 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

378 
h–pEÁry
 *
he
 = 
h–pEÁr›s
+
i
;

379 ià(!
	`¡rÿ£cmp
(
he
->
¬gv
[0],
cmdÇme
))

382 ià(
i
 !ğ
h–pEÁr›sL’
) ;

384 
h–pEÁr›sL’
++;

385 
h–pEÁr›s
 = 
	`z»®loc
(h–pEÁr›s,(
h–pEÁry
)*
h–pEÁr›sL’
);

386 
h–pEÁry
 *
Ãw
 = 
h–pEÁr›s
+(
h–pEÁr›sL’
-1);

388 
Ãw
->
¬gc
 = 1;

389 
Ãw
->
¬gv
 = 
	`zm®loc
((
sds
));

390 
Ãw
->
¬gv
[0] = 
	`sd¢ew
(
cmdÇme
);

391 
Ãw
->
fuÎ
 =‚ew->
¬gv
[0];

392 
Ãw
->
ty³
 = 
CLI_HELP_COMMAND
;

393 
	`sd¡ouµ”
(
Ãw
->
¬gv
[0]);

395 
commªdH–p
 *
ch
 = 
	`zm®loc
((*ch));

396 
ch
->
Çme
 = 
Ãw
->
¬gv
[0];

397 
ch
->
·¿ms
 = 
	`sd£m±y
();

398 
¬gs
 = 
	`Îabs
(
’Œy
->
–em’t
[1]->
š‹g”
);

399 ià(
’Œy
->
–em’t
[3]->
š‹g”
 == 1) {

400 
ch
->
·¿ms
 = 
	`sdsÿt
(ch->params,"key ");

401 
¬gs
--;

403 
¬gs
--è
ch
->
·¿ms
 = 
	`sdsÿt
(ch->params,"arg ");

404 ià(
’Œy
->
–em’t
[1]->
š‹g”
 < 0)

405 
ch
->
·¿ms
 = 
	`sdsÿt
(ch->params,"...options...");

406 
ch
->
summ¬y
 = "Help‚ot‡vailable";

407 
ch
->
group
 = 0;

408 
ch
->
sšû
 = "not known";

409 
Ãw
->
Üg
 = 
ch
;

411 
	`ä“R•lyObjeù
(
»¶y
);

412 
	}
}

415 
	$şiOuutCommªdH–p
(
commªdH–p
 *
h–p
, 
group
) {

416 
	`´štf
("\r\À \x1b[1m%s\x1b[0m \x1b[90m%s\x1b[0m\r\n", 
h–p
->
Çme
, h–p->
·¿ms
);

417 
	`´štf
(" \x1b[33msumm¬y:\x1b[0m %s\r\n", 
h–p
->
summ¬y
);

418 
	`´štf
(" \x1b[33msšû:\x1b[0m %s\r\n", 
h–p
->
sšû
);

419 ià(
group
) {

420 
	`´štf
(" \x1b[33mgroup:\x1b[0m %s\r\n", 
commªdGroups
[
h–p
->
group
]);

422 
	}
}

425 
	$şiOuutG’”icH–p
() {

426 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

427 
	`´štf
(

439 
v”siÚ


441 
	`sdsä“
(
v”siÚ
);

442 
	}
}

445 
	$şiOuutH–p
(
¬gc
, **
¬gv
) {

446 
i
, 
j
, 
Ën
;

447 
group
 = -1;

448 
h–pEÁry
 *
’Œy
;

449 
commªdH–p
 *
h–p
;

451 ià(
¬gc
 == 0) {

452 
	`şiOuutG’”icH–p
();

454 } ià(
¬gc
 > 0 && 
¬gv
[0][0] == '@') {

455 
Ën
 = (
commªdGroups
)/(*);

456 
i
 = 0; i < 
Ën
; i++) {

457 ià(
	`¡rÿ£cmp
(
¬gv
[0]+1,
commªdGroups
[
i
]) == 0) {

458 
group
 = 
i
;

464 
	`as£¹
(
¬gc
 > 0);

465 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

466 
’Œy
 = &
h–pEÁr›s
[
i
];

467 ià(
’Œy
->
ty³
 !ğ
CLI_HELP_COMMAND
) ;

469 
h–p
 = 
’Œy
->
Üg
;

470 ià(
group
 == -1) {

472 ià(
¬gc
 =ğ
’Œy
->argc) {

473 
j
 = 0; j < 
¬gc
; j++) {

474 ià(
	`¡rÿ£cmp
(
¬gv
[
j
],
’Œy
->argv[j]) != 0) ;

476 ià(
j
 =ğ
¬gc
) {

477 
	`şiOuutCommªdH–p
(
h–p
,1);

481 ià(
group
 =ğ
h–p
->group) {

482 
	`şiOuutCommªdH–p
(
h–p
,0);

486 
	`´štf
("\r\n");

487 
	}
}

490 
	$com¶‘iÚC®lback
(cÚ¡ *
buf
, 
lš’oi£Com¶‘iÚs
 *
lc
) {

491 
size_t
 
¡¬os
 = 0;

492 
mask
;

493 
i
;

494 
size_t
 
m©chËn
;

495 
sds
 
tmp
;

497 ià(
	`¡ºÿ£cmp
(
buf
,"help ",5) == 0) {

498 
¡¬os
 = 5;

499 
	`is¥aû
(
buf
[
¡¬os
])) startpos++;

500 
mask
 = 
CLI_HELP_COMMAND
 | 
CLI_HELP_GROUP
;

502 
mask
 = 
CLI_HELP_COMMAND
;

505 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

506 ià(!(
h–pEÁr›s
[
i
].
ty³
 & 
mask
)) ;

508 
m©chËn
 = 
	`¡¾’
(
buf
+
¡¬os
);

509 ià(
	`¡ºÿ£cmp
(
buf
+
¡¬os
,
h–pEÁr›s
[
i
].
fuÎ
,
m©chËn
) == 0) {

510 
tmp
 = 
	`sd¢ewËn
(
buf
,
¡¬os
);

511 
tmp
 = 
	`sdsÿt
Ñmp,
h–pEÁr›s
[
i
].
fuÎ
);

512 
	`lš’oi£AddCom¶‘iÚ
(
lc
,
tmp
);

513 
	`sdsä“
(
tmp
);

516 
	}
}

519 *
	$hštsC®lback
(cÚ¡ *
buf
, *
cŞÜ
, *
bŞd
) {

520 ià(!
´ef
.
hšts
è 
NULL
;

522 
i
, 
¬gc
, 
buæ’
 = 
	`¡¾’
(
buf
);

523 
sds
 *
¬gv
 = 
	`sds¥l™¬gs
(
buf
,&
¬gc
);

524 
’d¥aû
 = 
buæ’
 && 
	`is¥aû
(
buf
[buflen-1]);

527 ià(
¬gc
 == 0) {

528 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

529  
NULL
;

532 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

533 ià(!(
h–pEÁr›s
[
i
].
ty³
 & 
CLI_HELP_COMMAND
)) ;

535 ià(
	`¡rÿ£cmp
(
¬gv
[0],
h–pEÁr›s
[
i
].
fuÎ
) == 0)

537 *
cŞÜ
 = 90;

538 *
bŞd
 = 0;

539 
sds
 
hšt
 = 
	`sd¢ew
(
h–pEÁr›s
[
i
].
Üg
->
·¿ms
);

543 
tÜemove
 = 
¬gc
-1;

544 
tÜemove
 > 0 && 
	`sd¦’
(
hšt
)) {

545 ià(
hšt
[0] == '[') ;

546 ià(
hšt
[0] =ğ' 'è
tÜemove
--;

547 
	`sd¤ªge
(
hšt
,1,-1);

551 ià(!
’d¥aû
) {

552 
sds
 
Ãwhšt
 = 
	`sd¢ewËn
(" ",1);

553 
Ãwhšt
 = 
	`sdsÿtsds
Òewhšt,
hšt
);

554 
	`sdsä“
(
hšt
);

555 
hšt
 = 
Ãwhšt
;

558 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

559  
hšt
;

562 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

563  
NULL
;

564 
	}
}

566 
	$ä“HštsC®lback
(*
±r
) {

567 
	`sdsä“
(
±r
);

568 
	}
}

575 
	$şiAuth
() {

576 
»disR•ly
 *
»¶y
;

577 ià(
cÚfig
.
auth
 =ğ
NULL
è 
REDIS_OK
;

579 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"AUTH %s",
cÚfig
.
auth
);

580 ià(
»¶y
 !ğ
NULL
) {

581 
	`ä“R•lyObjeù
(
»¶y
);

582  
REDIS_OK
;

584  
REDIS_ERR
;

585 
	}
}

588 
	$şiS–eù
() {

589 
»disR•ly
 *
»¶y
;

590 ià(
cÚfig
.
dbnum
 =ğ0è 
REDIS_OK
;

592 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SELECT %d",
cÚfig
.
dbnum
);

593 ià(
»¶y
 !ğ
NULL
) {

594 
»suÉ
 = 
REDIS_OK
;

595 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
è
»suÉ
 = 
REDIS_ERR
;

596 
	`ä“R•lyObjeù
(
»¶y
);

597  
»suÉ
;

599  
REDIS_ERR
;

600 
	}
}

604 
	$şiCÚÃù
(
fÜû
) {

605 ià(
cÚ‹xt
 =ğ
NULL
 || 
fÜû
) {

606 ià(
cÚ‹xt
 !ğ
NULL
) {

607 
	`»disF»e
(
cÚ‹xt
);

610 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
) {

611 
cÚ‹xt
 = 
	`»disCÚÃù
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

613 
cÚ‹xt
 = 
	`»disCÚÃùUnix
(
cÚfig
.
ho¡sock‘
);

616 ià(
cÚ‹xt
->
”r
) {

617 
	`årštf
(
¡d”r
,"Could‚ot connecto Redis‡t ");

618 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
)

619 
	`årštf
(
¡d”r
,"%s:%d: %s\n",
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
,
cÚ‹xt
->
”r¡r
);

621 
	`årštf
(
¡d”r
,"%s: %s\n",
cÚfig
.
ho¡sock‘
,
cÚ‹xt
->
”r¡r
);

622 
	`»disF»e
(
cÚ‹xt
);

623 
cÚ‹xt
 = 
NULL
;

624  
REDIS_ERR
;

631 
	`ª‘K“pAlive
(
NULL
, 
cÚ‹xt
->
fd
, 
REDIS_CLI_KEEPALIVE_INTERVAL
);

634 ià(
	`şiAuth
(è!ğ
REDIS_OK
)

635  
REDIS_ERR
;

636 ià(
	`şiS–eù
(è!ğ
REDIS_OK
)

637  
REDIS_ERR
;

639  
REDIS_OK
;

640 
	}
}

642 
	$şiPrštCÚ‹xtE¼Ü
() {

643 ià(
cÚ‹xt
 =ğ
NULL
) ;

644 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
cÚ‹xt
->
”r¡r
);

645 
	}
}

647 
sds
 
	$şiFÜm©R•lyTTY
(
»disR•ly
 *
r
, *
´efix
) {

648 
sds
 
out
 = 
	`sd£m±y
();

649 
r
->
ty³
) {

650 
REDIS_REPLY_ERROR
:

651 
out
 = 
	`sdsÿrštf
(out,"Ó¼Üè%s\n", 
r
->
¡r
);

653 
REDIS_REPLY_STATUS
:

654 
out
 = 
	`sdsÿt
(out,
r
->
¡r
);

655 
out
 = 
	`sdsÿt
(out,"\n");

657 
REDIS_REPLY_INTEGER
:

658 
out
 = 
	`sdsÿrštf
(out,"(š‹g”è%Îd\n",
r
->
š‹g”
);

660 
REDIS_REPLY_STRING
:

663 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

664 
out
 = 
	`sdsÿt
(out,"\n");

666 
REDIS_REPLY_NIL
:

667 
out
 = 
	`sdsÿt
(out,"(nil)\n");

669 
REDIS_REPLY_ARRAY
:

670 ià(
r
->
–em’ts
 == 0) {

671 
out
 = 
	`sdsÿt
(out,"(empty†ist or set)\n");

673 
i
, 
idxËn
 = 0;

674 
_´efixËn
[16];

675 
_´efixfmt
[16];

676 
sds
 
_´efix
;

677 
sds
 
tmp
;

680 
i
 = 
r
->
–em’ts
;

682 
idxËn
++;

683 
i
 /= 10;

684 } 
i
);

687 
	`mem£t
(
_´efixËn
,' ',
idxËn
+2);

688 
_´efixËn
[
idxËn
+2] = '\0';

689 
_´efix
 = 
	`sdsÿt
(
	`sd¢ew
(
´efix
),
_´efixËn
);

692 
	`¢´štf
(
_´efixfmt
,(_´efixfmt),"%%s%%%udè",
idxËn
);

694 
i
 = 0; i < 
r
->
–em’ts
; i++) {

697 
out
 = 
	`sdsÿrštf
(out,
_´efixfmt
,
i
 =ğ0 ? "" : 
´efix
,i+1);

700 
tmp
 = 
	`şiFÜm©R•lyTTY
(
r
->
–em’t
[
i
],
_´efix
);

701 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

702 
	`sdsä“
(
tmp
);

704 
	`sdsä“
(
_´efix
);

708 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

709 
	`ex™
(1);

711  
out
;

712 
	}
}

714 
	$isCŞÜT”m
() {

715 *
t
 = 
	`g‘’v
("TERM");

716  
t
 !ğ
NULL
 && 
	`¡r¡r
(t,"xterm") != NULL;

717 
	}
}

721 
sds
 
	$sdsÿtcŞÜ
(
sds
 
o
, *
s
, 
size_t
 
Ën
, *
cŞÜ
) {

722 ià(!
	`isCŞÜT”m
()è 
	`sdsÿ’
(
o
,
s
,
Ën
);

724 
bŞd
 = 
	`¡r¡r
(
cŞÜ
,"bŞd"è!ğ
NULL
;

725 
ccode
 = 37;

726 ià(
	`¡r¡r
(
cŞÜ
,"»d")è
ccode
 = 31;

727 ià(
	`¡r¡r
(
cŞÜ
,"g»’")è
ccode
 = 32;

728 ià(
	`¡r¡r
(
cŞÜ
,"y–low")è
ccode
 = 33;

729 ià(
	`¡r¡r
(
cŞÜ
,"blue")è
ccode
 = 34;

730 ià(
	`¡r¡r
(
cŞÜ
,"mag’")è
ccode
 = 35;

731 ià(
	`¡r¡r
(
cŞÜ
,"cyª")è
ccode
 = 36;

732 ià(
	`¡r¡r
(
cŞÜ
,"wh™e")è
ccode
 = 37;

734 
o
 = 
	`sdsÿtfmt
(o,"\033[%i;%i;49m",
bŞd
,
ccode
);

735 
o
 = 
	`sdsÿ’
(o,
s
,
Ën
);

736 
o
 = 
	`sdsÿt
(o,"\033[0m");

737  
o
;

738 
	}
}

742 
sds
 
	$sdsC©CŞÜizedLdbR•ly
(
sds
 
o
, *
s
, 
size_t
 
Ën
) {

743 *
cŞÜ
 = "white";

745 ià(
	`¡r¡r
(
s
,"<debug>")è
cŞÜ
 = "bold";

746 ià(
	`¡r¡r
(
s
,"<»dis>")è
cŞÜ
 = "green";

747 ià(
	`¡r¡r
(
s
,"<»¶y>")è
cŞÜ
 = "cyan";

748 ià(
	`¡r¡r
(
s
,"<”rÜ>")è
cŞÜ
 = "red";

749 ià(
	`¡r¡r
(
s
,"<hšt>")è
cŞÜ
 = "bold";

750 ià(
	`¡r¡r
(
s
,"<v®ue>"è|| sŒ¡r(s,"<»tv®>")è
cŞÜ
 = "magenta";

751 ià(
Ën
 > 4 && 
	`isdig™
(
s
[3])) {

752 ià(
s
[1] =ğ'>'è
cŞÜ
 = "yellow";

753 ià(
s
[2] =ğ'#'è
cŞÜ
 = "bold";

755  
	`sdsÿtcŞÜ
(
o
,
s
,
Ën
,
cŞÜ
);

756 
	}
}

758 
sds
 
	$şiFÜm©R•lyRaw
(
»disR•ly
 *
r
) {

759 
sds
 
out
 = 
	`sd£m±y
(), 
tmp
;

760 
size_t
 
i
;

762 
r
->
ty³
) {

763 
REDIS_REPLY_NIL
:

766 
REDIS_REPLY_ERROR
:

767 
out
 = 
	`sdsÿ’
(out,
r
->
¡r
,r->
Ën
);

768 
out
 = 
	`sdsÿ’
(out,"\n",1);

770 
REDIS_REPLY_STATUS
:

771 
REDIS_REPLY_STRING
:

772 ià(
r
->
ty³
 =ğ
REDIS_REPLY_STATUS
 && 
cÚfig
.
ev®_ldb
) {

778 ià(
	`¡r¡r
(
r
->
¡r
,"<endsession>") ==„->str) {

779 
cÚfig
.
’abË_ldb_Ú_ev®
 = 0;

780 
cÚfig
.
ev®_ldb
 = 0;

781 
cÚfig
.
ev®_ldb_’d
 = 1;

782 
cÚfig
.
ouut
 = 
OUTPUT_STANDARD
;

783 
	`şiReäeshProm±
();

785 
out
 = 
	`sdsC©CŞÜizedLdbR•ly
(out,
r
->
¡r
,r->
Ën
);

788 
out
 = 
	`sdsÿ’
(out,
r
->
¡r
,r->
Ën
);

791 
REDIS_REPLY_INTEGER
:

792 
out
 = 
	`sdsÿrštf
(out,"%Îd",
r
->
š‹g”
);

794 
REDIS_REPLY_ARRAY
:

795 
i
 = 0; i < 
r
->
–em’ts
; i++) {

796 ià(
i
 > 0è
out
 = 
	`sdsÿt
(out,
cÚfig
.
mb_d–im
);

797 
tmp
 = 
	`şiFÜm©R•lyRaw
(
r
->
–em’t
[
i
]);

798 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

799 
	`sdsä“
(
tmp
);

803 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

804 
	`ex™
(1);

806  
out
;

807 
	}
}

809 
sds
 
	$şiFÜm©R•lyCSV
(
»disR•ly
 *
r
) {

810 
i
;

812 
sds
 
out
 = 
	`sd£m±y
();

813 
r
->
ty³
) {

814 
REDIS_REPLY_ERROR
:

815 
out
 = 
	`sdsÿt
(out,"ERROR,");

816 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,
	`¡¾’
(r->str));

818 
REDIS_REPLY_STATUS
:

819 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

821 
REDIS_REPLY_INTEGER
:

822 
out
 = 
	`sdsÿrštf
(out,"%Îd",
r
->
š‹g”
);

824 
REDIS_REPLY_STRING
:

825 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

827 
REDIS_REPLY_NIL
:

828 
out
 = 
	`sdsÿt
(out,"NIL");

830 
REDIS_REPLY_ARRAY
:

831 
i
 = 0; i < 
r
->
–em’ts
; i++) {

832 
sds
 
tmp
 = 
	`şiFÜm©R•lyCSV
(
r
->
–em’t
[
i
]);

833 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

834 ià(
i
 !ğ
r
->
–em’ts
-1è
out
 = 
	`sdsÿt
(out,",");

835 
	`sdsä“
(
tmp
);

839 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

840 
	`ex™
(1);

842  
out
;

843 
	}
}

845 
	$şiR—dR•ly
(
ouut_¿w_¡ršgs
) {

846 *
_»¶y
;

847 
»disR•ly
 *
»¶y
;

848 
sds
 
out
 = 
NULL
;

849 
ouut
 = 1;

851 ià(
	`»disG‘R•ly
(
cÚ‹xt
,&
_»¶y
è!ğ
REDIS_OK
) {

852 ià(
cÚfig
.
shutdown
) {

853 
	`»disF»e
(
cÚ‹xt
);

854 
cÚ‹xt
 = 
NULL
;

855  
REDIS_OK
;

857 ià(
cÚfig
.
š‹¿ùive
) {

859 ià(
cÚ‹xt
->
”r
 =ğ
REDIS_ERR_IO
 &&

860 (
”ºo
 =ğ
ECONNRESET
 ||ƒ¼nØ=ğ
EPIPE
))

861  
REDIS_ERR
;

862 ià(
cÚ‹xt
->
”r
 =ğ
REDIS_ERR_EOF
)

863  
REDIS_ERR
;

865 
	`şiPrštCÚ‹xtE¼Ü
();

866 
	`ex™
(1);

867  
REDIS_ERR
;

870 
»¶y
 = (
»disR•ly
*)
_»¶y
;

872 
cÚfig
.
Ï¡_cmd_ty³
 = 
»¶y
->
ty³
;

876 ià(
cÚfig
.
şu¡”_mode
 && 
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
 &&

877 (!
	`¡ºcmp
(
»¶y
->
¡r
,"MOVED",5è|| !
	`¡rcmp
(reply->str,"ASK")))

879 *
p
 = 
»¶y
->
¡r
, *
s
;

880 
¦Ù
;

882 
ouut
 = 0;

888 
s
 = 
	`¡rchr
(
p
,' ');

889 
p
 = 
	`¡rchr
(
s
+1,' ');

890 *
p
 = '\0';

891 
¦Ù
 = 
	`©oi
(
s
+1);

892 
s
 = 
	`¡¼chr
(
p
+1,':');

893 *
s
 = '\0';

894 
	`sdsä“
(
cÚfig
.
ho¡
);

895 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
p
+1);

896 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
s
+1);

897 ià(
cÚfig
.
š‹¿ùive
)

898 
	`´štf
("-> Redirectedo slot [%d]†ocated‡t %s:%d\n",

899 
¦Ù
, 
cÚfig
.
ho¡
, cÚfig.
ho¡pÜt
);

900 
cÚfig
.
şu¡”_»issue_commªd
 = 1;

901 
	`şiReäeshProm±
();

904 ià(
ouut
) {

905 ià(
ouut_¿w_¡ršgs
) {

906 
out
 = 
	`şiFÜm©R•lyRaw
(
»¶y
);

908 ià(
cÚfig
.
ouut
 =ğ
OUTPUT_RAW
) {

909 
out
 = 
	`şiFÜm©R•lyRaw
(
»¶y
);

910 
out
 = 
	`sdsÿt
(out,"\n");

911 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_STANDARD
) {

912 
out
 = 
	`şiFÜm©R•lyTTY
(
»¶y
,"");

913 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_CSV
) {

914 
out
 = 
	`şiFÜm©R•lyCSV
(
»¶y
);

915 
out
 = 
	`sdsÿt
(out,"\n");

918 
	`fwr™e
(
out
,
	`sd¦’
(out),1,
¡dout
);

919 
	`sdsä“
(
out
);

921 
	`ä“R•lyObjeù
(
»¶y
);

922  
REDIS_OK
;

923 
	}
}

925 
	$şiS’dCommªd
(
¬gc
, **
¬gv
, 
»³©
) {

926 *
commªd
 = 
¬gv
[0];

927 
size_t
 *
¬gvËn
;

928 
j
, 
ouut_¿w
;

930 ià(!
cÚfig
.
ev®_ldb
 &&

931 (!
	`¡rÿ£cmp
(
commªd
,"help") || !strcasecmp(command,"?"))) {

932 
	`şiOuutH–p
(--
¬gc
, ++
¬gv
);

933  
REDIS_OK
;

936 ià(
cÚ‹xt
 =ğ
NULL
è 
REDIS_ERR
;

938 
ouut_¿w
 = 0;

939 ià(!
	`¡rÿ£cmp
(
commªd
,"info") ||

940 (
¬gc
 >ğ2 && !
	`¡rÿ£cmp
(
commªd
,"debug") &&

941 !
	`¡rÿ£cmp
(
¬gv
[1],"htstats")) ||

942 (
¬gc
 >ğ2 && !
	`¡rÿ£cmp
(
commªd
,"memory") &&

943 (!
	`¡rÿ£cmp
(
¬gv
[1],"malloc-stats") ||

944 !
	`¡rÿ£cmp
(
¬gv
[1],"doctor"))) ||

945 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"cluster") &&

946 (!
	`¡rÿ£cmp
(
¬gv
[1],"nodes") ||

947 !
	`¡rÿ£cmp
(
¬gv
[1],"info"))) ||

948 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"client") &&

949 !
	`¡rÿ£cmp
(
¬gv
[1],"list")) ||

950 (
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
commªd
,"latency") &&

951 !
	`¡rÿ£cmp
(
¬gv
[1],"graph")) ||

952 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"latency") &&

953 !
	`¡rÿ£cmp
(
¬gv
[1],"doctor")))

955 
ouut_¿w
 = 1;

958 ià(!
	`¡rÿ£cmp
(
commªd
,"shutdown")è
cÚfig
.
shutdown
 = 1;

959 ià(!
	`¡rÿ£cmp
(
commªd
,"mÚ™Ü")è
cÚfig
.
mÚ™Ü_mode
 = 1;

960 ià(!
	`¡rÿ£cmp
(
commªd
,"subscribe") ||

961 !
	`¡rÿ£cmp
(
commªd
,"psubsüibe")è
cÚfig
.
pubsub_mode
 = 1;

962 ià(!
	`¡rÿ£cmp
(
commªd
,"sync") ||

963 !
	`¡rÿ£cmp
(
commªd
,"psync")è
cÚfig
.
¦ave_mode
 = 1;

967 ià(
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
¬gv
[0],"script") &&

968 !
	`¡rÿ£cmp
(
¬gv
[1],"debug"))

970 ià(!
	`¡rÿ£cmp
(
¬gv
[2],"yes") || !strcasecmp(argv[2],"sync")) {

971 
cÚfig
.
’abË_ldb_Ú_ev®
 = 1;

973 
cÚfig
.
’abË_ldb_Ú_ev®
 = 0;

978 ià(!
	`¡rÿ£cmp
(
commªd
,"ev®"è&& 
cÚfig
.
’abË_ldb_Ú_ev®
) {

979 
cÚfig
.
ev®_ldb
 = 1;

980 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

984 
¬gvËn
 = 
	`zm®loc
(
¬gc
*(
size_t
));

985 
j
 = 0; j < 
¬gc
; j++)

986 
¬gvËn
[
j
] = 
	`sd¦’
(
¬gv
[j]);

988 
»³©
-- > 0) {

989 
	`»disAµ’dCommªdArgv
(
cÚ‹xt
,
¬gc
,(cÚ¡ **)
¬gv
,
¬gvËn
);

990 
cÚfig
.
mÚ™Ü_mode
) {

991 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
è
	`ex™
(1);

992 
	`fæush
(
¡dout
);

995 ià(
cÚfig
.
pubsub_mode
) {

996 ià(
cÚfig
.
ouut
 !ğ
OUTPUT_RAW
)

997 
	`´štf
("Reading messages... (press Ctrl-Co quit)\n");

999 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
è
	`ex™
(1);

1003 ià(
cÚfig
.
¦ave_mode
) {

1004 
	`´štf
("Entering slave output mode... (press Ctrl-Co quit)\n");

1005 
	`¦aveMode
();

1006 
cÚfig
.
¦ave_mode
 = 0;

1007 
	`zä“
(
¬gvËn
);

1008  
REDIS_ERR
;

1011 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
) {

1012 
	`zä“
(
¬gvËn
);

1013  
REDIS_ERR
;

1016 ià(!
	`¡rÿ£cmp
(
commªd
,"£Ëù"è&& 
¬gc
 =ğ2 && 
cÚfig
.
Ï¡_cmd_ty³
 !ğ
REDIS_REPLY_ERROR
) {

1017 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[1]);

1018 
	`şiReäeshProm±
();

1019 } ià(!
	`¡rÿ£cmp
(
commªd
,"auth"è&& 
¬gc
 == 2) {

1020 
	`şiS–eù
();

1023 ià(
cÚfig
.
š‹rv®
è
	`u¦“p
(config.interval);

1024 
	`fæush
(
¡dout
);

1027 
	`zä“
(
¬gvËn
);

1028  
REDIS_OK
;

1029 
	}
}

1032 
»disR•ly
 *
	$»cÚÃùšgRedisCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fmt
, ...) {

1033 
»disR•ly
 *
»¶y
 = 
NULL
;

1034 
Œ›s
 = 0;

1035 
va_li¡
 
­
;

1037 
	`as£¹
(!
c
->
”r
);

1038 
»¶y
 =ğ
NULL
) {

1039 
c
->
”r
 & (
REDIS_ERR_IO
 | 
REDIS_ERR_EOF
)) {

1040 
	`´štf
("\r\x1b[0K");

1041 
	`´štf
("RecÚÃùšg... %d\r", ++
Œ›s
);

1042 
	`fæush
(
¡dout
);

1044 
	`»disF»e
(
c
);

1045 
c
 = 
	`»disCÚÃù
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

1046 
	`u¦“p
(1000000);

1049 
	`va_¡¬t
(
­
,
fmt
);

1050 
»¶y
 = 
	`»disvCommªd
(
c
,
fmt
,
­
);

1051 
	`va_’d
(
­
);

1053 ià(
c
->
”r
 && !(c->”¸& (
REDIS_ERR_IO
 | 
REDIS_ERR_EOF
))) {

1054 
	`årštf
(
¡d”r
, "E¼Ü: %s\n", 
c
->
”r¡r
);

1055 
	`ex™
(1);

1056 } ià(
Œ›s
 > 0) {

1057 
	`´štf
("\r\x1b[0K");

1061 
cÚ‹xt
 = 
c
;

1062  
»¶y
;

1063 
	}
}

1069 
	$·r£O±iÚs
(
¬gc
, **
¬gv
) {

1070 
i
;

1072 
i
 = 1; i < 
¬gc
; i++) {

1073 
Ï¡¬g
 = 
i
==
¬gc
-1;

1075 ià(!
	`¡rcmp
(
¬gv
[
i
],"-h"è&& !
Ï¡¬g
) {

1076 
	`sdsä“
(
cÚfig
.
ho¡
);

1077 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
¬gv
[++
i
]);

1078 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-h"è&& 
Ï¡¬g
) {

1079 
	`u§ge
();

1080 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--help")) {

1081 
	`u§ge
();

1082 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-x")) {

1083 
cÚfig
.
¡dš¬g
 = 1;

1084 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-p"è&& !
Ï¡¬g
) {

1085 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[++
i
]);

1086 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-s"è&& !
Ï¡¬g
) {

1087 
cÚfig
.
ho¡sock‘
 = 
¬gv
[++
i
];

1088 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-r"è&& !
Ï¡¬g
) {

1089 
cÚfig
.
»³©
 = 
	`¡¹Şl
(
¬gv
[++
i
],
NULL
,10);

1090 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-i"è&& !
Ï¡¬g
) {

1091 
£cÚds
 = 
	`©of
(
¬gv
[++
i
]);

1092 
cÚfig
.
š‹rv®
 = 
£cÚds
*1000000;

1093 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-n"è&& !
Ï¡¬g
) {

1094 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[++
i
]);

1095 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-a"è&& !
Ï¡¬g
) {

1096 
	`åuts
("W¬nšg: Usšg‡…asswÜd w™h '-a' o±iÚ oÀthcommªd†šš‹rçû may‚Ù b§ã.\n", 
¡d”r
);

1097 
cÚfig
.
auth
 = 
¬gv
[++
i
];

1098 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-u"è&& !
Ï¡¬g
) {

1099 
	`·r£RedisUri
(
¬gv
[++
i
]);

1100 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--raw")) {

1101 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1102 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--no-raw")) {

1103 
cÚfig
.
ouut
 = 
OUTPUT_STANDARD
;

1104 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--csv")) {

1105 
cÚfig
.
ouut
 = 
OUTPUT_CSV
;

1106 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency")) {

1107 
cÚfig
.
Ï‹ncy_mode
 = 1;

1108 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency-dist")) {

1109 
cÚfig
.
Ï‹ncy_di¡_mode
 = 1;

1110 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--mono")) {

1111 
¥eùrum_·Ë‰e
 = 
¥eùrum_·Ë‰e_mÚo
;

1112 
¥eùrum_·Ë‰e_size
 = 
¥eùrum_·Ë‰e_mÚo_size
;

1113 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency-history")) {

1114 
cÚfig
.
Ï‹ncy_mode
 = 1;

1115 
cÚfig
.
Ï‹ncy_hi¡Üy
 = 1;

1116 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--Ìu-‹¡"è&& !
Ï¡¬g
) {

1117 
cÚfig
.
Ìu_‹¡_mode
 = 1;

1118 
cÚfig
.
Ìu_‹¡_§m¶e_size
 = 
	`¡¹Şl
(
¬gv
[++
i
],
NULL
,10);

1119 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--slave")) {

1120 
cÚfig
.
¦ave_mode
 = 1;

1121 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--stat")) {

1122 
cÚfig
.
¡©_mode
 = 1;

1123 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--scan")) {

1124 
cÚfig
.
sÿn_mode
 = 1;

1125 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--·‰”n"è&& !
Ï¡¬g
) {

1126 
cÚfig
.
·‰”n
 = 
¬gv
[++
i
];

1127 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--šŒšsic-Ï‹ncy"è&& !
Ï¡¬g
) {

1128 
cÚfig
.
šŒšsic_Ï‹ncy_mode
 = 1;

1129 
cÚfig
.
šŒšsic_Ï‹ncy_du¿tiÚ
 = 
	`©oi
(
¬gv
[++
i
]);

1130 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--rdb"è&& !
Ï¡¬g
) {

1131 
cÚfig
.
g‘rdb_mode
 = 1;

1132 
cÚfig
.
rdb_f’ame
 = 
¬gv
[++
i
];

1133 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--pipe")) {

1134 
cÚfig
.
pe_mode
 = 1;

1135 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--pe-timeout"è&& !
Ï¡¬g
) {

1136 
cÚfig
.
pe_timeout
 = 
	`©oi
(
¬gv
[++
i
]);

1137 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--bigkeys")) {

1138 
cÚfig
.
bigkeys
 = 1;

1139 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--hotkeys")) {

1140 
cÚfig
.
hÙkeys
 = 1;

1141 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--ev®"è&& !
Ï¡¬g
) {

1142 
cÚfig
.
ev®
 = 
¬gv
[++
i
];

1143 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--ldb")) {

1144 
cÚfig
.
ev®_ldb
 = 1;

1145 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1146 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--ldb-sync-mode")) {

1147 
cÚfig
.
ev®_ldb
 = 1;

1148 
cÚfig
.
ev®_ldb_sync
 = 1;

1149 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1150 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-c")) {

1151 
cÚfig
.
şu¡”_mode
 = 1;

1152 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-d"è&& !
Ï¡¬g
) {

1153 
	`sdsä“
(
cÚfig
.
mb_d–im
);

1154 
cÚfig
.
mb_d–im
 = 
	`sd¢ew
(
¬gv
[++
i
]);

1155 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-v") || !strcmp(argv[i], "--version")) {

1156 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

1157 
	`´štf
("»dis-ş˜%s\n", 
v”siÚ
);

1158 
	`sdsä“
(
v”siÚ
);

1159 
	`ex™
(0);

1161 ià(
¬gv
[
i
][0] == '-') {

1162 
	`årštf
(
¡d”r
,

1164 
¬gv
[
i
]);

1165 
	`ex™
(1);

1174 ià(
cÚfig
.
ev®_ldb
 && cÚfig.
ev®
 =ğ
NULL
) {

1175 
	`årštf
(
¡d”r
,"Options --ldb‡nd --ldb-sync-mode„equire --eval.\n");

1176 
	`årštf
(
¡d”r
,"Try % --h–°fÜ mÜšfÜm©iÚ.\n", 
¬gv
[0]);

1177 
	`ex™
(1);

1179  
i
;

1180 
	}
}

1182 
sds
 
	$»adArgFromStdš
() {

1183 
buf
[1024];

1184 
sds
 
¬g
 = 
	`sd£m±y
();

1187 
Ä—d
 = 
	`»ad
(
	`f’o
(
¡dš
),
buf
,1024);

1189 ià(
Ä—d
 == 0) ;

1190 ià(
Ä—d
 == -1) {

1191 
	`³¼Ü
("Reading from standard input");

1192 
	`ex™
(1);

1194 
¬g
 = 
	`sdsÿ’
×rg,
buf
,
Ä—d
);

1196  
¬g
;

1197 
	}
}

1199 
	$u§ge
() {

1200 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

1201 
	`årštf
(
¡d”r
,

1269 
v”siÚ
, 
REDIS_CLI_DEFAULT_PIPE_TIMEOUT
);

1270 
	`sdsä“
(
v”siÚ
);

1271 
	`ex™
(1);

1272 
	}
}

1275 **
	$cÚv”tToSds
(
couÁ
, ** 
¬gs
) {

1276 
j
;

1277 **
sds
 = 
	`zm®loc
((*)*
couÁ
);

1279 
j
 = 0; j < 
couÁ
; j++)

1280 
sds
[
j
] = 
	`sd¢ew
(
¬gs
[j]);

1282  
sds
;

1283 
	}
}

1285 
	$issueCommªdR•—t
(
¬gc
, **
¬gv
, 
»³©
) {

1287 
cÚfig
.
şu¡”_»issue_commªd
 = 0;

1288 ià(
	`şiS’dCommªd
(
¬gc
,
¬gv
,
»³©
è!ğ
REDIS_OK
) {

1289 
	`şiCÚÃù
(1);

1293 ià(
	`şiS’dCommªd
(
¬gc
,
¬gv
,
»³©
è!ğ
REDIS_OK
) {

1294 
	`şiPrštCÚ‹xtE¼Ü
();

1295  
REDIS_ERR
;

1299 ià(
cÚfig
.
şu¡”_mode
 && cÚfig.
şu¡”_»issue_commªd
) {

1300 
	`şiCÚÃù
(1);

1305  
REDIS_OK
;

1306 
	}
}

1308 
	$issueCommªd
(
¬gc
, **
¬gv
) {

1309  
	`issueCommªdR•—t
(
¬gc
, 
¬gv
, 
cÚfig
.
»³©
);

1310 
	}
}

1318 
sds
 *
	$şiS¶™Args
(*
lše
, *
¬gc
) {

1319 ià(
cÚfig
.
ev®_ldb
 && (
	`¡r¡r
(
lše
,"eval ") ==†ine ||

1320 
	`¡r¡r
(
lše
,"e ") ==†ine))

1322 
sds
 *
¬gv
 = 
	`sds_m®loc
((sds)*2);

1323 *
¬gc
 = 2;

1324 
Ën
 = 
	`¡¾’
(
lše
);

1325 
–’
 = 
lše
[1] == ' ' ? 2 : 5;

1326 
¬gv
[0] = 
	`sd¢ewËn
(
lše
,
–’
-1);

1327 
¬gv
[1] = 
	`sd¢ewËn
(
lše
+
–’
,
Ën
-elen);

1328  
¬gv
;

1330  
	`sds¥l™¬gs
(
lše
,
¬gc
);

1332 
	}
}

1337 
	$şiS‘P»ã»nûs
(**
¬gv
, 
¬gc
, 
š‹¿ùive
) {

1338 ià(!
	`¡rÿ£cmp
(
¬gv
[0],":£t"è&& 
¬gc
 >= 2) {

1339 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"hšts")è
´ef
.
hšts
 = 1;

1340 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"nohšts")è
´ef
.
hšts
 = 0;

1342 
	`´štf
("%sunknown„edis-cli…reference '%s'\n",

1343 
š‹¿ùive
 ? "" : ".redisclirc: ",

1344 
¬gv
[1]);

1347 
	`´štf
("%sunknown„edis-cli internal command '%s'\n",

1348 
š‹¿ùive
 ? "" : ".redisclirc: ",

1349 
¬gv
[0]);

1351 
	}
}

1354 
	$şiLßdP»ã»nûs
() {

1355 
sds
 
rcfe
 = 
	`g‘DÙfeP©h
(
REDIS_CLI_RCFILE_ENV
,
REDIS_CLI_RCFILE_DEFAULT
);

1356 ià(
rcfe
 =ğ
NULL
) ;

1357 
FILE
 *
å
 = 
	`fİ’
(
rcfe
,"r");

1358 
buf
[1024];

1360 ià(
å
) {

1361 
	`fg‘s
(
buf
,(buf),
å
è!ğ
NULL
) {

1362 
sds
 *
¬gv
;

1363 
¬gc
;

1365 
¬gv
 = 
	`sds¥l™¬gs
(
buf
,&
¬gc
);

1366 ià(
¬gc
 > 0è
	`şiS‘P»ã»nûs
(
¬gv
,argc,0);

1367 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1369 
	`fşo£
(
å
);

1371 
	`sdsä“
(
rcfe
);

1372 
	}
}

1374 
	$»¶
() {

1375 
sds
 
hi¡Üyfe
 = 
NULL
;

1376 
hi¡Üy
 = 0;

1377 *
lše
;

1378 
¬gc
;

1379 
sds
 *
¬gv
;

1383 
	`şiIn™H–p
();

1384 
	`şiIÁeg¿‹H–p
();

1386 
cÚfig
.
š‹¿ùive
 = 1;

1387 
	`lš’oi£S‘MuÉiLše
(1);

1388 
	`lš’oi£S‘Com¶‘iÚC®lback
(
com¶‘iÚC®lback
);

1389 
	`lš’oi£S‘HštsC®lback
(
hštsC®lback
);

1390 
	`lš’oi£S‘F»eHštsC®lback
(
ä“HštsC®lback
);

1393 ià(
	`i§‰y
(
	`f’o
(
¡dš
))) {

1394 
hi¡Üyfe
 = 
	`g‘DÙfeP©h
(
REDIS_CLI_HISTFILE_ENV
,
REDIS_CLI_HISTFILE_DEFAULT
);

1396 
hi¡Üy
 = 1;

1397 ià(
hi¡Üyfe
 !ğ
NULL
) {

1398 
	`lš’oi£Hi¡ÜyLßd
(
hi¡Üyfe
);

1400 
	`şiLßdP»ã»nûs
();

1403 
	`şiReäeshProm±
();

1404 (
lše
 = 
	`lš’oi£
(
cÚ‹xt
 ? 
cÚfig
.
´om±
 : "nÙ cÚÃùed> ")è!ğ
NULL
) {

1405 ià(
lše
[0] != '\0') {

1406 
»³©
 = 1;

1407 
sk¬gs
 = 0;

1408 *
’d±r
 = 
NULL
;

1410 
¬gv
 = 
	`şiS¶™Args
(
lše
,&
¬gc
);

1414 ià(
¬gv
 && 
¬gc
 > 0) {

1415 
”ºo
 = 0;

1416 
»³©
 = 
	`¡¹Ş
(
¬gv
[0], &
’d±r
, 10);

1417 ià(
¬gc
 > 1 && *
’d±r
 == '\0') {

1418 ià(
”ºo
 =ğ
ERANGE
 ||ƒ¼nØ=ğ
EINVAL
 || 
»³©
 <= 0) {

1419 
	`åuts
("Inv®id„edis-ş˜»³© commªd o±iÚ v®ue.\n", 
¡dout
);

1420 
	`sdsä“¥l™»s
(
¬gv
, 
¬gc
);

1421 
	`lš’oi£F»e
(
lše
);

1424 
sk¬gs
 = 1;

1426 
»³©
 = 1;

1431 ià(!(
¬gv
 && 
¬gc
 > 0 && !
	`¡rÿ£cmp
×rgv[0+
sk¬gs
], "auth"))) {

1432 ià(
hi¡Üy
è
	`lš’oi£Hi¡ÜyAdd
(
lše
);

1433 ià(
hi¡Üyfe
è
	`lš’oi£Hi¡ÜySave
(historyfile);

1436 ià(
¬gv
 =ğ
NULL
) {

1437 
	`´štf
("Invalid‡rgument(s)\n");

1438 
	`lš’oi£F»e
(
lše
);

1440 } ià(
¬gc
 > 0) {

1441 ià(
	`¡rÿ£cmp
(
¬gv
[0],"quit") == 0 ||

1442 
	`¡rÿ£cmp
(
¬gv
[0],"exit") == 0)

1444 
	`ex™
(0);

1445 } ià(
¬gv
[0][0] == ':') {

1446 
	`şiS‘P»ã»nûs
(
¬gv
,
¬gc
,1);

1447 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1448 
	`lš’oi£F»e
(
lše
);

1450 } ià(
	`¡rÿ£cmp
(
¬gv
[0],"restart") == 0) {

1451 ià(
cÚfig
.
ev®
) {

1452 
cÚfig
.
ev®_ldb
 = 1;

1453 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

1456 
	`´štf
("Use 'restart' only in Lua debugging mode.");

1458 } ià(
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
¬gv
[0],"connect")) {

1459 
	`sdsä“
(
cÚfig
.
ho¡
);

1460 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
¬gv
[1]);

1461 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[2]);

1462 
	`şiReäeshProm±
();

1463 
	`şiCÚÃù
(1);

1464 } ià(
¬gc
 =ğ1 && !
	`¡rÿ£cmp
(
¬gv
[0],"clear")) {

1465 
	`lš’oi£CË¬Sü“n
();

1467 
¡¬t_time
 = 
	`m¡ime
(), 
–­£d
;

1469 
	`issueCommªdR•—t
(
¬gc
-
sk¬gs
, 
¬gv
+sk¬gs, 
»³©
);

1473 ià(
cÚfig
.
ev®_ldb_’d
) {

1474 
cÚfig
.
ev®_ldb_’d
 = 0;

1475 
	`şiR—dR•ly
(0);

1476 
	`´štf
("\n(Lua debugging sessionƒnded%s)\n\n",

1477 
cÚfig
.
ev®_ldb_sync
 ? "" :

1481 
–­£d
 = 
	`m¡ime
()-
¡¬t_time
;

1482 ià(
–­£d
 >= 500 &&

1483 
cÚfig
.
ouut
 =ğ
OUTPUT_STANDARD
)

1485 
	`´štf
("(%.2fs)\n",()
–­£d
/1000);

1490 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1493 
	`lš’oi£F»e
(
lše
);

1495 
	`ex™
(0);

1496 
	}
}

1498 
	$nÚš‹¿ùive
(
¬gc
, **
¬gv
) {

1499 
»tv®
 = 0;

1500 ià(
cÚfig
.
¡dš¬g
) {

1501 
¬gv
 = 
	`z»®loc
×rgv, (
¬gc
+1)*(*));

1502 
¬gv
[
¬gc
] = 
	`»adArgFromStdš
();

1503 
»tv®
 = 
	`issueCommªd
(
¬gc
+1, 
¬gv
);

1505 
»tv®
 = 
	`issueCommªd
(
¬gc
, 
¬gv
);

1507  
»tv®
;

1508 
	}
}

1514 
	$ev®Mode
(
¬gc
, **
¬gv
) {

1515 
sds
 
süt
 = 
NULL
;

1516 
FILE
 *
å
;

1517 
buf
[1024];

1518 
size_t
 
Ä—d
;

1519 **
¬gv2
;

1520 
j
, 
gÙ_comma
, 
keys
;

1521 
»tv®
 = 
REDIS_OK
;

1524 ià(
cÚfig
.
ev®_ldb
) {

1525 
	`´štf
(

1533 
	`sdsä“
(
süt
);

1534 
süt
 = 
	`sd£m±y
();

1535 
gÙ_comma
 = 0;

1536 
keys
 = 0;

1539 
å
 = 
	`fİ’
(
cÚfig
.
ev®
,"r");

1540 ià(!
å
) {

1541 
	`årštf
(
¡d”r
,

1542 "Cª'ˆİ’ f'%s': %s\n", 
cÚfig
.
ev®
, 
	`¡»¼Ü
(
”ºo
));

1543 
	`ex™
(1);

1545 (
Ä—d
 = 
	`ä—d
(
buf
,1,(buf),
å
)) != 0) {

1546 
süt
 = 
	`sdsÿ’
(süt,
buf
,
Ä—d
);

1548 
	`fşo£
(
å
);

1551 ià(
cÚfig
.
ev®_ldb
) {

1552 
»disR•ly
 *
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,

1553 
cÚfig
.
ev®_ldb_sync
 ?

1555 ià(
»¶y
è
	`ä“R•lyObjeù
(reply);

1559 
¬gv2
 = 
	`zm®loc
((
sds
)*(
¬gc
+3));

1560 
¬gv2
[0] = 
	`sd¢ew
("EVAL");

1561 
¬gv2
[1] = 
süt
;

1562 
j
 = 0; j < 
¬gc
; j++) {

1563 ià(!
gÙ_comma
 && 
¬gv
[
j
][0] == ',' &&‡rgv[j][1] == 0) {

1564 
gÙ_comma
 = 1;

1567 
¬gv2
[
j
+3-
gÙ_comma
] = 
	`sd¢ew
(
¬gv
[j]);

1568 ià(!
gÙ_comma
è
keys
++;

1570 
¬gv2
[2] = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",
keys
);

1573 
ev®_ldb
 = 
cÚfig
.eval_ldb;

1574 
»tv®
 = 
	`issueCommªd
(
¬gc
+3-
gÙ_comma
, 
¬gv2
);

1575 ià(
ev®_ldb
) {

1576 ià(!
cÚfig
.
ev®_ldb
) {

1580 
	`´štf
("Eval debugging session can't start:\n");

1581 
	`şiR—dR•ly
(0);

1584 
	`¡ºıy
(
cÚfig
.
´om±
,"lua debugger> ",(config.prompt));

1585 
	`»¶
();

1587 
	`şiCÚÃù
(1);

1588 
	`´štf
("\n");

1594  
»tv®
;

1595 
	}
}

1601 
	$Ï‹ncyModePršt
(
mš
, 
max
, 
avg
, 
couÁ
) {

1602 ià(
cÚfig
.
ouut
 =ğ
OUTPUT_STANDARD
) {

1603 
	`´štf
("min: %lld, max: %lld,‡vg: %.2f (%lld samples)",

1604 
mš
, 
max
, 
avg
, 
couÁ
);

1605 
	`fæush
(
¡dout
);

1606 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_CSV
) {

1607 
	`´štf
("%Îd,%Îd,%.2f,%Îd\n", 
mš
, 
max
, 
avg
, 
couÁ
);

1608 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_RAW
) {

1609 
	`´štf
("%Îd %Îd %.2à%Îd\n", 
mš
, 
max
, 
avg
, 
couÁ
);

1611 
	}
}

1613 
	#LATENCY_SAMPLE_RATE
 10

	)

1614 
	#LATENCY_HISTORY_DEFAULT_INTERVAL
 15000

	)

1615 
	$Ï‹ncyMode
() {

1616 
»disR•ly
 *
»¶y
;

1617 
¡¬t
, 
Ï‹ncy
, 
mš
 = 0, 
max
 = 0, 
tÙ
 = 0, 
couÁ
 = 0;

1618 
hi¡Üy_š‹rv®
 =

1619 
cÚfig
.
š‹rv®
 ? config.interval/1000 :

1620 
LATENCY_HISTORY_DEFAULT_INTERVAL
;

1621 
avg
;

1622 
hi¡Üy_¡¬t
 = 
	`m¡ime
();

1626 ià(
cÚfig
.
š‹rv®
 == 0) {

1627 
cÚfig
.
š‹rv®
 = 1000;

1629 
cÚfig
.
š‹rv®
 /= 1000;

1632 ià(!
cÚ‹xt
è
	`ex™
(1);

1634 
¡¬t
 = 
	`m¡ime
();

1635 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"PING");

1636 ià(
»¶y
 =ğ
NULL
) {

1637 
	`årštf
(
¡d”r
,"\nI/Oƒrror\n");

1638 
	`ex™
(1);

1640 
Ï‹ncy
 = 
	`m¡ime
()-
¡¬t
;

1641 
	`ä“R•lyObjeù
(
»¶y
);

1642 
couÁ
++;

1643 ià(
couÁ
 == 1) {

1644 
mš
 = 
max
 = 
tÙ
 = 
Ï‹ncy
;

1645 
avg
 = (è
Ï‹ncy
;

1647 ià(
Ï‹ncy
 < 
mš
) min =†atency;

1648 ià(
Ï‹ncy
 > 
max
) max =†atency;

1649 
tÙ
 +ğ
Ï‹ncy
;

1650 
avg
 = (è
tÙ
/
couÁ
;

1653 ià(
cÚfig
.
ouut
 =ğ
OUTPUT_STANDARD
) {

1654 
	`´štf
("\x1b[0G\x1b[2K");

1655 
	`Ï‹ncyModePršt
(
mš
,
max
,
avg
,
couÁ
);

1657 ià(
cÚfig
.
Ï‹ncy_hi¡Üy
) {

1658 
	`Ï‹ncyModePršt
(
mš
,
max
,
avg
,
couÁ
);

1659 } ià(
	`m¡ime
()-
hi¡Üy_¡¬t
 > 
cÚfig
.
š‹rv®
) {

1660 
	`Ï‹ncyModePršt
(
mš
,
max
,
avg
,
couÁ
);

1661 
	`ex™
(0);

1665 ià(
cÚfig
.
Ï‹ncy_hi¡Üy
 && 
	`m¡ime
()-
hi¡Üy_¡¬t
 > 
hi¡Üy_š‹rv®
)

1667 
	`´štf
(" -- %.2à£cÚd ¿nge\n", ()(
	`m¡ime
()-
hi¡Üy_¡¬t
)/1000);

1668 
hi¡Üy_¡¬t
 = 
	`m¡ime
();

1669 
mš
 = 
max
 = 
tÙ
 = 
couÁ
 = 0;

1671 
	`u¦“p
(
LATENCY_SAMPLE_RATE
 * 1000);

1673 
	}
}

1679 
	#LATENCY_DIST_DEFAULT_INTERVAL
 1000

	)

1682 
	sdi¡§m¶es
 {

1683 
	mmax
;

1684 
	mcouÁ
;

1685 
	mch¬aù”
;

1699 
	$showL©’cyDi¡Sam¶es
(
di¡§m¶es
 *
§m¶es
, 
tÙ
) {

1700 
j
;

1707 
	`´štf
("\033[38;5;0m");

1708 
j
 = 0; ; j++) {

1709 
cŞÜidx
 =

1710 
	`û
((è
§m¶es
[
j
].
couÁ
 / 
tÙ
 * (
¥eùrum_·Ë‰e_size
-1));

1711 
cŞÜ
 = 
¥eùrum_·Ë‰e
[
cŞÜidx
];

1712 
	`´štf
("\033[48;5;%dm%c", ()
cŞÜ
, 
§m¶es
[
j
].
ch¬aù”
);

1713 
§m¶es
[
j
].
couÁ
 = 0;

1714 ià(
§m¶es
[
j
].
max
 == 0) ;

1716 
	`´štf
("\033[0m\n");

1717 
	`fæush
(
¡dout
);

1718 
	}
}

1722 
	$showL©’cyDi¡Leg’d
() {

1723 
j
;

1725 
	`´štf
("---------------------------------------------\n");

1726 
	`´štf
(". - * # .01 .125 .25 .5 milliseconds\n");

1727 
	`´štf
("1,2,3,...,9 from 1o 9 milliseconds\n");

1728 
	`´štf
("A,B,C,D,E 10,20,30,40,50 milliseconds\n");

1729 
	`´štf
("F,G,H,I,J .1,.2,.3,.4,.5 seconds\n");

1730 
	`´štf
("K,L,M,N,O,P,Q,? 1,2,4,8,16,30,60,>60 seconds\n");

1731 
	`´štf
("From 0o 100%%: ");

1732 
j
 = 0; j < 
¥eùrum_·Ë‰e_size
; j++) {

1733 
	`´štf
("\033[48;5;%dm ", 
¥eùrum_·Ë‰e
[
j
]);

1735 
	`´štf
("\033[0m\n");

1736 
	`´štf
("---------------------------------------------\n");

1737 
	}
}

1739 
	$Ï‹ncyDi¡Mode
() {

1740 
»disR•ly
 *
»¶y
;

1741 
¡¬t
, 
Ï‹ncy
, 
couÁ
 = 0;

1742 
hi¡Üy_š‹rv®
 =

1743 
cÚfig
.
š‹rv®
 ? config.interval/1000 :

1744 
LATENCY_DIST_DEFAULT_INTERVAL
;

1745 
hi¡Üy_¡¬t
 = 
	`u¡ime
();

1746 
j
, 
ouuts
 = 0;

1748 
di¡§m¶es
 
§m¶es
[] = {

1785 ià(!
cÚ‹xt
è
	`ex™
(1);

1787 
¡¬t
 = 
	`u¡ime
();

1788 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"PING");

1789 ià(
»¶y
 =ğ
NULL
) {

1790 
	`årštf
(
¡d”r
,"\nI/Oƒrror\n");

1791 
	`ex™
(1);

1793 
Ï‹ncy
 = 
	`u¡ime
()-
¡¬t
;

1794 
	`ä“R•lyObjeù
(
»¶y
);

1795 
couÁ
++;

1798 
j
 = 0; ; j++) {

1799 ià(
§m¶es
[
j
].
max
 =ğ0 || 
Ï‹ncy
 <= samples[j].max) {

1800 
§m¶es
[
j
].
couÁ
++;

1806 ià(
couÁ
 && (
	`u¡ime
()-
hi¡Üy_¡¬t
)/1000 > 
hi¡Üy_š‹rv®
) {

1807 ià((
ouuts
++ % 20) == 0)

1808 
	`showL©’cyDi¡Leg’d
();

1809 
	`showL©’cyDi¡Sam¶es
(
§m¶es
,
couÁ
);

1810 
hi¡Üy_¡¬t
 = 
	`u¡ime
();

1811 
couÁ
 = 0;

1813 
	`u¦“p
(
LATENCY_SAMPLE_RATE
 * 1000);

1815 
	}
}

1823 
	$£ndSync
(
fd
) {

1828 
buf
[4096], *
p
;

1829 
ssize_t
 
Ä—d
;

1832 ià(
	`wr™e
(
fd
,"SYNC\r\n",6) != 6) {

1833 
	`årštf
(
¡d”r
,"Error writingo master\n");

1834 
	`ex™
(1);

1838 
p
 = 
buf
;

1840 
Ä—d
 = 
	`»ad
(
fd
,
p
,1);

1841 ià(
Ä—d
 <= 0) {

1842 
	`årštf
(
¡d”r
,"Error„eading bulk†ength while SYNCing\n");

1843 
	`ex™
(1);

1845 ià(*
p
 =ğ'\n' &&… !ğ
buf
) ;

1846 ià(*
p
 != '\n')…++;

1848 *
p
 = '\0';

1849 ià(
buf
[0] == '-') {

1850 
	`´štf
("SYNC w™h ma¡” faed: %s\n", 
buf
);

1851 
	`ex™
(1);

1853  
	`¡¹ouÎ
(
buf
+1,
NULL
,10);

1854 
	}
}

1856 
	$¦aveMode
() {

1857 
fd
 = 
cÚ‹xt
->fd;

1858 
·ylßd
 = 
	`£ndSync
(
fd
);

1859 
buf
[1024];

1860 
Üigš®_ouut
 = 
cÚfig
.
ouut
;

1862 
	`årštf
(
¡d”r
,"SYNC with master, discarding %llu "

1863 "by‹ oàbulk¿nsãr...\n", 
·ylßd
);

1866 
·ylßd
) {

1867 
ssize_t
 
Ä—d
;

1869 
Ä—d
 = 
	`»ad
(
fd
,
buf
,(
·ylßd
 > (buf)) ? (buf) :…ayload);

1870 ià(
Ä—d
 <= 0) {

1871 
	`årštf
(
¡d”r
,"Error„eading RDB…ayload while SYNCing\n");

1872 
	`ex™
(1);

1874 
·ylßd
 -ğ
Ä—d
;

1876 
	`årštf
(
¡d”r
,"SYNC done. Logging commands from master.\n");

1879 
cÚfig
.
ouut
 = 
OUTPUT_CSV
;

1880 
	`şiR—dR•ly
(0è=ğ
REDIS_OK
);

1881 
cÚfig
.
ouut
 = 
Üigš®_ouut
;

1882 
	}
}

1890 
	$g‘RDB
() {

1891 
s
 = 
cÚ‹xt
->
fd
;

1892 
fd
;

1893 
·ylßd
 = 
	`£ndSync
(
s
);

1894 
buf
[4096];

1896 
	`årštf
(
¡d”r
,"SYNC sento master, writing %llu byteso '%s'\n",

1897 
·ylßd
, 
cÚfig
.
rdb_f’ame
);

1900 ià(!
	`¡rcmp
(
cÚfig
.
rdb_f’ame
,"-")) {

1901 
fd
 = 
STDOUT_FILENO
;

1903 
fd
 = 
	`İ’
(
cÚfig
.
rdb_f’ame
, 
O_CREAT
|
O_WRONLY
, 0644);

1904 ià(
fd
 == -1) {

1905 
	`årštf
(
¡d”r
, "E¼Ü o³nšg '%s': %s\n", 
cÚfig
.
rdb_f’ame
,

1906 
	`¡»¼Ü
(
”ºo
));

1907 
	`ex™
(1);

1911 
·ylßd
) {

1912 
ssize_t
 
Ä—d
, 
nwr™‹n
;

1914 
Ä—d
 = 
	`»ad
(
s
,
buf
,(
·ylßd
 > (buf)) ? (buf) :…ayload);

1915 ià(
Ä—d
 <= 0) {

1916 
	`årštf
(
¡d”r
,"I/O Error„eading RDB…ayload from socket\n");

1917 
	`ex™
(1);

1919 
nwr™‹n
 = 
	`wr™e
(
fd
, 
buf
, 
Ä—d
);

1920 ià(
nwr™‹n
 !ğ
Ä—d
) {

1921 
	`årštf
(
¡d”r
,"Error writing datao file: %s\n",

1922 
	`¡»¼Ü
(
”ºo
));

1923 
	`ex™
(1);

1925 
·ylßd
 -ğ
Ä—d
;

1927 
	`şo£
(
s
);

1928 
	`fsync
(
fd
);

1929 
	`årštf
(
¡d”r
,"Transfer finished with success.\n");

1930 
	`ex™
(0);

1931 
	}
}

1937 
	#PIPEMODE_WRITE_LOOP_MAX_BYTES
 (128*1024)

	)

1938 
	$peMode
() {

1939 
fd
 = 
cÚ‹xt
->fd;

1940 
”rÜs
 = 0, 
»¶›s
 = 0, 
obuf_Ën
 = 0, 
obuf_pos
 = 0;

1941 
ibuf
[1024*16], 
obuf
[1024*16];

1942 
ª‘”r
[
ANET_ERR_LEN
];

1943 
»disR—d”
 *
»ad”
 = 
	`»disR—d”C»©e
();

1944 
»disR•ly
 *
»¶y
;

1945 
eof
 = 0;

1946 
dÚe
 = 0;

1947 
magic
[20];

1948 
time_t
 
Ï¡_»ad_time
 = 
	`time
(
NULL
);

1950 
	`¤ªd
(
	`time
(
NULL
));

1953 ià(
	`ª‘NÚBlock
(
ª‘”r
,
fd
è=ğ
ANET_ERR
) {

1954 
	`årštf
(
¡d”r
, "Can't sethe socket in‚on blocking mode: %s\n",

1955 
ª‘”r
);

1956 
	`ex™
(1);

1961 !
dÚe
) {

1962 
mask
 = 
AE_READABLE
;

1964 ià(!
eof
 || 
obuf_Ën
 !ğ0è
mask
 |ğ
AE_WRITABLE
;

1965 
mask
 = 
	`«Wa™
(
fd
,mask,1000);

1968 ià(
mask
 & 
AE_READABLE
) {

1969 
ssize_t
 
Ä—d
;

1973 
Ä—d
 = 
	`»ad
(
fd
,
ibuf
,(ibuf));

1974 ià(
Ä—d
 =ğ-1 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
) {

1975 
	`årštf
(
¡d”r
, "Error„eading fromhe server: %s\n",

1976 
	`¡»¼Ü
(
”ºo
));

1977 
	`ex™
(1);

1979 ià(
Ä—d
 > 0) {

1980 
	`»disR—d”F“d
(
»ad”
,
ibuf
,
Ä—d
);

1981 
Ï¡_»ad_time
 = 
	`time
(
NULL
);

1983 } 
Ä—d
 > 0);

1987 ià(
	`»disR—d”G‘R•ly
(
»ad”
,(**)&
»¶y
è=ğ
REDIS_ERR
) {

1988 
	`årštf
(
¡d”r
, "Error„eading„eplies from server\n");

1989 
	`ex™
(1);

1991 ià(
»¶y
) {

1992 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1993 
	`årštf
(
¡d”r
,"%s\n", 
»¶y
->
¡r
);

1994 
”rÜs
++;

1995 } ià(
eof
 && 
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

1996 
»¶y
->
Ën
 == 20) {

2000 ià(
	`memcmp
(
»¶y
->
¡r
,
magic
,20) == 0) {

2001 
	`´štf
("Last„eply„eceived from server.\n");

2002 
dÚe
 = 1;

2003 
»¶›s
--;

2006 
»¶›s
++;

2007 
	`ä“R•lyObjeù
(
»¶y
);

2009 } 
»¶y
);

2013 ià(
mask
 & 
AE_WRITABLE
) {

2014 
ssize_t
 
loİ_nwr™‹n
 = 0;

2018 ià(
obuf_Ën
 != 0) {

2019 
ssize_t
 
nwr™‹n
 = 
	`wr™e
(
fd
,
obuf
+
obuf_pos
,
obuf_Ën
);

2021 ià(
nwr™‹n
 == -1) {

2022 ià(
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
) {

2023 
	`årštf
(
¡d”r
, "Error writingohe server: %s\n",

2024 
	`¡»¼Ü
(
”ºo
));

2025 
	`ex™
(1);

2027 
nwr™‹n
 = 0;

2030 
obuf_Ën
 -ğ
nwr™‹n
;

2031 
obuf_pos
 +ğ
nwr™‹n
;

2032 
loİ_nwr™‹n
 +ğ
nwr™‹n
;

2033 ià(
obuf_Ën
 != 0) ;

2036 ià(
obuf_Ën
 =ğ0 && !
eof
) {

2037 
ssize_t
 
Ä—d
 = 
	`»ad
(
STDIN_FILENO
,
obuf
,(obuf));

2039 ià(
Ä—d
 == 0) {

2044 
echo
[] =

2046 
j
;

2048 
eof
 = 1;

2052 
j
 = 0; j < 20; j++)

2053 
magic
[
j
] = 
	`¿nd
() & 0xff;

2054 
	`memıy
(
echo
+21,
magic
,20);

2055 
	`memıy
(
obuf
,
echo
,(echo)-1);

2056 
obuf_Ën
 = (
echo
)-1;

2057 
obuf_pos
 = 0;

2058 
	`´štf
("All dataransferred. Waiting forhe†ast„eply...\n");

2059 } ià(
Ä—d
 == -1) {

2060 
	`årštf
(
¡d”r
, "Error„eading from stdin: %s\n",

2061 
	`¡»¼Ü
(
”ºo
));

2062 
	`ex™
(1);

2064 
obuf_Ën
 = 
Ä—d
;

2065 
obuf_pos
 = 0;

2068 ià((
obuf_Ën
 =ğ0 && 
eof
) ||

2069 
loİ_nwr™‹n
 > 
PIPEMODE_WRITE_LOOP_MAX_BYTES
) ;

2076 ià(
eof
 && 
cÚfig
.
pe_timeout
 > 0 &&

2077 
	`time
(
NULL
)-
Ï¡_»ad_time
 > 
cÚfig
.
pe_timeout
)

2079 
	`årštf
(
¡d”r
,"No„eplies for %d seconds:ƒxiting.\n",

2080 
cÚfig
.
pe_timeout
);

2081 
”rÜs
++;

2085 
	`»disR—d”F»e
(
»ad”
);

2086 
	`´štf
("”rÜs: %Îd,„•l›s: %Îd\n", 
”rÜs
, 
»¶›s
);

2087 ià(
”rÜs
)

2088 
	`ex™
(1);

2090 
	`ex™
(0);

2091 
	}
}

2097 
	#TYPE_STRING
 0

	)

2098 
	#TYPE_LIST
 1

	)

2099 
	#TYPE_SET
 2

	)

2100 
	#TYPE_HASH
 3

	)

2101 
	#TYPE_ZSET
 4

	)

2102 
	#TYPE_STREAM
 5

	)

2103 
	#TYPE_NONE
 6

	)

2104 
	#TYPE_COUNT
 7

	)

2106 
»disR•ly
 *
	$£ndSÿn
(*
™
) {

2107 
»disR•ly
 *
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
, "SCAN %Îu", *
™
);

2110 if(
»¶y
 =ğ
NULL
) {

2111 
	`årštf
(
¡d”r
, "\nI/Oƒrror\n");

2112 
	`ex™
(1);

2113 } if(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2114 
	`årštf
(
¡d”r
, "SCANƒ¼Ü: %s\n", 
»¶y
->
¡r
);

2115 
	`ex™
(1);

2116 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

2117 
	`årštf
(
¡d”r
, "Non ARRAY„esponse from SCAN!\n");

2118 
	`ex™
(1);

2119 } if(
»¶y
->
–em’ts
 != 2) {

2120 
	`årštf
(
¡d”r
, "Invalidƒlement count from SCAN!\n");

2121 
	`ex™
(1);

2125 
	`as£¹
(
»¶y
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_STRING
);

2126 
	`as£¹
(
»¶y
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

2129 *
™
 = 
	`¡¹ouÎ
(
»¶y
->
–em’t
[0]->
¡r
, 
NULL
, 10);

2131  
»¶y
;

2132 
	}
}

2134 
	$g‘DbSize
() {

2135 
»disR•ly
 *
»¶y
;

2136 
size
;

2138 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
, "DBSIZE");

2140 if(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

2141 
	`årštf
(
¡d”r
, "Couldn't determine DBSIZE!\n");

2142 
	`ex™
(1);

2146 
size
 = 
»¶y
->
š‹g”
;

2147 
	`ä“R•lyObjeù
(
»¶y
);

2149  
size
;

2150 
	}
}

2152 
	$toIÁTy³
(*
key
, *
ty³
) {

2153 if(!
	`¡rcmp
(
ty³
, "string")) {

2154  
TYPE_STRING
;

2155 } if(!
	`¡rcmp
(
ty³
, "list")) {

2156  
TYPE_LIST
;

2157 } if(!
	`¡rcmp
(
ty³
, "set")) {

2158  
TYPE_SET
;

2159 } if(!
	`¡rcmp
(
ty³
, "hash")) {

2160  
TYPE_HASH
;

2161 } if(!
	`¡rcmp
(
ty³
, "zset")) {

2162  
TYPE_ZSET
;

2163 } if(!
	`¡rcmp
(
ty³
, "none")) {

2164  
TYPE_NONE
;

2166 
	`årštf
(
¡d”r
, "UnknowÀty³ '%s' fÜ key '%s'\n", 
ty³
, 
key
);

2167 
	`ex™
(1);

2169 
	}
}

2171 
	$g‘KeyTy³s
(
»disR•ly
 *
keys
, *
ty³s
) {

2172 
»disR•ly
 *
»¶y
;

2173 
i
;

2176 
i
=0;i<
keys
->
–em’ts
;i++) {

2177 
	`»disAµ’dCommªd
(
cÚ‹xt
, "TYPE %s", 
keys
->
–em’t
[
i
]->
¡r
);

2181 
i
=0;i<
keys
->
–em’ts
;i++) {

2182 if(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
)!=
REDIS_OK
) {

2183 
	`årštf
(
¡d”r
, "Error gettingype for key '%s' (%d: %s)\n",

2184 
keys
->
–em’t
[
i
]->
¡r
, 
cÚ‹xt
->
”r
, cÚ‹xt->
”r¡r
);

2185 
	`ex™
(1);

2186 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STATUS
) {

2187 if(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2188 
	`årštf
(
¡d”r
, "TYPE„‘uºed‡À”rÜ: %s\n", 
»¶y
->
¡r
);

2190 
	`årštf
(
¡d”r
,

2192 
»¶y
->
ty³
, 
keys
->
–em’t
[
i
]->
¡r
);

2194 
	`ex™
(1);

2197 
ty³s
[
i
] = 
	`toIÁTy³
(
keys
->
–em’t
[i]->
¡r
, 
»¶y
->str);

2198 
	`ä“R•lyObjeù
(
»¶y
);

2200 
	}
}

2202 
	$g‘KeySizes
(
»disR•ly
 *
keys
, *
ty³s
,

2203 *
sizes
)

2205 
»disR•ly
 *
»¶y
;

2206 *
sizecmds
[] = {"STRLEN","LLEN","SCARD","HLEN","ZCARD"};

2207 
i
;

2210 
i
=0;i<
keys
->
–em’ts
;i++) {

2212 if(
ty³s
[
i
]==
TYPE_NONE
)

2215 
	`»disAµ’dCommªd
(
cÚ‹xt
, "% %s", 
sizecmds
[
ty³s
[
i
]],

2216 
keys
->
–em’t
[
i
]->
¡r
);

2220 
i
=0;i<
keys
->
–em’ts
;i++) {

2222 if(
ty³s
[
i
] =ğ
TYPE_NONE
) {

2223 
sizes
[
i
] = 0;

2228 if(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
)!=
REDIS_OK
) {

2229 
	`årštf
(
¡d”r
, "Error getting size for key '%s' (%d: %s)\n",

2230 
keys
->
–em’t
[
i
]->
¡r
, 
cÚ‹xt
->
”r
, cÚ‹xt->
”r¡r
);

2231 
	`ex™
(1);

2232 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

2235 
	`årštf
(
¡d”r
,

2237 
sizecmds
[
ty³s
[
i
]], 
keys
->
–em’t
[i]->
¡r
);

2238 
sizes
[
i
] = 0;

2240 
sizes
[
i
] = 
»¶y
->
š‹g”
;

2243 
	`ä“R•lyObjeù
(
»¶y
);

2245 
	}
}

2247 
	$fšdBigKeys
() {

2248 
bigge¡
[
TYPE_COUNT
] = {0}, 
couÁs
[TYPE_COUNT] = {0}, 
tÙ®size
[TYPE_COUNT] = {0};

2249 
§m¶ed
 = 0, 
tÙ®_keys
, 
tÙËn
=0, *
sizes
=
NULL
, 
™
=0;

2250 
sds
 
maxkeys
[
TYPE_COUNT
] = {0};

2251 *
ty³Çme
[] = {"string","list","set","hash","zset","stream","none"};

2252 *
ty³un™
[] = {"bytes","items","members","fields","members","entries",""};

2253 
»disR•ly
 *
»¶y
, *
keys
;

2254 
¬rsize
=0, 
i
;

2255 
ty³
, *
ty³s
=
NULL
;

2256 
pù
;

2259 
tÙ®_keys
 = 
	`g‘DbSize
();

2262 
	`´štf
("\n# Scanningheƒntire keyspaceo find biggest keys‡s well‡s\n");

2263 
	`´štf
("#‡verage sizes…er keyype. You can use -i 0.1o sleep 0.1 sec\n");

2264 
	`´štf
("#…er 100 SCAN commands (not usually‚eeded).\n\n");

2267 
i
=0;i<
TYPE_NONE
; i++) {

2268 
maxkeys
[
i
] = 
	`sd£m±y
();

2269 if(!
maxkeys
[
i
]) {

2270 
	`årštf
(
¡d”r
, "Failedo‡llocate memory for†argest key‚ames!\n");

2271 
	`ex™
(1);

2278 
pù
 = 100 * ()
§m¶ed
/
tÙ®_keys
;

2281 
»¶y
 = 
	`£ndSÿn
(&
™
);

2282 
keys
 = 
»¶y
->
–em’t
[1];

2285 if(
keys
->
–em’ts
 > 
¬rsize
) {

2286 
ty³s
 = 
	`z»®loc
Ñy³s, ()*
keys
->
–em’ts
);

2287 
sizes
 = 
	`z»®loc
(sizes, ()*
keys
->
–em’ts
);

2289 if(!
ty³s
 || !
sizes
) {

2290 
	`årštf
(
¡d”r
, "Failedo‡llocate storage for keys!\n");

2291 
	`ex™
(1);

2294 
¬rsize
 = 
keys
->
–em’ts
;

2298 
	`g‘KeyTy³s
(
keys
, 
ty³s
);

2299 
	`g‘KeySizes
(
keys
, 
ty³s
, 
sizes
);

2302 
i
=0;i<
keys
->
–em’ts
;i++) {

2303 if((
ty³
 = 
ty³s
[
i
]è=ğ
TYPE_NONE
)

2306 
tÙ®size
[
ty³
] +ğ
sizes
[
i
];

2307 
couÁs
[
ty³
]++;

2308 
tÙËn
 +ğ
keys
->
–em’t
[
i
]->
Ën
;

2309 
§m¶ed
++;

2311 if(
bigge¡
[
ty³
]<
sizes
[
i
]) {

2312 
	`´štf
(

2314 
pù
, 
ty³Çme
[
ty³
], 
keys
->
–em’t
[
i
]->
¡r
, 
sizes
[i],

2315 
ty³un™
[
ty³
]);

2318 
maxkeys
[
ty³
] = 
	`sdsıy
(maxkeys[ty³], 
keys
->
–em’t
[
i
]->
¡r
);

2319 if(!
maxkeys
[
ty³
]) {

2320 
	`årštf
(
¡d”r
, "Failedo‡llocate memory for key!\n");

2321 
	`ex™
(1);

2325 
bigge¡
[
ty³
] = 
sizes
[
i
];

2329 if(
§m¶ed
 % 1000000 == 0) {

2330 
	`´štf
("[%05.2f%%] Sam¶ed %Îu key sØçr\n", 
pù
, 
§m¶ed
);

2335 if(
§m¶ed
 && (§m¶ed %100è=ğ0 && 
cÚfig
.
š‹rv®
) {

2336 
	`u¦“p
(
cÚfig
.
š‹rv®
);

2339 
	`ä“R•lyObjeù
(
»¶y
);

2340 } 
™
 != 0);

2342 if(
ty³s
è
	`zä“
(types);

2343 if(
sizes
è
	`zä“
(sizes);

2346 
	`´štf
("\n-------- summary -------\n\n");

2348 
	`´štf
("Sam¶ed %Îu key šhkey¥aû!\n", 
§m¶ed
);

2349 
	`´štf
("Total key†ength in bytes is %llu (avg†en %.2f)\n\n",

2350 
tÙËn
,ÙËÀ? (éÙËn/
§m¶ed
 : 0);

2353 
i
=0;i<
TYPE_NONE
;i++) {

2354 if(
	`sd¦’
(
maxkeys
[
i
])>0) {

2355 
	`´štf
("Bigge¡ %6 found '%s' ha %Îu %s\n", 
ty³Çme
[
i
], 
maxkeys
[i],

2356 
bigge¡
[
i
], 
ty³un™
[i]);

2360 
	`´štf
("\n");

2362 
i
=0;i<
TYPE_NONE
;i++) {

2363 
	`´štf
("%llu %ss with %llu %s (%05.2f%% of keys,‡vg size %.2f)\n",

2364 
couÁs
[
i
], 
ty³Çme
[i], 
tÙ®size
[i], 
ty³un™
[i],

2365 
§m¶ed
 ? 100 * ()
couÁs
[
i
]/sampled : 0,

2366 
couÁs
[
i
] ? ()
tÙ®size
[i]/counts[i] : 0);

2370 
i
=0;i<
TYPE_NONE
;i++) {

2371 
	`sdsä“
(
maxkeys
[
i
]);

2375 
	`ex™
(0);

2376 
	}
}

2378 
	$g‘KeyF»qs
(
»disR•ly
 *
keys
, *
äeqs
) {

2379 
»disR•ly
 *
»¶y
;

2380 
i
;

2383 
i
=0;i<
keys
->
–em’ts
;i++) {

2384 
	`»disAµ’dCommªd
(
cÚ‹xt
, "OBJECT f»q %s", 
keys
->
–em’t
[
i
]->
¡r
);

2388 
i
=0;i<
keys
->
–em’ts
;i++) {

2389 if(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
)!=
REDIS_OK
) {

2390 
	`årštf
(
¡d”r
, "Error getting freq for key '%s' (%d: %s)\n",

2391 
keys
->
–em’t
[
i
]->
¡r
, 
cÚ‹xt
->
”r
, cÚ‹xt->
”r¡r
);

2392 
	`ex™
(1);

2393 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

2394 if(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2395 
	`årštf
(
¡d”r
, "E¼Ü: %s\n", 
»¶y
->
¡r
);

2396 
	`ex™
(1);

2398 
	`årštf
(
¡d”r
, "W¬nšg: OBJECT f»q oÀ'%s' faed (may havb“Àd–‘ed)\n", 
keys
->
–em’t
[
i
]->
¡r
);

2399 
äeqs
[
i
] = 0;

2402 
äeqs
[
i
] = 
»¶y
->
š‹g”
;

2404 
	`ä“R•lyObjeù
(
»¶y
);

2406 
	}
}

2408 
	#HOTKEYS_SAMPLE
 16

	)

2409 
	$fšdHÙKeys
() {

2410 
»disR•ly
 *
keys
, *
»¶y
;

2411 
couÁ”s
[
HOTKEYS_SAMPLE
] = {0};

2412 
sds
 
hÙkeys
[
HOTKEYS_SAMPLE
] = {
NULL
};

2413 
§m¶ed
 = 0, 
tÙ®_keys
, *
äeqs
 = 
NULL
, 
™
 = 0;

2414 
¬rsize
 = 0, 
i
, 
k
;

2415 
pù
;

2418 
tÙ®_keys
 = 
	`g‘DbSize
();

2421 
	`´štf
("\n# Scanningheƒntire keyspaceo find hot keys‡s well‡s\n");

2422 
	`´štf
("#‡verage sizes…er keyype. You can use -i 0.1o sleep 0.1 sec\n");

2423 
	`´štf
("#…er 100 SCAN commands (not usually‚eeded).\n\n");

2428 
pù
 = 100 * ()
§m¶ed
/
tÙ®_keys
;

2431 
»¶y
 = 
	`£ndSÿn
(&
™
);

2432 
keys
 = 
»¶y
->
–em’t
[1];

2435 if(
keys
->
–em’ts
 > 
¬rsize
) {

2436 
äeqs
 = 
	`z»®loc
(äeqs, ()*
keys
->
–em’ts
);

2438 if(!
äeqs
) {

2439 
	`årštf
(
¡d”r
, "Failedo‡llocate storage for keys!\n");

2440 
	`ex™
(1);

2443 
¬rsize
 = 
keys
->
–em’ts
;

2446 
	`g‘KeyF»qs
(
keys
, 
äeqs
);

2449 
i
=0;i<
keys
->
–em’ts
;i++) {

2450 
§m¶ed
++;

2452 if(
§m¶ed
 % 1000000 == 0) {

2453 
	`´štf
("[%05.2f%%] Sam¶ed %Îu key sØçr\n", 
pù
, 
§m¶ed
);

2457 
k
 = 0;

2458 
k
 < 
HOTKEYS_SAMPLE
 && 
äeqs
[
i
] > 
couÁ”s
[k]) k++;

2459 ià(
k
 == 0) ;

2460 
k
--;

2461 ià(
k
 =ğ0 || 
couÁ”s
[k] == 0) {

2462 
	`sdsä“
(
hÙkeys
[
k
]);

2464 
	`sdsä“
(
hÙkeys
[0]);

2465 
	`memmove
(
couÁ”s
,couÁ”s+1,(couÁ”s[0])*
k
);

2466 
	`memmove
(
hÙkeys
,hÙkeys+1,(hÙkeys[0])*
k
);

2468 
couÁ”s
[
k
] = 
äeqs
[
i
];

2469 
hÙkeys
[
k
] = 
	`sd¢ew
(
keys
->
–em’t
[
i
]->
¡r
);

2470 
	`´štf
(

2472 
pù
, 
keys
->
–em’t
[
i
]->
¡r
, 
äeqs
[i]);

2476 if(
§m¶ed
 && (§m¶ed %100è=ğ0 && 
cÚfig
.
š‹rv®
) {

2477 
	`u¦“p
(
cÚfig
.
š‹rv®
);

2480 
	`ä“R•lyObjeù
(
»¶y
);

2481 } 
™
 != 0);

2483 ià(
äeqs
è
	`zä“
(freqs);

2486 
	`´štf
("\n-------- summary -------\n\n");

2488 
	`´štf
("Sam¶ed %Îu key šhkey¥aû!\n", 
§m¶ed
);

2490 
i
=1; i<ğ
HOTKEYS_SAMPLE
; i++) {

2491 
k
 = 
HOTKEYS_SAMPLE
 - 
i
;

2492 if(
couÁ”s
[
k
]>0) {

2493 
	`´štf
("hÙ key found w™h couÁ”: %Îu\tkeyÇme: %s\n", 
couÁ”s
[
k
], 
hÙkeys
[k]);

2494 
	`sdsä“
(
hÙkeys
[
k
]);

2498 
	`ex™
(0);

2499 
	}
}

2508 *
	$g‘InfoF›ld
(*
šfo
, *
f›ld
) {

2509 *
p
 = 
	`¡r¡r
(
šfo
,
f›ld
);

2510 *
n1
, *
n2
;

2511 *
»suÉ
;

2513 ià(!
p
è 
NULL
;

2514 
p
 +ğ
	`¡¾’
(
f›ld
)+1;

2515 
n1
 = 
	`¡rchr
(
p
,'\r');

2516 
n2
 = 
	`¡rchr
(
p
,',');

2517 ià(
n2
 &&‚2 < 
n1
)‚1 =‚2;

2518 
»suÉ
 = 
	`zm®loc
(()*(
n1
-
p
)+1);

2519 
	`memıy
(
»suÉ
,
p
,(
n1
-p));

2520 
»suÉ
[
n1
-
p
] = '\0';

2521  
»suÉ
;

2522 
	}
}

2526 
	$g‘LÚgInfoF›ld
(*
šfo
, *
f›ld
) {

2527 *
v®ue
 = 
	`g‘InfoF›ld
(
šfo
,
f›ld
);

2528 
l
;

2530 ià(!
v®ue
è 
LONG_MIN
;

2531 
l
 = 
	`¡¹Ş
(
v®ue
,
NULL
,10);

2532 
	`zä“
(
v®ue
);

2533  
l
;

2534 
	}
}

2538 
	$by‹sToHumª
(*
s
, 
n
) {

2539 
d
;

2541 ià(
n
 < 0) {

2542 *
s
 = '-';

2543 
s
++;

2544 
n
 = -n;

2546 ià(
n
 < 1024) {

2548 
	`¥rštf
(
s
,"%ÎdB",
n
);

2550 } ià(
n
 < (1024*1024)) {

2551 
d
 = ()
n
/(1024);

2552 
	`¥rštf
(
s
,"%.2fK",
d
);

2553 } ià(
n
 < (1024LL*1024*1024)) {

2554 
d
 = ()
n
/(1024*1024);

2555 
	`¥rštf
(
s
,"%.2fM",
d
);

2556 } ià(
n
 < (1024LL*1024*1024*1024)) {

2557 
d
 = ()
n
/(1024LL*1024*1024);

2558 
	`¥rštf
(
s
,"%.2fG",
d
);

2560 
	}
}

2562 
	$¡©Mode
() {

2563 
»disR•ly
 *
»¶y
;

2564 
aux
, 
»que¡s
 = 0;

2565 
i
 = 0;

2568 
buf
[64];

2569 
j
;

2571 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"INFO");

2572 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2573 
	`´štf
("ERROR: %s\n", 
»¶y
->
¡r
);

2574 
	`ex™
(1);

2577 ià((
i
++ % 20) == 0) {

2578 
	`´štf
(

2584 
aux
 = 0;

2585 
j
 = 0; j < 20; j++) {

2586 
k
;

2588 
	`¥rštf
(
buf
,"db%d:keys",
j
);

2589 
k
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,
buf
);

2590 ià(
k
 =ğ
LONG_MIN
) ;

2591 
aux
 +ğ
k
;

2593 
	`¥rštf
(
buf
,"%ld",
aux
);

2594 
	`´štf
("%-11s",
buf
);

2597 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"used_memory");

2598 
	`by‹sToHumª
(
buf
,
aux
);

2599 
	`´štf
("%-8s",
buf
);

2602 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"connected_clients");

2603 
	`¥rštf
(
buf
,"%ld",
aux
);

2604 
	`´štf
(" %-8s",
buf
);

2607 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"blocked_clients");

2608 
	`¥rštf
(
buf
,"%ld",
aux
);

2609 
	`´štf
("%-8s",
buf
);

2612 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"total_commands_processed");

2613 
	`¥rštf
(
buf
,"%ld (+%ld)",
aux
,
»que¡s
 == 0 ? 0 :‡ux-requests);

2614 
	`´štf
("%-19s",
buf
);

2615 
»que¡s
 = 
aux
;

2618 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"total_connections_received");

2619 
	`¥rštf
(
buf
,"%ld",
aux
);

2620 
	`´štf
(" %-12s",
buf
);

2623 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"bgsave_in_progress");

2624 
aux
 |ğ
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"aof_rewrite_in_progress") << 1;

2625 
aux
 |ğ
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"loading") << 2;

2626 
aux
) {

2629 
	`´štf
("SAVE");

2632 
	`´štf
("AOF");

2635 
	`´štf
("SAVE+AOF");

2638 
	`´štf
("LOAD");

2642 
	`´štf
("\n");

2643 
	`ä“R•lyObjeù
(
»¶y
);

2644 
	`u¦“p
(
cÚfig
.
š‹rv®
);

2646 
	}
}

2652 
	$sÿnMode
() {

2653 
»disR•ly
 *
»¶y
;

2654 
cur
 = 0;

2657 ià(
cÚfig
.
·‰”n
)

2658 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SCAN %llu MATCH %s",

2659 
cur
,
cÚfig
.
·‰”n
);

2661 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SCAN %Îu",
cur
);

2662 ià(
»¶y
 =ğ
NULL
) {

2663 
	`´štf
("I/Oƒrror\n");

2664 
	`ex™
(1);

2665 } ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2666 
	`´štf
("ERROR: %s\n", 
»¶y
->
¡r
);

2667 
	`ex™
(1);

2669 
j
;

2671 
cur
 = 
	`¡¹ouÎ
(
»¶y
->
–em’t
[0]->
¡r
,
NULL
,10);

2672 
j
 = 0; j < 
»¶y
->
–em’t
[1]->
–em’ts
; j++)

2673 
	`´štf
("%s\n", 
»¶y
->
–em’t
[1]->–em’t[
j
]->
¡r
);

2675 
	`ä“R•lyObjeù
(
»¶y
);

2676 } 
cur
 != 0);

2678 
	`ex™
(0);

2679 
	}
}

2691 
	$pow”LawRªd
(
mš
, 
max
, 
®pha
) {

2692 
¶
, 
r
;

2694 
max
 += 1;

2695 
r
 = (()
	`¿nd
()è/ 
RAND_MAX
;

2696 
¶
 = 
	`pow
(

2697 ((
	`pow
(
max
,
®pha
+1è-…ow(
mš
,®pha+1))*
r
 +…ow(min,alpha+1)),

2698 (1.0/(
®pha
+1)));

2699  (
max
-1-()
¶
)+
mš
;

2700 
	}
}

2704 
	$LRUTe¡G’Key
(*
buf
, 
size_t
 
buæ’
) {

2705 
	`¢´štf
(
buf
, 
buæ’
, "lru:%lld",

2706 
	`pow”LawRªd
(1, 
cÚfig
.
Ìu_‹¡_§m¶e_size
, 6.2));

2707 
	}
}

2709 
	#LRU_CYCLE_PERIOD
 1000

	)

2710 
	#LRU_CYCLE_PIPELINE_SIZE
 250

	)

2711 
	$LRUTe¡Mode
() {

2712 
»disR•ly
 *
»¶y
;

2713 
key
[128];

2714 
¡¬t_cyşe
;

2715 
j
;

2717 
	`¤ªd
(
	`time
(
NULL
)^
	`g‘pid
());

2722 
¡¬t_cyşe
 = 
	`m¡ime
();

2723 
h™s
 = 0, 
mis£s
 = 0;

2724 
	`m¡ime
(è- 
¡¬t_cyşe
 < 1000) {

2726 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2727 
v®
[6];

2728 
v®
[5] = '\0';

2729 
i
 = 0; i < 5; i++è
v®
[i] = 'A'+
	`¿nd
()%('z'-'A');

2730 
	`LRUTe¡G’Key
(
key
,(key));

2731 
	`»disAµ’dCommªd
(
cÚ‹xt
, "SET % %s",
key
,
v®
);

2733 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++)

2734 
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
);

2737 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2738 
	`LRUTe¡G’Key
(
key
,(key));

2739 
	`»disAµ’dCommªd
(
cÚ‹xt
, "GET %s",
key
);

2741 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2742 ià(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
è=ğ
REDIS_OK
) {

2743 
»¶y
->
ty³
) {

2744 
REDIS_REPLY_ERROR
:

2745 
	`´štf
("%s\n", 
»¶y
->
¡r
);

2747 
REDIS_REPLY_NIL
:

2748 
mis£s
++;

2751 
h™s
++;

2757 ià(
cÚ‹xt
->
”r
) {

2758 
	`årštf
(
¡d”r
,"I/Oƒrror during LRUest\n");

2759 
	`ex™
(1);

2763 
	`´štf
(

2765 
h™s
+
mis£s
,

2766 
h™s
, ()h™s/(h™s+
mis£s
)*100,

2767 
mis£s
, ()mis£s/(
h™s
+misses)*100);

2769 
	`ex™
(0);

2770 
	}
}

2783 
	$compu‹_som‘hšg_ç¡
() {

2784 
s
[256], 
i
, 
j
, 
t
;

2785 
couÁ
 = 1000, 
k
;

2786 
ouut
 = 0;

2788 
k
 = 0; k < 256; k++è
s
[k] = k;

2790 
i
 = 0;

2791 
j
 = 0;

2792 
couÁ
--) {

2793 
i
++;

2794 
j
 = j + 
s
[
i
];

2795 
t
 = 
s
[
i
];

2796 
s
[
i
] = s[
j
];

2797 
s
[
j
] = 
t
;

2798 
ouut
 +ğ
s
[(s[
i
]+s[
j
])&255];

2800  
ouut
;

2801 
	}
}

2803 
	$šŒšsicL©’cyModeStİ
(
s
) {

2804 
	`UNUSED
(
s
);

2805 
fÜû_ÿnûl_loİ
 = 1;

2806 
	}
}

2808 
	$šŒšsicL©’cyMode
() {

2809 
‹¡_’d
, 
run_time
, 
max_Ï‹ncy
 = 0, 
runs
 = 0;

2811 
run_time
 = 
cÚfig
.
šŒšsic_Ï‹ncy_du¿tiÚ
*1000000;

2812 
‹¡_’d
 = 
	`u¡ime
(è+ 
run_time
;

2813 
	`sigÇl
(
SIGINT
, 
šŒšsicL©’cyModeStİ
);

2816 
¡¬t
, 
’d
, 
Ï‹ncy
;

2818 
¡¬t
 = 
	`u¡ime
();

2819 
	`compu‹_som‘hšg_ç¡
();

2820 
’d
 = 
	`u¡ime
();

2821 
Ï‹ncy
 = 
’d
-
¡¬t
;

2822 
runs
++;

2823 ià(
Ï‹ncy
 <= 0) ;

2826 ià(
Ï‹ncy
 > 
max_Ï‹ncy
) {

2827 
max_Ï‹ncy
 = 
Ï‹ncy
;

2828 
	`´štf
("Max†©’cy sØçr: %Îd miüo£cÚds.\n", 
max_Ï‹ncy
);

2831 
avg_us
 = ()
run_time
/
runs
;

2832 
avg_ns
 = 
avg_us
 * 1e3;

2833 ià(
fÜû_ÿnûl_loİ
 || 
’d
 > 
‹¡_’d
) {

2834 
	`´štf
("\n%lldotal„uns "

2837 
runs
, 
avg_us
, 
avg_ns
);

2838 
	`´štf
("Worst„unook %.0fx†ongerhanhe‡verage†atency.\n",

2839 
max_Ï‹ncy
 / 
avg_us
);

2840 
	`ex™
(0);

2843 
	}
}

2849 
	$maš
(
¬gc
, **
¬gv
) {

2850 
fœ¡¬g
;

2852 
cÚfig
.
ho¡
 = 
	`sd¢ew
("127.0.0.1");

2853 
cÚfig
.
ho¡pÜt
 = 6379;

2854 
cÚfig
.
ho¡sock‘
 = 
NULL
;

2855 
cÚfig
.
»³©
 = 1;

2856 
cÚfig
.
š‹rv®
 = 0;

2857 
cÚfig
.
dbnum
 = 0;

2858 
cÚfig
.
š‹¿ùive
 = 0;

2859 
cÚfig
.
shutdown
 = 0;

2860 
cÚfig
.
mÚ™Ü_mode
 = 0;

2861 
cÚfig
.
pubsub_mode
 = 0;

2862 
cÚfig
.
Ï‹ncy_mode
 = 0;

2863 
cÚfig
.
Ï‹ncy_di¡_mode
 = 0;

2864 
cÚfig
.
Ï‹ncy_hi¡Üy
 = 0;

2865 
cÚfig
.
Ìu_‹¡_mode
 = 0;

2866 
cÚfig
.
Ìu_‹¡_§m¶e_size
 = 0;

2867 
cÚfig
.
şu¡”_mode
 = 0;

2868 
cÚfig
.
¦ave_mode
 = 0;

2869 
cÚfig
.
g‘rdb_mode
 = 0;

2870 
cÚfig
.
¡©_mode
 = 0;

2871 
cÚfig
.
sÿn_mode
 = 0;

2872 
cÚfig
.
šŒšsic_Ï‹ncy_mode
 = 0;

2873 
cÚfig
.
·‰”n
 = 
NULL
;

2874 
cÚfig
.
rdb_f’ame
 = 
NULL
;

2875 
cÚfig
.
pe_mode
 = 0;

2876 
cÚfig
.
pe_timeout
 = 
REDIS_CLI_DEFAULT_PIPE_TIMEOUT
;

2877 
cÚfig
.
bigkeys
 = 0;

2878 
cÚfig
.
hÙkeys
 = 0;

2879 
cÚfig
.
¡dš¬g
 = 0;

2880 
cÚfig
.
auth
 = 
NULL
;

2881 
cÚfig
.
ev®
 = 
NULL
;

2882 
cÚfig
.
ev®_ldb
 = 0;

2883 
cÚfig
.
ev®_ldb_’d
 = 0;

2884 
cÚfig
.
ev®_ldb_sync
 = 0;

2885 
cÚfig
.
’abË_ldb_Ú_ev®
 = 0;

2886 
cÚfig
.
Ï¡_cmd_ty³
 = -1;

2888 
´ef
.
hšts
 = 1;

2890 
¥eùrum_·Ë‰e
 = 
¥eùrum_·Ë‰e_cŞÜ
;

2891 
¥eùrum_·Ë‰e_size
 = 
¥eùrum_·Ë‰e_cŞÜ_size
;

2893 ià(!
	`i§‰y
(
	`f’o
(
¡dout
)è&& (
	`g‘’v
("FAKETTY"è=ğ
NULL
))

2894 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

2896 
cÚfig
.
ouut
 = 
OUTPUT_STANDARD
;

2897 
cÚfig
.
mb_d–im
 = 
	`sd¢ew
("\n");

2899 
fœ¡¬g
 = 
	`·r£O±iÚs
(
¬gc
,
¬gv
);

2900 
¬gc
 -ğ
fœ¡¬g
;

2901 
¬gv
 +ğ
fœ¡¬g
;

2904 ià(
cÚfig
.
Ï‹ncy_mode
) {

2905 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2906 
	`Ï‹ncyMode
();

2910 ià(
cÚfig
.
Ï‹ncy_di¡_mode
) {

2911 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2912 
	`Ï‹ncyDi¡Mode
();

2916 ià(
cÚfig
.
¦ave_mode
) {

2917 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2918 
	`¦aveMode
();

2922 ià(
cÚfig
.
g‘rdb_mode
) {

2923 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2924 
	`g‘RDB
();

2928 ià(
cÚfig
.
pe_mode
) {

2929 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2930 
	`peMode
();

2934 ià(
cÚfig
.
bigkeys
) {

2935 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2936 
	`fšdBigKeys
();

2940 ià(
cÚfig
.
hÙkeys
) {

2941 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2942 
	`fšdHÙKeys
();

2946 ià(
cÚfig
.
¡©_mode
) {

2947 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2948 ià(
cÚfig
.
š‹rv®
 == 0) config.interval = 1000000;

2949 
	`¡©Mode
();

2953 ià(
cÚfig
.
sÿn_mode
) {

2954 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2955 
	`sÿnMode
();

2959 ià(
cÚfig
.
Ìu_‹¡_mode
) {

2960 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2961 
	`LRUTe¡Mode
();

2965 ià(
cÚfig
.
šŒšsic_Ï‹ncy_mode
è
	`šŒšsicL©’cyMode
();

2968 ià(
¬gc
 =ğ0 && !
cÚfig
.
ev®
) {

2970 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

2974 
	`şiCÚÃù
(0);

2975 
	`»¶
();

2979 ià(
	`şiCÚÃù
(0è!ğ
REDIS_OK
è
	`ex™
(1);

2980 ià(
cÚfig
.
ev®
) {

2981  
	`ev®Mode
(
¬gc
,
¬gv
);

2983  
	`nÚš‹¿ùive
(
¬gc
,
	`cÚv”tToSds
×rgc,
¬gv
));

2985 
	}
}

	@src/redisassert.h

38 #iâdeà
__REDIS_ASSERT_H__


39 
	#__REDIS_ASSERT_H__


	)

41 
	~<uni¡d.h
>

43 
	#as£¹
(
_e
è((_e)?()0 : (
	`_£rv”As£¹
(#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

44 
	#·nic
(...è
	`_£rv”Pªic
(
__FILE__
,
__LINE__
,
__VA_ARGS__
),
	`_ex™
(1)

	)

46 
_£rv”As£¹
(*
e¡r
, *
fe
, 
lše
);

47 
_£rv”Pªic
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
msg
, ...);

	@src/redismodule.h

1 #iâdeà
REDISMODULE_H


2 
	#REDISMODULE_H


	)

4 
	~<sys/ty³s.h
>

5 
	~<¡dšt.h
>

6 
	~<¡dio.h
>

11 
	#REDISMODULE_OK
 0

	)

12 
	#REDISMODULE_ERR
 1

	)

15 
	#REDISMODULE_APIVER_1
 1

	)

18 
	#REDISMODULE_READ
 (1<<0)

	)

19 
	#REDISMODULE_WRITE
 (1<<1)

	)

21 
	#REDISMODULE_LIST_HEAD
 0

	)

22 
	#REDISMODULE_LIST_TAIL
 1

	)

25 
	#REDISMODULE_KEYTYPE_EMPTY
 0

	)

26 
	#REDISMODULE_KEYTYPE_STRING
 1

	)

27 
	#REDISMODULE_KEYTYPE_LIST
 2

	)

28 
	#REDISMODULE_KEYTYPE_HASH
 3

	)

29 
	#REDISMODULE_KEYTYPE_SET
 4

	)

30 
	#REDISMODULE_KEYTYPE_ZSET
 5

	)

31 
	#REDISMODULE_KEYTYPE_MODULE
 6

	)

34 
	#REDISMODULE_REPLY_UNKNOWN
 -1

	)

35 
	#REDISMODULE_REPLY_STRING
 0

	)

36 
	#REDISMODULE_REPLY_ERROR
 1

	)

37 
	#REDISMODULE_REPLY_INTEGER
 2

	)

38 
	#REDISMODULE_REPLY_ARRAY
 3

	)

39 
	#REDISMODULE_REPLY_NULL
 4

	)

42 
	#REDISMODULE_POSTPONED_ARRAY_LEN
 -1

	)

45 
	#REDISMODULE_NO_EXPIRE
 -1

	)

48 
	#REDISMODULE_ZADD_XX
 (1<<0)

	)

49 
	#REDISMODULE_ZADD_NX
 (1<<1)

	)

50 
	#REDISMODULE_ZADD_ADDED
 (1<<2)

	)

51 
	#REDISMODULE_ZADD_UPDATED
 (1<<3)

	)

52 
	#REDISMODULE_ZADD_NOP
 (1<<4)

	)

55 
	#REDISMODULE_HASH_NONE
 0

	)

56 
	#REDISMODULE_HASH_NX
 (1<<0)

	)

57 
	#REDISMODULE_HASH_XX
 (1<<1)

	)

58 
	#REDISMODULE_HASH_CFIELDS
 (1<<2)

	)

59 
	#REDISMODULE_HASH_EXISTS
 (1<<3)

	)

64 
	#REDISMODULE_CTX_FLAGS_LUA
 0x0001

	)

66 
	#REDISMODULE_CTX_FLAGS_MULTI
 0x0002

	)

68 
	#REDISMODULE_CTX_FLAGS_MASTER
 0x0004

	)

70 
	#REDISMODULE_CTX_FLAGS_SLAVE
 0x0008

	)

72 
	#REDISMODULE_CTX_FLAGS_READONLY
 0x0010

	)

74 
	#REDISMODULE_CTX_FLAGS_CLUSTER
 0x0020

	)

76 
	#REDISMODULE_CTX_FLAGS_AOF
 0x0040

77 

	)

78 
	#REDISMODULE_CTX_FLAGS_RDB
 0x0080

79 

	)

80 
	#REDISMODULE_CTX_FLAGS_MAXMEMORY
 0x0100

	)

82 
	#REDISMODULE_CTX_FLAGS_EVICT
 0x0200

	)

85 
	#REDISMODULE_NOTIFY_GENERIC
 (1<<2è

	)

86 
	#REDISMODULE_NOTIFY_STRING
 (1<<3è

	)

87 
	#REDISMODULE_NOTIFY_LIST
 (1<<4è

	)

88 
	#REDISMODULE_NOTIFY_SET
 (1<<5è

	)

89 
	#REDISMODULE_NOTIFY_HASH
 (1<<6è

	)

90 
	#REDISMODULE_NOTIFY_ZSET
 (1<<7è

	)

91 
	#REDISMODULE_NOTIFY_EXPIRED
 (1<<8è

	)

92 
	#REDISMODULE_NOTIFY_EVICTED
 (1<<9è

	)

93 
	#REDISMODULE_NOTIFY_ALL
 (
REDISMODULE_NOTIFY_GENERIC
 | 
REDISMODULE_NOTIFY_STRING
 | 
REDISMODULE_NOTIFY_LIST
 | 
REDISMODULE_NOTIFY_SET
 | 
REDISMODULE_NOTIFY_HASH
 | 
REDISMODULE_NOTIFY_ZSET
 | 
REDISMODULE_NOTIFY_EXPIRED
 | 
REDISMODULE_NOTIFY_EVICTED
è

	)

98 
	#REDISMODULE_HASH_DELETE
 ((
RedisModuËSŒšg
*)()1)

	)

101 
	#REDISMODULE_ERRORMSG_WRONGTYPE
 "WRONGTYPE O³¿tiÚ‡gaš¡‡ key hŞdšghwrÚg kšd oàv®ue"

	)

103 
	#REDISMODULE_POSITIVE_INFINITE
 (1.0/0.0)

	)

104 
	#REDISMODULE_NEGATIVE_INFINITE
 (-1.0/0.0)

	)

106 
	#REDISMODULE_NOT_USED
(
V
è((èV)

	)

110 #iâdeà
REDISMODULE_CORE


112 
	tm¡ime_t
;

115 
RedisModuËCtx
 
	tRedisModuËCtx
;

116 
RedisModuËKey
 
	tRedisModuËKey
;

117 
RedisModuËSŒšg
 
	tRedisModuËSŒšg
;

118 
RedisModuËC®lR•ly
 
	tRedisModuËC®lR•ly
;

119 
RedisModuËIO
 
	tRedisModuËIO
;

120 
RedisModuËTy³
 
	tRedisModuËTy³
;

121 
RedisModuËDige¡
 
	tRedisModuËDige¡
;

122 
RedisModuËBlockedCl›Á
 
	tRedisModuËBlockedCl›Á
;

124 (*
	tRedisModuËCmdFunc
è(
	tRedisModuËCtx
 *
	tùx
, 
	tRedisModuËSŒšg
 **
	t¬gv
, 
	t¬gc
);

126 (*
	tRedisModuËNÙifiÿtiÚFunc
è(
	tRedisModuËCtx
 *
	tùx
, 
	tty³
, cÚ¡ *
	tev’t
, 
	tRedisModuËSŒšg
 *
	tkey
);

127 *(*
	tRedisModuËTy³LßdFunc
)(
	tRedisModuËIO
 *
	trdb
, 
	t’cv”
);

128 (*
	tRedisModuËTy³SaveFunc
)(
	tRedisModuËIO
 *
	trdb
, *
	tv®ue
);

129 (*
	tRedisModuËTy³Rewr™eFunc
)(
	tRedisModuËIO
 *
	taof
, 
	tRedisModuËSŒšg
 *
	tkey
, *
	tv®ue
);

130 
	$size_t
 (*
	tRedisModuËTy³MemU§geFunc
)(cÚ¡ *
	tv®ue
);

131 (*
	tRedisModuËTy³Dige¡Func
)(
	tRedisModuËDige¡
 *
	tdige¡
, *
	tv®ue
);

132 (*
	tRedisModuËTy³F»eFunc
)(*
	tv®ue
);

134 
	#REDISMODULE_TYPE_METHOD_VERSION
 1

	)

135 
	sRedisModuËTy³M‘hods
 {

136 
ušt64_t
 
v”siÚ
;

137 
RedisModuËTy³LßdFunc
 
rdb_lßd
;

138 
RedisModuËTy³SaveFunc
 
rdb_§ve
;

139 
RedisModuËTy³Rewr™eFunc
 
aof_»wr™e
;

140 
RedisModuËTy³MemU§geFunc
 
mem_u§ge
;

141 
RedisModuËTy³Dige¡Func
 
dige¡
;

142 
RedisModuËTy³F»eFunc
 
ä“
;

143 } 
	tRedisModuËTy³M‘hods
;

145 
	#REDISMODULE_GET_API
(
Çme
) \

146 
	`RedisModuË_G‘Api
("RedisModuË_" #Çme, ((**)&
RedisModuË_
 ## 
Çme
))

	)

148 
	#REDISMODULE_API_FUNC
(
x
è(*x)

	)

151 *
	$REDISMODULE_API_FUNC
(
RedisModuË_AÎoc
)(
size_t
 
by‹s
);

152 *
	$REDISMODULE_API_FUNC
(
RedisModuË_R—Îoc
)(*
±r
, 
size_t
 
by‹s
);

153 
	$REDISMODULE_API_FUNC
(
RedisModuË_F»e
)(*
±r
);

154 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®loc
)(
size_t
 
nmemb
, size_ˆ
size
);

155 *
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒdup
)(cÚ¡ *
¡r
);

156 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘Api
)(const *, *);

157 
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eCommªd
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
RedisModuËCmdFunc
 
cmdfunc
, cÚ¡ *
¡ræags
, 
fœ¡key
, 
Ï¡key
, 
key¡•
);

158 
	$REDISMODULE_API_FUNC
(
RedisModuË_S‘ModuËA‰ribs
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
);

159 
	$REDISMODULE_API_FUNC
(
RedisModuË_IsModuËNameBusy
)(cÚ¡ *
Çme
);

160 
	$REDISMODULE_API_FUNC
(
RedisModuË_WrÚgAr™y
)(
RedisModuËCtx
 *
ùx
);

161 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hLÚgLÚg
)(
RedisModuËCtx
 *
ùx
, 
Î
);

162 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘S–eùedDb
)(
RedisModuËCtx
 *
ùx
);

163 
	$REDISMODULE_API_FUNC
(
RedisModuË_S–eùDb
)(
RedisModuËCtx
 *
ùx
, 
Ãwid
);

164 *
	$REDISMODULE_API_FUNC
(
RedisModuË_O³nKey
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
keyÇme
, 
mode
);

165 
	$REDISMODULE_API_FUNC
(
RedisModuË_Clo£Key
)(
RedisModuËKey
 *
kp
);

166 
	$REDISMODULE_API_FUNC
(
RedisModuË_KeyTy³
)(
RedisModuËKey
 *
kp
);

167 
size_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_V®ueL’gth
)(
RedisModuËKey
 *
kp
);

168 
	$REDISMODULE_API_FUNC
(
RedisModuË_Li¡Push
)(
RedisModuËKey
 *
kp
, 
wh”e
, 
RedisModuËSŒšg
 *
–e
);

169 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_Li¡Pİ
)(
RedisModuËKey
 *
key
, 
wh”e
);

170 
RedisModuËC®lR•ly
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®l
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...);

171 cÚ¡ *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyPrÙo
)(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
);

172 
	$REDISMODULE_API_FUNC
(
RedisModuË_F»eC®lR•ly
)(
RedisModuËC®lR•ly
 *
»¶y
);

173 
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyTy³
)(
RedisModuËC®lR•ly
 *
»¶y
);

174 
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyIÁeg”
)(
RedisModuËC®lR•ly
 *
»¶y
);

175 
size_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyL’gth
)(
RedisModuËC®lR•ly
 *
»¶y
);

176 
RedisModuËC®lR•ly
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lyA¼ayEËm’t
)(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 
idx
);

177 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšg
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
±r
, 
size_t
 
Ën
);

178 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšgFromLÚgLÚg
)(
RedisModuËCtx
 *
ùx
, 
Î
);

179 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšgFromSŒšg
)(
RedisModuËCtx
 *
ùx
, cÚ¡ 
RedisModuËSŒšg
 *
¡r
);

180 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšgPrštf
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
fmt
, ...);

181 
	$REDISMODULE_API_FUNC
(
RedisModuË_F»eSŒšg
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
);

182 cÚ¡ *
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgPŒL’
)(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, 
size_t
 *
Ën
);

183 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hE¼Ü
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
”r
);

184 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hSim¶eSŒšg
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
msg
);

185 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hA¼ay
)(
RedisModuËCtx
 *
ùx
, 
Ën
);

186 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyS‘A¼ayL’gth
)(
RedisModuËCtx
 *
ùx
, 
Ën
);

187 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hSŒšgBufãr
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
buf
, 
size_t
 
Ën
);

188 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hSŒšg
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
);

189 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hNuÎ
)(
RedisModuËCtx
 *
ùx
);

190 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hDoubË
)(
RedisModuËCtx
 *
ùx
, 
d
);

191 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•lyW™hC®lR•ly
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËC®lR•ly
 *
»¶y
);

192 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgToLÚgLÚg
)(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
Î
);

193 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgToDoubË
)(cÚ¡ 
RedisModuËSŒšg
 *
¡r
, *
d
);

194 
	$REDISMODULE_API_FUNC
(
RedisModuË_AutoMemÜy
)(
RedisModuËCtx
 *
ùx
);

195 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•liÿ‹
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...);

196 
	$REDISMODULE_API_FUNC
(
RedisModuË_R•liÿ‹V”b©im
)(
RedisModuËCtx
 *
ùx
);

197 cÚ¡ *
	$REDISMODULE_API_FUNC
(
RedisModuË_C®lR•lySŒšgPŒ
)(
RedisModuËC®lR•ly
 *
»¶y
, 
size_t
 *
Ën
);

198 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eSŒšgFromC®lR•ly
)(
RedisModuËC®lR•ly
 *
»¶y
);

199 
	$REDISMODULE_API_FUNC
(
RedisModuË_D–‘eKey
)(
RedisModuËKey
 *
key
);

200 
	$REDISMODULE_API_FUNC
(
RedisModuË_UÆškKey
)(
RedisModuËKey
 *
key
);

201 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgS‘
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
¡r
);

202 *
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgDMA
)(
RedisModuËKey
 *
key
, 
size_t
 *
Ën
, 
mode
);

203 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgTrunÿ‹
)(
RedisModuËKey
 *
key
, 
size_t
 
ÃwËn
);

204 
m¡ime_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘Expœe
)(
RedisModuËKey
 *
key
);

205 
	$REDISMODULE_API_FUNC
(
RedisModuË_S‘Expœe
)(
RedisModuËKey
 *
key
, 
m¡ime_t
 
expœe
);

206 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tAdd
)(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
);

207 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tInüby
)(
RedisModuËKey
 *
key
, 
scÜe
, 
RedisModuËSŒšg
 *
–e
, *
æag¥Œ
, *
ÃwscÜe
);

208 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tScÜe
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
scÜe
);

209 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRem
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
–e
, *
d–‘ed
);

210 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeStİ
)(
RedisModuËKey
 *
key
);

211 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tFœ¡InScÜeRªge
)(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
);

212 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tLa¡InScÜeRªge
)(
RedisModuËKey
 *
key
, 
mš
, 
max
, 
mšex
, 
maxex
);

213 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tFœ¡InLexRªge
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
);

214 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tLa¡InLexRªge
)(
RedisModuËKey
 *
key
, 
RedisModuËSŒšg
 *
mš
, RedisModuËSŒšg *
max
);

215 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeCu¼’tEËm’t
)(
RedisModuËKey
 *
key
, *
scÜe
);

216 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeNext
)(
RedisModuËKey
 *
key
);

217 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeP»v
)(
RedisModuËKey
 *
key
);

218 
	$REDISMODULE_API_FUNC
(
RedisModuË_Z£tRªgeEndR—ched
)(
RedisModuËKey
 *
key
);

219 
	$REDISMODULE_API_FUNC
(
RedisModuË_HashS‘
)(
RedisModuËKey
 *
key
, 
æags
, ...);

220 
	$REDISMODULE_API_FUNC
(
RedisModuË_HashG‘
)(
RedisModuËKey
 *
key
, 
æags
, ...);

221 
	$REDISMODULE_API_FUNC
(
RedisModuË_IsKeysPos™iÚReque¡
)(
RedisModuËCtx
 *
ùx
);

222 
	$REDISMODULE_API_FUNC
(
RedisModuË_KeyAtPos
)(
RedisModuËCtx
 *
ùx
, 
pos
);

223 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘Cl›ÁId
)(
RedisModuËCtx
 *
ùx
);

224 
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘CÚ‹xtFÏgs
)(
RedisModuËCtx
 *
ùx
);

225 *
	$REDISMODULE_API_FUNC
(
RedisModuË_PoŞAÎoc
)(
RedisModuËCtx
 *
ùx
, 
size_t
 
by‹s
);

226 
RedisModuËTy³
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_C»©eD©aTy³
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
’cv”
, 
RedisModuËTy³M‘hods
 *
ty³m‘hods
);

227 
	$REDISMODULE_API_FUNC
(
RedisModuË_ModuËTy³S‘V®ue
)(
RedisModuËKey
 *
key
, 
RedisModuËTy³
 *
mt
, *
v®ue
);

228 
RedisModuËTy³
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_ModuËTy³G‘Ty³
)(
RedisModuËKey
 *
key
);

229 *
	$REDISMODULE_API_FUNC
(
RedisModuË_ModuËTy³G‘V®ue
)(
RedisModuËKey
 *
key
);

230 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveUnsigÃd
)(
RedisModuËIO
 *
io
, 
ušt64_t
 
v®ue
);

231 
ušt64_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdUnsigÃd
)(
RedisModuËIO
 *
io
);

232 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveSigÃd
)(
RedisModuËIO
 *
io
, 
št64_t
 
v®ue
);

233 
št64_t
 
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdSigÃd
)(
RedisModuËIO
 *
io
);

234 
	$REDISMODULE_API_FUNC
(
RedisModuË_Em™AOF
)(
RedisModuËIO
 *
io
, cÚ¡ *
cmdÇme
, cÚ¡ *
fmt
, ...);

235 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveSŒšg
)(
RedisModuËIO
 *
io
, 
RedisModuËSŒšg
 *
s
);

236 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveSŒšgBufãr
)(
RedisModuËIO
 *
io
, cÚ¡ *
¡r
, 
size_t
 
Ën
);

237 
RedisModuËSŒšg
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdSŒšg
)(
RedisModuËIO
 *
io
);

238 *
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdSŒšgBufãr
)(
RedisModuËIO
 *
io
, 
size_t
 *
ËÅŒ
);

239 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveDoubË
)(
RedisModuËIO
 *
io
, 
v®ue
);

240 
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdDoubË
)(
RedisModuËIO
 *
io
);

241 
	$REDISMODULE_API_FUNC
(
RedisModuË_SaveFlßt
)(
RedisModuËIO
 *
io
, 
v®ue
);

242 
	$REDISMODULE_API_FUNC
(
RedisModuË_LßdFlßt
)(
RedisModuËIO
 *
io
);

243 
	$REDISMODULE_API_FUNC
(
RedisModuË_Log
)(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Ëv–
, cÚ¡ *
fmt
, ...);

244 
	$REDISMODULE_API_FUNC
(
RedisModuË_LogIOE¼Ü
)(
RedisModuËIO
 *
io
, cÚ¡ *
Ëv–¡r
, cÚ¡ *
fmt
, ...);

245 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgAµ’dBufãr
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

246 
	$REDISMODULE_API_FUNC
(
RedisModuË_R‘ašSŒšg
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËSŒšg
 *
¡r
);

247 
	$REDISMODULE_API_FUNC
(
RedisModuË_SŒšgCom·»
)(
RedisModuËSŒšg
 *
a
, RedisModuËSŒšg *
b
);

248 
RedisModuËCtx
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘CÚ‹xtFromIO
)(
RedisModuËIO
 *
io
);

249 
	$REDISMODULE_API_FUNC
(
RedisModuË_Mli£cÚds
)();

250 
	$REDISMODULE_API_FUNC
(
RedisModuË_Dige¡AddSŒšgBufãr
)(
RedisModuËDige¡
 *
md
, *
–e
, 
size_t
 
Ën
);

251 
	$REDISMODULE_API_FUNC
(
RedisModuË_Dige¡AddLÚgLÚg
)(
RedisModuËDige¡
 *
md
, 
–e
);

252 
	$REDISMODULE_API_FUNC
(
RedisModuË_Dige¡EndSequ’û
)(
RedisModuËDige¡
 *
md
);

255 #ifdeà
REDISMODULE_EXPERIMENTAL_API


256 
RedisModuËBlockedCl›Á
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_BlockCl›Á
)(
RedisModuËCtx
 *
ùx
, 
RedisModuËCmdFunc
 
»¶y_ÿÎback
, RedisModuËCmdFunø
timeout_ÿÎback
, (*
ä“_´ivd©a
)(*), 
timeout_ms
);

257 
	$REDISMODULE_API_FUNC
(
RedisModuË_UnblockCl›Á
)(
RedisModuËBlockedCl›Á
 *
bc
, *
´ivd©a
);

258 
	$REDISMODULE_API_FUNC
(
RedisModuË_IsBlockedR•lyReque¡
)(
RedisModuËCtx
 *
ùx
);

259 
	$REDISMODULE_API_FUNC
(
RedisModuË_IsBlockedTimeoutReque¡
)(
RedisModuËCtx
 *
ùx
);

260 *
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘BlockedCl›ÁPriv©eD©a
)(
RedisModuËCtx
 *
ùx
);

261 
	$REDISMODULE_API_FUNC
(
RedisModuË_AbÜtBlock
)(
RedisModuËBlockedCl›Á
 *
bc
);

262 
RedisModuËCtx
 *
	$REDISMODULE_API_FUNC
(
RedisModuË_G‘Th»adSaãCÚ‹xt
)(
RedisModuËBlockedCl›Á
 *
bc
);

263 
	$REDISMODULE_API_FUNC
(
RedisModuË_F»eTh»adSaãCÚ‹xt
)(
RedisModuËCtx
 *
ùx
);

264 
	$REDISMODULE_API_FUNC
(
RedisModuË_Th»adSaãCÚ‹xtLock
)(
RedisModuËCtx
 *
ùx
);

265 
	$REDISMODULE_API_FUNC
(
RedisModuË_Th»adSaãCÚ‹xtUÆock
)(
RedisModuËCtx
 *
ùx
);

266 
	$REDISMODULE_API_FUNC
(
RedisModuË_SubsüibeToKey¥aûEv’ts
)(
RedisModuËCtx
 *
ùx
, 
ty³s
, 
RedisModuËNÙifiÿtiÚFunc
 
cb
);

271 
	$RedisModuË_In™
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
è
	`__©Œibu‹__
((
unu£d
));

272 
	$RedisModuË_In™
(
RedisModuËCtx
 *
ùx
, cÚ¡ *
Çme
, 
v”
, 
­iv”
) {

273 *
g‘­ifunıŒ
 = ((**)
ùx
)[0];

274 
RedisModuË_G‘Api
 = ((*)(cÚ¡ *, *)è()
g‘­ifunıŒ
;

275 
	`REDISMODULE_GET_API
(
AÎoc
);

276 
	`REDISMODULE_GET_API
(
C®loc
);

277 
	`REDISMODULE_GET_API
(
F»e
);

278 
	`REDISMODULE_GET_API
(
R—Îoc
);

279 
	`REDISMODULE_GET_API
(
SŒdup
);

280 
	`REDISMODULE_GET_API
(
C»©eCommªd
);

281 
	`REDISMODULE_GET_API
(
S‘ModuËA‰ribs
);

282 
	`REDISMODULE_GET_API
(
IsModuËNameBusy
);

283 
	`REDISMODULE_GET_API
(
WrÚgAr™y
);

284 
	`REDISMODULE_GET_API
(
R•lyW™hLÚgLÚg
);

285 
	`REDISMODULE_GET_API
(
R•lyW™hE¼Ü
);

286 
	`REDISMODULE_GET_API
(
R•lyW™hSim¶eSŒšg
);

287 
	`REDISMODULE_GET_API
(
R•lyW™hA¼ay
);

288 
	`REDISMODULE_GET_API
(
R•lyS‘A¼ayL’gth
);

289 
	`REDISMODULE_GET_API
(
R•lyW™hSŒšgBufãr
);

290 
	`REDISMODULE_GET_API
(
R•lyW™hSŒšg
);

291 
	`REDISMODULE_GET_API
(
R•lyW™hNuÎ
);

292 
	`REDISMODULE_GET_API
(
R•lyW™hC®lR•ly
);

293 
	`REDISMODULE_GET_API
(
R•lyW™hDoubË
);

294 
	`REDISMODULE_GET_API
(
R•lyS‘A¼ayL’gth
);

295 
	`REDISMODULE_GET_API
(
G‘S–eùedDb
);

296 
	`REDISMODULE_GET_API
(
S–eùDb
);

297 
	`REDISMODULE_GET_API
(
O³nKey
);

298 
	`REDISMODULE_GET_API
(
Clo£Key
);

299 
	`REDISMODULE_GET_API
(
KeyTy³
);

300 
	`REDISMODULE_GET_API
(
V®ueL’gth
);

301 
	`REDISMODULE_GET_API
(
Li¡Push
);

302 
	`REDISMODULE_GET_API
(
Li¡Pİ
);

303 
	`REDISMODULE_GET_API
(
SŒšgToLÚgLÚg
);

304 
	`REDISMODULE_GET_API
(
SŒšgToDoubË
);

305 
	`REDISMODULE_GET_API
(
C®l
);

306 
	`REDISMODULE_GET_API
(
C®lR•lyPrÙo
);

307 
	`REDISMODULE_GET_API
(
F»eC®lR•ly
);

308 
	`REDISMODULE_GET_API
(
C®lR•lyIÁeg”
);

309 
	`REDISMODULE_GET_API
(
C®lR•lyTy³
);

310 
	`REDISMODULE_GET_API
(
C®lR•lyL’gth
);

311 
	`REDISMODULE_GET_API
(
C®lR•lyA¼ayEËm’t
);

312 
	`REDISMODULE_GET_API
(
C®lR•lySŒšgPŒ
);

313 
	`REDISMODULE_GET_API
(
C»©eSŒšgFromC®lR•ly
);

314 
	`REDISMODULE_GET_API
(
C»©eSŒšg
);

315 
	`REDISMODULE_GET_API
(
C»©eSŒšgFromLÚgLÚg
);

316 
	`REDISMODULE_GET_API
(
C»©eSŒšgFromSŒšg
);

317 
	`REDISMODULE_GET_API
(
C»©eSŒšgPrštf
);

318 
	`REDISMODULE_GET_API
(
F»eSŒšg
);

319 
	`REDISMODULE_GET_API
(
SŒšgPŒL’
);

320 
	`REDISMODULE_GET_API
(
AutoMemÜy
);

321 
	`REDISMODULE_GET_API
(
R•liÿ‹
);

322 
	`REDISMODULE_GET_API
(
R•liÿ‹V”b©im
);

323 
	`REDISMODULE_GET_API
(
D–‘eKey
);

324 
	`REDISMODULE_GET_API
(
UÆškKey
);

325 
	`REDISMODULE_GET_API
(
SŒšgS‘
);

326 
	`REDISMODULE_GET_API
(
SŒšgDMA
);

327 
	`REDISMODULE_GET_API
(
SŒšgTrunÿ‹
);

328 
	`REDISMODULE_GET_API
(
G‘Expœe
);

329 
	`REDISMODULE_GET_API
(
S‘Expœe
);

330 
	`REDISMODULE_GET_API
(
Z£tAdd
);

331 
	`REDISMODULE_GET_API
(
Z£tInüby
);

332 
	`REDISMODULE_GET_API
(
Z£tScÜe
);

333 
	`REDISMODULE_GET_API
(
Z£tRem
);

334 
	`REDISMODULE_GET_API
(
Z£tRªgeStİ
);

335 
	`REDISMODULE_GET_API
(
Z£tFœ¡InScÜeRªge
);

336 
	`REDISMODULE_GET_API
(
Z£tLa¡InScÜeRªge
);

337 
	`REDISMODULE_GET_API
(
Z£tFœ¡InLexRªge
);

338 
	`REDISMODULE_GET_API
(
Z£tLa¡InLexRªge
);

339 
	`REDISMODULE_GET_API
(
Z£tRªgeCu¼’tEËm’t
);

340 
	`REDISMODULE_GET_API
(
Z£tRªgeNext
);

341 
	`REDISMODULE_GET_API
(
Z£tRªgeP»v
);

342 
	`REDISMODULE_GET_API
(
Z£tRªgeEndR—ched
);

343 
	`REDISMODULE_GET_API
(
HashS‘
);

344 
	`REDISMODULE_GET_API
(
HashG‘
);

345 
	`REDISMODULE_GET_API
(
IsKeysPos™iÚReque¡
);

346 
	`REDISMODULE_GET_API
(
KeyAtPos
);

347 
	`REDISMODULE_GET_API
(
G‘Cl›ÁId
);

348 
	`REDISMODULE_GET_API
(
G‘CÚ‹xtFÏgs
);

349 
	`REDISMODULE_GET_API
(
PoŞAÎoc
);

350 
	`REDISMODULE_GET_API
(
C»©eD©aTy³
);

351 
	`REDISMODULE_GET_API
(
ModuËTy³S‘V®ue
);

352 
	`REDISMODULE_GET_API
(
ModuËTy³G‘Ty³
);

353 
	`REDISMODULE_GET_API
(
ModuËTy³G‘V®ue
);

354 
	`REDISMODULE_GET_API
(
SaveUnsigÃd
);

355 
	`REDISMODULE_GET_API
(
LßdUnsigÃd
);

356 
	`REDISMODULE_GET_API
(
SaveSigÃd
);

357 
	`REDISMODULE_GET_API
(
LßdSigÃd
);

358 
	`REDISMODULE_GET_API
(
SaveSŒšg
);

359 
	`REDISMODULE_GET_API
(
SaveSŒšgBufãr
);

360 
	`REDISMODULE_GET_API
(
LßdSŒšg
);

361 
	`REDISMODULE_GET_API
(
LßdSŒšgBufãr
);

362 
	`REDISMODULE_GET_API
(
SaveDoubË
);

363 
	`REDISMODULE_GET_API
(
LßdDoubË
);

364 
	`REDISMODULE_GET_API
(
SaveFlßt
);

365 
	`REDISMODULE_GET_API
(
LßdFlßt
);

366 
	`REDISMODULE_GET_API
(
Em™AOF
);

367 
	`REDISMODULE_GET_API
(
Log
);

368 
	`REDISMODULE_GET_API
(
LogIOE¼Ü
);

369 
	`REDISMODULE_GET_API
(
SŒšgAµ’dBufãr
);

370 
	`REDISMODULE_GET_API
(
R‘ašSŒšg
);

371 
	`REDISMODULE_GET_API
(
SŒšgCom·»
);

372 
	`REDISMODULE_GET_API
(
G‘CÚ‹xtFromIO
);

373 
	`REDISMODULE_GET_API
(
Mli£cÚds
);

374 
	`REDISMODULE_GET_API
(
Dige¡AddSŒšgBufãr
);

375 
	`REDISMODULE_GET_API
(
Dige¡AddLÚgLÚg
);

376 
	`REDISMODULE_GET_API
(
Dige¡EndSequ’û
);

378 #ifdeà
REDISMODULE_EXPERIMENTAL_API


379 
	`REDISMODULE_GET_API
(
G‘Th»adSaãCÚ‹xt
);

380 
	`REDISMODULE_GET_API
(
F»eTh»adSaãCÚ‹xt
);

381 
	`REDISMODULE_GET_API
(
Th»adSaãCÚ‹xtLock
);

382 
	`REDISMODULE_GET_API
(
Th»adSaãCÚ‹xtUÆock
);

383 
	`REDISMODULE_GET_API
(
BlockCl›Á
);

384 
	`REDISMODULE_GET_API
(
UnblockCl›Á
);

385 
	`REDISMODULE_GET_API
(
IsBlockedR•lyReque¡
);

386 
	`REDISMODULE_GET_API
(
IsBlockedTimeoutReque¡
);

387 
	`REDISMODULE_GET_API
(
G‘BlockedCl›ÁPriv©eD©a
);

388 
	`REDISMODULE_GET_API
(
AbÜtBlock
);

389 
	`REDISMODULE_GET_API
(
SubsüibeToKey¥aûEv’ts
);

393 ià(
RedisModuË_IsModuËNameBusy
 && 
	`RedisModuË_IsModuËNameBusy
(
Çme
)è 
REDISMODULE_ERR
;

394 
	`RedisModuË_S‘ModuËA‰ribs
(
ùx
,
Çme
,
v”
,
­iv”
);

395  
REDISMODULE_OK
;

396 
	}
}

402 
	#RedisModuËSŒšg
 
robj


	)

	@src/release.c

34 
	~<¡ršg.h
>

36 
	~"»Ëa£.h
"

37 
	~"v”siÚ.h
"

38 
	~"üc64.h
"

40 *
	$»disG™SHA1
() {

41  
REDIS_GIT_SHA1
;

42 
	}
}

44 *
	$»disG™Dœty
() {

45  
REDIS_GIT_DIRTY
;

46 
	}
}

48 
ušt64_t
 
	$»disBudId
() {

49 *
budid
 = 
REDIS_VERSION
 
REDIS_BUILD_ID
 
REDIS_GIT_DIRTY
 
REDIS_GIT_SHA1
;

51  
	`üc64
(0,(*)
budid
,
	`¡¾’
(buildid));

52 
	}
}

	@src/release.h

1 
	#REDIS_GIT_SHA1
 "00000000"

	)

2 
	#REDIS_GIT_DIRTY
 "0"

	)

3 
	#REDIS_BUILD_ID
 "puÃ-lom-1528893542"

	)

	@src/replication.c

32 
	~"£rv”.h
"

34 
	~<sys/time.h
>

35 
	~<uni¡d.h
>

36 
	~<fú.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/¡©.h
>

40 
»¶iÿtiÚDisÿrdCachedMa¡”
();

41 
»¶iÿtiÚResu¼eùCachedMa¡”
(
Ãwfd
);

42 
»¶iÿtiÚS’dAck
();

43 
putSÏveOÆše
(
ş›Á
 *
¦ave
);

44 
ÿnûlR•liÿtiÚHªdshake
();

52 *
	$»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
) {

53 
buf
[
NET_PEER_ID_LEN
];

54 

[
NET_IP_STR_LEN
];

56 

[0] = '\0';

57 
buf
[0] = '\0';

58 ià(
c
->
¦ave_
[0] != '\0' ||

59 
	`ª‘P“rToSŒšg
(
c
->
fd
,

,(),
NULL
) != -1)

62 ià(
c
->
¦ave_
[0] !ğ'\0'è
	`memıy
(

,c->slave_ip,(c->slave_ip));

64 ià(
c
->
¦ave_li¡’šg_pÜt
)

65 
	`ª‘FÜm©Addr
(
buf
,(buf),

,
c
->
¦ave_li¡’šg_pÜt
);

67 
	`¢´štf
(
buf
,(buf),"%s:<unknown-¦ave-pÜt>",

);

69 
	`¢´štf
(
buf
,(buf),"client id #%llu",

70 (è
c
->
id
);

72  
buf
;

73 
	}
}

77 
	$ü—‹R•liÿtiÚBacklog
() {

78 
	`£rv”As£¹
(
£rv”
.
»¶_backlog
 =ğ
NULL
);

79 
£rv”
.
»¶_backlog
 = 
	`zm®loc
(£rv”.
»¶_backlog_size
);

80 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

81 
£rv”
.
»¶_backlog_idx
 = 0;

86 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
+1;

87 
	}
}

95 
	$»sizeR•liÿtiÚBacklog
(
Ãwsize
) {

96 ià(
Ãwsize
 < 
CONFIG_REPL_BACKLOG_MIN_SIZE
)

97 
Ãwsize
 = 
CONFIG_REPL_BACKLOG_MIN_SIZE
;

98 ià(
£rv”
.
»¶_backlog_size
 =ğ
Ãwsize
) ;

100 
£rv”
.
»¶_backlog_size
 = 
Ãwsize
;

101 ià(
£rv”
.
»¶_backlog
 !ğ
NULL
) {

107 
	`zä“
(
£rv”
.
»¶_backlog
);

108 
£rv”
.
»¶_backlog
 = 
	`zm®loc
(£rv”.
»¶_backlog_size
);

109 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

110 
£rv”
.
»¶_backlog_idx
 = 0;

112 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
+1;

114 
	}
}

116 
	$ä“R•liÿtiÚBacklog
() {

117 
	`£rv”As£¹
(
	`li¡L’gth
(
£rv”
.
¦aves
) == 0);

118 
	`zä“
(
£rv”
.
»¶_backlog
);

119 
£rv”
.
»¶_backlog
 = 
NULL
;

120 
	}
}

126 
	$ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
) {

127 *
p
 = 
±r
;

129 
£rv”
.
ma¡”_»¶_off£t
 +ğ
Ën
;

133 
Ën
) {

134 
size_t
 
thi¦’
 = 
£rv”
.
»¶_backlog_size
 - s”v”.
»¶_backlog_idx
;

135 ià(
thi¦’
 > 
Ën
)hislen =†en;

136 
	`memıy
(
£rv”
.
»¶_backlog
+£rv”.
»¶_backlog_idx
,
p
,
thi¦’
);

137 
£rv”
.
»¶_backlog_idx
 +ğ
thi¦’
;

138 ià(
£rv”
.
»¶_backlog_idx
 =ğ£rv”.
»¶_backlog_size
)

139 
£rv”
.
»¶_backlog_idx
 = 0;

140 
Ën
 -ğ
thi¦’
;

141 
p
 +ğ
thi¦’
;

142 
£rv”
.
»¶_backlog_hi¡Ën
 +ğ
thi¦’
;

144 ià(
£rv”
.
»¶_backlog_hi¡Ën
 > s”v”.
»¶_backlog_size
)

145 
£rv”
.
»¶_backlog_hi¡Ën
 = s”v”.
»¶_backlog_size
;

147 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
 -

148 
£rv”
.
»¶_backlog_hi¡Ën
 + 1;

149 
	}
}

153 
	$ãedR•liÿtiÚBacklogW™hObjeù
(
robj
 *
o
) {

154 
Î¡r
[
LONG_STR_SIZE
];

155 *
p
;

156 
size_t
 
Ën
;

158 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

159 
Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),()
o
->
±r
);

160 
p
 = 
Î¡r
;

162 
Ën
 = 
	`sd¦’
(
o
->
±r
);

163 
p
 = 
o
->
±r
;

165 
	`ãedR•liÿtiÚBacklog
(
p
,
Ën
);

166 
	}
}

173 
	$»¶iÿtiÚF“dSÏves
(
li¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

174 
li¡Node
 *
Ê
;

175 
li¡I‹r
 
li
;

176 
j
, 
Ën
;

177 
Î¡r
[
LONG_STR_SIZE
];

184 ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
) ;

188 ià(
£rv”
.
»¶_backlog
 =ğ
NULL
 && 
	`li¡L’gth
(
¦aves
) == 0) ;

191 
	`£rv”As£¹
(!(
	`li¡L’gth
(
¦aves
è!ğ0 && 
£rv”
.
»¶_backlog
 =ğ
NULL
));

194 ià(
£rv”
.
¦ave£ldb
 !ğ
diùid
) {

195 
robj
 *
£Ëùcmd
;

198 ià(
diùid
 >ğ0 && diùid < 
PROTO_SHARED_SELECT_CMDS
) {

199 
£Ëùcmd
 = 
sh¬ed
.
£Ëù
[
diùid
];

201 
diùid_Ën
;

203 
diùid_Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),
diùid
);

204 
£Ëùcmd
 = 
	`ü—‹Objeù
(
OBJ_STRING
,

205 
	`sdsÿrštf
(
	`sd£m±y
(),

207 
diùid_Ën
, 
Î¡r
));

211 ià(
£rv”
.
»¶_backlog
è
	`ãedR•liÿtiÚBacklogW™hObjeù
(
£Ëùcmd
);

214 
	`li¡Rewšd
(
¦aves
,&
li
);

215 (
Ê
 = 
	`li¡Next
(&
li
))) {

216 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

217 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

218 
	`addR•ly
(
¦ave
,
£Ëùcmd
);

221 ià(
diùid
 < 0 || diùid >ğ
PROTO_SHARED_SELECT_CMDS
)

222 
	`deüRefCouÁ
(
£Ëùcmd
);

224 
£rv”
.
¦ave£ldb
 = 
diùid
;

227 ià(
£rv”
.
»¶_backlog
) {

228 
aux
[
LONG_STR_SIZE
+3];

231 
aux
[0] = '*';

232 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
¬gc
);

233 
aux
[
Ën
+1] = '\r';

234 
aux
[
Ën
+2] = '\n';

235 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

237 
j
 = 0; j < 
¬gc
; j++) {

238 
objËn
 = 
	`¡ršgObjeùL’
(
¬gv
[
j
]);

243 
aux
[0] = '$';

244 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
objËn
);

245 
aux
[
Ën
+1] = '\r';

246 
aux
[
Ën
+2] = '\n';

247 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

248 
	`ãedR•liÿtiÚBacklogW™hObjeù
(
¬gv
[
j
]);

249 
	`ãedR•liÿtiÚBacklog
(
aux
+
Ën
+1,2);

254 
	`li¡Rewšd
(
¦aves
,&
li
);

255 (
Ê
 = 
	`li¡Next
(&
li
))) {

256 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

259 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

266 
	`addR•lyMuÉiBulkL’
(
¦ave
,
¬gc
);

270 
j
 = 0; j < 
¬gc
; j++)

271 
	`addR•lyBulk
(
¦ave
,
¬gv
[
j
]);

273 
	}
}

277 
	~<ùy³.h
>

278 
	$»¶iÿtiÚF“dSÏvesFromMa¡”SŒ—m
(
li¡
 *
¦aves
, *
buf
, 
size_t
 
buæ’
) {

279 
li¡Node
 *
Ê
;

280 
li¡I‹r
 
li
;

285 
	`´štf
("%zu:",
buæ’
);

286 
size_t
 
j
 = 0; j < 
buæ’
; j++) {

287 
	`´štf
("%c", 
	`i¥ršt
(
buf
[
j
]) ? buf[j] : '.');

289 
	`´štf
("\n");

292 ià(
£rv”
.
»¶_backlog
è
	`ãedR•liÿtiÚBacklog
(
buf
,
buæ’
);

293 
	`li¡Rewšd
(
¦aves
,&
li
);

294 (
Ê
 = 
	`li¡Next
(&
li
))) {

295 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

298 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) ;

299 
	`addR•lySŒšg
(
¦ave
,
buf
,
buæ’
);

301 
	}
}

303 
	$»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
li¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

304 
li¡Node
 *
Ê
;

305 
li¡I‹r
 
li
;

306 
j
;

307 
sds
 
cmd»´
 = 
	`sd¢ew
("+");

308 
robj
 *
cmdobj
;

309 
timev®
 
tv
;

311 
	`g‘timeofday
(&
tv
,
NULL
);

312 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"%ld.%06ld ",()
tv
.
tv_£c
,(év.
tv_u£c
);

313 ià(
c
->
æags
 & 
CLIENT_LUA
) {

314 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d†ua] ",
diùid
);

315 } ià(
c
->
æags
 & 
CLIENT_UNIX_SOCKET
) {

316 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d unix:%s] ",
diùid
,
£rv”
.
unixsock‘
);

318 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d %s] ",
diùid
,
	`g‘Cl›ÁP“rId
(
c
));

321 
j
 = 0; j < 
¬gc
; j++) {

322 ià(
¬gv
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

323 
cmd»´
 = 
	`sdsÿrštf
(cmd»´, "\"%ld\"", ()
¬gv
[
j
]->
±r
);

325 
cmd»´
 = 
	`sdsÿŒ•r
(cmd»´,(*)
¬gv
[
j
]->
±r
,

326 
	`sd¦’
(
¬gv
[
j
]->
±r
));

328 ià(
j
 !ğ
¬gc
-1)

329 
cmd»´
 = 
	`sdsÿ’
(cmdrepr," ",1);

331 
cmd»´
 = 
	`sdsÿ’
(cmdrepr,"\r\n",2);

332 
cmdobj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
cmd»´
);

334 
	`li¡Rewšd
(
mÚ™Üs
,&
li
);

335 (
Ê
 = 
	`li¡Next
(&
li
))) {

336 
ş›Á
 *
mÚ™Ü
 = 
Ê
->
v®ue
;

337 
	`addR•ly
(
mÚ™Ü
,
cmdobj
);

339 
	`deüRefCouÁ
(
cmdobj
);

340 
	}
}

344 
	$addR•lyR•liÿtiÚBacklog
(
ş›Á
 *
c
, 
off£t
) {

345 
j
, 
sk
, 
Ën
;

347 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] SÏv»que¡ off£t: %Îd", 
off£t
);

349 ià(
£rv”
.
»¶_backlog_hi¡Ën
 == 0) {

350 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Backlog history†en is zero");

354 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Backlog size: %lld",

355 
£rv”
.
»¶_backlog_size
);

356 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] First byte: %lld",

357 
£rv”
.
»¶_backlog_off
);

358 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] History†en: %lld",

359 
£rv”
.
»¶_backlog_hi¡Ën
);

360 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Current index: %lld",

361 
£rv”
.
»¶_backlog_idx
);

364 
sk
 = 
off£t
 - 
£rv”
.
»¶_backlog_off
;

365 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Skpšg: %Îd", 
sk
);

369 
j
 = (
£rv”
.
»¶_backlog_idx
 +

370 (
£rv”
.
»¶_backlog_size
-£rv”.
»¶_backlog_hi¡Ën
)) %

371 
£rv”
.
»¶_backlog_size
;

372 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] Index oàfœ¡ by‹: %Îd", 
j
);

375 
j
 = (j + 
sk
è% 
£rv”
.
»¶_backlog_size
;

379 
Ën
 = 
£rv”
.
»¶_backlog_hi¡Ën
 - 
sk
;

380 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC] R•lyÙ®†’gth: %Îd", 
Ën
);

381 
Ën
) {

382 
thi¦’
 =

383 ((
£rv”
.
»¶_backlog_size
 - 
j
è< 
Ën
) ?

384 (
£rv”
.
»¶_backlog_size
 - 
j
è: 
Ën
;

386 
	`£rv”Log
(
LL_DEBUG
, "[PSYNC]‡ddR•ly(èËngth: %Îd", 
thi¦’
);

387 
	`addR•lySds
(
c
,
	`sd¢ewËn
(
£rv”
.
»¶_backlog
 + 
j
, 
thi¦’
));

388 
Ën
 -ğ
thi¦’
;

389 
j
 = 0;

391  
£rv”
.
»¶_backlog_hi¡Ën
 - 
sk
;

392 
	}
}

398 
	$g‘PsyncIn™ŸlOff£t
() {

399  
£rv”
.
ma¡”_»¶_off£t
;

400 
	}
}

418 
	$»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
ş›Á
 *
¦ave
, 
off£t
) {

419 
buf
[128];

420 
buæ’
;

422 
¦ave
->
psync_š™Ÿl_off£t
 = 
off£t
;

423 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_END
;

427 
£rv”
.
¦ave£ldb
 = -1;

431 ià(!(
¦ave
->
æags
 & 
CLIENT_PRE_PSYNC
)) {

432 
buæ’
 = 
	`¢´štf
(
buf
,(buf),"+FULLRESYNC %s %lld\r\n",

433 
£rv”
.
»¶id
,
off£t
);

434 ià(
	`wr™e
(
¦ave
->
fd
,
buf
,
buæ’
) != buflen) {

435 
	`ä“Cl›ÁAsync
(
¦ave
);

436  
C_ERR
;

439  
C_OK
;

440 
	}
}

447 
	$ma¡”TryP¬tŸlResynchrÚiz©iÚ
(
ş›Á
 *
c
) {

448 
psync_off£t
, 
psync_Ën
;

449 *
ma¡”_»¶id
 = 
c
->
¬gv
[1]->
±r
;

450 
buf
[128];

451 
buæ’
;

456 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
psync_off£t
,
NULL
) !=

457 
C_OK
è
Ãed_fuÎ_»sync
;

465 ià(
	`¡rÿ£cmp
(
ma¡”_»¶id
, 
£rv”
.
»¶id
) &&

466 (
	`¡rÿ£cmp
(
ma¡”_»¶id
, 
£rv”
.
»¶id2
) ||

467 
psync_off£t
 > 
£rv”
.
£cÚd_»¶id_off£t
))

470 ià(
ma¡”_»¶id
[0] != '?') {

471 ià(
	`¡rÿ£cmp
(
ma¡”_»¶id
, 
£rv”
.
»¶id
) &&

472 
	`¡rÿ£cmp
(
ma¡”_»¶id
, 
£rv”
.
»¶id2
))

474 
	`£rv”Log
(
LL_NOTICE
,"Partial„esynchronization‚ot‡ccepted: "

477 
ma¡”_»¶id
, 
£rv”
.
»¶id
, s”v”.
»¶id2
);

479 
	`£rv”Log
(
LL_NOTICE
,"Partial„esynchronization‚ot‡ccepted: "

481 "u°tØ%Îd", 
psync_off£t
, 
£rv”
.
£cÚd_»¶id_off£t
);

484 
	`£rv”Log
(
LL_NOTICE
,"Full„esync„equested by slave %s",

485 
	`»¶iÿtiÚG‘SÏveName
(
c
));

487 
Ãed_fuÎ_»sync
;

491 ià(!
£rv”
.
»¶_backlog
 ||

492 
psync_off£t
 < 
£rv”
.
»¶_backlog_off
 ||

493 
psync_off£t
 > (
£rv”
.
»¶_backlog_off
 + s”v”.
»¶_backlog_hi¡Ën
))

495 
	`£rv”Log
(
LL_NOTICE
,

496 "UÇbËØ·¹ŸÈ»synøw™h sÏv% fÜ†ack oàbacklog (SÏv»que¡ was: %Îd).", 
	`»¶iÿtiÚG‘SÏveName
(
c
), 
psync_off£t
);

497 ià(
psync_off£t
 > 
£rv”
.
ma¡”_»¶_off£t
) {

498 
	`£rv”Log
(
LL_WARNING
,

499 "W¬nšg: sÏv% Œ›dØPSYNC w™h‡Àoff£ˆth© i g»©”hªhma¡”„•liÿtiÚ off£t.", 
	`»¶iÿtiÚG‘SÏveName
(
c
));

501 
Ãed_fuÎ_»sync
;

508 
c
->
æags
 |ğ
CLIENT_SLAVE
;

509 
c
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

510 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

511 
c
->
»¶_put_Úlše_Ú_ack
 = 0;

512 
	`li¡AddNodeTa
(
£rv”
.
¦aves
,
c
);

516 ià(
c
->
¦ave_ÿ·
 & 
SLAVE_CAPA_PSYNC2
) {

517 
buæ’
 = 
	`¢´štf
(
buf
,(buf),"+CONTINUE %s\r\n", 
£rv”
.
»¶id
);

519 
buæ’
 = 
	`¢´štf
(
buf
,(buf),"+CONTINUE\r\n");

521 ià(
	`wr™e
(
c
->
fd
,
buf
,
buæ’
) != buflen) {

522 
	`ä“Cl›ÁAsync
(
c
);

523  
C_OK
;

525 
psync_Ën
 = 
	`addR•lyR•liÿtiÚBacklog
(
c
,
psync_off£t
);

526 
	`£rv”Log
(
LL_NOTICE
,

528 
	`»¶iÿtiÚG‘SÏveName
(
c
),

529 
psync_Ën
, 
psync_off£t
);

534 
	`»äeshGoodSÏvesCouÁ
();

535  
C_OK
;

537 
Ãed_fuÎ_»sync
:

542  
C_ERR
;

543 
	}
}

563 
	$¡¬tBg§veFÜR•liÿtiÚ
(
mšÿ·
) {

564 
»tv®
;

565 
sock‘_rg‘
 = 
£rv”
.
»¶_diskËss_sync
 && (
mšÿ·
 & 
SLAVE_CAPA_EOF
);

566 
li¡I‹r
 
li
;

567 
li¡Node
 *
Ê
;

569 
	`£rv”Log
(
LL_NOTICE
,"Starting BGSAVE for SYNC witharget: %s",

570 
sock‘_rg‘
 ? "slaves sockets" : "disk");

572 
rdbSaveInfo
 
rsi
, *
rsŒ
;

573 
rsŒ
 = 
	`rdbPİuÏ‹SaveInfo
(&
rsi
);

576 ià(
rsŒ
) {

577 ià(
sock‘_rg‘
)

578 
»tv®
 = 
	`rdbSaveToSÏvesSock‘s
(
rsŒ
);

580 
»tv®
 = 
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
,
rsŒ
);

582 
	`£rv”Log
(
LL_WARNING
,"BGSAVE for„eplication:„eplication information‚ot‡vailable, can't generatehe RDB file„ight‚ow. Try†ater.");

583 
»tv®
 = 
C_ERR
;

589 ià(
»tv®
 =ğ
C_ERR
) {

590 
	`£rv”Log
(
LL_WARNING
,"BGSAVE for„eplication failed");

591 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

592 (
Ê
 = 
	`li¡Next
(&
li
))) {

593 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

595 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

596 
¦ave
->
æags
 &ğ~
CLIENT_SLAVE
;

597 
	`li¡D–Node
(
£rv”
.
¦aves
,
Ê
);

598 
	`addR•lyE¼Ü
(
¦ave
,

600 
¦ave
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

603  
»tv®
;

608 ià(!
sock‘_rg‘
) {

609 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

610 (
Ê
 = 
	`li¡Next
(&
li
))) {

611 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

613 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

614 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
¦ave
,

615 
	`g‘PsyncIn™ŸlOff£t
());

622 ià(
»tv®
 =ğ
C_OK
è
	`»¶iÿtiÚSütCacheFlush
();

623  
»tv®
;

624 
	}
}

627 
	$syncCommªd
(
ş›Á
 *
c
) {

629 ià(
c
->
æags
 & 
CLIENT_SLAVE
) ;

633 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
) {

634 
	`addR•lySds
(
c
,
	`sd¢ew
("-NOMASTERLINK Can't SYNC while‚ot connected with my master\r\n"));

642 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

643 
	`addR•lyE¼Ü
(
c
,"SYNC‡nd PSYNC‡re invalid with…ending output");

647 
	`£rv”Log
(
LL_NOTICE
,"Slave %s‡sks for synchronization",

648 
	`»¶iÿtiÚG‘SÏveName
(
c
));

659 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[0]->
±r
,"psync")) {

660 ià(
	`ma¡”TryP¬tŸlResynchrÚiz©iÚ
(
c
è=ğ
C_OK
) {

661 
£rv”
.
¡©_sync_·¹Ÿl_ok
++;

664 *
ma¡”_»¶id
 = 
c
->
¬gv
[1]->
±r
;

670 ià(
ma¡”_»¶id
[0] !ğ'?'è
£rv”
.
¡©_sync_·¹Ÿl_”r
++;

676 
c
->
æags
 |ğ
CLIENT_PRE_PSYNC
;

680 
£rv”
.
¡©_sync_fuÎ
++;

684 
c
->
»¶¡©e
 = 
SLAVE_STATE_WAIT_BGSAVE_START
;

685 ià(
£rv”
.
»¶_di§bË_tı_nod–ay
)

686 
	`ª‘Di§bËTıNoD–ay
(
NULL
, 
c
->
fd
);

687 
c
->
»¶dbfd
 = -1;

688 
c
->
æags
 |ğ
CLIENT_SLAVE
;

689 
	`li¡AddNodeTa
(
£rv”
.
¦aves
,
c
);

692 ià(
	`li¡L’gth
(
£rv”
.
¦aves
è=ğ1 && s”v”.
»¶_backlog
 =ğ
NULL
) {

696 
	`chªgeR•liÿtiÚId
();

697 
	`ş—rR•liÿtiÚId2
();

698 
	`ü—‹R•liÿtiÚBacklog
();

702 ià(
£rv”
.
rdb_chd_pid
 != -1 &&

703 
£rv”
.
rdb_chd_ty³
 =ğ
RDB_CHILD_TYPE_DISK
)

708 
ş›Á
 *
¦ave
;

709 
li¡Node
 *
Ê
;

710 
li¡I‹r
 
li
;

712 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

713 (
Ê
 = 
	`li¡Next
(&
li
))) {

714 
¦ave
 = 
Ê
->
v®ue
;

715 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
) ;

719 ià(
Ê
 && ((
c
->
¦ave_ÿ·
 & 
¦ave
->slave_capa) == slave->slave_capa)) {

722 
	`cİyCl›ÁOuutBufãr
(
c
,
¦ave
);

723 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
c
,
¦ave
->
psync_š™Ÿl_off£t
);

724 
	`£rv”Log
(
LL_NOTICE
,"Waiting forƒnd of BGSAVE for SYNC");

728 
	`£rv”Log
(
LL_NOTICE
,"Can't‡ttachhe slaveohe current BGSAVE. Waiting for‚ext BGSAVE for SYNC");

732 } ià(
£rv”
.
rdb_chd_pid
 != -1 &&

733 
£rv”
.
rdb_chd_ty³
 =ğ
RDB_CHILD_TYPE_SOCKET
)

738 
	`£rv”Log
(
LL_NOTICE
,"Current BGSAVE has socketarget. Waiting for‚ext BGSAVE for SYNC");

742 ià(
£rv”
.
»¶_diskËss_sync
 && (
c
->
¦ave_ÿ·
 & 
SLAVE_CAPA_EOF
)) {

746 ià(
£rv”
.
»¶_diskËss_sync_d–ay
)

747 
	`£rv”Log
(
LL_NOTICE
,"Delay‚ext BGSAVE for diskless SYNC");

752 ià(
£rv”
.
aof_chd_pid
 == -1) {

753 
	`¡¬tBg§veFÜR•liÿtiÚ
(
c
->
¦ave_ÿ·
);

755 
	`£rv”Log
(
LL_NOTICE
,

762 
	}
}

776 
	$»¶cÚfCommªd
(
ş›Á
 *
c
) {

777 
j
;

779 ià((
c
->
¬gc
 % 2) == 0) {

782 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

787 
j
 = 1; j < 
c
->
¬gc
; j+=2) {

788 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"listening-port")) {

789 
pÜt
;

791 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+1],

792 &
pÜt
,
NULL
è!ğ
C_OK
))

794 
c
->
¦ave_li¡’šg_pÜt
 = 
pÜt
;

795 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"ip-address")) {

796 
sds
 

 = 
c
->
¬gv
[
j
+1]->
±r
;

797 ià(
	`sd¦’
(

è< (
c
->
¦ave_
)) {

798 
	`memıy
(
c
->
¦ave_
,

,
	`sd¦’
(ip)+1);

800 
	`addR•lyE¼ÜFÜm©
(
c
,"REPLCONF ip-address…rovided by "

801 "¦avš¡ªû i toØlÚg: %zd by‹s", 
	`sd¦’
(

));

804 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"capa")) {

806 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
+1]->
±r
,"eof"))

807 
c
->
¦ave_ÿ·
 |ğ
SLAVE_CAPA_EOF
;

808 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
+1]->
±r
,"psync2"))

809 
c
->
¦ave_ÿ·
 |ğ
SLAVE_CAPA_PSYNC2
;

810 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"ack")) {

814 
off£t
;

816 ià(!(
c
->
æags
 & 
CLIENT_SLAVE
)) ;

817 ià((
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[
j
+1], &
off£t
è!ğ
C_OK
))

819 ià(
off£t
 > 
c
->
»¶_ack_off
)

820 
c
->
»¶_ack_off
 = 
off£t
;

821 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

825 ià(
c
->
»¶_put_Úlše_Ú_ack
 && c->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
)

826 
	`putSÏveOÆše
(
c
);

829 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"getack")) {

832 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
ma¡”
è
	`»¶iÿtiÚS’dAck
();

835 
	`addR•lyE¼ÜFÜm©
(
c
,"Unrecognized REPLCONF option: %s",

836 (*)
c
->
¬gv
[
j
]->
±r
);

840 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

841 
	}
}

855 
	$putSÏveOÆše
(
ş›Á
 *
¦ave
) {

856 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

857 
¦ave
->
»¶_put_Úlše_Ú_ack
 = 0;

858 
¦ave
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

859 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
¦ave
->
fd
, 
AE_WRITABLE
,

860 
£ndR•lyToCl›Á
, 
¦ave
è=ğ
AE_ERR
) {

861 
	`£rv”Log
(
LL_WARNING
,"UÇbËØ»gi¡” wr™abËƒv’ˆfÜ sÏvbulk¿nsãr: %s", 
	`¡»¼Ü
(
”ºo
));

862 
	`ä“Cl›Á
(
¦ave
);

865 
	`»äeshGoodSÏvesCouÁ
();

866 
	`£rv”Log
(
LL_NOTICE
,"Synchronization with slave %s succeeded",

867 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

868 
	}
}

870 
	$£ndBulkToSÏve
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

871 
ş›Á
 *
¦ave
 = 
´ivd©a
;

872 
	`UNUSED
(
–
);

873 
	`UNUSED
(
mask
);

874 
buf
[
PROTO_IOBUF_LEN
];

875 
ssize_t
 
nwr™‹n
, 
buæ’
;

880 ià(
¦ave
->
»¶´—mbË
) {

881 
nwr™‹n
 = 
	`wr™e
(
fd
,
¦ave
->
»¶´—mbË
,
	`sd¦’
(slave->replpreamble));

882 ià(
nwr™‹n
 == -1) {

883 
	`£rv”Log
(
LL_VERBOSE
,"Writeƒrror sending RDB…reambleo slave: %s",

884 
	`¡»¼Ü
(
”ºo
));

885 
	`ä“Cl›Á
(
¦ave
);

888 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
nwr™‹n
;

889 
	`sd¤ªge
(
¦ave
->
»¶´—mbË
,
nwr™‹n
,-1);

890 ià(
	`sd¦’
(
¦ave
->
»¶´—mbË
) == 0) {

891 
	`sdsä“
(
¦ave
->
»¶´—mbË
);

892 
¦ave
->
»¶´—mbË
 = 
NULL
;

900 
	`l£ek
(
¦ave
->
»¶dbfd
,¦ave->
»¶dboff
,
SEEK_SET
);

901 
buæ’
 = 
	`»ad
(
¦ave
->
»¶dbfd
,
buf
,
PROTO_IOBUF_LEN
);

902 ià(
buæ’
 <= 0) {

903 
	`£rv”Log
(
LL_WARNING
,"Readƒrror sending DBo slave: %s",

904 (
buæ’
 =ğ0è? "´em©u» EOF" : 
	`¡»¼Ü
(
”ºo
));

905 
	`ä“Cl›Á
(
¦ave
);

908 ià((
nwr™‹n
 = 
	`wr™e
(
fd
,
buf
,
buæ’
)) == -1) {

909 ià(
”ºo
 !ğ
EAGAIN
) {

910 
	`£rv”Log
(
LL_WARNING
,"Writeƒrror sending DBo slave: %s",

911 
	`¡»¼Ü
(
”ºo
));

912 
	`ä“Cl›Á
(
¦ave
);

916 
¦ave
->
»¶dboff
 +ğ
nwr™‹n
;

917 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
nwr™‹n
;

918 ià(
¦ave
->
»¶dboff
 =ğ¦ave->
»¶dbsize
) {

919 
	`şo£
(
¦ave
->
»¶dbfd
);

920 
¦ave
->
»¶dbfd
 = -1;

921 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
¦ave
->
fd
,
AE_WRITABLE
);

922 
	`putSÏveOÆše
(
¦ave
);

924 
	}
}

940 
	$upd©eSÏvesWa™šgBg§ve
(
bg§v“¼
, 
ty³
) {

941 
li¡Node
 *
Ê
;

942 
¡¬tbg§ve
 = 0;

943 
mšÿ·
 = -1;

944 
li¡I‹r
 
li
;

946 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

947 (
Ê
 = 
	`li¡Next
(&
li
))) {

948 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

950 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

951 
¡¬tbg§ve
 = 1;

952 
mšÿ·
 = (mšÿ· =ğ-1è? 
¦ave
->
¦ave_ÿ·
 :

953 (
mšÿ·
 & 
¦ave
->
¦ave_ÿ·
);

954 } ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
) {

955 
»dis_¡©
 
buf
;

962 ià(
ty³
 =ğ
RDB_CHILD_TYPE_SOCKET
) {

963 
	`£rv”Log
(
LL_NOTICE
,

965 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

971 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_ONLINE
;

972 
¦ave
->
»¶_put_Úlše_Ú_ack
 = 1;

973 
¦ave
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

975 ià(
bg§v“¼
 !ğ
C_OK
) {

976 
	`ä“Cl›Á
(
¦ave
);

977 
	`£rv”Log
(
LL_WARNING
,"SYNC failed. BGSAVE child„eturned‡nƒrror");

980 ià((
¦ave
->
»¶dbfd
 = 
	`İ’
(
£rv”
.
rdb_f’ame
,
O_RDONLY
)) == -1 ||

981 
	`»dis_f¡©
(
¦ave
->
»¶dbfd
,&
buf
) == -1) {

982 
	`ä“Cl›Á
(
¦ave
);

983 
	`£rv”Log
(
LL_WARNING
,"SYNC faed. Cª'ˆİ’/¡© DB‡á” BGSAVE: %s", 
	`¡»¼Ü
(
”ºo
));

986 
¦ave
->
»¶dboff
 = 0;

987 
¦ave
->
»¶dbsize
 = 
buf
.
¡_size
;

988 
¦ave
->
»¶¡©e
 = 
SLAVE_STATE_SEND_BULK
;

989 
¦ave
->
»¶´—mbË
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"$%lld\r\n",

990 (è
¦ave
->
»¶dbsize
);

992 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
¦ave
->
fd
,
AE_WRITABLE
);

993 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
¦ave
->
fd
, 
AE_WRITABLE
, 
£ndBulkToSÏve
, sÏveè=ğ
AE_ERR
) {

994 
	`ä“Cl›Á
(
¦ave
);

1000 ià(
¡¬tbg§ve
è
	`¡¬tBg§veFÜR•liÿtiÚ
(
mšÿ·
);

1001 
	}
}

1007 
	$chªgeR•liÿtiÚId
() {

1008 
	`g‘RªdomHexCh¬s
(
£rv”
.
»¶id
,
CONFIG_RUN_ID_SIZE
);

1009 
£rv”
.
»¶id
[
CONFIG_RUN_ID_SIZE
] = '\0';

1010 
	}
}

1015 
	$ş—rR•liÿtiÚId2
() {

1016 
	`mem£t
(
£rv”
.
»¶id2
,'0',(£rv”.
»¶id
));

1017 
£rv”
.
»¶id2
[
CONFIG_RUN_ID_SIZE
] = '\0';

1018 
£rv”
.
£cÚd_»¶id_off£t
 = -1;

1019 
	}
}

1026 
	$shiáR•liÿtiÚId
() {

1027 
	`memıy
(
£rv”
.
»¶id2
,£rv”.
»¶id
,(server.replid));

1035 
£rv”
.
£cÚd_»¶id_off£t
 = s”v”.
ma¡”_»¶_off£t
+1;

1036 
	`chªgeR•liÿtiÚId
();

1037 
	`£rv”Log
(
LL_WARNING
,"S‘tšg secÚd¬y„•liÿtiÚ IDØ%s, v®id u°tØoff£t: %Îd. New„•liÿtiÚ ID i %s", 
£rv”
.
»¶id2
, s”v”.
£cÚd_»¶id_off£t
, s”v”.
»¶id
);

1038 
	}
}

1044 
	$¦aveIsInHªdshakeS‹
() {

1045  
£rv”
.
»¶_¡©e
 >ğ
REPL_STATE_RECEIVE_PONG
 &&

1046 
£rv”
.
»¶_¡©e
 <ğ
REPL_STATE_RECEIVE_PSYNC
;

1047 
	}
}

1057 
	$»¶iÿtiÚS’dNewlšeToMa¡”
() {

1058 
time_t
 
Ãwlše_£Á
;

1059 ià(
	`time
(
NULL
è!ğ
Ãwlše_£Á
) {

1060 
Ãwlše_£Á
 = 
	`time
(
NULL
);

1061 ià(
	`wr™e
(
£rv”
.
»¶_Œªsãr_s
,"\n",1) == -1) {

1065 
	}
}

1069 
	$»¶iÿtiÚEm±yDbC®lback
(*
´ivd©a
) {

1070 
	`UNUSED
(
´ivd©a
);

1071 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

1072 
	}
}

1077 
	$»¶iÿtiÚC»©eMa¡”Cl›Á
(
fd
, 
dbid
) {

1078 
£rv”
.
ma¡”
 = 
	`ü—‹Cl›Á
(
fd
);

1079 
£rv”
.
ma¡”
->
æags
 |ğ
CLIENT_MASTER
;

1080 
£rv”
.
ma¡”
->
auth’tiÿ‹d
 = 1;

1081 
£rv”
.
ma¡”
->
»¶off
 = s”v”.
ma¡”_š™Ÿl_off£t
;

1082 
£rv”
.
ma¡”
->
»ad_»¶off
 = s”v”.ma¡”->
»¶off
;

1083 
	`memıy
(
£rv”
.
ma¡”
->
»¶id
, s”v”.
ma¡”_»¶id
,

1084 (
£rv”
.
ma¡”_»¶id
));

1087 ià(
£rv”
.
ma¡”
->
»¶off
 == -1)

1088 
£rv”
.
ma¡”
->
æags
 |ğ
CLIENT_PRE_PSYNC
;

1089 ià(
dbid
 !ğ-1è
	`£ËùDb
(
£rv”
.
ma¡”
,dbid);

1090 
	}
}

1092 
	$»¡¬tAOF
() {

1093 
»Œy
 = 10;

1094 
»Œy
-- && 
	`¡¬tAµ’dOÆy
(è=ğ
C_ERR
) {

1095 
	`£rv”Log
(
LL_WARNING
,"Failedƒnablinghe AOF‡fter successful master synchronization! Trying it‡gain in one second.");

1096 
	`¦“p
(1);

1098 ià(!
»Œy
) {

1099 
	`£rv”Log
(
LL_WARNING
,"FATAL:his slave instance finishedhe synchronization with its master, buthe AOF can't beurned on. Exiting‚ow.");

1100 
	`ex™
(1);

1102 
	}
}

1105 
	#REPL_MAX_WRITTEN_BEFORE_FSYNC
 (1024*1024*8è

	)

1106 
	$»adSyncBulkPaylßd
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1107 
buf
[4096];

1108 
ssize_t
 
Ä—d
, 
»adËn
;

1109 
off_t
 
Ëá
;

1110 
	`UNUSED
(
–
);

1111 
	`UNUSED
(
´ivd©a
);

1112 
	`UNUSED
(
mask
);

1116 
eofm¬k
[
CONFIG_RUN_ID_SIZE
];

1117 
Ï¡by‹s
[
CONFIG_RUN_ID_SIZE
];

1118 
u£m¬k
 = 0;

1122 ià(
£rv”
.
»¶_Œªsãr_size
 == -1) {

1123 ià(
	`syncR—dLše
(
fd
,
buf
,1024,
£rv”
.
»¶_syncio_timeout
*1000) == -1) {

1124 
	`£rv”Log
(
LL_WARNING
,

1126 
	`¡»¼Ü
(
”ºo
));

1127 
”rÜ
;

1130 ià(
buf
[0] == '-') {

1131 
	`£rv”Log
(
LL_WARNING
,

1133 
buf
+1);

1134 
”rÜ
;

1135 } ià(
buf
[0] == '\0') {

1139 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1141 } ià(
buf
[0] != '$') {

1142 
	`£rv”Log
(
LL_WARNING
,"Bad…rÙocŞ from MASTER,hfœ¡ by‹ i nÙ '$' (w»ûived '%s'),‡» you su»hho¡‡nd…Üˆ¬right?", 
buf
);

1143 
”rÜ
;

1156 ià(
	`¡ºcmp
(
buf
+1,"EOF:",4è=ğ0 && 
	`¡¾’
(buf+5è>ğ
CONFIG_RUN_ID_SIZE
) {

1157 
u£m¬k
 = 1;

1158 
	`memıy
(
eofm¬k
,
buf
+5,
CONFIG_RUN_ID_SIZE
);

1159 
	`mem£t
(
Ï¡by‹s
,0,
CONFIG_RUN_ID_SIZE
);

1162 
£rv”
.
»¶_Œªsãr_size
 = 0;

1163 
	`£rv”Log
(
LL_NOTICE
,

1166 
u£m¬k
 = 0;

1167 
£rv”
.
»¶_Œªsãr_size
 = 
	`¡¹Ş
(
buf
+1,
NULL
,10);

1168 
	`£rv”Log
(
LL_NOTICE
,

1170 (è
£rv”
.
»¶_Œªsãr_size
);

1176 ià(
u£m¬k
) {

1177 
»adËn
 = (
buf
);

1179 
Ëá
 = 
£rv”
.
»¶_Œªsãr_size
 - s”v”.
»¶_Œªsãr_»ad
;

1180 
»adËn
 = (
Ëá
 < (sigÃd)(
buf
)) ?†eft : (signed)(buf);

1183 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
»adËn
);

1184 ià(
Ä—d
 <= 0) {

1185 
	`£rv”Log
(
LL_WARNING
,"I/Oƒrrorryingo sync with MASTER: %s",

1186 (
Ä—d
 =ğ-1è? 
	`¡»¼Ü
(
”ºo
) : "connection†ost");

1187 
	`ÿnûlR•liÿtiÚHªdshake
();

1190 
£rv”
.
¡©_Ãt_šput_by‹s
 +ğ
Ä—d
;

1194 
eof_»ached
 = 0;

1196 ià(
u£m¬k
) {

1198 ià(
Ä—d
 >ğ
CONFIG_RUN_ID_SIZE
) {

1199 
	`memıy
(
Ï¡by‹s
,
buf
+
Ä—d
-
CONFIG_RUN_ID_SIZE
,CONFIG_RUN_ID_SIZE);

1201 
»m
 = 
CONFIG_RUN_ID_SIZE
-
Ä—d
;

1202 
	`memmove
(
Ï¡by‹s
,Ï¡by‹s+
Ä—d
,
»m
);

1203 
	`memıy
(
Ï¡by‹s
+
»m
,
buf
,
Ä—d
);

1205 ià(
	`memcmp
(
Ï¡by‹s
,
eofm¬k
,
CONFIG_RUN_ID_SIZE
è=ğ0è
eof_»ached
 = 1;

1208 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1209 ià(
	`wr™e
(
£rv”
.
»¶_Œªsãr_fd
,
buf
,
Ä—d
) !=‚read) {

1210 
	`£rv”Log
(
LL_WARNING
,"Wr™”rÜ o¸shÜˆwr™wr™šgØthDB dum°fÃeded fÜ MASTER <-> SLAVE synchrÚiz©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

1211 
”rÜ
;

1213 
£rv”
.
»¶_Œªsãr_»ad
 +ğ
Ä—d
;

1216 ià(
u£m¬k
 && 
eof_»ached
) {

1217 ià(
	`árunÿ‹
(
£rv”
.
»¶_Œªsãr_fd
,

1218 
£rv”
.
»¶_Œªsãr_»ad
 - 
CONFIG_RUN_ID_SIZE
) == -1)

1220 
	`£rv”Log
(
LL_WARNING
,"E¼ÜrunÿtšghRDB f»ûived fromhma¡” fÜ SYNC: %s", 
	`¡»¼Ü
(
”ºo
));

1221 
”rÜ
;

1228 ià(
£rv”
.
»¶_Œªsãr_»ad
 >=

1229 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 + 
REPL_MAX_WRITTEN_BEFORE_FSYNC
)

1231 
off_t
 
sync_size
 = 
£rv”
.
»¶_Œªsãr_»ad
 -

1232 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
;

1233 
	`rdb_fsync_¿nge
(
£rv”
.
»¶_Œªsãr_fd
,

1234 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
, 
sync_size
);

1235 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 +ğ
sync_size
;

1239 ià(!
u£m¬k
) {

1240 ià(
£rv”
.
»¶_Œªsãr_»ad
 =ğ£rv”.
»¶_Œªsãr_size
)

1241 
eof_»ached
 = 1;

1244 ià(
eof_»ached
) {

1245 
aof_is_’abËd
 = 
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
;

1247 ià(
	`»Çme
(
£rv”
.
»¶_Œªsãr_tmpfe
,£rv”.
rdb_f’ame
) == -1) {

1248 
	`£rv”Log
(
LL_WARNING
,"FaedryšgØ»Çmth‹m°DB iÁØdump.rdb iÀMASTER <-> SLAVE synchrÚiz©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

1249 
	`ÿnûlR•liÿtiÚHªdshake
();

1252 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Flushing old data");

1255 if(
aof_is_’abËd
è
	`¡İAµ’dOÆy
();

1256 
	`sigÇlFlushedDb
(-1);

1257 
	`em±yDb
(

1259 
£rv”
.
»¶_¦ave_Ïzy_æush
 ? 
EMPTYDB_ASYNC
 : 
EMPTYDB_NO_FLAGS
,

1260 
»¶iÿtiÚEm±yDbC®lback
);

1265 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
»¶_Œªsãr_s
,
AE_READABLE
);

1266 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Loading DB in memory");

1267 
rdbSaveInfo
 
rsi
 = 
RDB_SAVE_INFO_INIT
;

1268 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
,&
rsi
è!ğ
C_OK
) {

1269 
	`£rv”Log
(
LL_WARNING
,"Failedryingo†oadhe MASTER synchronization DB from disk");

1270 
	`ÿnûlR•liÿtiÚHªdshake
();

1273 ià(
aof_is_’abËd
è
	`»¡¬tAOF
();

1277 
	`zä“
(
£rv”
.
»¶_Œªsãr_tmpfe
);

1278 
	`şo£
(
£rv”
.
»¶_Œªsãr_fd
);

1279 
	`»¶iÿtiÚC»©eMa¡”Cl›Á
(
£rv”
.
»¶_Œªsãr_s
,
rsi
.
»¶_¡»am_db
);

1280 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECTED
;

1284 
	`memıy
(
£rv”
.
»¶id
,£rv”.
ma¡”
->replid,(server.replid));

1285 
£rv”
.
ma¡”_»¶_off£t
 = s”v”.
ma¡”
->
»¶off
;

1286 
	`ş—rR•liÿtiÚId2
();

1291 ià(
£rv”
.
»¶_backlog
 =ğ
NULL
è
	`ü—‹R•liÿtiÚBacklog
();

1293 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Finished with success");

1297 ià(
aof_is_’abËd
è
	`»¡¬tAOF
();

1301 
”rÜ
:

1302 
	`ÿnûlR•liÿtiÚHªdshake
();

1304 
	}
}

1312 
	#SYNC_CMD_READ
 (1<<0)

	)

1313 
	#SYNC_CMD_WRITE
 (1<<1)

	)

1314 
	#SYNC_CMD_FULL
 (
SYNC_CMD_READ
|
SYNC_CMD_WRITE
)

	)

1315 *
	$£ndSynchrÚousCommªd
(
æags
, 
fd
, ...) {

1319 ià(
æags
 & 
SYNC_CMD_WRITE
) {

1320 *
¬g
;

1321 
va_li¡
 
­
;

1322 
sds
 
cmd
 = 
	`sd£m±y
();

1323 
	`va_¡¬t
(
­
,
fd
);

1326 
¬g
 = 
	`va_¬g
(
­
, *);

1327 ià(
¬g
 =ğ
NULL
) ;

1329 ià(
	`sd¦’
(
cmd
è!ğ0ècmd = 
	`sdsÿ’
(cmd," ",1);

1330 
cmd
 = 
	`sdsÿt
(cmd,
¬g
);

1332 
cmd
 = 
	`sdsÿ’
(cmd,"\r\n",2);

1333 
	`va_’d
(
­
);

1336 ià(
	`syncWr™e
(
fd
,
cmd
,
	`sd¦’
(cmd),
£rv”
.
»¶_syncio_timeout
*1000)

1339 
	`sdsä“
(
cmd
);

1340  
	`sdsÿrštf
(
	`sd£m±y
(),"-Writingo master: %s",

1341 
	`¡»¼Ü
(
”ºo
));

1343 
	`sdsä“
(
cmd
);

1347 ià(
æags
 & 
SYNC_CMD_READ
) {

1348 
buf
[256];

1350 ià(
	`syncR—dLše
(
fd
,
buf
,(buf),
£rv”
.
»¶_syncio_timeout
*1000)

1353  
	`sdsÿrštf
(
	`sd£m±y
(),"-Reading from master: %s",

1354 
	`¡»¼Ü
(
”ºo
));

1356 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1357  
	`sd¢ew
(
buf
);

1359  
NULL
;

1360 
	}
}

1410 
	#PSYNC_WRITE_ERROR
 0

	)

1411 
	#PSYNC_WAIT_REPLY
 1

	)

1412 
	#PSYNC_CONTINUE
 2

	)

1413 
	#PSYNC_FULLRESYNC
 3

	)

1414 
	#PSYNC_NOT_SUPPORTED
 4

	)

1415 
	#PSYNC_TRY_LATER
 5

	)

1416 
	$¦aveTryP¬tŸlResynchrÚiz©iÚ
(
fd
, 
»ad_»¶y
) {

1417 *
psync_»¶id
;

1418 
psync_off£t
[32];

1419 
sds
 
»¶y
;

1422 ià(!
»ad_»¶y
) {

1428 
£rv”
.
ma¡”_š™Ÿl_off£t
 = -1;

1430 ià(
£rv”
.
ÿched_ma¡”
) {

1431 
psync_»¶id
 = 
£rv”
.
ÿched_ma¡”
->
»¶id
;

1432 
	`¢´štf
(
psync_off£t
,Õsync_off£t),"%Îd", 
£rv”
.
ÿched_ma¡”
->
»¶off
+1);

1433 
	`£rv”Log
(
LL_NOTICE
,"Tryšg‡…¬tŸÈ»synchrÚiz©iÚ (»que¡ %s:%s).", 
psync_»¶id
, 
psync_off£t
);

1435 
	`£rv”Log
(
LL_NOTICE
,"Partial„esynchronization‚ot…ossible (no cached master)");

1436 
psync_»¶id
 = "?";

1437 
	`memıy
(
psync_off£t
,"-1",3);

1441 
»¶y
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"PSYNC",
psync_»¶id
,
psync_off£t
,
NULL
);

1442 ià(
»¶y
 !ğ
NULL
) {

1443 
	`£rv”Log
(
LL_WARNING
,"UÇbËØ£nd PSYNCØma¡”: %s",
»¶y
);

1444 
	`sdsä“
(
»¶y
);

1445 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
);

1446  
PSYNC_WRITE_ERROR
;

1448  
PSYNC_WAIT_REPLY
;

1452 
»¶y
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1453 ià(
	`sd¦’
(
»¶y
) == 0) {

1456 
	`sdsä“
(
»¶y
);

1457  
PSYNC_WAIT_REPLY
;

1460 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
);

1462 ià(!
	`¡ºcmp
(
»¶y
,"+FULLRESYNC",11)) {

1463 *
»¶id
 = 
NULL
, *
off£t
 = NULL;

1467 
»¶id
 = 
	`¡rchr
(
»¶y
,' ');

1468 ià(
»¶id
) {

1469 
»¶id
++;

1470 
off£t
 = 
	`¡rchr
(
»¶id
,' ');

1471 ià(
off£t
) offset++;

1473 ià(!
»¶id
 || !
off£t
 || (off£t-»¶id-1è!ğ
CONFIG_RUN_ID_SIZE
) {

1474 
	`£rv”Log
(
LL_WARNING
,

1480 
	`mem£t
(
£rv”
.
ma¡”_»¶id
,0,
CONFIG_RUN_ID_SIZE
+1);

1482 
	`memıy
(
£rv”
.
ma¡”_»¶id
, 
»¶id
, 
off£t
-replid-1);

1483 
£rv”
.
ma¡”_»¶id
[
CONFIG_RUN_ID_SIZE
] = '\0';

1484 
£rv”
.
ma¡”_š™Ÿl_off£t
 = 
	`¡¹Şl
(
off£t
,
NULL
,10);

1485 
	`£rv”Log
(
LL_NOTICE
,"Full„esync from master: %s:%lld",

1486 
£rv”
.
ma¡”_»¶id
,

1487 
£rv”
.
ma¡”_š™Ÿl_off£t
);

1490 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1491 
	`sdsä“
(
»¶y
);

1492  
PSYNC_FULLRESYNC
;

1495 ià(!
	`¡ºcmp
(
»¶y
,"+CONTINUE",9)) {

1497 
	`£rv”Log
(
LL_NOTICE
,

1505 *
¡¬t
 = 
»¶y
+10;

1506 *
’d
 = 
»¶y
+9;

1507 
’d
[0] != '\r' &&ƒnd[0] != '\n' &&ƒnd[0] != '\0')ƒnd++;

1508 ià(
’d
-
¡¬t
 =ğ
CONFIG_RUN_ID_SIZE
) {

1509 
Ãw
[
CONFIG_RUN_ID_SIZE
+1];

1510 
	`memıy
(
Ãw
,
¡¬t
,
CONFIG_RUN_ID_SIZE
);

1511 
Ãw
[
CONFIG_RUN_ID_SIZE
] = '\0';

1513 ià(
	`¡rcmp
(
Ãw
,
£rv”
.
ÿched_ma¡”
->
»¶id
)) {

1515 
	`£rv”Log
(
LL_WARNING
,"Ma¡”„•liÿtiÚ ID chªgedØ%s",
Ãw
);

1518 
	`memıy
(
£rv”
.
»¶id2
,£rv”.
ÿched_ma¡”
->
»¶id
,

1519 (
£rv”
.
»¶id2
));

1520 
£rv”
.
£cÚd_»¶id_off£t
 = s”v”.
ma¡”_»¶_off£t
+1;

1524 
	`memıy
(
£rv”
.
»¶id
,
Ãw
,(server.replid));

1525 
	`memıy
(
£rv”
.
ÿched_ma¡”
->
»¶id
,
Ãw
,(server.replid));

1528 
	`discÚÃùSÏves
();

1533 
	`sdsä“
(
»¶y
);

1534 
	`»¶iÿtiÚResu¼eùCachedMa¡”
(
fd
);

1539 ià(
£rv”
.
»¶_backlog
 =ğ
NULL
è
	`ü—‹R•liÿtiÚBacklog
();

1540  
PSYNC_CONTINUE
;

1550 ià(!
	`¡ºcmp
(
»¶y
,"-NOMASTERLINK",13) ||

1551 !
	`¡ºcmp
(
»¶y
,"-LOADING",8))

1553 
	`£rv”Log
(
LL_NOTICE
,

1555 "buˆshould bšhfutu»: %s", 
»¶y
);

1556 
	`sdsä“
(
»¶y
);

1557  
PSYNC_TRY_LATER
;

1560 ià(
	`¡ºcmp
(
»¶y
,"-ERR",4)) {

1562 
	`£rv”Log
(
LL_WARNING
,

1563 "UÃx³ùed„•lyØPSYNC from ma¡”: %s", 
»¶y
);

1565 
	`£rv”Log
(
LL_NOTICE
,

1567 "”rÜ s‹ (»¶y: %s)", 
»¶y
);

1569 
	`sdsä“
(
»¶y
);

1570 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1571  
PSYNC_NOT_SUPPORTED
;

1572 
	}
}

1576 
	$syncW™hMa¡”
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1577 
tmpfe
[256], *
”r
 = 
NULL
;

1578 
dfd
 = -1, 
maxŒ›s
 = 5;

1579 
sock”r
 = 0, 
psync_»suÉ
;

1580 
sockËn_t
 
”¾’
 = (
sock”r
);

1581 
	`UNUSED
(
–
);

1582 
	`UNUSED
(
´ivd©a
);

1583 
	`UNUSED
(
mask
);

1587 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_NONE
) {

1588 
	`şo£
(
fd
);

1594 ià(
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
sock”r
, &
”¾’
) == -1)

1595 
sock”r
 = 
”ºo
;

1596 ià(
sock”r
) {

1597 
	`£rv”Log
(
LL_WARNING
,"Error condition on socket for SYNC: %s",

1598 
	`¡»¼Ü
(
sock”r
));

1599 
”rÜ
;

1603 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTING
) {

1604 
	`£rv”Log
(
LL_NOTICE
,"Non blocking connect for SYNC firedheƒvent.");

1607 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_WRITABLE
);

1608 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_PONG
;

1611 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"PING",
NULL
);

1612 ià(
”r
è
wr™e_”rÜ
;

1617 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_PONG
) {

1618 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1625 ià(
”r
[0] != '+' &&

1626 
	`¡ºcmp
(
”r
,"-NOAUTH",7) != 0 &&

1627 
	`¡ºcmp
(
”r
,"-ERR operation‚ot…ermitted",28) != 0)

1629 
	`£rv”Log
(
LL_WARNING
,"E¼Ü„•lyØPING from ma¡”: '%s'",
”r
);

1630 
	`sdsä“
(
”r
);

1631 
”rÜ
;

1633 
	`£rv”Log
(
LL_NOTICE
,

1636 
	`sdsä“
(
”r
);

1637 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_AUTH
;

1641 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_AUTH
) {

1642 ià(
£rv”
.
ma¡”auth
) {

1643 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"AUTH",
£rv”
.
ma¡”auth
,
NULL
);

1644 ià(
”r
è
wr™e_”rÜ
;

1645 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_AUTH
;

1648 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_PORT
;

1653 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_AUTH
) {

1654 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1655 ià(
”r
[0] == '-') {

1656 
	`£rv”Log
(
LL_WARNING
,"UÇbËØAUTHØMASTER: %s",
”r
);

1657 
	`sdsä“
(
”r
);

1658 
”rÜ
;

1660 
	`sdsä“
(
”r
);

1661 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_PORT
;

1666 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_PORT
) {

1667 
sds
 
pÜt
 = 
	`sdsäomlÚglÚg
(
£rv”
.
¦ave_ªnounû_pÜt
 ?

1668 
£rv”
.
¦ave_ªnounû_pÜt
 : s”v”.
pÜt
);

1669 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"REPLCONF",

1670 "li¡’šg-pÜt",
pÜt
, 
NULL
);

1671 
	`sdsä“
(
pÜt
);

1672 ià(
”r
è
wr™e_”rÜ
;

1673 
	`sdsä“
(
”r
);

1674 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_PORT
;

1679 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_PORT
) {

1680 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1683 ià(
”r
[0] == '-') {

1684 
	`£rv”Log
(
LL_NOTICE
,"(Non critical) Master does‚ot understand "

1685 "REPLCONF†i¡’šg-pÜt: %s", 
”r
);

1687 
	`sdsä“
(
”r
);

1688 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_IP
;

1692 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_IP
 &&

1693 
£rv”
.
¦ave_ªnounû_
 =ğ
NULL
)

1695 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_CAPA
;

1700 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_IP
) {

1701 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"REPLCONF",

1702 "-add»ss",
£rv”
.
¦ave_ªnounû_
, 
NULL
);

1703 ià(
”r
è
wr™e_”rÜ
;

1704 
	`sdsä“
(
”r
);

1705 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_IP
;

1710 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_IP
) {

1711 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1714 ià(
”r
[0] == '-') {

1715 
	`£rv”Log
(
LL_NOTICE
,"(Non critical) Master does‚ot understand "

1716 "REPLCONF ip-add»ss: %s", 
”r
);

1718 
	`sdsä“
(
”r
);

1719 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_CAPA
;

1728 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_CAPA
) {

1729 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_WRITE
,
fd
,"REPLCONF",

1730 "ÿ·","eof","ÿ·","psync2",
NULL
);

1731 ià(
”r
è
wr™e_”rÜ
;

1732 
	`sdsä“
(
”r
);

1733 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_CAPA
;

1738 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_RECEIVE_CAPA
) {

1739 
”r
 = 
	`£ndSynchrÚousCommªd
(
SYNC_CMD_READ
,
fd
,
NULL
);

1742 ià(
”r
[0] == '-') {

1743 
	`£rv”Log
(
LL_NOTICE
,"(Non critical) Master does‚ot understand "

1744 "REPLCONF c­a: %s", 
”r
);

1746 
	`sdsä“
(
”r
);

1747 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_SEND_PSYNC
;

1755 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_SEND_PSYNC
) {

1756 ià(
	`¦aveTryP¬tŸlResynchrÚiz©iÚ
(
fd
,0è=ğ
PSYNC_WRITE_ERROR
) {

1757 
”r
 = 
	`sd¢ew
("Writeƒrror sendinghe PSYNC command.");

1758 
wr™e_”rÜ
;

1760 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_RECEIVE_PSYNC
;

1765 ià(
£rv”
.
»¶_¡©e
 !ğ
REPL_STATE_RECEIVE_PSYNC
) {

1766 
	`£rv”Log
(
LL_WARNING
,"syncWithMaster(): state machineƒrror, "

1768 
£rv”
.
»¶_¡©e
);

1769 
”rÜ
;

1772 
psync_»suÉ
 = 
	`¦aveTryP¬tŸlResynchrÚiz©iÚ
(
fd
,1);

1773 ià(
psync_»suÉ
 =ğ
PSYNC_WAIT_REPLY
) ;

1779 ià(
psync_»suÉ
 =ğ
PSYNC_TRY_LATER
è
”rÜ
;

1784 ià(
psync_»suÉ
 =ğ
PSYNC_CONTINUE
) {

1785 
	`£rv”Log
(
LL_NOTICE
, "MASTER <-> SLAVE sync: Master‡ccepted‡ Partial Resynchronization.");

1793 
	`discÚÃùSÏves
();

1794 
	`ä“R•liÿtiÚBacklog
();

1799 ià(
psync_»suÉ
 =ğ
PSYNC_NOT_SUPPORTED
) {

1800 
	`£rv”Log
(
LL_NOTICE
,"Retrying with SYNC...");

1801 ià(
	`syncWr™e
(
fd
,"SYNC\r\n",6,
£rv”
.
»¶_syncio_timeout
*1000) == -1) {

1802 
	`£rv”Log
(
LL_WARNING
,"I/Oƒrror writingo MASTER: %s",

1803 
	`¡»¼Ü
(
”ºo
));

1804 
”rÜ
;

1809 
maxŒ›s
--) {

1810 
	`¢´štf
(
tmpfe
,256,

1811 "‹mp-%d.%ld.rdb",()
£rv”
.
unixtime
,()
	`g‘pid
());

1812 
dfd
 = 
	`İ’
(
tmpfe
,
O_CREAT
|
O_WRONLY
|
O_EXCL
,0644);

1813 ià(
dfd
 != -1) ;

1814 
	`¦“p
(1);

1816 ià(
dfd
 == -1) {

1817 
	`£rv”Log
(
LL_WARNING
,"O³nšgh‹m°fÃeded fÜ MASTER <-> SLAVE synchrÚiz©iÚ: %s",
	`¡»¼Ü
(
”ºo
));

1818 
”rÜ
;

1822 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
, 
AE_READABLE
,
»adSyncBulkPaylßd
,
NULL
)

1823 =ğ
AE_ERR
)

1825 
	`£rv”Log
(
LL_WARNING
,

1827 
	`¡»¼Ü
(
”ºo
),
fd
);

1828 
”rÜ
;

1831 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_TRANSFER
;

1832 
£rv”
.
»¶_Œªsãr_size
 = -1;

1833 
£rv”
.
»¶_Œªsãr_»ad
 = 0;

1834 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 = 0;

1835 
£rv”
.
»¶_Œªsãr_fd
 = 
dfd
;

1836 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1837 
£rv”
.
»¶_Œªsãr_tmpfe
 = 
	`z¡rdup
(
tmpfe
);

1840 
”rÜ
:

1841 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
);

1842 ià(
dfd
 !ğ-1è
	`şo£
(dfd);

1843 
	`şo£
(
fd
);

1844 
£rv”
.
»¶_Œªsãr_s
 = -1;

1845 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1848 
wr™e_”rÜ
:

1849 
	`£rv”Log
(
LL_WARNING
,"S’dšg commªdØma¡” iÀ»¶iÿtiÚ hªdshake: %s", 
”r
);

1850 
	`sdsä“
(
”r
);

1851 
”rÜ
;

1852 
	}
}

1854 
	$cÚÃùW™hMa¡”
() {

1855 
fd
;

1857 
fd
 = 
	`ª‘TıNÚBlockBe¡EffÜtBšdCÚÃù
(
NULL
,

1858 
£rv”
.
ma¡”ho¡
,£rv”.
ma¡”pÜt
,
NET_FIRST_BIND_ADDR
);

1859 ià(
fd
 == -1) {

1860 
	`£rv”Log
(
LL_WARNING
,"Unableo connecto MASTER: %s",

1861 
	`¡»¼Ü
(
”ºo
));

1862  
C_ERR
;

1865 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
,
syncW™hMa¡”
,
NULL
) ==

1866 
AE_ERR
)

1868 
	`şo£
(
fd
);

1869 
	`£rv”Log
(
LL_WARNING
,"Can't create„eadableƒvent for SYNC");

1870  
C_ERR
;

1873 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1874 
£rv”
.
»¶_Œªsãr_s
 = 
fd
;

1875 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECTING
;

1876  
C_OK
;

1877 
	}
}

1883 
	$undoCÚÃùW™hMa¡”
() {

1884 
fd
 = 
£rv”
.
»¶_Œªsãr_s
;

1886 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
);

1887 
	`şo£
(
fd
);

1888 
£rv”
.
»¶_Œªsãr_s
 = -1;

1889 
	}
}

1894 
	$»¶iÿtiÚAbÜtSyncT¿nsãr
() {

1895 
	`£rv”As£¹
(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
);

1896 
	`undoCÚÃùW™hMa¡”
();

1897 
	`şo£
(
£rv”
.
»¶_Œªsãr_fd
);

1898 
	`uÆšk
(
£rv”
.
»¶_Œªsãr_tmpfe
);

1899 
	`zä“
(
£rv”
.
»¶_Œªsãr_tmpfe
);

1900 
	}
}

1910 
	$ÿnûlR•liÿtiÚHªdshake
() {

1911 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
) {

1912 
	`»¶iÿtiÚAbÜtSyncT¿nsãr
();

1913 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1914 } ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTING
 ||

1915 
	`¦aveIsInHªdshakeS‹
())

1917 
	`undoCÚÃùW™hMa¡”
();

1918 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1923 
	}
}

1926 
	$»¶iÿtiÚS‘Ma¡”
(*

, 
pÜt
) {

1927 
was_ma¡”
 = 
£rv”
.
ma¡”ho¡
 =ğ
NULL
;

1929 
	`sdsä“
(
£rv”
.
ma¡”ho¡
);

1930 
£rv”
.
ma¡”ho¡
 = 
	`sd¢ew
(

);

1931 
£rv”
.
ma¡”pÜt
 = 
pÜt
;

1932 ià(
£rv”
.
ma¡”
) {

1933 
	`ä“Cl›Á
(
£rv”
.
ma¡”
);

1935 
	`discÚÃùAÎBlockedCl›Ás
();

1939 
	`discÚÃùSÏves
();

1940 
	`ÿnûlR•liÿtiÚHªdshake
();

1943 ià(
was_ma¡”
è
	`»¶iÿtiÚCacheMa¡”UsšgMy£lf
();

1944 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1945 
£rv”
.
»¶_down_sšû
 = 0;

1946 
	}
}

1949 
	$»¶iÿtiÚUn£tMa¡”
() {

1950 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
) ;

1951 
	`sdsä“
(
£rv”
.
ma¡”ho¡
);

1952 
£rv”
.
ma¡”ho¡
 = 
NULL
;

1957 
	`shiáR•liÿtiÚId
();

1958 ià(
£rv”
.
ma¡”
è
	`ä“Cl›Á
(server.master);

1959 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1960 
	`ÿnûlR•liÿtiÚHªdshake
();

1965 
	`discÚÃùSÏves
();

1966 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_NONE
;

1972 
£rv”
.
¦ave£ldb
 = -1;

1978 
£rv”
.
»¶_no_¦aves_sšû
 = s”v”.
unixtime
;

1979 
	}
}

1983 
	$»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
() {

1984 
£rv”
.
ma¡”
 = 
NULL
;

1985 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECT
;

1986 
£rv”
.
»¶_down_sšû
 = s”v”.
unixtime
;

1990 
	}
}

1992 
	$¦aveofCommªd
(
ş›Á
 *
c
) {

1995 ià(
£rv”
.
şu¡”_’abËd
) {

1996 
	`addR•lyE¼Ü
(
c
,"SLAVEOF‚ot‡llowed in cluster mode.");

2002 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"no") &&

2003 !
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"one")) {

2004 ià(
£rv”
.
ma¡”ho¡
) {

2005 
	`»¶iÿtiÚUn£tMa¡”
();

2006 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

2007 
	`£rv”Log
(
LL_NOTICE
,"MASTER MODEƒnabled (user„equest from '%s')",

2008 
ş›Á
);

2009 
	`sdsä“
(
ş›Á
);

2012 
pÜt
;

2014 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
pÜt
, 
NULL
è!ğ
C_OK
))

2018 ià(
£rv”
.
ma¡”ho¡
 && !
	`¡rÿ£cmp
(£rv”.ma¡”ho¡,
c
->
¬gv
[1]->
±r
)

2019 && 
£rv”
.
ma¡”pÜt
 =ğ
pÜt
) {

2020 
	`£rv”Log
(
LL_NOTICE
,"SLAVE OF would„esult into synchronization withhe master we‡re‡lready connected with. No operation…erformed.");

2021 
	`addR•lySds
(
c
,
	`sd¢ew
("+OK Already connectedo specified master\r\n"));

2026 
	`»¶iÿtiÚS‘Ma¡”
(
c
->
¬gv
[1]->
±r
, 
pÜt
);

2027 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

2028 
	`£rv”Log
(
LL_NOTICE
,"SLAVE OF %s:%dƒnabled (user„equest from '%s')",

2029 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
, 
ş›Á
);

2030 
	`sdsä“
(
ş›Á
);

2032 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2033 
	}
}

2038 
	$rŞeCommªd
(
ş›Á
 *
c
) {

2039 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
) {

2040 
li¡I‹r
 
li
;

2041 
li¡Node
 *
Ê
;

2042 *
mbcouÁ
;

2043 
¦aves
 = 0;

2045 
	`addR•lyMuÉiBulkL’
(
c
,3);

2046 
	`addR•lyBulkCBufãr
(
c
,"master",6);

2047 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”_»¶_off£t
);

2048 
mbcouÁ
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2049 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2050 (
Ê
 = 
	`li¡Next
(&
li
))) {

2051 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2052 

[
NET_IP_STR_LEN
], *
¦ave
 = 
¦ave
->
¦ave_
;

2054 ià(
¦ave
[0] == '\0') {

2055 ià(
	`ª‘P“rToSŒšg
(
¦ave
->
fd
,

,(),
NULL
) == -1)

2057 
¦ave
 = 

;

2059 ià(
¦ave
->
»¶¡©e
 !ğ
SLAVE_STATE_ONLINE
) ;

2060 
	`addR•lyMuÉiBulkL’
(
c
,3);

2061 
	`addR•lyBulkCSŒšg
(
c
,
¦ave
);

2062 
	`addR•lyBulkLÚgLÚg
(
c
,
¦ave
->
¦ave_li¡’šg_pÜt
);

2063 
	`addR•lyBulkLÚgLÚg
(
c
,
¦ave
->
»¶_ack_off
);

2064 
¦aves
++;

2066 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
mbcouÁ
,
¦aves
);

2068 *
¦ave¡©e
 = 
NULL
;

2070 
	`addR•lyMuÉiBulkL’
(
c
,5);

2071 
	`addR•lyBulkCBufãr
(
c
,"slave",5);

2072 
	`addR•lyBulkCSŒšg
(
c
,
£rv”
.
ma¡”ho¡
);

2073 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”pÜt
);

2074 ià(
	`¦aveIsInHªdshakeS‹
()) {

2075 
¦ave¡©e
 = "handshake";

2077 
£rv”
.
»¶_¡©e
) {

2078 
REPL_STATE_NONE
: 
¦ave¡©e
 = "none"; ;

2079 
REPL_STATE_CONNECT
: 
¦ave¡©e
 = "connect"; ;

2080 
REPL_STATE_CONNECTING
: 
¦ave¡©e
 = "connecting"; ;

2081 
REPL_STATE_TRANSFER
: 
¦ave¡©e
 = "sync"; ;

2082 
REPL_STATE_CONNECTED
: 
¦ave¡©e
 = "connected"; ;

2083 : 
¦ave¡©e
 = "unknown"; ;

2086 
	`addR•lyBulkCSŒšg
(
c
,
¦ave¡©e
);

2087 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”
 ? s”v”.ma¡”->
»¶off
 : -1);

2089 
	}
}

2094 
	$»¶iÿtiÚS’dAck
() {

2095 
ş›Á
 *
c
 = 
£rv”
.
ma¡”
;

2097 ià(
c
 !ğ
NULL
) {

2098 
c
->
æags
 |ğ
CLIENT_MASTER_FORCE_REPLY
;

2099 
	`addR•lyMuÉiBulkL’
(
c
,3);

2100 
	`addR•lyBulkCSŒšg
(
c
,"REPLCONF");

2101 
	`addR•lyBulkCSŒšg
(
c
,"ACK");

2102 
	`addR•lyBulkLÚgLÚg
(
c
,c->
»¶off
);

2103 
c
->
æags
 &ğ~
CLIENT_MASTER_FORCE_REPLY
;

2105 
	}
}

2127 
	$»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
) {

2128 
	`£rv”As£¹
(
£rv”
.
ma¡”
 !ğ
NULL
 && s”v”.
ÿched_ma¡”
 == NULL);

2129 
	`£rv”Log
(
LL_NOTICE
,"Cachinghe disconnected master state.");

2132 
	`uÆškCl›Á
(
c
);

2138 
	`sdsş—r
(
£rv”
.
ma¡”
->
qu”ybuf
);

2139 
	`sdsş—r
(
£rv”
.
ma¡”
->
³ndšg_qu”ybuf
);

2140 
£rv”
.
ma¡”
->
»ad_»¶off
 = s”v”.ma¡”->
»¶off
;

2141 ià(
c
->
æags
 & 
CLIENT_MULTI
è
	`disÿrdT¿n§ùiÚ
(c);

2142 
	`li¡Em±y
(
c
->
»¶y
);

2143 
c
->
buåos
 = 0;

2144 
	`»£tCl›Á
(
c
);

2148 
£rv”
.
ÿched_ma¡”
 = s”v”.
ma¡”
;

2151 ià(
c
->
³”id
) {

2152 
	`sdsä“
(
c
->
³”id
);

2153 
c
->
³”id
 = 
NULL
;

2159 
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

2160 
	}
}

2171 
	$»¶iÿtiÚCacheMa¡”UsšgMy£lf
() {

2174 
£rv”
.
ma¡”_š™Ÿl_off£t
 = s”v”.
ma¡”_»¶_off£t
;

2175 
	`»¶iÿtiÚC»©eMa¡”Cl›Á
(-1,-1);

2178 
	`memıy
(
£rv”
.
ma¡”
->
»¶id
, server.replid, (server.replid));

2181 
	`uÆškCl›Á
(
£rv”
.
ma¡”
);

2182 
£rv”
.
ÿched_ma¡”
 = s”v”.
ma¡”
;

2183 
£rv”
.
ma¡”
 = 
NULL
;

2184 
	`£rv”Log
(
LL_NOTICE
,"Beforeurning into‡ slave, using my master…arameterso synthesize‡ cached master: I may be‡bleo synchronize withhe‚ew master with just‡…artialransfer.");

2185 
	}
}

2189 
	$»¶iÿtiÚDisÿrdCachedMa¡”
() {

2190 ià(
£rv”
.
ÿched_ma¡”
 =ğ
NULL
) ;

2192 
	`£rv”Log
(
LL_NOTICE
,"Discarding…reviously cached master state.");

2193 
£rv”
.
ÿched_ma¡”
->
æags
 &ğ~
CLIENT_MASTER
;

2194 
	`ä“Cl›Á
(
£rv”
.
ÿched_ma¡”
);

2195 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

2196 
	}
}

2204 
	$»¶iÿtiÚResu¼eùCachedMa¡”
(
Ãwfd
) {

2205 
£rv”
.
ma¡”
 = s”v”.
ÿched_ma¡”
;

2206 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

2207 
£rv”
.
ma¡”
->
fd
 = 
Ãwfd
;

2208 
£rv”
.
ma¡”
->
æags
 &ğ~(
CLIENT_CLOSE_AFTER_REPLY
|
CLIENT_CLOSE_ASAP
);

2209 
£rv”
.
ma¡”
->
auth’tiÿ‹d
 = 1;

2210 
£rv”
.
ma¡”
->
Ï¡š‹¿ùiÚ
 = s”v”.
unixtime
;

2211 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_CONNECTED
;

2214 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás
,£rv”.
ma¡”
);

2215 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
Ãwfd
, 
AE_READABLE
,

2216 
»adQu”yFromCl›Á
, 
£rv”
.
ma¡”
)) {

2217 
	`£rv”Log
(
LL_WARNING
,"E¼Ü„esu¼eùšghÿched ma¡”, impossibËØaddh»adabË hªdËr: %s", 
	`¡»¼Ü
(
”ºo
));

2218 
	`ä“Cl›ÁAsync
(
£rv”
.
ma¡”
);

2223 ià(
	`ş›ÁHasP’dšgR•l›s
(
£rv”
.
ma¡”
)) {

2224 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
Ãwfd
, 
AE_WRITABLE
,

2225 
£ndR•lyToCl›Á
, 
£rv”
.
ma¡”
)) {

2226 
	`£rv”Log
(
LL_WARNING
,"E¼Ü„esu¼eùšghÿched ma¡”, impossibËØaddhwr™abË hªdËr: %s", 
	`¡»¼Ü
(
”ºo
));

2227 
	`ä“Cl›ÁAsync
(
£rv”
.
ma¡”
);

2230 
	}
}

2237 
	$»äeshGoodSÏvesCouÁ
() {

2238 
li¡I‹r
 
li
;

2239 
li¡Node
 *
Ê
;

2240 
good
 = 0;

2242 ià(!
£rv”
.
»¶_mš_¦aves_to_wr™e
 ||

2243 !
£rv”
.
»¶_mš_¦aves_max_Ïg
) ;

2245 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2246 (
Ê
 = 
	`li¡Next
(&
li
))) {

2247 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2248 
time_t
 
Ïg
 = 
£rv”
.
unixtime
 - 
¦ave
->
»¶_ack_time
;

2250 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
 &&

2251 
Ïg
 <ğ
£rv”
.
»¶_mš_¦aves_max_Ïg
è
good
++;

2253 
£rv”
.
»¶_good_¦aves_couÁ
 = 
good
;

2254 
	}
}

2288 
	$»¶iÿtiÚSütCacheIn™
() {

2289 
£rv”
.
»¶_sütÿche_size
 = 10000;

2290 
£rv”
.
»¶_sütÿche_diù
 = 
	`diùC»©e
(&
»¶SütCacheDiùTy³
,
NULL
);

2291 
£rv”
.
»¶_sütÿche_fifo
 = 
	`li¡C»©e
();

2292 
	}
}

2305 
	$»¶iÿtiÚSütCacheFlush
() {

2306 
	`diùEm±y
(
£rv”
.
»¶_sütÿche_diù
,
NULL
);

2307 
	`li¡R–—£
(
£rv”
.
»¶_sütÿche_fifo
);

2308 
£rv”
.
»¶_sütÿche_fifo
 = 
	`li¡C»©e
();

2309 
	}
}

2313 
	$»¶iÿtiÚSütCacheAdd
(
sds
 
sha1
) {

2314 
»tv®
;

2315 
sds
 
key
 = 
	`sdsdup
(
sha1
);

2318 ià(
	`li¡L’gth
(
£rv”
.
»¶_sütÿche_fifo
è=ğ£rv”.
»¶_sütÿche_size
)

2320 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
£rv”
.
»¶_sütÿche_fifo
);

2321 
sds
 
Şde¡
 = 
	`li¡NodeV®ue
(
Ê
);

2323 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
»¶_sütÿche_diù
,
Şde¡
);

2324 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

2325 
	`li¡D–Node
(
£rv”
.
»¶_sütÿche_fifo
,
Ê
);

2329 
»tv®
 = 
	`diùAdd
(
£rv”
.
»¶_sütÿche_diù
,
key
,
NULL
);

2330 
	`li¡AddNodeH—d
(
£rv”
.
»¶_sütÿche_fifo
,
key
);

2331 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

2332 
	}
}

2336 
	$»¶iÿtiÚSütCacheExi¡s
(
sds
 
sha1
) {

2337  
	`diùFšd
(
£rv”
.
»¶_sütÿche_diù
,
sha1
è!ğ
NULL
;

2338 
	}
}

2370 
	$»¶iÿtiÚReque¡AckFromSÏves
() {

2371 
£rv”
.
g‘_ack_äom_¦aves
 = 1;

2372 
	}
}

2376 
	$»¶iÿtiÚCouÁAcksByOff£t
(
off£t
) {

2377 
li¡I‹r
 
li
;

2378 
li¡Node
 *
Ê
;

2379 
couÁ
 = 0;

2381 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2382 (
Ê
 = 
	`li¡Next
(&
li
))) {

2383 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2385 ià(
¦ave
->
»¶¡©e
 !ğ
SLAVE_STATE_ONLINE
) ;

2386 ià(
¦ave
->
»¶_ack_off
 >ğ
off£t
è
couÁ
++;

2388  
couÁ
;

2389 
	}
}

2393 
	$wa™Commªd
(
ş›Á
 *
c
) {

2394 
m¡ime_t
 
timeout
;

2395 
num»¶iÿs
, 
ack»¶iÿs
;

2396 
off£t
 = 
c
->
woff
;

2398 ià(
£rv”
.
ma¡”ho¡
) {

2399 
	`addR•lyE¼Ü
(
c
,"WAIT cannot be used with slave instances. Please‡lso‚otehat since Redis 4.0 if‡ slave is configuredo be writable (which is‚othe default) writeso slaves‡re just†ocal‡nd‡re‚ot…ropagated.");

2404 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[1],&
num»¶iÿs
,
NULL
è!ğ
C_OK
)

2406 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
timeout
,
UNIT_MILLISECONDS
)

2407 !ğ
C_OK
) ;

2410 
ack»¶iÿs
 = 
	`»¶iÿtiÚCouÁAcksByOff£t
(
c
->
woff
);

2411 ià(
ack»¶iÿs
 >ğ
num»¶iÿs
 || 
c
->
æags
 & 
CLIENT_MULTI
) {

2412 
	`addR•lyLÚgLÚg
(
c
,
ack»¶iÿs
);

2418 
c
->
bpİ
.
timeout
 =imeout;

2419 
c
->
bpİ
.
»¶off£t
 = 
off£t
;

2420 
c
->
bpİ
.
num»¶iÿs
 =‚umreplicas;

2421 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás_wa™šg_acks
,
c
);

2422 
	`blockCl›Á
(
c
,
BLOCKED_WAIT
);

2426 
	`»¶iÿtiÚReque¡AckFromSÏves
();

2427 
	}
}

2433 
	$unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
) {

2434 
li¡Node
 *
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás_wa™šg_acks
,
c
);

2435 
	`£rv”As£¹
(
Ê
 !ğ
NULL
);

2436 
	`li¡D–Node
(
£rv”
.
ş›Ás_wa™šg_acks
,
Ê
);

2437 
	}
}

2441 
	$´oûssCl›ÁsWa™šgR•liÿs
() {

2442 
Ï¡_off£t
 = 0;

2443 
Ï¡_num»¶iÿs
 = 0;

2445 
li¡I‹r
 
li
;

2446 
li¡Node
 *
Ê
;

2448 
	`li¡Rewšd
(
£rv”
.
ş›Ás_wa™šg_acks
,&
li
);

2449 (
Ê
 = 
	`li¡Next
(&
li
))) {

2450 
ş›Á
 *
c
 = 
Ê
->
v®ue
;

2456 ià(
Ï¡_off£t
 &&†a¡_off£ˆ> 
c
->
bpİ
.
»¶off£t
 &&

2457 
Ï¡_num»¶iÿs
 > 
c
->
bpİ
.
num»¶iÿs
)

2459 
	`unblockCl›Á
(
c
);

2460 
	`addR•lyLÚgLÚg
(
c
,
Ï¡_num»¶iÿs
);

2462 
num»¶iÿs
 = 
	`»¶iÿtiÚCouÁAcksByOff£t
(
c
->
bpİ
.
»¶off£t
);

2464 ià(
num»¶iÿs
 >ğ
c
->
bpİ
.numreplicas) {

2465 
Ï¡_off£t
 = 
c
->
bpİ
.
»¶off£t
;

2466 
Ï¡_num»¶iÿs
 = 
num»¶iÿs
;

2467 
	`unblockCl›Á
(
c
);

2468 
	`addR•lyLÚgLÚg
(
c
,
num»¶iÿs
);

2472 
	}
}

2476 
	$»¶iÿtiÚG‘SÏveOff£t
() {

2477 
off£t
 = 0;

2479 ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
) {

2480 ià(
£rv”
.
ma¡”
) {

2481 
off£t
 = 
£rv”
.
ma¡”
->
»¶off
;

2482 } ià(
£rv”
.
ÿched_ma¡”
) {

2483 
off£t
 = 
£rv”
.
ÿched_ma¡”
->
»¶off
;

2490 ià(
off£t
 < 0) offset = 0;

2491  
off£t
;

2492 
	}
}

2497 
	$»¶iÿtiÚCrÚ
() {

2498 
»¶iÿtiÚ_üÚ_loİs
 = 0;

2501 ià(
£rv”
.
ma¡”ho¡
 &&

2502 (
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTING
 ||

2503 
	`¦aveIsInHªdshakeS‹
()) &&

2504 (
	`time
(
NULL
)-
£rv”
.
»¶_Œªsãr_Ï¡io
è> s”v”.
»¶_timeout
)

2506 
	`£rv”Log
(
LL_WARNING
,"Timeout connectingohe MASTER...");

2507 
	`ÿnûlR•liÿtiÚHªdshake
();

2511 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
 &&

2512 (
	`time
(
NULL
)-
£rv”
.
»¶_Œªsãr_Ï¡io
è> s”v”.
»¶_timeout
)

2514 
	`£rv”Log
(
LL_WARNING
,"Timeout„eceiving bulk data from MASTER... Ifhe…roblem…ersistsryo sethe 'repl-timeout'…arameter in„edis.confo‡†arger value.");

2515 
	`ÿnûlR•liÿtiÚHªdshake
();

2519 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTED
 &&

2520 (
	`time
(
NULL
)-
£rv”
.
ma¡”
->
Ï¡š‹¿ùiÚ
è> s”v”.
»¶_timeout
)

2522 
	`£rv”Log
(
LL_WARNING
,"MASTERimeout:‚o data‚or PING„eceived...");

2523 
	`ä“Cl›Á
(
£rv”
.
ma¡”
);

2527 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECT
) {

2528 
	`£rv”Log
(
LL_NOTICE
,"Connectingo MASTER %s:%d",

2529 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

2530 ià(
	`cÚÃùW™hMa¡”
(è=ğ
C_OK
) {

2531 
	`£rv”Log
(
LL_NOTICE
,"MASTER <-> SLAVE sync started");

2538 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
ma¡”
 &&

2539 !(
£rv”
.
ma¡”
->
æags
 & 
CLIENT_PRE_PSYNC
))

2540 
	`»¶iÿtiÚS’dAck
();

2546 
li¡I‹r
 
li
;

2547 
li¡Node
 *
Ê
;

2548 
robj
 *
pšg_¬gv
[1];

2551 ià((
»¶iÿtiÚ_üÚ_loİs
 % 
£rv”
.
»¶_pšg_¦ave_³riod
) == 0 &&

2552 
	`li¡L’gth
(
£rv”
.
¦aves
))

2554 
pšg_¬gv
[0] = 
	`ü—‹SŒšgObjeù
("PING",4);

2555 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
, s”v”.
¦ave£ldb
,

2556 
pšg_¬gv
, 1);

2557 
	`deüRefCouÁ
(
pšg_¬gv
[0]);

2574 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2575 (
Ê
 = 
	`li¡Next
(&
li
))) {

2576 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2578 
is_´esync
 =

2579 (
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
 ||

2580 (
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_END
 &&

2581 
£rv”
.
rdb_chd_ty³
 !ğ
RDB_CHILD_TYPE_SOCKET
));

2583 ià(
is_´esync
) {

2584 ià(
	`wr™e
(
¦ave
->
fd
, "\n", 1) == -1) {

2591 ià(
	`li¡L’gth
(
£rv”
.
¦aves
)) {

2592 
li¡I‹r
 
li
;

2593 
li¡Node
 *
Ê
;

2595 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2596 (
Ê
 = 
	`li¡Next
(&
li
))) {

2597 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2599 ià(
¦ave
->
»¶¡©e
 !ğ
SLAVE_STATE_ONLINE
) ;

2600 ià(
¦ave
->
æags
 & 
CLIENT_PRE_PSYNC
) ;

2601 ià((
£rv”
.
unixtime
 - 
¦ave
->
»¶_ack_time
è> s”v”.
»¶_timeout
)

2603 
	`£rv”Log
(
LL_WARNING
, "Disconnectingimedout slave: %s",

2604 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

2605 
	`ä“Cl›Á
(
¦ave
);

2616 ià(
	`li¡L’gth
(
£rv”
.
¦aves
è=ğ0 && s”v”.
»¶_backlog_time_lim™
 &&

2617 
£rv”
.
»¶_backlog
 && s”v”.
ma¡”ho¡
 =ğ
NULL
)

2619 
time_t
 
idË
 = 
£rv”
.
unixtime
 - s”v”.
»¶_no_¦aves_sšû
;

2621 ià(
idË
 > 
£rv”
.
»¶_backlog_time_lim™
) {

2637 
	`chªgeR•liÿtiÚId
();

2638 
	`ş—rR•liÿtiÚId2
();

2639 
	`ä“R•liÿtiÚBacklog
();

2640 
	`£rv”Log
(
LL_NOTICE
,

2643 (è
£rv”
.
»¶_backlog_time_lim™
);

2650 ià(
	`li¡L’gth
(
£rv”
.
¦aves
) == 0 &&

2651 
£rv”
.
aof_¡©e
 =ğ
AOF_OFF
 &&

2652 
	`li¡L’gth
(
£rv”
.
»¶_sütÿche_fifo
) != 0)

2654 
	`»¶iÿtiÚSütCacheFlush
();

2663 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1) {

2664 
time_t
 
idË
, 
max_idË
 = 0;

2665 
¦aves_wa™šg
 = 0;

2666 
mšÿ·
 = -1;

2667 
li¡Node
 *
Ê
;

2668 
li¡I‹r
 
li
;

2670 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2671 (
Ê
 = 
	`li¡Next
(&
li
))) {

2672 
ş›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2673 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_WAIT_BGSAVE_START
) {

2674 
idË
 = 
£rv”
.
unixtime
 - 
¦ave
->
Ï¡š‹¿ùiÚ
;

2675 ià(
idË
 > 
max_idË
) max_idle = idle;

2676 
¦aves_wa™šg
++;

2677 
mšÿ·
 = (mšÿ· =ğ-1è? 
¦ave
->
¦ave_ÿ·
 :

2678 (
mšÿ·
 & 
¦ave
->
¦ave_ÿ·
);

2682 ià(
¦aves_wa™šg
 &&

2683 (!
£rv”
.
»¶_diskËss_sync
 ||

2684 
max_idË
 > 
£rv”
.
»¶_diskËss_sync_d–ay
))

2689 
	`¡¬tBg§veFÜR•liÿtiÚ
(
mšÿ·
);

2694 
	`»äeshGoodSÏvesCouÁ
();

2695 
»¶iÿtiÚ_üÚ_loİs
++;

2696 
	}
}

	@src/rio.c

48 
	~"fmaüos.h
"

49 
	~<¡ršg.h
>

50 
	~<¡dio.h
>

51 
	~<uni¡d.h
>

52 
	~"rio.h
"

53 
	~"ut.h
"

54 
	~"üc64.h
"

55 
	~"cÚfig.h
"

56 
	~"£rv”.h
"

61 
size_t
 
	$rioBufãrWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

62 
r
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Ô->io.bufãr.±r,(*)
buf
,
Ën
);

63 
r
->
io
.
bufãr
.
pos
 +ğ
Ën
;

65 
	}
}

68 
size_t
 
	$rioBufãrR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

69 ià(
	`sd¦’
(
r
->
io
.
bufãr
.
±r
)-r->io.bufãr.
pos
 < 
Ën
)

71 
	`memıy
(
buf
,
r
->
io
.
bufãr
.
±r
+r->io.bufãr.
pos
,
Ën
);

72 
r
->
io
.
bufãr
.
pos
 +ğ
Ën
;

74 
	}
}

77 
off_t
 
	$rioBufãrT–l
(
rio
 *
r
) {

78  
r
->
io
.
bufãr
.
pos
;

79 
	}
}

83 
	$rioBufãrFlush
(
rio
 *
r
) {

84 
	`UNUSED
(
r
);

86 
	}
}

88 cÚ¡ 
rio
 
	grioBufãrIO
 = {

89 
rioBufãrR—d
,

90 
rioBufãrWr™e
,

91 
rioBufãrT–l
,

92 
rioBufãrFlush
,

93 
NULL
,

97 { { 
NULL
, 0 } }

100 
	$rioIn™W™hBufãr
(
rio
 *
r
, 
sds
 
s
) {

101 *
r
 = 
rioBufãrIO
;

102 
r
->
io
.
bufãr
.
±r
 = 
s
;

103 
r
->
io
.
bufãr
.
pos
 = 0;

104 
	}
}

109 
size_t
 
	$rioFeWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

110 
size_t
 
»tv®
;

112 
»tv®
 = 
	`fwr™e
(
buf
,
Ën
,1,
r
->
io
.
fe
.
å
);

113 
r
->
io
.
fe
.
bufã»d
 +ğ
Ën
;

115 ià(
r
->
io
.
fe
.
autosync
 &&

116 
r
->
io
.
fe
.
bufã»d
 >ğr->io.fe.
autosync
)

118 
	`fæush
(
r
->
io
.
fe
.
å
);

119 
	`aof_fsync
(
	`f’o
(
r
->
io
.
fe
.
å
));

120 
r
->
io
.
fe
.
bufã»d
 = 0;

122  
»tv®
;

123 
	}
}

126 
size_t
 
	$rioFeR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

128  
	`ä—d
(
buf
,
Ën
,1,
r
->
io
.
fe
.
å
);

129 
	}
}

132 
off_t
 
	$rioFeT–l
(
rio
 *
r
) {

133  
	`á–lo
(
r
->
io
.
fe
.
å
);

134 
	}
}

138 
	$rioFeFlush
(
rio
 *
r
) {

139  (
	`fæush
(
r
->
io
.
fe
.
å
) == 0) ? 1 : 0;

140 
	}
}

142 cÚ¡ 
rio
 
	grioFeIO
 = {

143 
rioFeR—d
,

144 
rioFeWr™e
,

145 
rioFeT–l
,

146 
rioFeFlush
,

147 
NULL
,

151 { { 
NULL
, 0 } }

154 
	$rioIn™W™hFe
(
rio
 *
r
, 
FILE
 *
å
) {

155 *
r
 = 
rioFeIO
;

156 
r
->
io
.
fe
.
å
 = fp;

157 
r
->
io
.
fe
.
bufã»d
 = 0;

158 
r
->
io
.
fe
.
autosync
 = 0;

159 
	}
}

170 
size_t
 
	$rioFd£tWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

171 
ssize_t
 
»tv®
;

172 
j
;

173 *
p
 = (*è
buf
;

174 
doæush
 = (
buf
 =ğ
NULL
 && 
Ën
 == 0);

178 ià(
Ën
) {

179 
r
->
io
.
fd£t
.
buf
 = 
	`sdsÿ’
Ô->io.fd£t.buf,buf,
Ën
);

180 
Ën
 = 0;

181 ià(
	`sd¦’
(
r
->
io
.
fd£t
.
buf
è> 
PROTO_IOBUF_LEN
è
doæush
 = 1;

184 ià(
doæush
) {

185 
p
 = (*è
r
->
io
.
fd£t
.
buf
;

186 
Ën
 = 
	`sd¦’
(
r
->
io
.
fd£t
.
buf
);

192 
Ën
) {

193 
size_t
 
couÁ
 = 
Ën
 < 1024 ?†en : 1024;

194 
brok’
 = 0;

195 
j
 = 0; j < 
r
->
io
.
fd£t
.
numfds
; j++) {

196 ià(
r
->
io
.
fd£t
.
¡©e
[
j
] != 0) {

198 
brok’
++;

204 
size_t
 
nwr™‹n
 = 0;

205 
nwr™‹n
 !ğ
couÁ
) {

206 
»tv®
 = 
	`wr™e
(
r
->
io
.
fd£t
.
fds
[
j
],
p
+
nwr™‹n
,
couÁ
-nwritten);

207 ià(
»tv®
 <= 0) {

212 ià(
»tv®
 =ğ-1 && 
”ºo
 =ğ
EWOULDBLOCK
è”ºØğ
ETIMEDOUT
;

215 
nwr™‹n
 +ğ
»tv®
;

218 ià(
nwr™‹n
 !ğ
couÁ
) {

220 
r
->
io
.
fd£t
.
¡©e
[
j
] = 
”ºo
;

221 ià(
r
->
io
.
fd£t
.
¡©e
[
j
] =ğ0èr->io.fd£t.¡©e[j] = 
EIO
;

224 ià(
brok’
 =ğ
r
->
io
.
fd£t
.
numfds
)  0;

225 
p
 +ğ
couÁ
;

226 
Ën
 -ğ
couÁ
;

227 
r
->
io
.
fd£t
.
pos
 +ğ
couÁ
;

230 ià(
doæush
è
	`sdsş—r
(
r
->
io
.
fd£t
.
buf
);

232 
	}
}

235 
size_t
 
	$rioFd£tR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

236 
	`UNUSED
(
r
);

237 
	`UNUSED
(
buf
);

238 
	`UNUSED
(
Ën
);

240 
	}
}

243 
off_t
 
	$rioFd£tT–l
(
rio
 *
r
) {

244  
r
->
io
.
fd£t
.
pos
;

245 
	}
}

249 
	$rioFd£tFlush
(
rio
 *
r
) {

252  
	`rioFd£tWr™e
(
r
,
NULL
,0);

253 
	}
}

255 cÚ¡ 
rio
 
	grioFd£tIO
 = {

256 
rioFd£tR—d
,

257 
rioFd£tWr™e
,

258 
rioFd£tT–l
,

259 
rioFd£tFlush
,

260 
NULL
,

264 { { 
NULL
, 0 } }

267 
	$rioIn™W™hFd£t
(
rio
 *
r
, *
fds
, 
numfds
) {

268 
j
;

270 *
r
 = 
rioFd£tIO
;

271 
r
->
io
.
fd£t
.
fds
 = 
	`zm®loc
(()*
numfds
);

272 
r
->
io
.
fd£t
.
¡©e
 = 
	`zm®loc
(()*
numfds
);

273 
	`memıy
(
r
->
io
.
fd£t
.
fds
,fds,()*
numfds
);

274 
j
 = 0; j < 
numfds
; j++è
r
->
io
.
fd£t
.
¡©e
[j] = 0;

275 
r
->
io
.
fd£t
.
numfds
 =‚umfds;

276 
r
->
io
.
fd£t
.
pos
 = 0;

277 
r
->
io
.
fd£t
.
buf
 = 
	`sd£m±y
();

278 
	}
}

281 
	$rioF»eFd£t
(
rio
 *
r
) {

282 
	`zä“
(
r
->
io
.
fd£t
.
fds
);

283 
	`zä“
(
r
->
io
.
fd£t
.
¡©e
);

284 
	`sdsä“
(
r
->
io
.
fd£t
.
buf
);

285 
	}
}

291 
	$rioG’”icUpd©eChecksum
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

292 
r
->
cksum
 = 
	`üc64
Ô->cksum,
buf
,
Ën
);

293 
	}
}

303 
	$rioS‘AutoSync
(
rio
 *
r
, 
off_t
 
by‹s
) {

304 
	`£rv”As£¹
(
r
->
»ad
 =ğ
rioFeIO
.read);

305 
r
->
io
.
fe
.
autosync
 = 
by‹s
;

306 
	}
}

314 
size_t
 
	$rioWr™eBulkCouÁ
(
rio
 *
r
, 
´efix
, 
couÁ
) {

315 
cbuf
[128];

316 
ş’
;

318 
cbuf
[0] = 
´efix
;

319 
ş’
 = 1+
	`Î2¡ršg
(
cbuf
+1,(cbuf)-1,
couÁ
);

320 
cbuf
[
ş’
++] = '\r';

321 
cbuf
[
ş’
++] = '\n';

322 ià(
	`rioWr™e
(
r
,
cbuf
,
ş’
) == 0)  0;

323  
ş’
;

324 
	}
}

327 
size_t
 
	$rioWr™eBulkSŒšg
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

328 
size_t
 
nwr™‹n
;

330 ià((
nwr™‹n
 = 
	`rioWr™eBulkCouÁ
(
r
,'$',
Ën
)) == 0)  0;

331 ià(
Ën
 > 0 && 
	`rioWr™e
(
r
,
buf
,len) == 0)  0;

332 ià(
	`rioWr™e
(
r
,"\r\n",2) == 0)  0;

333  
nwr™‹n
+
Ën
+2;

334 
	}
}

337 
size_t
 
	$rioWr™eBulkLÚgLÚg
(
rio
 *
r
, 
l
) {

338 
lbuf
[32];

339 
Î’
;

341 
Î’
 = 
	`Î2¡ršg
(
lbuf
,Öbuf),
l
);

342  
	`rioWr™eBulkSŒšg
(
r
,
lbuf
,
Î’
);

343 
	}
}

346 
size_t
 
	$rioWr™eBulkDoubË
(
rio
 *
r
, 
d
) {

347 
dbuf
[128];

348 
dËn
;

350 
dËn
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",
d
);

351  
	`rioWr™eBulkSŒšg
(
r
,
dbuf
,
dËn
);

352 
	}
}

	@src/rio.h

32 #iâdeà
__REDIS_RIO_H


33 
	#__REDIS_RIO_H


	)

35 
	~<¡dio.h
>

36 
	~<¡dšt.h
>

37 
	~"sds.h
"

39 
	s_rio
 {

43 
size_t
 (*
»ad
)(
	m_rio
 *, *
	mbuf
, size_ˆ
	mËn
);

44 
size_t
 (*
wr™e
)(
	m_rio
 *, cÚ¡ *
	mbuf
, size_ˆ
	mËn
);

45 
off_t
 (*
‹Î
)(
	m_rio
 *);

46 (*
	mæush
)(
	m_rio
 *);

52 (*
	mupd©e_cksum
)(
	m_rio
 *, cÚ¡ *
	mbuf
, 
size_t
 
	mËn
);

55 
ušt64_t
 
	mcksum
;

58 
size_t
 
	m´oûs£d_by‹s
;

61 
size_t
 
	mmax_´oûssšg_chunk
;

67 
sds
 
	m±r
;

68 
off_t
 
	mpos
;

69 } 
	mbufãr
;

72 
FILE
 *
	må
;

73 
off_t
 
	mbufã»d
;

74 
off_t
 
	mautosync
;

75 } 
	mfe
;

78 *
	mfds
;

79 *
	m¡©e
;

80 
	mnumfds
;

81 
off_t
 
	mpos
;

82 
sds
 
	mbuf
;

83 } 
	mfd£t
;

84 } 
	mio
;

87 
_rio
 
	trio
;

93 
šlše
 
size_t
 
	$rioWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

94 
Ën
) {

95 
size_t
 
by‹s_to_wr™e
 = (
r
->
max_´oûssšg_chunk
 &&„->max_´oûssšg_chunk < 
Ën
) ?„->max_processing_chunk :†en;

96 ià(
r
->
upd©e_cksum
èr->
	`upd©e_cksum
Ô,
buf
,
by‹s_to_wr™e
);

97 ià(
r
->
	`wr™e
Ô,
buf
,
by‹s_to_wr™e
) == 0)

99 
buf
 = (*)buà+ 
by‹s_to_wr™e
;

100 
Ën
 -ğ
by‹s_to_wr™e
;

101 
r
->
´oûs£d_by‹s
 +ğ
by‹s_to_wr™e
;

104 
	}
}

106 
šlše
 
size_t
 
	$rioR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

107 
Ën
) {

108 
size_t
 
by‹s_to_»ad
 = (
r
->
max_´oûssšg_chunk
 &&„->max_´oûssšg_chunk < 
Ën
) ?„->max_processing_chunk :†en;

109 ià(
r
->
	`»ad
Ô,
buf
,
by‹s_to_»ad
) == 0)

111 ià(
r
->
upd©e_cksum
èr->
	`upd©e_cksum
Ô,
buf
,
by‹s_to_»ad
);

112 
buf
 = (*)buà+ 
by‹s_to_»ad
;

113 
Ën
 -ğ
by‹s_to_»ad
;

114 
r
->
´oûs£d_by‹s
 +ğ
by‹s_to_»ad
;

117 
	}
}

119 
šlše
 
off_t
 
	$rioT–l
(
rio
 *
r
) {

120  
r
->
	`‹Î
(r);

121 
	}
}

123 
šlše
 
	$rioFlush
(
rio
 *
r
) {

124  
r
->
	`æush
(r);

125 
	}
}

127 
rioIn™W™hFe
(
rio
 *
r
, 
FILE
 *
å
);

128 
rioIn™W™hBufãr
(
rio
 *
r
, 
sds
 
s
);

129 
rioIn™W™hFd£t
(
rio
 *
r
, *
fds
, 
numfds
);

131 
rioF»eFd£t
(
rio
 *
r
);

133 
size_t
 
rioWr™eBulkCouÁ
(
rio
 *
r
, 
´efix
, 
couÁ
);

134 
size_t
 
rioWr™eBulkSŒšg
(
rio
 *
r
, cÚ¡ *
buf
, size_ˆ
Ën
);

135 
size_t
 
rioWr™eBulkLÚgLÚg
(
rio
 *
r
, 
l
);

136 
size_t
 
rioWr™eBulkDoubË
(
rio
 *
r
, 
d
);

138 
	g»disObjeù
;

139 
rioWr™eBulkObjeù
(
rio
 *
r
, 
»disObjeù
 *
obj
);

141 
rioG’”icUpd©eChecksum
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

142 
rioS‘AutoSync
(
rio
 *
r
, 
off_t
 
by‹s
);

	@src/scripting.c

30 
	~"£rv”.h
"

31 
	~"sha1.h
"

32 
	~"¿nd.h
"

33 
	~"şu¡”.h
"

35 
	~<lua.h
>

36 
	~<Ïuxlib.h
>

37 
	~<lu®ib.h
>

38 
	~<ùy³.h
>

39 
	~<m©h.h
>

41 *
»disPrÙocŞToLuaTy³_IÁ
(
lua_S‹
 *
lua
, *
»¶y
);

42 *
»disPrÙocŞToLuaTy³_Bulk
(
lua_S‹
 *
lua
, *
»¶y
);

43 *
»disPrÙocŞToLuaTy³_Stus
(
lua_S‹
 *
lua
, *
»¶y
);

44 *
»disPrÙocŞToLuaTy³_E¼Ü
(
lua_S‹
 *
lua
, *
»¶y
);

45 *
»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua_S‹
 *
lua
, *
»¶y
);

46 
»dis_m©h_¿ndom
 (
lua_S‹
 *
L
);

47 
»dis_m©h_¿ndom£ed
 (
lua_S‹
 *
L
);

48 
ldbIn™
();

49 
ldbDi§bË
(
ş›Á
 *
c
);

50 
ldbEÇbË
(
ş›Á
 *
c
);

51 
ev®G’”icCommªdW™hDebuggšg
(
ş›Á
 *
c
, 
ev®sha
);

52 
luaLdbLšeHook
(
lua_S‹
 *
lua
, 
lua_Debug
 *
¬
);

53 
ldbLog
(
sds
 
’Œy
);

54 
ldbLogRedisR•ly
(*
»¶y
);

55 
sds
 
ldbC©SckV®ue
(sd 
s
, 
lua_S‹
 *
lua
, 
idx
);

58 
	#LDB_BREAKPOINTS_MAX
 64

	)

59 
	#LDB_MAX_LEN_DEFAULT
 256

	)

60 
	sldbS‹
 {

61 
	mfd
;

62 
	maùive
;

63 
	mfÜked
;

64 
li¡
 *
	mlogs
;

65 
li¡
 *
	mŒaûs
;

66 
li¡
 *
	mchd»n
;

67 
	mbp
[
LDB_BREAKPOINTS_MAX
];

68 
	mbpcouÁ
;

69 
	m¡•
;

70 
	mluabp
;

71 
sds
 *
	m¤c
;

72 
	mlšes
;

73 
	mcu¼’še
;

74 
sds
 
	mcbuf
;

75 
size_t
 
	mmaxËn
;

76 
	mmaxËn_hšt_£Á
;

77 } 
	gldb
;

89 
	$sha1hex
(*
dige¡
, *
süt
, 
size_t
 
Ën
) {

90 
SHA1_CTX
 
ùx
;

91 
hash
[20];

92 *
c£t
 = "0123456789abcdef";

93 
j
;

95 
	`SHA1In™
(&
ùx
);

96 
	`SHA1Upd©e
(&
ùx
,(*)
süt
,
Ën
);

97 
	`SHA1Fš®
(
hash
,&
ùx
);

99 
j
 = 0; j < 20; j++) {

100 
dige¡
[
j
*2] = 
c£t
[((
hash
[j]&0xF0)>>4)];

101 
dige¡
[
j
*2+1] = 
c£t
[(
hash
[j]&0xF)];

103 
dige¡
[40] = '\0';

104 
	}
}

127 *
	$»disPrÙocŞToLuaTy³
(
lua_S‹
 *
lua
, * 
»¶y
) {

128 *
p
 = 
»¶y
;

130 *
p
) {

131 ':': 
p
 = 
	`»disPrÙocŞToLuaTy³_IÁ
(
lua
,
»¶y
); ;

132 '$': 
p
 = 
	`»disPrÙocŞToLuaTy³_Bulk
(
lua
,
»¶y
); ;

133 '+': 
p
 = 
	`»disPrÙocŞToLuaTy³_Stus
(
lua
,
»¶y
); ;

134 '-': 
p
 = 
	`»disPrÙocŞToLuaTy³_E¼Ü
(
lua
,
»¶y
); ;

135 '*': 
p
 = 
	`»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua
,
»¶y
); ;

137  
p
;

138 
	}
}

140 *
	$»disPrÙocŞToLuaTy³_IÁ
(
lua_S‹
 *
lua
, *
»¶y
) {

141 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

142 
v®ue
;

144 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
v®ue
);

145 
	`lua_pushnumb”
(
lua
,(
lua_Numb”
)
v®ue
);

146  
p
+2;

147 
	}
}

149 *
	$»disPrÙocŞToLuaTy³_Bulk
(
lua_S‹
 *
lua
, *
»¶y
) {

150 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

151 
bulkËn
;

153 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
bulkËn
);

154 ià(
bulkËn
 == -1) {

155 
	`lua_pushboŞ—n
(
lua
,0);

156  
p
+2;

158 
	`lua_pushl¡ršg
(
lua
,
p
+2,
bulkËn
);

159  
p
+2+
bulkËn
+2;

161 
	}
}

163 *
	$»disPrÙocŞToLuaTy³_Stus
(
lua_S‹
 *
lua
, *
»¶y
) {

164 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

166 
	`lua_ÃwbË
(
lua
);

167 
	`lua_push¡ršg
(
lua
,"ok");

168 
	`lua_pushl¡ršg
(
lua
,
»¶y
+1,
p
-reply-1);

169 
	`lua_£‰abË
(
lua
,-3);

170  
p
+2;

171 
	}
}

173 *
	$»disPrÙocŞToLuaTy³_E¼Ü
(
lua_S‹
 *
lua
, *
»¶y
) {

174 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

176 
	`lua_ÃwbË
(
lua
);

177 
	`lua_push¡ršg
(
lua
,"err");

178 
	`lua_pushl¡ršg
(
lua
,
»¶y
+1,
p
-reply-1);

179 
	`lua_£‰abË
(
lua
,-3);

180  
p
+2;

181 
	}
}

183 *
	$»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua_S‹
 *
lua
, *
»¶y
) {

184 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

185 
mbulkËn
;

186 
j
 = 0;

188 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
mbulkËn
);

189 
p
 += 2;

190 ià(
mbulkËn
 == -1) {

191 
	`lua_pushboŞ—n
(
lua
,0);

192  
p
;

194 
	`lua_ÃwbË
(
lua
);

195 
j
 = 0; j < 
mbulkËn
; j++) {

196 
	`lua_pushnumb”
(
lua
,
j
+1);

197 
p
 = 
	`»disPrÙocŞToLuaTy³
(
lua
,p);

198 
	`lua_£‰abË
(
lua
,-3);

200  
p
;

201 
	}
}

208 
	$luaPushE¼Ü
(
lua_S‹
 *
lua
, *
”rÜ
) {

209 
lua_Debug
 
dbg
;

213 ià(
ldb
.
aùive
 &&†db.
¡•
) {

214 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"<”rÜ> %s",
”rÜ
));

217 
	`lua_ÃwbË
(
lua
);

218 
	`lua_push¡ršg
(
lua
,"err");

221 if(
	`lua_g‘¡ack
(
lua
, 1, &
dbg
è&& 
	`lua_g‘šfo
(lua, "nSl", &dbg)) {

222 
sds
 
msg
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s: %d: %s",

223 
dbg
.
sourû
, dbg.
cu¼’še
, 
”rÜ
);

224 
	`lua_push¡ršg
(
lua
, 
msg
);

225 
	`sdsä“
(
msg
);

227 
	`lua_push¡ršg
(
lua
, 
”rÜ
);

229 
	`lua_£‰abË
(
lua
,-3);

230 
	}
}

236 
	$luaRai£E¼Ü
(
lua_S‹
 *
lua
) {

237 
	`lua_push¡ršg
(
lua
,"err");

238 
	`lua_g‘bË
(
lua
,-2);

239  
	`lua_”rÜ
(
lua
);

240 
	}
}

248 
	$luaSÜtA¼ay
(
lua_S‹
 *
lua
) {

250 
	`lua_g‘glob®
(
lua
,"table");

251 
	`lua_push¡ršg
(
lua
,"sort");

252 
	`lua_g‘bË
(
lua
,-2);

253 
	`lua_pushv®ue
(
lua
,-3);

254 ià(
	`lua_pÿÎ
(
lua
,1,0,0)) {

261 
	`lua_pİ
(
lua
,1);

262 
	`lua_push¡ršg
(
lua
,"sort");

263 
	`lua_g‘bË
(
lua
,-2);

264 
	`lua_pushv®ue
(
lua
,-3);

265 
	`lua_g‘glob®
(
lua
,"__redis__compare_helper");

267 
	`lua_ÿÎ
(
lua
,2,0);

270 
	`lua_pİ
(
lua
,1);

271 
	}
}

277 
	$luaR•lyToRedisR•ly
(
ş›Á
 *
c
, 
lua_S‹
 *
lua
) {

278 
t
 = 
	`lua_ty³
(
lua
,-1);

280 
t
) {

281 
LUA_TSTRING
:

282 
	`addR•lyBulkCBufãr
(
c
,(*)
	`lua_to¡ršg
(
lua
,-1),
	`lua_¡¾’
(lua,-1));

284 
LUA_TBOOLEAN
:

285 
	`addR•ly
(
c
,
	`lua_toboŞ—n
(
lua
,-1è? 
sh¬ed
.
cÚe
 : sh¬ed.
nuÎbulk
);

287 
LUA_TNUMBER
:

288 
	`addR•lyLÚgLÚg
(
c
,()
	`lua_tÚumb”
(
lua
,-1));

290 
LUA_TTABLE
:

295 
	`lua_push¡ršg
(
lua
,"err");

296 
	`lua_g‘bË
(
lua
,-2);

297 
t
 = 
	`lua_ty³
(
lua
,-1);

298 ià(
t
 =ğ
LUA_TSTRING
) {

299 
sds
 
”r
 = 
	`sd¢ew
(
	`lua_to¡ršg
(
lua
,-1));

300 
	`sdsm­ch¬s
(
”r
,"\r\n"," ",2);

301 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"-%s\r\n",
”r
));

302 
	`sdsä“
(
”r
);

303 
	`lua_pİ
(
lua
,2);

307 
	`lua_pİ
(
lua
,1);

308 
	`lua_push¡ršg
(
lua
,"ok");

309 
	`lua_g‘bË
(
lua
,-2);

310 
t
 = 
	`lua_ty³
(
lua
,-1);

311 ià(
t
 =ğ
LUA_TSTRING
) {

312 
sds
 
ok
 = 
	`sd¢ew
(
	`lua_to¡ršg
(
lua
,-1));

313 
	`sdsm­ch¬s
(
ok
,"\r\n"," ",2);

314 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"+%s\r\n",
ok
));

315 
	`sdsä“
(
ok
);

316 
	`lua_pİ
(
lua
,1);

318 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

319 
j
 = 1, 
mbulkËn
 = 0;

321 
	`lua_pİ
(
lua
,1);

323 
	`lua_pushnumb”
(
lua
,
j
++);

324 
	`lua_g‘bË
(
lua
,-2);

325 
t
 = 
	`lua_ty³
(
lua
,-1);

326 ià(
t
 =ğ
LUA_TNIL
) {

327 
	`lua_pİ
(
lua
,1);

330 
	`luaR•lyToRedisR•ly
(
c
, 
lua
);

331 
mbulkËn
++;

333 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
mbulkËn
);

337 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

339 
	`lua_pİ
(
lua
,1);

340 
	}
}

346 
	#LUA_CMD_OBJCACHE_SIZE
 32

	)

347 
	#LUA_CMD_OBJCACHE_MAX_LEN
 64

	)

348 
	$luaRedisG’”icCommªd
(
lua_S‹
 *
lua
, 
¿i£_”rÜ
) {

349 
j
, 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

350 
»disCommªd
 *
cmd
;

351 
ş›Á
 *
c
 = 
£rv”
.
lua_ş›Á
;

352 
sds
 
»¶y
;

355 
robj
 **
¬gv
 = 
NULL
;

356 
¬gv_size
 = 0;

357 
robj
 *
ÿched_objeùs
[
LUA_CMD_OBJCACHE_SIZE
];

358 
size_t
 
ÿched_objeùs_Ën
[
LUA_CMD_OBJCACHE_SIZE
];

359 
šu£
 = 0;

362 ià(
£rv”
.
lua_muÉi_em™‹d
 || (£rv”.
lua_ÿÎ”
->
æags
 & 
CLIENT_MULTI
)) {

363 
c
->
æags
 |ğ
CLIENT_MULTI
;

365 
c
->
æags
 &ğ~
CLIENT_MULTI
;

372 ià(
šu£
) {

373 *
»cursiÚ_w¬nšg
 =

376 
	`£rv”Log
(
LL_WARNING
,"%s",
»cursiÚ_w¬nšg
);

377 
	`luaPushE¼Ü
(
lua
,
»cursiÚ_w¬nšg
);

380 
šu£
++;

383 ià(
¬gc
 == 0) {

384 
	`luaPushE¼Ü
(
lua
,

386 
šu£
--;

387  
¿i£_”rÜ
 ? 
	`luaRai£E¼Ü
(
lua
) : 1;

391 ià(
¬gv_size
 < 
¬gc
) {

392 
¬gv
 = 
	`z»®loc
×rgv,(
robj
*)*
¬gc
);

393 
¬gv_size
 = 
¬gc
;

396 
j
 = 0; j < 
¬gc
; j++) {

397 *
obj_s
;

398 
size_t
 
obj_Ën
;

399 
dbuf
[64];

401 ià(
	`lua_ty³
(
lua
,
j
+1è=ğ
LUA_TNUMBER
) {

404 
lua_Numb”
 
num
 = 
	`lua_tÚumb”
(
lua
,
j
+1);

406 
obj_Ën
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",()
num
);

407 
obj_s
 = 
dbuf
;

409 
obj_s
 = (*)
	`lua_tŞ¡ršg
(
lua
,
j
+1,&
obj_Ën
);

410 ià(
obj_s
 =ğ
NULL
) ;

414 ià(
j
 < 
LUA_CMD_OBJCACHE_SIZE
 && 
ÿched_objeùs
[j] &&

415 
ÿched_objeùs_Ën
[
j
] >ğ
obj_Ën
)

417 
sds
 
s
 = 
ÿched_objeùs
[
j
]->
±r
;

418 
¬gv
[
j
] = 
ÿched_objeùs
[j];

419 
ÿched_objeùs
[
j
] = 
NULL
;

420 
	`memıy
(
s
,
obj_s
,
obj_Ën
+1);

421 
	`sds£’
(
s
, 
obj_Ën
);

423 
¬gv
[
j
] = 
	`ü—‹SŒšgObjeù
(
obj_s
, 
obj_Ën
);

430 ià(
j
 !ğ
¬gc
) {

431 
j
--;

432 
j
 >= 0) {

433 
	`deüRefCouÁ
(
¬gv
[
j
]);

434 
j
--;

436 
	`luaPushE¼Ü
(
lua
,

438 
šu£
--;

439  
¿i£_”rÜ
 ? 
	`luaRai£E¼Ü
(
lua
) : 1;

443 
c
->
¬gv
 =‡rgv;

444 
c
->
¬gc
 =‡rgc;

447 ià(
ldb
.
aùive
 &&†db.
¡•
) {

448 
sds
 
cmdlog
 = 
	`sd¢ew
("<redis>");

449 
j
 = 0; j < 
c
->
¬gc
; j++) {

450 ià(
j
 == 10) {

451 
cmdlog
 = 
	`sdsÿrštf
(cmdlog," ... (%d more)",

452 
c
->
¬gc
-
j
-1);

455 
cmdlog
 = 
	`sdsÿ’
(cmdlog," ",1);

456 
cmdlog
 = 
	`sdsÿtsds
(cmdlog,
c
->
¬gv
[
j
]->
±r
);

459 
	`ldbLog
(
cmdlog
);

463 
cmd
 = 
	`lookupCommªd
(
¬gv
[0]->
±r
);

464 ià(!
cmd
 || ((cmd->
¬™y
 > 0 && cmd->¬™y !ğ
¬gc
) ||

465 (
¬gc
 < -
cmd
->
¬™y
)))

467 ià(
cmd
)

468 
	`luaPushE¼Ü
(
lua
,

471 
	`luaPushE¼Ü
(
lua
,"Unknown Redis command called from Lua script");

472 
ş—nup
;

474 
c
->
cmd
 = c->
Ï¡cmd
 = cmd;

477 ià(
cmd
->
æags
 & 
CMD_NOSCRIPT
) {

478 
	`luaPushE¼Ü
(
lua
, "This Redis command is‚ot‡llowed from scripts");

479 
ş—nup
;

485 ià(
cmd
->
æags
 & 
CMD_WRITE
) {

486 ià(
£rv”
.
lua_¿ndom_dœty
 && !£rv”.
lua_»¶iÿ‹_commªds
) {

487 
	`luaPushE¼Ü
(
lua
,

489 
ş—nup
;

490 } ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¦ave_ro
 &&

491 !
£rv”
.
lßdšg
 &&

492 !(
£rv”
.
lua_ÿÎ”
->
æags
 & 
CLIENT_MASTER
))

494 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
ro¦av“¼
->
±r
);

495 
ş—nup
;

496 } ià(
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 &&

497 
£rv”
.
§v•¬am¦’
 > 0 &&

498 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_ERR
)

500 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
bg§v“¼
->
±r
);

501 
ş—nup
;

509 ià(
£rv”
.
maxmemÜy
 && s”v”.
lua_wr™e_dœty
 == 0 &&

510 (
cmd
->
æags
 & 
CMD_DENYOOM
))

512 ià(
	`ä“MemÜyIfN“ded
(è=ğ
C_ERR
) {

513 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
oom”r
->
±r
);

514 
ş—nup
;

518 ià(
cmd
->
æags
 & 
CMD_RANDOM
è
£rv”
.
lua_¿ndom_dœty
 = 1;

519 ià(
cmd
->
æags
 & 
CMD_WRITE
è
£rv”
.
lua_wr™e_dœty
 = 1;

524 ià(
£rv”
.
şu¡”_’abËd
 && !£rv”.
lßdšg
 &&

525 !(
£rv”
.
lua_ÿÎ”
->
æags
 & 
CLIENT_MASTER
))

528 
c
->
æags
 &ğ~(
CLIENT_READONLY
|
CLIENT_ASKING
);

529 
c
->
æags
 |ğ
£rv”
.
lua_ÿÎ”
->æag & (
CLIENT_READONLY
|
CLIENT_ASKING
);

530 ià(
	`g‘NodeByQu”y
(
c
,c->
cmd
,c->
¬gv
,c->
¬gc
,
NULL
,NULL) !=

531 
£rv”
.
şu¡”
->
my£lf
)

533 
	`luaPushE¼Ü
(
lua
,

536 
ş—nup
;

543 ià(
£rv”
.
lua_»¶iÿ‹_commªds
 &&

544 !
£rv”
.
lua_muÉi_em™‹d
 &&

545 !(
£rv”
.
lua_ÿÎ”
->
æags
 & 
CLIENT_MULTI
) &&

546 
£rv”
.
lua_wr™e_dœty
 &&

547 
£rv”
.
lua_»¶
 !ğ
PROPAGATE_NONE
)

549 
	`execCommªdPrİag©eMuÉi
(
£rv”
.
lua_ÿÎ”
);

550 
£rv”
.
lua_muÉi_em™‹d
 = 1;

554 
ÿÎ_æags
 = 
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
;

555 ià(
£rv”
.
lua_»¶iÿ‹_commªds
) {

557 ià(
£rv”
.
lua_»¶
 & 
PROPAGATE_AOF
)

558 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_AOF
;

559 ià(
£rv”
.
lua_»¶
 & 
PROPAGATE_REPL
)

560 
ÿÎ_æags
 |ğ
CMD_CALL_PROPAGATE_REPL
;

562 
	`ÿÎ
(
c
,
ÿÎ_æags
);

567 ià(
	`li¡L’gth
(
c
->
»¶y
è=ğ0 && c->
buåos
 < 
PROTO_REPLY_CHUNK_BYTES
) {

571 
c
->
buf
[c->
buåos
] = '\0';

572 
»¶y
 = 
c
->
buf
;

573 
c
->
buåos
 = 0;

575 
»¶y
 = 
	`sd¢ewËn
(
c
->
buf
,c->
buåos
);

576 
c
->
buåos
 = 0;

577 
	`li¡L’gth
(
c
->
»¶y
)) {

578 
sds
 
o
 = 
	`li¡NodeV®ue
(
	`li¡Fœ¡
(
c
->
»¶y
));

580 
»¶y
 = 
	`sdsÿtsds
Ô•ly,
o
);

581 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

584 ià(
¿i£_”rÜ
 && 
»¶y
[0] != '-')„aise_error = 0;

585 
	`»disPrÙocŞToLuaTy³
(
lua
,
»¶y
);

588 ià(
ldb
.
aùive
 &&†db.
¡•
)

589 
	`ldbLogRedisR•ly
(
»¶y
);

593 ià((
cmd
->
æags
 & 
CMD_SORT_FOR_SCRIPT
) &&

594 (
£rv”
.
lua_»¶iÿ‹_commªds
 == 0) &&

595 (
»¶y
[0] == '*' &&„eply[1] != '-')) {

596 
	`luaSÜtA¼ay
(
lua
);

598 ià(
»¶y
 !ğ
c
->
buf
è
	`sdsä“
(reply);

599 
c
->
»¶y_by‹s
 = 0;

601 
ş—nup
:

604 
j
 = 0; j < 
c
->
¬gc
; j++) {

605 
robj
 *
o
 = 
c
->
¬gv
[
j
];

610 ià(
j
 < 
LUA_CMD_OBJCACHE_SIZE
 &&

611 
o
->
»fcouÁ
 == 1 &&

612 (
o
->
’codšg
 =ğ
OBJ_ENCODING_RAW
 ||

613 
o
->
’codšg
 =ğ
OBJ_ENCODING_EMBSTR
) &&

614 
	`sd¦’
(
o
->
±r
è<ğ
LUA_CMD_OBJCACHE_MAX_LEN
)

616 
sds
 
s
 = 
o
->
±r
;

617 ià(
ÿched_objeùs
[
j
]è
	`deüRefCouÁ
(cached_objects[j]);

618 
ÿched_objeùs
[
j
] = 
o
;

619 
ÿched_objeùs_Ën
[
j
] = 
	`sd§Îoc
(
s
);

621 
	`deüRefCouÁ
(
o
);

625 ià(
c
->
¬gv
 !=‡rgv) {

626 
	`zä“
(
c
->
¬gv
);

627 
¬gv
 = 
NULL
;

628 
¬gv_size
 = 0;

631 ià(
¿i£_”rÜ
) {

635 
šu£
--;

636  
	`luaRai£E¼Ü
(
lua
);

638 
šu£
--;

640 
	}
}

643 
	$luaRedisC®lCommªd
(
lua_S‹
 *
lua
) {

644  
	`luaRedisG’”icCommªd
(
lua
,1);

645 
	}
}

648 
	$luaRedisPC®lCommªd
(
lua_S‹
 *
lua
) {

649  
	`luaRedisG’”icCommªd
(
lua
,0);

650 
	}
}

654 
	$luaRedisSha1hexCommªd
(
lua_S‹
 *
lua
) {

655 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

656 
dige¡
[41];

657 
size_t
 
Ën
;

658 *
s
;

660 ià(
¬gc
 != 1) {

661 
	`lua_push¡ršg
(
lua
, "wrong‚umber of‡rguments");

662  
	`lua_”rÜ
(
lua
);

665 
s
 = (*)
	`lua_tŞ¡ršg
(
lua
,1,&
Ën
);

666 
	`sha1hex
(
dige¡
,
s
,
Ën
);

667 
	`lua_push¡ršg
(
lua
,
dige¡
);

669 
	}
}

678 
	$luaRedisR‘uºSšgËF›ldTabË
(
lua_S‹
 *
lua
, *
f›ld
) {

679 ià(
	`lua_g‘tİ
(
lua
è!ğ1 || 
	`lua_ty³
Öua,-1è!ğ
LUA_TSTRING
) {

680 
	`luaPushE¼Ü
(
lua
, "wrong‚umber orype of‡rguments");

684 
	`lua_ÃwbË
(
lua
);

685 
	`lua_push¡ršg
(
lua
, 
f›ld
);

686 
	`lua_pushv®ue
(
lua
, -3);

687 
	`lua_£‰abË
(
lua
, -3);

689 
	}
}

692 
	$luaRedisE¼ÜR•lyCommªd
(
lua_S‹
 *
lua
) {

693  
	`luaRedisR‘uºSšgËF›ldTabË
(
lua
,"err");

694 
	}
}

697 
	$luaRedisStusR•lyCommªd
(
lua_S‹
 *
lua
) {

698  
	`luaRedisR‘uºSšgËF›ldTabË
(
lua
,"ok");

699 
	}
}

707 
	$luaRedisR•liÿ‹CommªdsCommªd
(
lua_S‹
 *
lua
) {

708 ià(
£rv”
.
lua_wr™e_dœty
) {

709 
	`lua_pushboŞ—n
(
lua
,0);

711 
£rv”
.
lua_»¶iÿ‹_commªds
 = 1;

715 
	`»disS¿nd48
(
	`¿nd
());

716 
	`lua_pushboŞ—n
(
lua
,1);

719 
	}
}

726 
	$luaRedisB»akpoštCommªd
(
lua_S‹
 *
lua
) {

727 ià(
ldb
.
aùive
) {

728 
ldb
.
luabp
 = 1;

729 
	`lua_pushboŞ—n
(
lua
,1);

731 
	`lua_pushboŞ—n
(
lua
,0);

734 
	}
}

741 
	$luaRedisDebugCommªd
(
lua_S‹
 *
lua
) {

742 ià(!
ldb
.
aùive
)  0;

743 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

744 
sds
 
log
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"<debug>†š%d: ", 
ldb
.
cu¼’še
);

745 
¬gc
--) {

746 
log
 = 
	`ldbC©SckV®ue
Öog,
lua
,-1 - 
¬gc
);

747 ià(
¬gc
 !ğ0è
log
 = 
	`sdsÿ’
(log,", ",2);

749 
	`ldbLog
(
log
);

751 
	}
}

757 
	$luaRedisS‘R•lCommªd
(
lua_S‹
 *
lua
) {

758 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

759 
æags
;

761 ià(
£rv”
.
lua_»¶iÿ‹_commªds
 == 0) {

762 
	`lua_push¡ršg
(
lua
, "You can sethe„eplication behavior only‡fterurning on single commands„eplication with„edis.replicate_commands().");

763  
	`lua_”rÜ
(
lua
);

764 } ià(
¬gc
 != 1) {

765 
	`lua_push¡ršg
(
lua
, "redis.set_repl()„equireswo‡rguments.");

766  
	`lua_”rÜ
(
lua
);

769 
æags
 = 
	`lua_tÚumb”
(
lua
,-1);

770 ià((
æags
 & ~(
PROPAGATE_AOF
|
PROPAGATE_REPL
)) != 0) {

771 
	`lua_push¡ršg
(
lua
, "Invalid„eplication flags. Use REPL_AOF, REPL_SLAVE, REPL_ALL or REPL_NONE.");

772  
	`lua_”rÜ
(
lua
);

774 
£rv”
.
lua_»¶
 = 
æags
;

776 
	}
}

779 
	$luaLogCommªd
(
lua_S‹
 *
lua
) {

780 
j
, 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

781 
Ëv–
;

782 
sds
 
log
;

784 ià(
¬gc
 < 2) {

785 
	`lua_push¡ršg
(
lua
, "redis.log()„equireswo‡rguments or more.");

786  
	`lua_”rÜ
(
lua
);

787 } ià(!
	`lua_i¢umb”
(
lua
,-
¬gc
)) {

788 
	`lua_push¡ršg
(
lua
, "First‡rgument must be‡‚umber (log†evel).");

789  
	`lua_”rÜ
(
lua
);

791 
Ëv–
 = 
	`lua_tÚumb”
(
lua
,-
¬gc
);

792 ià(
Ëv–
 < 
LL_DEBUG
 ||†ev– > 
LL_WARNING
) {

793 
	`lua_push¡ršg
(
lua
, "Invalid debug†evel.");

794  
	`lua_”rÜ
(
lua
);

798 
log
 = 
	`sd£m±y
();

799 
j
 = 1; j < 
¬gc
; j++) {

800 
size_t
 
Ën
;

801 *
s
;

803 
s
 = (*)
	`lua_tŞ¡ršg
(
lua
,(-
¬gc
)+
j
,&
Ën
);

804 ià(
s
) {

805 ià(
j
 !ğ1è
log
 = 
	`sdsÿ’
(log," ",1);

806 
log
 = 
	`sdsÿ’
Öog,
s
,
Ën
);

809 
	`£rv”LogRaw
(
Ëv–
,
log
);

810 
	`sdsä“
(
log
);

812 
	}
}

818 
	$luaLßdLib
(
lua_S‹
 *
lua
, cÚ¡ *
libÇme
, 
lua_CFunùiÚ
 
luafunc
) {

819 
	`lua_pushcfunùiÚ
(
lua
, 
luafunc
);

820 
	`lua_push¡ršg
(
lua
, 
libÇme
);

821 
	`lua_ÿÎ
(
lua
, 1, 0);

822 
	}
}

824 
LUALIB_API
 (
luaİ’_cjsÚ
è(
lua_S‹
 *
L
);

825 
LUALIB_API
 (
luaİ’_¡ruù
è(
lua_S‹
 *
L
);

826 
LUALIB_API
 (
luaİ’_cmsg·ck
è(
lua_S‹
 *
L
);

827 
LUALIB_API
 (
luaİ’_b™
è(
lua_S‹
 *
L
);

829 
	$luaLßdLib¿r›s
(
lua_S‹
 *
lua
) {

830 
	`luaLßdLib
(
lua
, "", 
luaİ’_ba£
);

831 
	`luaLßdLib
(
lua
, 
LUA_TABLIBNAME
, 
luaİ’_bË
);

832 
	`luaLßdLib
(
lua
, 
LUA_STRLIBNAME
, 
luaİ’_¡ršg
);

833 
	`luaLßdLib
(
lua
, 
LUA_MATHLIBNAME
, 
luaİ’_m©h
);

834 
	`luaLßdLib
(
lua
, 
LUA_DBLIBNAME
, 
luaİ’_debug
);

835 
	`luaLßdLib
(
lua
, "cjsÚ", 
luaİ’_cjsÚ
);

836 
	`luaLßdLib
(
lua
, "¡ruù", 
luaİ’_¡ruù
);

837 
	`luaLßdLib
(
lua
, "cmsg·ck", 
luaİ’_cmsg·ck
);

838 
	`luaLßdLib
(
lua
, "b™", 
luaİ’_b™
);

841 
	`luaLßdLib
(
lua
, 
LUA_LOADLIBNAME
, 
luaİ’_·ckage
);

842 
	`luaLßdLib
(
lua
, 
LUA_OSLIBNAME
, 
luaİ’_os
);

844 
	}
}

848 
	$luaRemoveUnsuµÜ‹dFunùiÚs
(
lua_S‹
 *
lua
) {

849 
	`lua_pushn
(
lua
);

850 
	`lua_£tglob®
(
lua
,"loadfile");

851 
	`lua_pushn
(
lua
);

852 
	`lua_£tglob®
(
lua
,"dofile");

853 
	}
}

860 
	$sütšgEÇbËGlob®sPrÙeùiÚ
(
lua_S‹
 *
lua
) {

861 *
s
[32];

862 
sds
 
code
 = 
	`sd£m±y
();

863 
j
 = 0;

867 
s
[
j
++]="local dbg=debug\n";

868 
s
[
j
++]="local mt = {}\n";

869 
s
[
j
++]="setmetatable(_G, mt)\n";

870 
s
[
j
++]="mt.__newindex = function (t,‚, v)\n";

871 
s
[
j
++]=" if dbg.getinfo(2)hen\n";

872 
s
[
j
++]="†ocal w = dbg.getinfo(2, \"S\").what\n";

873 
s
[
j
++]=" if w ~= \"main\"‡nd w ~= \"C\"hen\n";

874 
s
[
j
++]="ƒrror(\"Script‡ttemptedo create global variable '\"..tostring(n)..\"'\", 2)\n";

875 
s
[
j
++]="ƒnd\n";

876 
s
[
j
++]="ƒnd\n";

877 
s
[
j
++]="„awset(t,‚, v)\n";

878 
s
[
j
++]="end\n";

879 
s
[
j
++]="mt.__index = function (t,‚)\n";

880 
s
[
j
++]=" if dbg.getinfo(2)‡nd dbg.getinfo(2, \"S\").what ~= \"C\"hen\n";

881 
s
[
j
++]="ƒrror(\"Script‡ttemptedo‡ccess‚onexistent global variable '\"..tostring(n)..\"'\", 2)\n";

882 
s
[
j
++]="ƒnd\n";

883 
s
[
j
++]="„eturn„awget(t,‚)\n";

884 
s
[
j
++]="end\n";

885 
s
[
j
++]="debug =‚il\n";

886 
s
[
j
++]=
NULL
;

888 
j
 = 0; 
s
[j] !ğ
NULL
; j++è
code
 = 
	`sdsÿ’
(code,s[j],
	`¡¾’
(s[j]));

889 
	`luaL_lßdbufãr
(
lua
,
code
,
	`sd¦’
(code),"@enable_strict_lua");

890 
	`lua_pÿÎ
(
lua
,0,0,0);

891 
	`sdsä“
(
code
);

892 
	}
}

904 
	$sütšgIn™
(
£tup
) {

905 
lua_S‹
 *
lua
 = 
	`lua_İ’
();

907 ià(
£tup
) {

908 
£rv”
.
lua_ş›Á
 = 
NULL
;

909 
£rv”
.
lua_ÿÎ”
 = 
NULL
;

910 
£rv”
.
lua_timedout
 = 0;

911 
£rv”
.
lua_®ways_»¶iÿ‹_commªds
 = 0;

912 
	`ldbIn™
();

915 
	`luaLßdLib¿r›s
(
lua
);

916 
	`luaRemoveUnsuµÜ‹dFunùiÚs
(
lua
);

921 
£rv”
.
lua_süts
 = 
	`diùC»©e
(&
shaSütObjeùDiùTy³
,
NULL
);

924 
	`lua_ÃwbË
(
lua
);

927 
	`lua_push¡ršg
(
lua
,"call");

928 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisC®lCommªd
);

929 
	`lua_£‰abË
(
lua
,-3);

932 
	`lua_push¡ršg
(
lua
,"pcall");

933 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisPC®lCommªd
);

934 
	`lua_£‰abË
(
lua
,-3);

937 
	`lua_push¡ršg
(
lua
,"log");

938 
	`lua_pushcfunùiÚ
(
lua
,
luaLogCommªd
);

939 
	`lua_£‰abË
(
lua
,-3);

941 
	`lua_push¡ršg
(
lua
,"LOG_DEBUG");

942 
	`lua_pushnumb”
(
lua
,
LL_DEBUG
);

943 
	`lua_£‰abË
(
lua
,-3);

945 
	`lua_push¡ršg
(
lua
,"LOG_VERBOSE");

946 
	`lua_pushnumb”
(
lua
,
LL_VERBOSE
);

947 
	`lua_£‰abË
(
lua
,-3);

949 
	`lua_push¡ršg
(
lua
,"LOG_NOTICE");

950 
	`lua_pushnumb”
(
lua
,
LL_NOTICE
);

951 
	`lua_£‰abË
(
lua
,-3);

953 
	`lua_push¡ršg
(
lua
,"LOG_WARNING");

954 
	`lua_pushnumb”
(
lua
,
LL_WARNING
);

955 
	`lua_£‰abË
(
lua
,-3);

958 
	`lua_push¡ršg
(
lua
, "sha1hex");

959 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisSha1hexCommªd
);

960 
	`lua_£‰abË
(
lua
, -3);

963 
	`lua_push¡ršg
(
lua
, "error_reply");

964 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisE¼ÜR•lyCommªd
);

965 
	`lua_£‰abË
(
lua
, -3);

966 
	`lua_push¡ršg
(
lua
, "status_reply");

967 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisStusR•lyCommªd
);

968 
	`lua_£‰abË
(
lua
, -3);

971 
	`lua_push¡ršg
(
lua
, "replicate_commands");

972 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisR•liÿ‹CommªdsCommªd
);

973 
	`lua_£‰abË
(
lua
, -3);

976 
	`lua_push¡ršg
(
lua
,"set_repl");

977 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisS‘R•lCommªd
);

978 
	`lua_£‰abË
(
lua
,-3);

980 
	`lua_push¡ršg
(
lua
,"REPL_NONE");

981 
	`lua_pushnumb”
(
lua
,
PROPAGATE_NONE
);

982 
	`lua_£‰abË
(
lua
,-3);

984 
	`lua_push¡ršg
(
lua
,"REPL_AOF");

985 
	`lua_pushnumb”
(
lua
,
PROPAGATE_AOF
);

986 
	`lua_£‰abË
(
lua
,-3);

988 
	`lua_push¡ršg
(
lua
,"REPL_SLAVE");

989 
	`lua_pushnumb”
(
lua
,
PROPAGATE_REPL
);

990 
	`lua_£‰abË
(
lua
,-3);

992 
	`lua_push¡ršg
(
lua
,"REPL_ALL");

993 
	`lua_pushnumb”
(
lua
,
PROPAGATE_AOF
|
PROPAGATE_REPL
);

994 
	`lua_£‰abË
(
lua
,-3);

997 
	`lua_push¡ršg
(
lua
,"breakpoint");

998 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisB»akpoštCommªd
);

999 
	`lua_£‰abË
(
lua
,-3);

1002 
	`lua_push¡ršg
(
lua
,"debug");

1003 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisDebugCommªd
);

1004 
	`lua_£‰abË
(
lua
,-3);

1007 
	`lua_£tglob®
(
lua
,"redis");

1010 
	`lua_g‘glob®
(
lua
,"math");

1012 
	`lua_push¡ršg
(
lua
,"random");

1013 
	`lua_pushcfunùiÚ
(
lua
,
»dis_m©h_¿ndom
);

1014 
	`lua_£‰abË
(
lua
,-3);

1016 
	`lua_push¡ršg
(
lua
,"randomseed");

1017 
	`lua_pushcfunùiÚ
(
lua
,
»dis_m©h_¿ndom£ed
);

1018 
	`lua_£‰abË
(
lua
,-3);

1020 
	`lua_£tglob®
(
lua
,"math");

1025 *
com·»_func
 = "function __redis__compare_helper(a,b)\n"

1030 
	`luaL_lßdbufãr
(
lua
,
com·»_func
,
	`¡¾’
(compare_func),"@cmp_func_def");

1031 
	`lua_pÿÎ
(
lua
,0,0,0);

1039 *
”rh_func
 = "local dbg = debug\n"

1051 
	`luaL_lßdbufãr
(
lua
,
”rh_func
,
	`¡¾’
(errh_func),"@err_handler_def");

1052 
	`lua_pÿÎ
(
lua
,0,0,0);

1059 ià(
£rv”
.
lua_ş›Á
 =ğ
NULL
) {

1060 
£rv”
.
lua_ş›Á
 = 
	`ü—‹Cl›Á
(-1);

1061 
£rv”
.
lua_ş›Á
->
æags
 |ğ
CLIENT_LUA
;

1067 
	`sütšgEÇbËGlob®sPrÙeùiÚ
(
lua
);

1069 
£rv”
.
lua
 =†ua;

1070 
	}
}

1074 
	$sütšgR–—£
() {

1075 
	`diùR–—£
(
£rv”
.
lua_süts
);

1076 
	`lua_şo£
(
£rv”
.
lua
);

1077 
	}
}

1079 
	$sütšgRe£t
() {

1080 
	`sütšgR–—£
();

1081 
	`sütšgIn™
(0);

1082 
	}
}

1086 
	$luaS‘Glob®A¼ay
(
lua_S‹
 *
lua
, *
v¬
, 
robj
 **
–ev
, 
–ec
) {

1087 
j
;

1089 
	`lua_ÃwbË
(
lua
);

1090 
j
 = 0; j < 
–ec
; j++) {

1091 
	`lua_pushl¡ršg
(
lua
,(*)
–ev
[
j
]->
±r
,
	`sd¦’
(elev[j]->ptr));

1092 
	`lua_¿w£ti
(
lua
,-2,
j
+1);

1094 
	`lua_£tglob®
(
lua
,
v¬
);

1095 
	}
}

1107 
	$»dis_m©h_¿ndom
 (
lua_S‹
 *
L
) {

1110 
lua_Numb”
 
r
 = (lua_Numb”)(
	`»disL¿nd48
()%
REDIS_LRAND48_MAX
) /

1111 (
lua_Numb”
)
REDIS_LRAND48_MAX
;

1112 
	`lua_g‘tİ
(
L
)) {

1114 
	`lua_pushnumb”
(
L
, 
r
);

1118 
u
 = 
	`luaL_checkšt
(
L
, 1);

1119 
	`luaL_¬gcheck
(
L
, 1<=
u
, 1, "interval isƒmpty");

1120 
	`lua_pushnumb”
(
L
, 
	`æoÜ
(
r
*
u
)+1);

1124 
l
 = 
	`luaL_checkšt
(
L
, 1);

1125 
u
 = 
	`luaL_checkšt
(
L
, 2);

1126 
	`luaL_¬gcheck
(
L
, 
l
<=
u
, 2, "interval isƒmpty");

1127 
	`lua_pushnumb”
(
L
, 
	`æoÜ
(
r
*(
u
-
l
+1))+l);

1130 :  
	`luaL_”rÜ
(
L
, "wrong‚umber of‡rguments");

1133 
	}
}

1135 
	$»dis_m©h_¿ndom£ed
 (
lua_S‹
 *
L
) {

1136 
	`»disS¿nd48
(
	`luaL_checkšt
(
L
, 1));

1138 
	}
}

1161 
sds
 
	$luaC»©eFunùiÚ
(
ş›Á
 *
c
, 
lua_S‹
 *
lua
, 
robj
 *
body
) {

1162 
funúame
[43];

1163 
diùEÁry
 *
de
;

1165 
funúame
[0] = 'f';

1166 
funúame
[1] = '_';

1167 
	`sha1hex
(
funúame
+2,
body
->
±r
,
	`sd¦’
(body->ptr));

1169 
sds
 
sha
 = 
	`sd¢ewËn
(
funúame
+2,40);

1170 ià((
de
 = 
	`diùFšd
(
£rv”
.
lua_süts
,
sha
)è!ğ
NULL
) {

1171 
	`sdsä“
(
sha
);

1172  
	`diùG‘Key
(
de
);

1175 
sds
 
funcdef
 = 
	`sd£m±y
();

1176 
funcdef
 = 
	`sdsÿt
(funcdef,"function ");

1177 
funcdef
 = 
	`sdsÿ’
(funcdef,
funúame
,42);

1178 
funcdef
 = 
	`sdsÿ’
(funcdef,"() ",3);

1179 
funcdef
 = 
	`sdsÿ’
(funcdef,
body
->
±r
,
	`sd¦’
(body->ptr));

1180 
funcdef
 = 
	`sdsÿ’
(funcdef,"\nend",4);

1182 ià(
	`luaL_lßdbufãr
(
lua
,
funcdef
,
	`sd¦’
(funcdef),"@user_script")) {

1183 ià(
c
 !ğ
NULL
) {

1184 
	`addR•lyE¼ÜFÜm©
(
c
,

1186 
	`lua_to¡ršg
(
lua
,-1));

1188 
	`lua_pİ
(
lua
,1);

1189 
	`sdsä“
(
sha
);

1190 
	`sdsä“
(
funcdef
);

1191  
NULL
;

1193 
	`sdsä“
(
funcdef
);

1195 ià(
	`lua_pÿÎ
(
lua
,0,0,0)) {

1196 ià(
c
 !ğ
NULL
) {

1197 
	`addR•lyE¼ÜFÜm©
(
c
,"Error„unning script (new function): %s\n",

1198 
	`lua_to¡ršg
(
lua
,-1));

1200 
	`lua_pİ
(
lua
,1);

1201 
	`sdsä“
(
sha
);

1202  
NULL
;

1208 
»tv®
 = 
	`diùAdd
(
£rv”
.
lua_süts
,
sha
,
body
);

1209 
	`£rv”As£¹W™hInfo
(
c
 ? c : 
£rv”
.
lua_ş›Á
,
NULL
,
»tv®
 =ğ
DICT_OK
);

1210 
	`šüRefCouÁ
(
body
);

1211  
sha
;

1212 
	}
}

1215 
	$luaMaskCouÁHook
(
lua_S‹
 *
lua
, 
lua_Debug
 *
¬
) {

1216 
–­£d
;

1217 
	`UNUSED
(
¬
);

1218 
	`UNUSED
(
lua
);

1220 
–­£d
 = 
	`m¡ime
(è- 
£rv”
.
lua_time_¡¬t
;

1221 ià(
–­£d
 >ğ
£rv”
.
lua_time_lim™
 && s”v”.
lua_timedout
 == 0) {

1222 
	`£rv”Log
(
LL_WARNING
,"Lu¨¦ow süˆd‘eùed: stÈšƒxecutiÚ‡á” %Îd mli£cÚds. You cªry klšghsüˆusšghSCRIPT KILL commªd.",
–­£d
);

1223 
£rv”
.
lua_timedout
 = 1;

1229 
	`«D–‘eFeEv’t
(
£rv”
.
–
, s”v”.
lua_ÿÎ”
->
fd
, 
AE_READABLE
);

1231 ià(
£rv”
.
lua_timedout
è
	`´oûssEv’tsWheBlocked
();

1232 ià(
£rv”
.
lua_kl
) {

1233 
	`£rv”Log
(
LL_WARNING
,"Lua script killed by user with SCRIPT KILL.");

1234 
	`lua_push¡ršg
(
lua
,"Script killed by user with SCRIPT KILL...");

1235 
	`lua_”rÜ
(
lua
);

1237 
	}
}

1239 
	$ev®G’”icCommªd
(
ş›Á
 *
c
, 
ev®sha
) {

1240 
lua_S‹
 *
lua
 = 
£rv”
.lua;

1241 
funúame
[43];

1242 
numkeys
;

1243 
d–hook
 = 0, 
”r
;

1247 
	`»disS¿nd48
(0);

1257 
£rv”
.
lua_¿ndom_dœty
 = 0;

1258 
£rv”
.
lua_wr™e_dœty
 = 0;

1259 
£rv”
.
lua_»¶iÿ‹_commªds
 = s”v”.
lua_®ways_»¶iÿ‹_commªds
;

1260 
£rv”
.
lua_muÉi_em™‹d
 = 0;

1261 
£rv”
.
lua_»¶
 = 
PROPAGATE_AOF
|
PROPAGATE_REPL
;

1264 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
numkeys
,
NULL
è!ğ
C_OK
)

1266 ià(
numkeys
 > (
c
->
¬gc
 - 3)) {

1267 
	`addR•lyE¼Ü
(
c
,"Number of keys can't be greaterhan‚umber of‡rgs");

1269 } ià(
numkeys
 < 0) {

1270 
	`addR•lyE¼Ü
(
c
,"Number of keys can't be‚egative");

1276 
funúame
[0] = 'f';

1277 
funúame
[1] = '_';

1278 ià(!
ev®sha
) {

1280 
	`sha1hex
(
funúame
+2,
c
->
¬gv
[1]->
±r
,
	`sd¦’
(c->argv[1]->ptr));

1283 
j
;

1284 *
sha
 = 
c
->
¬gv
[1]->
±r
;

1289 
j
 = 0; j < 40; j++)

1290 
funúame
[
j
+2] = (
sha
[j] >= 'A' && sha[j] <= 'Z') ?

1291 
sha
[
j
]+('a'-'A') : sha[j];

1292 
funúame
[42] = '\0';

1296 
	`lua_g‘glob®
(
lua
, "__redis__err__handler");

1299 
	`lua_g‘glob®
(
lua
, 
funúame
);

1300 ià(
	`lua_i¢
(
lua
,-1)) {

1301 
	`lua_pİ
(
lua
,1);

1305 ià(
ev®sha
) {

1306 
	`lua_pİ
(
lua
,1);

1307 
	`addR•ly
(
c
, 
sh¬ed
.
nosü‹¼
);

1310 ià(
	`luaC»©eFunùiÚ
(
c
,
lua
,c->
¬gv
[1]è=ğ
NULL
) {

1311 
	`lua_pİ
(
lua
,1);

1317 
	`lua_g‘glob®
(
lua
, 
funúame
);

1318 
	`£rv”As£¹
(!
	`lua_i¢
(
lua
,-1));

1323 
	`luaS‘Glob®A¼ay
(
lua
,"KEYS",
c
->
¬gv
+3,
numkeys
);

1324 
	`luaS‘Glob®A¼ay
(
lua
,"ARGV",
c
->
¬gv
+3+
numkeys
,c->
¬gc
-3-numkeys);

1327 
	`£ËùDb
(
£rv”
.
lua_ş›Á
,
c
->
db
->
id
);

1336 
£rv”
.
lua_ÿÎ”
 = 
c
;

1337 
£rv”
.
lua_time_¡¬t
 = 
	`m¡ime
();

1338 
£rv”
.
lua_kl
 = 0;

1339 ià(
£rv”
.
lua_time_lim™
 > 0 && s”v”.
ma¡”ho¡
 =ğ
NULL
 &&

1340 
ldb
.
aùive
 == 0)

1342 
	`lua_£thook
(
lua
,
luaMaskCouÁHook
,
LUA_MASKCOUNT
,100000);

1343 
d–hook
 = 1;

1344 } ià(
ldb
.
aùive
) {

1345 
	`lua_£thook
(
£rv”
.
lua
,
luaLdbLšeHook
,
LUA_MASKLINE
|
LUA_MASKCOUNT
,100000);

1346 
d–hook
 = 1;

1352 
”r
 = 
	`lua_pÿÎ
(
lua
,0,1,-2);

1355 ià(
d–hook
è
	`lua_£thook
(
lua
,
NULL
,0,0);

1356 ià(
£rv”
.
lua_timedout
) {

1357 
£rv”
.
lua_timedout
 = 0;

1360 
	`«C»©eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_READABLE
,

1361 
»adQu”yFromCl›Á
,
c
);

1363 
£rv”
.
lua_ÿÎ”
 = 
NULL
;

1371 
	#LUA_GC_CYCLE_PERIOD
 50

	)

1373 
gc_couÁ
 = 0;

1375 
gc_couÁ
++;

1376 ià(
gc_couÁ
 =ğ
LUA_GC_CYCLE_PERIOD
) {

1377 
	`lua_gc
(
lua
,
LUA_GCSTEP
,
LUA_GC_CYCLE_PERIOD
);

1378 
gc_couÁ
 = 0;

1382 ià(
”r
) {

1383 
	`addR•lyE¼ÜFÜm©
(
c
,"Error„unning script (callo %s): %s\n",

1384 
funúame
, 
	`lua_to¡ršg
(
lua
,-1));

1385 
	`lua_pİ
(
lua
,2);

1389 
	`luaR•lyToRedisR•ly
(
c
,
lua
);

1390 
	`lua_pİ
(
lua
,1);

1395 ià(
£rv”
.
lua_»¶iÿ‹_commªds
) {

1396 
	`´ev’tCommªdPrİag©iÚ
(
c
);

1397 ià(
£rv”
.
lua_muÉi_em™‹d
) {

1398 
robj
 *
´İ¬gv
[1];

1399 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("EXEC",4);

1400 
	`®soPrİag©e
(
£rv”
.
execCommªd
,
c
->
db
->
id
,
´İ¬gv
,1,

1401 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

1402 
	`deüRefCouÁ
(
´İ¬gv
[0]);

1416 ià(
ev®sha
 && !
£rv”
.
lua_»¶iÿ‹_commªds
) {

1417 ià(!
	`»¶iÿtiÚSütCacheExi¡s
(
c
->
¬gv
[1]->
±r
)) {

1421 
robj
 *
süt
 = 
	`diùF‘chV®ue
(
£rv”
.
lua_süts
,
c
->
¬gv
[1]->
±r
);

1423 
	`»¶iÿtiÚSütCacheAdd
(
c
->
¬gv
[1]->
±r
);

1424 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
süt
 != NULL);

1425 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,

1426 
	`»£tRefCouÁ
(
	`ü—‹SŒšgObjeù
("EVAL",4)));

1427 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,1,
süt
);

1428 
	`fÜûCommªdPrİag©iÚ
(
c
,
PROPAGATE_REPL
|
PROPAGATE_AOF
);

1431 
	}
}

1433 
	$ev®Commªd
(
ş›Á
 *
c
) {

1434 ià(!(
c
->
æags
 & 
CLIENT_LUA_DEBUG
))

1435 
	`ev®G’”icCommªd
(
c
,0);

1437 
	`ev®G’”icCommªdW™hDebuggšg
(
c
,0);

1438 
	}
}

1440 
	$ev®ShaCommªd
(
ş›Á
 *
c
) {

1441 ià(
	`sd¦’
(
c
->
¬gv
[1]->
±r
) != 40) {

1446 
	`addR•ly
(
c
, 
sh¬ed
.
nosü‹¼
);

1449 ià(!(
c
->
æags
 & 
CLIENT_LUA_DEBUG
))

1450 
	`ev®G’”icCommªd
(
c
,1);

1452 
	`addR•lyE¼Ü
(
c
,"Please use EVAL instead of EVALSHA for debugging");

1455 
	}
}

1457 
	$sütCommªd
(
ş›Á
 *
c
) {

1458 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"flush")) {

1459 
	`sütšgRe£t
();

1460 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1461 
	`»¶iÿtiÚSütCacheFlush
();

1462 
£rv”
.
dœty
++;

1463 } ià(
c
->
¬gc
 >ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"exists")) {

1464 
j
;

1466 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

1467 
j
 = 2; j < 
c
->
¬gc
; j++) {

1468 ià(
	`diùFšd
(
£rv”
.
lua_süts
,
c
->
¬gv
[
j
]->
±r
))

1469 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

1471 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1473 } ià(
c
->
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"load")) {

1474 
sds
 
sha
 = 
	`luaC»©eFunùiÚ
(
c
,
£rv”
.
lua
,c->
¬gv
[2]);

1475 ià(
sha
 =ğ
NULL
) ;

1476 
	`addR•lyBulkCBufãr
(
c
,
sha
,40);

1477 
	`fÜûCommªdPrİag©iÚ
(
c
,
PROPAGATE_REPL
|
PROPAGATE_AOF
);

1478 } ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"kill")) {

1479 ià(
£rv”
.
lua_ÿÎ”
 =ğ
NULL
) {

1480 
	`addR•lySds
(
c
,
	`sd¢ew
("-NOTBUSY No scripts inƒxecution„ight‚ow.\r\n"));

1481 } ià(
£rv”
.
lua_wr™e_dœty
) {

1482 
	`addR•lySds
(
c
,
	`sd¢ew
("-UNKILLABLE Sorryhe script‡lreadyƒxecuted write commands‡gainsthe dataset. You canƒither waithe scriptermination or killhe server in‡ hard way usinghe SHUTDOWN NOSAVE command.\r\n"));

1484 
£rv”
.
lua_kl
 = 1;

1485 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1487 } ià(
c
->
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"debug")) {

1488 ià(
	`ş›ÁHasP’dšgR•l›s
(
c
)) {

1489 
	`addR•lyE¼Ü
(
c
,"SCRIPT DEBUG must be called outside‡…ipeline");

1492 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"no")) {

1493 
	`ldbDi§bË
(
c
);

1494 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1495 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"yes")) {

1496 
	`ldbEÇbË
(
c
);

1497 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1498 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"sync")) {

1499 
	`ldbEÇbË
(
c
);

1500 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1501 
c
->
æags
 |ğ
CLIENT_LUA_DEBUG_SYNC
;

1503 
	`addR•lyE¼Ü
(
c
,"Use SCRIPT DEBUG yes/sync/no");

1506 
	`addR•lyE¼Ü
(
c
, "Unknown SCRIPT subcommand or wrong # of‡rgs.");

1508 
	}
}

1515 
	$ldbIn™
() {

1516 
ldb
.
fd
 = -1;

1517 
ldb
.
aùive
 = 0;

1518 
ldb
.
logs
 = 
	`li¡C»©e
();

1519 
	`li¡S‘F»eM‘hod
(
ldb
.
logs
,((*)(*))
sdsä“
);

1520 
ldb
.
chd»n
 = 
	`li¡C»©e
();

1521 
ldb
.
¤c
 = 
NULL
;

1522 
ldb
.
lšes
 = 0;

1523 
ldb
.
cbuf
 = 
	`sd£m±y
();

1524 
	}
}

1527 
	$ldbFlushLog
(
li¡
 *
log
) {

1528 
li¡Node
 *
Ê
;

1530 (
Ê
 = 
	`li¡Fœ¡
(
log
)è!ğ
NULL
)

1531 
	`li¡D–Node
(
log
,
Ê
);

1532 
	}
}

1535 
	$ldbEÇbË
(
ş›Á
 *
c
) {

1536 
c
->
æags
 |ğ
CLIENT_LUA_DEBUG
;

1537 
	`ldbFlushLog
(
ldb
.
logs
);

1538 
ldb
.
fd
 = 
c
->fd;

1539 
ldb
.
¡•
 = 1;

1540 
ldb
.
bpcouÁ
 = 0;

1541 
ldb
.
luabp
 = 0;

1542 
	`sdsä“
(
ldb
.
cbuf
);

1543 
ldb
.
cbuf
 = 
	`sd£m±y
();

1544 
ldb
.
maxËn
 = 
LDB_MAX_LEN_DEFAULT
;

1545 
ldb
.
maxËn_hšt_£Á
 = 0;

1546 
	}
}

1551 
	$ldbDi§bË
(
ş›Á
 *
c
) {

1552 
c
->
æags
 &ğ~(
CLIENT_LUA_DEBUG
|
CLIENT_LUA_DEBUG_SYNC
);

1553 
	}
}

1556 
	$ldbLog
(
sds
 
’Œy
) {

1557 
	`li¡AddNodeTa
(
ldb
.
logs
,
’Œy
);

1558 
	}
}

1564 
	$ldbLogW™hMaxL’
(
sds
 
’Œy
) {

1565 
Œimmed
 = 0;

1566 ià(
ldb
.
maxËn
 && 
	`sd¦’
(
’Œy
) >†db.maxlen) {

1567 
	`sd¤ªge
(
’Œy
,0,
ldb
.
maxËn
-1);

1568 
’Œy
 = 
	`sdsÿ’
(entry," ...",4);

1569 
Œimmed
 = 1;

1571 
	`ldbLog
(
’Œy
);

1572 ià(
Œimmed
 && 
ldb
.
maxËn_hšt_£Á
 == 0) {

1573 
ldb
.
maxËn_hšt_£Á
 = 1;

1574 
	`ldbLog
(
	`sd¢ew
(

1577 
	}
}

1582 
	$ldbS’dLogs
() {

1583 
sds
 
´Ùo
 = 
	`sd£m±y
();

1584 
´Ùo
 = 
	`sdsÿtfmt
ÕrÙo,"*%i\r\n", ()
	`li¡L’gth
(
ldb
.
logs
));

1585 
	`li¡L’gth
(
ldb
.
logs
)) {

1586 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
ldb
.
logs
);

1587 
´Ùo
 = 
	`sdsÿ’
(proto,"+",1);

1588 
	`sdsm­ch¬s
(
Ê
->
v®ue
,"\r\n"," ",2);

1589 
´Ùo
 = 
	`sdsÿtsds
ÕrÙo,
Ê
->
v®ue
);

1590 
´Ùo
 = 
	`sdsÿ’
(proto,"\r\n",2);

1591 
	`li¡D–Node
(
ldb
.
logs
,
Ê
);

1593 ià(
	`wr™e
(
ldb
.
fd
,
´Ùo
,
	`sd¦’
(proto)) == -1) {

1598 
	`sdsä“
(
´Ùo
);

1599 
	}
}

1613 
	$ldbS¹SessiÚ
(
ş›Á
 *
c
) {

1614 
ldb
.
fÜked
 = (
c
->
æags
 & 
CLIENT_LUA_DEBUG_SYNC
) == 0;

1615 ià(
ldb
.
fÜked
) {

1616 
pid_t
 
ı
 = 
	`fÜk
();

1617 ià(
ı
 == -1) {

1618 
	`addR•lyE¼Ü
(
c
,"Fork() failed: can't„un EVAL in debugging mode.");

1620 } ià(
ı
 == 0) {

1622 
sigaùiÚ
 
aù
;

1623 
	`sigem±y£t
(&
aù
.
§_mask
);

1624 
aù
.
§_æags
 = 0;

1625 
aù
.
§_hªdËr
 = 
SIG_IGN
;

1626 
	`sigaùiÚ
(
SIGTERM
, &
aù
, 
NULL
);

1627 
	`sigaùiÚ
(
SIGINT
, &
aù
, 
NULL
);

1632 
	`£rv”Log
(
LL_WARNING
,"Redis forked for debuggingƒval");

1633 
	`şo£Li¡’šgSock‘s
(0);

1636 
	`li¡AddNodeTa
(
ldb
.
chd»n
,(*)()
ı
);

1637 
	`ä“Cl›ÁAsync
(
c
);

1641 
	`£rv”Log
(
LL_WARNING
,

1646 
	`ª‘Block
(
NULL
,
ldb
.
fd
);

1647 
	`ª‘S’dTimeout
(
NULL
,
ldb
.
fd
,5000);

1648 
ldb
.
aùive
 = 1;

1652 
sds
 
¤c¡ršg
 = 
	`sdsdup
(
c
->
¬gv
[1]->
±r
);

1653 
size_t
 
¤ş’
 = 
	`sd¦’
(
¤c¡ršg
);

1654 
¤ş’
 && (
¤c¡ršg
[srclen-1] == '\n' ||

1655 
¤c¡ršg
[
¤ş’
-1] == '\r'))

1657 
¤c¡ršg
[--
¤ş’
] = '\0';

1659 
	`sds£’
(
¤c¡ršg
,
¤ş’
);

1660 
ldb
.
¤c
 = 
	`sds¥l™Ën
(
¤c¡ršg
,
	`sd¦’
(¤c¡ršg),"\n",1,&ldb.
lšes
);

1661 
	`sdsä“
(
¤c¡ršg
);

1663 
	}
}

1667 
	$ldbEndSessiÚ
(
ş›Á
 *
c
) {

1669 
	`ldbLog
(
	`sd¢ew
("<endsession>"));

1670 
	`ldbS’dLogs
();

1673 ià(
ldb
.
fÜked
) {

1674 
	`wr™eToCl›Á
(
c
->
fd
, c, 0);

1675 
	`£rv”Log
(
LL_WARNING
,"Lua debugging session childƒxiting");

1676 
	`ex™FromChd
(0);

1678 
	`£rv”Log
(
LL_WARNING
,

1683 
	`ª‘NÚBlock
(
NULL
,
ldb
.
fd
);

1684 
	`ª‘S’dTimeout
(
NULL
,
ldb
.
fd
,0);

1688 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

1691 
	`sdsä“¥l™»s
(
ldb
.
¤c
,ldb.
lšes
);

1692 
ldb
.
lšes
 = 0;

1693 
ldb
.
aùive
 = 0;

1694 
	}
}

1699 
	$ldbRemoveChd
(
pid_t
 
pid
) {

1700 
li¡Node
 *
Ê
 = 
	`li¡S—rchKey
(
ldb
.
chd»n
,(*)()
pid
);

1701 ià(
Ê
) {

1702 
	`li¡D–Node
(
ldb
.
chd»n
,
Ê
);

1706 
	}
}

1710 
	$ldbP’dšgChd»n
() {

1711  
	`li¡L’gth
(
ldb
.
chd»n
);

1712 
	}
}

1715 
	$ldbKlFÜkedSessiÚs
() {

1716 
li¡I‹r
 
li
;

1717 
li¡Node
 *
Ê
;

1719 
	`li¡Rewšd
(
ldb
.
chd»n
,&
li
);

1720 (
Ê
 = 
	`li¡Next
(&
li
))) {

1721 
pid_t
 
pid
 = (è
Ê
->
v®ue
;

1722 
	`£rv”Log
(
LL_WARNING
,"Klšg debuggšg sessiÚ %ld",()
pid
);

1723 
	`kl
(
pid
,
SIGKILL
);

1725 
	`li¡R–—£
(
ldb
.
chd»n
);

1726 
ldb
.
chd»n
 = 
	`li¡C»©e
();

1727 
	}
}

1731 
	$ev®G’”icCommªdW™hDebuggšg
(
ş›Á
 *
c
, 
ev®sha
) {

1732 ià(
	`ldbS¹SessiÚ
(
c
)) {

1733 
	`ev®G’”icCommªd
(
c
,
ev®sha
);

1734 
	`ldbEndSessiÚ
(
c
);

1736 
	`ldbDi§bË
(
c
);

1738 
	}
}

1742 *
	$ldbG‘SourûLše
(
lše
) {

1743 
idx
 = 
lše
-1;

1744 ià(
idx
 < 0 || idx >ğ
ldb
.
lšes
)  "<out of„ange source code†ine>";

1745  
ldb
.
¤c
[
idx
];

1746 
	}
}

1749 
	$ldbIsB»akpošt
(
lše
) {

1750 
j
;

1752 
j
 = 0; j < 
ldb
.
bpcouÁ
; j++)

1753 ià(
ldb
.
bp
[
j
] =ğ
lše
)  1;

1755 
	}
}

1760 
	$ldbAddB»akpošt
(
lše
) {

1761 ià(
lše
 <ğ0 ||†š> 
ldb
.
lšes
)  0;

1762 ià(!
	`ldbIsB»akpošt
(
lše
è&& 
ldb
.
bpcouÁ
 !ğ
LDB_BREAKPOINTS_MAX
) {

1763 
ldb
.
bp
[ldb.
bpcouÁ
++] = 
lše
;

1767 
	}
}

1771 
	$ldbD–B»akpošt
(
lše
) {

1772 
j
;

1774 
j
 = 0; j < 
ldb
.
bpcouÁ
; j++) {

1775 ià(
ldb
.
bp
[
j
] =ğ
lše
) {

1776 
ldb
.
bpcouÁ
--;

1777 
	`memmove
(
ldb
.
bp
+
j
,ldb.bp+j+1,ldb.
bpcouÁ
-j);

1782 
	}
}

1787 
sds
 *
	$ldbR•lP¬£Commªd
(*
¬gı
) {

1788 
sds
 *
¬gv
 = 
NULL
;

1789 
¬gc
 = 0;

1790 ià(
	`sd¦’
(
ldb
.
cbuf
è=ğ0è 
NULL
;

1794 
sds
 
cİy
 = 
	`sdsdup
(
ldb
.
cbuf
);

1795 *
p
 = 
cİy
;

1802 
p
 = 
	`¡rchr
Õ,'*'); ià(!pè
´ÙÛ¼
;

1803 *
¶’
 = 
p
+1;

1804 
p
 = 
	`¡r¡r
Õ,"\r\n"); ià(!pè
´ÙÛ¼
;

1805 *
p
 = '\0';… += 2;

1806 *
¬gı
 = 
	`©oi
(
¶’
);

1807 ià(*
¬gı
 <ğ0 || *¬gı > 1024è
´ÙÛ¼
;

1810 
¬gv
 = 
	`zm®loc
((
sds
)*(*
¬gı
));

1811 
¬gc
 = 0;

1812 
¬gc
 < *
¬gı
) {

1813 ià(*
p
 !ğ'$'è
´ÙÛ¼
;

1814 
¶’
 = 
p
+1;

1815 
p
 = 
	`¡r¡r
Õ,"\r\n"); ià(!pè
´ÙÛ¼
;

1816 *
p
 = '\0';… += 2;

1817 
¦’
 = 
	`©oi
(
¶’
);

1818 ià(
¦’
 <ğ0 || sËÀ> 1024è
´ÙÛ¼
;

1819 
¬gv
[
¬gc
++] = 
	`sd¢ewËn
(
p
,
¦’
);

1820 
p
 +ğ
¦’
;

1821 ià(
p
[0] !ğ'\r' ||…[1] !ğ'\n'è
´ÙÛ¼
;

1822 
p
 += 2;

1824 
	`sdsä“
(
cİy
);

1825  
¬gv
;

1827 
´ÙÛ¼
:

1828 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1829 
	`sdsä“
(
cİy
);

1830  
NULL
;

1831 
	}
}

1834 
	$ldbLogSourûLše
(
Êum
) {

1835 *
lše
 = 
	`ldbG‘SourûLše
(
Êum
);

1836 *
´efix
;

1837 
bp
 = 
	`ldbIsB»akpošt
(
Êum
);

1838 
cu¼’t
 = 
ldb
.
cu¼’še
 =ğ
Êum
;

1840 ià(
cu¼’t
 && 
bp
)

1841 
´efix
 = "->#";

1842 ià(
cu¼’t
)

1843 
´efix
 = "-> ";

1844 ià(
bp
)

1845 
´efix
 = " #";

1847 
´efix
 = " ";

1848 
sds
 
thi¦še
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%s%-3d %s", 
´efix
, 
Êum
, 
lše
);

1849 
	`ldbLog
(
thi¦še
);

1850 
	}
}

1857 
	$ldbLi¡
(
¬ound
, 
cÚ‹xt
) {

1858 
j
;

1860 
j
 = 1; j <ğ
ldb
.
lšes
; j++) {

1861 ià(
¬ound
 !ğ0 && 
	`abs
×round-
j
è> 
cÚ‹xt
) ;

1862 
	`ldbLogSourûLše
(
j
);

1864 
	}
}

1873 
	#LDB_MAX_VALUES_DEPTH
 (
LUA_MINSTACK
/2)

	)

1874 
sds
 
	$ldbC©SckV®ueRec
(
sds
 
s
, 
lua_S‹
 *
lua
, 
idx
, 
Ëv–
) {

1875 
t
 = 
	`lua_ty³
(
lua
,
idx
);

1877 ià(
Ëv–
++ =ğ
LDB_MAX_VALUES_DEPTH
)

1878  
	`sdsÿt
(
s
,"<max„ecursion†evel„eached! Nestedable?>");

1880 
t
) {

1881 
LUA_TSTRING
:

1883 
size_t
 
¡¾
;

1884 *
¡½
 = (*)
	`lua_tŞ¡ršg
(
lua
,
idx
,&
¡¾
);

1885 
s
 = 
	`sdsÿŒ•r
(s,
¡½
,
¡¾
);

1888 
LUA_TBOOLEAN
:

1889 
s
 = 
	`sdsÿt
(s,
	`lua_toboŞ—n
(
lua
,
idx
) ? "true" : "false");

1891 
LUA_TNUMBER
:

1892 
s
 = 
	`sdsÿrštf
(s,"%g",()
	`lua_tÚumb”
(
lua
,
idx
));

1894 
LUA_TNIL
:

1895 
s
 = 
	`sdsÿ’
(s,"nil",3);

1897 
LUA_TTABLE
:

1899 
ex³ùed_šdex
 = 1;

1900 
is_¬¿y
 = 1;

1904 
sds
 
»´1
 = 
	`sd£m±y
();

1905 
sds
 
»´2
 = 
	`sd£m±y
();

1906 
	`lua_pushn
(
lua
);

1907 
	`lua_Ãxt
(
lua
,
idx
-1)) {

1909 ià(
is_¬¿y
 &&

1910 (
	`lua_ty³
(
lua
,-2è!ğ
LUA_TNUMBER
 ||

1911 
	`lua_tÚumb”
(
lua
,-2è!ğ
ex³ùed_šdex
)è
is_¬¿y
 = 0;

1914 
»´1
 = 
	`ldbC©SckV®ueRec
Ô•r1,
lua
,-1,
Ëv–
);

1915 
»´1
 = 
	`sdsÿ’
(repr1,"; ",2);

1917 
»´2
 = 
	`sdsÿ’
(repr2,"[",1);

1918 
»´2
 = 
	`ldbC©SckV®ueRec
Ô•r2,
lua
,-2,
Ëv–
);

1919 
»´2
 = 
	`sdsÿ’
(repr2,"]=",2);

1920 
»´2
 = 
	`ldbC©SckV®ueRec
Ô•r2,
lua
,-1,
Ëv–
);

1921 
»´2
 = 
	`sdsÿ’
(repr2,"; ",2);

1922 
	`lua_pİ
(
lua
,1);

1923 
ex³ùed_šdex
++;

1926 ià(
	`sd¦’
(
»´1
)è
	`sd¤ªge
(repr1,0,-3);

1927 ià(
	`sd¦’
(
»´2
)è
	`sd¤ªge
(repr2,0,-3);

1929 
s
 = 
	`sdsÿ’
(s,"{",1);

1930 
s
 = 
	`sdsÿtsds
(s,
is_¬¿y
 ? 
»´1
 : 
»´2
);

1931 
s
 = 
	`sdsÿ’
(s,"}",1);

1932 
	`sdsä“
(
»´1
);

1933 
	`sdsä“
(
»´2
);

1936 
LUA_TFUNCTION
:

1937 
LUA_TUSERDATA
:

1938 
LUA_TTHREAD
:

1939 
LUA_TLIGHTUSERDATA
:

1941 cÚ¡ *
p
 = 
	`lua_tİoš‹r
(
lua
,
idx
);

1942 *
ty³Çme
 = "unknown";

1943 ià(
t
 =ğ
LUA_TFUNCTION
è
ty³Çme
 = "function";

1944 ià(
t
 =ğ
LUA_TUSERDATA
è
ty³Çme
 = "userdata";

1945 ià(
t
 =ğ
LUA_TTHREAD
è
ty³Çme
 = "thread";

1946 ià(
t
 =ğ
LUA_TLIGHTUSERDATA
è
ty³Çme
 = "light-userdata";

1947 
s
 = 
	`sdsÿrštf
(s,"\"%s@%p\"",
ty³Çme
,
p
);

1951 
s
 = 
	`sdsÿt
(s,"\"<unknown-lua-type>\"");

1954  
s
;

1955 
	}
}

1959 
sds
 
	$ldbC©SckV®ue
(
sds
 
s
, 
lua_S‹
 *
lua
, 
idx
) {

1960  
	`ldbC©SckV®ueRec
(
s
,
lua
,
idx
,0);

1961 
	}
}

1966 
	$ldbLogSckV®ue
(
lua_S‹
 *
lua
, *
´efix
) {

1967 
sds
 
s
 = 
	`sd¢ew
(
´efix
);

1968 
s
 = 
	`ldbC©SckV®ue
(s,
lua
,-1);

1969 
	`ldbLogW™hMaxL’
(
s
);

1970 
	}
}

1972 *
ldbRedisPrÙocŞToHumª_IÁ
(
sds
 *
o
, *
»¶y
);

1973 *
ldbRedisPrÙocŞToHumª_Bulk
(
sds
 *
o
, *
»¶y
);

1974 *
ldbRedisPrÙocŞToHumª_Stus
(
sds
 *
o
, *
»¶y
);

1975 *
ldbRedisPrÙocŞToHumª_MuÉiBulk
(
sds
 *
o
, *
»¶y
);

1982 *
	$ldbRedisPrÙocŞToHumª
(
sds
 *
o
, *
»¶y
) {

1983 *
p
 = 
»¶y
;

1984 *
p
) {

1985 ':': 
p
 = 
	`ldbRedisPrÙocŞToHumª_IÁ
(
o
,
»¶y
); ;

1986 '$': 
p
 = 
	`ldbRedisPrÙocŞToHumª_Bulk
(
o
,
»¶y
); ;

1987 '+': 
p
 = 
	`ldbRedisPrÙocŞToHumª_Stus
(
o
,
»¶y
); ;

1988 '-': 
p
 = 
	`ldbRedisPrÙocŞToHumª_Stus
(
o
,
»¶y
); ;

1989 '*': 
p
 = 
	`ldbRedisPrÙocŞToHumª_MuÉiBulk
(
o
,
»¶y
); ;

1991  
p
;

1992 
	}
}

1997 *
	$ldbRedisPrÙocŞToHumª_IÁ
(
sds
 *
o
, *
»¶y
) {

1998 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

1999 *
o
 = 
	`sdsÿ’
(*o,
»¶y
+1,
p
-reply-1);

2000  
p
+2;

2001 
	}
}

2003 *
	$ldbRedisPrÙocŞToHumª_Bulk
(
sds
 *
o
, *
»¶y
) {

2004 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

2005 
bulkËn
;

2007 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
bulkËn
);

2008 ià(
bulkËn
 == -1) {

2009 *
o
 = 
	`sdsÿ’
(*o,"NULL",4);

2010  
p
+2;

2012 *
o
 = 
	`sdsÿŒ•r
(*o,
p
+2,
bulkËn
);

2013  
p
+2+
bulkËn
+2;

2015 
	}
}

2017 *
	$ldbRedisPrÙocŞToHumª_Stus
(
sds
 *
o
, *
»¶y
) {

2018 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

2020 *
o
 = 
	`sdsÿŒ•r
(*o,
»¶y
,
p
-reply);

2021  
p
+2;

2022 
	}
}

2024 *
	$ldbRedisPrÙocŞToHumª_MuÉiBulk
(
sds
 *
o
, *
»¶y
) {

2025 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

2026 
mbulkËn
;

2027 
j
 = 0;

2029 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
mbulkËn
);

2030 
p
 += 2;

2031 ià(
mbulkËn
 == -1) {

2032 *
o
 = 
	`sdsÿ’
(*o,"NULL",4);

2033  
p
;

2035 *
o
 = 
	`sdsÿ’
(*o,"[",1);

2036 
j
 = 0; j < 
mbulkËn
; j++) {

2037 
p
 = 
	`ldbRedisPrÙocŞToHumª
(
o
,p);

2038 ià(
j
 !ğ
mbulkËn
-1è*
o
 = 
	`sdsÿ’
(*o,",",1);

2040 *
o
 = 
	`sdsÿ’
(*o,"]",1);

2041  
p
;

2042 
	}
}

2047 
	$ldbLogRedisR•ly
(*
»¶y
) {

2048 
sds
 
log
 = 
	`sd¢ew
("<reply> ");

2049 
	`ldbRedisPrÙocŞToHumª
(&
log
,
»¶y
);

2050 
	`ldbLogW™hMaxL’
(
log
);

2051 
	}
}

2056 
	$ldbPršt
(
lua_S‹
 *
lua
, *
v¬Çme
) {

2057 
lua_Debug
 
¬
;

2059 
l
 = 0;

2060 
	`lua_g‘¡ack
(
lua
,
l
,&
¬
) != 0) {

2061 
l
++;

2062 cÚ¡ *
Çme
;

2063 
i
 = 1;

2064 (
Çme
 = 
	`lua_g‘loÿl
(
lua
,&
¬
,
i
)è!ğ
NULL
) {

2065 
i
++;

2066 ià(
	`¡rcmp
(
v¬Çme
,
Çme
) == 0) {

2067 
	`ldbLogSckV®ue
(
lua
,"<value> ");

2068 
	`lua_pİ
(
lua
,1);

2071 
	`lua_pİ
(
lua
,1);

2077 ià(!
	`¡rcmp
(
v¬Çme
,"ARGV") || !strcmp(varname,"KEYS")) {

2078 
	`lua_g‘glob®
(
lua
, 
v¬Çme
);

2079 
	`ldbLogSckV®ue
(
lua
,"<value> ");

2080 
	`lua_pİ
(
lua
,1);

2082 
	`ldbLog
(
	`sd¢ew
("No such variable."));

2084 
	}
}

2088 
	$ldbPrštAÎ
(
lua_S‹
 *
lua
) {

2089 
lua_Debug
 
¬
;

2090 
v¬s
 = 0;

2092 ià(
	`lua_g‘¡ack
(
lua
,0,&
¬
) != 0) {

2093 cÚ¡ *
Çme
;

2094 
i
 = 1;

2095 (
Çme
 = 
	`lua_g‘loÿl
(
lua
,&
¬
,
i
)è!ğ
NULL
) {

2096 
i
++;

2097 ià(!
	`¡r¡r
(
Çme
,"(*temporary)")) {

2098 
sds
 
´efix
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"<v®ue> % ğ",
Çme
);

2099 
	`ldbLogSckV®ue
(
lua
,
´efix
);

2100 
	`sdsä“
(
´efix
);

2101 
v¬s
++;

2103 
	`lua_pİ
(
lua
,1);

2107 ià(
v¬s
 == 0) {

2108 
	`ldbLog
(
	`sd¢ew
("No†ocal variables inhe current context."));

2110 
	}
}

2113 
	$ldbB»ak
(
sds
 *
¬gv
, 
¬gc
) {

2114 ià(
¬gc
 == 1) {

2115 ià(
ldb
.
bpcouÁ
 == 0) {

2116 
	`ldbLog
(
	`sd¢ew
("No breakpoints set. Use 'b <line>'o‡dd one."));

2119 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"%˜b»akpošt £t:",
ldb
.
bpcouÁ
));

2120 
j
;

2121 
j
 = 0; j < 
ldb
.
bpcouÁ
; j++)

2122 
	`ldbLogSourûLše
(
ldb
.
bp
[
j
]);

2125 
j
;

2126 
j
 = 1; j < 
¬gc
; j++) {

2127 *
¬g
 = 
¬gv
[
j
];

2128 
lše
;

2129 ià(!
	`¡ršg2l
(
¬g
,
	`sd¦’
×rg),&
lše
)) {

2130 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"Inv®id‡rgum’t:'%s'",
¬g
));

2132 ià(
lše
 == 0) {

2133 
ldb
.
bpcouÁ
 = 0;

2134 
	`ldbLog
(
	`sd¢ew
("All breakpoints„emoved."));

2135 } ià(
lše
 > 0) {

2136 ià(
ldb
.
bpcouÁ
 =ğ
LDB_BREAKPOINTS_MAX
) {

2137 
	`ldbLog
(
	`sd¢ew
("Too many breakpoints set."));

2138 } ià(
	`ldbAddB»akpošt
(
lše
)) {

2139 
	`ldbLi¡
(
lše
,1);

2141 
	`ldbLog
(
	`sd¢ew
("Wrong†ine‚umber."));

2143 } ià(
lše
 < 0) {

2144 ià(
	`ldbD–B»akpošt
(-
lše
))

2145 
	`ldbLog
(
	`sd¢ew
("Breakpoint„emoved."));

2147 
	`ldbLog
(
	`sd¢ew
("No breakpoint inhe specified†ine."));

2152 
	}
}

2157 
	$ldbEv®
(
lua_S‹
 *
lua
, 
sds
 *
¬gv
, 
¬gc
) {

2159 
sds
 
code
 = 
	`sdsjošsds
(
¬gv
+1,
¬gc
-1," ",1);

2160 
sds
 
ex´
 = 
	`sdsÿtsds
(
	`sd¢ew
("»tuº "),
code
);

2163 ià(
	`luaL_lßdbufãr
(
lua
,
ex´
,
	`sd¦’
(expr),"@ldb_eval")) {

2164 
	`lua_pİ
(
lua
,1);

2166 ià(
	`luaL_lßdbufãr
(
lua
,
code
,
	`sd¦’
(code),"@ldb_eval")) {

2167 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"<”rÜ> %s",
	`lua_to¡ršg
(
lua
,-1)));

2168 
	`lua_pİ
(
lua
,1);

2169 
	`sdsä“
(
code
);

2175 
	`sdsä“
(
code
);

2176 
	`sdsä“
(
ex´
);

2177 ià(
	`lua_pÿÎ
(
lua
,0,1,0)) {

2178 
	`ldbLog
(
	`sdsÿtfmt
(
	`sd£m±y
(),"<”rÜ> %s",
	`lua_to¡ršg
(
lua
,-1)));

2179 
	`lua_pİ
(
lua
,1);

2182 
	`ldbLogSckV®ue
(
lua
,"<retval> ");

2183 
	`lua_pİ
(
lua
,1);

2184 
	}
}

2190 
	$ldbRedis
(
lua_S‹
 *
lua
, 
sds
 *
¬gv
, 
¬gc
) {

2191 
j
, 
§ved_rc
 = 
£rv”
.
lua_»¶iÿ‹_commªds
;

2193 
	`lua_g‘glob®
(
lua
,"redis");

2194 
	`lua_push¡ršg
(
lua
,"call");

2195 
	`lua_g‘bË
(
lua
,-2);

2196 
j
 = 1; j < 
¬gc
; j++)

2197 
	`lua_pushl¡ršg
(
lua
,
¬gv
[
j
],
	`sd¦’
(argv[j]));

2198 
ldb
.
¡•
 = 1;

2199 
£rv”
.
lua_»¶iÿ‹_commªds
 = 1;

2200 
	`lua_pÿÎ
(
lua
,
¬gc
-1,1,0);

2201 
ldb
.
¡•
 = 0;

2202 
£rv”
.
lua_»¶iÿ‹_commªds
 = 
§ved_rc
;

2203 
	`lua_pİ
(
lua
,2);

2204 
	}
}

2208 
	$ldbT¿û
(
lua_S‹
 *
lua
) {

2209 
lua_Debug
 
¬
;

2210 
Ëv–
 = 0;

2212 
	`lua_g‘¡ack
(
lua
,
Ëv–
,&
¬
)) {

2213 
	`lua_g‘šfo
(
lua
,"SÆ",&
¬
);

2214 if(
	`¡r¡r
(
¬
.
shÜt_¤c
,"u£r_süt"è!ğ
NULL
) {

2215 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"%s %s:",

2216 (
Ëv–
 == 0) ? "In" : "From",

2217 
¬
.
Çme
 ?‡r.name : "top†evel"));

2218 
	`ldbLogSourûLše
(
¬
.
cu¼’še
);

2220 
Ëv–
++;

2222 ià(
Ëv–
 == 0) {

2223 
	`ldbLog
(
	`sd¢ew
("<error> Can't„etrieve Lua stack."));

2225 
	}
}

2229 
	$ldbMaxËn
(
sds
 *
¬gv
, 
¬gc
) {

2230 ià(
¬gc
 == 2) {

2231 
Ãwv®
 = 
	`©oi
(
¬gv
[1]);

2232 
ldb
.
maxËn_hšt_£Á
 = 1;

2233 ià(
Ãwv®
 != 0 &&‚ewval <= 60)‚ewval = 60;

2234 
ldb
.
maxËn
 = 
Ãwv®
;

2236 ià(
ldb
.
maxËn
) {

2237 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"<v®ue>„•l› ¬Œunÿ‹d‡ˆ%d by‹s.",()
ldb
.
maxËn
));

2239 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),"<value>„eplies‡re unlimited."));

2241 
	}
}

2246 
	$ldbR•l
(
lua_S‹
 *
lua
) {

2247 
sds
 *
¬gv
;

2248 
¬gc
;

2253 (
¬gv
 = 
	`ldbR•lP¬£Commªd
(&
¬gc
)è=ğ
NULL
) {

2254 
buf
[1024];

2255 
Ä—d
 = 
	`»ad
(
ldb
.
fd
,
buf
,(buf));

2256 ià(
Ä—d
 <= 0) {

2259 
ldb
.
¡•
 = 0;

2260 
ldb
.
bpcouÁ
 = 0;

2261  
C_ERR
;

2263 
ldb
.
cbuf
 = 
	`sdsÿ’
Ödb.cbuf,
buf
,
Ä—d
);

2267 
	`sdsä“
(
ldb
.
cbuf
);

2268 
ldb
.
cbuf
 = 
	`sd£m±y
();

2271 ià(!
	`¡rÿ£cmp
(
¬gv
[0],"h") || !strcasecmp(argv[0],"help")) {

2272 
	`ldbLog
(
	`sd¢ew
("Redis Lua debugger help:"));

2273 
	`ldbLog
(
	`sd¢ew
("[h]elp Showhis help."));

2274 
	`ldbLog
(
	`sd¢ew
("[s]tep Run current†ine‡nd stop‡gain."));

2275 
	`ldbLog
(
	`sd¢ew
("[n]ext Alias for step."));

2276 
	`ldbLog
(
	`sd¢ew
("[c]continue Runill‚ext breakpoint."));

2277 
	`ldbLog
(
	`sd¢ew
("[l]list List source code‡round current†ine."));

2278 
	`ldbLog
(
	`sd¢ew
("[l]list [line] List source code‡round [line]."));

2279 
	`ldbLog
(
	`sd¢ew
("†ine = 0 means: current…osition."));

2280 
	`ldbLog
(
	`sd¢ew
("[l]list [line] [ctx] Inhis form [ctx] specifies how many†ines"));

2281 
	`ldbLog
(
	`sd¢ew
("o show before/after [line]."));

2282 
	`ldbLog
(
	`sd¢ew
("[w]hole List‡ll source code. Alias for 'list 1 1000000'."));

2283 
	`ldbLog
(
	`sd¢ew
("[p]rint Show‡llhe†ocal variables."));

2284 
	`ldbLog
(
	`sd¢ew
("[p]rint <var> Showhe value ofhe specified variable."));

2285 
	`ldbLog
(
	`sd¢ew
(" Can‡lso show global vars KEYS‡nd ARGV."));

2286 
	`ldbLog
(
	`sd¢ew
("[b]reak Show‡ll breakpoints."));

2287 
	`ldbLog
(
	`sd¢ew
("[b]reak <line> Add‡ breakpointohe specified†ine."));

2288 
	`ldbLog
(
	`sd¢ew
("[b]reak -<line> Remove breakpoint fromhe specified†ine."));

2289 
	`ldbLog
(
	`sd¢ew
("[b]reak 0 Remove‡ll breakpoints."));

2290 
	`ldbLog
(
	`sd¢ew
("[t]race Show‡ backtrace."));

2291 
	`ldbLog
(
	`sd¢ew
("[e]eval <code> Execute some Lua code (in‡ different callframe)."));

2292 
	`ldbLog
(
	`sd¢ew
("[r]edis <cmd> Execute‡ Redis command."));

2293 
	`ldbLog
(
	`sd¢ew
("[m]axlen [len] Trim†ogged Redis„eplies‡nd Lua var dumpso†en."));

2294 
	`ldbLog
(
	`sd¢ew
(" Specifying zero‡s <len> means unlimited."));

2295 
	`ldbLog
(
	`sd¢ew
("[a]bort Stopheƒxecution ofhe script. In sync"));

2296 
	`ldbLog
(
	`sd¢ew
(" mode dataset changes will be„etained."));

2297 
	`ldbLog
(
	`sd¢ew
(""));

2298 
	`ldbLog
(
	`sd¢ew
("Debugger functions you can call from Lua scripts:"));

2299 
	`ldbLog
(
	`sd¢ew
("redis.debug() Produce†ogs inhe debugger console."));

2300 
	`ldbLog
(
	`sd¢ew
("redis.breakpoint() Stopƒxecution†ike ifhere was‡ breakpoing."));

2301 
	`ldbLog
(
	`sd¢ew
(" inhe‚ext†ine of code."));

2302 
	`ldbS’dLogs
();

2303 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"s") || !strcasecmp(argv[0],"step") ||

2304 !
	`¡rÿ£cmp
(
¬gv
[0],"n") || !strcasecmp(argv[0],"next")) {

2305 
ldb
.
¡•
 = 1;

2307 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"c") || !strcasecmp(argv[0],"continue")){

2309 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"t") || !strcasecmp(argv[0],"trace")) {

2310 
	`ldbT¿û
(
lua
);

2311 
	`ldbS’dLogs
();

2312 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"m") || !strcasecmp(argv[0],"maxlen")) {

2313 
	`ldbMaxËn
(
¬gv
,
¬gc
);

2314 
	`ldbS’dLogs
();

2315 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"b") || !strcasecmp(argv[0],"break")) {

2316 
	`ldbB»ak
(
¬gv
,
¬gc
);

2317 
	`ldbS’dLogs
();

2318 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"e") || !strcasecmp(argv[0],"eval")) {

2319 
	`ldbEv®
(
lua
,
¬gv
,
¬gc
);

2320 
	`ldbS’dLogs
();

2321 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"a") || !strcasecmp(argv[0],"abort")) {

2322 
	`lua_push¡ršg
(
lua
, "script‡borted for user„equest");

2323 
	`lua_”rÜ
(
lua
);

2324 } ià(
¬gc
 > 1 &&

2325 (!
	`¡rÿ£cmp
(
¬gv
[0],"r") || !strcasecmp(argv[0],"redis"))) {

2326 
	`ldbRedis
(
lua
,
¬gv
,
¬gc
);

2327 
	`ldbS’dLogs
();

2328 } ià((!
	`¡rÿ£cmp
(
¬gv
[0],"p") || !strcasecmp(argv[0],"print"))) {

2329 ià(
¬gc
 == 2)

2330 
	`ldbPršt
(
lua
,
¬gv
[1]);

2332 
	`ldbPrštAÎ
(
lua
);

2333 
	`ldbS’dLogs
();

2334 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"l") || !strcasecmp(argv[0],"list")){

2335 
¬ound
 = 
ldb
.
cu¼’še
, 
ùx
 = 5;

2336 ià(
¬gc
 > 1) {

2337 
num
 = 
	`©oi
(
¬gv
[1]);

2338 ià(
num
 > 0è
¬ound
 =‚um;

2340 ià(
¬gc
 > 2è
ùx
 = 
	`©oi
(
¬gv
[2]);

2341 
	`ldbLi¡
(
¬ound
,
ùx
);

2342 
	`ldbS’dLogs
();

2343 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"w") || !strcasecmp(argv[0],"whole")){

2344 
	`ldbLi¡
(1,1000000);

2345 
	`ldbS’dLogs
();

2347 
	`ldbLog
(
	`sd¢ew
("<error> Unknown Redis Lua debugger command or "

2349 
	`ldbS’dLogs
();

2353 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

2357 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

2358  
C_OK
;

2359 
	}
}

2363 
	$luaLdbLšeHook
(
lua_S‹
 *
lua
, 
lua_Debug
 *
¬
) {

2364 
	`lua_g‘¡ack
(
lua
,0,
¬
);

2365 
	`lua_g‘šfo
(
lua
,"Sl",
¬
);

2366 
ldb
.
cu¼’še
 = 
¬
->currentline;

2368 
bp
 = 
	`ldbIsB»akpošt
(
ldb
.
cu¼’še
è||†db.
luabp
;

2369 
timeout
 = 0;

2372 if(
	`¡r¡r
(
¬
->
shÜt_¤c
,"u£r_süt"è=ğ
NULL
) ;

2375 ià(
¬
->
ev’t
 =ğ
LUA_HOOKCOUNT
 && 
ldb
.
¡•
 =ğ0 && 
bp
 == 0) {

2376 
m¡ime_t
 
–­£d
 = 
	`m¡ime
(è- 
£rv”
.
lua_time_¡¬t
;

2377 
m¡ime_t
 
tim–im™
 = 
£rv”
.
lua_time_lim™
 ?

2378 
£rv”
.
lua_time_lim™
 : 5000;

2379 ià(
–­£d
 >ğ
tim–im™
) {

2380 
timeout
 = 1;

2381 
ldb
.
¡•
 = 1;

2387 ià(
ldb
.
¡•
 || 
bp
) {

2388 *
»asÚ
 = "step over";

2389 ià(
bp
è
»asÚ
 = 
ldb
.
luabp
 ? "redis.breakpoint() called" :

2391 ià(
timeout
è
»asÚ
 = "timeout„eached, infinite†oop?";

2392 
ldb
.
¡•
 = 0;

2393 
ldb
.
luabp
 = 0;

2394 
	`ldbLog
(
	`sdsÿrštf
(
	`sd£m±y
(),

2396 
ldb
.
cu¼’še
, 
»asÚ
));

2397 
	`ldbLogSourûLše
(
ldb
.
cu¼’še
);

2398 
	`ldbS’dLogs
();

2399 ià(
	`ldbR•l
(
lua
è=ğ
C_ERR
 && 
timeout
) {

2403 
	`lua_push¡ršg
(
lua
, "timeout during Lua debugging with client closing connection");

2404 
	`lua_”rÜ
(
lua
);

2406 
£rv”
.
lua_time_¡¬t
 = 
	`m¡ime
();

2408 
	}
}

	@src/sds.c

33 
	~<¡dio.h
>

34 
	~<¡dlib.h
>

35 
	~<¡ršg.h
>

36 
	~<ùy³.h
>

37 
	~<as£¹.h
>

38 
	~<lim™s.h
>

39 
	~"sds.h
"

40 
	~"sd§Îoc.h
"

42 
šlše
 
	$sdsHdrSize
(
ty³
) {

43 
ty³
&
SDS_TYPE_MASK
) {

44 
SDS_TYPE_5
:

45  (
sdshdr5
);

46 
SDS_TYPE_8
:

47  (
sdshdr8
);

48 
SDS_TYPE_16
:

49  (
sdshdr16
);

50 
SDS_TYPE_32
:

51  (
sdshdr32
);

52 
SDS_TYPE_64
:

53  (
sdshdr64
);

56 
	}
}

58 
šlše
 
	$sdsReqTy³
(
size_t
 
¡ršg_size
) {

59 ià(
¡ršg_size
 < 1<<5)

60  
SDS_TYPE_5
;

61 ià(
¡ršg_size
 < 1<<8)

62  
SDS_TYPE_8
;

63 ià(
¡ršg_size
 < 1<<16)

64  
SDS_TYPE_16
;

65 #ià(
LONG_MAX
 =ğ
LLONG_MAX
)

66 ià(
¡ršg_size
 < 1ll<<32)

67  
SDS_TYPE_32
;

69  
SDS_TYPE_64
;

70 
	}
}

84 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

85 *
sh
;

86 
sds
 
s
;

87 
ty³
 = 
	`sdsReqTy³
(
š™Ën
);

90 ià(
ty³
 =ğ
SDS_TYPE_5
 && 
š™Ën
 =ğ0èty³ = 
SDS_TYPE_8
;

91 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

92 *
å
;

94 
sh
 = 
	`s_m®loc
(
hd¾’
+
š™Ën
+1);

95 ià(!
š™
)

96 
	`mem£t
(
sh
, 0, 
hd¾’
+
š™Ën
+1);

97 ià(
sh
 =ğ
NULL
)  NULL;

98 
s
 = (*)
sh
+
hd¾’
;

99 
å
 = ((*)
s
)-1;

100 
ty³
) {

101 
SDS_TYPE_5
: {

102 *
å
 = 
ty³
 | (
š™Ën
 << 
SDS_TYPE_BITS
);

105 
SDS_TYPE_8
: {

106 
	`SDS_HDR_VAR
(8,
s
);

107 
sh
->
Ën
 = 
š™Ën
;

108 
sh
->
®loc
 = 
š™Ën
;

109 *
å
 = 
ty³
;

112 
SDS_TYPE_16
: {

113 
	`SDS_HDR_VAR
(16,
s
);

114 
sh
->
Ën
 = 
š™Ën
;

115 
sh
->
®loc
 = 
š™Ën
;

116 *
å
 = 
ty³
;

119 
SDS_TYPE_32
: {

120 
	`SDS_HDR_VAR
(32,
s
);

121 
sh
->
Ën
 = 
š™Ën
;

122 
sh
->
®loc
 = 
š™Ën
;

123 *
å
 = 
ty³
;

126 
SDS_TYPE_64
: {

127 
	`SDS_HDR_VAR
(64,
s
);

128 
sh
->
Ën
 = 
š™Ën
;

129 
sh
->
®loc
 = 
š™Ën
;

130 *
å
 = 
ty³
;

134 ià(
š™Ën
 && 
š™
)

135 
	`memıy
(
s
, 
š™
, 
š™Ën
);

136 
s
[
š™Ën
] = '\0';

137  
s
;

138 
	}
}

142 
sds
 
	$sd£m±y
() {

143  
	`sd¢ewËn
("",0);

144 
	}
}

147 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

148 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

149  
	`sd¢ewËn
(
š™
, 
š™Ën
);

150 
	}
}

153 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

154  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

155 
	}
}

158 
	$sdsä“
(
sds
 
s
) {

159 ià(
s
 =ğ
NULL
) ;

160 
	`s_ä“
((*)
s
-
	`sdsHdrSize
(s[-1]));

161 
	}
}

177 
	$sdsupd©–’
(
sds
 
s
) {

178 
size_t
 
»®Ën
 = 
	`¡¾’
(
s
);

179 
	`sds£’
(
s
, 
»®Ën
);

180 
	}
}

186 
	$sdsş—r
(
sds
 
s
) {

187 
	`sds£’
(
s
, 0);

188 
s
[0] = '\0';

189 
	}
}

197 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

198 *
sh
, *
Ãwsh
;

199 
size_t
 
ava
 = 
	`sd§va
(
s
);

200 
size_t
 
Ën
, 
ÃwËn
;

201 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

202 
hd¾’
;

205 ià(
ava
 >ğ
addËn
è 
s
;

207 
Ën
 = 
	`sd¦’
(
s
);

208 
sh
 = (*)
s
-
	`sdsHdrSize
(
Şdty³
);

209 
ÃwËn
 = (
Ën
+
addËn
);

210 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

211 
ÃwËn
 *= 2;

213 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

215 
ty³
 = 
	`sdsReqTy³
(
ÃwËn
);

220 ià(
ty³
 =ğ
SDS_TYPE_5
èty³ = 
SDS_TYPE_8
;

222 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

223 ià(
Şdty³
==
ty³
) {

224 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
hd¾’
+
ÃwËn
+1);

225 ià(
Ãwsh
 =ğ
NULL
)  NULL;

226 
s
 = (*)
Ãwsh
+
hd¾’
;

230 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
ÃwËn
+1);

231 ià(
Ãwsh
 =ğ
NULL
)  NULL;

232 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

233 
	`s_ä“
(
sh
);

234 
s
 = (*)
Ãwsh
+
hd¾’
;

235 
s
[-1] = 
ty³
;

236 
	`sds£’
(
s
, 
Ën
);

238 
	`sds£Îoc
(
s
, 
ÃwËn
);

239  
s
;

240 
	}
}

248 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

249 *
sh
, *
Ãwsh
;

250 
ty³
, 
Şdty³
 = 
s
[-1] & 
SDS_TYPE_MASK
;

251 
hd¾’
, 
Şdhd¾’
 = 
	`sdsHdrSize
(
Şdty³
);

252 
size_t
 
Ën
 = 
	`sd¦’
(
s
);

253 
sh
 = (*)
s
-
Şdhd¾’
;

257 
ty³
 = 
	`sdsReqTy³
(
Ën
);

258 
hd¾’
 = 
	`sdsHdrSize
(
ty³
);

264 ià(
Şdty³
==
ty³
 ||y³ > 
SDS_TYPE_8
) {

265 
Ãwsh
 = 
	`s_»®loc
(
sh
, 
Şdhd¾’
+
Ën
+1);

266 ià(
Ãwsh
 =ğ
NULL
)  NULL;

267 
s
 = (*)
Ãwsh
+
Şdhd¾’
;

269 
Ãwsh
 = 
	`s_m®loc
(
hd¾’
+
Ën
+1);

270 ià(
Ãwsh
 =ğ
NULL
)  NULL;

271 
	`memıy
((*)
Ãwsh
+
hd¾’
, 
s
, 
Ën
+1);

272 
	`s_ä“
(
sh
);

273 
s
 = (*)
Ãwsh
+
hd¾’
;

274 
s
[-1] = 
ty³
;

275 
	`sds£’
(
s
, 
Ën
);

277 
	`sds£Îoc
(
s
, 
Ën
);

278  
s
;

279 
	}
}

288 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

289 
size_t
 
®loc
 = 
	`sd§Îoc
(
s
);

290  
	`sdsHdrSize
(
s
[-1])+
®loc
+1;

291 
	}
}

295 *
	$sdsAÎocPŒ
(
sds
 
s
) {

296  (*è(
s
-
	`sdsHdrSize
(s[-1]));

297 
	}
}

322 
	$sdsInüL’
(
sds
 
s
, 
ssize_t
 
šü
) {

323 
æags
 = 
s
[-1];

324 
size_t
 
Ën
;

325 
æags
&
SDS_TYPE_MASK
) {

326 
SDS_TYPE_5
: {

327 *
å
 = ((*)
s
)-1;

328 
ŞdËn
 = 
	`SDS_TYPE_5_LEN
(
æags
);

329 
	`as£¹
((
šü
 > 0 && 
ŞdËn
+incr < 32) || (incr < 0 && oldlen >= ()(-incr)));

330 *
å
 = 
SDS_TYPE_5
 | ((
ŞdËn
+
šü
è<< 
SDS_TYPE_BITS
);

331 
Ën
 = 
ŞdËn
+
šü
;

334 
SDS_TYPE_8
: {

335 
	`SDS_HDR_VAR
(8,
s
);

336 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

337 
Ën
 = (
sh
->ËÀ+ğ
šü
);

340 
SDS_TYPE_16
: {

341 
	`SDS_HDR_VAR
(16,
s
);

342 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= incr) || (incr < 0 && sh->len >= ()(-incr)));

343 
Ën
 = (
sh
->ËÀ+ğ
šü
);

346 
SDS_TYPE_32
: {

347 
	`SDS_HDR_VAR
(32,
s
);

348 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >= ()incr) || (incr < 0 && sh->len >= ()(-incr)));

349 
Ën
 = (
sh
->ËÀ+ğ
šü
);

352 
SDS_TYPE_64
: {

353 
	`SDS_HDR_VAR
(64,
s
);

354 
	`as£¹
((
šü
 >ğ0 && 
sh
->
®loc
-sh->
Ën
 >ğ(
ušt64_t
)incr) || (incr < 0 && sh->len >= (uint64_t)(-incr)));

355 
Ën
 = (
sh
->ËÀ+ğ
šü
);

358 : 
Ën
 = 0;

360 
s
[
Ën
] = '\0';

361 
	}
}

368 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

369 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

371 ià(
Ën
 <ğ
cu¾’
è 
s
;

372 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

373 ià(
s
 =ğ
NULL
)  NULL;

376 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

377 
	`sds£’
(
s
, 
Ën
);

378  
s
;

379 
	}
}

386 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

387 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

389 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

390 ià(
s
 =ğ
NULL
)  NULL;

391 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

392 
	`sds£’
(
s
, 
cu¾’
+
Ën
);

393 
s
[
cu¾’
+
Ën
] = '\0';

394  
s
;

395 
	}
}

401 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

402  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

403 
	}
}

409 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

410  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

411 
	}
}

415 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

416 ià(
	`sd§Îoc
(
s
è< 
Ën
) {

417 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
	`sd¦’
(s));

418 ià(
s
 =ğ
NULL
)  NULL;

420 
	`memıy
(
s
, 
t
, 
Ën
);

421 
s
[
Ën
] = '\0';

422 
	`sds£’
(
s
, 
Ën
);

423  
s
;

424 
	}
}

428 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

429  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

430 
	}
}

438 
	#SDS_LLSTR_SIZE
 21

	)

439 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

440 *
p
, 
aux
;

441 
v
;

442 
size_t
 
l
;

446 
v
 = (
v®ue
 < 0) ? -value : value;

447 
p
 = 
s
;

449 *
p
++ = '0'+(
v
%10);

450 
v
 /= 10;

451 } 
v
);

452 ià(
v®ue
 < 0è*
p
++ = '-';

455 
l
 = 
p
-
s
;

456 *
p
 = '\0';

459 
p
--;

460 
s
 < 
p
) {

461 
aux
 = *
s
;

462 *
s
 = *
p
;

463 *
p
 = 
aux
;

464 
s
++;

465 
p
--;

467  
l
;

468 
	}
}

471 
	$sdsuÎ2¡r
(*
s
, 
v
) {

472 *
p
, 
aux
;

473 
size_t
 
l
;

477 
p
 = 
s
;

479 *
p
++ = '0'+(
v
%10);

480 
v
 /= 10;

481 } 
v
);

484 
l
 = 
p
-
s
;

485 *
p
 = '\0';

488 
p
--;

489 
s
 < 
p
) {

490 
aux
 = *
s
;

491 *
s
 = *
p
;

492 *
p
 = 
aux
;

493 
s
++;

494 
p
--;

496  
l
;

497 
	}
}

503 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

504 
buf
[
SDS_LLSTR_SIZE
];

505 
Ën
 = 
	`sd¦l2¡r
(
buf
,
v®ue
);

507  
	`sd¢ewËn
(
buf
,
Ën
);

508 
	}
}

511 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

512 
va_li¡
 
ıy
;

513 
¡©icbuf
[1024], *
buf
 = sticbuf, *
t
;

514 
size_t
 
buæ’
 = 
	`¡¾’
(
fmt
)*2;

518 ià(
buæ’
 > (
¡©icbuf
)) {

519 
buf
 = 
	`s_m®loc
(
buæ’
);

520 ià(
buf
 =ğ
NULL
)  NULL;

522 
buæ’
 = (
¡©icbuf
);

528 
buf
[
buæ’
-2] = '\0';

529 
	`va_cİy
(
ıy
,
­
);

530 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

531 
	`va_’d
(
ıy
);

532 ià(
buf
[
buæ’
-2] != '\0') {

533 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

534 
buæ’
 *= 2;

535 
buf
 = 
	`s_m®loc
(
buæ’
);

536 ià(
buf
 =ğ
NULL
)  NULL;

543 
t
 = 
	`sdsÿt
(
s
, 
buf
);

544 ià(
buf
 !ğ
¡©icbuf
è
	`s_ä“
(buf);

545  
t
;

546 
	}
}

564 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

565 
va_li¡
 
­
;

566 *
t
;

567 
	`va_¡¬t
(
­
, 
fmt
);

568 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

569 
	`va_’d
(
­
);

570  
t
;

571 
	}
}

589 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

590 
size_t
 
š™Ën
 = 
	`sd¦’
(
s
);

591 cÚ¡ *
f
 = 
fmt
;

592 
i
;

593 
va_li¡
 
­
;

595 
	`va_¡¬t
(
­
,
fmt
);

596 
f
 = 
fmt
;

597 
i
 = 
š™Ën
;

598 *
f
) {

599 
Ãxt
, *
¡r
;

600 
size_t
 
l
;

601 
num
;

602 
unum
;

605 ià(
	`sd§va
(
s
)==0) {

606 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

609 *
f
) {

611 
Ãxt
 = *(
f
+1);

612 
f
++;

613 
Ãxt
) {

616 
¡r
 = 
	`va_¬g
(
­
,*);

617 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

618 ià(
	`sd§va
(
s
è< 
l
) {

619 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

621 
	`memıy
(
s
+
i
,
¡r
,
l
);

622 
	`sdsšş’
(
s
,
l
);

623 
i
 +ğ
l
;

627 ià(
Ãxt
 == 'i')

628 
num
 = 
	`va_¬g
(
­
,);

630 
num
 = 
	`va_¬g
(
­
,);

632 
buf
[
SDS_LLSTR_SIZE
];

633 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

634 ià(
	`sd§va
(
s
è< 
l
) {

635 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

637 
	`memıy
(
s
+
i
,
buf
,
l
);

638 
	`sdsšş’
(
s
,
l
);

639 
i
 +ğ
l
;

644 ià(
Ãxt
 == 'u')

645 
unum
 = 
	`va_¬g
(
­
,);

647 
unum
 = 
	`va_¬g
(
­
,);

649 
buf
[
SDS_LLSTR_SIZE
];

650 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

651 ià(
	`sd§va
(
s
è< 
l
) {

652 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

654 
	`memıy
(
s
+
i
,
buf
,
l
);

655 
	`sdsšş’
(
s
,
l
);

656 
i
 +ğ
l
;

660 
s
[
i
++] = 
Ãxt
;

661 
	`sdsšş’
(
s
,1);

666 
s
[
i
++] = *
f
;

667 
	`sdsšş’
(
s
,1);

670 
f
++;

672 
	`va_’d
(
­
);

675 
s
[
i
] = '\0';

676  
s
;

677 
	}
}

693 
sds
 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

694 *
¡¬t
, *
’d
, *
¥
, *
•
;

695 
size_t
 
Ën
;

697 
¥
 = 
¡¬t
 = 
s
;

698 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

699 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

700 
•
 > 
¥
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

701 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

702 ià(
s
 !ğ
¥
è
	`memmove
(s, sp, 
Ën
);

703 
s
[
Ën
] = '\0';

704 
	`sds£’
(
s
,
Ën
);

705  
s
;

706 
	}
}

724 
	$sd¤ªge
(
sds
 
s
, 
ssize_t
 
¡¬t
, ssize_ˆ
’d
) {

725 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

727 ià(
Ën
 == 0) ;

728 ià(
¡¬t
 < 0) {

729 
¡¬t
 = 
Ën
+start;

730 ià(
¡¬t
 < 0) start = 0;

732 ià(
’d
 < 0) {

733 
’d
 = 
Ën
+end;

734 ià(
’d
 < 0)ƒnd = 0;

736 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

737 ià(
ÃwËn
 != 0) {

738 ià(
¡¬t
 >ğ(
ssize_t
)
Ën
) {

739 
ÃwËn
 = 0;

740 } ià(
’d
 >ğ(
ssize_t
)
Ën
) {

741 
’d
 = 
Ën
-1;

742 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

745 
¡¬t
 = 0;

747 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
s
, s+start,‚ewlen);

748 
s
[
ÃwËn
] = 0;

749 
	`sds£’
(
s
,
ÃwËn
);

750 
	}
}

753 
	$sd¡Şow”
(
sds
 
s
) {

754 
size_t
 
Ën
 = 
	`sd¦’
(
s
), 
j
;

756 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

757 
	}
}

760 
	$sd¡ouµ”
(
sds
 
s
) {

761 
size_t
 
Ën
 = 
	`sd¦’
(
s
), 
j
;

763 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

764 
	}
}

777 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

778 
size_t
 
l1
, 
l2
, 
mšËn
;

779 
cmp
;

781 
l1
 = 
	`sd¦’
(
s1
);

782 
l2
 = 
	`sd¦’
(
s2
);

783 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

784 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

785 ià(
cmp
 =ğ0è 
l1
>
l2
? 1: (l1<l2? -1: 0);

786  
cmp
;

787 
	}
}

805 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
ssize_t
 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

806 
–em’ts
 = 0, 
¦Ùs
 = 5;

807 
¡¬t
 = 0, 
j
;

808 
sds
 *
tok’s
;

810 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

812 
tok’s
 = 
	`s_m®loc
((
sds
)*
¦Ùs
);

813 ià(
tok’s
 =ğ
NULL
)  NULL;

815 ià(
Ën
 == 0) {

816 *
couÁ
 = 0;

817  
tok’s
;

819 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

821 ià(
¦Ùs
 < 
–em’ts
+2) {

822 
sds
 *
Ãwtok’s
;

824 
¦Ùs
 *= 2;

825 
Ãwtok’s
 = 
	`s_»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

826 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

827 
tok’s
 = 
Ãwtok’s
;

830 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

831 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

832 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

833 
–em’ts
++;

834 
¡¬t
 = 
j
+
£¶’
;

835 
j
 = j+
£¶’
-1;

839 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

840 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

841 
–em’ts
++;

842 *
couÁ
 = 
–em’ts
;

843  
tok’s
;

845 
ş—nup
:

847 
i
;

848 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

849 
	`s_ä“
(
tok’s
);

850 *
couÁ
 = 0;

851  
NULL
;

853 
	}
}

856 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

857 ià(!
tok’s
) ;

858 
couÁ
--)

859 
	`sdsä“
(
tok’s
[
couÁ
]);

860 
	`s_ä“
(
tok’s
);

861 
	}
}

869 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

870 
s
 = 
	`sdsÿ’
(s,"\"",1);

871 
Ën
--) {

872 *
p
) {

875 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

877 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

878 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

879 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

880 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

881 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

883 ià(
	`i¥ršt
(*
p
))

884 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

886 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

889 
p
++;

891  
	`sdsÿ’
(
s
,"\"",1);

892 
	}
}

896 
	$is_hex_dig™
(
c
) {

897  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

898 (
c
 >= 'A' && c <= 'F');

899 
	}
}

903 
	$hex_dig™_to_št
(
c
) {

904 
c
) {

923 
	}
}

944 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

945 cÚ¡ *
p
 = 
lše
;

946 *
cu¼’t
 = 
NULL
;

947 **
veùÜ
 = 
NULL
;

949 *
¬gc
 = 0;

952 *
p
 && 
	`is¥aû
(*p))…++;

953 ià(*
p
) {

955 
šq
=0;

956 
šsq
=0;

957 
dÚe
=0;

959 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

960 !
dÚe
) {

961 ià(
šq
) {

962 ià(*
p
 == '\\' && *(p+1) == 'x' &&

963 
	`is_hex_dig™
(*(
p
+2)) &&

964 
	`is_hex_dig™
(*(
p
+3)))

966 
by‹
;

968 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

969 
	`hex_dig™_to_št
(*(
p
+3));

970 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

971 
p
 += 3;

972 } ià(*
p
 == '\\' && *(p+1)) {

973 
c
;

975 
p
++;

976 *
p
) {

977 'n': 
c
 = '\n'; ;

978 'r': 
c
 = '\r'; ;

979 't': 
c
 = '\t'; ;

980 'b': 
c
 = '\b'; ;

981 'a': 
c
 = '\a'; ;

982 : 
c
 = *
p
; ;

984 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

985 } ià(*
p
 == '"') {

988 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

989 
dÚe
=1;

990 } ià(!*
p
) {

992 
”r
;

994 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

996 } ià(
šsq
) {

997 ià(*
p
 == '\\' && *(p+1) == '\'') {

998 
p
++;

999 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

1000 } ià(*
p
 == '\'') {

1003 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

1004 
dÚe
=1;

1005 } ià(!*
p
) {

1007 
”r
;

1009 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1012 *
p
) {

1018 
dÚe
=1;

1021 
šq
=1;

1024 
šsq
=1;

1027 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

1031 ià(*
p
)…++;

1034 
veùÜ
 = 
	`s_»®loc
(veùÜ,((*
¬gc
)+1)*(*));

1035 
veùÜ
[*
¬gc
] = 
cu¼’t
;

1036 (*
¬gc
)++;

1037 
cu¼’t
 = 
NULL
;

1040 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`s_m®loc
((*));

1041  
veùÜ
;

1045 
”r
:

1046 (*
¬gc
)--)

1047 
	`sdsä“
(
veùÜ
[*
¬gc
]);

1048 
	`s_ä“
(
veùÜ
);

1049 ià(
cu¼’t
è
	`sdsä“
(current);

1050 *
¬gc
 = 0;

1051  
NULL
;

1052 
	}
}

1063 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

1064 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

1066 
j
 = 0; j < 
l
; j++) {

1067 
i
 = 0; i < 
£’
; i++) {

1068 ià(
s
[
j
] =ğ
äom
[
i
]) {

1069 
s
[
j
] = 
to
[
i
];

1074  
s
;

1075 
	}
}

1079 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
) {

1080 
sds
 
još
 = 
	`sd£m±y
();

1081 
j
;

1083 
j
 = 0; j < 
¬gc
; j++) {

1084 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

1085 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿt
(još,
£p
);

1087  
još
;

1088 
	}
}

1091 
sds
 
	$sdsjošsds
(
sds
 *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
) {

1092 
sds
 
još
 = 
	`sd£m±y
();

1093 
j
;

1095 
j
 = 0; j < 
¬gc
; j++) {

1096 
još
 = 
	`sdsÿtsds
(još, 
¬gv
[
j
]);

1097 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿ’
(još,
£p
,
£¶’
);

1099  
još
;

1100 
	}
}

1107 *
	$sds_m®loc
(
size_t
 
size
è{  
	`s_m®loc
(size); 
	}
}

1108 *
	$sds_»®loc
(*
±r
, 
size_t
 
size
è{  
	`s_»®loc
ÕŒ,size); 
	}
}

1109 
	$sds_ä“
(*
±r
è{ 
	`s_ä“
ÕŒ); 
	}
}

1111 #ià
defšed
(
SDS_TEST_MAIN
)

1112 
	~<¡dio.h
>

1113 
	~"‹¡h–p.h
"

1114 
	~"lim™s.h
"

1116 
	#UNUSED
(
x
è()(x)

	)

1117 
	$sdsTe¡
() {

1119 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

1121 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

1122 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

1124 
	`sdsä“
(
x
);

1125 
x
 = 
	`sd¢ewËn
("foo",2);

1126 
	`‹¡_cÚd
("Create‡ string with specified†ength",

1127 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

1129 
x
 = 
	`sdsÿt
(x,"bar");

1130 
	`‹¡_cÚd
("Strings concatenation",

1131 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

1133 
x
 = 
	`sdsıy
(x,"a");

1134 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

1135 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

1137 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

1138 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

1139 
	`sd¦’
(
x
) == 33 &&

1140 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

1142 
	`sdsä“
(
x
);

1143 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

1144 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

1145 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) == 0)

1147 
	`sdsä“
(
x
);

1148 
x
 = 
	`sd¢ew
("--");

1149 
x
 = 
	`sdsÿtfmt
(x, "H–lØ% WÜld %I,%I--", "Hi!", 
LLONG_MIN
,
LLONG_MAX
);

1150 
	`‹¡_cÚd
("sdscatfmt() seems working inhe base case",

1151 
	`sd¦’
(
x
) == 60 &&

1152 
	`memcmp
(
x
,"--Hello Hi! World -9223372036854775808,"

1154 
	`´štf
("[%s]\n",
x
);

1156 
	`sdsä“
(
x
);

1157 
x
 = 
	`sd¢ew
("--");

1158 
x
 = 
	`sdsÿtfmt
(x, "%u,%U--", 
UINT_MAX
, 
ULLONG_MAX
);

1159 
	`‹¡_cÚd
("sdscatfmt() seems working with unsigned‚umbers",

1160 
	`sd¦’
(
x
) == 35 &&

1161 
	`memcmp
(
x
,"--4294967295,18446744073709551615--",35) == 0)

1163 
	`sdsä“
(
x
);

1164 
x
 = 
	`sd¢ew
(" x ");

1165 
	`sd¡rim
(
x
," x");

1166 
	`‹¡_cÚd
("sdstrim() works when‡ll chars match",

1167 
	`sd¦’
(
x
) == 0)

1169 
	`sdsä“
(
x
);

1170 
x
 = 
	`sd¢ew
(" x ");

1171 
	`sd¡rim
(
x
," ");

1172 
	`‹¡_cÚd
("sdstrim() works when‡ single char„emains",

1173 
	`sd¦’
(
x
) == 1 && x[0] == 'x')

1175 
	`sdsä“
(
x
);

1176 
x
 = 
	`sd¢ew
("xxciaoyyy");

1177 
	`sd¡rim
(
x
,"xy");

1178 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1179 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1181 
y
 = 
	`sdsdup
(
x
);

1182 
	`sd¤ªge
(
y
,1,1);

1183 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1184 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1186 
	`sdsä“
(
y
);

1187 
y
 = 
	`sdsdup
(
x
);

1188 
	`sd¤ªge
(
y
,1,-1);

1189 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1190 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1192 
	`sdsä“
(
y
);

1193 
y
 = 
	`sdsdup
(
x
);

1194 
	`sd¤ªge
(
y
,-2,-1);

1195 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1196 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1198 
	`sdsä“
(
y
);

1199 
y
 = 
	`sdsdup
(
x
);

1200 
	`sd¤ªge
(
y
,2,1);

1201 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1202 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1204 
	`sdsä“
(
y
);

1205 
y
 = 
	`sdsdup
(
x
);

1206 
	`sd¤ªge
(
y
,1,100);

1207 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1208 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1210 
	`sdsä“
(
y
);

1211 
y
 = 
	`sdsdup
(
x
);

1212 
	`sd¤ªge
(
y
,100,100);

1213 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1214 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1216 
	`sdsä“
(
y
);

1217 
	`sdsä“
(
x
);

1218 
x
 = 
	`sd¢ew
("foo");

1219 
y
 = 
	`sd¢ew
("foa");

1220 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1222 
	`sdsä“
(
y
);

1223 
	`sdsä“
(
x
);

1224 
x
 = 
	`sd¢ew
("bar");

1225 
y
 = 
	`sd¢ew
("bar");

1226 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1228 
	`sdsä“
(
y
);

1229 
	`sdsä“
(
x
);

1230 
x
 = 
	`sd¢ew
("aar");

1231 
y
 = 
	`sd¢ew
("bar");

1232 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1234 
	`sdsä“
(
y
);

1235 
	`sdsä“
(
x
);

1236 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1237 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1238 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1239 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1242 
Şdä“
;

1243 *
p
;

1244 
¡•
 = 10, 
j
, 
i
;

1246 
	`sdsä“
(
x
);

1247 
	`sdsä“
(
y
);

1248 
x
 = 
	`sd¢ew
("0");

1249 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
	`sd¦’
(
x
è=ğ1 && 
	`sd§va
(x) == 0);

1253 
i
 = 0; i < 10; i++) {

1254 
ŞdËn
 = 
	`sd¦’
(
x
);

1255 
x
 = 
	`sdsMakeRoomFÜ
(x,
¡•
);

1256 
ty³
 = 
x
[-1]&
SDS_TYPE_MASK
;

1258 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èËn", 
	`sd¦’
(
x
è=ğ
ŞdËn
);

1259 ià(
ty³
 !ğ
SDS_TYPE_5
) {

1260 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èä“", 
	`sd§va
(
x
è>ğ
¡•
);

1261 
Şdä“
 = 
	`sd§va
(
x
);

1263 
p
 = 
x
+
ŞdËn
;

1264 
j
 = 0; j < 
¡•
; j++) {

1265 
p
[
j
] = 'A'+j;

1267 
	`sdsInüL’
(
x
,
¡•
);

1269 
	`‹¡_cÚd
("sdsMakeRoomFor() content",

1270 
	`memcmp
("0ABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJ",
x
,101) == 0);

1271 
	`‹¡_cÚd
("sdsMakeRoomFÜ(èfš®†’gth",
	`sd¦’
(
x
)==101);

1273 
	`sdsä“
(
x
);

1276 
	`‹¡_»pÜt
()

1278 
	}
}

1281 #ifdeà
SDS_TEST_MAIN


1282 
	$maš
() {

1283  
	`sdsTe¡
();

1284 
	}
}

	@src/sds.h

33 #iâdeà
__SDS_H


34 
	#__SDS_H


	)

36 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

38 
	~<sys/ty³s.h
>

39 
	~<¡d¬g.h
>

40 
	~<¡dšt.h
>

42 *
	tsds
;

46 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr5
 {

47 
	gæags
;

48 
	gbuf
[];

50 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr8
 {

51 
ušt8_t
 
	gËn
;

52 
ušt8_t
 
	g®loc
;

53 
	gæags
;

54 
	gbuf
[];

56 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr16
 {

57 
ušt16_t
 
	gËn
;

58 
ušt16_t
 
	g®loc
;

59 
	gæags
;

60 
	gbuf
[];

62 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr32
 {

63 
ušt32_t
 
	gËn
;

64 
ušt32_t
 
	g®loc
;

65 
	gæags
;

66 
	gbuf
[];

68 
__©Œibu‹__
 ((
__·cked__
)è
	gsdshdr64
 {

69 
ušt64_t
 
	gËn
;

70 
ušt64_t
 
	g®loc
;

71 
	gæags
;

72 
	gbuf
[];

75 
	#SDS_TYPE_5
 0

	)

76 
	#SDS_TYPE_8
 1

	)

77 
	#SDS_TYPE_16
 2

	)

78 
	#SDS_TYPE_32
 3

	)

79 
	#SDS_TYPE_64
 4

	)

80 
	#SDS_TYPE_MASK
 7

	)

81 
	#SDS_TYPE_BITS
 3

	)

82 
	#SDS_HDR_VAR
(
T
,
s
è
sdshdr
##T *
sh
 = (*)((s)-((sdshdr##T)));

	)

83 
	#SDS_HDR
(
T
,
s
è((
sdshdr
##T *)((s)-((sdshdr##T))))

	)

84 
	#SDS_TYPE_5_LEN
(
f
è((f)>>
SDS_TYPE_BITS
)

	)

86 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

87 
æags
 = 
s
[-1];

88 
æags
&
SDS_TYPE_MASK
) {

89 
SDS_TYPE_5
:

90  
	`SDS_TYPE_5_LEN
(
æags
);

91 
SDS_TYPE_8
:

92  
	`SDS_HDR
(8,
s
)->
Ën
;

93 
SDS_TYPE_16
:

94  
	`SDS_HDR
(16,
s
)->
Ën
;

95 
SDS_TYPE_32
:

96  
	`SDS_HDR
(32,
s
)->
Ën
;

97 
SDS_TYPE_64
:

98  
	`SDS_HDR
(64,
s
)->
Ën
;

101 
	}
}

103 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

104 
æags
 = 
s
[-1];

105 
æags
&
SDS_TYPE_MASK
) {

106 
SDS_TYPE_5
: {

109 
SDS_TYPE_8
: {

110 
	`SDS_HDR_VAR
(8,
s
);

111  
sh
->
®loc
 - sh->
Ën
;

113 
SDS_TYPE_16
: {

114 
	`SDS_HDR_VAR
(16,
s
);

115  
sh
->
®loc
 - sh->
Ën
;

117 
SDS_TYPE_32
: {

118 
	`SDS_HDR_VAR
(32,
s
);

119  
sh
->
®loc
 - sh->
Ën
;

121 
SDS_TYPE_64
: {

122 
	`SDS_HDR_VAR
(64,
s
);

123  
sh
->
®loc
 - sh->
Ën
;

127 
	}
}

129 
šlše
 
	$sds£’
(
sds
 
s
, 
size_t
 
ÃwËn
) {

130 
æags
 = 
s
[-1];

131 
æags
&
SDS_TYPE_MASK
) {

132 
SDS_TYPE_5
:

134 *
å
 = ((*)
s
)-1;

135 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

138 
SDS_TYPE_8
:

139 
	`SDS_HDR
(8,
s
)->
Ën
 = 
ÃwËn
;

141 
SDS_TYPE_16
:

142 
	`SDS_HDR
(16,
s
)->
Ën
 = 
ÃwËn
;

144 
SDS_TYPE_32
:

145 
	`SDS_HDR
(32,
s
)->
Ën
 = 
ÃwËn
;

147 
SDS_TYPE_64
:

148 
	`SDS_HDR
(64,
s
)->
Ën
 = 
ÃwËn
;

151 
	}
}

153 
šlše
 
	$sdsšş’
(
sds
 
s
, 
size_t
 
šc
) {

154 
æags
 = 
s
[-1];

155 
æags
&
SDS_TYPE_MASK
) {

156 
SDS_TYPE_5
:

158 *
å
 = ((*)
s
)-1;

159 
ÃwËn
 = 
	`SDS_TYPE_5_LEN
(
æags
)+
šc
;

160 *
å
 = 
SDS_TYPE_5
 | (
ÃwËn
 << 
SDS_TYPE_BITS
);

163 
SDS_TYPE_8
:

164 
	`SDS_HDR
(8,
s
)->
Ën
 +ğ
šc
;

166 
SDS_TYPE_16
:

167 
	`SDS_HDR
(16,
s
)->
Ën
 +ğ
šc
;

169 
SDS_TYPE_32
:

170 
	`SDS_HDR
(32,
s
)->
Ën
 +ğ
šc
;

172 
SDS_TYPE_64
:

173 
	`SDS_HDR
(64,
s
)->
Ën
 +ğ
šc
;

176 
	}
}

179 
šlše
 
size_t
 
	$sd§Îoc
(cÚ¡ 
sds
 
s
) {

180 
æags
 = 
s
[-1];

181 
æags
&
SDS_TYPE_MASK
) {

182 
SDS_TYPE_5
:

183  
	`SDS_TYPE_5_LEN
(
æags
);

184 
SDS_TYPE_8
:

185  
	`SDS_HDR
(8,
s
)->
®loc
;

186 
SDS_TYPE_16
:

187  
	`SDS_HDR
(16,
s
)->
®loc
;

188 
SDS_TYPE_32
:

189  
	`SDS_HDR
(32,
s
)->
®loc
;

190 
SDS_TYPE_64
:

191  
	`SDS_HDR
(64,
s
)->
®loc
;

194 
	}
}

196 
šlše
 
	$sds£Îoc
(
sds
 
s
, 
size_t
 
ÃwËn
) {

197 
æags
 = 
s
[-1];

198 
æags
&
SDS_TYPE_MASK
) {

199 
SDS_TYPE_5
:

202 
SDS_TYPE_8
:

203 
	`SDS_HDR
(8,
s
)->
®loc
 = 
ÃwËn
;

205 
SDS_TYPE_16
:

206 
	`SDS_HDR
(16,
s
)->
®loc
 = 
ÃwËn
;

208 
SDS_TYPE_32
:

209 
	`SDS_HDR
(32,
s
)->
®loc
 = 
ÃwËn
;

211 
SDS_TYPE_64
:

212 
	`SDS_HDR
(64,
s
)->
®loc
 = 
ÃwËn
;

215 
	}
}

217 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

218 
sds
 
sd¢ew
(cÚ¡ *
š™
);

219 
sds
 
sd£m±y
();

220 
sds
 
sdsdup
(cÚ¡ sd 
s
);

221 
sdsä“
(
sds
 
s
);

222 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

223 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

224 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

225 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

226 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

227 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

229 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

230 #ifdeà
__GNUC__


231 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

232 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

234 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

237 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

238 
sds
 
	`sd¡rim
(sd 
s
, cÚ¡ *
c£t
);

239 
	`sd¤ªge
(
sds
 
s
, 
ssize_t
 
¡¬t
, ssize_ˆ
’d
);

240 
	`sdsupd©–’
(
sds
 
s
);

241 
	`sdsş—r
(
sds
 
s
);

242 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

243 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
ssize_t
 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

244 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

245 
	`sd¡Şow”
(
sds
 
s
);

246 
	`sd¡ouµ”
(
sds
 
s
);

247 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

248 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

249 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

250 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

251 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
);

252 
sds
 
	`sdsjošsds
(sd *
¬gv
, 
¬gc
, cÚ¡ *
£p
, 
size_t
 
£¶’
);

255 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

256 
	`sdsInüL’
(
sds
 
s
, 
ssize_t
 
šü
);

257 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

258 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

259 *
	`sdsAÎocPŒ
(
sds
 
s
);

265 *
	`sds_m®loc
(
size_t
 
size
);

266 *
	`sds_»®loc
(*
±r
, 
size_t
 
size
);

267 
	`sds_ä“
(*
±r
);

269 #ifdeà
REDIS_TEST


270 
	`sdsTe¡
(
¬gc
, *
¬gv
[]);

	@src/sdsalloc.h

39 
	~"zm®loc.h
"

40 
	#s_m®loc
 
zm®loc


	)

41 
	#s_»®loc
 
z»®loc


	)

42 
	#s_ä“
 
zä“


	)

	@src/sentinel.c

31 
	~"£rv”.h
"

32 
	~"hœedis.h
"

33 
	~"async.h
"

35 
	~<ùy³.h
>

36 
	~<¬·/š‘.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/wa™.h
>

39 
	~<fú.h
>

41 **
’vœÚ
;

43 
	#REDIS_SENTINEL_PORT
 26379

	)

48 
	s£Áš–Addr
 {

49 *
	m
;

50 
	mpÜt
;

51 } 
	t£Áš–Addr
;

54 
	#SRI_MASTER
 (1<<0)

	)

55 
	#SRI_SLAVE
 (1<<1)

	)

56 
	#SRI_SENTINEL
 (1<<2)

	)

57 
	#SRI_S_DOWN
 (1<<3è

	)

58 
	#SRI_O_DOWN
 (1<<4è

	)

59 
	#SRI_MASTER_DOWN
 (1<<5è

	)

61 
	#SRI_FAILOVER_IN_PROGRESS
 (1<<6è

	)

63 
	#SRI_PROMOTED
 (1<<7è

	)

64 
	#SRI_RECONF_SENT
 (1<<8è

	)

65 
	#SRI_RECONF_INPROG
 (1<<9è

	)

66 
	#SRI_RECONF_DONE
 (1<<10è

	)

67 
	#SRI_FORCE_FAILOVER
 (1<<11è

	)

68 
	#SRI_SCRIPT_KILL_SENT
 (1<<12è

	)

71 
	#SENTINEL_INFO_PERIOD
 10000

	)

72 
	#SENTINEL_PING_PERIOD
 1000

	)

73 
	#SENTINEL_ASK_PERIOD
 1000

	)

74 
	#SENTINEL_PUBLISH_PERIOD
 2000

	)

75 
	#SENTINEL_DEFAULT_DOWN_AFTER
 30000

	)

76 
	#SENTINEL_HELLO_CHANNEL
 "__£Áš–__:h–lo"

	)

77 
	#SENTINEL_TILT_TRIGGER
 2000

	)

78 
	#SENTINEL_TILT_PERIOD
 (
SENTINEL_PING_PERIOD
*30)

	)

79 
	#SENTINEL_DEFAULT_SLAVE_PRIORITY
 100

	)

80 
	#SENTINEL_SLAVE_RECONF_TIMEOUT
 10000

	)

81 
	#SENTINEL_DEFAULT_PARALLEL_SYNCS
 1

	)

82 
	#SENTINEL_MIN_LINK_RECONNECT_PERIOD
 15000

	)

83 
	#SENTINEL_DEFAULT_FAILOVER_TIMEOUT
 (60*3*1000)

	)

84 
	#SENTINEL_MAX_PENDING_COMMANDS
 100

	)

85 
	#SENTINEL_ELECTION_TIMEOUT
 10000

	)

86 
	#SENTINEL_MAX_DESYNC
 1000

	)

89 
	#SENTINEL_FAILOVER_STATE_NONE
 0

	)

90 
	#SENTINEL_FAILOVER_STATE_WAIT_START
 1

	)

91 
	#SENTINEL_FAILOVER_STATE_SELECT_SLAVE
 2

	)

92 
	#SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
 3

	)

93 
	#SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
 4

	)

94 
	#SENTINEL_FAILOVER_STATE_RECONF_SLAVES
 5

	)

95 
	#SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
 6

	)

97 
	#SENTINEL_MASTER_LINK_STATUS_UP
 0

	)

98 
	#SENTINEL_MASTER_LINK_STATUS_DOWN
 1

	)

103 
	#SENTINEL_NO_FLAGS
 0

	)

104 
	#SENTINEL_GENERATE_EVENT
 (1<<16)

	)

105 
	#SENTINEL_LEADER
 (1<<17)

	)

106 
	#SENTINEL_OBSERVER
 (1<<18)

	)

109 
	#SENTINEL_SCRIPT_NONE
 0

	)

110 
	#SENTINEL_SCRIPT_RUNNING
 1

	)

111 
	#SENTINEL_SCRIPT_MAX_QUEUE
 256

	)

112 
	#SENTINEL_SCRIPT_MAX_RUNNING
 16

	)

113 
	#SENTINEL_SCRIPT_MAX_RUNTIME
 60000

	)

114 
	#SENTINEL_SCRIPT_MAX_RETRY
 10

	)

115 
	#SENTINEL_SCRIPT_RETRY_DELAY
 30000

	)

118 
	#SENTINEL_SIMFAILURE_NONE
 0

	)

119 
	#SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION
 (1<<0)

	)

120 
	#SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION
 (1<<1)

	)

136 
	sš¡ªûLšk
 {

137 
	m»fcouÁ
;

138 
	mdiscÚÃùed
;

139 
	m³ndšg_commªds
;

140 
»disAsyncCÚ‹xt
 *
	mcc
;

141 
»disAsyncCÚ‹xt
 *
	mpc
;

142 
m¡ime_t
 
	mcc_cÚn_time
;

143 
m¡ime_t
 
	mpc_cÚn_time
;

144 
m¡ime_t
 
	mpc_Ï¡_aùiv™y
;

145 
m¡ime_t
 
	mÏ¡_ava_time
;

147 
m¡ime_t
 
	maù_pšg_time
;

152 
m¡ime_t
 
	mÏ¡_pšg_time
;

156 
m¡ime_t
 
	mÏ¡_pÚg_time
;

159 
m¡ime_t
 
	mÏ¡_»cÚn_time
;

161 } 
	tš¡ªûLšk
;

163 
	s£Áš–RedisIn¡ªû
 {

164 
	mæags
;

165 *
	mÇme
;

166 *
	mrunid
;

167 
ušt64_t
 
	mcÚfig_•och
;

168 
£Áš–Addr
 *
	maddr
;

169 
š¡ªûLšk
 *
	mlšk
;

170 
m¡ime_t
 
	mÏ¡_pub_time
;

171 
m¡ime_t
 
	mÏ¡_h–lo_time
;

174 
m¡ime_t
 
	mÏ¡_ma¡”_down_»¶y_time
;

176 
m¡ime_t
 
	ms_down_sšû_time
;

177 
m¡ime_t
 
	mo_down_sšû_time
;

178 
m¡ime_t
 
	mdown_aá”_³riod
;

179 
m¡ime_t
 
	mšfo_»äesh
;

186 
	mrŞe_»pÜ‹d
;

187 
m¡ime_t
 
	mrŞe_»pÜ‹d_time
;

188 
m¡ime_t
 
	m¦ave_cÚf_chªge_time
;

191 
diù
 *
	m£Áš–s
;

192 
diù
 *
	m¦aves
;

193 
	mquÜum
;

194 
	m·¿Î–_syncs
;

195 *
	mauth_·ss
;

198 
m¡ime_t
 
	mma¡”_lšk_down_time
;

199 
	m¦ave_´iÜ™y
;

200 
m¡ime_t
 
	m¦ave_»cÚf_£Á_time
;

201 
£Áš–RedisIn¡ªû
 *
	mma¡”
;

202 *
	m¦ave_ma¡”_ho¡
;

203 
	m¦ave_ma¡”_pÜt
;

204 
	m¦ave_ma¡”_lšk_¡©us
;

205 
	m¦ave_»¶_off£t
;

207 *
	mËad”
;

211 
ušt64_t
 
	mËad”_•och
;

212 
ušt64_t
 
	mçov”_•och
;

213 
	mçov”_¡©e
;

214 
m¡ime_t
 
	mçov”_¡©e_chªge_time
;

215 
m¡ime_t
 
	mçov”_¡¬t_time
;

216 
m¡ime_t
 
	mçov”_timeout
;

217 
m¡ime_t
 
	mçov”_d–ay_logged
;

219 
£Áš–RedisIn¡ªû
 *
	m´omÙed_¦ave
;

222 *
	mnÙifiÿtiÚ_süt
;

223 *
	mş›Á_»cÚfig_süt
;

224 
sds
 
	mšfo
;

225 } 
	t£Áš–RedisIn¡ªû
;

228 
	s£Áš–S‹
 {

229 
	mmyid
[
CONFIG_RUN_ID_SIZE
+1];

230 
ušt64_t
 
	mcu¼’t_•och
;

231 
diù
 *
	mma¡”s
;

234 
	mtt
;

235 
	mruÂšg_süts
;

236 
m¡ime_t
 
	mtt_¡¬t_time
;

237 
m¡ime_t
 
	m´evious_time
;

238 
li¡
 *
	msüts_queue
;

239 *
	mªnounû_
;

241 
	mªnounû_pÜt
;

243 
	msimçu»_æags
;

244 } 
	g£Áš–
;

247 
	s£Áš–SütJob
 {

248 
	mæags
;

249 
	m»Œy_num
;

250 **
	m¬gv
;

251 
m¡ime_t
 
	m¡¬t_time
;

256 
pid_t
 
	mpid
;

257 } 
	t£Áš–SütJob
;

264 
	s»disAeEv’ts
 {

265 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

266 
«Ev’tLoİ
 *
	mloİ
;

267 
	mfd
;

268 
	m»adšg
, 
	mwr™šg
;

269 } 
	t»disAeEv’ts
;

271 
	$»disAeR—dEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

272 (()
–
); (()
fd
); (()
mask
);

274 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

275 
	`»disAsyncHªdËR—d
(
e
->
cÚ‹xt
);

276 
	}
}

278 
	$»disAeWr™eEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

279 (()
–
); (()
fd
); (()
mask
);

281 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

282 
	`»disAsyncHªdËWr™e
(
e
->
cÚ‹xt
);

283 
	}
}

285 
	$»disAeAddR—d
(*
´ivd©a
) {

286 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

287 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

288 ià(!
e
->
»adšg
) {

289 
e
->
»adšg
 = 1;

290 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
,
»disAeR—dEv’t
,e);

292 
	}
}

294 
	$»disAeD–R—d
(*
´ivd©a
) {

295 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

296 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

297 ià(
e
->
»adšg
) {

298 
e
->
»adšg
 = 0;

299 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
);

301 
	}
}

303 
	$»disAeAddWr™e
(*
´ivd©a
) {

304 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

305 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

306 ià(!
e
->
wr™šg
) {

307 
e
->
wr™šg
 = 1;

308 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
,
»disAeWr™eEv’t
,e);

310 
	}
}

312 
	$»disAeD–Wr™e
(*
´ivd©a
) {

313 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

314 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

315 ià(
e
->
wr™šg
) {

316 
e
->
wr™šg
 = 0;

317 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
);

319 
	}
}

321 
	$»disAeCËªup
(*
´ivd©a
) {

322 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

323 
	`»disAeD–R—d
(
´ivd©a
);

324 
	`»disAeD–Wr™e
(
´ivd©a
);

325 
	`zä“
(
e
);

326 
	}
}

328 
	$»disAeA‰ach
(
«Ev’tLoİ
 *
loİ
, 
»disAsyncCÚ‹xt
 *
ac
) {

329 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

330 
»disAeEv’ts
 *
e
;

333 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

334  
C_ERR
;

337 
e
 = (
»disAeEv’ts
*)
	`zm®loc
((*e));

338 
e
->
cÚ‹xt
 = 
ac
;

339 
e
->
loİ
 =†oop;

340 
e
->
fd
 = 
c
->fd;

341 
e
->
»adšg
 =ƒ->
wr™šg
 = 0;

344 
ac
->
ev
.
addR—d
 = 
»disAeAddR—d
;

345 
ac
->
ev
.
d–R—d
 = 
»disAeD–R—d
;

346 
ac
->
ev
.
addWr™e
 = 
»disAeAddWr™e
;

347 
ac
->
ev
.
d–Wr™e
 = 
»disAeD–Wr™e
;

348 
ac
->
ev
.
ş—nup
 = 
»disAeCËªup
;

349 
ac
->
ev
.
d©a
 = 
e
;

351  
C_OK
;

352 
	}
}

356 
£Áš–LškE¡ablishedC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
);

357 
£Áš–DiscÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
);

358 
£Áš–ReûiveH–loMes§ges
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
);

359 
£Áš–RedisIn¡ªû
 *
£Áš–G‘Ma¡”ByName
(*
Çme
);

360 *
£Áš–G‘SubjeùiveL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

361 *
£Áš–G‘ObjeùiveL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

362 
ye¢Ùoi
(*
s
);

363 
š¡ªûLškCÚÃùiÚE¼Ü
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
);

364 cÚ¡ *
£Áš–RedisIn¡ªûTy³SŒ
(
£Áš–RedisIn¡ªû
 *
ri
);

365 
£Áš–AbÜtFaov”
(
£Áš–RedisIn¡ªû
 *
ri
);

366 
£Áš–Ev’t
(
Ëv–
, *
ty³
, 
£Áš–RedisIn¡ªû
 *
ri
, cÚ¡ *
fmt
, ...);

367 
£Áš–RedisIn¡ªû
 *
£Áš–S–eùSÏve
(£Áš–RedisIn¡ªû *
ma¡”
);

368 
£Áš–ScheduËSütExecutiÚ
(*
·th
, ...);

369 
£Áš–S¹Faov”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

370 
£Áš–DisÿrdR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
);

371 
£Áš–S’dSÏveOf
(
£Áš–RedisIn¡ªû
 *
ri
, *
ho¡
, 
pÜt
);

372 *
£Áš–VÙeL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
»q_•och
, *
»q_runid
, ušt64_ˆ*
Ëad”_•och
);

373 
£Áš–FlushCÚfig
();

374 
£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
();

375 
£Áš–S’dPšg
(
£Áš–RedisIn¡ªû
 *
ri
);

376 
£Áš–FÜûH–loUpd©eFÜMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

377 
£Áš–RedisIn¡ªû
 *
g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
diù
 *
š¡ªûs
, *

, 
pÜt
, *
runid
);

378 
£Áš–SimFau»C¿sh
();

382 
ušt64_t
 
diùSdsHash
(cÚ¡ *
key
);

383 
diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

384 
»Ëa£S’tš–RedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
);

386 
	$diùIn¡ªûsV®De¡ruùÜ
 (*
´ivd©a
, *
obj
) {

387 
	`UNUSED
(
´ivd©a
);

388 
	`»Ëa£S’tš–RedisIn¡ªû
(
obj
);

389 
	}
}

395 
diùTy³
 
	gš¡ªûsDiùTy³
 = {

396 
diùSdsHash
,

397 
NULL
,

398 
NULL
,

399 
diùSdsKeyCom·»
,

400 
NULL
,

401 
diùIn¡ªûsV®De¡ruùÜ


408 
diùTy³
 
	gËad”VÙesDiùTy³
 = {

409 
diùSdsHash
,

410 
NULL
,

411 
NULL
,

412 
diùSdsKeyCom·»
,

413 
NULL
,

414 
NULL


419 
£Áš–Commªd
(
ş›Á
 *
c
);

420 
£Áš–InfoCommªd
(
ş›Á
 *
c
);

421 
£Áš–S‘Commªd
(
ş›Á
 *
c
);

422 
£Áš–PublishCommªd
(
ş›Á
 *
c
);

423 
£Áš–RŞeCommªd
(
ş›Á
 *
c
);

425 
»disCommªd
 
	g£Áš–cmds
[] = {

426 {"pšg",
pšgCommªd
,1,"",0,
NULL
,0,0,0,0,0},

427 {"£Áš–",
£Áš–Commªd
,-2,"",0,
NULL
,0,0,0,0,0},

428 {"subsüibe",
subsüibeCommªd
,-2,"",0,
NULL
,0,0,0,0,0},

429 {"unsubsüibe",
unsubsüibeCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

430 {"psubsüibe",
psubsüibeCommªd
,-2,"",0,
NULL
,0,0,0,0,0},

431 {"punsubsüibe",
punsubsüibeCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

432 {"publish",
£Áš–PublishCommªd
,3,"",0,
NULL
,0,0,0,0,0},

433 {"šfo",
£Áš–InfoCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

434 {"rŞe",
£Áš–RŞeCommªd
,1,"l",0,
NULL
,0,0,0,0,0},

435 {"ş›Á",
ş›ÁCommªd
,-2,"rs",0,
NULL
,0,0,0,0,0},

436 {"shutdown",
shutdownCommªd
,-1,"",0,
NULL
,0,0,0,0,0}

441 
	$š™S’tš–CÚfig
() {

442 
£rv”
.
pÜt
 = 
REDIS_SENTINEL_PORT
;

443 
	}
}

446 
	$š™S’tš–
() {

447 
j
;

451 
	`diùEm±y
(
£rv”
.
commªds
,
NULL
);

452 
j
 = 0; j < (
£Áš–cmds
)/(sentinelcmds[0]); j++) {

453 
»tv®
;

454 
»disCommªd
 *
cmd
 = 
£Áš–cmds
+
j
;

456 
»tv®
 = 
	`diùAdd
(
£rv”
.
commªds
, 
	`sd¢ew
(
cmd
->
Çme
), cmd);

457 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

461 
£Áš–
.
cu¼’t_•och
 = 0;

462 
£Áš–
.
ma¡”s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

463 
£Áš–
.
tt
 = 0;

464 
£Áš–
.
tt_¡¬t_time
 = 0;

465 
£Áš–
.
´evious_time
 = 
	`m¡ime
();

466 
£Áš–
.
ruÂšg_süts
 = 0;

467 
£Áš–
.
süts_queue
 = 
	`li¡C»©e
();

468 
£Áš–
.
ªnounû_
 = 
NULL
;

469 
£Áš–
.
ªnounû_pÜt
 = 0;

470 
£Áš–
.
simçu»_æags
 = 
SENTINEL_SIMFAILURE_NONE
;

471 
	`mem£t
(
£Áš–
.
myid
,0,(sentinel.myid));

472 
	}
}

476 
	$£Áš–IsRuÂšg
() {

477 
j
;

479 ià(
£rv”
.
cÚfigfe
 =ğ
NULL
) {

480 
	`£rv”Log
(
LL_WARNING
,

482 
	`ex™
(1);

483 } ià(
	`acûss
(
£rv”
.
cÚfigfe
,
W_OK
) == -1) {

484 
	`£rv”Log
(
LL_WARNING
,

486 
£rv”
.
cÚfigfe
,
	`¡»¼Ü
(
”ºo
));

487 
	`ex™
(1);

493 
j
 = 0; j < 
CONFIG_RUN_ID_SIZE
; j++)

494 ià(
£Áš–
.
myid
[
j
] != 0) ;

496 ià(
j
 =ğ
CONFIG_RUN_ID_SIZE
) {

498 
	`g‘RªdomHexCh¬s
(
£Áš–
.
myid
,
CONFIG_RUN_ID_SIZE
);

499 
	`£Áš–FlushCÚfig
();

503 
	`£rv”Log
(
LL_WARNING
,"S’tš– ID i %s", 
£Áš–
.
myid
);

507 
	`£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
();

508 
	}
}

517 
£Áš–Addr
 *
	$ü—‹S’tš–Addr
(*
ho¡Çme
, 
pÜt
) {

518 

[
NET_IP_STR_LEN
];

519 
£Áš–Addr
 *
§
;

521 ià(
pÜt
 < 0 ||…ort > 65535) {

522 
”ºo
 = 
EINVAL
;

523  
NULL
;

525 ià(
	`ª‘ResŞve
(
NULL
,
ho¡Çme
,

,()è=ğ
ANET_ERR
) {

526 
”ºo
 = 
ENOENT
;

527  
NULL
;

529 
§
 = 
	`zm®loc
((*sa));

530 
§
->

 = 
	`sd¢ew
(ip);

531 
§
->
pÜt
 =…ort;

532  
§
;

533 
	}
}

536 
£Áš–Addr
 *
	$dupS’tš–Addr
(
£Áš–Addr
 *
¤c
) {

537 
£Áš–Addr
 *
§
;

539 
§
 = 
	`zm®loc
((*sa));

540 
§
->

 = 
	`sd¢ew
(
¤c
->ip);

541 
§
->
pÜt
 = 
¤c
->port;

542  
§
;

543 
	}
}

546 
	$»Ëa£S’tš–Addr
(
£Áš–Addr
 *
§
) {

547 
	`sdsä“
(
§
->

);

548 
	`zä“
(
§
);

549 
	}
}

552 
	$£Áš–AddrIsEqu®
(
£Áš–Addr
 *
a
, s’tš–Add¸*
b
) {

553  
a
->
pÜt
 =ğ
b
->pÜˆ&& !
	`¡rÿ£cmp
×->

,b->ip);

554 
	}
}

582 
	$£Áš–Ev’t
(
Ëv–
, *
ty³
, 
£Áš–RedisIn¡ªû
 *
ri
,

583 cÚ¡ *
fmt
, ...) {

584 
va_li¡
 
­
;

585 
msg
[
LOG_MAX_LEN
];

586 
robj
 *
chªÃl
, *
·ylßd
;

589 ià(
fmt
[0] == '%' && fmt[1] == '@') {

590 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?

591 
NULL
 : 
ri
->
ma¡”
;

593 ià(
ma¡”
) {

594 
	`¢´štf
(
msg
, (msg), "%s %s %s %d @ %s %s %d",

595 
	`£Áš–RedisIn¡ªûTy³SŒ
(
ri
),

596 
ri
->
Çme
,„i->
addr
->

,„i->addr->
pÜt
,

597 
ma¡”
->
Çme
, ma¡”->
addr
->

, ma¡”->addr->
pÜt
);

599 
	`¢´štf
(
msg
, (msg), "%s %s %s %d",

600 
	`£Áš–RedisIn¡ªûTy³SŒ
(
ri
),

601 
ri
->
Çme
,„i->
addr
->

,„i->addr->
pÜt
);

603 
fmt
 += 2;

605 
msg
[0] = '\0';

609 ià(
fmt
[0] != '\0') {

610 
	`va_¡¬t
(
­
, 
fmt
);

611 
	`v¢´štf
(
msg
+
	`¡¾’
(msg), (msg)-¡¾’(msg), 
fmt
, 
­
);

612 
	`va_’d
(
­
);

616 ià(
Ëv–
 >ğ
£rv”
.
v”bos™y
)

617 
	`£rv”Log
(
Ëv–
,"% %s",
ty³
,
msg
);

620 ià(
Ëv–
 !ğ
LL_DEBUG
) {

621 
chªÃl
 = 
	`ü—‹SŒšgObjeù
(
ty³
,
	`¡¾’
(type));

622 
·ylßd
 = 
	`ü—‹SŒšgObjeù
(
msg
,
	`¡¾’
(msg));

623 
	`pubsubPublishMes§ge
(
chªÃl
,
·ylßd
);

624 
	`deüRefCouÁ
(
chªÃl
);

625 
	`deüRefCouÁ
(
·ylßd
);

629 ià(
Ëv–
 =ğ
LL_WARNING
 && 
ri
 !ğ
NULL
) {

630 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?

631 
ri
 :„i->
ma¡”
;

632 ià(
ma¡”
 && ma¡”->
nÙifiÿtiÚ_süt
) {

633 
	`£Áš–ScheduËSütExecutiÚ
(
ma¡”
->
nÙifiÿtiÚ_süt
,

634 
ty³
,
msg
,
NULL
);

637 
	}
}

643 
	$£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
() {

644 
diùI‹¿tÜ
 *
di
;

645 
diùEÁry
 *
de
;

647 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

648 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

649 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

650 
	`£Áš–Ev’t
(
LL_WARNING
,"+mÚ™Ü",
ri
,"%@ quÜum %d",ri->
quÜum
);

652 
	`diùR–—£I‹¿tÜ
(
di
);

653 
	}
}

658 
	$£Áš–R–—£SütJob
(
£Áš–SütJob
 *
sj
) {

659 
j
 = 0;

661 
sj
->
¬gv
[
j
]è
	`sdsä“
(sj->argv[j++]);

662 
	`zä“
(
sj
->
¬gv
);

663 
	`zä“
(
sj
);

664 
	}
}

666 
	#SENTINEL_SCRIPT_MAX_ARGS
 16

	)

667 
	$£Áš–ScheduËSütExecutiÚ
(*
·th
, ...) {

668 
va_li¡
 
­
;

669 *
¬gv
[
SENTINEL_SCRIPT_MAX_ARGS
+1];

670 
¬gc
 = 1;

671 
£Áš–SütJob
 *
sj
;

673 
	`va_¡¬t
(
­
, 
·th
);

674 
¬gc
 < 
SENTINEL_SCRIPT_MAX_ARGS
) {

675 
¬gv
[
¬gc
] = 
	`va_¬g
(
­
,*);

676 ià(!
¬gv
[
¬gc
]) ;

677 
¬gv
[
¬gc
] = 
	`sd¢ew
(argv[argc]);

678 
¬gc
++;

680 
	`va_’d
(
­
);

681 
¬gv
[0] = 
	`sd¢ew
(
·th
);

683 
sj
 = 
	`zm®loc
((*sj));

684 
sj
->
æags
 = 
SENTINEL_SCRIPT_NONE
;

685 
sj
->
»Œy_num
 = 0;

686 
sj
->
¬gv
 = 
	`zm®loc
((*)*(
¬gc
+1));

687 
sj
->
¡¬t_time
 = 0;

688 
sj
->
pid
 = 0;

689 
	`memıy
(
sj
->
¬gv
,¬gv,(*)*(
¬gc
+1));

691 
	`li¡AddNodeTa
(
£Áš–
.
süts_queue
,
sj
);

694 ià(
	`li¡L’gth
(
£Áš–
.
süts_queue
è> 
SENTINEL_SCRIPT_MAX_QUEUE
) {

695 
li¡Node
 *
Ê
;

696 
li¡I‹r
 
li
;

698 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

699 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

700 
sj
 = 
Ê
->
v®ue
;

702 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ;

704 
	`li¡D–Node
(
£Áš–
.
süts_queue
,
Ê
);

705 
	`£Áš–R–—£SütJob
(
sj
);

708 
	`£rv”As£¹
(
	`li¡L’gth
(
£Áš–
.
süts_queue
) <=

709 
SENTINEL_SCRIPT_MAX_QUEUE
);

711 
	}
}

715 
li¡Node
 *
	$£Áš–G‘SütLi¡NodeByPid
(
pid_t
 
pid
) {

716 
li¡Node
 *
Ê
;

717 
li¡I‹r
 
li
;

719 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

720 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

721 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

723 ià((
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
è&& sj->
pid
 ==…id)

724  
Ê
;

726  
NULL
;

727 
	}
}

731 
	$£Áš–RunP’dšgSüts
() {

732 
li¡Node
 *
Ê
;

733 
li¡I‹r
 
li
;

734 
m¡ime_t
 
now
 = 
	`m¡ime
();

738 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

739 
£Áš–
.
ruÂšg_süts
 < 
SENTINEL_SCRIPT_MAX_RUNNING
 &&

740 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
)

742 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

743 
pid_t
 
pid
;

746 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ;

749 ià(
sj
->
¡¬t_time
 && sj->¡¬t_tim> 
now
) ;

751 
sj
->
æags
 |ğ
SENTINEL_SCRIPT_RUNNING
;

752 
sj
->
¡¬t_time
 = 
	`m¡ime
();

753 
sj
->
»Œy_num
++;

754 
pid
 = 
	`fÜk
();

756 ià(
pid
 == -1) {

760 
	`£Áš–Ev’t
(
LL_WARNING
,"-süt-”rÜ",
NULL
,

761 "% %d %d", 
sj
->
¬gv
[0], 99, 0);

762 
sj
->
æags
 &ğ~
SENTINEL_SCRIPT_RUNNING
;

763 
sj
->
pid
 = 0;

764 } ià(
pid
 == 0) {

766 
	`execve
(
sj
->
¬gv
[0],sj->¬gv,
’vœÚ
);

768 
	`_ex™
(2);

770 
£Áš–
.
ruÂšg_süts
++;

771 
sj
->
pid
 =…id;

772 
	`£Áš–Ev’t
(
LL_DEBUG
,"+süt-chd",
NULL
,"%ld",()
pid
);

775 
	}
}

784 
m¡ime_t
 
	$£Áš–SütR‘ryD–ay
(
»Œy_num
) {

785 
m¡ime_t
 
d–ay
 = 
SENTINEL_SCRIPT_RETRY_DELAY
;

787 
»Œy_num
-- > 1è
d–ay
 *= 2;

788  
d–ay
;

789 
	}
}

795 
	$£Áš–CŞËùT”mš©edSüts
() {

796 
¡©loc
;

797 
pid_t
 
pid
;

799 (
pid
 = 
	`wa™3
(&
¡©loc
,
WNOHANG
,
NULL
)) > 0) {

800 
ex™code
 = 
	`WEXITSTATUS
(
¡©loc
);

801 
bysigÇl
 = 0;

802 
li¡Node
 *
Ê
;

803 
£Áš–SütJob
 *
sj
;

805 ià(
	`WIFSIGNALED
(
¡©loc
)è
bysigÇl
 = 
	`WTERMSIG
(statloc);

806 
	`£Áš–Ev’t
(
LL_DEBUG
,"-süt-chd",
NULL
,"%ld %d %d",

807 ()
pid
, 
ex™code
, 
bysigÇl
);

809 
Ê
 = 
	`£Áš–G‘SütLi¡NodeByPid
(
pid
);

810 ià(
Ê
 =ğ
NULL
) {

811 
	`£rv”Log
(
LL_WARNING
,"wa™3(è»tuºed‡…id (%ldèwÿn'ˆfšd iÀou¸süt executiÚ queue!", ()
pid
);

814 
sj
 = 
Ê
->
v®ue
;

819 ià((
bysigÇl
 || 
ex™code
 == 1) &&

820 
sj
->
»Œy_num
 !ğ
SENTINEL_SCRIPT_MAX_RETRY
)

822 
sj
->
æags
 &ğ~
SENTINEL_SCRIPT_RUNNING
;

823 
sj
->
pid
 = 0;

824 
sj
->
¡¬t_time
 = 
	`m¡ime
() +

825 
	`£Áš–SütR‘ryD–ay
(
sj
->
»Œy_num
);

829 ià(
bysigÇl
 || 
ex™code
 != 0) {

830 
	`£Áš–Ev’t
(
LL_WARNING
,"-süt-”rÜ",
NULL
,

831 "% %d %d", 
sj
->
¬gv
[0], 
bysigÇl
, 
ex™code
);

833 
	`li¡D–Node
(
£Áš–
.
süts_queue
,
Ê
);

834 
	`£Áš–R–—£SütJob
(
sj
);

835 
£Áš–
.
ruÂšg_süts
--;

838 
	}
}

842 
	$£Áš–KlTimedoutSüts
() {

843 
li¡Node
 *
Ê
;

844 
li¡I‹r
 
li
;

845 
m¡ime_t
 
now
 = 
	`m¡ime
();

847 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

848 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

849 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

851 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
 &&

852 (
now
 - 
sj
->
¡¬t_time
è> 
SENTINEL_SCRIPT_MAX_RUNTIME
)

854 
	`£Áš–Ev’t
(
LL_WARNING
,"-süt-timeout",
NULL
,"%s %ld",

855 
sj
->
¬gv
[0], ()sj->
pid
);

856 
	`kl
(
sj
->
pid
,
SIGKILL
);

859 
	}
}

862 
	$£Áš–P’dšgSütsCommªd
(
ş›Á
 *
c
) {

863 
li¡Node
 *
Ê
;

864 
li¡I‹r
 
li
;

866 
	`addR•lyMuÉiBulkL’
(
c
,
	`li¡L’gth
(
£Áš–
.
süts_queue
));

867 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

868 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

869 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

870 
j
 = 0;

872 
	`addR•lyMuÉiBulkL’
(
c
,10);

874 
	`addR•lyBulkCSŒšg
(
c
,"argv");

875 
sj
->
¬gv
[
j
]) j++;

876 
	`addR•lyMuÉiBulkL’
(
c
,
j
);

877 
j
 = 0;

878 
sj
->
¬gv
[
j
]è
	`addR•lyBulkCSŒšg
(
c
,sj->argv[j++]);

880 
	`addR•lyBulkCSŒšg
(
c
,"flags");

881 
	`addR•lyBulkCSŒšg
(
c
,

882 (
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ? "running" : "scheduled");

884 
	`addR•lyBulkCSŒšg
(
c
,"pid");

885 
	`addR•lyBulkLÚgLÚg
(
c
,
sj
->
pid
);

887 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) {

888 
	`addR•lyBulkCSŒšg
(
c
,"run-time");

889 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
sj
->
¡¬t_time
);

891 
m¡ime_t
 
d–ay
 = 
sj
->
¡¬t_time
 ? (sj->¡¬t_time-
	`m¡ime
()) : 0;

892 ià(
d–ay
 < 0) delay = 0;

893 
	`addR•lyBulkCSŒšg
(
c
,"run-delay");

894 
	`addR•lyBulkLÚgLÚg
(
c
,
d–ay
);

897 
	`addR•lyBulkCSŒšg
(
c
,"retry-num");

898 
	`addR•lyBulkLÚgLÚg
(
c
,
sj
->
»Œy_num
);

900 
	}
}

914 
	$£Áš–C®lCl›ÁRecÚfSüt
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
rŞe
, *
¡©e
, 
£Áš–Addr
 *
äom
, s’tš–Add¸*
to
) {

915 
äompÜt
[32], 
tİÜt
[32];

917 ià(
ma¡”
->
ş›Á_»cÚfig_süt
 =ğ
NULL
) ;

918 
	`Î2¡ršg
(
äompÜt
,(äompÜt),
äom
->
pÜt
);

919 
	`Î2¡ršg
(
tİÜt
,ÑİÜt),
to
->
pÜt
);

920 
	`£Áš–ScheduËSütExecutiÚ
(
ma¡”
->
ş›Á_»cÚfig_süt
,

921 
ma¡”
->
Çme
,

922 (
rŞe
 =ğ
SENTINEL_LEADER
) ? "leader" : "observer",

923 
¡©e
, 
äom
->

, 
äompÜt
, 
to
->, 
tİÜt
, 
NULL
);

924 
	}
}

929 
š¡ªûLšk
 *
	$ü—‹In¡ªûLšk
() {

930 
š¡ªûLšk
 *
lšk
 = 
	`zm®loc
((*link));

932 
lšk
->
»fcouÁ
 = 1;

933 
lšk
->
discÚÃùed
 = 1;

934 
lšk
->
³ndšg_commªds
 = 0;

935 
lšk
->
cc
 = 
NULL
;

936 
lšk
->
pc
 = 
NULL
;

937 
lšk
->
cc_cÚn_time
 = 0;

938 
lšk
->
pc_cÚn_time
 = 0;

939 
lšk
->
Ï¡_»cÚn_time
 = 0;

940 
lšk
->
pc_Ï¡_aùiv™y
 = 0;

945 
lšk
->
aù_pšg_time
 = 
	`m¡ime
();

946 
lšk
->
Ï¡_pšg_time
 = 0;

947 
lšk
->
Ï¡_ava_time
 = 
	`m¡ime
();

948 
lšk
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

949  
lšk
;

950 
	}
}

953 
	$š¡ªûLškClo£CÚÃùiÚ
(
š¡ªûLšk
 *
lšk
, 
»disAsyncCÚ‹xt
 *
c
) {

954 ià(
c
 =ğ
NULL
) ;

956 ià(
lšk
->
cc
 =ğ
c
) {

957 
lšk
->
cc
 = 
NULL
;

958 
lšk
->
³ndšg_commªds
 = 0;

960 ià(
lšk
->
pc
 =ğ
c
èlšk->pøğ
NULL
;

961 
c
->
d©a
 = 
NULL
;

962 
lšk
->
discÚÃùed
 = 1;

963 
	`»disAsyncF»e
(
c
);

964 
	}
}

974 
š¡ªûLšk
 *
	$»Ëa£In¡ªûLšk
(
š¡ªûLšk
 *
lšk
, 
£Áš–RedisIn¡ªû
 *
ri
)

976 
	`£rv”As£¹
(
lšk
->
»fcouÁ
 > 0);

977 
lšk
->
»fcouÁ
--;

978 ià(
lšk
->
»fcouÁ
 != 0) {

979 ià(
ri
 &&„i->
lšk
->
cc
) {

985 
»disC®lback
 *
cb
;

986 
»disC®lbackLi¡
 *
ÿÎbacks
 = &
lšk
->
cc
->
»¶›s
;

988 
cb
 = 
ÿÎbacks
->
h—d
;

989 
cb
) {

990 ià(
cb
->
´ivd©a
 =ğ
ri
) {

991 
cb
->
â
 = 
£Áš–DisÿrdR•lyC®lback
;

992 
cb
->
´ivd©a
 = 
NULL
;

994 
cb
 = cb->
Ãxt
;

997  
lšk
;

1000 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
cc
);

1001 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
pc
);

1002 
	`zä“
(
lšk
);

1003  
NULL
;

1004 
	}
}

1018 
	$£Áš–TryCÚÃùiÚSh¬šg
(
£Áš–RedisIn¡ªû
 *
ri
) {

1019 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_SENTINEL
);

1020 
diùI‹¿tÜ
 *
di
;

1021 
diùEÁry
 *
de
;

1023 ià(
ri
->
runid
 =ğ
NULL
è 
C_ERR
;

1024 ià(
ri
->
lšk
->
»fcouÁ
 > 1è 
C_ERR
;

1026 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1027 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1028 
£Áš–RedisIn¡ªû
 *
ma¡”
 = 
	`diùG‘V®
(
de
), *
m©ch
;

1031 ià(
ma¡”
 =ğ
ri
->master) ;

1032 
m©ch
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
ma¡”
->
£Áš–s
,

1033 
NULL
,0,
ri
->
runid
);

1034 ià(
m©ch
 =ğ
NULL
) ;

1035 ià(
m©ch
 =ğ
ri
) ;

1039 
	`»Ëa£In¡ªûLšk
(
ri
->
lšk
,
NULL
);

1040 
ri
->
lšk
 = 
m©ch
->link;

1041 
m©ch
->
lšk
->
»fcouÁ
++;

1042  
C_OK
;

1044 
	`diùR–—£I‹¿tÜ
(
di
);

1045  
C_ERR
;

1046 
	}
}

1054 
	$£Áš–Upd©eS’tš–Add»ssInAÎMa¡”s
(
£Áš–RedisIn¡ªû
 *
ri
) {

1055 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_SENTINEL
);

1056 
diùI‹¿tÜ
 *
di
;

1057 
diùEÁry
 *
de
;

1058 
»cÚfigu»d
 = 0;

1060 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1061 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1062 
£Áš–RedisIn¡ªû
 *
ma¡”
 = 
	`diùG‘V®
(
de
), *
m©ch
;

1063 
m©ch
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
ma¡”
->
£Áš–s
,

1064 
NULL
,0,
ri
->
runid
);

1067 ià(
m©ch
 =ğ
NULL
) ;

1070 ià(
m©ch
->
lšk
->
cc
 !ğ
NULL
)

1071 
	`š¡ªûLškClo£CÚÃùiÚ
(
m©ch
->
lšk
,m©ch->lšk->
cc
);

1072 ià(
m©ch
->
lšk
->
pc
 !ğ
NULL
)

1073 
	`š¡ªûLškClo£CÚÃùiÚ
(
m©ch
->
lšk
,m©ch->lšk->
pc
);

1075 ià(
m©ch
 =ğ
ri
) ;

1079 
	`»Ëa£S’tš–Addr
(
m©ch
->
addr
);

1080 
m©ch
->
addr
 = 
	`dupS’tš–Addr
(
ri
->addr);

1081 
»cÚfigu»d
++;

1083 
	`diùR–—£I‹¿tÜ
(
di
);

1084 ià(
»cÚfigu»d
)

1085 
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–-add»ss-upd©e", 
ri
,

1086 "%@ %d‡dd™iÚ® m©chšg in¡ªûs", 
»cÚfigu»d
);

1087  
»cÚfigu»d
;

1088 
	}
}

1096 
	$š¡ªûLškCÚÃùiÚE¼Ü
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
) {

1097 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

1098 
pubsub
;

1100 ià(!
lšk
) ;

1102 
pubsub
 = (
lšk
->
pc
 =ğ
c
);

1103 ià(
pubsub
)

1104 
lšk
->
pc
 = 
NULL
;

1106 
lšk
->
cc
 = 
NULL
;

1107 
lšk
->
discÚÃùed
 = 1;

1108 
	}
}

1112 
	$£Áš–LškE¡ablishedC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

1113 ià(
¡©us
 !ğ
C_OK
è
	`š¡ªûLškCÚÃùiÚE¼Ü
(
c
);

1114 
	}
}

1116 
	$£Áš–DiscÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

1117 
	`UNUSED
(
¡©us
);

1118 
	`š¡ªûLškCÚÃùiÚE¼Ü
(
c
);

1119 
	}
}

1145 
£Áš–RedisIn¡ªû
 *
	$ü—‹S’tš–RedisIn¡ªû
(*
Çme
, 
æags
, *
ho¡Çme
, 
pÜt
, 
quÜum
, 
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1146 
£Áš–RedisIn¡ªû
 *
ri
;

1147 
£Áš–Addr
 *
addr
;

1148 
diù
 *
bË
 = 
NULL
;

1149 
¦av’ame
[
NET_PEER_ID_LEN
], *
sd¢ame
;

1151 
	`£rv”As£¹
(
æags
 & (
SRI_MASTER
|
SRI_SLAVE
|
SRI_SENTINEL
));

1152 
	`£rv”As£¹
((
æags
 & 
SRI_MASTER
è|| 
ma¡”
 !ğ
NULL
);

1155 
addr
 = 
	`ü—‹S’tš–Addr
(
ho¡Çme
,
pÜt
);

1156 ià(
addr
 =ğ
NULL
)  NULL;

1159 ià(
æags
 & 
SRI_SLAVE
) {

1160 
	`ª‘FÜm©Addr
(
¦av’ame
, (¦av’ame), 
ho¡Çme
, 
pÜt
);

1161 
Çme
 = 
¦av’ame
;

1168 ià(
æags
 & 
SRI_MASTER
è
bË
 = 
£Áš–
.
ma¡”s
;

1169 ià(
æags
 & 
SRI_SLAVE
è
bË
 = 
ma¡”
->
¦aves
;

1170 ià(
æags
 & 
SRI_SENTINEL
è
bË
 = 
ma¡”
->
£Áš–s
;

1171 
sd¢ame
 = 
	`sd¢ew
(
Çme
);

1172 ià(
	`diùFšd
(
bË
,
sd¢ame
)) {

1173 
	`»Ëa£S’tš–Addr
(
addr
);

1174 
	`sdsä“
(
sd¢ame
);

1175 
”ºo
 = 
EBUSY
;

1176  
NULL
;

1180 
ri
 = 
	`zm®loc
((*ri));

1183 
ri
->
æags
 = flags;

1184 
ri
->
Çme
 = 
sd¢ame
;

1185 
ri
->
runid
 = 
NULL
;

1186 
ri
->
cÚfig_•och
 = 0;

1187 
ri
->
addr
 =‡ddr;

1188 
ri
->
lšk
 = 
	`ü—‹In¡ªûLšk
();

1189 
ri
->
Ï¡_pub_time
 = 
	`m¡ime
();

1190 
ri
->
Ï¡_h–lo_time
 = 
	`m¡ime
();

1191 
ri
->
Ï¡_ma¡”_down_»¶y_time
 = 
	`m¡ime
();

1192 
ri
->
s_down_sšû_time
 = 0;

1193 
ri
->
o_down_sšû_time
 = 0;

1194 
ri
->
down_aá”_³riod
 = 
ma¡”
 ? master->down_after_period :

1195 
SENTINEL_DEFAULT_DOWN_AFTER
;

1196 
ri
->
ma¡”_lšk_down_time
 = 0;

1197 
ri
->
auth_·ss
 = 
NULL
;

1198 
ri
->
¦ave_´iÜ™y
 = 
SENTINEL_DEFAULT_SLAVE_PRIORITY
;

1199 
ri
->
¦ave_»cÚf_£Á_time
 = 0;

1200 
ri
->
¦ave_ma¡”_ho¡
 = 
NULL
;

1201 
ri
->
¦ave_ma¡”_pÜt
 = 0;

1202 
ri
->
¦ave_ma¡”_lšk_¡©us
 = 
SENTINEL_MASTER_LINK_STATUS_DOWN
;

1203 
ri
->
¦ave_»¶_off£t
 = 0;

1204 
ri
->
£Áš–s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1205 
ri
->
quÜum
 = quorum;

1206 
ri
->
·¿Î–_syncs
 = 
SENTINEL_DEFAULT_PARALLEL_SYNCS
;

1207 
ri
->
ma¡”
 = master;

1208 
ri
->
¦aves
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1209 
ri
->
šfo_»äesh
 = 0;

1212 
ri
->
Ëad”
 = 
NULL
;

1213 
ri
->
Ëad”_•och
 = 0;

1214 
ri
->
çov”_•och
 = 0;

1215 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

1216 
ri
->
çov”_¡©e_chªge_time
 = 0;

1217 
ri
->
çov”_¡¬t_time
 = 0;

1218 
ri
->
çov”_timeout
 = 
SENTINEL_DEFAULT_FAILOVER_TIMEOUT
;

1219 
ri
->
çov”_d–ay_logged
 = 0;

1220 
ri
->
´omÙed_¦ave
 = 
NULL
;

1221 
ri
->
nÙifiÿtiÚ_süt
 = 
NULL
;

1222 
ri
->
ş›Á_»cÚfig_süt
 = 
NULL
;

1223 
ri
->
šfo
 = 
NULL
;

1226 
ri
->
rŞe_»pÜ‹d
 =„i->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
);

1227 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

1228 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

1231 
	`diùAdd
(
bË
, 
ri
->
Çme
,„i);

1232  
ri
;

1233 
	}
}

1239 
	$»Ëa£S’tš–RedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

1241 
	`diùR–—£
(
ri
->
£Áš–s
);

1242 
	`diùR–—£
(
ri
->
¦aves
);

1245 
	`»Ëa£In¡ªûLšk
(
ri
->
lšk
,ri);

1248 
	`sdsä“
(
ri
->
Çme
);

1249 
	`sdsä“
(
ri
->
runid
);

1250 
	`sdsä“
(
ri
->
nÙifiÿtiÚ_süt
);

1251 
	`sdsä“
(
ri
->
ş›Á_»cÚfig_süt
);

1252 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

1253 
	`sdsä“
(
ri
->
Ëad”
);

1254 
	`sdsä“
(
ri
->
auth_·ss
);

1255 
	`sdsä“
(
ri
->
šfo
);

1256 
	`»Ëa£S’tš–Addr
(
ri
->
addr
);

1259 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& (ri->æag & 
SRI_PROMOTED
è&&„i->
ma¡”
)

1260 
ri
->
ma¡”
->
´omÙed_¦ave
 = 
NULL
;

1262 
	`zä“
(
ri
);

1263 
	}
}

1266 
£Áš–RedisIn¡ªû
 *
	$£Áš–RedisIn¡ªûLookupSÏve
(

1267 
£Áš–RedisIn¡ªû
 *
ri
, *

, 
pÜt
)

1269 
sds
 
key
;

1270 
£Áš–RedisIn¡ªû
 *
¦ave
;

1271 
buf
[
NET_PEER_ID_LEN
];

1273 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_MASTER
);

1274 
	`ª‘FÜm©Addr
(
buf
,(buf),

,
pÜt
);

1275 
key
 = 
	`sd¢ew
(
buf
);

1276 
¦ave
 = 
	`diùF‘chV®ue
(
ri
->
¦aves
,
key
);

1277 
	`sdsä“
(
key
);

1278  
¦ave
;

1279 
	}
}

1282 cÚ¡ *
	$£Áš–RedisIn¡ªûTy³SŒ
(
£Áš–RedisIn¡ªû
 *
ri
) {

1283 ià(
ri
->
æags
 & 
SRI_MASTER
)  "master";

1284 ià(
ri
->
æags
 & 
SRI_SLAVE
)  "slave";

1285 ià(
ri
->
æags
 & 
SRI_SENTINEL
)  "sentinel";

1287 
	}
}

1300 
	$»moveM©chšgS’tš–FromMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, *
runid
) {

1301 
diùI‹¿tÜ
 *
di
;

1302 
diùEÁry
 *
de
;

1303 
»moved
 = 0;

1305 ià(
runid
 =ğ
NULL
)  0;

1307 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
ma¡”
->
£Áš–s
);

1308 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1309 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1311 ià(
ri
->
runid
 && 
	`¡rcmp
(ri->runid,runid) == 0) {

1312 
	`diùD–‘e
(
ma¡”
->
£Áš–s
,
ri
->
Çme
);

1313 
»moved
++;

1316 
	`diùR–—£I‹¿tÜ
(
di
);

1317  
»moved
;

1318 
	}
}

1326 
£Áš–RedisIn¡ªû
 *
	$g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
diù
 *
š¡ªûs
, *

, 
pÜt
, *
runid
) {

1327 
diùI‹¿tÜ
 *
di
;

1328 
diùEÁry
 *
de
;

1329 
£Áš–RedisIn¡ªû
 *
š¡ªû
 = 
NULL
;

1331 
	`£rv”As£¹
(

 || 
runid
);

1332 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1333 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1334 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1336 ià(
runid
 && !
ri
->runid) ;

1337 ià((
runid
 =ğ
NULL
 || 
	`¡rcmp
(
ri
->runid,„unid) == 0) &&

1338 (

 =ğ
NULL
 || (
	`¡rcmp
(
ri
->
addr
->ip, ip) == 0 &&

1339 
ri
->
addr
->
pÜt
 ==…ort)))

1341 
š¡ªû
 = 
ri
;

1345 
	`diùR–—£I‹¿tÜ
(
di
);

1346  
š¡ªû
;

1347 
	}
}

1350 
£Áš–RedisIn¡ªû
 *
	$£Áš–G‘Ma¡”ByName
(*
Çme
) {

1351 
£Áš–RedisIn¡ªû
 *
ri
;

1352 
sds
 
sd¢ame
 = 
	`sd¢ew
(
Çme
);

1354 
ri
 = 
	`diùF‘chV®ue
(
£Áš–
.
ma¡”s
,
sd¢ame
);

1355 
	`sdsä“
(
sd¢ame
);

1356  
ri
;

1357 
	}
}

1360 
	$£Áš–AddFÏgsToDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
, 
æags
) {

1361 
diùI‹¿tÜ
 *
di
;

1362 
diùEÁry
 *
de
;

1364 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1365 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1366 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1367 
ri
->
æags
 |= flags;

1369 
	`diùR–—£I‹¿tÜ
(
di
);

1370 
	}
}

1374 
	$£Áš–D–FÏgsToDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
, 
æags
) {

1375 
diùI‹¿tÜ
 *
di
;

1376 
diùEÁry
 *
de
;

1378 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1379 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1380 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1381 
ri
->
æags
 &= ~flags;

1383 
	`diùR–—£I‹¿tÜ
(
di
);

1384 
	}
}

1397 
	#SENTINEL_RESET_NO_SENTINELS
 (1<<0)

	)

1398 
	$£Áš–Re£tMa¡”
(
£Áš–RedisIn¡ªû
 *
ri
, 
æags
) {

1399 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_MASTER
);

1400 
	`diùR–—£
(
ri
->
¦aves
);

1401 
ri
->
¦aves
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1402 ià(!(
æags
 & 
SENTINEL_RESET_NO_SENTINELS
)) {

1403 
	`diùR–—£
(
ri
->
£Áš–s
);

1404 
ri
->
£Áš–s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1406 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
cc
);

1407 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
pc
);

1408 
ri
->
æags
 &ğ
SRI_MASTER
;

1409 ià(
ri
->
Ëad”
) {

1410 
	`sdsä“
(
ri
->
Ëad”
);

1411 
ri
->
Ëad”
 = 
NULL
;

1413 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

1414 
ri
->
çov”_¡©e_chªge_time
 = 0;

1415 
ri
->
çov”_¡¬t_time
 = 0;

1416 
ri
->
´omÙed_¦ave
 = 
NULL
;

1417 
	`sdsä“
(
ri
->
runid
);

1418 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

1419 
ri
->
runid
 = 
NULL
;

1420 
ri
->
¦ave_ma¡”_ho¡
 = 
NULL
;

1421 
ri
->
lšk
->
aù_pšg_time
 = 
	`m¡ime
();

1422 
ri
->
lšk
->
Ï¡_pšg_time
 = 0;

1423 
ri
->
lšk
->
Ï¡_ava_time
 = 
	`m¡ime
();

1424 
ri
->
lšk
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

1425 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

1426 
ri
->
rŞe_»pÜ‹d
 = 
SRI_MASTER
;

1427 ià(
æags
 & 
SENTINEL_GENERATE_EVENT
)

1428 
	`£Áš–Ev’t
(
LL_WARNING
,"+»£t-ma¡”",
ri
,"%@");

1429 
	}
}

1433 
	$£Áš–Re£tMa¡”sByP©‹º
(*
·‰”n
, 
æags
) {

1434 
diùI‹¿tÜ
 *
di
;

1435 
diùEÁry
 *
de
;

1436 
»£t
 = 0;

1438 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1439 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1440 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1442 ià(
ri
->
Çme
) {

1443 ià(
	`¡ršgm©ch
(
·‰”n
,
ri
->
Çme
,0)) {

1444 
	`£Áš–Re£tMa¡”
(
ri
,
æags
);

1445 
»£t
++;

1449 
	`diùR–—£I‹¿tÜ
(
di
);

1450  
»£t
;

1451 
	}
}

1460 
	$£Áš–Re£tMa¡”AndChªgeAdd»ss
(
£Áš–RedisIn¡ªû
 *
ma¡”
, *

, 
pÜt
) {

1461 
£Áš–Addr
 *
Şdaddr
, *
Ãwaddr
;

1462 
£Áš–Addr
 **
¦aves
 = 
NULL
;

1463 
num¦aves
 = 0, 
j
;

1464 
diùI‹¿tÜ
 *
di
;

1465 
diùEÁry
 *
de
;

1467 
Ãwaddr
 = 
	`ü—‹S’tš–Addr
(

,
pÜt
);

1468 ià(
Ãwaddr
 =ğ
NULL
è 
C_ERR
;

1472 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

1473 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1474 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

1476 ià(
	`£Áš–AddrIsEqu®
(
¦ave
->
addr
,
Ãwaddr
)) ;

1477 
¦aves
 = 
	`z»®loc
(¦aves,(
£Áš–Addr
*)*(
num¦aves
+1));

1478 
¦aves
[
num¦aves
++] = 
	`ü—‹S’tš–Addr
(
¦ave
->
addr
->

,

1479 
¦ave
->
addr
->
pÜt
);

1481 
	`diùR–—£I‹¿tÜ
(
di
);

1486 ià(!
	`£Áš–AddrIsEqu®
(
Ãwaddr
,
ma¡”
->
addr
)) {

1487 
¦aves
 = 
	`z»®loc
(¦aves,(
£Áš–Addr
*)*(
num¦aves
+1));

1488 
¦aves
[
num¦aves
++] = 
	`ü—‹S’tš–Addr
(
ma¡”
->
addr
->

,

1489 
ma¡”
->
addr
->
pÜt
);

1493 
	`£Áš–Re£tMa¡”
(
ma¡”
,
SENTINEL_RESET_NO_SENTINELS
);

1494 
Şdaddr
 = 
ma¡”
->
addr
;

1495 
ma¡”
->
addr
 = 
Ãwaddr
;

1496 
ma¡”
->
o_down_sšû_time
 = 0;

1497 
ma¡”
->
s_down_sšû_time
 = 0;

1500 
j
 = 0; j < 
num¦aves
; j++) {

1501 
£Áš–RedisIn¡ªû
 *
¦ave
;

1503 
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,
¦aves
[
j
]->

,

1504 
¦aves
[
j
]->
pÜt
, 
ma¡”
->
quÜum
, master);

1505 
	`»Ëa£S’tš–Addr
(
¦aves
[
j
]);

1506 ià(
¦ave
è
	`£Áš–Ev’t
(
LL_NOTICE
,"+slave",slave,"%@");

1508 
	`zä“
(
¦aves
);

1512 
	`»Ëa£S’tš–Addr
(
Şdaddr
);

1513 
	`£Áš–FlushCÚfig
();

1514  
C_OK
;

1515 
	}
}

1519 
	$£Áš–RedisIn¡ªûNoDownFÜ
(
£Áš–RedisIn¡ªû
 *
ri
, 
m¡ime_t
 
ms
) {

1520 
m¡ime_t
 
mo¡_»ûÁ
;

1522 
mo¡_»ûÁ
 = 
ri
->
s_down_sšû_time
;

1523 ià(
ri
->
o_down_sšû_time
 > 
mo¡_»ûÁ
)

1524 
mo¡_»ûÁ
 = 
ri
->
o_down_sšû_time
;

1525  
mo¡_»ûÁ
 =ğ0 || (
	`m¡ime
(è- mo¡_»ûÁè> 
ms
;

1526 
	}
}

1530 
£Áš–Addr
 *
	$£Áš–G‘Cu¼’tMa¡”Add»ss
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1536 ià((
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) &&

1537 
ma¡”
->
´omÙed_¦ave
 &&

1538 
ma¡”
->
çov”_¡©e
 >ğ
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
)

1540  
ma¡”
->
´omÙed_¦ave
->
addr
;

1542  
ma¡”
->
addr
;

1544 
	}
}

1548 
	$£Áš–Prİag©eDownAá”P”iod
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1549 
diùI‹¿tÜ
 *
di
;

1550 
diùEÁry
 *
de
;

1551 
j
;

1552 
diù
 *
d
[] = {
ma¡”
->
¦aves
, ma¡”->
£Áš–s
, 
NULL
};

1554 
j
 = 0; 
d
[j]; j++) {

1555 
di
 = 
	`diùG‘I‹¿tÜ
(
d
[
j
]);

1556 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1557 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1558 
ri
->
down_aá”_³riod
 = 
ma¡”
->down_after_period;

1560 
	`diùR–—£I‹¿tÜ
(
di
);

1562 
	}
}

1564 *
	$£Áš–G‘In¡ªûTy³SŒšg
(
£Áš–RedisIn¡ªû
 *
ri
) {

1565 ià(
ri
->
æags
 & 
SRI_MASTER
)  "master";

1566 ià(
ri
->
æags
 & 
SRI_SLAVE
)  "slave";

1567 ià(
ri
->
æags
 & 
SRI_SENTINEL
)  "sentinel";

1569 
	}
}

1572 *
	$£Áš–HªdËCÚfigu¿tiÚ
(**
¬gv
, 
¬gc
) {

1573 
£Áš–RedisIn¡ªû
 *
ri
;

1575 ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mÚ™Ü"è&& 
¬gc
 == 5) {

1577 
quÜum
 = 
	`©oi
(
¬gv
[4]);

1579 ià(
quÜum
 <= 0)  "Quorum must be 1 or greater.";

1580 ià(
	`ü—‹S’tš–RedisIn¡ªû
(
¬gv
[1],
SRI_MASTER
,argv[2],

1581 
	`©oi
(
¬gv
[3]),
quÜum
,
NULL
) == NULL)

1583 
”ºo
) {

1584 
EBUSY
:  "Duplicated master‚ame.";

1585 
ENOENT
:  "Can't„esolve master instance hostname.";

1586 
EINVAL
:  "Invalid…ort‚umber";

1589 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"down-aá”-mli£cÚds"è&& 
¬gc
 == 3) {

1591 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1592 ià(!
ri
)  "No such master with specified‚ame.";

1593 
ri
->
down_aá”_³riod
 = 
	`©oi
(
¬gv
[2]);

1594 ià(
ri
->
down_aá”_³riod
 <= 0)

1596 
	`£Áš–Prİag©eDownAá”P”iod
(
ri
);

1597 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"çov”-timeout"è&& 
¬gc
 == 3) {

1599 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1600 ià(!
ri
)  "No such master with specified‚ame.";

1601 
ri
->
çov”_timeout
 = 
	`©oi
(
¬gv
[2]);

1602 ià(
ri
->
çov”_timeout
 <= 0)

1604 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"·¿Î–-syncs"è&& 
¬gc
 == 3) {

1606 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1607 ià(!
ri
)  "No such master with specified‚ame.";

1608 
ri
->
·¿Î–_syncs
 = 
	`©oi
(
¬gv
[2]);

1609 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"nÙifiÿtiÚ-süt"è&& 
¬gc
 == 3) {

1611 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1612 ià(!
ri
)  "No such master with specified‚ame.";

1613 ià(
	`acûss
(
¬gv
[2],
X_OK
) == -1)

1615 
ri
->
nÙifiÿtiÚ_süt
 = 
	`sd¢ew
(
¬gv
[2]);

1616 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ş›Á-»cÚfig-süt"è&& 
¬gc
 == 3) {

1618 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1619 ià(!
ri
)  "No such master with specified‚ame.";

1620 ià(
	`acûss
(
¬gv
[2],
X_OK
) == -1)

1623 
ri
->
ş›Á_»cÚfig_süt
 = 
	`sd¢ew
(
¬gv
[2]);

1624 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auth-·ss"è&& 
¬gc
 == 3) {

1626 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1627 ià(!
ri
)  "No such master with specified‚ame.";

1628 
ri
->
auth_·ss
 = 
	`sd¢ew
(
¬gv
[2]);

1629 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cu¼’t-•och"è&& 
¬gc
 == 2) {

1631 
cu¼’t_•och
 = 
	`¡¹ouÎ
(
¬gv
[1],
NULL
,10);

1632 ià(
cu¼’t_•och
 > 
£Áš–
.current_epoch)

1633 
£Áš–
.
cu¼’t_•och
 = current_epoch;

1634 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"myid"è&& 
¬gc
 == 2) {

1635 ià(
	`¡¾’
(
¬gv
[1]è!ğ
CONFIG_RUN_ID_SIZE
)

1637 
	`memıy
(
£Áš–
.
myid
,
¬gv
[1],
CONFIG_RUN_ID_SIZE
);

1638 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cÚfig-•och"è&& 
¬gc
 == 3) {

1640 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1641 ià(!
ri
)  "No such master with specified‚ame.";

1642 
ri
->
cÚfig_•och
 = 
	`¡¹ouÎ
(
¬gv
[2],
NULL
,10);

1646 ià(
ri
->
cÚfig_•och
 > 
£Áš–
.
cu¼’t_•och
)

1647 
£Áš–
.
cu¼’t_•och
 = 
ri
->
cÚfig_•och
;

1648 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ëad”-•och"è&& 
¬gc
 == 3) {

1650 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1651 ià(!
ri
)  "No such master with specified‚ame.";

1652 
ri
->
Ëad”_•och
 = 
	`¡¹ouÎ
(
¬gv
[2],
NULL
,10);

1653 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"known-¦ave"è&& 
¬gc
 == 4) {

1654 
£Áš–RedisIn¡ªû
 *
¦ave
;

1657 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1658 ià(!
ri
)  "No such master with specified‚ame.";

1659 ià((
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,
¬gv
[2],

1660 
	`©oi
(
¬gv
[3]), 
ri
->
quÜum
,„i)è=ğ
NULL
)

1664 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"known-sentinel") &&

1665 (
¬gc
 == 4 ||‡rgc == 5)) {

1666 
£Áš–RedisIn¡ªû
 *
si
;

1668 ià(
¬gc
 == 5) {

1670 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1671 ià(!
ri
)  "No such master with specified‚ame.";

1672 ià((
si
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
¬gv
[4],
SRI_SENTINEL
,argv[2],

1673 
	`©oi
(
¬gv
[3]), 
ri
->
quÜum
,„i)è=ğ
NULL
)

1677 
si
->
runid
 = 
	`sd¢ew
(
¬gv
[4]);

1678 
	`£Áš–TryCÚÃùiÚSh¬šg
(
si
);

1680 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ªnounû-"è&& 
¬gc
 == 2) {

1682 ià(
	`¡¾’
(
¬gv
[1]))

1683 
£Áš–
.
ªnounû_
 = 
	`sd¢ew
(
¬gv
[1]);

1684 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ªnounû-pÜt"è&& 
¬gc
 == 2) {

1686 
£Áš–
.
ªnounû_pÜt
 = 
	`©oi
(
¬gv
[1]);

1690  
NULL
;

1691 
	}
}

1698 
	$»wr™eCÚfigS’tš–O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1699 
diùI‹¿tÜ
 *
di
, *
di2
;

1700 
diùEÁry
 *
de
;

1701 
sds
 
lše
;

1704 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "£Áš– myid %s", 
£Áš–
.
myid
);

1705 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1708 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1709 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1710 
£Áš–RedisIn¡ªû
 *
ma¡”
, *
ri
;

1711 
£Áš–Addr
 *
ma¡”_addr
;

1714 
ma¡”
 = 
	`diùG‘V®
(
de
);

1715 
ma¡”_addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ma¡”
);

1716 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"sentinel monitor %s %s %d %d",

1717 
ma¡”
->
Çme
, 
ma¡”_addr
->

, ma¡”_addr->
pÜt
,

1718 
ma¡”
->
quÜum
);

1719 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1722 ià(
ma¡”
->
down_aá”_³riod
 !ğ
SENTINEL_DEFAULT_DOWN_AFTER
) {

1723 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1725 
ma¡”
->
Çme
, (èma¡”->
down_aá”_³riod
);

1726 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1730 ià(
ma¡”
->
çov”_timeout
 !ğ
SENTINEL_DEFAULT_FAILOVER_TIMEOUT
) {

1731 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1733 
ma¡”
->
Çme
, (èma¡”->
çov”_timeout
);

1734 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1738 ià(
ma¡”
->
·¿Î–_syncs
 !ğ
SENTINEL_DEFAULT_PARALLEL_SYNCS
) {

1739 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1741 
ma¡”
->
Çme
, ma¡”->
·¿Î–_syncs
);

1742 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1746 ià(
ma¡”
->
nÙifiÿtiÚ_süt
) {

1747 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1749 
ma¡”
->
Çme
, ma¡”->
nÙifiÿtiÚ_süt
);

1750 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1754 ià(
ma¡”
->
ş›Á_»cÚfig_süt
) {

1755 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1757 
ma¡”
->
Çme
, ma¡”->
ş›Á_»cÚfig_süt
);

1758 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1762 ià(
ma¡”
->
auth_·ss
) {

1763 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1765 
ma¡”
->
Çme
, ma¡”->
auth_·ss
);

1766 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1770 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1772 
ma¡”
->
Çme
, (èma¡”->
cÚfig_•och
);

1773 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1776 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1778 
ma¡”
->
Çme
, (èma¡”->
Ëad”_•och
);

1779 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1782 
di2
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

1783 (
de
 = 
	`diùNext
(
di2
)è!ğ
NULL
) {

1784 
£Áš–Addr
 *
¦ave_addr
;

1786 
ri
 = 
	`diùG‘V®
(
de
);

1787 
¦ave_addr
 = 
ri
->
addr
;

1794 ià(
	`£Áš–AddrIsEqu®
(
¦ave_addr
,
ma¡”_addr
))

1795 
¦ave_addr
 = 
ma¡”
->
addr
;

1796 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1798 
ma¡”
->
Çme
, 
¦ave_addr
->

, sÏve_addr->
pÜt
);

1799 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1801 
	`diùR–—£I‹¿tÜ
(
di2
);

1804 
di2
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

1805 (
de
 = 
	`diùNext
(
di2
)è!ğ
NULL
) {

1806 
ri
 = 
	`diùG‘V®
(
de
);

1807 ià(
ri
->
runid
 =ğ
NULL
) ;

1808 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1810 
ma¡”
->
Çme
, 
ri
->
addr
->

,„i->addr->
pÜt
,„i->
runid
);

1811 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1813 
	`diùR–—£I‹¿tÜ
(
di2
);

1817 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1818 "£Áš– cu¼’t-•och %Îu", (è
£Áš–
.
cu¼’t_•och
);

1819 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1822 ià(
£Áš–
.
ªnounû_
) {

1823 
lše
 = 
	`sd¢ew
("sentinel‡nnounce-ip ");

1824 
lše
 = 
	`sdsÿŒ•r
Öše, 
£Áš–
.
ªnounû_
, 
	`sd¦’
(sentinel.announce_ip));

1825 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1829 ià(
£Áš–
.
ªnounû_pÜt
) {

1830 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"sentinel‡nnounce-port %d",

1831 
£Áš–
.
ªnounû_pÜt
);

1832 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1835 
	`diùR–—£I‹¿tÜ
(
di
);

1836 
	}
}

1845 
	$£Áš–FlushCÚfig
() {

1846 
fd
 = -1;

1847 
§ved_hz
 = 
£rv”
.
hz
;

1848 
»wr™e_¡©us
;

1850 
£rv”
.
hz
 = 
CONFIG_DEFAULT_HZ
;

1851 
»wr™e_¡©us
 = 
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
);

1852 
£rv”
.
hz
 = 
§ved_hz
;

1854 ià(
»wr™e_¡©us
 =ğ-1è
w”r
;

1855 ià((
fd
 = 
	`İ’
(
£rv”
.
cÚfigfe
,
O_RDONLY
)è=ğ-1è
w”r
;

1856 ià(
	`fsync
(
fd
è=ğ-1è
w”r
;

1857 ià(
	`şo£
(
fd
è=ğ
EOF
è
w”r
;

1860 
w”r
:

1861 ià(
fd
 !ğ-1è
	`şo£
(fd);

1862 
	`£rv”Log
(
LL_WARNING
,"WARNING: S’tš– wa nÙ‡bËØ§vthÃw cÚfigu¿tiÚ oÀdisk!!!: %s", 
	`¡»¼Ü
(
”ºo
));

1863 
	}
}

1873 
	$£Áš–S’dAuthIfN“ded
(
£Áš–RedisIn¡ªû
 *
ri
, 
»disAsyncCÚ‹xt
 *
c
) {

1874 *
auth_·ss
 = (
ri
->
æags
 & 
SRI_MASTER
) ?„i->auth_pass :

1875 
ri
->
ma¡”
->
auth_·ss
;

1877 ià(
auth_·ss
) {

1878 ià(
	`»disAsyncCommªd
(
c
, 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "AUTH %s",

1879 
auth_·ss
è=ğ
C_OK
è
ri
->
lšk
->
³ndšg_commªds
++;

1881 
	}
}

1889 
	$£Áš–S‘Cl›ÁName
(
£Áš–RedisIn¡ªû
 *
ri
, 
»disAsyncCÚ‹xt
 *
c
, *
ty³
) {

1890 
Çme
[64];

1892 
	`¢´štf
(
Çme
,Òame),"£Áš–-%.8s-%s",
£Áš–
.
myid
,
ty³
);

1893 ià(
	`»disAsyncCommªd
(
c
, 
£Áš–DisÿrdR•lyC®lback
, 
ri
,

1894 "CLIENT SETNAME %s", 
Çme
è=ğ
C_OK
)

1896 
ri
->
lšk
->
³ndšg_commªds
++;

1898 
	}
}

1903 
	$£Áš–RecÚÃùIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

1904 ià(
ri
->
lšk
->
discÚÃùed
 == 0) ;

1905 ià(
ri
->
addr
->
pÜt
 == 0) ;

1906 
š¡ªûLšk
 *
lšk
 = 
ri
->link;

1907 
m¡ime_t
 
now
 = 
	`m¡ime
();

1909 ià(
now
 - 
ri
->
lšk
->
Ï¡_»cÚn_time
 < 
SENTINEL_PING_PERIOD
) ;

1910 
ri
->
lšk
->
Ï¡_»cÚn_time
 = 
now
;

1913 ià(
lšk
->
cc
 =ğ
NULL
) {

1914 
lšk
->
cc
 = 
	`»disAsyncCÚÃùBšd
(
ri
->
addr
->

,ri->addr->
pÜt
,
NET_FIRST_BIND_ADDR
);

1915 ià(
lšk
->
cc
->
”r
) {

1916 
	`£Áš–Ev’t
(
LL_DEBUG
,"-cmd-lšk-»cÚÃùiÚ",
ri
,"%@ #%s",

1917 
lšk
->
cc
->
”r¡r
);

1918 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
cc
);

1920 
lšk
->
³ndšg_commªds
 = 0;

1921 
lšk
->
cc_cÚn_time
 = 
	`m¡ime
();

1922 
lšk
->
cc
->
d©a
 =†ink;

1923 
	`»disAeA‰ach
(
£rv”
.
–
,
lšk
->
cc
);

1924 
	`»disAsyncS‘CÚÃùC®lback
(
lšk
->
cc
,

1925 
£Áš–LškE¡ablishedC®lback
);

1926 
	`»disAsyncS‘DiscÚÃùC®lback
(
lšk
->
cc
,

1927 
£Áš–DiscÚÃùC®lback
);

1928 
	`£Áš–S’dAuthIfN“ded
(
ri
,
lšk
->
cc
);

1929 
	`£Áš–S‘Cl›ÁName
(
ri
,
lšk
->
cc
,"cmd");

1932 
	`£Áš–S’dPšg
(
ri
);

1936 ià((
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)è&& 
lšk
->
pc
 =ğ
NULL
) {

1937 
lšk
->
pc
 = 
	`»disAsyncCÚÃùBšd
(
ri
->
addr
->

,ri->addr->
pÜt
,
NET_FIRST_BIND_ADDR
);

1938 ià(
lšk
->
pc
->
”r
) {

1939 
	`£Áš–Ev’t
(
LL_DEBUG
,"-pubsub-lšk-»cÚÃùiÚ",
ri
,"%@ #%s",

1940 
lšk
->
pc
->
”r¡r
);

1941 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
pc
);

1943 
»tv®
;

1945 
lšk
->
pc_cÚn_time
 = 
	`m¡ime
();

1946 
lšk
->
pc
->
d©a
 =†ink;

1947 
	`»disAeA‰ach
(
£rv”
.
–
,
lšk
->
pc
);

1948 
	`»disAsyncS‘CÚÃùC®lback
(
lšk
->
pc
,

1949 
£Áš–LškE¡ablishedC®lback
);

1950 
	`»disAsyncS‘DiscÚÃùC®lback
(
lšk
->
pc
,

1951 
£Áš–DiscÚÃùC®lback
);

1952 
	`£Áš–S’dAuthIfN“ded
(
ri
,
lšk
->
pc
);

1953 
	`£Áš–S‘Cl›ÁName
(
ri
,
lšk
->
pc
,"pubsub");

1955 
»tv®
 = 
	`»disAsyncCommªd
(
lšk
->
pc
,

1956 
£Áš–ReûiveH–loMes§ges
, 
ri
, "SUBSCRIBE %s",

1957 
SENTINEL_HELLO_CHANNEL
);

1958 ià(
»tv®
 !ğ
C_OK
) {

1961 
	`š¡ªûLškClo£CÚÃùiÚ
(
lšk
,lšk->
pc
);

1968 ià(
lšk
->
cc
 && (
ri
->
æags
 & 
SRI_SENTINEL
 ||†šk->
pc
))

1969 
lšk
->
discÚÃùed
 = 0;

1970 
	}
}

1979 
	$£Áš–Ma¡”LooksSªe
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1981 
ma¡”
->
æags
 & 
SRI_MASTER
 &&

1982 
ma¡”
->
rŞe_»pÜ‹d
 =ğ
SRI_MASTER
 &&

1983 (
ma¡”
->
æags
 & (
SRI_S_DOWN
|
SRI_O_DOWN
)) == 0 &&

1984 (
	`m¡ime
(è- 
ma¡”
->
šfo_»äesh
è< 
SENTINEL_INFO_PERIOD
*2;

1985 
	}
}

1988 
	$£Áš–ReäeshIn¡ªûInfo
(
£Áš–RedisIn¡ªû
 *
ri
, cÚ¡ *
šfo
) {

1989 
sds
 *
lšes
;

1990 
numlšes
, 
j
;

1991 
rŞe
 = 0;

1994 
	`sdsä“
(
ri
->
šfo
);

1995 
ri
->
šfo
 = 
	`sd¢ew
(info);

1999 
ri
->
ma¡”_lšk_down_time
 = 0;

2002 
lšes
 = 
	`sds¥l™Ën
(
šfo
,
	`¡¾’
(šfo),"\r\n",2,&
numlšes
);

2003 
j
 = 0; j < 
numlšes
; j++) {

2004 
£Áš–RedisIn¡ªû
 *
¦ave
;

2005 
sds
 
l
 = 
lšes
[
j
];

2008 ià(
	`sd¦’
(
l
è>ğ47 && !
	`memcmp
(l,"run_id:",7)) {

2009 ià(
ri
->
runid
 =ğ
NULL
) {

2010 
ri
->
runid
 = 
	`sd¢ewËn
(
l
+7,40);

2012 ià(
	`¡ºcmp
(
ri
->
runid
,
l
+7,40) != 0) {

2013 
	`£Áš–Ev’t
(
LL_NOTICE
,"+»boÙ",
ri
,"%@");

2014 
	`sdsä“
(
ri
->
runid
);

2015 
ri
->
runid
 = 
	`sd¢ewËn
(
l
+7,40);

2022 ià((
ri
->
æags
 & 
SRI_MASTER
) &&

2023 
	`sd¦’
(
l
) >= 7 &&

2024 !
	`memcmp
(
l
,"¦ave",5è&& 
	`isdig™
(l[5]))

2026 *

, *
pÜt
, *
’d
;

2028 ià(
	`¡r¡r
(
l
,"="è=ğ
NULL
) {

2030 

 = 
	`¡rchr
(
l
,':'); if (!ip) ;

2031 

++;

2032 
pÜt
 = 
	`¡rchr
(

,','); if (!port) ;

2033 *
pÜt
 = '\0';

2034 
pÜt
++;

2035 
’d
 = 
	`¡rchr
(
pÜt
,','); if (!end) ;

2036 *
’d
 = '\0';

2039 

 = 
	`¡r¡r
(
l
,"ip="); if (!ip) ;

2040 

 += 3;

2041 
pÜt
 = 
	`¡r¡r
(
l
,"port="); if (!port) ;

2042 
pÜt
 += 5;

2044 
’d
 = 
	`¡rchr
(

,','); if (end) *end = '\0';

2045 
’d
 = 
	`¡rchr
(
pÜt
,','); if (end) *end = '\0';

2050 ià(
	`£Áš–RedisIn¡ªûLookupSÏve
(
ri
,

,
	`©oi
(
pÜt
)è=ğ
NULL
) {

2051 ià((
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,

,

2052 
	`©oi
(
pÜt
), 
ri
->
quÜum
,„i)è!ğ
NULL
)

2054 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave",
¦ave
,"%@");

2055 
	`£Áš–FlushCÚfig
();

2061 ià(
	`sd¦’
(
l
) >= 32 &&

2062 !
	`memcmp
(
l
,"master_link_down_since_seconds",30))

2064 
ri
->
ma¡”_lšk_down_time
 = 
	`¡¹Şl
(
l
+31,
NULL
,10)*1000;

2068 ià(!
	`memcmp
(
l
,"rŞe:ma¡”",11)è
rŞe
 = 
SRI_MASTER
;

2069 ià(!
	`memcmp
(
l
,"rŞe:¦ave",10)è
rŞe
 = 
SRI_SLAVE
;

2071 ià(
rŞe
 =ğ
SRI_SLAVE
) {

2073 ià(
	`sd¦’
(
l
è>ğ12 && !
	`memcmp
(l,"master_host:",12)) {

2074 ià(
ri
->
¦ave_ma¡”_ho¡
 =ğ
NULL
 ||

2075 
	`¡rÿ£cmp
(
l
+12,
ri
->
¦ave_ma¡”_ho¡
))

2077 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

2078 
ri
->
¦ave_ma¡”_ho¡
 = 
	`sd¢ew
(
l
+12);

2079 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

2084 ià(
	`sd¦’
(
l
è>ğ12 && !
	`memcmp
(l,"master_port:",12)) {

2085 
¦ave_ma¡”_pÜt
 = 
	`©oi
(
l
+12);

2087 ià(
ri
->
¦ave_ma¡”_pÜt
 != slave_master_port) {

2088 
ri
->
¦ave_ma¡”_pÜt
 = slave_master_port;

2089 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

2094 ià(
	`sd¦’
(
l
è>ğ19 && !
	`memcmp
(l,"master_link_status:",19)) {

2095 
ri
->
¦ave_ma¡”_lšk_¡©us
 =

2096 (
	`¡rÿ£cmp
(
l
+19,"up") == 0) ?

2097 
SENTINEL_MASTER_LINK_STATUS_UP
 :

2098 
SENTINEL_MASTER_LINK_STATUS_DOWN
;

2102 ià(
	`sd¦’
(
l
è>ğ15 && !
	`memcmp
(l,"slave_priority:",15))

2103 
ri
->
¦ave_´iÜ™y
 = 
	`©oi
(
l
+15);

2106 ià(
	`sd¦’
(
l
è>ğ18 && !
	`memcmp
(l,"slave_repl_offset:",18))

2107 
ri
->
¦ave_»¶_off£t
 = 
	`¡¹ouÎ
(
l
+18,
NULL
,10);

2110 
ri
->
šfo_»äesh
 = 
	`m¡ime
();

2111 
	`sdsä“¥l™»s
(
lšes
,
numlšes
);

2118 ià(
rŞe
 !ğ
ri
->
rŞe_»pÜ‹d
) {

2119 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

2120 
ri
->
rŞe_»pÜ‹d
 = 
rŞe
;

2121 ià(
rŞe
 =ğ
SRI_SLAVE
è
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

2124 
	`£Áš–Ev’t
(
LL_VERBOSE
,

2125 ((
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)è=ğ
rŞe
) ?

2127 
ri
, "%@‚ew„eported„ole is %s",

2128 
rŞe
 =ğ
SRI_MASTER
 ? "master" : "slave",

2129 
ri
->
æags
 & 
SRI_MASTER
 ? "master" : "slave");

2134 ià(
£Áš–
.
tt
) ;

2137 ià((
ri
->
æags
 & 
SRI_MASTER
è&& 
rŞe
 =ğ
SRI_SLAVE
) {

2144 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& 
rŞe
 =ğ
SRI_MASTER
) {

2147 ià((
ri
->
æags
 & 
SRI_PROMOTED
) &&

2148 (
ri
->
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) &&

2149 (
ri
->
ma¡”
->
çov”_¡©e
 ==

2150 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
))

2157 
ri
->
ma¡”
->
cÚfig_•och
 =„i->ma¡”->
çov”_•och
;

2158 
ri
->
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
;

2159 
ri
->
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

2160 
	`£Áš–FlushCÚfig
();

2161 
	`£Áš–Ev’t
(
LL_WARNING
,"+´omÙed-¦ave",
ri
,"%@");

2162 ià(
£Áš–
.
simçu»_æags
 &

2163 
SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION
)

2164 
	`£Áš–SimFau»C¿sh
();

2165 
	`£Áš–Ev’t
(
LL_WARNING
,"+failover-state-reconf-slaves",

2166 
ri
->
ma¡”
,"%@");

2167 
	`£Áš–C®lCl›ÁRecÚfSüt
(
ri
->
ma¡”
,
SENTINEL_LEADER
,

2168 "¡¬t",
ri
->
ma¡”
->
addr
,ri->addr);

2169 
	`£Áš–FÜûH–loUpd©eFÜMa¡”
(
ri
->
ma¡”
);

2174 
m¡ime_t
 
wa™_time
 = 
SENTINEL_PUBLISH_PERIOD
*4;

2176 ià(!(
ri
->
æags
 & 
SRI_PROMOTED
) &&

2177 
	`£Áš–Ma¡”LooksSªe
(
ri
->
ma¡”
) &&

2178 
	`£Áš–RedisIn¡ªûNoDownFÜ
(
ri
,
wa™_time
) &&

2179 
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
 > 
wa™_time
)

2181 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
,

2182 
ri
->
ma¡”
->
addr
->

,

2183 
ri
->
ma¡”
->
addr
->
pÜt
);

2184 ià(
»tv®
 =ğ
C_OK
)

2185 
	`£Áš–Ev’t
(
LL_NOTICE
,"+cÚv”t-to-¦ave",
ri
,"%@");

2191 ià((
ri
->
æags
 & 
SRI_SLAVE
) &&

2192 
rŞe
 =ğ
SRI_SLAVE
 &&

2193 (
ri
->
¦ave_ma¡”_pÜt
 !ğri->
ma¡”
->
addr
->
pÜt
 ||

2194 
	`¡rÿ£cmp
(
ri
->
¦ave_ma¡”_ho¡
,ri->
ma¡”
->
addr
->

)))

2196 
m¡ime_t
 
wa™_time
 = 
ri
->
ma¡”
->
çov”_timeout
;

2200 ià(
	`£Áš–Ma¡”LooksSªe
(
ri
->
ma¡”
) &&

2201 
	`£Áš–RedisIn¡ªûNoDownFÜ
(
ri
,
wa™_time
) &&

2202 
	`m¡ime
(è- 
ri
->
¦ave_cÚf_chªge_time
 > 
wa™_time
)

2204 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
,

2205 
ri
->
ma¡”
->
addr
->

,

2206 
ri
->
ma¡”
->
addr
->
pÜt
);

2207 ià(
»tv®
 =ğ
C_OK
)

2208 
	`£Áš–Ev’t
(
LL_NOTICE
,"+fix-¦ave-cÚfig",
ri
,"%@");

2214 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& 
rŞe
 == SRI_SLAVE &&

2215 (
ri
->
æags
 & (
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
)))

2218 ià((
ri
->
æags
 & 
SRI_RECONF_SENT
) &&

2219 
ri
->
¦ave_ma¡”_ho¡
 &&

2220 
	`¡rcmp
(
ri
->
¦ave_ma¡”_ho¡
,

2221 
ri
->
ma¡”
->
´omÙed_¦ave
->
addr
->

) == 0 &&

2222 
ri
->
¦ave_ma¡”_pÜt
 =ğri->
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
)

2224 
ri
->
æags
 &ğ~
SRI_RECONF_SENT
;

2225 
ri
->
æags
 |ğ
SRI_RECONF_INPROG
;

2226 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-š´og",
ri
,"%@");

2230 ià((
ri
->
æags
 & 
SRI_RECONF_INPROG
) &&

2231 
ri
->
¦ave_ma¡”_lšk_¡©us
 =ğ
SENTINEL_MASTER_LINK_STATUS_UP
)

2233 
ri
->
æags
 &ğ~
SRI_RECONF_INPROG
;

2234 
ri
->
æags
 |ğ
SRI_RECONF_DONE
;

2235 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-dÚe",
ri
,"%@");

2238 
	}
}

2240 
	$£Áš–InfoR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2241 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2242 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2243 
»disR•ly
 *
r
;

2245 ià(!
»¶y
 || !
lšk
) ;

2246 
lšk
->
³ndšg_commªds
--;

2247 
r
 = 
»¶y
;

2249 ià(
r
->
ty³
 =ğ
REDIS_REPLY_STRING
)

2250 
	`£Áš–ReäeshIn¡ªûInfo
(
ri
,
r
->
¡r
);

2251 
	}
}

2255 
	$£Áš–DisÿrdR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2256 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2257 
	`UNUSED
(
»¶y
);

2258 
	`UNUSED
(
´ivd©a
);

2260 ià(
lšk
èlšk->
³ndšg_commªds
--;

2261 
	}
}

2263 
	$£Áš–PšgR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2264 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2265 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2266 
»disR•ly
 *
r
;

2268 ià(!
»¶y
 || !
lšk
) ;

2269 
lšk
->
³ndšg_commªds
--;

2270 
r
 = 
»¶y
;

2272 ià(
r
->
ty³
 =ğ
REDIS_REPLY_STATUS
 ||

2273 
r
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2276 ià(
	`¡ºcmp
(
r
->
¡r
,"PONG",4) == 0 ||

2277 
	`¡ºcmp
(
r
->
¡r
,"LOADING",7) == 0 ||

2278 
	`¡ºcmp
(
r
->
¡r
,"MASTERDOWN",10) == 0)

2280 
lšk
->
Ï¡_ava_time
 = 
	`m¡ime
();

2281 
lšk
->
aù_pšg_time
 = 0;

2285 ià(
	`¡ºcmp
(
r
->
¡r
,"BUSY",4) == 0 &&

2286 (
ri
->
æags
 & 
SRI_S_DOWN
) &&

2287 !(
ri
->
æags
 & 
SRI_SCRIPT_KILL_SENT
))

2289 ià(
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2290 
£Áš–DisÿrdR•lyC®lback
, 
ri
,

2291 "SCRIPT KILL"è=ğ
C_OK
)

2292 
ri
->
lšk
->
³ndšg_commªds
++;

2293 
ri
->
æags
 |ğ
SRI_SCRIPT_KILL_SENT
;

2297 
lšk
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

2298 
	}
}

2302 
	$£Áš–PublishR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2303 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2304 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

2305 
»disR•ly
 *
r
;

2307 ià(!
»¶y
 || !
lšk
) ;

2308 
lšk
->
³ndšg_commªds
--;

2309 
r
 = 
»¶y
;

2313 ià(
r
->
ty³
 !ğ
REDIS_REPLY_ERROR
)

2314 
ri
->
Ï¡_pub_time
 = 
	`m¡ime
();

2315 
	}
}

2322 
	$£Áš–ProûssH–loMes§ge
(*
h–lo
, 
h–lo_Ën
) {

2326 
numtok’s
, 
pÜt
, 
»moved
, 
ma¡”_pÜt
;

2327 
ušt64_t
 
cu¼’t_•och
, 
ma¡”_cÚfig_•och
;

2328 **
tok’
 = 
	`sds¥l™Ën
(
h–lo
, 
h–lo_Ën
, ",", 1, &
numtok’s
);

2329 
£Áš–RedisIn¡ªû
 *
si
, *
ma¡”
;

2331 ià(
numtok’s
 == 8) {

2333 
ma¡”
 = 
	`£Áš–G‘Ma¡”ByName
(
tok’
[4]);

2334 ià(!
ma¡”
è
ş—nup
;

2337 
pÜt
 = 
	`©oi
(
tok’
[1]);

2338 
ma¡”_pÜt
 = 
	`©oi
(
tok’
[6]);

2339 
si
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(

2340 
ma¡”
->
£Áš–s
,
tok’
[0],
pÜt
,token[2]);

2341 
cu¼’t_•och
 = 
	`¡¹ouÎ
(
tok’
[3],
NULL
,10);

2342 
ma¡”_cÚfig_•och
 = 
	`¡¹ouÎ
(
tok’
[7],
NULL
,10);

2344 ià(!
si
) {

2348 
»moved
 = 
	`»moveM©chšgS’tš–FromMa¡”
(
ma¡”
,
tok’
[2]);

2349 ià(
»moved
) {

2350 
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–-add»ss-sw™ch",
ma¡”
,

2351 "%@ i°% pÜˆ%d fÜ %s", 
tok’
[0],
pÜt
,token[2]);

2357 
£Áš–RedisIn¡ªû
 *
Ùh”
 =

2358 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(

2359 
ma¡”
->
£Áš–s
, 
tok’
[0],
pÜt
,
NULL
);

2360 ià(
Ùh”
) {

2361 
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–-šv®id-addr",
Ùh”
,"%@");

2362 
Ùh”
->
addr
->
pÜt
 = 0;

2363 
	`£Áš–Upd©eS’tš–Add»ssInAÎMa¡”s
(
Ùh”
);

2368 
si
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
tok’
[2],
SRI_SENTINEL
,

2369 
tok’
[0],
pÜt
,
ma¡”
->
quÜum
,master);

2371 ià(
si
) {

2372 ià(!
»moved
è
	`£Áš–Ev’t
(
LL_NOTICE
,"+£Áš–",
si
,"%@");

2376 
si
->
runid
 = 
	`sd¢ew
(
tok’
[2]);

2377 
	`£Áš–TryCÚÃùiÚSh¬šg
(
si
);

2378 ià(
»moved
è
	`£Áš–Upd©eS’tš–Add»ssInAÎMa¡”s
(
si
);

2379 
	`£Áš–FlushCÚfig
();

2384 ià(
cu¼’t_•och
 > 
£Áš–
.current_epoch) {

2385 
£Áš–
.
cu¼’t_•och
 = current_epoch;

2386 
	`£Áš–FlushCÚfig
();

2387 
	`£Áš–Ev’t
(
LL_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

2388 (è
£Áš–
.
cu¼’t_•och
);

2392 ià(
si
 && 
ma¡”
->
cÚfig_•och
 < 
ma¡”_cÚfig_•och
) {

2393 
ma¡”
->
cÚfig_•och
 = 
ma¡”_cÚfig_•och
;

2394 ià(
ma¡”_pÜt
 !ğ
ma¡”
->
addr
->
pÜt
 ||

2395 
	`¡rcmp
(
ma¡”
->
addr
->

, 
tok’
[5]))

2397 
£Áš–Addr
 *
Şd_addr
;

2399 
	`£Áš–Ev’t
(
LL_WARNING
,"+cÚfig-upd©e-äom",
si
,"%@");

2400 
	`£Áš–Ev’t
(
LL_WARNING
,"+switch-master",

2401 
ma¡”
,"%s %s %d %s %d",

2402 
ma¡”
->
Çme
,

2403 
ma¡”
->
addr
->

, ma¡”->addr->
pÜt
,

2404 
tok’
[5], 
ma¡”_pÜt
);

2406 
Şd_addr
 = 
	`dupS’tš–Addr
(
ma¡”
->
addr
);

2407 
	`£Áš–Re£tMa¡”AndChªgeAdd»ss
(
ma¡”
, 
tok’
[5], 
ma¡”_pÜt
);

2408 
	`£Áš–C®lCl›ÁRecÚfSüt
(
ma¡”
,

2409 
SENTINEL_OBSERVER
,"start",

2410 
Şd_addr
,
ma¡”
->
addr
);

2411 
	`»Ëa£S’tš–Addr
(
Şd_addr
);

2416 ià(
si
èsi->
Ï¡_h–lo_time
 = 
	`m¡ime
();

2419 
ş—nup
:

2420 
	`sdsä“¥l™»s
(
tok’
,
numtok’s
);

2421 
	}
}

2426 
	$£Áš–ReûiveH–loMes§ges
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2427 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

2428 
»disR•ly
 *
r
;

2429 
	`UNUSED
(
c
);

2431 ià(!
»¶y
 || !
ri
) ;

2432 
r
 = 
»¶y
;

2437 
ri
->
lšk
->
pc_Ï¡_aùiv™y
 = 
	`m¡ime
();

2441 ià(
r
->
ty³
 !ğ
REDIS_REPLY_ARRAY
 ||

2442 
r
->
–em’ts
 != 3 ||

2443 
r
->
–em’t
[0]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2444 
r
->
–em’t
[1]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2445 
r
->
–em’t
[2]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2446 
	`¡rcmp
(
r
->
–em’t
[0]->
¡r
,"message") != 0) ;

2449 ià(
	`¡r¡r
(
r
->
–em’t
[2]->
¡r
,
£Áš–
.
myid
è!ğ
NULL
) ;

2451 
	`£Áš–ProûssH–loMes§ge
(
r
->
–em’t
[2]->
¡r
,„->–em’t[2]->
Ën
);

2452 
	}
}

2465 
	$£Áš–S’dH–lo
(
£Áš–RedisIn¡ªû
 *
ri
) {

2466 

[
NET_IP_STR_LEN
];

2467 
·ylßd
[
NET_IP_STR_LEN
+1024];

2468 
»tv®
;

2469 *
ªnounû_
;

2470 
ªnounû_pÜt
;

2471 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?„i :„i->master;

2472 
£Áš–Addr
 *
ma¡”_addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ma¡”
);

2474 ià(
ri
->
lšk
->
discÚÃùed
è 
C_ERR
;

2478 ià(
£Áš–
.
ªnounû_
) {

2479 
ªnounû_
 = 
£Áš–
.announce_ip;

2481 ià(
	`ª‘SockName
(
ri
->
lšk
->
cc
->
c
.
fd
,

,(),
NULL
) == -1)

2482  
C_ERR
;

2483 
ªnounû_
 = 

;

2485 
ªnounû_pÜt
 = 
£Áš–
.announce_port ?

2486 
£Áš–
.
ªnounû_pÜt
 : 
£rv”
.
pÜt
;

2489 
	`¢´štf
(
·ylßd
,(payload),

2492 
ªnounû_
, 
ªnounû_pÜt
, 
£Áš–
.
myid
,

2493 (è
£Áš–
.
cu¼’t_•och
,

2495 
ma¡”
->
Çme
,
ma¡”_addr
->

,ma¡”_addr->
pÜt
,

2496 (è
ma¡”
->
cÚfig_•och
);

2497 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2498 
£Áš–PublishR•lyC®lback
, 
ri
, "PUBLISH %s %s",

2499 
SENTINEL_HELLO_CHANNEL
,
·ylßd
);

2500 ià(
»tv®
 !ğ
C_OK
è 
C_ERR
;

2501 
ri
->
lšk
->
³ndšg_commªds
++;

2502  
C_OK
;

2503 
	}
}

2507 
	$£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
) {

2508 
diùI‹¿tÜ
 *
di
;

2509 
diùEÁry
 *
de
;

2511 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
š¡ªûs
);

2512 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2513 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2514 ià(
ri
->
Ï¡_pub_time
 >ğ(
SENTINEL_PUBLISH_PERIOD
+1))

2515 
ri
->
Ï¡_pub_time
 -ğ(
SENTINEL_PUBLISH_PERIOD
+1);

2517 
	`diùR–—£I‹¿tÜ
(
di
);

2518 
	}
}

2528 
	$£Áš–FÜûH–loUpd©eFÜMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

2529 ià(!(
ma¡”
->
æags
 & 
SRI_MASTER
)è 
C_ERR
;

2530 ià(
ma¡”
->
Ï¡_pub_time
 >ğ(
SENTINEL_PUBLISH_PERIOD
+1))

2531 
ma¡”
->
Ï¡_pub_time
 -ğ(
SENTINEL_PUBLISH_PERIOD
+1);

2532 
	`£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
ma¡”
->
£Áš–s
);

2533 
	`£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
ma¡”
->
¦aves
);

2534  
C_OK
;

2535 
	}
}

2542 
	$£Áš–S’dPšg
(
£Áš–RedisIn¡ªû
 *
ri
) {

2543 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2544 
£Áš–PšgR•lyC®lback
, 
ri
, "PING");

2545 ià(
»tv®
 =ğ
C_OK
) {

2546 
ri
->
lšk
->
³ndšg_commªds
++;

2547 
ri
->
lšk
->
Ï¡_pšg_time
 = 
	`m¡ime
();

2551 ià(
ri
->
lšk
->
aù_pšg_time
 == 0)

2552 
ri
->
lšk
->
aù_pšg_time
 =„i->lšk->
Ï¡_pšg_time
;

2557 
	}
}

2561 
	$£Áš–S’dP”iodicCommªds
(
£Áš–RedisIn¡ªû
 *
ri
) {

2562 
m¡ime_t
 
now
 = 
	`m¡ime
();

2563 
m¡ime_t
 
šfo_³riod
, 
pšg_³riod
;

2564 
»tv®
;

2568 ià(
ri
->
lšk
->
discÚÃùed
) ;

2576 ià(
ri
->
lšk
->
³ndšg_commªds
 >=

2577 
SENTINEL_MAX_PENDING_COMMANDS
 * 
ri
->
lšk
->
»fcouÁ
) ;

2587 ià((
ri
->
æags
 & 
SRI_SLAVE
) &&

2588 ((
ri
->
ma¡”
->
æags
 & (
SRI_O_DOWN
|
SRI_FAILOVER_IN_PROGRESS
)) ||

2589 (
ri
->
ma¡”_lšk_down_time
 != 0)))

2591 
šfo_³riod
 = 1000;

2593 
šfo_³riod
 = 
SENTINEL_INFO_PERIOD
;

2599 
pšg_³riod
 = 
ri
->
down_aá”_³riod
;

2600 ià(
pšg_³riod
 > 
SENTINEL_PING_PERIOD
)…ing_period = SENTINEL_PING_PERIOD;

2603 ià((
ri
->
æags
 & 
SRI_SENTINEL
) == 0 &&

2604 (
ri
->
šfo_»äesh
 == 0 ||

2605 (
now
 - 
ri
->
šfo_»äesh
è> 
šfo_³riod
))

2607 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

2608 
£Áš–InfoR•lyC®lback
, 
ri
, "INFO");

2609 ià(
»tv®
 =ğ
C_OK
è
ri
->
lšk
->
³ndšg_commªds
++;

2613 ià((
now
 - 
ri
->
lšk
->
Ï¡_pÚg_time
è> 
pšg_³riod
 &&

2614 (
now
 - 
ri
->
lšk
->
Ï¡_pšg_time
è> 
pšg_³riod
/2) {

2615 
	`£Áš–S’dPšg
(
ri
);

2619 ià((
now
 - 
ri
->
Ï¡_pub_time
è> 
SENTINEL_PUBLISH_PERIOD
) {

2620 
	`£Áš–S’dH–lo
(
ri
);

2622 
	}
}

2626 cÚ¡ *
	$£Áš–Faov”S‹SŒ
(
¡©e
) {

2627 
¡©e
) {

2628 
SENTINEL_FAILOVER_STATE_NONE
:  "none";

2629 
SENTINEL_FAILOVER_STATE_WAIT_START
:  "wait_start";

2630 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
:  "select_slave";

2631 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
:  "send_slaveof_noone";

2632 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
:  "wait_promotion";

2633 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
:  "reconf_slaves";

2634 
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
:  "update_config";

2637 
	}
}

2640 
	$addR•lyS’tš–RedisIn¡ªû
(
ş›Á
 *
c
, 
£Áš–RedisIn¡ªû
 *
ri
) {

2641 *
æags
 = 
	`sd£m±y
();

2642 *
mbl
;

2643 
f›lds
 = 0;

2645 
mbl
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2647 
	`addR•lyBulkCSŒšg
(
c
,"name");

2648 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Çme
);

2649 
f›lds
++;

2651 
	`addR•lyBulkCSŒšg
(
c
,"ip");

2652 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
addr
->

);

2653 
f›lds
++;

2655 
	`addR•lyBulkCSŒšg
(
c
,"port");

2656 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
addr
->
pÜt
);

2657 
f›lds
++;

2659 
	`addR•lyBulkCSŒšg
(
c
,"runid");

2660 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
runid
 ?„i->runid : "");

2661 
f›lds
++;

2663 
	`addR•lyBulkCSŒšg
(
c
,"flags");

2664 ià(
ri
->
æags
 & 
SRI_S_DOWN
èæag ğ
	`sdsÿt
(flags,"s_down,");

2665 ià(
ri
->
æags
 & 
SRI_O_DOWN
èæag ğ
	`sdsÿt
(flags,"o_down,");

2666 ià(
ri
->
æags
 & 
SRI_MASTER
èæag ğ
	`sdsÿt
(flags,"master,");

2667 ià(
ri
->
æags
 & 
SRI_SLAVE
èæag ğ
	`sdsÿt
(flags,"slave,");

2668 ià(
ri
->
æags
 & 
SRI_SENTINEL
èæag ğ
	`sdsÿt
(flags,"sentinel,");

2669 ià(
ri
->
lšk
->
discÚÃùed
è
æags
 = 
	`sdsÿt
(flags,"disconnected,");

2670 ià(
ri
->
æags
 & 
SRI_MASTER_DOWN
èæag ğ
	`sdsÿt
(flags,"master_down,");

2671 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)

2672 
æags
 = 
	`sdsÿt
(flags,"failover_in_progress,");

2673 ià(
ri
->
æags
 & 
SRI_PROMOTED
èæag ğ
	`sdsÿt
(flags,"promoted,");

2674 ià(
ri
->
æags
 & 
SRI_RECONF_SENT
èæag ğ
	`sdsÿt
(flags,"reconf_sent,");

2675 ià(
ri
->
æags
 & 
SRI_RECONF_INPROG
èæag ğ
	`sdsÿt
(flags,"reconf_inprog,");

2676 ià(
ri
->
æags
 & 
SRI_RECONF_DONE
èæag ğ
	`sdsÿt
(flags,"reconf_done,");

2678 ià(
	`sd¦’
(
æags
è!ğ0è
	`sd¤ªge
(flags,0,-2);

2679 
	`addR•lyBulkCSŒšg
(
c
,
æags
);

2680 
	`sdsä“
(
æags
);

2681 
f›lds
++;

2683 
	`addR•lyBulkCSŒšg
(
c
,"link-pending-commands");

2684 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
lšk
->
³ndšg_commªds
);

2685 
f›lds
++;

2687 
	`addR•lyBulkCSŒšg
(
c
,"link-refcount");

2688 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
lšk
->
»fcouÁ
);

2689 
f›lds
++;

2691 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) {

2692 
	`addR•lyBulkCSŒšg
(
c
,"failover-state");

2693 
	`addR•lyBulkCSŒšg
(
c
,(*)
	`£Áš–Faov”S‹SŒ
(
ri
->
çov”_¡©e
));

2694 
f›lds
++;

2697 
	`addR•lyBulkCSŒšg
(
c
,"last-ping-sent");

2698 
	`addR•lyBulkLÚgLÚg
(
c
,

2699 
ri
->
lšk
->
aù_pšg_time
 ? (
	`m¡ime
() -„i->link->act_ping_time) : 0);

2700 
f›lds
++;

2702 
	`addR•lyBulkCSŒšg
(
c
,"last-ok-ping-reply");

2703 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_ava_time
);

2704 
f›lds
++;

2706 
	`addR•lyBulkCSŒšg
(
c
,"last-ping-reply");

2707 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_pÚg_time
);

2708 
f›lds
++;

2710 ià(
ri
->
æags
 & 
SRI_S_DOWN
) {

2711 
	`addR•lyBulkCSŒšg
(
c
,"s-down-time");

2712 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
()-
ri
->
s_down_sšû_time
);

2713 
f›lds
++;

2716 ià(
ri
->
æags
 & 
SRI_O_DOWN
) {

2717 
	`addR•lyBulkCSŒšg
(
c
,"o-down-time");

2718 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
()-
ri
->
o_down_sšû_time
);

2719 
f›lds
++;

2722 
	`addR•lyBulkCSŒšg
(
c
,"down-after-milliseconds");

2723 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
down_aá”_³riod
);

2724 
f›lds
++;

2727 ià(
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)) {

2728 
	`addR•lyBulkCSŒšg
(
c
,"info-refresh");

2729 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
šfo_»äesh
);

2730 
f›lds
++;

2732 
	`addR•lyBulkCSŒšg
(
c
,"role-reported");

2733 
	`addR•lyBulkCSŒšg
(
c
, (
ri
->
rŞe_»pÜ‹d
 =ğ
SRI_MASTER
) ? "master" :

2735 
f›lds
++;

2737 
	`addR•lyBulkCSŒšg
(
c
,"role-reported-time");

2738 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
);

2739 
f›lds
++;

2743 ià(
ri
->
æags
 & 
SRI_MASTER
) {

2744 
	`addR•lyBulkCSŒšg
(
c
,"config-epoch");

2745 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
cÚfig_•och
);

2746 
f›lds
++;

2748 
	`addR•lyBulkCSŒšg
(
c
,"num-slaves");

2749 
	`addR•lyBulkLÚgLÚg
(
c
,
	`diùSize
(
ri
->
¦aves
));

2750 
f›lds
++;

2752 
	`addR•lyBulkCSŒšg
(
c
,"num-other-sentinels");

2753 
	`addR•lyBulkLÚgLÚg
(
c
,
	`diùSize
(
ri
->
£Áš–s
));

2754 
f›lds
++;

2756 
	`addR•lyBulkCSŒšg
(
c
,"quorum");

2757 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
quÜum
);

2758 
f›lds
++;

2760 
	`addR•lyBulkCSŒšg
(
c
,"failover-timeout");

2761 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
çov”_timeout
);

2762 
f›lds
++;

2764 
	`addR•lyBulkCSŒšg
(
c
,"parallel-syncs");

2765 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
·¿Î–_syncs
);

2766 
f›lds
++;

2768 ià(
ri
->
nÙifiÿtiÚ_süt
) {

2769 
	`addR•lyBulkCSŒšg
(
c
,"notification-script");

2770 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
nÙifiÿtiÚ_süt
);

2771 
f›lds
++;

2774 ià(
ri
->
ş›Á_»cÚfig_süt
) {

2775 
	`addR•lyBulkCSŒšg
(
c
,"client-reconfig-script");

2776 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
ş›Á_»cÚfig_süt
);

2777 
f›lds
++;

2782 ià(
ri
->
æags
 & 
SRI_SLAVE
) {

2783 
	`addR•lyBulkCSŒšg
(
c
,"master-link-down-time");

2784 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
ma¡”_lšk_down_time
);

2785 
f›lds
++;

2787 
	`addR•lyBulkCSŒšg
(
c
,"master-link-status");

2788 
	`addR•lyBulkCSŒšg
(
c
,

2789 (
ri
->
¦ave_ma¡”_lšk_¡©us
 =ğ
SENTINEL_MASTER_LINK_STATUS_UP
) ?

2791 
f›lds
++;

2793 
	`addR•lyBulkCSŒšg
(
c
,"master-host");

2794 
	`addR•lyBulkCSŒšg
(
c
,

2795 
ri
->
¦ave_ma¡”_ho¡
 ?„i->slave_master_host : "?");

2796 
f›lds
++;

2798 
	`addR•lyBulkCSŒšg
(
c
,"master-port");

2799 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_ma¡”_pÜt
);

2800 
f›lds
++;

2802 
	`addR•lyBulkCSŒšg
(
c
,"slave-priority");

2803 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_´iÜ™y
);

2804 
f›lds
++;

2806 
	`addR•lyBulkCSŒšg
(
c
,"slave-repl-offset");

2807 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_»¶_off£t
);

2808 
f›lds
++;

2812 ià(
ri
->
æags
 & 
SRI_SENTINEL
) {

2813 
	`addR•lyBulkCSŒšg
(
c
,"last-hello-message");

2814 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
Ï¡_h–lo_time
);

2815 
f›lds
++;

2817 
	`addR•lyBulkCSŒšg
(
c
,"voted-leader");

2818 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Ëad”
 ?„i->leader : "?");

2819 
f›lds
++;

2821 
	`addR•lyBulkCSŒšg
(
c
,"voted-leader-epoch");

2822 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
Ëad”_•och
);

2823 
f›lds
++;

2826 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
mbl
,
f›lds
*2);

2827 
	}
}

2831 
	$addR•lyDiùOfRedisIn¡ªûs
(
ş›Á
 *
c
, 
diù
 *
š¡ªûs
) {

2832 
diùI‹¿tÜ
 *
di
;

2833 
diùEÁry
 *
de
;

2835 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

2836 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
š¡ªûs
));

2837 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2838 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2840 
	`addR•lyS’tš–RedisIn¡ªû
(
c
,
ri
);

2842 
	`diùR–—£I‹¿tÜ
(
di
);

2843 
	}
}

2848 
£Áš–RedisIn¡ªû
 *
	$£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
ş›Á
 *
c
,

2849 
robj
 *
Çme
)

2851 
£Áš–RedisIn¡ªû
 *
ri
;

2853 
ri
 = 
	`diùF‘chV®ue
(
£Áš–
.
ma¡”s
,
Çme
->
±r
);

2854 ià(!
ri
) {

2855 
	`addR•lyE¼Ü
(
c
,"No such master withhat‚ame");

2856  
NULL
;

2858  
ri
;

2859 
	}
}

2861 
	#SENTINEL_ISQR_OK
 0

	)

2862 
	#SENTINEL_ISQR_NOQUORUM
 (1<<0)

	)

2863 
	#SENTINEL_ISQR_NOAUTH
 (1<<1)

	)

2864 
	$£Áš–IsQuÜumR—chabË
(
£Áš–RedisIn¡ªû
 *
ma¡”
, *
u§bË±r
) {

2865 
diùI‹¿tÜ
 *
di
;

2866 
diùEÁry
 *
de
;

2867 
u§bË
 = 1;

2868 
»suÉ
 = 
SENTINEL_ISQR_OK
;

2869 
vÙ”s
 = 
	`diùSize
(
ma¡”
->
£Áš–s
)+1;

2871 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

2872 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2873 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2875 ià(
ri
->
æags
 & (
SRI_S_DOWN
|
SRI_O_DOWN
)) ;

2876 
u§bË
++;

2878 
	`diùR–—£I‹¿tÜ
(
di
);

2880 ià(
u§bË
 < ()
ma¡”
->
quÜum
è
»suÉ
 |ğ
SENTINEL_ISQR_NOQUORUM
;

2881 ià(
u§bË
 < 
vÙ”s
/2+1è
»suÉ
 |ğ
SENTINEL_ISQR_NOAUTH
;

2882 ià(
u§bË±r
è*u§bË±¸ğ
u§bË
;

2883  
»suÉ
;

2884 
	}
}

2886 
	$£Áš–Commªd
(
ş›Á
 *
c
) {

2887 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"masters")) {

2889 ià(
c
->
¬gc
 !ğ2è
num¬g£¼
;

2890 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
£Áš–
.
ma¡”s
);

2891 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"master")) {

2893 
£Áš–RedisIn¡ªû
 *
ri
;

2895 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2896 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

2897 =ğ
NULL
) ;

2898 
	`addR•lyS’tš–RedisIn¡ªû
(
c
,
ri
);

2899 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"slaves")) {

2901 
£Áš–RedisIn¡ªû
 *
ri
;

2903 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2904 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2906 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
ri
->
¦aves
);

2907 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"sentinels")) {

2909 
£Áš–RedisIn¡ªû
 *
ri
;

2911 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2912 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2914 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
ri
->
£Áš–s
);

2915 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"is-master-down-by-addr")) {

2933 
£Áš–RedisIn¡ªû
 *
ri
;

2934 
»q_•och
;

2935 
ušt64_t
 
Ëad”_•och
 = 0;

2936 *
Ëad”
 = 
NULL
;

2937 
pÜt
;

2938 
isdown
 = 0;

2940 ià(
c
->
¬gc
 !ğ6è
num¬g£¼
;

2941 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
pÜt
,
NULL
è!ğ
C_OK
 ||

2942 
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
»q_•och
,
NULL
)

2943 !ğ
C_OK
)

2945 
ri
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
£Áš–
.
ma¡”s
,

2946 
c
->
¬gv
[2]->
±r
,
pÜt
,
NULL
);

2950 ià(!
£Áš–
.
tt
 && 
ri
 && (ri->
æags
 & 
SRI_S_DOWN
) &&

2951 (
ri
->
æags
 & 
SRI_MASTER
))

2952 
isdown
 = 1;

2956 ià(
ri
 &&„i->
æags
 & 
SRI_MASTER
 && 
	`¡rÿ£cmp
(
c
->
¬gv
[5]->
±r
,"*")) {

2957 
Ëad”
 = 
	`£Áš–VÙeL—d”
(
ri
,(
ušt64_t
)
»q_•och
,

2958 
c
->
¬gv
[5]->
±r
,

2959 &
Ëad”_•och
);

2964 
	`addR•lyMuÉiBulkL’
(
c
,3);

2965 
	`addR•ly
(
c
, 
isdown
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

2966 
	`addR•lyBulkCSŒšg
(
c
, 
Ëad”
 ?†eader : "*");

2967 
	`addR•lyLÚgLÚg
(
c
, ()
Ëad”_•och
);

2968 ià(
Ëad”
è
	`sdsä“
(leader);

2969 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reset")) {

2971 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2972 
	`addR•lyLÚgLÚg
(
c
,
	`£Áš–Re£tMa¡”sByP©‹º
(c->
¬gv
[2]->
±r
,
SENTINEL_GENERATE_EVENT
));

2973 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get-master-addr-by-name")) {

2975 
£Áš–RedisIn¡ªû
 *
ri
;

2977 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2978 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
c
->
¬gv
[2]->
±r
);

2979 ià(
ri
 =ğ
NULL
) {

2980 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

2982 
£Áš–Addr
 *
addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ri
);

2984 
	`addR•lyMuÉiBulkL’
(
c
,2);

2985 
	`addR•lyBulkCSŒšg
(
c
,
addr
->

);

2986 
	`addR•lyBulkLÚgLÚg
(
c
,
addr
->
pÜt
);

2988 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"failover")) {

2990 
£Áš–RedisIn¡ªû
 *
ri
;

2992 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2993 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2995 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) {

2996 
	`addR•lySds
(
c
,
	`sd¢ew
("-INPROG Failover‡lready in…rogress\r\n"));

2999 ià(
	`£Áš–S–eùSÏve
(
ri
è=ğ
NULL
) {

3000 
	`addR•lySds
(
c
,
	`sd¢ew
("-NOGOODSLAVE No suitable slaveo…romote\r\n"));

3003 
	`£rv”Log
(
LL_WARNING
,"Executing user„equested FAILOVER of '%s'",

3004 
ri
->
Çme
);

3005 
	`£Áš–S¹Faov”
(
ri
);

3006 
ri
->
æags
 |ğ
SRI_FORCE_FAILOVER
;

3007 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3008 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"pending-scripts")) {

3011 ià(
c
->
¬gc
 !ğ2è
num¬g£¼
;

3012 
	`£Áš–P’dšgSütsCommªd
(
c
);

3013 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"monitor")) {

3015 
£Áš–RedisIn¡ªû
 *
ri
;

3016 
quÜum
, 
pÜt
;

3017 

[
NET_IP_STR_LEN
];

3019 ià(
c
->
¬gc
 !ğ6è
num¬g£¼
;

3020 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[5],&
quÜum
,"Invalid quorum")

3021 !ğ
C_OK
) ;

3022 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
pÜt
,"Invalid…ort")

3023 !ğ
C_OK
) ;

3025 ià(
quÜum
 <= 0) {

3026 
	`addR•lyE¼Ü
(
c
, "Quorum must be 1 or greater.");

3033 ià(
	`ª‘ResŞveIP
(
NULL
,
c
->
¬gv
[3]->
±r
,

,()è=ğ
ANET_ERR
) {

3034 
	`addR•lyE¼Ü
(
c
,"Invalid IP‡ddress specified");

3039 
ri
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
c
->
¬gv
[2]->
±r
,
SRI_MASTER
,

3040 
c
->
¬gv
[3]->
±r
,
pÜt
,
quÜum
,
NULL
);

3041 ià(
ri
 =ğ
NULL
) {

3042 
”ºo
) {

3043 
EBUSY
:

3044 
	`addR•lyE¼Ü
(
c
,"Duplicated master‚ame");

3046 
EINVAL
:

3047 
	`addR•lyE¼Ü
(
c
,"Invalid…ort‚umber");

3050 
	`addR•lyE¼Ü
(
c
,"Unspecifiedƒrror‡ddinghe instance");

3054 
	`£Áš–FlushCÚfig
();

3055 
	`£Áš–Ev’t
(
LL_WARNING
,"+mÚ™Ü",
ri
,"%@ quÜum %d",ri->
quÜum
);

3056 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3058 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"flushconfig")) {

3059 ià(
c
->
¬gc
 !ğ2è
num¬g£¼
;

3060 
	`£Áš–FlushCÚfig
();

3061 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3063 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"remove")) {

3065 
£Áš–RedisIn¡ªû
 *
ri
;

3067 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

3068 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

3069 =ğ
NULL
) ;

3070 
	`£Áš–Ev’t
(
LL_WARNING
,"-mÚ™Ü",
ri
,"%@");

3071 
	`diùD–‘e
(
£Áš–
.
ma¡”s
,
c
->
¬gv
[2]->
±r
);

3072 
	`£Áš–FlushCÚfig
();

3073 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3074 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"ckquorum")) {

3076 
£Áš–RedisIn¡ªû
 *
ri
;

3077 
u§bË
;

3079 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

3080 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

3081 =ğ
NULL
) ;

3082 
»suÉ
 = 
	`£Áš–IsQuÜumR—chabË
(
ri
,&
u§bË
);

3083 ià(
»suÉ
 =ğ
SENTINEL_ISQR_OK
) {

3084 
	`addR•lySds
(
c
, 
	`sdsÿtfmt
(
	`sd£m±y
(),

3086 "ÿÀb»ached\r\n",
u§bË
));

3088 
sds
 
e
 = 
	`sdsÿtfmt
(
	`sd£m±y
(),

3089 "-NOQUORUM %˜u§bË S’tš–s. ",
u§bË
);

3090 ià(
»suÉ
 & 
SENTINEL_ISQR_NOQUORUM
)

3091 
e
 = 
	`sdsÿt
(e,"Notƒnough‡vailable Sentinelso„eachhe"

3093 ià(
»suÉ
 & 
SENTINEL_ISQR_NOAUTH
) {

3094 ià(
»suÉ
 & 
SENTINEL_ISQR_NOQUORUM
è
e
 = 
	`sdsÿt
(e,". ");

3095 
e
 = 
	`sdsÿt
(e, "Notƒnough‡vailable Sentinelso„eachhe"

3098 
e
 = 
	`sdsÿt
(e,"\r\n");

3099 
	`addR•lySds
(
c
,
e
);

3101 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set")) {

3102 ià(
c
->
¬gc
 < 3 || c->¬gø% 2 =ğ0è
num¬g£¼
;

3103 
	`£Áš–S‘Commªd
(
c
);

3104 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"info-cache")) {

3106 ià(
c
->
¬gc
 < 2è
num¬g£¼
;

3107 
m¡ime_t
 
now
 = 
	`m¡ime
();

3112 
diùTy³
 
cİy_k“³r
 = 
š¡ªûsDiùTy³
;

3113 
cİy_k“³r
.
v®De¡ruùÜ
 = 
NULL
;

3114 
diù
 *
ma¡”s_loÿl
 = 
£Áš–
.
ma¡”s
;

3115 ià(
c
->
¬gc
 > 2) {

3116 
ma¡”s_loÿl
 = 
	`diùC»©e
(&
cİy_k“³r
, 
NULL
);

3118 
i
 = 2; i < 
c
->
¬gc
; i++) {

3119 
£Áš–RedisIn¡ªû
 *
ri
;

3120 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
c
->
¬gv
[
i
]->
±r
);

3121 ià(!
ri
) ;

3122 
	`diùAdd
(
ma¡”s_loÿl
, 
ri
->
Çme
,„i);

3134 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
ma¡”s_loÿl
) * 2);

3136 
diùI‹¿tÜ
 *
di
;

3137 
diùEÁry
 *
de
;

3138 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”s_loÿl
);

3139 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3140 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3141 
	`addR•lyBulkCBufãr
(
c
,
ri
->
Çme
,
	`¡¾’
(ri->name));

3142 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
ri
->
¦aves
) + 1);

3143 
	`addR•lyMuÉiBulkL’
(
c
,2);

3144 
	`addR•lyLÚgLÚg
(
c
, 
now
 - 
ri
->
šfo_»äesh
);

3145 ià(
ri
->
šfo
)

3146 
	`addR•lyBulkCBufãr
(
c
,
ri
->
šfo
,
	`sd¦’
(ri->info));

3148 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3150 
diùI‹¿tÜ
 *
sdi
;

3151 
diùEÁry
 *
sde
;

3152 
sdi
 = 
	`diùG‘I‹¿tÜ
(
ri
->
¦aves
);

3153 (
sde
 = 
	`diùNext
(
sdi
)è!ğ
NULL
) {

3154 
£Áš–RedisIn¡ªû
 *
¤i
 = 
	`diùG‘V®
(
sde
);

3155 
	`addR•lyMuÉiBulkL’
(
c
,2);

3156 
	`addR•lyLÚgLÚg
(
c
, 
now
 - 
¤i
->
šfo_»äesh
);

3157 ià(
¤i
->
šfo
)

3158 
	`addR•lyBulkCBufãr
(
c
,
¤i
->
šfo
,
	`sd¦’
(sri->info));

3160 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3162 
	`diùR–—£I‹¿tÜ
(
sdi
);

3164 
	`diùR–—£I‹¿tÜ
(
di
);

3165 ià(
ma¡”s_loÿl
 !ğ
£Áš–
.
ma¡”s
è
	`diùR–—£
(masters_local);

3166 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"simulate-failure")) {

3168 
j
;

3170 
£Áš–
.
simçu»_æags
 = 
SENTINEL_SIMFAILURE_NONE
;

3171 
j
 = 2; j < 
c
->
¬gc
; j++) {

3172 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"crash-after-election")) {

3173 
£Áš–
.
simçu»_æags
 |=

3174 
SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION
;

3175 
	`£rv”Log
(
LL_WARNING
,"Failure simulation:his Sentinel "

3178 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"crash-after-promotion")) {

3179 
£Áš–
.
simçu»_æags
 |=

3180 
SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION
;

3181 
	`£rv”Log
(
LL_WARNING
,"Failure simulation:his Sentinel "

3183 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"help")) {

3184 
	`addR•lyMuÉiBulkL’
(
c
,2);

3185 
	`addR•lyBulkCSŒšg
(
c
,"crash-after-election");

3186 
	`addR•lyBulkCSŒšg
(
c
,"crash-after-promotion");

3188 
	`addR•lyE¼Ü
(
c
,"Unknown failure simulation specified");

3192 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3194 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown sentinel subcommand '%s'",

3195 (*)
c
->
¬gv
[1]->
±r
);

3199 
num¬g£¼
:

3200 
	`addR•lyE¼ÜFÜm©
(
c
,"Wrong‚umber of‡rguments for 'sentinel %s'",

3201 (*)
c
->
¬gv
[1]->
±r
);

3202 
	}
}

3204 
	#šfo_£ùiÚ_äom_»dis
(
£ùiÚ_Çme
) do { \

3205 ià(
def£ùiÚs
 || 
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,
£ùiÚ_Çme
)) { \

3206 
sds
 
»dis£ùiÚ
; \

3207 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n"); \

3208 
»dis£ùiÚ
 = 
	`g’RedisInfoSŒšg
(
£ùiÚ_Çme
); \

3209 
šfo
 = 
	`sdsÿ’
(šfo,
»dis£ùiÚ
,
	`sd¦’
(redissection)); \

3210 
	`sdsä“
(
»dis£ùiÚ
); \

3212 } 0)

	)

3215 
	$£Áš–InfoCommªd
(
ş›Á
 *
c
) {

3216 ià(
c
->
¬gc
 > 2) {

3217 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

3221 
def£ùiÚs
 = 0, 
®l£ùiÚs
 = 0;

3222 *
£ùiÚ
 = 
c
->
¬gc
 =ğ2 ? c->
¬gv
[1]->
±r
 : 
NULL
;

3223 ià(
£ùiÚ
) {

3224 
®l£ùiÚs
 = !
	`¡rÿ£cmp
(
£ùiÚ
,"all");

3225 
def£ùiÚs
 = !
	`¡rÿ£cmp
(
£ùiÚ
,"default");

3227 
def£ùiÚs
 = 1;

3230 
£ùiÚs
 = 0;

3231 
sds
 
šfo
 = 
	`sd£m±y
();

3233 
	`šfo_£ùiÚ_äom_»dis
("server");

3234 
	`šfo_£ùiÚ_äom_»dis
("clients");

3235 
	`šfo_£ùiÚ_äom_»dis
("cpu");

3236 
	`šfo_£ùiÚ_äom_»dis
("stats");

3238 ià(
def£ùiÚs
 || 
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"sentinel")) {

3239 
diùI‹¿tÜ
 *
di
;

3240 
diùEÁry
 *
de
;

3241 
ma¡”_id
 = 0;

3243 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3244 
šfo
 = 
	`sdsÿrštf
(info,

3251 
	`diùSize
(
£Áš–
.
ma¡”s
),

3252 
£Áš–
.
tt
,

3253 
£Áš–
.
ruÂšg_süts
,

3254 
	`li¡L’gth
(
£Áš–
.
süts_queue
),

3255 
£Áš–
.
simçu»_æags
);

3257 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

3258 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3259 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3260 *
¡©us
 = "ok";

3262 ià(
ri
->
æags
 & 
SRI_O_DOWN
è
¡©us
 = "odown";

3263 ià(
ri
->
æags
 & 
SRI_S_DOWN
è
¡©us
 = "sdown";

3264 
šfo
 = 
	`sdsÿrštf
(info,

3267 
ma¡”_id
++, 
ri
->
Çme
, 
¡©us
,

3268 
ri
->
addr
->

,„i->addr->
pÜt
,

3269 
	`diùSize
(
ri
->
¦aves
),

3270 
	`diùSize
(
ri
->
£Áš–s
)+1);

3272 
	`diùR–—£I‹¿tÜ
(
di
);

3275 
	`addR•lyBulkSds
(
c
, 
šfo
);

3276 
	}
}

3280 
	$£Áš–RŞeCommªd
(
ş›Á
 *
c
) {

3281 
diùI‹¿tÜ
 *
di
;

3282 
diùEÁry
 *
de
;

3284 
	`addR•lyMuÉiBulkL’
(
c
,2);

3285 
	`addR•lyBulkCBufãr
(
c
,"sentinel",8);

3286 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
£Áš–
.
ma¡”s
));

3288 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

3289 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3290 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3292 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Çme
);

3294 
	`diùR–—£I‹¿tÜ
(
di
);

3295 
	}
}

3298 
	$£Áš–S‘Commªd
(
ş›Á
 *
c
) {

3299 
£Áš–RedisIn¡ªû
 *
ri
;

3300 
j
, 
chªges
 = 0;

3301 *
İtiÚ
, *
v®ue
;

3303 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

3304 =ğ
NULL
) ;

3307 
j
 = 3; j < 
c
->
¬gc
; j += 2) {

3308 
İtiÚ
 = 
c
->
¬gv
[
j
]->
±r
;

3309 
v®ue
 = 
c
->
¬gv
[
j
+1]->
±r
;

3310 
robj
 *
o
 = 
c
->
¬gv
[
j
+1];

3311 
Î
;

3313 ià(!
	`¡rÿ£cmp
(
İtiÚ
,"down-after-milliseconds")) {

3315 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3316 
badfmt
;

3317 
ri
->
down_aá”_³riod
 = 
Î
;

3318 
	`£Áš–Prİag©eDownAá”P”iod
(
ri
);

3319 
chªges
++;

3320 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"failover-timeout")) {

3322 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3323 
badfmt
;

3324 
ri
->
çov”_timeout
 = 
Î
;

3325 
chªges
++;

3326 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"parallel-syncs")) {

3328 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3329 
badfmt
;

3330 
ri
->
·¿Î–_syncs
 = 
Î
;

3331 
chªges
++;

3332 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"notification-script")) {

3334 ià(
	`¡¾’
(
v®ue
è&& 
	`acûss
(v®ue,
X_OK
) == -1) {

3335 
	`addR•lyE¼Ü
(
c
,

3337 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3340 
	`sdsä“
(
ri
->
nÙifiÿtiÚ_süt
);

3341 
ri
->
nÙifiÿtiÚ_süt
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

3342 
chªges
++;

3343 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"client-reconfig-script")) {

3345 ià(
	`¡¾’
(
v®ue
è&& 
	`acûss
(v®ue,
X_OK
) == -1) {

3346 
	`addR•lyE¼Ü
(
c
,

3349 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3352 
	`sdsä“
(
ri
->
ş›Á_»cÚfig_süt
);

3353 
ri
->
ş›Á_»cÚfig_süt
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

3354 
chªges
++;

3355 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"auth-pass")) {

3357 
	`sdsä“
(
ri
->
auth_·ss
);

3358 
ri
->
auth_·ss
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

3359 
chªges
++;

3360 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"quorum")) {

3362 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
C_ERR
 ||†l <= 0)

3363 
badfmt
;

3364 
ri
->
quÜum
 = 
Î
;

3365 
chªges
++;

3367 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown option '%s' for SENTINEL SET",

3368 
İtiÚ
);

3369 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3372 
	`£Áš–Ev’t
(
LL_WARNING
,"+£t",
ri
,"%@ % %s",
İtiÚ
,
v®ue
);

3375 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3376 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3379 
badfmt
:

3380 ià(
chªges
è
	`£Áš–FlushCÚfig
();

3381 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‡rgument '%s' for SENTINEL SET '%s'",

3382 
v®ue
, 
İtiÚ
);

3383 
	}
}

3391 
	$£Áš–PublishCommªd
(
ş›Á
 *
c
) {

3392 ià(
	`¡rcmp
(
c
->
¬gv
[1]->
±r
,
SENTINEL_HELLO_CHANNEL
)) {

3393 
	`addR•lyE¼Ü
(
c
, "Only HELLO messages‡re‡ccepted by Sentinel instances.");

3396 
	`£Áš–ProûssH–loMes§ge
(
c
->
¬gv
[2]->
±r
,
	`sd¦’
(c->argv[2]->ptr));

3397 
	`addR•lyLÚgLÚg
(
c
,1);

3398 
	}
}

3403 
	$£Áš–CheckSubjeùiv–yDown
(
£Áš–RedisIn¡ªû
 *
ri
) {

3404 
m¡ime_t
 
–­£d
 = 0;

3406 ià(
ri
->
lšk
->
aù_pšg_time
)

3407 
–­£d
 = 
	`m¡ime
(è- 
ri
->
lšk
->
aù_pšg_time
;

3408 ià(
ri
->
lšk
->
discÚÃùed
)

3409 
–­£d
 = 
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_ava_time
;

3417 ià(
ri
->
lšk
->
cc
 &&

3418 (
	`m¡ime
(è- 
ri
->
lšk
->
cc_cÚn_time
) >

3419 
SENTINEL_MIN_LINK_RECONNECT_PERIOD
 &&

3420 
ri
->
lšk
->
aù_pšg_time
 != 0 &&

3423 (
	`m¡ime
(è- 
ri
->
lšk
->
aù_pšg_time
è> (ri->
down_aá”_³riod
/2) &&

3424 (
	`m¡ime
(è- 
ri
->
lšk
->
Ï¡_pÚg_time
è> (ri->
down_aá”_³riod
/2))

3426 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
cc
);

3434 ià(
ri
->
lšk
->
pc
 &&

3435 (
	`m¡ime
(è- 
ri
->
lšk
->
pc_cÚn_time
) >

3436 
SENTINEL_MIN_LINK_RECONNECT_PERIOD
 &&

3437 (
	`m¡ime
(è- 
ri
->
lšk
->
pc_Ï¡_aùiv™y
è> (
SENTINEL_PUBLISH_PERIOD
*3))

3439 
	`š¡ªûLškClo£CÚÃùiÚ
(
ri
->
lšk
,ri->lšk->
pc
);

3448 ià(
–­£d
 > 
ri
->
down_aá”_³riod
 ||

3449 (
ri
->
æags
 & 
SRI_MASTER
 &&

3450 
ri
->
rŞe_»pÜ‹d
 =ğ
SRI_SLAVE
 &&

3451 
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
 >

3452 (
ri
->
down_aá”_³riod
+
SENTINEL_INFO_PERIOD
*2)))

3455 ià((
ri
->
æags
 & 
SRI_S_DOWN
) == 0) {

3456 
	`£Áš–Ev’t
(
LL_WARNING
,"+sdown",
ri
,"%@");

3457 
ri
->
s_down_sšû_time
 = 
	`m¡ime
();

3458 
ri
->
æags
 |ğ
SRI_S_DOWN
;

3462 ià(
ri
->
æags
 & 
SRI_S_DOWN
) {

3463 
	`£Áš–Ev’t
(
LL_WARNING
,"-sdown",
ri
,"%@");

3464 
ri
->
æags
 &ğ~(
SRI_S_DOWN
|
SRI_SCRIPT_KILL_SENT
);

3467 
	}
}

3475 
	$£Áš–CheckObjeùiv–yDown
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3476 
diùI‹¿tÜ
 *
di
;

3477 
diùEÁry
 *
de
;

3478 
quÜum
 = 0, 
odown
 = 0;

3480 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
) {

3482 
quÜum
 = 1;

3484 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3485 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3486 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3488 ià(
ri
->
æags
 & 
SRI_MASTER_DOWN
è
quÜum
++;

3490 
	`diùR–—£I‹¿tÜ
(
di
);

3491 ià(
quÜum
 >ğ
ma¡”
->quÜumè
odown
 = 1;

3495 ià(
odown
) {

3496 ià((
ma¡”
->
æags
 & 
SRI_O_DOWN
) == 0) {

3497 
	`£Áš–Ev’t
(
LL_WARNING
,"+odown",
ma¡”
,"%@ #quorum %d/%d",

3498 
quÜum
, 
ma¡”
->quorum);

3499 
ma¡”
->
æags
 |ğ
SRI_O_DOWN
;

3500 
ma¡”
->
o_down_sšû_time
 = 
	`m¡ime
();

3503 ià(
ma¡”
->
æags
 & 
SRI_O_DOWN
) {

3504 
	`£Áš–Ev’t
(
LL_WARNING
,"-odown",
ma¡”
,"%@");

3505 
ma¡”
->
æags
 &ğ~
SRI_O_DOWN
;

3508 
	}
}

3512 
	$£Áš–ReûiveIsMa¡”DownR•ly
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

3513 
£Áš–RedisIn¡ªû
 *
ri
 = 
´ivd©a
;

3514 
š¡ªûLšk
 *
lšk
 = 
c
->
d©a
;

3515 
»disR•ly
 *
r
;

3517 ià(!
»¶y
 || !
lšk
) ;

3518 
lšk
->
³ndšg_commªds
--;

3519 
r
 = 
»¶y
;

3524 ià(
r
->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&„->
–em’ts
 == 3 &&

3525 
r
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

3526 
r
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

3527 
r
->
–em’t
[2]->
ty³
 =ğ
REDIS_REPLY_INTEGER
)

3529 
ri
->
Ï¡_ma¡”_down_»¶y_time
 = 
	`m¡ime
();

3530 ià(
r
->
–em’t
[0]->
š‹g”
 == 1) {

3531 
ri
->
æags
 |ğ
SRI_MASTER_DOWN
;

3533 
ri
->
æags
 &ğ~
SRI_MASTER_DOWN
;

3535 ià(
	`¡rcmp
(
r
->
–em’t
[1]->
¡r
,"*")) {

3538 
	`sdsä“
(
ri
->
Ëad”
);

3539 ià(()
ri
->
Ëad”_•och
 !ğ
r
->
–em’t
[2]->
š‹g”
)

3540 
	`£rv”Log
(
LL_WARNING
,

3541 "% vÙed fÜ % %Îu", 
ri
->
Çme
,

3542 
r
->
–em’t
[1]->
¡r
,

3543 (è
r
->
–em’t
[2]->
š‹g”
);

3544 
ri
->
Ëad”
 = 
	`sd¢ew
(
r
->
–em’t
[1]->
¡r
);

3545 
ri
->
Ëad”_•och
 = 
r
->
–em’t
[2]->
š‹g”
;

3548 
	}
}

3554 
	#SENTINEL_ASK_FORCED
 (1<<0)

	)

3555 
	$£Áš–AskMa¡”S‹ToOth”S’tš–s
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
æags
) {

3556 
diùI‹¿tÜ
 *
di
;

3557 
diùEÁry
 *
de
;

3559 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3560 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3561 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3562 
m¡ime_t
 
–­£d
 = 
	`m¡ime
(è- 
ri
->
Ï¡_ma¡”_down_»¶y_time
;

3563 
pÜt
[32];

3564 
»tv®
;

3567 ià(
–­£d
 > 
SENTINEL_ASK_PERIOD
*5) {

3568 
ri
->
æags
 &ğ~
SRI_MASTER_DOWN
;

3569 
	`sdsä“
(
ri
->
Ëad”
);

3570 
ri
->
Ëad”
 = 
NULL
;

3578 ià((
ma¡”
->
æags
 & 
SRI_S_DOWN
) == 0) ;

3579 ià(
ri
->
lšk
->
discÚÃùed
) ;

3580 ià(!(
æags
 & 
SENTINEL_ASK_FORCED
) &&

3581 
	`m¡ime
(è- 
ri
->
Ï¡_ma¡”_down_»¶y_time
 < 
SENTINEL_ASK_PERIOD
)

3585 
	`Î2¡ršg
(
pÜt
,ÕÜt),
ma¡”
->
addr
->port);

3586 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3587 
£Áš–ReûiveIsMa¡”DownR•ly
, 
ri
,

3589 
ma¡”
->
addr
->

, 
pÜt
,

3590 
£Áš–
.
cu¼’t_•och
,

3591 (
ma¡”
->
çov”_¡©e
 > 
SENTINEL_FAILOVER_STATE_NONE
) ?

3592 
£Áš–
.
myid
 : "*");

3593 ià(
»tv®
 =ğ
C_OK
è
ri
->
lšk
->
³ndšg_commªds
++;

3595 
	`diùR–—£I‹¿tÜ
(
di
);

3596 
	}
}

3601 
	$£Áš–SimFau»C¿sh
() {

3602 
	`£rv”Log
(
LL_WARNING
,

3604 
	`ex™
(99);

3605 
	}
}

3612 *
	$£Áš–VÙeL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
»q_•och
, *
»q_runid
, ušt64_ˆ*
Ëad”_•och
) {

3613 ià(
»q_•och
 > 
£Áš–
.
cu¼’t_•och
) {

3614 
£Áš–
.
cu¼’t_•och
 = 
»q_•och
;

3615 
	`£Áš–FlushCÚfig
();

3616 
	`£Áš–Ev’t
(
LL_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

3617 (è
£Áš–
.
cu¼’t_•och
);

3620 ià(
ma¡”
->
Ëad”_•och
 < 
»q_•och
 && 
£Áš–
.
cu¼’t_•och
 <=„eq_epoch)

3622 
	`sdsä“
(
ma¡”
->
Ëad”
);

3623 
ma¡”
->
Ëad”
 = 
	`sd¢ew
(
»q_runid
);

3624 
ma¡”
->
Ëad”_•och
 = 
£Áš–
.
cu¼’t_•och
;

3625 
	`£Áš–FlushCÚfig
();

3626 
	`£Áš–Ev’t
(
LL_WARNING
,"+vÙe-fÜ-Ëad”",
ma¡”
,"%s %llu",

3627 
ma¡”
->
Ëad”
, (èma¡”->
Ëad”_•och
);

3631 ià(
	`¡rÿ£cmp
(
ma¡”
->
Ëad”
,
£Áš–
.
myid
))

3632 
ma¡”
->
çov”_¡¬t_time
 = 
	`m¡ime
()+
	`¿nd
()%
SENTINEL_MAX_DESYNC
;

3635 *
Ëad”_•och
 = 
ma¡”
->leader_epoch;

3636  
ma¡”
->
Ëad”
 ? 
	`sd¢ew
(ma¡”->Ëad”è: 
NULL
;

3637 
	}
}

3639 
	s£Áš–L—d”
 {

3640 *
	mrunid
;

3641 
	mvÙes
;

3646 
	$£Áš–L—d”Inü
(
diù
 *
couÁ”s
, *
runid
) {

3647 
diùEÁry
 *
exi¡šg
, *
de
;

3648 
ušt64_t
 
Şdv®
;

3650 
de
 = 
	`diùAddRaw
(
couÁ”s
,
runid
,&
exi¡šg
);

3651 ià(
exi¡šg
) {

3652 
Şdv®
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
exi¡šg
);

3653 
	`diùS‘UnsigÃdIÁeg”V®
(
exi¡šg
,
Şdv®
+1);

3654  
Şdv®
+1;

3656 
	`£rv”As£¹
(
de
 !ğ
NULL
);

3657 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,1);

3660 
	}
}

3668 *
	$£Áš–G‘L—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
•och
) {

3669 
diù
 *
couÁ”s
;

3670 
diùI‹¿tÜ
 *
di
;

3671 
diùEÁry
 *
de
;

3672 
vÙ”s
 = 0, 
vÙ”s_quÜum
;

3673 *
myvÙe
;

3674 *
wšÃr
 = 
NULL
;

3675 
ušt64_t
 
Ëad”_•och
;

3676 
ušt64_t
 
max_vÙes
 = 0;

3678 
	`£rv”As£¹
(
ma¡”
->
æags
 & (
SRI_O_DOWN
|
SRI_FAILOVER_IN_PROGRESS
));

3679 
couÁ”s
 = 
	`diùC»©e
(&
Ëad”VÙesDiùTy³
,
NULL
);

3681 
vÙ”s
 = 
	`diùSize
(
ma¡”
->
£Áš–s
)+1;

3684 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3685 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3686 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3687 ià(
ri
->
Ëad”
 !ğ
NULL
 &&„i->
Ëad”_•och
 =ğ
£Áš–
.
cu¼’t_•och
)

3688 
	`£Áš–L—d”Inü
(
couÁ”s
,
ri
->
Ëad”
);

3690 
	`diùR–—£I‹¿tÜ
(
di
);

3695 
di
 = 
	`diùG‘I‹¿tÜ
(
couÁ”s
);

3696 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3697 
ušt64_t
 
vÙes
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

3699 ià(
vÙes
 > 
max_vÙes
) {

3700 
max_vÙes
 = 
vÙes
;

3701 
wšÃr
 = 
	`diùG‘Key
(
de
);

3704 
	`diùR–—£I‹¿tÜ
(
di
);

3709 ià(
wšÃr
)

3710 
myvÙe
 = 
	`£Áš–VÙeL—d”
(
ma¡”
,
•och
,
wšÃr
,&
Ëad”_•och
);

3712 
myvÙe
 = 
	`£Áš–VÙeL—d”
(
ma¡”
,
•och
,
£Áš–
.
myid
,&
Ëad”_•och
);

3714 ià(
myvÙe
 && 
Ëad”_•och
 =ğ
•och
) {

3715 
ušt64_t
 
vÙes
 = 
	`£Áš–L—d”Inü
(
couÁ”s
,
myvÙe
);

3717 ià(
vÙes
 > 
max_vÙes
) {

3718 
max_vÙes
 = 
vÙes
;

3719 
wšÃr
 = 
myvÙe
;

3723 
vÙ”s_quÜum
 = 
vÙ”s
/2+1;

3724 ià(
wšÃr
 && (
max_vÙes
 < 
vÙ”s_quÜum
 || max_vÙe < 
ma¡”
->
quÜum
))

3725 
wšÃr
 = 
NULL
;

3727 
wšÃr
 = wšÃ¸? 
	`sd¢ew
(wšÃrè: 
NULL
;

3728 
	`sdsä“
(
myvÙe
);

3729 
	`diùR–—£
(
couÁ”s
);

3730  
wšÃr
;

3731 
	}
}

3743 
	$£Áš–S’dSÏveOf
(
£Áš–RedisIn¡ªû
 *
ri
, *
ho¡
, 
pÜt
) {

3744 
pÜt¡r
[32];

3745 
»tv®
;

3747 
	`Î2¡ršg
(
pÜt¡r
,ÕÜt¡r),
pÜt
);

3751 ià(
ho¡
 =ğ
NULL
) {

3752 
ho¡
 = "NO";

3753 
	`memıy
(
pÜt¡r
,"ONE",4);

3766 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3767 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "MULTI");

3768 ià(
»tv®
 =ğ
C_ERR
) „etval;

3769 
ri
->
lšk
->
³ndšg_commªds
++;

3771 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3772 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "SLAVEOF % %s", 
ho¡
, 
pÜt¡r
);

3773 ià(
»tv®
 =ğ
C_ERR
) „etval;

3774 
ri
->
lšk
->
³ndšg_commªds
++;

3776 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3777 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "CONFIG REWRITE");

3778 ià(
»tv®
 =ğ
C_ERR
) „etval;

3779 
ri
->
lšk
->
³ndšg_commªds
++;

3786 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3787 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "CLIENT KILL TYPE‚ormal");

3788 ià(
»tv®
 =ğ
C_ERR
) „etval;

3789 
ri
->
lšk
->
³ndšg_commªds
++;

3791 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
lšk
->
cc
,

3792 
£Áš–DisÿrdR•lyC®lback
, 
ri
, "EXEC");

3793 ià(
»tv®
 =ğ
C_ERR
) „etval;

3794 
ri
->
lšk
->
³ndšg_commªds
++;

3796  
C_OK
;

3797 
	}
}

3800 
	$£Áš–S¹Faov”
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3801 
	`£rv”As£¹
(
ma¡”
->
æags
 & 
SRI_MASTER
);

3803 
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_WAIT_START
;

3804 
ma¡”
->
æags
 |ğ
SRI_FAILOVER_IN_PROGRESS
;

3805 
ma¡”
->
çov”_•och
 = ++
£Áš–
.
cu¼’t_•och
;

3806 
	`£Áš–Ev’t
(
LL_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

3807 (è
£Áš–
.
cu¼’t_•och
);

3808 
	`£Áš–Ev’t
(
LL_WARNING
,"+Œy-çov”",
ma¡”
,"%@");

3809 
ma¡”
->
çov”_¡¬t_time
 = 
	`m¡ime
()+
	`¿nd
()%
SENTINEL_MAX_DESYNC
;

3810 
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3811 
	}
}

3824 
	$£Áš–S¹Faov”IfN“ded
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3826 ià(!(
ma¡”
->
æags
 & 
SRI_O_DOWN
))  0;

3829 ià(
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)  0;

3832 ià(
	`m¡ime
(è- 
ma¡”
->
çov”_¡¬t_time
 <

3833 
ma¡”
->
çov”_timeout
*2)

3835 ià(
ma¡”
->
çov”_d–ay_logged
 !ğma¡”->
çov”_¡¬t_time
) {

3836 
time_t
 
şock
 = (
ma¡”
->
çov”_¡¬t_time
 +

3837 
ma¡”
->
çov”_timeout
*2) / 1000;

3838 
ùimebuf
[26];

3840 
	`ùime_r
(&
şock
,
ùimebuf
);

3841 
ùimebuf
[24] = '\0';

3842 
ma¡”
->
çov”_d–ay_logged
 = ma¡”->
çov”_¡¬t_time
;

3843 
	`£rv”Log
(
LL_WARNING
,

3845 
ùimebuf
);

3850 
	`£Áš–S¹Faov”
(
ma¡”
);

3852 
	}
}

3886 
	$com·»SÏvesFÜPromÙiÚ
(cÚ¡ *
a
, cÚ¡ *
b
) {

3887 
£Áš–RedisIn¡ªû
 **
§
 = (£Áš–RedisIn¡ªû **)
a
,

3888 **
sb
 = (
£Áš–RedisIn¡ªû
 **)
b
;

3889 *
§_runid
, *
sb_runid
;

3891 ià((*
§
)->
¦ave_´iÜ™y
 !ğ(*
sb
)->slave_priority)

3892  (*
§
)->
¦ave_´iÜ™y
 - (*
sb
)->slave_priority;

3896 ià((*
§
)->
¦ave_»¶_off£t
 > (*
sb
)->slave_repl_offset) {

3898 } ià((*
§
)->
¦ave_»¶_off£t
 < (*
sb
)->slave_repl_offset) {

3906 
§_runid
 = (*
§
)->
runid
;

3907 
sb_runid
 = (*
sb
)->
runid
;

3908 ià(
§_runid
 =ğ
NULL
 && 
sb_runid
 == NULL)  0;

3909 ià(
§_runid
 =ğ
NULL
)  1;

3910 ià(
sb_runid
 =ğ
NULL
)  -1;

3911  
	`¡rÿ£cmp
(
§_runid
, 
sb_runid
);

3912 
	}
}

3914 
£Áš–RedisIn¡ªû
 *
	$£Áš–S–eùSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3915 
£Áš–RedisIn¡ªû
 **
š¡ªû
 =

3916 
	`zm®loc
((
š¡ªû
[0])*
	`diùSize
(
ma¡”
->
¦aves
));

3917 
£Áš–RedisIn¡ªû
 *
£Ëùed
 = 
NULL
;

3918 
š¡ªûs
 = 0;

3919 
diùI‹¿tÜ
 *
di
;

3920 
diùEÁry
 *
de
;

3921 
m¡ime_t
 
max_ma¡”_down_time
 = 0;

3923 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
)

3924 
max_ma¡”_down_time
 +ğ
	`m¡ime
(è- 
ma¡”
->
s_down_sšû_time
;

3925 
max_ma¡”_down_time
 +ğ
ma¡”
->
down_aá”_³riod
 * 10;

3927 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

3928 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3929 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

3930 
m¡ime_t
 
šfo_v®id™y_time
;

3932 ià(
¦ave
->
æags
 & (
SRI_S_DOWN
|
SRI_O_DOWN
)) ;

3933 ià(
¦ave
->
lšk
->
discÚÃùed
) ;

3934 ià(
	`m¡ime
(è- 
¦ave
->
lšk
->
Ï¡_ava_time
 > 
SENTINEL_PING_PERIOD
*5) ;

3935 ià(
¦ave
->
¦ave_´iÜ™y
 == 0) ;

3940 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
)

3941 
šfo_v®id™y_time
 = 
SENTINEL_PING_PERIOD
*5;

3943 
šfo_v®id™y_time
 = 
SENTINEL_INFO_PERIOD
*3;

3944 ià(
	`m¡ime
(è- 
¦ave
->
šfo_»äesh
 > 
šfo_v®id™y_time
) ;

3945 ià(
¦ave
->
ma¡”_lšk_down_time
 > 
max_ma¡”_down_time
) ;

3946 
š¡ªû
[
š¡ªûs
++] = 
¦ave
;

3948 
	`diùR–—£I‹¿tÜ
(
di
);

3949 ià(
š¡ªûs
) {

3950 
	`qsÜt
(
š¡ªû
,
š¡ªûs
,(
£Áš–RedisIn¡ªû
*),

3951 
com·»SÏvesFÜPromÙiÚ
);

3952 
£Ëùed
 = 
š¡ªû
[0];

3954 
	`zä“
(
š¡ªû
);

3955  
£Ëùed
;

3956 
	}
}

3959 
	$£Áš–Faov”Wa™S¹
(
£Áš–RedisIn¡ªû
 *
ri
) {

3960 *
Ëad”
;

3961 
i¦—d”
;

3964 
Ëad”
 = 
	`£Áš–G‘L—d”
(
ri
,„i->
çov”_•och
);

3965 
i¦—d”
 = 
Ëad”
 && 
	`¡rÿ£cmp
Ö—d”,
£Áš–
.
myid
) == 0;

3966 
	`sdsä“
(
Ëad”
);

3970 ià(!
i¦—d”
 && !(
ri
->
æags
 & 
SRI_FORCE_FAILOVER
)) {

3971 
–eùiÚ_timeout
 = 
SENTINEL_ELECTION_TIMEOUT
;

3975 ià(
–eùiÚ_timeout
 > 
ri
->
çov”_timeout
)

3976 
–eùiÚ_timeout
 = 
ri
->
çov”_timeout
;

3978 ià(
	`m¡ime
(è- 
ri
->
çov”_¡¬t_time
 > 
–eùiÚ_timeout
) {

3979 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-nÙ-–eùed",
ri
,"%@");

3980 
	`£Áš–AbÜtFaov”
(
ri
);

3984 
	`£Áš–Ev’t
(
LL_WARNING
,"+–eùed-Ëad”",
ri
,"%@");

3985 ià(
£Áš–
.
simçu»_æags
 & 
SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION
)

3986 
	`£Áš–SimFau»C¿sh
();

3987 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
;

3988 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3989 
	`£Áš–Ev’t
(
LL_WARNING
,"+çov”-¡©e-£Ëù-¦ave",
ri
,"%@");

3990 
	}
}

3992 
	$£Áš–Faov”S–eùSÏve
(
£Áš–RedisIn¡ªû
 *
ri
) {

3993 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`£Áš–S–eùSÏve
(
ri
);

3997 ià(
¦ave
 =ğ
NULL
) {

3998 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-no-good-¦ave",
ri
,"%@");

3999 
	`£Áš–AbÜtFaov”
(
ri
);

4001 
	`£Áš–Ev’t
(
LL_WARNING
,"+£Ëùed-¦ave",
¦ave
,"%@");

4002 
¦ave
->
æags
 |ğ
SRI_PROMOTED
;

4003 
ri
->
´omÙed_¦ave
 = 
¦ave
;

4004 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
;

4005 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

4006 
	`£Áš–Ev’t
(
LL_NOTICE
,"+failover-state-send-slaveof-noone",

4007 
¦ave
, "%@");

4009 
	}
}

4011 
	$£Áš–Faov”S’dSÏveOfNoOÃ
(
£Áš–RedisIn¡ªû
 *
ri
) {

4012 
»tv®
;

4017 ià(
ri
->
´omÙed_¦ave
->
lšk
->
discÚÃùed
) {

4018 ià(
	`m¡ime
(è- 
ri
->
çov”_¡©e_chªge_time
 >„i->
çov”_timeout
) {

4019 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-¦ave-timeout",
ri
,"%@");

4020 
	`£Áš–AbÜtFaov”
(
ri
);

4029 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
->
´omÙed_¦ave
,
NULL
,0);

4030 ià(
»tv®
 !ğ
C_OK
) ;

4031 
	`£Áš–Ev’t
(
LL_NOTICE
, "+failover-state-wait-promotion",

4032 
ri
->
´omÙed_¦ave
,"%@");

4033 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
;

4034 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

4035 
	}
}

4039 
	$£Áš–Faov”Wa™PromÙiÚ
(
£Áš–RedisIn¡ªû
 *
ri
) {

4042 ià(
	`m¡ime
(è- 
ri
->
çov”_¡©e_chªge_time
 >„i->
çov”_timeout
) {

4043 
	`£Áš–Ev’t
(
LL_WARNING
,"-çov”-abÜt-¦ave-timeout",
ri
,"%@");

4044 
	`£Áš–AbÜtFaov”
(
ri
);

4046 
	}
}

4048 
	$£Áš–Faov”D‘eùEnd
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

4049 
nÙ_»cÚfigu»d
 = 0, 
timeout
 = 0;

4050 
diùI‹¿tÜ
 *
di
;

4051 
diùEÁry
 *
de
;

4052 
m¡ime_t
 
–­£d
 = 
	`m¡ime
(è- 
ma¡”
->
çov”_¡©e_chªge_time
;

4056 ià(
ma¡”
->
´omÙed_¦ave
 =ğ
NULL
 ||

4057 
ma¡”
->
´omÙed_¦ave
->
æags
 & 
SRI_S_DOWN
) ;

4061 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4062 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4063 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4065 ià(
¦ave
->
æags
 & (
SRI_PROMOTED
|
SRI_RECONF_DONE
)) ;

4066 ià(
¦ave
->
æags
 & 
SRI_S_DOWN
) ;

4067 
nÙ_»cÚfigu»d
++;

4069 
	`diùR–—£I‹¿tÜ
(
di
);

4072 ià(
–­£d
 > 
ma¡”
->
çov”_timeout
) {

4073 
nÙ_»cÚfigu»d
 = 0;

4074 
timeout
 = 1;

4075 
	`£Áš–Ev’t
(
LL_WARNING
,"+çov”-’d-fÜ-timeout",
ma¡”
,"%@");

4078 ià(
nÙ_»cÚfigu»d
 == 0) {

4079 
	`£Áš–Ev’t
(
LL_WARNING
,"+çov”-’d",
ma¡”
,"%@");

4080 
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
;

4081 
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

4087 ià(
timeout
) {

4088 
diùI‹¿tÜ
 *
di
;

4089 
diùEÁry
 *
de
;

4091 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4092 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4093 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4094 
»tv®
;

4096 ià(
¦ave
->
æags
 & (
SRI_RECONF_DONE
|
SRI_RECONF_SENT
)) ;

4097 ià(
¦ave
->
lšk
->
discÚÃùed
) ;

4099 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
¦ave
,

4100 
ma¡”
->
´omÙed_¦ave
->
addr
->

,

4101 
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
);

4102 ià(
»tv®
 =ğ
C_OK
) {

4103 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-£Á-be",
¦ave
,"%@");

4104 
¦ave
->
æags
 |ğ
SRI_RECONF_SENT
;

4107 
	`diùR–—£I‹¿tÜ
(
di
);

4109 
	}
}

4113 
	$£Áš–Faov”RecÚfNextSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

4114 
diùI‹¿tÜ
 *
di
;

4115 
diùEÁry
 *
de
;

4116 
š_´og»ss
 = 0;

4118 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4119 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4120 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4122 ià(
¦ave
->
æags
 & (
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
))

4123 
š_´og»ss
++;

4125 
	`diùR–—£I‹¿tÜ
(
di
);

4127 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

4128 
š_´og»ss
 < 
ma¡”
->
·¿Î–_syncs
 &&

4129 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
)

4131 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

4132 
»tv®
;

4135 ià(
¦ave
->
æags
 & (
SRI_PROMOTED
|
SRI_RECONF_DONE
)) ;

4141 ià((
¦ave
->
æags
 & 
SRI_RECONF_SENT
) &&

4142 (
	`m¡ime
(è- 
¦ave
->
¦ave_»cÚf_£Á_time
) >

4143 
SENTINEL_SLAVE_RECONF_TIMEOUT
)

4145 
	`£Áš–Ev’t
(
LL_NOTICE
,"-¦ave-»cÚf-£Á-timeout",
¦ave
,"%@");

4146 
¦ave
->
æags
 &ğ~
SRI_RECONF_SENT
;

4147 
¦ave
->
æags
 |ğ
SRI_RECONF_DONE
;

4152 ià(
¦ave
->
æags
 & (
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
)) ;

4153 ià(
¦ave
->
lšk
->
discÚÃùed
) ;

4156 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
¦ave
,

4157 
ma¡”
->
´omÙed_¦ave
->
addr
->

,

4158 
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
);

4159 ià(
»tv®
 =ğ
C_OK
) {

4160 
¦ave
->
æags
 |ğ
SRI_RECONF_SENT
;

4161 
¦ave
->
¦ave_»cÚf_£Á_time
 = 
	`m¡ime
();

4162 
	`£Áš–Ev’t
(
LL_NOTICE
,"+¦ave-»cÚf-£Á",
¦ave
,"%@");

4163 
š_´og»ss
++;

4166 
	`diùR–—£I‹¿tÜ
(
di
);

4169 
	`£Áš–Faov”D‘eùEnd
(
ma¡”
);

4170 
	}
}

4175 
	$£Áš–Faov”Sw™chToPromÙedSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

4176 
£Áš–RedisIn¡ªû
 *
»f
 = 
ma¡”
->
´omÙed_¦ave
 ?

4177 
ma¡”
->
´omÙed_¦ave
 : master;

4179 
	`£Áš–Ev’t
(
LL_WARNING
,"+sw™ch-ma¡”",
ma¡”
,"%s %s %d %s %d",

4180 
ma¡”
->
Çme
, ma¡”->
addr
->

, ma¡”->addr->
pÜt
,

4181 
»f
->
addr
->

,„ef->addr->
pÜt
);

4183 
	`£Áš–Re£tMa¡”AndChªgeAdd»ss
(
ma¡”
,
»f
->
addr
->

,»f->addr->
pÜt
);

4184 
	}
}

4186 
	$£Áš–Faov”S‹Machše
(
£Áš–RedisIn¡ªû
 *
ri
) {

4187 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_MASTER
);

4189 ià(!(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)) ;

4191 
ri
->
çov”_¡©e
) {

4192 
SENTINEL_FAILOVER_STATE_WAIT_START
:

4193 
	`£Áš–Faov”Wa™S¹
(
ri
);

4195 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
:

4196 
	`£Áš–Faov”S–eùSÏve
(
ri
);

4198 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
:

4199 
	`£Áš–Faov”S’dSÏveOfNoOÃ
(
ri
);

4201 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
:

4202 
	`£Áš–Faov”Wa™PromÙiÚ
(
ri
);

4204 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
:

4205 
	`£Áš–Faov”RecÚfNextSÏve
(
ri
);

4208 
	}
}

4215 
	$£Áš–AbÜtFaov”
(
£Áš–RedisIn¡ªû
 *
ri
) {

4216 
	`£rv”As£¹
(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
);

4217 
	`£rv”As£¹
(
ri
->
çov”_¡©e
 <ğ
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
);

4219 
ri
->
æags
 &ğ~(
SRI_FAILOVER_IN_PROGRESS
|
SRI_FORCE_FAILOVER
);

4220 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

4221 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

4222 ià(
ri
->
´omÙed_¦ave
) {

4223 
ri
->
´omÙed_¦ave
->
æags
 &ğ~
SRI_PROMOTED
;

4224 
ri
->
´omÙed_¦ave
 = 
NULL
;

4226 
	}
}

4234 
	$£Áš–HªdËRedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

4237 
	`£Áš–RecÚÃùIn¡ªû
(
ri
);

4238 
	`£Áš–S’dP”iodicCommªds
(
ri
);

4244 ià(
£Áš–
.
tt
) {

4245 ià(
	`m¡ime
()-
£Áš–
.
tt_¡¬t_time
 < 
SENTINEL_TILT_PERIOD
) ;

4246 
£Áš–
.
tt
 = 0;

4247 
	`£Áš–Ev’t
(
LL_WARNING
,"-tt",
NULL
,"#tilt modeƒxited");

4251 
	`£Áš–CheckSubjeùiv–yDown
(
ri
);

4254 ià(
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)) {

4259 ià(
ri
->
æags
 & 
SRI_MASTER
) {

4260 
	`£Áš–CheckObjeùiv–yDown
(
ri
);

4261 ià(
	`£Áš–S¹Faov”IfN“ded
(
ri
))

4262 
	`£Áš–AskMa¡”S‹ToOth”S’tš–s
(
ri
,
SENTINEL_ASK_FORCED
);

4263 
	`£Áš–Faov”S‹Machše
(
ri
);

4264 
	`£Áš–AskMa¡”S‹ToOth”S’tš–s
(
ri
,
SENTINEL_NO_FLAGS
);

4266 
	}
}

4270 
	$£Áš–HªdËDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
) {

4271 
diùI‹¿tÜ
 *
di
;

4272 
diùEÁry
 *
de
;

4273 
£Áš–RedisIn¡ªû
 *
sw™ch_to_´omÙed
 = 
NULL
;

4276 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

4277 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4278 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

4280 
	`£Áš–HªdËRedisIn¡ªû
(
ri
);

4281 ià(
ri
->
æags
 & 
SRI_MASTER
) {

4282 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
ri
->
¦aves
);

4283 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
ri
->
£Áš–s
);

4284 ià(
ri
->
çov”_¡©e
 =ğ
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
) {

4285 
sw™ch_to_´omÙed
 = 
ri
;

4289 ià(
sw™ch_to_´omÙed
)

4290 
	`£Áš–Faov”Sw™chToPromÙedSÏve
(
sw™ch_to_´omÙed
);

4291 
	`diùR–—£I‹¿tÜ
(
di
);

4292 
	}
}

4313 
	$£Áš–CheckTtCÚd™iÚ
() {

4314 
m¡ime_t
 
now
 = 
	`m¡ime
();

4315 
m¡ime_t
 
d–
 = 
now
 - 
£Áš–
.
´evious_time
;

4317 ià(
d–
 < 0 || d– > 
SENTINEL_TILT_TRIGGER
) {

4318 
£Áš–
.
tt
 = 1;

4319 
£Áš–
.
tt_¡¬t_time
 = 
	`m¡ime
();

4320 
	`£Áš–Ev’t
(
LL_WARNING
,"+tt",
NULL
,"#tilt modeƒntered");

4322 
£Áš–
.
´evious_time
 = 
	`m¡ime
();

4323 
	}
}

4325 
	$£Áš–Tim”
() {

4326 
	`£Áš–CheckTtCÚd™iÚ
();

4327 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
£Áš–
.
ma¡”s
);

4328 
	`£Áš–RunP’dšgSüts
();

4329 
	`£Áš–CŞËùT”mš©edSüts
();

4330 
	`£Áš–KlTimedoutSüts
();

4338 
£rv”
.
hz
 = 
CONFIG_DEFAULT_HZ
 + 
	`¿nd
() % CONFIG_DEFAULT_HZ;

4339 
	}
}

	@src/server.c

30 
	~"£rv”.h
"

31 
	~"şu¡”.h
"

32 
	~"¦owlog.h
"

33 
	~"bio.h
"

34 
	~"Ï‹ncy.h
"

35 
	~"©omicv¬.h
"

37 
	~<time.h
>

38 
	~<sigÇl.h
>

39 
	~<sys/wa™.h
>

40 
	~<”ºo.h
>

41 
	~<as£¹.h
>

42 
	~<ùy³.h
>

43 
	~<¡d¬g.h
>

44 
	~<¬·/š‘.h
>

45 
	~<sys/¡©.h
>

46 
	~<fú.h
>

47 
	~<sys/time.h
>

48 
	~<sys/»sourû.h
>

49 
	~<sys/uio.h
>

50 
	~<sys/un.h
>

51 
	~<lim™s.h
>

52 
	~<æßt.h
>

53 
	~<m©h.h
>

54 
	~<sys/»sourû.h
>

55 
	~<sys/ut¢ame.h
>

56 
	~<loÿË.h
>

57 
	~<sys/sock‘.h
>

61 
sh¬edObjeùsSŒuù
 
	gsh¬ed
;

67 
	gR_Z”o
, 
	gR_PosInf
, 
	gR_NegInf
, 
	gR_Nª
;

72 
»disS”v”
 
	g£rv”
;

73 vŞ©
	gÌu_şock
;

127 
»disCommªd
 
	g»disCommªdTabË
[] = {

128 {"moduË",
moduËCommªd
,-2,"as",0,
NULL
,0,0,0,0,0},

129 {"g‘",
g‘Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

130 {"£t",
£tCommªd
,-3,"wm",0,
NULL
,1,1,1,0,0},

131 {"£Šx",
£ŠxCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

132 {"£‹x",
£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

133 {"p£‹x",
p£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

134 {"­³nd",
­³ndCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

135 {"¡¾’",
¡¾’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

136 {"d–",
d–Commªd
,-2,"w",0,
NULL
,1,-1,1,0,0},

137 {"uÆšk",
uÆškCommªd
,-2,"wF",0,
NULL
,1,-1,1,0,0},

138 {"exi¡s",
exi¡sCommªd
,-2,"rF",0,
NULL
,1,-1,1,0,0},

139 {"£tb™",
£tb™Commªd
,4,"wm",0,
NULL
,1,1,1,0,0},

140 {"g‘b™",
g‘b™Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

141 {"b™f›ld",
b™f›ldCommªd
,-2,"wm",0,
NULL
,1,1,1,0,0},

142 {"£Œªge",
£ŒªgeCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

143 {"g‘¿nge",
g‘¿ngeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

144 {"sub¡r",
g‘¿ngeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

145 {"šü",
šüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

146 {"deü",
deüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

147 {"mg‘",
mg‘Commªd
,-2,"rF",0,
NULL
,1,-1,1,0,0},

148 {"½ush",
½ushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

149 {"Íush",
ÍushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

150 {"½ushx",
½ushxCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

151 {"Íushx",
ÍushxCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

152 {"lš£¹",
lš£¹Commªd
,5,"wm",0,
NULL
,1,1,1,0,0},

153 {"½İ",
½İCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

154 {"Íİ",
ÍİCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

155 {"b½İ",
b½İCommªd
,-3,"ws",0,
NULL
,1,-2,1,0,0},

156 {"b½İÍush",
b½İÍushCommªd
,4,"wms",0,
NULL
,1,2,1,0,0},

157 {"bÍİ",
bÍİCommªd
,-3,"ws",0,
NULL
,1,-2,1,0,0},

158 {"Î’",
Î’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

159 {"lšdex",
lšdexCommªd
,3,"r",0,
NULL
,1,1,1,0,0},

160 {"l£t",
l£tCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

161 {"Ìªge",
ÌªgeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

162 {"Érim",
ÉrimCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

163 {"Ìem",
ÌemCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

164 {"½İÍush",
½İÍushCommªd
,3,"wm",0,
NULL
,1,2,1,0,0},

165 {"§dd",
§ddCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

166 {"¤em",
¤emCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

167 {"smove",
smoveCommªd
,4,"wF",0,
NULL
,1,2,1,0,0},

168 {"sismemb”",
sismemb”Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

169 {"sÿrd",
sÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

170 {"¥İ",
¥İCommªd
,-2,"wRF",0,
NULL
,1,1,1,0,0},

171 {"¤ªdmemb”",
¤ªdmemb”Commªd
,-2,"rR",0,
NULL
,1,1,1,0,0},

172 {"sš‹r",
sš‹rCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

173 {"sš‹r¡Üe",
sš‹r¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

174 {"suniÚ",
suniÚCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

175 {"suniÚ¡Üe",
suniÚ¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

176 {"sdiff",
sdiffCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

177 {"sdiff¡Üe",
sdiff¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

178 {"smemb”s",
sš‹rCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

179 {"ssÿn",
ssÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

180 {"zadd",
zaddCommªd
,-4,"wmF",0,
NULL
,1,1,1,0,0},

181 {"zšüby",
zšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

182 {"z»m",
z»mCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

183 {"z»m¿ngebyscÜe",
z»m¿ngebyscÜeCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

184 {"z»m¿ngeby¿nk",
z»m¿ngeby¿nkCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

185 {"z»m¿ngebyËx",
z»m¿ngebyËxCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

186 {"zuniÚ¡Üe",
zuniÚ¡ÜeCommªd
,-4,"wm",0,
zuniÚIÁ”G‘Keys
,0,0,0,0,0},

187 {"zš‹r¡Üe",
zš‹r¡ÜeCommªd
,-4,"wm",0,
zuniÚIÁ”G‘Keys
,0,0,0,0,0},

188 {"z¿nge",
z¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

189 {"z¿ngebyscÜe",
z¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

190 {"z»v¿ngebyscÜe",
z»v¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

191 {"z¿ngebyËx",
z¿ngebyËxCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

192 {"z»v¿ngebyËx",
z»v¿ngebyËxCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

193 {"zcouÁ",
zcouÁCommªd
,4,"rF",0,
NULL
,1,1,1,0,0},

194 {"zËxcouÁ",
zËxcouÁCommªd
,4,"rF",0,
NULL
,1,1,1,0,0},

195 {"z»v¿nge",
z»v¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

196 {"zÿrd",
zÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

197 {"zscÜe",
zscÜeCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

198 {"z¿nk",
z¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

199 {"z»v¿nk",
z»v¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

200 {"zsÿn",
zsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

201 {"h£t",
h£tCommªd
,-4,"wmF",0,
NULL
,1,1,1,0,0},

202 {"h£Šx",
h£ŠxCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

203 {"hg‘",
hg‘Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

204 {"hm£t",
h£tCommªd
,-4,"wmF",0,
NULL
,1,1,1,0,0},

205 {"hmg‘",
hmg‘Commªd
,-3,"rF",0,
NULL
,1,1,1,0,0},

206 {"hšüby",
hšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

207 {"hšübyæßt",
hšübyæßtCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

208 {"hd–",
hd–Commªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

209 {"hËn",
hËnCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

210 {"h¡¾’",
h¡¾’Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

211 {"hkeys",
hkeysCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

212 {"hv®s",
hv®sCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

213 {"hg‘®l",
hg‘®lCommªd
,2,"r",0,
NULL
,1,1,1,0,0},

214 {"hexi¡s",
hexi¡sCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

215 {"hsÿn",
hsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

216 {"šüby",
šübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

217 {"deüby",
deübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

218 {"šübyæßt",
šübyæßtCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

219 {"g‘£t",
g‘£tCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

220 {"m£t",
m£tCommªd
,-3,"wm",0,
NULL
,1,-1,2,0,0},

221 {"m£Šx",
m£ŠxCommªd
,-3,"wm",0,
NULL
,1,-1,2,0,0},

222 {"¿ndomkey",
¿ndomkeyCommªd
,1,"rR",0,
NULL
,0,0,0,0,0},

223 {"£Ëù",
£ËùCommªd
,2,"lF",0,
NULL
,0,0,0,0,0},

224 {"sw­db",
sw­dbCommªd
,3,"wF",0,
NULL
,0,0,0,0,0},

225 {"move",
moveCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

226 {"»Çme",
»ÇmeCommªd
,3,"w",0,
NULL
,1,2,1,0,0},

227 {"»Çm’x",
»Çm’xCommªd
,3,"wF",0,
NULL
,1,2,1,0,0},

228 {"expœe",
expœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

229 {"expœ—t",
expœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

230 {"³xpœe",
³xpœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

231 {"³xpœ—t",
³xpœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

232 {"keys",
keysCommªd
,2,"rS",0,
NULL
,0,0,0,0,0},

233 {"sÿn",
sÿnCommªd
,-2,"rR",0,
NULL
,0,0,0,0,0},

234 {"dbsize",
dbsizeCommªd
,1,"rF",0,
NULL
,0,0,0,0,0},

235 {"auth",
authCommªd
,2,"¦tF",0,
NULL
,0,0,0,0,0},

236 {"pšg",
pšgCommªd
,-1,"tF",0,
NULL
,0,0,0,0,0},

237 {"echo",
echoCommªd
,2,"F",0,
NULL
,0,0,0,0,0},

238 {"§ve",
§veCommªd
,1,"as",0,
NULL
,0,0,0,0,0},

239 {"bg§ve",
bg§veCommªd
,-1,"a",0,
NULL
,0,0,0,0,0},

240 {"bg»wr™—of",
bg»wr™—ofCommªd
,1,"a",0,
NULL
,0,0,0,0,0},

241 {"shutdown",
shutdownCommªd
,-1,"®t",0,
NULL
,0,0,0,0,0},

242 {"Ï¡§ve",
Ï¡§veCommªd
,1,"RF",0,
NULL
,0,0,0,0,0},

243 {"ty³",
ty³Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

244 {"muÉi",
muÉiCommªd
,1,"sF",0,
NULL
,0,0,0,0,0},

245 {"exec",
execCommªd
,1,"sM",0,
NULL
,0,0,0,0,0},

246 {"disÿrd",
disÿrdCommªd
,1,"sF",0,
NULL
,0,0,0,0,0},

247 {"sync",
syncCommªd
,1,"¬s",0,
NULL
,0,0,0,0,0},

248 {"psync",
syncCommªd
,3,"¬s",0,
NULL
,0,0,0,0,0},

249 {"»¶cÚf",
»¶cÚfCommªd
,-1,"a¦t",0,
NULL
,0,0,0,0,0},

250 {"æushdb",
æushdbCommªd
,-1,"w",0,
NULL
,0,0,0,0,0},

251 {"æush®l",
æush®lCommªd
,-1,"w",0,
NULL
,0,0,0,0,0},

252 {"sÜt",
sÜtCommªd
,-2,"wm",0,
sÜtG‘Keys
,1,1,1,0,0},

253 {"šfo",
šfoCommªd
,-1,"É",0,
NULL
,0,0,0,0,0},

254 {"mÚ™Ü",
mÚ™ÜCommªd
,1,"as",0,
NULL
,0,0,0,0,0},

255 {"‰l",
‰lCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

256 {"touch",
touchCommªd
,-2,"rF",0,
NULL
,1,1,1,0,0},

257 {"±",
±Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

258 {"³rsi¡",
³rsi¡Commªd
,2,"wF",0,
NULL
,1,1,1,0,0},

259 {"¦aveof",
¦aveofCommªd
,3,"a¡",0,
NULL
,0,0,0,0,0},

260 {"rŞe",
rŞeCommªd
,1,"l¡",0,
NULL
,0,0,0,0,0},

261 {"debug",
debugCommªd
,-1,"as",0,
NULL
,0,0,0,0,0},

262 {"cÚfig",
cÚfigCommªd
,-2,"Ït",0,
NULL
,0,0,0,0,0},

263 {"subsüibe",
subsüibeCommªd
,-2,"p¦t",0,
NULL
,0,0,0,0,0},

264 {"unsubsüibe",
unsubsüibeCommªd
,-1,"p¦t",0,
NULL
,0,0,0,0,0},

265 {"psubsüibe",
psubsüibeCommªd
,-2,"p¦t",0,
NULL
,0,0,0,0,0},

266 {"punsubsüibe",
punsubsüibeCommªd
,-1,"p¦t",0,
NULL
,0,0,0,0,0},

267 {"publish",
publishCommªd
,3,"¶tF",0,
NULL
,0,0,0,0,0},

268 {"pubsub",
pubsubCommªd
,-2,"¶tR",0,
NULL
,0,0,0,0,0},

269 {"w©ch",
w©chCommªd
,-2,"sF",0,
NULL
,1,-1,1,0,0},

270 {"unw©ch",
unw©chCommªd
,1,"sF",0,
NULL
,0,0,0,0,0},

271 {"şu¡”",
şu¡”Commªd
,-2,"a",0,
NULL
,0,0,0,0,0},

272 {"»¡Üe",
»¡ÜeCommªd
,-4,"wm",0,
NULL
,1,1,1,0,0},

273 {"»¡Üe-askšg",
»¡ÜeCommªd
,-4,"wmk",0,
NULL
,1,1,1,0,0},

274 {"mig¿‹",
mig¿‹Commªd
,-6,"w",0,
mig¿‹G‘Keys
,0,0,0,0,0},

275 {"askšg",
askšgCommªd
,1,"F",0,
NULL
,0,0,0,0,0},

276 {"»adÚly",
»adÚlyCommªd
,1,"F",0,
NULL
,0,0,0,0,0},

277 {"»adwr™e",
»adwr™eCommªd
,1,"F",0,
NULL
,0,0,0,0,0},

278 {"dump",
dumpCommªd
,2,"r",0,
NULL
,1,1,1,0,0},

279 {"objeù",
objeùCommªd
,-2,"r",0,
NULL
,2,2,2,0,0},

280 {"memÜy",
memÜyCommªd
,-2,"r",0,
NULL
,0,0,0,0,0},

281 {"ş›Á",
ş›ÁCommªd
,-2,"as",0,
NULL
,0,0,0,0,0},

282 {"ev®",
ev®Commªd
,-3,"s",0,
ev®G‘Keys
,0,0,0,0,0},

283 {"ev®sha",
ev®ShaCommªd
,-3,"s",0,
ev®G‘Keys
,0,0,0,0,0},

284 {"¦owlog",
¦owlogCommªd
,-2,"a",0,
NULL
,0,0,0,0,0},

285 {"süt",
sütCommªd
,-2,"s",0,
NULL
,0,0,0,0,0},

286 {"time",
timeCommªd
,1,"RF",0,
NULL
,0,0,0,0,0},

287 {"b™İ",
b™İCommªd
,-4,"wm",0,
NULL
,2,-1,1,0,0},

288 {"b™couÁ",
b™couÁCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

289 {"b™pos",
b™posCommªd
,-3,"r",0,
NULL
,1,1,1,0,0},

290 {"wa™",
wa™Commªd
,3,"s",0,
NULL
,0,0,0,0,0},

291 {"commªd",
commªdCommªd
,0,"É",0,
NULL
,0,0,0,0,0},

292 {"geßdd",
geßddCommªd
,-5,"wm",0,
NULL
,1,1,1,0,0},

293 {"geÜadius",
geÜadiusCommªd
,-6,"w",0,
geÜadiusG‘Keys
,1,1,1,0,0},

294 {"geÜadius_ro",
geÜadiu¤oCommªd
,-6,"r",0,
geÜadiusG‘Keys
,1,1,1,0,0},

295 {"geÜadiusbymemb”",
geÜadiusbymemb”Commªd
,-5,"w",0,
geÜadiusG‘Keys
,1,1,1,0,0},

296 {"geÜadiusbymemb”_ro",
geÜadiusbymemb”roCommªd
,-5,"r",0,
geÜadiusG‘Keys
,1,1,1,0,0},

297 {"geohash",
geohashCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

298 {"geİos",
geİosCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

299 {"geodi¡",
geodi¡Commªd
,-4,"r",0,
NULL
,1,1,1,0,0},

300 {"pf£láe¡",
pf£láe¡Commªd
,1,"a",0,
NULL
,0,0,0,0,0},

301 {"pçdd",
pçddCommªd
,-2,"wmF",0,
NULL
,1,1,1,0,0},

302 {"pfcouÁ",
pfcouÁCommªd
,-2,"r",0,
NULL
,1,-1,1,0,0},

303 {"pfm”ge",
pfm”geCommªd
,-2,"wm",0,
NULL
,1,-1,1,0,0},

304 {"pfdebug",
pfdebugCommªd
,-3,"w",0,
NULL
,0,0,0,0,0},

305 {"po¡",
£cur™yW¬nšgCommªd
,-1,"É",0,
NULL
,0,0,0,0,0},

306 {"ho¡:",
£cur™yW¬nšgCommªd
,-1,"É",0,
NULL
,0,0,0,0,0},

307 {"Ï‹ncy",
Ï‹ncyCommªd
,-2,"a¦t",0,
NULL
,0,0,0,0,0}

314 
	$£rv”LogRaw
(
Ëv–
, cÚ¡ *
msg
) {

315 cÚ¡ 
sy¦ogLev–M­
[] = { 
LOG_DEBUG
, 
LOG_INFO
, 
LOG_NOTICE
, 
LOG_WARNING
 };

316 cÚ¡ *
c
 = ".-*#";

317 
FILE
 *
å
;

318 
buf
[64];

319 
¿wmode
 = (
Ëv–
 & 
LL_RAW
);

320 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

322 
Ëv–
 &= 0xff;

323 ià(
Ëv–
 < 
£rv”
.
v”bos™y
) ;

325 
å
 = 
log_to_¡dout
 ? 
¡dout
 : 
	`fİ’
(
£rv”
.
logfe
,"a");

326 ià(!
å
) ;

328 ià(
¿wmode
) {

329 
	`årštf
(
å
,"%s",
msg
);

331 
off
;

332 
timev®
 
tv
;

333 
rŞe_ch¬
;

334 
pid_t
 
pid
 = 
	`g‘pid
();

336 
	`g‘timeofday
(&
tv
,
NULL
);

337 
off
 = 
	`¡ráime
(
buf
,(buf),"%d %b %H:%M:%S.",
	`loÿÉime
(&
tv
.
tv_£c
));

338 
	`¢´štf
(
buf
+
off
,(buf)-off,"%03d",()
tv
.
tv_u£c
/1000);

339 ià(
£rv”
.
£Áš–_mode
) {

340 
rŞe_ch¬
 = 'X';

341 } ià(
pid
 !ğ
£rv”
.pid) {

342 
rŞe_ch¬
 = 'C';

344 
rŞe_ch¬
 = (
£rv”
.
ma¡”ho¡
 ? 'S':'M');

346 
	`årštf
(
å
,"%d:%c %s %c %s\n",

347 ()
	`g‘pid
(),
rŞe_ch¬
, 
buf
,
c
[
Ëv–
],
msg
);

349 
	`fæush
(
å
);

351 ià(!
log_to_¡dout
è
	`fşo£
(
å
);

352 ià(
£rv”
.
sy¦og_’abËd
è
	`sy¦og
(
sy¦ogLev–M­
[
Ëv–
], "%s", 
msg
);

353 
	}
}

358 
	$£rv”Log
(
Ëv–
, cÚ¡ *
fmt
, ...) {

359 
va_li¡
 
­
;

360 
msg
[
LOG_MAX_LEN
];

362 ià((
Ëv–
&0xffè< 
£rv”
.
v”bos™y
) ;

364 
	`va_¡¬t
(
­
, 
fmt
);

365 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
­
);

366 
	`va_’d
(
­
);

368 
	`£rv”LogRaw
(
Ëv–
,
msg
);

369 
	}
}

377 
	$£rv”LogFromHªdËr
(
Ëv–
, cÚ¡ *
msg
) {

378 
fd
;

379 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

380 
buf
[64];

382 ià((
Ëv–
&0xffè< 
£rv”
.
v”bos™y
 || (
log_to_¡dout
 && s”v”.
d«mÚize
))

384 
fd
 = 
log_to_¡dout
 ? 
STDOUT_FILENO
 :

385 
	`İ’
(
£rv”
.
logfe
, 
O_APPEND
|
O_CREAT
|
O_WRONLY
, 0644);

386 ià(
fd
 == -1) ;

387 
	`Î2¡ršg
(
buf
,(buf),
	`g‘pid
());

388 ià(
	`wr™e
(
fd
,
buf
,
	`¡¾’
(buf)è=ğ-1è
”r
;

389 ià(
	`wr™e
(
fd
,":sigÇl-hªdË¸(",17è=ğ-1è
”r
;

390 
	`Î2¡ršg
(
buf
,(buf),
	`time
(
NULL
));

391 ià(
	`wr™e
(
fd
,
buf
,
	`¡¾’
(buf)è=ğ-1è
”r
;

392 ià(
	`wr™e
(
fd
,"è",2è=ğ-1è
”r
;

393 ià(
	`wr™e
(
fd
,
msg
,
	`¡¾’
(msg)è=ğ-1è
”r
;

394 ià(
	`wr™e
(
fd
,"\n",1è=ğ-1è
”r
;

395 
”r
:

396 ià(!
log_to_¡dout
è
	`şo£
(
fd
);

397 
	}
}

400 
	$u¡ime
() {

401 
timev®
 
tv
;

402 
u¡
;

404 
	`g‘timeofday
(&
tv
, 
NULL
);

405 
u¡
 = (()
tv
.
tv_£c
)*1000000;

406 
u¡
 +ğ
tv
.
tv_u£c
;

407  
u¡
;

408 
	}
}

411 
m¡ime_t
 
	$m¡ime
() {

412  
	`u¡ime
()/1000;

413 
	}
}

419 
	$ex™FromChd
(
»tcode
) {

420 #ifdeà
COVERAGE_TEST


421 
	`ex™
(
»tcode
);

423 
	`_ex™
(
»tcode
);

425 
	}
}

433 
	$diùVªÏF»e
(*
´ivd©a
, *
v®
)

435 
	`DICT_NOTUSED
(
´ivd©a
);

436 
	`zä“
(
v®
);

437 
	}
}

439 
	$diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
)

441 
	`DICT_NOTUSED
(
´ivd©a
);

442 
	`li¡R–—£
((
li¡
*)
v®
);

443 
	}
}

445 
	$diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

446 cÚ¡ *
key2
)

448 
l1
,
l2
;

449 
	`DICT_NOTUSED
(
´ivd©a
);

451 
l1
 = 
	`sd¦’
((
sds
)
key1
);

452 
l2
 = 
	`sd¦’
((
sds
)
key2
);

453 ià(
l1
 !ğ
l2
)  0;

454  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

455 
	}
}

459 
	$diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
,

460 cÚ¡ *
key2
)

462 
	`DICT_NOTUSED
(
´ivd©a
);

464  
	`¡rÿ£cmp
(
key1
, 
key2
) == 0;

465 
	}
}

467 
	$diùObjeùDe¡ruùÜ
(*
´ivd©a
, *
v®
)

469 
	`DICT_NOTUSED
(
´ivd©a
);

471 ià(
v®
 =ğ
NULL
) ;

472 
	`deüRefCouÁ
(
v®
);

473 
	}
}

475 
	$diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
)

477 
	`DICT_NOTUSED
(
´ivd©a
);

479 
	`sdsä“
(
v®
);

480 
	}
}

482 
	$diùObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

483 cÚ¡ *
key2
)

485 cÚ¡ 
robj
 *
o1
 = 
key1
, *
o2
 = 
key2
;

486  
	`diùSdsKeyCom·»
(
´ivd©a
,
o1
->
±r
,
o2
->ptr);

487 
	}
}

489 
ušt64_t
 
	$diùObjHash
(cÚ¡ *
key
) {

490 cÚ¡ 
robj
 *
o
 = 
key
;

491  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

492 
	}
}

494 
ušt64_t
 
	$diùSdsHash
(cÚ¡ *
key
) {

495  
	`diùG’HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

496 
	}
}

498 
ušt64_t
 
	$diùSdsCa£Hash
(cÚ¡ *
key
) {

499  
	`diùG’Ca£HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

500 
	}
}

502 
	$diùEncObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

503 cÚ¡ *
key2
)

505 
robj
 *
o1
 = (robj*è
key1
, *
o2
 = (robj*è
key2
;

506 
cmp
;

508 ià(
o1
->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

509 
o2
->
’codšg
 =ğ
OBJ_ENCODING_INT
)

510  
o1
->
±r
 =ğ
o2
->ptr;

512 
o1
 = 
	`g‘DecodedObjeù
(o1);

513 
o2
 = 
	`g‘DecodedObjeù
(o2);

514 
cmp
 = 
	`diùSdsKeyCom·»
(
´ivd©a
,
o1
->
±r
,
o2
->ptr);

515 
	`deüRefCouÁ
(
o1
);

516 
	`deüRefCouÁ
(
o2
);

517  
cmp
;

518 
	}
}

520 
ušt64_t
 
	$diùEncObjHash
(cÚ¡ *
key
) {

521 
robj
 *
o
 = (robj*è
key
;

523 ià(
	`sdsEncodedObjeù
(
o
)) {

524  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

526 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

527 
buf
[32];

528 
Ën
;

530 
Ën
 = 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

531  
	`diùG’HashFunùiÚ
((*)
buf
, 
Ën
);

533 
ušt64_t
 
hash
;

535 
o
 = 
	`g‘DecodedObjeù
(o);

536 
hash
 = 
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

537 
	`deüRefCouÁ
(
o
);

538  
hash
;

541 
	}
}

545 
diùTy³
 
	gobjeùKeyPoš‹rV®ueDiùTy³
 = {

546 
diùEncObjHash
,

547 
NULL
,

548 
NULL
,

549 
diùEncObjKeyCom·»
,

550 
diùObjeùDe¡ruùÜ
,

551 
NULL


555 
diùTy³
 
	g£tDiùTy³
 = {

556 
diùSdsHash
,

557 
NULL
,

558 
NULL
,

559 
diùSdsKeyCom·»
,

560 
diùSdsDe¡ruùÜ
,

561 
NULL


565 
diùTy³
 
	gz£tDiùTy³
 = {

566 
diùSdsHash
,

567 
NULL
,

568 
NULL
,

569 
diùSdsKeyCom·»
,

570 
NULL
,

571 
NULL


575 
diùTy³
 
	gdbDiùTy³
 = {

576 
diùSdsHash
,

577 
NULL
,

578 
NULL
,

579 
diùSdsKeyCom·»
,

580 
diùSdsDe¡ruùÜ
,

581 
diùObjeùDe¡ruùÜ


585 
diùTy³
 
	gshaSütObjeùDiùTy³
 = {

586 
diùSdsCa£Hash
,

587 
NULL
,

588 
NULL
,

589 
diùSdsKeyCa£Com·»
,

590 
diùSdsDe¡ruùÜ
,

591 
diùObjeùDe¡ruùÜ


595 
diùTy³
 
	gkey±rDiùTy³
 = {

596 
diùSdsHash
,

597 
NULL
,

598 
NULL
,

599 
diùSdsKeyCom·»
,

600 
NULL
,

601 
NULL


605 
diùTy³
 
	gcommªdTabËDiùTy³
 = {

606 
diùSdsCa£Hash
,

607 
NULL
,

608 
NULL
,

609 
diùSdsKeyCa£Com·»
,

610 
diùSdsDe¡ruùÜ
,

611 
NULL


615 
diùTy³
 
	ghashDiùTy³
 = {

616 
diùSdsHash
,

617 
NULL
,

618 
NULL
,

619 
diùSdsKeyCom·»
,

620 
diùSdsDe¡ruùÜ
,

621 
diùSdsDe¡ruùÜ


627 
diùTy³
 
	gkeyli¡DiùTy³
 = {

628 
diùObjHash
,

629 
NULL
,

630 
NULL
,

631 
diùObjKeyCom·»
,

632 
diùObjeùDe¡ruùÜ
,

633 
diùLi¡De¡ruùÜ


638 
diùTy³
 
	gşu¡”NodesDiùTy³
 = {

639 
diùSdsHash
,

640 
NULL
,

641 
NULL
,

642 
diùSdsKeyCom·»
,

643 
diùSdsDe¡ruùÜ
,

644 
NULL


650 
diùTy³
 
	gşu¡”NodesBÏckLi¡DiùTy³
 = {

651 
diùSdsCa£Hash
,

652 
NULL
,

653 
NULL
,

654 
diùSdsKeyCa£Com·»
,

655 
diùSdsDe¡ruùÜ
,

656 
NULL


662 
diùTy³
 
	gmoduËsDiùTy³
 = {

663 
diùSdsCa£Hash
,

664 
NULL
,

665 
NULL
,

666 
diùSdsKeyCa£Com·»
,

667 
diùSdsDe¡ruùÜ
,

668 
NULL


672 
diùTy³
 
	gmig¿‹CacheDiùTy³
 = {

673 
diùSdsHash
,

674 
NULL
,

675 
NULL
,

676 
diùSdsKeyCom·»
,

677 
diùSdsDe¡ruùÜ
,

678 
NULL


684 
diùTy³
 
	g»¶SütCacheDiùTy³
 = {

685 
diùSdsCa£Hash
,

686 
NULL
,

687 
NULL
,

688 
diùSdsKeyCa£Com·»
,

689 
diùSdsDe¡ruùÜ
,

690 
NULL


693 
	$htN“dsResize
(
diù
 *dict) {

694 
size
, 
u£d
;

696 
size
 = 
	`diùSlÙs
(
diù
);

697 
u£d
 = 
	`diùSize
(
diù
);

698  (
size
 > 
DICT_HT_INITIAL_SIZE
 &&

699 (
u£d
*100/
size
 < 
HASHTABLE_MIN_FILL
));

700 
	}
}

704 
	$ŒyResizeHashTabËs
(
dbid
) {

705 ià(
	`htN“dsResize
(
£rv”
.
db
[
dbid
].
diù
))

706 
	`diùResize
(
£rv”
.
db
[
dbid
].
diù
);

707 ià(
	`htN“dsResize
(
£rv”
.
db
[
dbid
].
expœes
))

708 
	`diùResize
(
£rv”
.
db
[
dbid
].
expœes
);

709 
	}
}

718 
	$šüem’ÎyRehash
(
dbid
) {

720 ià(
	`diùIsRehashšg
(
£rv”
.
db
[
dbid
].
diù
)) {

721 
	`diùRehashMli£cÚds
(
£rv”
.
db
[
dbid
].
diù
,1);

725 ià(
	`diùIsRehashšg
(
£rv”
.
db
[
dbid
].
expœes
)) {

726 
	`diùRehashMli£cÚds
(
£rv”
.
db
[
dbid
].
expœes
,1);

730 
	}
}

738 
	$upd©eDiùResizePŞicy
() {

739 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1)

740 
	`diùEÇbËResize
();

742 
	`diùDi§bËResize
();

743 
	}
}

748 
	$ŒackIn¡ªÃousM‘ric
(
m‘ric
, 
cu¼’t_»adšg
) {

749 
t
 = 
	`m¡ime
(è- 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
;

750 
İs
 = 
cu¼’t_»adšg
 -

751 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
;

752 
İs_£c
;

754 
İs_£c
 = 
t
 > 0 ? (
İs
*1000/t) : 0;

756 
£rv”
.
š¡_m‘ric
[
m‘ric
].
§m¶es
[£rv”.š¡_m‘ric[m‘ric].
idx
] =

757 
İs_£c
;

758 
£rv”
.
š¡_m‘ric
[
m‘ric
].
idx
++;

759 
£rv”
.
š¡_m‘ric
[
m‘ric
].
idx
 %ğ
STATS_METRIC_SAMPLES
;

760 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
 = 
	`m¡ime
();

761 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
 = 
cu¼’t_»adšg
;

762 
	}
}

765 
	$g‘In¡ªÃousM‘ric
(
m‘ric
) {

766 
j
;

767 
sum
 = 0;

769 
j
 = 0; j < 
STATS_METRIC_SAMPLES
; j++)

770 
sum
 +ğ
£rv”
.
š¡_m‘ric
[
m‘ric
].
§m¶es
[
j
];

771  
sum
 / 
STATS_METRIC_SAMPLES
;

772 
	}
}

778 
	$ş›ÁsCrÚHªdËTimeout
(
ş›Á
 *
c
, 
m¡ime_t
 
now_ms
) {

779 
time_t
 
now
 = 
now_ms
/1000;

781 ià(
£rv”
.
maxidËtime
 &&

782 !(
c
->
æags
 & 
CLIENT_SLAVE
) &&

783 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

784 !(
c
->
æags
 & 
CLIENT_BLOCKED
) &&

785 !(
c
->
æags
 & 
CLIENT_PUBSUB
) &&

786 (
now
 - 
c
->
Ï¡š‹¿ùiÚ
 > 
£rv”
.
maxidËtime
))

788 
	`£rv”Log
(
LL_VERBOSE
,"Closing idle client");

789 
	`ä“Cl›Á
(
c
);

791 } ià(
c
->
æags
 & 
CLIENT_BLOCKED
) {

796 ià(
c
->
bpİ
.
timeout
 !ğ0 && c->bpİ.timeouˆ< 
now_ms
) {

798 
	`»¶yToBlockedCl›ÁTimedOut
(
c
);

799 
	`unblockCl›Á
(
c
);

800 } ià(
£rv”
.
şu¡”_’abËd
) {

803 ià(
	`şu¡”RedœeùBlockedCl›ÁIfN“ded
(
c
))

804 
	`unblockCl›Á
(
c
);

808 
	}
}

814 
	$ş›ÁsCrÚResizeQu”yBufãr
(
ş›Á
 *
c
) {

815 
size_t
 
qu”ybuf_size
 = 
	`sdsAÎocSize
(
c
->
qu”ybuf
);

816 
time_t
 
idËtime
 = 
£rv”
.
unixtime
 - 
c
->
Ï¡š‹¿ùiÚ
;

821 ià(((
qu”ybuf_size
 > 
PROTO_MBULK_BIG_ARG
) &&

822 (
qu”ybuf_size
/(
c
->
qu”ybuf_³ak
+1)) > 2) ||

823 (
qu”ybuf_size
 > 1024 && 
idËtime
 > 2))

826 ià(
	`sd§va
(
c
->
qu”ybuf
) > 1024) {

827 
c
->
qu”ybuf
 = 
	`sdsRemoveF»eS·û
(c->querybuf);

832 
c
->
qu”ybuf_³ak
 = 0;

834 
	}
}

836 
	#CLIENTS_CRON_MIN_ITERATIONS
 5

	)

837 
	$ş›ÁsCrÚ
() {

842 
numş›Ás
 = 
	`li¡L’gth
(
£rv”
.
ş›Ás
);

843 
™”©iÚs
 = 
numş›Ás
/
£rv”
.
hz
;

844 
m¡ime_t
 
now
 = 
	`m¡ime
();

849 ià(
™”©iÚs
 < 
CLIENTS_CRON_MIN_ITERATIONS
)

850 
™”©iÚs
 = (
numş›Ás
 < 
CLIENTS_CRON_MIN_ITERATIONS
) ?

851 
numş›Ás
 : 
CLIENTS_CRON_MIN_ITERATIONS
;

853 
	`li¡L’gth
(
£rv”
.
ş›Ás
è&& 
™”©iÚs
--) {

854 
ş›Á
 *
c
;

855 
li¡Node
 *
h—d
;

860 
	`li¡RÙ©e
(
£rv”
.
ş›Ás
);

861 
h—d
 = 
	`li¡Fœ¡
(
£rv”
.
ş›Ás
);

862 
c
 = 
	`li¡NodeV®ue
(
h—d
);

866 ià(
	`ş›ÁsCrÚHªdËTimeout
(
c
,
now
)) ;

867 ià(
	`ş›ÁsCrÚResizeQu”yBufãr
(
c
)) ;

869 
	}
}

874 
	$d©aba£sCrÚ
() {

877 ià(
£rv”
.
aùive_expœe_’abËd
 && s”v”.
ma¡”ho¡
 =ğ
NULL
) {

878 
	`aùiveExpœeCyşe
(
ACTIVE_EXPIRE_CYCLE_SLOW
);

879 } ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
) {

880 
	`expœeSÏveKeys
();

884 ià(
£rv”
.
aùive_deäag_’abËd
)

885 
	`aùiveDeäagCyşe
();

890 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1) {

894 
»size_db
 = 0;

895 
»hash_db
 = 0;

896 
dbs_³r_ÿÎ
 = 
CRON_DBS_PER_CALL
;

897 
j
;

900 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
) dbs_per_call = server.dbnum;

903 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

904 
	`ŒyResizeHashTabËs
(
»size_db
 % 
£rv”
.
dbnum
);

905 
»size_db
++;

909 ià(
£rv”
.
aùiv”ehashšg
) {

910 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

911 
wÜk_dÚe
 = 
	`šüem’ÎyRehash
(
»hash_db
);

912 ià(
wÜk_dÚe
) {

918 
»hash_db
++;

919 
»hash_db
 %ğ
£rv”
.
dbnum
;

924 
	}
}

930 
	$upd©eCachedTime
() {

931 
time_t
 
unixtime
 = 
	`time
(
NULL
);

932 
	`©omicS‘
(
£rv”
.
unixtime
,unixtime);

933 
£rv”
.
m¡ime
 = 
	`m¡ime
();

934 
	}
}

955 
	$£rv”CrÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

956 
j
;

957 
	`UNUSED
(
ev’tLoİ
);

958 
	`UNUSED
(
id
);

959 
	`UNUSED
(
ş›ÁD©a
);

963 ià(
£rv”
.
w©chdog_³riod
è
	`w©chdogScheduËSigÇl
(server.watchdog_period);

966 
	`upd©eCachedTime
();

968 
	`run_w™h_³riod
(100) {

969 
	`ŒackIn¡ªÃousM‘ric
(
STATS_METRIC_COMMAND
,
£rv”
.
¡©_numcommªds
);

970 
	`ŒackIn¡ªÃousM‘ric
(
STATS_METRIC_NET_INPUT
,

971 
£rv”
.
¡©_Ãt_šput_by‹s
);

972 
	`ŒackIn¡ªÃousM‘ric
(
STATS_METRIC_NET_OUTPUT
,

973 
£rv”
.
¡©_Ãt_ouut_by‹s
);

987 
Ìuşock
 = 
	`g‘LRUClock
();

988 
	`©omicS‘
(
£rv”
.
Ìuşock
,lruclock);

991 ià(
	`zm®loc_u£d_memÜy
(è> 
£rv”
.
¡©_³ak_memÜy
)

992 
£rv”
.
¡©_³ak_memÜy
 = 
	`zm®loc_u£d_memÜy
();

995 
£rv”
.
»sid’t_£t_size
 = 
	`zm®loc_g‘_rss
();

999 ià(
£rv”
.
shutdown_a§p
) {

1000 ià(
	`´•¬eFÜShutdown
(
SHUTDOWN_NOFLAGS
è=ğ
C_OK
è
	`ex™
(0);

1001 
	`£rv”Log
(
LL_WARNING
,"SIGTERM„eceived butƒrrorsryingo shut downhe server, checkhe†ogs for more information");

1002 
£rv”
.
shutdown_a§p
 = 0;

1006 
	`run_w™h_³riod
(5000) {

1007 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

1008 
size
, 
u£d
, 
vkeys
;

1010 
size
 = 
	`diùSlÙs
(
£rv”
.
db
[
j
].
diù
);

1011 
u£d
 = 
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

1012 
vkeys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
expœes
);

1013 ià(
u£d
 || 
vkeys
) {

1014 
	`£rv”Log
(
LL_VERBOSE
,"DB %d: %Îd key (%Îd vŞ©eèš %Îd slÙ HT.",
j
,
u£d
,
vkeys
,
size
);

1021 ià(!
£rv”
.
£Áš–_mode
) {

1022 
	`run_w™h_³riod
(5000) {

1023 
	`£rv”Log
(
LL_VERBOSE
,

1025 
	`li¡L’gth
(
£rv”
.
ş›Ás
)-li¡L’gth(£rv”.
¦aves
),

1026 
	`li¡L’gth
(
£rv”
.
¦aves
),

1027 
	`zm®loc_u£d_memÜy
());

1032 
	`ş›ÁsCrÚ
();

1035 
	`d©aba£sCrÚ
();

1039 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1 &&

1040 
£rv”
.
aof_»wr™e_scheduËd
)

1042 
	`»wr™eAµ’dOÆyFeBackground
();

1046 ià(
£rv”
.
rdb_chd_pid
 !ğ-1 || s”v”.
aof_chd_pid
 != -1 ||

1047 
	`ldbP’dšgChd»n
())

1049 
¡©loc
;

1050 
pid_t
 
pid
;

1052 ià((
pid
 = 
	`wa™3
(&
¡©loc
,
WNOHANG
,
NULL
)) != 0) {

1053 
ex™code
 = 
	`WEXITSTATUS
(
¡©loc
);

1054 
bysigÇl
 = 0;

1056 ià(
	`WIFSIGNALED
(
¡©loc
)è
bysigÇl
 = 
	`WTERMSIG
(statloc);

1058 ià(
pid
 == -1) {

1059 
	`£rv”Log
(
LL_WARNING
,"wait3()„eturned‡nƒrror: %s. "

1061 
	`¡»¼Ü
(
”ºo
),

1062 (è
£rv”
.
rdb_chd_pid
,

1063 (è
£rv”
.
aof_chd_pid
);

1064 } ià(
pid
 =ğ
£rv”
.
rdb_chd_pid
) {

1065 
	`backgroundSaveDÚeHªdËr
(
ex™code
,
bysigÇl
);

1066 ià(!
bysigÇl
 && 
ex™code
 =ğ0è
	`»ûiveChdInfo
();

1067 } ià(
pid
 =ğ
£rv”
.
aof_chd_pid
) {

1068 
	`backgroundRewr™eDÚeHªdËr
(
ex™code
,
bysigÇl
);

1069 ià(!
bysigÇl
 && 
ex™code
 =ğ0è
	`»ûiveChdInfo
();

1071 ià(!
	`ldbRemoveChd
(
pid
)) {

1072 
	`£rv”Log
(
LL_WARNING
,

1074 ()
pid
);

1077 
	`upd©eDiùResizePŞicy
();

1078 
	`şo£ChdInfoPe
();

1083 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1084 
§v•¬am
 *
¥
 = 
£rv”
.
§v•¬ams
+
j
;

1090 ià(
£rv”
.
dœty
 >ğ
¥
->
chªges
 &&

1091 
£rv”
.
unixtime
-£rv”.
Ï¡§ve
 > 
¥
->
£cÚds
 &&

1092 (
£rv”
.
unixtime
-£rv”.
Ï¡bg§ve_Œy
 >

1093 
CONFIG_BGSAVE_RETRY_DELAY
 ||

1094 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_OK
))

1096 
	`£rv”Log
(
LL_NOTICE
,"%d changes in %d seconds. Saving...",

1097 
¥
->
chªges
, ()¥->
£cÚds
);

1098 
rdbSaveInfo
 
rsi
, *
rsŒ
;

1099 
rsŒ
 = 
	`rdbPİuÏ‹SaveInfo
(&
rsi
);

1100 
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
,
rsŒ
);

1106 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
 &&

1107 
£rv”
.
rdb_chd_pid
 == -1 &&

1108 
£rv”
.
aof_chd_pid
 == -1 &&

1109 
£rv”
.
aof_»wr™e_³rc
 &&

1110 
£rv”
.
aof_cu¼’t_size
 > s”v”.
aof_»wr™e_mš_size
)

1112 
ba£
 = 
£rv”
.
aof_»wr™e_ba£_size
 ?

1113 
£rv”
.
aof_»wr™e_ba£_size
 : 1;

1114 
growth
 = (
£rv”
.
aof_cu¼’t_size
*100/
ba£
) - 100;

1115 ià(
growth
 >ğ
£rv”
.
aof_»wr™e_³rc
) {

1116 
	`£rv”Log
(
LL_NOTICE
,"S¹šg‡utom©iø»wr™šg oàAOF oÀ%Îd%% growth",
growth
);

1117 
	`»wr™eAµ’dOÆyFeBackground
();

1125 ià(
£rv”
.
aof_æush_po¡pÚed_¡¬t
è
	`æushAµ’dOÆyFe
(0);

1131 
	`run_w™h_³riod
(1000) {

1132 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_ERR
)

1133 
	`æushAµ’dOÆyFe
(0);

1137 
	`ä“Cl›ÁsInAsyncF»eQueue
();

1140 
	`ş›ÁsA»Pau£d
();

1144 
	`run_w™h_³riod
(1000è
	`»¶iÿtiÚCrÚ
();

1147 
	`run_w™h_³riod
(100) {

1148 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”CrÚ
();

1152 
	`run_w™h_³riod
(100) {

1153 ià(
£rv”
.
£Áš–_mode
è
	`£Áš–Tim”
();

1157 
	`run_w™h_³riod
(1000) {

1158 
	`mig¿‹Clo£TimedoutSock‘s
();

1168 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1 &&

1169 
£rv”
.
rdb_bg§ve_scheduËd
 &&

1170 (
£rv”
.
unixtime
-£rv”.
Ï¡bg§ve_Œy
 > 
CONFIG_BGSAVE_RETRY_DELAY
 ||

1171 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_OK
))

1173 
rdbSaveInfo
 
rsi
, *
rsŒ
;

1174 
rsŒ
 = 
	`rdbPİuÏ‹SaveInfo
(&
rsi
);

1175 ià(
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
,
rsŒ
è=ğ
C_OK
)

1176 
£rv”
.
rdb_bg§ve_scheduËd
 = 0;

1179 
£rv”
.
üÚloİs
++;

1180  1000/
£rv”
.
hz
;

1181 
	}
}

1186 
	$befÜeSË•
(
«Ev’tLoİ
 *
ev’tLoİ
) {

1187 
	`UNUSED
(
ev’tLoİ
);

1193 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”BefÜeSË•
();

1197 ià(
£rv”
.
aùive_expœe_’abËd
 && s”v”.
ma¡”ho¡
 =ğ
NULL
)

1198 
	`aùiveExpœeCyşe
(
ACTIVE_EXPIRE_CYCLE_FAST
);

1202 ià(
£rv”
.
g‘_ack_äom_¦aves
) {

1203 
robj
 *
¬gv
[3];

1205 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
("REPLCONF",8);

1206 
¬gv
[1] = 
	`ü—‹SŒšgObjeù
("GETACK",6);

1207 
¬gv
[2] = 
	`ü—‹SŒšgObjeù
("*",1);

1208 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
, s”v”.
¦ave£ldb
, 
¬gv
, 3);

1209 
	`deüRefCouÁ
(
¬gv
[0]);

1210 
	`deüRefCouÁ
(
¬gv
[1]);

1211 
	`deüRefCouÁ
(
¬gv
[2]);

1212 
£rv”
.
g‘_ack_äom_¦aves
 = 0;

1217 ià(
	`li¡L’gth
(
£rv”
.
ş›Ás_wa™šg_acks
))

1218 
	`´oûssCl›ÁsWa™šgR•liÿs
();

1222 
	`moduËHªdËBlockedCl›Ás
();

1225 ià(
	`li¡L’gth
(
£rv”
.
unblocked_ş›Ás
))

1226 
	`´oûssUnblockedCl›Ás
();

1229 
	`æushAµ’dOÆyFe
(0);

1232 
	`hªdËCl›ÁsW™hP’dšgWr™es
();

1237 ià(
	`moduËCouÁ
()è
	`moduËR–—£GIL
();

1238 
	}
}

1243 
	$aá”SË•
(
«Ev’tLoİ
 *
ev’tLoİ
) {

1244 
	`UNUSED
(
ev’tLoİ
);

1245 ià(
	`moduËCouÁ
()è
	`moduËAcquœeGIL
();

1246 
	}
}

1250 
	$ü—‹Sh¬edObjeùs
() {

1251 
j
;

1253 
sh¬ed
.
ülf
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("\r\n"));

1254 
sh¬ed
.
ok
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+OK\r\n"));

1255 
sh¬ed
.
”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("-ERR\r\n"));

1256 
sh¬ed
.
em±ybulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$0\r\n\r\n"));

1257 
sh¬ed
.
cz”o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":0\r\n"));

1258 
sh¬ed
.
cÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":1\r\n"));

1259 
sh¬ed
.
úegÚe
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":-1\r\n"));

1260 
sh¬ed
.
nuÎbulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("$-1\r\n"));

1261 
sh¬ed
.
nuÎmuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*-1\r\n"));

1262 
sh¬ed
.
em±ymuÉibulk
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*0\r\n"));

1263 
sh¬ed
.
pÚg
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+PONG\r\n"));

1264 
sh¬ed
.
queued
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+QUEUED\r\n"));

1265 
sh¬ed
.
em±ysÿn
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("*2\r\n$1\r\n0\r\n*0\r\n"));

1266 
sh¬ed
.
wrÚgty³”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1268 
sh¬ed
.
nokey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1270 
sh¬ed
.
syÁax”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1272 
sh¬ed
.
§meobjeù”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1274 
sh¬ed
.
outoäªg“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1276 
sh¬ed
.
nosü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1278 
sh¬ed
.
lßdšg”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1280 
sh¬ed
.
¦owsü‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1282 
sh¬ed
.
ma¡”dowÃ¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1284 
sh¬ed
.
bg§v“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1286 
sh¬ed
.
ro¦av“¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1288 
sh¬ed
.
nßuth”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1290 
sh¬ed
.
oom”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1292 
sh¬ed
.
exeÿbÜ‹¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1294 
sh¬ed
.
nÜ•liÿ£¼
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1296 
sh¬ed
.
busykey”r
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(

1298 
sh¬ed
.
¥aû
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(" "));

1299 
sh¬ed
.
cŞÚ
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
(":"));

1300 
sh¬ed
.
¶us
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ew
("+"));

1302 
j
 = 0; j < 
PROTO_SHARED_SELECT_CMDS
; j++) {

1303 
diùid_¡r
[64];

1304 
diùid_Ën
;

1306 
diùid_Ën
 = 
	`Î2¡ršg
(
diùid_¡r
,(diùid_¡r),
j
);

1307 
sh¬ed
.
£Ëù
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

1308 
	`sdsÿrštf
(
	`sd£m±y
(),

1310 
diùid_Ën
, 
diùid_¡r
));

1312 
sh¬ed
.
mes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$7\r\nmessage\r\n",13);

1313 
sh¬ed
.
pmes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$8\r\npmessage\r\n",14);

1314 
sh¬ed
.
subsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$9\r\nsubscribe\r\n",15);

1315 
sh¬ed
.
unsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$11\r\nunsubscribe\r\n",18);

1316 
sh¬ed
.
psubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$10\r\npsubscribe\r\n",17);

1317 
sh¬ed
.
punsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$12\r\npunsubscribe\r\n",19);

1318 
sh¬ed
.
d–
 = 
	`ü—‹SŒšgObjeù
("DEL",3);

1319 
sh¬ed
.
uÆšk
 = 
	`ü—‹SŒšgObjeù
("UNLINK",6);

1320 
sh¬ed
.
½İ
 = 
	`ü—‹SŒšgObjeù
("RPOP",4);

1321 
sh¬ed
.
Íİ
 = 
	`ü—‹SŒšgObjeù
("LPOP",4);

1322 
sh¬ed
.
Íush
 = 
	`ü—‹SŒšgObjeù
("LPUSH",5);

1323 
j
 = 0; j < 
OBJ_SHARED_INTEGERS
; j++) {

1324 
sh¬ed
.
š‹g”s
[
j
] =

1325 
	`makeObjeùSh¬ed
(
	`ü—‹Objeù
(
OBJ_STRING
,(*)()
j
));

1326 
sh¬ed
.
š‹g”s
[
j
]->
’codšg
 = 
OBJ_ENCODING_INT
;

1328 
j
 = 0; j < 
OBJ_SHARED_BULKHDR_LEN
; j++) {

1329 
sh¬ed
.
mbulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

1330 
	`sdsÿrštf
(
	`sd£m±y
(),"*%d\r\n",
j
));

1331 
sh¬ed
.
bulkhdr
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

1332 
	`sdsÿrštf
(
	`sd£m±y
(),"$%d\r\n",
j
));

1338 
sh¬ed
.
mš¡ršg
 = 
	`sd¢ew
("minstring");

1339 
sh¬ed
.
max¡ršg
 = 
	`sd¢ew
("maxstring");

1340 
	}
}

1342 
	$š™S”v”CÚfig
() {

1343 
j
;

1345 
	`±h»ad_mu‹x_š™
(&
£rv”
.
Ãxt_ş›Á_id_mu‹x
,
NULL
);

1346 
	`±h»ad_mu‹x_š™
(&
£rv”
.
Ìuşock_mu‹x
,
NULL
);

1347 
	`±h»ad_mu‹x_š™
(&
£rv”
.
unixtime_mu‹x
,
NULL
);

1349 
	`g‘RªdomHexCh¬s
(
£rv”
.
runid
,
CONFIG_RUN_ID_SIZE
);

1350 
£rv”
.
runid
[
CONFIG_RUN_ID_SIZE
] = '\0';

1351 
	`chªgeR•liÿtiÚId
();

1352 
	`ş—rR•liÿtiÚId2
();

1353 
£rv”
.
cÚfigfe
 = 
NULL
;

1354 
£rv”
.
execubË
 = 
NULL
;

1355 
£rv”
.
hz
 = 
CONFIG_DEFAULT_HZ
;

1356 
£rv”
.
¬ch_b™s
 = (() == 8) ? 64 : 32;

1357 
£rv”
.
pÜt
 = 
CONFIG_DEFAULT_SERVER_PORT
;

1358 
£rv”
.
tı_backlog
 = 
CONFIG_DEFAULT_TCP_BACKLOG
;

1359 
£rv”
.
bšdaddr_couÁ
 = 0;

1360 
£rv”
.
unixsock‘
 = 
NULL
;

1361 
£rv”
.
unixsock‘³rm
 = 
CONFIG_DEFAULT_UNIX_SOCKET_PERM
;

1362 
£rv”
.
fd_couÁ
 = 0;

1363 
£rv”
.
sofd
 = -1;

1364 
£rv”
.
´Ùeùed_mode
 = 
CONFIG_DEFAULT_PROTECTED_MODE
;

1365 
£rv”
.
dbnum
 = 
CONFIG_DEFAULT_DBNUM
;

1366 
£rv”
.
v”bos™y
 = 
CONFIG_DEFAULT_VERBOSITY
;

1367 
£rv”
.
maxidËtime
 = 
CONFIG_DEFAULT_CLIENT_TIMEOUT
;

1368 
£rv”
.
tık“·live
 = 
CONFIG_DEFAULT_TCP_KEEPALIVE
;

1369 
£rv”
.
aùive_expœe_’abËd
 = 1;

1370 
£rv”
.
aùive_deäag_’abËd
 = 
CONFIG_DEFAULT_ACTIVE_DEFRAG
;

1371 
£rv”
.
aùive_deäag_ignÜe_by‹s
 = 
CONFIG_DEFAULT_DEFRAG_IGNORE_BYTES
;

1372 
£rv”
.
aùive_deäag_th»shŞd_low”
 = 
CONFIG_DEFAULT_DEFRAG_THRESHOLD_LOWER
;

1373 
£rv”
.
aùive_deäag_th»shŞd_uµ”
 = 
CONFIG_DEFAULT_DEFRAG_THRESHOLD_UPPER
;

1374 
£rv”
.
aùive_deäag_cyşe_mš
 = 
CONFIG_DEFAULT_DEFRAG_CYCLE_MIN
;

1375 
£rv”
.
aùive_deäag_cyşe_max
 = 
CONFIG_DEFAULT_DEFRAG_CYCLE_MAX
;

1376 
£rv”
.
´Ùo_max_bulk_Ën
 = 
CONFIG_DEFAULT_PROTO_MAX_BULK_LEN
;

1377 
£rv”
.
ş›Á_max_qu”ybuf_Ën
 = 
PROTO_MAX_QUERYBUF_LEN
;

1378 
£rv”
.
§v•¬ams
 = 
NULL
;

1379 
£rv”
.
lßdšg
 = 0;

1380 
£rv”
.
logfe
 = 
	`z¡rdup
(
CONFIG_DEFAULT_LOGFILE
);

1381 
£rv”
.
sy¦og_’abËd
 = 
CONFIG_DEFAULT_SYSLOG_ENABLED
;

1382 
£rv”
.
sy¦og_id’t
 = 
	`z¡rdup
(
CONFIG_DEFAULT_SYSLOG_IDENT
);

1383 
£rv”
.
sy¦og_çc™y
 = 
LOG_LOCAL0
;

1384 
£rv”
.
d«mÚize
 = 
CONFIG_DEFAULT_DAEMONIZE
;

1385 
£rv”
.
su³rvi£d
 = 0;

1386 
£rv”
.
su³rvi£d_mode
 = 
SUPERVISED_NONE
;

1387 
£rv”
.
aof_¡©e
 = 
AOF_OFF
;

1388 
£rv”
.
aof_fsync
 = 
CONFIG_DEFAULT_AOF_FSYNC
;

1389 
£rv”
.
aof_no_fsync_Ú_»wr™e
 = 
CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
;

1390 
£rv”
.
aof_»wr™e_³rc
 = 
AOF_REWRITE_PERC
;

1391 
£rv”
.
aof_»wr™e_mš_size
 = 
AOF_REWRITE_MIN_SIZE
;

1392 
£rv”
.
aof_»wr™e_ba£_size
 = 0;

1393 
£rv”
.
aof_»wr™e_scheduËd
 = 0;

1394 
£rv”
.
aof_Ï¡_fsync
 = 
	`time
(
NULL
);

1395 
£rv”
.
aof_»wr™e_time_Ï¡
 = -1;

1396 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

1397 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
C_OK
;

1398 
£rv”
.
aof_d–ayed_fsync
 = 0;

1399 
£rv”
.
aof_fd
 = -1;

1400 
£rv”
.
aof_£Ëùed_db
 = -1;

1401 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = 0;

1402 
£rv”
.
aof_»wr™e_šüem’l_fsync
 = 
CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
;

1403 
£rv”
.
aof_lßd_Œunÿ‹d
 = 
CONFIG_DEFAULT_AOF_LOAD_TRUNCATED
;

1404 
£rv”
.
aof_u£_rdb_´—mbË
 = 
CONFIG_DEFAULT_AOF_USE_RDB_PREAMBLE
;

1405 
£rv”
.
pidfe
 = 
NULL
;

1406 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
CONFIG_DEFAULT_RDB_FILENAME
);

1407 
£rv”
.
aof_f’ame
 = 
	`z¡rdup
(
CONFIG_DEFAULT_AOF_FILENAME
);

1408 
£rv”
.
»quœ•ass
 = 
NULL
;

1409 
£rv”
.
rdb_com´essiÚ
 = 
CONFIG_DEFAULT_RDB_COMPRESSION
;

1410 
£rv”
.
rdb_checksum
 = 
CONFIG_DEFAULT_RDB_CHECKSUM
;

1411 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 
CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
;

1412 
£rv”
.
aùiv”ehashšg
 = 
CONFIG_DEFAULT_ACTIVE_REHASHING
;

1413 
£rv”
.
aùive_deäag_ruÂšg
 = 0;

1414 
£rv”
.
nÙify_key¥aû_ev’ts
 = 0;

1415 
£rv”
.
maxş›Ás
 = 
CONFIG_DEFAULT_MAX_CLIENTS
;

1416 
£rv”
.
bpİ_blocked_ş›Ás
 = 0;

1417 
£rv”
.
maxmemÜy
 = 
CONFIG_DEFAULT_MAXMEMORY
;

1418 
£rv”
.
maxmemÜy_pŞicy
 = 
CONFIG_DEFAULT_MAXMEMORY_POLICY
;

1419 
£rv”
.
maxmemÜy_§m¶es
 = 
CONFIG_DEFAULT_MAXMEMORY_SAMPLES
;

1420 
£rv”
.
lfu_log_çùÜ
 = 
CONFIG_DEFAULT_LFU_LOG_FACTOR
;

1421 
£rv”
.
lfu_deÿy_time
 = 
CONFIG_DEFAULT_LFU_DECAY_TIME
;

1422 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
OBJ_HASH_MAX_ZIPLIST_ENTRIES
;

1423 
£rv”
.
hash_max_zli¡_v®ue
 = 
OBJ_HASH_MAX_ZIPLIST_VALUE
;

1424 
£rv”
.
li¡_max_zli¡_size
 = 
OBJ_LIST_MAX_ZIPLIST_SIZE
;

1425 
£rv”
.
li¡_com´ess_d•th
 = 
OBJ_LIST_COMPRESS_DEPTH
;

1426 
£rv”
.
£t_max_št£t_’Œ›s
 = 
OBJ_SET_MAX_INTSET_ENTRIES
;

1427 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
OBJ_ZSET_MAX_ZIPLIST_ENTRIES
;

1428 
£rv”
.
z£t_max_zli¡_v®ue
 = 
OBJ_ZSET_MAX_ZIPLIST_VALUE
;

1429 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
;

1430 
£rv”
.
shutdown_a§p
 = 0;

1431 
£rv”
.
şu¡”_’abËd
 = 0;

1432 
£rv”
.
şu¡”_node_timeout
 = 
CLUSTER_DEFAULT_NODE_TIMEOUT
;

1433 
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 = 
CLUSTER_DEFAULT_MIGRATION_BARRIER
;

1434 
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 = 
CLUSTER_DEFAULT_SLAVE_VALIDITY
;

1435 
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
 = 
CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
;

1436 
£rv”
.
şu¡”_¦ave_no_çov”
 = 
CLUSTER_DEFAULT_SLAVE_NO_FAILOVER
;

1437 
£rv”
.
şu¡”_cÚfigfe
 = 
	`z¡rdup
(
CONFIG_DEFAULT_CLUSTER_CONFIG_FILE
);

1438 
£rv”
.
şu¡”_ªnounû_
 = 
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_IP
;

1439 
£rv”
.
şu¡”_ªnounû_pÜt
 = 
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT
;

1440 
£rv”
.
şu¡”_ªnounû_bus_pÜt
 = 
CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT
;

1441 
£rv”
.
mig¿‹_ÿched_sock‘s
 = 
	`diùC»©e
(&
mig¿‹CacheDiùTy³
,
NULL
);

1442 
£rv”
.
Ãxt_ş›Á_id
 = 1;

1443 
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 = (1024*1024*2);

1444 
£rv”
.
Ïzyä“_Ïzy_eviùiÚ
 = 
CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION
;

1445 
£rv”
.
Ïzyä“_Ïzy_expœe
 = 
CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE
;

1446 
£rv”
.
Ïzyä“_Ïzy_£rv”_d–
 = 
CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL
;

1447 
£rv”
.
®ways_show_logo
 = 
CONFIG_DEFAULT_ALWAYS_SHOW_LOGO
;

1448 
£rv”
.
lua_time_lim™
 = 
LUA_SCRIPT_TIME_LIMIT
;

1450 
Ìuşock
 = 
	`g‘LRUClock
();

1451 
	`©omicS‘
(
£rv”
.
Ìuşock
,lruclock);

1452 
	`»£tS”v”SaveP¬ams
();

1454 
	`­³ndS”v”SaveP¬ams
(60*60,1);

1455 
	`­³ndS”v”SaveP¬ams
(300,100);

1456 
	`­³ndS”v”SaveP¬ams
(60,10000);

1459 
£rv”
.
ma¡”auth
 = 
NULL
;

1460 
£rv”
.
ma¡”ho¡
 = 
NULL
;

1461 
£rv”
.
ma¡”pÜt
 = 6379;

1462 
£rv”
.
ma¡”
 = 
NULL
;

1463 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

1464 
£rv”
.
ma¡”_š™Ÿl_off£t
 = -1;

1465 
£rv”
.
»¶_¡©e
 = 
REPL_STATE_NONE
;

1466 
£rv”
.
»¶_syncio_timeout
 = 
CONFIG_REPL_SYNCIO_TIMEOUT
;

1467 
£rv”
.
»¶_£rve_¡®e_d©a
 = 
CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA
;

1468 
£rv”
.
»¶_¦ave_ro
 = 
CONFIG_DEFAULT_SLAVE_READ_ONLY
;

1469 
£rv”
.
»¶_¦ave_Ïzy_æush
 = 
CONFIG_DEFAULT_SLAVE_LAZY_FLUSH
;

1470 
£rv”
.
»¶_down_sšû
 = 0;

1471 
£rv”
.
»¶_di§bË_tı_nod–ay
 = 
CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY
;

1472 
£rv”
.
»¶_diskËss_sync
 = 
CONFIG_DEFAULT_REPL_DISKLESS_SYNC
;

1473 
£rv”
.
»¶_diskËss_sync_d–ay
 = 
CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY
;

1474 
£rv”
.
»¶_pšg_¦ave_³riod
 = 
CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD
;

1475 
£rv”
.
»¶_timeout
 = 
CONFIG_DEFAULT_REPL_TIMEOUT
;

1476 
£rv”
.
»¶_mš_¦aves_to_wr™e
 = 
CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE
;

1477 
£rv”
.
»¶_mš_¦aves_max_Ïg
 = 
CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG
;

1478 
£rv”
.
¦ave_´iÜ™y
 = 
CONFIG_DEFAULT_SLAVE_PRIORITY
;

1479 
£rv”
.
¦ave_ªnounû_
 = 
CONFIG_DEFAULT_SLAVE_ANNOUNCE_IP
;

1480 
£rv”
.
¦ave_ªnounû_pÜt
 = 
CONFIG_DEFAULT_SLAVE_ANNOUNCE_PORT
;

1481 
£rv”
.
ma¡”_»¶_off£t
 = 0;

1484 
£rv”
.
»¶_backlog
 = 
NULL
;

1485 
£rv”
.
»¶_backlog_size
 = 
CONFIG_DEFAULT_REPL_BACKLOG_SIZE
;

1486 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

1487 
£rv”
.
»¶_backlog_idx
 = 0;

1488 
£rv”
.
»¶_backlog_off
 = 0;

1489 
£rv”
.
»¶_backlog_time_lim™
 = 
CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
;

1490 
£rv”
.
»¶_no_¦aves_sšû
 = 
	`time
(
NULL
);

1493 
j
 = 0; j < 
CLIENT_TYPE_OBUF_COUNT
; j++)

1494 
£rv”
.
ş›Á_obuf_lim™s
[
j
] = 
ş›ÁBufãrLim™sDeçuÉs
[j];

1497 
R_Z”o
 = 0.0;

1498 
R_PosInf
 = 1.0/
R_Z”o
;

1499 
R_NegInf
 = -1.0/
R_Z”o
;

1500 
R_Nª
 = 
R_Z”o
/R_Zero;

1505 
£rv”
.
commªds
 = 
	`diùC»©e
(&
commªdTabËDiùTy³
,
NULL
);

1506 
£rv”
.
Üig_commªds
 = 
	`diùC»©e
(&
commªdTabËDiùTy³
,
NULL
);

1507 
	`pİuÏ‹CommªdTabË
();

1508 
£rv”
.
d–Commªd
 = 
	`lookupCommªdByCSŒšg
("del");

1509 
£rv”
.
muÉiCommªd
 = 
	`lookupCommªdByCSŒšg
("multi");

1510 
£rv”
.
ÍushCommªd
 = 
	`lookupCommªdByCSŒšg
("lpush");

1511 
£rv”
.
ÍİCommªd
 = 
	`lookupCommªdByCSŒšg
("lpop");

1512 
£rv”
.
½İCommªd
 = 
	`lookupCommªdByCSŒšg
("rpop");

1513 
£rv”
.
¤emCommªd
 = 
	`lookupCommªdByCSŒšg
("srem");

1514 
£rv”
.
execCommªd
 = 
	`lookupCommªdByCSŒšg
("exec");

1515 
£rv”
.
expœeCommªd
 = 
	`lookupCommªdByCSŒšg
("expire");

1516 
£rv”
.
³xpœeCommªd
 = 
	`lookupCommªdByCSŒšg
("pexpire");

1519 
£rv”
.
¦owlog_log_¦ow”_thª
 = 
CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
;

1520 
£rv”
.
¦owlog_max_Ën
 = 
CONFIG_DEFAULT_SLOWLOG_MAX_LEN
;

1523 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 = 
CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD
;

1526 
£rv”
.
as£¹_çed
 = "<no‡ssertion failed>";

1527 
£rv”
.
as£¹_fe
 = "<no file>";

1528 
£rv”
.
as£¹_lše
 = 0;

1529 
£rv”
.
bug_»pÜt_¡¬t
 = 0;

1530 
£rv”
.
w©chdog_³riod
 = 0;

1531 
	}
}

1533 **
’vœÚ
;

1550 
	$»¡¬tS”v”
(
æags
, 
m¡ime_t
 
d–ay
) {

1551 
j
;

1555 ià(
	`acûss
(
£rv”
.
execubË
,
X_OK
) == -1) {

1556 
	`£rv”Log
(
LL_WARNING
,"Can't„estart:his…rocess has‚o "

1557 "³rmissiÚ tØexecu‹ %s", 
£rv”
.
execubË
);

1558  
C_ERR
;

1562 ià(
æags
 & 
RESTART_SERVER_CONFIG_REWRITE
 &&

1563 
£rv”
.
cÚfigfe
 &&

1564 
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
) == -1)

1566 
	`£rv”Log
(
LL_WARNING
,"Can't„estart: configuration„ewrite…rocess "

1568  
C_ERR
;

1572 ià(
æags
 & 
RESTART_SERVER_GRACEFULLY
 &&

1573 
	`´•¬eFÜShutdown
(
SHUTDOWN_NOFLAGS
è!ğ
C_OK
)

1575 
	`£rv”Log
(
LL_WARNING
,"Can't„estart:ƒrror…reparing for shutdown");

1576  
C_ERR
;

1581 
j
 = 3; j < ()
£rv”
.
maxş›Ás
 + 1024; j++) {

1584 ià(
	`fú
(
j
,
F_GETFD
è!ğ-1è
	`şo£
(j);

1588 ià(
d–ay
è
	`u¦“p
(delay*1000);

1589 
	`zä“
(
£rv”
.
exec_¬gv
[0]);

1590 
£rv”
.
exec_¬gv
[0] = 
	`z¡rdup
(£rv”.
execubË
);

1591 
	`execve
(
£rv”
.
execubË
,£rv”.
exec_¬gv
,
’vœÚ
);

1594 
	`_ex™
(1);

1596  
C_ERR
;

1597 
	}
}

1607 
	$adju¡O³nFesLim™
() {

1608 
¾im_t
 
maxfes
 = 
£rv”
.
maxş›Ás
+
CONFIG_MIN_RESERVED_FDS
;

1609 
¾im™
 
lim™
;

1611 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
,&
lim™
) == -1) {

1612 
	`£rv”Log
(
LL_WARNING
,"Unableo obtainhe current NOFILE†imit (%s),‡ssuming 1024‡nd settinghe max clients configuration‡ccordingly.",

1613 
	`¡»¼Ü
(
”ºo
));

1614 
£rv”
.
maxş›Ás
 = 1024-
CONFIG_MIN_RESERVED_FDS
;

1616 
¾im_t
 
Şdlim™
 = 
lim™
.
¾im_cur
;

1620 ià(
Şdlim™
 < 
maxfes
) {

1621 
¾im_t
 
be¡lim™
;

1622 
£Œlim™_”rÜ
 = 0;

1626 
be¡lim™
 = 
maxfes
;

1627 
be¡lim™
 > 
Şdlim™
) {

1628 
¾im_t
 
deü_¡•
 = 16;

1630 
lim™
.
¾im_cur
 = 
be¡lim™
;

1631 
lim™
.
¾im_max
 = 
be¡lim™
;

1632 ià(
	`£Œlim™
(
RLIMIT_NOFILE
,&
lim™
) != -1) ;

1633 
£Œlim™_”rÜ
 = 
”ºo
;

1637 ià(
be¡lim™
 < 
deü_¡•
) ;

1638 
be¡lim™
 -ğ
deü_¡•
;

1643 ià(
be¡lim™
 < 
Şdlim™
) bestlimit = oldlimit;

1645 ià(
be¡lim™
 < 
maxfes
) {

1646 
Şd_maxş›Ás
 = 
£rv”
.
maxş›Ás
;

1647 
£rv”
.
maxş›Ás
 = 
be¡lim™
-
CONFIG_MIN_RESERVED_FDS
;

1651 ià(
be¡lim™
 <ğ
CONFIG_MIN_RESERVED_FDS
) {

1652 
	`£rv”Log
(
LL_WARNING
,"Your current 'ulimit -n' "

1656 (è
Şdlim™
,

1657 (è
maxfes
);

1658 
	`ex™
(1);

1660 
	`£rv”Log
(
LL_WARNING
,"You„equested maxclients of %d "

1662 
Şd_maxş›Ás
,

1663 (è
maxfes
);

1664 
	`£rv”Log
(
LL_WARNING
,"Server can't set maximum open files "

1666 (è
maxfes
, 
	`¡»¼Ü
(
£Œlim™_”rÜ
));

1667 
	`£rv”Log
(
LL_WARNING
,"Current maximum open files is %llu. "

1671 (è
be¡lim™
, 
£rv”
.
maxş›Ás
);

1673 
	`£rv”Log
(
LL_NOTICE
,"Increased maximum‚umber of open files "

1675 (è
maxfes
,

1676 (è
Şdlim™
);

1680 
	}
}

1684 
	$checkTıBacklogS‘tšgs
() {

1685 #ifdeà
HAVE_PROC_SOMAXCONN


1686 
FILE
 *
å
 = 
	`fİ’
("/proc/sys/net/core/somaxconn","r");

1687 
buf
[1024];

1688 ià(!
å
) ;

1689 ià(
	`fg‘s
(
buf
,(buf),
å
è!ğ
NULL
) {

1690 
somaxcÚn
 = 
	`©oi
(
buf
);

1691 ià(
somaxcÚn
 > 0 && somaxcÚÀ< 
£rv”
.
tı_backlog
) {

1692 
	`£rv”Log
(
LL_WARNING
,"WARNING: ThTCP backlog s‘tšg oà%d cªnÙ b’fÜûd beÿu£ /´oc/sys/Ãt/cÜe/somaxcÚÀi £ˆtØthlow” v®uoà%d.", 
£rv”
.
tı_backlog
, 
somaxcÚn
);

1695 
	`fşo£
(
å
);

1697 
	}
}

1717 
	$li¡’ToPÜt
(
pÜt
, *
fds
, *
couÁ
) {

1718 
j
;

1722 ià(
£rv”
.
bšdaddr_couÁ
 =ğ0è£rv”.
bšdaddr
[0] = 
NULL
;

1723 
j
 = 0; j < 
£rv”
.
bšdaddr_couÁ
 || j == 0; j++) {

1724 ià(
£rv”
.
bšdaddr
[
j
] =ğ
NULL
) {

1725 
unsuµÜ‹d
 = 0;

1728 
fds
[*
couÁ
] = 
	`ª‘Tı6S”v”
(
£rv”
.
Ã‹¼
,
pÜt
,
NULL
,

1729 
£rv”
.
tı_backlog
);

1730 ià(
fds
[*
couÁ
] !ğ
ANET_ERR
) {

1731 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1732 (*
couÁ
)++;

1733 } ià(
”ºo
 =ğ
EAFNOSUPPORT
) {

1734 
unsuµÜ‹d
++;

1735 
	`£rv”Log
(
LL_WARNING
,"Not†isteningo IPv6: unsupproted");

1738 ià(*
couÁ
 =ğ1 || 
unsuµÜ‹d
) {

1740 
fds
[*
couÁ
] = 
	`ª‘TıS”v”
(
£rv”
.
Ã‹¼
,
pÜt
,
NULL
,

1741 
£rv”
.
tı_backlog
);

1742 ià(
fds
[*
couÁ
] !ğ
ANET_ERR
) {

1743 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1744 (*
couÁ
)++;

1745 } ià(
”ºo
 =ğ
EAFNOSUPPORT
) {

1746 
unsuµÜ‹d
++;

1747 
	`£rv”Log
(
LL_WARNING
,"Not†isteningo IPv4: unsupproted");

1753 ià(*
couÁ
 + 
unsuµÜ‹d
 == 2) ;

1754 } ià(
	`¡rchr
(
£rv”
.
bšdaddr
[
j
],':')) {

1756 
fds
[*
couÁ
] = 
	`ª‘Tı6S”v”
(
£rv”
.
Ã‹¼
,
pÜt
,£rv”.
bšdaddr
[
j
],

1757 
£rv”
.
tı_backlog
);

1760 
fds
[*
couÁ
] = 
	`ª‘TıS”v”
(
£rv”
.
Ã‹¼
,
pÜt
,£rv”.
bšdaddr
[
j
],

1761 
£rv”
.
tı_backlog
);

1763 ià(
fds
[*
couÁ
] =ğ
ANET_ERR
) {

1764 
	`£rv”Log
(
LL_WARNING
,

1766 
£rv”
.
bšdaddr
[
j
] ? server.bindaddr[j] : "*",

1767 
pÜt
, 
£rv”
.
Ã‹¼
);

1768  
C_ERR
;

1770 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1771 (*
couÁ
)++;

1773  
C_OK
;

1774 
	}
}

1779 
	$»£tS”v”Sts
() {

1780 
j
;

1782 
£rv”
.
¡©_numcommªds
 = 0;

1783 
£rv”
.
¡©_numcÚÃùiÚs
 = 0;

1784 
£rv”
.
¡©_expœedkeys
 = 0;

1785 
£rv”
.
¡©_expœed_¡®e_³rc
 = 0;

1786 
£rv”
.
¡©_expœed_time_ÿp_»ached_couÁ
 = 0;

1787 
£rv”
.
¡©_eviùedkeys
 = 0;

1788 
£rv”
.
¡©_key¥aû_mis£s
 = 0;

1789 
£rv”
.
¡©_key¥aû_h™s
 = 0;

1790 
£rv”
.
¡©_aùive_deäag_h™s
 = 0;

1791 
£rv”
.
¡©_aùive_deäag_mis£s
 = 0;

1792 
£rv”
.
¡©_aùive_deäag_key_h™s
 = 0;

1793 
£rv”
.
¡©_aùive_deäag_key_mis£s
 = 0;

1794 
£rv”
.
¡©_fÜk_time
 = 0;

1795 
£rv”
.
¡©_fÜk_¿‹
 = 0;

1796 
£rv”
.
¡©_»jeùed_cÚn
 = 0;

1797 
£rv”
.
¡©_sync_fuÎ
 = 0;

1798 
£rv”
.
¡©_sync_·¹Ÿl_ok
 = 0;

1799 
£rv”
.
¡©_sync_·¹Ÿl_”r
 = 0;

1800 
j
 = 0; j < 
STATS_METRIC_COUNT
; j++) {

1801 
£rv”
.
š¡_m‘ric
[
j
].
idx
 = 0;

1802 
£rv”
.
š¡_m‘ric
[
j
].
Ï¡_§m¶e_time
 = 
	`m¡ime
();

1803 
£rv”
.
š¡_m‘ric
[
j
].
Ï¡_§m¶e_couÁ
 = 0;

1804 
	`mem£t
(
£rv”
.
š¡_m‘ric
[
j
].
§m¶es
,0,

1805 (
£rv”
.
š¡_m‘ric
[
j
].
§m¶es
));

1807 
£rv”
.
¡©_Ãt_šput_by‹s
 = 0;

1808 
£rv”
.
¡©_Ãt_ouut_by‹s
 = 0;

1809 
£rv”
.
aof_d–ayed_fsync
 = 0;

1810 
	}
}

1812 
	$š™S”v”
() {

1813 
j
;

1815 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

1816 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

1817 
	`£tupSigÇlHªdËrs
();

1819 ià(
£rv”
.
sy¦og_’abËd
) {

1820 
	`İ’log
(
£rv”
.
sy¦og_id’t
, 
LOG_PID
 | 
LOG_NDELAY
 | 
LOG_NOWAIT
,

1821 
£rv”
.
sy¦og_çc™y
);

1824 
£rv”
.
pid
 = 
	`g‘pid
();

1825 
£rv”
.
cu¼’t_ş›Á
 = 
NULL
;

1826 
£rv”
.
ş›Ás
 = 
	`li¡C»©e
();

1827 
£rv”
.
ş›Ás_to_şo£
 = 
	`li¡C»©e
();

1828 
£rv”
.
¦aves
 = 
	`li¡C»©e
();

1829 
£rv”
.
mÚ™Üs
 = 
	`li¡C»©e
();

1830 
£rv”
.
ş›Ás_³ndšg_wr™e
 = 
	`li¡C»©e
();

1831 
£rv”
.
¦ave£ldb
 = -1;

1832 
£rv”
.
unblocked_ş›Ás
 = 
	`li¡C»©e
();

1833 
£rv”
.
»ady_keys
 = 
	`li¡C»©e
();

1834 
£rv”
.
ş›Ás_wa™šg_acks
 = 
	`li¡C»©e
();

1835 
£rv”
.
g‘_ack_äom_¦aves
 = 0;

1836 
£rv”
.
ş›Ás_·u£d
 = 0;

1837 
£rv”
.
sy¡em_memÜy_size
 = 
	`zm®loc_g‘_memÜy_size
();

1839 
	`ü—‹Sh¬edObjeùs
();

1840 
	`adju¡O³nFesLim™
();

1841 
£rv”
.
–
 = 
	`«C»©eEv’tLoİ
(£rv”.
maxş›Ás
+
CONFIG_FDSET_INCR
);

1842 ià(
£rv”
.
–
 =ğ
NULL
) {

1843 
	`£rv”Log
(
LL_WARNING
,

1845 
	`¡»¼Ü
(
”ºo
));

1846 
	`ex™
(1);

1848 
£rv”
.
db
 = 
	`zm®loc
((
»disDb
)*£rv”.
dbnum
);

1851 ià(
£rv”
.
pÜt
 != 0 &&

1852 
	`li¡’ToPÜt
(
£rv”
.
pÜt
,£rv”.
fd
,&£rv”.
fd_couÁ
è=ğ
C_ERR
)

1853 
	`ex™
(1);

1856 ià(
£rv”
.
unixsock‘
 !ğ
NULL
) {

1857 
	`uÆšk
(
£rv”
.
unixsock‘
);

1858 
£rv”
.
sofd
 = 
	`ª‘UnixS”v”
(£rv”.
Ã‹¼
,£rv”.
unixsock‘
,

1859 
£rv”
.
unixsock‘³rm
, s”v”.
tı_backlog
);

1860 ià(
£rv”
.
sofd
 =ğ
ANET_ERR
) {

1861 
	`£rv”Log
(
LL_WARNING
, "O³nšg Unix sock‘: %s", 
£rv”
.
Ã‹¼
);

1862 
	`ex™
(1);

1864 
	`ª‘NÚBlock
(
NULL
,
£rv”
.
sofd
);

1868 ià(
£rv”
.
fd_couÁ
 =ğ0 && s”v”.
sofd
 < 0) {

1869 
	`£rv”Log
(
LL_WARNING
, "Configuredo‚ot†isten‡nywhere,ƒxiting.");

1870 
	`ex™
(1);

1874 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

1875 
£rv”
.
db
[
j
].
diù
 = 
	`diùC»©e
(&
dbDiùTy³
,
NULL
);

1876 
£rv”
.
db
[
j
].
expœes
 = 
	`diùC»©e
(&
key±rDiùTy³
,
NULL
);

1877 
£rv”
.
db
[
j
].
blockšg_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1878 
£rv”
.
db
[
j
].
»ady_keys
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

1879 
£rv”
.
db
[
j
].
w©ched_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1880 
£rv”
.
db
[
j
].
id
 = j;

1881 
£rv”
.
db
[
j
].
avg_‰l
 = 0;

1883 
	`eviùiÚPoŞAÎoc
();

1884 
£rv”
.
pubsub_chªÃls
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1885 
£rv”
.
pubsub_·‰”ns
 = 
	`li¡C»©e
();

1886 
	`li¡S‘F»eM‘hod
(
£rv”
.
pubsub_·‰”ns
,
ä“PubsubP©‹º
);

1887 
	`li¡S‘M©chM‘hod
(
£rv”
.
pubsub_·‰”ns
,
li¡M©chPubsubP©‹º
);

1888 
£rv”
.
üÚloİs
 = 0;

1889 
£rv”
.
rdb_chd_pid
 = -1;

1890 
£rv”
.
aof_chd_pid
 = -1;

1891 
£rv”
.
rdb_chd_ty³
 = 
RDB_CHILD_TYPE_NONE
;

1892 
£rv”
.
rdb_bg§ve_scheduËd
 = 0;

1893 
£rv”
.
chd_šfo_pe
[0] = -1;

1894 
£rv”
.
chd_šfo_pe
[1] = -1;

1895 
£rv”
.
chd_šfo_d©a
.
magic
 = 0;

1896 
	`aofRewr™eBufãrRe£t
();

1897 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

1898 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

1899 
£rv”
.
Ï¡bg§ve_Œy
 = 0;

1900 
£rv”
.
rdb_§ve_time_Ï¡
 = -1;

1901 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1902 
£rv”
.
dœty
 = 0;

1903 
	`»£tS”v”Sts
();

1905 
£rv”
.
¡©_¡¬‰ime
 = 
	`time
(
NULL
);

1906 
£rv”
.
¡©_³ak_memÜy
 = 0;

1907 
£rv”
.
¡©_rdb_cow_by‹s
 = 0;

1908 
£rv”
.
¡©_aof_cow_by‹s
 = 0;

1909 
£rv”
.
»sid’t_£t_size
 = 0;

1910 
£rv”
.
Ï¡bg§ve_¡©us
 = 
C_OK
;

1911 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
C_OK
;

1912 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 0;

1913 
£rv”
.
»¶_good_¦aves_couÁ
 = 0;

1914 
	`upd©eCachedTime
();

1919 ià(
	`«C»©eTimeEv’t
(
£rv”
.
–
, 1, 
£rv”CrÚ
, 
NULL
, NULLè=ğ
AE_ERR
) {

1920 
	`£rv”Pªic
("Can't createƒvent†oopimers.");

1921 
	`ex™
(1);

1926 
j
 = 0; j < 
£rv”
.
fd_couÁ
; j++) {

1927 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
fd
[
j
], 
AE_READABLE
,

1928 
acû±TıHªdËr
,
NULL
è=ğ
AE_ERR
)

1930 
	`£rv”Pªic
(

1934 ià(
£rv”
.
sofd
 > 0 && 
	`«C»©eFeEv’t
(£rv”.
–
,£rv”.sofd,
AE_READABLE
,

1935 
acû±UnixHªdËr
,
NULL
è=ğ
AE_ERR
è
	`£rv”Pªic
("Unrecoverableƒrror creating server.sofd fileƒvent.");

1940 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
moduË_blocked_pe
[0], 
AE_READABLE
,

1941 
moduËBlockedCl›ÁPeR—dabË
,
NULL
è=ğ
AE_ERR
) {

1942 
	`£rv”Pªic
(

1948 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
) {

1949 
£rv”
.
aof_fd
 = 
	`İ’
(£rv”.
aof_f’ame
,

1950 
O_RDWR
|
O_APPEND
|
O_CREAT
,0644);

1951 ià(
£rv”
.
aof_fd
 == -1) {

1952 
	`£rv”Log
(
LL_WARNING
, "Can't openhe‡ppend-only file: %s",

1953 
	`¡»¼Ü
(
”ºo
));

1954 
	`ex™
(1);

1962 ià(
£rv”
.
¬ch_b™s
 =ğ32 && s”v”.
maxmemÜy
 == 0) {

1963 
	`£rv”Log
(
LL_WARNING
,"Warning: 32 bit instance detected but‚o memory†imit set. Setting 3 GB maxmemory†imit with 'noeviction'…olicy‚ow.");

1964 
£rv”
.
maxmemÜy
 = 3072LL*(1024*1024);

1965 
£rv”
.
maxmemÜy_pŞicy
 = 
MAXMEMORY_NO_EVICTION
;

1968 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”In™
();

1969 
	`»¶iÿtiÚSütCacheIn™
();

1970 
	`sütšgIn™
(1);

1971 
	`¦owlogIn™
();

1972 
	`Ï‹ncyMÚ™ÜIn™
();

1973 
	`bioIn™
();

1974 
£rv”
.
š™Ÿl_memÜy_u§ge
 = 
	`zm®loc_u£d_memÜy
();

1975 
	}
}

1979 
	$pİuÏ‹CommªdTabË
() {

1980 
j
;

1981 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

1983 
j
 = 0; j < 
numcommªds
; j++) {

1984 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

1985 *
f
 = 
c
->
sæags
;

1986 
»tv®1
, 
»tv®2
;

1988 *
f
 != '\0') {

1989 *
f
) {

1990 'w': 
c
->
æags
 |ğ
CMD_WRITE
; ;

1991 'r': 
c
->
æags
 |ğ
CMD_READONLY
; ;

1992 'm': 
c
->
æags
 |ğ
CMD_DENYOOM
; ;

1993 'a': 
c
->
æags
 |ğ
CMD_ADMIN
; ;

1994 'p': 
c
->
æags
 |ğ
CMD_PUBSUB
; ;

1995 's': 
c
->
æags
 |ğ
CMD_NOSCRIPT
; ;

1996 'R': 
c
->
æags
 |ğ
CMD_RANDOM
; ;

1997 'S': 
c
->
æags
 |ğ
CMD_SORT_FOR_SCRIPT
; ;

1998 'l': 
c
->
æags
 |ğ
CMD_LOADING
; ;

1999 't': 
c
->
æags
 |ğ
CMD_STALE
; ;

2000 'M': 
c
->
æags
 |ğ
CMD_SKIP_MONITOR
; ;

2001 'k': 
c
->
æags
 |ğ
CMD_ASKING
; ;

2002 'F': 
c
->
æags
 |ğ
CMD_FAST
; ;

2003 : 
	`£rv”Pªic
("Unsupported command flag"); ;

2005 
f
++;

2008 
»tv®1
 = 
	`diùAdd
(
£rv”
.
commªds
, 
	`sd¢ew
(
c
->
Çme
), c);

2011 
»tv®2
 = 
	`diùAdd
(
£rv”
.
Üig_commªds
, 
	`sd¢ew
(
c
->
Çme
), c);

2012 
	`£rv”As£¹
(
»tv®1
 =ğ
DICT_OK
 && 
»tv®2
 == DICT_OK);

2014 
	}
}

2016 
	$»£tCommªdTabËSts
() {

2017 
»disCommªd
 *
c
;

2018 
diùEÁry
 *
de
;

2019 
diùI‹¿tÜ
 *
di
;

2021 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
commªds
);

2022 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2023 
c
 = (
»disCommªd
 *è
	`diùG‘V®
(
de
);

2024 
c
->
miüo£cÚds
 = 0;

2025 
c
->
ÿÎs
 = 0;

2027 
	`diùR–—£I‹¿tÜ
(
di
);

2029 
	}
}

2033 
	$»disOpA¼ayIn™
(
»disOpA¼ay
 *
ß
) {

2034 
ß
->
İs
 = 
NULL
;

2035 
ß
->
numİs
 = 0;

2036 
	}
}

2038 
	$»disOpA¼ayAµ’d
(
»disOpA¼ay
 *
ß
, 
»disCommªd
 *
cmd
, 
dbid
,

2039 
robj
 **
¬gv
, 
¬gc
, 
rg‘
)

2041 
»disOp
 *
İ
;

2043 
ß
->
İs
 = 
	`z»®loc
(ß->İs,(
»disOp
)*(ß->
numİs
+1));

2044 
İ
 = 
ß
->
İs
+ß->
numİs
;

2045 
İ
->
cmd
 = cmd;

2046 
İ
->
dbid
 = dbid;

2047 
İ
->
¬gv
 =‡rgv;

2048 
İ
->
¬gc
 =‡rgc;

2049 
İ
->
rg‘
 =arget;

2050 
ß
->
numİs
++;

2051  
ß
->
numİs
;

2052 
	}
}

2054 
	$»disOpA¼ayF»e
(
»disOpA¼ay
 *
ß
) {

2055 
ß
->
numİs
) {

2056 
j
;

2057 
»disOp
 *
İ
;

2059 
ß
->
numİs
--;

2060 
İ
 = 
ß
->
İs
+ß->
numİs
;

2061 
j
 = 0; j < 
İ
->
¬gc
; j++)

2062 
	`deüRefCouÁ
(
İ
->
¬gv
[
j
]);

2063 
	`zä“
(
İ
->
¬gv
);

2065 
	`zä“
(
ß
->
İs
);

2066 
	}
}

2070 
»disCommªd
 *
	$lookupCommªd
(
sds
 
Çme
) {

2071  
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

2072 
	}
}

2074 
»disCommªd
 *
	$lookupCommªdByCSŒšg
(*
s
) {

2075 
»disCommªd
 *
cmd
;

2076 
sds
 
Çme
 = 
	`sd¢ew
(
s
);

2078 
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

2079 
	`sdsä“
(
Çme
);

2080  
cmd
;

2081 
	}
}

2090 
»disCommªd
 *
	$lookupCommªdOrOrigš®
(
sds
 
Çme
) {

2091 
»disCommªd
 *
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

2093 ià(!
cmd
ècmd = 
	`diùF‘chV®ue
(
£rv”
.
Üig_commªds
,
Çme
);

2094  
cmd
;

2095 
	}
}

2108 
	$´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

2109 
æags
)

2111 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
 && 
æags
 & 
PROPAGATE_AOF
)

2112 
	`ãedAµ’dOÆyFe
(
cmd
,
dbid
,
¬gv
,
¬gc
);

2113 ià(
æags
 & 
PROPAGATE_REPL
)

2114 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
,
dbid
,
¬gv
,
¬gc
);

2115 
	}
}

2129 
	$®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

2130 
rg‘
)

2132 
robj
 **
¬gvcİy
;

2133 
j
;

2135 ià(
£rv”
.
lßdšg
) ;

2137 
¬gvcİy
 = 
	`zm®loc
((
robj
*)*
¬gc
);

2138 
j
 = 0; j < 
¬gc
; j++) {

2139 
¬gvcİy
[
j
] = 
¬gv
[j];

2140 
	`šüRefCouÁ
(
¬gv
[
j
]);

2142 
	`»disOpA¼ayAµ’d
(&
£rv”
.
®so_´İag©e
,
cmd
,
dbid
,
¬gvcİy
,
¬gc
,
rg‘
);

2143 
	}
}

2148 
	$fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
) {

2149 ià(
æags
 & 
PROPAGATE_REPL
è
c
->æag |ğ
CLIENT_FORCE_REPL
;

2150 ià(
æags
 & 
PROPAGATE_AOF
è
c
->æag |ğ
CLIENT_FORCE_AOF
;

2151 
	}
}

2156 
	$´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
) {

2157 
c
->
æags
 |ğ
CLIENT_PREVENT_PROP
;

2158 
	}
}

2161 
	$´ev’tCommªdAOF
(
ş›Á
 *
c
) {

2162 
c
->
æags
 |ğ
CLIENT_PREVENT_AOF_PROP
;

2163 
	}
}

2166 
	$´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
) {

2167 
c
->
æags
 |ğ
CLIENT_PREVENT_REPL_PROP
;

2168 
	}
}

2207 
	$ÿÎ
(
ş›Á
 *
c
, 
æags
) {

2208 
dœty
, 
¡¬t
, 
du¿tiÚ
;

2209 
ş›Á_Şd_æags
 = 
c
->
æags
;

2213 ià(
	`li¡L’gth
(
£rv”
.
mÚ™Üs
) &&

2214 !
£rv”
.
lßdšg
 &&

2215 !(
c
->
cmd
->
æags
 & (
CMD_SKIP_MONITOR
|
CMD_ADMIN
)))

2217 
	`»¶iÿtiÚF“dMÚ™Üs
(
c
,
£rv”
.
mÚ™Üs
,c->
db
->
id
,c->
¬gv
,c->
¬gc
);

2222 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

2223 
»disOpA¼ay
 
´ev_®so_´İag©e
 = 
£rv”
.
®so_´İag©e
;

2224 
	`»disOpA¼ayIn™
(&
£rv”
.
®so_´İag©e
);

2227 
dœty
 = 
£rv”
.dirty;

2228 
¡¬t
 = 
	`u¡ime
();

2229 
c
->
cmd
->
	`´oc
(c);

2230 
du¿tiÚ
 = 
	`u¡ime
()-
¡¬t
;

2231 
dœty
 = 
£rv”
.dirty-dirty;

2232 ià(
dœty
 < 0) dirty = 0;

2236 ià(
£rv”
.
lßdšg
 && 
c
->
æags
 & 
CLIENT_LUA
)

2237 
æags
 &ğ~(
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
);

2242 ià(
c
->
æags
 & 
CLIENT_LUA
 && 
£rv”
.
lua_ÿÎ”
) {

2243 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
)

2244 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_REPL
;

2245 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
)

2246 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
CLIENT_FORCE_AOF
;

2251 ià(
æags
 & 
CMD_CALL_SLOWLOG
 && 
c
->
cmd
->
´oc
 !ğ
execCommªd
) {

2252 *
Ï‹ncy_ev’t
 = (
c
->
cmd
->
æags
 & 
CMD_FAST
) ?

2254 
	`Ï‹ncyAddSam¶eIfN“ded
(
Ï‹ncy_ev’t
,
du¿tiÚ
/1000);

2255 
	`¦owlogPushEÁryIfN“ded
(
c
,c->
¬gv
,c->
¬gc
,
du¿tiÚ
);

2257 ià(
æags
 & 
CMD_CALL_STATS
) {

2258 
c
->
Ï¡cmd
->
miüo£cÚds
 +ğ
du¿tiÚ
;

2259 
c
->
Ï¡cmd
->
ÿÎs
++;

2263 ià(
æags
 & 
CMD_CALL_PROPAGATE
 &&

2264 (
c
->
æags
 & 
CLIENT_PREVENT_PROP
) != CLIENT_PREVENT_PROP)

2266 
´İag©e_æags
 = 
PROPAGATE_NONE
;

2270 ià(
dœty
è
´İag©e_æags
 |ğ(
PROPAGATE_AOF
|
PROPAGATE_REPL
);

2274 ià(
c
->
æags
 & 
CLIENT_FORCE_REPL
è
´İag©e_æags
 |ğ
PROPAGATE_REPL
;

2275 ià(
c
->
æags
 & 
CLIENT_FORCE_AOF
è
´İag©e_æags
 |ğ
PROPAGATE_AOF
;

2280 ià(
c
->
æags
 & 
CLIENT_PREVENT_REPL_PROP
 ||

2281 !(
æags
 & 
CMD_CALL_PROPAGATE_REPL
))

2282 
´İag©e_æags
 &ğ~
PROPAGATE_REPL
;

2283 ià(
c
->
æags
 & 
CLIENT_PREVENT_AOF_PROP
 ||

2284 !(
æags
 & 
CMD_CALL_PROPAGATE_AOF
))

2285 
´İag©e_æags
 &ğ~
PROPAGATE_AOF
;

2290 ià(
´İag©e_æags
 !ğ
PROPAGATE_NONE
 && !(
c
->
cmd
->
æags
 & 
CMD_MODULE
))

2291 
	`´İag©e
(
c
->
cmd
,c->
db
->
id
,c->
¬gv
,c->
¬gc
,
´İag©e_æags
);

2296 
c
->
æags
 &ğ~(
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

2297 
c
->
æags
 |ğ
ş›Á_Şd_æags
 &

2298 (
CLIENT_FORCE_AOF
|
CLIENT_FORCE_REPL
|
CLIENT_PREVENT_PROP
);

2303 ià(
£rv”
.
®so_´İag©e
.
numİs
) {

2304 
j
;

2305 
»disOp
 *
rİ
;

2307 ià(
æags
 & 
CMD_CALL_PROPAGATE
) {

2308 
j
 = 0; j < 
£rv”
.
®so_´İag©e
.
numİs
; j++) {

2309 
rİ
 = &
£rv”
.
®so_´İag©e
.
İs
[
j
];

2310 
rg‘
 = 
rİ
->target;

2312 ià(!(
æags
&
CMD_CALL_PROPAGATE_AOF
)è
rg‘
 &ğ~
PROPAGATE_AOF
;

2313 ià(!(
æags
&
CMD_CALL_PROPAGATE_REPL
)è
rg‘
 &ğ~
PROPAGATE_REPL
;

2314 ià(
rg‘
)

2315 
	`´İag©e
(
rİ
->
cmd
,rİ->
dbid
,rİ->
¬gv
,rİ->
¬gc
,
rg‘
);

2318 
	`»disOpA¼ayF»e
(&
£rv”
.
®so_´İag©e
);

2320 
£rv”
.
®so_´İag©e
 = 
´ev_®so_´İag©e
;

2321 
£rv”
.
¡©_numcommªds
++;

2322 
	}
}

2332 
	$´oûssCommªd
(
ş›Á
 *
c
) {

2337 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[0]->
±r
,"quit")) {

2338 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2339 
c
->
æags
 |ğ
CLIENT_CLOSE_AFTER_REPLY
;

2340  
C_ERR
;

2345 
c
->
cmd
 = c->
Ï¡cmd
 = 
	`lookupCommªd
(c->
¬gv
[0]->
±r
);

2346 ià(!
c
->
cmd
) {

2347 
	`æagT¿n§ùiÚ
(
c
);

2348 
	`addR•lyE¼ÜFÜm©
(
c
,"unknown command '%s'",

2349 (*)
c
->
¬gv
[0]->
±r
);

2350  
C_OK
;

2351 } ià((
c
->
cmd
->
¬™y
 > 0 && c->cmd->¬™y !ğc->
¬gc
) ||

2352 (
c
->
¬gc
 < -c->
cmd
->
¬™y
)) {

2353 
	`æagT¿n§ùiÚ
(
c
);

2354 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

2355 
c
->
cmd
->
Çme
);

2356  
C_OK
;

2360 ià(
£rv”
.
»quœ•ass
 && !
c
->
auth’tiÿ‹d
 && c->
cmd
->
´oc
 !ğ
authCommªd
)

2362 
	`æagT¿n§ùiÚ
(
c
);

2363 
	`addR•ly
(
c
,
sh¬ed
.
nßuth”r
);

2364  
C_OK
;

2371 ià(
£rv”
.
şu¡”_’abËd
 &&

2372 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

2373 !(
c
->
æags
 & 
CLIENT_LUA
 &&

2374 
£rv”
.
lua_ÿÎ”
->
æags
 & 
CLIENT_MASTER
) &&

2375 !(
c
->
cmd
->
g‘keys_´oc
 =ğ
NULL
 && c->cmd->
fœ¡key
 == 0 &&

2376 
c
->
cmd
->
´oc
 !ğ
execCommªd
))

2378 
hash¦Ù
;

2379 
”rÜ_code
;

2380 
şu¡”Node
 *
n
 = 
	`g‘NodeByQu”y
(
c
,c->
cmd
,c->
¬gv
,c->
¬gc
,

2381 &
hash¦Ù
,&
”rÜ_code
);

2382 ià(
n
 =ğ
NULL
 ||‚ !ğ
£rv”
.
şu¡”
->
my£lf
) {

2383 ià(
c
->
cmd
->
´oc
 =ğ
execCommªd
) {

2384 
	`disÿrdT¿n§ùiÚ
(
c
);

2386 
	`æagT¿n§ùiÚ
(
c
);

2388 
	`şu¡”RedœeùCl›Á
(
c
,
n
,
hash¦Ù
,
”rÜ_code
);

2389  
C_OK
;

2398 ià(
£rv”
.
maxmemÜy
) {

2399 
»tv®
 = 
	`ä“MemÜyIfN“ded
();

2402 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
NULL
è 
C_ERR
;

2406 ià((
c
->
cmd
->
æags
 & 
CMD_DENYOOM
è&& 
»tv®
 =ğ
C_ERR
) {

2407 
	`æagT¿n§ùiÚ
(
c
);

2408 
	`addR•ly
(
c
, 
sh¬ed
.
oom”r
);

2409  
C_OK
;

2415 ià(((
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 &&

2416 
£rv”
.
§v•¬am¦’
 > 0 &&

2417 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_ERR
) ||

2418 
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_ERR
) &&

2419 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

2420 (
c
->
cmd
->
æags
 & 
CMD_WRITE
 ||

2421 
c
->
cmd
->
´oc
 =ğ
pšgCommªd
))

2423 
	`æagT¿n§ùiÚ
(
c
);

2424 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_OK
)

2425 
	`addR•ly
(
c
, 
sh¬ed
.
bg§v“¼
);

2427 
	`addR•lySds
(
c
,

2428 
	`sdsÿrštf
(
	`sd£m±y
(),

2430 
	`¡»¼Ü
(
£rv”
.
aof_Ï¡_wr™e_”ºo
)));

2431  
C_OK
;

2436 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

2437 
£rv”
.
»¶_mš_¦aves_to_wr™e
 &&

2438 
£rv”
.
»¶_mš_¦aves_max_Ïg
 &&

2439 
c
->
cmd
->
æags
 & 
CMD_WRITE
 &&

2440 
£rv”
.
»¶_good_¦aves_couÁ
 < s”v”.
»¶_mš_¦aves_to_wr™e
)

2442 
	`æagT¿n§ùiÚ
(
c
);

2443 
	`addR•ly
(
c
, 
sh¬ed
.
nÜ•liÿ£¼
);

2444  
C_OK
;

2449 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¦ave_ro
 &&

2450 !(
c
->
æags
 & 
CLIENT_MASTER
) &&

2451 
c
->
cmd
->
æags
 & 
CMD_WRITE
)

2453 
	`addR•ly
(
c
, 
sh¬ed
.
ro¦av“¼
);

2454  
C_OK
;

2458 ià(
c
->
æags
 & 
CLIENT_PUBSUB
 &&

2459 
c
->
cmd
->
´oc
 !ğ
pšgCommªd
 &&

2460 
c
->
cmd
->
´oc
 !ğ
subsüibeCommªd
 &&

2461 
c
->
cmd
->
´oc
 !ğ
unsubsüibeCommªd
 &&

2462 
c
->
cmd
->
´oc
 !ğ
psubsüibeCommªd
 &&

2463 
c
->
cmd
->
´oc
 !ğ
punsubsüibeCommªd
) {

2464 
	`addR•lyE¼Ü
(
c
,"only (P)SUBSCRIBE / (P)UNSUBSCRIBE / PING / QUIT‡llowed inhis context");

2465  
C_OK
;

2470 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
 &&

2471 
£rv”
.
»¶_£rve_¡®e_d©a
 == 0 &&

2472 !(
c
->
cmd
->
æags
 & 
CMD_STALE
))

2474 
	`æagT¿n§ùiÚ
(
c
);

2475 
	`addR•ly
(
c
, 
sh¬ed
.
ma¡”dowÃ¼
);

2476  
C_OK
;

2481 ià(
£rv”
.
lßdšg
 && !(
c
->
cmd
->
æags
 & 
CMD_LOADING
)) {

2482 
	`addR•ly
(
c
, 
sh¬ed
.
lßdšg”r
);

2483  
C_OK
;

2487 ià(
£rv”
.
lua_timedout
 &&

2488 
c
->
cmd
->
´oc
 !ğ
authCommªd
 &&

2489 
c
->
cmd
->
´oc
 !ğ
»¶cÚfCommªd
 &&

2490 !(
c
->
cmd
->
´oc
 =ğ
shutdownCommªd
 &&

2491 
c
->
¬gc
 == 2 &&

2492 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'n') &&

2493 !(
c
->
cmd
->
´oc
 =ğ
sütCommªd
 &&

2494 
c
->
¬gc
 == 2 &&

2495 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'k'))

2497 
	`æagT¿n§ùiÚ
(
c
);

2498 
	`addR•ly
(
c
, 
sh¬ed
.
¦owsü‹¼
);

2499  
C_OK
;

2503 ià(
c
->
æags
 & 
CLIENT_MULTI
 &&

2504 
c
->
cmd
->
´oc
 !ğ
execCommªd
 && c->cmd->´oø!ğ
disÿrdCommªd
 &&

2505 
c
->
cmd
->
´oc
 !ğ
muÉiCommªd
 && c->cmd->´oø!ğ
w©chCommªd
)

2507 
	`queueMuÉiCommªd
(
c
);

2508 
	`addR•ly
(
c
,
sh¬ed
.
queued
);

2510 
	`ÿÎ
(
c
,
CMD_CALL_FULL
);

2511 
c
->
woff
 = 
£rv”
.
ma¡”_»¶_off£t
;

2512 ià(
	`li¡L’gth
(
£rv”
.
»ady_keys
))

2513 
	`hªdËCl›ÁsBlockedOnLi¡s
();

2515  
C_OK
;

2516 
	}
}

2522 
	$şo£Li¡’šgSock‘s
(
uÆšk_unix_sock‘
) {

2523 
j
;

2525 
j
 = 0; j < 
£rv”
.
fd_couÁ
; j++è
	`şo£
(£rv”.
fd
[j]);

2526 ià(
£rv”
.
sofd
 !ğ-1è
	`şo£
(server.sofd);

2527 ià(
£rv”
.
şu¡”_’abËd
)

2528 
j
 = 0; j < 
£rv”
.
cfd_couÁ
; j++è
	`şo£
(£rv”.
cfd
[j]);

2529 ià(
uÆšk_unix_sock‘
 && 
£rv”
.
unixsock‘
) {

2530 
	`£rv”Log
(
LL_NOTICE
,"Removinghe unix socket file.");

2531 
	`uÆšk
(
£rv”
.
unixsock‘
);

2533 
	}
}

2535 
	$´•¬eFÜShutdown
(
æags
) {

2536 
§ve
 = 
æags
 & 
SHUTDOWN_SAVE
;

2537 
no§ve
 = 
æags
 & 
SHUTDOWN_NOSAVE
;

2539 
	`£rv”Log
(
LL_WARNING
,"User„equested shutdown...");

2542 
	`ldbKlFÜkedSessiÚs
();

2547 ià(
£rv”
.
rdb_chd_pid
 != -1) {

2548 
	`£rv”Log
(
LL_WARNING
,"There is‡ child saving‡n .rdb. Killing it!");

2549 
	`kl
(
£rv”
.
rdb_chd_pid
,
SIGUSR1
);

2550 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

2553 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

2556 ià(
£rv”
.
aof_chd_pid
 != -1) {

2559 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_WAIT_REWRITE
) {

2560 
	`£rv”Log
(
LL_WARNING
, "Writing initial AOF, can'tƒxit.");

2561  
C_ERR
;

2563 
	`£rv”Log
(
LL_WARNING
,

2565 
	`kl
(
£rv”
.
aof_chd_pid
,
SIGUSR1
);

2568 
	`£rv”Log
(
LL_NOTICE
,"Calling fsync() onhe AOF file.");

2569 
	`æushAµ’dOÆyFe
(1);

2570 
	`aof_fsync
(
£rv”
.
aof_fd
);

2574 ià((
£rv”
.
§v•¬am¦’
 > 0 && !
no§ve
è|| 
§ve
) {

2575 
	`£rv”Log
(
LL_NOTICE
,"Savinghe final RDB snapshot beforeƒxiting.");

2577 
rdbSaveInfo
 
rsi
, *
rsŒ
;

2578 
rsŒ
 = 
	`rdbPİuÏ‹SaveInfo
(&
rsi
);

2579 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
,
rsŒ
è!ğ
C_OK
) {

2585 
	`£rv”Log
(
LL_WARNING
,"Errorryingo savehe DB, can'tƒxit.");

2586  
C_ERR
;

2591 ià(
£rv”
.
d«mÚize
 || s”v”.
pidfe
) {

2592 
	`£rv”Log
(
LL_NOTICE
,"Removinghe…id file.");

2593 
	`uÆšk
(
£rv”
.
pidfe
);

2598 
	`æushSÏvesOuutBufãrs
();

2601 
	`şo£Li¡’šgSock‘s
(1);

2602 
	`£rv”Log
(
LL_WARNING
,"%s is‚ow„eadyoƒxit, bye bye...",

2603 
£rv”
.
£Áš–_mode
 ? "Sentinel" : "Redis");

2604  
C_OK
;

2605 
	}
}

2618 
	$time_šd•’d’t_¡rcmp
(*
a
, *
b
) {

2619 
buç
[
CONFIG_AUTHPASS_MAX_LEN
], 
bufb
[CONFIG_AUTHPASS_MAX_LEN];

2624 
®’
 = 
	`¡¾’
(
a
);

2625 
bËn
 = 
	`¡¾’
(
b
);

2626 
j
;

2627 
diff
 = 0;

2632 ià(
®’
 > (
buç
è|| 
bËn
 > (
bufb
))  1;

2634 
	`mem£t
(
buç
,0,(bufa));

2635 
	`mem£t
(
bufb
,0,(bufb));

2638 
	`memıy
(
buç
,
a
,
®’
);

2639 
	`memıy
(
bufb
,
b
,
bËn
);

2643 
j
 = 0; j < (
buç
); j++) {

2644 
diff
 |ğ(
buç
[
j
] ^ 
bufb
[j]);

2647 
diff
 |ğ
®’
 ^ 
bËn
;

2648  
diff
;

2649 
	}
}

2651 
	$authCommªd
(
ş›Á
 *
c
) {

2652 ià(!
£rv”
.
»quœ•ass
) {

2653 
	`addR•lyE¼Ü
(
c
,"Client sent AUTH, but‚o…assword is set");

2654 } ià(!
	`time_šd•’d’t_¡rcmp
(
c
->
¬gv
[1]->
±r
, 
£rv”
.
»quœ•ass
)) {

2655 
c
->
auth’tiÿ‹d
 = 1;

2656 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2658 
c
->
auth’tiÿ‹d
 = 0;

2659 
	`addR•lyE¼Ü
(
c
,"invalid…assword");

2661 
	}
}

2665 
	$pšgCommªd
(
ş›Á
 *
c
) {

2667 ià(
c
->
¬gc
 > 2) {

2668 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

2669 
c
->
cmd
->
Çme
);

2673 ià(
c
->
æags
 & 
CLIENT_PUBSUB
) {

2674 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[2]);

2675 
	`addR•lyBulkCBufãr
(
c
,"pong",4);

2676 ià(
c
->
¬gc
 == 1)

2677 
	`addR•lyBulkCBufãr
(
c
,"",0);

2679 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2681 ià(
c
->
¬gc
 == 1)

2682 
	`addR•ly
(
c
,
sh¬ed
.
pÚg
);

2684 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2686 
	}
}

2688 
	$echoCommªd
(
ş›Á
 *
c
) {

2689 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2690 
	}
}

2692 
	$timeCommªd
(
ş›Á
 *
c
) {

2693 
timev®
 
tv
;

2697 
	`g‘timeofday
(&
tv
,
NULL
);

2698 
	`addR•lyMuÉiBulkL’
(
c
,2);

2699 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_£c
);

2700 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_u£c
);

2701 
	}
}

2704 
	$addR•lyCommªdFÏg
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
, 
f
, *
»¶y
) {

2705 ià(
cmd
->
æags
 & 
f
) {

2706 
	`addR•lyStus
(
c
, 
»¶y
);

2710 
	}
}

2713 
	$addR•lyCommªd
(
ş›Á
 *
c
, 
»disCommªd
 *
cmd
) {

2714 ià(!
cmd
) {

2715 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

2718 
	`addR•lyMuÉiBulkL’
(
c
, 6);

2719 
	`addR•lyBulkCSŒšg
(
c
, 
cmd
->
Çme
);

2720 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
¬™y
);

2722 
æagcouÁ
 = 0;

2723 *
æagËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2724 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_WRITE
, "write");

2725 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_READONLY
, "readonly");

2726 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_DENYOOM
, "denyoom");

2727 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ADMIN
, "admin");

2728 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_PUBSUB
, "pubsub");

2729 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_NOSCRIPT
, "noscript");

2730 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_RANDOM
, "random");

2731 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SORT_FOR_SCRIPT
,"sort_for_script");

2732 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_LOADING
, "loading");

2733 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_STALE
, "stale");

2734 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_SKIP_MONITOR
, "skip_monitor");

2735 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_ASKING
, "asking");

2736 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
CMD_FAST
, "fast");

2737 ià((
cmd
->
g‘keys_´oc
 && !(cmd->
æags
 & 
CMD_MODULE
)) ||

2738 
cmd
->
æags
 & 
CMD_MODULE_GETKEYS
)

2740 
	`addR•lyStus
(
c
, "movablekeys");

2741 
æagcouÁ
 += 1;

2743 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
æagËn
, 
æagcouÁ
);

2745 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
fœ¡key
);

2746 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
Ï¡key
);

2747 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
key¡•
);

2749 
	}
}

2752 
	$commªdCommªd
(
ş›Á
 *
c
) {

2753 
diùI‹¿tÜ
 *
di
;

2754 
diùEÁry
 *
de
;

2756 ià(
c
->
¬gc
 == 1) {

2757 
	`addR•lyMuÉiBulkL’
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

2758 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
commªds
);

2759 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2760 
	`addR•lyCommªd
(
c
, 
	`diùG‘V®
(
de
));

2762 
	`diùR–—£I‹¿tÜ
(
di
);

2763 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "info")) {

2764 
i
;

2765 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

2766 
i
 = 2; i < 
c
->
¬gc
; i++) {

2767 
	`addR•lyCommªd
(
c
, 
	`diùF‘chV®ue
(
£rv”
.
commªds
, c->
¬gv
[
i
]->
±r
));

2769 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "couÁ"è&& c->
¬gc
 == 2) {

2770 
	`addR•lyLÚgLÚg
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

2771 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘keys"è&& c->
¬gc
 >= 3) {

2772 
»disCommªd
 *
cmd
 = 
	`lookupCommªd
(
c
->
¬gv
[2]->
±r
);

2773 *
keys
, 
numkeys
, 
j
;

2775 ià(!
cmd
) {

2776 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid command specified");

2778 } ià((
cmd
->
¬™y
 > 0 && cmd->¬™y !ğ
c
->
¬gc
-2) ||

2779 ((
c
->
¬gc
-2è< -
cmd
->
¬™y
))

2781 
	`addR•lyE¼Ü
(
c
,"Invalid‚umber of‡rguments specified for command");

2785 
keys
 = 
	`g‘KeysFromCommªd
(
cmd
,
c
->
¬gv
+2,c->
¬gc
-2,&
numkeys
);

2786 
	`addR•lyMuÉiBulkL’
(
c
,
numkeys
);

2787 
j
 = 0; j < 
numkeys
; j++è
	`addR•lyBulk
(
c
,c->
¬gv
[
keys
[j]+2]);

2788 
	`g‘KeysF»eResuÉ
(
keys
);

2790 
	`addR•lyE¼Ü
(
c
, "Unknown subcommand or wrong‚umber of‡rguments.");

2793 
	}
}

2797 
	$by‹sToHumª
(*
s
, 
n
) {

2798 
d
;

2800 ià(
n
 < 1024) {

2802 
	`¥rštf
(
s
,"%ÎuB",
n
);

2804 } ià(
n
 < (1024*1024)) {

2805 
d
 = ()
n
/(1024);

2806 
	`¥rštf
(
s
,"%.2fK",
d
);

2807 } ià(
n
 < (1024LL*1024*1024)) {

2808 
d
 = ()
n
/(1024*1024);

2809 
	`¥rštf
(
s
,"%.2fM",
d
);

2810 } ià(
n
 < (1024LL*1024*1024*1024)) {

2811 
d
 = ()
n
/(1024LL*1024*1024);

2812 
	`¥rštf
(
s
,"%.2fG",
d
);

2813 } ià(
n
 < (1024LL*1024*1024*1024*1024)) {

2814 
d
 = ()
n
/(1024LL*1024*1024*1024);

2815 
	`¥rštf
(
s
,"%.2fT",
d
);

2816 } ià(
n
 < (1024LL*1024*1024*1024*1024*1024)) {

2817 
d
 = ()
n
/(1024LL*1024*1024*1024*1024);

2818 
	`¥rštf
(
s
,"%.2fP",
d
);

2821 
	`¥rštf
(
s
,"%ÎuB",
n
);

2823 
	}
}

2828 
sds
 
	$g’RedisInfoSŒšg
(*
£ùiÚ
) {

2829 
sds
 
šfo
 = 
	`sd£m±y
();

2830 
time_t
 
u±ime
 = 
£rv”
.
unixtime
-£rv”.
¡©_¡¬‰ime
;

2831 
j
;

2832 
ru§ge
 
£lf_ru
, 
c_ru
;

2833 
lŞ
, 
bib
;

2834 
®l£ùiÚs
 = 0, 
def£ùiÚs
 = 0;

2835 
£ùiÚs
 = 0;

2837 ià(
£ùiÚ
 =ğ
NULL
) section = "default";

2838 
®l£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"all") == 0;

2839 
def£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"default") == 0;

2841 
	`g‘ru§ge
(
RUSAGE_SELF
, &
£lf_ru
);

2842 
	`g‘ru§ge
(
RUSAGE_CHILDREN
, &
c_ru
);

2843 
	`g‘Cl›ÁsMaxBufãrs
(&
lŞ
,&
bib
);

2846 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"server")) {

2847 
ÿÎ_uÇme
 = 1;

2848 
ut¢ame
 
Çme
;

2849 *
mode
;

2851 ià(
£rv”
.
şu¡”_’abËd
è
mode
 = "cluster";

2852 ià(
£rv”
.
£Áš–_mode
è
mode
 = "sentinel";

2853 
mode
 = "standalone";

2855 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2857 ià(
ÿÎ_uÇme
) {

2859 
	`uÇme
(&
Çme
);

2860 
ÿÎ_uÇme
 = 0;

2863 
Ìuşock
;

2864 
	`©omicG‘
(
£rv”
.
Ìuşock
,lruclock);

2865 
šfo
 = 
	`sdsÿrštf
(info,

2886 
REDIS_VERSION
,

2887 
	`»disG™SHA1
(),

2888 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

2889 (è
	`»disBudId
(),

2890 
mode
,

2891 
Çme
.
sy¢ame
,‚ame.
»Ëa£
,‚ame.
machše
,

2892 
£rv”
.
¬ch_b™s
,

2893 
	`«G‘ApiName
(),

2894 
REDIS_ATOMIC_API
,

2895 #ifdeà
__GNUC__


2896 
__GNUC__
,
__GNUC_MINOR__
,
__GNUC_PATCHLEVEL__
,

2900 (è
	`g‘pid
(),

2901 
£rv”
.
runid
,

2902 
£rv”
.
pÜt
,

2903 (
štmax_t
)
u±ime
,

2904 (
štmax_t
)(
u±ime
/(3600*24)),

2905 
£rv”
.
hz
,

2906 (è
Ìuşock
,

2907 
£rv”
.
execubË
 ? server.executable : "",

2908 
£rv”
.
cÚfigfe
 ? server.configfile : "");

2912 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"clients")) {

2913 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2914 
šfo
 = 
	`sdsÿrštf
(info,

2920 
	`li¡L’gth
(
£rv”
.
ş›Ás
)-li¡L’gth(£rv”.
¦aves
),

2921 
lŞ
, 
bib
,

2922 
£rv”
.
bpİ_blocked_ş›Ás
);

2926 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"memory")) {

2927 
hmem
[64];

2928 
³ak_hmem
[64];

2929 
tÙ®_sy¡em_hmem
[64];

2930 
u£d_memÜy_lua_hmem
[64];

2931 
u£d_memÜy_rss_hmem
[64];

2932 
maxmemÜy_hmem
[64];

2933 
size_t
 
zm®loc_u£d
 = 
	`zm®loc_u£d_memÜy
();

2934 
size_t
 
tÙ®_sy¡em_mem
 = 
£rv”
.
sy¡em_memÜy_size
;

2935 cÚ¡ *
eviù_pŞicy
 = 
	`eviùPŞicyToSŒšg
();

2936 
memÜy_lua
 = ()
	`lua_gc
(
£rv”
.
lua
,
LUA_GCCOUNT
,0)*1024;

2937 
»disMemOv”h—d
 *
mh
 = 
	`g‘MemÜyOv”h—dD©a
();

2943 ià(
zm®loc_u£d
 > 
£rv”
.
¡©_³ak_memÜy
)

2944 
£rv”
.
¡©_³ak_memÜy
 = 
zm®loc_u£d
;

2946 
	`by‹sToHumª
(
hmem
,
zm®loc_u£d
);

2947 
	`by‹sToHumª
(
³ak_hmem
,
£rv”
.
¡©_³ak_memÜy
);

2948 
	`by‹sToHumª
(
tÙ®_sy¡em_hmem
,
tÙ®_sy¡em_mem
);

2949 
	`by‹sToHumª
(
u£d_memÜy_lua_hmem
,
memÜy_lua
);

2950 
	`by‹sToHumª
(
u£d_memÜy_rss_hmem
,
£rv”
.
»sid’t_£t_size
);

2951 
	`by‹sToHumª
(
maxmemÜy_hmem
,
£rv”
.
maxmemÜy
);

2953 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2954 
šfo
 = 
	`sdsÿrštf
(info,

2978 
zm®loc_u£d
,

2979 
hmem
,

2980 
£rv”
.
»sid’t_£t_size
,

2981 
u£d_memÜy_rss_hmem
,

2982 
£rv”
.
¡©_³ak_memÜy
,

2983 
³ak_hmem
,

2984 
mh
->
³ak_³rc
,

2985 
mh
->
ov”h—d_tÙ®
,

2986 
mh
->
¡¬tup_®loÿ‹d
,

2987 
mh
->
d©a£t
,

2988 
mh
->
d©a£t_³rc
,

2989 ()
tÙ®_sy¡em_mem
,

2990 
tÙ®_sy¡em_hmem
,

2991 
memÜy_lua
,

2992 
u£d_memÜy_lua_hmem
,

2993 
£rv”
.
maxmemÜy
,

2994 
maxmemÜy_hmem
,

2995 
eviù_pŞicy
,

2996 
mh
->
äagm’tiÚ
,

2997 
ZMALLOC_LIB
,

2998 
£rv”
.
aùive_deäag_ruÂšg
,

2999 
	`Ïzyä“G‘P’dšgObjeùsCouÁ
()

3001 
	`ä“MemÜyOv”h—dD©a
(
mh
);

3005 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"persistence")) {

3006 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3007 
šfo
 = 
	`sdsÿrštf
(info,

3025 
£rv”
.
lßdšg
,

3026 
£rv”
.
dœty
,

3027 
£rv”
.
rdb_chd_pid
 != -1,

3028 (
štmax_t
)
£rv”
.
Ï¡§ve
,

3029 (
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
C_OK
) ? "ok" : "err",

3030 (
štmax_t
)
£rv”
.
rdb_§ve_time_Ï¡
,

3031 (
štmax_t
)((
£rv”
.
rdb_chd_pid
 == -1) ?

3032 -1 : 
	`time
(
NULL
)-
£rv”
.
rdb_§ve_time_¡¬t
),

3033 
£rv”
.
¡©_rdb_cow_by‹s
,

3034 
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
,

3035 
£rv”
.
aof_chd_pid
 != -1,

3036 
£rv”
.
aof_»wr™e_scheduËd
,

3037 (
štmax_t
)
£rv”
.
aof_»wr™e_time_Ï¡
,

3038 (
štmax_t
)((
£rv”
.
aof_chd_pid
 == -1) ?

3039 -1 : 
	`time
(
NULL
)-
£rv”
.
aof_»wr™e_time_¡¬t
),

3040 (
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 =ğ
C_OK
) ? "ok" : "err",

3041 (
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
C_OK
) ? "ok" : "err",

3042 
£rv”
.
¡©_aof_cow_by‹s
);

3044 ià(
£rv”
.
aof_¡©e
 !ğ
AOF_OFF
) {

3045 
šfo
 = 
	`sdsÿrštf
(info,

3053 (è
£rv”
.
aof_cu¼’t_size
,

3054 (è
£rv”
.
aof_»wr™e_ba£_size
,

3055 
£rv”
.
aof_»wr™e_scheduËd
,

3056 
	`sd¦’
(
£rv”
.
aof_buf
),

3057 
	`aofRewr™eBufãrSize
(),

3058 
	`bioP’dšgJobsOfTy³
(
BIO_AOF_FSYNC
),

3059 
£rv”
.
aof_d–ayed_fsync
);

3062 ià(
£rv”
.
lßdšg
) {

3063 
³rc
;

3064 
time_t
 
‘a
, 
–­£d
;

3065 
off_t
 
»maššg_by‹s
 = 
£rv”
.
lßdšg_tÙ®_by‹s
-

3066 
£rv”
.
lßdšg_lßded_by‹s
;

3068 
³rc
 = (()
£rv”
.
lßdšg_lßded_by‹s
 /

3069 (
£rv”
.
lßdšg_tÙ®_by‹s
+1)) * 100;

3071 
–­£d
 = 
	`time
(
NULL
)-
£rv”
.
lßdšg_¡¬t_time
;

3072 ià(
–­£d
 == 0) {

3073 
‘a
 = 1;

3076 
‘a
 = (
–­£d
*
»maššg_by‹s
)/(
£rv”
.
lßdšg_lßded_by‹s
+1);

3079 
šfo
 = 
	`sdsÿrštf
(info,

3085 (
štmax_t
è
£rv”
.
lßdšg_¡¬t_time
,

3086 (è
£rv”
.
lßdšg_tÙ®_by‹s
,

3087 (è
£rv”
.
lßdšg_lßded_by‹s
,

3088 
³rc
,

3089 (
štmax_t
)
‘a


3095 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"stats")) {

3096 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3097 
šfo
 = 
	`sdsÿrštf
(info,

3125 
£rv”
.
¡©_numcÚÃùiÚs
,

3126 
£rv”
.
¡©_numcommªds
,

3127 
	`g‘In¡ªÃousM‘ric
(
STATS_METRIC_COMMAND
),

3128 
£rv”
.
¡©_Ãt_šput_by‹s
,

3129 
£rv”
.
¡©_Ãt_ouut_by‹s
,

3130 ()
	`g‘In¡ªÃousM‘ric
(
STATS_METRIC_NET_INPUT
)/1024,

3131 ()
	`g‘In¡ªÃousM‘ric
(
STATS_METRIC_NET_OUTPUT
)/1024,

3132 
£rv”
.
¡©_»jeùed_cÚn
,

3133 
£rv”
.
¡©_sync_fuÎ
,

3134 
£rv”
.
¡©_sync_·¹Ÿl_ok
,

3135 
£rv”
.
¡©_sync_·¹Ÿl_”r
,

3136 
£rv”
.
¡©_expœedkeys
,

3137 
£rv”
.
¡©_expœed_¡®e_³rc
*100,

3138 
£rv”
.
¡©_expœed_time_ÿp_»ached_couÁ
,

3139 
£rv”
.
¡©_eviùedkeys
,

3140 
£rv”
.
¡©_key¥aû_h™s
,

3141 
£rv”
.
¡©_key¥aû_mis£s
,

3142 
	`diùSize
(
£rv”
.
pubsub_chªÃls
),

3143 
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
),

3144 
£rv”
.
¡©_fÜk_time
,

3145 
	`diùSize
(
£rv”
.
mig¿‹_ÿched_sock‘s
),

3146 
	`g‘SÏveKeyW™hExpœeCouÁ
(),

3147 
£rv”
.
¡©_aùive_deäag_h™s
,

3148 
£rv”
.
¡©_aùive_deäag_mis£s
,

3149 
£rv”
.
¡©_aùive_deäag_key_h™s
,

3150 
£rv”
.
¡©_aùive_deäag_key_mis£s
);

3154 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"replication")) {

3155 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3156 
šfo
 = 
	`sdsÿrštf
(info,

3159 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 ? "master" : "slave");

3160 ià(
£rv”
.
ma¡”ho¡
) {

3161 
¦ave_»¶_off£t
 = 1;

3163 ià(
£rv”
.
ma¡”
)

3164 
¦ave_»¶_off£t
 = 
£rv”
.
ma¡”
->
»¶off
;

3165 ià(
£rv”
.
ÿched_ma¡”
)

3166 
¦ave_»¶_off£t
 = 
£rv”
.
ÿched_ma¡”
->
»¶off
;

3168 
šfo
 = 
	`sdsÿrštf
(info,

3175 ,
£rv”
.
ma¡”ho¡
,

3176 
£rv”
.
ma¡”pÜt
,

3177 (
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_CONNECTED
) ?

3179 
£rv”
.
ma¡”
 ?

3180 (()(
£rv”
.
unixtime
-£rv”.
ma¡”
->
Ï¡š‹¿ùiÚ
)) : -1,

3181 
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
,

3182 
¦ave_»¶_off£t


3185 ià(
£rv”
.
»¶_¡©e
 =ğ
REPL_STATE_TRANSFER
) {

3186 
šfo
 = 
	`sdsÿrštf
(info,

3190 (
£rv”
.
»¶_Œªsãr_size
 - s”v”.
»¶_Œªsãr_»ad
),

3191 ()(
£rv”
.
unixtime
-£rv”.
»¶_Œªsãr_Ï¡io
)

3195 ià(
£rv”
.
»¶_¡©e
 !ğ
REPL_STATE_CONNECTED
) {

3196 
šfo
 = 
	`sdsÿrštf
(info,

3198 (
štmax_t
)
£rv”
.
unixtime
-£rv”.
»¶_down_sšû
);

3200 
šfo
 = 
	`sdsÿrštf
(info,

3203 
£rv”
.
¦ave_´iÜ™y
,

3204 
£rv”
.
»¶_¦ave_ro
);

3207 
šfo
 = 
	`sdsÿrštf
(info,

3209 
	`li¡L’gth
(
£rv”
.
¦aves
));

3213 ià(
£rv”
.
»¶_mš_¦aves_to_wr™e
 &&

3214 
£rv”
.
»¶_mš_¦aves_max_Ïg
) {

3215 
šfo
 = 
	`sdsÿrštf
(info,

3217 
£rv”
.
»¶_good_¦aves_couÁ
);

3220 ià(
	`li¡L’gth
(
£rv”
.
¦aves
)) {

3221 
¦aveid
 = 0;

3222 
li¡Node
 *
Ê
;

3223 
li¡I‹r
 
li
;

3225 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

3226 (
Ê
 = 
	`li¡Next
(&
li
))) {

3227 
ş›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

3228 *
¡©e
 = 
NULL
;

3229 

[
NET_IP_STR_LEN
], *
¦ave
 = 
¦ave
->
¦ave_
;

3230 
pÜt
;

3231 
Ïg
 = 0;

3233 ià(
¦ave
[0] == '\0') {

3234 ià(
	`ª‘P“rToSŒšg
(
¦ave
->
fd
,

,(),&
pÜt
) == -1)

3236 
¦ave
 = 

;

3238 
¦ave
->
»¶¡©e
) {

3239 
SLAVE_STATE_WAIT_BGSAVE_START
:

3240 
SLAVE_STATE_WAIT_BGSAVE_END
:

3241 
¡©e
 = "wait_bgsave";

3243 
SLAVE_STATE_SEND_BULK
:

3244 
¡©e
 = "send_bulk";

3246 
SLAVE_STATE_ONLINE
:

3247 
¡©e
 = "online";

3250 ià(
¡©e
 =ğ
NULL
) ;

3251 ià(
¦ave
->
»¶¡©e
 =ğ
SLAVE_STATE_ONLINE
)

3252 
Ïg
 = 
	`time
(
NULL
è- 
¦ave
->
»¶_ack_time
;

3254 
šfo
 = 
	`sdsÿrštf
(info,

3257 
¦aveid
,
¦ave
,
¦ave
->
¦ave_li¡’šg_pÜt
,
¡©e
,

3258 
¦ave
->
»¶_ack_off
, 
Ïg
);

3259 
¦aveid
++;

3262 
šfo
 = 
	`sdsÿrštf
(info,

3271 
£rv”
.
»¶id
,

3272 
£rv”
.
»¶id2
,

3273 
£rv”
.
ma¡”_»¶_off£t
,

3274 
£rv”
.
£cÚd_»¶id_off£t
,

3275 
£rv”
.
»¶_backlog
 !ğ
NULL
,

3276 
£rv”
.
»¶_backlog_size
,

3277 
£rv”
.
»¶_backlog_off
,

3278 
£rv”
.
»¶_backlog_hi¡Ën
);

3282 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"cpu")) {

3283 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3284 
šfo
 = 
	`sdsÿrštf
(info,

3290 ()
£lf_ru
.
ru_¡ime
.
tv_£c
+()£lf_ru.ru_¡ime.
tv_u£c
/1000000,

3291 ()
£lf_ru
.
ru_utime
.
tv_£c
+()£lf_ru.ru_utime.
tv_u£c
/1000000,

3292 ()
c_ru
.
ru_¡ime
.
tv_£c
+()c_ru.ru_¡ime.
tv_u£c
/1000000,

3293 ()
c_ru
.
ru_utime
.
tv_£c
+()c_ru.ru_utime.
tv_u£c
/1000000);

3297 ià(
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"commandstats")) {

3298 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3299 
šfo
 = 
	`sdsÿrštf
(info, "# Commandstats\r\n");

3301 
»disCommªd
 *
c
;

3302 
diùEÁry
 *
de
;

3303 
diùI‹¿tÜ
 *
di
;

3304 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
commªds
);

3305 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3306 
c
 = (
»disCommªd
 *è
	`diùG‘V®
(
de
);

3307 ià(!
c
->
ÿÎs
) ;

3308 
šfo
 = 
	`sdsÿrštf
(info,

3310 
c
->
Çme
, c->
ÿÎs
, c->
miüo£cÚds
,

3311 (
c
->
ÿÎs
 =ğ0è? 0 : (()c->
miüo£cÚds
/c->calls));

3313 
	`diùR–—£I‹¿tÜ
(
di
);

3317 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"cluster")) {

3318 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3319 
šfo
 = 
	`sdsÿrštf
(info,

3322 
£rv”
.
şu¡”_’abËd
);

3326 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"keyspace")) {

3327 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3328 
šfo
 = 
	`sdsÿrštf
(info, "# Keyspace\r\n");

3329 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

3330 
keys
, 
vkeys
;

3332 
keys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

3333 
vkeys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
expœes
);

3334 ià(
keys
 || 
vkeys
) {

3335 
šfo
 = 
	`sdsÿrštf
(info,

3337 
j
, 
keys
, 
vkeys
, 
£rv”
.
db
[j].
avg_‰l
);

3341  
šfo
;

3342 
	}
}

3344 
	$šfoCommªd
(
ş›Á
 *
c
) {

3345 *
£ùiÚ
 = 
c
->
¬gc
 =ğ2 ? c->
¬gv
[1]->
±r
 : "default";

3347 ià(
c
->
¬gc
 > 2) {

3348 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

3351 
	`addR•lyBulkSds
(
c
, 
	`g’RedisInfoSŒšg
(
£ùiÚ
));

3352 
	}
}

3354 
	$mÚ™ÜCommªd
(
ş›Á
 *
c
) {

3356 ià(
c
->
æags
 & 
CLIENT_SLAVE
) ;

3358 
c
->
æags
 |ğ(
CLIENT_SLAVE
|
CLIENT_MONITOR
);

3359 
	`li¡AddNodeTa
(
£rv”
.
mÚ™Üs
,
c
);

3360 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3361 
	}
}

3365 #ifdeà
__lšux__


3366 
	$lšuxOv”comm™MemÜyV®ue
() {

3367 
FILE
 *
å
 = 
	`fİ’
("/proc/sys/vm/overcommit_memory","r");

3368 
buf
[64];

3370 ià(!
å
)  -1;

3371 ià(
	`fg‘s
(
buf
,64,
å
è=ğ
NULL
) {

3372 
	`fşo£
(
å
);

3375 
	`fşo£
(
å
);

3377  
	`©oi
(
buf
);

3378 
	}
}

3380 
	$lšuxMemÜyW¬nšgs
() {

3381 ià(
	`lšuxOv”comm™MemÜyV®ue
() == 0) {

3382 
	`£rv”Log
(
LL_WARNING
,"WARNING overcommit_memory is seto 0! Background save may fail under†ow memory condition. To fixhis issue‡dd 'vm.overcommit_memory = 1'o /etc/sysctl.conf‡ndhen„eboot or„unhe command 'sysctl vm.overcommit_memory=1' forhisoakeƒffect.");

3384 ià(
	`THPIsEÇbËd
()) {

3385 
	`£rv”Log
(
LL_WARNING
,"WARNING you have Transparent Huge Pages (THP) supportƒnabled in your kernel. This will create†atency‡nd memory usage issues with Redis. To fixhis issue„unhe command 'echo‚ever > /sys/kernel/mm/transparent_hugepage/enabled'‡s„oot,‡nd‡dd ito your /etc/rc.local in ordero„etainhe setting‡fter‡„eboot. Redis must be„estarted‡fter THP is disabled.");

3387 
	}
}

3390 
	$ü—‹PidFe
() {

3393 ià(!
£rv”
.
pidfe
è£rv”.pidfğ
	`z¡rdup
(
CONFIG_DEFAULT_PID_FILE
);

3396 
FILE
 *
å
 = 
	`fİ’
(
£rv”
.
pidfe
,"w");

3397 ià(
å
) {

3398 
	`årštf
(
å
,"%d\n",()
	`g‘pid
());

3399 
	`fşo£
(
å
);

3401 
	}
}

3403 
	$d«mÚize
() {

3404 
fd
;

3406 ià(
	`fÜk
(è!ğ0è
	`ex™
(0);

3407 
	`£tsid
();

3412 ià((
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
, 0)) != -1) {

3413 
	`dup2
(
fd
, 
STDIN_FILENO
);

3414 
	`dup2
(
fd
, 
STDOUT_FILENO
);

3415 
	`dup2
(
fd
, 
STDERR_FILENO
);

3416 ià(
fd
 > 
STDERR_FILENO
è
	`şo£
(fd);

3418 
	}
}

3420 
	$v”siÚ
() {

3421 
	`´štf
("Redis server v=%s sha=%s:%d malloc=%s bits=%d build=%llx\n",

3422 
REDIS_VERSION
,

3423 
	`»disG™SHA1
(),

3424 
	`©oi
(
	`»disG™Dœty
()) > 0,

3425 
ZMALLOC_LIB
,

3427 (è
	`»disBudId
());

3428 
	`ex™
(0);

3429 
	}
}

3431 
	$u§ge
() {

3432 
	`årštf
(
¡d”r
,"Usage: ./redis-server [/path/to/redis.conf] [options]\n");

3433 
	`årštf
(
¡d”r
," ./redis-server - (read config from stdin)\n");

3434 
	`årštf
(
¡d”r
," ./redis-server -v or --version\n");

3435 
	`årštf
(
¡d”r
," ./redis-server -h or --help\n");

3436 
	`årštf
(
¡d”r
," ./redis-server --test-memory <megabytes>\n\n");

3437 
	`årštf
(
¡d”r
,"Examples:\n");

3438 
	`årštf
(
¡d”r
," ./redis-server (runhe server with default conf)\n");

3439 
	`årštf
(
¡d”r
," ./redis-server /etc/redis/6379.conf\n");

3440 
	`årštf
(
¡d”r
," ./redis-server --port 7777\n");

3441 
	`årštf
(
¡d”r
," ./redis-server --port 7777 --slaveof 127.0.0.1 8888\n");

3442 
	`årštf
(
¡d”r
," ./redis-server /etc/myredis.conf --loglevel verbose\n\n");

3443 
	`årštf
(
¡d”r
,"Sentinel mode:\n");

3444 
	`årštf
(
¡d”r
," ./redis-server /etc/sentinel.conf --sentinel\n");

3445 
	`ex™
(1);

3446 
	}
}

3448 
	$»disAsciiA¹
() {

3449 
	~"asciogo.h
"

3450 *
buf
 = 
	`zm®loc
(1024*16);

3451 *
mode
;

3453 ià(
£rv”
.
şu¡”_’abËd
è
mode
 = "cluster";

3454 ià(
£rv”
.
£Áš–_mode
è
mode
 = "sentinel";

3455 
mode
 = "standalone";

3460 
show_logo
 = ((!
£rv”
.
sy¦og_’abËd
 &&

3461 
£rv”
.
logfe
[0] == '\0' &&

3462 
	`i§‰y
(
	`f’o
(
¡dout
))) ||

3463 
£rv”
.
®ways_show_logo
);

3465 ià(!
show_logo
) {

3466 
	`£rv”Log
(
LL_NOTICE
,

3468 
mode
, 
£rv”
.
pÜt


3471 
	`¢´štf
(
buf
,1024*16,
ascii_logo
,

3472 
REDIS_VERSION
,

3473 
	`»disG™SHA1
(),

3474 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

3476 
mode
, 
£rv”
.
pÜt
,

3477 (è
	`g‘pid
()

3479 
	`£rv”LogRaw
(
LL_NOTICE
|
LL_RAW
,
buf
);

3481 
	`zä“
(
buf
);

3482 
	}
}

3484 
	$sigShutdownHªdËr
(
sig
) {

3485 *
msg
;

3487 
sig
) {

3488 
SIGINT
:

3489 
msg
 = "Received SIGINT scheduling shutdown...";

3491 
SIGTERM
:

3492 
msg
 = "Received SIGTERM scheduling shutdown...";

3495 
msg
 = "Received shutdown signal, scheduling shutdown...";

3502 ià(
£rv”
.
shutdown_a§p
 && 
sig
 =ğ
SIGINT
) {

3503 
	`£rv”LogFromHªdËr
(
LL_WARNING
, "You insist...ƒxiting‚ow.");

3504 
	`rdbRemoveTempFe
(
	`g‘pid
());

3505 
	`ex™
(1);

3506 } ià(
£rv”
.
lßdšg
) {

3507 
	`ex™
(0);

3510 
	`£rv”LogFromHªdËr
(
LL_WARNING
, 
msg
);

3511 
£rv”
.
shutdown_a§p
 = 1;

3512 
	}
}

3514 
	$£tupSigÇlHªdËrs
() {

3515 
sigaùiÚ
 
aù
;

3519 
	`sigem±y£t
(&
aù
.
§_mask
);

3520 
aù
.
§_æags
 = 0;

3521 
aù
.
§_hªdËr
 = 
sigShutdownHªdËr
;

3522 
	`sigaùiÚ
(
SIGTERM
, &
aù
, 
NULL
);

3523 
	`sigaùiÚ
(
SIGINT
, &
aù
, 
NULL
);

3525 #ifdeà
HAVE_BACKTRACE


3526 
	`sigem±y£t
(&
aù
.
§_mask
);

3527 
aù
.
§_æags
 = 
SA_NODEFER
 | 
SA_RESETHAND
 | 
SA_SIGINFO
;

3528 
aù
.
§_sigaùiÚ
 = 
sig£gvHªdËr
;

3529 
	`sigaùiÚ
(
SIGSEGV
, &
aù
, 
NULL
);

3530 
	`sigaùiÚ
(
SIGBUS
, &
aù
, 
NULL
);

3531 
	`sigaùiÚ
(
SIGFPE
, &
aù
, 
NULL
);

3532 
	`sigaùiÚ
(
SIGILL
, &
aù
, 
NULL
);

3535 
	}
}

3537 
mem‹¡
(
size_t
 
megaby‹s
, 
·s£s
);

3541 
	$checkFÜS’tš–Mode
(
¬gc
, **
¬gv
) {

3542 
j
;

3544 ià(
	`¡r¡r
(
¬gv
[0],"»dis-£Áš–"è!ğ
NULL
)  1;

3545 
j
 = 1; j < 
¬gc
; j++)

3546 ià(!
	`¡rcmp
(
¬gv
[
j
],"--sentinel"))  1;

3548 
	}
}

3551 
	$lßdD©aFromDisk
() {

3552 
¡¬t
 = 
	`u¡ime
();

3553 ià(
£rv”
.
aof_¡©e
 =ğ
AOF_ON
) {

3554 ià(
	`lßdAµ’dOÆyFe
(
£rv”
.
aof_f’ame
è=ğ
C_OK
)

3555 
	`£rv”Log
(
LL_NOTICE
,"DB†ßded from‡µ’d oÆy fe: %.3à£cÚds",()(
	`u¡ime
()-
¡¬t
)/1000000);

3557 
rdbSaveInfo
 
rsi
 = 
RDB_SAVE_INFO_INIT
;

3558 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
,&
rsi
è=ğ
C_OK
) {

3559 
	`£rv”Log
(
LL_NOTICE
,"DB†oaded from disk: %.3f seconds",

3560 ()(
	`u¡ime
()-
¡¬t
)/1000000);

3563 ià(
£rv”
.
ma¡”ho¡
 &&

3564 
rsi
.
»¶_id_is_£t
 &&

3565 
rsi
.
»¶_off£t
 != -1 &&

3569 
rsi
.
»¶_¡»am_db
 != -1)

3571 
	`memıy
(
£rv”
.
»¶id
,
rsi
.
»¶_id
,(server.replid));

3572 
£rv”
.
ma¡”_»¶_off£t
 = 
rsi
.
»¶_off£t
;

3576 
	`»¶iÿtiÚCacheMa¡”UsšgMy£lf
();

3577 
	`£ËùDb
(
£rv”
.
ÿched_ma¡”
,
rsi
.
»¶_¡»am_db
);

3579 } ià(
”ºo
 !ğ
ENOENT
) {

3580 
	`£rv”Log
(
LL_WARNING
,"F©®ƒ¼Ü†ßdšghDB: %s. Ex™šg.",
	`¡»¼Ü
(
”ºo
));

3581 
	`ex™
(1);

3584 
	}
}

3586 
	$»disOutOfMemÜyHªdËr
(
size_t
 
®loÿtiÚ_size
) {

3587 
	`£rv”Log
(
LL_WARNING
,"Out Of Memory‡llocating %zu bytes!",

3588 
®loÿtiÚ_size
);

3589 
	`£rv”Pªic
("Redis‡borting for OUT OF MEMORY");

3590 
	}
}

3592 
	$»disS‘ProcT™Ë
(*
t™Ë
) {

3593 #ifdeà
USE_SETPROCTITLE


3594 *
£rv”_mode
 = "";

3595 ià(
£rv”
.
şu¡”_’abËd
è
£rv”_mode
 = " [cluster]";

3596 ià(
£rv”
.
£Áš–_mode
è
£rv”_mode
 = " [sentinel]";

3598 
	`£roù™Ë
("%s %s:%d%s",

3599 
t™Ë
,

3600 
£rv”
.
bšdaddr_couÁ
 ? s”v”.
bšdaddr
[0] : "*",

3601 
£rv”
.
pÜt
,

3602 
£rv”_mode
);

3604 
	`UNUSED
(
t™Ë
);

3606 
	}
}

3612 
	$»disSu³rvi£dUp¡¬t
() {

3613 cÚ¡ *
up¡¬t_job
 = 
	`g‘’v
("UPSTART_JOB");

3615 ià(!
up¡¬t_job
) {

3616 
	`£rv”Log
(
LL_WARNING
,

3621 
	`£rv”Log
(
LL_NOTICE
, "supervised by upstart, will stopo signal„eadiness");

3622 
	`¿i£
(
SIGSTOP
);

3623 
	`un£‹nv
("UPSTART_JOB");

3625 
	}
}

3627 
	$»disSu³rvi£dSy¡emd
() {

3628 cÚ¡ *
nÙify_sock‘
 = 
	`g‘’v
("NOTIFY_SOCKET");

3629 
fd
 = 1;

3630 
sockaddr_un
 
su
;

3631 
iovec
 
iov
;

3632 
msghdr
 
hdr
;

3633 
£ndto_æags
 = 0;

3635 ià(!
nÙify_sock‘
) {

3636 
	`£rv”Log
(
LL_WARNING
,

3641 ià((
	`¡rchr
("@/", 
nÙify_sock‘
[0])è=ğ
NULL
 || 
	`¡¾’
(notify_socket) < 2) {

3645 
	`£rv”Log
(
LL_NOTICE
, "supervised by systemd, will signal„eadiness");

3646 ià((
fd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_DGRAM
, 0)) == -1) {

3647 
	`£rv”Log
(
LL_WARNING
,

3648 "Cª'ˆcÚÃùØsy¡emd sock‘ %s", 
nÙify_sock‘
);

3652 
	`mem£t
(&
su
, 0, (su));

3653 
su
.
sun_çmy
 = 
AF_UNIX
;

3654 
	`¡ºıy
 (
su
.
sun_·th
, 
nÙify_sock‘
, (su.sun_path) -1);

3655 
su
.
sun_·th
[(su.sun_path) - 1] = '\0';

3657 ià(
nÙify_sock‘
[0] == '@')

3658 
su
.
sun_·th
[0] = '\0';

3660 
	`mem£t
(&
iov
, 0, (iov));

3661 
iov
.
iov_ba£
 = "READY=1";

3662 
iov
.
iov_Ën
 = 
	`¡¾’
("READY=1");

3664 
	`mem£t
(&
hdr
, 0, (hdr));

3665 
hdr
.
msg_Çme
 = &
su
;

3666 
hdr
.
msg_Çm–’
 = 
	`off£tof
(
sockaddr_un
, 
sun_·th
) +

3667 
	`¡¾’
(
nÙify_sock‘
);

3668 
hdr
.
msg_iov
 = &
iov
;

3669 
hdr
.
msg_iovËn
 = 1;

3671 
	`un£‹nv
("NOTIFY_SOCKET");

3672 #ifdeà
HAVE_MSG_NOSIGNAL


3673 
£ndto_æags
 |ğ
MSG_NOSIGNAL
;

3675 ià(
	`£ndmsg
(
fd
, &
hdr
, 
£ndto_æags
) < 0) {

3676 
	`£rv”Log
(
LL_WARNING
, "Can't send‚otificationo systemd");

3677 
	`şo£
(
fd
);

3680 
	`şo£
(
fd
);

3682 
	}
}

3684 
	$»disIsSu³rvi£d
(
mode
) {

3685 ià(
mode
 =ğ
SUPERVISED_AUTODETECT
) {

3686 cÚ¡ *
up¡¬t_job
 = 
	`g‘’v
("UPSTART_JOB");

3687 cÚ¡ *
nÙify_sock‘
 = 
	`g‘’v
("NOTIFY_SOCKET");

3689 ià(
up¡¬t_job
) {

3690 
	`»disSu³rvi£dUp¡¬t
();

3691 } ià(
nÙify_sock‘
) {

3692 
	`»disSu³rvi£dSy¡emd
();

3694 } ià(
mode
 =ğ
SUPERVISED_UPSTART
) {

3695  
	`»disSu³rvi£dUp¡¬t
();

3696 } ià(
mode
 =ğ
SUPERVISED_SYSTEMD
) {

3697  
	`»disSu³rvi£dSy¡emd
();

3701 
	}
}

3704 
	$maš
(
¬gc
, **
¬gv
) {

3705 
timev®
 
tv
;

3706 
j
;

3708 #ifdeà
REDIS_TEST


3709 ià(
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
¬gv
[1], "test")) {

3710 ià(!
	`¡rÿ£cmp
(
¬gv
[2], "ziplist")) {

3711  
	`zli¡Te¡
(
¬gc
, 
¬gv
);

3712 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "quicklist")) {

3713 
	`quickli¡Te¡
(
¬gc
, 
¬gv
);

3714 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "intset")) {

3715  
	`št£tTe¡
(
¬gc
, 
¬gv
);

3716 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "zipmap")) {

3717  
	`zm­Te¡
(
¬gc
, 
¬gv
);

3718 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "sha1test")) {

3719  
	`sha1Te¡
(
¬gc
, 
¬gv
);

3720 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "util")) {

3721  
	`utTe¡
(
¬gc
, 
¬gv
);

3722 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "sds")) {

3723  
	`sdsTe¡
(
¬gc
, 
¬gv
);

3724 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "endianconv")) {

3725  
	`’dŸncÚvTe¡
(
¬gc
, 
¬gv
);

3726 } ià(!
	`¡rÿ£cmp
(
¬gv
[2], "crc64")) {

3727  
	`üc64Te¡
(
¬gc
, 
¬gv
);

3735 #ifdeà
INIT_SETPROCTITLE_REPLACEMENT


3736 
	`¥t_š™
(
¬gc
, 
¬gv
);

3738 
	`£oÿË
(
LC_COLLATE
,"");

3739 
	`zm®loc_£t_oom_hªdËr
(
»disOutOfMemÜyHªdËr
);

3740 
	`¤ªd
(
	`time
(
NULL
)^
	`g‘pid
());

3741 
	`g‘timeofday
(&
tv
,
NULL
);

3742 
hash£ed
[16];

3743 
	`g‘RªdomHexCh¬s
(
hash£ed
,(hashseed));

3744 
	`diùS‘HashFunùiÚS“d
((
ušt8_t
*)
hash£ed
);

3745 
£rv”
.
£Áš–_mode
 = 
	`checkFÜS’tš–Mode
(
¬gc
,
¬gv
);

3746 
	`š™S”v”CÚfig
();

3747 
	`moduËIn™ModuËsSy¡em
();

3751 
£rv”
.
execubË
 = 
	`g‘AbsŞu‹P©h
(
¬gv
[0]);

3752 
£rv”
.
exec_¬gv
 = 
	`zm®loc
((*)*(
¬gc
+1));

3753 
£rv”
.
exec_¬gv
[
¬gc
] = 
NULL
;

3754 
j
 = 0; j < 
¬gc
; j++è
£rv”
.
exec_¬gv
[j] = 
	`z¡rdup
(
¬gv
[j]);

3759 ià(
£rv”
.
£Áš–_mode
) {

3760 
	`š™S’tš–CÚfig
();

3761 
	`š™S’tš–
();

3767 ià(
	`¡r¡r
(
¬gv
[0],"»dis-check-rdb"è!ğ
NULL
)

3768 
	`»dis_check_rdb_maš
(
¬gc
,
¬gv
,
NULL
);

3769 ià(
	`¡r¡r
(
¬gv
[0],"»dis-check-aof"è!ğ
NULL
)

3770 
	`»dis_check_aof_maš
(
¬gc
,
¬gv
);

3772 ià(
¬gc
 >= 2) {

3773 
j
 = 1;

3774 
sds
 
İtiÚs
 = 
	`sd£m±y
();

3775 *
cÚfigfe
 = 
NULL
;

3778 ià(
	`¡rcmp
(
¬gv
[1], "-v") == 0 ||

3779 
	`¡rcmp
(
¬gv
[1], "--v”siÚ"è=ğ0è
	`v”siÚ
();

3780 ià(
	`¡rcmp
(
¬gv
[1], "--help") == 0 ||

3781 
	`¡rcmp
(
¬gv
[1], "-h"è=ğ0è
	`u§ge
();

3782 ià(
	`¡rcmp
(
¬gv
[1], "--test-memory") == 0) {

3783 ià(
¬gc
 == 3) {

3784 
	`mem‹¡
(
	`©oi
(
¬gv
[2]),50);

3785 
	`ex™
(0);

3787 
	`årštf
(
¡d”r
,"Please specifyhe‡mount of memoryoest in megabytes.\n");

3788 
	`årštf
(
¡d”r
,"Example: ./redis-server --test-memory 4096\n\n");

3789 
	`ex™
(1);

3794 ià(
¬gv
[
j
][0] != '-' ||‡rgv[j][1] != '-') {

3795 
cÚfigfe
 = 
¬gv
[
j
];

3796 
£rv”
.
cÚfigfe
 = 
	`g‘AbsŞu‹P©h
(configfile);

3799 
	`zä“
(
£rv”
.
exec_¬gv
[
j
]);

3800 
£rv”
.
exec_¬gv
[
j
] = 
	`z¡rdup
(£rv”.
cÚfigfe
);

3801 
j
++;

3808 
j
 !ğ
¬gc
) {

3809 ià(
¬gv
[
j
][0] == '-' &&‡rgv[j][1] == '-') {

3811 ià(!
	`¡rcmp
(
¬gv
[
j
], "--check-rdb")) {

3813 
j
++;

3816 ià(
	`sd¦’
(
İtiÚs
)èİtiÚ ğ
	`sdsÿt
(options,"\n");

3817 
İtiÚs
 = 
	`sdsÿt
(İtiÚs,
¬gv
[
j
]+2);

3818 
İtiÚs
 = 
	`sdsÿt
(options," ");

3821 
İtiÚs
 = 
	`sdsÿŒ•r
(İtiÚs,
¬gv
[
j
],
	`¡¾’
(argv[j]));

3822 
İtiÚs
 = 
	`sdsÿt
(options," ");

3824 
j
++;

3826 ià(
£rv”
.
£Áš–_mode
 && 
cÚfigfe
 && *configfile == '-') {

3827 
	`£rv”Log
(
LL_WARNING
,

3829 
	`£rv”Log
(
LL_WARNING
,

3831 
	`ex™
(1);

3833 
	`»£tS”v”SaveP¬ams
();

3834 
	`lßdS”v”CÚfig
(
cÚfigfe
,
İtiÚs
);

3835 
	`sdsä“
(
İtiÚs
);

3838 
	`£rv”Log
(
LL_WARNING
, "oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo");

3839 
	`£rv”Log
(
LL_WARNING
,

3841 
REDIS_VERSION
,

3843 
	`»disG™SHA1
(),

3844 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

3845 ()
	`g‘pid
());

3847 ià(
¬gc
 == 1) {

3848 
	`£rv”Log
(
LL_WARNING
, "W¬nšg:‚ØcÚfig f¥ecif›d, usšghdeçuÉ cÚfig. IÀÜd”Ø¥ecify‡ cÚfig fu£ % /·th/to/%s.cÚf", 
¬gv
[0], 
£rv”
.
£Áš–_mode
 ? "sentinel" : "redis");

3850 
	`£rv”Log
(
LL_WARNING
, "Configuration†oaded");

3853 
£rv”
.
su³rvi£d
 = 
	`»disIsSu³rvi£d
(£rv”.
su³rvi£d_mode
);

3854 
background
 = 
£rv”
.
d«mÚize
 && !£rv”.
su³rvi£d
;

3855 ià(
background
è
	`d«mÚize
();

3857 
	`š™S”v”
();

3858 ià(
background
 || 
£rv”
.
pidfe
è
	`ü—‹PidFe
();

3859 
	`»disS‘ProcT™Ë
(
¬gv
[0]);

3860 
	`»disAsciiA¹
();

3861 
	`checkTıBacklogS‘tšgs
();

3863 ià(!
£rv”
.
£Áš–_mode
) {

3865 
	`£rv”Log
(
LL_WARNING
,"Server initialized");

3866 #ifdeà
__lšux__


3867 
	`lšuxMemÜyW¬nšgs
();

3869 
	`moduËLßdFromQueue
();

3870 
	`lßdD©aFromDisk
();

3871 ià(
£rv”
.
şu¡”_’abËd
) {

3872 ià(
	`v”ifyClu¡”CÚfigW™hD©a
(è=ğ
C_ERR
) {

3873 
	`£rv”Log
(
LL_WARNING
,

3876 
	`ex™
(1);

3879 ià(
£rv”
.
fd_couÁ
 > 0)

3880 
	`£rv”Log
(
LL_NOTICE
,"Readyo‡ccept connections");

3881 ià(
£rv”
.
sofd
 > 0)

3882 
	`£rv”Log
(
LL_NOTICE
,"Th£rv” i now„—dyØacû± cÚÃùiÚ © %s", 
£rv”
.
unixsock‘
);

3884 
	`£Áš–IsRuÂšg
();

3888 ià(
£rv”
.
maxmemÜy
 > 0 && server.maxmemory < 1024*1024) {

3889 
	`£rv”Log
(
LL_WARNING
,"WARNING: You s³cif›d‡ maxmemÜy v®uth© i Ës thª 1MB (cu¼’ˆv®ui %Îu by‹s). A» you su»hi i wh© you„—Îy wªt?", 
£rv”
.
maxmemÜy
);

3892 
	`«S‘BefÜeSË•Proc
(
£rv”
.
–
,
befÜeSË•
);

3893 
	`«S‘Aá”SË•Proc
(
£rv”
.
–
,
aá”SË•
);

3894 
	`«Maš
(
£rv”
.
–
);

3895 
	`«D–‘eEv’tLoİ
(
£rv”
.
–
);

3897 
	}
}

	@src/server.h

30 #iâdeà
__REDIS_H


31 
	#__REDIS_H


	)

33 
	~"fmaüos.h
"

34 
	~"cÚfig.h
"

35 
	~"sŞ¬isfixes.h
"

36 
	~"rio.h
"

38 
	~<¡dio.h
>

39 
	~<¡dlib.h
>

40 
	~<¡ršg.h
>

41 
	~<time.h
>

42 
	~<lim™s.h
>

43 
	~<uni¡d.h
>

44 
	~<”ºo.h
>

45 
	~<š‰y³s.h
>

46 
	~<±h»ad.h
>

47 
	~<sy¦og.h
>

48 
	~<Ãtš‘/š.h
>

49 
	~<lua.h
>

50 
	~<sigÇl.h
>

52 
	tm¡ime_t
;

54 
	~"«.h
"

55 
	~"sds.h
"

56 
	~"diù.h
"

57 
	~"adli¡.h
"

58 
	~"zm®loc.h
"

59 
	~"ª‘.h
"

60 
	~"zli¡.h
"

61 
	~"št£t.h
"

62 
	~"v”siÚ.h
"

63 
	~"ut.h
"

64 
	~"Ï‹ncy.h
"

65 
	~"¥¬klše.h
"

66 
	~"quickli¡.h
"

68 
	~"¿x.h
"

71 
	~"zm­.h
"

72 
	~"sha1.h
"

73 
	~"’dŸncÚv.h
"

74 
	~"üc64.h
"

77 
	#C_OK
 0

	)

78 
	#C_ERR
 -1

	)

81 
	#CONFIG_DEFAULT_HZ
 10

	)

82 
	#CONFIG_MIN_HZ
 1

	)

83 
	#CONFIG_MAX_HZ
 500

	)

84 
	#CONFIG_DEFAULT_SERVER_PORT
 6379

	)

85 
	#CONFIG_DEFAULT_TCP_BACKLOG
 511

	)

86 
	#CONFIG_DEFAULT_CLIENT_TIMEOUT
 0

	)

87 
	#CONFIG_DEFAULT_DBNUM
 16

	)

88 
	#CONFIG_MAX_LINE
 1024

	)

89 
	#CRON_DBS_PER_CALL
 16

	)

90 
	#NET_MAX_WRITES_PER_EVENT
 (1024*64)

	)

91 
	#PROTO_SHARED_SELECT_CMDS
 10

	)

92 
	#OBJ_SHARED_INTEGERS
 10000

	)

93 
	#OBJ_SHARED_BULKHDR_LEN
 32

	)

94 
	#LOG_MAX_LEN
 1024

	)

95 
	#AOF_REWRITE_PERC
 100

	)

96 
	#AOF_REWRITE_MIN_SIZE
 (64*1024*1024)

	)

97 
	#AOF_REWRITE_ITEMS_PER_CMD
 64

	)

98 
	#AOF_READ_DIFF_INTERVAL_BYTES
 (1024*10)

	)

99 
	#CONFIG_DEFAULT_SLOWLOG_LOG_SLOWER_THAN
 10000

	)

100 
	#CONFIG_DEFAULT_SLOWLOG_MAX_LEN
 128

	)

101 
	#CONFIG_DEFAULT_MAX_CLIENTS
 10000

	)

102 
	#CONFIG_AUTHPASS_MAX_LEN
 512

	)

103 
	#CONFIG_DEFAULT_SLAVE_PRIORITY
 100

	)

104 
	#CONFIG_DEFAULT_REPL_TIMEOUT
 60

	)

105 
	#CONFIG_DEFAULT_REPL_PING_SLAVE_PERIOD
 10

	)

106 
	#CONFIG_RUN_ID_SIZE
 40

	)

107 
	#RDB_EOF_MARK_SIZE
 40

	)

108 
	#CONFIG_DEFAULT_REPL_BACKLOG_SIZE
 (1024*1024è

	)

109 
	#CONFIG_DEFAULT_REPL_BACKLOG_TIME_LIMIT
 (60*60è

	)

110 
	#CONFIG_REPL_BACKLOG_MIN_SIZE
 (1024*16è

	)

111 
	#CONFIG_BGSAVE_RETRY_DELAY
 5

	)

112 
	#CONFIG_DEFAULT_PID_FILE
 "/v¬/run/»dis.pid"

	)

113 
	#CONFIG_DEFAULT_SYSLOG_IDENT
 "»dis"

	)

114 
	#CONFIG_DEFAULT_CLUSTER_CONFIG_FILE
 "nodes.cÚf"

	)

115 
	#CONFIG_DEFAULT_CLUSTER_ANNOUNCE_IP
 
NULL


	)

116 
	#CONFIG_DEFAULT_CLUSTER_ANNOUNCE_PORT
 0

	)

117 
	#CONFIG_DEFAULT_CLUSTER_ANNOUNCE_BUS_PORT
 0

	)

118 
	#CONFIG_DEFAULT_DAEMONIZE
 0

	)

119 
	#CONFIG_DEFAULT_UNIX_SOCKET_PERM
 0

	)

120 
	#CONFIG_DEFAULT_TCP_KEEPALIVE
 300

	)

121 
	#CONFIG_DEFAULT_PROTECTED_MODE
 1

	)

122 
	#CONFIG_DEFAULT_LOGFILE
 ""

	)

123 
	#CONFIG_DEFAULT_SYSLOG_ENABLED
 0

	)

124 
	#CONFIG_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
 1

	)

125 
	#CONFIG_DEFAULT_RDB_COMPRESSION
 1

	)

126 
	#CONFIG_DEFAULT_RDB_CHECKSUM
 1

	)

127 
	#CONFIG_DEFAULT_RDB_FILENAME
 "dump.rdb"

	)

128 
	#CONFIG_DEFAULT_REPL_DISKLESS_SYNC
 0

	)

129 
	#CONFIG_DEFAULT_REPL_DISKLESS_SYNC_DELAY
 5

	)

130 
	#CONFIG_DEFAULT_SLAVE_SERVE_STALE_DATA
 1

	)

131 
	#CONFIG_DEFAULT_SLAVE_READ_ONLY
 1

	)

132 
	#CONFIG_DEFAULT_SLAVE_ANNOUNCE_IP
 
NULL


	)

133 
	#CONFIG_DEFAULT_SLAVE_ANNOUNCE_PORT
 0

	)

134 
	#CONFIG_DEFAULT_REPL_DISABLE_TCP_NODELAY
 0

	)

135 
	#CONFIG_DEFAULT_MAXMEMORY
 0

	)

136 
	#CONFIG_DEFAULT_MAXMEMORY_SAMPLES
 5

	)

137 
	#CONFIG_DEFAULT_LFU_LOG_FACTOR
 10

	)

138 
	#CONFIG_DEFAULT_LFU_DECAY_TIME
 1

	)

139 
	#CONFIG_DEFAULT_AOF_FILENAME
 "­³ndÚly.aof"

	)

140 
	#CONFIG_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
 0

	)

141 
	#CONFIG_DEFAULT_AOF_LOAD_TRUNCATED
 1

	)

142 
	#CONFIG_DEFAULT_AOF_USE_RDB_PREAMBLE
 0

	)

143 
	#CONFIG_DEFAULT_ACTIVE_REHASHING
 1

	)

144 
	#CONFIG_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
 1

	)

145 
	#CONFIG_DEFAULT_MIN_SLAVES_TO_WRITE
 0

	)

146 
	#CONFIG_DEFAULT_MIN_SLAVES_MAX_LAG
 10

	)

147 
	#NET_IP_STR_LEN
 46

	)

148 
	#NET_PEER_ID_LEN
 (
NET_IP_STR_LEN
+32è

	)

149 
	#CONFIG_BINDADDR_MAX
 16

	)

150 
	#CONFIG_MIN_RESERVED_FDS
 32

	)

151 
	#CONFIG_DEFAULT_LATENCY_MONITOR_THRESHOLD
 0

	)

152 
	#CONFIG_DEFAULT_SLAVE_LAZY_FLUSH
 0

	)

153 
	#CONFIG_DEFAULT_LAZYFREE_LAZY_EVICTION
 0

	)

154 
	#CONFIG_DEFAULT_LAZYFREE_LAZY_EXPIRE
 0

	)

155 
	#CONFIG_DEFAULT_LAZYFREE_LAZY_SERVER_DEL
 0

	)

156 
	#CONFIG_DEFAULT_ALWAYS_SHOW_LOGO
 0

	)

157 
	#CONFIG_DEFAULT_ACTIVE_DEFRAG
 0

	)

158 
	#CONFIG_DEFAULT_DEFRAG_THRESHOLD_LOWER
 10

	)

159 
	#CONFIG_DEFAULT_DEFRAG_THRESHOLD_UPPER
 100

	)

160 
	#CONFIG_DEFAULT_DEFRAG_IGNORE_BYTES
 (100<<20è

	)

161 
	#CONFIG_DEFAULT_DEFRAG_CYCLE_MIN
 25

	)

162 
	#CONFIG_DEFAULT_DEFRAG_CYCLE_MAX
 75

	)

163 
	#CONFIG_DEFAULT_PROTO_MAX_BULK_LEN
 (512Î*1024*1024è

	)

165 
	#ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
 20

	)

166 
	#ACTIVE_EXPIRE_CYCLE_FAST_DURATION
 1000

	)

167 
	#ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
 25

	)

168 
	#ACTIVE_EXPIRE_CYCLE_SLOW
 0

	)

169 
	#ACTIVE_EXPIRE_CYCLE_FAST
 1

	)

172 
	#STATS_METRIC_SAMPLES
 16

	)

173 
	#STATS_METRIC_COMMAND
 0

	)

174 
	#STATS_METRIC_NET_INPUT
 1

	)

175 
	#STATS_METRIC_NET_OUTPUT
 2

	)

176 
	#STATS_METRIC_COUNT
 3

	)

179 
	#PROTO_MAX_QUERYBUF_LEN
 (1024*1024*1024è

	)

180 
	#PROTO_IOBUF_LEN
 (1024*16è

	)

181 
	#PROTO_REPLY_CHUNK_BYTES
 (16*1024è

	)

182 
	#PROTO_INLINE_MAX_SIZE
 (1024*64è

	)

183 
	#PROTO_MBULK_BIG_ARG
 (1024*32)

	)

184 
	#LONG_STR_SIZE
 21

	)

185 
	#AOF_AUTOSYNC_BYTES
 (1024*1024*32è

	)

191 
	#CONFIG_FDSET_INCR
 (
CONFIG_MIN_RESERVED_FDS
+96)

	)

194 
	#HASHTABLE_MIN_FILL
 10

	)

198 
	#CMD_WRITE
 (1<<0è

	)

199 
	#CMD_READONLY
 (1<<1è

	)

200 
	#CMD_DENYOOM
 (1<<2è

	)

201 
	#CMD_MODULE
 (1<<3è

	)

202 
	#CMD_ADMIN
 (1<<4è

	)

203 
	#CMD_PUBSUB
 (1<<5è

	)

204 
	#CMD_NOSCRIPT
 (1<<6è

	)

205 
	#CMD_RANDOM
 (1<<7è

	)

206 
	#CMD_SORT_FOR_SCRIPT
 (1<<8è

	)

207 
	#CMD_LOADING
 (1<<9è

	)

208 
	#CMD_STALE
 (1<<10è

	)

209 
	#CMD_SKIP_MONITOR
 (1<<11è

	)

210 
	#CMD_ASKING
 (1<<12è

	)

211 
	#CMD_FAST
 (1<<13è

	)

212 
	#CMD_MODULE_GETKEYS
 (1<<14è

	)

213 
	#CMD_MODULE_NO_CLUSTER
 (1<<15è

	)

216 
	#AOF_OFF
 0

	)

217 
	#AOF_ON
 1

	)

218 
	#AOF_WAIT_REWRITE
 2

	)

221 
	#CLIENT_SLAVE
 (1<<0è

	)

222 
	#CLIENT_MASTER
 (1<<1è

	)

223 
	#CLIENT_MONITOR
 (1<<2è

	)

224 
	#CLIENT_MULTI
 (1<<3è

	)

225 
	#CLIENT_BLOCKED
 (1<<4è

	)

226 
	#CLIENT_DIRTY_CAS
 (1<<5è

	)

227 
	#CLIENT_CLOSE_AFTER_REPLY
 (1<<6è

	)

228 
	#CLIENT_UNBLOCKED
 (1<<7è

	)

230 
	#CLIENT_LUA
 (1<<8è

	)

231 
	#CLIENT_ASKING
 (1<<9è

	)

232 
	#CLIENT_CLOSE_ASAP
 (1<<10)

	)

233 
	#CLIENT_UNIX_SOCKET
 (1<<11è

	)

234 
	#CLIENT_DIRTY_EXEC
 (1<<12è

	)

235 
	#CLIENT_MASTER_FORCE_REPLY
 (1<<13è

	)

236 
	#CLIENT_FORCE_AOF
 (1<<14è

	)

237 
	#CLIENT_FORCE_REPL
 (1<<15è

	)

238 
	#CLIENT_PRE_PSYNC
 (1<<16è

	)

239 
	#CLIENT_READONLY
 (1<<17è

	)

240 
	#CLIENT_PUBSUB
 (1<<18è

	)

241 
	#CLIENT_PREVENT_AOF_PROP
 (1<<19è

	)

242 
	#CLIENT_PREVENT_REPL_PROP
 (1<<20è

	)

243 
	#CLIENT_PREVENT_PROP
 (
CLIENT_PREVENT_AOF_PROP
|
CLIENT_PREVENT_REPL_PROP
)

	)

244 
	#CLIENT_PENDING_WRITE
 (1<<21è

	)

246 
	#CLIENT_REPLY_OFF
 (1<<22è

	)

247 
	#CLIENT_REPLY_SKIP_NEXT
 (1<<23è

	)

248 
	#CLIENT_REPLY_SKIP
 (1<<24è

	)

249 
	#CLIENT_LUA_DEBUG
 (1<<25è

	)

250 
	#CLIENT_LUA_DEBUG_SYNC
 (1<<26è

	)

251 
	#CLIENT_MODULE
 (1<<27è

	)

255 
	#BLOCKED_NONE
 0

	)

256 
	#BLOCKED_LIST
 1

	)

257 
	#BLOCKED_WAIT
 2

	)

258 
	#BLOCKED_MODULE
 3

	)

261 
	#PROTO_REQ_INLINE
 1

	)

262 
	#PROTO_REQ_MULTIBULK
 2

	)

266 
	#CLIENT_TYPE_NORMAL
 0

	)

267 
	#CLIENT_TYPE_SLAVE
 1

	)

268 
	#CLIENT_TYPE_PUBSUB
 2

	)

269 
	#CLIENT_TYPE_MASTER
 3

	)

270 
	#CLIENT_TYPE_OBUF_COUNT
 3

	)

276 
	#REPL_STATE_NONE
 0

	)

277 
	#REPL_STATE_CONNECT
 1

	)

278 
	#REPL_STATE_CONNECTING
 2

	)

280 
	#REPL_STATE_RECEIVE_PONG
 3

	)

281 
	#REPL_STATE_SEND_AUTH
 4

	)

282 
	#REPL_STATE_RECEIVE_AUTH
 5

	)

283 
	#REPL_STATE_SEND_PORT
 6

	)

284 
	#REPL_STATE_RECEIVE_PORT
 7

	)

285 
	#REPL_STATE_SEND_IP
 8

	)

286 
	#REPL_STATE_RECEIVE_IP
 9

	)

287 
	#REPL_STATE_SEND_CAPA
 10

	)

288 
	#REPL_STATE_RECEIVE_CAPA
 11

	)

289 
	#REPL_STATE_SEND_PSYNC
 12

	)

290 
	#REPL_STATE_RECEIVE_PSYNC
 13

	)

292 
	#REPL_STATE_TRANSFER
 14

	)

293 
	#REPL_STATE_CONNECTED
 15

	)

299 
	#SLAVE_STATE_WAIT_BGSAVE_START
 6

	)

300 
	#SLAVE_STATE_WAIT_BGSAVE_END
 7

	)

301 
	#SLAVE_STATE_SEND_BULK
 8

	)

302 
	#SLAVE_STATE_ONLINE
 9

	)

305 
	#SLAVE_CAPA_NONE
 0

	)

306 
	#SLAVE_CAPA_EOF
 (1<<0è

	)

307 
	#SLAVE_CAPA_PSYNC2
 (1<<1è

	)

310 
	#CONFIG_REPL_SYNCIO_TIMEOUT
 5

	)

313 
	#LIST_HEAD
 0

	)

314 
	#LIST_TAIL
 1

	)

317 
	#SORT_OP_GET
 0

	)

320 
	#LL_DEBUG
 0

	)

321 
	#LL_VERBOSE
 1

	)

322 
	#LL_NOTICE
 2

	)

323 
	#LL_WARNING
 3

	)

324 
	#LL_RAW
 (1<<10è

	)

325 
	#CONFIG_DEFAULT_VERBOSITY
 
LL_NOTICE


	)

328 
	#SUPERVISED_NONE
 0

	)

329 
	#SUPERVISED_AUTODETECT
 1

	)

330 
	#SUPERVISED_SYSTEMD
 2

	)

331 
	#SUPERVISED_UPSTART
 3

	)

334 
	#UNUSED
(
V
è((èV)

	)

336 
	#ZSKIPLIST_MAXLEVEL
 32

	)

337 
	#ZSKIPLIST_P
 0.25

	)

340 
	#AOF_FSYNC_NO
 0

	)

341 
	#AOF_FSYNC_ALWAYS
 1

	)

342 
	#AOF_FSYNC_EVERYSEC
 2

	)

343 
	#CONFIG_DEFAULT_AOF_FSYNC
 
AOF_FSYNC_EVERYSEC


	)

346 
	#OBJ_HASH_MAX_ZIPLIST_ENTRIES
 512

	)

347 
	#OBJ_HASH_MAX_ZIPLIST_VALUE
 64

	)

348 
	#OBJ_SET_MAX_INTSET_ENTRIES
 512

	)

349 
	#OBJ_ZSET_MAX_ZIPLIST_ENTRIES
 128

	)

350 
	#OBJ_ZSET_MAX_ZIPLIST_VALUE
 64

	)

353 
	#OBJ_LIST_MAX_ZIPLIST_SIZE
 -2

	)

354 
	#OBJ_LIST_COMPRESS_DEPTH
 0

	)

357 
	#CONFIG_DEFAULT_HLL_SPARSE_MAX_BYTES
 3000

	)

360 
	#SET_OP_UNION
 0

	)

361 
	#SET_OP_DIFF
 1

	)

362 
	#SET_OP_INTER
 2

	)

367 
	#MAXMEMORY_FLAG_LRU
 (1<<0)

	)

368 
	#MAXMEMORY_FLAG_LFU
 (1<<1)

	)

369 
	#MAXMEMORY_FLAG_ALLKEYS
 (1<<2)

	)

370 
	#MAXMEMORY_FLAG_NO_SHARED_INTEGERS
 \

371 (
MAXMEMORY_FLAG_LRU
|
MAXMEMORY_FLAG_LFU
)

	)

373 
	#MAXMEMORY_VOLATILE_LRU
 ((0<<8)|
MAXMEMORY_FLAG_LRU
)

	)

374 
	#MAXMEMORY_VOLATILE_LFU
 ((1<<8)|
MAXMEMORY_FLAG_LFU
)

	)

375 
	#MAXMEMORY_VOLATILE_TTL
 (2<<8)

	)

376 
	#MAXMEMORY_VOLATILE_RANDOM
 (3<<8)

	)

377 
	#MAXMEMORY_ALLKEYS_LRU
 ((4<<8)|
MAXMEMORY_FLAG_LRU
|
MAXMEMORY_FLAG_ALLKEYS
)

	)

378 
	#MAXMEMORY_ALLKEYS_LFU
 ((5<<8)|
MAXMEMORY_FLAG_LFU
|
MAXMEMORY_FLAG_ALLKEYS
)

	)

379 
	#MAXMEMORY_ALLKEYS_RANDOM
 ((6<<8)|
MAXMEMORY_FLAG_ALLKEYS
)

	)

380 
	#MAXMEMORY_NO_EVICTION
 (7<<8)

	)

382 
	#CONFIG_DEFAULT_MAXMEMORY_POLICY
 
MAXMEMORY_NO_EVICTION


	)

385 
	#LUA_SCRIPT_TIME_LIMIT
 5000

	)

388 
	#UNIT_SECONDS
 0

	)

389 
	#UNIT_MILLISECONDS
 1

	)

392 
	#SHUTDOWN_NOFLAGS
 0

	)

393 
	#SHUTDOWN_SAVE
 1

	)

395 
	#SHUTDOWN_NOSAVE
 2

	)

398 
	#CMD_CALL_NONE
 0

	)

399 
	#CMD_CALL_SLOWLOG
 (1<<0)

	)

400 
	#CMD_CALL_STATS
 (1<<1)

	)

401 
	#CMD_CALL_PROPAGATE_AOF
 (1<<2)

	)

402 
	#CMD_CALL_PROPAGATE_REPL
 (1<<3)

	)

403 
	#CMD_CALL_PROPAGATE
 (
CMD_CALL_PROPAGATE_AOF
|
CMD_CALL_PROPAGATE_REPL
)

	)

404 
	#CMD_CALL_FULL
 (
CMD_CALL_SLOWLOG
 | 
CMD_CALL_STATS
 | 
CMD_CALL_PROPAGATE
)

	)

407 
	#PROPAGATE_NONE
 0

	)

408 
	#PROPAGATE_AOF
 1

	)

409 
	#PROPAGATE_REPL
 2

	)

412 
	#RDB_CHILD_TYPE_NONE
 0

	)

413 
	#RDB_CHILD_TYPE_DISK
 1

	)

414 
	#RDB_CHILD_TYPE_SOCKET
 2

	)

418 
	#NOTIFY_KEYSPACE
 (1<<0è

	)

419 
	#NOTIFY_KEYEVENT
 (1<<1è

	)

420 
	#NOTIFY_GENERIC
 (1<<2è

	)

421 
	#NOTIFY_STRING
 (1<<3è

	)

422 
	#NOTIFY_LIST
 (1<<4è

	)

423 
	#NOTIFY_SET
 (1<<5è

	)

424 
	#NOTIFY_HASH
 (1<<6è

	)

425 
	#NOTIFY_ZSET
 (1<<7è

	)

426 
	#NOTIFY_EXPIRED
 (1<<8è

	)

427 
	#NOTIFY_EVICTED
 (1<<9è

	)

428 
	#NOTIFY_ALL
 (
NOTIFY_GENERIC
 | 
NOTIFY_STRING
 | 
NOTIFY_LIST
 | 
NOTIFY_SET
 | 
NOTIFY_HASH
 | 
NOTIFY_ZSET
 | 
NOTIFY_EXPIRED
 | 
NOTIFY_EVICTED
è

	)

431 
	#NET_FIRST_BIND_ADDR
 (
£rv”
.
bšdaddr_couÁ
 ? s”v”.
bšdaddr
[0] : 
NULL
)

	)

436 
	#run_w™h_³riod
(
_ms_
èià((_ms_ <ğ1000/
£rv”
.
hz
è|| !(£rv”.
üÚloİs
%((_ms_)/(1000/£rv”.hz))))

	)

439 
	#£rv”As£¹W™hInfo
(
_c
,
_o
,
_e
è((_e)?()0 : (
	`_£rv”As£¹W™hInfo
(_c,_o,#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

440 
	#£rv”As£¹
(
_e
è((_e)?()0 : (
	`_£rv”As£¹
(#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

441 
	#£rv”Pªic
(...è
	`_£rv”Pªic
(
__FILE__
,
__LINE__
,
__VA_ARGS__
),
	`_ex™
(1)

	)

450 
	#OBJ_STRING
 0

	)

451 
	#OBJ_LIST
 1

	)

452 
	#OBJ_SET
 2

	)

453 
	#OBJ_ZSET
 3

	)

454 
	#OBJ_HASH
 4

	)

467 
	#OBJ_MODULE
 5

	)

470 
	#REDISMODULE_TYPE_ENCVER_BITS
 10

	)

471 
	#REDISMODULE_TYPE_ENCVER_MASK
 ((1<<
REDISMODULE_TYPE_ENCVER_BITS
)-1)

	)

472 
	#REDISMODULE_TYPE_ENCVER
(
id
è(id & 
REDISMODULE_TYPE_ENCVER_MASK
)

	)

473 
	#REDISMODULE_TYPE_SIGN
(
id
è((id & ~((
ušt64_t
)
REDISMODULE_TYPE_ENCVER_MASK
)è>>
REDISMODULE_TYPE_ENCVER_BITS
)

	)

475 
	gRedisModuË
;

476 
	gRedisModuËIO
;

477 
	gRedisModuËDige¡
;

478 
	gRedisModuËCtx
;

479 
	g»disObjeù
;

485 *(*
	tmoduËTy³LßdFunc
)(
	tRedisModuËIO
 *
	tio
, 
	t’cv”
);

486 (*
	tmoduËTy³SaveFunc
)(
	tRedisModuËIO
 *
	tio
, *
	tv®ue
);

487 (*
	tmoduËTy³Rewr™eFunc
)(
	tRedisModuËIO
 *
	tio
, 
	t»disObjeù
 *
	tkey
, *
	tv®ue
);

488 (*
	tmoduËTy³Dige¡Func
)(
	tRedisModuËDige¡
 *
	tdige¡
, *
	tv®ue
);

489 
	$size_t
 (*
	tmoduËTy³MemU§geFunc
)(cÚ¡ *
	tv®ue
);

490 (*
	tmoduËTy³F»eFunc
)(*
	tv®ue
);

494 
	sRedisModuËTy³
 {

495 
ušt64_t
 
id
;

496 
RedisModuË
 *
moduË
;

497 
moduËTy³LßdFunc
 
rdb_lßd
;

498 
moduËTy³SaveFunc
 
rdb_§ve
;

499 
moduËTy³Rewr™eFunc
 
aof_»wr™e
;

500 
moduËTy³MemU§geFunc
 
mem_u§ge
;

501 
moduËTy³Dige¡Func
 
dige¡
;

502 
moduËTy³F»eFunc
 
ä“
;

503 
Çme
[10];

504 } 
	tmoduËTy³
;

521 
	smoduËV®ue
 {

522 
moduËTy³
 *
ty³
;

523 *
v®ue
;

524 } 
	tmoduËV®ue
;

529 
	sRedisModuËIO
 {

530 
size_t
 
by‹s
;

531 
rio
 *rio;

532 
moduËTy³
 *
ty³
;

533 
”rÜ
;

534 
v”
;

536 
RedisModuËCtx
 *
ùx
;

537 } 
	tRedisModuËIO
;

541 
	#moduËIn™IOCÚ‹xt
(
iov¬
,
mty³
,
riİŒ
) do { \

542 
iov¬
.
rio
 = 
riİŒ
; \

543 
iov¬
.
ty³
 = 
mty³
; \

544 
iov¬
.
by‹s
 = 0; \

545 
iov¬
.
”rÜ
 = 0; \

546 
iov¬
.
v”
 = 0; \

547 
iov¬
.
ùx
 = 
NULL
; \

548 
	}
} 0);

	)

555 
	sRedisModuËDige¡
 {

556 
	mo
[20];

557 
	mx
[20];

558 } 
	tRedisModuËDige¡
;

561 
	#moduËIn™Dige¡CÚ‹xt
(
mdv¬
) do { \

562 
	`mem£t
(
mdv¬
.
o
,0,(mdvar.o)); \

563 
	`mem£t
(
mdv¬
.
x
,0,(mdvar.x)); \

564 } 0);

	)

569 
	#OBJ_ENCODING_RAW
 0

	)

570 
	#OBJ_ENCODING_INT
 1

	)

571 
	#OBJ_ENCODING_HT
 2

	)

572 
	#OBJ_ENCODING_ZIPMAP
 3

	)

573 
	#OBJ_ENCODING_LINKEDLIST
 4

	)

574 
	#OBJ_ENCODING_ZIPLIST
 5

	)

575 
	#OBJ_ENCODING_INTSET
 6

	)

576 
	#OBJ_ENCODING_SKIPLIST
 7

	)

577 
	#OBJ_ENCODING_EMBSTR
 8

	)

578 
	#OBJ_ENCODING_QUICKLIST
 9

	)

580 
	#LRU_BITS
 24

	)

581 
	#LRU_CLOCK_MAX
 ((1<<
LRU_BITS
)-1è

	)

582 
	#LRU_CLOCK_RESOLUTION
 1000

	)

584 
	#OBJ_SHARED_REFCOUNT
 
INT_MAX


	)

585 
	s»disObjeù
 {

586 
	mty³
:4;

587 
	m’codšg
:4;

588 
	mÌu
:
LRU_BITS
;

591 
	m»fcouÁ
;

592 *
	m±r
;

593 } 
	trobj
;

599 
	#š™SticSŒšgObjeù
(
_v¬
,
_±r
) do { \

600 
_v¬
.
»fcouÁ
 = 1; \

601 
_v¬
.
ty³
 = 
OBJ_STRING
; \

602 
_v¬
.
’codšg
 = 
OBJ_ENCODING_RAW
; \

603 
_v¬
.
±r
 = 
_±r
; \

604 } 0)

	)

606 
	geviùiÚPoŞEÁry
;

611 
	s»disDb
 {

612 
diù
 *
	mdiù
;

613 
diù
 *
	mexpœes
;

614 
diù
 *
	mblockšg_keys
;

615 
diù
 *
	m»ady_keys
;

616 
diù
 *
	mw©ched_keys
;

617 
	mid
;

618 
	mavg_‰l
;

619 } 
	t»disDb
;

622 
	smuÉiCmd
 {

623 
robj
 **
	m¬gv
;

624 
	m¬gc
;

625 
»disCommªd
 *
	mcmd
;

626 } 
	tmuÉiCmd
;

628 
	smuÉiS‹
 {

629 
muÉiCmd
 *
	mcommªds
;

630 
	mcouÁ
;

631 
	mmš»¶iÿs
;

632 
time_t
 
	mmš»¶iÿs_timeout
;

633 } 
	tmuÉiS‹
;

637 
	sblockšgS‹
 {

639 
m¡ime_t
 
	mtimeout
;

643 
diù
 *
	mkeys
;

645 
robj
 *
	mrg‘
;

649 
	mnum»¶iÿs
;

650 
	m»¶off£t
;

653 *
	mmoduË_blocked_hªdË
;

656 } 
	tblockšgS‹
;

669 
	s»adyLi¡
 {

670 
»disDb
 *
	mdb
;

671 
robj
 *
	mkey
;

672 } 
	t»adyLi¡
;

676 
	sş›Á
 {

677 
ušt64_t
 
	mid
;

678 
	mfd
;

679 
»disDb
 *
	mdb
;

680 
robj
 *
	mÇme
;

681 
sds
 
	mqu”ybuf
;

682 
sds
 
	m³ndšg_qu”ybuf
;

685 
size_t
 
	mqu”ybuf_³ak
;

686 
	m¬gc
;

687 
robj
 **
	m¬gv
;

688 
»disCommªd
 *
	mcmd
, *
	mÏ¡cmd
;

689 
	m»qty³
;

690 
	mmuÉibulkËn
;

691 
	mbulkËn
;

692 
li¡
 *
	m»¶y
;

693 
	m»¶y_by‹s
;

694 
size_t
 
	m£ÁËn
;

696 
time_t
 
	mùime
;

697 
time_t
 
	mÏ¡š‹¿ùiÚ
;

698 
time_t
 
	mobuf_soá_lim™_»ached_time
;

699 
	mæags
;

700 
	mauth’tiÿ‹d
;

701 
	m»¶¡©e
;

702 
	m»¶_put_Úlše_Ú_ack
;

703 
	m»¶dbfd
;

704 
off_t
 
	m»¶dboff
;

705 
off_t
 
	m»¶dbsize
;

706 
sds
 
	m»¶´—mbË
;

707 
	m»ad_»¶off
;

708 
	m»¶off
;

709 
	m»¶_ack_off
;

710 
	m»¶_ack_time
;

711 
	mpsync_š™Ÿl_off£t
;

714 
	m»¶id
[
CONFIG_RUN_ID_SIZE
+1];

715 
	m¦ave_li¡’šg_pÜt
;

716 
	m¦ave_
[
NET_IP_STR_LEN
];

717 
	m¦ave_ÿ·
;

718 
muÉiS‹
 
	mm¡©e
;

719 
	mbty³
;

720 
blockšgS‹
 
	mbpİ
;

721 
	mwoff
;

722 
li¡
 *
	mw©ched_keys
;

723 
diù
 *
	mpubsub_chªÃls
;

724 
li¡
 *
	mpubsub_·‰”ns
;

725 
sds
 
	m³”id
;

728 
	mbuåos
;

729 
	mbuf
[
PROTO_REPLY_CHUNK_BYTES
];

730 } 
	tş›Á
;

732 
	s§v•¬am
 {

733 
time_t
 
	m£cÚds
;

734 
	mchªges
;

737 
	smoduËLßdQueueEÁry
 {

738 
sds
 
	m·th
;

739 
	m¬gc
;

740 
robj
 **
	m¬gv
;

743 
	ssh¬edObjeùsSŒuù
 {

744 
robj
 *
	mülf
, *
	mok
, *
	m”r
, *
	mem±ybulk
, *
	mcz”o
, *
	mcÚe
, *
	múegÚe
, *
	mpÚg
, *
	m¥aû
,

745 *
	mcŞÚ
, *
	mnuÎbulk
, *
	mnuÎmuÉibulk
, *
	mqueued
,

746 *
	mem±ymuÉibulk
, *
	mwrÚgty³”r
, *
	mnokey”r
, *
	msyÁax”r
, *
	m§meobjeù”r
,

747 *
	moutoäªg“¼
, *
	mnosü‹¼
, *
	mlßdšg”r
, *
	m¦owsü‹¼
, *
	mbg§v“¼
,

748 *
	mma¡”dowÃ¼
, *
	mro¦av“¼
, *
	mexeÿbÜ‹¼
, *
	mnßuth”r
, *
	mnÜ•liÿ£¼
,

749 *
	mbusykey”r
, *
	moom”r
, *
	m¶us
, *
	mmes§gebulk
, *
	mpmes§gebulk
, *
	msubsüibebulk
,

750 *
	munsubsüibebulk
, *
	mpsubsüibebulk
, *
	mpunsubsüibebulk
, *
	md–
, *
	muÆšk
,

751 *
	m½İ
, *
	mÍİ
, *
	mÍush
, *
	mem±ysÿn
,

752 *
	m£Ëù
[
PROTO_SHARED_SELECT_CMDS
],

753 *
	mš‹g”s
[
OBJ_SHARED_INTEGERS
],

754 *
	mmbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
],

755 *
	mbulkhdr
[
OBJ_SHARED_BULKHDR_LEN
];

756 
sds
 
	mmš¡ršg
, 
	mmax¡ršg
;

760 
	szskli¡Node
 {

761 
sds
 
	m–e
;

762 
	mscÜe
;

763 
zskli¡Node
 *
	mbackw¬d
;

764 
	szskli¡Lev–
 {

765 
zskli¡Node
 *
	mfÜw¬d
;

766 
	m¥ª
;

767 } 
	mËv–
[];

768 } 
	tzskli¡Node
;

770 
	szskli¡
 {

771 
zskli¡Node
 *
	mh—d”
, *
	m
;

772 
	mËngth
;

773 
	mËv–
;

774 } 
	tzskli¡
;

776 
	sz£t
 {

777 
diù
 *
	mdiù
;

778 
zskli¡
 *
	mz¦
;

779 } 
	tz£t
;

781 
	sş›ÁBufãrLim™sCÚfig
 {

782 
	mh¬d_lim™_by‹s
;

783 
	msoá_lim™_by‹s
;

784 
time_t
 
	msoá_lim™_£cÚds
;

785 } 
	tş›ÁBufãrLim™sCÚfig
;

787 
ş›ÁBufãrLim™sCÚfig
 
ş›ÁBufãrLim™sDeçuÉs
[
CLIENT_TYPE_OBUF_COUNT
];

795 
	s»disOp
 {

796 
robj
 **
	m¬gv
;

797 
	m¬gc
, 
	mdbid
, 
	mrg‘
;

798 
»disCommªd
 *
	mcmd
;

799 } 
	t»disOp
;

808 
	s»disOpA¼ay
 {

809 
»disOp
 *
	mİs
;

810 
	mnumİs
;

811 } 
	t»disOpA¼ay
;

815 
	s»disMemOv”h—d
 {

816 
size_t
 
	m³ak_®loÿ‹d
;

817 
size_t
 
	mtÙ®_®loÿ‹d
;

818 
size_t
 
	m¡¬tup_®loÿ‹d
;

819 
size_t
 
	m»¶_backlog
;

820 
size_t
 
	mş›Ás_¦aves
;

821 
size_t
 
	mş›Ás_nÜm®
;

822 
size_t
 
	maof_bufãr
;

823 
size_t
 
	mov”h—d_tÙ®
;

824 
size_t
 
	md©a£t
;

825 
size_t
 
	mtÙ®_keys
;

826 
size_t
 
	mby‹s_³r_key
;

827 
	md©a£t_³rc
;

828 
	m³ak_³rc
;

829 
	mäagm’tiÚ
;

830 
size_t
 
	mnum_dbs
;

832 
size_t
 
	mdbid
;

833 
size_t
 
	mov”h—d_ht_maš
;

834 
size_t
 
	mov”h—d_ht_expœes
;

835 } *
	mdb
;

846 
	srdbSaveInfo
 {

848 
	m»¶_¡»am_db
;

851 
	m»¶_id_is_£t
;

852 
	m»¶_id
[
CONFIG_RUN_ID_SIZE
+1];

853 
	m»¶_off£t
;

854 } 
	trdbSaveInfo
;

856 
	#RDB_SAVE_INFO_INIT
 {-1,0,"000000000000000000000000000000",-1}

	)

862 
	gşu¡”S‹
;

866 #ifdeà
_AIX


867 #undeà
hz


870 
	#CHILD_INFO_MAGIC
 0xC17DDA7A12345678LL

	)

871 
	#CHILD_INFO_TYPE_RDB
 0

	)

872 
	#CHILD_INFO_TYPE_AOF
 1

	)

874 
	s»disS”v”
 {

876 
pid_t
 
	mpid
;

877 *
	mcÚfigfe
;

878 *
	mexecubË
;

879 **
	mexec_¬gv
;

880 
	mhz
;

881 
»disDb
 *
	mdb
;

882 
diù
 *
	mcommªds
;

883 
diù
 *
	mÜig_commªds
;

884 
«Ev’tLoİ
 *
	m–
;

885 
	mÌuşock
;

886 
	mshutdown_a§p
;

887 
	maùiv”ehashšg
;

888 
	maùive_deäag_ruÂšg
;

889 *
	m»quœ•ass
;

890 *
	mpidfe
;

891 
	m¬ch_b™s
;

892 
	müÚloİs
;

893 
	mrunid
[
CONFIG_RUN_ID_SIZE
+1];

894 
	m£Áš–_mode
;

895 
size_t
 
	mš™Ÿl_memÜy_u§ge
;

896 
	m®ways_show_logo
;

898 
diù
 *
	mmoduË­i
;

899 
li¡
 *
	mlßdmoduË_queue
;

900 
	mmoduË_blocked_pe
[2];

904 
	mpÜt
;

905 
	mtı_backlog
;

906 *
	mbšdaddr
[
CONFIG_BINDADDR_MAX
];

907 
	mbšdaddr_couÁ
;

908 *
	munixsock‘
;

909 
mode_t
 
	munixsock‘³rm
;

910 
	mfd
[
CONFIG_BINDADDR_MAX
];

911 
	mfd_couÁ
;

912 
	msofd
;

913 
	mcfd
[
CONFIG_BINDADDR_MAX
];

914 
	mcfd_couÁ
;

915 
li¡
 *
	mş›Ás
;

916 
li¡
 *
	mş›Ás_to_şo£
;

917 
li¡
 *
	mş›Ás_³ndšg_wr™e
;

918 
li¡
 *
	m¦aves
, *
	mmÚ™Üs
;

919 
ş›Á
 *
	mcu¼’t_ş›Á
;

920 
	mş›Ás_·u£d
;

921 
m¡ime_t
 
	mş›Ás_·u£_’d_time
;

922 
	mÃ‹¼
[
ANET_ERR_LEN
];

923 
diù
 *
	mmig¿‹_ÿched_sock‘s
;

924 
ušt64_t
 
	mÃxt_ş›Á_id
;

925 
	m´Ùeùed_mode
;

927 
	mlßdšg
;

928 
off_t
 
	mlßdšg_tÙ®_by‹s
;

929 
off_t
 
	mlßdšg_lßded_by‹s
;

930 
time_t
 
	mlßdšg_¡¬t_time
;

931 
off_t
 
	mlßdšg_´oûss_ev’ts_š‹rv®_by‹s
;

933 
»disCommªd
 *
	md–Commªd
, *
	mmuÉiCommªd
, *
	mÍushCommªd
, *
	mÍİCommªd
,

934 *
	m½İCommªd
, *
	m¤emCommªd
, *
	mexecCommªd
, *
	mexpœeCommªd
,

935 *
	m³xpœeCommªd
;

937 
time_t
 
	m¡©_¡¬‰ime
;

938 
	m¡©_numcommªds
;

939 
	m¡©_numcÚÃùiÚs
;

940 
	m¡©_expœedkeys
;

941 
	m¡©_expœed_¡®e_³rc
;

942 
	m¡©_expœed_time_ÿp_»ached_couÁ
;

943 
	m¡©_eviùedkeys
;

944 
	m¡©_key¥aû_h™s
;

945 
	m¡©_key¥aû_mis£s
;

946 
	m¡©_aùive_deäag_h™s
;

947 
	m¡©_aùive_deäag_mis£s
;

948 
	m¡©_aùive_deäag_key_h™s
;

949 
	m¡©_aùive_deäag_key_mis£s
;

950 
size_t
 
	m¡©_³ak_memÜy
;

951 
	m¡©_fÜk_time
;

952 
	m¡©_fÜk_¿‹
;

953 
	m¡©_»jeùed_cÚn
;

954 
	m¡©_sync_fuÎ
;

955 
	m¡©_sync_·¹Ÿl_ok
;

956 
	m¡©_sync_·¹Ÿl_”r
;

957 
li¡
 *
	m¦owlog
;

958 
	m¦owlog_’Œy_id
;

959 
	m¦owlog_log_¦ow”_thª
;

960 
	m¦owlog_max_Ën
;

961 
size_t
 
	m»sid’t_£t_size
;

962 
	m¡©_Ãt_šput_by‹s
;

963 
	m¡©_Ãt_ouut_by‹s
;

964 
size_t
 
	m¡©_rdb_cow_by‹s
;

965 
size_t
 
	m¡©_aof_cow_by‹s
;

969 
	mÏ¡_§m¶e_time
;

970 
	mÏ¡_§m¶e_couÁ
;

971 
	m§m¶es
[
STATS_METRIC_SAMPLES
];

972 
	midx
;

973 } 
	mš¡_m‘ric
[
STATS_METRIC_COUNT
];

975 
	mv”bos™y
;

976 
	mmaxidËtime
;

977 
	mtık“·live
;

978 
	maùive_expœe_’abËd
;

979 
	maùive_deäag_’abËd
;

980 
size_t
 
	maùive_deäag_ignÜe_by‹s
;

981 
	maùive_deäag_th»shŞd_low”
;

982 
	maùive_deäag_th»shŞd_uµ”
;

983 
	maùive_deäag_cyşe_mš
;

984 
	maùive_deäag_cyşe_max
;

985 
size_t
 
	mş›Á_max_qu”ybuf_Ën
;

986 
	mdbnum
;

987 
	msu³rvi£d
;

988 
	msu³rvi£d_mode
;

989 
	md«mÚize
;

990 
ş›ÁBufãrLim™sCÚfig
 
	mş›Á_obuf_lim™s
[
CLIENT_TYPE_OBUF_COUNT
];

992 
	maof_¡©e
;

993 
	maof_fsync
;

994 *
	maof_f’ame
;

995 
	maof_no_fsync_Ú_»wr™e
;

996 
	maof_»wr™e_³rc
;

997 
off_t
 
	maof_»wr™e_mš_size
;

998 
off_t
 
	maof_»wr™e_ba£_size
;

999 
off_t
 
	maof_cu¼’t_size
;

1000 
	maof_»wr™e_scheduËd
;

1001 
pid_t
 
	maof_chd_pid
;

1002 
li¡
 *
	maof_»wr™e_buf_blocks
;

1003 
sds
 
	maof_buf
;

1004 
	maof_fd
;

1005 
	maof_£Ëùed_db
;

1006 
time_t
 
	maof_æush_po¡pÚed_¡¬t
;

1007 
time_t
 
	maof_Ï¡_fsync
;

1008 
time_t
 
	maof_»wr™e_time_Ï¡
;

1009 
time_t
 
	maof_»wr™e_time_¡¬t
;

1010 
	maof_Ï¡bg»wr™e_¡©us
;

1011 
	maof_d–ayed_fsync
;

1012 
	maof_»wr™e_šüem’l_fsync
;

1013 
	maof_Ï¡_wr™e_¡©us
;

1014 
	maof_Ï¡_wr™e_”ºo
;

1015 
	maof_lßd_Œunÿ‹d
;

1016 
	maof_u£_rdb_´—mbË
;

1018 
	maof_pe_wr™e_d©a_to_chd
;

1019 
	maof_pe_»ad_d©a_äom_·»Á
;

1020 
	maof_pe_wr™e_ack_to_·»Á
;

1021 
	maof_pe_»ad_ack_äom_chd
;

1022 
	maof_pe_wr™e_ack_to_chd
;

1023 
	maof_pe_»ad_ack_äom_·»Á
;

1024 
	maof_¡İ_£ndšg_diff
;

1026 
sds
 
	maof_chd_diff
;

1028 
	mdœty
;

1029 
	mdœty_befÜe_bg§ve
;

1030 
pid_t
 
	mrdb_chd_pid
;

1031 
§v•¬am
 *
	m§v•¬ams
;

1032 
	m§v•¬am¦’
;

1033 *
	mrdb_f’ame
;

1034 
	mrdb_com´essiÚ
;

1035 
	mrdb_checksum
;

1036 
time_t
 
	mÏ¡§ve
;

1037 
time_t
 
	mÏ¡bg§ve_Œy
;

1038 
time_t
 
	mrdb_§ve_time_Ï¡
;

1039 
time_t
 
	mrdb_§ve_time_¡¬t
;

1040 
	mrdb_bg§ve_scheduËd
;

1041 
	mrdb_chd_ty³
;

1042 
	mÏ¡bg§ve_¡©us
;

1043 
	m¡İ_wr™es_Ú_bg§ve_”r
;

1044 
	mrdb_pe_wr™e_»suÉ_to_·»Á
;

1045 
	mrdb_pe_»ad_»suÉ_äom_chd
;

1047 
	mchd_šfo_pe
[2];

1049 
	m´oûss_ty³
;

1050 
size_t
 
	mcow_size
;

1051 
	mmagic
;

1052 } 
	mchd_šfo_d©a
;

1054 
»disOpA¼ay
 
	m®so_´İag©e
;

1056 *
	mlogfe
;

1057 
	msy¦og_’abËd
;

1058 *
	msy¦og_id’t
;

1059 
	msy¦og_çc™y
;

1061 
	m»¶id
[
CONFIG_RUN_ID_SIZE
+1];

1062 
	m»¶id2
[
CONFIG_RUN_ID_SIZE
+1];

1063 
	mma¡”_»¶_off£t
;

1064 
	m£cÚd_»¶id_off£t
;

1065 
	m¦ave£ldb
;

1066 
	m»¶_pšg_¦ave_³riod
;

1067 *
	m»¶_backlog
;

1068 
	m»¶_backlog_size
;

1069 
	m»¶_backlog_hi¡Ën
;

1070 
	m»¶_backlog_idx
;

1072 
	m»¶_backlog_off
;

1074 
time_t
 
	m»¶_backlog_time_lim™
;

1076 
time_t
 
	m»¶_no_¦aves_sšû
;

1078 
	m»¶_mš_¦aves_to_wr™e
;

1079 
	m»¶_mš_¦aves_max_Ïg
;

1080 
	m»¶_good_¦aves_couÁ
;

1081 
	m»¶_diskËss_sync
;

1082 
	m»¶_diskËss_sync_d–ay
;

1084 *
	mma¡”auth
;

1085 *
	mma¡”ho¡
;

1086 
	mma¡”pÜt
;

1087 
	m»¶_timeout
;

1088 
ş›Á
 *
	mma¡”
;

1089 
ş›Á
 *
	mÿched_ma¡”
;

1090 
	m»¶_syncio_timeout
;

1091 
	m»¶_¡©e
;

1092 
off_t
 
	m»¶_Œªsãr_size
;

1093 
off_t
 
	m»¶_Œªsãr_»ad
;

1094 
off_t
 
	m»¶_Œªsãr_Ï¡_fsync_off
;

1095 
	m»¶_Œªsãr_s
;

1096 
	m»¶_Œªsãr_fd
;

1097 *
	m»¶_Œªsãr_tmpfe
;

1098 
time_t
 
	m»¶_Œªsãr_Ï¡io
;

1099 
	m»¶_£rve_¡®e_d©a
;

1100 
	m»¶_¦ave_ro
;

1101 
time_t
 
	m»¶_down_sšû
;

1102 
	m»¶_di§bË_tı_nod–ay
;

1103 
	m¦ave_´iÜ™y
;

1104 
	m¦ave_ªnounû_pÜt
;

1105 *
	m¦ave_ªnounû_
;

1109 
	mma¡”_»¶id
[
CONFIG_RUN_ID_SIZE
+1];

1110 
	mma¡”_š™Ÿl_off£t
;

1111 
	m»¶_¦ave_Ïzy_æush
;

1113 
diù
 *
	m»¶_sütÿche_diù
;

1114 
li¡
 *
	m»¶_sütÿche_fifo
;

1115 
	m»¶_sütÿche_size
;

1117 
li¡
 *
	mş›Ás_wa™šg_acks
;

1118 
	mg‘_ack_äom_¦aves
;

1120 
	mmaxş›Ás
;

1121 
	mmaxmemÜy
;

1122 
	mmaxmemÜy_pŞicy
;

1123 
	mmaxmemÜy_§m¶es
;

1124 
	mlfu_log_çùÜ
;

1125 
	mlfu_deÿy_time
;

1126 
	m´Ùo_max_bulk_Ën
;

1128 
	mbpİ_blocked_ş›Ás
;

1129 
li¡
 *
	munblocked_ş›Ás
;

1130 
li¡
 *
	m»ady_keys
;

1133 
	msÜt_desc
;

1134 
	msÜt_®pha
;

1135 
	msÜt_by·‰”n
;

1136 
	msÜt_¡Üe
;

1138 
size_t
 
	mhash_max_zli¡_’Œ›s
;

1139 
size_t
 
	mhash_max_zli¡_v®ue
;

1140 
size_t
 
	m£t_max_št£t_’Œ›s
;

1141 
size_t
 
	mz£t_max_zli¡_’Œ›s
;

1142 
size_t
 
	mz£t_max_zli¡_v®ue
;

1143 
size_t
 
	mhÎ_¥¬£_max_by‹s
;

1145 
	mli¡_max_zli¡_size
;

1146 
	mli¡_com´ess_d•th
;

1148 
time_t
 
	munixtime
;

1149 
	mm¡ime
;

1151 
diù
 *
	mpubsub_chªÃls
;

1152 
li¡
 *
	mpubsub_·‰”ns
;

1153 
	mnÙify_key¥aû_ev’ts
;

1156 
	mşu¡”_’abËd
;

1157 
m¡ime_t
 
	mşu¡”_node_timeout
;

1158 *
	mşu¡”_cÚfigfe
;

1159 
şu¡”S‹
 *
	mşu¡”
;

1160 
	mşu¡”_mig¿tiÚ_b¬r›r
;

1161 
	mşu¡”_¦ave_v®id™y_çùÜ
;

1162 
	mşu¡”_»quœe_fuÎ_cov”age
;

1164 
	mşu¡”_¦ave_no_çov”
;

1166 *
	mşu¡”_ªnounû_
;

1167 
	mşu¡”_ªnounû_pÜt
;

1168 
	mşu¡”_ªnounû_bus_pÜt
;

1170 
lua_S‹
 *
	mlua
;

1171 
ş›Á
 *
	mlua_ş›Á
;

1172 
ş›Á
 *
	mlua_ÿÎ”
;

1173 
diù
 *
	mlua_süts
;

1174 
m¡ime_t
 
	mlua_time_lim™
;

1175 
m¡ime_t
 
	mlua_time_¡¬t
;

1176 
	mlua_wr™e_dœty
;

1178 
	mlua_¿ndom_dœty
;

1180 
	mlua_»¶iÿ‹_commªds
;

1181 
	mlua_muÉi_em™‹d
;

1182 
	mlua_»¶
;

1183 
	mlua_timedout
;

1185 
	mlua_kl
;

1186 
	mlua_®ways_»¶iÿ‹_commªds
;

1188 
	mÏzyä“_Ïzy_eviùiÚ
;

1189 
	mÏzyä“_Ïzy_expœe
;

1190 
	mÏzyä“_Ïzy_£rv”_d–
;

1192 
	mÏ‹ncy_mÚ™Ü_th»shŞd
;

1193 
diù
 *
	mÏ‹ncy_ev’ts
;

1195 cÚ¡ *
	mas£¹_çed
;

1196 cÚ¡ *
	mas£¹_fe
;

1197 
	mas£¹_lše
;

1198 
	mbug_»pÜt_¡¬t
;

1199 
	mw©chdog_³riod
;

1201 
size_t
 
	msy¡em_memÜy_size
;

1205 
±h»ad_mu‹x_t
 
	mÌuşock_mu‹x
;

1206 
±h»ad_mu‹x_t
 
	mÃxt_ş›Á_id_mu‹x
;

1207 
±h»ad_mu‹x_t
 
	munixtime_mu‹x
;

1210 
	spubsubP©‹º
 {

1211 
ş›Á
 *
	mş›Á
;

1212 
robj
 *
	m·‰”n
;

1213 } 
	tpubsubP©‹º
;

1215 
	t»disCommªdProc
(
	tş›Á
 *
	tc
);

1216 *
	t»disG‘KeysProc
(
	t»disCommªd
 *
	tcmd
, 
	trobj
 **
	t¬gv
, 
	t¬gc
, *
	tnumkeys
);

1217 
	s»disCommªd
 {

1218 *
	mÇme
;

1219 
»disCommªdProc
 *
	m´oc
;

1220 
	m¬™y
;

1221 *
	msæags
;

1222 
	mæags
;

1225 
»disG‘KeysProc
 *
	mg‘keys_´oc
;

1227 
	mfœ¡key
;

1228 
	mÏ¡key
;

1229 
	mkey¡•
;

1230 
	mmiüo£cÚds
, 
	mÿÎs
;

1233 
	s»disFunùiÚSym
 {

1234 *
	mÇme
;

1235 
	mpoš‹r
;

1238 
	s_»disSÜtObjeù
 {

1239 
robj
 *
	mobj
;

1241 
	mscÜe
;

1242 
robj
 *
	mcmpobj
;

1243 } 
	mu
;

1244 } 
	t»disSÜtObjeù
;

1246 
	s_»disSÜtO³¿tiÚ
 {

1247 
	mty³
;

1248 
robj
 *
	m·‰”n
;

1249 } 
	t»disSÜtO³¿tiÚ
;

1253 
robj
 *
	msubjeù
;

1254 
	m’codšg
;

1255 
	mdœeùiÚ
;

1256 
quickli¡I‹r
 *
	m™”
;

1257 } 
	tli¡Ty³I‹¿tÜ
;

1261 
li¡Ty³I‹¿tÜ
 *
	mli
;

1262 
quickli¡EÁry
 
	m’Œy
;

1263 } 
	tli¡Ty³EÁry
;

1267 
robj
 *
	msubjeù
;

1268 
	m’codšg
;

1269 
	mii
;

1270 
diùI‹¿tÜ
 *
	mdi
;

1271 } 
	t£tTy³I‹¿tÜ
;

1278 
robj
 *
	msubjeù
;

1279 
	m’codšg
;

1281 *
	måŒ
, *
	mv±r
;

1283 
diùI‹¿tÜ
 *
	mdi
;

1284 
diùEÁry
 *
	mde
;

1285 } 
	thashTy³I‹¿tÜ
;

1287 
	#OBJ_HASH_KEY
 1

	)

1288 
	#OBJ_HASH_VALUE
 2

	)

1294 
»disS”v”
 
£rv”
;

1295 
sh¬edObjeùsSŒuù
 
sh¬ed
;

1296 
diùTy³
 
objeùKeyPoš‹rV®ueDiùTy³
;

1297 
diùTy³
 
£tDiùTy³
;

1298 
diùTy³
 
z£tDiùTy³
;

1299 
diùTy³
 
şu¡”NodesDiùTy³
;

1300 
diùTy³
 
şu¡”NodesBÏckLi¡DiùTy³
;

1301 
diùTy³
 
dbDiùTy³
;

1302 
diùTy³
 
shaSütObjeùDiùTy³
;

1303 
R_Z”o
, 
R_PosInf
, 
R_NegInf
, 
R_Nª
;

1304 
diùTy³
 
hashDiùTy³
;

1305 
diùTy³
 
»¶SütCacheDiùTy³
;

1306 
diùTy³
 
key±rDiùTy³
;

1307 
diùTy³
 
moduËsDiùTy³
;

1314 
moduËIn™ModuËsSy¡em
();

1315 
moduËLßd
(cÚ¡ *
·th
, **
¬gv
, 
¬gc
);

1316 
moduËLßdFromQueue
();

1317 *
moduËG‘CommªdKeysVŸAPI
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1318 
moduËTy³
 *
moduËTy³LookupModuËByID
(
ušt64_t
 
id
);

1319 
moduËTy³NameByID
(*
Çme
, 
ušt64_t
 
moduËid
);

1320 
moduËF»eCÚ‹xt
(
RedisModuËCtx
 *
ùx
);

1321 
unblockCl›ÁFromModuË
(
ş›Á
 *
c
);

1322 
moduËHªdËBlockedCl›Ás
();

1323 
moduËBlockedCl›ÁTimedOut
(
ş›Á
 *
c
);

1324 
moduËBlockedCl›ÁPeR—dabË
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1325 
size_t
 
moduËCouÁ
();

1326 
moduËAcquœeGIL
();

1327 
moduËR–—£GIL
();

1328 
moduËNÙifyKey¥aûEv’t
(
ty³
, cÚ¡ *
ev’t
, 
robj
 *
key
, 
dbid
);

1332 
u¡ime
();

1333 
m¡ime
();

1334 
g‘RªdomHexCh¬s
(*
p
, 
Ën
);

1335 
ušt64_t
 
üc64
(ušt64_ˆ
üc
, cÚ¡ *
s
, ušt64_ˆ
l
);

1336 
ex™FromChd
(
»tcode
);

1337 
size_t
 
»disPİcouÁ
(*
s
, 
couÁ
);

1338 
»disS‘ProcT™Ë
(*
t™Ë
);

1341 
ş›Á
 *
ü—‹Cl›Á
(
fd
);

1342 
şo£TimedoutCl›Ás
();

1343 
ä“Cl›Á
(
ş›Á
 *
c
);

1344 
ä“Cl›ÁAsync
(
ş›Á
 *
c
);

1345 
»£tCl›Á
(
ş›Á
 *
c
);

1346 
£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1347 *
addDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
);

1348 
£tDeã¼edMuÉiBulkL’gth
(
ş›Á
 *
c
, *
node
, 
Ëngth
);

1349 
´oûssIÅutBufãr
(
ş›Á
 *
c
);

1350 
acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1351 
acû±TıHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1352 
acû±UnixHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1353 
»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1354 
addR•lySŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
, 
size_t
 
Ën
);

1355 
addR•lyBulk
(
ş›Á
 *
c
, 
robj
 *
obj
);

1356 
addR•lyBulkCSŒšg
(
ş›Á
 *
c
, cÚ¡ *
s
);

1357 
addR•lyBulkCBufãr
(
ş›Á
 *
c
, cÚ¡ *
p
, 
size_t
 
Ën
);

1358 
addR•lyBulkLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

1359 
addR•ly
(
ş›Á
 *
c
, 
robj
 *
obj
);

1360 
addR•lySds
(
ş›Á
 *
c
, 
sds
 
s
);

1361 
addR•lyBulkSds
(
ş›Á
 *
c
, 
sds
 
s
);

1362 
addR•lyE¼Ü
(
ş›Á
 *
c
, cÚ¡ *
”r
);

1363 
addR•lyStus
(
ş›Á
 *
c
, cÚ¡ *
¡©us
);

1364 
addR•lyDoubË
(
ş›Á
 *
c
, 
d
);

1365 
addR•lyHumªLÚgDoubË
(
ş›Á
 *
c
, 
d
);

1366 
addR•lyLÚgLÚg
(
ş›Á
 *
c
, 
Î
);

1367 
addR•lyMuÉiBulkL’
(
ş›Á
 *
c
, 
Ëngth
);

1368 
cİyCl›ÁOuutBufãr
(
ş›Á
 *
d¡
, cl›Á *
¤c
);

1369 
size_t
 
sdsZm®locSize
(
sds
 
s
);

1370 
size_t
 
g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
);

1371 *
dupCl›ÁR•lyV®ue
(*
o
);

1372 
g‘Cl›ÁsMaxBufãrs
(*
lÚge¡_ouut_li¡
,

1373 *
bigge¡_šput_bufãr
);

1374 *
g‘Cl›ÁP“rId
(
ş›Á
 *client);

1375 
sds
 
ÿtCl›ÁInfoSŒšg
(sd 
s
, 
ş›Á
 *client);

1376 
sds
 
g‘AÎCl›ÁsInfoSŒšg
();

1377 
»wr™eCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, ...);

1378 
»wr™eCl›ÁCommªdArgum’t
(
ş›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
);

1379 
»¶aûCl›ÁCommªdVeùÜ
(
ş›Á
 *
c
, 
¬gc
, 
robj
 **
¬gv
);

1380 
g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
 *
c
);

1381 
ä“Cl›ÁsInAsyncF»eQueue
();

1382 
asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
ş›Á
 *
c
);

1383 
g‘Cl›ÁTy³
(
ş›Á
 *
c
);

1384 
g‘Cl›ÁTy³ByName
(*
Çme
);

1385 *
g‘Cl›ÁTy³Name
(
şass
);

1386 
æushSÏvesOuutBufãrs
();

1387 
discÚÃùSÏves
();

1388 
li¡’ToPÜt
(
pÜt
, *
fds
, *
couÁ
);

1389 
·u£Cl›Ás
(
m¡ime_t
 
du¿tiÚ
);

1390 
ş›ÁsA»Pau£d
();

1391 
´oûssEv’tsWheBlocked
();

1392 
hªdËCl›ÁsW™hP’dšgWr™es
();

1393 
ş›ÁHasP’dšgR•l›s
(
ş›Á
 *
c
);

1394 
uÆškCl›Á
(
ş›Á
 *
c
);

1395 
wr™eToCl›Á
(
fd
, 
ş›Á
 *
c
, 
hªdËr_š¡®Ëd
);

1397 #ifdeà
__GNUC__


1398 
	$addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

1399 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1400 
	$addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...)

1401 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1403 
	`addR•lyE¼ÜFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

1404 
	`addR•lyStusFÜm©
(
ş›Á
 *
c
, cÚ¡ *
fmt
, ...);

1408 
	`li¡Ty³TryCÚv”siÚ
(
robj
 *
subjeù
,„obj *
v®ue
);

1409 
	`li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
);

1410 
robj
 *
	`li¡Ty³Pİ
Ôobj *
subjeù
, 
wh”e
);

1411 
	`li¡Ty³L’gth
(cÚ¡ 
robj
 *
subjeù
);

1412 
li¡Ty³I‹¿tÜ
 *
	`li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
, 
dœeùiÚ
);

1413 
	`li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
);

1414 
	`li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
);

1415 
robj
 *
	`li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
);

1416 
	`li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
);

1417 
	`li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
);

1418 
	`li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
);

1419 
	`li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
);

1420 
	`unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
);

1421 
	`hªdËCl›ÁsBlockedOnLi¡s
();

1422 
	`pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
);

1423 
	`sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
);

1426 
	`unw©chAÎKeys
(
ş›Á
 *
c
);

1427 
	`š™Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

1428 
	`ä“Cl›ÁMuÉiS‹
(
ş›Á
 *
c
);

1429 
	`queueMuÉiCommªd
(
ş›Á
 *
c
);

1430 
	`touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
);

1431 
	`touchW©chedKeysOnFlush
(
dbid
);

1432 
	`disÿrdT¿n§ùiÚ
(
ş›Á
 *
c
);

1433 
	`æagT¿n§ùiÚ
(
ş›Á
 *
c
);

1434 
	`execCommªdPrİag©eMuÉi
(
ş›Á
 *
c
);

1437 
	`deüRefCouÁ
(
robj
 *
o
);

1438 
	`deüRefCouÁVoid
(*
o
);

1439 
	`šüRefCouÁ
(
robj
 *
o
);

1440 
robj
 *
	`makeObjeùSh¬ed
Ôobj *
o
);

1441 
robj
 *
	`»£tRefCouÁ
Ôobj *
obj
);

1442 
	`ä“SŒšgObjeù
(
robj
 *
o
);

1443 
	`ä“Li¡Objeù
(
robj
 *
o
);

1444 
	`ä“S‘Objeù
(
robj
 *
o
);

1445 
	`ä“Z£tObjeù
(
robj
 *
o
);

1446 
	`ä“HashObjeù
(
robj
 *
o
);

1447 
robj
 *
	`ü—‹Objeù
(
ty³
, *
±r
);

1448 
robj
 *
	`ü—‹SŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

1449 
robj
 *
	`ü—‹RawSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

1450 
robj
 *
	`ü—‹EmbeddedSŒšgObjeù
(cÚ¡ *
±r
, 
size_t
 
Ën
);

1451 
robj
 *
	`dupSŒšgObjeù
(cÚ¡„obj *
o
);

1452 
	`isSdsR•»£ÁabËAsLÚgLÚg
(
sds
 
s
, *
Îv®
);

1453 
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
ÎÚgv®
);

1454 
robj
 *
	`ŒyObjeùEncodšg
Ôobj *
o
);

1455 
robj
 *
	`g‘DecodedObjeù
Ôobj *
o
);

1456 
size_t
 
	`¡ršgObjeùL’
(
robj
 *
o
);

1457 
robj
 *
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

1458 
robj
 *
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
);

1459 
robj
 *
	`ü—‹Quickli¡Objeù
();

1460 
robj
 *
	`ü—‹Zli¡Objeù
();

1461 
robj
 *
	`ü—‹S‘Objeù
();

1462 
robj
 *
	`ü—‹IÁ£tObjeù
();

1463 
robj
 *
	`ü—‹HashObjeù
();

1464 
robj
 *
	`ü—‹Z£tObjeù
();

1465 
robj
 *
	`ü—‹Z£tZli¡Objeù
();

1466 
robj
 *
	`ü—‹ModuËObjeù
(
moduËTy³
 *
mt
, *
v®ue
);

1467 
	`g‘LÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1468 
	`checkTy³
(
ş›Á
 *
c
, 
robj
 *
o
, 
ty³
);

1469 
	`g‘LÚgLÚgFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1470 
	`g‘DoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1471 
	`g‘DoubËFromObjeù
(cÚ¡ 
robj
 *
o
, *
rg‘
);

1472 
	`g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
);

1473 
	`g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
);

1474 
	`g‘LÚgDoubËFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1475 *
	`¡rEncodšg
(
’codšg
);

1476 
	`com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1477 
	`cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1478 
	`equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1479 
	`e¡im©eObjeùIdËTime
(
robj
 *
o
);

1480 
	#sdsEncodedObjeù
(
obj±r
è(obj±r->
’codšg
 =ğ
OBJ_ENCODING_RAW
 || obj±r->’codšg =ğ
OBJ_ENCODING_EMBSTR
)

	)

1483 
ssize_t
 
	`syncWr™e
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1484 
ssize_t
 
	`syncR—d
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1485 
ssize_t
 
	`syncR—dLše
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1488 
	`»¶iÿtiÚF“dSÏves
(
li¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1489 
	`»¶iÿtiÚF“dSÏvesFromMa¡”SŒ—m
(
li¡
 *
¦aves
, *
buf
, 
size_t
 
buæ’
);

1490 
	`»¶iÿtiÚF“dMÚ™Üs
(
ş›Á
 *
c
, 
li¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1491 
	`upd©eSÏvesWa™šgBg§ve
(
bg§v“¼
, 
ty³
);

1492 
	`»¶iÿtiÚCrÚ
();

1493 
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

1494 
	`»¶iÿtiÚCacheMa¡”
(
ş›Á
 *
c
);

1495 
	`»sizeR•liÿtiÚBacklog
(
Ãwsize
);

1496 
	`»¶iÿtiÚS‘Ma¡”
(*

, 
pÜt
);

1497 
	`»¶iÿtiÚUn£tMa¡”
();

1498 
	`»äeshGoodSÏvesCouÁ
();

1499 
	`»¶iÿtiÚSütCacheIn™
();

1500 
	`»¶iÿtiÚSütCacheFlush
();

1501 
	`»¶iÿtiÚSütCacheAdd
(
sds
 
sha1
);

1502 
	`»¶iÿtiÚSütCacheExi¡s
(
sds
 
sha1
);

1503 
	`´oûssCl›ÁsWa™šgR•liÿs
();

1504 
	`unblockCl›ÁWa™šgR•liÿs
(
ş›Á
 *
c
);

1505 
	`»¶iÿtiÚCouÁAcksByOff£t
(
off£t
);

1506 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

1507 
	`»¶iÿtiÚG‘SÏveOff£t
();

1508 *
	`»¶iÿtiÚG‘SÏveName
(
ş›Á
 *
c
);

1509 
	`g‘PsyncIn™ŸlOff£t
();

1510 
	`»¶iÿtiÚS‘upSÏveFÜFuÎResync
(
ş›Á
 *
¦ave
, 
off£t
);

1511 
	`chªgeR•liÿtiÚId
();

1512 
	`ş—rR•liÿtiÚId2
();

1513 
	`chİR•liÿtiÚBacklog
();

1514 
	`»¶iÿtiÚCacheMa¡”UsšgMy£lf
();

1515 
	`ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
);

1518 
	`¡¬tLßdšg
(
FILE
 *
å
);

1519 
	`lßdšgProg»ss
(
off_t
 
pos
);

1520 
	`¡İLßdšg
();

1523 
	~"rdb.h
"

1524 
	`rdbSaveRio
(
rio
 *
rdb
, *
”rÜ
, 
æags
, 
rdbSaveInfo
 *
rsi
);

1527 
	`æushAµ’dOÆyFe
(
fÜû
);

1528 
	`ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1529 
	`aofRemoveTempFe
(
pid_t
 
chdpid
);

1530 
	`»wr™eAµ’dOÆyFeBackground
();

1531 
	`lßdAµ’dOÆyFe
(*
f’ame
);

1532 
	`¡İAµ’dOÆy
();

1533 
	`¡¬tAµ’dOÆy
();

1534 
	`backgroundRewr™eDÚeHªdËr
(
ex™code
, 
bysigÇl
);

1535 
	`aofRewr™eBufãrRe£t
();

1536 
	`aofRewr™eBufãrSize
();

1537 
ssize_t
 
	`aofR—dDiffFromP¬’t
();

1540 
	`İ’ChdInfoPe
();

1541 
	`şo£ChdInfoPe
();

1542 
	`£ndChdInfo
(
´oûss_ty³
);

1543 
	`»ûiveChdInfo
();

1548 
	#ZADD_NONE
 0

	)

1549 
	#ZADD_INCR
 (1<<0è

	)

1550 
	#ZADD_NX
 (1<<1è

	)

1551 
	#ZADD_XX
 (1<<2è

	)

1554 
	#ZADD_NOP
 (1<<3è

	)

1555 
	#ZADD_NAN
 (1<<4è

	)

1556 
	#ZADD_ADDED
 (1<<5è

	)

1557 
	#ZADD_UPDATED
 (1<<6è

	)

1560 
	#ZADD_CH
 (1<<16è

	)

1564 
mš
, 
max
;

1565 
mšex
, 
maxex
;

1566 } 
	tz¿nge¥ec
;

1570 
sds
 
mš
, 
max
;

1571 
mšex
, 
maxex
;

1572 } 
	tzËx¿nge¥ec
;

1574 
zskli¡
 *
	`z¦C»©e
();

1575 
	`z¦F»e
(
zskli¡
 *
z¦
);

1576 
zskli¡Node
 *
	`z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
);

1577 *
	`zzlIn£¹
(*
zl
, 
sds
 
–e
, 
scÜe
);

1578 
	`z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
, 
zskli¡Node
 **
node
);

1579 
zskli¡Node
 *
	`z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

1580 
zskli¡Node
 *
	`z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

1581 
	`zzlG‘ScÜe
(*
¥Œ
);

1582 
	`zzlNext
(*
zl
, **
•Œ
, **
¥Œ
);

1583 
	`zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
);

1584 *
	`zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

1585 *
	`zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
);

1586 
	`z£tL’gth
(cÚ¡ 
robj
 *
zobj
);

1587 
	`z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
);

1588 
	`z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
);

1589 
	`z£tScÜe
(
robj
 *
zobj
, 
sds
 
memb”
, *
scÜe
);

1590 
	`z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
o
);

1591 
	`z£tAdd
(
robj
 *
zobj
, 
scÜe
, 
sds
 
–e
, *
æags
, *
ÃwscÜe
);

1592 
	`z£tRªk
(
robj
 *
zobj
, 
sds
 
–e
, 
»v”£
);

1593 
	`z£tD–
(
robj
 *
zobj
, 
sds
 
–e
);

1594 
sds
 
	`zli¡G‘Objeù
(*
¥Œ
);

1595 
	`z¦V®ueG‹Mš
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

1596 
	`z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
);

1597 
	`z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
);

1598 
	`z¦P¬£LexRªge
(
robj
 *
mš
,„obj *
max
, 
zËx¿nge¥ec
 *
¥ec
);

1599 *
	`zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

1600 *
	`zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
);

1601 
zskli¡Node
 *
	`z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

1602 
zskli¡Node
 *
	`z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
);

1603 
	`zzlLexV®ueG‹Mš
(*
p
, 
zËx¿nge¥ec
 *
¥ec
);

1604 
	`zzlLexV®ueL‹Max
(*
p
, 
zËx¿nge¥ec
 *
¥ec
);

1605 
	`z¦LexV®ueG‹Mš
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

1606 
	`z¦LexV®ueL‹Max
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

1609 
	`ä“MemÜyIfN“ded
();

1610 
	`´oûssCommªd
(
ş›Á
 *
c
);

1611 
	`£tupSigÇlHªdËrs
();

1612 
»disCommªd
 *
	`lookupCommªd
(
sds
 
Çme
);

1613 
»disCommªd
 *
	`lookupCommªdByCSŒšg
(*
s
);

1614 
»disCommªd
 *
	`lookupCommªdOrOrigš®
(
sds
 
Çme
);

1615 
	`ÿÎ
(
ş›Á
 *
c
, 
æags
);

1616 
	`´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
æags
);

1617 
	`®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
rg‘
);

1618 
	`fÜûCommªdPrİag©iÚ
(
ş›Á
 *
c
, 
æags
);

1619 
	`´ev’tCommªdPrİag©iÚ
(
ş›Á
 *
c
);

1620 
	`´ev’tCommªdAOF
(
ş›Á
 *
c
);

1621 
	`´ev’tCommªdR•liÿtiÚ
(
ş›Á
 *
c
);

1622 
	`´•¬eFÜShutdown
();

1623 #ifdeà
__GNUC__


1624 
	$£rv”Log
(
Ëv–
, cÚ¡ *
fmt
, ...)

1625 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1627 
	`£rv”Log
(
Ëv–
, cÚ¡ *
fmt
, ...);

1629 
	`£rv”LogRaw
(
Ëv–
, cÚ¡ *
msg
);

1630 
	`£rv”LogFromHªdËr
(
Ëv–
, cÚ¡ *
msg
);

1631 
	`u§ge
();

1632 
	`upd©eDiùResizePŞicy
();

1633 
	`htN“dsResize
(
diù
 *dict);

1634 
	`pİuÏ‹CommªdTabË
();

1635 
	`»£tCommªdTabËSts
();

1636 
	`adju¡O³nFesLim™
();

1637 
	`şo£Li¡’šgSock‘s
(
uÆšk_unix_sock‘
);

1638 
	`upd©eCachedTime
();

1639 
	`»£tS”v”Sts
();

1640 
	`aùiveDeäagCyşe
();

1641 
	`g‘LRUClock
();

1642 
	`LRU_CLOCK
();

1643 cÚ¡ *
	`eviùPŞicyToSŒšg
();

1644 
»disMemOv”h—d
 *
	`g‘MemÜyOv”h—dD©a
();

1645 
	`ä“MemÜyOv”h—dD©a
(
»disMemOv”h—d
 *
mh
);

1647 
	#RESTART_SERVER_NONE
 0

	)

1648 
	#RESTART_SERVER_GRACEFULLY
 (1<<0è

	)

1649 
	#RESTART_SERVER_CONFIG_REWRITE
 (1<<1è

	)

1650 
	`»¡¬tS”v”
(
æags
, 
m¡ime_t
 
d–ay
);

1653 
robj
 *
	`£tTy³C»©e
(
sds
 
v®ue
);

1654 
	`£tTy³Add
(
robj
 *
subjeù
, 
sds
 
v®ue
);

1655 
	`£tTy³Remove
(
robj
 *
subjeù
, 
sds
 
v®ue
);

1656 
	`£tTy³IsMemb”
(
robj
 *
subjeù
, 
sds
 
v®ue
);

1657 
£tTy³I‹¿tÜ
 *
	`£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

1658 
	`£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
);

1659 
	`£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
);

1660 
sds
 
	`£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
);

1661 
	`£tTy³RªdomEËm’t
(
robj
 *
£tobj
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
);

1662 
	`£tTy³RªdomEËm’ts
(
robj
 *
£t
, 
couÁ
,„obj *
aux_£t
);

1663 
	`£tTy³Size
(cÚ¡ 
robj
 *
subjeù
);

1664 
	`£tTy³CÚv”t
(
robj
 *
subjeù
, 
’c
);

1667 
	#HASH_SET_TAKE_FIELD
 (1<<0)

	)

1668 
	#HASH_SET_TAKE_VALUE
 (1<<1)

	)

1669 
	#HASH_SET_COPY
 0

	)

1671 
	`hashTy³CÚv”t
(
robj
 *
o
, 
’c
);

1672 
	`hashTy³TryCÚv”siÚ
(
robj
 *
subjeù
,„obj **
¬gv
, 
¡¬t
, 
’d
);

1673 
	`hashTy³TryObjeùEncodšg
(
robj
 *
subjeù
,„obj **
o1
,„obj **
o2
);

1674 
	`hashTy³Exi¡s
(
robj
 *
o
, 
sds
 
key
);

1675 
	`hashTy³D–‘e
(
robj
 *
o
, 
sds
 
key
);

1676 
	`hashTy³L’gth
(cÚ¡ 
robj
 *
o
);

1677 
hashTy³I‹¿tÜ
 *
	`hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

1678 
	`hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
);

1679 
	`hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
);

1680 
	`hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
,

1681 **
v¡r
,

1682 *
vËn
,

1683 *
vÎ
);

1684 
sds
 
	`hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
);

1685 
	`hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, **
v¡r
, *
vËn
, *
vÎ
);

1686 
sds
 
	`hashTy³Cu¼’tObjeùNewSds
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
);

1687 
robj
 *
	`hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
,„obj *
key
);

1688 
robj
 *
	`hashTy³G‘V®ueObjeù
Ôobj *
o
, 
sds
 
f›ld
);

1689 
	`hashTy³S‘
(
robj
 *
o
, 
sds
 
f›ld
, sd 
v®ue
, 
æags
);

1692 
	`pubsubUnsubsüibeAÎChªÃls
(
ş›Á
 *
c
, 
nÙify
);

1693 
	`pubsubUnsubsüibeAÎP©‹ºs
(
ş›Á
 *
c
, 
nÙify
);

1694 
	`ä“PubsubP©‹º
(*
p
);

1695 
	`li¡M©chPubsubP©‹º
(*
a
, *
b
);

1696 
	`pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
);

1699 
	`nÙifyKey¥aûEv’t
(
ty³
, *
ev’t
, 
robj
 *
key
, 
dbid
);

1700 
	`key¥aûEv’tsSŒšgToFÏgs
(*
şas£s
);

1701 
sds
 
	`key¥aûEv’tsFÏgsToSŒšg
(
æags
);

1704 
	`lßdS”v”CÚfig
(*
f’ame
, *
İtiÚs
);

1705 
	`­³ndS”v”SaveP¬ams
(
time_t
 
£cÚds
, 
chªges
);

1706 
	`»£tS”v”SaveP¬ams
();

1707 
»wr™eCÚfigS‹
;

1708 
	`»wr™eCÚfigRewr™eLše
(
»wr™eCÚfigS‹
 *
¡©e
, cÚ¡ *
İtiÚ
, 
sds
 
lše
, 
fÜû
);

1709 
	`»wr™eCÚfig
(*
·th
);

1712 
	`»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

1713 
	`´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
Ïzy
);

1714 
	`expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
);

1715 
	`g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
);

1716 
	`£tExpœe
(
ş›Á
 *
c
, 
»disDb
 *
db
, 
robj
 *
key
, 
wh’
);

1717 
robj
 *
	`lookupKey
(
»disDb
 *
db
,„obj *
key
, 
æags
);

1718 
robj
 *
	`lookupKeyR—d
(
»disDb
 *
db
,„obj *
key
);

1719 
robj
 *
	`lookupKeyWr™e
(
»disDb
 *
db
,„obj *
key
);

1720 
robj
 *
	`lookupKeyR—dOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

1721 
robj
 *
	`lookupKeyWr™eOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

1722 
robj
 *
	`lookupKeyR—dW™hFÏgs
(
»disDb
 *
db
,„obj *
key
, 
æags
);

1723 
robj
 *
	`objeùCommªdLookup
(
ş›Á
 *
c
,„obj *
key
);

1724 
robj
 *
	`objeùCommªdLookupOrR•ly
(
ş›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

1725 
	#LOOKUP_NONE
 0

	)

1726 
	#LOOKUP_NOTOUCH
 (1<<0)

	)

1727 
	`dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1728 
	`dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1729 
	`£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1730 
	`dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
);

1731 
robj
 *
	`dbRªdomKey
(
»disDb
 *
db
);

1732 
	`dbSyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

1733 
	`dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

1734 
robj
 *
	`dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
,„obj *
key
,„obj *
o
);

1736 
	#EMPTYDB_NO_FLAGS
 0

	)

1737 
	#EMPTYDB_ASYNC
 (1<<0è

	)

1738 
	`em±yDb
(
dbnum
, 
æags
, (
ÿÎback
)(*));

1740 
	`£ËùDb
(
ş›Á
 *
c
, 
id
);

1741 
	`sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
);

1742 
	`sigÇlFlushedDb
(
dbid
);

1743 
	`g‘KeysInSlÙ
(
hash¦Ù
, 
robj
 **
keys
, 
couÁ
);

1744 
	`couÁKeysInSlÙ
(
hash¦Ù
);

1745 
	`d–KeysInSlÙ
(
hash¦Ù
);

1746 
	`v”ifyClu¡”CÚfigW™hD©a
();

1747 
	`sÿnG’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
o
, 
cursÜ
);

1748 
	`·r£SÿnCursÜOrR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, *
cursÜ
);

1749 
	`¦ÙToKeyAdd
(
robj
 *
key
);

1750 
	`¦ÙToKeyD–
(
robj
 *
key
);

1751 
	`¦ÙToKeyFlush
();

1752 
	`dbAsyncD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

1753 
	`em±yDbAsync
(
»disDb
 *
db
);

1754 
	`¦ÙToKeyFlushAsync
();

1755 
size_t
 
	`Ïzyä“G‘P’dšgObjeùsCouÁ
();

1758 *
	`g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1759 
	`g‘KeysF»eResuÉ
(*
»suÉ
);

1760 *
	`zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1761 *
	`ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1762 *
	`sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1763 *
	`mig¿‹G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1764 *
	`geÜadiusG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1767 
	`şu¡”In™
();

1768 
	`üc16
(cÚ¡ *
buf
, 
Ën
);

1769 
	`keyHashSlÙ
(*
key
, 
keyËn
);

1770 
	`şu¡”CrÚ
();

1771 
	`şu¡”Prİag©ePublish
(
robj
 *
chªÃl
,„obj *
mes§ge
);

1772 
	`mig¿‹Clo£TimedoutSock‘s
();

1773 
	`şu¡”BefÜeSË•
();

1776 
	`š™S’tš–CÚfig
();

1777 
	`š™S’tš–
();

1778 
	`£Áš–Tim”
();

1779 *
	`£Áš–HªdËCÚfigu¿tiÚ
(**
¬gv
, 
¬gc
);

1780 
	`£Áš–IsRuÂšg
();

1783 
	`»dis_check_rdb
(*
rdbf’ame
, 
FILE
 *
å
);

1784 
	`»dis_check_rdb_maš
(
¬gc
, **
¬gv
, 
FILE
 *
å
);

1785 
	`»dis_check_aof_maš
(
¬gc
, **
¬gv
);

1788 
	`sütšgIn™
(
£tup
);

1789 
	`ldbRemoveChd
(
pid_t
 
pid
);

1790 
	`ldbKlFÜkedSessiÚs
();

1791 
	`ldbP’dšgChd»n
();

1792 
sds
 
	`luaC»©eFunùiÚ
(
ş›Á
 *
c
, 
lua_S‹
 *
lua
, 
robj
 *
body
);

1795 
	`´oûssUnblockedCl›Ás
();

1796 
	`blockCl›Á
(
ş›Á
 *
c
, 
bty³
);

1797 
	`unblockCl›Á
(
ş›Á
 *
c
);

1798 
	`»¶yToBlockedCl›ÁTimedOut
(
ş›Á
 *
c
);

1799 
	`g‘TimeoutFromObjeùOrR•ly
(
ş›Á
 *
c
, 
robj
 *
objeù
, 
m¡ime_t
 *
timeout
, 
un™
);

1800 
	`discÚÃùAÎBlockedCl›Ás
();

1803 
	`aùiveExpœeCyşe
(
ty³
);

1804 
	`expœeSÏveKeys
();

1805 
	`»memb”SÏveKeyW™hExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

1806 
	`æushSÏveKeysW™hExpœeLi¡
();

1807 
size_t
 
	`g‘SÏveKeyW™hExpœeCouÁ
();

1810 
	`eviùiÚPoŞAÎoc
();

1811 
	#LFU_INIT_VAL
 5

	)

1812 
	`LFUG‘TimeInMšu‹s
();

1813 
ušt8_t
 
	`LFULogInü
(ušt8_ˆ
v®ue
);

1814 
	`LFUDeüAndR‘uº
(
robj
 *
o
);

1817 
ušt64_t
 
	`diùSdsHash
(cÚ¡ *
key
);

1818 
	`diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

1819 
	`diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
);

1822 *
	`»disG™SHA1
();

1823 *
	`»disG™Dœty
();

1824 
ušt64_t
 
	`»disBudId
();

1827 
	`authCommªd
(
ş›Á
 *
c
);

1828 
	`pšgCommªd
(
ş›Á
 *
c
);

1829 
	`echoCommªd
(
ş›Á
 *
c
);

1830 
	`commªdCommªd
(
ş›Á
 *
c
);

1831 
	`£tCommªd
(
ş›Á
 *
c
);

1832 
	`£ŠxCommªd
(
ş›Á
 *
c
);

1833 
	`£‹xCommªd
(
ş›Á
 *
c
);

1834 
	`p£‹xCommªd
(
ş›Á
 *
c
);

1835 
	`g‘Commªd
(
ş›Á
 *
c
);

1836 
	`d–Commªd
(
ş›Á
 *
c
);

1837 
	`uÆškCommªd
(
ş›Á
 *
c
);

1838 
	`exi¡sCommªd
(
ş›Á
 *
c
);

1839 
	`£tb™Commªd
(
ş›Á
 *
c
);

1840 
	`g‘b™Commªd
(
ş›Á
 *
c
);

1841 
	`b™f›ldCommªd
(
ş›Á
 *
c
);

1842 
	`£ŒªgeCommªd
(
ş›Á
 *
c
);

1843 
	`g‘¿ngeCommªd
(
ş›Á
 *
c
);

1844 
	`šüCommªd
(
ş›Á
 *
c
);

1845 
	`deüCommªd
(
ş›Á
 *
c
);

1846 
	`šübyCommªd
(
ş›Á
 *
c
);

1847 
	`deübyCommªd
(
ş›Á
 *
c
);

1848 
	`šübyæßtCommªd
(
ş›Á
 *
c
);

1849 
	`£ËùCommªd
(
ş›Á
 *
c
);

1850 
	`sw­dbCommªd
(
ş›Á
 *
c
);

1851 
	`¿ndomkeyCommªd
(
ş›Á
 *
c
);

1852 
	`keysCommªd
(
ş›Á
 *
c
);

1853 
	`sÿnCommªd
(
ş›Á
 *
c
);

1854 
	`dbsizeCommªd
(
ş›Á
 *
c
);

1855 
	`Ï¡§veCommªd
(
ş›Á
 *
c
);

1856 
	`§veCommªd
(
ş›Á
 *
c
);

1857 
	`bg§veCommªd
(
ş›Á
 *
c
);

1858 
	`bg»wr™—ofCommªd
(
ş›Á
 *
c
);

1859 
	`shutdownCommªd
(
ş›Á
 *
c
);

1860 
	`moveCommªd
(
ş›Á
 *
c
);

1861 
	`»ÇmeCommªd
(
ş›Á
 *
c
);

1862 
	`»Çm’xCommªd
(
ş›Á
 *
c
);

1863 
	`ÍushCommªd
(
ş›Á
 *
c
);

1864 
	`½ushCommªd
(
ş›Á
 *
c
);

1865 
	`ÍushxCommªd
(
ş›Á
 *
c
);

1866 
	`½ushxCommªd
(
ş›Á
 *
c
);

1867 
	`lš£¹Commªd
(
ş›Á
 *
c
);

1868 
	`ÍİCommªd
(
ş›Á
 *
c
);

1869 
	`½İCommªd
(
ş›Á
 *
c
);

1870 
	`Î’Commªd
(
ş›Á
 *
c
);

1871 
	`lšdexCommªd
(
ş›Á
 *
c
);

1872 
	`ÌªgeCommªd
(
ş›Á
 *
c
);

1873 
	`ÉrimCommªd
(
ş›Á
 *
c
);

1874 
	`ty³Commªd
(
ş›Á
 *
c
);

1875 
	`l£tCommªd
(
ş›Á
 *
c
);

1876 
	`§ddCommªd
(
ş›Á
 *
c
);

1877 
	`¤emCommªd
(
ş›Á
 *
c
);

1878 
	`smoveCommªd
(
ş›Á
 *
c
);

1879 
	`sismemb”Commªd
(
ş›Á
 *
c
);

1880 
	`sÿrdCommªd
(
ş›Á
 *
c
);

1881 
	`¥İCommªd
(
ş›Á
 *
c
);

1882 
	`¤ªdmemb”Commªd
(
ş›Á
 *
c
);

1883 
	`sš‹rCommªd
(
ş›Á
 *
c
);

1884 
	`sš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

1885 
	`suniÚCommªd
(
ş›Á
 *
c
);

1886 
	`suniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

1887 
	`sdiffCommªd
(
ş›Á
 *
c
);

1888 
	`sdiff¡ÜeCommªd
(
ş›Á
 *
c
);

1889 
	`ssÿnCommªd
(
ş›Á
 *
c
);

1890 
	`syncCommªd
(
ş›Á
 *
c
);

1891 
	`æushdbCommªd
(
ş›Á
 *
c
);

1892 
	`æush®lCommªd
(
ş›Á
 *
c
);

1893 
	`sÜtCommªd
(
ş›Á
 *
c
);

1894 
	`ÌemCommªd
(
ş›Á
 *
c
);

1895 
	`½İÍushCommªd
(
ş›Á
 *
c
);

1896 
	`šfoCommªd
(
ş›Á
 *
c
);

1897 
	`mg‘Commªd
(
ş›Á
 *
c
);

1898 
	`mÚ™ÜCommªd
(
ş›Á
 *
c
);

1899 
	`expœeCommªd
(
ş›Á
 *
c
);

1900 
	`expœ—tCommªd
(
ş›Á
 *
c
);

1901 
	`³xpœeCommªd
(
ş›Á
 *
c
);

1902 
	`³xpœ—tCommªd
(
ş›Á
 *
c
);

1903 
	`g‘£tCommªd
(
ş›Á
 *
c
);

1904 
	`‰lCommªd
(
ş›Á
 *
c
);

1905 
	`touchCommªd
(
ş›Á
 *
c
);

1906 
	`±Commªd
(
ş›Á
 *
c
);

1907 
	`³rsi¡Commªd
(
ş›Á
 *
c
);

1908 
	`¦aveofCommªd
(
ş›Á
 *
c
);

1909 
	`rŞeCommªd
(
ş›Á
 *
c
);

1910 
	`debugCommªd
(
ş›Á
 *
c
);

1911 
	`m£tCommªd
(
ş›Á
 *
c
);

1912 
	`m£ŠxCommªd
(
ş›Á
 *
c
);

1913 
	`zaddCommªd
(
ş›Á
 *
c
);

1914 
	`zšübyCommªd
(
ş›Á
 *
c
);

1915 
	`z¿ngeCommªd
(
ş›Á
 *
c
);

1916 
	`z¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

1917 
	`z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

1918 
	`z¿ngebyËxCommªd
(
ş›Á
 *
c
);

1919 
	`z»v¿ngebyËxCommªd
(
ş›Á
 *
c
);

1920 
	`zcouÁCommªd
(
ş›Á
 *
c
);

1921 
	`zËxcouÁCommªd
(
ş›Á
 *
c
);

1922 
	`z»v¿ngeCommªd
(
ş›Á
 *
c
);

1923 
	`zÿrdCommªd
(
ş›Á
 *
c
);

1924 
	`z»mCommªd
(
ş›Á
 *
c
);

1925 
	`zscÜeCommªd
(
ş›Á
 *
c
);

1926 
	`z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
);

1927 
	`z»m¿ngebyËxCommªd
(
ş›Á
 *
c
);

1928 
	`muÉiCommªd
(
ş›Á
 *
c
);

1929 
	`execCommªd
(
ş›Á
 *
c
);

1930 
	`disÿrdCommªd
(
ş›Á
 *
c
);

1931 
	`bÍİCommªd
(
ş›Á
 *
c
);

1932 
	`b½İCommªd
(
ş›Á
 *
c
);

1933 
	`b½İÍushCommªd
(
ş›Á
 *
c
);

1934 
	`­³ndCommªd
(
ş›Á
 *
c
);

1935 
	`¡¾’Commªd
(
ş›Á
 *
c
);

1936 
	`z¿nkCommªd
(
ş›Á
 *
c
);

1937 
	`z»v¿nkCommªd
(
ş›Á
 *
c
);

1938 
	`h£tCommªd
(
ş›Á
 *
c
);

1939 
	`h£ŠxCommªd
(
ş›Á
 *
c
);

1940 
	`hg‘Commªd
(
ş›Á
 *
c
);

1941 
	`hm£tCommªd
(
ş›Á
 *
c
);

1942 
	`hmg‘Commªd
(
ş›Á
 *
c
);

1943 
	`hd–Commªd
(
ş›Á
 *
c
);

1944 
	`hËnCommªd
(
ş›Á
 *
c
);

1945 
	`h¡¾’Commªd
(
ş›Á
 *
c
);

1946 
	`z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
);

1947 
	`zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
);

1948 
	`zš‹r¡ÜeCommªd
(
ş›Á
 *
c
);

1949 
	`zsÿnCommªd
(
ş›Á
 *
c
);

1950 
	`hkeysCommªd
(
ş›Á
 *
c
);

1951 
	`hv®sCommªd
(
ş›Á
 *
c
);

1952 
	`hg‘®lCommªd
(
ş›Á
 *
c
);

1953 
	`hexi¡sCommªd
(
ş›Á
 *
c
);

1954 
	`hsÿnCommªd
(
ş›Á
 *
c
);

1955 
	`cÚfigCommªd
(
ş›Á
 *
c
);

1956 
	`hšübyCommªd
(
ş›Á
 *
c
);

1957 
	`hšübyæßtCommªd
(
ş›Á
 *
c
);

1958 
	`subsüibeCommªd
(
ş›Á
 *
c
);

1959 
	`unsubsüibeCommªd
(
ş›Á
 *
c
);

1960 
	`psubsüibeCommªd
(
ş›Á
 *
c
);

1961 
	`punsubsüibeCommªd
(
ş›Á
 *
c
);

1962 
	`publishCommªd
(
ş›Á
 *
c
);

1963 
	`pubsubCommªd
(
ş›Á
 *
c
);

1964 
	`w©chCommªd
(
ş›Á
 *
c
);

1965 
	`unw©chCommªd
(
ş›Á
 *
c
);

1966 
	`şu¡”Commªd
(
ş›Á
 *
c
);

1967 
	`»¡ÜeCommªd
(
ş›Á
 *
c
);

1968 
	`mig¿‹Commªd
(
ş›Á
 *
c
);

1969 
	`askšgCommªd
(
ş›Á
 *
c
);

1970 
	`»adÚlyCommªd
(
ş›Á
 *
c
);

1971 
	`»adwr™eCommªd
(
ş›Á
 *
c
);

1972 
	`dumpCommªd
(
ş›Á
 *
c
);

1973 
	`objeùCommªd
(
ş›Á
 *
c
);

1974 
	`memÜyCommªd
(
ş›Á
 *
c
);

1975 
	`ş›ÁCommªd
(
ş›Á
 *
c
);

1976 
	`ev®Commªd
(
ş›Á
 *
c
);

1977 
	`ev®ShaCommªd
(
ş›Á
 *
c
);

1978 
	`sütCommªd
(
ş›Á
 *
c
);

1979 
	`timeCommªd
(
ş›Á
 *
c
);

1980 
	`b™İCommªd
(
ş›Á
 *
c
);

1981 
	`b™couÁCommªd
(
ş›Á
 *
c
);

1982 
	`b™posCommªd
(
ş›Á
 *
c
);

1983 
	`»¶cÚfCommªd
(
ş›Á
 *
c
);

1984 
	`wa™Commªd
(
ş›Á
 *
c
);

1985 
	`geÛncodeCommªd
(
ş›Á
 *
c
);

1986 
	`geodecodeCommªd
(
ş›Á
 *
c
);

1987 
	`geÜadiusbymemb”Commªd
(
ş›Á
 *
c
);

1988 
	`geÜadiusbymemb”roCommªd
(
ş›Á
 *
c
);

1989 
	`geÜadiusCommªd
(
ş›Á
 *
c
);

1990 
	`geÜadiu¤oCommªd
(
ş›Á
 *
c
);

1991 
	`geßddCommªd
(
ş›Á
 *
c
);

1992 
	`geohashCommªd
(
ş›Á
 *
c
);

1993 
	`geİosCommªd
(
ş›Á
 *
c
);

1994 
	`geodi¡Commªd
(
ş›Á
 *
c
);

1995 
	`pf£láe¡Commªd
(
ş›Á
 *
c
);

1996 
	`pçddCommªd
(
ş›Á
 *
c
);

1997 
	`pfcouÁCommªd
(
ş›Á
 *
c
);

1998 
	`pfm”geCommªd
(
ş›Á
 *
c
);

1999 
	`pfdebugCommªd
(
ş›Á
 *
c
);

2000 
	`Ï‹ncyCommªd
(
ş›Á
 *
c
);

2001 
	`moduËCommªd
(
ş›Á
 *
c
);

2002 
	`£cur™yW¬nšgCommªd
(
ş›Á
 *
c
);

2004 #ià
	`defšed
(
__GNUC__
)

2005 *
	$ÿÎoc
(
size_t
 
couÁ
, size_ˆ
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

2006 
	$ä“
(*
±r
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

2007 *
	$m®loc
(
size_t
 
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

2008 *
	$»®loc
(*
±r
, 
size_t
 
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

2012 
	`_£rv”As£¹W™hInfo
(cÚ¡ 
ş›Á
 *
c
, cÚ¡ 
robj
 *
o
, cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
);

2013 
	`_£rv”As£¹
(cÚ¡ *
e¡r
, cÚ¡ *
fe
, 
lše
);

2014 
	`_£rv”Pªic
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
msg
, ...);

2015 
	`bugR•ÜtS¹
();

2016 
	`£rv”LogObjeùDebugInfo
(cÚ¡ 
robj
 *
o
);

2017 
	`sig£gvHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
);

2018 
sds
 
	`g’RedisInfoSŒšg
(*
£ùiÚ
);

2019 
	`’abËW©chdog
(
³riod
);

2020 
	`di§bËW©chdog
();

2021 
	`w©chdogScheduËSigÇl
(
³riod
);

2022 
	`£rv”LogHexDump
(
Ëv–
, *
desü
, *
v®ue
, 
size_t
 
Ën
);

2023 
	`mem‹¡_´e£rvšg_‹¡
(*
m
, 
size_t
 
by‹s
, 
·s£s
);

2024 
	`mixDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
);

2025 
	`xÜDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
);

2027 
	#»disDebug
(
fmt
, ...) \

2028 
	`´štf
("DEBUG %s:%d > " 
fmt
 "\n", 
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

2029 
	#»disDebugM¬k
() \

2030 
	`´štf
("-- MARK %s:%d --\n", 
__FILE__
, 
__LINE__
)

	)

	@src/setproctitle.c

28 #iâdeà
_GNU_SOURCE


29 
	#_GNU_SOURCE


	)

32 
	~<¡ddef.h
>

33 
	~<¡d¬g.h
>

34 
	~<¡dlib.h
>

35 
	~<¡dio.h
>

37 
	~<¡ršg.h
>

39 
	~<”ºo.h
>

41 #ià!
defšed
(
HAVE_SETPROCTITLE
)

42 #ià(
defšed
 
__N‘BSD__
 || defšed 
__F»eBSD__
 || defšed 
__O³nBSD__
)

43 
	#HAVE_SETPROCTITLE
 1

	)

45 
	#HAVE_SETPROCTITLE
 0

	)

50 #ià!
HAVE_SETPROCTITLE


51 #ià(
defšed
 
__lšux
 || defšed 
__APPLE__
)

53 **
’vœÚ
;

57 cÚ¡ *
	m¬g0
;

60 *
	mba£
, *
	m’d
;

63 *
	mnul
;

65 
_BoŞ
 
	m»£t
;

66 
	m”rÜ
;

67 } 
	gSPT
;

70 #iâdeà
SPT_MIN


71 
	#SPT_MIN
(
a
, 
b
è((×è< (b))? (aè: (b))

	)

74 
šlše
 
size_t
 
	$¥t_mš
(
size_t
 
a
, size_ˆ
b
) {

75  
	`SPT_MIN
(
a
, 
b
);

76 
	}
}

83 
	$¥t_ş—»nv
() {

84 #ià
__GLIBC__


85 
	`ş—»nv
();

89 **
’vœÚ
;

90 **
tmp
;

92 ià(!(
tmp
 = 
	`m®loc
( *tmp)))

93  
”ºo
;

95 
tmp
[0] = 
NULL
;

96 
’vœÚ
 = 
tmp
;

100 
	}
}

103 
	$¥t_cİy’v
(*
Şd’v
[]) {

104 **
’vœÚ
;

105 *
eq
;

106 
i
, 
”rÜ
;

108 ià(
’vœÚ
 !ğ
Şd’v
)

111 ià((
”rÜ
 = 
	`¥t_ş—»nv
()))

112 
”rÜ
;

114 
i
 = 0; 
Şd’v
[i]; i++) {

115 ià(!(
eq
 = 
	`¡rchr
(
Şd’v
[
i
], '=')))

118 *
eq
 = '\0';

119 
”rÜ
 = (0 !ğ
	`£‹nv
(
Şd’v
[
i
], 
eq
 + 1, 1))? 
”ºo
 : 0;

120 *
eq
 = '=';

122 ià(
”rÜ
)

123 
”rÜ
;

127 
”rÜ
:

128 
’vœÚ
 = 
Şd’v
;

130  
”rÜ
;

131 
	}
}

134 
	$¥t_cİy¬gs
(
¬gc
, *
¬gv
[]) {

135 *
tmp
;

136 
i
;

138 
i
 = 1; i < 
¬gc
 || (˜>ğ¬gø&& 
¬gv
[i]); i++) {

139 ià(!
¬gv
[
i
])

142 ià(!(
tmp
 = 
	`¡rdup
(
¬gv
[
i
])))

143  
”ºo
;

145 
¬gv
[
i
] = 
tmp
;

149 
	}
}

152 
	$¥t_š™
(
¬gc
, *
¬gv
[]) {

153 **
’vp
 = 
’vœÚ
;

154 *
ba£
, *
’d
, *
nul
, *
tmp
;

155 
i
, 
”rÜ
;

157 ià(!(
ba£
 = 
¬gv
[0]))

160 
nul
 = &
ba£
[
	`¡¾’
(base)];

161 
’d
 = 
nul
 + 1;

163 
i
 = 0; i < 
¬gc
 || (˜>ğ¬gø&& 
¬gv
[i]); i++) {

164 ià(!
¬gv
[
i
] ||‡rgv[i] < 
’d
)

167 
’d
 = 
¬gv
[
i
] + 
	`¡¾’
(argv[i]) + 1;

170 
i
 = 0; 
’vp
[i]; i++) {

171 ià(
’vp
[
i
] < 
’d
)

174 
’d
 = 
’vp
[
i
] + 
	`¡¾’
(envp[i]) + 1;

177 ià(!(
SPT
.
¬g0
 = 
	`¡rdup
(
¬gv
[0])))

178 
sy”r
;

180 #ià
__GLIBC__


181 ià(!(
tmp
 = 
	`¡rdup
(
´og¿m_švoÿtiÚ_Çme
)))

182 
sy”r
;

184 
´og¿m_švoÿtiÚ_Çme
 = 
tmp
;

186 ià(!(
tmp
 = 
	`¡rdup
(
´og¿m_švoÿtiÚ_shÜt_Çme
)))

187 
sy”r
;

189 
´og¿m_švoÿtiÚ_shÜt_Çme
 = 
tmp
;

190 #–ià
__APPLE__


191 ià(!(
tmp
 = 
	`¡rdup
(
	`g‘´ogÇme
())))

192 
sy”r
;

194 
	`£rogÇme
(
tmp
);

198 ià((
”rÜ
 = 
	`¥t_cİy’v
(
’vp
)))

199 
”rÜ
;

201 ià((
”rÜ
 = 
	`¥t_cİy¬gs
(
¬gc
, 
¬gv
)))

202 
”rÜ
;

204 
SPT
.
nul
 =‚ul;

205 
SPT
.
ba£
 = base;

206 
SPT
.
’d
 =ƒnd;

209 
sy”r
:

210 
”rÜ
 = 
”ºo
;

211 
”rÜ
:

212 
SPT
.
”rÜ
 =ƒrror;

213 
	}
}

216 #iâdeà
SPT_MAXTITLE


217 
	#SPT_MAXTITLE
 255

	)

220 
	$£roù™Ë
(cÚ¡ *
fmt
, ...) {

221 
buf
[
SPT_MAXTITLE
 + 1];

222 
va_li¡
 
­
;

223 *
nul
;

224 
Ën
, 
”rÜ
;

226 ià(!
SPT
.
ba£
)

229 ià(
fmt
) {

230 
	`va_¡¬t
(
­
, 
fmt
);

231 
Ën
 = 
	`v¢´štf
(
buf
,  buf, 
fmt
, 
­
);

232 
	`va_’d
(
­
);

234 
Ën
 = 
	`¢´štf
(
buf
,  buf, "%s", 
SPT
.
¬g0
);

237 ià(
Ën
 <= 0)

238 { 
”rÜ
 = 
”ºo
; error; }

240 ià(!
SPT
.
»£t
) {

241 
	`mem£t
(
SPT
.
ba£
, 0, SPT.
’d
 - SPT.base);

242 
SPT
.
»£t
 = 1;

244 
	`mem£t
(
SPT
.
ba£
, 0, 
	`¥t_mš
( 
buf
, SPT.
’d
 - SPT.base));

247 
Ën
 = 
	`¥t_mš
Ö’, s±_mš( 
buf
, 
SPT
.
’d
 - SPT.
ba£
) - 1);

248 
	`memıy
(
SPT
.
ba£
, 
buf
, 
Ën
);

249 
nul
 = &
SPT
.
ba£
[
Ën
];

251 ià(
nul
 < 
SPT
.nul) {

252 *
SPT
.
nul
 = '.';

253 } ià(
nul
 =ğ
SPT
.nuÈ&& &nul[1] < SPT.
’d
) {

254 *
SPT
.
nul
 = ' ';

255 *++
nul
 = '\0';

259 
”rÜ
:

260 
SPT
.
”rÜ
 =ƒrror;

261 
	}
}

	@src/sha1.c

22 
	#SHA1HANDSOFF


	)

24 
	~<¡dio.h
>

25 
	~<¡ršg.h
>

26 
	~<¡dšt.h
>

27 
	~"sŞ¬isfixes.h
"

28 
	~"sha1.h
"

29 
	~"cÚfig.h
"

31 
	#rŞ
(
v®ue
, 
b™s
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

35 #ià
BYTE_ORDER
 =ğ
LITTLE_ENDIAN


36 
	#blk0
(
i
è(
block
->
l
[i] = (
	`rŞ
(block->l[i],24)&0xFF00FF00) \

37 |(
	`rŞ
(
block
->
l
[
i
],8)&0x00FF00FF))

	)

38 #–ià
BYTE_ORDER
 =ğ
BIG_ENDIAN


39 
	#blk0
(
i
è
block
->
l
[i]

	)

43 
	#blk
(
i
è(
block
->
l
[i&15] = 
	`rŞ
(block->l[(i+13)&15]^block->l[(i+8)&15] \

44 ^
block
->
l
[(
i
+2)&15]^block->l[i&15],1))

	)

47 
	#R0
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk0
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

48 
	#R1
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

49 
	#R2
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0x6ED9EBA1+
	`rŞ
(v,5);wôŞ(w,30);

	)

50 
	#R3
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(((w|x)&y)|(w&x))+
	`blk
(i)+0x8F1BBCDC+
	`rŞ
(v,5);wôŞ(w,30);

	)

51 
	#R4
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0xCA62C1D6+
	`rŞ
(v,5);wôŞ(w,30);

	)

56 
	$SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64])

58 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
e
;

60 
c
[64];

61 
ušt32_t
 
l
[16];

62 } 
	tCHAR64LONG16
;

63 #ifdeà
SHA1HANDSOFF


64 
CHAR64LONG16
 
block
[1];

65 
	`memıy
(
block
, 
bufãr
, 64);

72 
CHAR64LONG16
* 
block
 = (cÚ¡ CHAR64LONG16*)
bufãr
;

75 
a
 = 
¡©e
[0];

76 
b
 = 
¡©e
[1];

77 
c
 = 
¡©e
[2];

78 
d
 = 
¡©e
[3];

79 
e
 = 
¡©e
[4];

81 
	`R0
(
a
,
b
,
c
,
d
,
e
, 0); R0(e,a,b,c,d, 1); R0(d,e,a,b,c, 2); R0(c,d,e,a,b, 3);

82 
	`R0
(
b
,
c
,
d
,
e
,
a
, 4); R0(a,b,c,d,e, 5); R0(e,a,b,c,d, 6); R0(d,e,a,b,c, 7);

83 
	`R0
(
c
,
d
,
e
,
a
,
b
, 8); R0(b,c,d,e,a, 9); R0(a,b,c,d,e,10); R0(e,a,b,c,d,11);

84 
	`R0
(
d
,
e
,
a
,
b
,
c
,12); R0(c,d,e,a,b,13); R0(b,c,d,e,a,14); R0(a,b,c,d,e,15);

85 
	`R1
(
e
,
a
,
b
,
c
,
d
,16); R1(d,e,a,b,c,17); R1(c,d,e,a,b,18); R1(b,c,d,e,a,19);

86 
	`R2
(
a
,
b
,
c
,
d
,
e
,20); R2(e,a,b,c,d,21); R2(d,e,a,b,c,22); R2(c,d,e,a,b,23);

87 
	`R2
(
b
,
c
,
d
,
e
,
a
,24); R2(a,b,c,d,e,25); R2(e,a,b,c,d,26); R2(d,e,a,b,c,27);

88 
	`R2
(
c
,
d
,
e
,
a
,
b
,28); R2(b,c,d,e,a,29); R2(a,b,c,d,e,30); R2(e,a,b,c,d,31);

89 
	`R2
(
d
,
e
,
a
,
b
,
c
,32); R2(c,d,e,a,b,33); R2(b,c,d,e,a,34); R2(a,b,c,d,e,35);

90 
	`R2
(
e
,
a
,
b
,
c
,
d
,36); R2(d,e,a,b,c,37); R2(c,d,e,a,b,38); R2(b,c,d,e,a,39);

91 
	`R3
(
a
,
b
,
c
,
d
,
e
,40); R3(e,a,b,c,d,41); R3(d,e,a,b,c,42); R3(c,d,e,a,b,43);

92 
	`R3
(
b
,
c
,
d
,
e
,
a
,44); R3(a,b,c,d,e,45); R3(e,a,b,c,d,46); R3(d,e,a,b,c,47);

93 
	`R3
(
c
,
d
,
e
,
a
,
b
,48); R3(b,c,d,e,a,49); R3(a,b,c,d,e,50); R3(e,a,b,c,d,51);

94 
	`R3
(
d
,
e
,
a
,
b
,
c
,52); R3(c,d,e,a,b,53); R3(b,c,d,e,a,54); R3(a,b,c,d,e,55);

95 
	`R3
(
e
,
a
,
b
,
c
,
d
,56); R3(d,e,a,b,c,57); R3(c,d,e,a,b,58); R3(b,c,d,e,a,59);

96 
	`R4
(
a
,
b
,
c
,
d
,
e
,60); R4(e,a,b,c,d,61); R4(d,e,a,b,c,62); R4(c,d,e,a,b,63);

97 
	`R4
(
b
,
c
,
d
,
e
,
a
,64); R4(a,b,c,d,e,65); R4(e,a,b,c,d,66); R4(d,e,a,b,c,67);

98 
	`R4
(
c
,
d
,
e
,
a
,
b
,68); R4(b,c,d,e,a,69); R4(a,b,c,d,e,70); R4(e,a,b,c,d,71);

99 
	`R4
(
d
,
e
,
a
,
b
,
c
,72); R4(c,d,e,a,b,73); R4(b,c,d,e,a,74); R4(a,b,c,d,e,75);

100 
	`R4
(
e
,
a
,
b
,
c
,
d
,76); R4(d,e,a,b,c,77); R4(c,d,e,a,b,78); R4(b,c,d,e,a,79);

102 
¡©e
[0] +ğ
a
;

103 
¡©e
[1] +ğ
b
;

104 
¡©e
[2] +ğ
c
;

105 
¡©e
[3] +ğ
d
;

106 
¡©e
[4] +ğ
e
;

108 
a
 = 
b
 = 
c
 = 
d
 = 
e
 = 0;

109 #ifdeà
SHA1HANDSOFF


110 
	`mem£t
(
block
, '\0', (block));

112 
	}
}

117 
	$SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
)

120 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

121 
cÚ‹xt
->
¡©e
[1] = 0xEFCDAB89;

122 
cÚ‹xt
->
¡©e
[2] = 0x98BADCFE;

123 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

124 
cÚ‹xt
->
¡©e
[4] = 0xC3D2E1F0;

125 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

126 
	}
}

131 
	$SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
)

133 
ušt32_t
 
i
, 
j
;

135 
j
 = 
cÚ‹xt
->
couÁ
[0];

136 ià((
cÚ‹xt
->
couÁ
[0] +ğ
Ën
 << 3è< 
j
)

137 
cÚ‹xt
->
couÁ
[1]++;

138 
cÚ‹xt
->
couÁ
[1] +ğ(
Ën
>>29);

139 
j
 = (j >> 3) & 63;

140 ià((
j
 + 
Ën
) > 63) {

141 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], 
d©a
, (
i
 = 64-j));

142 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

143  ; 
i
 + 63 < 
Ën
; i += 64) {

144 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, &
d©a
[
i
]);

146 
j
 = 0;

148 
i
 = 0;

149 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], &
d©a
[
i
], 
Ën
 - i);

150 
	}
}

155 
	$SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
)

157 
i
;

158 
fš®couÁ
[8];

159 
c
;

167 *
fı
 = &
fš®couÁ
[8];

169 
i
 = 0; i < 2; i++)

171 
ušt32_t
 
t
 = 
cÚ‹xt
->
couÁ
[
i
];

172 
j
;

174 
j
 = 0; j < 4; 
t
 >>= 8, j++)

175 *--
fı
 = (è
t
;

178 
i
 = 0; i < 8; i++) {

179 
fš®couÁ
[
i
] = ()((
cÚ‹xt
->
couÁ
[(i >= 4 ? 0 : 1)]

180 >> ((3-(
i
 & 3)) * 8) ) & 255);

183 
c
 = 0200;

184 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

185 (
cÚ‹xt
->
couÁ
[0] & 504) != 448) {

186 
c
 = 0000;

187 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

189 
	`SHA1Upd©e
(
cÚ‹xt
, 
fš®couÁ
, 8);

190 
i
 = 0; i < 20; i++) {

191 
dige¡
[
i
] = ()

192 ((
cÚ‹xt
->
¡©e
[
i
>>2] >> ((3-(i & 3)) * 8) ) & 255);

195 
	`mem£t
(
cÚ‹xt
, '\0', (*context));

196 
	`mem£t
(&
fš®couÁ
, '\0', (finalcount));

197 
	}
}

200 #ifdeà
REDIS_TEST


201 
	#BUFSIZE
 4096

	)

203 
	#UNUSED
(
x
è()(x)

	)

204 
	$sha1Te¡
(
¬gc
, **
¬gv
)

206 
SHA1_CTX
 
ùx
;

207 
hash
[20], 
buf
[
BUFSIZE
];

208 
i
;

210 
	`UNUSED
(
¬gc
);

211 
	`UNUSED
(
¬gv
);

213 
i
=0;i<
BUFSIZE
;i++)

214 
buf
[
i
] = i;

216 
	`SHA1In™
(&
ùx
);

217 
i
=0;i<1000;i++)

218 
	`SHA1Upd©e
(&
ùx
, 
buf
, 
BUFSIZE
);

219 
	`SHA1Fš®
(
hash
, &
ùx
);

221 
	`´štf
("SHA1=");

222 
i
=0;i<20;i++)

223 
	`´štf
("%02x", 
hash
[
i
]);

224 
	`´štf
("\n");

226 
	}
}

	@src/sha1.h

1 #iâdeà
SHA1_H


2 
	#SHA1_H


	)

11 
ušt32_t
 
	m¡©e
[5];

12 
ušt32_t
 
	mcouÁ
[2];

13 
	mbufãr
[64];

14 } 
	tSHA1_CTX
;

16 
SHA1T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64]);

17 
SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
);

18 
SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
ušt32_t
 
Ën
);

19 
SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
);

21 #ifdeà
REDIS_TEST


22 
sha1Te¡
(
¬gc
, **
¬gv
);

	@src/siphash.c

42 
	~<as£¹.h
>

43 
	~<¡dšt.h
>

44 
	~<¡dio.h
>

45 
	~<¡ršg.h
>

46 
	~<ùy³.h
>

50 
	$sw
(
c
) {

51 ià(
c
 >= 'A' && c <= 'Z') {

52  
c
+('a'-'A');

54  
c
;

56 
	}
}

61 #ià
defšed
(
__X86_64__
è|| defšed(
__x86_64__
è|| defšed (
__i386__
)

62 
	#UNALIGNED_LE_CPU


	)

65 
	#ROTL
(
x
, 
b
è(
ušt64_t
)(((xè<< (b)è| ((xè>> (64 - (b))))

	)

67 
	#U32TO8_LE
(
p
, 
v
) \

68 (
p
)[0] = (
ušt8_t
)((
v
)); \

69 (
p
)[1] = (
ušt8_t
)((
v
) >> 8); \

70 (
p
)[2] = (
ušt8_t
)((
v
) >> 16); \

71 (
p
)[3] = (
ušt8_t
)((
v
è>> 24);

	)

73 
	#U64TO8_LE
(
p
, 
v
) \

74 
	`U32TO8_LE
((
p
), (
ušt32_t
)((
v
))); \

75 
	`U32TO8_LE
((
p
è+ 4, (
ušt32_t
)((
v
è>> 32));

	)

77 #ifdeà
UNALIGNED_LE_CPU


78 
	#U8TO64_LE
(
p
è(*((
ušt64_t
*)Õ)))

	)

80 
	#U8TO64_LE
(
p
) \

81 (((
ušt64_t
)((
p
)[0])) | ((uint64_t)((p)[1]) << 8) | \

82 ((
ušt64_t
)((
p
)[2]) << 16) | ((uint64_t)((p)[3]) << 24) | \

83 ((
ušt64_t
)((
p
)[4]) << 32) | ((uint64_t)((p)[5]) << 40) | \

84 ((
ušt64_t
)((
p
)[6]è<< 48è| ((ušt64_t)(Õ)[7]è<< 56))

	)

87 
	#U8TO64_LE_NOCASE
(
p
) \

88 (((
ušt64_t
)(
	`sw
((
p
)[0]))) | \

89 ((
ušt64_t
)(
	`sw
((
p
)[1])) << 8) | \

90 ((
ušt64_t
)(
	`sw
((
p
)[2])) << 16) | \

91 ((
ušt64_t
)(
	`sw
((
p
)[3])) << 24) | \

92 ((
ušt64_t
)(
	`sw
((
p
)[4])) << 32) | \

93 ((
ušt64_t
)(
	`sw
((
p
)[5])) << 40) | \

94 ((
ušt64_t
)(
	`sw
((
p
)[6])) << 48) | \

95 ((
ušt64_t
)(
	`sw
((
p
)[7])è<< 56))

	)

97 
	#SIPROUND
 \

99 
v0
 +ğ
v1
; \

100 
v1
 = 
	`ROTL
(v1, 13); \

101 
v1
 ^ğ
v0
; \

102 
v0
 = 
	`ROTL
(v0, 32); \

103 
v2
 +ğ
v3
; \

104 
v3
 = 
	`ROTL
(v3, 16); \

105 
v3
 ^ğ
v2
; \

106 
v0
 +ğ
v3
; \

107 
v3
 = 
	`ROTL
(v3, 21); \

108 
v3
 ^ğ
v0
; \

109 
v2
 +ğ
v1
; \

110 
v1
 = 
	`ROTL
(v1, 17); \

111 
v1
 ^ğ
v2
; \

112 
v2
 = 
	`ROTL
(v2, 32); \

113 } 0)

	)

115 
ušt64_t
 
	$shash
(cÚ¡ 
ušt8_t
 *
š
, cÚ¡ 
size_t
 
šËn
, cÚ¡ ušt8_ˆ*
k
) {

116 #iâdeà
UNALIGNED_LE_CPU


117 
ušt64_t
 
hash
;

118 
ušt8_t
 *
out
 = (ušt8_t*è&
hash
;

120 
ušt64_t
 
v0
 = 0x736f6d6570736575ULL;

121 
ušt64_t
 
v1
 = 0x646f72616e646f6dULL;

122 
ušt64_t
 
v2
 = 0x6c7967656e657261ULL;

123 
ušt64_t
 
v3
 = 0x7465646279746573ULL;

124 
ušt64_t
 
k0
 = 
	`U8TO64_LE
(
k
);

125 
ušt64_t
 
k1
 = 
	`U8TO64_LE
(
k
 + 8);

126 
ušt64_t
 
m
;

127 cÚ¡ 
ušt8_t
 *
’d
 = 
š
 + 
šËn
 - (šËÀ% (
ušt64_t
));

128 cÚ¡ 
Ëá
 = 
šËn
 & 7;

129 
ušt64_t
 
b
 = ((ušt64_t)
šËn
) << 56;

130 
v3
 ^ğ
k1
;

131 
v2
 ^ğ
k0
;

132 
v1
 ^ğ
k1
;

133 
v0
 ^ğ
k0
;

135 ; 
š
 !ğ
’d
; in += 8) {

136 
m
 = 
	`U8TO64_LE
(
š
);

137 
v3
 ^ğ
m
;

139 
SIPROUND
;

141 
v0
 ^ğ
m
;

144 
Ëá
) {

145 7: 
b
 |ğ((
ušt64_t
)
š
[6]) << 48;

146 6: 
b
 |ğ((
ušt64_t
)
š
[5]) << 40;

147 5: 
b
 |ğ((
ušt64_t
)
š
[4]) << 32;

148 4: 
b
 |ğ((
ušt64_t
)
š
[3]) << 24;

149 3: 
b
 |ğ((
ušt64_t
)
š
[2]) << 16;

150 2: 
b
 |ğ((
ušt64_t
)
š
[1]) << 8;

151 1: 
b
 |ğ((
ušt64_t
)
š
[0]); ;

155 
v3
 ^ğ
b
;

157 
SIPROUND
;

159 
v0
 ^ğ
b
;

160 
v2
 ^= 0xff;

162 
SIPROUND
;

163 
SIPROUND
;

165 
b
 = 
v0
 ^ 
v1
 ^ 
v2
 ^ 
v3
;

166 #iâdeà
UNALIGNED_LE_CPU


167 
	`U64TO8_LE
(
out
, 
b
);

168  
hash
;

170  
b
;

172 
	}
}

174 
ušt64_t
 
	$shash_noÿ£
(cÚ¡ 
ušt8_t
 *
š
, cÚ¡ 
size_t
 
šËn
, cÚ¡ ušt8_ˆ*
k
)

176 #iâdeà
UNALIGNED_LE_CPU


177 
ušt64_t
 
hash
;

178 
ušt8_t
 *
out
 = (ušt8_t*è&
hash
;

180 
ušt64_t
 
v0
 = 0x736f6d6570736575ULL;

181 
ušt64_t
 
v1
 = 0x646f72616e646f6dULL;

182 
ušt64_t
 
v2
 = 0x6c7967656e657261ULL;

183 
ušt64_t
 
v3
 = 0x7465646279746573ULL;

184 
ušt64_t
 
k0
 = 
	`U8TO64_LE
(
k
);

185 
ušt64_t
 
k1
 = 
	`U8TO64_LE
(
k
 + 8);

186 
ušt64_t
 
m
;

187 cÚ¡ 
ušt8_t
 *
’d
 = 
š
 + 
šËn
 - (šËÀ% (
ušt64_t
));

188 cÚ¡ 
Ëá
 = 
šËn
 & 7;

189 
ušt64_t
 
b
 = ((ušt64_t)
šËn
) << 56;

190 
v3
 ^ğ
k1
;

191 
v2
 ^ğ
k0
;

192 
v1
 ^ğ
k1
;

193 
v0
 ^ğ
k0
;

195 ; 
š
 !ğ
’d
; in += 8) {

196 
m
 = 
	`U8TO64_LE_NOCASE
(
š
);

197 
v3
 ^ğ
m
;

199 
SIPROUND
;

201 
v0
 ^ğ
m
;

204 
Ëá
) {

205 7: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[6])) << 48;

206 6: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[5])) << 40;

207 5: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[4])) << 32;

208 4: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[3])) << 24;

209 3: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[2])) << 16;

210 2: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[1])) << 8;

211 1: 
b
 |ğ((
ušt64_t
)
	`sw
(
š
[0])); ;

215 
v3
 ^ğ
b
;

217 
SIPROUND
;

219 
v0
 ^ğ
b
;

220 
v2
 ^= 0xff;

222 
SIPROUND
;

223 
SIPROUND
;

225 
b
 = 
v0
 ^ 
v1
 ^ 
v2
 ^ 
v3
;

226 #iâdeà
UNALIGNED_LE_CPU


227 
	`U64TO8_LE
(
out
, 
b
);

228  
hash
;

230  
b
;

232 
	}
}

237 #ifdeà
SIPHASH_TEST


239 cÚ¡ 
ušt8_t
 
	gveùÜs_s64
[64][8] = {

313 
	$shash_‹¡
() {

314 
ušt8_t
 
š
[64], 
k
[16];

315 
i
;

316 
çs
 = 0;

318 
i
 = 0; i < 16; ++i)

319 
k
[
i
] = i;

321 
i
 = 0; i < 64; ++i) {

322 
š
[
i
] = i;

323 
ušt64_t
 
hash
 = 
	`shash
(
š
, 
i
, 
k
);

324 cÚ¡ 
ušt8_t
 *
v
 = 
NULL
;

325 
v
 = (
ušt8_t
 *)
veùÜs_s64
;

326 ià(
	`memcmp
(&
hash
, 
v
 + (
i
 * 8), 8)) {

328 
çs
++;

333 
ušt64_t
 
h1
, 
h2
;

334 
h1
 = 
	`shash
((
ušt8_t
*)"hello world",11,(uint8_t*)"1234567812345678");

335 
h2
 = 
	`shash_noÿ£
((
ušt8_t
*)"hello world",11,(uint8_t*)"1234567812345678");

336 ià(
h1
 !ğ
h2
è
çs
++;

338 
h1
 = 
	`shash
((
ušt8_t
*)"hello world",11,(uint8_t*)"1234567812345678");

339 
h2
 = 
	`shash_noÿ£
((
ušt8_t
*)"HELLO world",11,(uint8_t*)"1234567812345678");

340 ià(
h1
 !ğ
h2
è
çs
++;

342 
h1
 = 
	`shash
((
ušt8_t
*)"HELLO world",11,(uint8_t*)"1234567812345678");

343 
h2
 = 
	`shash_noÿ£
((
ušt8_t
*)"HELLO world",11,(uint8_t*)"1234567812345678");

344 ià(
h1
 =ğ
h2
è
çs
++;

346 ià(!
çs
)  0;

348 
	}
}

350 
	$maš
() {

351 ià(
	`shash_‹¡
() == 0) {

352 
	`´štf
("SipHashest: OK\n");

355 
	`´štf
("SipHashest: FAILED\n");

358 
	}
}

	@src/slowlog.c

42 
	~"£rv”.h
"

43 
	~"¦owlog.h
"

48 
¦owlogEÁry
 *
	$¦owlogC»©eEÁry
(
ş›Á
 *
c
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

49 
¦owlogEÁry
 *
£
 = 
	`zm®loc
((*se));

50 
j
, 
¦¬gc
 = 
¬gc
;

52 ià(
¦¬gc
 > 
SLOWLOG_ENTRY_MAX_ARGC
) slargc = SLOWLOG_ENTRY_MAX_ARGC;

53 
£
->
¬gc
 = 
¦¬gc
;

54 
£
->
¬gv
 = 
	`zm®loc
((
robj
*)*
¦¬gc
);

55 
j
 = 0; j < 
¦¬gc
; j++) {

59 ià(
¦¬gc
 !ğ
¬gc
 && 
j
 == slargc-1) {

60 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,

61 
	`sdsÿrštf
(
	`sd£m±y
(),"... (%d more‡rguments)",

62 
¬gc
-
¦¬gc
+1));

65 ià(
¬gv
[
j
]->
ty³
 =ğ
OBJ_STRING
 &&

66 
	`sdsEncodedObjeù
(
¬gv
[
j
]) &&

67 
	`sd¦’
(
¬gv
[
j
]->
±r
è> 
SLOWLOG_ENTRY_MAX_STRING
)

69 
sds
 
s
 = 
	`sd¢ewËn
(
¬gv
[
j
]->
±r
, 
SLOWLOG_ENTRY_MAX_STRING
);

71 
s
 = 
	`sdsÿrštf
(s,"... (%lu more bytes)",

73 
	`sd¦’
(
¬gv
[
j
]->
±r
è- 
SLOWLOG_ENTRY_MAX_STRING
);

74 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
OBJ_STRING
,
s
);

75 } ià(
¬gv
[
j
]->
»fcouÁ
 =ğ
OBJ_SHARED_REFCOUNT
) {

76 
£
->
¬gv
[
j
] =‡rgv[j];

84 
£
->
¬gv
[
j
] = 
	`dupSŒšgObjeù
(argv[j]);

88 
£
->
time
 = 
	`time
(
NULL
);

89 
£
->
du¿tiÚ
 = duration;

90 
£
->
id
 = 
£rv”
.
¦owlog_’Œy_id
++;

91 
£
->
³”id
 = 
	`sd¢ew
(
	`g‘Cl›ÁP“rId
(
c
));

92 
£
->
úame
 = 
c
->
Çme
 ? 
	`sd¢ew
(c->Çme->
±r
è: 
	`sd£m±y
();

93  
£
;

94 
	}
}

100 
	$¦owlogF»eEÁry
(*
£±r
) {

101 
¦owlogEÁry
 *
£
 = 
£±r
;

102 
j
;

104 
j
 = 0; j < 
£
->
¬gc
; j++)

105 
	`deüRefCouÁ
(
£
->
¬gv
[
j
]);

106 
	`zä“
(
£
->
¬gv
);

107 
	`sdsä“
(
£
->
³”id
);

108 
	`sdsä“
(
£
->
úame
);

109 
	`zä“
(
£
);

110 
	}
}

114 
	$¦owlogIn™
() {

115 
£rv”
.
¦owlog
 = 
	`li¡C»©e
();

116 
£rv”
.
¦owlog_’Œy_id
 = 0;

117 
	`li¡S‘F»eM‘hod
(
£rv”
.
¦owlog
,
¦owlogF»eEÁry
);

118 
	}
}

123 
	$¦owlogPushEÁryIfN“ded
(
ş›Á
 *
c
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

124 ià(
£rv”
.
¦owlog_log_¦ow”_thª
 < 0) ;

125 ià(
du¿tiÚ
 >ğ
£rv”
.
¦owlog_log_¦ow”_thª
)

126 
	`li¡AddNodeH—d
(
£rv”
.
¦owlog
,

127 
	`¦owlogC»©eEÁry
(
c
,
¬gv
,
¬gc
,
du¿tiÚ
));

130 
	`li¡L’gth
(
£rv”
.
¦owlog
è> s”v”.
¦owlog_max_Ën
)

131 
	`li¡D–Node
(
£rv”
.
¦owlog
,
	`li¡La¡
(server.slowlog));

132 
	}
}

135 
	$¦owlogRe£t
() {

136 
	`li¡L’gth
(
£rv”
.
¦owlog
) > 0)

137 
	`li¡D–Node
(
£rv”
.
¦owlog
,
	`li¡La¡
(server.slowlog));

138 
	}
}

142 
	$¦owlogCommªd
(
ş›Á
 *
c
) {

143 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"reset")) {

144 
	`¦owlogRe£t
();

145 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

146 } ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"len")) {

147 
	`addR•lyLÚgLÚg
(
c
,
	`li¡L’gth
(
£rv”
.
¦owlog
));

148 } ià((
c
->
¬gc
 == 2 || c->argc == 3) &&

149 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get"))

151 
couÁ
 = 10, 
£Á
 = 0;

152 
li¡I‹r
 
li
;

153 *
tÙ’Œ›s
;

154 
li¡Node
 *
Ê
;

155 
¦owlogEÁry
 *
£
;

157 ià(
c
->
¬gc
 == 3 &&

158 
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
couÁ
,
NULL
è!ğ
C_OK
)

161 
	`li¡Rewšd
(
£rv”
.
¦owlog
,&
li
);

162 
tÙ’Œ›s
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

163 
couÁ
-- && (
Ê
 = 
	`li¡Next
(&
li
))) {

164 
j
;

166 
£
 = 
Ê
->
v®ue
;

167 
	`addR•lyMuÉiBulkL’
(
c
,6);

168 
	`addR•lyLÚgLÚg
(
c
,
£
->
id
);

169 
	`addR•lyLÚgLÚg
(
c
,
£
->
time
);

170 
	`addR•lyLÚgLÚg
(
c
,
£
->
du¿tiÚ
);

171 
	`addR•lyMuÉiBulkL’
(
c
,
£
->
¬gc
);

172 
j
 = 0; j < 
£
->
¬gc
; j++)

173 
	`addR•lyBulk
(
c
,
£
->
¬gv
[
j
]);

174 
	`addR•lyBulkCBufãr
(
c
,
£
->
³”id
,
	`sd¦’
(se->peerid));

175 
	`addR•lyBulkCBufãr
(
c
,
£
->
úame
,
	`sd¦’
(se->cname));

176 
£Á
++;

178 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
tÙ’Œ›s
,
£Á
);

180 
	`addR•lyE¼Ü
(
c
,

183 
	}
}

	@src/slowlog.h

30 
	#SLOWLOG_ENTRY_MAX_ARGC
 32

	)

31 
	#SLOWLOG_ENTRY_MAX_STRING
 128

	)

34 
	s¦owlogEÁry
 {

35 
robj
 **
	m¬gv
;

36 
	m¬gc
;

37 
	mid
;

38 
	mdu¿tiÚ
;

39 
time_t
 
	mtime
;

40 
sds
 
	múame
;

41 
sds
 
	m³”id
;

42 } 
	t¦owlogEÁry
;

45 
¦owlogIn™
();

46 
¦owlogPushEÁryIfN“ded
(
ş›Á
 *
c
, 
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
);

49 
¦owlogCommªd
(
ş›Á
 *
c
);

	@src/solarisfixes.h

31 #ià
defšed
(
__sun
)

33 #ià
defšed
(
__GNUC__
)

34 
	~<m©h.h
>

35 #undeà
i¢ª


36 
	#i¢ª
(
x
) \

37 
	`__ex‹nsiÚ__
({ 
	`__ty³of
 (
x
è
__x_a
 = (x); \

38 
	`__butš_ex³ù
(
__x_a
 !ğ__x_a, 0); })

	)

40 #undeà
isfš™e


41 
	#isfš™e
(
x
) \

42 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_f
 = (x); \

43 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_f
 - __x_f), 1); })

	)

45 #undeà
isšf


46 
	#isšf
(
x
) \

47 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_i
 = (x); \

48 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_i
è&& !
	`isfš™e
(__x_i), 0); })

	)

50 
	#u_št
 
ušt


	)

51 
	#u_št32_t
 
ušt32_t


	)

	@src/sort.c

32 
	~"£rv”.h
"

33 
	~"pqsÜt.h
"

34 
	~<m©h.h
>

36 
zskli¡Node
* 
z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
);

38 
»disSÜtO³¿tiÚ
 *
	$ü—‹SÜtO³¿tiÚ
(
ty³
, 
robj
 *
·‰”n
) {

39 
»disSÜtO³¿tiÚ
 *
so
 = 
	`zm®loc
((*so));

40 
so
->
ty³
 =ype;

41 
so
->
·‰”n
 =…attern;

42  
so
;

43 
	}
}

61 
robj
 *
	$lookupKeyByP©‹º
(
»disDb
 *
db
, 
robj
 *
·‰”n
,„obj *
sub¡
) {

62 *
p
, *
f
, *
k
;

63 
sds
 
¥©
, 
ssub
;

64 
robj
 *
keyobj
, *
f›ldobj
 = 
NULL
, *
o
;

65 
´efixËn
, 
subËn
, 
po¡fixËn
, 
f›ldËn
;

69 
¥©
 = 
·‰”n
->
±r
;

70 ià(
¥©
[0] == '#' && spat[1] == '\0') {

71 
	`šüRefCouÁ
(
sub¡
);

72  
sub¡
;

78 
sub¡
 = 
	`g‘DecodedObjeù
(subst);

79 
ssub
 = 
sub¡
->
±r
;

83 
p
 = 
	`¡rchr
(
¥©
,'*');

84 ià(!
p
) {

85 
	`deüRefCouÁ
(
sub¡
);

86  
NULL
;

90 ià((
f
 = 
	`¡r¡r
(
p
+1, "->")è!ğ
NULL
 && *(f+2) != '\0') {

91 
f›ldËn
 = 
	`sd¦’
(
¥©
)-(
f
-spat)-2;

92 
f›ldobj
 = 
	`ü—‹SŒšgObjeù
(
f
+2,
f›ldËn
);

94 
f›ldËn
 = 0;

98 
´efixËn
 = 
p
-
¥©
;

99 
subËn
 = 
	`sd¦’
(
ssub
);

100 
po¡fixËn
 = 
	`sd¦’
(
¥©
)-(
´efixËn
+1)-(
f›ldËn
 ? fieldlen+2 : 0);

101 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
NULL
,
´efixËn
+
subËn
+
po¡fixËn
);

102 
k
 = 
keyobj
->
±r
;

103 
	`memıy
(
k
,
¥©
,
´efixËn
);

104 
	`memıy
(
k
+
´efixËn
,
ssub
,
subËn
);

105 
	`memıy
(
k
+
´efixËn
+
subËn
,
p
+1,
po¡fixËn
);

106 
	`deüRefCouÁ
(
sub¡
);

109 
o
 = 
	`lookupKeyR—d
(
db
,
keyobj
);

110 ià(
o
 =ğ
NULL
è
noobj
;

112 ià(
f›ldobj
) {

113 ià(
o
->
ty³
 !ğ
OBJ_HASH
è
noobj
;

117 
o
 = 
	`hashTy³G‘V®ueObjeù
(o, 
f›ldobj
->
±r
);

119 ià(
o
->
ty³
 !ğ
OBJ_STRING
è
noobj
;

123 
	`šüRefCouÁ
(
o
);

125 
	`deüRefCouÁ
(
keyobj
);

126 ià(
f›ldobj
è
	`deüRefCouÁ
(fieldobj);

127  
o
;

129 
noobj
:

130 
	`deüRefCouÁ
(
keyobj
);

131 ià(
f›ldËn
è
	`deüRefCouÁ
(
f›ldobj
);

132  
NULL
;

133 
	}
}

138 
	$sÜtCom·»
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

139 cÚ¡ 
»disSÜtObjeù
 *
so1
 = 
s1
, *
so2
 = 
s2
;

140 
cmp
;

142 ià(!
£rv”
.
sÜt_®pha
) {

144 ià(
so1
->
u
.
scÜe
 > 
so2
->u.score) {

145 
cmp
 = 1;

146 } ià(
so1
->
u
.
scÜe
 < 
so2
->u.score) {

147 
cmp
 = -1;

152 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

156 ià(
£rv”
.
sÜt_by·‰”n
) {

157 ià(!
so1
->
u
.
cmpobj
 || !
so2
->u.cmpobj) {

159 ià(
so1
->
u
.
cmpobj
 =ğ
so2
->u.cmpobj)

160 
cmp
 = 0;

161 ià(
so1
->
u
.
cmpobj
 =ğ
NULL
)

162 
cmp
 = -1;

164 
cmp
 = 1;

167 ià(
£rv”
.
sÜt_¡Üe
) {

168 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
u
.
cmpobj
,
so2
->u.cmpobj);

172 
cmp
 = 
	`¡rcŞl
(
so1
->
u
.
cmpobj
->
±r
,
so2
->u.cmpobj->ptr);

177 ià(
£rv”
.
sÜt_¡Üe
) {

178 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

180 
cmp
 = 
	`cŞÏ‹SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

184  
£rv”
.
sÜt_desc
 ? -
cmp
 : cmp;

185 
	}
}

189 
	$sÜtCommªd
(
ş›Á
 *
c
) {

190 
li¡
 *
İ”©iÚs
;

191 
ouu’
 = 0;

192 
desc
 = 0, 
®pha
 = 0;

193 
lim™_¡¬t
 = 0, 
lim™_couÁ
 = -1, 
¡¬t
, 
’d
;

194 
j
, 
dÚtsÜt
 = 0, 
veùÜËn
;

195 
g‘İ
 = 0;

196 
št_cÚv”tiÚ_”rÜ
 = 0;

197 
syÁax_”rÜ
 = 0;

198 
robj
 *
sÜtv®
, *
sÜtby
 = 
NULL
, *
¡Üekey
 = NULL;

199 
»disSÜtObjeù
 *
veùÜ
;

202 
sÜtv®
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

203 ià(
sÜtv®
 && sÜtv®->
ty³
 !ğ
OBJ_SET
 &&

204 
sÜtv®
->
ty³
 !ğ
OBJ_LIST
 &&

205 
sÜtv®
->
ty³
 !ğ
OBJ_ZSET
)

207 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

213 
İ”©iÚs
 = 
	`li¡C»©e
();

214 
	`li¡S‘F»eM‘hod
(
İ”©iÚs
,
zä“
);

215 
j
 = 2;

220 ià(
sÜtv®
)

221 
	`šüRefCouÁ
(
sÜtv®
);

223 
sÜtv®
 = 
	`ü—‹Quickli¡Objeù
();

226 
j
 < 
c
->
¬gc
) {

227 
Ëá¬gs
 = 
c
->
¬gc
-
j
-1;

228 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"asc")) {

229 
desc
 = 0;

230 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"desc")) {

231 
desc
 = 1;

232 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"alpha")) {

233 
®pha
 = 1;

234 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"lim™"è&& 
Ëá¬gs
 >= 2) {

235 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
j
+1], &
lim™_¡¬t
, 
NULL
)

236 !ğ
C_OK
) ||

237 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
j
+2], &
lim™_couÁ
, 
NULL
)

238 !ğ
C_OK
))

240 
syÁax_”rÜ
++;

243 
j
+=2;

244 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"¡Üe"è&& 
Ëá¬gs
 >= 1) {

245 
¡Üekey
 = 
c
->
¬gv
[
j
+1];

246 
j
++;

247 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"by"è&& 
Ëá¬gs
 >= 1) {

248 
sÜtby
 = 
c
->
¬gv
[
j
+1];

251 ià(
	`¡rchr
(
c
->
¬gv
[
j
+1]->
±r
,'*'è=ğ
NULL
) {

252 
dÚtsÜt
 = 1;

256 ià(
£rv”
.
şu¡”_’abËd
) {

257 
	`addR•lyE¼Ü
(
c
,"BY option of SORT denied in Cluster mode.");

258 
syÁax_”rÜ
++;

262 
j
++;

263 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"g‘"è&& 
Ëá¬gs
 >= 1) {

264 ià(
£rv”
.
şu¡”_’abËd
) {

265 
	`addR•lyE¼Ü
(
c
,"GET option of SORT denied in Cluster mode.");

266 
syÁax_”rÜ
++;

269 
	`li¡AddNodeTa
(
İ”©iÚs
,
	`ü—‹SÜtO³¿tiÚ
(

270 
SORT_OP_GET
,
c
->
¬gv
[
j
+1]));

271 
g‘İ
++;

272 
j
++;

274 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

275 
syÁax_”rÜ
++;

278 
j
++;

282 ià(
syÁax_”rÜ
) {

283 
	`deüRefCouÁ
(
sÜtv®
);

284 
	`li¡R–—£
(
İ”©iÚs
);

294 ià(
dÚtsÜt
 &&

295 
sÜtv®
->
ty³
 =ğ
OBJ_SET
 &&

296 (
¡Üekey
 || 
c
->
æags
 & 
CLIENT_LUA
))

299 
dÚtsÜt
 = 0;

300 
®pha
 = 1;

301 
sÜtby
 = 
NULL
;

305 ià(
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
)

306 
	`z£tCÚv”t
(
sÜtv®
, 
OBJ_ENCODING_SKIPLIST
);

309 
sÜtv®
->
ty³
) {

310 
OBJ_LIST
: 
veùÜËn
 = 
	`li¡Ty³L’gth
(
sÜtv®
); ;

311 
OBJ_SET
: 
veùÜËn
 = 
	`£tTy³Size
(
sÜtv®
); ;

312 
OBJ_ZSET
: 
veùÜËn
 = 
	`diùSize
(((
z£t
*)
sÜtv®
->
±r
)->
diù
); ;

313 : 
veùÜËn
 = 0; 
	`£rv”Pªic
("Bad SORType");

317 
¡¬t
 = (
lim™_¡¬t
 < 0) ? 0 :†imit_start;

318 
’d
 = (
lim™_couÁ
 < 0è? 
veùÜËn
-1 : 
¡¬t
+limit_count-1;

319 ià(
¡¬t
 >ğ
veùÜËn
) {

320 
¡¬t
 = 
veùÜËn
-1;

321 
’d
 = 
veùÜËn
-2;

323 ià(
’d
 >ğ
veùÜËn
)ƒnd = vectorlen-1;

335 ià((
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
 || sÜtv®->ty³ =ğ
OBJ_LIST
) &&

336 
dÚtsÜt
 &&

337 (
¡¬t
 !ğ0 || 
’d
 !ğ
veùÜËn
-1))

339 
veùÜËn
 = 
’d
-
¡¬t
+1;

343 
veùÜ
 = 
	`zm®loc
((
»disSÜtObjeù
)*
veùÜËn
);

344 
j
 = 0;

346 ià(
sÜtv®
->
ty³
 =ğ
OBJ_LIST
 && 
dÚtsÜt
) {

353 ià(
’d
 >ğ
¡¬t
) {

354 
li¡Ty³I‹¿tÜ
 *
li
;

355 
li¡Ty³EÁry
 
’Œy
;

356 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
sÜtv®
,

357 
desc
 ? ()(
	`li¡Ty³L’gth
(
sÜtv®
è- 
¡¬t
 - 1) : start,

358 
desc
 ? 
LIST_HEAD
 : 
LIST_TAIL
);

360 
j
 < 
veùÜËn
 && 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

361 
veùÜ
[
j
].
obj
 = 
	`li¡Ty³G‘
(&
’Œy
);

362 
veùÜ
[
j
].
u
.
scÜe
 = 0;

363 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

364 
j
++;

366 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

368 
’d
 -ğ
¡¬t
;

369 
¡¬t
 = 0;

371 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_LIST
) {

372 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
sÜtv®
,0,
LIST_TAIL
);

373 
li¡Ty³EÁry
 
’Œy
;

374 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

375 
veùÜ
[
j
].
obj
 = 
	`li¡Ty³G‘
(&
’Œy
);

376 
veùÜ
[
j
].
u
.
scÜe
 = 0;

377 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

378 
j
++;

380 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

381 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_SET
) {

382 
£tTy³I‹¿tÜ
 *
si
 = 
	`£tTy³In™I‹¿tÜ
(
sÜtv®
);

383 
sds
 
sd£Ë
;

384 (
sd£Ë
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

385 
veùÜ
[
j
].
obj
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
sd£Ë
);

386 
veùÜ
[
j
].
u
.
scÜe
 = 0;

387 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

388 
j
++;

390 
	`£tTy³R–—£I‹¿tÜ
(
si
);

391 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
 && 
dÚtsÜt
) {

399 
z£t
 *
zs
 = 
sÜtv®
->
±r
;

400 
zskli¡
 *
z¦
 = 
zs
->zsl;

401 
zskli¡Node
 *
Ê
;

402 
sds
 
sd£Ë
;

403 
¿ng–’
 = 
veùÜËn
;

406 ià(
desc
) {

407 
z£’
 = 
	`diùSize
(((
z£t
*)
sÜtv®
->
±r
)->
diù
);

409 
Ê
 = 
z¦
->

;

410 ià(
¡¬t
 > 0)

411 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
z£’
-
¡¬t
);

413 
Ê
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

414 ià(
¡¬t
 > 0)

415 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
¡¬t
+1);

418 
¿ng–’
--) {

419 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
Ê
 !ğ
NULL
);

420 
sd£Ë
 = 
Ê
->
–e
;

421 
veùÜ
[
j
].
obj
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

422 
veùÜ
[
j
].
u
.
scÜe
 = 0;

423 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

424 
j
++;

425 
Ê
 = 
desc
 ?†n->
backw¬d
 :†n->
Ëv–
[0].
fÜw¬d
;

428 
’d
 -ğ
¡¬t
;

429 
¡¬t
 = 0;

430 } ià(
sÜtv®
->
ty³
 =ğ
OBJ_ZSET
) {

431 
diù
 *
£t
 = ((
z£t
*)
sÜtv®
->
±r
)->dict;

432 
diùI‹¿tÜ
 *
di
;

433 
diùEÁry
 *
£‹Ë
;

434 
sds
 
sd£Ë
;

435 
di
 = 
	`diùG‘I‹¿tÜ
(
£t
);

436 (
£‹Ë
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

437 
sd£Ë
 = 
	`diùG‘Key
(
£‹Ë
);

438 
veùÜ
[
j
].
obj
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

439 
veùÜ
[
j
].
u
.
scÜe
 = 0;

440 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

441 
j
++;

443 
	`diùR–—£I‹¿tÜ
(
di
);

445 
	`£rv”Pªic
("Unknownype");

447 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
j
 =ğ
veùÜËn
);

450 ià(
dÚtsÜt
 == 0) {

451 
j
 = 0; j < 
veùÜËn
; j++) {

452 
robj
 *
byv®
;

453 ià(
sÜtby
) {

455 
byv®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sÜtby
,
veùÜ
[
j
].
obj
);

456 ià(!
byv®
) ;

459 
byv®
 = 
veùÜ
[
j
].
obj
;

462 ià(
®pha
) {

463 ià(
sÜtby
è
veùÜ
[
j
].
u
.
cmpobj
 = 
	`g‘DecodedObjeù
(
byv®
);

465 ià(
	`sdsEncodedObjeù
(
byv®
)) {

466 *
•Œ
;

468 
veùÜ
[
j
].
u
.
scÜe
 = 
	`¡¹od
(
byv®
->
±r
,&
•Œ
);

469 ià(
•Œ
[0] !ğ'\0' || 
”ºo
 =ğ
ERANGE
 ||

470 
	`i¢ª
(
veùÜ
[
j
].
u
.
scÜe
))

472 
št_cÚv”tiÚ_”rÜ
 = 1;

474 } ià(
byv®
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

478 
veùÜ
[
j
].
u
.
scÜe
 = ()
byv®
->
±r
;

480 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,1 != 1);

486 ià(
sÜtby
) {

487 
	`deüRefCouÁ
(
byv®
);

492 ià(
dÚtsÜt
 == 0) {

493 
£rv”
.
sÜt_desc
 = 
desc
;

494 
£rv”
.
sÜt_®pha
 = 
®pha
;

495 
£rv”
.
sÜt_by·‰”n
 = 
sÜtby
 ? 1 : 0;

496 
£rv”
.
sÜt_¡Üe
 = 
¡Üekey
 ? 1 : 0;

497 ià(
sÜtby
 && (
¡¬t
 !ğ0 || 
’d
 !ğ
veùÜËn
-1))

498 
	`pqsÜt
(
veùÜ
,
veùÜËn
,(
»disSÜtObjeù
),
sÜtCom·»
, 
¡¬t
,
’d
);

500 
	`qsÜt
(
veùÜ
,
veùÜËn
,(
»disSÜtObjeù
),
sÜtCom·»
);

505 
ouu’
 = 
g‘İ
 ? g‘İ*(
’d
-
¡¬t
+1) :ƒnd-start+1;

506 ià(
št_cÚv”tiÚ_”rÜ
) {

507 
	`addR•lyE¼Ü
(
c
,"One or more scores can't be converted into double");

508 } ià(
¡Üekey
 =ğ
NULL
) {

510 
	`addR•lyMuÉiBulkL’
(
c
,
ouu’
);

511 
j
 = 
¡¬t
; j <ğ
’d
; j++) {

512 
li¡Node
 *
Ê
;

513 
li¡I‹r
 
li
;

515 ià(!
g‘İ
è
	`addR•lyBulk
(
c
,
veùÜ
[
j
].
obj
);

516 
	`li¡Rewšd
(
İ”©iÚs
,&
li
);

517 (
Ê
 = 
	`li¡Next
(&
li
))) {

518 
»disSÜtO³¿tiÚ
 *
sİ
 = 
Ê
->
v®ue
;

519 
robj
 *
v®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sİ
->
·‰”n
,

520 
veùÜ
[
j
].
obj
);

522 ià(
sİ
->
ty³
 =ğ
SORT_OP_GET
) {

523 ià(!
v®
) {

524 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

526 
	`addR•lyBulk
(
c
,
v®
);

527 
	`deüRefCouÁ
(
v®
);

531 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
sİ
->
ty³
 =ğ
SORT_OP_GET
);

536 
robj
 *
sobj
 = 
	`ü—‹Quickli¡Objeù
();

539 
j
 = 
¡¬t
; j <ğ
’d
; j++) {

540 
li¡Node
 *
Ê
;

541 
li¡I‹r
 
li
;

543 ià(!
g‘İ
) {

544 
	`li¡Ty³Push
(
sobj
,
veùÜ
[
j
].
obj
,
LIST_TAIL
);

546 
	`li¡Rewšd
(
İ”©iÚs
,&
li
);

547 (
Ê
 = 
	`li¡Next
(&
li
))) {

548 
»disSÜtO³¿tiÚ
 *
sİ
 = 
Ê
->
v®ue
;

549 
robj
 *
v®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sİ
->
·‰”n
,

550 
veùÜ
[
j
].
obj
);

552 ià(
sİ
->
ty³
 =ğ
SORT_OP_GET
) {

553 ià(!
v®
èv® = 
	`ü—‹SŒšgObjeù
("",0);

558 
	`li¡Ty³Push
(
sobj
,
v®
,
LIST_TAIL
);

559 
	`deüRefCouÁ
(
v®
);

562 
	`£rv”As£¹W™hInfo
(
c
,
sÜtv®
,
sİ
->
ty³
 =ğ
SORT_OP_GET
);

567 ià(
ouu’
) {

568 
	`£tKey
(
c
->
db
,
¡Üekey
,
sobj
);

569 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"sÜt¡Üe",
¡Üekey
,

570 
c
->
db
->
id
);

571 
£rv”
.
dœty
 +ğ
ouu’
;

572 } ià(
	`dbD–‘e
(
c
->
db
,
¡Üekey
)) {

573 
	`sigÇlModif›dKey
(
c
->
db
,
¡Üekey
);

574 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
¡Üekey
,
c
->
db
->
id
);

575 
£rv”
.
dœty
++;

577 
	`deüRefCouÁ
(
sobj
);

578 
	`addR•lyLÚgLÚg
(
c
,
ouu’
);

582 
j
 = 0; j < 
veùÜËn
; j++)

583 
	`deüRefCouÁ
(
veùÜ
[
j
].
obj
);

585 
	`deüRefCouÁ
(
sÜtv®
);

586 
	`li¡R–—£
(
İ”©iÚs
);

587 
j
 = 0; j < 
veùÜËn
; j++) {

588 ià(
®pha
 && 
veùÜ
[
j
].
u
.
cmpobj
)

589 
	`deüRefCouÁ
(
veùÜ
[
j
].
u
.
cmpobj
);

591 
	`zä“
(
veùÜ
);

592 
	}
}

	@src/sparkline.c

33 
	~"£rv”.h
"

35 
	~<m©h.h
>

39 
	gch¬£t
[] = "_-`";

40 
	gch¬£t_fl
[] = "_o#";

41 
	gch¬£t_Ën
 = (
ch¬£t
)-1;

42 
	gÏb–_m¬gš_tİ
 = 1;

57 
£qu’û
 *
	$ü—‹S·rklšeSequ’û
() {

58 
£qu’û
 *
£q
 = 
	`zm®loc
((*seq));

59 
£q
->
Ëngth
 = 0;

60 
£q
->
§m¶es
 = 
NULL
;

61  
£q
;

62 
	}
}

65 
	$¥¬klšeSequ’ûAddSam¶e
(
£qu’û
 *
£q
, 
v®ue
, *
Ïb–
) {

66 
Ïb–
 = (Ïb– =ğ
NULL
 ||†ab–[0] =ğ'\0'è? NULL : 
	`z¡rdup
(label);

67 ià(
£q
->
Ëngth
 == 0) {

68 
£q
->
mš
 = seq->
max
 = 
v®ue
;

70 ià(
v®ue
 < 
£q
->
mš
) seq->min = value;

71 ià(
v®ue
 > 
£q
->
max
) seq->max = value;

73 
£q
->
§m¶es
 = 
	`z»®loc
(£q->§m¶es,(
§m¶e
)*(£q->
Ëngth
+1));

74 
£q
->
§m¶es
[£q->
Ëngth
].
v®ue
 = value;

75 
£q
->
§m¶es
[£q->
Ëngth
].
Ïb–
 =†abel;

76 
£q
->
Ëngth
++;

77 ià(
Ïb–
è
£q
->
Ïb–s
++;

78 
	}
}

81 
	$ä“S·rklšeSequ’û
(
£qu’û
 *
£q
) {

82 
j
;

84 
j
 = 0; j < 
£q
->
Ëngth
; j++)

85 
	`zä“
(
£q
->
§m¶es
[
j
].
Ïb–
);

86 
	`zä“
(
£q
->
§m¶es
);

87 
	`zä“
(
£q
);

88 
	}
}

97 
sds
 
	$¥¬klšeR’d”Rªge
(
sds
 
ouut
, 
£qu’û
 *
£q
, 
rows
, 
off£t
, 
Ën
, 
æags
) {

98 
j
;

99 
»lmax
 = 
£q
->
max
 - seq->
mš
;

100 
¡•s
 = 
ch¬£t_Ën
*
rows
;

101 
row
 = 0;

102 *
ch¬s
 = 
	`zm®loc
(
Ën
);

103 
loİ
 = 1;

104 
İt_fl
 = 
æags
 & 
SPARKLINE_FILL
;

105 
İt_log
 = 
æags
 & 
SPARKLINE_LOG_SCALE
;

107 ià(
İt_log
) {

108 
»lmax
 = 
	`log
(relmax+1);

109 } ià(
»lmax
 == 0) {

110 
»lmax
 = 1;

113 
loİ
) {

114 
loİ
 = 0;

115 
	`mem£t
(
ch¬s
,' ',
Ën
);

116 
j
 = 0; j < 
Ën
; j++) {

117 
§m¶e
 *
s
 = &
£q
->
§m¶es
[
j
+
off£t
];

118 
»lv®
 = 
s
->
v®ue
 - 
£q
->
mš
;

119 
¡•
;

121 ià(
İt_log
è
»lv®
 = 
	`log
(relval+1);

122 
¡•
 = (è(
»lv®
*
¡•s
)/
»lmax
;

123 ià(
¡•
 < 0) step = 0;

124 ià(
¡•
 >ğ
¡•s
) step = steps-1;

126 ià(
row
 < 
rows
) {

128 
ch¬idx
 = 
¡•
-((
rows
-
row
-1)*
ch¬£t_Ën
);

129 
loİ
 = 1;

130 ià(
ch¬idx
 >ğ0 && ch¬idx < 
ch¬£t_Ën
) {

131 
ch¬s
[
j
] = 
İt_fl
 ? 
ch¬£t_fl
[
ch¬idx
] :

132 
ch¬£t
[
ch¬idx
];

133 } if(
İt_fl
 && 
ch¬idx
 >ğ
ch¬£t_Ën
) {

134 
ch¬s
[
j
] = '|';

138 ià(
£q
->
Ïb–s
 && 
row
-
rows
 < 
Ïb–_m¬gš_tİ
) {

139 
loİ
 = 1;

143 ià(
s
->
Ïb–
) {

144 
Ïb–_Ën
 = 
	`¡¾’
(
s
->
Ïb–
);

145 
Ïb–_ch¬
 = 
row
 - 
rows
 - 
Ïb–_m¬gš_tİ
;

147 ià(
Ïb–_Ën
 > 
Ïb–_ch¬
) {

148 
loİ
 = 1;

149 
ch¬s
[
j
] = 
s
->
Ïb–
[
Ïb–_ch¬
];

154 ià(
loİ
) {

155 
row
++;

156 
ouut
 = 
	`sdsÿ’
(ouut,
ch¬s
,
Ën
);

157 
ouut
 = 
	`sdsÿ’
(output,"\n",1);

160 
	`zä“
(
ch¬s
);

161  
ouut
;

162 
	}
}

165 
sds
 
	$¥¬klšeR’d”
(
sds
 
ouut
, 
£qu’û
 *
£q
, 
cŞumns
, 
rows
, 
æags
) {

166 
j
;

168 
j
 = 0; j < 
£q
->
Ëngth
; j +ğ
cŞumns
) {

169 
subËn
 = (
£q
->
Ëngth
-
j
è< 
cŞumns
 ? (seq->length-j) : columns;

171 ià(
j
 !ğ0è
ouut
 = 
	`sdsÿ’
(output,"\n",1);

172 
ouut
 = 
	`¥¬klšeR’d”Rªge
(ouut, 
£q
, 
rows
, 
j
, 
subËn
, 
æags
);

174  
ouut
;

175 
	}
}

	@src/sparkline.h

30 #iâdeà
__SPARKLINE_H


31 
	#__SPARKLINE_H


	)

34 
	s§m¶e
 {

35 
	mv®ue
;

36 *
	mÏb–
;

39 
	s£qu’û
 {

40 
	mËngth
;

41 
	mÏb–s
;

42 
§m¶e
 *
	m§m¶es
;

43 
	mmš
, 
	mmax
;

46 
	#SPARKLINE_NO_FLAGS
 0

	)

47 
	#SPARKLINE_FILL
 1

	)

48 
	#SPARKLINE_LOG_SCALE
 2

	)

50 
£qu’û
 *
ü—‹S·rklšeSequ’û
();

51 
¥¬klšeSequ’ûAddSam¶e
(
£qu’û
 *
£q
, 
v®ue
, *
Ïb–
);

52 
ä“S·rklšeSequ’û
(
£qu’û
 *
£q
);

53 
sds
 
¥¬klšeR’d”Rªge
(sd 
ouut
, 
£qu’û
 *
£q
, 
rows
, 
off£t
, 
Ën
, 
æags
);

54 
sds
 
¥¬klšeR’d”
(sd 
ouut
, 
£qu’û
 *
£q
, 
cŞumns
, 
rows
, 
æags
);

	@src/syncio.c

31 
	~"£rv”.h
"

43 
	#SYNCIO__RESOLUTION
 10

	)

49 
ssize_t
 
	$syncWr™e
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

50 
ssize_t
 
nwr™‹n
, 
»t
 = 
size
;

51 
¡¬t
 = 
	`m¡ime
();

52 
»maššg
 = 
timeout
;

55 
wa™
 = (
»maššg
 > 
SYNCIO__RESOLUTION
) ?

56 
»maššg
 : 
SYNCIO__RESOLUTION
;

57 
–­£d
;

61 
nwr™‹n
 = 
	`wr™e
(
fd
,
±r
,
size
);

62 ià(
nwr™‹n
 == -1) {

63 ià(
”ºo
 !ğ
EAGAIN
)  -1;

65 
±r
 +ğ
nwr™‹n
;

66 
size
 -ğ
nwr™‹n
;

68 ià(
size
 =ğ0è 
»t
;

71 
	`«Wa™
(
fd
,
AE_WRITABLE
,
wa™
);

72 
–­£d
 = 
	`m¡ime
(è- 
¡¬t
;

73 ià(
–­£d
 >ğ
timeout
) {

74 
”ºo
 = 
ETIMEDOUT
;

77 
»maššg
 = 
timeout
 - 
–­£d
;

79 
	}
}

85 
ssize_t
 
	$syncR—d
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

86 
ssize_t
 
Ä—d
, 
tÙ»ad
 = 0;

87 
¡¬t
 = 
	`m¡ime
();

88 
»maššg
 = 
timeout
;

90 ià(
size
 == 0)  0;

92 
wa™
 = (
»maššg
 > 
SYNCIO__RESOLUTION
) ?

93 
»maššg
 : 
SYNCIO__RESOLUTION
;

94 
–­£d
;

98 
Ä—d
 = 
	`»ad
(
fd
,
±r
,
size
);

99 ià(
Ä—d
 == 0)  -1;

100 ià(
Ä—d
 == -1) {

101 ià(
”ºo
 !ğ
EAGAIN
)  -1;

103 
±r
 +ğ
Ä—d
;

104 
size
 -ğ
Ä—d
;

105 
tÙ»ad
 +ğ
Ä—d
;

107 ià(
size
 =ğ0è 
tÙ»ad
;

110 
	`«Wa™
(
fd
,
AE_READABLE
,
wa™
);

111 
–­£d
 = 
	`m¡ime
(è- 
¡¬t
;

112 ià(
–­£d
 >ğ
timeout
) {

113 
”ºo
 = 
ETIMEDOUT
;

116 
»maššg
 = 
timeout
 - 
–­£d
;

118 
	}
}

125 
ssize_t
 
	$syncR—dLše
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

126 
ssize_t
 
Ä—d
 = 0;

128 
size
--;

129 
size
) {

130 
c
;

132 ià(
	`syncR—d
(
fd
,&
c
,1,
timeout
) == -1)  -1;

133 ià(
c
 == '\n') {

134 *
±r
 = '\0';

135 ià(
Ä—d
 && *(
±r
-1) == '\r') *(ptr-1) = '\0';

136  
Ä—d
;

138 *
±r
++ = 
c
;

139 *
±r
 = '\0';

140 
Ä—d
++;

142 
size
--;

144  
Ä—d
;

145 
	}
}

	@src/t_hash.c

30 
	~"£rv”.h
"

31 
	~<m©h.h
>

40 
	$hashTy³TryCÚv”siÚ
(
robj
 *
o
,„obj **
¬gv
, 
¡¬t
, 
’d
) {

41 
i
;

43 ià(
o
->
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
) ;

45 
i
 = 
¡¬t
; i <ğ
’d
; i++) {

46 ià(
	`sdsEncodedObjeù
(
¬gv
[
i
]) &&

47 
	`sd¦’
(
¬gv
[
i
]->
±r
è> 
£rv”
.
hash_max_zli¡_v®ue
)

49 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

53 
	}
}

57 
	$hashTy³G‘FromZli¡
(
robj
 *
o
, 
sds
 
f›ld
,

58 **
v¡r
,

59 *
vËn
,

60 *
vÎ
)

62 *
zl
, *
åŒ
 = 
NULL
, *
v±r
 = NULL;

63 
»t
;

65 
	`£rv”As£¹
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

67 
zl
 = 
o
->
±r
;

68 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

69 ià(
åŒ
 !ğ
NULL
) {

70 
åŒ
 = 
	`zli¡Fšd
(åŒ, (*)
f›ld
, 
	`sd¦’
(field), 1);

71 ià(
åŒ
 !ğ
NULL
) {

73 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

74 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

78 ià(
v±r
 !ğ
NULL
) {

79 
»t
 = 
	`zli¡G‘
(
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

80 
	`£rv”As£¹
(
»t
);

85 
	}
}

90 
sds
 
	$hashTy³G‘FromHashTabË
(
robj
 *
o
, 
sds
 
f›ld
) {

91 
diùEÁry
 *
de
;

93 
	`£rv”As£¹
(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

95 
de
 = 
	`diùFšd
(
o
->
±r
, 
f›ld
);

96 ià(
de
 =ğ
NULL
)  NULL;

97  
	`diùG‘V®
(
de
);

98 
	}
}

109 
	$hashTy³G‘V®ue
(
robj
 *
o
, 
sds
 
f›ld
, **
v¡r
, *
vËn
, *
vÎ
) {

110 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

111 *
v¡r
 = 
NULL
;

112 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, 
v¡r
, 
vËn
, 
vÎ
) == 0)

113  
C_OK
;

114 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

115 
sds
 
v®ue
;

116 ià((
v®ue
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
)è!ğ
NULL
) {

117 *
v¡r
 = (*è
v®ue
;

118 *
vËn
 = 
	`sd¦’
(
v®ue
);

119  
C_OK
;

122 
	`£rv”Pªic
("Unknown hashƒncoding");

124  
C_ERR
;

125 
	}
}

131 
robj
 *
	$hashTy³G‘V®ueObjeù
(
robj
 *
o
, 
sds
 
f›ld
) {

132 *
v¡r
;

133 
vËn
;

134 
vÎ
;

136 ià(
	`hashTy³G‘V®ue
(
o
,
f›ld
,&
v¡r
,&
vËn
,&
vÎ
è=ğ
C_ERR
è 
NULL
;

137 ià(
v¡r
è 
	`ü—‹SŒšgObjeù
((*)v¡r,
vËn
);

138  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
);

139 
	}
}

144 
size_t
 
	$hashTy³G‘V®ueL’gth
(
robj
 *
o
, 
sds
 
f›ld
) {

145 
size_t
 
Ën
 = 0;

146 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

147 *
v¡r
 = 
NULL
;

148 
vËn
 = 
UINT_MAX
;

149 
vÎ
 = 
LLONG_MAX
;

151 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)

152 
Ën
 = 
v¡r
 ? 
vËn
 : 
	`sdig™s10
(
vÎ
);

153 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

154 
sds
 
aux
;

156 ià((
aux
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
)è!ğ
NULL
)

157 
Ën
 = 
	`sd¦’
(
aux
);

159 
	`£rv”Pªic
("Unknown hashƒncoding");

161  
Ën
;

162 
	}
}

166 
	$hashTy³Exi¡s
(
robj
 *
o
, 
sds
 
f›ld
) {

167 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

168 *
v¡r
 = 
NULL
;

169 
vËn
 = 
UINT_MAX
;

170 
vÎ
 = 
LLONG_MAX
;

172 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)  1;

173 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

174 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
è!ğ
NULL
)  1;

176 
	`£rv”Pªic
("Unknown hashƒncoding");

179 
	}
}

199 
	#HASH_SET_TAKE_FIELD
 (1<<0)

	)

200 
	#HASH_SET_TAKE_VALUE
 (1<<1)

	)

201 
	#HASH_SET_COPY
 0

	)

202 
	$hashTy³S‘
(
robj
 *
o
, 
sds
 
f›ld
, sd 
v®ue
, 
æags
) {

203 
upd©e
 = 0;

205 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

206 *
zl
, *
åŒ
, *
v±r
;

208 
zl
 = 
o
->
±r
;

209 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

210 ià(
åŒ
 !ğ
NULL
) {

211 
åŒ
 = 
	`zli¡Fšd
(åŒ, (*)
f›ld
, 
	`sd¦’
(field), 1);

212 ià(
åŒ
 !ğ
NULL
) {

214 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

215 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

216 
upd©e
 = 1;

219 
zl
 = 
	`zli¡D–‘e
(zl, &
v±r
);

222 
zl
 = 
	`zli¡In£¹
(zl, 
v±r
, (*)
v®ue
,

223 
	`sd¦’
(
v®ue
));

227 ià(!
upd©e
) {

229 
zl
 = 
	`zli¡Push
(zl, (*)
f›ld
, 
	`sd¦’
(field),

230 
ZIPLIST_TAIL
);

231 
zl
 = 
	`zli¡Push
(zl, (*)
v®ue
, 
	`sd¦’
(value),

232 
ZIPLIST_TAIL
);

234 
o
->
±r
 = 
zl
;

237 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
)

238 
	`hashTy³CÚv”t
(
o
, 
OBJ_ENCODING_HT
);

239 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

240 
diùEÁry
 *
de
 = 
	`diùFšd
(
o
->
±r
,
f›ld
);

241 ià(
de
) {

242 
	`sdsä“
(
	`diùG‘V®
(
de
));

243 ià(
æags
 & 
HASH_SET_TAKE_VALUE
) {

244 
	`diùG‘V®
(
de
èğ
v®ue
;

245 
v®ue
 = 
NULL
;

247 
	`diùG‘V®
(
de
èğ
	`sdsdup
(
v®ue
);

249 
upd©e
 = 1;

251 
sds
 
f
,
v
;

252 ià(
æags
 & 
HASH_SET_TAKE_FIELD
) {

253 
f
 = 
f›ld
;

254 
f›ld
 = 
NULL
;

256 
f
 = 
	`sdsdup
(
f›ld
);

258 ià(
æags
 & 
HASH_SET_TAKE_VALUE
) {

259 
v
 = 
v®ue
;

260 
v®ue
 = 
NULL
;

262 
v
 = 
	`sdsdup
(
v®ue
);

264 
	`diùAdd
(
o
->
±r
,
f
,
v
);

267 
	`£rv”Pªic
("Unknown hashƒncoding");

272 ià(
æags
 & 
HASH_SET_TAKE_FIELD
 && 
f›ld
è
	`sdsä“
(field);

273 ià(
æags
 & 
HASH_SET_TAKE_VALUE
 && 
v®ue
è
	`sdsä“
(value);

274  
upd©e
;

275 
	}
}

279 
	$hashTy³D–‘e
(
robj
 *
o
, 
sds
 
f›ld
) {

280 
d–‘ed
 = 0;

282 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

283 *
zl
, *
åŒ
;

285 
zl
 = 
o
->
±r
;

286 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

287 ià(
åŒ
 !ğ
NULL
) {

288 
åŒ
 = 
	`zli¡Fšd
(åŒ, (*)
f›ld
, 
	`sd¦’
(field), 1);

289 ià(
åŒ
 !ğ
NULL
) {

290 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

291 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

292 
o
->
±r
 = 
zl
;

293 
d–‘ed
 = 1;

296 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

297 ià(
	`diùD–‘e
((
diù
*)
o
->
±r
, 
f›ld
è=ğ
C_OK
) {

298 
d–‘ed
 = 1;

301 ià(
	`htN“dsResize
(
o
->
±r
)è
	`diùResize
(o->ptr);

305 
	`£rv”Pªic
("Unknown hashƒncoding");

307  
d–‘ed
;

308 
	}
}

311 
	$hashTy³L’gth
(cÚ¡ 
robj
 *
o
) {

312 
Ëngth
 = 
ULONG_MAX
;

314 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

315 
Ëngth
 = 
	`zli¡L’
(
o
->
±r
) / 2;

316 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

317 
Ëngth
 = 
	`diùSize
((cÚ¡ 
diù
*)
o
->
±r
);

319 
	`£rv”Pªic
("Unknown hashƒncoding");

321  
Ëngth
;

322 
	}
}

324 
hashTy³I‹¿tÜ
 *
	$hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

325 
hashTy³I‹¿tÜ
 *
hi
 = 
	`zm®loc
((hashTypeIterator));

326 
hi
->
subjeù
 = subject;

327 
hi
->
’codšg
 = 
subjeù
->encoding;

329 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

330 
hi
->
åŒ
 = 
NULL
;

331 
hi
->
v±r
 = 
NULL
;

332 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

333 
hi
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

335 
	`£rv”Pªic
("Unknown hashƒncoding");

337  
hi
;

338 
	}
}

340 
	$hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
) {

341 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

342 
	`diùR–—£I‹¿tÜ
(
hi
->
di
);

343 
	`zä“
(
hi
);

344 
	}
}

348 
	$hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
) {

349 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

350 *
zl
;

351 *
åŒ
, *
v±r
;

353 
zl
 = 
hi
->
subjeù
->
±r
;

354 
åŒ
 = 
hi
->fptr;

355 
v±r
 = 
hi
->vptr;

357 ià(
åŒ
 =ğ
NULL
) {

359 
	`£rv”As£¹
(
v±r
 =ğ
NULL
);

360 
åŒ
 = 
	`zli¡Index
(
zl
, 0);

363 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

364 
åŒ
 = 
	`zli¡Next
(
zl
, 
v±r
);

366 ià(
åŒ
 =ğ
NULL
è 
C_ERR
;

369 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

370 
	`£rv”As£¹
(
v±r
 !ğ
NULL
);

373 
hi
->
åŒ
 = fptr;

374 
hi
->
v±r
 = vptr;

375 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

376 ià((
hi
->
de
 = 
	`diùNext
(hi->
di
)è=ğ
NULL
è 
C_ERR
;

378 
	`£rv”Pªic
("Unknown hashƒncoding");

380  
C_OK
;

381 
	}
}

385 
	$hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
,

386 **
v¡r
,

387 *
vËn
,

388 *
vÎ
)

390 
»t
;

392 
	`£rv”As£¹
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

394 ià(
wh©
 & 
OBJ_HASH_KEY
) {

395 
»t
 = 
	`zli¡G‘
(
hi
->
åŒ
, 
v¡r
, 
vËn
, 
vÎ
);

396 
	`£rv”As£¹
(
»t
);

398 
»t
 = 
	`zli¡G‘
(
hi
->
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

399 
	`£rv”As£¹
(
»t
);

401 
	}
}

406 
sds
 
	$hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

407 
	`£rv”As£¹
(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
);

409 ià(
wh©
 & 
OBJ_HASH_KEY
) {

410  
	`diùG‘Key
(
hi
->
de
);

412  
	`diùG‘V®
(
hi
->
de
);

414 
	}
}

426 
	$hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, **
v¡r
, *
vËn
, *
vÎ
) {

427 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

428 *
v¡r
 = 
NULL
;

429 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, 
v¡r
, 
vËn
, 
vÎ
);

430 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

431 
sds
 
–e
 = 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
);

432 *
v¡r
 = (*è
–e
;

433 *
vËn
 = 
	`sd¦’
(
–e
);

435 
	`£rv”Pªic
("Unknown hashƒncoding");

437 
	}
}

441 
sds
 
	$hashTy³Cu¼’tObjeùNewSds
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

442 *
v¡r
;

443 
vËn
;

444 
vÎ
;

446 
	`hashTy³Cu¼’tObjeù
(
hi
,
wh©
,&
v¡r
,&
vËn
,&
vÎ
);

447 ià(
v¡r
è 
	`sd¢ewËn
(v¡r,
vËn
);

448  
	`sdsäomlÚglÚg
(
vÎ
);

449 
	}
}

451 
robj
 *
	$hashTy³LookupWr™eOrC»©e
(
ş›Á
 *
c
, 
robj
 *
key
) {

452 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
);

453 ià(
o
 =ğ
NULL
) {

454 
o
 = 
	`ü—‹HashObjeù
();

455 
	`dbAdd
(
c
->
db
,
key
,
o
);

457 ià(
o
->
ty³
 !ğ
OBJ_HASH
) {

458 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

459  
NULL
;

462  
o
;

463 
	}
}

465 
	$hashTy³CÚv”tZli¡
(
robj
 *
o
, 
’c
) {

466 
	`£rv”As£¹
(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
);

468 ià(
’c
 =ğ
OBJ_ENCODING_ZIPLIST
) {

471 } ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

472 
hashTy³I‹¿tÜ
 *
hi
;

473 
diù
 *dict;

474 
»t
;

476 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

477 
diù
 = 
	`diùC»©e
(&
hashDiùTy³
, 
NULL
);

479 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

480 
sds
 
key
, 
v®ue
;

482 
key
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_KEY
);

483 
v®ue
 = 
	`hashTy³Cu¼’tObjeùNewSds
(
hi
,
OBJ_HASH_VALUE
);

484 
»t
 = 
	`diùAdd
(
diù
, 
key
, 
v®ue
);

485 ià(
»t
 !ğ
DICT_OK
) {

486 
	`£rv”LogHexDump
(
LL_WARNING
,"ziplist with dupƒlements dump",

487 
o
->
±r
,
	`zli¡BlobL’
(o->ptr));

488 
	`£rv”Pªic
("Ziplist corruption detected");

491 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

492 
	`zä“
(
o
->
±r
);

493 
o
->
’codšg
 = 
OBJ_ENCODING_HT
;

494 
o
->
±r
 = 
diù
;

496 
	`£rv”Pªic
("Unknown hashƒncoding");

498 
	}
}

500 
	$hashTy³CÚv”t
(
robj
 *
o
, 
’c
) {

501 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

502 
	`hashTy³CÚv”tZli¡
(
o
, 
’c
);

503 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

504 
	`£rv”Pªic
("Not implemented");

506 
	`£rv”Pªic
("Unknown hashƒncoding");

508 
	}
}

514 
	$h£ŠxCommªd
(
ş›Á
 *
c
) {

515 
robj
 *
o
;

516 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

517 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

519 ià(
	`hashTy³Exi¡s
(
o
, 
c
->
¬gv
[2]->
±r
)) {

520 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

522 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2]->
±r
,c->¬gv[3]->±r,
HASH_SET_COPY
);

523 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

524 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

525 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

526 
£rv”
.
dœty
++;

528 
	}
}

530 
	$h£tCommªd
(
ş›Á
 *
c
) {

531 
i
, 
ü—‹d
 = 0;

532 
robj
 *
o
;

534 ià((
c
->
¬gc
 % 2) == 1) {

535 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for HMSET");

539 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

540 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,c->
¬gc
-1);

542 
i
 = 2; i < 
c
->
¬gc
; i += 2)

543 
ü—‹d
 +ğ!
	`hashTy³S‘
(
o
,
c
->
¬gv
[
i
]->
±r
,c->¬gv[i+1]->±r,
HASH_SET_COPY
);

546 *
cmdÇme
 = 
c
->
¬gv
[0]->
±r
;

547 ià(
cmdÇme
[1] == 's' || cmdname[1] == 'S') {

549 
	`addR•lyLÚgLÚg
(
c
, 
ü—‹d
);

552 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

554 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

555 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

556 
£rv”
.
dœty
++;

557 
	}
}

559 
	$hšübyCommªd
(
ş›Á
 *
c
) {

560 
v®ue
, 
šü
, 
Şdv®ue
;

561 
robj
 *
o
;

562 
sds
 
Ãw
;

563 *
v¡r
;

564 
vËn
;

566 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
C_OK
) ;

567 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

568 ià(
	`hashTy³G‘V®ue
(
o
,
c
->
¬gv
[2]->
±r
,&
v¡r
,&
vËn
,&
v®ue
è=ğ
C_OK
) {

569 ià(
v¡r
) {

570 ià(
	`¡ršg2Î
((*)
v¡r
,
vËn
,&
v®ue
) == 0) {

571 
	`addR•lyE¼Ü
(
c
,"hash value is‚ot‡n integer");

576 
v®ue
 = 0;

579 
Şdv®ue
 = 
v®ue
;

580 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

581 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

582 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

585 
v®ue
 +ğ
šü
;

586 
Ãw
 = 
	`sdsäomlÚglÚg
(
v®ue
);

587 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2]->
±r
,
Ãw
,
HASH_SET_TAKE_VALUE
);

588 
	`addR•lyLÚgLÚg
(
c
,
v®ue
);

589 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

590 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšüby",
c
->
¬gv
[1],c->
db
->
id
);

591 
£rv”
.
dœty
++;

592 
	}
}

594 
	$hšübyæßtCommªd
(
ş›Á
 *
c
) {

595 
v®ue
, 
šü
;

596 
Î
;

597 
robj
 *
o
;

598 
sds
 
Ãw
;

599 *
v¡r
;

600 
vËn
;

602 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
C_OK
) ;

603 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

604 ià(
	`hashTy³G‘V®ue
(
o
,
c
->
¬gv
[2]->
±r
,&
v¡r
,&
vËn
,&
Î
è=ğ
C_OK
) {

605 ià(
v¡r
) {

606 ià(
	`¡ršg2ld
((*)
v¡r
,
vËn
,&
v®ue
) == 0) {

607 
	`addR•lyE¼Ü
(
c
,"hash value is‚ot‡ float");

611 
v®ue
 = ()
Î
;

614 
v®ue
 = 0;

617 
v®ue
 +ğ
šü
;

619 
buf
[
MAX_LONG_DOUBLE_CHARS
];

620 
Ën
 = 
	`ld2¡ršg
(
buf
,(buf),
v®ue
,1);

621 
Ãw
 = 
	`sd¢ewËn
(
buf
,
Ën
);

622 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2]->
±r
,
Ãw
,
HASH_SET_TAKE_VALUE
);

623 
	`addR•lyBulkCBufãr
(
c
,
buf
,
Ën
);

624 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

625 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hšübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

626 
£rv”
.
dœty
++;

631 
robj
 *
aux
, *
Ãwobj
;

632 
aux
 = 
	`ü—‹SŒšgObjeù
("HSET",4);

633 
Ãwobj
 = 
	`ü—‹RawSŒšgObjeù
(
buf
,
Ën
);

634 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

635 
	`deüRefCouÁ
(
aux
);

636 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,3,
Ãwobj
);

637 
	`deüRefCouÁ
(
Ãwobj
);

638 
	}
}

640 
	$addHashF›ldToR•ly
(
ş›Á
 *
c
, 
robj
 *
o
, 
sds
 
f›ld
) {

641 
»t
;

643 ià(
o
 =ğ
NULL
) {

644 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

648 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

649 *
v¡r
 = 
NULL
;

650 
vËn
 = 
UINT_MAX
;

651 
vÎ
 = 
LLONG_MAX
;

653 
»t
 = 
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
);

654 ià(
»t
 < 0) {

655 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

657 ià(
v¡r
) {

658 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

660 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

664 } ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

665 
sds
 
v®ue
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
);

666 ià(
v®ue
 =ğ
NULL
)

667 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

669 
	`addR•lyBulkCBufãr
(
c
, 
v®ue
, 
	`sd¦’
(value));

671 
	`£rv”Pªic
("Unknown hashƒncoding");

673 
	}
}

675 
	$hg‘Commªd
(
ş›Á
 *
c
) {

676 
robj
 *
o
;

678 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

679 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

681 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[2]->
±r
);

682 
	}
}

684 
	$hmg‘Commªd
(
ş›Á
 *
c
) {

685 
robj
 *
o
;

686 
i
;

690 
o
 = 
	`lookupKeyR—d
(
c
->
db
, c->
¬gv
[1]);

691 ià(
o
 !ğ
NULL
 && o->
ty³
 !ğ
OBJ_HASH
) {

692 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

696 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

697 
i
 = 2; i < 
c
->
¬gc
; i++) {

698 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[
i
]->
±r
);

700 
	}
}

702 
	$hd–Commªd
(
ş›Á
 *
c
) {

703 
robj
 *
o
;

704 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

706 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

707 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

709 
j
 = 2; j < 
c
->
¬gc
; j++) {

710 ià(
	`hashTy³D–‘e
(
o
,
c
->
¬gv
[
j
]->
±r
)) {

711 
d–‘ed
++;

712 ià(
	`hashTy³L’gth
(
o
) == 0) {

713 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

714 
key»moved
 = 1;

719 ià(
d–‘ed
) {

720 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

721 
	`nÙifyKey¥aûEv’t
(
NOTIFY_HASH
,"hd–",
c
->
¬gv
[1],c->
db
->
id
);

722 ià(
key»moved
)

723 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

724 
c
->
db
->
id
);

725 
£rv”
.
dœty
 +ğ
d–‘ed
;

727 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

728 
	}
}

730 
	$hËnCommªd
(
ş›Á
 *
c
) {

731 
robj
 *
o
;

733 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

734 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

736 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³L’gth
(
o
));

737 
	}
}

739 
	$h¡¾’Commªd
(
ş›Á
 *
c
) {

740 
robj
 *
o
;

742 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

743 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

744 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³G‘V®ueL’gth
(
o
,c->
¬gv
[2]->
±r
));

745 
	}
}

747 
	$addHashI‹¿tÜCursÜToR•ly
(
ş›Á
 *
c
, 
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

748 ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

749 *
v¡r
 = 
NULL
;

750 
vËn
 = 
UINT_MAX
;

751 
vÎ
 = 
LLONG_MAX
;

753 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

754 ià(
v¡r
)

755 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

757 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

758 } ià(
hi
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

759 
sds
 
v®ue
 = 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
);

760 
	`addR•lyBulkCBufãr
(
c
, 
v®ue
, 
	`sd¦’
(value));

762 
	`£rv”Pªic
("Unknown hashƒncoding");

764 
	}
}

766 
	$g’”icHg‘®lCommªd
(
ş›Á
 *
c
, 
æags
) {

767 
robj
 *
o
;

768 
hashTy³I‹¿tÜ
 *
hi
;

769 
muÉl›r
 = 0;

770 
Ëngth
, 
couÁ
 = 0;

772 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


773 || 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

775 ià(
æags
 & 
OBJ_HASH_KEY
è
muÉl›r
++;

776 ià(
æags
 & 
OBJ_HASH_VALUE
è
muÉl›r
++;

778 
Ëngth
 = 
	`hashTy³L’gth
(
o
è* 
muÉl›r
;

779 
	`addR•lyMuÉiBulkL’
(
c
, 
Ëngth
);

781 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

782 
	`hashTy³Next
(
hi
è!ğ
C_ERR
) {

783 ià(
æags
 & 
OBJ_HASH_KEY
) {

784 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_KEY
);

785 
couÁ
++;

787 ià(
æags
 & 
OBJ_HASH_VALUE
) {

788 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
OBJ_HASH_VALUE
);

789 
couÁ
++;

793 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

794 
	`£rv”As£¹
(
couÁ
 =ğ
Ëngth
);

795 
	}
}

797 
	$hkeysCommªd
(
ş›Á
 *
c
) {

798 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
);

799 
	}
}

801 
	$hv®sCommªd
(
ş›Á
 *
c
) {

802 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_VALUE
);

803 
	}
}

805 
	$hg‘®lCommªd
(
ş›Á
 *
c
) {

806 
	`g’”icHg‘®lCommªd
(
c
,
OBJ_HASH_KEY
|
OBJ_HASH_VALUE
);

807 
	}
}

809 
	$hexi¡sCommªd
(
ş›Á
 *
c
) {

810 
robj
 *
o
;

811 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

812 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

814 
	`addR•ly
(
c
, 
	`hashTy³Exi¡s
(
o
,c->
¬gv
[2]->
±r
è? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

815 
	}
}

817 
	$hsÿnCommªd
(
ş›Á
 *
c
) {

818 
robj
 *
o
;

819 
cursÜ
;

821 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
C_ERR
) ;

822 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

823 
	`checkTy³
(
c
,
o
,
OBJ_HASH
)) ;

824 
	`sÿnG’”icCommªd
(
c
,
o
,
cursÜ
);

825 
	}
}

	@src/t_list.c

30 
	~"£rv”.h
"

41 
	$li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
) {

42 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

43 
pos
 = (
wh”e
 =ğ
LIST_HEAD
è? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

44 
v®ue
 = 
	`g‘DecodedObjeù
(value);

45 
size_t
 
Ën
 = 
	`sd¦’
(
v®ue
->
±r
);

46 
	`quickli¡Push
(
subjeù
->
±r
, 
v®ue
->±r, 
Ën
, 
pos
);

47 
	`deüRefCouÁ
(
v®ue
);

49 
	`£rv”Pªic
("Unknown†istƒncoding");

51 
	}
}

53 *
	$li¡PİSav”
(*
d©a
, 
sz
) {

54  
	`ü—‹SŒšgObjeù
((*)
d©a
,
sz
);

55 
	}
}

57 
robj
 *
	$li¡Ty³Pİ
(
robj
 *
subjeù
, 
wh”e
) {

58 
vlÚg
;

59 
robj
 *
v®ue
 = 
NULL
;

61 
ql_wh”e
 = 
wh”e
 =ğ
LIST_HEAD
 ? 
QUICKLIST_HEAD
 : 
QUICKLIST_TAIL
;

62 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

63 ià(
	`quickli¡PİCu¡om
(
subjeù
->
±r
, 
ql_wh”e
, (**)&
v®ue
,

64 
NULL
, &
vlÚg
, 
li¡PİSav”
)) {

65 ià(!
v®ue
)

66 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

69 
	`£rv”Pªic
("Unknown†istƒncoding");

71  
v®ue
;

72 
	}
}

74 
	$li¡Ty³L’gth
(cÚ¡ 
robj
 *
subjeù
) {

75 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

76  
	`quickli¡CouÁ
(
subjeù
->
±r
);

78 
	`£rv”Pªic
("Unknown†istƒncoding");

80 
	}
}

83 
li¡Ty³I‹¿tÜ
 *
	$li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
,

84 
dœeùiÚ
) {

85 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`zm®loc
((listTypeIterator));

86 
li
->
subjeù
 = subject;

87 
li
->
’codšg
 = 
subjeù
->encoding;

88 
li
->
dœeùiÚ
 = direction;

89 
li
->
™”
 = 
NULL
;

92 
™”_dœeùiÚ
 =

93 
dœeùiÚ
 =ğ
LIST_HEAD
 ? 
AL_START_TAIL
 : 
AL_START_HEAD
;

94 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

95 
li
->
™”
 = 
	`quickli¡G‘I‹¿tÜAtIdx
Öi->
subjeù
->
±r
,

96 
™”_dœeùiÚ
, 
šdex
);

98 
	`£rv”Pªic
("Unknown†istƒncoding");

100  
li
;

101 
	}
}

104 
	$li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
) {

105 
	`zä“
(
li
->
™”
);

106 
	`zä“
(
li
);

107 
	}
}

112 
	$li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
) {

114 
	`£rv”As£¹
(
li
->
subjeù
->
’codšg
 ==†i->encoding);

116 
’Œy
->
li
 =†i;

117 ià(
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

118  
	`quickli¡Next
(
li
->
™”
, &
’Œy
->entry);

120 
	`£rv”Pªic
("Unknown†istƒncoding");

123 
	}
}

126 
robj
 *
	$li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
) {

127 
robj
 *
v®ue
 = 
NULL
;

128 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

129 ià(
’Œy
->’Œy.
v®ue
) {

130 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
->entry.value,

131 
’Œy
->’Œy.
sz
);

133 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
->’Œy.
lÚgv®
);

136 
	`£rv”Pªic
("Unknown†istƒncoding");

138  
v®ue
;

139 
	}
}

141 
	$li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
) {

142 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

143 
v®ue
 = 
	`g‘DecodedObjeù
(value);

144 
sds
 
¡r
 = 
v®ue
->
±r
;

145 
size_t
 
Ën
 = 
	`sd¦’
(
¡r
);

146 ià(
wh”e
 =ğ
LIST_TAIL
) {

147 
	`quickli¡In£¹Aá”
((
quickli¡
 *)
’Œy
->entry.quicklist,

148 &
’Œy
->’Œy, 
¡r
, 
Ën
);

149 } ià(
wh”e
 =ğ
LIST_HEAD
) {

150 
	`quickli¡In£¹BefÜe
((
quickli¡
 *)
’Œy
->entry.quicklist,

151 &
’Œy
->’Œy, 
¡r
, 
Ën
);

153 
	`deüRefCouÁ
(
v®ue
);

155 
	`£rv”Pªic
("Unknown†istƒncoding");

157 
	}
}

160 
	$li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
) {

161 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

162 
	`£rv”As£¹W™hInfo
(
NULL
,
o
,
	`sdsEncodedObjeù
(o));

163  
	`quickli¡Com·»
(
’Œy
->’Œy.
zi
,
o
->
±r
,
	`sd¦’
(o->ptr));

165 
	`£rv”Pªic
("Unknown†istƒncoding");

167 
	}
}

170 
	$li¡Ty³D–‘e
(
li¡Ty³I‹¿tÜ
 *
™”
, 
li¡Ty³EÁry
 *
’Œy
) {

171 ià(
’Œy
->
li
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

172 
	`quickli¡D–EÁry
(
™”
->™”, &
’Œy
->entry);

174 
	`£rv”Pªic
("Unknown†istƒncoding");

176 
	}
}

179 
	$li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
) {

180 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
ty³
==
OBJ_LIST
);

181 
	`£rv”As£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
’codšg
==
OBJ_ENCODING_ZIPLIST
);

183 ià(
’c
 =ğ
OBJ_ENCODING_QUICKLIST
) {

184 
size_t
 
zËn
 = 
£rv”
.
li¡_max_zli¡_size
;

185 
d•th
 = 
£rv”
.
li¡_com´ess_d•th
;

186 
subjeù
->
±r
 = 
	`quickli¡C»©eFromZli¡
(
zËn
, 
d•th
, subject->ptr);

187 
subjeù
->
’codšg
 = 
OBJ_ENCODING_QUICKLIST
;

189 
	`£rv”Pªic
("Unsupported†ist conversion");

191 
	}
}

197 
	$pushG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

198 
j
, 
pushed
 = 0;

199 
robj
 *
lobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

201 ià(
lobj
 &&†obj->
ty³
 !ğ
OBJ_LIST
) {

202 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

206 
j
 = 2; j < 
c
->
¬gc
; j++) {

207 ià(!
lobj
) {

208 
lobj
 = 
	`ü—‹Quickli¡Objeù
();

209 
	`quickli¡S‘O±iÚs
(
lobj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

210 
£rv”
.
li¡_com´ess_d•th
);

211 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
lobj
);

213 
	`li¡Ty³Push
(
lobj
,
c
->
¬gv
[
j
],
wh”e
);

214 
pushed
++;

216 
	`addR•lyLÚgLÚg
(
c
, (
lobj
 ? 
	`li¡Ty³L’gth
(lobj) : 0));

217 ià(
pushed
) {

218 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

220 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

221 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

223 
£rv”
.
dœty
 +ğ
pushed
;

224 
	}
}

226 
	$ÍushCommªd
(
ş›Á
 *
c
) {

227 
	`pushG’”icCommªd
(
c
,
LIST_HEAD
);

228 
	}
}

230 
	$½ushCommªd
(
ş›Á
 *
c
) {

231 
	`pushG’”icCommªd
(
c
,
LIST_TAIL
);

232 
	}
}

234 
	$pushxG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

235 
j
, 
pushed
 = 0;

236 
robj
 *
subjeù
;

238 ià((
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

239 
	`checkTy³
(
c
,
subjeù
,
OBJ_LIST
)) ;

241 
j
 = 2; j < 
c
->
¬gc
; j++) {

242 
	`li¡Ty³Push
(
subjeù
,
c
->
¬gv
[
j
],
wh”e
);

243 
pushed
++;

246 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
subjeù
));

248 ià(
pushed
) {

249 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpush" : "rpush";

250 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

251 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

253 
£rv”
.
dœty
 +ğ
pushed
;

254 
	}
}

256 
	$ÍushxCommªd
(
ş›Á
 *
c
) {

257 
	`pushxG’”icCommªd
(
c
,
LIST_HEAD
);

258 
	}
}

260 
	$½ushxCommªd
(
ş›Á
 *
c
) {

261 
	`pushxG’”icCommªd
(
c
,
LIST_TAIL
);

262 
	}
}

264 
	$lš£¹Commªd
(
ş›Á
 *
c
) {

265 
wh”e
;

266 
robj
 *
subjeù
;

267 
li¡Ty³I‹¿tÜ
 *
™”
;

268 
li¡Ty³EÁry
 
’Œy
;

269 
š£¹ed
 = 0;

271 ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"after") == 0) {

272 
wh”e
 = 
LIST_TAIL
;

273 } ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"before") == 0) {

274 
wh”e
 = 
LIST_HEAD
;

276 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

280 ià((
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

281 
	`checkTy³
(
c
,
subjeù
,
OBJ_LIST
)) ;

284 
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

285 
	`li¡Ty³Next
(
™”
,&
’Œy
)) {

286 ià(
	`li¡Ty³Equ®
(&
’Œy
,
c
->
¬gv
[3])) {

287 
	`li¡Ty³In£¹
(&
’Œy
,
c
->
¬gv
[4],
wh”e
);

288 
š£¹ed
 = 1;

292 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

294 ià(
š£¹ed
) {

295 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

296 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"linsert",

297 
c
->
¬gv
[1],c->
db
->
id
);

298 
£rv”
.
dœty
++;

301 
	`addR•ly
(
c
,
sh¬ed
.
úegÚe
);

305 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
subjeù
));

306 
	}
}

308 
	$Î’Commªd
(
ş›Á
 *
c
) {

309 
robj
 *
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
);

310 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

311 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
o
));

312 
	}
}

314 
	$lšdexCommªd
(
ş›Á
 *
c
) {

315 
robj
 *
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
);

316 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

317 
šdex
;

318 
robj
 *
v®ue
 = 
NULL
;

320 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
C_OK
))

323 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

324 
quickli¡EÁry
 
’Œy
;

325 ià(
	`quickli¡Index
(
o
->
±r
, 
šdex
, &
’Œy
)) {

326 ià(
’Œy
.
v®ue
) {

327 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
’Œy
.v®ue,’Œy.
sz
);

329 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
’Œy
.
lÚgv®
);

331 
	`addR•lyBulk
(
c
,
v®ue
);

332 
	`deüRefCouÁ
(
v®ue
);

334 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

337 
	`£rv”Pªic
("Unknown†istƒncoding");

339 
	}
}

341 
	$l£tCommªd
(
ş›Á
 *
c
) {

342 
robj
 *
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
);

343 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

344 
šdex
;

345 
robj
 *
v®ue
 = 
c
->
¬gv
[3];

347 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
C_OK
))

350 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

351 
quickli¡
 *
ql
 = 
o
->
±r
;

352 
»¶aûd
 = 
	`quickli¡R•ÏûAtIndex
(
ql
, 
šdex
,

353 
v®ue
->
±r
, 
	`sd¦’
(value->ptr));

354 ià(!
»¶aûd
) {

355 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

357 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

358 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

359 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"l£t",
c
->
¬gv
[1],c->
db
->
id
);

360 
£rv”
.
dœty
++;

363 
	`£rv”Pªic
("Unknown†istƒncoding");

365 
	}
}

367 
	$pİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

368 
robj
 *
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
);

369 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
OBJ_LIST
)) ;

371 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

372 ià(
v®ue
 =ğ
NULL
) {

373 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

375 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

377 
	`addR•lyBulk
(
c
,
v®ue
);

378 
	`deüRefCouÁ
(
v®ue
);

379 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

380 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

381 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

382 
c
->
¬gv
[1],c->
db
->
id
);

383 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

385 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

386 
£rv”
.
dœty
++;

388 
	}
}

390 
	$ÍİCommªd
(
ş›Á
 *
c
) {

391 
	`pİG’”icCommªd
(
c
,
LIST_HEAD
);

392 
	}
}

394 
	$½İCommªd
(
ş›Á
 *
c
) {

395 
	`pİG’”icCommªd
(
c
,
LIST_TAIL
);

396 
	}
}

398 
	$ÌªgeCommªd
(
ş›Á
 *
c
) {

399 
robj
 *
o
;

400 
¡¬t
, 
’d
, 
Î’
, 
¿ng–’
;

402 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
C_OK
) ||

403 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
C_OK
)) ;

405 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


406 || 
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) ;

407 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

410 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

411 ià(
’d
 < 0è’d = 
Î’
+end;

412 ià(
¡¬t
 < 0) start = 0;

416 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

417 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

420 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

421 
¿ng–’
 = (
’d
-
¡¬t
)+1;

424 
	`addR•lyMuÉiBulkL’
(
c
,
¿ng–’
);

425 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

426 
li¡Ty³I‹¿tÜ
 *
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
o
, 
¡¬t
, 
LIST_TAIL
);

428 
¿ng–’
--) {

429 
li¡Ty³EÁry
 
’Œy
;

430 
	`li¡Ty³Next
(
™”
, &
’Œy
);

431 
quickli¡EÁry
 *
qe
 = &
’Œy
.entry;

432 ià(
qe
->
v®ue
) {

433 
	`addR•lyBulkCBufãr
(
c
,
qe
->
v®ue
,qe->
sz
);

435 
	`addR•lyBulkLÚgLÚg
(
c
,
qe
->
lÚgv®
);

438 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

440 
	`£rv”Pªic
("Listƒncoding is‚ot QUICKLIST!");

442 
	}
}

444 
	$ÉrimCommªd
(
ş›Á
 *
c
) {

445 
robj
 *
o
;

446 
¡¬t
, 
’d
, 
Î’
, 
Érim
, 
¹rim
;

448 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
C_OK
) ||

449 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
C_OK
)) ;

451 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
ok
)è=ğ
NULL
 ||

452 
	`checkTy³
(
c
,
o
,
OBJ_LIST
)) ;

453 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

456 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

457 ià(
’d
 < 0è’d = 
Î’
+end;

458 ià(
¡¬t
 < 0) start = 0;

462 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

464 
Érim
 = 
Î’
;

465 
¹rim
 = 0;

467 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

468 
Érim
 = 
¡¬t
;

469 
¹rim
 = 
Î’
-
’d
-1;

473 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_QUICKLIST
) {

474 
	`quickli¡D–Rªge
(
o
->
±r
,0,
Érim
);

475 
	`quickli¡D–Rªge
(
o
->
±r
,-
¹rim
,rtrim);

477 
	`£rv”Pªic
("Unknown†istƒncoding");

480 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Érim",
c
->
¬gv
[1],c->
db
->
id
);

481 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

482 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

483 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

485 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

486 
£rv”
.
dœty
++;

487 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

488 
	}
}

490 
	$ÌemCommªd
(
ş›Á
 *
c
) {

491 
robj
 *
subjeù
, *
obj
;

492 
obj
 = 
c
->
¬gv
[3];

493 
tÜemove
;

494 
»moved
 = 0;

496 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
tÜemove
, 
NULL
è!ğ
C_OK
))

499 
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
);

500 ià(
subjeù
 =ğ
NULL
 || 
	`checkTy³
(
c
,subjeù,
OBJ_LIST
)) ;

502 
li¡Ty³I‹¿tÜ
 *
li
;

503 ià(
tÜemove
 < 0) {

504 
tÜemove
 = -toremove;

505 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,-1,
LIST_HEAD
);

507 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
LIST_TAIL
);

510 
li¡Ty³EÁry
 
’Œy
;

511 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

512 ià(
	`li¡Ty³Equ®
(&
’Œy
,
obj
)) {

513 
	`li¡Ty³D–‘e
(
li
, &
’Œy
);

514 
£rv”
.
dœty
++;

515 
»moved
++;

516 ià(
tÜemove
 && 
»moved
 ==oremove) ;

519 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

521 ià(
»moved
) {

522 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

523 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"Ìem",
c
->
¬gv
[1],c->
db
->
id
);

526 ià(
	`li¡Ty³L’gth
(
subjeù
) == 0) {

527 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

528 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

531 
	`addR•lyLÚgLÚg
(
c
,
»moved
);

532 
	}
}

550 
	$½İÍushHªdËPush
(
ş›Á
 *
c
, 
robj
 *
d¡key
,„obj *
d¡obj
,„obj *
v®ue
) {

552 ià(!
d¡obj
) {

553 
d¡obj
 = 
	`ü—‹Quickli¡Objeù
();

554 
	`quickli¡S‘O±iÚs
(
d¡obj
->
±r
, 
£rv”
.
li¡_max_zli¡_size
,

555 
£rv”
.
li¡_com´ess_d•th
);

556 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

558 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

559 
	`li¡Ty³Push
(
d¡obj
,
v®ue
,
LIST_HEAD
);

560 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"Íush",
d¡key
,
c
->
db
->
id
);

562 
	`addR•lyBulk
(
c
,
v®ue
);

563 
	}
}

565 
	$½İÍushCommªd
(
ş›Á
 *
c
) {

566 
robj
 *
sobj
, *
v®ue
;

567 ià((
sobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

568 
	`checkTy³
(
c
,
sobj
,
OBJ_LIST
)) ;

570 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

573 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

575 
robj
 *
dobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]);

576 
robj
 *
touchedkey
 = 
c
->
¬gv
[1];

578 ià(
dobj
 && 
	`checkTy³
(
c
,dobj,
OBJ_LIST
)) ;

579 
v®ue
 = 
	`li¡Ty³Pİ
(
sobj
,
LIST_TAIL
);

583 
	`šüRefCouÁ
(
touchedkey
);

584 
	`½İÍushHªdËPush
(
c
,c->
¬gv
[2],
dobj
,
v®ue
);

587 
	`deüRefCouÁ
(
v®ue
);

590 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,"½İ",
touchedkey
,
c
->
db
->
id
);

591 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

592 
	`dbD–‘e
(
c
->
db
,
touchedkey
);

593 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

594 
touchedkey
,
c
->
db
->
id
);

596 
	`sigÇlModif›dKey
(
c
->
db
,
touchedkey
);

597 
	`deüRefCouÁ
(
touchedkey
);

598 
£rv”
.
dœty
++;

600 
	}
}

625 
	$blockFÜKeys
(
ş›Á
 *
c
, 
robj
 **
keys
, 
numkeys
, 
m¡ime_t
 
timeout
,„obj *
rg‘
) {

626 
diùEÁry
 *
de
;

627 
li¡
 *
l
;

628 
j
;

630 
c
->
bpİ
.
timeout
 =imeout;

631 
c
->
bpİ
.
rg‘
 =arget;

633 ià(
rg‘
 !ğ
NULL
è
	`šüRefCouÁ
(target);

635 
j
 = 0; j < 
numkeys
; j++) {

637 ià(
	`diùAdd
(
c
->
bpİ
.
keys
,keys[
j
],
NULL
è!ğ
DICT_OK
) ;

638 
	`šüRefCouÁ
(
keys
[
j
]);

641 
de
 = 
	`diùFšd
(
c
->
db
->
blockšg_keys
,
keys
[
j
]);

642 ià(
de
 =ğ
NULL
) {

643 
»tv®
;

646 
l
 = 
	`li¡C»©e
();

647 
»tv®
 = 
	`diùAdd
(
c
->
db
->
blockšg_keys
,
keys
[
j
],
l
);

648 
	`šüRefCouÁ
(
keys
[
j
]);

649 
	`£rv”As£¹W™hInfo
(
c
,
keys
[
j
],
»tv®
 =ğ
DICT_OK
);

651 
l
 = 
	`diùG‘V®
(
de
);

653 
	`li¡AddNodeTa
(
l
,
c
);

655 
	`blockCl›Á
(
c
,
BLOCKED_LIST
);

656 
	}
}

660 
	$unblockCl›ÁWa™šgD©a
(
ş›Á
 *
c
) {

661 
diùEÁry
 *
de
;

662 
diùI‹¿tÜ
 *
di
;

663 
li¡
 *
l
;

665 
	`£rv”As£¹W™hInfo
(
c
,
NULL
,
	`diùSize
(c->
bpİ
.
keys
) != 0);

666 
di
 = 
	`diùG‘I‹¿tÜ
(
c
->
bpİ
.
keys
);

668 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

669 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

672 
l
 = 
	`diùF‘chV®ue
(
c
->
db
->
blockšg_keys
,
key
);

673 
	`£rv”As£¹W™hInfo
(
c
,
key
,
l
 !ğ
NULL
);

674 
	`li¡D–Node
(
l
,
	`li¡S—rchKey
Ö,
c
));

676 ià(
	`li¡L’gth
(
l
) == 0)

677 
	`diùD–‘e
(
c
->
db
->
blockšg_keys
,
key
);

679 
	`diùR–—£I‹¿tÜ
(
di
);

682 
	`diùEm±y
(
c
->
bpİ
.
keys
,
NULL
);

683 ià(
c
->
bpİ
.
rg‘
) {

684 
	`deüRefCouÁ
(
c
->
bpİ
.
rg‘
);

685 
c
->
bpİ
.
rg‘
 = 
NULL
;

687 
	}
}

696 
	$sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
) {

697 
»adyLi¡
 *
¾
;

700 ià(
	`diùFšd
(
db
->
blockšg_keys
,
key
è=ğ
NULL
) ;

703 ià(
	`diùFšd
(
db
->
»ady_keys
,
key
è!ğ
NULL
) ;

706 
¾
 = 
	`zm®loc
((*rl));

707 
¾
->
key
 = key;

708 
¾
->
db
 = db;

709 
	`šüRefCouÁ
(
key
);

710 
	`li¡AddNodeTa
(
£rv”
.
»ady_keys
,
¾
);

715 
	`šüRefCouÁ
(
key
);

716 
	`£rv”As£¹
(
	`diùAdd
(
db
->
»ady_keys
,
key
,
NULL
è=ğ
DICT_OK
);

717 
	}
}

738 
	$£rveCl›ÁBlockedOnLi¡
(
ş›Á
 *
»ûiv”
, 
robj
 *
key
,„obj *
d¡key
, 
»disDb
 *
db
,„obj *
v®ue
, 
wh”e
)

740 
robj
 *
¬gv
[3];

742 ià(
d¡key
 =ğ
NULL
) {

744 
¬gv
[0] = (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 :

745 
sh¬ed
.
½İ
;

746 
¬gv
[1] = 
key
;

747 
	`´İag©e
((
wh”e
 =ğ
LIST_HEAD
) ?

748 
£rv”
.
ÍİCommªd
 : s”v”.
½İCommªd
,

749 
db
->
id
,
¬gv
,2,
PROPAGATE_AOF
|
PROPAGATE_REPL
);

752 
	`addR•lyMuÉiBulkL’
(
»ûiv”
,2);

753 
	`addR•lyBulk
(
»ûiv”
,
key
);

754 
	`addR•lyBulk
(
»ûiv”
,
v®ue
);

757 
robj
 *
d¡obj
 =

758 
	`lookupKeyWr™e
(
»ûiv”
->
db
,
d¡key
);

759 ià(!(
d¡obj
 &&

760 
	`checkTy³
(
»ûiv”
,
d¡obj
,
OBJ_LIST
)))

763 
¬gv
[0] = 
sh¬ed
.
½İ
;

764 
¬gv
[1] = 
key
;

765 
	`´İag©e
(
£rv”
.
½İCommªd
,

766 
db
->
id
,
¬gv
,2,

767 
PROPAGATE_AOF
|

768 
PROPAGATE_REPL
);

769 
	`½İÍushHªdËPush
(
»ûiv”
,
d¡key
,
d¡obj
,

770 
v®ue
);

772 
¬gv
[0] = 
sh¬ed
.
Íush
;

773 
¬gv
[1] = 
d¡key
;

774 
¬gv
[2] = 
v®ue
;

775 
	`´İag©e
(
£rv”
.
ÍushCommªd
,

776 
db
->
id
,
¬gv
,3,

777 
PROPAGATE_AOF
|

778 
PROPAGATE_REPL
);

782  
C_ERR
;

785  
C_OK
;

786 
	}
}

798 
	$hªdËCl›ÁsBlockedOnLi¡s
() {

799 
	`li¡L’gth
(
£rv”
.
»ady_keys
) != 0) {

800 
li¡
 *
l
;

806 
l
 = 
£rv”
.
»ady_keys
;

807 
£rv”
.
»ady_keys
 = 
	`li¡C»©e
();

809 
	`li¡L’gth
(
l
) != 0) {

810 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

811 
»adyLi¡
 *
¾
 = 
Ê
->
v®ue
;

815 
	`diùD–‘e
(
¾
->
db
->
»ady_keys
,¾->
key
);

819 
robj
 *
o
 = 
	`lookupKeyWr™e
(
¾
->
db
,¾->
key
);

820 ià(
o
 !ğ
NULL
 && o->
ty³
 =ğ
OBJ_LIST
) {

821 
diùEÁry
 *
de
;

825 
de
 = 
	`diùFšd
(
¾
->
db
->
blockšg_keys
,¾->
key
);

826 ià(
de
) {

827 
li¡
 *
ş›Ás
 = 
	`diùG‘V®
(
de
);

828 
numş›Ás
 = 
	`li¡L’gth
(
ş›Ás
);

830 
numş›Ás
--) {

831 
li¡Node
 *
ş›Ánode
 = 
	`li¡Fœ¡
(
ş›Ás
);

832 
ş›Á
 *
»ûiv”
 = 
ş›Ánode
->
v®ue
;

833 
robj
 *
d¡key
 = 
»ûiv”
->
bpİ
.
rg‘
;

834 
wh”e
 = (
»ûiv”
->
Ï¡cmd
 &&

835 
»ûiv”
->
Ï¡cmd
->
´oc
 =ğ
bÍİCommªd
) ?

836 
LIST_HEAD
 : 
LIST_TAIL
;

837 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

839 ià(
v®ue
) {

843 ià(
d¡key
è
	`šüRefCouÁ
(dstkey);

844 
	`unblockCl›Á
(
»ûiv”
);

846 ià(
	`£rveCl›ÁBlockedOnLi¡
(
»ûiv”
,

847 
¾
->
key
,
d¡key
,¾->
db
,
v®ue
,

848 
wh”e
è=ğ
C_ERR
)

852 
	`li¡Ty³Push
(
o
,
v®ue
,
wh”e
);

855 ià(
d¡key
è
	`deüRefCouÁ
(dstkey);

856 
	`deüRefCouÁ
(
v®ue
);

863 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

864 
	`dbD–‘e
(
¾
->
db
,¾->
key
);

871 
	`deüRefCouÁ
(
¾
->
key
);

872 
	`zä“
(
¾
);

873 
	`li¡D–Node
(
l
,
Ê
);

875 
	`li¡R–—£
(
l
);

877 
	}
}

880 
	$blockšgPİG’”icCommªd
(
ş›Á
 *
c
, 
wh”e
) {

881 
robj
 *
o
;

882 
m¡ime_t
 
timeout
;

883 
j
;

885 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[c->
¬gc
-1],&
timeout
,
UNIT_SECONDS
)

886 !ğ
C_OK
) ;

888 
j
 = 1; j < 
c
->
¬gc
-1; j++) {

889 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]);

890 ià(
o
 !ğ
NULL
) {

891 ià(
o
->
ty³
 !ğ
OBJ_LIST
) {

892 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

895 ià(
	`li¡Ty³L’gth
(
o
) != 0) {

897 *
ev’t
 = (
wh”e
 =ğ
LIST_HEAD
) ? "lpop" : "rpop";

898 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

899 
	`£rv”As£¹
(
v®ue
 !ğ
NULL
);

901 
	`addR•lyMuÉiBulkL’
(
c
,2);

902 
	`addR•lyBulk
(
c
,c->
¬gv
[
j
]);

903 
	`addR•lyBulk
(
c
,
v®ue
);

904 
	`deüRefCouÁ
(
v®ue
);

905 
	`nÙifyKey¥aûEv’t
(
NOTIFY_LIST
,
ev’t
,

906 
c
->
¬gv
[
j
],c->
db
->
id
);

907 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

908 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[
j
]);

909 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

910 
c
->
¬gv
[
j
],c->
db
->
id
);

912 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

913 
£rv”
.
dœty
++;

916 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,

917 (
wh”e
 =ğ
LIST_HEAD
è? 
sh¬ed
.
Íİ
 : sh¬ed.
½İ
,

918 
c
->
¬gv
[
j
]);

927 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

928 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

933 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, c->
¬gc
 - 2, 
timeout
, 
NULL
);

934 
	}
}

936 
	$bÍİCommªd
(
ş›Á
 *
c
) {

937 
	`blockšgPİG’”icCommªd
(
c
,
LIST_HEAD
);

938 
	}
}

940 
	$b½İCommªd
(
ş›Á
 *
c
) {

941 
	`blockšgPİG’”icCommªd
(
c
,
LIST_TAIL
);

942 
	}
}

944 
	$b½İÍushCommªd
(
ş›Á
 *
c
) {

945 
m¡ime_t
 
timeout
;

947 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
timeout
,
UNIT_SECONDS
)

948 !ğ
C_OK
) ;

950 
robj
 *
key
 = 
	`lookupKeyWr™e
(
c
->
db
, c->
¬gv
[1]);

952 ià(
key
 =ğ
NULL
) {

953 ià(
c
->
æags
 & 
CLIENT_MULTI
) {

956 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

959 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, 1, 
timeout
, c->argv[2]);

962 ià(
key
->
ty³
 !ğ
OBJ_LIST
) {

963 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

967 
	`£rv”As£¹W™hInfo
(
c
,
key
,
	`li¡Ty³L’gth
(key) > 0);

968 
	`½İÍushCommªd
(
c
);

971 
	}
}

	@src/t_set.c

30 
	~"£rv”.h
"

36 
suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

37 
robj
 *
d¡key
, 
İ
);

42 
robj
 *
	$£tTy³C»©e
(
sds
 
v®ue
) {

43 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,
NULL
è=ğ
C_OK
)

44  
	`ü—‹IÁ£tObjeù
();

45  
	`ü—‹S‘Objeù
();

46 
	}
}

52 
	$£tTy³Add
(
robj
 *
subjeù
, 
sds
 
v®ue
) {

53 
Îv®
;

54 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

55 
diù
 *
ht
 = 
subjeù
->
±r
;

56 
diùEÁry
 *
de
 = 
	`diùAddRaw
(
ht
,
v®ue
,
NULL
);

57 ià(
de
) {

58 
	`diùS‘Key
(
ht
,
de
,
	`sdsdup
(
v®ue
));

59 
	`diùS‘V®
(
ht
,
de
,
NULL
);

62 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

63 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
C_OK
) {

64 
ušt8_t
 
sucûss
 = 0;

65 
subjeù
->
±r
 = 
	`št£tAdd
(subjeù->±r,
Îv®
,&
sucûss
);

66 ià(
sucûss
) {

69 ià(
	`št£tL’
(
subjeù
->
±r
è> 
£rv”
.
£t_max_št£t_’Œ›s
)

70 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

75 
	`£tTy³CÚv”t
(
subjeù
,
OBJ_ENCODING_HT
);

79 
	`£rv”As£¹
(
	`diùAdd
(
subjeù
->
±r
,
	`sdsdup
(
v®ue
),
NULL
è=ğ
DICT_OK
);

83 
	`£rv”Pªic
("Unknown setƒncoding");

86 
	}
}

88 
	$£tTy³Remove
(
robj
 *
£tobj
, 
sds
 
v®ue
) {

89 
Îv®
;

90 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

91 ià(
	`diùD–‘e
(
£tobj
->
±r
,
v®ue
è=ğ
DICT_OK
) {

92 ià(
	`htN“dsResize
(
£tobj
->
±r
)è
	`diùResize
(setobj->ptr);

95 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

96 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
C_OK
) {

97 
sucûss
;

98 
£tobj
->
±r
 = 
	`št£tRemove
(£tobj->±r,
Îv®
,&
sucûss
);

99 ià(
sucûss
)  1;

102 
	`£rv”Pªic
("Unknown setƒncoding");

105 
	}
}

107 
	$£tTy³IsMemb”
(
robj
 *
subjeù
, 
sds
 
v®ue
) {

108 
Îv®
;

109 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

110  
	`diùFšd
((
diù
*)
subjeù
->
±r
,
v®ue
è!ğ
NULL
;

111 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

112 ià(
	`isSdsR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
C_OK
) {

113  
	`št£tFšd
((
št£t
*)
subjeù
->
±r
,
Îv®
);

116 
	`£rv”Pªic
("Unknown setƒncoding");

119 
	}
}

121 
£tTy³I‹¿tÜ
 *
	$£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

122 
£tTy³I‹¿tÜ
 *
si
 = 
	`zm®loc
((setTypeIterator));

123 
si
->
subjeù
 = subject;

124 
si
->
’codšg
 = 
subjeù
->encoding;

125 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

126 
si
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

127 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

128 
si
->
ii
 = 0;

130 
	`£rv”Pªic
("Unknown setƒncoding");

132  
si
;

133 
	}
}

135 
	$£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
) {

136 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
)

137 
	`diùR–—£I‹¿tÜ
(
si
->
di
);

138 
	`zä“
(
si
);

139 
	}
}

154 
	$£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
) {

155 ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

156 
diùEÁry
 *
de
 = 
	`diùNext
(
si
->
di
);

157 ià(
de
 =ğ
NULL
)  -1;

158 *
sd£Ë
 = 
	`diùG‘Key
(
de
);

159 *
Î–e
 = -123456789;

160 } ià(
si
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

161 ià(!
	`št£tG‘
(
si
->
subjeù
->
±r
,si->
ii
++,
Î–e
))

163 *
sd£Ë
 = 
NULL
;

165 
	`£rv”Pªic
("Wrong setƒncoding in setTypeNext");

167  
si
->
’codšg
;

168 
	}
}

177 
sds
 
	$£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
) {

178 
št64_t
 
š‹Ë
;

179 
sds
 
sd£Ë
;

180 
’codšg
;

182 
’codšg
 = 
	`£tTy³Next
(
si
,&
sd£Ë
,&
š‹Ë
);

183 
’codšg
) {

184 -1:  
NULL
;

185 
OBJ_ENCODING_INTSET
:

186  
	`sdsäomlÚglÚg
(
š‹Ë
);

187 
OBJ_ENCODING_HT
:

188  
	`sdsdup
(
sd£Ë
);

190 
	`£rv”Pªic
("Unsupportedƒncoding");

192  
NULL
;

193 
	}
}

208 
	$£tTy³RªdomEËm’t
(
robj
 *
£tobj
, 
sds
 *
sd£Ë
, 
št64_t
 *
Î–e
) {

209 ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

210 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£tobj
->
±r
);

211 *
sd£Ë
 = 
	`diùG‘Key
(
de
);

212 *
Î–e
 = -123456789;

213 } ià(
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

214 *
Î–e
 = 
	`št£tRªdom
(
£tobj
->
±r
);

215 *
sd£Ë
 = 
NULL
;

217 
	`£rv”Pªic
("Unknown setƒncoding");

219  
£tobj
->
’codšg
;

220 
	}
}

222 
	$£tTy³Size
(cÚ¡ 
robj
 *
subjeù
) {

223 ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

224  
	`diùSize
((cÚ¡ 
diù
*)
subjeù
->
±r
);

225 } ià(
subjeù
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

226  
	`št£tL’
((cÚ¡ 
št£t
*)
subjeù
->
±r
);

228 
	`£rv”Pªic
("Unknown setƒncoding");

230 
	}
}

235 
	$£tTy³CÚv”t
(
robj
 *
£tobj
, 
’c
) {

236 
£tTy³I‹¿tÜ
 *
si
;

237 
	`£rv”As£¹W™hInfo
(
NULL
,
£tobj
,£tobj->
ty³
 =ğ
OBJ_SET
 &&

238 
£tobj
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
);

240 ià(
’c
 =ğ
OBJ_ENCODING_HT
) {

241 
št64_t
 
š‹Ë
;

242 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

243 
sds
 
–em’t
;

246 
	`diùEx·nd
(
d
,
	`št£tL’
(
£tobj
->
±r
));

249 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

250 
	`£tTy³Next
(
si
,&
–em’t
,&
š‹Ë
) != -1) {

251 
–em’t
 = 
	`sdsäomlÚglÚg
(
š‹Ë
);

252 
	`£rv”As£¹
(
	`diùAdd
(
d
,
–em’t
,
NULL
è=ğ
DICT_OK
);

254 
	`£tTy³R–—£I‹¿tÜ
(
si
);

256 
£tobj
->
’codšg
 = 
OBJ_ENCODING_HT
;

257 
	`zä“
(
£tobj
->
±r
);

258 
£tobj
->
±r
 = 
d
;

260 
	`£rv”Pªic
("Unsupported set conversion");

262 
	}
}

264 
	$§ddCommªd
(
ş›Á
 *
c
) {

265 
robj
 *
£t
;

266 
j
, 
added
 = 0;

268 
£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

269 ià(
£t
 =ğ
NULL
) {

270 
£t
 = 
	`£tTy³C»©e
(
c
->
¬gv
[2]->
±r
);

271 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
£t
);

273 ià(
£t
->
ty³
 !ğ
OBJ_SET
) {

274 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

279 
j
 = 2; j < 
c
->
¬gc
; j++) {

280 ià(
	`£tTy³Add
(
£t
,
c
->
¬gv
[
j
]->
±r
)è
added
++;

282 ià(
added
) {

283 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

284 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[1],c->
db
->
id
);

286 
£rv”
.
dœty
 +ğ
added
;

287 
	`addR•lyLÚgLÚg
(
c
,
added
);

288 
	}
}

290 
	$¤emCommªd
(
ş›Á
 *
c
) {

291 
robj
 *
£t
;

292 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

294 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

295 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

297 
j
 = 2; j < 
c
->
¬gc
; j++) {

298 ià(
	`£tTy³Remove
(
£t
,
c
->
¬gv
[
j
]->
±r
)) {

299 
d–‘ed
++;

300 ià(
	`£tTy³Size
(
£t
) == 0) {

301 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

302 
key»moved
 = 1;

307 ià(
d–‘ed
) {

308 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

309 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

310 ià(
key»moved
)

311 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

312 
c
->
db
->
id
);

313 
£rv”
.
dœty
 +ğ
d–‘ed
;

315 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

316 
	}
}

318 
	$smoveCommªd
(
ş›Á
 *
c
) {

319 
robj
 *
¤c£t
, *
d¡£t
, *
–e
;

320 
¤c£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

321 
d¡£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]);

322 
–e
 = 
c
->
¬gv
[3];

325 ià(
¤c£t
 =ğ
NULL
) {

326 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

332 ià(
	`checkTy³
(
c
,
¤c£t
,
OBJ_SET
) ||

333 (
d¡£t
 && 
	`checkTy³
(
c
,d¡£t,
OBJ_SET
))) ;

336 ià(
¤c£t
 =ğ
d¡£t
) {

337 
	`addR•ly
(
c
,
	`£tTy³IsMemb”
(
¤c£t
,
–e
->
±r
) ?

338 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

343 ià(!
	`£tTy³Remove
(
¤c£t
,
–e
->
±r
)) {

344 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

347 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

350 ià(
	`£tTy³Size
(
¤c£t
) == 0) {

351 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

352 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

356 ià(!
d¡£t
) {

357 
d¡£t
 = 
	`£tTy³C»©e
(
–e
->
±r
);

358 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
d¡£t
);

361 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

362 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

363 
£rv”
.
dœty
++;

366 ià(
	`£tTy³Add
(
d¡£t
,
–e
->
±r
)) {

367 
£rv”
.
dœty
++;

368 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"§dd",
c
->
¬gv
[2],c->
db
->
id
);

370 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

371 
	}
}

373 
	$sismemb”Commªd
(
ş›Á
 *
c
) {

374 
robj
 *
£t
;

376 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

377 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

379 ià(
	`£tTy³IsMemb”
(
£t
,
c
->
¬gv
[2]->
±r
))

380 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

382 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

383 
	}
}

385 
	$sÿrdCommªd
(
ş›Á
 *
c
) {

386 
robj
 *
o
;

388 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

389 
	`checkTy³
(
c
,
o
,
OBJ_SET
)) ;

391 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
o
));

392 
	}
}

400 
	#SPOP_MOVE_STRATEGY_MUL
 5

	)

402 
	$¥İW™hCouÁCommªd
(
ş›Á
 *
c
) {

403 
l
;

404 
couÁ
, 
size
;

405 
robj
 *
£t
;

408 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
C_OK
) ;

409 ià(
l
 >= 0) {

410 
couÁ
 = (è
l
;

412 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

418 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
))

419 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

423 ià(
couÁ
 == 0) {

424 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

428 
size
 = 
	`£tTy³Size
(
£t
);

431 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

432 
£rv”
.
dœty
 +ğ
couÁ
;

437 ià(
couÁ
 >ğ
size
) {

439 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,1,
NULL
,
SET_OP_UNION
);

442 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

443 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

446 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
sh¬ed
.
d–
,c->
¬gv
[1]);

447 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

448 
£rv”
.
dœty
++;

455 
robj
 *
´İ¬gv
[3];

456 
´İ¬gv
[0] = 
	`ü—‹SŒšgObjeù
("SREM",4);

457 
´İ¬gv
[1] = 
c
->
¬gv
[1];

458 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

461 
sds
 
sd£Ë
;

462 
robj
 *
obj–e
;

463 
’codšg
;

464 
št64_t
 
Î–e
;

465 
»maššg
 = 
size
-
couÁ
;

474 ià(
»maššg
*
SPOP_MOVE_STRATEGY_MUL
 > 
couÁ
) {

475 
couÁ
--) {

477 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
sd£Ë
,&
Î–e
);

478 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

479 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

480 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

481 
£t
->
±r
 = 
	`št£tRemove
(£t->±r,
Î–e
,
NULL
);

483 
	`addR•lyBulkCBufãr
(
c
,
sd£Ë
,
	`sd¦’
(sdsele));

484 
obj–e
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

485 
	`£tTy³Remove
(
£t
,
sd£Ë
);

489 
´İ¬gv
[2] = 
obj–e
;

490 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

491 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

492 
	`deüRefCouÁ
(
obj–e
);

503 
robj
 *
Ãw£t
 = 
NULL
;

506 
»maššg
--) {

507 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
sd£Ë
,&
Î–e
);

508 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

509 
sd£Ë
 = 
	`sdsäomlÚglÚg
(
Î–e
);

511 
sd£Ë
 = 
	`sdsdup
(sdsele);

513 ià(!
Ãw£t
èÃw£ˆğ
	`£tTy³C»©e
(
sd£Ë
);

514 
	`£tTy³Add
(
Ãw£t
,
sd£Ë
);

515 
	`£tTy³Remove
(
£t
,
sd£Ë
);

516 
	`sdsä“
(
sd£Ë
);

520 
	`šüRefCouÁ
(
£t
);

521 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw£t
);

524 
£tTy³I‹¿tÜ
 *
si
;

525 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

526 (
’codšg
 = 
	`£tTy³Next
(
si
,&
sd£Ë
,&
Î–e
)) != -1) {

527 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

528 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

529 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

531 
	`addR•lyBulkCBufãr
(
c
,
sd£Ë
,
	`sd¦’
(sdsele));

532 
obj–e
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

536 
´İ¬gv
[2] = 
obj–e
;

537 
	`®soPrİag©e
(
£rv”
.
¤emCommªd
,
c
->
db
->
id
,
´İ¬gv
,3,

538 
PROPAGATE_AOF
|
PROPAGATE_REPL
);

539 
	`deüRefCouÁ
(
obj–e
);

541 
	`£tTy³R–—£I‹¿tÜ
(
si
);

542 
	`deüRefCouÁ
(
£t
);

549 
	`deüRefCouÁ
(
´İ¬gv
[0]);

550 
	`´ev’tCommªdPrİag©iÚ
(
c
);

551 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

552 
£rv”
.
dœty
++;

553 
	}
}

555 
	$¥İCommªd
(
ş›Á
 *
c
) {

556 
robj
 *
£t
, *
–e
, *
aux
;

557 
sds
 
sd£Ë
;

558 
št64_t
 
Î–e
;

559 
’codšg
;

561 ià(
c
->
¬gc
 == 3) {

562 
	`¥İW™hCouÁCommªd
(
c
);

564 } ià(
c
->
¬gc
 > 3) {

565 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

571 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

572 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

575 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
sd£Ë
,&
Î–e
);

578 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

579 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

580 
£t
->
±r
 = 
	`št£tRemove
(£t->±r,
Î–e
,
NULL
);

582 
–e
 = 
	`ü—‹SŒšgObjeù
(
sd£Ë
,
	`sd¦’
(sdsele));

583 
	`£tTy³Remove
(
£t
,
–e
->
±r
);

586 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

589 
aux
 = 
	`ü—‹SŒšgObjeù
("SREM",4);

590 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,3,
aux
,c->
¬gv
[1],
–e
);

591 
	`deüRefCouÁ
(
aux
);

594 
	`addR•lyBulk
(
c
,
–e
);

595 
	`deüRefCouÁ
(
–e
);

598 ià(
	`£tTy³Size
(
£t
) == 0) {

599 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

600 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

604 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

605 
£rv”
.
dœty
++;

606 
	}
}

614 
	#SRANDMEMBER_SUB_STRATEGY_MUL
 3

	)

616 
	$¤ªdmemb”W™hCouÁCommªd
(
ş›Á
 *
c
) {

617 
l
;

618 
couÁ
, 
size
;

619 
uniq
 = 1;

620 
robj
 *
£t
;

621 
sds
 
–e
;

622 
št64_t
 
Î–e
;

623 
’codšg
;

625 
diù
 *
d
;

627 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
C_OK
) ;

628 ià(
l
 >= 0) {

629 
couÁ
 = (è
l
;

633 
couÁ
 = -
l
;

634 
uniq
 = 0;

637 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
))

638 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

639 
size
 = 
	`£tTy³Size
(
£t
);

642 ià(
couÁ
 == 0) {

643 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

651 ià(!
uniq
) {

652 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

653 
couÁ
--) {

654 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

655 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

656 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

658 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

667 ià(
couÁ
 >ğ
size
) {

668 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,1,
NULL
,
SET_OP_UNION
);

673 
d
 = 
	`diùC»©e
(&
objeùKeyPoš‹rV®ueDiùTy³
,
NULL
);

684 ià(
couÁ
*
SRANDMEMBER_SUB_STRATEGY_MUL
 > 
size
) {

685 
£tTy³I‹¿tÜ
 *
si
;

688 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

689 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–e
,&
Î–e
)) != -1) {

690 
»tv®
 = 
DICT_ERR
;

692 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

693 
»tv®
 = 
	`diùAdd
(
d
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
),
NULL
);

695 
»tv®
 = 
	`diùAdd
(
d
,
	`ü—‹SŒšgObjeù
(
–e
,
	`sd¦’
ÓË)),
NULL
);

697 
	`£rv”As£¹
(
»tv®
 =ğ
DICT_OK
);

699 
	`£tTy³R–—£I‹¿tÜ
(
si
);

700 
	`£rv”As£¹
(
	`diùSize
(
d
è=ğ
size
);

703 
size
 > 
couÁ
) {

704 
diùEÁry
 *
de
;

706 
de
 = 
	`diùG‘RªdomKey
(
d
);

707 
	`diùD–‘e
(
d
,
	`diùG‘Key
(
de
));

708 
size
--;

717 
added
 = 0;

718 
robj
 *
obj–e
;

720 
added
 < 
couÁ
) {

721 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

722 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

723 
obj–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

725 
obj–e
 = 
	`ü—‹SŒšgObjeù
(
–e
,
	`sd¦’
(ele));

730 ià(
	`diùAdd
(
d
,
obj–e
,
NULL
è=ğ
DICT_OK
)

731 
added
++;

733 
	`deüRefCouÁ
(
obj–e
);

739 
diùI‹¿tÜ
 *
di
;

740 
diùEÁry
 *
de
;

742 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

743 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

744 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
)

745 
	`addR•lyBulk
(
c
,
	`diùG‘Key
(
de
));

746 
	`diùR–—£I‹¿tÜ
(
di
);

747 
	`diùR–—£
(
d
);

749 
	}
}

751 
	$¤ªdmemb”Commªd
(
ş›Á
 *
c
) {

752 
robj
 *
£t
;

753 
sds
 
–e
;

754 
št64_t
 
Î–e
;

755 
’codšg
;

757 ià(
c
->
¬gc
 == 3) {

758 
	`¤ªdmemb”W™hCouÁCommªd
(
c
);

760 } ià(
c
->
¬gc
 > 3) {

761 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

765 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

766 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

768 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

769 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

770 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

772 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

774 
	}
}

776 
	$qsÜtCom·»S‘sByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

777 ià(
	`£tTy³Size
(*(
robj
**)
s1
è> s‘Ty³Size(*Ôobj**)
s2
))  1;

778 ià(
	`£tTy³Size
(*(
robj
**)
s1
è< s‘Ty³Size(*Ôobj**)
s2
))  -1;

780 
	}
}

784 
	$qsÜtCom·»S‘sByRevC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

785 
robj
 *
o1
 = *Ôobj**)
s1
, *
o2
 = *Ôobj**)
s2
;

786 
fœ¡
 = 
o1
 ? 
	`£tTy³Size
(o1) : 0;

787 
£cÚd
 = 
o2
 ? 
	`£tTy³Size
(o2) : 0;

789 ià(
fœ¡
 < 
£cÚd
)  1;

790 ià(
fœ¡
 > 
£cÚd
)  -1;

792 
	}
}

794 
	$sš‹rG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
,

795 
£Šum
, 
robj
 *
d¡key
) {

796 
robj
 **
£ts
 = 
	`zm®loc
(Ôobj*)*
£Šum
);

797 
£tTy³I‹¿tÜ
 *
si
;

798 
robj
 *
d¡£t
 = 
NULL
;

799 
sds
 
–esds
;

800 
št64_t
 
štobj
;

801 *
»¶yËn
 = 
NULL
;

802 
j
, 
ÿrdš®™y
 = 0;

803 
’codšg
;

805 
j
 = 0; j < 
£Šum
; j++) {

806 
robj
 *
£tobj
 = 
d¡key
 ?

807 
	`lookupKeyWr™e
(
c
->
db
,
£tkeys
[
j
]) :

808 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

809 ià(!
£tobj
) {

810 
	`zä“
(
£ts
);

811 ià(
d¡key
) {

812 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
)) {

813 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

814 
£rv”
.
dœty
++;

816 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

818 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

822 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

823 
	`zä“
(
£ts
);

826 
£ts
[
j
] = 
£tobj
;

830 
	`qsÜt
(
£ts
,
£Šum
,(
robj
*),
qsÜtCom·»S‘sByC¬dš®™y
);

837 ià(!
d¡key
) {

838 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

842 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

848 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[0]);

849 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–esds
,&
štobj
)) != -1) {

850 
j
 = 1; j < 
£Šum
; j++) {

851 ià(
£ts
[
j
] == sets[0]) ;

852 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

854 ià(
£ts
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_INTSET
 &&

855 !
	`št£tFšd
((
št£t
*)
£ts
[
j
]->
±r
,
štobj
))

861 } ià(
£ts
[
j
]->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

862 
–esds
 = 
	`sdsäomlÚglÚg
(
štobj
);

863 ià(!
	`£tTy³IsMemb”
(
£ts
[
j
],
–esds
)) {

864 
	`sdsä“
(
–esds
);

867 
	`sdsä“
(
–esds
);

869 } ià(
’codšg
 =ğ
OBJ_ENCODING_HT
) {

870 ià(!
	`£tTy³IsMemb”
(
£ts
[
j
],
–esds
)) {

877 ià(
j
 =ğ
£Šum
) {

878 ià(!
d¡key
) {

879 ià(
’codšg
 =ğ
OBJ_ENCODING_HT
)

880 
	`addR•lyBulkCBufãr
(
c
,
–esds
,
	`sd¦’
(elesds));

882 
	`addR•lyBulkLÚgLÚg
(
c
,
štobj
);

883 
ÿrdš®™y
++;

885 ià(
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

886 
–esds
 = 
	`sdsäomlÚglÚg
(
štobj
);

887 
	`£tTy³Add
(
d¡£t
,
–esds
);

888 
	`sdsä“
(
–esds
);

890 
	`£tTy³Add
(
d¡£t
,
–esds
);

895 
	`£tTy³R–—£I‹¿tÜ
(
si
);

897 ià(
d¡key
) {

900 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

901 ià(
	`£tTy³Size
(
d¡£t
) > 0) {

902 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

903 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

904 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,"sinterstore",

905 
d¡key
,
c
->
db
->
id
);

907 
	`deüRefCouÁ
(
d¡£t
);

908 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

909 ià(
d–‘ed
)

910 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

911 
d¡key
,
c
->
db
->
id
);

913 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

914 
£rv”
.
dœty
++;

916 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
ÿrdš®™y
);

918 
	`zä“
(
£ts
);

919 
	}
}

921 
	$sš‹rCommªd
(
ş›Á
 *
c
) {

922 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
);

923 
	}
}

925 
	$sš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

926 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->argv[1]);

927 
	}
}

929 
	#SET_OP_UNION
 0

	)

930 
	#SET_OP_DIFF
 1

	)

931 
	#SET_OP_INTER
 2

	)

933 
	$suniÚDiffG’”icCommªd
(
ş›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,

934 
robj
 *
d¡key
, 
İ
) {

935 
robj
 **
£ts
 = 
	`zm®loc
(Ôobj*)*
£Šum
);

936 
£tTy³I‹¿tÜ
 *
si
;

937 
robj
 *
d¡£t
 = 
NULL
;

938 
sds
 
–e
;

939 
j
, 
ÿrdš®™y
 = 0;

940 
diff_®go
 = 1;

942 
j
 = 0; j < 
£Šum
; j++) {

943 
robj
 *
£tobj
 = 
d¡key
 ?

944 
	`lookupKeyWr™e
(
c
->
db
,
£tkeys
[
j
]) :

945 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

946 ià(!
£tobj
) {

947 
£ts
[
j
] = 
NULL
;

950 ià(
	`checkTy³
(
c
,
£tobj
,
OBJ_SET
)) {

951 
	`zä“
(
£ts
);

954 
£ts
[
j
] = 
£tobj
;

966 ià(
İ
 =ğ
SET_OP_DIFF
 && 
£ts
[0]) {

967 
®go_Úe_wÜk
 = 0, 
®go_two_wÜk
 = 0;

969 
j
 = 0; j < 
£Šum
; j++) {

970 ià(
£ts
[
j
] =ğ
NULL
) ;

972 
®go_Úe_wÜk
 +ğ
	`£tTy³Size
(
£ts
[0]);

973 
®go_two_wÜk
 +ğ
	`£tTy³Size
(
£ts
[
j
]);

978 
®go_Úe_wÜk
 /= 2;

979 
diff_®go
 = (
®go_Úe_wÜk
 <ğ
®go_two_wÜk
) ? 1 : 2;

981 ià(
diff_®go
 =ğ1 && 
£Šum
 > 1) {

985 
	`qsÜt
(
£ts
+1,
£Šum
-1,(
robj
*),

986 
qsÜtCom·»S‘sByRevC¬dš®™y
);

993 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

995 ià(
İ
 =ğ
SET_OP_UNION
) {

998 
j
 = 0; j < 
£Šum
; j++) {

999 ià(!
£ts
[
j
]) ;

1001 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[
j
]);

1002 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1003 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

1004 
	`sdsä“
(
–e
);

1006 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1008 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
£ts
[0] && 
diff_®go
 == 1) {

1017 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[0]);

1018 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1019 
j
 = 1; j < 
£Šum
; j++) {

1020 ià(!
£ts
[
j
]) ;

1021 ià(
£ts
[
j
] == sets[0]) ;

1022 ià(
	`£tTy³IsMemb”
(
£ts
[
j
],
–e
)) ;

1024 ià(
j
 =ğ
£Šum
) {

1026 
	`£tTy³Add
(
d¡£t
,
–e
);

1027 
ÿrdš®™y
++;

1029 
	`sdsä“
(
–e
);

1031 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1032 } ià(
İ
 =ğ
SET_OP_DIFF
 && 
£ts
[0] && 
diff_®go
 == 2) {

1040 
j
 = 0; j < 
£Šum
; j++) {

1041 ià(!
£ts
[
j
]) ;

1043 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[
j
]);

1044 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1045 ià(
j
 == 0) {

1046 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

1048 ià(
	`£tTy³Remove
(
d¡£t
,
–e
)è
ÿrdš®™y
--;

1050 
	`sdsä“
(
–e
);

1052 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1056 ià(
ÿrdš®™y
 == 0) ;

1061 ià(!
d¡key
) {

1062 
	`addR•lyMuÉiBulkL’
(
c
,
ÿrdš®™y
);

1063 
si
 = 
	`£tTy³In™I‹¿tÜ
(
d¡£t
);

1064 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

1065 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

1066 
	`sdsä“
(
–e
);

1068 
	`£tTy³R–—£I‹¿tÜ
(
si
);

1069 
	`deüRefCouÁ
(
d¡£t
);

1073 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

1074 ià(
	`£tTy³Size
(
d¡£t
) > 0) {

1075 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

1076 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

1077 
	`nÙifyKey¥aûEv’t
(
NOTIFY_SET
,

1078 
İ
 =ğ
SET_OP_UNION
 ? "sunionstore" : "sdiffstore",

1079 
d¡key
,
c
->
db
->
id
);

1081 
	`deüRefCouÁ
(
d¡£t
);

1082 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1083 ià(
d–‘ed
)

1084 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"del",

1085 
d¡key
,
c
->
db
->
id
);

1087 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

1088 
£rv”
.
dœty
++;

1090 
	`zä“
(
£ts
);

1091 
	}
}

1093 
	$suniÚCommªd
(
ş›Á
 *
c
) {

1094 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_UNION
);

1095 
	}
}

1097 
	$suniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

1098 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_UNION
);

1099 
	}
}

1101 
	$sdiffCommªd
(
ş›Á
 *
c
) {

1102 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
SET_OP_DIFF
);

1103 
	}
}

1105 
	$sdiff¡ÜeCommªd
(
ş›Á
 *
c
) {

1106 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
SET_OP_DIFF
);

1107 
	}
}

1109 
	$ssÿnCommªd
(
ş›Á
 *
c
) {

1110 
robj
 *
£t
;

1111 
cursÜ
;

1113 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
C_ERR
) ;

1114 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

1115 
	`checkTy³
(
c
,
£t
,
OBJ_SET
)) ;

1116 
	`sÿnG’”icCommªd
(
c
,
£t
,
cursÜ
);

1117 
	}
}

	@src/t_string.c

30 
	~"£rv”.h
"

31 
	~<m©h.h
>

37 
	$checkSŒšgL’gth
(
ş›Á
 *
c
, 
size
) {

38 ià(
size
 > 512*1024*1024) {

39 
	`addR•lyE¼Ü
(
c
,"stringƒxceeds maximum‡llowed size (512MB)");

40  
C_ERR
;

42  
C_OK
;

43 
	}
}

61 
	#OBJ_SET_NO_FLAGS
 0

	)

62 
	#OBJ_SET_NX
 (1<<0è

	)

63 
	#OBJ_SET_XX
 (1<<1è

	)

64 
	#OBJ_SET_EX
 (1<<2è

	)

65 
	#OBJ_SET_PX
 (1<<3è

	)

67 
	$£tG’”icCommªd
(
ş›Á
 *
c
, 
æags
, 
robj
 *
key
,„obj *
v®
,„obj *
expœe
, 
un™
,„obj *
ok_»¶y
,„obj *
abÜt_»¶y
) {

68 
mli£cÚds
 = 0;

70 ià(
expœe
) {

71 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
expœe
, &
mli£cÚds
, 
NULL
è!ğ
C_OK
)

73 ià(
mli£cÚds
 <= 0) {

74 
	`addR•lyE¼ÜFÜm©
(
c
,"šv®idƒxpœtimš %s",c->
cmd
->
Çme
);

77 ià(
un™
 =ğ
UNIT_SECONDS
è
mli£cÚds
 *= 1000;

80 ià((
æags
 & 
OBJ_SET_NX
 && 
	`lookupKeyWr™e
(
c
->
db
,
key
è!ğ
NULL
) ||

81 (
æags
 & 
OBJ_SET_XX
 && 
	`lookupKeyWr™e
(
c
->
db
,
key
è=ğ
NULL
))

83 
	`addR•ly
(
c
, 
abÜt_»¶y
 ?‡bÜt_»¶y : 
sh¬ed
.
nuÎbulk
);

86 
	`£tKey
(
c
->
db
,
key
,
v®
);

87 
£rv”
.
dœty
++;

88 ià(
expœe
è
	`£tExpœe
(
c
,c->
db
,
key
,
	`m¡ime
()+
mli£cÚds
);

89 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
key
,
c
->
db
->
id
);

90 ià(
expœe
è
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,

91 "expœe",
key
,
c
->
db
->
id
);

92 
	`addR•ly
(
c
, 
ok_»¶y
 ? ok_»¶y : 
sh¬ed
.
ok
);

93 
	}
}

96 
	$£tCommªd
(
ş›Á
 *
c
) {

97 
j
;

98 
robj
 *
expœe
 = 
NULL
;

99 
un™
 = 
UNIT_SECONDS
;

100 
æags
 = 
OBJ_SET_NO_FLAGS
;

102 
j
 = 3; j < 
c
->
¬gc
; j++) {

103 *
a
 = 
c
->
¬gv
[
j
]->
±r
;

104 
robj
 *
Ãxt
 = (
j
 =ğ
c
->
¬gc
-1è? 
NULL
 : c->
¬gv
[j+1];

106 ià((
a
[0] == 'n' ||‡[0] == 'N') &&

107 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

108 !(
æags
 & 
OBJ_SET_XX
))

110 
æags
 |ğ
OBJ_SET_NX
;

111 } ià((
a
[0] == 'x' ||‡[0] == 'X') &&

112 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

113 !(
æags
 & 
OBJ_SET_NX
))

115 
æags
 |ğ
OBJ_SET_XX
;

116 } ià((
a
[0] == 'e' ||‡[0] == 'E') &&

117 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

118 !(
æags
 & 
OBJ_SET_PX
è&& 
Ãxt
)

120 
æags
 |ğ
OBJ_SET_EX
;

121 
un™
 = 
UNIT_SECONDS
;

122 
expœe
 = 
Ãxt
;

123 
j
++;

124 } ià((
a
[0] == 'p' ||‡[0] == 'P') &&

125 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0' &&

126 !(
æags
 & 
OBJ_SET_EX
è&& 
Ãxt
)

128 
æags
 |ğ
OBJ_SET_PX
;

129 
un™
 = 
UNIT_MILLISECONDS
;

130 
expœe
 = 
Ãxt
;

131 
j
++;

133 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

138 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

139 
	`£tG’”icCommªd
(
c
,
æags
,c->
¬gv
[1],c->¬gv[2],
expœe
,
un™
,
NULL
,NULL);

140 
	}
}

142 
	$£ŠxCommªd
(
ş›Á
 *
c
) {

143 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

144 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NX
,c->
¬gv
[1],c->¬gv[2],
NULL
,0,
sh¬ed
.
cÚe
,sh¬ed.
cz”o
);

145 
	}
}

147 
	$£‹xCommªd
(
ş›Á
 *
c
) {

148 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

149 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_SECONDS
,
NULL
,NULL);

150 
	}
}

152 
	$p£‹xCommªd
(
ş›Á
 *
c
) {

153 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

154 
	`£tG’”icCommªd
(
c
,
OBJ_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_MILLISECONDS
,
NULL
,NULL);

155 
	}
}

157 
	$g‘G’”icCommªd
(
ş›Á
 *
c
) {

158 
robj
 *
o
;

160 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
)

161  
C_OK
;

163 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

164 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

165  
C_ERR
;

167 
	`addR•lyBulk
(
c
,
o
);

168  
C_OK
;

170 
	}
}

172 
	$g‘Commªd
(
ş›Á
 *
c
) {

173 
	`g‘G’”icCommªd
(
c
);

174 
	}
}

176 
	$g‘£tCommªd
(
ş›Á
 *
c
) {

177 ià(
	`g‘G’”icCommªd
(
c
è=ğ
C_ERR
) ;

178 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

179 
	`£tKey
(
c
->
db
,c->
¬gv
[1],c->argv[2]);

180 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[1],c->
db
->
id
);

181 
£rv”
.
dœty
++;

182 
	}
}

184 
	$£ŒªgeCommªd
(
ş›Á
 *
c
) {

185 
robj
 *
o
;

186 
off£t
;

187 
sds
 
v®ue
 = 
c
->
¬gv
[3]->
±r
;

189 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
off£t
,
NULL
è!ğ
C_OK
)

192 ià(
off£t
 < 0) {

193 
	`addR•lyE¼Ü
(
c
,"offset is out of„ange");

197 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

198 ià(
o
 =ğ
NULL
) {

200 ià(
	`sd¦’
(
v®ue
) == 0) {

201 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

206 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
C_OK
)

209 
o
 = 
	`ü—‹Objeù
(
OBJ_STRING
,
	`sd¢ewËn
(
NULL
, 
off£t
+
	`sd¦’
(
v®ue
)));

210 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

212 
size_t
 
Ş’
;

215 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

219 
Ş’
 = 
	`¡ršgObjeùL’
(
o
);

220 ià(
	`sd¦’
(
v®ue
) == 0) {

221 
	`addR•lyLÚgLÚg
(
c
,
Ş’
);

226 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
C_OK
)

230 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

233 ià(
	`sd¦’
(
v®ue
) > 0) {

234 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
off£t
+
	`sd¦’
(
v®ue
));

235 
	`memıy
((*)
o
->
±r
+
off£t
,
v®ue
,
	`sd¦’
(value));

236 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

237 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,

238 "£Œªge",
c
->
¬gv
[1],c->
db
->
id
);

239 
£rv”
.
dœty
++;

241 
	`addR•lyLÚgLÚg
(
c
,
	`sd¦’
(
o
->
±r
));

242 
	}
}

244 
	$g‘¿ngeCommªd
(
ş›Á
 *
c
) {

245 
robj
 *
o
;

246 
¡¬t
, 
’d
;

247 *
¡r
, 
Îbuf
[32];

248 
size_t
 
¡¾’
;

250 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
C_OK
)

252 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
C_OK
)

254 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ybulk
)è=ğ
NULL
 ||

255 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

257 ià(
o
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

258 
¡r
 = 
Îbuf
;

259 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

261 
¡r
 = 
o
->
±r
;

262 
¡¾’
 = 
	`sd¦’
(
¡r
);

266 ià(
¡¬t
 < 0 && 
’d
 < 0 && start >ƒnd) {

267 
	`addR•ly
(
c
,
sh¬ed
.
em±ybulk
);

270 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

271 ià(
’d
 < 0è’d = 
¡¾’
+end;

272 ià(
¡¬t
 < 0) start = 0;

273 ià(
’d
 < 0)ƒnd = 0;

274 ià(()
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

278 ià(
¡¬t
 > 
’d
 || 
¡¾’
 == 0) {

279 
	`addR•ly
(
c
,
sh¬ed
.
em±ybulk
);

281 
	`addR•lyBulkCBufãr
(
c
,(*)
¡r
+
¡¬t
,
’d
-start+1);

283 
	}
}

285 
	$mg‘Commªd
(
ş›Á
 *
c
) {

286 
j
;

288 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-1);

289 
j
 = 1; j < 
c
->
¬gc
; j++) {

290 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

291 ià(
o
 =ğ
NULL
) {

292 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

294 ià(
o
->
ty³
 !ğ
OBJ_STRING
) {

295 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

297 
	`addR•lyBulk
(
c
,
o
);

301 
	}
}

303 
	$m£tG’”icCommªd
(
ş›Á
 *
c
, 
nx
) {

304 
j
, 
busykeys
 = 0;

306 ià((
c
->
¬gc
 % 2) == 0) {

307 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for MSET");

312 ià(
nx
) {

313 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

314 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]è!ğ
NULL
) {

315 
busykeys
++;

318 ià(
busykeys
) {

319 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

324 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

325 
c
->
¬gv
[
j
+1] = 
	`ŒyObjeùEncodšg
(c->argv[j+1]);

326 
	`£tKey
(
c
->
db
,c->
¬gv
[
j
],c->argv[j+1]);

327 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"£t",
c
->
¬gv
[
j
],c->
db
->
id
);

329 
£rv”
.
dœty
 +ğ(
c
->
¬gc
-1)/2;

330 
	`addR•ly
(
c
, 
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

331 
	}
}

333 
	$m£tCommªd
(
ş›Á
 *
c
) {

334 
	`m£tG’”icCommªd
(
c
,0);

335 
	}
}

337 
	$m£ŠxCommªd
(
ş›Á
 *
c
) {

338 
	`m£tG’”icCommªd
(
c
,1);

339 
	}
}

341 
	$šüDeüCommªd
(
ş›Á
 *
c
, 
šü
) {

342 
v®ue
, 
Şdv®ue
;

343 
robj
 *
o
, *
Ãw
;

345 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

346 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)) ;

347 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
C_OK
) ;

349 
Şdv®ue
 = 
v®ue
;

350 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

351 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

352 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

355 
v®ue
 +ğ
šü
;

357 ià(
o
 && o->
»fcouÁ
 =ğ1 && o->
’codšg
 =ğ
OBJ_ENCODING_INT
 &&

358 (
v®ue
 < 0 || v®u>ğ
OBJ_SHARED_INTEGERS
) &&

359 
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
)

361 
Ãw
 = 
o
;

362 
o
->
±r
 = (*)(()
v®ue
);

364 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

365 ià(
o
) {

366 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

368 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

371 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

372 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šüby",
c
->
¬gv
[1],c->
db
->
id
);

373 
£rv”
.
dœty
++;

374 
	`addR•ly
(
c
,
sh¬ed
.
cŞÚ
);

375 
	`addR•ly
(
c
,
Ãw
);

376 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

377 
	}
}

379 
	$šüCommªd
(
ş›Á
 *
c
) {

380 
	`šüDeüCommªd
(
c
,1);

381 
	}
}

383 
	$deüCommªd
(
ş›Á
 *
c
) {

384 
	`šüDeüCommªd
(
c
,-1);

385 
	}
}

387 
	$šübyCommªd
(
ş›Á
 *
c
) {

388 
šü
;

390 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
C_OK
) ;

391 
	`šüDeüCommªd
(
c
,
šü
);

392 
	}
}

394 
	$deübyCommªd
(
ş›Á
 *
c
) {

395 
šü
;

397 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
C_OK
) ;

398 
	`šüDeüCommªd
(
c
,-
šü
);

399 
	}
}

401 
	$šübyæßtCommªd
(
ş›Á
 *
c
) {

402 
šü
, 
v®ue
;

403 
robj
 *
o
, *
Ãw
, *
aux
;

405 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

406 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
OBJ_STRING
)) ;

407 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
C_OK
 ||

408 
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
šü
,
NULL
è!ğ
C_OK
)

411 
v®ue
 +ğ
šü
;

412 ià(
	`i¢ª
(
v®ue
è|| 
	`isšf
(value)) {

413 
	`addR•lyE¼Ü
(
c
,"increment would…roduce NaN or Infinity");

416 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
,1);

417 ià(
o
)

418 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

420 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

421 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

422 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"šübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

423 
£rv”
.
dœty
++;

424 
	`addR•lyBulk
(
c
,
Ãw
);

429 
aux
 = 
	`ü—‹SŒšgObjeù
("SET",3);

430 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

431 
	`deüRefCouÁ
(
aux
);

432 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,2,
Ãw
);

433 
	}
}

435 
	$­³ndCommªd
(
ş›Á
 *
c
) {

436 
size_t
 
tÙËn
;

437 
robj
 *
o
, *
­³nd
;

439 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

440 ià(
o
 =ğ
NULL
) {

442 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

443 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],c->argv[2]);

444 
	`šüRefCouÁ
(
c
->
¬gv
[2]);

445 
tÙËn
 = 
	`¡ršgObjeùL’
(
c
->
¬gv
[2]);

448 ià(
	`checkTy³
(
c
,
o
,
OBJ_STRING
))

452 
­³nd
 = 
c
->
¬gv
[2];

453 
tÙËn
 = 
	`¡ršgObjeùL’
(
o
)+
	`sd¦’
(
­³nd
->
±r
);

454 ià(
	`checkSŒšgL’gth
(
c
,
tÙËn
è!ğ
C_OK
)

458 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

459 
o
->
±r
 = 
	`sdsÿ’
(o->±r,
­³nd
->±r,
	`sd¦’
(append->ptr));

460 
tÙËn
 = 
	`sd¦’
(
o
->
±r
);

462 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

463 
	`nÙifyKey¥aûEv’t
(
NOTIFY_STRING
,"­³nd",
c
->
¬gv
[1],c->
db
->
id
);

464 
£rv”
.
dœty
++;

465 
	`addR•lyLÚgLÚg
(
c
,
tÙËn
);

466 
	}
}

468 
	$¡¾’Commªd
(
ş›Á
 *
c
) {

469 
robj
 *
o
;

470 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

471 
	`checkTy³
(
c
,
o
,
OBJ_STRING
)) ;

472 
	`addR•lyLÚgLÚg
(
c
,
	`¡ršgObjeùL’
(
o
));

473 
	}
}

	@src/t_zset.c

59 
	~"£rv”.h
"

60 
	~<m©h.h
>

66 
z¦LexV®ueG‹Mš
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

67 
z¦LexV®ueL‹Max
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

71 
zskli¡Node
 *
	$z¦C»©eNode
(
Ëv–
, 
scÜe
, 
sds
 
–e
) {

72 
zskli¡Node
 *
zn
 =

73 
	`zm®loc
((*
zn
)+
Ëv–
*(
zskli¡Lev–
));

74 
zn
->
scÜe
 = score;

75 
zn
->
–e
 =ƒle;

76  
zn
;

77 
	}
}

80 
zskli¡
 *
	$z¦C»©e
() {

81 
j
;

82 
zskli¡
 *
z¦
;

84 
z¦
 = 
	`zm®loc
((*zsl));

85 
z¦
->
Ëv–
 = 1;

86 
z¦
->
Ëngth
 = 0;

87 
z¦
->
h—d”
 = 
	`z¦C»©eNode
(
ZSKIPLIST_MAXLEVEL
,0,
NULL
);

88 
j
 = 0; j < 
ZSKIPLIST_MAXLEVEL
; j++) {

89 
z¦
->
h—d”
->
Ëv–
[
j
].
fÜw¬d
 = 
NULL
;

90 
z¦
->
h—d”
->
Ëv–
[
j
].
¥ª
 = 0;

92 
z¦
->
h—d”
->
backw¬d
 = 
NULL
;

93 
z¦
->

 = 
NULL
;

94  
z¦
;

95 
	}
}

100 
	$z¦F»eNode
(
zskli¡Node
 *
node
) {

101 
	`sdsä“
(
node
->
–e
);

102 
	`zä“
(
node
);

103 
	}
}

106 
	$z¦F»e
(
zskli¡
 *
z¦
) {

107 
zskli¡Node
 *
node
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
, *
Ãxt
;

109 
	`zä“
(
z¦
->
h—d”
);

110 
node
) {

111 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

112 
	`z¦F»eNode
(
node
);

113 
node
 = 
Ãxt
;

115 
	`zä“
(
z¦
);

116 
	}
}

122 
	$z¦RªdomLev–
() {

123 
Ëv–
 = 1;

124 (
	`¿ndom
()&0xFFFFè< (
ZSKIPLIST_P
 * 0xFFFF))

125 
Ëv–
 += 1;

126  (
Ëv–
<
ZSKIPLIST_MAXLEVEL
) ?†evel : ZSKIPLIST_MAXLEVEL;

127 
	}
}

132 
zskli¡Node
 *
	$z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
) {

133 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

134 
¿nk
[
ZSKIPLIST_MAXLEVEL
];

135 
i
, 
Ëv–
;

137 
	`£rv”As£¹
(!
	`i¢ª
(
scÜe
));

138 
x
 = 
z¦
->
h—d”
;

139 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

141 
¿nk
[
i
] = i =ğ(
z¦
->
Ëv–
-1) ? 0 :„ank[i+1];

142 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

143 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

144 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

145 
	`sdscmp
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,ele) < 0)))

147 
¿nk
[
i
] +ğ
x
->
Ëv–
[i].
¥ª
;

148 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

150 
upd©e
[
i
] = 
x
;

156 
Ëv–
 = 
	`z¦RªdomLev–
();

157 ià(
Ëv–
 > 
z¦
->level) {

158 
i
 = 
z¦
->
Ëv–
; i <†evel; i++) {

159 
¿nk
[
i
] = 0;

160 
upd©e
[
i
] = 
z¦
->
h—d”
;

161 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = 
z¦
->
Ëngth
;

163 
z¦
->
Ëv–
 =†evel;

165 
x
 = 
	`z¦C»©eNode
(
Ëv–
,
scÜe
,
–e
);

166 
i
 = 0; i < 
Ëv–
; i++) {

167 
x
->
Ëv–
[
i
].
fÜw¬d
 = 
upd©e
[i]->level[i].forward;

168 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
;

171 
x
->
Ëv–
[
i
].
¥ª
 = 
upd©e
[i]->Ëv–[i].¥ª - (
¿nk
[0] -„ank[i]);

172 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = (
¿nk
[0] -„ank[i]) + 1;

176 
i
 = 
Ëv–
; i < 
z¦
->level; i++) {

177 
upd©e
[
i
]->
Ëv–
[i].
¥ª
++;

180 
x
->
backw¬d
 = (
upd©e
[0] =ğ
z¦
->
h—d”
è? 
NULL
 : update[0];

181 ià(
x
->
Ëv–
[0].
fÜw¬d
)

182 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x;

184 
z¦
->

 = 
x
;

185 
z¦
->
Ëngth
++;

186  
x
;

187 
	}
}

190 
	$z¦D–‘eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
x
, zskli¡Nod**
upd©e
) {

191 
i
;

192 
i
 = 0; i < 
z¦
->
Ëv–
; i++) {

193 ià(
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 =ğ
x
) {

194 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 +ğ
x
->level[i].span - 1;

195 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
->level[i].forward;

197 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 -= 1;

200 ià(
x
->
Ëv–
[0].
fÜw¬d
) {

201 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x->backward;

203 
z¦
->

 = 
x
->
backw¬d
;

205 
z¦
->
Ëv–
 > 1 && z¦->
h—d”
->Ëv–[z¦->Ëv–-1].
fÜw¬d
 =ğ
NULL
)

206 
z¦
->
Ëv–
--;

207 
z¦
->
Ëngth
--;

208 
	}
}

218 
	$z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
, 
zskli¡Node
 **
node
) {

219 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

220 
i
;

222 
x
 = 
z¦
->
h—d”
;

223 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

224 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

225 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

226 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

227 
	`sdscmp
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,ele) < 0)))

229 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

231 
upd©e
[
i
] = 
x
;

235 
x
 = x->
Ëv–
[0].
fÜw¬d
;

236 ià(
x
 && 
scÜe
 =ğx->scÜ&& 
	`sdscmp
(x->
–e
,ele) == 0) {

237 
	`z¦D–‘eNode
(
z¦
, 
x
, 
upd©e
);

238 ià(!
node
)

239 
	`z¦F»eNode
(
x
);

241 *
node
 = 
x
;

245 
	}
}

247 
	$z¦V®ueG‹Mš
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

248  
¥ec
->
mšex
 ? (
v®ue
 > s³c->
mš
) : (value >= spec->min);

249 
	}
}

251 
	$z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

252  
¥ec
->
maxex
 ? (
v®ue
 < s³c->
max
) : (value <= spec->max);

253 
	}
}

256 
	$z¦IsInRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

257 
zskli¡Node
 *
x
;

260 ià(
¿nge
->
mš
 >„ªge->
max
 ||

261 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

263 
x
 = 
z¦
->

;

264 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueG‹Mš
(x->
scÜe
,
¿nge
))

266 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

267 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueL‹Max
(x->
scÜe
,
¿nge
))

270 
	}
}

274 
zskli¡Node
 *
	$z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

275 
zskli¡Node
 *
x
;

276 
i
;

279 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

281 
x
 = 
z¦
->
h—d”
;

282 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

284 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

285 !
	`z¦V®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

286 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

290 
x
 = x->
Ëv–
[0].
fÜw¬d
;

291 
	`£rv”As£¹
(
x
 !ğ
NULL
);

294 ià(!
	`z¦V®ueL‹Max
(
x
->
scÜe
,
¿nge
)è 
NULL
;

295  
x
;

296 
	}
}

300 
zskli¡Node
 *
	$z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

301 
zskli¡Node
 *
x
;

302 
i
;

305 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

307 
x
 = 
z¦
->
h—d”
;

308 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

310 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

311 
	`z¦V®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

312 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

316 
	`£rv”As£¹
(
x
 !ğ
NULL
);

319 ià(!
	`z¦V®ueG‹Mš
(
x
->
scÜe
,
¿nge
)è 
NULL
;

320  
x
;

321 
	}
}

327 
	$z¦D–‘eRªgeByScÜe
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

328 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

329 
»moved
 = 0;

330 
i
;

332 
x
 = 
z¦
->
h—d”
;

333 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

334 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
¿nge
->
mšex
 ?

335 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 <ğ
¿nge
->
mš
 :

336 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < 
¿nge
->
mš
))

337 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

338 
upd©e
[
i
] = 
x
;

342 
x
 = x->
Ëv–
[0].
fÜw¬d
;

345 
x
 &&

346 (
¿nge
->
maxex
 ? 
x
->
scÜe
 <„ªge->
max
 : x->score <=„ange->max))

348 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

349 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

350 
	`diùD–‘e
(
diù
,
x
->
–e
);

351 
	`z¦F»eNode
(
x
);

352 
»moved
++;

353 
x
 = 
Ãxt
;

355  
»moved
;

356 
	}
}

358 
	$z¦D–‘eRªgeByLex
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

359 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

360 
»moved
 = 0;

361 
i
;

364 
x
 = 
z¦
->
h—d”
;

365 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

366 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

367 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,
¿nge
))

368 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

369 
upd©e
[
i
] = 
x
;

373 
x
 = x->
Ëv–
[0].
fÜw¬d
;

376 
x
 && 
	`z¦LexV®ueL‹Max
(x->
–e
,
¿nge
)) {

377 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

378 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

379 
	`diùD–‘e
(
diù
,
x
->
–e
);

380 
	`z¦F»eNode
(
x
);

381 
»moved
++;

382 
x
 = 
Ãxt
;

384  
»moved
;

385 
	}
}

389 
	$z¦D–‘eRªgeByRªk
(
zskli¡
 *
z¦
, 
¡¬t
, 
’d
, 
diù
 *dict) {

390 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

391 
Œav”£d
 = 0, 
»moved
 = 0;

392 
i
;

394 
x
 = 
z¦
->
h—d”
;

395 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

396 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è< 
¡¬t
) {

397 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

398 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

400 
upd©e
[
i
] = 
x
;

403 
Œav”£d
++;

404 
x
 = x->
Ëv–
[0].
fÜw¬d
;

405 
x
 && 
Œav”£d
 <ğ
’d
) {

406 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

407 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

408 
	`diùD–‘e
(
diù
,
x
->
–e
);

409 
	`z¦F»eNode
(
x
);

410 
»moved
++;

411 
Œav”£d
++;

412 
x
 = 
Ãxt
;

414  
»moved
;

415 
	}
}

421 
	$z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
sds
 
–e
) {

422 
zskli¡Node
 *
x
;

423 
¿nk
 = 0;

424 
i
;

426 
x
 = 
z¦
->
h—d”
;

427 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

428 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

429 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

430 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

431 
	`sdscmp
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,ele) <= 0))) {

432 
¿nk
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

433 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

437 ià(
x
->
–e
 && 
	`sdscmp
(x->ele,ele) == 0) {

438  
¿nk
;

442 
	}
}

445 
zskli¡Node
* 
	$z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
) {

446 
zskli¡Node
 *
x
;

447 
Œav”£d
 = 0;

448 
i
;

450 
x
 = 
z¦
->
h—d”
;

451 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

452 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è<ğ
¿nk
)

454 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

455 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

457 ià(
Œav”£d
 =ğ
¿nk
) {

458  
x
;

461  
NULL
;

462 
	}
}

465 
	$z¦P¬£Rªge
(
robj
 *
mš
,„obj *
max
, 
z¿nge¥ec
 *
¥ec
) {

466 *
•Œ
;

467 
¥ec
->
mšex
 = s³c->
maxex
 = 0;

473 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

474 
¥ec
->
mš
 = ()mš->
±r
;

476 ià(((*)
mš
->
±r
)[0] == '(') {

477 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
+1,&
•Œ
);

478 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
C_ERR
;

479 
¥ec
->
mšex
 = 1;

481 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
,&
•Œ
);

482 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
C_ERR
;

485 ià(
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
) {

486 
¥ec
->
max
 = ()max->
±r
;

488 ià(((*)
max
->
±r
)[0] == '(') {

489 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
+1,&
•Œ
);

490 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
C_ERR
;

491 
¥ec
->
maxex
 = 1;

493 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
,&
•Œ
);

494 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
C_ERR
;

498  
C_OK
;

499 
	}
}

516 
	$z¦P¬£LexRªgeI‹m
(
robj
 *
™em
, 
sds
 *
de¡
, *
ex
) {

517 *
c
 = 
™em
->
±r
;

519 
c
[0]) {

521 ià(
c
[1] !ğ'\0'è 
C_ERR
;

522 *
ex
 = 0;

523 *
de¡
 = 
sh¬ed
.
max¡ršg
;

524  
C_OK
;

526 ià(
c
[1] !ğ'\0'è 
C_ERR
;

527 *
ex
 = 0;

528 *
de¡
 = 
sh¬ed
.
mš¡ršg
;

529  
C_OK
;

531 *
ex
 = 1;

532 *
de¡
 = 
	`sd¢ewËn
(
c
+1,
	`sd¦’
(c)-1);

533  
C_OK
;

535 *
ex
 = 0;

536 *
de¡
 = 
	`sd¢ewËn
(
c
+1,
	`sd¦’
(c)-1);

537  
C_OK
;

539  
C_ERR
;

541 
	}
}

545 
	$z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
) {

546 ià(
¥ec
->
mš
 !ğ
sh¬ed
.
mš¡ršg
 &&

547 
¥ec
->
mš
 !ğ
sh¬ed
.
max¡ršg
è
	`sdsä“
(spec->min);

548 ià(
¥ec
->
max
 !ğ
sh¬ed
.
mš¡ršg
 &&

549 
¥ec
->
max
 !ğ
sh¬ed
.
max¡ršg
è
	`sdsä“
(spec->max);

550 
	}
}

557 
	$z¦P¬£LexRªge
(
robj
 *
mš
,„obj *
max
, 
zËx¿nge¥ec
 *
¥ec
) {

560 ià(
mš
->
’codšg
 =ğ
OBJ_ENCODING_INT
 ||

561 
max
->
’codšg
 =ğ
OBJ_ENCODING_INT
è 
C_ERR
;

563 
¥ec
->
mš
 = s³c->
max
 = 
NULL
;

564 ià(
	`z¦P¬£LexRªgeI‹m
(
mš
, &
¥ec
->mš, &¥ec->
mšex
è=ğ
C_ERR
 ||

565 
	`z¦P¬£LexRªgeI‹m
(
max
, &
¥ec
->max, &¥ec->
maxex
è=ğ
C_ERR
) {

566 
	`z¦F»eLexRªge
(
¥ec
);

567  
C_ERR
;

569  
C_OK
;

571 
	}
}

576 
	$sdscm¶ex
(
sds
 
a
, sd 
b
) {

577 ià(
a
 =ğ
b
)  0;

578 ià(
a
 =ğ
sh¬ed
.
mš¡ršg
 || 
b
 =ğsh¬ed.
max¡ršg
)  -1;

579 ià(
a
 =ğ
sh¬ed
.
max¡ršg
 || 
b
 =ğsh¬ed.
mš¡ršg
)  1;

580  
	`sdscmp
(
a
,
b
);

581 
	}
}

583 
	$z¦LexV®ueG‹Mš
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

584  
¥ec
->
mšex
 ?

585 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
mš
) > 0) :

586 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
mš
) >= 0);

587 
	}
}

589 
	$z¦LexV®ueL‹Max
(
sds
 
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

590  
¥ec
->
maxex
 ?

591 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
max
) < 0) :

592 (
	`sdscm¶ex
(
v®ue
,
¥ec
->
max
) <= 0);

593 
	}
}

596 
	$z¦IsInLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

597 
zskli¡Node
 *
x
;

600 ià(
	`sdscm¶ex
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

601 (
	`sdscmp
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

602 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

604 
x
 = 
z¦
->

;

605 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueG‹Mš
(x->
–e
,
¿nge
))

607 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

608 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueL‹Max
(x->
–e
,
¿nge
))

611 
	}
}

615 
zskli¡Node
 *
	$z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

616 
zskli¡Node
 *
x
;

617 
i
;

620 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

622 
x
 = 
z¦
->
h—d”
;

623 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

625 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

626 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,
¿nge
))

627 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

631 
x
 = x->
Ëv–
[0].
fÜw¬d
;

632 
	`£rv”As£¹
(
x
 !ğ
NULL
);

635 ià(!
	`z¦LexV®ueL‹Max
(
x
->
–e
,
¿nge
)è 
NULL
;

636  
x
;

637 
	}
}

641 
zskli¡Node
 *
	$z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

642 
zskli¡Node
 *
x
;

643 
i
;

646 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

648 
x
 = 
z¦
->
h—d”
;

649 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

651 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

652 
	`z¦LexV®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
–e
,
¿nge
))

653 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

657 
	`£rv”As£¹
(
x
 !ğ
NULL
);

660 ià(!
	`z¦LexV®ueG‹Mš
(
x
->
–e
,
¿nge
)è 
NULL
;

661  
x
;

662 
	}
}

668 
	$zzlG‘ScÜe
(*
¥Œ
) {

669 *
v¡r
;

670 
vËn
;

671 
vlÚg
;

672 
buf
[128];

673 
scÜe
;

675 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

676 
	`£rv”As£¹
(
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

678 ià(
v¡r
) {

679 
	`memıy
(
buf
,
v¡r
,
vËn
);

680 
buf
[
vËn
] = '\0';

681 
scÜe
 = 
	`¡¹od
(
buf
,
NULL
);

683 
scÜe
 = 
vlÚg
;

686  
scÜe
;

687 
	}
}

690 
sds
 
	$zli¡G‘Objeù
(*
¥Œ
) {

691 *
v¡r
;

692 
vËn
;

693 
vlÚg
;

695 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

696 
	`£rv”As£¹
(
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

698 ià(
v¡r
) {

699  
	`sd¢ewËn
((*)
v¡r
,
vËn
);

701  
	`sdsäomlÚglÚg
(
vlÚg
);

703 
	}
}

706 
	$zzlCom·»EËm’ts
(*
•Œ
, *
c¡r
, 
ş’
) {

707 *
v¡r
;

708 
vËn
;

709 
vlÚg
;

710 
vbuf
[32];

711 
mšËn
, 
cmp
;

713 
	`£rv”As£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

714 ià(
v¡r
 =ğ
NULL
) {

716 
vËn
 = 
	`Î2¡ršg
((*)
vbuf
,(vbuf),
vlÚg
);

717 
v¡r
 = 
vbuf
;

720 
mšËn
 = (
vËn
 < 
ş’
) ? vlen : clen;

721 
cmp
 = 
	`memcmp
(
v¡r
,
c¡r
,
mšËn
);

722 ià(
cmp
 =ğ0è 
vËn
-
ş’
;

723  
cmp
;

724 
	}
}

726 
	$zzlL’gth
(*
zl
) {

727  
	`zli¡L’
(
zl
)/2;

728 
	}
}

732 
	$zzlNext
(*
zl
, **
•Œ
, **
¥Œ
) {

733 *
_•Œ
, *
_¥Œ
;

734 
	`£rv”As£¹
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

736 
_•Œ
 = 
	`zli¡Next
(
zl
,*
¥Œ
);

737 ià(
_•Œ
 !ğ
NULL
) {

738 
_¥Œ
 = 
	`zli¡Next
(
zl
,
_•Œ
);

739 
	`£rv”As£¹
(
_¥Œ
 !ğ
NULL
);

742 
_¥Œ
 = 
NULL
;

745 *
•Œ
 = 
_•Œ
;

746 *
¥Œ
 = 
_¥Œ
;

747 
	}
}

751 
	$zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
) {

752 *
_•Œ
, *
_¥Œ
;

753 
	`£rv”As£¹
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

755 
_¥Œ
 = 
	`zli¡P»v
(
zl
,*
•Œ
);

756 ià(
_¥Œ
 !ğ
NULL
) {

757 
_•Œ
 = 
	`zli¡P»v
(
zl
,
_¥Œ
);

758 
	`£rv”As£¹
(
_•Œ
 !ğ
NULL
);

761 
_•Œ
 = 
NULL
;

764 *
•Œ
 = 
_•Œ
;

765 *
¥Œ
 = 
_¥Œ
;

766 
	}
}

770 
	$zzlIsInRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

771 *
p
;

772 
scÜe
;

775 ià(
¿nge
->
mš
 >„ªge->
max
 ||

776 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

779 
p
 = 
	`zli¡Index
(
zl
,-1);

780 ià(
p
 =ğ
NULL
)  0;

781 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

782 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

785 
p
 = 
	`zli¡Index
(
zl
,1);

786 
	`£rv”As£¹
(
p
 !ğ
NULL
);

787 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

788 ià(!
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

792 
	}
}

796 *
	$zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

797 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

798 
scÜe
;

801 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

803 
•Œ
 !ğ
NULL
) {

804 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

805 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

807 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

808 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
)) {

810 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

811  
•Œ
;

812  
NULL
;

816 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

819  
NULL
;

820 
	}
}

824 *
	$zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

825 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

826 
scÜe
;

829 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

831 
•Œ
 !ğ
NULL
) {

832 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

833 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

835 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

836 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

838 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

839  
•Œ
;

840  
NULL
;

845 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

846 ià(
¥Œ
 !ğ
NULL
)

847 
	`£rv”As£¹
((
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
)è!ğ
NULL
);

849 
•Œ
 = 
NULL
;

852  
NULL
;

853 
	}
}

855 
	$zzlLexV®ueG‹Mš
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

856 
sds
 
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

857 
»s
 = 
	`z¦LexV®ueG‹Mš
(
v®ue
,
¥ec
);

858 
	`sdsä“
(
v®ue
);

859  
»s
;

860 
	}
}

862 
	$zzlLexV®ueL‹Max
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

863 
sds
 
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

864 
»s
 = 
	`z¦LexV®ueL‹Max
(
v®ue
,
¥ec
);

865 
	`sdsä“
(
v®ue
);

866  
»s
;

867 
	}
}

871 
	$zzlIsInLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

872 *
p
;

875 ià(
	`sdscm¶ex
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

876 (
	`sdscmp
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

877 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

880 
p
 = 
	`zli¡Index
(
zl
,-2);

881 ià(
p
 =ğ
NULL
)  0;

882 ià(!
	`zzlLexV®ueG‹Mš
(
p
,
¿nge
))

885 
p
 = 
	`zli¡Index
(
zl
,0);

886 
	`£rv”As£¹
(
p
 !ğ
NULL
);

887 ià(!
	`zzlLexV®ueL‹Max
(
p
,
¿nge
))

891 
	}
}

895 *
	$zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

896 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

899 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

901 
•Œ
 !ğ
NULL
) {

902 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
)) {

904 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
))

905  
•Œ
;

906  
NULL
;

910 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

911 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

912 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

915  
NULL
;

916 
	}
}

920 *
	$zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

921 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

924 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

926 
•Œ
 !ğ
NULL
) {

927 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

929 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
))

930  
•Œ
;

931  
NULL
;

936 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

937 ià(
¥Œ
 !ğ
NULL
)

938 
	`£rv”As£¹
((
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
)è!ğ
NULL
);

940 
•Œ
 = 
NULL
;

943  
NULL
;

944 
	}
}

946 *
	$zzlFšd
(*
zl
, 
sds
 
–e
, *
scÜe
) {

947 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

949 
•Œ
 !ğ
NULL
) {

950 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

951 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

953 ià(
	`zli¡Com·»
(
•Œ
,(*)
–e
,
	`sd¦’
(ele))) {

955 ià(
scÜe
 !ğ
NULL
è*scÜğ
	`zzlG‘ScÜe
(
¥Œ
);

956  
•Œ
;

960 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

962  
NULL
;

963 
	}
}

967 *
	$zzlD–‘e
(*
zl
, *
•Œ
) {

968 *
p
 = 
•Œ
;

971 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

972 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

973  
zl
;

974 
	}
}

976 *
	$zzlIn£¹At
(*
zl
, *
•Œ
, 
sds
 
–e
, 
scÜe
) {

977 *
¥Œ
;

978 
scÜebuf
[128];

979 
scÜ–’
;

980 
size_t
 
off£t
;

982 
scÜ–’
 = 
	`d2¡ršg
(
scÜebuf
,(scÜebuf),
scÜe
);

983 ià(
•Œ
 =ğ
NULL
) {

984 
zl
 = 
	`zli¡Push
(zl,(*)
–e
,
	`sd¦’
ÓË),
ZIPLIST_TAIL
);

985 
zl
 = 
	`zli¡Push
(zl,(*)
scÜebuf
,
scÜ–’
,
ZIPLIST_TAIL
);

988 
off£t
 = 
•Œ
-
zl
;

989 
zl
 = 
	`zli¡In£¹
(zl,
•Œ
,(*)
–e
,
	`sd¦’
(ele));

990 
•Œ
 = 
zl
+
off£t
;

993 
	`£rv”As£¹
((
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
);

994 
zl
 = 
	`zli¡In£¹
(zl,
¥Œ
,(*)
scÜebuf
,
scÜ–’
);

996  
zl
;

997 
	}
}

1001 *
	$zzlIn£¹
(*
zl
, 
sds
 
–e
, 
scÜe
) {

1002 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

1003 
s
;

1005 
•Œ
 !ğ
NULL
) {

1006 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1007 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

1008 
s
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1010 ià(
s
 > 
scÜe
) {

1014 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e
,
scÜe
);

1016 } ià(
s
 =ğ
scÜe
) {

1018 ià(
	`zzlCom·»EËm’ts
(
•Œ
,(*)
–e
,
	`sd¦’
(ele)) > 0) {

1019 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e
,
scÜe
);

1025 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

1029 ià(
•Œ
 =ğ
NULL
)

1030 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
–e
,
scÜe
);

1031  
zl
;

1032 
	}
}

1034 *
	$zzlD–‘eRªgeByScÜe
(*
zl
, 
z¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

1035 *
•Œ
, *
¥Œ
;

1036 
scÜe
;

1037 
num
 = 0;

1039 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

1041 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,
¿nge
);

1042 ià(
•Œ
 =ğ
NULL
è 
zl
;

1046 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

1047 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1048 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

1050 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1051 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1052 
num
++;

1059 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

1060  
zl
;

1061 
	}
}

1063 *
	$zzlD–‘eRªgeByLex
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

1064 *
•Œ
, *
¥Œ
;

1065 
num
 = 0;

1067 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

1069 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,
¿nge
);

1070 ià(
•Œ
 =ğ
NULL
è 
zl
;

1074 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

1075 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

1077 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1078 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1079 
num
++;

1086 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

1087  
zl
;

1088 
	}
}

1092 *
	$zzlD–‘eRªgeByRªk
(*
zl
, 
¡¬t
, 
’d
, *
d–‘ed
) {

1093 
num
 = (
’d
-
¡¬t
)+1;

1094 ià(
d–‘ed
è*d–‘ed = 
num
;

1095 
zl
 = 
	`zli¡D–‘eRªge
(zl,2*(
¡¬t
-1),2*
num
);

1096  
zl
;

1097 
	}
}

1103 
	$z£tL’gth
(cÚ¡ 
robj
 *
zobj
) {

1104 
Ëngth
 = -1;

1105 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1106 
Ëngth
 = 
	`zzlL’gth
(
zobj
->
±r
);

1107 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1108 
Ëngth
 = ((cÚ¡ 
z£t
*)
zobj
->
±r
)->
z¦
->length;

1110 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1112  
Ëngth
;

1113 
	}
}

1115 
	$z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
) {

1116 
z£t
 *
zs
;

1117 
zskli¡Node
 *
node
, *
Ãxt
;

1118 
sds
 
–e
;

1119 
scÜe
;

1121 ià(
zobj
->
’codšg
 ==ƒncoding) ;

1122 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1123 *
zl
 = 
zobj
->
±r
;

1124 *
•Œ
, *
¥Œ
;

1125 *
v¡r
;

1126 
vËn
;

1127 
vlÚg
;

1129 ià(
’codšg
 !ğ
OBJ_ENCODING_SKIPLIST
)

1130 
	`£rv”Pªic
("Unknownargetƒncoding");

1132 
zs
 = 
	`zm®loc
((*zs));

1133 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

1134 
zs
->
z¦
 = 
	`z¦C»©e
();

1136 
•Œ
 = 
	`zli¡Index
(
zl
,0);

1137 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
•Œ
 != NULL);

1138 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1139 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
¥Œ
 != NULL);

1141 
•Œ
 !ğ
NULL
) {

1142 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1143 
	`£rv”As£¹W™hInfo
(
NULL
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

1144 ià(
v¡r
 =ğ
NULL
)

1145 
–e
 = 
	`sdsäomlÚglÚg
(
vlÚg
);

1147 
–e
 = 
	`sd¢ewËn
((*)
v¡r
,
vËn
);

1149 
node
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1150 
	`£rv”As£¹
(
	`diùAdd
(
zs
->
diù
,
–e
,&
node
->
scÜe
è=ğ
DICT_OK
);

1151 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

1154 
	`zä“
(
zobj
->
±r
);

1155 
zobj
->
±r
 = 
zs
;

1156 
zobj
->
’codšg
 = 
OBJ_ENCODING_SKIPLIST
;

1157 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1158 *
zl
 = 
	`zli¡New
();

1160 ià(
’codšg
 !ğ
OBJ_ENCODING_ZIPLIST
)

1161 
	`£rv”Pªic
("Unknownargetƒncoding");

1165 
zs
 = 
zobj
->
±r
;

1166 
	`diùR–—£
(
zs
->
diù
);

1167 
node
 = 
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1168 
	`zä“
(
zs
->
z¦
->
h—d”
);

1169 
	`zä“
(
zs
->
z¦
);

1171 
node
) {

1172 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
node
->
–e
,node->
scÜe
);

1173 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

1174 
	`z¦F»eNode
(
node
);

1175 
node
 = 
Ãxt
;

1178 
	`zä“
(
zs
);

1179 
zobj
->
±r
 = 
zl
;

1180 
zobj
->
’codšg
 = 
OBJ_ENCODING_ZIPLIST
;

1182 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1184 
	}
}

1189 
	$z£tCÚv”tToZli¡IfN“ded
(
robj
 *
zobj
, 
size_t
 
max––’
) {

1190 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) ;

1191 
z£t
 *z£ˆğ
zobj
->
±r
;

1193 ià(
z£t
->
z¦
->
Ëngth
 <ğ
£rv”
.
z£t_max_zli¡_’Œ›s
 &&

1194 
max––’
 <ğ
£rv”
.
z£t_max_zli¡_v®ue
)

1195 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_ZIPLIST
);

1196 
	}
}

1202 
	$z£tScÜe
(
robj
 *
zobj
, 
sds
 
memb”
, *
scÜe
) {

1203 ià(!
zobj
 || !
memb”
è 
C_ERR
;

1205 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1206 ià(
	`zzlFšd
(
zobj
->
±r
, 
memb”
, 
scÜe
è=ğ
NULL
è 
C_ERR
;

1207 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1208 
z£t
 *
zs
 = 
zobj
->
±r
;

1209 
diùEÁry
 *
de
 = 
	`diùFšd
(
zs
->
diù
, 
memb”
);

1210 ià(
de
 =ğ
NULL
è 
C_ERR
;

1211 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1213 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1215  
C_OK
;

1216 
	}
}

1261 
	$z£tAdd
(
robj
 *
zobj
, 
scÜe
, 
sds
 
–e
, *
æags
, *
ÃwscÜe
) {

1263 
šü
 = (*
æags
 & 
ZADD_INCR
) != 0;

1264 
nx
 = (*
æags
 & 
ZADD_NX
) != 0;

1265 
xx
 = (*
æags
 & 
ZADD_XX
) != 0;

1266 *
æags
 = 0;

1267 
curscÜe
;

1270 ià(
	`i¢ª
(
scÜe
)) {

1271 *
æags
 = 
ZADD_NAN
;

1276 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1277 *
•Œ
;

1279 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
–e
,&
curscÜe
)è!ğ
NULL
) {

1281 ià(
nx
) {

1282 *
æags
 |ğ
ZADD_NOP
;

1287 ià(
šü
) {

1288 
scÜe
 +ğ
curscÜe
;

1289 ià(
	`i¢ª
(
scÜe
)) {

1290 *
æags
 |ğ
ZADD_NAN
;

1293 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1297 ià(
scÜe
 !ğ
curscÜe
) {

1298 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1299 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1300 *
æags
 |ğ
ZADD_UPDATED
;

1303 } ià(!
xx
) {

1306 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1307 ià(
	`zzlL’gth
(
zobj
->
±r
è> 
£rv”
.
z£t_max_zli¡_’Œ›s
)

1308 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1309 ià(
	`sd¦’
(
–e
è> 
£rv”
.
z£t_max_zli¡_v®ue
)

1310 
	`z£tCÚv”t
(
zobj
,
OBJ_ENCODING_SKIPLIST
);

1311 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1312 *
æags
 |ğ
ZADD_ADDED
;

1315 *
æags
 |ğ
ZADD_NOP
;

1318 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1319 
z£t
 *
zs
 = 
zobj
->
±r
;

1320 
zskli¡Node
 *
znode
;

1321 
diùEÁry
 *
de
;

1323 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

1324 ià(
de
 !ğ
NULL
) {

1326 ià(
nx
) {

1327 *
æags
 |ğ
ZADD_NOP
;

1330 
curscÜe
 = *(*)
	`diùG‘V®
(
de
);

1333 ià(
šü
) {

1334 
scÜe
 +ğ
curscÜe
;

1335 ià(
	`i¢ª
(
scÜe
)) {

1336 *
æags
 |ğ
ZADD_NAN
;

1339 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1343 ià(
scÜe
 !ğ
curscÜe
) {

1344 
zskli¡Node
 *
node
;

1345 
	`£rv”As£¹
(
	`z¦D–‘e
(
zs
->
z¦
,
curscÜe
,
–e
,&
node
));

1346 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
node
->
–e
);

1349 
node
->
–e
 = 
NULL
;

1350 
	`z¦F»eNode
(
node
);

1354 
	`diùG‘V®
(
de
èğ&
znode
->
scÜe
;

1355 *
æags
 |ğ
ZADD_UPDATED
;

1358 } ià(!
xx
) {

1359 
–e
 = 
	`sdsdup
(ele);

1360 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1361 
	`£rv”As£¹
(
	`diùAdd
(
zs
->
diù
,
–e
,&
znode
->
scÜe
è=ğ
DICT_OK
);

1362 *
æags
 |ğ
ZADD_ADDED
;

1363 ià(
ÃwscÜe
è*ÃwscÜğ
scÜe
;

1366 *
æags
 |ğ
ZADD_NOP
;

1370 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1373 
	}
}

1377 
	$z£tD–
(
robj
 *
zobj
, 
sds
 
–e
) {

1378 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1379 *
•Œ
;

1381 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
–e
,
NULL
)) != NULL) {

1382 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1385 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1386 
z£t
 *
zs
 = 
zobj
->
±r
;

1387 
diùEÁry
 *
de
;

1388 
scÜe
;

1390 
de
 = 
	`diùUÆšk
(
zs
->
diù
,
–e
);

1391 ià(
de
 !ğ
NULL
) {

1393 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1400 
	`diùF»eUÆškedEÁry
(
zs
->
diù
,
de
);

1403 
»tv®
 = 
	`z¦D–‘e
(
zs
->
z¦
,
scÜe
,
–e
,
NULL
);

1404 
	`£rv”As£¹
(
»tv®
);

1406 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1410 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1413 
	}
}

1426 
	$z£tRªk
(
robj
 *
zobj
, 
sds
 
–e
, 
»v”£
) {

1427 
Î’
;

1428 
¿nk
;

1430 
Î’
 = 
	`z£tL’gth
(
zobj
);

1432 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1433 *
zl
 = 
zobj
->
±r
;

1434 *
•Œ
, *
¥Œ
;

1436 
•Œ
 = 
	`zli¡Index
(
zl
,0);

1437 
	`£rv”As£¹
(
•Œ
 !ğ
NULL
);

1438 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1439 
	`£rv”As£¹
(
¥Œ
 !ğ
NULL
);

1441 
¿nk
 = 1;

1442 
•Œ
 !ğ
NULL
) {

1443 ià(
	`zli¡Com·»
(
•Œ
,(*)
–e
,
	`sd¦’
(ele)))

1445 
¿nk
++;

1446 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

1449 ià(
•Œ
 !ğ
NULL
) {

1450 ià(
»v”£
)

1451  
Î’
-
¿nk
;

1453  
¿nk
-1;

1457 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1458 
z£t
 *
zs
 = 
zobj
->
±r
;

1459 
zskli¡
 *
z¦
 = 
zs
->zsl;

1460 
diùEÁry
 *
de
;

1461 
scÜe
;

1463 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

1464 ià(
de
 !ğ
NULL
) {

1465 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1466 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
,
scÜe
,
–e
);

1468 
	`£rv”As£¹
(
¿nk
 != 0);

1469 ià(
»v”£
)

1470  
Î’
-
¿nk
;

1472  
¿nk
-1;

1477 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1479 
	}
}

1486 
	$zaddG’”icCommªd
(
ş›Á
 *
c
, 
æags
) {

1487 *
ÇÃ¼
 = "resulting score is‚ot‡‚umber (NaN)";

1488 
robj
 *
key
 = 
c
->
¬gv
[1];

1489 
robj
 *
zobj
;

1490 
sds
 
–e
;

1491 
scÜe
 = 0, *
scÜes
 = 
NULL
;

1492 
j
, 
–em’ts
;

1493 
scÜeidx
 = 0;

1497 
added
 = 0;

1498 
upd©ed
 = 0;

1499 
´oûs£d
 = 0;

1504 
scÜeidx
 = 2;

1505 
scÜeidx
 < 
c
->
¬gc
) {

1506 *
İt
 = 
c
->
¬gv
[
scÜeidx
]->
±r
;

1507 ià(!
	`¡rÿ£cmp
(
İt
,"nx")è
æags
 |ğ
ZADD_NX
;

1508 ià(!
	`¡rÿ£cmp
(
İt
,"xx")è
æags
 |ğ
ZADD_XX
;

1509 ià(!
	`¡rÿ£cmp
(
İt
,"ch")è
æags
 |ğ
ZADD_CH
;

1510 ià(!
	`¡rÿ£cmp
(
İt
,"šü")è
æags
 |ğ
ZADD_INCR
;

1512 
scÜeidx
++;

1516 
šü
 = (
æags
 & 
ZADD_INCR
) != 0;

1517 
nx
 = (
æags
 & 
ZADD_NX
) != 0;

1518 
xx
 = (
æags
 & 
ZADD_XX
) != 0;

1519 
ch
 = (
æags
 & 
ZADD_CH
) != 0;

1523 
–em’ts
 = 
c
->
¬gc
-
scÜeidx
;

1524 ià(
–em’ts
 % 2 || !elements) {

1525 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1528 
–em’ts
 /= 2;

1531 ià(
nx
 && 
xx
) {

1532 
	`addR•lyE¼Ü
(
c
,

1537 ià(
šü
 && 
–em’ts
 > 1) {

1538 
	`addR•lyE¼Ü
(
c
,

1546 
scÜes
 = 
	`zm®loc
(()*
–em’ts
);

1547 
j
 = 0; j < 
–em’ts
; j++) {

1548 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
scÜeidx
+
j
*2],&
scÜes
[j],
NULL
)

1549 !ğ
C_OK
è
ş—nup
;

1553 
zobj
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
);

1554 ià(
zobj
 =ğ
NULL
) {

1555 ià(
xx
è
»¶y_to_ş›Á
;

1556 ià(
£rv”
.
z£t_max_zli¡_’Œ›s
 == 0 ||

1557 
£rv”
.
z£t_max_zli¡_v®ue
 < 
	`sd¦’
(
c
->
¬gv
[
scÜeidx
+1]->
±r
))

1559 
zobj
 = 
	`ü—‹Z£tObjeù
();

1561 
zobj
 = 
	`ü—‹Z£tZli¡Objeù
();

1563 
	`dbAdd
(
c
->
db
,
key
,
zobj
);

1565 ià(
zobj
->
ty³
 !ğ
OBJ_ZSET
) {

1566 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1567 
ş—nup
;

1571 
j
 = 0; j < 
–em’ts
; j++) {

1572 
ÃwscÜe
;

1573 
scÜe
 = 
scÜes
[
j
];

1574 
»tæags
 = 
æags
;

1576 
–e
 = 
c
->
¬gv
[
scÜeidx
+1+
j
*2]->
±r
;

1577 
»tv®
 = 
	`z£tAdd
(
zobj
, 
scÜe
, 
–e
, &
»tæags
, &
ÃwscÜe
);

1578 ià(
»tv®
 == 0) {

1579 
	`addR•lyE¼Ü
(
c
,
ÇÃ¼
);

1580 
ş—nup
;

1582 ià(
»tæags
 & 
ZADD_ADDED
è
added
++;

1583 ià(
»tæags
 & 
ZADD_UPDATED
è
upd©ed
++;

1584 ià(!(
»tæags
 & 
ZADD_NOP
)è
´oûs£d
++;

1585 
scÜe
 = 
ÃwscÜe
;

1587 
£rv”
.
dœty
 +ğ(
added
+
upd©ed
);

1589 
»¶y_to_ş›Á
:

1590 ià(
šü
) {

1591 ià(
´oûs£d
)

1592 
	`addR•lyDoubË
(
c
,
scÜe
);

1594 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1596 
	`addR•lyLÚgLÚg
(
c
,
ch
 ? 
added
+
upd©ed
 :‡dded);

1599 
ş—nup
:

1600 
	`zä“
(
scÜes
);

1601 ià(
added
 || 
upd©ed
) {

1602 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1603 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

1604 
šü
 ? "zšü" : "zadd", 
key
, 
c
->
db
->
id
);

1606 
	}
}

1608 
	$zaddCommªd
(
ş›Á
 *
c
) {

1609 
	`zaddG’”icCommªd
(
c
,
ZADD_NONE
);

1610 
	}
}

1612 
	$zšübyCommªd
(
ş›Á
 *
c
) {

1613 
	`zaddG’”icCommªd
(
c
,
ZADD_INCR
);

1614 
	}
}

1616 
	$z»mCommªd
(
ş›Á
 *
c
) {

1617 
robj
 *
key
 = 
c
->
¬gv
[1];

1618 
robj
 *
zobj
;

1619 
d–‘ed
 = 0, 
key»moved
 = 0, 
j
;

1621 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

1622 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

1624 
j
 = 2; j < 
c
->
¬gc
; j++) {

1625 ià(
	`z£tD–
(
zobj
,
c
->
¬gv
[
j
]->
±r
)è
d–‘ed
++;

1626 ià(
	`z£tL’gth
(
zobj
) == 0) {

1627 
	`dbD–‘e
(
c
->
db
,
key
);

1628 
key»moved
 = 1;

1633 ià(
d–‘ed
) {

1634 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,"z»m",
key
,
c
->
db
->
id
);

1635 ià(
key»moved
)

1636 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1637 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1638 
£rv”
.
dœty
 +ğ
d–‘ed
;

1640 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1641 
	}
}

1644 
	#ZRANGE_RANK
 0

	)

1645 
	#ZRANGE_SCORE
 1

	)

1646 
	#ZRANGE_LEX
 2

	)

1647 
	$z»m¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
¿ng‘y³
) {

1648 
robj
 *
key
 = 
c
->
¬gv
[1];

1649 
robj
 *
zobj
;

1650 
key»moved
 = 0;

1651 
d–‘ed
 = 0;

1652 
z¿nge¥ec
 
¿nge
;

1653 
zËx¿nge¥ec
 
Ëx¿nge
;

1654 
¡¬t
, 
’d
, 
Î’
;

1657 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1658 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
C_OK
) ||

1659 (
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
C_OK
))

1661 } ià(
¿ng‘y³
 =ğ
ZRANGE_SCORE
) {

1662 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
C_OK
) {

1663 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

1666 } ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
) {

1667 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
Ëx¿nge
è!ğ
C_OK
) {

1668 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

1674 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

1675 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)è
ş—nup
;

1677 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1679 
Î’
 = 
	`z£tL’gth
(
zobj
);

1680 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

1681 ià(
’d
 < 0è’d = 
Î’
+end;

1682 ià(
¡¬t
 < 0) start = 0;

1686 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

1687 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1688 
ş—nup
;

1690 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

1694 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1695 
¿ng‘y³
) {

1696 
ZRANGE_RANK
:

1697 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByRªk
(zobj->±r,
¡¬t
+1,
’d
+1,&
d–‘ed
);

1699 
ZRANGE_SCORE
:

1700 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByScÜe
(zobj->±r,&
¿nge
,&
d–‘ed
);

1702 
ZRANGE_LEX
:

1703 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByLex
(zobj->±r,&
Ëx¿nge
,&
d–‘ed
);

1706 ià(
	`zzlL’gth
(
zobj
->
±r
) == 0) {

1707 
	`dbD–‘e
(
c
->
db
,
key
);

1708 
key»moved
 = 1;

1710 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1711 
z£t
 *
zs
 = 
zobj
->
±r
;

1712 
¿ng‘y³
) {

1713 
ZRANGE_RANK
:

1714 
d–‘ed
 = 
	`z¦D–‘eRªgeByRªk
(
zs
->
z¦
,
¡¬t
+1,
’d
+1,zs->
diù
);

1716 
ZRANGE_SCORE
:

1717 
d–‘ed
 = 
	`z¦D–‘eRªgeByScÜe
(
zs
->
z¦
,&
¿nge
,zs->
diù
);

1719 
ZRANGE_LEX
:

1720 
d–‘ed
 = 
	`z¦D–‘eRªgeByLex
(
zs
->
z¦
,&
Ëx¿nge
,zs->
diù
);

1723 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1724 ià(
	`diùSize
(
zs
->
diù
) == 0) {

1725 
	`dbD–‘e
(
c
->
db
,
key
);

1726 
key»moved
 = 1;

1729 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1733 ià(
d–‘ed
) {

1734 *
ev’t
[3] = {"zremrangebyrank","zremrangebyscore","zremrangebylex"};

1735 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1736 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,
ev’t
[
¿ng‘y³
],
key
,
c
->
db
->
id
);

1737 ià(
key»moved
)

1738 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1740 
£rv”
.
dœty
 +ğ
d–‘ed
;

1741 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1743 
ş—nup
:

1744 ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
è
	`z¦F»eLexRªge
(&
Ëx¿nge
);

1745 
	}
}

1747 
	$z»m¿ngeby¿nkCommªd
(
ş›Á
 *
c
) {

1748 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_RANK
);

1749 
	}
}

1751 
	$z»m¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

1752 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_SCORE
);

1753 
	}
}

1755 
	$z»m¿ngebyËxCommªd
(
ş›Á
 *
c
) {

1756 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_LEX
);

1757 
	}
}

1760 
robj
 *
	msubjeù
;

1761 
	mty³
;

1762 
	m’codšg
;

1763 
	mweight
;

1767 
	u_™”£t
 {

1769 
št£t
 *
	mis
;

1770 
	mii
;

1771 } 
	mis
;

1773 
diù
 *
	mdiù
;

1774 
diùI‹¿tÜ
 *
	mdi
;

1775 
diùEÁry
 *
	mde
;

1776 } 
	mht
;

1777 } 
	m£t
;

1780 
	u_™”z£t
 {

1782 *
	mzl
;

1783 *
	m•Œ
, *
	m¥Œ
;

1784 } 
	mzl
;

1786 
z£t
 *
	mzs
;

1787 
zskli¡Node
 *
	mnode
;

1788 } 
	m¦
;

1789 } 
	mz£t
;

1790 } 
	m™”
;

1791 } 
	tz£tİ¤c
;

1800 
	#OPVAL_DIRTY_SDS
 1

	)

1801 
	#OPVAL_DIRTY_LL
 2

	)

1802 
	#OPVAL_VALID_LL
 4

	)

1806 
	mæags
;

1807 
	m_buf
[32];

1808 
sds
 
	m–e
;

1809 *
	me¡r
;

1810 
	m–’
;

1811 
	m–l
;

1812 
	mscÜe
;

1813 } 
	tz£tİv®
;

1815 
_™”£t
 
	t™”£t
;

1816 
_™”z£t
 
	t™”z£t
;

1818 
	$zuiIn™I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1819 ià(
İ
->
subjeù
 =ğ
NULL
)

1822 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1823 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1824 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1825 
™
->
is
.i ğ
İ
->
subjeù
->
±r
;

1826 
™
->
is
.
ii
 = 0;

1827 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1828 
™
->
ht
.
diù
 = 
İ
->
subjeù
->
±r
;

1829 
™
->
ht
.
di
 = 
	`diùG‘I‹¿tÜ
(
İ
->
subjeù
->
±r
);

1830 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1832 
	`£rv”Pªic
("Unknown setƒncoding");

1834 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1835 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1836 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1837 
™
->
zl
.zÈğ
İ
->
subjeù
->
±r
;

1838 
™
->
zl
.
•Œ
 = 
	`zli¡Index
(it->zl.zl,0);

1839 ià(
™
->
zl
.
•Œ
 !ğ
NULL
) {

1840 
™
->
zl
.
¥Œ
 = 
	`zli¡Next
(™->zl.zl,™->zl.
•Œ
);

1841 
	`£rv”As£¹
(
™
->
zl
.
¥Œ
 !ğ
NULL
);

1843 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1844 
™
->
¦
.
zs
 = 
İ
->
subjeù
->
±r
;

1845 
™
->
¦
.
node
 = it->¦.
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1847 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1850 
	`£rv”Pªic
("Unsupportedype");

1852 
	}
}

1854 
	$zuiCË¬I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1855 ià(
İ
->
subjeù
 =ğ
NULL
)

1858 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1859 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1860 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1861 
	`UNUSED
(
™
);

1862 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1863 
	`diùR–—£I‹¿tÜ
(
™
->
ht
.
di
);

1865 
	`£rv”Pªic
("Unknown setƒncoding");

1867 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1868 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1869 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1870 
	`UNUSED
(
™
);

1871 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1872 
	`UNUSED
(
™
);

1874 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1877 
	`£rv”Pªic
("Unsupportedype");

1879 
	}
}

1881 
	$zuiL’gth
(
z£tİ¤c
 *
İ
) {

1882 ià(
İ
->
subjeù
 =ğ
NULL
)

1885 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1886 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1887  
	`št£tL’
(
İ
->
subjeù
->
±r
);

1888 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1889 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

1890  
	`diùSize
(
ht
);

1892 
	`£rv”Pªic
("Unknown setƒncoding");

1894 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1895 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1896  
	`zzlL’gth
(
İ
->
subjeù
->
±r
);

1897 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1898 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

1899  
zs
->
z¦
->
Ëngth
;

1901 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1904 
	`£rv”Pªic
("Unsupportedype");

1906 
	}
}

1911 
	$zuiNext
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
) {

1912 ià(
İ
->
subjeù
 =ğ
NULL
)

1915 ià(
v®
->
æags
 & 
OPVAL_DIRTY_SDS
)

1916 
	`sdsä“
(
v®
->
–e
);

1918 
	`mem£t
(
v®
,0,(
z£tİv®
));

1920 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

1921 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1922 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

1923 
št64_t
 
–l
;

1925 ià(!
	`št£tG‘
(
™
->
is
.is,™->is.
ii
,&
–l
))

1927 
v®
->
–l
 =ƒll;

1928 
v®
->
scÜe
 = 1.0;

1931 
™
->
is
.
ii
++;

1932 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

1933 ià(
™
->
ht
.
de
 =ğ
NULL
)

1935 
v®
->
–e
 = 
	`diùG‘Key
(
™
->
ht
.
de
);

1936 
v®
->
scÜe
 = 1.0;

1939 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1941 
	`£rv”Pªic
("Unknown setƒncoding");

1943 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

1944 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1945 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

1947 ià(
™
->
zl
.
•Œ
 =ğ
NULL
 || it->zl.
¥Œ
 == NULL)

1949 
	`£rv”As£¹
(
	`zli¡G‘
(
™
->
zl
.
•Œ
,&
v®
->
e¡r
,&v®->
–’
,&v®->
–l
));

1950 
v®
->
scÜe
 = 
	`zzlG‘ScÜe
(
™
->
zl
.
¥Œ
);

1953 
	`zzlNext
(
™
->
zl
.zl,&™->zl.
•Œ
,&™->zl.
¥Œ
);

1954 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

1955 ià(
™
->
¦
.
node
 =ğ
NULL
)

1957 
v®
->
–e
 = 
™
->
¦
.
node
->ele;

1958 
v®
->
scÜe
 = 
™
->
¦
.
node
->score;

1961 
™
->
¦
.
node
 = it->¦.node->
Ëv–
[0].
fÜw¬d
;

1963 
	`£rv”Pªic
("Unknown sorted setƒncoding");

1966 
	`£rv”Pªic
("Unsupportedype");

1969 
	}
}

1971 
	$zuiLÚgLÚgFromV®ue
(
z£tİv®
 *
v®
) {

1972 ià(!(
v®
->
æags
 & 
OPVAL_DIRTY_LL
)) {

1973 
v®
->
æags
 |ğ
OPVAL_DIRTY_LL
;

1975 ià(
v®
->
–e
 !ğ
NULL
) {

1976 ià(
	`¡ršg2Î
(
v®
->
–e
,
	`sd¦’
(v®->–e),&v®->
–l
))

1977 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1978 } ià(
v®
->
e¡r
 !ğ
NULL
) {

1979 ià(
	`¡ršg2Î
((*)
v®
->
e¡r
,v®->
–’
,&v®->
–l
))

1980 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1983 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1986  
v®
->
æags
 & 
OPVAL_VALID_LL
;

1987 
	}
}

1989 
sds
 
	$zuiSdsFromV®ue
(
z£tİv®
 *
v®
) {

1990 ià(
v®
->
–e
 =ğ
NULL
) {

1991 ià(
v®
->
e¡r
 !ğ
NULL
) {

1992 
v®
->
–e
 = 
	`sd¢ewËn
((*)v®->
e¡r
,v®->
–’
);

1994 
v®
->
–e
 = 
	`sdsäomlÚglÚg
(v®->
–l
);

1996 
v®
->
æags
 |ğ
OPVAL_DIRTY_SDS
;

1998  
v®
->
–e
;

1999 
	}
}

2003 
sds
 
	$zuiNewSdsFromV®ue
(
z£tİv®
 *
v®
) {

2004 ià(
v®
->
æags
 & 
OPVAL_DIRTY_SDS
) {

2006 
sds
 
–e
 = 
v®
->ele;

2007 
v®
->
æags
 &ğ~
OPVAL_DIRTY_SDS
;

2008 
v®
->
–e
 = 
NULL
;

2009  
–e
;

2010 } ià(
v®
->
–e
) {

2011  
	`sdsdup
(
v®
->
–e
);

2012 } ià(
v®
->
e¡r
) {

2013  
	`sd¢ewËn
((*)
v®
->
e¡r
,v®->
–’
);

2015  
	`sdsäomlÚglÚg
(
v®
->
–l
);

2017 
	}
}

2019 
	$zuiBufãrFromV®ue
(
z£tİv®
 *
v®
) {

2020 ià(
v®
->
e¡r
 =ğ
NULL
) {

2021 ià(
v®
->
–e
 !ğ
NULL
) {

2022 
v®
->
–’
 = 
	`sd¦’
(v®->
–e
);

2023 
v®
->
e¡r
 = (*)v®->
–e
;

2025 
v®
->
–’
 = 
	`Î2¡ršg
((*)v®->
_buf
,(v®->_buf),v®->
–l
);

2026 
v®
->
e¡r
 = v®->
_buf
;

2030 
	}
}

2034 
	$zuiFšd
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
, *
scÜe
) {

2035 ià(
İ
->
subjeù
 =ğ
NULL
)

2038 ià(
İ
->
ty³
 =ğ
OBJ_SET
) {

2039 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_INTSET
) {

2040 ià(
	`zuiLÚgLÚgFromV®ue
(
v®
) &&

2041 
	`št£tFšd
(
İ
->
subjeù
->
±r
,
v®
->
–l
))

2043 *
scÜe
 = 1.0;

2048 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_HT
) {

2049 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

2050 
	`zuiSdsFromV®ue
(
v®
);

2051 ià(
	`diùFšd
(
ht
,
v®
->
–e
è!ğ
NULL
) {

2052 *
scÜe
 = 1.0;

2058 
	`£rv”Pªic
("Unknown setƒncoding");

2060 } ià(
İ
->
ty³
 =ğ
OBJ_ZSET
) {

2061 
	`zuiSdsFromV®ue
(
v®
);

2063 ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2064 ià(
	`zzlFšd
(
İ
->
subjeù
->
±r
,
v®
->
–e
,
scÜe
è!ğ
NULL
) {

2070 } ià(
İ
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2071 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

2072 
diùEÁry
 *
de
;

2073 ià((
de
 = 
	`diùFšd
(
zs
->
diù
,
v®
->
–e
)è!ğ
NULL
) {

2074 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

2080 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2083 
	`£rv”Pªic
("Unsupportedype");

2085 
	}
}

2087 
	$zuiCom·»ByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

2088  
	`zuiL’gth
((
z£tİ¤c
*)
s1
è- zuiL’gth((z£tİ¤c*)
s2
);

2089 
	}
}

2091 
	#REDIS_AGGR_SUM
 1

	)

2092 
	#REDIS_AGGR_MIN
 2

	)

2093 
	#REDIS_AGGR_MAX
 3

	)

2094 
	#zuniÚIÁ”DiùV®ue
(
_e
è(
	`diùG‘V®
(_eè=ğ
NULL
 ? 1.0 : *(*)diùG‘V®(_e))

	)

2096 
šlše
 
	$zuniÚIÁ”Agg»g©e
(*
rg‘
, 
v®
, 
agg»g©e
) {

2097 ià(
agg»g©e
 =ğ
REDIS_AGGR_SUM
) {

2098 *
rg‘
 = *rg‘ + 
v®
;

2102 ià(
	`i¢ª
(*
rg‘
)) *target = 0.0;

2103 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MIN
) {

2104 *
rg‘
 = 
v®
 < *target ? val : *target;

2105 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MAX
) {

2106 *
rg‘
 = 
v®
 > *target ? val : *target;

2109 
	`£rv”Pªic
("Unknown ZUNION/INTER‡ggregateype");

2111 
	}
}

2113 
ušt64_t
 
diùSdsHash
(cÚ¡ *
key
);

2114 
diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

2116 
diùTy³
 
	g£tAccumuÏtÜDiùTy³
 = {

2117 
diùSdsHash
,

2118 
NULL
,

2119 
NULL
,

2120 
diùSdsKeyCom·»
,

2121 
NULL
,

2122 
NULL


2125 
	$zuniÚIÁ”G’”icCommªd
(
ş›Á
 *
c
, 
robj
 *
d¡key
, 
İ
) {

2126 
i
, 
j
;

2127 
£Šum
;

2128 
agg»g©e
 = 
REDIS_AGGR_SUM
;

2129 
z£tİ¤c
 *
¤c
;

2130 
z£tİv®
 
zv®
;

2131 
sds
 
tmp
;

2132 
max––’
 = 0;

2133 
robj
 *
d¡obj
;

2134 
z£t
 *
d¡z£t
;

2135 
zskli¡Node
 *
znode
;

2136 
touched
 = 0;

2139 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
£Šum
, 
NULL
è!ğ
C_OK
))

2142 ià(
£Šum
 < 1) {

2143 
	`addR•lyE¼Ü
(
c
,

2149 ià(
£Šum
 > 
c
->
¬gc
-3) {

2150 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2155 
¤c
 = 
	`zÿÎoc
((
z£tİ¤c
è* 
£Šum
);

2156 
i
 = 0, 
j
 = 3; i < 
£Šum
; i++, j++) {

2157 
robj
 *
obj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]);

2158 ià(
obj
 !ğ
NULL
) {

2159 ià(
obj
->
ty³
 !ğ
OBJ_ZSET
 && obj->ty³ !ğ
OBJ_SET
) {

2160 
	`zä“
(
¤c
);

2161 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

2165 
¤c
[
i
].
subjeù
 = 
obj
;

2166 
¤c
[
i
].
ty³
 = 
obj
->type;

2167 
¤c
[
i
].
’codšg
 = 
obj
->encoding;

2169 
¤c
[
i
].
subjeù
 = 
NULL
;

2173 
¤c
[
i
].
weight
 = 1.0;

2177 ià(
j
 < 
c
->
¬gc
) {

2178 
»maššg
 = 
c
->
¬gc
 - 
j
;

2180 
»maššg
) {

2181 ià(
»maššg
 >ğ(
£Šum
 + 1) &&

2182 !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"weights"))

2184 
j
++; 
»maššg
--;

2185 
i
 = 0; i < 
£Šum
; i++, 
j
++, 
»maššg
--) {

2186 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
],&
¤c
[
i
].
weight
,

2187 "weighˆv®ui nÙ‡ flßt"è!ğ
C_OK
)

2189 
	`zä“
(
¤c
);

2193 } ià(
»maššg
 >= 2 &&

2194 !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"aggregate"))

2196 
j
++; 
»maššg
--;

2197 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"sum")) {

2198 
agg»g©e
 = 
REDIS_AGGR_SUM
;

2199 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"min")) {

2200 
agg»g©e
 = 
REDIS_AGGR_MIN
;

2201 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"max")) {

2202 
agg»g©e
 = 
REDIS_AGGR_MAX
;

2204 
	`zä“
(
¤c
);

2205 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2208 
j
++; 
»maššg
--;

2210 
	`zä“
(
¤c
);

2211 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2219 
	`qsÜt
(
¤c
,
£Šum
,(
z£tİ¤c
),
zuiCom·»ByC¬dš®™y
);

2221 
d¡obj
 = 
	`ü—‹Z£tObjeù
();

2222 
d¡z£t
 = 
d¡obj
->
±r
;

2223 
	`mem£t
(&
zv®
, 0, (zval));

2225 ià(
İ
 =ğ
SET_OP_INTER
) {

2227 ià(
	`zuiL’gth
(&
¤c
[0]) > 0) {

2230 
	`zuiIn™I‹¿tÜ
(&
¤c
[0]);

2231 
	`zuiNext
(&
¤c
[0],&
zv®
)) {

2232 
scÜe
, 
v®ue
;

2234 
scÜe
 = 
¤c
[0].
weight
 * 
zv®
.score;

2235 ià(
	`i¢ª
(
scÜe
)) score = 0;

2237 
j
 = 1; j < 
£Šum
; j++) {

2240 ià(
¤c
[
j
].
subjeù
 == src[0].subject) {

2241 
v®ue
 = 
zv®
.
scÜe
*
¤c
[
j
].
weight
;

2242 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

2243 } ià(
	`zuiFšd
(&
¤c
[
j
],&
zv®
,&
v®ue
)) {

2244 
v®ue
 *ğ
¤c
[
j
].
weight
;

2245 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

2252 ià(
j
 =ğ
£Šum
) {

2253 
tmp
 = 
	`zuiNewSdsFromV®ue
(&
zv®
);

2254 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
tmp
);

2255 
	`diùAdd
(
d¡z£t
->
diù
,
tmp
,&
znode
->
scÜe
);

2256 ià(
	`sd¦’
(
tmp
è> 
max––’
) maxelelen = sdslen(tmp);

2259 
	`zuiCË¬I‹¿tÜ
(&
¤c
[0]);

2261 } ià(
İ
 =ğ
SET_OP_UNION
) {

2262 
diù
 *
accumuÏtÜ
 = 
	`diùC»©e
(&
£tAccumuÏtÜDiùTy³
,
NULL
);

2263 
diùI‹¿tÜ
 *
di
;

2264 
diùEÁry
 *
de
, *
exi¡šg
;

2265 
scÜe
;

2267 ià(
£Šum
) {

2270 
	`diùEx·nd
(
accumuÏtÜ
,
	`zuiL’gth
(&
¤c
[
£Šum
-1]));

2275 
i
 = 0; i < 
£Šum
; i++) {

2276 ià(
	`zuiL’gth
(&
¤c
[
i
]) == 0) ;

2278 
	`zuiIn™I‹¿tÜ
(&
¤c
[
i
]);

2279 
	`zuiNext
(&
¤c
[
i
],&
zv®
)) {

2281 
scÜe
 = 
¤c
[
i
].
weight
 * 
zv®
.score;

2282 ià(
	`i¢ª
(
scÜe
)) score = 0;

2285 
de
 = 
	`diùAddRaw
(
accumuÏtÜ
,
	`zuiSdsFromV®ue
(&
zv®
),&
exi¡šg
);

2287 ià(!
exi¡šg
) {

2288 
tmp
 = 
	`zuiNewSdsFromV®ue
(&
zv®
);

2292 ià(
	`sd¦’
(
tmp
è> 
max––’
) maxelelen = sdslen(tmp);

2294 
	`diùS‘Key
(
accumuÏtÜ
, 
de
, 
tmp
);

2295 
	`diùS‘DoubËV®
(
de
,
scÜe
);

2303 
	`zuniÚIÁ”Agg»g©e
(&
exi¡šg
->
v
.
d
,
scÜe
,
agg»g©e
);

2306 
	`zuiCË¬I‹¿tÜ
(&
¤c
[
i
]);

2310 
di
 = 
	`diùG‘I‹¿tÜ
(
accumuÏtÜ
);

2315 
	`diùEx·nd
(
d¡z£t
->
diù
,
	`diùSize
(
accumuÏtÜ
));

2317 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2318 
sds
 
–e
 = 
	`diùG‘Key
(
de
);

2319 
scÜe
 = 
	`diùG‘DoubËV®
(
de
);

2320 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
–e
);

2321 
	`diùAdd
(
d¡z£t
->
diù
,
–e
,&
znode
->
scÜe
);

2323 
	`diùR–—£I‹¿tÜ
(
di
);

2324 
	`diùR–—£
(
accumuÏtÜ
);

2326 
	`£rv”Pªic
("Unknown operator");

2329 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
))

2330 
touched
 = 1;

2331 ià(
d¡z£t
->
z¦
->
Ëngth
) {

2332 
	`z£tCÚv”tToZli¡IfN“ded
(
d¡obj
,
max––’
);

2333 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

2334 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
d¡obj
));

2335 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2336 
	`nÙifyKey¥aûEv’t
(
NOTIFY_ZSET
,

2337 (
İ
 =ğ
SET_OP_UNION
) ? "zunionstore" : "zinterstore",

2338 
d¡key
,
c
->
db
->
id
);

2339 
£rv”
.
dœty
++;

2341 
	`deüRefCouÁ
(
d¡obj
);

2342 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

2343 ià(
touched
) {

2344 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2345 
	`nÙifyKey¥aûEv’t
(
NOTIFY_GENERIC
,"d–",
d¡key
,
c
->
db
->
id
);

2346 
£rv”
.
dœty
++;

2349 
	`zä“
(
¤c
);

2350 
	}
}

2352 
	$zuniÚ¡ÜeCommªd
(
ş›Á
 *
c
) {

2353 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_UNION
);

2354 
	}
}

2356 
	$zš‹r¡ÜeCommªd
(
ş›Á
 *
c
) {

2357 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
SET_OP_INTER
);

2358 
	}
}

2360 
	$z¿ngeG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2361 
robj
 *
key
 = 
c
->
¬gv
[1];

2362 
robj
 *
zobj
;

2363 
w™hscÜes
 = 0;

2364 
¡¬t
;

2365 
’d
;

2366 
Î’
;

2367 
¿ng–’
;

2369 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
C_OK
) ||

2370 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
C_OK
)) ;

2372 ià(
c
->
¬gc
 =ğ5 && !
	`¡rÿ£cmp
(c->
¬gv
[4]->
±r
,"withscores")) {

2373 
w™hscÜes
 = 1;

2374 } ià(
c
->
¬gc
 >= 5) {

2375 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2379 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


2380 || 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

2383 
Î’
 = 
	`z£tL’gth
(
zobj
);

2384 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

2385 ià(
’d
 < 0è’d = 
Î’
+end;

2386 ià(
¡¬t
 < 0) start = 0;

2390 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

2391 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

2394 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

2395 
¿ng–’
 = (
’d
-
¡¬t
)+1;

2398 
	`addR•lyMuÉiBulkL’
(
c
, 
w™hscÜes
 ? (
¿ng–’
*2) :„angelen);

2400 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2401 *
zl
 = 
zobj
->
±r
;

2402 *
•Œ
, *
¥Œ
;

2403 *
v¡r
;

2404 
vËn
;

2405 
vlÚg
;

2407 ià(
»v”£
)

2408 
•Œ
 = 
	`zli¡Index
(
zl
,-2-(2*
¡¬t
));

2410 
•Œ
 = 
	`zli¡Index
(
zl
,2*
¡¬t
);

2412 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2413 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2415 
¿ng–’
--) {

2416 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
 && 
¥Œ
 != NULL);

2417 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2418 ià(
v¡r
 =ğ
NULL
)

2419 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2421 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2423 ià(
w™hscÜes
)

2424 
	`addR•lyDoubË
(
c
,
	`zzlG‘ScÜe
(
¥Œ
));

2426 ià(
»v”£
)

2427 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2429 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2432 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2433 
z£t
 *
zs
 = 
zobj
->
±r
;

2434 
zskli¡
 *
z¦
 = 
zs
->zsl;

2435 
zskli¡Node
 *
Ê
;

2436 
sds
 
–e
;

2439 ià(
»v”£
) {

2440 
Ê
 = 
z¦
->

;

2441 ià(
¡¬t
 > 0)

2442 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
Î’
-
¡¬t
);

2444 
Ê
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

2445 ià(
¡¬t
 > 0)

2446 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
¡¬t
+1);

2449 
¿ng–’
--) {

2450 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
Ê
 !ğ
NULL
);

2451 
–e
 = 
Ê
->ele;

2452 
	`addR•lyBulkCBufãr
(
c
,
–e
,
	`sd¦’
(ele));

2453 ià(
w™hscÜes
)

2454 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2455 
Ê
 = 
»v”£
 ?†n->
backw¬d
 :†n->
Ëv–
[0].
fÜw¬d
;

2458 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2460 
	}
}

2462 
	$z¿ngeCommªd
(
ş›Á
 *
c
) {

2463 
	`z¿ngeG’”icCommªd
(
c
,0);

2464 
	}
}

2466 
	$z»v¿ngeCommªd
(
ş›Á
 *
c
) {

2467 
	`z¿ngeG’”icCommªd
(
c
,1);

2468 
	}
}

2471 
	$g’”icZ¿ngebyscÜeCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2472 
z¿nge¥ec
 
¿nge
;

2473 
robj
 *
key
 = 
c
->
¬gv
[1];

2474 
robj
 *
zobj
;

2475 
off£t
 = 0, 
lim™
 = -1;

2476 
w™hscÜes
 = 0;

2477 
¿ng–’
 = 0;

2478 *
»¶yËn
 = 
NULL
;

2479 
mšidx
, 
maxidx
;

2482 ià(
»v”£
) {

2484 
maxidx
 = 2; 
mšidx
 = 3;

2487 
mšidx
 = 2; 
maxidx
 = 3;

2490 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
C_OK
) {

2491 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2497 ià(
c
->
¬gc
 > 4) {

2498 
»maššg
 = 
c
->
¬gc
 - 4;

2499 
pos
 = 4;

2501 
»maššg
) {

2502 ià(
»maššg
 >ğ1 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"withscores")) {

2503 
pos
++; 
»maššg
--;

2504 
w™hscÜes
 = 1;

2505 } ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2506 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
)

2507 !ğ
C_OK
) ||

2508 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
)

2509 !ğ
C_OK
))

2513 
pos
 +ğ3; 
»maššg
 -= 3;

2515 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2522 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

2523 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

2525 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2526 *
zl
 = 
zobj
->
±r
;

2527 *
•Œ
, *
¥Œ
;

2528 *
v¡r
;

2529 
vËn
;

2530 
vlÚg
;

2531 
scÜe
;

2534 ià(
»v”£
) {

2535 
•Œ
 = 
	`zzlLa¡InRªge
(
zl
,&
¿nge
);

2537 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2541 ià(
•Œ
 =ğ
NULL
) {

2542 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2547 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2548 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2553 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2557 
•Œ
 && 
off£t
--) {

2558 ià(
»v”£
) {

2559 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2561 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2565 
•Œ
 && 
lim™
--) {

2566 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2569 ià(
»v”£
) {

2570 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,&
¿nge
)) ;

2572 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) ;

2576 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2578 
¿ng–’
++;

2579 ià(
v¡r
 =ğ
NULL
) {

2580 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2582 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2585 ià(
w™hscÜes
) {

2586 
	`addR•lyDoubË
(
c
,
scÜe
);

2590 ià(
»v”£
) {

2591 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2593 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2596 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2597 
z£t
 *
zs
 = 
zobj
->
±r
;

2598 
zskli¡
 *
z¦
 = 
zs
->zsl;

2599 
zskli¡Node
 *
Ê
;

2602 ià(
»v”£
) {

2603 
Ê
 = 
	`z¦La¡InRªge
(
z¦
,&
¿nge
);

2605 
Ê
 = 
	`z¦Fœ¡InRªge
(
z¦
,&
¿nge
);

2609 ià(
Ê
 =ğ
NULL
) {

2610 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2617 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2621 
Ê
 && 
off£t
--) {

2622 ià(
»v”£
) {

2623 
Ê
 =†n->
backw¬d
;

2625 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2629 
Ê
 && 
lim™
--) {

2631 ià(
»v”£
) {

2632 ià(!
	`z¦V®ueG‹Mš
(
Ê
->
scÜe
,&
¿nge
)) ;

2634 ià(!
	`z¦V®ueL‹Max
(
Ê
->
scÜe
,&
¿nge
)) ;

2637 
¿ng–’
++;

2638 
	`addR•lyBulkCBufãr
(
c
,
Ê
->
–e
,
	`sd¦’
(ln->ele));

2640 ià(
w™hscÜes
) {

2641 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2645 ià(
»v”£
) {

2646 
Ê
 =†n->
backw¬d
;

2648 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2652 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2655 ià(
w™hscÜes
) {

2656 
¿ng–’
 *= 2;

2659 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

2660 
	}
}

2662 
	$z¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2663 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,0);

2664 
	}
}

2666 
	$z»v¿ngebyscÜeCommªd
(
ş›Á
 *
c
) {

2667 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,1);

2668 
	}
}

2670 
	$zcouÁCommªd
(
ş›Á
 *
c
) {

2671 
robj
 *
key
 = 
c
->
¬gv
[1];

2672 
robj
 *
zobj
;

2673 
z¿nge¥ec
 
¿nge
;

2674 
couÁ
 = 0;

2677 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
C_OK
) {

2678 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2683 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2684 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
)) ;

2686 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2687 *
zl
 = 
zobj
->
±r
;

2688 *
•Œ
, *
¥Œ
;

2689 
scÜe
;

2692 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2695 ià(
•Œ
 =ğ
NULL
) {

2696 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2701 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2702 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2703 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
));

2706 
•Œ
) {

2707 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2710 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) {

2713 
couÁ
++;

2714 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2717 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2718 
z£t
 *
zs
 = 
zobj
->
±r
;

2719 
zskli¡
 *
z¦
 = 
zs
->zsl;

2720 
zskli¡Node
 *
zn
;

2721 
¿nk
;

2724 
zn
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
);

2727 ià(
zn
 !ğ
NULL
) {

2728 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2729 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2732 
zn
 = 
	`z¦La¡InRªge
(
z¦
, &
¿nge
);

2735 ià(
zn
 !ğ
NULL
) {

2736 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2737 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2741 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2744 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2745 
	}
}

2747 
	$zËxcouÁCommªd
(
ş›Á
 *
c
) {

2748 
robj
 *
key
 = 
c
->
¬gv
[1];

2749 
robj
 *
zobj
;

2750 
zËx¿nge¥ec
 
¿nge
;

2751 
couÁ
 = 0;

2754 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
C_OK
) {

2755 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2760 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2761 
	`checkTy³
(
c
, 
zobj
, 
OBJ_ZSET
))

2763 
	`z¦F»eLexRªge
(&
¿nge
);

2767 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2768 *
zl
 = 
zobj
->
±r
;

2769 *
•Œ
, *
¥Œ
;

2772 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2775 ià(
•Œ
 =ğ
NULL
) {

2776 
	`z¦F»eLexRªge
(&
¿nge
);

2777 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2782 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2783 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
));

2786 
•Œ
) {

2788 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) {

2791 
couÁ
++;

2792 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2795 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2796 
z£t
 *
zs
 = 
zobj
->
±r
;

2797 
zskli¡
 *
z¦
 = 
zs
->zsl;

2798 
zskli¡Node
 *
zn
;

2799 
¿nk
;

2802 
zn
 = 
	`z¦Fœ¡InLexRªge
(
z¦
, &
¿nge
);

2805 ià(
zn
 !ğ
NULL
) {

2806 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2807 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2810 
zn
 = 
	`z¦La¡InLexRªge
(
z¦
, &
¿nge
);

2813 ià(
zn
 !ğ
NULL
) {

2814 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
–e
);

2815 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2819 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2822 
	`z¦F»eLexRªge
(&
¿nge
);

2823 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2824 
	}
}

2827 
	$g’”icZ¿ngebyËxCommªd
(
ş›Á
 *
c
, 
»v”£
) {

2828 
zËx¿nge¥ec
 
¿nge
;

2829 
robj
 *
key
 = 
c
->
¬gv
[1];

2830 
robj
 *
zobj
;

2831 
off£t
 = 0, 
lim™
 = -1;

2832 
¿ng–’
 = 0;

2833 *
»¶yËn
 = 
NULL
;

2834 
mšidx
, 
maxidx
;

2837 ià(
»v”£
) {

2839 
maxidx
 = 2; 
mšidx
 = 3;

2842 
mšidx
 = 2; 
maxidx
 = 3;

2845 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
C_OK
) {

2846 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2852 ià(
c
->
¬gc
 > 4) {

2853 
»maššg
 = 
c
->
¬gc
 - 4;

2854 
pos
 = 4;

2856 
»maššg
) {

2857 ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2858 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
è!ğ
C_OK
) ||

2859 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
è!ğ
C_OK
)) ;

2860 
pos
 +ğ3; 
»maššg
 -= 3;

2862 
	`z¦F»eLexRªge
(&
¿nge
);

2863 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2870 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

2871 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
))

2873 
	`z¦F»eLexRªge
(&
¿nge
);

2877 ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_ZIPLIST
) {

2878 *
zl
 = 
zobj
->
±r
;

2879 *
•Œ
, *
¥Œ
;

2880 *
v¡r
;

2881 
vËn
;

2882 
vlÚg
;

2885 ià(
»v”£
) {

2886 
•Œ
 = 
	`zzlLa¡InLexRªge
(
zl
,&
¿nge
);

2888 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2892 ià(
•Œ
 =ğ
NULL
) {

2893 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2894 
	`z¦F»eLexRªge
(&
¿nge
);

2899 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2900 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2905 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2909 
•Œ
 && 
off£t
--) {

2910 ià(
»v”£
) {

2911 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2913 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2917 
•Œ
 && 
lim™
--) {

2919 ià(
»v”£
) {

2920 ià(!
	`zzlLexV®ueG‹Mš
(
•Œ
,&
¿nge
)) ;

2922 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) ;

2927 
	`£rv”As£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2929 
¿ng–’
++;

2930 ià(
v¡r
 =ğ
NULL
) {

2931 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2933 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2937 ià(
»v”£
) {

2938 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2940 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2943 } ià(
zobj
->
’codšg
 =ğ
OBJ_ENCODING_SKIPLIST
) {

2944 
z£t
 *
zs
 = 
zobj
->
±r
;

2945 
zskli¡
 *
z¦
 = 
zs
->zsl;

2946 
zskli¡Node
 *
Ê
;

2949 ià(
»v”£
) {

2950 
Ê
 = 
	`z¦La¡InLexRªge
(
z¦
,&
¿nge
);

2952 
Ê
 = 
	`z¦Fœ¡InLexRªge
(
z¦
,&
¿nge
);

2956 ià(
Ê
 =ğ
NULL
) {

2957 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2958 
	`z¦F»eLexRªge
(&
¿nge
);

2965 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2969 
Ê
 && 
off£t
--) {

2970 ià(
»v”£
) {

2971 
Ê
 =†n->
backw¬d
;

2973 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2977 
Ê
 && 
lim™
--) {

2979 ià(
»v”£
) {

2980 ià(!
	`z¦LexV®ueG‹Mš
(
Ê
->
–e
,&
¿nge
)) ;

2982 ià(!
	`z¦LexV®ueL‹Max
(
Ê
->
–e
,&
¿nge
)) ;

2985 
¿ng–’
++;

2986 
	`addR•lyBulkCBufãr
(
c
,
Ê
->
–e
,
	`sd¦’
(ln->ele));

2989 ià(
»v”£
) {

2990 
Ê
 =†n->
backw¬d
;

2992 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2996 
	`£rv”Pªic
("Unknown sorted setƒncoding");

2999 
	`z¦F»eLexRªge
(&
¿nge
);

3000 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

3001 
	}
}

3003 
	$z¿ngebyËxCommªd
(
ş›Á
 *
c
) {

3004 
	`g’”icZ¿ngebyËxCommªd
(
c
,0);

3005 
	}
}

3007 
	$z»v¿ngebyËxCommªd
(
ş›Á
 *
c
) {

3008 
	`g’”icZ¿ngebyËxCommªd
(
c
,1);

3009 
	}
}

3011 
	$zÿrdCommªd
(
ş›Á
 *
c
) {

3012 
robj
 *
key
 = 
c
->
¬gv
[1];

3013 
robj
 *
zobj
;

3015 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

3016 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

3018 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
zobj
));

3019 
	}
}

3021 
	$zscÜeCommªd
(
ş›Á
 *
c
) {

3022 
robj
 *
key
 = 
c
->
¬gv
[1];

3023 
robj
 *
zobj
;

3024 
scÜe
;

3026 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

3027 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

3029 ià(
	`z£tScÜe
(
zobj
,
c
->
¬gv
[2]->
±r
,&
scÜe
è=ğ
C_ERR
) {

3030 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3032 
	`addR•lyDoubË
(
c
,
scÜe
);

3034 
	}
}

3036 
	$z¿nkG’”icCommªd
(
ş›Á
 *
c
, 
»v”£
) {

3037 
robj
 *
key
 = 
c
->
¬gv
[1];

3038 
robj
 *
–e
 = 
c
->
¬gv
[2];

3039 
robj
 *
zobj
;

3040 
¿nk
;

3042 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

3043 
	`checkTy³
(
c
,
zobj
,
OBJ_ZSET
)) ;

3045 
	`£rv”As£¹W™hInfo
(
c
,
–e
,
	`sdsEncodedObjeù
(ele));

3046 
¿nk
 = 
	`z£tRªk
(
zobj
,
–e
->
±r
,
»v”£
);

3047 ià(
¿nk
 >= 0) {

3048 
	`addR•lyLÚgLÚg
(
c
,
¿nk
);

3050 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

3052 
	}
}

3054 
	$z¿nkCommªd
(
ş›Á
 *
c
) {

3055 
	`z¿nkG’”icCommªd
(
c
, 0);

3056 
	}
}

3058 
	$z»v¿nkCommªd
(
ş›Á
 *
c
) {

3059 
	`z¿nkG’”icCommªd
(
c
, 1);

3060 
	}
}

3062 
	$zsÿnCommªd
(
ş›Á
 *
c
) {

3063 
robj
 *
o
;

3064 
cursÜ
;

3066 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
C_ERR
) ;

3067 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

3068 
	`checkTy³
(
c
,
o
,
OBJ_ZSET
)) ;

3069 
	`sÿnG’”icCommªd
(
c
,
o
,
cursÜ
);

3070 
	}
}

	@src/testhelp.h

39 #iâdeà
__TESTHELP_H


40 
	#__TESTHELP_H


	)

42 
	g__çed_‹¡s
 = 0;

43 
	g__‹¡_num
 = 0;

44 
	#‹¡_cÚd
(
desü
,
_c
) do { \

45 
__‹¡_num
++; 
	`´štf
("%d - %s: ", __‹¡_num, 
desü
); \

46 if(
_c
è
	`´štf
("PASSED\n"); {´štf("FAILED\n"); 
__çed_‹¡s
++;} \

47 } 0);

	)

48 
	#‹¡_»pÜt
() do { \

49 
	`´štf
("%de¡s, %d…as£d, %d faed\n", 
__‹¡_num
, \

50 
__‹¡_num
-
__çed_‹¡s
, __failed_tests); \

51 ià(
__çed_‹¡s
) { \

52 
	`´štf
("=== WARNING === We have failedests here...\n"); \

53 
	`ex™
(1); \

55 } 0);

	)

	@src/util.c

30 
	~"fmaüos.h
"

31 
	~<¡dlib.h
>

32 
	~<¡dio.h
>

33 
	~<¡ršg.h
>

34 
	~<ùy³.h
>

35 
	~<lim™s.h
>

36 
	~<m©h.h
>

37 
	~<uni¡d.h
>

38 
	~<sys/time.h
>

39 
	~<æßt.h
>

40 
	~<¡dšt.h
>

41 
	~<”ºo.h
>

43 
	~"ut.h
"

44 
	~"sha1.h
"

47 
	$¡ršgm©chËn
(cÚ¡ *
·‰”n
, 
·‰”nL’
,

48 cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
)

50 
·‰”nL’
) {

51 
·‰”n
[0]) {

53 
·‰”n
[1] == '*') {

54 
·‰”n
++;

55 
·‰”nL’
--;

57 ià(
·‰”nL’
 == 1)

59 
¡ršgL’
) {

60 ià(
	`¡ršgm©chËn
(
·‰”n
+1, 
·‰”nL’
-1,

61 
¡ršg
, 
¡ršgL’
, 
noÿ£
))

63 
¡ršg
++;

64 
¡ršgL’
--;

69 ià(
¡ršgL’
 == 0)

71 
¡ršg
++;

72 
¡ršgL’
--;

76 
nÙ
, 
m©ch
;

78 
·‰”n
++;

79 
·‰”nL’
--;

80 
nÙ
 = 
·‰”n
[0] == '^';

81 ià(
nÙ
) {

82 
·‰”n
++;

83 
·‰”nL’
--;

85 
m©ch
 = 0;

87 ià(
·‰”n
[0] =ğ'\\' && 
·‰”nL’
 >= 2) {

88 
·‰”n
++;

89 
·‰”nL’
--;

90 ià(
·‰”n
[0] =ğ
¡ršg
[0])

91 
m©ch
 = 1;

92 } ià(
·‰”n
[0] == ']') {

94 } ià(
·‰”nL’
 == 0) {

95 
·‰”n
--;

96 
·‰”nL’
++;

98 } ià(
·‰”n
[1] =ğ'-' && 
·‰”nL’
 >= 3) {

99 
¡¬t
 = 
·‰”n
[0];

100 
’d
 = 
·‰”n
[2];

101 
c
 = 
¡ršg
[0];

102 ià(
¡¬t
 > 
’d
) {

103 
t
 = 
¡¬t
;

104 
¡¬t
 = 
’d
;

105 
’d
 = 
t
;

107 ià(
noÿ£
) {

108 
¡¬t
 = 
	`tŞow”
(start);

109 
’d
 = 
	`tŞow”
(end);

110 
c
 = 
	`tŞow”
(c);

112 
·‰”n
 += 2;

113 
·‰”nL’
 -= 2;

114 ià(
c
 >ğ
¡¬t
 && c <ğ
’d
)

115 
m©ch
 = 1;

117 ià(!
noÿ£
) {

118 ià(
·‰”n
[0] =ğ
¡ršg
[0])

119 
m©ch
 = 1;

121 ià(
	`tŞow”
(()
·‰”n
[0]è=ğtŞow”(()
¡ršg
[0]))

122 
m©ch
 = 1;

125 
·‰”n
++;

126 
·‰”nL’
--;

128 ià(
nÙ
)

129 
m©ch
 = !match;

130 ià(!
m©ch
)

132 
¡ršg
++;

133 
¡ršgL’
--;

137 ià(
·‰”nL’
 >= 2) {

138 
·‰”n
++;

139 
·‰”nL’
--;

143 ià(!
noÿ£
) {

144 ià(
·‰”n
[0] !ğ
¡ršg
[0])

147 ià(
	`tŞow”
(()
·‰”n
[0]è!ğtŞow”(()
¡ršg
[0]))

150 
¡ršg
++;

151 
¡ršgL’
--;

154 
·‰”n
++;

155 
·‰”nL’
--;

156 ià(
¡ršgL’
 == 0) {

157 *
·‰”n
 == '*') {

158 
·‰”n
++;

159 
·‰”nL’
--;

164 ià(
·‰”nL’
 =ğ0 && 
¡ršgL’
 == 0)

167 
	}
}

169 
	$¡ršgm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
) {

170  
	`¡ršgm©chËn
(
·‰”n
,
	`¡¾’
Õ©‹º),
¡ršg
,¡¾’(¡ršg),
noÿ£
);

171 
	}
}

180 
	$memtŞl
(cÚ¡ *
p
, *
”r
) {

181 cÚ¡ *
u
;

182 
buf
[128];

183 
mul
;

184 
v®
;

185 
dig™s
;

187 ià(
”r
) *err = 0;

190 
u
 = 
p
;

191 ià(*
u
 == '-') u++;

192 *
u
 && 
	`isdig™
(*u)) u++;

193 ià(*
u
 =ğ'\0' || !
	`¡rÿ£cmp
(u,"b")) {

194 
mul
 = 1;

195 } ià(!
	`¡rÿ£cmp
(
u
,"k")) {

196 
mul
 = 1000;

197 } ià(!
	`¡rÿ£cmp
(
u
,"kb")) {

198 
mul
 = 1024;

199 } ià(!
	`¡rÿ£cmp
(
u
,"m")) {

200 
mul
 = 1000*1000;

201 } ià(!
	`¡rÿ£cmp
(
u
,"mb")) {

202 
mul
 = 1024*1024;

203 } ià(!
	`¡rÿ£cmp
(
u
,"g")) {

204 
mul
 = 1000L*1000*1000;

205 } ià(!
	`¡rÿ£cmp
(
u
,"gb")) {

206 
mul
 = 1024L*1024*1024;

208 ià(
”r
) *err = 1;

214 
dig™s
 = 
u
-
p
;

215 ià(
dig™s
 >ğ(
buf
)) {

216 ià(
”r
) *err = 1;

219 
	`memıy
(
buf
,
p
,
dig™s
);

220 
buf
[
dig™s
] = '\0';

222 *
’d±r
;

223 
”ºo
 = 0;

224 
v®
 = 
	`¡¹Şl
(
buf
,&
’d±r
,10);

225 ià((
v®
 =ğ0 && 
”ºo
 =ğ
EINVAL
è|| *
’d±r
 != '\0') {

226 ià(
”r
) *err = 1;

229  
v®
*
mul
;

230 
	}
}

234 
ušt32_t
 
	$dig™s10
(
ušt64_t
 
v
) {

235 ià(
v
 < 10)  1;

236 ià(
v
 < 100)  2;

237 ià(
v
 < 1000)  3;

238 ià(
v
 < 1000000000000UL) {

239 ià(
v
 < 100000000UL) {

240 ià(
v
 < 1000000) {

241 ià(
v
 < 10000)  4;

242  5 + (
v
 >= 100000);

244  7 + (
v
 >= 10000000UL);

246 ià(
v
 < 10000000000UL) {

247  9 + (
v
 >= 1000000000UL);

249  11 + (
v
 >= 100000000000UL);

251  12 + 
	`dig™s10
(
v
 / 1000000000000UL);

252 
	}
}

255 
ušt32_t
 
	$sdig™s10
(
št64_t
 
v
) {

256 ià(
v
 < 0) {

258 
ušt64_t
 
uv
 = (
v
 !ğ
LLONG_MIN
) ?

259 (
ušt64_t
)-
v
 : ((ušt64_tè
LLONG_MAX
)+1;

260  
	`dig™s10
(
uv
)+1;

262  
	`dig™s10
(
v
);

264 
	}
}

277 
	$Î2¡ršg
(*
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
) {

278 cÚ¡ 
dig™s
[201] =

284 
Ãg©ive
;

285 
v®ue
;

289 ià(
sv®ue
 < 0) {

290 ià(
sv®ue
 !ğ
LLONG_MIN
) {

291 
v®ue
 = -
sv®ue
;

293 
v®ue
 = ((è
LLONG_MAX
)+1;

295 
Ãg©ive
 = 1;

297 
v®ue
 = 
sv®ue
;

298 
Ãg©ive
 = 0;

302 
ušt32_t
 cÚ¡ 
Ëngth
 = 
	`dig™s10
(
v®ue
)+
Ãg©ive
;

303 ià(
Ëngth
 >ğ
d¡Ën
)  0;

306 
ušt32_t
 
Ãxt
 = 
Ëngth
;

307 
d¡
[
Ãxt
] = '\0';

308 
Ãxt
--;

309 
v®ue
 >= 100) {

310 cÚ¡ 
i
 = (
v®ue
 % 100) * 2;

311 
v®ue
 /= 100;

312 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

313 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

314 
Ãxt
 -= 2;

318 ià(
v®ue
 < 10) {

319 
d¡
[
Ãxt
] = '0' + (
ušt32_t
è
v®ue
;

321 
i
 = (
ušt32_t
è
v®ue
 * 2;

322 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

323 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

327 ià(
Ãg©ive
è
d¡
[0] = '-';

328  
Ëngth
;

329 
	}
}

343 
	$¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
) {

344 cÚ¡ *
p
 = 
s
;

345 
size_t
 
¶’
 = 0;

346 
Ãg©ive
 = 0;

347 
v
;

349 ià(
¶’
 =ğ
¦’
)

353 ià(
¦’
 =ğ1 && 
p
[0] == '0') {

354 ià(
v®ue
 !ğ
NULL
) *value = 0;

358 ià(
p
[0] == '-') {

359 
Ãg©ive
 = 1;

360 
p
++; 
¶’
++;

363 ià(
¶’
 =ğ
¦’
)

368 ià(
p
[0] >= '1' &&…[0] <= '9') {

369 
v
 = 
p
[0]-'0';

370 
p
++; 
¶’
++;

371 } ià(
p
[0] =ğ'0' && 
¦’
 == 1) {

372 *
v®ue
 = 0;

378 
¶’
 < 
¦’
 && 
p
[0] >= '0' &&…[0] <= '9') {

379 ià(
v
 > (
ULLONG_MAX
 / 10))

381 
v
 *= 10;

383 ià(
v
 > (
ULLONG_MAX
 - (
p
[0]-'0')))

385 
v
 +ğ
p
[0]-'0';

387 
p
++; 
¶’
++;

391 ià(
¶’
 < 
¦’
)

394 ià(
Ãg©ive
) {

395 ià(
v
 > (()(-(
LLONG_MIN
+1))+1))

397 ià(
v®ue
 !ğ
NULL
è*v®uğ-
v
;

399 ià(
v
 > 
LLONG_MAX
)

401 ià(
v®ue
 !ğ
NULL
è*v®uğ
v
;

404 
	}
}

409 
	$¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
) {

410 
Îv®
;

412 ià(!
	`¡ršg2Î
(
s
,
¦’
,&
Îv®
))

415 ià(
Îv®
 < 
LONG_MIN
 ||†lv® > 
LONG_MAX
)

418 *
lv®
 = ()
Îv®
;

420 
	}
}

429 
	$¡ršg2ld
(cÚ¡ *
s
, 
size_t
 
¦’
, *
dp
) {

430 
buf
[256];

431 
v®ue
;

432 *
•Œ
;

434 ià(
¦’
 >ğ(
buf
))  0;

435 
	`memıy
(
buf
,
s
,
¦’
);

436 
buf
[
¦’
] = '\0';

438 
”ºo
 = 0;

439 
v®ue
 = 
	`¡¹Şd
(
buf
, &
•Œ
);

440 ià(
	`is¥aû
(
buf
[0]è|| 
•Œ
[0] != '\0' ||

441 (
”ºo
 =ğ
ERANGE
 &&

442 (
v®ue
 =ğ
HUGE_VAL
 || value == -HUGE_VAL || value == 0)) ||

443 
”ºo
 =ğ
EINVAL
 ||

444 
	`i¢ª
(
v®ue
))

447 ià(
dp
è*d°ğ
v®ue
;

449 
	}
}

456 
	$d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
) {

457 ià(
	`i¢ª
(
v®ue
)) {

458 
Ën
 = 
	`¢´štf
(
buf
,len,"nan");

459 } ià(
	`isšf
(
v®ue
)) {

460 ià(
v®ue
 < 0)

461 
Ën
 = 
	`¢´štf
(
buf
,len,"-inf");

463 
Ën
 = 
	`¢´štf
(
buf
,len,"inf");

464 } ià(
v®ue
 == 0) {

466 ià(1.0/
v®ue
 < 0)

467 
Ën
 = 
	`¢´štf
(
buf
,len,"-0");

469 
Ën
 = 
	`¢´štf
(
buf
,len,"0");

471 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

481 
mš
 = -4503599627370495;

482 
max
 = 4503599627370496;

483 ià(
v®ue
 > 
mš
 && v®u< 
max
 && value == (()(()value)))

484 
Ën
 = 
	`Î2¡ršg
(
buf
,Ën,()
v®ue
);

487 
Ën
 = 
	`¢´štf
(
buf
,Ën,"%.17g",
v®ue
);

490  
Ën
;

491 
	}
}

500 
	$ld2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
, 
humªä›ndly
) {

501 
size_t
 
l
;

503 ià(
	`isšf
(
v®ue
)) {

506 ià(
Ën
 < 5)  0;

507 ià(
v®ue
 > 0) {

508 
	`memıy
(
buf
,"inf",3);

509 
l
 = 3;

511 
	`memıy
(
buf
,"-inf",4);

512 
l
 = 4;

514 } ià(
humªä›ndly
) {

520 
l
 = 
	`¢´štf
(
buf
,
Ën
,"%.17Lf", 
v®ue
);

521 ià(
l
+1 > 
Ën
)  0;

523 ià(
	`¡rchr
(
buf
,'.'è!ğ
NULL
) {

524 *
p
 = 
buf
+
l
-1;

525 *
p
 == '0') {

526 
p
--;

527 
l
--;

529 ià(*
p
 =ğ'.'è
l
--;

532 
l
 = 
	`¢´štf
(
buf
,
Ën
,"%.17Lg", 
v®ue
);

533 ià(
l
+1 > 
Ën
)  0;

535 
buf
[
l
] = '\0';

536  
l
;

537 
	}
}

543 
	$g‘RªdomHexCh¬s
(*
p
, 
Ën
) {

544 *
ch¬£t
 = "0123456789abcdef";

545 
j
;

548 
£ed_š™Ÿlized
 = 0;

549 
£ed
[20];

550 
ušt64_t
 
couÁ”
 = 0;

552 ià(!
£ed_š™Ÿlized
) {

557 
FILE
 *
å
 = 
	`fİ’
("/dev/urandom","r");

558 ià(
å
 && 
	`ä—d
(
£ed
,(seed),1,fp) == 1)

559 
£ed_š™Ÿlized
 = 1;

560 ià(
å
è
	`fşo£
(fp);

563 ià(
£ed_š™Ÿlized
) {

564 
Ën
) {

565 
dige¡
[20];

566 
SHA1_CTX
 
ùx
;

567 
cİyËn
 = 
Ën
 > 20 ? 20 :†en;

569 
	`SHA1In™
(&
ùx
);

570 
	`SHA1Upd©e
(&
ùx
, 
£ed
, (seed));

571 
	`SHA1Upd©e
(&
ùx
, (*)&
couÁ”
,(counter));

572 
	`SHA1Fš®
(
dige¡
, &
ùx
);

573 
couÁ”
++;

575 
	`memıy
(
p
,
dige¡
,
cİyËn
);

577 
j
 = 0; j < 
cİyËn
; j++è
p
[j] = 
ch¬£t
[p[j] & 0x0F];

578 
Ën
 -ğ
cİyËn
;

579 
p
 +ğ
cİyËn
;

585 *
x
 = 
p
;

586 
l
 = 
Ën
;

587 
timev®
 
tv
;

588 
pid_t
 
pid
 = 
	`g‘pid
();

591 
	`g‘timeofday
(&
tv
,
NULL
);

592 ià(
l
 >ğ(
tv
.
tv_u£c
)) {

593 
	`memıy
(
x
,&
tv
.
tv_u£c
,(tv.tv_usec));

594 
l
 -ğ(
tv
.
tv_u£c
);

595 
x
 +ğ(
tv
.
tv_u£c
);

597 ià(
l
 >ğ(
tv
.
tv_£c
)) {

598 
	`memıy
(
x
,&
tv
.
tv_£c
,(tv.tv_sec));

599 
l
 -ğ(
tv
.
tv_£c
);

600 
x
 +ğ(
tv
.
tv_£c
);

602 ià(
l
 >ğ(
pid
)) {

603 
	`memıy
(
x
,&
pid
,(pid));

604 
l
 -ğ(
pid
);

605 
x
 +ğ(
pid
);

609 
j
 = 0; j < 
Ën
; j++) {

610 
p
[
j
] ^ğ
	`¿nd
();

611 
p
[
j
] = 
ch¬£t
[p[j] & 0x0F];

614 
	}
}

623 
sds
 
	$g‘AbsŞu‹P©h
(*
f’ame
) {

624 
cwd
[1024];

625 
sds
 
ab¥©h
;

626 
sds
 
»Í©h
 = 
	`sd¢ew
(
f’ame
);

628 
»Í©h
 = 
	`sd¡rim
(relpath," \r\n\t");

629 ià(
»Í©h
[0] == '/') „elpath;

632 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

633 
	`sdsä“
(
»Í©h
);

634  
NULL
;

636 
ab¥©h
 = 
	`sd¢ew
(
cwd
);

637 ià(
	`sd¦’
(
ab¥©h
) &&‡bspath[sdslen(abspath)-1] != '/')

638 
ab¥©h
 = 
	`sdsÿt
(abspath,"/");

646 
	`sd¦’
(
»Í©h
) >= 3 &&

647 
»Í©h
[0] == '.' &&„elpath[1] == '.' &&„elpath[2] == '/')

649 
	`sd¤ªge
(
»Í©h
,3,-1);

650 ià(
	`sd¦’
(
ab¥©h
) > 1) {

651 *
p
 = 
ab¥©h
 + 
	`sd¦’
(abspath)-2;

652 
ŒimËn
 = 1;

654 *
p
 != '/') {

655 
p
--;

656 
ŒimËn
++;

658 
	`sd¤ªge
(
ab¥©h
,0,-(
ŒimËn
+1));

663 
ab¥©h
 = 
	`sdsÿtsds
×b¥©h,
»Í©h
);

664 
	`sdsä“
(
»Í©h
);

665  
ab¥©h
;

666 
	}
}

672 
	$·thIsBa£Name
(*
·th
) {

673  
	`¡rchr
(
·th
,'/'è=ğ
NULL
 && strchr(path,'\\') == NULL;

674 
	}
}

676 #ifdeà
REDIS_TEST


677 
	~<as£¹.h
>

679 
	$‹¡_¡ršg2Î
() {

680 
buf
[32];

681 
v
;

684 
	`¡rıy
(
buf
,"+1");

685 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

688 
	`¡rıy
(
buf
," 1");

689 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

692 
	`¡rıy
(
buf
,"1 ");

693 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

696 
	`¡rıy
(
buf
,"01");

697 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

699 
	`¡rıy
(
buf
,"-1");

700 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

701 
	`as£¹
(
v
 == -1);

703 
	`¡rıy
(
buf
,"0");

704 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

705 
	`as£¹
(
v
 == 0);

707 
	`¡rıy
(
buf
,"1");

708 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

709 
	`as£¹
(
v
 == 1);

711 
	`¡rıy
(
buf
,"99");

712 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

713 
	`as£¹
(
v
 == 99);

715 
	`¡rıy
(
buf
,"-99");

716 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

717 
	`as£¹
(
v
 == -99);

719 
	`¡rıy
(
buf
,"-9223372036854775808");

720 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

721 
	`as£¹
(
v
 =ğ
LLONG_MIN
);

723 
	`¡rıy
(
buf
,"-9223372036854775809");

724 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

726 
	`¡rıy
(
buf
,"9223372036854775807");

727 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

728 
	`as£¹
(
v
 =ğ
LLONG_MAX
);

730 
	`¡rıy
(
buf
,"9223372036854775808");

731 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

732 
	}
}

734 
	$‹¡_¡ršg2l
() {

735 
buf
[32];

736 
v
;

739 
	`¡rıy
(
buf
,"+1");

740 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

743 
	`¡rıy
(
buf
,"01");

744 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

746 
	`¡rıy
(
buf
,"-1");

747 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

748 
	`as£¹
(
v
 == -1);

750 
	`¡rıy
(
buf
,"0");

751 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

752 
	`as£¹
(
v
 == 0);

754 
	`¡rıy
(
buf
,"1");

755 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

756 
	`as£¹
(
v
 == 1);

758 
	`¡rıy
(
buf
,"99");

759 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

760 
	`as£¹
(
v
 == 99);

762 
	`¡rıy
(
buf
,"-99");

763 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

764 
	`as£¹
(
v
 == -99);

766 #ià
LONG_MAX
 !ğ
LLONG_MAX


767 
	`¡rıy
(
buf
,"-2147483648");

768 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

769 
	`as£¹
(
v
 =ğ
LONG_MIN
);

771 
	`¡rıy
(
buf
,"-2147483649");

772 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

774 
	`¡rıy
(
buf
,"2147483647");

775 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

776 
	`as£¹
(
v
 =ğ
LONG_MAX
);

778 
	`¡rıy
(
buf
,"2147483648");

779 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

781 
	}
}

783 
	$‹¡_Î2¡ršg
() {

784 
buf
[32];

785 
v
;

786 
sz
;

788 
v
 = 0;

789 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

790 
	`as£¹
(
sz
 == 1);

791 
	`as£¹
(!
	`¡rcmp
(
buf
, "0"));

793 
v
 = -1;

794 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

795 
	`as£¹
(
sz
 == 2);

796 
	`as£¹
(!
	`¡rcmp
(
buf
, "-1"));

798 
v
 = 99;

799 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

800 
	`as£¹
(
sz
 == 2);

801 
	`as£¹
(!
	`¡rcmp
(
buf
, "99"));

803 
v
 = -99;

804 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

805 
	`as£¹
(
sz
 == 3);

806 
	`as£¹
(!
	`¡rcmp
(
buf
, "-99"));

808 
v
 = -2147483648;

809 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

810 
	`as£¹
(
sz
 == 11);

811 
	`as£¹
(!
	`¡rcmp
(
buf
, "-2147483648"));

813 
v
 = 
LLONG_MIN
;

814 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

815 
	`as£¹
(
sz
 == 20);

816 
	`as£¹
(!
	`¡rcmp
(
buf
, "-9223372036854775808"));

818 
v
 = 
LLONG_MAX
;

819 
sz
 = 
	`Î2¡ršg
(
buf
,  buf, 
v
);

820 
	`as£¹
(
sz
 == 19);

821 
	`as£¹
(!
	`¡rcmp
(
buf
, "9223372036854775807"));

822 
	}
}

824 
	#UNUSED
(
x
è()(x)

	)

825 
	$utTe¡
(
¬gc
, **
¬gv
) {

826 
	`UNUSED
(
¬gc
);

827 
	`UNUSED
(
¬gv
);

829 
	`‹¡_¡ršg2Î
();

830 
	`‹¡_¡ršg2l
();

831 
	`‹¡_Î2¡ršg
();

833 
	}
}

	@src/util.h

30 #iâdeà
__REDIS_UTIL_H


31 
	#__REDIS_UTIL_H


	)

33 
	~<¡dšt.h
>

34 
	~"sds.h
"

39 
	#MAX_LONG_DOUBLE_CHARS
 5*1024

	)

41 
¡ršgm©chËn
(cÚ¡ *
p
, 
¶’
, cÚ¡ *
s
, 
¦’
, 
noÿ£
);

42 
¡ršgm©ch
(cÚ¡ *
p
, cÚ¡ *
s
, 
noÿ£
);

43 
memtŞl
(cÚ¡ *
p
, *
”r
);

44 
ušt32_t
 
dig™s10
(
ušt64_t
 
v
);

45 
ušt32_t
 
sdig™s10
(
št64_t
 
v
);

46 
Î2¡ršg
(*
s
, 
size_t
 
Ën
, 
v®ue
);

47 
¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

48 
¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

49 
¡ršg2ld
(cÚ¡ *
s
, 
size_t
 
¦’
, *
dp
);

50 
d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
);

51 
ld2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
, 
humªä›ndly
);

52 
sds
 
g‘AbsŞu‹P©h
(*
f’ame
);

53 
·thIsBa£Name
(*
·th
);

55 #ifdeà
REDIS_TEST


56 
utTe¡
(
¬gc
, **
¬gv
);

	@src/version.h

1 
	#REDIS_VERSION
 "4.0.10"

	)

	@src/ziplist.c

182 
	~<¡dio.h
>

183 
	~<¡dlib.h
>

184 
	~<¡ršg.h
>

185 
	~<¡dšt.h
>

186 
	~<lim™s.h
>

187 
	~"zm®loc.h
"

188 
	~"ut.h
"

189 
	~"zli¡.h
"

190 
	~"’dŸncÚv.h
"

191 
	~"»di§s£¹.h
"

193 
	#ZIP_END
 255

	)

194 
	#ZIP_BIG_PREVLEN
 254

	)

202 
	#ZIP_STR_MASK
 0xc0

	)

203 
	#ZIP_INT_MASK
 0x30

	)

204 
	#ZIP_STR_06B
 (0 << 6)

	)

205 
	#ZIP_STR_14B
 (1 << 6)

	)

206 
	#ZIP_STR_32B
 (2 << 6)

	)

207 
	#ZIP_INT_16B
 (0xc0 | 0<<4)

	)

208 
	#ZIP_INT_32B
 (0xc0 | 1<<4)

	)

209 
	#ZIP_INT_64B
 (0xc0 | 2<<4)

	)

210 
	#ZIP_INT_24B
 (0xc0 | 3<<4)

	)

211 
	#ZIP_INT_8B
 0xã

	)

215 
	#ZIP_INT_IMM_MASK
 0x0à

	)

217 
	#ZIP_INT_IMM_MIN
 0xf1

	)

218 
	#ZIP_INT_IMM_MAX
 0xfd

	)

220 
	#INT24_MAX
 0x7fffff

	)

221 
	#INT24_MIN
 (-
INT24_MAX
 - 1)

	)

225 
	#ZIP_IS_STR
(
’c
è((Óncè& 
ZIP_STR_MASK
è< ZIP_STR_MASK)

	)

230 
	#ZIPLIST_BYTES
(
zl
è(*((
ušt32_t
*)(zl)))

	)

233 
	#ZIPLIST_TAIL_OFFSET
(
zl
è(*((
ušt32_t
*)((zl)+(ušt32_t))))

	)

237 
	#ZIPLIST_LENGTH
(
zl
è(*((
ušt16_t
*)((zl)+(
ušt32_t
)*2)))

	)

242 
	#ZIPLIST_HEADER_SIZE
 ((
ušt32_t
)*2+(
ušt16_t
))

	)

245 
	#ZIPLIST_END_SIZE
 ((
ušt8_t
))

	)

248 
	#ZIPLIST_ENTRY_HEAD
(
zl
è((zl)+
ZIPLIST_HEADER_SIZE
)

	)

252 
	#ZIPLIST_ENTRY_TAIL
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl)))

	)

256 
	#ZIPLIST_ENTRY_END
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-1)

	)

263 
	#ZIPLIST_INCR_LENGTH
(
zl
,
šü
) { \

264 ià(
	`ZIPLIST_LENGTH
(
zl
è< 
UINT16_MAX
) \

265 
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(šŒev16ifbe(ZIPLIST_LENGTH(zl))+
šü
); \

266 }

	)

271 
	szËÁry
 {

272 
	m´ev¿wËnsize
;

273 
	m´ev¿wËn
;

274 
	mËnsize
;

277 
	mËn
;

282 
	mh—d”size
;

283 
	m’codšg
;

287 *
	mp
;

289 } 
	tzËÁry
;

291 
	#ZIPLIST_ENTRY_ZERO
(
zË
) { \

292 (
zË
)->
´ev¿wËnsize
 = (zË)->
´ev¿wËn
 = 0; \

293 (
zË
)->
Ënsize
 = (zË)->
Ën
 = (zË)->
h—d”size
 = 0; \

294 (
zË
)->
’codšg
 = 0; \

295 (
zË
)->
p
 = 
NULL
; \

296 }

	)

300 
	#ZIP_ENTRY_ENCODING
(
±r
, 
’codšg
) do { \

301 (
’codšg
èğ(
±r
[0]); \

302 ià((
’codšg
è< 
ZIP_STR_MASK
) (encoding) &= ZIP_STR_MASK; \

303 } 0)

	)

306 
	$zIÁSize
(
’codšg
) {

307 
’codšg
) {

308 
ZIP_INT_8B
:  1;

309 
ZIP_INT_16B
:  2;

310 
ZIP_INT_24B
:  3;

311 
ZIP_INT_32B
:  4;

312 
ZIP_INT_64B
:  8;

314 ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
)

316 
	`·nic
("Inv®id iÁeg”ƒncodšg 0x%02X", 
’codšg
);

318 
	}
}

332 
	$zStÜeEÁryEncodšg
(*
p
, 
’codšg
, 
¿wËn
) {

333 
Ën
 = 1, 
buf
[5];

335 ià(
	`ZIP_IS_STR
(
’codšg
)) {

338 ià(
¿wËn
 <= 0x3f) {

339 ià(!
p
è 
Ën
;

340 
buf
[0] = 
ZIP_STR_06B
 | 
¿wËn
;

341 } ià(
¿wËn
 <= 0x3fff) {

342 
Ën
 += 1;

343 ià(!
p
è 
Ën
;

344 
buf
[0] = 
ZIP_STR_14B
 | ((
¿wËn
 >> 8) & 0x3f);

345 
buf
[1] = 
¿wËn
 & 0xff;

347 
Ën
 += 4;

348 ià(!
p
è 
Ën
;

349 
buf
[0] = 
ZIP_STR_32B
;

350 
buf
[1] = (
¿wËn
 >> 24) & 0xff;

351 
buf
[2] = (
¿wËn
 >> 16) & 0xff;

352 
buf
[3] = (
¿wËn
 >> 8) & 0xff;

353 
buf
[4] = 
¿wËn
 & 0xff;

357 ià(!
p
è 
Ën
;

358 
buf
[0] = 
’codšg
;

362 
	`memıy
(
p
,
buf
,
Ën
);

363  
Ën
;

364 
	}
}

371 
	#ZIP_DECODE_LENGTH
(
±r
, 
’codšg
, 
Ënsize
, 
Ën
) do { \

372 
	`ZIP_ENTRY_ENCODING
((
±r
), (
’codšg
)); \

373 ià((
’codšg
è< 
ZIP_STR_MASK
) { \

374 ià((
’codšg
è=ğ
ZIP_STR_06B
) { \

375 (
Ënsize
) = 1; \

376 (
Ën
èğ(
±r
)[0] & 0x3f; \

377 } ià((
’codšg
è=ğ
ZIP_STR_14B
) { \

378 (
Ënsize
) = 2; \

379 (
Ën
èğ(((
±r
)[0] & 0x3f) << 8) | (ptr)[1]; \

380 } ià((
’codšg
è=ğ
ZIP_STR_32B
) { \

381 (
Ënsize
) = 5; \

382 (
Ën
èğ((
±r
)[1] << 24) | \

383 ((
±r
)[2] << 16) | \

384 ((
±r
)[3] << 8) | \

385 ((
±r
)[4]); \

387 
	`·nic
("Inv®id sŒšgƒncodšg 0x%02X", (
’codšg
)); \

390 (
Ënsize
) = 1; \

391 (
Ën
èğ
	`zIÁSize
(
’codšg
); \

393 } 0);

	)

397 
	$zStÜeP»vEÁryL’gthL¬ge
(*
p
, 
Ën
) {

398 ià(
p
 !ğ
NULL
) {

399 
p
[0] = 
ZIP_BIG_PREVLEN
;

400 
	`memıy
(
p
+1,&
Ën
,(len));

401 
	`mem»v32ifbe
(
p
+1);

403  1+(
Ën
);

404 
	}
}

408 
	$zStÜeP»vEÁryL’gth
(*
p
, 
Ën
) {

409 ià(
p
 =ğ
NULL
) {

410  (
Ën
 < 
ZIP_BIG_PREVLEN
) ? 1 : (len)+1;

412 ià(
Ën
 < 
ZIP_BIG_PREVLEN
) {

413 
p
[0] = 
Ën
;

416  
	`zStÜeP»vEÁryL’gthL¬ge
(
p
,
Ën
);

419 
	}
}

423 
	#ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
) do { \

424 ià((
±r
)[0] < 
ZIP_BIG_PREVLEN
) { \

425 (
´evËnsize
) = 1; \

427 (
´evËnsize
) = 5; \

429 } 0);

	)

438 
	#ZIP_DECODE_PREVLEN
(
±r
, 
´evËnsize
, 
´evËn
) do { \

439 
	`ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
); \

440 ià((
´evËnsize
) == 1) { \

441 (
´evËn
èğ(
±r
)[0]; \

442 } ià((
´evËnsize
) == 5) { \

443 
	`as£¹
(((
´evËn
)) == 4); \

444 
	`memıy
(&(
´evËn
), ((*)(
±r
)) + 1, 4); \

445 
	`mem»v32ifbe
(&
´evËn
); \

447 } 0);

	)

464 
	$zP»vL’By‹Diff
(*
p
, 
Ën
) {

465 
´evËnsize
;

466 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

467  
	`zStÜeP»vEÁryL’gth
(
NULL
, 
Ën
è- 
´evËnsize
;

468 
	}
}

471 
	$zRawEÁryL’gth
(*
p
) {

472 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

473 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

474 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

475  
´evËnsize
 + 
Ënsize
 + 
Ën
;

476 
	}
}

480 
	$zTryEncodšg
(*
’Œy
, 
’ŒyËn
, *
v
, *
’codšg
) {

481 
v®ue
;

483 ià(
’ŒyËn
 >= 32 ||ƒntrylen == 0)  0;

484 ià(
	`¡ršg2Î
((*)
’Œy
,
’ŒyËn
,&
v®ue
)) {

487 ià(
v®ue
 >= 0 && value <= 12) {

488 *
’codšg
 = 
ZIP_INT_IMM_MIN
+
v®ue
;

489 } ià(
v®ue
 >ğ
INT8_MIN
 && v®u<ğ
INT8_MAX
) {

490 *
’codšg
 = 
ZIP_INT_8B
;

491 } ià(
v®ue
 >ğ
INT16_MIN
 && v®u<ğ
INT16_MAX
) {

492 *
’codšg
 = 
ZIP_INT_16B
;

493 } ià(
v®ue
 >ğ
INT24_MIN
 && v®u<ğ
INT24_MAX
) {

494 *
’codšg
 = 
ZIP_INT_24B
;

495 } ià(
v®ue
 >ğ
INT32_MIN
 && v®u<ğ
INT32_MAX
) {

496 *
’codšg
 = 
ZIP_INT_32B
;

498 *
’codšg
 = 
ZIP_INT_64B
;

500 *
v
 = 
v®ue
;

504 
	}
}

507 
	$zSaveIÁeg”
(*
p
, 
št64_t
 
v®ue
, 
’codšg
) {

508 
št16_t
 
i16
;

509 
št32_t
 
i32
;

510 
št64_t
 
i64
;

511 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

512 ((
št8_t
*)
p
)[0] = (št8_t)
v®ue
;

513 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

514 
i16
 = 
v®ue
;

515 
	`memıy
(
p
,&
i16
,(i16));

516 
	`mem»v16ifbe
(
p
);

517 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

518 
i32
 = 
v®ue
<<8;

519 
	`mem»v32ifbe
(&
i32
);

520 
	`memıy
(
p
,((
ušt8_t
*)&
i32
)+1,(i32)-(uint8_t));

521 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

522 
i32
 = 
v®ue
;

523 
	`memıy
(
p
,&
i32
,(i32));

524 
	`mem»v32ifbe
(
p
);

525 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

526 
i64
 = 
v®ue
;

527 
	`memıy
(
p
,&
i64
,(i64));

528 
	`mem»v64ifbe
(
p
);

529 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

532 
	`as£¹
(
NULL
);

534 
	}
}

537 
št64_t
 
	$zLßdIÁeg”
(*
p
, 
’codšg
) {

538 
št16_t
 
i16
;

539 
št32_t
 
i32
;

540 
št64_t
 
i64
, 
»t
 = 0;

541 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

542 
»t
 = ((
št8_t
*)
p
)[0];

543 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

544 
	`memıy
(&
i16
,
p
,(i16));

545 
	`mem»v16ifbe
(&
i16
);

546 
»t
 = 
i16
;

547 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

548 
	`memıy
(&
i32
,
p
,(i32));

549 
	`mem»v32ifbe
(&
i32
);

550 
»t
 = 
i32
;

551 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

552 
i32
 = 0;

553 
	`memıy
(((
ušt8_t
*)&
i32
)+1,
p
,(i32)-(uint8_t));

554 
	`mem»v32ifbe
(&
i32
);

555 
»t
 = 
i32
>>8;

556 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

557 
	`memıy
(&
i64
,
p
,(i64));

558 
	`mem»v64ifbe
(&
i64
);

559 
»t
 = 
i64
;

560 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

561 
»t
 = (
’codšg
 & 
ZIP_INT_IMM_MASK
)-1;

563 
	`as£¹
(
NULL
);

565  
»t
;

566 
	}
}

569 
	$zEÁry
(*
p
, 
zËÁry
 *
e
) {

571 
	`ZIP_DECODE_PREVLEN
(
p
, 
e
->
´ev¿wËnsize
,ƒ->
´ev¿wËn
);

572 
	`ZIP_DECODE_LENGTH
(
p
 + 
e
->
´ev¿wËnsize
,ƒ->
’codšg
,ƒ->
Ënsize
,ƒ->
Ën
);

573 
e
->
h—d”size
 =ƒ->
´ev¿wËnsize
 +ƒ->
Ënsize
;

574 
e
->
p
 =…;

575 
	}
}

578 *
	$zli¡New
() {

579 
by‹s
 = 
ZIPLIST_HEADER_SIZE
+1;

580 *
zl
 = 
	`zm®loc
(
by‹s
);

581 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
by‹s
);

582 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
ZIPLIST_HEADER_SIZE
);

583 
	`ZIPLIST_LENGTH
(
zl
) = 0;

584 
zl
[
by‹s
-1] = 
ZIP_END
;

585  
zl
;

586 
	}
}

589 *
	$zli¡Resize
(*
zl
, 
Ën
) {

590 
zl
 = 
	`z»®loc
(zl,
Ën
);

591 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
Ën
);

592 
zl
[
Ën
-1] = 
ZIP_END
;

593  
zl
;

594 
	}
}

616 *
	$__zli¡CasÿdeUpd©e
(*
zl
, *
p
) {

617 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
¿wËn
, 
¿wËnsize
;

618 
size_t
 
off£t
, 
noff£t
, 
exŒa
;

619 *
Å
;

620 
zËÁry
 
cur
, 
Ãxt
;

622 
p
[0] !ğ
ZIP_END
) {

623 
	`zEÁry
(
p
, &
cur
);

624 
¿wËn
 = 
cur
.
h—d”size
 + cur.
Ën
;

625 
¿wËnsize
 = 
	`zStÜeP»vEÁryL’gth
(
NULL
,
¿wËn
);

628 ià(
p
[
¿wËn
] =ğ
ZIP_END
) ;

629 
	`zEÁry
(
p
+
¿wËn
, &
Ãxt
);

632 ià(
Ãxt
.
´ev¿wËn
 =ğ
¿wËn
) ;

634 ià(
Ãxt
.
´ev¿wËnsize
 < 
¿wËnsize
) {

637 
off£t
 = 
p
-
zl
;

638 
exŒa
 = 
¿wËnsize
-
Ãxt
.
´ev¿wËnsize
;

639 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
exŒa
);

640 
p
 = 
zl
+
off£t
;

643 
Å
 = 
p
+
¿wËn
;

644 
noff£t
 = 
Å
-
zl
;

647 ià((
zl
+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl))è!ğ
Å
) {

648 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

649 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
exŒa
);

653 
	`memmove
(
Å
+
¿wËnsize
,

654 
Å
+
Ãxt
.
´ev¿wËnsize
,

655 
cu¾’
-
noff£t
-
Ãxt
.
´ev¿wËnsize
-1);

656 
	`zStÜeP»vEÁryL’gth
(
Å
,
¿wËn
);

659 
p
 +ğ
¿wËn
;

660 
cu¾’
 +ğ
exŒa
;

662 ià(
Ãxt
.
´ev¿wËnsize
 > 
¿wËnsize
) {

665 
	`zStÜeP»vEÁryL’gthL¬ge
(
p
+
¿wËn
,rawlen);

667 
	`zStÜeP»vEÁryL’gth
(
p
+
¿wËn
,rawlen);

674  
zl
;

675 
	}
}

678 *
	$__zli¡D–‘e
(*
zl
, *
p
, 
num
) {

679 
i
, 
tÙËn
, 
d–‘ed
 = 0;

680 
size_t
 
off£t
;

681 
Ãxtdiff
 = 0;

682 
zËÁry
 
fœ¡
, 

;

684 
	`zEÁry
(
p
, &
fœ¡
);

685 
i
 = 0; 
p
[0] !ğ
ZIP_END
 && i < 
num
; i++) {

686 
p
 +ğ
	`zRawEÁryL’gth
(p);

687 
d–‘ed
++;

690 
tÙËn
 = 
p
-
fœ¡
.p;

691 ià(
tÙËn
 > 0) {

692 ià(
p
[0] !ğ
ZIP_END
) {

697 
Ãxtdiff
 = 
	`zP»vL’By‹Diff
(
p
,
fœ¡
.
´ev¿wËn
);

703 
p
 -ğ
Ãxtdiff
;

704 
	`zStÜeP»vEÁryL’gth
(
p
,
fœ¡
.
´ev¿wËn
);

707 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

708 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))-
tÙËn
);

713 
	`zEÁry
(
p
, &

);

714 ià(
p
[

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

715 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

716 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

720 
	`memmove
(
fœ¡
.
p
,p,

721 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
))-(
p
-zl)-1);

724 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

725 
	`šŒev32ifbe
((
fœ¡
.
p
-
zl
)-fœ¡.
´ev¿wËn
);

729 
off£t
 = 
fœ¡
.
p
-
zl
;

730 
zl
 = 
	`zli¡Resize
(zl, 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-
tÙËn
+
Ãxtdiff
);

731 
	`ZIPLIST_INCR_LENGTH
(
zl
,-
d–‘ed
);

732 
p
 = 
zl
+
off£t
;

736 ià(
Ãxtdiff
 != 0)

737 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
);

739  
zl
;

740 
	}
}

743 *
	$__zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

744 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
»qËn
;

745 
´evËnsize
, 
´evËn
 = 0;

746 
size_t
 
off£t
;

747 
Ãxtdiff
 = 0;

748 
’codšg
 = 0;

749 
v®ue
 = 123456789;

752 
zËÁry
 

;

755 ià(
p
[0] !ğ
ZIP_END
) {

756 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

758 *
±a
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

759 ià(
±a
[0] !ğ
ZIP_END
) {

760 
´evËn
 = 
	`zRawEÁryL’gth
(
±a
);

765 ià(
	`zTryEncodšg
(
s
,
¦’
,&
v®ue
,&
’codšg
)) {

767 
»qËn
 = 
	`zIÁSize
(
’codšg
);

771 
»qËn
 = 
¦’
;

775 
»qËn
 +ğ
	`zStÜeP»vEÁryL’gth
(
NULL
,
´evËn
);

776 
»qËn
 +ğ
	`zStÜeEÁryEncodšg
(
NULL
,
’codšg
,
¦’
);

781 
fÜûÏrge
 = 0;

782 
Ãxtdiff
 = (
p
[0] !ğ
ZIP_END
è? 
	`zP»vL’By‹Diff
Õ,
»qËn
) : 0;

783 ià(
Ãxtdiff
 =ğ-4 && 
»qËn
 < 4) {

784 
Ãxtdiff
 = 0;

785 
fÜûÏrge
 = 1;

789 
off£t
 = 
p
-
zl
;

790 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
»qËn
+
Ãxtdiff
);

791 
p
 = 
zl
+
off£t
;

794 ià(
p
[0] !ğ
ZIP_END
) {

796 
	`memmove
(
p
+
»qËn
,p-
Ãxtdiff
,
cu¾’
-
off£t
-1+nextdiff);

799 ià(
fÜûÏrge
)

800 
	`zStÜeP»vEÁryL’gthL¬ge
(
p
+
»qËn
,reqlen);

802 
	`zStÜeP»vEÁryL’gth
(
p
+
»qËn
,reqlen);

805 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

806 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
»qËn
);

811 
	`zEÁry
(
p
+
»qËn
, &

);

812 ià(
p
[
»qËn
+

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

813 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

814 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

818 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
p
-zl);

823 ià(
Ãxtdiff
 != 0) {

824 
off£t
 = 
p
-
zl
;

825 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
+
»qËn
);

826 
p
 = 
zl
+
off£t
;

830 
p
 +ğ
	`zStÜeP»vEÁryL’gth
Õ,
´evËn
);

831 
p
 +ğ
	`zStÜeEÁryEncodšg
Õ,
’codšg
,
¦’
);

832 ià(
	`ZIP_IS_STR
(
’codšg
)) {

833 
	`memıy
(
p
,
s
,
¦’
);

835 
	`zSaveIÁeg”
(
p
,
v®ue
,
’codšg
);

837 
	`ZIPLIST_INCR_LENGTH
(
zl
,1);

838  
zl
;

839 
	}
}

856 *
	$zli¡M”ge
(**
fœ¡
, **
£cÚd
) {

858 ià(
fœ¡
 =ğ
NULL
 || *fœ¡ =ğNULL || 
£cÚd
 == NULL || *second == NULL)

859  
NULL
;

862 ià(*
fœ¡
 =ğ*
£cÚd
)

863  
NULL
;

865 
size_t
 
fœ¡_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
fœ¡
));

866 
size_t
 
fœ¡_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
fœ¡
));

868 
size_t
 
£cÚd_by‹s
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(*
£cÚd
));

869 
size_t
 
£cÚd_Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(*
£cÚd
));

871 
­³nd
;

872 *
sourû
, *
rg‘
;

873 
size_t
 
rg‘_by‹s
, 
sourû_by‹s
;

877 ià(
fœ¡_Ën
 >ğ
£cÚd_Ën
) {

879 
rg‘
 = *
fœ¡
;

880 
rg‘_by‹s
 = 
fœ¡_by‹s
;

881 
sourû
 = *
£cÚd
;

882 
sourû_by‹s
 = 
£cÚd_by‹s
;

883 
­³nd
 = 1;

886 
rg‘
 = *
£cÚd
;

887 
rg‘_by‹s
 = 
£cÚd_by‹s
;

888 
sourû
 = *
fœ¡
;

889 
sourû_by‹s
 = 
fœ¡_by‹s
;

890 
­³nd
 = 0;

894 
size_t
 
zlby‹s
 = 
fœ¡_by‹s
 + 
£cÚd_by‹s
 -

895 
ZIPLIST_HEADER_SIZE
 - 
ZIPLIST_END_SIZE
;

896 
size_t
 
zÎ’gth
 = 
fœ¡_Ën
 + 
£cÚd_Ën
;

899 
zÎ’gth
 = zÎ’gth < 
UINT16_MAX
 ? zllength : UINT16_MAX;

902 
size_t
 
fœ¡_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
fœ¡
));

903 
size_t
 
£cÚd_off£t
 = 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(*
£cÚd
));

906 
rg‘
 = 
	`z»®loc
Ñ¬g‘, 
zlby‹s
);

907 ià(
­³nd
) {

911 
	`memıy
(
rg‘
 + 
rg‘_by‹s
 - 
ZIPLIST_END_SIZE
,

912 
sourû
 + 
ZIPLIST_HEADER_SIZE
,

913 
sourû_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

919 
	`memmove
(
rg‘
 + 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
,

920 
rg‘
 + 
ZIPLIST_HEADER_SIZE
,

921 
rg‘_by‹s
 - 
ZIPLIST_HEADER_SIZE
);

922 
	`memıy
(
rg‘
, 
sourû
, 
sourû_by‹s
 - 
ZIPLIST_END_SIZE
);

926 
	`ZIPLIST_BYTES
(
rg‘
èğ
	`šŒev32ifbe
(
zlby‹s
);

927 
	`ZIPLIST_LENGTH
(
rg‘
èğ
	`šŒev16ifbe
(
zÎ’gth
);

933 
	`ZIPLIST_TAIL_OFFSET
(
rg‘
èğ
	`šŒev32ifbe
(

934 (
fœ¡_by‹s
 - 
ZIPLIST_END_SIZE
) +

935 (
£cÚd_off£t
 - 
ZIPLIST_HEADER_SIZE
));

941 
rg‘
 = 
	`__zli¡CasÿdeUpd©e
Ñ¬g‘,¬g‘+
fœ¡_off£t
);

944 ià(
­³nd
) {

945 
	`zä“
(*
£cÚd
);

946 *
£cÚd
 = 
NULL
;

947 *
fœ¡
 = 
rg‘
;

949 
	`zä“
(*
fœ¡
);

950 *
fœ¡
 = 
NULL
;

951 *
£cÚd
 = 
rg‘
;

953  
rg‘
;

954 
	}
}

956 *
	$zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
) {

957 *
p
;

958 
p
 = (
wh”e
 =ğ
ZIPLIST_HEAD
è? 
	`ZIPLIST_ENTRY_HEAD
(
zl
è: 
	`ZIPLIST_ENTRY_END
(zl);

959  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

960 
	}
}

965 *
	$zli¡Index
(*
zl
, 
šdex
) {

966 *
p
;

967 
´evËnsize
, 
´evËn
 = 0;

968 ià(
šdex
 < 0) {

969 
šdex
 = (-index)-1;

970 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

971 ià(
p
[0] !ğ
ZIP_END
) {

972 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

973 
´evËn
 > 0 && 
šdex
--) {

974 
p
 -ğ
´evËn
;

975 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

979 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

980 
p
[0] !ğ
ZIP_END
 && 
šdex
--) {

981 
p
 +ğ
	`zRawEÁryL’gth
(p);

984  (
p
[0] =ğ
ZIP_END
 || 
šdex
 > 0è? 
NULL
 :…;

985 
	}
}

993 *
	$zli¡Next
(*
zl
, *
p
) {

994 ((è
zl
);

999 ià(
p
[0] =ğ
ZIP_END
) {

1000  
NULL
;

1003 
p
 +ğ
	`zRawEÁryL’gth
(p);

1004 ià(
p
[0] =ğ
ZIP_END
) {

1005  
NULL
;

1008  
p
;

1009 
	}
}

1012 *
	$zli¡P»v
(*
zl
, *
p
) {

1013 
´evËnsize
, 
´evËn
 = 0;

1018 ià(
p
[0] =ğ
ZIP_END
) {

1019 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

1020  (
p
[0] =ğ
ZIP_END
è? 
NULL
 :…;

1021 } ià(
p
 =ğ
	`ZIPLIST_ENTRY_HEAD
(
zl
)) {

1022  
NULL
;

1024 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

1025 
	`as£¹
(
´evËn
 > 0);

1026  
p
-
´evËn
;

1028 
	}
}

1034 
	$zli¡G‘
(*
p
, **
s¡r
, *
¦’
, *
sv®
) {

1035 
zËÁry
 
’Œy
;

1036 ià(
p
 =ğ
NULL
 ||…[0] =ğ
ZIP_END
)  0;

1037 ià(
s¡r
è*s¡¸ğ
NULL
;

1039 
	`zEÁry
(
p
, &
’Œy
);

1040 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

1041 ià(
s¡r
) {

1042 *
¦’
 = 
’Œy
.
Ën
;

1043 *
s¡r
 = 
p
+
’Œy
.
h—d”size
;

1046 ià(
sv®
) {

1047 *
sv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

1051 
	}
}

1054 *
	$zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

1055  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

1056 
	}
}

1061 *
	$zli¡D–‘e
(*
zl
, **
p
) {

1062 
size_t
 
off£t
 = *
p
-
zl
;

1063 
zl
 = 
	`__zli¡D–‘e
(zl,*
p
,1);

1069 *
p
 = 
zl
+
off£t
;

1070  
zl
;

1071 
	}
}

1074 *
	$zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
) {

1075 *
p
 = 
	`zli¡Index
(
zl
,
šdex
);

1076  (
p
 =ğ
NULL
è? 
zl
 : 
	`__zli¡D–‘e
(zl,p,
num
);

1077 
	}
}

1081 
	$zli¡Com·»
(*
p
, *
s¡r
, 
¦’
) {

1082 
zËÁry
 
’Œy
;

1083 
£ncodšg
;

1084 
zv®
, 
sv®
;

1085 ià(
p
[0] =ğ
ZIP_END
)  0;

1087 
	`zEÁry
(
p
, &
’Œy
);

1088 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

1090 ià(
’Œy
.
Ën
 =ğ
¦’
) {

1091  
	`memcmp
(
p
+
’Œy
.
h—d”size
,
s¡r
,
¦’
) == 0;

1098 ià(
	`zTryEncodšg
(
s¡r
,
¦’
,&
sv®
,&
£ncodšg
)) {

1099 
zv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

1100  
zv®
 =ğ
sv®
;

1104 
	}
}

1108 *
	$zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
) {

1109 
skút
 = 0;

1110 
v’codšg
 = 0;

1111 
vÎ
 = 0;

1113 
p
[0] !ğ
ZIP_END
) {

1114 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

1115 *
q
;

1117 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

1118 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

1119 
q
 = 
p
 + 
´evËnsize
 + 
Ënsize
;

1121 ià(
skút
 == 0) {

1123 ià(
	`ZIP_IS_STR
(
’codšg
)) {

1124 ià(
Ën
 =ğ
vËn
 && 
	`memcmp
(
q
, 
v¡r
, vlen) == 0) {

1125  
p
;

1131 ià(
v’codšg
 == 0) {

1132 ià(!
	`zTryEncodšg
(
v¡r
, 
vËn
, &
vÎ
, &
v’codšg
)) {

1136 
v’codšg
 = 
UCHAR_MAX
;

1139 
	`as£¹
(
v’codšg
);

1145 ià(
v’codšg
 !ğ
UCHAR_MAX
) {

1146 
Î
 = 
	`zLßdIÁeg”
(
q
, 
’codšg
);

1147 ià(
Î
 =ğ
vÎ
) {

1148  
p
;

1154 
skút
 = 
sk
;

1157 
skút
--;

1161 
p
 = 
q
 + 
Ën
;

1164  
NULL
;

1165 
	}
}

1168 
	$zli¡L’
(*
zl
) {

1169 
Ën
 = 0;

1170 ià(
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)è< 
UINT16_MAX
) {

1171 
Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
));

1173 *
p
 = 
zl
+
ZIPLIST_HEADER_SIZE
;

1174 *
p
 !ğ
ZIP_END
) {

1175 
p
 +ğ
	`zRawEÁryL’gth
(p);

1176 
Ën
++;

1180 ià(
Ën
 < 
UINT16_MAX
è
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(len);

1182  
Ën
;

1183 
	}
}

1186 
size_t
 
	$zli¡BlobL’
(*
zl
) {

1187  
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
));

1188 
	}
}

1190 
	$zli¡R•r
(*
zl
) {

1191 *
p
;

1192 
šdex
 = 0;

1193 
zËÁry
 
’Œy
;

1195 
	`´štf
(

1199 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),

1200 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)),

1201 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(
zl
)));

1202 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

1203 *
p
 !ğ
ZIP_END
) {

1204 
	`zEÁry
(
p
, &
’Œy
);

1205 
	`´štf
(

1215 ()
p
,

1216 
šdex
,

1217 (è(
p
-
zl
),

1218 
’Œy
.
h—d”size
+’Œy.
Ën
,

1219 
’Œy
.
h—d”size
,

1220 
’Œy
.
´ev¿wËn
,

1221 
’Œy
.
´ev¿wËnsize
,

1222 
’Œy
.
Ën
);

1223 
	`´štf
("\tbytes: ");

1224 
i
 = 0; i < 
’Œy
.
h—d”size
+’Œy.
Ën
; i++) {

1225 
	`´štf
("%02x|",
p
[
i
]);

1227 
	`´štf
("\n");

1228 
p
 +ğ
’Œy
.
h—d”size
;

1229 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

1230 
	`´štf
("\t[str]");

1231 ià(
’Œy
.
Ën
 > 40) {

1232 ià(
	`fwr™e
(
p
,40,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1233 
	`´štf
("...");

1235 ià(
’Œy
.
Ën
 &&

1236 
	`fwr™e
(
p
,
’Œy
.
Ën
,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1239 
	`´štf
("\t[št]%Îd", (è
	`zLßdIÁeg”
(
p
,
’Œy
.
’codšg
));

1241 
	`´štf
("\n}\n");

1242 
p
 +ğ
’Œy
.
Ën
;

1243 
šdex
++;

1245 
	`´štf
("{end}\n\n");

1246 
	}
}

1248 #ifdeà
REDIS_TEST


1249 
	~<sys/time.h
>

1250 
	~"adli¡.h
"

1251 
	~"sds.h
"

1253 
	#debug
(
f
, ...è{ ià(
DEBUG
è
	`´štf
(f, 
__VA_ARGS__
); }

	)

1255 *
	$ü—‹Li¡
() {

1256 *
zl
 = 
	`zli¡New
();

1257 
zl
 = 
	`zli¡Push
(zl, (*)"foo", 3, 
ZIPLIST_TAIL
);

1258 
zl
 = 
	`zli¡Push
(zl, (*)"quux", 4, 
ZIPLIST_TAIL
);

1259 
zl
 = 
	`zli¡Push
(zl, (*)"h–lo", 5, 
ZIPLIST_HEAD
);

1260 
zl
 = 
	`zli¡Push
(zl, (*)"1024", 4, 
ZIPLIST_TAIL
);

1261  
zl
;

1262 
	}
}

1264 *
	$ü—‹IÁLi¡
() {

1265 *
zl
 = 
	`zli¡New
();

1266 
buf
[32];

1268 
	`¥rštf
(
buf
, "100");

1269 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1270 
	`¥rštf
(
buf
, "128000");

1271 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1272 
	`¥rštf
(
buf
, "-100");

1273 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1274 
	`¥rštf
(
buf
, "4294967296");

1275 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

1276 
	`¥rštf
(
buf
, "non integer");

1277 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1278 
	`¥rštf
(
buf
, "much much†onger‚on integer");

1279 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

1280  
zl
;

1281 
	}
}

1283 
	$u£c
() {

1284 
timev®
 
tv
;

1285 
	`g‘timeofday
(&
tv
,
NULL
);

1286  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

1287 
	}
}

1289 
	$¡»ss
(
pos
, 
num
, 
maxsize
, 
dnum
) {

1290 
i
,
j
,
k
;

1291 *
zl
;

1292 
pos¡r
[2][5] = { "HEAD", "TAIL" };

1293 
¡¬t
;

1294 
i
 = 0; i < 
maxsize
; i+=
dnum
) {

1295 
zl
 = 
	`zli¡New
();

1296 
j
 = 0; j < 
i
; j++) {

1297 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
ZIPLIST_TAIL
);

1301 
¡¬t
 = 
	`u£c
();

1302 
k
 = 0; k < 
num
; k++) {

1303 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
pos
);

1304 
zl
 = 
	`zli¡D–‘eRªge
(zl,0,1);

1306 
	`´štf
("List size: %8d, bytes: %8d, %dx…ush+pop (%s): %6lld usec\n",

1307 
i
,
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),
num
,
pos¡r
[
pos
],
	`u£c
()-
¡¬t
);

1308 
	`zä“
(
zl
);

1310 
	}
}

1312 *
	$pİ
(*
zl
, 
wh”e
) {

1313 *
p
, *
v¡r
;

1314 
vËn
;

1315 
vlÚg
;

1317 
p
 = 
	`zli¡Index
(
zl
,
wh”e
 =ğ
ZIPLIST_HEAD
 ? 0 : -1);

1318 ià(
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vlÚg
)) {

1319 ià(
wh”e
 =ğ
ZIPLIST_HEAD
)

1320 
	`´štf
("Pop head: ");

1322 
	`´štf
("Popail: ");

1324 ià(
v¡r
) {

1325 ià(
vËn
 && 
	`fwr™e
(
v¡r
,vËn,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1328 
	`´štf
("%Îd", 
vlÚg
);

1331 
	`´štf
("\n");

1332  
	`zli¡D–‘e
(
zl
,&
p
);

1334 
	`´štf
("ERROR: Could‚ot…op\n");

1335 
	`ex™
(1);

1337 
	}
}

1339 
	$¿nd¡ršg
(*
rg‘
, 
mš
, 
max
) {

1340 
p
 = 0;

1341 
Ën
 = 
mš
+
	`¿nd
()%(
max
-min+1);

1342 
mšv®
, 
maxv®
;

1343 
	`¿nd
() % 3) {

1345 
mšv®
 = 0;

1346 
maxv®
 = 255;

1349 
mšv®
 = 48;

1350 
maxv®
 = 122;

1353 
mšv®
 = 48;

1354 
maxv®
 = 52;

1357 
	`as£¹
(
NULL
);

1360 
p
 < 
Ën
)

1361 
rg‘
[
p
++] = 
mšv®
+
	`¿nd
()%(
maxv®
-minval+1);

1362  
Ën
;

1363 
	}
}

1365 
	$v”ify
(*
zl
, 
zËÁry
 *
e
) {

1366 
Ën
 = 
	`zli¡L’
(
zl
);

1367 
zËÁry
 
_e
;

1369 
	`ZIPLIST_ENTRY_ZERO
(&
_e
);

1371 
i
 = 0; i < 
Ën
; i++) {

1372 
	`mem£t
(&
e
[
i
], 0, (
zËÁry
));

1373 
	`zEÁry
(
	`zli¡Index
(
zl
, 
i
), &
e
[i]);

1375 
	`mem£t
(&
_e
, 0, (
zËÁry
));

1376 
	`zEÁry
(
	`zli¡Index
(
zl
, -
Ën
+
i
), &
_e
);

1378 
	`as£¹
(
	`memcmp
(&
e
[
i
], &
_e
, (
zËÁry
)) == 0);

1380 
	}
}

1382 
	$zli¡Te¡
(
¬gc
, **
¬gv
) {

1383 *
zl
, *
p
;

1384 *
’Œy
;

1385 
–’
;

1386 
v®ue
;

1389 ià(
¬gc
 == 2)

1390 
	`¤ªd
(
	`©oi
(
¬gv
[1]));

1392 
zl
 = 
	`ü—‹IÁLi¡
();

1393 
	`zli¡R•r
(
zl
);

1395 
	`zä“
(
zl
);

1397 
zl
 = 
	`ü—‹Li¡
();

1398 
	`zli¡R•r
(
zl
);

1400 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1401 
	`zli¡R•r
(
zl
);

1403 
zl
 = 
	`pİ
(zl,
ZIPLIST_HEAD
);

1404 
	`zli¡R•r
(
zl
);

1406 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1407 
	`zli¡R•r
(
zl
);

1409 
zl
 = 
	`pİ
(zl,
ZIPLIST_TAIL
);

1410 
	`zli¡R•r
(
zl
);

1412 
	`zä“
(
zl
);

1414 
	`´štf
("Getƒlement‡t index 3:\n");

1416 
zl
 = 
	`ü—‹Li¡
();

1417 
p
 = 
	`zli¡Index
(
zl
, 3);

1418 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1419 
	`´štf
("ERROR: Could‚ot‡ccess index 3\n");

1422 ià(
’Œy
) {

1423 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1424 
	`´štf
("\n");

1426 
	`´štf
("%Îd\n", 
v®ue
);

1428 
	`´štf
("\n");

1429 
	`zä“
(
zl
);

1432 
	`´štf
("Getƒlement‡t index 4 (out of„ange):\n");

1434 
zl
 = 
	`ü—‹Li¡
();

1435 
p
 = 
	`zli¡Index
(
zl
, 4);

1436 ià(
p
 =ğ
NULL
) {

1437 
	`´štf
("Noƒntry\n");

1439 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1442 
	`´štf
("\n");

1443 
	`zä“
(
zl
);

1446 
	`´štf
("Getƒlement‡t index -1 (lastƒlement):\n");

1448 
zl
 = 
	`ü—‹Li¡
();

1449 
p
 = 
	`zli¡Index
(
zl
, -1);

1450 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1451 
	`´štf
("ERROR: Could‚ot‡ccess index -1\n");

1454 ià(
’Œy
) {

1455 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1456 
	`´štf
("\n");

1458 
	`´štf
("%Îd\n", 
v®ue
);

1460 
	`´štf
("\n");

1461 
	`zä“
(
zl
);

1464 
	`´štf
("Getƒlement‡t index -4 (firstƒlement):\n");

1466 
zl
 = 
	`ü—‹Li¡
();

1467 
p
 = 
	`zli¡Index
(
zl
, -4);

1468 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1469 
	`´štf
("ERROR: Could‚ot‡ccess index -4\n");

1472 ià(
’Œy
) {

1473 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1474 
	`´štf
("\n");

1476 
	`´štf
("%Îd\n", 
v®ue
);

1478 
	`´štf
("\n");

1479 
	`zä“
(
zl
);

1482 
	`´štf
("Getƒlement‡t index -5 (reverse out of„ange):\n");

1484 
zl
 = 
	`ü—‹Li¡
();

1485 
p
 = 
	`zli¡Index
(
zl
, -5);

1486 ià(
p
 =ğ
NULL
) {

1487 
	`´štf
("Noƒntry\n");

1489 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1492 
	`´štf
("\n");

1493 
	`zä“
(
zl
);

1496 
	`´štf
("Iterate†ist from 0oƒnd:\n");

1498 
zl
 = 
	`ü—‹Li¡
();

1499 
p
 = 
	`zli¡Index
(
zl
, 0);

1500 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1501 
	`´štf
("Entry: ");

1502 ià(
’Œy
) {

1503 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1505 
	`´štf
("%Îd", 
v®ue
);

1507 
p
 = 
	`zli¡Next
(
zl
,p);

1508 
	`´štf
("\n");

1510 
	`´štf
("\n");

1511 
	`zä“
(
zl
);

1514 
	`´štf
("Iterate†ist from 1oƒnd:\n");

1516 
zl
 = 
	`ü—‹Li¡
();

1517 
p
 = 
	`zli¡Index
(
zl
, 1);

1518 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1519 
	`´štf
("Entry: ");

1520 ià(
’Œy
) {

1521 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1523 
	`´štf
("%Îd", 
v®ue
);

1525 
p
 = 
	`zli¡Next
(
zl
,p);

1526 
	`´štf
("\n");

1528 
	`´štf
("\n");

1529 
	`zä“
(
zl
);

1532 
	`´štf
("Iterate†ist from 2oƒnd:\n");

1534 
zl
 = 
	`ü—‹Li¡
();

1535 
p
 = 
	`zli¡Index
(
zl
, 2);

1536 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1537 
	`´štf
("Entry: ");

1538 ià(
’Œy
) {

1539 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1541 
	`´štf
("%Îd", 
v®ue
);

1543 
p
 = 
	`zli¡Next
(
zl
,p);

1544 
	`´štf
("\n");

1546 
	`´štf
("\n");

1547 
	`zä“
(
zl
);

1550 
	`´štf
("Iterate starting out of„ange:\n");

1552 
zl
 = 
	`ü—‹Li¡
();

1553 
p
 = 
	`zli¡Index
(
zl
, 4);

1554 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1555 
	`´štf
("Noƒntry\n");

1557 
	`´štf
("ERROR\n");

1559 
	`´štf
("\n");

1560 
	`zä“
(
zl
);

1563 
	`´štf
("Iterate from backo front:\n");

1565 
zl
 = 
	`ü—‹Li¡
();

1566 
p
 = 
	`zli¡Index
(
zl
, -1);

1567 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1568 
	`´štf
("Entry: ");

1569 ià(
’Œy
) {

1570 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1572 
	`´štf
("%Îd", 
v®ue
);

1574 
p
 = 
	`zli¡P»v
(
zl
,p);

1575 
	`´štf
("\n");

1577 
	`´štf
("\n");

1578 
	`zä“
(
zl
);

1581 
	`´štf
("Iterate from backo front, deleting‡ll items:\n");

1583 
zl
 = 
	`ü—‹Li¡
();

1584 
p
 = 
	`zli¡Index
(
zl
, -1);

1585 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1586 
	`´štf
("Entry: ");

1587 ià(
’Œy
) {

1588 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1590 
	`´štf
("%Îd", 
v®ue
);

1592 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1593 
p
 = 
	`zli¡P»v
(
zl
,p);

1594 
	`´štf
("\n");

1596 
	`´štf
("\n");

1597 
	`zä“
(
zl
);

1600 
	`´štf
("Delete inclusive„ange 0,0:\n");

1602 
zl
 = 
	`ü—‹Li¡
();

1603 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 1);

1604 
	`zli¡R•r
(
zl
);

1605 
	`zä“
(
zl
);

1608 
	`´štf
("Delete inclusive„ange 0,1:\n");

1610 
zl
 = 
	`ü—‹Li¡
();

1611 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 2);

1612 
	`zli¡R•r
(
zl
);

1613 
	`zä“
(
zl
);

1616 
	`´štf
("Delete inclusive„ange 1,2:\n");

1618 
zl
 = 
	`ü—‹Li¡
();

1619 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 2);

1620 
	`zli¡R•r
(
zl
);

1621 
	`zä“
(
zl
);

1624 
	`´štf
("Delete with start index out of„ange:\n");

1626 
zl
 = 
	`ü—‹Li¡
();

1627 
zl
 = 
	`zli¡D–‘eRªge
(zl, 5, 1);

1628 
	`zli¡R•r
(
zl
);

1629 
	`zä“
(
zl
);

1632 
	`´štf
("Delete with‚um overflow:\n");

1634 
zl
 = 
	`ü—‹Li¡
();

1635 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 5);

1636 
	`zli¡R•r
(
zl
);

1637 
	`zä“
(
zl
);

1640 
	`´štf
("Delete foo while iterating:\n");

1642 
zl
 = 
	`ü—‹Li¡
();

1643 
p
 = 
	`zli¡Index
(
zl
,0);

1644 
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
)) {

1645 ià(
’Œy
 && 
	`¡ºcmp
("foo",(*ëÁry,
–’
) == 0) {

1646 
	`´štf
("Delete foo\n");

1647 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1649 
	`´štf
("Entry: ");

1650 ià(
’Œy
) {

1651 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
) == 0)

1652 
	`³¼Ü
("fwrite");

1654 
	`´štf
("%Îd",
v®ue
);

1656 
p
 = 
	`zli¡Next
(
zl
,p);

1657 
	`´štf
("\n");

1660 
	`´štf
("\n");

1661 
	`zli¡R•r
(
zl
);

1662 
	`zä“
(
zl
);

1665 
	`´štf
("Regressionest for >255 byte strings:\n");

1667 
v1
[257] = {0}, 
v2
[257] = {0};

1668 
	`mem£t
(
v1
,'x',256);

1669 
	`mem£t
(
v2
,'y',256);

1670 
zl
 = 
	`zli¡New
();

1671 
zl
 = 
	`zli¡Push
(zl,(*)
v1
,
	`¡¾’
(v1),
ZIPLIST_TAIL
);

1672 
zl
 = 
	`zli¡Push
(zl,(*)
v2
,
	`¡¾’
(v2),
ZIPLIST_TAIL
);

1675 
p
 = 
	`zli¡Index
(
zl
,0);

1676 
	`as£¹
(
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
));

1677 
	`as£¹
(
	`¡ºcmp
(
v1
,(*)
’Œy
,
–’
) == 0);

1678 
p
 = 
	`zli¡Index
(
zl
,1);

1679 
	`as£¹
(
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
));

1680 
	`as£¹
(
	`¡ºcmp
(
v2
,(*)
’Œy
,
–’
) == 0);

1681 
	`´štf
("SUCCESS\n\n");

1682 
	`zä“
(
zl
);

1685 
	`´štf
("Regressionest deleting‚exto†astƒntries:\n");

1687 
v
[3][257] = {{0}};

1688 
zËÁry
 
e
[3] = {{.
´ev¿wËnsize
 = 0, .
´ev¿wËn
 = 0, .
Ënsize
 = 0,

1689 .
Ën
 = 0, .
h—d”size
 = 0, .
’codšg
 = 0, .
p
 = 
NULL
}};

1690 
size_t
 
i
;

1692 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1693 
	`mem£t
(
v
[
i
], 'a' + i, (v[0]));

1696 
v
[0][256] = '\0';

1697 
v
[1][ 1] = '\0';

1698 
v
[2][256] = '\0';

1700 
zl
 = 
	`zli¡New
();

1701 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1702 
zl
 = 
	`zli¡Push
(zl, (*è
v
[
i
], 
	`¡¾’
(v[i]), 
ZIPLIST_TAIL
);

1705 
	`v”ify
(
zl
, 
e
);

1707 
	`as£¹
(
e
[0].
´ev¿wËnsize
 == 1);

1708 
	`as£¹
(
e
[1].
´ev¿wËnsize
 == 5);

1709 
	`as£¹
(
e
[2].
´ev¿wËnsize
 == 1);

1712 *
p
 = 
e
[1].p;

1713 
zl
 = 
	`zli¡D–‘e
(zl, &
p
);

1715 
	`v”ify
(
zl
, 
e
);

1717 
	`as£¹
(
e
[0].
´ev¿wËnsize
 == 1);

1718 
	`as£¹
(
e
[1].
´ev¿wËnsize
 == 5);

1720 
	`´štf
("SUCCESS\n\n");

1721 
	`zä“
(
zl
);

1724 
	`´štf
("Create†ong†ist‡nd check indices:\n");

1726 
zl
 = 
	`zli¡New
();

1727 
buf
[32];

1728 
i
,
Ën
;

1729 
i
 = 0; i < 1000; i++) {

1730 
Ën
 = 
	`¥rštf
(
buf
,"%d",
i
);

1731 
zl
 = 
	`zli¡Push
(zl,(*)
buf
,
Ën
,
ZIPLIST_TAIL
);

1733 
i
 = 0; i < 1000; i++) {

1734 
p
 = 
	`zli¡Index
(
zl
,
i
);

1735 
	`as£¹
(
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
));

1736 
	`as£¹
(
i
 =ğ
v®ue
);

1738 
p
 = 
	`zli¡Index
(
zl
,-
i
-1);

1739 
	`as£¹
(
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
));

1740 
	`as£¹
(999-
i
 =ğ
v®ue
);

1742 
	`´štf
("SUCCESS\n\n");

1743 
	`zä“
(
zl
);

1746 
	`´štf
("Compare strings with ziplistƒntries:\n");

1748 
zl
 = 
	`ü—‹Li¡
();

1749 
p
 = 
	`zli¡Index
(
zl
,0);

1750 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1751 
	`´štf
("ERROR:‚ot \"hello\"\n");

1754 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1755 
	`´štf
("ERROR: \"hella\"\n");

1759 
p
 = 
	`zli¡Index
(
zl
,3);

1760 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1761 
	`´štf
("ERROR:‚ot \"1024\"\n");

1764 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1765 
	`´štf
("ERROR: \"1025\"\n");

1768 
	`´štf
("SUCCESS\n\n");

1769 
	`zä“
(
zl
);

1772 
	`´štf
("Mergeest:\n");

1775 
zl
 = 
	`ü—‹Li¡
();

1776 *
zl2
 = 
	`ü—‹Li¡
();

1778 *
zl3
 = 
	`zli¡New
();

1779 *
zl4
 = 
	`zli¡New
();

1781 ià(
	`zli¡M”ge
(&
zl4
, &zl4)) {

1782 
	`´štf
("ERROR: Allowed merging of one ziplist into itself.\n");

1787 
zl4
 = 
	`zli¡M”ge
(&
zl3
, &zl4);

1788 
	`zli¡R•r
(
zl4
);

1789 ià(
	`zli¡L’
(
zl4
)) {

1790 
	`´štf
("ERROR: Mergingwoƒmpty ziplists createdƒntries.\n");

1793 
	`zä“
(
zl4
);

1795 
zl2
 = 
	`zli¡M”ge
(&
zl
, &zl2);

1797 
	`zli¡R•r
(
zl2
);

1799 ià(
	`zli¡L’
(
zl2
) != 8) {

1800 
	`´štf
("ERROR: M”ged†’gth‚Ù 8, but: %u\n", 
	`zli¡L’
(
zl2
));

1804 
p
 = 
	`zli¡Index
(
zl2
,0);

1805 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1806 
	`´štf
("ERROR:‚ot \"hello\"\n");

1809 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1810 
	`´štf
("ERROR: \"hella\"\n");

1814 
p
 = 
	`zli¡Index
(
zl2
,3);

1815 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1816 
	`´štf
("ERROR:‚ot \"1024\"\n");

1819 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1820 
	`´štf
("ERROR: \"1025\"\n");

1824 
p
 = 
	`zli¡Index
(
zl2
,4);

1825 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1826 
	`´štf
("ERROR:‚ot \"hello\"\n");

1829 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1830 
	`´štf
("ERROR: \"hella\"\n");

1834 
p
 = 
	`zli¡Index
(
zl2
,7);

1835 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1836 
	`´štf
("ERROR:‚ot \"1024\"\n");

1839 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1840 
	`´štf
("ERROR: \"1025\"\n");

1843 
	`´štf
("SUCCESS\n\n");

1844 
	`zä“
(
zl
);

1847 
	`´štf
("Stress with„andom…ayloads of differentƒncoding:\n");

1849 
i
,
j
,
Ën
,
wh”e
;

1850 *
p
;

1851 
buf
[1024];

1852 
buæ’
;

1853 
li¡
 *
»f
;

1854 
li¡Node
 *
»âode
;

1857 *
s¡r
;

1858 
¦’
;

1859 
sv®
;

1861 
i
 = 0; i < 20000; i++) {

1862 
zl
 = 
	`zli¡New
();

1863 
»f
 = 
	`li¡C»©e
();

1864 
	`li¡S‘F»eM‘hod
(
»f
,((*)(*))
sdsä“
);

1865 
Ën
 = 
	`¿nd
() % 256;

1868 
j
 = 0; j < 
Ën
; j++) {

1869 
wh”e
 = (
	`¿nd
(è& 1è? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
;

1870 ià(
	`¿nd
() % 2) {

1871 
buæ’
 = 
	`¿nd¡ršg
(
buf
,1,(buf)-1);

1873 
	`¿nd
() % 3) {

1875 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) >> 20);

1878 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()));

1881 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) << 20);

1884 
	`as£¹
(
NULL
);

1889 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
buæ’
, 
wh”e
);

1892 ià(
wh”e
 =ğ
ZIPLIST_HEAD
) {

1893 
	`li¡AddNodeH—d
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1894 } ià(
wh”e
 =ğ
ZIPLIST_TAIL
) {

1895 
	`li¡AddNodeTa
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1897 
	`as£¹
(
NULL
);

1901 
	`as£¹
(
	`li¡L’gth
(
»f
è=ğ
	`zli¡L’
(
zl
));

1902 
j
 = 0; j < 
Ën
; j++) {

1905 
p
 = 
	`zli¡Index
(
zl
,
j
);

1906 
»âode
 = 
	`li¡Index
(
»f
,
j
);

1908 
	`as£¹
(
	`zli¡G‘
(
p
,&
s¡r
,&
¦’
,&
sv®
));

1909 ià(
s¡r
 =ğ
NULL
) {

1910 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",
sv®
);

1912 
buæ’
 = 
¦’
;

1913 
	`memıy
(
buf
,
s¡r
,
buæ’
);

1914 
buf
[
buæ’
] = '\0';

1916 
	`as£¹
(
	`memcmp
(
buf
,
	`li¡NodeV®ue
(
»âode
),
buæ’
) == 0);

1918 
	`zä“
(
zl
);

1919 
	`li¡R–—£
(
»f
);

1921 
	`´štf
("SUCCESS\n\n");

1924 
	`´štf
("Stress with variable ziplist size:\n");

1926 
	`¡»ss
(
ZIPLIST_HEAD
,100000,16384,256);

1927 
	`¡»ss
(
ZIPLIST_TAIL
,100000,16384,256);

1931 
	}
}

	@src/ziplist.h

31 #iâdeà
_ZIPLIST_H


32 
	#_ZIPLIST_H


	)

34 
	#ZIPLIST_HEAD
 0

	)

35 
	#ZIPLIST_TAIL
 1

	)

37 *
zli¡New
();

38 *
zli¡M”ge
(**
fœ¡
, **
£cÚd
);

39 *
zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
);

40 *
zli¡Index
(*
zl
, 
šdex
);

41 *
zli¡Next
(*
zl
, *
p
);

42 *
zli¡P»v
(*
zl
, *
p
);

43 
zli¡G‘
(*
p
, **
sv®
, *
¦’
, *
lv®
);

44 *
zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
);

45 *
zli¡D–‘e
(*
zl
, **
p
);

46 *
zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
);

47 
zli¡Com·»
(*
p
, *
s
, 
¦’
);

48 *
zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
);

49 
zli¡L’
(*
zl
);

50 
size_t
 
zli¡BlobL’
(*
zl
);

51 
zli¡R•r
(*
zl
);

53 #ifdeà
REDIS_TEST


54 
zli¡Te¡
(
¬gc
, *
¬gv
[]);

	@src/zipmap.c

78 
	~<¡dio.h
>

79 
	~<¡ršg.h
>

80 
	~"zm®loc.h
"

81 
	~"’dŸncÚv.h
"

83 
	#ZIPMAP_BIGLEN
 254

	)

84 
	#ZIPMAP_END
 255

	)

88 
	#ZIPMAP_VALUE_MAX_FREE
 4

	)

93 
	#ZIPMAP_LEN_BYTES
(
_l
è(((_lè< 
ZIPMAP_BIGLEN
è? 1 : ()+1)

	)

96 *
	$zm­New
() {

97 *
zm
 = 
	`zm®loc
(2);

99 
zm
[0] = 0;

100 
zm
[1] = 
ZIPMAP_END
;

101  
zm
;

102 
	}
}

105 
	$zm­DecodeL’gth
(*
p
) {

106 
Ën
 = *
p
;

108 ià(
Ën
 < 
ZIPMAP_BIGLEN
) †en;

109 
	`memıy
(&
Ën
,
p
+1,());

110 
	`mem»v32ifbe
(&
Ën
);

111  
Ën
;

112 
	}
}

116 
	$zm­EncodeL’gth
(*
p
, 
Ën
) {

117 ià(
p
 =ğ
NULL
) {

118  
	`ZIPMAP_LEN_BYTES
(
Ën
);

120 ià(
Ën
 < 
ZIPMAP_BIGLEN
) {

121 
p
[0] = 
Ën
;

124 
p
[0] = 
ZIPMAP_BIGLEN
;

125 
	`memıy
(
p
+1,&
Ën
,(len));

126 
	`mem»v32ifbe
(
p
+1);

127  1+(
Ën
);

130 
	}
}

138 *
	$zm­LookupRaw
(*
zm
, *
key
, 
kËn
, *
tÙËn
) {

139 *
p
 = 
zm
+1, *
k
 = 
NULL
;

140 
l
,
Î’
;

142 *
p
 !ğ
ZIPMAP_END
) {

143 
ä“
;

146 
l
 = 
	`zm­DecodeL’gth
(
p
);

147 
Î’
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

148 ià(
key
 !ğ
NULL
 && 
k
 =ğNULL && 
l
 =ğ
kËn
 && !
	`memcmp
(
p
+
Î’
,key,l)) {

151 ià(
tÙËn
 !ğ
NULL
) {

152 
k
 = 
p
;

154  
p
;

157 
p
 +ğ
Î’
+
l
;

159 
l
 = 
	`zm­DecodeL’gth
(
p
);

160 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

161 
ä“
 = 
p
[0];

162 
p
 +ğ
l
+1+
ä“
;

164 ià(
tÙËn
 !ğ
NULL
è*tÙËÀğ()(
p
-
zm
)+1;

165  
k
;

166 
	}
}

168 
	$zm­RequœedL’gth
(
kËn
, 
vËn
) {

169 
l
;

171 
l
 = 
kËn
+
vËn
+3;

172 ià(
kËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

173 ià(
vËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

174  
l
;

175 
	}
}

178 
	$zm­RawKeyL’gth
(*
p
) {

179 
l
 = 
	`zm­DecodeL’gth
(
p
);

180  
	`zm­EncodeL’gth
(
NULL
,
l
) +†;

181 
	}
}

185 
	$zm­RawV®ueL’gth
(*
p
) {

186 
l
 = 
	`zm­DecodeL’gth
(
p
);

187 
u£d
;

189 
u£d
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

190 
u£d
 +ğ
p
[u£d] + 1 + 
l
;

191  
u£d
;

192 
	}
}

197 
	$zm­RawEÁryL’gth
(*
p
) {

198 
l
 = 
	`zm­RawKeyL’gth
(
p
);

199  
l
 + 
	`zm­RawV®ueL’gth
(
p
+l);

200 
	}
}

202 
šlše
 *
	$zm­Resize
(*
zm
, 
Ën
) {

203 
zm
 = 
	`z»®loc
(zm, 
Ën
);

204 
zm
[
Ën
-1] = 
ZIPMAP_END
;

205  
zm
;

206 
	}
}

211 *
	$zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
) {

212 
zmËn
, 
off£t
;

213 
ä“Ën
, 
»qËn
 = 
	`zm­RequœedL’gth
(
kËn
,
vËn
);

214 
em±y
, 
vem±y
;

215 *
p
;

217 
ä“Ën
 = 
»qËn
;

218 ià(
upd©e
) *update = 0;

219 
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

220 ià(
p
 =ğ
NULL
) {

222 
zm
 = 
	`zm­Resize
(zm, 
zmËn
+
»qËn
);

223 
p
 = 
zm
+
zmËn
-1;

224 
zmËn
 = zmËn+
»qËn
;

227 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]++;

231 ià(
upd©e
) *update = 1;

232 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

233 ià(
ä“Ën
 < 
»qËn
) {

237 
off£t
 = 
p
-
zm
;

238 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
+
»qËn
);

239 
p
 = 
zm
+
off£t
;

243 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

244 
zmËn
 = zmËn-
ä“Ën
+
»qËn
;

245 
ä“Ën
 = 
»qËn
;

253 
em±y
 = 
ä“Ën
-
»qËn
;

254 ià(
em±y
 >ğ
ZIPMAP_VALUE_MAX_FREE
) {

257 
off£t
 = 
p
-
zm
;

258 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

259 
zmËn
 -ğ
em±y
;

260 
zm
 = 
	`zm­Resize
(zm, 
zmËn
);

261 
p
 = 
zm
+
off£t
;

262 
vem±y
 = 0;

264 
vem±y
 = 
em±y
;

269 
p
 +ğ
	`zm­EncodeL’gth
Õ,
kËn
);

270 
	`memıy
(
p
,
key
,
kËn
);

271 
p
 +ğ
kËn
;

273 
p
 +ğ
	`zm­EncodeL’gth
Õ,
vËn
);

274 *
p
++ = 
vem±y
;

275 
	`memıy
(
p
,
v®
,
vËn
);

276  
zm
;

277 
	}
}

281 *
	$zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
) {

282 
zmËn
, 
ä“Ën
;

283 *
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

284 ià(
p
) {

285 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

286 
	`memmove
(
p
,…+
ä“Ën
, 
zmËn
-(Õ-
zm
)+freelen+1));

287 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
);

290 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]--;

292 ià(
d–‘ed
) *deleted = 1;

294 ià(
d–‘ed
) *deleted = 0;

296  
zm
;

297 
	}
}

300 *
	$zm­Rewšd
(*
zm
) {

301  
zm
+1;

302 
	}
}

315 *
	$zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
) {

316 ià(
zm
[0] =ğ
ZIPMAP_END
è 
NULL
;

317 ià(
key
) {

318 *
key
 = 
zm
;

319 *
kËn
 = 
	`zm­DecodeL’gth
(
zm
);

320 *
key
 +ğ
	`ZIPMAP_LEN_BYTES
(*
kËn
);

322 
zm
 +ğ
	`zm­RawKeyL’gth
(zm);

323 ià(
v®ue
) {

324 *
v®ue
 = 
zm
+1;

325 *
vËn
 = 
	`zm­DecodeL’gth
(
zm
);

326 *
v®ue
 +ğ
	`ZIPMAP_LEN_BYTES
(*
vËn
);

328 
zm
 +ğ
	`zm­RawV®ueL’gth
(zm);

329  
zm
;

330 
	}
}

334 
	$zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
) {

335 *
p
;

337 ià((
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
)) == NULL)  0;

338 
p
 +ğ
	`zm­RawKeyL’gth
(p);

339 *
vËn
 = 
	`zm­DecodeL’gth
(
p
);

340 *
v®ue
 = 
p
 + 
	`ZIPMAP_LEN_BYTES
(*
vËn
) + 1;

342 
	}
}

345 
	$zm­Exi¡s
(*
zm
, *
key
, 
kËn
) {

346  
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
) != NULL;

347 
	}
}

350 
	$zm­L’
(*
zm
) {

351 
Ën
 = 0;

352 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) {

353 
Ën
 = 
zm
[0];

355 *
p
 = 
	`zm­Rewšd
(
zm
);

356 (
p
 = 
	`zm­Next
Õ,
NULL
,NULL,NULL,NULL)è!ğNULLè
Ën
++;

359 ià(
Ën
 < 
ZIPMAP_BIGLEN
è
zm
[0] =†en;

361  
Ën
;

362 
	}
}

367 
size_t
 
	$zm­BlobL’
(*
zm
) {

368 
tÙËn
;

369 
	`zm­LookupRaw
(
zm
,
NULL
,0,&
tÙËn
);

370  
tÙËn
;

371 
	}
}

373 #ifdeà
REDIS_TEST


374 
	$zm­R•r
(*
p
) {

375 
l
;

377 
	`´štf
("{¡©u %u}",*
p
++);

379 ià(
p
[0] =ğ
ZIPMAP_END
) {

380 
	`´štf
("{end}");

383 
e
;

385 
l
 = 
	`zm­DecodeL’gth
(
p
);

386 
	`´štf
("{key %u}",
l
);

387 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

388 ià(
l
 !ğ0 && 
	`fwr™e
(
p
,l,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

389 
p
 +ğ
l
;

391 
l
 = 
	`zm­DecodeL’gth
(
p
);

392 
	`´štf
("{v®u%u}",
l
);

393 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

394 
e
 = *
p
++;

395 ià(
l
 !ğ0 && 
	`fwr™e
(
p
,l,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

396 
p
 +ğ
l
+
e
;

397 ià(
e
) {

398 
	`´štf
("[");

399 
e
--è
	`´štf
(".");

400 
	`´štf
("]");

404 
	`´štf
("\n");

405 
	}
}

407 
	#UNUSED
(
x
è()(x)

	)

408 
	$zm­Te¡
(
¬gc
, *
¬gv
[]) {

409 *
zm
;

411 
	`UNUSED
(
¬gc
);

412 
	`UNUSED
(
¬gv
);

414 
zm
 = 
	`zm­New
();

416 
zm
 = 
	`zm­S‘
(zm,(*è"Çme",4, (*è"foo",3,
NULL
);

417 
zm
 = 
	`zm­S‘
(zm,(*è"suºame",7, (*è"foo",3,
NULL
);

418 
zm
 = 
	`zm­S‘
(zm,(*è"age",3, (*è"foo",3,
NULL
);

419 
	`zm­R•r
(
zm
);

421 
zm
 = 
	`zm­S‘
(zm,(*è"h–lo",5, (*è"wÜld!",6,
NULL
);

422 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"b¬",3,
NULL
);

423 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"!",1,
NULL
);

424 
	`zm­R•r
(
zm
);

425 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"12345",5,
NULL
);

426 
	`zm­R•r
(
zm
);

427 
zm
 = 
	`zm­S‘
(zm,(*è"Ãw",3, (*è"xx",2,
NULL
);

428 
zm
 = 
	`zm­S‘
(zm,(*è"nov®",5, (*è"",0,
NULL
);

429 
	`zm­R•r
(
zm
);

430 
zm
 = 
	`zm­D–
(zm,(*è"Ãw",3,
NULL
);

431 
	`zm­R•r
(
zm
);

433 
	`´štf
("\nLook up†arge key:\n");

435 
buf
[512];

436 *
v®ue
;

437 
vËn
, 
i
;

438 
i
 = 0; i < 512; i++è
buf
[i] = 'a';

440 
zm
 = 
	`zm­S‘
(zm,
buf
,512,(*è"lÚg",4,
NULL
);

441 ià(
	`zm­G‘
(
zm
,
buf
,512,&
v®ue
,&
vËn
)) {

442 
	`´štf
(" <long key> is‡ssociatedohe %d bytes value: %.*s\n",

443 
vËn
, vËn, 
v®ue
);

447 
	`´štf
("\nPerform‡ direct†ookup:\n");

449 *
v®ue
;

450 
vËn
;

452 ià(
	`zm­G‘
(
zm
,(*è"foo",3,&
v®ue
,&
vËn
)) {

453 
	`´štf
(" foo is‡ssociatedohe %d bytes value: %.*s\n",

454 
vËn
, vËn, 
v®ue
);

457 
	`´štf
("\nIteratehroughƒlements:\n");

459 *
i
 = 
	`zm­Rewšd
(
zm
);

460 *
key
, *
v®ue
;

461 
kËn
, 
vËn
;

463 (
i
 = 
	`zm­Next
(i,&
key
,&
kËn
,&
v®ue
,&
vËn
)è!ğ
NULL
) {

464 
	`´štf
(" %d:%.* => %d:%.*s\n", 
kËn
, kËn, 
key
, 
vËn
, vËn, 
v®ue
);

468 
	}
}

	@src/zipmap.h

35 #iâdeà
_ZIPMAP_H


36 
	#_ZIPMAP_H


	)

38 *
zm­New
();

39 *
zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
);

40 *
zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
);

41 *
zm­Rewšd
(*
zm
);

42 *
zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
);

43 
zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
);

44 
zm­Exi¡s
(*
zm
, *
key
, 
kËn
);

45 
zm­L’
(*
zm
);

46 
size_t
 
zm­BlobL’
(*
zm
);

47 
zm­R•r
(*
p
);

49 #ifdeà
REDIS_TEST


50 
zm­Te¡
(
¬gc
, *
¬gv
[]);

	@src/zmalloc.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

38 
	$zlibc_ä“
(*
±r
) {

39 
	`ä“
(
±r
);

40 
	}
}

42 
	~<¡ršg.h
>

43 
	~<±h»ad.h
>

44 
	~"cÚfig.h
"

45 
	~"zm®loc.h
"

46 
	~"©omicv¬.h
"

48 #ifdeà
HAVE_MALLOC_SIZE


49 
	#PREFIX_SIZE
 (0)

	)

51 #ià
defšed
(
__sun
è|| defšed(
__¥¬c
è|| defšed(
__¥¬c__
)

52 
	#PREFIX_SIZE
 (())

	)

54 
	#PREFIX_SIZE
 ((
size_t
))

	)

59 #ià
defšed
(
USE_TCMALLOC
)

60 
	#m®loc
(
size
è
	`tc_m®loc
(size)

	)

61 
	#ÿÎoc
(
couÁ
,
size
è
	`tc_ÿÎoc
(couÁ,size)

	)

62 
	#»®loc
(
±r
,
size
è
	`tc_»®loc
ÕŒ,size)

	)

63 
	#ä“
(
±r
è
	`tc_ä“
ÕŒ)

	)

64 #–ià
defšed
(
USE_JEMALLOC
)

65 
	#m®loc
(
size
è
	`je_m®loc
(size)

	)

66 
	#ÿÎoc
(
couÁ
,
size
è
	`je_ÿÎoc
(couÁ,size)

	)

67 
	#»®loc
(
±r
,
size
è
	`je_»®loc
ÕŒ,size)

	)

68 
	#ä“
(
±r
è
	`je_ä“
ÕŒ)

	)

69 
	#m®locx
(
size
,
æags
è
	`je_m®locx
(size,æags)

	)

70 
	#d®locx
(
±r
,
æags
è
	`je_d®locx
ÕŒ,æags)

	)

73 
	#upd©e_zm®loc_¡©_®loc
(
__n
) do { \

74 
size_t
 
_n
 = (
__n
); \

75 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

76 
	`©omicInü
(
u£d_memÜy
,
__n
); \

77 } 0)

	)

79 
	#upd©e_zm®loc_¡©_ä“
(
__n
) do { \

80 
size_t
 
_n
 = (
__n
); \

81 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

82 
	`©omicDeü
(
u£d_memÜy
,
__n
); \

83 } 0)

	)

85 
size_t
 
	gu£d_memÜy
 = 0;

86 
±h»ad_mu‹x_t
 
	gu£d_memÜy_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

88 
	$zm®loc_deçuÉ_oom
(
size_t
 
size
) {

89 
	`årštf
(
¡d”r
, "zmalloc: Out of memoryryingo‡llocate %zu bytes\n",

90 
size
);

91 
	`fæush
(
¡d”r
);

92 
	`abÜt
();

93 
	}
}

95 (*
zm®loc_oom_hªdËr
)(
size_t
èğ
zm®loc_deçuÉ_oom
;

97 *
	$zm®loc
(
size_t
 
size
) {

98 *
±r
 = 
	`m®loc
(
size
+
PREFIX_SIZE
);

100 ià(!
±r
è
	`zm®loc_oom_hªdËr
(
size
);

101 #ifdeà
HAVE_MALLOC_SIZE


102 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
±r
));

103  
±r
;

105 *((
size_t
*)
±r
èğ
size
;

106 
	`upd©e_zm®loc_¡©_®loc
(
size
+
PREFIX_SIZE
);

107  (*)
±r
+
PREFIX_SIZE
;

109 
	}
}

114 #ifdeà
HAVE_DEFRAG


115 *
	$zm®loc_no_tÿche
(
size_t
 
size
) {

116 *
±r
 = 
	`m®locx
(
size
+
PREFIX_SIZE
, 
MALLOCX_TCACHE_NONE
);

117 ià(!
±r
è
	`zm®loc_oom_hªdËr
(
size
);

118 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
±r
));

119  
±r
;

120 
	}
}

122 
	$zä“_no_tÿche
(*
±r
) {

123 ià(
±r
 =ğ
NULL
) ;

124 
	`upd©e_zm®loc_¡©_ä“
(
	`zm®loc_size
(
±r
));

125 
	`d®locx
(
±r
, 
MALLOCX_TCACHE_NONE
);

126 
	}
}

129 *
	$zÿÎoc
(
size_t
 
size
) {

130 *
±r
 = 
	`ÿÎoc
(1, 
size
+
PREFIX_SIZE
);

132 ià(!
±r
è
	`zm®loc_oom_hªdËr
(
size
);

133 #ifdeà
HAVE_MALLOC_SIZE


134 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
±r
));

135  
±r
;

137 *((
size_t
*)
±r
èğ
size
;

138 
	`upd©e_zm®loc_¡©_®loc
(
size
+
PREFIX_SIZE
);

139  (*)
±r
+
PREFIX_SIZE
;

141 
	}
}

143 *
	$z»®loc
(*
±r
, 
size_t
 
size
) {

144 #iâdeà
HAVE_MALLOC_SIZE


145 *
»®±r
;

147 
size_t
 
Şdsize
;

148 *
Ãw±r
;

150 ià(
±r
 =ğ
NULL
è 
	`zm®loc
(
size
);

151 #ifdeà
HAVE_MALLOC_SIZE


152 
Şdsize
 = 
	`zm®loc_size
(
±r
);

153 
Ãw±r
 = 
	`»®loc
(
±r
,
size
);

154 ià(!
Ãw±r
è
	`zm®loc_oom_hªdËr
(
size
);

156 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
);

157 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
Ãw±r
));

158  
Ãw±r
;

160 
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

161 
Şdsize
 = *((
size_t
*)
»®±r
);

162 
Ãw±r
 = 
	`»®loc
(
»®±r
,
size
+
PREFIX_SIZE
);

163 ià(!
Ãw±r
è
	`zm®loc_oom_hªdËr
(
size
);

165 *((
size_t
*)
Ãw±r
èğ
size
;

166 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
);

167 
	`upd©e_zm®loc_¡©_®loc
(
size
);

168  (*)
Ãw±r
+
PREFIX_SIZE
;

170 
	}
}

175 #iâdeà
HAVE_MALLOC_SIZE


176 
size_t
 
	$zm®loc_size
(*
±r
) {

177 *
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

178 
size_t
 
size
 = *((size_t*)
»®±r
);

181 ià(
size
&(()-1)) size += ()-(size&(()-1));

182  
size
+
PREFIX_SIZE
;

183 
	}
}

186 
	$zä“
(*
±r
) {

187 #iâdeà
HAVE_MALLOC_SIZE


188 *
»®±r
;

189 
size_t
 
Şdsize
;

192 ià(
±r
 =ğ
NULL
) ;

193 #ifdeà
HAVE_MALLOC_SIZE


194 
	`upd©e_zm®loc_¡©_ä“
(
	`zm®loc_size
(
±r
));

195 
	`ä“
(
±r
);

197 
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

198 
Şdsize
 = *((
size_t
*)
»®±r
);

199 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
+
PREFIX_SIZE
);

200 
	`ä“
(
»®±r
);

202 
	}
}

204 *
	$z¡rdup
(cÚ¡ *
s
) {

205 
size_t
 
l
 = 
	`¡¾’
(
s
)+1;

206 *
p
 = 
	`zm®loc
(
l
);

208 
	`memıy
(
p
,
s
,
l
);

209  
p
;

210 
	}
}

212 
size_t
 
	$zm®loc_u£d_memÜy
() {

213 
size_t
 
um
;

214 
	`©omicG‘
(
u£d_memÜy
,
um
);

215  
um
;

216 
	}
}

218 
	$zm®loc_£t_oom_hªdËr
((*
oom_hªdËr
)(
size_t
)) {

219 
zm®loc_oom_hªdËr
 = 
oom_hªdËr
;

220 
	}
}

232 #ià
defšed
(
HAVE_PROC_STAT
)

233 
	~<uni¡d.h
>

234 
	~<sys/ty³s.h
>

235 
	~<sys/¡©.h
>

236 
	~<fú.h
>

238 
size_t
 
	$zm®loc_g‘_rss
() {

239 
·ge
 = 
	`syscÚf
(
_SC_PAGESIZE
);

240 
size_t
 
rss
;

241 
buf
[4096];

242 
f’ame
[256];

243 
fd
, 
couÁ
;

244 *
p
, *
x
;

246 
	`¢´štf
(
f’ame
,256,"/´oc/%d/¡©",
	`g‘pid
());

247 ià((
fd
 = 
	`İ’
(
f’ame
,
O_RDONLY
)) == -1)  0;

248 ià(
	`»ad
(
fd
,
buf
,4096) <= 0) {

249 
	`şo£
(
fd
);

252 
	`şo£
(
fd
);

254 
p
 = 
buf
;

255 
couÁ
 = 23;

256 
p
 && 
couÁ
--) {

257 
p
 = 
	`¡rchr
(p,' ');

258 ià(
p
)…++;

260 ià(!
p
)  0;

261 
x
 = 
	`¡rchr
(
p
,' ');

262 ià(!
x
)  0;

263 *
x
 = '\0';

265 
rss
 = 
	`¡¹Şl
(
p
,
NULL
,10);

266 
rss
 *ğ
·ge
;

267  
rss
;

268 
	}
}

269 #–ià
defšed
(
HAVE_TASKINFO
)

270 
	~<uni¡d.h
>

271 
	~<¡dio.h
>

272 
	~<¡dlib.h
>

273 
	~<sys/ty³s.h
>

274 
	~<sys/sysùl.h
>

275 
	~<mach/sk.h
>

276 
	~<mach/mach_š™.h
>

278 
size_t
 
	$zm®loc_g‘_rss
() {

279 
sk_t
 
sk
 = 
MACH_PORT_NULL
;

280 
sk_basic_šfo
 
t_šfo
;

281 
mach_msg_ty³_numb”_t
 
t_šfo_couÁ
 = 
TASK_BASIC_INFO_COUNT
;

283 ià(
	`sk_fÜ_pid
(
	`cu¼’t_sk
(), 
	`g‘pid
(), &
sk
è!ğ
KERN_SUCCESS
)

285 
	`sk_šfo
(
sk
, 
TASK_BASIC_INFO
, (
sk_šfo_t
)&
t_šfo
, &
t_šfo_couÁ
);

287  
t_šfo
.
»sid’t_size
;

288 
	}
}

290 
size_t
 
	$zm®loc_g‘_rss
() {

296  
	`zm®loc_u£d_memÜy
();

297 
	}
}

301 
	$zm®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
) {

302  ()
rss
/
	`zm®loc_u£d_memÜy
();

303 
	}
}

315 #ià
defšed
(
HAVE_PROC_SMAPS
)

316 
size_t
 
	$zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
, 
pid
) {

317 
lše
[1024];

318 
size_t
 
by‹s
 = 0;

319 
æ’
 = 
	`¡¾’
(
f›ld
);

320 
FILE
 *
å
;

322 ià(
pid
 == -1) {

323 
å
 = 
	`fİ’
("/proc/self/smaps","r");

325 
f’ame
[128];

326 
	`¢´štf
(
f’ame
,(f’ame),"/´oc/%ld/sm­s",
pid
);

327 
å
 = 
	`fİ’
(
f’ame
,"r");

330 ià(!
å
)  0;

331 
	`fg‘s
(
lše
,Öše),
å
è!ğ
NULL
) {

332 ià(
	`¡ºcmp
(
lše
,
f›ld
,
æ’
) == 0) {

333 *
p
 = 
	`¡rchr
(
lše
,'k');

334 ià(
p
) {

335 *
p
 = '\0';

336 
by‹s
 +ğ
	`¡¹Ş
(
lše
+
æ’
,
NULL
,10) * 1024;

340 
	`fşo£
(
å
);

341  
by‹s
;

342 
	}
}

344 
size_t
 
	$zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
, 
pid
) {

345 ((è
f›ld
);

346 ((è
pid
);

348 
	}
}

351 
size_t
 
	$zm®loc_g‘_´iv©e_dœty
(
pid
) {

352  
	`zm®loc_g‘_sm­_by‹s_by_f›ld
("Priv©e_Dœty:",
pid
);

353 
	}
}

368 
size_t
 
	$zm®loc_g‘_memÜy_size
() {

369 #ià
	`defšed
(
__unix__
è|| defšed(
__unix
è|| defšed(
unix
) || \

370 (
	`defšed
(
__APPLE__
è&& defšed(
__MACH__
))

371 #ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_MEMSIZE
è|| defšed(
HW_PHYSMEM64
))

372 
mib
[2];

373 
mib
[0] = 
CTL_HW
;

374 #ià
	`defšed
(
HW_MEMSIZE
)

375 
mib
[1] = 
HW_MEMSIZE
;

376 #–ià
	`defšed
(
HW_PHYSMEM64
)

377 
mib
[1] = 
HW_PHYSMEM64
;

379 
št64_t
 
size
 = 0;

380 
size_t
 
Ën
 = (
size
);

381 ià(
	`sysùl
Ğ
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

382  (
size_t
)
size
;

385 #–ià
	`defšed
(
_SC_PHYS_PAGES
è&& defšed(
_SC_PAGESIZE
)

387  (
size_t
)
	`syscÚf
(
_SC_PHYS_PAGES
è* (size_t)syscÚf(
_SC_PAGESIZE
);

389 #–ià
	`defšed
(
CTL_HW
è&& (defšed(
HW_PHYSMEM
è|| defšed(
HW_REALMEM
))

391 
mib
[2];

392 
mib
[0] = 
CTL_HW
;

393 #ià
	`defšed
(
HW_REALMEM
)

394 
mib
[1] = 
HW_REALMEM
;

395 #–ià
	`defšed
(
HW_PYSMEM
)

396 
mib
[1] = 
HW_PHYSMEM
;

398 
size
 = 0;

399 
size_t
 
Ën
 = (
size
);

400 ià(
	`sysùl
(
mib
, 2, &
size
, &
Ën
, 
NULL
, 0) == 0)

401  (
size_t
)
size
;

409 
	}
}

	@src/zmalloc.h

31 #iâdeà
__ZMALLOC_H


32 
	#__ZMALLOC_H


	)

35 
	#__x¡r
(
s
è
	`__¡r
(s)

	)

36 
	#__¡r
(
s
è#s

	)

38 #ià
defšed
(
USE_TCMALLOC
)

39 
	#ZMALLOC_LIB
 ("tcm®loc-" 
	`__x¡r
(
TC_VERSION_MAJOR
è"." __x¡r(
TC_VERSION_MINOR
))

	)

40 
	~<googË/tcm®loc.h
>

41 #ià(
TC_VERSION_MAJOR
 =ğ1 && 
TC_VERSION_MINOR
 >= 6) || (TC_VERSION_MAJOR > 1)

42 
	#HAVE_MALLOC_SIZE
 1

	)

43 
	#zm®loc_size
(
p
è
	`tc_m®loc_size
Õ)

	)

48 #–ià
defšed
(
USE_JEMALLOC
)

49 
	#ZMALLOC_LIB
 ("jem®loc-" 
	`__x¡r
(
JEMALLOC_VERSION_MAJOR
è"." __x¡r(
JEMALLOC_VERSION_MINOR
è"." __x¡r(
JEMALLOC_VERSION_BUGFIX
))

	)

50 
	~<jem®loc/jem®loc.h
>

51 #ià(
JEMALLOC_VERSION_MAJOR
 =ğ2 && 
JEMALLOC_VERSION_MINOR
 >= 1) || (JEMALLOC_VERSION_MAJOR > 2)

52 
	#HAVE_MALLOC_SIZE
 1

	)

53 
	#zm®loc_size
(
p
è
	`je_m®loc_u§bË_size
Õ)

	)

58 #–ià
defšed
(
__APPLE__
)

59 
	~<m®loc/m®loc.h
>

60 
	#HAVE_MALLOC_SIZE
 1

	)

61 
	#zm®loc_size
(
p
è
	`m®loc_size
Õ)

	)

64 #iâdeà
ZMALLOC_LIB


65 
	#ZMALLOC_LIB
 "libc"

	)

71 #ià
defšed
(
USE_JEMALLOC
è&& defšed(
JEMALLOC_FRAG_HINT
)

72 
	#HAVE_DEFRAG


	)

75 *
zm®loc
(
size_t
 
size
);

76 *
zÿÎoc
(
size_t
 
size
);

77 *
z»®loc
(*
±r
, 
size_t
 
size
);

78 
zä“
(*
±r
);

79 *
z¡rdup
(cÚ¡ *
s
);

80 
size_t
 
zm®loc_u£d_memÜy
();

81 
zm®loc_£t_oom_hªdËr
((*
oom_hªdËr
)(
size_t
));

82 
	`zm®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
);

83 
size_t
 
	`zm®loc_g‘_rss
();

84 
size_t
 
	`zm®loc_g‘_´iv©e_dœty
(
pid
);

85 
size_t
 
	`zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
, 
pid
);

86 
size_t
 
	`zm®loc_g‘_memÜy_size
();

87 
	`zlibc_ä“
(*
±r
);

89 #ifdeà
HAVE_DEFRAG


90 
	`zä“_no_tÿche
(*
±r
);

91 *
	`zm®loc_no_tÿche
(
size_t
 
size
);

94 #iâdeà
HAVE_MALLOC_SIZE


95 
size_t
 
	`zm®loc_size
(*
±r
);

	@utils/corrupt_rdb.c

7 
	~<¡dio.h
>

8 
	~<fú.h
>

9 
	~<sys/¡©.h
>

10 
	~<¡dlib.h
>

11 
	~<uni¡d.h
>

12 
	~<time.h
>

14 
	$maš
(
¬gc
, **
¬gv
) {

15 
¡©
 stat;

16 
fd
, 
cyşes
;

18 ià(
¬gc
 != 3) {

19 
	`årštf
(
¡d”r
,"Usage: <filename> <cycles>\n");

20 
	`ex™
(1);

23 
	`¤ªd
(
	`time
(
NULL
));

24 
cyşes
 = 
	`©oi
(
¬gv
[2]);

25 
fd
 = 
	`İ’
("dump.rdb",
O_RDWR
);

26 ià(
fd
 == -1) {

27 
	`³¼Ü
("open");

28 
	`ex™
(1);

30 
	`f¡©
(
fd
,&
¡©
);

32 
cyşes
--) {

33 
buf
[32];

34 
off£t
 = 
	`¿nd
()%
¡©
.
¡_size
;

35 
wr™–’
 = 1+
	`¿nd
()%31;

36 
j
;

38 
j
 = 0; j < 
wr™–’
; j++è
buf
[j] = ()
	`¿nd
();

39 
	`l£ek
(
fd
,
off£t
,
SEEK_SET
);

40 
	`´štf
("Wr™šg %d by‹ © off£ˆ%lu\n", 
wr™–’
, 
off£t
);

41 
	`wr™e
(
fd
,
buf
,
wr™–’
);

44 
	}
}

	@utils/hashtable/rehashing.c

1 
	~"»dis.h
"

2 
	~"diù.h
"

4 
	$_»disAs£¹
(*
x
, *
y
, 
l
) {

5 
	`´štf
("ASSERT: % % %d\n",
x
,
y
,
l
);

6 
	`ex™
(1);

7 
	}
}

9 
	$diùKeyHash
(cÚ¡ *
keyp
) {

10 
key
 = ()
keyp
;

11 
key
 = 
	`diùG’HashFunùiÚ
(&key,(key));

12 
key
 += ~(key << 15);

13 
key
 ^= (key >> 10);

14 
key
 += (key << 3);

15 
key
 ^= (key >> 6);

16 
key
 += ~(key << 11);

17 
key
 ^= (key >> 16);

18  
key
;

19 
	}
}

21 
	$diùKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

22 
k1
 = ()
key1
;

23 
k2
 = ()
key2
;

24  
k1
 =ğ
k2
;

25 
	}
}

27 
diùTy³
 
	gdiùTy³Te¡
 = {

28 
diùKeyHash
,

29 
NULL
,

30 
NULL
,

31 
diùKeyCom·»
,

32 
NULL
,

33 
NULL


36 
	$showBuck‘s
(
diùht
 
ht
) {

37 ià(
ht
.
bË
 =ğ
NULL
) {

38 
	`´štf
("NULL\n");

40 
j
;

41 
j
 = 0; j < 
ht
.
size
; j++) {

42 
	`´štf
("%c", 
ht
.
bË
[
j
] ? '1' : '0');

44 
	`´štf
("\n");

46 
	}
}

48 
	$show
(
diù
 *
d
) {

49 
j
;

50 ià(
d
->
»hashidx
 != -1) {

51 
	`´štf
("rhidx: ");

52 
j
 = 0; j < 
d
->
»hashidx
; j++)

53 
	`´štf
(".");

54 
	`´štf
("|\n");

56 
	`´štf
("ht[0]: ");

57 
	`showBuck‘s
(
d
->
ht
[0]);

58 
	`´štf
("ht[1]: ");

59 
	`showBuck‘s
(
d
->
ht
[1]);

60 
	`´štf
("\n");

61 
	}
}

63 
	$sÜtPoš‹rs
(cÚ¡ *
a
, cÚ¡ *
b
) {

64 
Ï
, 
lb
;

66 
Ï
 = (è(*((
diùEÁry
**)
a
));

67 
lb
 = (è(*((
diùEÁry
**)
b
));

68  
Ï
-
lb
;

69 
	}
}

71 
	$¡»ssG‘Keys
(
diù
 *
d
, 
times
, *
³rãù_run
, *
­´ox_run
) {

72 
j
;

74 
diùEÁry
 **
des
 = 
	`zm®loc
((diùEÁry*)*
	`diùSize
(
d
));

75 
j
 = 0; j < 
times
; j++) {

76 
»que¡ed
 = 
	`¿nd
(è% (
	`diùSize
(
d
)+1);

77 
»tuºed
 = 
	`diùG‘SomeKeys
(
d
, 
des
, 
»que¡ed
);

78 
dup
 = 0;

80 
	`qsÜt
(
des
,
»tuºed
,(
diùEÁry
*),
sÜtPoš‹rs
);

81 ià(
»tuºed
 > 1) {

82 
i
;

83 
i
 = 0; i < 
»tuºed
-1; i++) {

84 ià(
des
[
i
] =ğdes[i+1]è
dup
++;

88 ià(
»que¡ed
 =ğ
»tuºed
 && 
dup
 == 0) {

89 (*
³rãù_run
)++;

91 (*
­´ox_run
)++;

92 
	`´štf
("Requested,„eturned, duplicated: %d %d %d\n",

93 
»que¡ed
, 
»tuºed
, 
dup
);

96 
	`zä“
(
des
);

97 
	}
}

99 
	#MAX1
 120

	)

100 
	#MAX2
 1000

	)

101 
	$maš
() {

102 
diù
 *
d
 = 
	`diùC»©e
(&
diùTy³Te¡
,
NULL
);

103 
i
;

104 
	`¤ªd
(
	`time
(
NULL
));

106 
i
 = 0; i < 
MAX1
; i++) {

107 
	`diùAdd
(
d
,(*)
i
,
NULL
);

108 
	`show
(
d
);

110 
	`´štf
("Size: %d\n", ()
	`diùSize
(
d
));

112 
i
 = 0; i < 
MAX1
; i++) {

113 
	`diùD–‘e
(
d
,(*)
i
);

114 
	`diùResize
(
d
);

115 
	`show
(
d
);

117 
	`diùR–—£
(
d
);

119 
d
 = 
	`diùC»©e
(&
diùTy³Te¡
,
NULL
);

121 
	`´štf
("Stressesting dictGetSomeKeys\n");

122 
³rãù_run
 = 0, 
­´ox_run
 = 0;

124 
i
 = 0; i < 
MAX2
; i++) {

125 
	`diùAdd
(
d
,(*)
i
,
NULL
);

126 
	`¡»ssG‘Keys
(
d
,100,&
³rãù_run
,&
­´ox_run
);

129 
i
 = 0; i < 
MAX2
; i++) {

130 
	`diùD–‘e
(
d
,(*)
i
);

131 
	`diùResize
(
d
);

132 
	`¡»ssG‘Keys
(
d
,100,&
³rãù_run
,&
­´ox_run
);

135 
	`´štf
("dictGetSomeKey, %d…erfect„uns, %d‡pproximated„uns\n",

136 
³rãù_run
, 
­´ox_run
);

138 
	`diùR–—£
(
d
);

140 
	`´štf
("TEST PASSED!\n");

142 
	}
}

	@utils/lru/lfu-simulation.c

1 
	~<¡dio.h
>

2 
	~<time.h
>

3 
	~<¡dšt.h
>

4 
	~<¡dlib.h
>

6 
	gdeü_ev”y
 = 1;

7 
	gkey¥aû_size
 = 1000000;

8 
time_t
 
	gsw™ch_aá”
 = 30;

10 
	s’Œy
 {

13 
ušt8_t
 
	mcouÁ”
;

14 
ušt16_t
 
	mdeütime
;

17 
ušt64_t
 
	mh™s
;

18 
time_t
 
	mùime
;

21 
	#to_16b™_mšu‹s
(
x
è((x/60è& 65535)

	)

22 
	#COUNTER_INIT_VAL
 5

	)

28 
ušt16_t
 
	$mšu‹s_diff
(
ušt16_t
 
now
, ušt16_ˆ
´ev
) {

29 ià(
now
 >ğ
´ev
) ‚ow-prev;

30  65535-
´ev
+
now
;

31 
	}
}

36 
ušt8_t
 
	$log_šü
(
ušt8_t
 
couÁ”
) {

37 ià(
couÁ”
 == 255)  counter;

38 
r
 = ()
	`¿nd
()/
RAND_MAX
;

39 
ba£v®
 = 
couÁ”
-
COUNTER_INIT_VAL
;

40 ià(
ba£v®
 < 0) baseval = 0;

41 
lim™
 = 1.0/(
ba£v®
*10+1);

42 ià(
r
 < 
lim™
è
couÁ”
++;

43  
couÁ”
;

44 
	}
}

47 
	$acûss_’Œy
(
’Œy
 *
e
) {

48 
e
->
couÁ”
 = 
	`log_šü
(e->counter);

49 
e
->
h™s
++;

50 
	}
}

54 
ušt8_t
 
	$sÿn_’Œy
(
’Œy
 *
e
) {

55 ià(
	`mšu‹s_diff
(
	`to_16b™_mšu‹s
(
	`time
(
NULL
)),
e
->
deütime
)

56 >ğ
deü_ev”y
)

58 ià(
e
->
couÁ”
) {

59 ià(
e
->
couÁ”
 > 
COUNTER_INIT_VAL
*2) {

60 
e
->
couÁ”
 /= 2;

62 
e
->
couÁ”
--;

65 
e
->
deütime
 = 
	`to_16b™_mšu‹s
(
	`time
(
NULL
));

67  
e
->
couÁ”
;

68 
	}
}

71 
	$show_’Œy
(
pos
, 
’Œy
 *
e
) {

72 *
g
 = "normal ";

74 ià(
pos
 >ğ10 &&…o <ğ14è
g
 = "new‚o‡ccess";

75 ià(
pos
 >ğ15 &&…o <ğ19è
g
 = "new‡ccessed ";

76 ià(
pos
 >ğ
key¥aû_size
 -5è
g
= "old‚o‡ccess";

78 
	`´štf
("%ld] <%s> frequency:%d decrtime:%d [%lu hits |‡ge:%ld sec]\n",

79 
pos
, 
g
, 
e
->
couÁ”
,ƒ->
deütime
, (ë->
h™s
,

80 
	`time
(
NULL
è- 
e
->
ùime
);

81 
	}
}

83 
	$maš
() {

84 
time_t
 
¡¬t
 = 
	`time
(
NULL
);

85 
time_t
 
Ãw_’Œy_time
 = 
¡¬t
;

86 
time_t
 
di¥Ïy_time
 = 
¡¬t
;

87 
’Œy
 *
’Œ›s
 = 
	`m®loc
((*’Œ›s)*
key¥aû_size
);

88 
j
;

91 
j
 = 0; j < 
key¥aû_size
; j++) {

92 
’Œ›s
[
j
].
couÁ”
 = 
COUNTER_INIT_VAL
;

93 
’Œ›s
[
j
].
deütime
 = 
	`to_16b™_mšu‹s
(
¡¬t
);

94 
’Œ›s
[
j
].
h™s
 = 0;

95 
’Œ›s
[
j
].
ùime
 = 
	`time
(
NULL
);

99 
time_t
 
now
 = 
	`time
(
NULL
);

100 
idx
;

103 
j
 = 0; j < 3; j++) {

104 
	`sÿn_’Œy
(
’Œ›s
+(
	`¿nd
()%
key¥aû_size
));

109 ià(
now
-
¡¬t
 < 
sw™ch_aá”
) {

111 
idx
 = 1;

112 (
	`¿nd
(è% 21è!ğ0 && 
idx
 < 
key¥aû_size
) idx *= 2;

113 ià(
idx
 > 
key¥aû_size
) idx = keyspace_size;

114 
idx
 = 
	`¿nd
() % idx;

117 
idx
 = 
	`¿nd
(è% 
key¥aû_size
;

127 ià((
idx
 < 10 || idx > 14è&& (idx < 
key¥aû_size
-5))

128 
	`acûss_’Œy
(
’Œ›s
+
idx
);

132 ià(
Ãw_’Œy_time
 <ğ
now
) {

133 
idx
 = 10+(
	`¿nd
()%10);

134 
’Œ›s
[
idx
].
couÁ”
 = 
COUNTER_INIT_VAL
;

135 
’Œ›s
[
idx
].
deütime
 = 
	`to_16b™_mšu‹s
(
	`time
(
NULL
));

136 
’Œ›s
[
idx
].
h™s
 = 0;

137 
’Œ›s
[
idx
].
ùime
 = 
	`time
(
NULL
);

138 
Ãw_’Œy_time
 = 
now
+10;

142 ià(
di¥Ïy_time
 !ğ
now
) {

143 
	`´štf
("=============================\n");

144 
	`´štf
("Cu¼’ˆmšu‹ time: %d\n", ()
	`to_16b™_mšu‹s
(
now
));

145 
	`´štf
("Access method: %s\n",

146 (
now
-
¡¬t
 < 
sw™ch_aá”
) ? "power-law" : "flat");

148 
j
 = 0; j < 20; j++)

149 
	`show_’Œy
(
j
,
’Œ›s
+j);

151 
j
 = 
key¥aû_size
-20; j < keyspace_size; j++)

152 
	`show_’Œy
(
j
,
’Œ›s
+j);

153 
di¥Ïy_time
 = 
now
;

157 
	}
}

	@/usr/include/alloca.h

18 #iâdef 
_ALLOCA_H


19 
	#_ALLOCA_H
 1

	)

21 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

26 
	g__BEGIN_DECLS


29 #undeà
®loÿ


32 *
	$®loÿ
 (
size_t
 
__size
è
__THROW
;

34 #ifdef 
__GNUC__


35 
	#®loÿ
(
size
è
	`__butš_®loÿ
 (size)

	)

38 
__END_DECLS


	@/usr/include/arpa/inet.h

18 #iâdeà
_ARPA_INET_H


19 
	#_ARPA_INET_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<Ãtš‘/š.h
>

25 #iâdeà
__sockËn_t_defšed


26 
__sockËn_t
 
	tsockËn_t
;

27 
	#__sockËn_t_defšed


	)

30 
__BEGIN_DECLS


34 
š_addr_t
 
	$š‘_addr
 (cÚ¡ *
__ı
è
__THROW
;

37 
š_addr_t
 
	$š‘_Êaof
 (
š_addr
 
__š
è
__THROW
;

41 
š_addr
 
	$š‘_mak—ddr
 (
š_addr_t
 
__Ãt
, in_addr_ˆ
__ho¡
)

42 
__THROW
;

45 
š_addr_t
 
	$š‘_Ãtof
 (
š_addr
 
__š
è
__THROW
;

49 
š_addr_t
 
	$š‘_ÃtwÜk
 (cÚ¡ *
__ı
è
__THROW
;

53 *
	$š‘_Áß
 (
š_addr
 
__š
è
__THROW
;

58 
	$š‘_±Ú
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

59 *
__»¡riù
 
__buf
è
__THROW
;

64 cÚ¡ *
	$š‘_Áİ
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

65 *
__»¡riù
 
__buf
, 
sockËn_t
 
__Ën
)

66 
__THROW
;

70 #ifdeà
__USE_MISC


73 
	$š‘_©Ú
 (cÚ¡ *
__ı
, 
š_addr
 *
__šp
è
__THROW
;

77 *
	$š‘_Ã
 (
š_addr_t
 
__Ãt
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

82 *
	$š‘_Ãt_Áİ
 (
__af
, cÚ¡ *
__ı
, 
__b™s
,

83 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

88 
	$š‘_Ãt_±Ú
 (
__af
, cÚ¡ *
__ı
,

89 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

94 
	$š‘_n§p_addr
 (cÚ¡ *
__ı
,

95 *
__buf
, 
__Ën
è
__THROW
;

99 *
	$š‘_n§p_Áß
 (
__Ën
, cÚ¡ *
__ı
,

100 *
__buf
è
__THROW
;

103 
__END_DECLS


	@/usr/include/assert.h

22 #ifdef 
_ASSERT_H


24 #undeà
_ASSERT_H


25 #undeà
as£¹


26 #undeà
__ASSERT_VOID_CAST


28 #ifdef 
__USE_GNU


29 #undeà
as£¹_³¼Ü


34 
	#_ASSERT_H
 1

	)

35 
	~<ã©u»s.h
>

37 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,95)

38 
	#__ASSERT_VOID_CAST
 
¡©ic_ÿ¡
<>

	)

40 
	#__ASSERT_VOID_CAST
 ()

	)

48 #ifdef 
NDEBUG


50 
	#as£¹
(
ex´
è(
	`__ASSERT_VOID_CAST
 (0))

	)

58 #ifdef 
__USE_GNU


59 
	#as£¹_³¼Ü
(
”ºum
è(
	`__ASSERT_VOID_CAST
 (0))

	)

64 #iâdeà
_ASSERT_H_DECLS


65 
	#_ASSERT_H_DECLS


	)

66 
__BEGIN_DECLS


69 
	$__as£¹_ç
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
,

70 
__lše
, cÚ¡ *
__funùiÚ
)

71 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

74 
	$__as£¹_³¼Ü_ç
 (
__”ºum
, cÚ¡ *
__fe
,

75 
__lše
, cÚ¡ *
__funùiÚ
)

76 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

81 
	$__as£¹
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
, 
__lše
)

82 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

85 
__END_DECLS


88 
	#as£¹
(
ex´
) \

89 ((
ex´
) \

90 ? 
	`__ASSERT_VOID_CAST
 (0) \

91 : 
	`__as£¹_ç
 (#ex´, 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

93 #ifdef 
__USE_GNU


94 
	#as£¹_³¼Ü
(
”ºum
) \

95 (!(
”ºum
) \

96 ? 
	`__ASSERT_VOID_CAST
 (0) \

97 : 
	`__as£¹_³¼Ü_ç
 ((
”ºum
), 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

105 #ià
defšed
 
__ılu¥lus
 ? 
	`__GNUC_PREREQ
 (2, 6) : __GNUC_PREREQ (2, 4)

106 
	#__ASSERT_FUNCTION
 
__PRETTY_FUNCTION__


	)

108 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

109 
	#__ASSERT_FUNCTION
 
__func__


	)

111 
	#__ASSERT_FUNCTION
 ((cÚ¡ *è0)

	)

118 #ià
defšed
 
__USE_ISOC11
 && !defšed 
__ılu¥lus


119 #undeà
¡©ic_as£¹


120 
	#¡©ic_as£¹
 
_Stic_as£¹


	)

	@/usr/include/ctype.h

22 #iâdef 
_CTYPE_H


23 
	#_CTYPE_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 
	g__BEGIN_DECLS


30 #iâdeà
_ISb™


39 
	~<’dŸn.h
>

40 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


41 
	#_ISb™
(
b™
è(1 << (b™))

	)

43 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

48 
	m_ISuµ”
 = 
_ISb™
 (0),

49 
	m_ISlow”
 = 
_ISb™
 (1),

50 
	m_IS®pha
 = 
_ISb™
 (2),

51 
	m_ISdig™
 = 
_ISb™
 (3),

52 
	m_ISxdig™
 = 
_ISb™
 (4),

53 
	m_IS¥aû
 = 
_ISb™
 (5),

54 
	m_IS´št
 = 
_ISb™
 (6),

55 
	m_ISg¿ph
 = 
_ISb™
 (7),

56 
	m_ISbÏnk
 = 
_ISb™
 (8),

57 
	m_ISúŒl
 = 
_ISb™
 (9),

58 
	m_ISpunù
 = 
_ISb™
 (10),

59 
	m_IS®num
 = 
_ISb™
 (11)

79 cÚ¡ **
	$__ùy³_b_loc
 ()

80 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

81 cÚ¡ 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

83 cÚ¡ 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

87 #iâdeà
__ılu¥lus


88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

90 #–ià
defšed
 
__USE_EXTERN_INLINES


91 
	#__isùy³_f
(
ty³
) \

92 
__ex‹º_šlše
 \

93 
is
##
	`ty³
 (
__c
è
__THROW
 \

95  (*
	`__ùy³_b_loc
 ())[(è(
__c
)] & (è
_IS
##
ty³
; \

96 
	}

	)
}

99 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

100 
	#__tßscii
(
c
è((cè& 0x7fè

	)

102 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

104 
__BEGIN_NAMESPACE_STD


110 
__exùy³
 (
i§Êum
);

111 
__exùy³
 (
i§Íha
);

112 
__exùy³
 (
isúŒl
);

113 
__exùy³
 (
isdig™
);

114 
__exùy³
 (
i¦ow”
);

115 
__exùy³
 (
isg¿ph
);

116 
__exùy³
 (
i¥ršt
);

117 
__exùy³
 (
i¥unù
);

118 
__exùy³
 (
is¥aû
);

119 
__exùy³
 (
isuµ”
);

120 
__exùy³
 (
isxdig™
);

124 
	$tŞow”
 (
__c
è
__THROW
;

127 
	$touµ”
 (
__c
è
__THROW
;

129 
__END_NAMESPACE_STD


133 #ifdef 
__USE_ISOC99


134 
__BEGIN_NAMESPACE_C99


136 
	`__exùy³
 (
isbÏnk
);

138 
__END_NAMESPACE_C99


141 #ifdeà
__USE_GNU


143 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

146 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


150 
	$i§scii
 (
__c
è
__THROW
;

154 
	$tßscii
 (
__c
è
__THROW
;

158 
	`__exùy³
 (
_touµ”
);

159 
	`__exùy³
 (
_tŞow”
);

163 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

164 (
__ex‹nsiÚ__
 \

165 ({ 
__»s
; \

166 ià( (
c
) > 1) \

168 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

170 
__c
 = (
c
); \

171 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

174 
__»s
 = 
f
 
¬gs
; \

177 
__»s
 = (
a
)[(è(
c
)]; \

178 
__»s
; 
	}
}))

	)

180 #ià!
defšed
 
__NO_CTYPE


181 #ifdeà
__isùy³_f


182 
	$__isùy³_f
 (
®num
)

183 
	$__isùy³_f
 (
®pha
)

184 
	$__isùy³_f
 (
úŒl
)

185 
	$__isùy³_f
 (
dig™
)

186 
	$__isùy³_f
 (
low”
)

187 
	$__isùy³_f
 (
g¿ph
)

188 
	$__isùy³_f
 (
´št
)

189 
	$__isùy³_f
 (
punù
)

190 
	$__isùy³_f
 (
¥aû
)

191 
	$__isùy³_f
 (
uµ”
)

192 
	$__isùy³_f
 (
xdig™
)

193 #ifdeà
__USE_ISOC99


194 
	$__isùy³_f
 (
bÏnk
)

196 #–ià
defšed
 
__isùy³


197 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

198 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

199 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

200 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

201 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

202 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

203 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

204 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

205 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

206 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

207 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

208 #ifdeà
__USE_ISOC99


209 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

213 #ifdeà
__USE_EXTERN_INLINES


214 
__ex‹º_šlše
 

215 
	`__NTH
 (
	$tŞow”
 (
__c
))

217  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

218 
	}
}

220 
__ex‹º_šlše
 

221 
__NTH
 (
	$touµ”
 (
__c
))

223  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

224 
	}
}

227 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


228 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

229 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

232 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


233 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

234 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

236 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

237 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

243 #ifdeà
__USE_XOPEN2K8


257 
	~<xloÿË.h
>

261 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

262 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

264 
	#__exùy³_l
(
Çme
) \

265 
	`Çme
 (, 
__loÿË_t
è
__THROW


	)

271 
__exùy³_l
 (
i§Êum_l
);

272 
__exùy³_l
 (
i§Íha_l
);

273 
__exùy³_l
 (
isúŒl_l
);

274 
__exùy³_l
 (
isdig™_l
);

275 
__exùy³_l
 (
i¦ow”_l
);

276 
__exùy³_l
 (
isg¿ph_l
);

277 
__exùy³_l
 (
i¥ršt_l
);

278 
__exùy³_l
 (
i¥unù_l
);

279 
__exùy³_l
 (
is¥aû_l
);

280 
__exùy³_l
 (
isuµ”_l
);

281 
__exùy³_l
 (
isxdig™_l
);

283 
__exùy³_l
 (
isbÏnk_l
);

287 
	$__tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

288 
	$tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

291 
	$__touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

292 
	$touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

294 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


295 
	#__tŞow”_l
(
c
, 
loÿË
) \

296 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

297 
	#__touµ”_l
(
c
, 
loÿË
) \

298 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

299 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

300 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

304 #iâdeà
__NO_CTYPE


305 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

306 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

307 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

308 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

309 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

310 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

311 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

312 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

313 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

314 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

315 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

317 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

319 #ifdeà
__USE_MISC


320 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

321 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

324 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

325 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

326 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

327 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

328 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

329 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

330 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

331 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

332 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

333 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

334 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

336 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

338 #ifdeà
__USE_MISC


339 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

340 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

347 
__END_DECLS


	@/usr/include/dlfcn.h

19 #iâdef 
_DLFCN_H


20 
	#_DLFCN_H
 1

	)

22 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

27 
	~<b™s/dlfú.h
>

30 #ifdeà
__USE_GNU


35 
	#RTLD_NEXT
 ((*è-1l)

	)

40 
	#RTLD_DEFAULT
 ((*è0)

	)

44 
	tLmid_t
;

47 
	#LM_ID_BASE
 0

	)

48 
	#LM_ID_NEWLM
 -1

	)

52 
__BEGIN_DECLS


56 *
	$dlİ’
 (cÚ¡ *
__fe
, 
__mode
è
__THROWNL
;

60 
	$dlşo£
 (*
__hªdË
è
__THROWNL
 
	`__nÚnuÎ
 ((1));

64 *
	$dlsym
 (*
__»¡riù
 
__hªdË
,

65 cÚ¡ *
__»¡riù
 
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((2));

67 #ifdeà
__USE_GNU


69 *
	$dlmİ’
 (
Lmid_t
 
__nsid
, cÚ¡ *
__fe
, 
__mode
è
__THROWNL
;

73 *
	$dlvsym
 (*
__»¡riù
 
__hªdË
,

74 cÚ¡ *
__»¡riù
 
__Çme
,

75 cÚ¡ *
__»¡riù
 
__v”siÚ
)

76 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

82 *
	$dË¼Ü
 (è
__THROW
;

85 #ifdeà
__USE_GNU


90 cÚ¡ *
dli_âame
;

91 *
dli_fba£
;

92 cÚ¡ *
dli_¢ame
;

93 *
dli_§ddr
;

94 } 
	tDl_šfo
;

98 
	$dÏddr
 (cÚ¡ *
__add»ss
, 
Dl_šfo
 *
__šfo
)

99 
__THROW
 
	`__nÚnuÎ
 ((2));

102 
	$dÏddr1
 (cÚ¡ *
__add»ss
, 
Dl_šfo
 *
__šfo
,

103 **
__exŒa_šfo
, 
__æags
è
__THROW
 
	`__nÚnuÎ
 ((2));

111 
RTLD_DL_SYMENT
 = 1,

114 
RTLD_DL_LINKMAP
 = 2

123 
	$dlšfo
 (*
__»¡riù
 
__hªdË
,

124 
__»que¡
, *
__»¡riù
 
__¬g
)

125 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

131 
RTLD_DI_LMID
 = 1,

135 
RTLD_DI_LINKMAP
 = 2,

137 
RTLD_DI_CONFIGADDR
 = 3,

144 
RTLD_DI_SERINFO
 = 4,

145 
RTLD_DI_SERINFOSIZE
 = 5,

149 
RTLD_DI_ORIGIN
 = 6,

151 
RTLD_DI_PROFILENAME
 = 7,

152 
RTLD_DI_PROFILEOUT
 = 8,

157 
RTLD_DI_TLS_MODID
 = 9,

163 
RTLD_DI_TLS_DATA
 = 10,

165 
RTLD_DI_MAX
 = 10

173 *
dls_Çme
;

174 
dls_æags
;

175 } 
	tDl_£½©h
;

181 
size_t
 
dls_size
;

182 
dls_út
;

183 
Dl_£½©h
 
dls_£½©h
[1];

184 } 
	tDl_£ršfo
;

188 
__END_DECLS


	@/usr/include/endian.h

18 #iâdef 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<ã©u»s.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<b™s/’dŸn.h
>

40 #iâdeà
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_MISC


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

53 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

58 #ià
defšed
 
__USE_MISC
 && !defšed 
__ASSEMBLER__


60 
	~<b™s/by‹sw­.h
>

62 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


63 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

64 
	#htŞe16
(
x
è(x)

	)

65 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

66 
	#Ë16toh
(
x
è(x)

	)

68 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

69 
	#htŞe32
(
x
è(x)

	)

70 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

71 
	#Ë32toh
(
x
è(x)

	)

73 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

74 
	#htŞe64
(
x
è(x)

	)

75 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

76 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/errno.h

22 #iâdef 
_ERRNO_H


26 #iâdef 
__Ãed_Em©h


27 
	#_ERRNO_H
 1

	)

28 
	~<ã©u»s.h
>

31 
	g__BEGIN_DECLS


35 
	~<b™s/”ºo.h
>

36 #undeà
__Ãed_Em©h


38 #ifdef 
_ERRNO_H


45 #iâdef 
”ºo


46 
”ºo
;

49 #ifdeà
__USE_GNU


54 *
´og¿m_švoÿtiÚ_Çme
, *
´og¿m_švoÿtiÚ_shÜt_Çme
;

58 
	g__END_DECLS


66 #ià
defšed
 
__USE_GNU
 || defšed 
__Ãed_”rÜ_t


67 #iâdeà
__”rÜ_t_defšed


68 
	t”rÜ_t
;

69 
	#__”rÜ_t_defšed
 1

	)

71 #undeà
__Ãed_”rÜ_t


	@/usr/include/execinfo.h

18 #iâdeà
_EXECINFO_H


19 
	#_EXECINFO_H
 1

	)

21 
	~<ã©u»s.h
>

23 
__BEGIN_DECLS


27 
	$backŒaû
 (**
__¬¿y
, 
__size
è
	`__nÚnuÎ
 ((1));

32 **
	$backŒaû_symbŞs
 (*cÚ¡ *
__¬¿y
, 
__size
)

33 
__THROW
 
	`__nÚnuÎ
 ((1));

38 
	$backŒaû_symbŞs_fd
 (*cÚ¡ *
__¬¿y
, 
__size
, 
__fd
)

39 
__THROW
 
	`__nÚnuÎ
 ((1));

41 
__END_DECLS


	@/usr/include/fcntl.h

22 #iâdef 
_FCNTL_H


23 
	#_FCNTL_H
 1

	)

25 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


31 
	~<b™s/ty³s.h
>

35 
	~<b™s/fú.h
>

39 #ifdeà
__O_TMPFILE


40 
	#__OPEN_NEEDS_MODE
(
oæag
) \

41 (((
oæag
è& 
O_CREAT
è!ğ0 || ((oæagè& 
__O_TMPFILE
è=ğ__O_TMPFILE)

	)

43 
	#__OPEN_NEEDS_MODE
(
oæag
è(((oæagè& 
O_CREAT
è!ğ0)

	)

49 #iâdeà
__mode_t_defšed


50 
__mode_t
 
	tmode_t
;

51 
	#__mode_t_defšed


	)

54 #iâdeà
__off_t_defšed


55 #iâdeà
__USE_FILE_OFFSET64


56 
__off_t
 
	toff_t
;

58 
__off64_t
 
	toff_t
;

60 
	#__off_t_defšed


	)

63 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


64 
__off64_t
 
	toff64_t
;

65 
	#__off64_t_defšed


	)

68 #iâdeà
__pid_t_defšed


69 
__pid_t
 
	tpid_t
;

70 
	#__pid_t_defšed


	)

74 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


75 
	#__Ãed_time¥ec


	)

76 
	~<time.h
>

77 
	~<b™s/¡©.h
>

79 
	#S_IFMT
 
__S_IFMT


	)

80 
	#S_IFDIR
 
__S_IFDIR


	)

81 
	#S_IFCHR
 
__S_IFCHR


	)

82 
	#S_IFBLK
 
__S_IFBLK


	)

83 
	#S_IFREG
 
__S_IFREG


	)

84 #ifdeà
__S_IFIFO


85 
	#S_IFIFO
 
__S_IFIFO


	)

87 #ifdeà
__S_IFLNK


88 
	#S_IFLNK
 
__S_IFLNK


	)

90 #ià(
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8
è&& defšed 
__S_IFSOCK


91 
	#S_IFSOCK
 
__S_IFSOCK


	)

96 
	#S_ISUID
 
__S_ISUID


	)

97 
	#S_ISGID
 
__S_ISGID


	)

99 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


101 
	#S_ISVTX
 
__S_ISVTX


	)

104 
	#S_IRUSR
 
__S_IREAD


	)

105 
	#S_IWUSR
 
__S_IWRITE


	)

106 
	#S_IXUSR
 
__S_IEXEC


	)

108 
	#S_IRWXU
 (
__S_IREAD
|
__S_IWRITE
|
__S_IEXEC
)

	)

110 
	#S_IRGRP
 (
S_IRUSR
 >> 3è

	)

111 
	#S_IWGRP
 (
S_IWUSR
 >> 3è

	)

112 
	#S_IXGRP
 (
S_IXUSR
 >> 3è

	)

114 
	#S_IRWXG
 (
S_IRWXU
 >> 3)

	)

116 
	#S_IROTH
 (
S_IRGRP
 >> 3è

	)

117 
	#S_IWOTH
 (
S_IWGRP
 >> 3è

	)

118 
	#S_IXOTH
 (
S_IXGRP
 >> 3è

	)

120 
	#S_IRWXO
 (
S_IRWXG
 >> 3)

	)

123 #ifdef 
__USE_MISC


124 #iâdeà
R_OK


127 
	#R_OK
 4

	)

128 
	#W_OK
 2

	)

129 
	#X_OK
 1

	)

130 
	#F_OK
 0

	)

135 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


136 
	#SEEK_SET
 0

	)

137 
	#SEEK_CUR
 1

	)

138 
	#SEEK_END
 2

	)

146 
fú
 (
__fd
, 
__cmd
, ...);

155 #iâdeà
__USE_FILE_OFFSET64


156 
	$İ’
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

158 #ifdeà
__REDIRECT


159 
	`__REDIRECT
 (
İ’
, (cÚ¡ *
__fe
, 
__oæag
, ...), 
İ’64
)

160 
	`__nÚnuÎ
 ((1));

162 
	#İ’
 
İ’64


	)

165 #ifdeà
__USE_LARGEFILE64


166 
	$İ’64
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

169 #ifdeà
__USE_ATFILE


179 #iâdeà
__USE_FILE_OFFSET64


180 
	$İ’©
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

181 
	`__nÚnuÎ
 ((2));

183 #ifdeà
__REDIRECT


184 
	`__REDIRECT
 (
İ’©
, (
__fd
, cÚ¡ *
__fe
, 
__oæag
,

185 ...), 
İ’©64
è
	`__nÚnuÎ
 ((2));

187 
	#İ’©
 
İ’©64


	)

190 #ifdeà
__USE_LARGEFILE64


191 
	$İ’©64
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

192 
	`__nÚnuÎ
 ((2));

201 #iâdeà
__USE_FILE_OFFSET64


202 
	$ü—t
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

204 #ifdeà
__REDIRECT


205 
	`__REDIRECT
 (
ü—t
, (cÚ¡ *
__fe
, 
mode_t
 
__mode
),

206 
ü—t64
è
	`__nÚnuÎ
 ((1));

208 
	#ü—t
 
ü—t64


	)

211 #ifdeà
__USE_LARGEFILE64


212 
	$ü—t64
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

215 #ià!
defšed
 
F_LOCK
 && (defšed 
__USE_MISC
 || (defšed 
__USE_XOPEN_EXTENDED
 \

216 && !
defšed
 
__USE_POSIX
))

225 
	#F_ULOCK
 0

	)

226 
	#F_LOCK
 1

	)

227 
	#F_TLOCK
 2

	)

228 
	#F_TEST
 3

	)

230 #iâdeà
__USE_FILE_OFFSET64


231 
	`lockf
 (
__fd
, 
__cmd
, 
off_t
 
__Ën
);

233 #ifdeà
__REDIRECT


234 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
), 
lockf64
);

236 
	#lockf
 
lockf64


	)

239 #ifdeà
__USE_LARGEFILE64


240 
	`lockf64
 (
__fd
, 
__cmd
, 
off64_t
 
__Ën
);

244 #ifdeà
__USE_XOPEN2K


247 #iâdeà
__USE_FILE_OFFSET64


248 
	$posix_çdvi£
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
,

249 
__advi£
è
__THROW
;

251 #ifdeà
__REDIRECT_NTH


252 
	`__REDIRECT_NTH
 (
posix_çdvi£
, (
__fd
, 
__off64_t
 
__off£t
,

253 
__off64_t
 
__Ën
, 
__advi£
),

254 
posix_çdvi£64
);

256 
	#posix_çdvi£
 
posix_çdvi£64


	)

259 #ifdeà
__USE_LARGEFILE64


260 
	$posix_çdvi£64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
,

261 
__advi£
è
__THROW
;

269 #iâdeà
__USE_FILE_OFFSET64


270 
	`posix_çÎoÿ‹
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
);

272 #ifdeà
__REDIRECT


273 
	`__REDIRECT
 (
posix_çÎoÿ‹
, (
__fd
, 
__off64_t
 
__off£t
,

274 
__off64_t
 
__Ën
),

275 
posix_çÎoÿ‹64
);

277 
	#posix_çÎoÿ‹
 
posix_çÎoÿ‹64


	)

280 #ifdeà
__USE_LARGEFILE64


281 
	`posix_çÎoÿ‹64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
);

287 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ
 \

288 && 
defšed
 
__va_¬g_·ck_Ën


289 
	~<b™s/fú2.h
>

292 
__END_DECLS


	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

97 #undeà
__USE_ISOC11


98 #undeà
__USE_ISOC99


99 #undeà
__USE_ISOC95


100 #undeà
__USE_ISOCXX11


101 #undeà
__USE_POSIX


102 #undeà
__USE_POSIX2


103 #undeà
__USE_POSIX199309


104 #undeà
__USE_POSIX199506


105 #undeà
__USE_XOPEN


106 #undeà
__USE_XOPEN_EXTENDED


107 #undeà
__USE_UNIX98


108 #undeà
__USE_XOPEN2K


109 #undeà
__USE_XOPEN2KXSI


110 #undeà
__USE_XOPEN2K8


111 #undeà
__USE_XOPEN2K8XSI


112 #undeà
__USE_LARGEFILE


113 #undeà
__USE_LARGEFILE64


114 #undeà
__USE_FILE_OFFSET64


115 #undeà
__USE_MISC


116 #undeà
__USE_ATFILE


117 #undeà
__USE_GNU


118 #undeà
__USE_REENTRANT


119 #undeà
__USE_FORTIFY_LEVEL


120 #undeà
__KERNEL_STRICT_NAMES


124 #iâdeà
_LOOSE_KERNEL_NAMES


125 
	#__KERNEL_STRICT_NAMES


	)

135 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


136 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

137 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

139 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

146 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

147 && !
defšed
 
	g_DEFAULT_SOURCE


152 #undeà
_DEFAULT_SOURCE


153 
	#_DEFAULT_SOURCE
 1

	)

157 #ifdeà
_GNU_SOURCE


158 #undeà
_ISOC95_SOURCE


159 
	#_ISOC95_SOURCE
 1

	)

160 #undeà
_ISOC99_SOURCE


161 
	#_ISOC99_SOURCE
 1

	)

162 #undeà
_ISOC11_SOURCE


163 
	#_ISOC11_SOURCE
 1

	)

164 #undeà
_POSIX_SOURCE


165 
	#_POSIX_SOURCE
 1

	)

166 #undeà
_POSIX_C_SOURCE


167 
	#_POSIX_C_SOURCE
 200809L

	)

168 #undeà
_XOPEN_SOURCE


169 
	#_XOPEN_SOURCE
 700

	)

170 #undeà
_XOPEN_SOURCE_EXTENDED


171 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

172 #undeà
_LARGEFILE64_SOURCE


173 
	#_LARGEFILE64_SOURCE
 1

	)

174 #undeà
_DEFAULT_SOURCE


175 
	#_DEFAULT_SOURCE
 1

	)

176 #undeà
_ATFILE_SOURCE


177 
	#_ATFILE_SOURCE
 1

	)

182 #ià(
defšed
 
_DEFAULT_SOURCE
 \

183 || (!
defšed
 
	g__STRICT_ANSI__
 \

184 && !
defšed
 
	g_ISOC99_SOURCE
 \

185 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

186 && !
defšed
 
	g_XOPEN_SOURCE
))

187 #undeà
_DEFAULT_SOURCE


188 
	#_DEFAULT_SOURCE
 1

	)

192 #ià(
defšed
 
_ISOC11_SOURCE
 \

193 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

194 
	#__USE_ISOC11
 1

	)

198 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

199 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

200 
	#__USE_ISOC99
 1

	)

204 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

205 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

206 
	#__USE_ISOC95
 1

	)

213 #ià((
defšed
 
__ılu¥lus
 && __cplusplus >= 201103L) \

214 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

215 
	#__USE_ISOCXX11
 1

	)

221 #ifdeà
_DEFAULT_SOURCE


222 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


223 
	#__USE_POSIX_IMPLICITLY
 1

	)

225 #undeà
_POSIX_SOURCE


226 
	#_POSIX_SOURCE
 1

	)

227 #undeà
_POSIX_C_SOURCE


228 
	#_POSIX_C_SOURCE
 200809L

	)

230 #ià((!
defšed
 
__STRICT_ANSI__
 \

231 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

232 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

233 
	#_POSIX_SOURCE
 1

	)

234 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

235 
	#_POSIX_C_SOURCE
 2

	)

236 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

237 
	#_POSIX_C_SOURCE
 199506L

	)

238 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

239 
	#_POSIX_C_SOURCE
 200112L

	)

241 
	#_POSIX_C_SOURCE
 200809L

	)

243 
	#__USE_POSIX_IMPLICITLY
 1

	)

246 #ià(
defšed
 
_POSIX_SOURCE
 \

247 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

248 || 
defšed
 
_XOPEN_SOURCE
)

249 
	#__USE_POSIX
 1

	)

252 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


253 
	#__USE_POSIX2
 1

	)

256 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

257 
	#__USE_POSIX199309
 1

	)

260 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

261 
	#__USE_POSIX199506
 1

	)

264 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

265 
	#__USE_XOPEN2K
 1

	)

266 #undeà
__USE_ISOC95


267 
	#__USE_ISOC95
 1

	)

268 #undeà
__USE_ISOC99


269 
	#__USE_ISOC99
 1

	)

272 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

273 
	#__USE_XOPEN2K8
 1

	)

274 #undeà
_ATFILE_SOURCE


275 
	#_ATFILE_SOURCE
 1

	)

278 #ifdef 
_XOPEN_SOURCE


279 
	#__USE_XOPEN
 1

	)

280 #ià(
_XOPEN_SOURCE
 - 0) >= 500

281 
	#__USE_XOPEN_EXTENDED
 1

	)

282 
	#__USE_UNIX98
 1

	)

283 #undeà
_LARGEFILE_SOURCE


284 
	#_LARGEFILE_SOURCE
 1

	)

285 #ià(
_XOPEN_SOURCE
 - 0) >= 600

286 #ià(
_XOPEN_SOURCE
 - 0) >= 700

287 
	#__USE_XOPEN2K8
 1

	)

288 
	#__USE_XOPEN2K8XSI
 1

	)

290 
	#__USE_XOPEN2K
 1

	)

291 
	#__USE_XOPEN2KXSI
 1

	)

292 #undeà
__USE_ISOC95


293 
	#__USE_ISOC95
 1

	)

294 #undeà
__USE_ISOC99


295 
	#__USE_ISOC99
 1

	)

298 #ifdeà
_XOPEN_SOURCE_EXTENDED


299 
	#__USE_XOPEN_EXTENDED
 1

	)

304 #ifdeà
_LARGEFILE_SOURCE


305 
	#__USE_LARGEFILE
 1

	)

308 #ifdeà
_LARGEFILE64_SOURCE


309 
	#__USE_LARGEFILE64
 1

	)

312 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

313 
	#__USE_FILE_OFFSET64
 1

	)

316 #ià
defšed
 
_DEFAULT_SOURCE


317 
	#__USE_MISC
 1

	)

320 #ifdef 
_ATFILE_SOURCE


321 
	#__USE_ATFILE
 1

	)

324 #ifdef 
_GNU_SOURCE


325 
	#__USE_GNU
 1

	)

328 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


329 
	#__USE_REENTRANT
 1

	)

332 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

333 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

334 #ià
_FORTIFY_SOURCE
 > 1

335 
	#__USE_FORTIFY_LEVEL
 2

	)

337 
	#__USE_FORTIFY_LEVEL
 1

	)

340 
	#__USE_FORTIFY_LEVEL
 0

	)

345 
	~<¡dc-´edef.h
>

353 #undeà
__GNU_LIBRARY__


354 
	#__GNU_LIBRARY__
 6

	)

358 
	#__GLIBC__
 2

	)

359 
	#__GLIBC_MINOR__
 23

	)

361 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

362 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

365 #iâdeà
__ASSEMBLER__


366 #iâdeà
_SYS_CDEFS_H


367 
	~<sys/cdefs.h
>

372 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


373 
	#__USE_LARGEFILE
 1

	)

374 
	#__USE_LARGEFILE64
 1

	)

380 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

381 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

382 && 
defšed
 
	g__ex‹º_šlše


383 
	#__USE_EXTERN_INLINES
 1

	)

391 
	~<gnu/¡ubs.h
>

	@/usr/include/inttypes.h

22 #iâdeà
_INTTYPES_H


23 
	#_INTTYPES_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<¡dšt.h
>

30 #iâdeà
____gwch¬_t_defšed


31 #ifdeà
__ılu¥lus


32 
	#__gwch¬_t
 
wch¬_t


	)

33 #–ià
defšed
 
__WCHAR_TYPE__


34 
__WCHAR_TYPE__
 
	t__gwch¬_t
;

36 
	#__Ãed_wch¬_t


	)

37 
	~<¡ddef.h
>

38 
wch¬_t
 
	t__gwch¬_t
;

40 
	#____gwch¬_t_defšed
 1

	)

43 #ià
__WORDSIZE
 == 64

44 
	#__PRI64_PREFIX
 "l"

	)

45 
	#__PRIPTR_PREFIX
 "l"

	)

47 
	#__PRI64_PREFIX
 "Î"

	)

48 
	#__PRIPTR_PREFIX


	)

54 
	#PRId8
 "d"

	)

55 
	#PRId16
 "d"

	)

56 
	#PRId32
 "d"

	)

57 
	#PRId64
 
__PRI64_PREFIX
 "d"

	)

59 
	#PRIdLEAST8
 "d"

	)

60 
	#PRIdLEAST16
 "d"

	)

61 
	#PRIdLEAST32
 "d"

	)

62 
	#PRIdLEAST64
 
__PRI64_PREFIX
 "d"

	)

64 
	#PRIdFAST8
 "d"

	)

65 
	#PRIdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

66 
	#PRIdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

67 
	#PRIdFAST64
 
__PRI64_PREFIX
 "d"

	)

70 
	#PRIi8
 "i"

	)

71 
	#PRIi16
 "i"

	)

72 
	#PRIi32
 "i"

	)

73 
	#PRIi64
 
__PRI64_PREFIX
 "i"

	)

75 
	#PRIiLEAST8
 "i"

	)

76 
	#PRIiLEAST16
 "i"

	)

77 
	#PRIiLEAST32
 "i"

	)

78 
	#PRIiLEAST64
 
__PRI64_PREFIX
 "i"

	)

80 
	#PRIiFAST8
 "i"

	)

81 
	#PRIiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

82 
	#PRIiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

83 
	#PRIiFAST64
 
__PRI64_PREFIX
 "i"

	)

86 
	#PRIo8
 "o"

	)

87 
	#PRIo16
 "o"

	)

88 
	#PRIo32
 "o"

	)

89 
	#PRIo64
 
__PRI64_PREFIX
 "o"

	)

91 
	#PRIoLEAST8
 "o"

	)

92 
	#PRIoLEAST16
 "o"

	)

93 
	#PRIoLEAST32
 "o"

	)

94 
	#PRIoLEAST64
 
__PRI64_PREFIX
 "o"

	)

96 
	#PRIoFAST8
 "o"

	)

97 
	#PRIoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

98 
	#PRIoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

99 
	#PRIoFAST64
 
__PRI64_PREFIX
 "o"

	)

102 
	#PRIu8
 "u"

	)

103 
	#PRIu16
 "u"

	)

104 
	#PRIu32
 "u"

	)

105 
	#PRIu64
 
__PRI64_PREFIX
 "u"

	)

107 
	#PRIuLEAST8
 "u"

	)

108 
	#PRIuLEAST16
 "u"

	)

109 
	#PRIuLEAST32
 "u"

	)

110 
	#PRIuLEAST64
 
__PRI64_PREFIX
 "u"

	)

112 
	#PRIuFAST8
 "u"

	)

113 
	#PRIuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

114 
	#PRIuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

115 
	#PRIuFAST64
 
__PRI64_PREFIX
 "u"

	)

118 
	#PRIx8
 "x"

	)

119 
	#PRIx16
 "x"

	)

120 
	#PRIx32
 "x"

	)

121 
	#PRIx64
 
__PRI64_PREFIX
 "x"

	)

123 
	#PRIxLEAST8
 "x"

	)

124 
	#PRIxLEAST16
 "x"

	)

125 
	#PRIxLEAST32
 "x"

	)

126 
	#PRIxLEAST64
 
__PRI64_PREFIX
 "x"

	)

128 
	#PRIxFAST8
 "x"

	)

129 
	#PRIxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

130 
	#PRIxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

131 
	#PRIxFAST64
 
__PRI64_PREFIX
 "x"

	)

134 
	#PRIX8
 "X"

	)

135 
	#PRIX16
 "X"

	)

136 
	#PRIX32
 "X"

	)

137 
	#PRIX64
 
__PRI64_PREFIX
 "X"

	)

139 
	#PRIXLEAST8
 "X"

	)

140 
	#PRIXLEAST16
 "X"

	)

141 
	#PRIXLEAST32
 "X"

	)

142 
	#PRIXLEAST64
 
__PRI64_PREFIX
 "X"

	)

144 
	#PRIXFAST8
 "X"

	)

145 
	#PRIXFAST16
 
__PRIPTR_PREFIX
 "X"

	)

146 
	#PRIXFAST32
 
__PRIPTR_PREFIX
 "X"

	)

147 
	#PRIXFAST64
 
__PRI64_PREFIX
 "X"

	)

151 
	#PRIdMAX
 
__PRI64_PREFIX
 "d"

	)

152 
	#PRIiMAX
 
__PRI64_PREFIX
 "i"

	)

153 
	#PRIoMAX
 
__PRI64_PREFIX
 "o"

	)

154 
	#PRIuMAX
 
__PRI64_PREFIX
 "u"

	)

155 
	#PRIxMAX
 
__PRI64_PREFIX
 "x"

	)

156 
	#PRIXMAX
 
__PRI64_PREFIX
 "X"

	)

160 
	#PRIdPTR
 
__PRIPTR_PREFIX
 "d"

	)

161 
	#PRIiPTR
 
__PRIPTR_PREFIX
 "i"

	)

162 
	#PRIoPTR
 
__PRIPTR_PREFIX
 "o"

	)

163 
	#PRIuPTR
 
__PRIPTR_PREFIX
 "u"

	)

164 
	#PRIxPTR
 
__PRIPTR_PREFIX
 "x"

	)

165 
	#PRIXPTR
 
__PRIPTR_PREFIX
 "X"

	)

171 
	#SCNd8
 "hhd"

	)

172 
	#SCNd16
 "hd"

	)

173 
	#SCNd32
 "d"

	)

174 
	#SCNd64
 
__PRI64_PREFIX
 "d"

	)

176 
	#SCNdLEAST8
 "hhd"

	)

177 
	#SCNdLEAST16
 "hd"

	)

178 
	#SCNdLEAST32
 "d"

	)

179 
	#SCNdLEAST64
 
__PRI64_PREFIX
 "d"

	)

181 
	#SCNdFAST8
 "hhd"

	)

182 
	#SCNdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

183 
	#SCNdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

184 
	#SCNdFAST64
 
__PRI64_PREFIX
 "d"

	)

187 
	#SCNi8
 "hhi"

	)

188 
	#SCNi16
 "hi"

	)

189 
	#SCNi32
 "i"

	)

190 
	#SCNi64
 
__PRI64_PREFIX
 "i"

	)

192 
	#SCNiLEAST8
 "hhi"

	)

193 
	#SCNiLEAST16
 "hi"

	)

194 
	#SCNiLEAST32
 "i"

	)

195 
	#SCNiLEAST64
 
__PRI64_PREFIX
 "i"

	)

197 
	#SCNiFAST8
 "hhi"

	)

198 
	#SCNiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

199 
	#SCNiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

200 
	#SCNiFAST64
 
__PRI64_PREFIX
 "i"

	)

203 
	#SCNu8
 "hhu"

	)

204 
	#SCNu16
 "hu"

	)

205 
	#SCNu32
 "u"

	)

206 
	#SCNu64
 
__PRI64_PREFIX
 "u"

	)

208 
	#SCNuLEAST8
 "hhu"

	)

209 
	#SCNuLEAST16
 "hu"

	)

210 
	#SCNuLEAST32
 "u"

	)

211 
	#SCNuLEAST64
 
__PRI64_PREFIX
 "u"

	)

213 
	#SCNuFAST8
 "hhu"

	)

214 
	#SCNuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

215 
	#SCNuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

216 
	#SCNuFAST64
 
__PRI64_PREFIX
 "u"

	)

219 
	#SCNo8
 "hho"

	)

220 
	#SCNo16
 "ho"

	)

221 
	#SCNo32
 "o"

	)

222 
	#SCNo64
 
__PRI64_PREFIX
 "o"

	)

224 
	#SCNoLEAST8
 "hho"

	)

225 
	#SCNoLEAST16
 "ho"

	)

226 
	#SCNoLEAST32
 "o"

	)

227 
	#SCNoLEAST64
 
__PRI64_PREFIX
 "o"

	)

229 
	#SCNoFAST8
 "hho"

	)

230 
	#SCNoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

231 
	#SCNoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

232 
	#SCNoFAST64
 
__PRI64_PREFIX
 "o"

	)

235 
	#SCNx8
 "hhx"

	)

236 
	#SCNx16
 "hx"

	)

237 
	#SCNx32
 "x"

	)

238 
	#SCNx64
 
__PRI64_PREFIX
 "x"

	)

240 
	#SCNxLEAST8
 "hhx"

	)

241 
	#SCNxLEAST16
 "hx"

	)

242 
	#SCNxLEAST32
 "x"

	)

243 
	#SCNxLEAST64
 
__PRI64_PREFIX
 "x"

	)

245 
	#SCNxFAST8
 "hhx"

	)

246 
	#SCNxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

247 
	#SCNxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

248 
	#SCNxFAST64
 
__PRI64_PREFIX
 "x"

	)

252 
	#SCNdMAX
 
__PRI64_PREFIX
 "d"

	)

253 
	#SCNiMAX
 
__PRI64_PREFIX
 "i"

	)

254 
	#SCNoMAX
 
__PRI64_PREFIX
 "o"

	)

255 
	#SCNuMAX
 
__PRI64_PREFIX
 "u"

	)

256 
	#SCNxMAX
 
__PRI64_PREFIX
 "x"

	)

259 
	#SCNdPTR
 
__PRIPTR_PREFIX
 "d"

	)

260 
	#SCNiPTR
 
__PRIPTR_PREFIX
 "i"

	)

261 
	#SCNoPTR
 
__PRIPTR_PREFIX
 "o"

	)

262 
	#SCNuPTR
 
__PRIPTR_PREFIX
 "u"

	)

263 
	#SCNxPTR
 
__PRIPTR_PREFIX
 "x"

	)

266 
	g__BEGIN_DECLS


268 #ià
__WORDSIZE
 == 64

273 
	mquÙ
;

274 
	m»m
;

275 } 
	timaxdiv_t
;

282 
__ex‹nsiÚ__
 
	mquÙ
;

283 
__ex‹nsiÚ__
 
	m»m
;

284 } 
	timaxdiv_t
;

290 
štmax_t
 
	$imaxabs
 (
štmax_t
 
__n
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

293 
imaxdiv_t
 
	$imaxdiv
 (
štmax_t
 
__num”
, iÁmax_ˆ
__d’om
)

294 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

297 
štmax_t
 
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

298 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

301 
uštmax_t
 
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

302 ** 
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

305 
štmax_t
 
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

306 
__gwch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

307 
__THROW
;

310 
uštmax_t
 
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

311 
__gwch¬_t
 ** 
__»¡riù
 
__’d±r
, 
__ba£
)

312 
__THROW
;

314 #ifdeà
__USE_EXTERN_INLINES


316 #ià
__WORDSIZE
 == 64

318 
	$__¡¹Ş_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

319 **
__»¡riù
 
__’d±r
,

320 
__ba£
, 
__group
)

321 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

323 
__ex‹º_šlše
 
štmax_t


324 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

325 
ba£
))

327  
	`__¡¹Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

328 
	}
}

330 
	$__¡¹oul_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

331 ** 
__»¡riù
 
__’d±r
,

332 
__ba£
, 
__group
)

333 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

335 
__ex‹º_šlše
 
uštmax_t


336 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

337 
ba£
))

339  
	`__¡¹oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

340 
	}
}

342 
	$__wc¡Ş_š‹º®
 (cÚ¡ 
__gwch¬_t
 * 
__»¡riù
 
__ÅŒ
,

343 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

344 
__ba£
, 
__group
)

345 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

347 
__ex‹º_šlše
 
štmax_t


348 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

349 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

351  
	`__wc¡Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

352 
	}
}

354 
	$__wc¡oul_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

355 
__»¡riù
 
__ÅŒ
,

356 
__gwch¬_t
 **

357 
__»¡riù
 
__’d±r
,

358 
__ba£
, 
__group
)

359 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

361 
__ex‹º_šlše
 
uštmax_t


362 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

363 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

365  
	`__wc¡oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

366 
	}
}

370 
__ex‹nsiÚ__


371 
	$__¡¹Şl_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

372 **
__»¡riù
 
__’d±r
,

373 
__ba£
, 
__group
)

374 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

376 
__ex‹º_šlše
 
štmax_t


377 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

378 
ba£
))

380  
	`__¡¹Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

381 
	}
}

383 
__ex‹nsiÚ__


384 
	$__¡¹ouÎ_š‹º®
 (const *

385 
__»¡riù
 
__ÅŒ
,

387 
__»¡riù
 
__’d±r
,

388 
__ba£
,

389 
__group
)

390 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

392 
__ex‹º_šlše
 
uštmax_t


393 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

394 
ba£
))

396  
	`__¡¹ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

397 
	}
}

399 
__ex‹nsiÚ__


400 
	$__wc¡Şl_š‹º®
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

401 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

402 
__ba£
, 
__group
)

403 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

405 
__ex‹º_šlše
 
štmax_t


406 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

407 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

409  
	`__wc¡Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

410 
	}
}

413 
__ex‹nsiÚ__


414 
	$__wc¡ouÎ_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

415 
__»¡riù
 
__ÅŒ
,

416 
__gwch¬_t
 **

417 
__»¡riù
 
__’d±r
,

418 
__ba£
,

419 
__group
)

420 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

422 
__ex‹º_šlše
 
uštmax_t


423 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

424 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

426  
	`__wc¡ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

427 
	}
}

432 
	g__END_DECLS


	@/usr/include/libunwind.h

4 #iâdeà
UNW_REMOTE_ONLY


6 #ià
defšed
 
__¯rch64__


7 
	~"libunwšd-¯rch64.h
"

8 #–ià
defšed
 
__¬m__


9 
	~"libunwšd-¬m.h
"

10 #–ià
defšed
 
__hµa__


11 
	~"libunwšd-hµa.h
"

12 #–ià
defšed
 
__Ÿ64__


13 
	~"libunwšd-Ÿ64.h
"

14 #–ià
defšed
 
__ms__


15 
	~"libunwšd-ms.h
"

16 #–ià
defšed
 
__pow”pc__
 && !defšed 
__pow”pc64__


17 
	~"libunwšd-µc32.h
"

18 #–ià
defšed
 
__pow”pc64__


19 
	~"libunwšd-µc64.h
"

20 #–ià
defšed
 
__sh__


21 
	~"libunwšd-sh.h
"

22 #–ià
defšed
 
__i386__


23 
	~"libunwšd-x86.h
"

24 #–ià
defšed
 
__x86_64__


25 
	~"libunwšd-x86_64.h
"

32 
	~"libunwšd-x86_64.h
"

	@/usr/include/limits.h

22 #iâdeà
_LIBC_LIMITS_H_


23 
	#_LIBC_LIMITS_H_
 1

	)

25 
	~<ã©u»s.h
>

31 
	#MB_LEN_MAX
 16

	)

36 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

41 #iâdeà
_LIMITS_H


42 
	#_LIMITS_H
 1

	)

44 
	~<b™s/wÜdsize.h
>

53 
	#CHAR_BIT
 8

	)

56 
	#SCHAR_MIN
 (-128)

	)

57 
	#SCHAR_MAX
 127

	)

60 
	#UCHAR_MAX
 255

	)

63 #ifdeà
__CHAR_UNSIGNED__


64 
	#CHAR_MIN
 0

	)

65 
	#CHAR_MAX
 
UCHAR_MAX


	)

67 
	#CHAR_MIN
 
SCHAR_MIN


	)

68 
	#CHAR_MAX
 
SCHAR_MAX


	)

72 
	#SHRT_MIN
 (-32768)

	)

73 
	#SHRT_MAX
 32767

	)

76 
	#USHRT_MAX
 65535

	)

79 
	#INT_MIN
 (-
INT_MAX
 - 1)

	)

80 
	#INT_MAX
 2147483647

	)

83 
	#UINT_MAX
 4294967295U

	)

86 #ià
__WORDSIZE
 == 64

87 
	#LONG_MAX
 9223372036854775807L

	)

89 
	#LONG_MAX
 2147483647L

	)

91 
	#LONG_MIN
 (-
LONG_MAX
 - 1L)

	)

94 #ià
__WORDSIZE
 == 64

95 
	#ULONG_MAX
 18446744073709551615UL

	)

97 
	#ULONG_MAX
 4294967295UL

	)

100 #ifdeà
__USE_ISOC99


103 
	#LLONG_MAX
 9223372036854775807LL

	)

104 
	#LLONG_MIN
 (-
LLONG_MAX
 - 1LL)

	)

107 
	#ULLONG_MAX
 18446744073709551615ULL

	)

121 #ià
defšed
 
__GNUC__
 && !defšed 
_GCC_LIMITS_H_


123 #šşude_Ãxˆ<
lim™s
.
h
>

129 #ià
defšed
 
__USE_ISOC99
 && defšed 
__GNUC__


130 #iâdeà
LLONG_MIN


131 
	#LLONG_MIN
 (-
LLONG_MAX
-1)

	)

133 #iâdeà
LLONG_MAX


134 
	#LLONG_MAX
 
__LONG_LONG_MAX__


	)

136 #iâdeà
ULLONG_MAX


137 
	#ULLONG_MAX
 (
LLONG_MAX
 * 2ULL + 1)

	)

141 #ifdef 
__USE_POSIX


143 
	~<b™s/posix1_lim.h
>

146 #ifdef 
__USE_POSIX2


147 
	~<b™s/posix2_lim.h
>

150 #ifdef 
__USE_XOPEN


151 
	~<b™s/xİ’_lim.h
>

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 263302

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@/usr/include/locale.h

22 #iâdef 
_LOCALE_H


23 
	#_LOCALE_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	#__Ãed_NULL


	)

28 
	~<¡ddef.h
>

29 
	~<b™s/loÿË.h
>

31 
	g__BEGIN_DECLS


35 
	#LC_CTYPE
 
__LC_CTYPE


	)

36 
	#LC_NUMERIC
 
__LC_NUMERIC


	)

37 
	#LC_TIME
 
__LC_TIME


	)

38 
	#LC_COLLATE
 
__LC_COLLATE


	)

39 
	#LC_MONETARY
 
__LC_MONETARY


	)

40 
	#LC_MESSAGES
 
__LC_MESSAGES


	)

41 
	#LC_ALL
 
__LC_ALL


	)

42 
	#LC_PAPER
 
__LC_PAPER


	)

43 
	#LC_NAME
 
__LC_NAME


	)

44 
	#LC_ADDRESS
 
__LC_ADDRESS


	)

45 
	#LC_TELEPHONE
 
__LC_TELEPHONE


	)

46 
	#LC_MEASUREMENT
 
__LC_MEASUREMENT


	)

47 
	#LC_IDENTIFICATION
 
__LC_IDENTIFICATION


	)

50 
__BEGIN_NAMESPACE_STD


53 
	slcÚv


57 *
	mdecim®_pošt
;

58 *
	mthou§nds_£p
;

64 *
	mgroupšg
;

70 *
	mšt_cu¼_symbŞ
;

71 *
	mcu¼’cy_symbŞ
;

72 *
	mmÚ_decim®_pošt
;

73 *
	mmÚ_thou§nds_£p
;

74 *
	mmÚ_groupšg
;

75 *
	mpos™ive_sign
;

76 *
	mÃg©ive_sign
;

77 
	mšt_äac_dig™s
;

78 
	mäac_dig™s
;

80 
	mp_cs_´eûdes
;

82 
	mp_£p_by_¥aû
;

84 
	mn_cs_´eûdes
;

86 
	mn_£p_by_¥aû
;

93 
	mp_sign_po¢
;

94 
	mn_sign_po¢
;

95 #ifdeà
__USE_ISOC99


97 
	mšt_p_cs_´eûdes
;

99 
	mšt_p_£p_by_¥aû
;

101 
	mšt_n_cs_´eûdes
;

103 
	mšt_n_£p_by_¥aû
;

110 
	mšt_p_sign_po¢
;

111 
	mšt_n_sign_po¢
;

113 
	m__št_p_cs_´eûdes
;

114 
	m__št_p_£p_by_¥aû
;

115 
	m__št_n_cs_´eûdes
;

116 
	m__št_n_£p_by_¥aû
;

117 
	m__št_p_sign_po¢
;

118 
	m__št_n_sign_po¢
;

124 *
	$£oÿË
 (
__ÿ‹gÜy
, cÚ¡ *
__loÿË
è
__THROW
;

127 
lcÚv
 *
	$loÿËcÚv
 (è
__THROW
;

129 
__END_NAMESPACE_STD


132 #ifdef 
__USE_XOPEN2K8


145 
	~<xloÿË.h
>

151 
__loÿË_t
 
	$ÃwloÿË
 (
__ÿ‹gÜy_mask
, cÚ¡ *
__loÿË
,

152 
__loÿË_t
 
__ba£
è
__THROW
;

158 
	#LC_CTYPE_MASK
 (1 << 
__LC_CTYPE
)

	)

159 
	#LC_NUMERIC_MASK
 (1 << 
__LC_NUMERIC
)

	)

160 
	#LC_TIME_MASK
 (1 << 
__LC_TIME
)

	)

161 
	#LC_COLLATE_MASK
 (1 << 
__LC_COLLATE
)

	)

162 
	#LC_MONETARY_MASK
 (1 << 
__LC_MONETARY
)

	)

163 
	#LC_MESSAGES_MASK
 (1 << 
__LC_MESSAGES
)

	)

164 
	#LC_PAPER_MASK
 (1 << 
__LC_PAPER
)

	)

165 
	#LC_NAME_MASK
 (1 << 
__LC_NAME
)

	)

166 
	#LC_ADDRESS_MASK
 (1 << 
__LC_ADDRESS
)

	)

167 
	#LC_TELEPHONE_MASK
 (1 << 
__LC_TELEPHONE
)

	)

168 
	#LC_MEASUREMENT_MASK
 (1 << 
__LC_MEASUREMENT
)

	)

169 
	#LC_IDENTIFICATION_MASK
 (1 << 
__LC_IDENTIFICATION
)

	)

170 
	#LC_ALL_MASK
 (
LC_CTYPE_MASK
 \

171 | 
LC_NUMERIC_MASK
 \

172 | 
LC_TIME_MASK
 \

173 | 
LC_COLLATE_MASK
 \

174 | 
LC_MONETARY_MASK
 \

175 | 
LC_MESSAGES_MASK
 \

176 | 
LC_PAPER_MASK
 \

177 | 
LC_NAME_MASK
 \

178 | 
LC_ADDRESS_MASK
 \

179 | 
LC_TELEPHONE_MASK
 \

180 | 
LC_MEASUREMENT_MASK
 \

181 | 
LC_IDENTIFICATION_MASK
 \

182 )

	)

186 
__loÿË_t
 
	$du¶oÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

190 
	$ä“loÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

197 
__loÿË_t
 
	$u£loÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

201 
	#LC_GLOBAL_LOCALE
 ((
__loÿË_t
è-1L)

	)

205 
__END_DECLS


	@/usr/include/malloc.h

19 #iâdeà
_MALLOC_H


20 
	#_MALLOC_H
 1

	)

22 
	~<ã©u»s.h
>

23 
	~<¡ddef.h
>

24 
	~<¡dio.h
>

26 #ifdeà
_LIBC


27 
	#__MALLOC_HOOK_VOLATILE


	)

28 
	#__MALLOC_DEPRECATED


	)

30 
	#__MALLOC_HOOK_VOLATILE
 vŞ©e

	)

31 
	#__MALLOC_DEPRECATED
 
__©Œibu‹_d•»ÿ‹d__


	)

35 
__BEGIN_DECLS


38 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

41 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

42 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

49 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

50 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

53 
	$ä“
 (*
__±r
è
__THROW
;

56 
	$cä“
 (*
__±r
è
__THROW
;

59 *
	$mem®ign
 (
size_t
 
__®ignm’t
, size_ˆ
__size
)

60 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

63 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

67 *
	$pv®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

71 *(*
__mÜecÜe
è(
±rdiff_t
 
__size
);

74 *
	$__deçuÉ_mÜecÜe
 (
±rdiff_t
 
__size
)

75 
__THROW
 
__©Œibu‹_m®loc__
;

79 
	sm®lšfo


81 
¬’a
;

82 
Üdblks
;

83 
smblks
;

84 
hblks
;

85 
hblkhd
;

86 
usmblks
;

87 
fsmblks
;

88 
uÜdblks
;

89 
fÜdblks
;

90 
k“pco¡
;

94 
m®lšfo
 
	$m®lšfo
 (è
__THROW
;

97 #iâdeà
M_MXFAST


98 
	#M_MXFAST
 1

	)

100 #iâdeà
M_NLBLKS


101 
	#M_NLBLKS
 2

	)

103 #iâdeà
M_GRAIN


104 
	#M_GRAIN
 3

	)

106 #iâdeà
M_KEEP


107 
	#M_KEEP
 4

	)

111 
	#M_TRIM_THRESHOLD
 -1

	)

112 
	#M_TOP_PAD
 -2

	)

113 
	#M_MMAP_THRESHOLD
 -3

	)

114 
	#M_MMAP_MAX
 -4

	)

115 
	#M_CHECK_ACTION
 -5

	)

116 
	#M_PERTURB
 -6

	)

117 
	#M_ARENA_TEST
 -7

	)

118 
	#M_ARENA_MAX
 -8

	)

121 
	$m®lİt
 (
__·¿m
, 
__v®
è
__THROW
;

125 
	$m®loc_Œim
 (
size_t
 
__·d
è
__THROW
;

129 
size_t
 
	$m®loc_u§bË_size
 (*
__±r
è
__THROW
;

132 
	$m®loc_¡©s
 (è
__THROW
;

135 
	$m®loc_šfo
 (
__İtiÚs
, 
FILE
 *
__å
è
__THROW
;

138 *
	$m®loc_g‘_¡©e
 (è
__THROW
;

142 
	$m®loc_£t_¡©e
 (*
__±r
è
__THROW
;

147 (*
__MALLOC_HOOK_VOLATILE
 
__m®loc_š™Ÿlize_hook
) ()

148 
__MALLOC_DEPRECATED
;

150 (*
__MALLOC_HOOK_VOLATILE
 
__ä“_hook
è(*
__±r
,

152 
__MALLOC_DEPRECATED
;

153 *(*
__MALLOC_HOOK_VOLATILE
 
__m®loc_hook
)(
size_t
 
__size
,

155 
__MALLOC_DEPRECATED
;

156 *(*
__MALLOC_HOOK_VOLATILE
 
__»®loc_hook
)(*
__±r
,

157 
size_t
 
__size
,

159 
__MALLOC_DEPRECATED
;

160 *(*
__MALLOC_HOOK_VOLATILE
 
__mem®ign_hook
)(
size_t
 
__®ignm’t
,

161 
size_t
 
__size
,

163 
__MALLOC_DEPRECATED
;

164 (*
__MALLOC_HOOK_VOLATILE
 
__aá”_mÜecÜe_hook
) ();

167 
	$__m®loc_check_š™
 (è
__THROW
 
__MALLOC_DEPRECATED
;

170 
__END_DECLS


	@/usr/include/math.h

23 #iâdef 
_MATH_H


24 
	#_MATH_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


31 
	~<b™s/m©h-veùÜ.h
>

35 
	~<b™s/huge_v®.h
>

36 #ifdeà
__USE_ISOC99


37 
	~<b™s/huge_v®f.h
>

38 
	~<b™s/huge_v®l.h
>

41 
	~<b™s/šf.h
>

44 
	~<b™s/Çn.h
>

48 
	~<b™s/m©hdef.h
>

55 
	#__SIMD_DECL
(
funùiÚ
è
	`__CONCAT
 (
__DECL_SIMD_
, funùiÚ)

	)

57 
	#__MATHCALL_VEC
(
funùiÚ
, 
suffix
, 
¬gs
) \

58 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
funùiÚ
, 
suffix
)) \

59 
	`__MATHCALL
 (
funùiÚ
, 
suffix
, 
¬gs
)

	)

61 
	#__MATHDECL_VEC
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

62 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
funùiÚ
, 
suffix
)) \

63 
	`__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
)

	)

65 
	#__MATHCALL
(
funùiÚ
,
suffix
, 
¬gs
) \

66 
	`__MATHDECL
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
)

	)

67 
	#__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

68 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
); \

69 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
)

	)

70 
	#__MATHCALLX
(
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

71 
	`__MATHDECLX
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
)

	)

72 
	#__MATHDECLX
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

73 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
); \

74 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
)

	)

75 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

76 
ty³
 
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
è
¬gs
 
__THROW


	)

78 
	#_MdoubË_
 

	)

79 
	#__MATH_PRECNAME
(
Çme
,
r
è
	`__CONCAT
Òame,r)

	)

80 
	#__MATH_DECLARING_DOUBLE
 1

	)

81 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_STD


	)

82 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_STD


	)

83 
	~<b™s/m©hÿÎs.h
>

84 #undeà
_MdoubË_


85 #undeà
_MdoubË_BEGIN_NAMESPACE


86 #undeà
_MdoubË_END_NAMESPACE


87 #undeà
__MATH_PRECNAME


88 #undeà
__MATH_DECLARING_DOUBLE


90 #ifdeà
__USE_ISOC99


96 #iâdeà
_Mæßt_


97 
	#_Mæßt_
 

	)

99 
	#_MdoubË_
 
_Mæßt_


	)

100 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f
##
	)
r

101 
	#__MATH_DECLARING_DOUBLE
 0

	)

102 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

103 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

104 
	~<b™s/m©hÿÎs.h
>

105 #undeà
_MdoubË_


106 #undeà
_MdoubË_BEGIN_NAMESPACE


107 #undeà
_MdoubË_END_NAMESPACE


108 #undeà
__MATH_PRECNAME


109 #undeà
__MATH_DECLARING_DOUBLE


111 #ià!(
defšed
 
__NO_LONG_DOUBLE_MATH
 && defšed 
_LIBC
) \

112 || 
defšed
 
__LDBL_COMPAT
 \

113 || 
defšed
 
_LIBC_TEST


114 #ifdeà
__LDBL_COMPAT


116 #ifdeà
__USE_ISOC99


117 
	$__Ædbl_Ãx‰ow¬df
 (
__x
, 
__y
)

118 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

119 #ifdeà
__REDIRECT_NTH


120 
	`__REDIRECT_NTH
 (
Ãx‰ow¬df
, (
__x
, 
__y
),

121 
__Ædbl_Ãx‰ow¬df
)

122 
	`__©Œibu‹__
 ((
__cÚ¡__
));

123 
	`__REDIRECT_NTH
 (
Ãx‰ow¬d
, (
__x
, 
__y
),

124 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

125 
	`__REDIRECT_NTH
 (
Ãx‰ow¬dl
,

126 (
__x
, 
__y
),

127 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

131 #undeà
__MATHDECL_1


132 
	#__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
®Ÿs
) \

133 
ty³
 
	`__REDIRECT_NTH
(
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
), \

134 
¬gs
, 
®Ÿs
)

	)

135 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

136 
	`__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
	`__CONCAT
(funùiÚ,suffix))

	)

142 #iâdeà
_MlÚg_doubË_


143 
	#_MlÚg_doubË_
 

	)

145 
	#_MdoubË_
 
_MlÚg_doubË_


	)

146 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
l
##
	)
r

147 
	#__MATH_DECLARING_DOUBLE
 0

	)

148 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

149 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

150 
	#__MATH_DECLARE_LDOUBLE
 1

	)

151 
	~<b™s/m©hÿÎs.h
>

152 #undeà
_MdoubË_


153 #undeà
_MdoubË_BEGIN_NAMESPACE


154 #undeà
_MdoubË_END_NAMESPACE


155 #undeà
__MATH_PRECNAME


156 #undeà
__MATH_DECLARING_DOUBLE


161 #undeà
__MATHDECL_1


162 #undeà
__MATHDECL


163 #undeà
__MATHCALL


166 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


168 
signgam
;

173 #ifdeà
__USE_ISOC99


211 
FP_NAN
 =

212 
	#FP_NAN
 0

	)

213 
FP_NAN
,

214 
FP_INFINITE
 =

215 
	#FP_INFINITE
 1

	)

216 
FP_INFINITE
,

217 
FP_ZERO
 =

218 
	#FP_ZERO
 2

	)

219 
FP_ZERO
,

220 
FP_SUBNORMAL
 =

221 
	#FP_SUBNORMAL
 3

	)

222 
FP_SUBNORMAL
,

223 
FP_NORMAL
 =

224 
	#FP_NORMAL
 4

	)

225 
FP_NORMAL


233 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__
 \

234 && !
defšed
 
__OPTIMIZE_SIZE__


235 
	#åşassify
(
x
è
	`__butš_åşassify
 (
FP_NAN
, 
FP_INFINITE
, \

236 
FP_NORMAL
, 
FP_SUBNORMAL
, 
FP_ZERO
, 
x
)

	)

237 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


238 
	#åşassify
(
x
) \

239 ( (
x
è=ğ (è? 
	`__åşassifyf
 (xè: 
	`__åşassify
 (x))

	)

241 
	#åşassify
(
x
) \

242 ( (
x
) ==  () \

243 ? 
	`__åşassifyf
 (
x
) \

244 :  (
x
) ==  () \

245 ? 
	`__åşassify
 (
x
è: 
	`__åşassifyl
 (x))

	)

249 #ià
	`__GNUC_PREREQ
 (4,0)

250 
	#signb™
(
x
) \

251 ( (
x
) ==  () \

252 ? 
	`__butš_signb™f
 (
x
) \

253 :  (
x
) ==  () \

254 ? 
	`__butš_signb™
 (
x
è: 
	`__butš_signb™l
 (x))

	)

256 #ifdeà
__NO_LONG_DOUBLE_MATH


257 
	#signb™
(
x
) \

258 ( (
x
è=ğ (è? 
	`__signb™f
 (xè: 
	`__signb™
 (x))

	)

260 
	#signb™
(
x
) \

261 ( (
x
) ==  () \

262 ? 
	`__signb™f
 (
x
) \

263 :  (
x
) ==  () \

264 ? 
	`__signb™
 (
x
è: 
	`__signb™l
 (x))

	)

269 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


270 
	#isfš™e
(
x
è
	`__butš_isfš™e
 (x)

	)

271 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


272 
	#isfš™e
(
x
) \

273 ( (
x
è=ğ (è? 
	`__fš™ef
 (xè: 
	`__fš™e
 (x))

	)

275 
	#isfš™e
(
x
) \

276 ( (
x
) ==  () \

277 ? 
	`__fš™ef
 (
x
) \

278 :  (
x
) ==  () \

279 ? 
	`__fš™e
 (
x
è: 
	`__fš™–
 (x))

	)

283 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


284 
	#i¢Üm®
(
x
è
	`__butš_i¢Üm®
 (x)

	)

286 
	#i¢Üm®
(
x
è(
	`åşassify
 (xè=ğ
FP_NORMAL
)

	)

291 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


292 
	#i¢ª
(
x
è
	`__butš_i¢ª
 (x)

	)

293 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


294 
	#i¢ª
(
x
) \

295 ( (
x
è=ğ (è? 
	`__i¢ªf
 (xè: 
	`__i¢ª
 (x))

	)

297 
	#i¢ª
(
x
) \

298 ( (
x
) ==  () \

299 ? 
	`__i¢ªf
 (
x
) \

300 :  (
x
) ==  () \

301 ? 
	`__i¢ª
 (
x
è: 
	`__i¢ªl
 (x))

	)

305 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


306 
	#isšf
(
x
è
	`__butš_isšf_sign
 (x)

	)

307 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


308 
	#isšf
(
x
) \

309 ( (
x
è=ğ (è? 
	`__isšff
 (xè: 
	`__isšf
 (x))

	)

311 
	#isšf
(
x
) \

312 ( (
x
) ==  () \

313 ? 
	`__isšff
 (
x
) \

314 :  (
x
) ==  () \

315 ? 
	`__isšf
 (
x
è: 
	`__isšæ
 (x))

	)

319 
	#MATH_ERRNO
 1

	)

320 
	#MATH_ERREXCEPT
 2

	)

325 #iâdeà
__FAST_MATH__


326 
	#m©h_”rhªdlšg
 (
MATH_ERRNO
 | 
MATH_ERREXCEPT
)

	)

331 #ifdeà
__USE_GNU


333 #ifdeà
__NO_LONG_DOUBLE_MATH


334 
	#issigÇlšg
(
x
) \

335 ( (
x
è=ğ (è? 
	`__issigÇlšgf
 (xè: 
	`__issigÇlšg
 (x))

	)

337 
	#issigÇlšg
(
x
) \

338 ( (
x
) ==  () \

339 ? 
	`__issigÇlšgf
 (
x
) \

340 :  (
x
) ==  () \

341 ? 
	`__issigÇlšg
 (
x
è: 
	`__issigÇlšgl
 (x))

	)

345 #ifdef 
__USE_MISC


349 
_IEEE_
 = -1,

350 
_SVID_
,

351 
_XOPEN_
,

352 
_POSIX_
,

353 
_ISOC_


354 } 
	t_LIB_VERSION_TYPE
;

359 
_LIB_VERSION_TYPE
 
_LIB_VERSION
;

363 #ifdeà
__USE_MISC


369 #ifdeà
__ılu¥lus


370 
__exû±iÚ


372 
exû±iÚ


375 
ty³
;

376 *
Çme
;

377 
¬g1
;

378 
¬g2
;

379 
»tv®
;

380 
	}
};

382 #ifdeà
__ılu¥lus


383 
	$m©h”r
 (
__exû±iÚ
 *
__exc
è
	`throw
 ();

385 
	`m©h”r
 (
exû±iÚ
 *
__exc
);

388 
	#X_TLOSS
 1.41484755040568800000e+16

	)

391 
	#DOMAIN
 1

	)

392 
	#SING
 2

	)

393 
	#OVERFLOW
 3

	)

394 
	#UNDERFLOW
 4

	)

395 
	#TLOSS
 5

	)

396 
	#PLOSS
 6

	)

399 
	#HUGE
 3.40282347e+38F

	)

403 #ifdeà
__USE_XOPEN


405 
	#MAXFLOAT
 3.40282347e+38F

	)

412 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


413 
	#M_E
 2.7182818284590452354

	)

414 
	#M_LOG2E
 1.4426950408889634074

	)

415 
	#M_LOG10E
 0.43429448190325182765

	)

416 
	#M_LN2
 0.69314718055994530942

	)

417 
	#M_LN10
 2.30258509299404568402

	)

418 
	#M_PI
 3.14159265358979323846

	)

419 
	#M_PI_2
 1.57079632679489661923

	)

420 
	#M_PI_4
 0.78539816339744830962

	)

421 
	#M_1_PI
 0.31830988618379067154

	)

422 
	#M_2_PI
 0.63661977236758134308

	)

423 
	#M_2_SQRTPI
 1.12837916709551257390

	)

424 
	#M_SQRT2
 1.41421356237309504880

	)

425 
	#M_SQRT1_2
 0.70710678118654752440

	)

431 #ifdeà
__USE_GNU


432 
	#M_El
 2.718281828459045235360287471352662498L

	)

433 
	#M_LOG2El
 1.442695040888963407359924681001892137L

	)

434 
	#M_LOG10El
 0.434294481903251827651128918916605082L

	)

435 
	#M_LN2l
 0.693147180559945309417232121458176568L

	)

436 
	#M_LN10l
 2.302585092994045684017991454684364208L

	)

437 
	#M_PIl
 3.141592653589793238462643383279502884L

	)

438 
	#M_PI_2l
 1.570796326794896619231321691639751442L

	)

439 
	#M_PI_4l
 0.785398163397448309615660845819875721L

	)

440 
	#M_1_PIl
 0.318309886183790671537767526745028724L

	)

441 
	#M_2_PIl
 0.636619772367581343075535053490057448L

	)

442 
	#M_2_SQRTPIl
 1.128379167095512573896158903121545172L

	)

443 
	#M_SQRT2l
 1.414213562373095048801688724209698079L

	)

444 
	#M_SQRT1_2l
 0.707106781186547524400844362104849039L

	)

451 #ià
defšed
 
__STRICT_ANSI__
 && !defšed 
__NO_MATH_INLINES


452 
	#__NO_MATH_INLINES
 1

	)

455 #ià
defšed
 
__USE_ISOC99
 && 
	`__GNUC_PREREQ
(2,97)

462 
	#isg»©”
(
x
, 
y
è
	`__butš_isg»©”
(x, y)

	)

463 
	#isg»©”equ®
(
x
, 
y
è
	`__butš_isg»©”equ®
(x, y)

	)

464 
	#i¦ess
(
x
, 
y
è
	`__butš_i¦ess
(x, y)

	)

465 
	#i¦es£qu®
(
x
, 
y
è
	`__butš_i¦es£qu®
(x, y)

	)

466 
	#i¦essg»©”
(
x
, 
y
è
	`__butš_i¦essg»©”
(x, y)

	)

467 
	#isunÜd”ed
(
u
, 
v
è
	`__butš_isunÜd”ed
(u, v)

	)

471 #ifdeà
__USE_EXTERN_INLINES


472 
	~<b™s/m©hšlše.h
>

477 #ià
defšed
 
__FINITE_MATH_ONLY__
 && __FINITE_MATH_ONLY__ > 0

478 
	~<b™s/m©h-fš™e.h
>

481 #ifdeà
__USE_ISOC99


485 #iâdeà
isg»©”


486 
	#isg»©”
(
x
, 
y
) \

487 (
__ex‹nsiÚ__
 \

488 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

489 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x > __y; 
	}
}))

	)

493 #iâdeà
isg»©”equ®


494 
	#isg»©”equ®
(
x
, 
y
) \

495 (
__ex‹nsiÚ__
 \

496 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

497 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x >ğ__y; }))

	)

501 #iâdeà
i¦ess


502 
	#i¦ess
(
x
, 
y
) \

503 (
__ex‹nsiÚ__
 \

504 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

505 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x < __y; }))

	)

509 #iâdeà
i¦es£qu®


510 
	#i¦es£qu®
(
x
, 
y
) \

511 (
__ex‹nsiÚ__
 \

512 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

513 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x <ğ__y; }))

	)

517 #iâdeà
i¦essg»©”


518 
	#i¦essg»©”
(
x
, 
y
) \

519 (
__ex‹nsiÚ__
 \

520 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

521 !
	`isunÜd”ed
 (
__x
, 
__y
è&& (__x < __y || __y < __x); }))

	)

525 #iâdeà
isunÜd”ed


526 
	#isunÜd”ed
(
u
, 
v
) \

527 (
__ex‹nsiÚ__
 \

528 ({ 
	`__ty³of__
(
u
è
__u
 = (u); __ty³of__(
v
è
__v
 = (v); \

529 
	`åşassify
 (
__u
è=ğ
FP_NAN
 || fpşassify (
__v
è=ğFP_NAN; }))

	)

534 
	g__END_DECLS


	@/usr/include/netdb.h

22 #iâdef 
_NETDB_H


23 
	#_NETDB_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<Ãtš‘/š.h
>

28 
	~<¡dšt.h
>

29 #ifdeà
__USE_MISC


32 
	~<½c/Ãtdb.h
>

35 #ifdeà
__USE_GNU


36 
	#__Ãed_sigev’t_t


	)

37 
	~<b™s/sigšfo.h
>

38 
	#__Ãed_time¥ec


	)

39 
	~<time.h
>

42 
	~<b™s/Ãtdb.h
>

45 
	#_PATH_HEQUIV
 "/‘c/ho¡s.equiv"

	)

46 
	#_PATH_HOSTS
 "/‘c/ho¡s"

	)

47 
	#_PATH_NETWORKS
 "/‘c/ÃtwÜks"

	)

48 
	#_PATH_NSSWITCH_CONF
 "/‘c/nssw™ch.cÚf"

	)

49 
	#_PATH_PROTOCOLS
 "/‘c/´ÙocŞs"

	)

50 
	#_PATH_SERVICES
 "/‘c/£rviûs"

	)

53 
	g__BEGIN_DECLS


55 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


58 
	#h_”ºo
 (*
	`__h_”ºo_loÿtiÚ
 ())

	)

61 *
	$__h_”ºo_loÿtiÚ
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

65 
	#HOST_NOT_FOUND
 1

	)

66 
	#TRY_AGAIN
 2

	)

68 
	#NO_RECOVERY
 3

	)

70 
	#NO_DATA
 4

	)

73 #ifdeà
__USE_MISC


74 
	#NETDB_INTERNAL
 -1

	)

75 
	#NETDB_SUCCESS
 0

	)

76 
	#NO_ADDRESS
 
NO_DATA


	)

79 #ià
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_XOPEN_EXTENDED


81 
	#IPPORT_RESERVED
 1024

	)

84 #ifdeà
__USE_GNU


86 
	#SCOPE_DELIMITER
 '%'

	)

89 #ifdeà
__USE_MISC


92 
	$h”rÜ
 (cÚ¡ *
__¡r
è
__THROW
;

95 cÚ¡ *
	$h¡»¼Ü
 (
__”r_num
è
__THROW
;

100 
	sho¡’t


102 *
h_Çme
;

103 **
h_®Ÿ£s
;

104 
h_add¹y³
;

105 
h_Ëngth
;

106 **
h_addr_li¡
;

107 #ifdeà
__USE_MISC


108 
	#h_addr
 
h_addr_li¡
[0]

	)

117 
	`£tho¡’t
 (
__¡ay_İ’
);

123 
	`’dho¡’t
 ();

130 
ho¡’t
 *
	`g‘ho¡’t
 ();

137 
ho¡’t
 *
	`g‘ho¡byaddr
 (cÚ¡ *
__addr
, 
__sockËn_t
 
__Ën
,

138 
__ty³
);

144 
ho¡’t
 *
	`g‘ho¡byÇme
 (cÚ¡ *
__Çme
);

146 #ifdeà
__USE_MISC


155 
ho¡’t
 *
	`g‘ho¡byÇme2
 (cÚ¡ *
__Çme
, 
__af
);

167 
	`g‘ho¡’t_r
 (
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

168 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

169 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

170 *
__»¡riù
 
__h_”ºİ
);

172 
	`g‘ho¡byaddr_r
 (cÚ¡ *
__»¡riù
 
__addr
, 
__sockËn_t
 
__Ën
,

173 
__ty³
,

174 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

175 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

176 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

177 *
__»¡riù
 
__h_”ºİ
);

179 
	`g‘ho¡byÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

180 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

181 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

182 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

183 *
__»¡riù
 
__h_”ºİ
);

185 
	`g‘ho¡byÇme2_r
 (cÚ¡ *
__»¡riù
 
__Çme
, 
__af
,

186 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

187 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

188 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

189 *
__»¡riù
 
__h_”ºİ
);

198 
	`£Š‘’t
 (
__¡ay_İ’
);

204 
	`’dÃ‹Á
 ();

211 
Ã‹Á
 *
	`g‘Ã‹Á
 ();

218 
Ã‹Á
 *
	`g‘Ãtbyaddr
 (
ušt32_t
 
__Ãt
, 
__ty³
);

224 
Ã‹Á
 *
	`g‘ÃtbyÇme
 (cÚ¡ *
__Çme
);

226 #ifdef 
__USE_MISC


237 
	`g‘Ã‹Á_r
 (
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

238 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

239 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

240 *
__»¡riù
 
__h_”ºİ
);

242 
	`g‘Ãtbyaddr_r
 (
ušt32_t
 
__Ãt
, 
__ty³
,

243 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

244 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

245 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

246 *
__»¡riù
 
__h_”ºİ
);

248 
	`g‘ÃtbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

249 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

250 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

251 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

252 *
__»¡riù
 
__h_”ºİ
);

257 
	s£rv’t


259 *
s_Çme
;

260 **
s_®Ÿ£s
;

261 
s_pÜt
;

262 *
s_´Ùo
;

270 
	`£t£rv’t
 (
__¡ay_İ’
);

276 
	`’d£rv’t
 ();

283 
£rv’t
 *
	`g‘£rv’t
 ();

290 
£rv’t
 *
	`g‘£rvbyÇme
 (cÚ¡ *
__Çme
, cÚ¡ *
__´Ùo
);

297 
£rv’t
 *
	`g‘£rvbypÜt
 (
__pÜt
, cÚ¡ *
__´Ùo
);

300 #ifdef 
__USE_MISC


308 
	`g‘£rv’t_r
 (
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

309 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

310 
£rv’t
 **
__»¡riù
 
__»suÉ
);

312 
	`g‘£rvbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

313 cÚ¡ *
__»¡riù
 
__´Ùo
,

314 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

315 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

316 
£rv’t
 **
__»¡riù
 
__»suÉ
);

318 
	`g‘£rvbypÜt_r
 (
__pÜt
, cÚ¡ *
__»¡riù
 
__´Ùo
,

319 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

320 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

321 
£rv’t
 **
__»¡riù
 
__»suÉ
);

326 
	s´ÙÛÁ


328 *
p_Çme
;

329 **
p_®Ÿ£s
;

330 
p_´Ùo
;

338 
	`£rÙÛÁ
 (
__¡ay_İ’
);

344 
	`’d´ÙÛÁ
 ();

351 
´ÙÛÁ
 *
	`g‘´ÙÛÁ
 ();

357 
´ÙÛÁ
 *
	`g‘´ÙobyÇme
 (cÚ¡ *
__Çme
);

363 
´ÙÛÁ
 *
	`g‘´Ùobynumb”
 (
__´Ùo
);

366 #ifdef 
__USE_MISC


374 
	`g‘´ÙÛÁ_r
 (
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

375 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

376 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

378 
	`g‘´ÙobyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

379 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

380 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

381 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

383 
	`g‘´Ùobynumb”_r
 (
__´Ùo
,

384 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

385 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

386 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

395 
	`£Š‘g»Á
 (cÚ¡ *
__Ãtgroup
);

403 
	`’dÃtg»Á
 ();

412 
	`g‘Ãtg»Á
 (**
__»¡riù
 
__ho¡p
,

413 **
__»¡riù
 
__u£½
,

414 **
__»¡riù
 
__domašp
);

423 
	`šÃtgr
 (cÚ¡ *
__Ãtgroup
, cÚ¡ *
__ho¡
,

424 cÚ¡ *
__u£r
, cÚ¡ *
__domaš
);

432 
	`g‘Ãtg»Á_r
 (**
__»¡riù
 
__ho¡p
,

433 **
__»¡riù
 
__u£½
,

434 **
__»¡riù
 
__domašp
,

435 *
__»¡riù
 
__bufãr
, 
size_t
 
__buæ’
);

439 #ifdeà
__USE_MISC


451 
	`rcmd
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

452 cÚ¡ *
__»¡riù
 
__locu£r
,

453 cÚ¡ *
__»¡riù
 
__»mu£r
,

454 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

463 
	`rcmd_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

464 cÚ¡ *
__»¡riù
 
__locu£r
,

465 cÚ¡ *
__»¡riù
 
__»mu£r
,

466 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

467 
§_çmy_t
 
__af
);

479 
	`»xec
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

480 cÚ¡ *
__»¡riù
 
__Çme
,

481 cÚ¡ *
__»¡riù
 
__·ss
,

482 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

491 
	`»xec_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

492 cÚ¡ *
__»¡riù
 
__Çme
,

493 cÚ¡ *
__»¡riù
 
__·ss
,

494 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

495 
§_çmy_t
 
__af
);

505 
	`ru£rok
 (cÚ¡ *
__rho¡
, 
__su£r
,

506 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

515 
	`ru£rok_af
 (cÚ¡ *
__rho¡
, 
__su£r
,

516 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

517 
§_çmy_t
 
__af
);

528 
	`œu£rok
 (
ušt32_t
 
__¿ddr
, 
__su£r
,

529 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

539 
	`œu£rok_af
 (cÚ¡ *
__¿ddr
, 
__su£r
,

540 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

541 
§_çmy_t
 
__af
);

551 
	`¼esvpÜt
 (*
__®pÜt
);

560 
	`¼esvpÜt_af
 (*
__®pÜt
, 
§_çmy_t
 
__af
);

565 #ifdeà
__USE_XOPEN2K


567 
	saddršfo


569 
ai_æags
;

570 
ai_çmy
;

571 
ai_sockty³
;

572 
ai_´ÙocŞ
;

573 
sockËn_t
 
ai_add¾’
;

574 
sockaddr
 *
ai_addr
;

575 *
ai_ÿnÚÇme
;

576 
addršfo
 *
ai_Ãxt
;

579 #ifdeà
__USE_GNU


581 
	sgaicb


583 cÚ¡ *
¬_Çme
;

584 cÚ¡ *
¬_£rviû
;

585 cÚ¡ 
addršfo
 *
¬_»que¡
;

586 
addršfo
 *
¬_»suÉ
;

588 
__»tuº
;

589 
__glibc_»£rved
[5];

593 
	#GAI_WAIT
 0

	)

594 
	#GAI_NOWAIT
 1

	)

598 
	#AI_PASSIVE
 0x0001

	)

599 
	#AI_CANONNAME
 0x0002

	)

600 
	#AI_NUMERICHOST
 0x0004

	)

601 
	#AI_V4MAPPED
 0x0008

	)

602 
	#AI_ALL
 0x0010

	)

603 
	#AI_ADDRCONFIG
 0x0020

	)

605 #ifdeà
__USE_GNU


606 
	#AI_IDN
 0x0040

	)

609 
	#AI_CANONIDN
 0x0080

	)

610 
	#AI_IDN_ALLOW_UNASSIGNED
 0x0100

	)

612 
	#AI_IDN_USE_STD3_ASCII_RULES
 0x0200

	)

615 
	#AI_NUMERICSERV
 0x0400

	)

618 
	#EAI_BADFLAGS
 -1

	)

619 
	#EAI_NONAME
 -2

	)

620 
	#EAI_AGAIN
 -3

	)

621 
	#EAI_FAIL
 -4

	)

622 
	#EAI_FAMILY
 -6

	)

623 
	#EAI_SOCKTYPE
 -7

	)

624 
	#EAI_SERVICE
 -8

	)

625 
	#EAI_MEMORY
 -10

	)

626 
	#EAI_SYSTEM
 -11

	)

627 
	#EAI_OVERFLOW
 -12

	)

628 #ifdeà
__USE_GNU


629 
	#EAI_NODATA
 -5

	)

630 
	#EAI_ADDRFAMILY
 -9

	)

631 
	#EAI_INPROGRESS
 -100

	)

632 
	#EAI_CANCELED
 -101

	)

633 
	#EAI_NOTCANCELED
 -102

	)

634 
	#EAI_ALLDONE
 -103

	)

635 
	#EAI_INTR
 -104

	)

636 
	#EAI_IDN_ENCODE
 -105

	)

639 #ifdeà
__USE_MISC


640 
	#NI_MAXHOST
 1025

	)

641 
	#NI_MAXSERV
 32

	)

644 
	#NI_NUMERICHOST
 1

	)

645 
	#NI_NUMERICSERV
 2

	)

646 
	#NI_NOFQDN
 4

	)

647 
	#NI_NAMEREQD
 8

	)

648 
	#NI_DGRAM
 16

	)

649 #ifdeà
__USE_GNU


650 
	#NI_IDN
 32

	)

651 
	#NI_IDN_ALLOW_UNASSIGNED
 64

	)

653 
	#NI_IDN_USE_STD3_ASCII_RULES
 128

	)

662 
	`g‘addršfo
 (cÚ¡ *
__»¡riù
 
__Çme
,

663 cÚ¡ *
__»¡riù
 
__£rviû
,

664 cÚ¡ 
addršfo
 *
__»¡riù
 
__»q
,

665 
addršfo
 **
__»¡riù
 
__·i
);

668 
	$ä“addršfo
 (
addršfo
 *
__ai
è
__THROW
;

671 cÚ¡ *
	$gai_¡»¼Ü
 (
__ecode
è
__THROW
;

677 
	`g‘Çmešfo
 (cÚ¡ 
sockaddr
 *
__»¡riù
 
__§
,

678 
sockËn_t
 
__§Ën
, *
__»¡riù
 
__ho¡
,

679 
sockËn_t
 
__ho¡Ën
, *
__»¡riù
 
__£rv
,

680 
sockËn_t
 
__£rvËn
, 
__æags
);

683 #ifdeà
__USE_GNU


692 
	`g‘addršfo_a
 (
__mode
, 
gaicb
 *
__li¡
[
__»¡riù_¬r
],

693 
__’t
, 
sigev’t
 *
__»¡riù
 
__sig
);

703 
	`gai_su¥’d
 (cÚ¡ 
gaicb
 *cÚ¡ 
__li¡
[], 
__’t
,

704 cÚ¡ 
time¥ec
 *
__timeout
);

707 
	$gai_”rÜ
 (
gaicb
 *
__»q
è
__THROW
;

710 
	$gai_ÿnûl
 (
gaicb
 *
__gaicbp
è
__THROW
;

713 
__END_DECLS


	@/usr/include/netinet/in.h

18 #iâdef 
_NETINET_IN_H


19 
	#_NETINET_IN_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<¡dšt.h
>

23 
	~<sys/sock‘.h
>

24 
	~<b™s/ty³s.h
>

27 
__BEGIN_DECLS


30 
ušt32_t
 
	tš_addr_t
;

31 
	sš_addr


33 
š_addr_t
 
	ms_addr
;

37 
	~<b™s/š.h
>

42 
	mIPPROTO_IP
 = 0,

43 
	#IPPROTO_IP
 
IPPROTO_IP


	)

44 
	mIPPROTO_ICMP
 = 1,

45 
	#IPPROTO_ICMP
 
IPPROTO_ICMP


	)

46 
	mIPPROTO_IGMP
 = 2,

47 
	#IPPROTO_IGMP
 
IPPROTO_IGMP


	)

48 
	mIPPROTO_IPIP
 = 4,

49 
	#IPPROTO_IPIP
 
IPPROTO_IPIP


	)

50 
	mIPPROTO_TCP
 = 6,

51 
	#IPPROTO_TCP
 
IPPROTO_TCP


	)

52 
	mIPPROTO_EGP
 = 8,

53 
	#IPPROTO_EGP
 
IPPROTO_EGP


	)

54 
	mIPPROTO_PUP
 = 12,

55 
	#IPPROTO_PUP
 
IPPROTO_PUP


	)

56 
	mIPPROTO_UDP
 = 17,

57 
	#IPPROTO_UDP
 
IPPROTO_UDP


	)

58 
	mIPPROTO_IDP
 = 22,

59 
	#IPPROTO_IDP
 
IPPROTO_IDP


	)

60 
	mIPPROTO_TP
 = 29,

61 
	#IPPROTO_TP
 
IPPROTO_TP


	)

62 
	mIPPROTO_DCCP
 = 33,

63 
	#IPPROTO_DCCP
 
IPPROTO_DCCP


	)

64 
	mIPPROTO_IPV6
 = 41,

65 
	#IPPROTO_IPV6
 
IPPROTO_IPV6


	)

66 
	mIPPROTO_RSVP
 = 46,

67 
	#IPPROTO_RSVP
 
IPPROTO_RSVP


	)

68 
	mIPPROTO_GRE
 = 47,

69 
	#IPPROTO_GRE
 
IPPROTO_GRE


	)

70 
	mIPPROTO_ESP
 = 50,

71 
	#IPPROTO_ESP
 
IPPROTO_ESP


	)

72 
	mIPPROTO_AH
 = 51,

73 
	#IPPROTO_AH
 
IPPROTO_AH


	)

74 
	mIPPROTO_MTP
 = 92,

75 
	#IPPROTO_MTP
 
IPPROTO_MTP


	)

76 
	mIPPROTO_BEETPH
 = 94,

77 
	#IPPROTO_BEETPH
 
IPPROTO_BEETPH


	)

78 
	mIPPROTO_ENCAP
 = 98,

79 
	#IPPROTO_ENCAP
 
IPPROTO_ENCAP


	)

80 
	mIPPROTO_PIM
 = 103,

81 
	#IPPROTO_PIM
 
IPPROTO_PIM


	)

82 
	mIPPROTO_COMP
 = 108,

83 
	#IPPROTO_COMP
 
IPPROTO_COMP


	)

84 
	mIPPROTO_SCTP
 = 132,

85 
	#IPPROTO_SCTP
 
IPPROTO_SCTP


	)

86 
	mIPPROTO_UDPLITE
 = 136,

87 
	#IPPROTO_UDPLITE
 
IPPROTO_UDPLITE


	)

88 
	mIPPROTO_MPLS
 = 137,

89 
	#IPPROTO_MPLS
 
IPPROTO_MPLS


	)

90 
	mIPPROTO_RAW
 = 255,

91 
	#IPPROTO_RAW
 
IPPROTO_RAW


	)

92 
	mIPPROTO_MAX


98 #iâdeà
__USE_KERNEL_IPV6_DEFS


101 
	mIPPROTO_HOPOPTS
 = 0,

102 
	#IPPROTO_HOPOPTS
 
IPPROTO_HOPOPTS


	)

103 
	mIPPROTO_ROUTING
 = 43,

104 
	#IPPROTO_ROUTING
 
IPPROTO_ROUTING


	)

105 
	mIPPROTO_FRAGMENT
 = 44,

106 
	#IPPROTO_FRAGMENT
 
IPPROTO_FRAGMENT


	)

107 
	mIPPROTO_ICMPV6
 = 58,

108 
	#IPPROTO_ICMPV6
 
IPPROTO_ICMPV6


	)

109 
	mIPPROTO_NONE
 = 59,

110 
	#IPPROTO_NONE
 
IPPROTO_NONE


	)

111 
	mIPPROTO_DSTOPTS
 = 60,

112 
	#IPPROTO_DSTOPTS
 
IPPROTO_DSTOPTS


	)

113 
	mIPPROTO_MH
 = 135

114 
	#IPPROTO_MH
 
IPPROTO_MH


	)

119 
ušt16_t
 
	tš_pÜt_t
;

124 
	mIPPORT_ECHO
 = 7,

125 
	mIPPORT_DISCARD
 = 9,

126 
	mIPPORT_SYSTAT
 = 11,

127 
	mIPPORT_DAYTIME
 = 13,

128 
	mIPPORT_NETSTAT
 = 15,

129 
	mIPPORT_FTP
 = 21,

130 
	mIPPORT_TELNET
 = 23,

131 
	mIPPORT_SMTP
 = 25,

132 
	mIPPORT_TIMESERVER
 = 37,

133 
	mIPPORT_NAMESERVER
 = 42,

134 
	mIPPORT_WHOIS
 = 43,

135 
	mIPPORT_MTP
 = 57,

137 
	mIPPORT_TFTP
 = 69,

138 
	mIPPORT_RJE
 = 77,

139 
	mIPPORT_FINGER
 = 79,

140 
	mIPPORT_TTYLINK
 = 87,

141 
	mIPPORT_SUPDUP
 = 95,

144 
	mIPPORT_EXECSERVER
 = 512,

145 
	mIPPORT_LOGINSERVER
 = 513,

146 
	mIPPORT_CMDSERVER
 = 514,

147 
	mIPPORT_EFSSERVER
 = 520,

150 
	mIPPORT_BIFFUDP
 = 512,

151 
	mIPPORT_WHOSERVER
 = 513,

152 
	mIPPORT_ROUTESERVER
 = 520,

155 
	mIPPORT_RESERVED
 = 1024,

158 
	mIPPORT_USERRESERVED
 = 5000

166 
	#IN_CLASSA
(
a
è((((
š_addr_t
)×)è& 0x80000000è=ğ0)

	)

167 
	#IN_CLASSA_NET
 0xff000000

	)

168 
	#IN_CLASSA_NSHIFT
 24

	)

169 
	#IN_CLASSA_HOST
 (0xfffffffà& ~
IN_CLASSA_NET
)

	)

170 
	#IN_CLASSA_MAX
 128

	)

172 
	#IN_CLASSB
(
a
è((((
š_addr_t
)×)è& 0xc0000000è=ğ0x80000000)

	)

173 
	#IN_CLASSB_NET
 0xffff0000

	)

174 
	#IN_CLASSB_NSHIFT
 16

	)

175 
	#IN_CLASSB_HOST
 (0xfffffffà& ~
IN_CLASSB_NET
)

	)

176 
	#IN_CLASSB_MAX
 65536

	)

178 
	#IN_CLASSC
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xc0000000)

	)

179 
	#IN_CLASSC_NET
 0xffffff00

	)

180 
	#IN_CLASSC_NSHIFT
 8

	)

181 
	#IN_CLASSC_HOST
 (0xfffffffà& ~
IN_CLASSC_NET
)

	)

183 
	#IN_CLASSD
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xe0000000)

	)

184 
	#IN_MULTICAST
(
a
è
	`IN_CLASSD
×)

	)

186 
	#IN_EXPERIMENTAL
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xe0000000)

	)

187 
	#IN_BADCLASS
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xf0000000)

	)

190 
	#INADDR_ANY
 ((
š_addr_t
è0x00000000)

	)

192 
	#INADDR_BROADCAST
 ((
š_addr_t
è0xffffffff)

	)

194 
	#INADDR_NONE
 ((
š_addr_t
è0xffffffff)

	)

197 
	#IN_LOOPBACKNET
 127

	)

199 #iâdeà
INADDR_LOOPBACK


200 
	#INADDR_LOOPBACK
 ((
š_addr_t
è0x7f000001è

	)

204 
	#INADDR_UNSPEC_GROUP
 ((
š_addr_t
è0xe0000000è

	)

205 
	#INADDR_ALLHOSTS_GROUP
 ((
š_addr_t
è0xe0000001è

	)

206 
	#INADDR_ALLRTRS_GROUP
 ((
š_addr_t
è0xe0000002è

	)

207 
	#INADDR_MAX_LOCAL_GROUP
 ((
š_addr_t
è0xe00000ffè

	)

209 #iâdeà
__USE_KERNEL_IPV6_DEFS


211 
	sš6_addr


215 
ušt8_t
 
	m__u6_addr8
[16];

216 #ifdeà
__USE_MISC


217 
ušt16_t
 
	m__u6_addr16
[8];

218 
ušt32_t
 
	m__u6_addr32
[4];

220 } 
	m__š6_u
;

221 
	#s6_addr
 
__š6_u
.
__u6_addr8


	)

222 #ifdeà
__USE_MISC


223 
	#s6_addr16
 
__š6_u
.
__u6_addr16


	)

224 
	#s6_addr32
 
__š6_u
.
__u6_addr32


	)

229 cÚ¡ 
š6_addr
 
š6addr_ªy
;

230 cÚ¡ 
š6_addr
 
š6addr_loİback
;

231 
	#IN6ADDR_ANY_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 } } }

	)

232 
	#IN6ADDR_LOOPBACK_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1 } } }

	)

234 
	#INET_ADDRSTRLEN
 16

	)

235 
	#INET6_ADDRSTRLEN
 46

	)

239 
	ssockaddr_š


241 
__SOCKADDR_COMMON
 (
sš_
);

242 
š_pÜt_t
 
	msš_pÜt
;

243 
š_addr
 
	msš_addr
;

246 
	msš_z”o
[ (
sockaddr
) -

247 
__SOCKADDR_COMMON_SIZE
 -

248  (
š_pÜt_t
) -

249  (
š_addr
)];

252 #iâdeà
__USE_KERNEL_IPV6_DEFS


254 
	ssockaddr_š6


256 
__SOCKADDR_COMMON
 (
sš6_
);

257 
š_pÜt_t
 
	msš6_pÜt
;

258 
ušt32_t
 
	msš6_æowšfo
;

259 
š6_addr
 
	msš6_addr
;

260 
ušt32_t
 
	msš6_scİe_id
;

264 #ifdeà
__USE_MISC


266 
	s_m»q


269 
š_addr
 
	mimr_muÉŸddr
;

272 
š_addr
 
	mimr_š‹rçû
;

275 
	s_m»q_sourû


278 
š_addr
 
	mimr_muÉŸddr
;

281 
š_addr
 
	mimr_š‹rçû
;

284 
š_addr
 
	mimr_sourûaddr
;

288 #iâdeà
__USE_KERNEL_IPV6_DEFS


290 
	sv6_m»q


293 
š6_addr
 
	mv6mr_muÉŸddr
;

296 
	mv6mr_š‹rçû
;

300 #ifdeà
__USE_MISC


302 
	sgroup_»q


305 
ušt32_t
 
	mgr_š‹rçû
;

308 
sockaddr_¡Üage
 
	mgr_group
;

311 
	sgroup_sourû_»q


314 
ušt32_t
 
	mg¤_š‹rçû
;

317 
sockaddr_¡Üage
 
	mg¤_group
;

320 
sockaddr_¡Üage
 
	mg¤_sourû
;

325 
	s_msf‹r


328 
š_addr
 
	mimsf_muÉŸddr
;

331 
š_addr
 
	mimsf_š‹rçû
;

334 
ušt32_t
 
	mimsf_fmode
;

337 
ušt32_t
 
	mimsf_num¤c
;

339 
š_addr
 
	mimsf_¦i¡
[1];

342 
	#IP_MSFILTER_SIZE
(
num¤c
è( (
_msf‹r
) \

343 -  (
š_addr
) \

344 + (
num¤c
è*  (
š_addr
))

	)

346 
	sgroup_f‹r


349 
ušt32_t
 
	mgf_š‹rçû
;

352 
sockaddr_¡Üage
 
	mgf_group
;

355 
ušt32_t
 
	mgf_fmode
;

358 
ušt32_t
 
	mgf_num¤c
;

360 
sockaddr_¡Üage
 
	mgf_¦i¡
[1];

363 
	#GROUP_FILTER_SIZE
(
num¤c
è( (
group_f‹r
) \

364 -  (
sockaddr_¡Üage
) \

365 + ((
num¤c
) \

366 *  (
sockaddr_¡Üage
)))

	)

376 
ušt32_t
 
	$Áohl
 (
ušt32_t
 
__ÃÚg
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

377 
ušt16_t
 
	$Áohs
 (
ušt16_t
 
__ÃtshÜt
)

378 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

379 
ušt32_t
 
	$htÚl
 (
ušt32_t
 
__ho¡lÚg
)

380 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

381 
ušt16_t
 
	$htÚs
 (
ušt16_t
 
__ho¡shÜt
)

382 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

384 
	~<’dŸn.h
>

387 
	~<b™s/by‹sw­.h
>

389 #ifdeà
__OPTIMIZE__


393 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


396 
	#Áohl
(
x
è(x)

	)

397 
	#Áohs
(
x
è(x)

	)

398 
	#htÚl
(
x
è(x)

	)

399 
	#htÚs
(
x
è(x)

	)

401 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


402 
	#Áohl
(
x
è
	`__bsw­_32
 (x)

	)

403 
	#Áohs
(
x
è
	`__bsw­_16
 (x)

	)

404 
	#htÚl
(
x
è
	`__bsw­_32
 (x)

	)

405 
	#htÚs
(
x
è
	`__bsw­_16
 (x)

	)

410 #ifdeà
__GNUC__


411 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

412 (
__ex‹nsiÚ__
 \

413 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

414 
__a
->
s6_addr32
[0] == 0 \

415 && 
__a
->
s6_addr32
[1] == 0 \

416 && 
__a
->
s6_addr32
[2] == 0 \

417 && 
__a
->
s6_addr32
[3] =ğ0; 
	}
}))

	)

419 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

420 (
__ex‹nsiÚ__
 \

421 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

422 
__a
->
s6_addr32
[0] == 0 \

423 && 
__a
->
s6_addr32
[1] == 0 \

424 && 
__a
->
s6_addr32
[2] == 0 \

425 && 
__a
->
s6_addr32
[3] =ğ
	`htÚl
 (1); }))

	)

427 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

428 (
__ex‹nsiÚ__
 \

429 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

430 (
__a
->
s6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xã800000); }))

	)

432 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

433 (
__ex‹nsiÚ__
 \

434 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

435 (
__a
->
s6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xãc00000); }))

	)

437 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

438 (
__ex‹nsiÚ__
 \

439 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

440 
__a
->
s6_addr32
[0] == 0 \

441 && 
__a
->
s6_addr32
[1] == 0 \

442 && 
__a
->
s6_addr32
[2] =ğ
	`htÚl
 (0xffff); }))

	)

444 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

445 (
__ex‹nsiÚ__
 \

446 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

447 
__a
->
s6_addr32
[0] == 0 \

448 && 
__a
->
s6_addr32
[1] == 0 \

449 && 
__a
->
s6_addr32
[2] == 0 \

450 && 
	`Áohl
 (
__a
->
s6_addr32
[3]è> 1; }))

	)

452 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

453 (
__ex‹nsiÚ__
 \

454 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

455 cÚ¡ 
š6_addr
 *
__b
 = (cÚ¡ š6_add¸*è(
b
); \

456 
__a
->
s6_addr32
[0] =ğ
__b
->s6_addr32[0] \

457 && 
__a
->
s6_addr32
[1] =ğ
__b
->s6_addr32[1] \

458 && 
__a
->
s6_addr32
[2] =ğ
__b
->s6_addr32[2] \

459 && 
__a
->
s6_addr32
[3] =ğ
__b
->s6_addr32[3]; }))

	)

461 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

462 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

463 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

464 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

465 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ0)

	)

467 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

468 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

469 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

470 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

471 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ
	`htÚl
 (1))

	)

473 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

474 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

475 =ğ
	`htÚl
 (0xã800000))

	)

477 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

478 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

479 =ğ
	`htÚl
 (0xãc00000))

	)

481 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

482 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

483 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

484 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ
	`htÚl
 (0xffff)))

	)

486 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

487 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

488 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

489 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0) \

490 && (
	`Áohl
 (((cÚ¡ 
ušt32_t
 *è(
a
))[3]è> 1))

	)

492 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

493 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[0]) \

494 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[1]) \

495 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[2]) \

496 && (((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[3]))

	)

499 
	#IN6_IS_ADDR_MULTICAST
(
a
è(((cÚ¡ 
ušt8_t
 *è×))[0] =ğ0xff)

	)

501 #ifdeà
__USE_MISC


503 
	$bšd»svpÜt
 (
__sockfd
, 
sockaddr_š
 *
__sock_š
è
__THROW
;

506 
	$bšd»svpÜt6
 (
__sockfd
, 
sockaddr_š6
 *
__sock_š
)

507 
__THROW
;

511 
	#IN6_IS_ADDR_MC_NODELOCAL
(
a
) \

512 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

513 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x1))

	)

515 
	#IN6_IS_ADDR_MC_LINKLOCAL
(
a
) \

516 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

517 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x2))

	)

519 
	#IN6_IS_ADDR_MC_SITELOCAL
(
a
) \

520 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

521 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x5))

	)

523 
	#IN6_IS_ADDR_MC_ORGLOCAL
(
a
) \

524 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

525 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x8))

	)

527 
	#IN6_IS_ADDR_MC_GLOBAL
(
a
) \

528 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

529 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0xe))

	)

532 #ifdeà
__USE_GNU


533 
cmsghdr
;

535 #iâdeà
__USE_KERNEL_IPV6_DEFS


537 
	sš6_pktšfo


539 
š6_addr
 
i6_addr
;

540 
i6_ifšdex
;

544 
	s6_mtušfo


546 
sockaddr_š6
 
6m_addr
;

547 
ušt32_t
 
6m_mtu
;

552 
	$š‘6_İtiÚ_¥aû
 (
__nby‹s
)

553 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

554 
	$š‘6_İtiÚ_š™
 (*
__bp
, 
cmsghdr
 **
__cmsgp
,

555 
__ty³
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

556 
	$š‘6_İtiÚ_­³nd
 (
cmsghdr
 *
__cmsg
,

557 cÚ¡ 
ušt8_t
 *
__ty³p
, 
__muÉx
,

558 
__¶usy
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

559 
ušt8_t
 *
	$š‘6_İtiÚ_®loc
 (
cmsghdr
 *
__cmsg
, 
__d©®’
,

560 
__muÉx
, 
__¶usy
)

561 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

562 
	$š‘6_İtiÚ_Ãxt
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

563 
ušt8_t
 **
__Œp
)

564 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

565 
	$š‘6_İtiÚ_fšd
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

566 
ušt8_t
 **
__Œp
, 
__ty³
)

567 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

571 
	$š‘6_İt_š™
 (*
__extbuf
, 
sockËn_t
 
__ex’
è
__THROW
;

572 
	$š‘6_İt_­³nd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

573 
ušt8_t
 
__ty³
, 
sockËn_t
 
__Ën
, ušt8_ˆ
__®ign
,

574 **
__d©abuå
è
__THROW
;

575 
	$š‘6_İt_fšish
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
)

576 
__THROW
;

577 
	$š‘6_İt_£t_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

578 
sockËn_t
 
__v®Ën
è
__THROW
;

579 
	$š‘6_İt_Ãxt
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

580 
ušt8_t
 *
__ty³p
, 
sockËn_t
 *
__ËÅ
,

581 **
__d©abuå
è
__THROW
;

582 
	$š‘6_İt_fšd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

583 
ušt8_t
 
__ty³
, 
sockËn_t
 *
__ËÅ
,

584 **
__d©abuå
è
__THROW
;

585 
	$š‘6_İt_g‘_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

586 
sockËn_t
 
__v®Ën
è
__THROW
;

590 
sockËn_t
 
	$š‘6_¹h_¥aû
 (
__ty³
, 
__£gm’ts
è
__THROW
;

591 *
	$š‘6_¹h_š™
 (*
__bp
, 
sockËn_t
 
__bp_Ën
, 
__ty³
,

592 
__£gm’ts
è
__THROW
;

593 
	$š‘6_¹h_add
 (*
__bp
, cÚ¡ 
š6_addr
 *
__addr
è
__THROW
;

594 
	$š‘6_¹h_»v”£
 (cÚ¡ *
__š
, *
__out
è
__THROW
;

595 
	$š‘6_¹h_£gm’ts
 (cÚ¡ *
__bp
è
__THROW
;

596 
š6_addr
 *
	$š‘6_¹h_g‘addr
 (cÚ¡ *
__bp
, 
__šdex
)

597 
__THROW
;

603 
	$g‘v4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

604 
š_addr
 
__group
, 
ušt32_t
 *
__fmode
,

605 
ušt32_t
 *
__num¤c
, 
š_addr
 *
__¦i¡
)

606 
__THROW
;

609 
	$£tv4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

610 
š_addr
 
__group
, 
ušt32_t
 
__fmode
,

611 
ušt32_t
 
__num¤c
,

612 cÚ¡ 
š_addr
 *
__¦i¡
)

613 
__THROW
;

617 
	$g‘sourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

618 cÚ¡ 
sockaddr
 *
__group
,

619 
sockËn_t
 
__grou¶’
, 
ušt32_t
 *
__fmode
,

620 
ušt32_t
 *
__num¤c
,

621 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

624 
	$£tsourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

625 cÚ¡ 
sockaddr
 *
__group
,

626 
sockËn_t
 
__grou¶’
, 
ušt32_t
 
__fmode
,

627 
ušt32_t
 
__num¤c
,

628 cÚ¡ 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

631 
__END_DECLS


	@/usr/include/netinet/tcp.h

32 #iâdeà
_NETINET_TCP_H


33 
	#_NETINET_TCP_H
 1

	)

35 
	~<ã©u»s.h
>

40 
	#TCP_NODELAY
 1

	)

41 
	#TCP_MAXSEG
 2

	)

42 
	#TCP_CORK
 3

	)

43 
	#TCP_KEEPIDLE
 4

	)

44 
	#TCP_KEEPINTVL
 5

	)

45 
	#TCP_KEEPCNT
 6

	)

46 
	#TCP_SYNCNT
 7

	)

47 
	#TCP_LINGER2
 8

	)

48 
	#TCP_DEFER_ACCEPT
 9

	)

49 
	#TCP_WINDOW_CLAMP
 10

	)

50 
	#TCP_INFO
 11

	)

51 
	#TCP_QUICKACK
 12

	)

52 
	#TCP_CONGESTION
 13

	)

53 
	#TCP_MD5SIG
 14

	)

54 
	#TCP_COOKIE_TRANSACTIONS
 15

	)

55 
	#TCP_THIN_LINEAR_TIMEOUTS
 16

	)

56 
	#TCP_THIN_DUPACK
 17

	)

57 
	#TCP_USER_TIMEOUT
 18

	)

58 
	#TCP_REPAIR
 19

	)

59 
	#TCP_REPAIR_QUEUE
 20

	)

60 
	#TCP_QUEUE_SEQ
 21

	)

61 
	#TCP_REPAIR_OPTIONS
 22

	)

62 
	#TCP_FASTOPEN
 23

	)

63 
	#TCP_TIMESTAMP
 24

	)

64 
	#TCP_NOTSENT_LOWAT
 25

	)

66 
	#TCP_CC_INFO
 26

	)

68 
	#TCP_SAVE_SYN
 27

	)

70 
	#TCP_SAVED_SYN
 28

	)

73 #ifdeà
__USE_MISC


74 
	~<sys/ty³s.h
>

75 
	~<sys/sock‘.h
>

77 
u_št32_t
 
	ttı_£q
;

82 
	stıhdr


84 
__ex‹nsiÚ__
 union

88 
u_št16_t
 
	mth_¥Üt
;

89 
u_št16_t
 
	mth_dpÜt
;

90 
tı_£q
 
	mth_£q
;

91 
tı_£q
 
	mth_ack
;

92 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


93 
u_št8_t
 
	mth_x2
:4;

94 
u_št8_t
 
	mth_off
:4;

96 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


97 
u_št8_t
 
	mth_off
:4;

98 
u_št8_t
 
	mth_x2
:4;

100 
u_št8_t
 
	mth_æags
;

101 
	#TH_FIN
 0x01

	)

102 
	#TH_SYN
 0x02

	)

103 
	#TH_RST
 0x04

	)

104 
	#TH_PUSH
 0x08

	)

105 
	#TH_ACK
 0x10

	)

106 
	#TH_URG
 0x20

	)

107 
u_št16_t
 
	mth_wš
;

108 
u_št16_t
 
	mth_sum
;

109 
u_št16_t
 
	mth_u½
;

113 
u_št16_t
 
	msourû
;

114 
u_št16_t
 
	mde¡
;

115 
u_št32_t
 
	m£q
;

116 
u_št32_t
 
	mack_£q
;

117 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


118 
u_št16_t
 
	m»s1
:4;

119 
u_št16_t
 
	mdoff
:4;

120 
u_št16_t
 
	mfš
:1;

121 
u_št16_t
 
	msyn
:1;

122 
u_št16_t
 
	mr¡
:1;

123 
u_št16_t
 
	mpsh
:1;

124 
u_št16_t
 
	mack
:1;

125 
u_št16_t
 
	murg
:1;

126 
u_št16_t
 
	m»s2
:2;

127 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


128 
u_št16_t
 
	mdoff
:4;

129 
u_št16_t
 
	m»s1
:4;

130 
u_št16_t
 
	m»s2
:2;

131 
u_št16_t
 
	murg
:1;

132 
u_št16_t
 
	mack
:1;

133 
u_št16_t
 
	mpsh
:1;

134 
u_št16_t
 
	mr¡
:1;

135 
u_št16_t
 
	msyn
:1;

136 
u_št16_t
 
	mfš
:1;

140 
u_št16_t
 
	mwšdow
;

141 
u_št16_t
 
	mcheck
;

142 
u_št16_t
 
	murg_±r
;

149 
	mTCP_ESTABLISHED
 = 1,

150 
	mTCP_SYN_SENT
,

151 
	mTCP_SYN_RECV
,

152 
	mTCP_FIN_WAIT1
,

153 
	mTCP_FIN_WAIT2
,

154 
	mTCP_TIME_WAIT
,

155 
	mTCP_CLOSE
,

156 
	mTCP_CLOSE_WAIT
,

157 
	mTCP_LAST_ACK
,

158 
	mTCP_LISTEN
,

159 
	mTCP_CLOSING


162 
	#TCPOPT_EOL
 0

	)

163 
	#TCPOPT_NOP
 1

	)

164 
	#TCPOPT_MAXSEG
 2

	)

165 
	#TCPOLEN_MAXSEG
 4

	)

166 
	#TCPOPT_WINDOW
 3

	)

167 
	#TCPOLEN_WINDOW
 3

	)

168 
	#TCPOPT_SACK_PERMITTED
 4

	)

169 
	#TCPOLEN_SACK_PERMITTED
 2

	)

170 
	#TCPOPT_SACK
 5

	)

171 
	#TCPOPT_TIMESTAMP
 8

	)

172 
	#TCPOLEN_TIMESTAMP
 10

	)

173 
	#TCPOLEN_TSTAMP_APPA
 (
TCPOLEN_TIMESTAMP
+2è

	)

175 
	#TCPOPT_TSTAMP_HDR
 \

176 (
TCPOPT_NOP
<<24|TCPOPT_NOP<<16|
TCPOPT_TIMESTAMP
<<8|
TCPOLEN_TIMESTAMP
)

	)

184 
	#TCP_MSS
 512

	)

186 
	#TCP_MAXWIN
 65535

	)

188 
	#TCP_MAX_WINSHIFT
 14

	)

190 
	#SOL_TCP
 6

	)

193 
	#TCPI_OPT_TIMESTAMPS
 1

	)

194 
	#TCPI_OPT_SACK
 2

	)

195 
	#TCPI_OPT_WSCALE
 4

	)

196 
	#TCPI_OPT_ECN
 8

	)

197 
	#TCPI_OPT_ECN_SEEN
 16

	)

198 
	#TCPI_OPT_SYN_DATA
 32

	)

201 
	etı_ÿ_¡©e


203 
	mTCP_CA_O³n
 = 0,

204 
	mTCP_CA_DisÜd”
 = 1,

205 
	mTCP_CA_CWR
 = 2,

206 
	mTCP_CA_Recov”y
 = 3,

207 
	mTCP_CA_Loss
 = 4

210 
	stı_šfo


212 
u_št8_t
 
	mtıi_¡©e
;

213 
u_št8_t
 
	mtıi_ÿ_¡©e
;

214 
u_št8_t
 
	mtıi_»Œªsm™s
;

215 
u_št8_t
 
	mtıi_´obes
;

216 
u_št8_t
 
	mtıi_backoff
;

217 
u_št8_t
 
	mtıi_İtiÚs
;

218 
u_št8_t
 
	mtıi_¢d_wsÿË
 : 4, 
	mtıi_rcv_wsÿË
 : 4;

220 
u_št32_t
 
	mtıi_¹o
;

221 
u_št32_t
 
	mtıi_©o
;

222 
u_št32_t
 
	mtıi_¢d_mss
;

223 
u_št32_t
 
	mtıi_rcv_mss
;

225 
u_št32_t
 
	mtıi_uÇcked
;

226 
u_št32_t
 
	mtıi_§cked
;

227 
u_št32_t
 
	mtıi_lo¡
;

228 
u_št32_t
 
	mtıi_»Œªs
;

229 
u_št32_t
 
	mtıi_çck‘s
;

232 
u_št32_t
 
	mtıi_Ï¡_d©a_£Á
;

233 
u_št32_t
 
	mtıi_Ï¡_ack_£Á
;

234 
u_št32_t
 
	mtıi_Ï¡_d©a_»cv
;

235 
u_št32_t
 
	mtıi_Ï¡_ack_»cv
;

238 
u_št32_t
 
	mtıi_pmtu
;

239 
u_št32_t
 
	mtıi_rcv_s¡h»sh
;

240 
u_št32_t
 
	mtıi_¹t
;

241 
u_št32_t
 
	mtıi_¹tv¬
;

242 
u_št32_t
 
	mtıi_¢d_s¡h»sh
;

243 
u_št32_t
 
	mtıi_¢d_cwnd
;

244 
u_št32_t
 
	mtıi_advmss
;

245 
u_št32_t
 
	mtıi_»Üd”šg
;

247 
u_št32_t
 
	mtıi_rcv_¹t
;

248 
u_št32_t
 
	mtıi_rcv_¥aû
;

250 
u_št32_t
 
	mtıi_tÙ®_»Œªs
;

255 
	#TCP_MD5SIG_MAXKEYLEN
 80

	)

257 
	stı_md5sig


259 
sockaddr_¡Üage
 
	mtım_addr
;

260 
u_št16_t
 
	m__tım_·d1
;

261 
u_št16_t
 
	mtım_keyËn
;

262 
u_št32_t
 
	m__tım_·d2
;

263 
u_št8_t
 
	mtım_key
[
TCP_MD5SIG_MAXKEYLEN
];

267 
	stı_»·œ_İt


269 
u_št32_t
 
	mİt_code
;

270 
u_št32_t
 
	mİt_v®
;

276 
	mTCP_NO_QUEUE
,

277 
	mTCP_RECV_QUEUE
,

278 
	mTCP_SEND_QUEUE
,

279 
	mTCP_QUEUES_NR
,

283 
	#TCP_COOKIE_MIN
 8

	)

284 
	#TCP_COOKIE_MAX
 16

	)

285 
	#TCP_COOKIE_PAIR_SIZE
 (2*
TCP_COOKIE_MAX
)

	)

288 
	#TCP_COOKIE_IN_ALWAYS
 (1 << 0è

	)

289 
	#TCP_COOKIE_OUT_NEVER
 (1 << 1è

	)

293 
	#TCP_S_DATA_IN
 (1 << 2è

	)

294 
	#TCP_S_DATA_OUT
 (1 << 3è

	)

296 
	#TCP_MSS_DEFAULT
 536U

	)

297 
	#TCP_MSS_DESIRED
 1220U

	)

299 
	stı_cook›_Œª§ùiÚs


301 
u_št16_t
 
	mtıù_æags
;

302 
u_št8_t
 
	m__tıù_·d1
;

303 
u_št8_t
 
	mtıù_cook›_desœed
;

304 
u_št16_t
 
	mtıù_s_d©a_desœed
;

305 
u_št16_t
 
	mtıù_u£d
;

306 
u_št8_t
 
	mtıù_v®ue
[
TCP_MSS_DEFAULT
];

	@/usr/include/poll.h

1 
	~<sys/pŞl.h
>

	@/usr/include/pthread.h

18 #iâdeà
_PTHREAD_H


19 
	#_PTHREAD_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<’dŸn.h
>

23 
	~<sched.h
>

24 
	~<time.h
>

26 
	~<b™s/±h»adty³s.h
>

27 
	~<b™s/£tjmp.h
>

28 
	~<b™s/wÜdsize.h
>

34 
	mPTHREAD_CREATE_JOINABLE
,

35 
	#PTHREAD_CREATE_JOINABLE
 
PTHREAD_CREATE_JOINABLE


	)

36 
	mPTHREAD_CREATE_DETACHED


37 
	#PTHREAD_CREATE_DETACHED
 
PTHREAD_CREATE_DETACHED


	)

44 
	mPTHREAD_MUTEX_TIMED_NP
,

45 
	mPTHREAD_MUTEX_RECURSIVE_NP
,

46 
	mPTHREAD_MUTEX_ERRORCHECK_NP
,

47 
	mPTHREAD_MUTEX_ADAPTIVE_NP


48 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


50 
	mPTHREAD_MUTEX_NORMAL
 = 
PTHREAD_MUTEX_TIMED_NP
,

51 
	mPTHREAD_MUTEX_RECURSIVE
 = 
PTHREAD_MUTEX_RECURSIVE_NP
,

52 
	mPTHREAD_MUTEX_ERRORCHECK
 = 
PTHREAD_MUTEX_ERRORCHECK_NP
,

53 
	mPTHREAD_MUTEX_DEFAULT
 = 
PTHREAD_MUTEX_NORMAL


55 #ifdeà
__USE_GNU


57 , 
	mPTHREAD_MUTEX_FAST_NP
 = 
PTHREAD_MUTEX_TIMED_NP


62 #ifdeà
__USE_XOPEN2K


66 
	mPTHREAD_MUTEX_STALLED
,

67 
	mPTHREAD_MUTEX_STALLED_NP
 = 
PTHREAD_MUTEX_STALLED
,

68 
	mPTHREAD_MUTEX_ROBUST
,

69 
	mPTHREAD_MUTEX_ROBUST_NP
 = 
PTHREAD_MUTEX_ROBUST


74 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


78 
	mPTHREAD_PRIO_NONE
,

79 
	mPTHREAD_PRIO_INHERIT
,

80 
	mPTHREAD_PRIO_PROTECT


85 #ifdeà
__PTHREAD_MUTEX_HAVE_PREV


86 
	#PTHREAD_MUTEX_INITIALIZER
 \

87 { { 0, 0, 0, 0, 0, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

88 #ifdeà
__USE_GNU


89 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

90 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

91 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

92 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

93 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

94 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

98 
	#PTHREAD_MUTEX_INITIALIZER
 \

99 { { 0, 0, 0, 0, 0, { 
__PTHREAD_SPINS
 } } }

	)

100 #ifdeà
__USE_GNU


101 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

102 { { 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

103 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

104 { { 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

105 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

106 { { 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

113 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


116 
	mPTHREAD_RWLOCK_PREFER_READER_NP
,

117 
	mPTHREAD_RWLOCK_PREFER_WRITER_NP
,

118 
	mPTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,

119 
	mPTHREAD_RWLOCK_DEFAULT_NP
 = 
PTHREAD_RWLOCK_PREFER_READER_NP


125 #iâdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


126 #ià
__WORDSIZE
 == 64

127 
	#__PTHREAD_RWLOCK_INT_FLAGS_SHARED
 1

	)

132 
	#PTHREAD_RWLOCK_INITIALIZER
 \

133 { { 0, 0, 0, 0, 0, 0, 0, 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, 0 } }

	)

134 #ifdeà
__USE_GNU


135 #ifdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


136 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

137 { { 0, 0, 0, 0, 0, 0, 0, 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, \

138 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
 } }

	)

140 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


141 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

142 { { 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
, \

143 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, 0 } }

	)

145 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

146 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,\

147 0 } }

	)

157 
	mPTHREAD_INHERIT_SCHED
,

158 
	#PTHREAD_INHERIT_SCHED
 
PTHREAD_INHERIT_SCHED


	)

159 
	mPTHREAD_EXPLICIT_SCHED


160 
	#PTHREAD_EXPLICIT_SCHED
 
PTHREAD_EXPLICIT_SCHED


	)

167 
	mPTHREAD_SCOPE_SYSTEM
,

168 
	#PTHREAD_SCOPE_SYSTEM
 
PTHREAD_SCOPE_SYSTEM


	)

169 
	mPTHREAD_SCOPE_PROCESS


170 
	#PTHREAD_SCOPE_PROCESS
 
PTHREAD_SCOPE_PROCESS


	)

177 
	mPTHREAD_PROCESS_PRIVATE
,

178 
	#PTHREAD_PROCESS_PRIVATE
 
PTHREAD_PROCESS_PRIVATE


	)

179 
	mPTHREAD_PROCESS_SHARED


180 
	#PTHREAD_PROCESS_SHARED
 
PTHREAD_PROCESS_SHARED


	)

186 
	#PTHREAD_COND_INITIALIZER
 { { 0, 0, 0, 0, 0, (*è0, 0, 0 } }

	)

190 
	s_±h»ad_ş—nup_bufãr


192 (*
	m__routše
) (*);

193 *
	m__¬g
;

194 
	m__ÿnûÉy³
;

195 
_±h»ad_ş—nup_bufãr
 *
	m__´ev
;

201 
	mPTHREAD_CANCEL_ENABLE
,

202 
	#PTHREAD_CANCEL_ENABLE
 
PTHREAD_CANCEL_ENABLE


	)

203 
	mPTHREAD_CANCEL_DISABLE


204 
	#PTHREAD_CANCEL_DISABLE
 
PTHREAD_CANCEL_DISABLE


	)

208 
	mPTHREAD_CANCEL_DEFERRED
,

209 
	#PTHREAD_CANCEL_DEFERRED
 
PTHREAD_CANCEL_DEFERRED


	)

210 
	mPTHREAD_CANCEL_ASYNCHRONOUS


211 
	#PTHREAD_CANCEL_ASYNCHRONOUS
 
PTHREAD_CANCEL_ASYNCHRONOUS


	)

213 
	#PTHREAD_CANCELED
 ((*è-1)

	)

217 
	#PTHREAD_ONCE_INIT
 0

	)

220 #ifdeà
__USE_XOPEN2K


224 
	#PTHREAD_BARRIER_SERIAL_THREAD
 -1

	)

228 
__BEGIN_DECLS


233 
	$±h»ad_ü—‹
 (
±h»ad_t
 *
__»¡riù
 
__Ãwth»ad
,

234 cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

235 *(*
__¡¬t_routše
) (*),

236 *
__»¡riù
 
__¬g
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 3));

242 
	$±h»ad_ex™
 (*
__»tv®
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

250 
	`±h»ad_još
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
);

252 #ifdeà
__USE_GNU


255 
	$±h»ad_Œyjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
è
__THROW
;

263 
	`±h»ad_timedjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
,

264 cÚ¡ 
time¥ec
 *
__ab¡ime
);

271 
	$±h»ad_d‘ach
 (
±h»ad_t
 
__th
è
__THROW
;

275 
±h»ad_t
 
	$±h»ad_£lf
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

278 
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
)

279 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

287 
	$±h»ad_©Œ_š™
 (
±h»ad_©Œ_t
 *
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

290 
	$±h»ad_©Œ_de¡roy
 (
±h»ad_©Œ_t
 *
__©Œ
)

291 
__THROW
 
	`__nÚnuÎ
 ((1));

294 
	$±h»ad_©Œ_g‘d‘ach¡©e
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

295 *
__d‘ach¡©e
)

296 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

299 
	$±h»ad_©Œ_£td‘ach¡©e
 (
±h»ad_©Œ_t
 *
__©Œ
,

300 
__d‘ach¡©e
)

301 
__THROW
 
	`__nÚnuÎ
 ((1));

305 
	$±h»ad_©Œ_g‘gu¬dsize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

306 
size_t
 *
__gu¬dsize
)

307 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

310 
	$±h»ad_©Œ_£tgu¬dsize
 (
±h»ad_©Œ_t
 *
__©Œ
,

311 
size_t
 
__gu¬dsize
)

312 
__THROW
 
	`__nÚnuÎ
 ((1));

316 
	$±h»ad_©Œ_g‘sched·¿m
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

317 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

318 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

321 
	$±h»ad_©Œ_£tsched·¿m
 (
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

322 cÚ¡ 
sched_·¿m
 *
__»¡riù


323 
__·¿m
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

326 
	$±h»ad_©Œ_g‘schedpŞicy
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


327 
__©Œ
, *
__»¡riù
 
__pŞicy
)

328 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

331 
	$±h»ad_©Œ_£tschedpŞicy
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__pŞicy
)

332 
__THROW
 
	`__nÚnuÎ
 ((1));

335 
	$±h»ad_©Œ_g‘šh”™sched
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


336 
__©Œ
, *
__»¡riù
 
__šh”™
)

337 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

340 
	$±h»ad_©Œ_£tšh”™sched
 (
±h»ad_©Œ_t
 *
__©Œ
,

341 
__šh”™
)

342 
__THROW
 
	`__nÚnuÎ
 ((1));

346 
	$±h»ad_©Œ_g‘scİe
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

347 *
__»¡riù
 
__scİe
)

348 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

351 
	$±h»ad_©Œ_£tscİe
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__scİe
)

352 
__THROW
 
	`__nÚnuÎ
 ((1));

355 
	$±h»ad_©Œ_g‘¡ackaddr
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


356 
__©Œ
, **
__»¡riù
 
__¡ackaddr
)

357 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__©Œibu‹_d•»ÿ‹d__
;

363 
	$±h»ad_©Œ_£t¡ackaddr
 (
±h»ad_©Œ_t
 *
__©Œ
,

364 *
__¡ackaddr
)

365 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
;

368 
	$±h»ad_©Œ_g‘¡acksize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


369 
__©Œ
, 
size_t
 *
__»¡riù
 
__¡acksize
)

370 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

375 
	$±h»ad_©Œ_£t¡acksize
 (
±h»ad_©Œ_t
 *
__©Œ
,

376 
size_t
 
__¡acksize
)

377 
__THROW
 
	`__nÚnuÎ
 ((1));

379 #ifdeà
__USE_XOPEN2K


381 
	$±h»ad_©Œ_g‘¡ack
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

382 **
__»¡riù
 
__¡ackaddr
,

383 
size_t
 *
__»¡riù
 
__¡acksize
)

384 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

389 
	$±h»ad_©Œ_£t¡ack
 (
±h»ad_©Œ_t
 *
__©Œ
, *
__¡ackaddr
,

390 
size_t
 
__¡acksize
è
__THROW
 
	`__nÚnuÎ
 ((1));

393 #ifdeà
__USE_GNU


396 
	$±h»ad_©Œ_£ffš™y_Å
 (
±h»ad_©Œ_t
 *
__©Œ
,

397 
size_t
 
__ıu£tsize
,

398 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

399 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

403 
	$±h»ad_©Œ_g‘affš™y_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

404 
size_t
 
__ıu£tsize
,

405 
ıu_£t_t
 *
__ıu£t
)

406 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

409 
	$±h»ad_g‘©Œ_deçuÉ_Å
 (
±h»ad_©Œ_t
 *
__©Œ
)

410 
__THROW
 
	`__nÚnuÎ
 ((1));

414 
	$±h»ad_£‰r_deçuÉ_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
)

415 
__THROW
 
	`__nÚnuÎ
 ((1));

420 
	$±h»ad_g‘©Œ_Å
 (
±h»ad_t
 
__th
, 
±h»ad_©Œ_t
 *
__©Œ
)

421 
__THROW
 
	`__nÚnuÎ
 ((2));

429 
	$±h»ad_£tsched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
, 
__pŞicy
,

430 cÚ¡ 
sched_·¿m
 *
__·¿m
)

431 
__THROW
 
	`__nÚnuÎ
 ((3));

434 
	$±h»ad_g‘sched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
,

435 *
__»¡riù
 
__pŞicy
,

436 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

437 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

440 
	$±h»ad_£tsched´io
 (
±h»ad_t
 
__rg‘_th»ad
, 
__´io
)

441 
__THROW
;

444 #ifdeà
__USE_GNU


446 
	$±h»ad_g‘Çme_Å
 (
±h»ad_t
 
__rg‘_th»ad
, *
__buf
,

447 
size_t
 
__buæ’
)

448 
__THROW
 
	`__nÚnuÎ
 ((2));

451 
	$±h»ad_£Šame_Å
 (
±h»ad_t
 
__rg‘_th»ad
, cÚ¡ *
__Çme
)

452 
__THROW
 
	`__nÚnuÎ
 ((2));

456 #ifdeà
__USE_UNIX98


458 
	$±h»ad_g‘cÚcu¼’cy
 (è
__THROW
;

461 
	$±h»ad_£tcÚcu¼’cy
 (
__Ëv–
è
__THROW
;

464 #ifdeà
__USE_GNU


469 
	$±h»ad_y›ld
 (è
__THROW
;

474 
	$±h»ad_£ffš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

475 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

476 
__THROW
 
	`__nÚnuÎ
 ((3));

479 
	$±h»ad_g‘affš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

480 
ıu_£t_t
 *
__ıu£t
)

481 
__THROW
 
	`__nÚnuÎ
 ((3));

494 
	$±h»ad_Úû
 (
±h»ad_Úû_t
 *
__Úû_cÚŒŞ
,

495 (*
__š™_routše
è()è
	`__nÚnuÎ
 ((1, 2));

506 
	`±h»ad_£tÿnûl¡©e
 (
__¡©e
, *
__Şd¡©e
);

510 
	`±h»ad_£tÿnûÉy³
 (
__ty³
, *
__Şdty³
);

513 
	`±h»ad_ÿnûl
 (
±h»ad_t
 
__th
);

518 
	`±h»ad_‹¡ÿnûl
 ();

527 
__jmp_buf
 
__ÿnûl_jmp_buf
;

528 
__mask_was_§ved
;

529 } 
__ÿnûl_jmp_buf
[1];

530 *
__·d
[4];

531 } 
	t__±h»ad_unwšd_buf_t
 
	t__©Œibu‹__
 ((
	t__®igÃd__
));

534 #iâdeà
__ş—nup_fù_©Œibu‹


535 
	#__ş—nup_fù_©Œibu‹


	)

540 
	s__±h»ad_ş—nup_äame


542 (*
__ÿnûl_routše
) (*);

543 *
__ÿnûl_¬g
;

544 
__do_™
;

545 
__ÿnûl_ty³
;

548 #ià
defšed
 
__GNUC__
 && defšed 
__EXCEPTIONS


549 #ifdeà
__ılu¥lus


551 şas 
	c__±h»ad_ş—nup_şass


553 (*
__ÿnûl_routše
) (*);

554 *
__ÿnûl_¬g
;

555 
__do_™
;

556 
__ÿnûl_ty³
;

558 
public
:

559 
	$__±h»ad_ş—nup_şass
 ((*
__fù
è(*), *
__¬g
)

560 : 
	`__ÿnûl_routše
 (
__fù
), 
	`__ÿnûl_¬g
 (
__¬g
), 
	$__do_™
 (1) { }

561 ~
	$__±h»ad_ş—nup_şass
 (è{ ià(
__do_™
è
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); 
	}
}

562 
	$__£tdo™
 (
__Ãwv®
è{ 
__do_™
 = __Ãwv®; 
	}
}

563 
	$__deãr
 (è{ 
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
,

564 &
__ÿnûl_ty³
); 
	}
}

565 
	$__»¡Üe
 (ècÚ¡ { 
	`±h»ad_£tÿnûÉy³
 (
__ÿnûl_ty³
, 0); 
	}
}

575 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

577 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
)

	)

581 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

582 
__şäame
.
	`__£tdo™
 (
execu‹
); \

583 } 0)

	)

585 #ifdeà
__USE_GNU


589 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

591 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
); \

592 
__şäame
.
	`__deãr
 ()

	)

597 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

598 
__şäame
.
	`__»¡Üe
 (); \

599 
__şäame
.
	`__£tdo™
 (
execu‹
); \

600 } 0)

	)

607 
__ex‹º_šlše
 

608 
	$__±h»ad_ş—nup_routše
 (
__±h»ad_ş—nup_äame
 *
__äame
)

610 ià(
__äame
->
__do_™
)

611 
__äame
->
	`__ÿnûl_routše
 (__äame->
__ÿnûl_¬g
);

612 
	}
}

621 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

623 
__±h»ad_ş—nup_äame
 
__şäame
 \

624 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

625 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

626 .
__do_™
 = 1 };

	)

630 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

631 
__şäame
.
__do_™
 = (
execu‹
); \

632 } 0)

	)

634 #ifdeà
__USE_GNU


638 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

640 
__±h»ad_ş—nup_äame
 
__şäame
 \

641 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

642 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

643 .
__do_™
 = 1 }; \

644 (è
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
, \

645 &
__şäame
.
__ÿnûl_ty³
)

	)

650 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

651 (è
	`±h»ad_£tÿnûÉy³
 (
__şäame
.
__ÿnûl_ty³
, 
NULL
); \

652 
__şäame
.
__do_™
 = (
execu‹
); \

653 } 0)

	)

664 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

666 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

667 (*
__ÿnûl_routše
è(*èğ(
routše
); \

668 *
__ÿnûl_¬g
 = (
¬g
); \

669 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

670 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

671 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

673 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

674 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

678 
	`__±h»ad_»gi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

679 dØ{

	)

680 
__±h»ad_»gi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

681 
__ş—nup_fù_©Œibu‹
;

685 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

688 
	`__±h»ad_uÄegi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

689 ià(
execu‹
) \

690 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

691 } 0)

	)

692 
	$__±h»ad_uÄegi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

693 
__ş—nup_fù_©Œibu‹
;

695 #ifdeà
__USE_GNU


699 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

701 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

702 (*
__ÿnûl_routše
è(*èğ(
routše
); \

703 *
__ÿnûl_¬g
 = (
¬g
); \

704 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

705 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

706 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

708 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

709 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

713 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (&
__ÿnûl_buf
); \

714 dØ{

	)

715 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

716 
__ş—nup_fù_©Œibu‹
;

721 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

724 
	`__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (&
__ÿnûl_buf
); \

725 ià(
execu‹
) \

726 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

727 
	}
} 0)

	)

728 
	$__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

729 
__ş—nup_fù_©Œibu‹
;

733 
	$__±h»ad_unwšd_Ãxt
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

734 
__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

735 #iâdeà
SHARED


736 
	`__©Œibu‹__
 ((
__w—k__
))

742 
__jmp_buf_g
;

743 
	$__sig£tjmp
 (
__jmp_buf_g
 *
__’v
, 
__§vemask
è
__THROWNL
;

749 
	$±h»ad_mu‹x_š™
 (
±h»ad_mu‹x_t
 *
__mu‹x
,

750 cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__mu‹x©Œ
)

751 
__THROW
 
	`__nÚnuÎ
 ((1));

754 
	$±h»ad_mu‹x_de¡roy
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

755 
__THROW
 
	`__nÚnuÎ
 ((1));

758 
	$±h»ad_mu‹x_Œylock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

759 
__THROWNL
 
	`__nÚnuÎ
 ((1));

762 
	$±h»ad_mu‹x_lock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

763 
__THROWNL
 
	`__nÚnuÎ
 ((1));

765 #ifdeà
__USE_XOPEN2K


767 
	$±h»ad_mu‹x_timedlock
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

768 cÚ¡ 
time¥ec
 *
__»¡riù


769 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

773 
	$±h»ad_mu‹x_uÆock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

774 
__THROWNL
 
	`__nÚnuÎ
 ((1));

778 
	$±h»ad_mu‹x_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x_t
 *

779 
__»¡riù
 
__mu‹x
,

780 *
__»¡riù
 
__´ioûšg
)

781 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

785 
	$±h»ad_mu‹x_£rioûšg
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

786 
__´ioûšg
,

787 *
__»¡riù
 
__Şd_ûšg
)

788 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

791 #ifdeà
__USE_XOPEN2K8


793 
	$±h»ad_mu‹x_cÚsi¡’t
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

794 
__THROW
 
	`__nÚnuÎ
 ((1));

795 #ifdeà
__USE_GNU


796 
	$±h»ad_mu‹x_cÚsi¡’t_Å
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

797 
__THROW
 
	`__nÚnuÎ
 ((1));

806 
	$±h»ad_mu‹x©Œ_š™
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

807 
__THROW
 
	`__nÚnuÎ
 ((1));

810 
	$±h»ad_mu‹x©Œ_de¡roy
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

811 
__THROW
 
	`__nÚnuÎ
 ((1));

814 
	$±h»ad_mu‹x©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

815 
__»¡riù
 
__©Œ
,

816 *
__»¡riù
 
__psh¬ed
)

817 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

820 
	$±h»ad_mu‹x©Œ_£sh¬ed
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

821 
__psh¬ed
)

822 
__THROW
 
	`__nÚnuÎ
 ((1));

824 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


826 
	$±h»ad_mu‹x©Œ_g‘ty³
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__»¡riù


827 
__©Œ
, *
__»¡riù
 
__kšd
)

828 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

833 
	$±h»ad_mu‹x©Œ_£‰y³
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
, 
__kšd
)

834 
__THROW
 
	`__nÚnuÎ
 ((1));

838 
	$±h»ad_mu‹x©Œ_g‘´ÙocŞ
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

839 
__»¡riù
 
__©Œ
,

840 *
__»¡riù
 
__´ÙocŞ
)

841 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

845 
	$±h»ad_mu‹x©Œ_£rÙocŞ
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

846 
__´ÙocŞ
)

847 
__THROW
 
	`__nÚnuÎ
 ((1));

850 
	$±h»ad_mu‹x©Œ_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

851 
__»¡riù
 
__©Œ
,

852 *
__»¡riù
 
__´ioûšg
)

853 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

856 
	$±h»ad_mu‹x©Œ_£rioûšg
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

857 
__´ioûšg
)

858 
__THROW
 
	`__nÚnuÎ
 ((1));

860 #ifdeà
__USE_XOPEN2K


862 
	$±h»ad_mu‹x©Œ_g‘robu¡
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

863 *
__robu¡Ãss
)

864 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

865 #ifdeà
__USE_GNU


866 
	$±h»ad_mu‹x©Œ_g‘robu¡_Å
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

867 *
__robu¡Ãss
)

868 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

872 
	$±h»ad_mu‹x©Œ_£Œobu¡
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

873 
__robu¡Ãss
)

874 
__THROW
 
	`__nÚnuÎ
 ((1));

875 #ifdeà
__USE_GNU


876 
	$±h»ad_mu‹x©Œ_£Œobu¡_Å
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

877 
__robu¡Ãss
)

878 
__THROW
 
	`__nÚnuÎ
 ((1));

883 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


888 
	$±h»ad_rwlock_š™
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

889 cÚ¡ 
±h»ad_rwlock©Œ_t
 *
__»¡riù


890 
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

893 
	$±h»ad_rwlock_de¡roy
 (
±h»ad_rwlock_t
 *
__rwlock
)

894 
__THROW
 
	`__nÚnuÎ
 ((1));

897 
	$±h»ad_rwlock_rdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

898 
__THROWNL
 
	`__nÚnuÎ
 ((1));

901 
	$±h»ad_rwlock_Œyrdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

902 
__THROWNL
 
	`__nÚnuÎ
 ((1));

904 #ifdeà
__USE_XOPEN2K


906 
	$±h»ad_rwlock_timedrdlock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

907 cÚ¡ 
time¥ec
 *
__»¡riù


908 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

912 
	$±h»ad_rwlock_w¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

913 
__THROWNL
 
	`__nÚnuÎ
 ((1));

916 
	$±h»ad_rwlock_Œyw¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

917 
__THROWNL
 
	`__nÚnuÎ
 ((1));

919 #ifdeà
__USE_XOPEN2K


921 
	$±h»ad_rwlock_timedw¾ock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

922 cÚ¡ 
time¥ec
 *
__»¡riù


923 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

927 
	$±h»ad_rwlock_uÆock
 (
±h»ad_rwlock_t
 *
__rwlock
)

928 
__THROWNL
 
	`__nÚnuÎ
 ((1));

934 
	$±h»ad_rwlock©Œ_š™
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

935 
__THROW
 
	`__nÚnuÎ
 ((1));

938 
	$±h»ad_rwlock©Œ_de¡roy
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

939 
__THROW
 
	`__nÚnuÎ
 ((1));

942 
	$±h»ad_rwlock©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

943 
__»¡riù
 
__©Œ
,

944 *
__»¡riù
 
__psh¬ed
)

945 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

948 
	$±h»ad_rwlock©Œ_£sh¬ed
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

949 
__psh¬ed
)

950 
__THROW
 
	`__nÚnuÎ
 ((1));

953 
	$±h»ad_rwlock©Œ_g‘kšd_Å
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

954 
__»¡riù
 
__©Œ
,

955 *
__»¡riù
 
__´ef
)

956 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

959 
	$±h»ad_rwlock©Œ_£tkšd_Å
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

960 
__´ef
è
__THROW
 
	`__nÚnuÎ
 ((1));

968 
	$±h»ad_cÚd_š™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

969 cÚ¡ 
±h»ad_cÚd©Œ_t
 *
__»¡riù
 
__cÚd_©Œ
)

970 
__THROW
 
	`__nÚnuÎ
 ((1));

973 
	$±h»ad_cÚd_de¡roy
 (
±h»ad_cÚd_t
 *
__cÚd
)

974 
__THROW
 
	`__nÚnuÎ
 ((1));

977 
	$±h»ad_cÚd_sigÇl
 (
±h»ad_cÚd_t
 *
__cÚd
)

978 
__THROWNL
 
	`__nÚnuÎ
 ((1));

981 
	$±h»ad_cÚd_brßdÿ¡
 (
±h»ad_cÚd_t
 *
__cÚd
)

982 
__THROWNL
 
	`__nÚnuÎ
 ((1));

989 
	$±h»ad_cÚd_wa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

990 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
)

991 
	`__nÚnuÎ
 ((1, 2));

1000 
	$±h»ad_cÚd_timedwa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

1001 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

1002 cÚ¡ 
time¥ec
 *
__»¡riù
 
__ab¡ime
)

1003 
	`__nÚnuÎ
 ((1, 2, 3));

1008 
	$±h»ad_cÚd©Œ_š™
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1009 
__THROW
 
	`__nÚnuÎ
 ((1));

1012 
	$±h»ad_cÚd©Œ_de¡roy
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1013 
__THROW
 
	`__nÚnuÎ
 ((1));

1016 
	$±h»ad_cÚd©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1017 
__»¡riù
 
__©Œ
,

1018 *
__»¡riù
 
__psh¬ed
)

1019 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1022 
	$±h»ad_cÚd©Œ_£sh¬ed
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1023 
__psh¬ed
è
__THROW
 
	`__nÚnuÎ
 ((1));

1025 #ifdeà
__USE_XOPEN2K


1027 
	$±h»ad_cÚd©Œ_g‘şock
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1028 
__»¡riù
 
__©Œ
,

1029 
__şockid_t
 *
__»¡riù
 
__şock_id
)

1030 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1033 
	$±h»ad_cÚd©Œ_£tşock
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1034 
__şockid_t
 
__şock_id
)

1035 
__THROW
 
	`__nÚnuÎ
 ((1));

1039 #ifdeà
__USE_XOPEN2K


1044 
	$±h»ad_¥š_š™
 (
±h»ad_¥šlock_t
 *
__lock
, 
__psh¬ed
)

1045 
__THROW
 
	`__nÚnuÎ
 ((1));

1048 
	$±h»ad_¥š_de¡roy
 (
±h»ad_¥šlock_t
 *
__lock
)

1049 
__THROW
 
	`__nÚnuÎ
 ((1));

1052 
	$±h»ad_¥š_lock
 (
±h»ad_¥šlock_t
 *
__lock
)

1053 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1056 
	$±h»ad_¥š_Œylock
 (
±h»ad_¥šlock_t
 *
__lock
)

1057 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1060 
	$±h»ad_¥š_uÆock
 (
±h»ad_¥šlock_t
 *
__lock
)

1061 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1068 
	$±h»ad_b¬r›r_š™
 (
±h»ad_b¬r›r_t
 *
__»¡riù
 
__b¬r›r
,

1069 cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *
__»¡riù


1070 
__©Œ
, 
__couÁ
)

1071 
__THROW
 
	`__nÚnuÎ
 ((1));

1074 
	$±h»ad_b¬r›r_de¡roy
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1075 
__THROW
 
	`__nÚnuÎ
 ((1));

1078 
	$±h»ad_b¬r›r_wa™
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1079 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1083 
	$±h»ad_b¬r›¿‰r_š™
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1084 
__THROW
 
	`__nÚnuÎ
 ((1));

1087 
	$±h»ad_b¬r›¿‰r_de¡roy
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1088 
__THROW
 
	`__nÚnuÎ
 ((1));

1091 
	$±h»ad_b¬r›¿‰r_g‘psh¬ed
 (cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *

1092 
__»¡riù
 
__©Œ
,

1093 *
__»¡riù
 
__psh¬ed
)

1094 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1097 
	$±h»ad_b¬r›¿‰r_£sh¬ed
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
,

1098 
__psh¬ed
)

1099 
__THROW
 
	`__nÚnuÎ
 ((1));

1111 
	$±h»ad_key_ü—‹
 (
±h»ad_key_t
 *
__key
,

1112 (*
__de¡r_funùiÚ
) (*))

1113 
__THROW
 
	`__nÚnuÎ
 ((1));

1116 
	$±h»ad_key_d–‘e
 (
±h»ad_key_t
 
__key
è
__THROW
;

1119 *
	$±h»ad_g‘¥ecific
 (
±h»ad_key_t
 
__key
è
__THROW
;

1122 
	$±h»ad_£t¥ecific
 (
±h»ad_key_t
 
__key
,

1123 cÚ¡ *
__poš‹r
è
__THROW
 ;

1126 #ifdeà
__USE_XOPEN2K


1128 
	$±h»ad_g‘ıuşockid
 (
±h»ad_t
 
__th»ad_id
,

1129 
__şockid_t
 *
__şock_id
)

1130 
__THROW
 
	`__nÚnuÎ
 ((2));

1145 
	$±h»ad_©fÜk
 ((*
__´•¬e
) (),

1146 (*
__·»Á
) (),

1147 (*
__chd
è()è
__THROW
;

1150 #ifdeà
__USE_EXTERN_INLINES


1152 
__ex‹º_šlše
 

1153 
	`__NTH
 (
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
))

1155  
__th»ad1
 =ğ
__th»ad2
;

1156 
	}
}

1159 
	g__END_DECLS


	@/usr/include/setjmp.h

22 #iâdef 
_SETJMP_H


23 
	#_SETJMP_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


29 
	~<b™s/£tjmp.h
>

30 
	~<b™s/sig£t.h
>

34 
	s__jmp_buf_g


40 
__jmp_buf
 
	m__jmpbuf
;

41 
	m__mask_was_§ved
;

42 
__sig£t_t
 
	m__§ved_mask
;

46 
__BEGIN_NAMESPACE_STD


48 
__jmp_buf_g
 
	tjmp_buf
[1];

52 
	$£tjmp
 (
jmp_buf
 
__’v
è
__THROWNL
;

54 
__END_NAMESPACE_STD


59 
	$__sig£tjmp
 (
__jmp_buf_g
 
__’v
[1], 
__§vemask
è
__THROWNL
;

63 
	$_£tjmp
 (
__jmp_buf_g
 
__’v
[1]è
__THROWNL
;

67 
	#£tjmp
(
’v
è
	`_£tjmp
 (’v)

	)

70 
__BEGIN_NAMESPACE_STD


74 
	$lÚgjmp
 (
__jmp_buf_g
 
__’v
[1], 
__v®
)

75 
__THROWNL
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

77 
__END_NAMESPACE_STD


79 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


83 
	$_lÚgjmp
 (
__jmp_buf_g
 
__’v
[1], 
__v®
)

84 
__THROWNL
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

88 #ifdef 
__USE_POSIX


92 
__jmp_buf_g
 
	tsigjmp_buf
[1];

96 
	#sig£tjmp
(
’v
, 
§vemask
è
	`__sig£tjmp
 (’v, savemask)

	)

102 
	$siglÚgjmp
 (
sigjmp_buf
 
__’v
, 
__v®
)

103 
__THROWNL
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

108 #ià
__USE_FORTIFY_LEVEL
 > 0

109 
	~<b™s/£tjmp2.h
>

112 
__END_DECLS


	@/usr/include/signal.h

22 #iâdef 
_SIGNAL_H


24 #ià!
defšed
 
__Ãed_sig_©omic_t
 && !defšed 
__Ãed_sig£t_t


25 
	#_SIGNAL_H


	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


32 
	~<b™s/sig£t.h
>

36 #ià
defšed
 
__Ãed_sig_©omic_t
 || defšed 
_SIGNAL_H


37 #iâdeà
__sig_©omic_t_defšed


38 
	#__sig_©omic_t_defšed


	)

39 
__BEGIN_NAMESPACE_STD


40 
__sig_©omic_t
 
	tsig_©omic_t
;

41 
	g__END_NAMESPACE_STD


43 #undeà
__Ãed_sig_©omic_t


46 #ià
defšed
 
__Ãed_sig£t_t
 || (defšed 
_SIGNAL_H
 && defšed 
__USE_POSIX
)

47 #iâdeà
__sig£t_t_defšed


48 
	#__sig£t_t_defšed


	)

49 
__sig£t_t
 
	tsig£t_t
;

51 #undeà
__Ãed_sig£t_t


54 #ifdeà
_SIGNAL_H


56 
	~<b™s/ty³s.h
>

57 
	~<b™s/signum.h
>

59 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


60 #iâdeà
__pid_t_defšed


61 
__pid_t
 
	tpid_t
;

62 
	#__pid_t_defšed


	)

64 #ifdeà
__USE_XOPEN


66 #iâdeà
__uid_t_defšed


67 
__uid_t
 
	tuid_t
;

68 
	#__uid_t_defšed


	)

72 #ifdeà
__USE_POSIX199309


74 
	#__Ãed_time¥ec


	)

75 
	~<time.h
>

78 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_XOPEN_EXTENDED


80 
	~<b™s/sigšfo.h
>

85 (*
	t__sighªdËr_t
) ();

90 
__sighªdËr_t
 
	$__sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

91 
__THROW
;

92 #ifdeà
__USE_GNU


93 
__sighªdËr_t
 
	$sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

94 
__THROW
;

100 
__BEGIN_NAMESPACE_STD


101 #ifdeà
__USE_MISC


102 
__sighªdËr_t
 
	$sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

103 
__THROW
;

106 #ifdeà
__REDIRECT_NTH


107 
__sighªdËr_t
 
	`__REDIRECT_NTH
 (
sigÇl
,

108 (
__sig
, 
__sighªdËr_t
 
__hªdËr
),

109 
__sysv_sigÇl
);

111 
	#sigÇl
 
__sysv_sigÇl


	)

114 
__END_NAMESPACE_STD


116 #ifdeà
__USE_XOPEN


119 
__sighªdËr_t
 
	$bsd_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

120 
__THROW
;

126 #ifdeà
__USE_POSIX


127 
	$kl
 (
__pid_t
 
__pid
, 
__sig
è
__THROW
;

130 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


134 
	$kÍg
 (
__pid_t
 
__pg½
, 
__sig
è
__THROW
;

137 
__BEGIN_NAMESPACE_STD


139 
	$¿i£
 (
__sig
è
__THROW
;

140 
__END_NAMESPACE_STD


142 #ifdeà
__USE_MISC


144 
__sighªdËr_t
 
	$ssigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

145 
__THROW
;

146 
	$gsigÇl
 (
__sig
è
__THROW
;

149 #ifdeà
__USE_XOPEN2K8


151 
	`psigÇl
 (
__sig
, cÚ¡ *
__s
);

154 
	`psigšfo
 (cÚ¡ 
sigšfo_t
 *
__pšfo
, cÚ¡ *
__s
);

166 #ifdeà
__USE_XOPEN


167 #ifdeà
__GNUC__


168 
	$sig·u£
 (
__sig
è
	`__asm__
 ("__xpg_sigpause");

170 
	`__sig·u£
 (
__sig_Ü_mask
, 
__is_sig
);

172 
	#sig·u£
(
sig
è
	`__sig·u£
 ((sig), 1)

	)

177 #ifdeà
__USE_MISC


184 
	#sigmask
(
sig
è
	`__sigmask
(sig)

	)

187 
	$sigblock
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

190 
	$sig£tmask
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

193 
	$sigg‘mask
 (è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

197 #ifdeà
__USE_MISC


198 
	#NSIG
 
_NSIG


	)

201 #ifdeà
__USE_GNU


202 
__sighªdËr_t
 
	tsighªdËr_t
;

206 #ifdeà
__USE_MISC


207 
__sighªdËr_t
 
	tsig_t
;

210 #ifdeà
__USE_POSIX


213 
	$sigem±y£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

216 
	$sigfl£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

219 
	$sigadd£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

222 
	$sigd–£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

225 
	$sigismemb”
 (cÚ¡ 
sig£t_t
 *
__£t
, 
__signo
)

226 
__THROW
 
	`__nÚnuÎ
 ((1));

228 #ifdeà
__USE_GNU


230 
	$sigi£m±y£t
 (cÚ¡ 
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

233 
	$sigªd£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

234 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

237 
	$sigÜ£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

238 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

243 
	~<b™s/sigaùiÚ.h
>

246 
	$sig´ocmask
 (
__how
, cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

247 
sig£t_t
 *
__»¡riù
 
__o£t
è
__THROW
;

254 
	$sigsu¥’d
 (cÚ¡ 
sig£t_t
 *
__£t
è
	`__nÚnuÎ
 ((1));

257 
	$sigaùiÚ
 (
__sig
, cÚ¡ 
sigaùiÚ
 *
__»¡riù
 
__aù
,

258 
sigaùiÚ
 *
__»¡riù
 
__ßù
è
__THROW
;

261 
	$sig³ndšg
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

268 
	$sigwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
, *__»¡riù 
__sig
)

269 
	`__nÚnuÎ
 ((1, 2));

271 #ifdeà
__USE_POSIX199309


276 
	$sigwa™šfo
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

277 
sigšfo_t
 *
__»¡riù
 
__šfo
è
	`__nÚnuÎ
 ((1));

284 
	$sigtimedwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

285 
sigšfo_t
 *
__»¡riù
 
__šfo
,

286 cÚ¡ 
time¥ec
 *
__»¡riù
 
__timeout
)

287 
	`__nÚnuÎ
 ((1));

291 
	$sigqueue
 (
__pid_t
 
__pid
, 
__sig
, cÚ¡ 
sigv®
 
__v®
)

292 
__THROW
;

297 #ifdeà
__USE_MISC


301 cÚ¡ *cÚ¡ 
_sys_sigli¡
[
_NSIG
];

302 cÚ¡ *cÚ¡ 
sys_sigli¡
[
_NSIG
];

306 
	~<b™s/sigcÚ‹xt.h
>

309 
	$sig»tuº
 (
sigcÚ‹xt
 *
__sı
è
__THROW
;

314 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


315 
	#__Ãed_size_t


	)

316 
	~<¡ddef.h
>

321 
	$sigš‹¼u±
 (
__sig
, 
__š‹¼u±
è
__THROW
;

323 
	~<b™s/sig¡ack.h
>

324 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


326 
	~<sys/ucÚ‹xt.h
>

332 
	$sig¡ack
 (
sig¡ack
 *
__ss
, sig¡ack *
__oss
)

333 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

337 
	$sig®t¡ack
 (cÚ¡ 
sig®t¡ack
 *
__»¡riù
 
__ss
,

338 
sig®t¡ack
 *
__»¡riù
 
__oss
è
__THROW
;

342 #ifdeà
__USE_XOPEN_EXTENDED


346 
	$sighŞd
 (
__sig
è
__THROW
;

349 
	$sig»l£
 (
__sig
è
__THROW
;

352 
	$sigignÜe
 (
__sig
è
__THROW
;

355 
__sighªdËr_t
 
	$sig£t
 (
__sig
, 
__sighªdËr_t
 
__di¥
è
__THROW
;

358 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


361 
	~<b™s/±h»adty³s.h
>

362 
	~<b™s/sigth»ad.h
>

369 
	$__libc_cu¼’t_sig¹mš
 (è
__THROW
;

371 
	$__libc_cu¼’t_sig¹max
 (è
__THROW
;

375 
__END_DECLS


	@/usr/include/stdint.h

22 #iâdeà
_STDINT_H


23 
	#_STDINT_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/wch¬.h
>

27 
	~<b™s/wÜdsize.h
>

34 #iâdeà
__št8_t_defšed


35 
	#__št8_t_defšed


	)

36 sigÃd 
	tšt8_t
;

37 
	tšt16_t
;

38 
	tšt32_t
;

39 #ià
__WORDSIZE
 == 64

40 
	tšt64_t
;

42 
__ex‹nsiÚ__


43 
	tšt64_t
;

48 
	tušt8_t
;

49 
	tušt16_t
;

50 #iâdeà
__ušt32_t_defšed


51 
	tušt32_t
;

52 
	#__ušt32_t_defšed


	)

54 #ià
__WORDSIZE
 == 64

55 
	tušt64_t
;

57 
__ex‹nsiÚ__


58 
	tušt64_t
;

65 sigÃd 
	tšt_Ëa¡8_t
;

66 
	tšt_Ëa¡16_t
;

67 
	tšt_Ëa¡32_t
;

68 #ià
__WORDSIZE
 == 64

69 
	tšt_Ëa¡64_t
;

71 
__ex‹nsiÚ__


72 
	tšt_Ëa¡64_t
;

76 
	tušt_Ëa¡8_t
;

77 
	tušt_Ëa¡16_t
;

78 
	tušt_Ëa¡32_t
;

79 #ià
__WORDSIZE
 == 64

80 
	tušt_Ëa¡64_t
;

82 
__ex‹nsiÚ__


83 
	tušt_Ëa¡64_t
;

90 sigÃd 
	tšt_ç¡8_t
;

91 #ià
__WORDSIZE
 == 64

92 
	tšt_ç¡16_t
;

93 
	tšt_ç¡32_t
;

94 
	tšt_ç¡64_t
;

96 
	tšt_ç¡16_t
;

97 
	tšt_ç¡32_t
;

98 
__ex‹nsiÚ__


99 
	tšt_ç¡64_t
;

103 
	tušt_ç¡8_t
;

104 #ià
__WORDSIZE
 == 64

105 
	tušt_ç¡16_t
;

106 
	tušt_ç¡32_t
;

107 
	tušt_ç¡64_t
;

109 
	tušt_ç¡16_t
;

110 
	tušt_ç¡32_t
;

111 
__ex‹nsiÚ__


112 
	tušt_ç¡64_t
;

117 #ià
__WORDSIZE
 == 64

118 #iâdeà
__šŒ_t_defšed


119 
	tšŒ_t
;

120 
	#__šŒ_t_defšed


	)

122 
	tušŒ_t
;

124 #iâdeà
__šŒ_t_defšed


125 
	tšŒ_t
;

126 
	#__šŒ_t_defšed


	)

128 
	tušŒ_t
;

133 #ià
__WORDSIZE
 == 64

134 
	tštmax_t
;

135 
	tuštmax_t
;

137 
__ex‹nsiÚ__


138 
	tštmax_t
;

139 
__ex‹nsiÚ__


140 
	tuštmax_t
;

144 #ià
__WORDSIZE
 == 64

145 
	#__INT64_C
(
c
èø## 
L


	)

146 
	#__UINT64_C
(
c
èø## 
UL


	)

148 
	#__INT64_C
(
c
èø## 
LL


	)

149 
	#__UINT64_C
(
c
èø## 
ULL


	)

155 
	#INT8_MIN
 (-128)

	)

156 
	#INT16_MIN
 (-32767-1)

	)

157 
	#INT32_MIN
 (-2147483647-1)

	)

158 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

160 
	#INT8_MAX
 (127)

	)

161 
	#INT16_MAX
 (32767)

	)

162 
	#INT32_MAX
 (2147483647)

	)

163 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

166 
	#UINT8_MAX
 (255)

	)

167 
	#UINT16_MAX
 (65535)

	)

168 
	#UINT32_MAX
 (4294967295U)

	)

169 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

173 
	#INT_LEAST8_MIN
 (-128)

	)

174 
	#INT_LEAST16_MIN
 (-32767-1)

	)

175 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

176 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

178 
	#INT_LEAST8_MAX
 (127)

	)

179 
	#INT_LEAST16_MAX
 (32767)

	)

180 
	#INT_LEAST32_MAX
 (2147483647)

	)

181 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

184 
	#UINT_LEAST8_MAX
 (255)

	)

185 
	#UINT_LEAST16_MAX
 (65535)

	)

186 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

187 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

191 
	#INT_FAST8_MIN
 (-128)

	)

192 #ià
__WORDSIZE
 == 64

193 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

194 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

196 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

197 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

199 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

201 
	#INT_FAST8_MAX
 (127)

	)

202 #ià
__WORDSIZE
 == 64

203 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

204 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

206 
	#INT_FAST16_MAX
 (2147483647)

	)

207 
	#INT_FAST32_MAX
 (2147483647)

	)

209 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

212 
	#UINT_FAST8_MAX
 (255)

	)

213 #ià
__WORDSIZE
 == 64

214 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

215 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

217 
	#UINT_FAST16_MAX
 (4294967295U)

	)

218 
	#UINT_FAST32_MAX
 (4294967295U)

	)

220 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

224 #ià
__WORDSIZE
 == 64

225 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

226 
	#INTPTR_MAX
 (9223372036854775807L)

	)

227 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

229 
	#INTPTR_MIN
 (-2147483647-1)

	)

230 
	#INTPTR_MAX
 (2147483647)

	)

231 
	#UINTPTR_MAX
 (4294967295U)

	)

236 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

238 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

241 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

247 #ià
__WORDSIZE
 == 64

248 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

249 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

251 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

252 
	#PTRDIFF_MAX
 (2147483647)

	)

256 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

257 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

260 #ià
__WORDSIZE
 == 64

261 
	#SIZE_MAX
 (18446744073709551615UL)

	)

263 #ifdeà
__WORDSIZE32_SIZE_ULONG


264 
	#SIZE_MAX
 (4294967295UL)

	)

266 
	#SIZE_MAX
 (4294967295U)

	)

271 #iâdeà
WCHAR_MIN


273 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

274 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

278 
	#WINT_MIN
 (0u)

	)

279 
	#WINT_MAX
 (4294967295u)

	)

282 
	#INT8_C
(
c
è
	)
c

283 
	#INT16_C
(
c
è
	)
c

284 
	#INT32_C
(
c
è
	)
c

285 #ià
__WORDSIZE
 == 64

286 
	#INT64_C
(
c
èø## 
L


	)

288 
	#INT64_C
(
c
èø## 
LL


	)

292 
	#UINT8_C
(
c
è
	)
c

293 
	#UINT16_C
(
c
è
	)
c

294 
	#UINT32_C
(
c
èø## 
U


	)

295 #ià
__WORDSIZE
 == 64

296 
	#UINT64_C
(
c
èø## 
UL


	)

298 
	#UINT64_C
(
c
èø## 
ULL


	)

302 #ià
__WORDSIZE
 == 64

303 
	#INTMAX_C
(
c
èø## 
L


	)

304 
	#UINTMAX_C
(
c
èø## 
UL


	)

306 
	#INTMAX_C
(
c
èø## 
LL


	)

307 
	#UINTMAX_C
(
c
èø## 
ULL


	)

	@/usr/include/stdio.h

23 #iâdeà
_STDIO_H


25 #ià!
defšed
 
__Ãed_FILE
 && !defšed 
__Ãed___FILE


26 
	#_STDIO_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	~<b™s/ty³s.h
>

36 
	#__Ãed_FILE


	)

37 
	#__Ãed___FILE


	)

41 #ià!
defšed
 
__FILE_defšed
 && defšed 
__Ãed_FILE


44 
	g_IO_FILE
;

46 
__BEGIN_NAMESPACE_STD


48 
_IO_FILE
 
	tFILE
;

49 
	g__END_NAMESPACE_STD


50 #ià
defšed
 
__USE_LARGEFILE64
 || defšed 
__USE_POSIX
 \

51 || 
defšed
 
	g__USE_ISOC99
 || defšed 
	g__USE_XOPEN
 \

52 || 
defšed
 
__USE_POSIX2


53 
	$__USING_NAMESPACE_STD
(
FILE
)

56 
	#__FILE_defšed
 1

	)

58 #undeà
__Ãed_FILE


61 #ià!
defšed
 
____FILE_defšed
 && defšed 
__Ãed___FILE


64 
_IO_FILE
 
	t__FILE
;

66 
	#____FILE_defšed
 1

	)

68 #undeà
__Ãed___FILE


71 #ifdef 
_STDIO_H


72 
	#_STDIO_USES_IOSTREAM


	)

74 
	~<libio.h
>

76 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


77 #ifdeà
__GNUC__


78 #iâdeà
_VA_LIST_DEFINED


79 
_G_va_li¡
 
	tva_li¡
;

80 
	#_VA_LIST_DEFINED


	)

83 
	~<¡d¬g.h
>

87 #ifdeà
__USE_XOPEN2K8


88 #iâdeà
__off_t_defšed


89 #iâdeà
__USE_FILE_OFFSET64


90 
__off_t
 
	toff_t
;

92 
__off64_t
 
	toff_t
;

94 
	#__off_t_defšed


	)

96 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


97 
__off64_t
 
	toff64_t
;

98 
	#__off64_t_defšed


	)

101 #iâdeà
__ssize_t_defšed


102 
__ssize_t
 
	tssize_t
;

103 
	#__ssize_t_defšed


	)

108 
__BEGIN_NAMESPACE_STD


109 #iâdeà
__USE_FILE_OFFSET64


110 
_G_åos_t
 
	tåos_t
;

112 
_G_åos64_t
 
	tåos_t
;

114 
__END_NAMESPACE_STD


115 #ifdeà
__USE_LARGEFILE64


116 
_G_åos64_t
 
	tåos64_t
;

120 
	#_IOFBF
 0

	)

121 
	#_IOLBF
 1

	)

122 
	#_IONBF
 2

	)

126 #iâdeà
BUFSIZ


127 
	#BUFSIZ
 
_IO_BUFSIZ


	)

133 #iâdeà
EOF


134 
	#EOF
 (-1)

	)

140 
	#SEEK_SET
 0

	)

141 
	#SEEK_CUR
 1

	)

142 
	#SEEK_END
 2

	)

143 #ifdeà
__USE_GNU


144 
	#SEEK_DATA
 3

	)

145 
	#SEEK_HOLE
 4

	)

149 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


151 
	#P_tmpdœ
 "/tmp"

	)

164 
	~<b™s/¡dio_lim.h
>

168 
_IO_FILE
 *
¡dš
;

169 
_IO_FILE
 *
¡dout
;

170 
_IO_FILE
 *
¡d”r
;

172 
	#¡dš
 
¡dš


	)

173 
	#¡dout
 
¡dout


	)

174 
	#¡d”r
 
¡d”r


	)

176 
__BEGIN_NAMESPACE_STD


178 
	$»move
 (cÚ¡ *
__f’ame
è
__THROW
;

180 
	$»Çme
 (cÚ¡ *
__Şd
, cÚ¡ *
__Ãw
è
__THROW
;

181 
__END_NAMESPACE_STD


183 #ifdeà
__USE_ATFILE


185 
	$»Çm—t
 (
__Şdfd
, cÚ¡ *
__Şd
, 
__Ãwfd
,

186 cÚ¡ *
__Ãw
è
__THROW
;

189 
__BEGIN_NAMESPACE_STD


194 #iâdeà
__USE_FILE_OFFSET64


195 
FILE
 *
	$tmpfe
 (è
__wur
;

197 #ifdeà
__REDIRECT


198 
FILE
 *
	`__REDIRECT
 (
tmpfe
, (), 
tmpfe64
è
__wur
;

200 
	#tmpfe
 
tmpfe64


	)

204 #ifdeà
__USE_LARGEFILE64


205 
FILE
 *
	$tmpfe64
 (è
__wur
;

209 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

210 
__END_NAMESPACE_STD


212 #ifdeà
__USE_MISC


215 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

219 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


227 *
	$‹m²am
 (cÚ¡ *
__dœ
, cÚ¡ *
__pfx
)

228 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

232 
__BEGIN_NAMESPACE_STD


237 
	`fşo£
 (
FILE
 *
__¡»am
);

242 
	`fæush
 (
FILE
 *
__¡»am
);

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_MISC


252 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

255 #ifdeà
__USE_GNU


262 
	`fşo£®l
 ();

266 
__BEGIN_NAMESPACE_STD


267 #iâdeà
__USE_FILE_OFFSET64


272 
FILE
 *
	$fİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

273 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

278 
FILE
 *
	$äeİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

279 cÚ¡ *
__»¡riù
 
__modes
,

280 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

282 #ifdeà
__REDIRECT


283 
FILE
 *
	`__REDIRECT
 (
fİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

284 cÚ¡ *
__»¡riù
 
__modes
), 
fİ’64
)

285 
__wur
;

286 
FILE
 *
	`__REDIRECT
 (
äeİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

287 cÚ¡ *
__»¡riù
 
__modes
,

288 
FILE
 *
__»¡riù
 
__¡»am
), 
äeİ’64
)

289 
__wur
;

291 
	#fİ’
 
fİ’64


	)

292 
	#äeİ’
 
äeİ’64


	)

295 
__END_NAMESPACE_STD


296 #ifdeà
__USE_LARGEFILE64


297 
FILE
 *
	$fİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

298 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

299 
FILE
 *
	$äeİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

300 cÚ¡ *
__»¡riù
 
__modes
,

301 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

304 #ifdef 
__USE_POSIX


306 
FILE
 *
	$fdİ’
 (
__fd
, cÚ¡ *
__modes
è
__THROW
 
__wur
;

309 #ifdef 
__USE_GNU


312 
FILE
 *
	$fİ’cook›
 (*
__»¡riù
 
__magic_cook›
,

313 cÚ¡ *
__»¡riù
 
__modes
,

314 
_IO_cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

317 #ifdeà
__USE_XOPEN2K8


319 
FILE
 *
	$fmemİ’
 (*
__s
, 
size_t
 
__Ën
, cÚ¡ *
__modes
)

320 
__THROW
 
__wur
;

325 
FILE
 *
	$İ’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

329 
__BEGIN_NAMESPACE_STD


332 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

336 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

337 
__modes
, 
size_t
 
__n
è
__THROW
;

338 
__END_NAMESPACE_STD


340 #ifdef 
__USE_MISC


343 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

344 
size_t
 
__size
è
__THROW
;

347 
	$£šebuf
 (
FILE
 *
__¡»am
è
__THROW
;

351 
__BEGIN_NAMESPACE_STD


356 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

357 cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

362 
	`´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

364 
	$¥rštf
 (*
__»¡riù
 
__s
,

365 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROWNL
;

371 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

372 
_G_va_li¡
 
__¬g
);

377 
	`v´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
);

379 
	$v¥rštf
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

380 
_G_va_li¡
 
__¬g
è
__THROWNL
;

381 
__END_NAMESPACE_STD


383 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_UNIX98


384 
__BEGIN_NAMESPACE_C99


386 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

387 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

388 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

390 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

391 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

392 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

393 
__END_NAMESPACE_C99


396 #ifdeà
__USE_GNU


399 
	$va¥rštf
 (**
__»¡riù
 
__±r
, cÚ¡ *__»¡riù 
__f
,

400 
_G_va_li¡
 
__¬g
)

401 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

402 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

403 cÚ¡ *
__»¡riù
 
__fmt
, ...)

404 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

405 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

406 cÚ¡ *
__»¡riù
 
__fmt
, ...)

407 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

410 #ifdeà
__USE_XOPEN2K8


412 
	$vd´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
,

413 
_G_va_li¡
 
__¬g
)

414 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

415 
	$d´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
, ...)

416 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

420 
__BEGIN_NAMESPACE_STD


425 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

426 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

431 
	$sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

433 
	$ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

434 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

436 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

437 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

438 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

439 #ifdeà
__REDIRECT


443 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

444 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

445 
__isoc99_fsÿnf
è
__wur
;

446 
	`__REDIRECT
 (
sÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

447 
__isoc99_sÿnf
è
__wur
;

448 
	`__REDIRECT_NTH
 (
ssÿnf
, (cÚ¡ *
__»¡riù
 
__s
,

449 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

450 
__isoc99_ssÿnf
);

452 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

453 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

454 
	$__isoc99_sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

455 
	$__isoc99_ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

456 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

457 
	#fsÿnf
 
__isoc99_fsÿnf


	)

458 
	#sÿnf
 
__isoc99_sÿnf


	)

459 
	#ssÿnf
 
__isoc99_ssÿnf


	)

463 
__END_NAMESPACE_STD


465 #ifdef 
__USE_ISOC99


466 
__BEGIN_NAMESPACE_C99


471 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

472 
_G_va_li¡
 
__¬g
)

473 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

479 
	$vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

480 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

483 
	$vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

484 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

485 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

487 #ià!
defšed
 
__USE_GNU
 \

488 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

489 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

490 #ifdeà
__REDIRECT


494 
	`__REDIRECT
 (
vfsÿnf
,

495 (
FILE
 *
__»¡riù
 
__s
,

496 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

497 
__isoc99_vfsÿnf
)

498 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

499 
	`__REDIRECT
 (
vsÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
,

500 
_G_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

501 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

502 
	`__REDIRECT_NTH
 (
vssÿnf
,

503 (cÚ¡ *
__»¡riù
 
__s
,

504 cÚ¡ *
__»¡riù
 
__fÜm©
,

505 
_G_va_li¡
 
__¬g
), 
__isoc99_vssÿnf
)

506 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

508 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

509 cÚ¡ *
__»¡riù
 
__fÜm©
,

510 
_G_va_li¡
 
__¬g
è
__wur
;

511 
	$__isoc99_vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
,

512 
_G_va_li¡
 
__¬g
è
__wur
;

513 
	$__isoc99_vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

514 cÚ¡ *
__»¡riù
 
__fÜm©
,

515 
_G_va_li¡
 
__¬g
è
__THROW
;

516 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

517 
	#vsÿnf
 
__isoc99_vsÿnf


	)

518 
	#vssÿnf
 
__isoc99_vssÿnf


	)

522 
__END_NAMESPACE_C99


526 
__BEGIN_NAMESPACE_STD


531 
	`fg‘c
 (
FILE
 *
__¡»am
);

532 
	`g‘c
 (
FILE
 *
__¡»am
);

538 
	`g‘ch¬
 ();

539 
__END_NAMESPACE_STD


543 
	#g‘c
(
_å
è
	`_IO_g‘c
 (_å)

	)

545 #ifdeà
__USE_POSIX


550 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

551 
	`g‘ch¬_uÆocked
 ();

554 #ifdeà
__USE_MISC


561 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

565 
__BEGIN_NAMESPACE_STD


573 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

574 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

580 
	`putch¬
 (
__c
);

581 
__END_NAMESPACE_STD


585 
	#putc
(
_ch
, 
_å
è
	`_IO_putc
 (_ch, _å)

	)

587 #ifdeà
__USE_MISC


594 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

597 #ifdeà
__USE_POSIX


602 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

603 
	`putch¬_uÆocked
 (
__c
);

607 #ià
defšed
 
__USE_MISC
 \

608 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

610 
	`g‘w
 (
FILE
 *
__¡»am
);

613 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

617 
__BEGIN_NAMESPACE_STD


622 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

623 
__wur
;

625 #ià!
defšed
 
__USE_ISOC11
 \

626 || (
defšed
 
__ılu¥lus
 && __cplusplus <= 201103L)

638 *
	$g‘s
 (*
__s
è
__wur
 
__©Œibu‹_d•»ÿ‹d__
;

640 
__END_NAMESPACE_STD


642 #ifdeà
__USE_GNU


649 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

650 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

654 #ifdef 
__USE_XOPEN2K8


665 
_IO_ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

666 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

667 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

668 
_IO_ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

669 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

670 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

678 
_IO_ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

679 
size_t
 *
__»¡riù
 
__n
,

680 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

684 
__BEGIN_NAMESPACE_STD


689 
	`åuts
 (cÚ¡ *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

695 
	`puts
 (cÚ¡ *
__s
);

702 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

709 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

710 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

715 
size_t
 
	`fwr™e
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

716 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
);

717 
__END_NAMESPACE_STD


719 #ifdeà
__USE_GNU


726 
	`åuts_uÆocked
 (cÚ¡ *
__»¡riù
 
__s
,

727 
FILE
 *
__»¡riù
 
__¡»am
);

730 #ifdeà
__USE_MISC


737 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

738 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

739 
size_t
 
	`fwr™e_uÆocked
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

740 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
);

744 
__BEGIN_NAMESPACE_STD


749 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

754 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

759 
	`»wšd
 (
FILE
 *
__¡»am
);

760 
__END_NAMESPACE_STD


767 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


768 #iâdeà
__USE_FILE_OFFSET64


773 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

778 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

780 #ifdeà
__REDIRECT


781 
	`__REDIRECT
 (
f£eko
,

782 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

783 
f£eko64
);

784 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

786 
	#f£eko
 
f£eko64


	)

787 
	#á–lo
 
á–lo64


	)

792 
__BEGIN_NAMESPACE_STD


793 #iâdeà
__USE_FILE_OFFSET64


798 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

803 
	`f£os
 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
);

805 #ifdeà
__REDIRECT


806 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

807 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

808 
	`__REDIRECT
 (
f£os
,

809 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
), 
f£os64
);

811 
	#fg‘pos
 
fg‘pos64


	)

812 
	#f£os
 
f£os64


	)

815 
__END_NAMESPACE_STD


817 #ifdeà
__USE_LARGEFILE64


818 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

819 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

820 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

821 
	`f£os64
 (
FILE
 *
__¡»am
, cÚ¡ 
åos64_t
 *
__pos
);

824 
__BEGIN_NAMESPACE_STD


826 
	$ş—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

828 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

830 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

831 
__END_NAMESPACE_STD


833 #ifdeà
__USE_MISC


835 
	$ş—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

836 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

837 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

841 
__BEGIN_NAMESPACE_STD


846 
	`³¼Ü
 (cÚ¡ *
__s
);

847 
__END_NAMESPACE_STD


853 
	~<b™s/sys_”¾i¡.h
>

856 #ifdef 
__USE_POSIX


858 
	$f’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

861 #ifdeà
__USE_MISC


863 
	$f’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

867 #ifdeà
__USE_POSIX2


872 
FILE
 *
	$pİ’
 (cÚ¡ *
__commªd
, cÚ¡ *
__modes
è
__wur
;

878 
	`pşo£
 (
FILE
 *
__¡»am
);

882 #ifdef 
__USE_POSIX


884 *
	$ù”mid
 (*
__s
è
__THROW
;

888 #ifdeà
__USE_XOPEN


890 *
	`cu£rid
 (*
__s
);

894 #ifdef 
__USE_GNU


895 
ob¡ack
;

898 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

899 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

900 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

901 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

902 cÚ¡ *
__»¡riù
 
__fÜm©
,

903 
_G_va_li¡
 
__¬gs
)

904 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

908 #ifdeà
__USE_POSIX


912 
	$æockfe
 (
FILE
 *
__¡»am
è
__THROW
;

916 
	$árylockfe
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

919 
	$fuÆockfe
 (
FILE
 *
__¡»am
è
__THROW
;

922 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


926 
	#__Ãed_g‘İt


	)

927 
	~<g‘İt.h
>

932 #ifdeà
__USE_EXTERN_INLINES


933 
	~<b™s/¡dio.h
>

935 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


936 
	~<b™s/¡dio2.h
>

938 #ifdeà
__LDBL_COMPAT


939 
	~<b™s/¡dio-ldbl.h
>

942 
__END_DECLS


	@/usr/include/stdlib.h

22 #iâdef 
_STDLIB_H


24 
	~<ã©u»s.h
>

27 
	#__Ãed_size_t


	)

28 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


29 
	#__Ãed_wch¬_t


	)

30 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

34 
	g__BEGIN_DECLS


36 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


37 
	#_STDLIB_H
 1

	)

39 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
è&& !defšed 
_SYS_WAIT_H


41 
	~<b™s/wa™æags.h
>

42 
	~<b™s/wa™¡©us.h
>

44 #ifdeà
__USE_MISC


49 #ià
defšed
 
__GNUC__
 && !defšed 
__ılu¥lus


50 
	#__WAIT_INT
(
¡©us
) \

51 (
	`__ex‹nsiÚ__
 (((uniÚ { 
	`__ty³of
(
¡©us
è
__š
; 
__i
; }) \

52 { .
__š
 = (
¡©us
è}).
__i
))

	)

54 
	#__WAIT_INT
(
¡©us
è(*(*è&(¡©us))

	)

62 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2 || defšed 
__ılu¥lus


63 
	#__WAIT_STATUS
 *

	)

64 
	#__WAIT_STATUS_DEFN
 *

	)

69 
wa™
 *
	m__u±r
;

70 *
	m__Œ
;

71 } 
	t__WAIT_STATUS
 
	t__©Œibu‹__
 ((
	t__Œª¥¬’t_uniÚ__
));

72 
	#__WAIT_STATUS_DEFN
 *

	)

77 
	#__WAIT_INT
(
¡©us
è(¡©us)

	)

78 
	#__WAIT_STATUS
 *

	)

79 
	#__WAIT_STATUS_DEFN
 *

	)

84 
	#WEXITSTATUS
(
¡©us
è
	`__WEXITSTATUS
 (
	`__WAIT_INT
 (¡©us))

	)

85 
	#WTERMSIG
(
¡©us
è
	`__WTERMSIG
 (
	`__WAIT_INT
 (¡©us))

	)

86 
	#WSTOPSIG
(
¡©us
è
	`__WSTOPSIG
 (
	`__WAIT_INT
 (¡©us))

	)

87 
	#WIFEXITED
(
¡©us
è
	`__WIFEXITED
 (
	`__WAIT_INT
 (¡©us))

	)

88 
	#WIFSIGNALED
(
¡©us
è
	`__WIFSIGNALED
 (
	`__WAIT_INT
 (¡©us))

	)

89 
	#WIFSTOPPED
(
¡©us
è
	`__WIFSTOPPED
 (
	`__WAIT_INT
 (¡©us))

	)

90 #ifdeà
__WIFCONTINUED


91 
	#WIFCONTINUED
(
¡©us
è
	`__WIFCONTINUED
 (
	`__WAIT_INT
 (¡©us))

	)

95 
__BEGIN_NAMESPACE_STD


99 
	mquÙ
;

100 
	m»m
;

101 } 
	tdiv_t
;

104 #iâdeà
__ldiv_t_defšed


107 
	mquÙ
;

108 
	m»m
;

109 } 
	tldiv_t
;

110 
	#__ldiv_t_defšed
 1

	)

112 
	g__END_NAMESPACE_STD


114 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__Îdiv_t_defšed


115 
__BEGIN_NAMESPACE_C99


117 
__ex‹nsiÚ__
 struct

119 
	mquÙ
;

120 
	m»m
;

121 } 
	tÎdiv_t
;

122 
	#__Îdiv_t_defšed
 1

	)

123 
	g__END_NAMESPACE_C99


128 
	#RAND_MAX
 2147483647

	)

133 
	#EXIT_FAILURE
 1

	)

134 
	#EXIT_SUCCESS
 0

	)

138 
	#MB_CUR_MAX
 (
	`__ùy³_g‘_mb_cur_max
 ())

	)

139 
size_t
 
	$__ùy³_g‘_mb_cur_max
 (è
__THROW
 
__wur
;

142 
__BEGIN_NAMESPACE_STD


144 
	$©of
 (cÚ¡ *
__ÅŒ
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

147 
	$©oi
 (cÚ¡ *
__ÅŒ
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

150 
	$©Ş
 (cÚ¡ *
__ÅŒ
)

151 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

152 
__END_NAMESPACE_STD


154 #ifdeà
__USE_ISOC99


155 
__BEGIN_NAMESPACE_C99


157 
__ex‹nsiÚ__
 
	$©Şl
 (cÚ¡ *
__ÅŒ
)

158 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

159 
__END_NAMESPACE_C99


162 
__BEGIN_NAMESPACE_STD


164 
	$¡¹od
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

165 **
__»¡riù
 
__’d±r
)

166 
__THROW
 
	`__nÚnuÎ
 ((1));

167 
__END_NAMESPACE_STD


169 #ifdef 
__USE_ISOC99


170 
__BEGIN_NAMESPACE_C99


172 
	$¡¹of
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

173 **
__»¡riù
 
__’d±r
è
__THROW
 
	`__nÚnuÎ
 ((1));

175 
	$¡¹Şd
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

176 **
__»¡riù
 
__’d±r
)

177 
__THROW
 
	`__nÚnuÎ
 ((1));

178 
__END_NAMESPACE_C99


181 
__BEGIN_NAMESPACE_STD


183 
	$¡¹Ş
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

184 **
__»¡riù
 
__’d±r
, 
__ba£
)

185 
__THROW
 
	`__nÚnuÎ
 ((1));

187 
	$¡¹oul
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

188 **
__»¡riù
 
__’d±r
, 
__ba£
)

189 
__THROW
 
	`__nÚnuÎ
 ((1));

190 
__END_NAMESPACE_STD


192 #ifdeà
__USE_MISC


194 
__ex‹nsiÚ__


195 
	$¡¹oq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

196 **
__»¡riù
 
__’d±r
, 
__ba£
)

197 
__THROW
 
	`__nÚnuÎ
 ((1));

199 
__ex‹nsiÚ__


200 
	$¡¹ouq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

201 **
__»¡riù
 
__’d±r
, 
__ba£
)

202 
__THROW
 
	`__nÚnuÎ
 ((1));

205 #ifdeà
__USE_ISOC99


206 
__BEGIN_NAMESPACE_C99


208 
__ex‹nsiÚ__


209 
	$¡¹Şl
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

210 **
__»¡riù
 
__’d±r
, 
__ba£
)

211 
__THROW
 
	`__nÚnuÎ
 ((1));

213 
__ex‹nsiÚ__


214 
	$¡¹ouÎ
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

215 **
__»¡riù
 
__’d±r
, 
__ba£
)

216 
__THROW
 
	`__nÚnuÎ
 ((1));

217 
__END_NAMESPACE_C99


221 #ifdeà
__USE_GNU


235 
	~<xloÿË.h
>

239 
	$¡¹Ş_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

240 **
__»¡riù
 
__’d±r
, 
__ba£
,

241 
__loÿË_t
 
__loc
è
__THROW
 
	`__nÚnuÎ
 ((1, 4));

243 
	$¡¹oul_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

244 **
__»¡riù
 
__’d±r
,

245 
__ba£
, 
__loÿË_t
 
__loc
)

246 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

248 
__ex‹nsiÚ__


249 
	$¡¹Şl_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

250 **
__»¡riù
 
__’d±r
, 
__ba£
,

251 
__loÿË_t
 
__loc
)

252 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

254 
__ex‹nsiÚ__


255 
	$¡¹ouÎ_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

256 **
__»¡riù
 
__’d±r
,

257 
__ba£
, 
__loÿË_t
 
__loc
)

258 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

260 
	$¡¹od_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

261 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

262 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

264 
	$¡¹of_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

265 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

266 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

268 
	$¡¹Şd_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

269 **
__»¡riù
 
__’d±r
,

270 
__loÿË_t
 
__loc
)

271 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

275 #ifdeà
__USE_EXTERN_INLINES


276 
__BEGIN_NAMESPACE_STD


277 
__ex‹º_šlše
 

278 
	`__NTH
 (
	$©oi
 (cÚ¡ *
__ÅŒ
))

280  (è
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

281 
	}
}

282 
__ex‹º_šlše
 

283 
__NTH
 (
	$©Ş
 (cÚ¡ *
__ÅŒ
))

285  
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

286 
	}
}

287 
	g__END_NAMESPACE_STD


289 #ifdeà
__USE_ISOC99


290 
__BEGIN_NAMESPACE_C99


291 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

292 
__NTH
 (
	$©Şl
 (cÚ¡ *
__ÅŒ
))

294  
	`¡¹Şl
 (
__ÅŒ
, (**è
NULL
, 10);

295 
	}
}

296 
	g__END_NAMESPACE_C99


301 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


305 *
	$l64a
 (
__n
è
__THROW
 
__wur
;

308 
	$a64l
 (cÚ¡ *
__s
)

309 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

313 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


314 
	~<sys/ty³s.h
>

321 
	$¿ndom
 (è
__THROW
;

324 
	$¤ªdom
 (
__£ed
è
__THROW
;

330 *
	$š™¡©e
 (
__£ed
, *
__¡©ebuf
,

331 
size_t
 
__¡©–’
è
__THROW
 
	`__nÚnuÎ
 ((2));

335 *
	$£t¡©e
 (*
__¡©ebuf
è
__THROW
 
	`__nÚnuÎ
 ((1));

338 #ifdeà
__USE_MISC


343 
	s¿ndom_d©a


345 
št32_t
 *
åŒ
;

346 
št32_t
 *
½Œ
;

347 
št32_t
 *
¡©e
;

348 
¿nd_ty³
;

349 
¿nd_deg
;

350 
¿nd_£p
;

351 
št32_t
 *
’d_±r
;

354 
	$¿ndom_r
 (
¿ndom_d©a
 *
__»¡riù
 
__buf
,

355 
št32_t
 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

357 
	$¤ªdom_r
 (
__£ed
, 
¿ndom_d©a
 *
__buf
)

358 
__THROW
 
	`__nÚnuÎ
 ((2));

360 
	$š™¡©e_r
 (
__£ed
, *
__»¡riù
 
__¡©ebuf
,

361 
size_t
 
__¡©–’
,

362 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

363 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

365 
	$£t¡©e_r
 (*
__»¡riù
 
__¡©ebuf
,

366 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

367 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

372 
__BEGIN_NAMESPACE_STD


374 
	$¿nd
 (è
__THROW
;

376 
	$¤ªd
 (
__£ed
è
__THROW
;

377 
__END_NAMESPACE_STD


379 #ifdeà
__USE_POSIX


381 
	$¿nd_r
 (*
__£ed
è
__THROW
;

385 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


389 
	$d¿nd48
 (è
__THROW
;

390 
	$”ªd48
 (
__xsubi
[3]è
__THROW
 
	`__nÚnuÎ
 ((1));

393 
	$Ìªd48
 (è
__THROW
;

394 
	$Äªd48
 (
__xsubi
[3])

395 
__THROW
 
	`__nÚnuÎ
 ((1));

398 
	$m¿nd48
 (è
__THROW
;

399 
	$j¿nd48
 (
__xsubi
[3])

400 
__THROW
 
	`__nÚnuÎ
 ((1));

403 
	$¤ªd48
 (
__£edv®
è
__THROW
;

404 *
	$£ed48
 (
__£ed16v
[3])

405 
__THROW
 
	`__nÚnuÎ
 ((1));

406 
	$lcÚg48
 (
__·¿m
[7]è
__THROW
 
	`__nÚnuÎ
 ((1));

408 #ifdeà
__USE_MISC


412 
	sd¿nd48_d©a


414 
__x
[3];

415 
__Şd_x
[3];

416 
__c
;

417 
__š™
;

418 
__ex‹nsiÚ__
 
__a
;

423 
	$d¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

424 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

425 
	$”ªd48_r
 (
__xsubi
[3],

426 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

427 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

430 
	$Ìªd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

431 *
__»¡riù
 
__»suÉ
)

432 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

433 
	$Äªd48_r
 (
__xsubi
[3],

434 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

435 *
__»¡riù
 
__»suÉ
)

436 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

439 
	$m¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

440 *
__»¡riù
 
__»suÉ
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

442 
	$j¿nd48_r
 (
__xsubi
[3],

443 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

444 *
__»¡riù
 
__»suÉ
)

445 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

448 
	$¤ªd48_r
 (
__£edv®
, 
d¿nd48_d©a
 *
__bufãr
)

449 
__THROW
 
	`__nÚnuÎ
 ((2));

451 
	$£ed48_r
 (
__£ed16v
[3],

452 
d¿nd48_d©a
 *
__bufãr
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$lcÚg48_r
 (
__·¿m
[7],

455 
d¿nd48_d©a
 *
__bufãr
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

462 #iâdeà
__m®loc_ªd_ÿÎoc_defšed


463 
	#__m®loc_ªd_ÿÎoc_defšed


	)

464 
__BEGIN_NAMESPACE_STD


466 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

468 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

469 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

470 
__END_NAMESPACE_STD


473 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


474 
__BEGIN_NAMESPACE_STD


480 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

481 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

483 
	$ä“
 (*
__±r
è
__THROW
;

484 
__END_NAMESPACE_STD


486 #ifdef 
__USE_MISC


488 
	$cä“
 (*
__±r
è
__THROW
;

491 #ifdeà
__USE_MISC


492 
	~<®loÿ.h
>

495 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

496 || 
defšed
 
__USE_MISC


498 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

501 #ifdeà
__USE_XOPEN2K


503 
	$posix_mem®ign
 (**
__mem±r
, 
size_t
 
__®ignm’t
, size_ˆ
__size
)

504 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

507 #ifdeà
__USE_ISOC11


509 *
	$®igÃd_®loc
 (
size_t
 
__®ignm’t
, size_ˆ
__size
)

510 
__THROW
 
__©Œibu‹_m®loc__
 
	`__©Œibu‹_®loc_size__
 ((2)è
__wur
;

513 
__BEGIN_NAMESPACE_STD


515 
	$abÜt
 (è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

519 
	$©ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

521 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


523 #ifdeà
__ılu¥lus


524 "C++" 
	$©_quick_ex™
 ((*
__func
) ())

525 
__THROW
 
	`__asm
 ("©_quick_ex™"è
	`__nÚnuÎ
 ((1));

527 
	$©_quick_ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

530 
__END_NAMESPACE_STD


532 #ifdef 
__USE_MISC


535 
	$Ú_ex™
 ((*
__func
è(
__¡©us
, *
__¬g
), *__arg)

536 
__THROW
 
	`__nÚnuÎ
 ((1));

539 
__BEGIN_NAMESPACE_STD


543 
	$ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

545 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


549 
	$quick_ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

551 
__END_NAMESPACE_STD


553 #ifdeà
__USE_ISOC99


554 
__BEGIN_NAMESPACE_C99


557 
	$_Ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

558 
__END_NAMESPACE_C99


562 
__BEGIN_NAMESPACE_STD


564 *
	$g‘’v
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

565 
__END_NAMESPACE_STD


567 #ifdeà
__USE_GNU


570 *
	$£cu»_g‘’v
 (cÚ¡ *
__Çme
)

571 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

574 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


578 
	$pu‹nv
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

581 #ifdeà
__USE_XOPEN2K


584 
	$£‹nv
 (cÚ¡ *
__Çme
, cÚ¡ *
__v®ue
, 
__»¶aû
)

585 
__THROW
 
	`__nÚnuÎ
 ((2));

588 
	$un£‹nv
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

591 #ifdef 
__USE_MISC


595 
	$ş—»nv
 (è
__THROW
;

599 #ià
defšed
 
__USE_MISC
 \

600 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
)

606 *
	$mk‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1));

609 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


618 #iâdeà
__USE_FILE_OFFSET64


619 
	$mk¡emp
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

621 #ifdeà
__REDIRECT


622 
	`__REDIRECT
 (
mk¡emp
, (*
__‹m¶©e
), 
mk¡emp64
)

623 
	`__nÚnuÎ
 ((1)è
__wur
;

625 
	#mk¡emp
 
mk¡emp64


	)

628 #ifdeà
__USE_LARGEFILE64


629 
	$mk¡emp64
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

633 #ifdeà
__USE_MISC


640 #iâdeà
__USE_FILE_OFFSET64


641 
	$mk¡emps
 (*
__‹m¶©e
, 
__suffixËn
è
	`__nÚnuÎ
 ((1)è
__wur
;

643 #ifdeà
__REDIRECT


644 
	`__REDIRECT
 (
mk¡emps
, (*
__‹m¶©e
, 
__suffixËn
),

645 
mk¡emps64
è
	`__nÚnuÎ
 ((1)è
__wur
;

647 
	#mk¡emps
 
mk¡emps64


	)

650 #ifdeà
__USE_LARGEFILE64


651 
	$mk¡emps64
 (*
__‹m¶©e
, 
__suffixËn
)

652 
	`__nÚnuÎ
 ((1)è
__wur
;

656 #ifdeà
__USE_XOPEN2K8


662 *
	$mkd‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

665 #ifdeà
__USE_GNU


672 #iâdeà
__USE_FILE_OFFSET64


673 
	$mko¡emp
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

675 #ifdeà
__REDIRECT


676 
	`__REDIRECT
 (
mko¡emp
, (*
__‹m¶©e
, 
__æags
), 
mko¡emp64
)

677 
	`__nÚnuÎ
 ((1)è
__wur
;

679 
	#mko¡emp
 
mko¡emp64


	)

682 #ifdeà
__USE_LARGEFILE64


683 
	$mko¡emp64
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

692 #iâdeà
__USE_FILE_OFFSET64


693 
	$mko¡emps
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

694 
	`__nÚnuÎ
 ((1)è
__wur
;

696 #ifdeà
__REDIRECT


697 
	`__REDIRECT
 (
mko¡emps
, (*
__‹m¶©e
, 
__suffixËn
,

698 
__æags
), 
mko¡emps64
)

699 
	`__nÚnuÎ
 ((1)è
__wur
;

701 
	#mko¡emps
 
mko¡emps64


	)

704 #ifdeà
__USE_LARGEFILE64


705 
	$mko¡emps64
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

706 
	`__nÚnuÎ
 ((1)è
__wur
;

711 
__BEGIN_NAMESPACE_STD


716 
	$sy¡em
 (cÚ¡ *
__commªd
è
__wur
;

717 
__END_NAMESPACE_STD


720 #ifdef 
__USE_GNU


723 *
	$ÿnÚiÿlize_fe_Çme
 (cÚ¡ *
__Çme
)

724 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

727 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


733 *
	$»®·th
 (cÚ¡ *
__»¡riù
 
__Çme
,

734 *
__»¡riù
 
__»sŞved
è
__THROW
 
__wur
;

739 #iâdeà
__COMPAR_FN_T


740 
	#__COMPAR_FN_T


	)

741 (*
	t__com·r_â_t
) (const *, const *);

743 #ifdef 
__USE_GNU


744 
__com·r_â_t
 
	tcom·risÚ_â_t
;

747 #ifdeà
__USE_GNU


748 (*
	t__com·r_d_â_t
) (const *, const *, *);

751 
__BEGIN_NAMESPACE_STD


754 *
	$b£¬ch
 (cÚ¡ *
__key
, cÚ¡ *
__ba£
,

755 
size_t
 
__nmemb
, size_ˆ
__size
, 
__com·r_â_t
 
__com·r
)

756 
	`__nÚnuÎ
 ((1, 2, 5)è
__wur
;

758 #ifdeà
__USE_EXTERN_INLINES


759 
	~<b™s/¡dlib-b£¬ch.h
>

764 
	$qsÜt
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

765 
__com·r_â_t
 
__com·r
è
	`__nÚnuÎ
 ((1, 4));

766 #ifdeà
__USE_GNU


767 
	$qsÜt_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

768 
__com·r_d_â_t
 
__com·r
, *
__¬g
)

769 
	`__nÚnuÎ
 ((1, 4));

774 
	$abs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

775 
	$Ïbs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

776 
__END_NAMESPACE_STD


778 #ifdeà
__USE_ISOC99


779 
__ex‹nsiÚ__
 
	$Îabs
 (
__x
)

780 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

784 
__BEGIN_NAMESPACE_STD


788 
div_t
 
	$div
 (
__num”
, 
__d’om
)

789 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

790 
ldiv_t
 
	$ldiv
 (
__num”
, 
__d’om
)

791 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

792 
__END_NAMESPACE_STD


794 #ifdeà
__USE_ISOC99


795 
__BEGIN_NAMESPACE_C99


796 
__ex‹nsiÚ__
 
Îdiv_t
 
	$Îdiv
 (
__num”
,

797 
__d’om
)

798 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

799 
__END_NAMESPACE_C99


803 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

804 || 
defšed
 
__USE_MISC


811 *
	$ecvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

812 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

817 *
	$fcvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

818 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

823 *
	$gcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

824 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

827 #ifdeà
__USE_MISC


829 *
	$qecvt
 (
__v®ue
, 
__ndig™
,

830 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

831 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

832 *
	$qfcvt
 (
__v®ue
, 
__ndig™
,

833 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

834 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

835 *
	$qgcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

836 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

841 
	$ecvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

842 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

843 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

844 
	$fcvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

845 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

846 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

848 
	$qecvt_r
 (
__v®ue
, 
__ndig™
,

849 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

850 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

851 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

852 
	$qfcvt_r
 (
__v®ue
, 
__ndig™
,

853 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

854 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

855 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

859 
__BEGIN_NAMESPACE_STD


862 
	$mbËn
 (cÚ¡ *
__s
, 
size_t
 
__n
è
__THROW
;

865 
	$mbtowc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

866 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

869 
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
è
__THROW
;

873 
size_t
 
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__pwcs
,

874 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

876 
size_t
 
	$wc¡ombs
 (*
__»¡riù
 
__s
,

877 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__pwcs
, 
size_t
 
__n
)

878 
__THROW
;

879 
__END_NAMESPACE_STD


882 #ifdeà
__USE_MISC


887 
	$½m©ch
 (cÚ¡ *
__»¥Ú£
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

891 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


898 
	$g‘subİt
 (**
__»¡riù
 
__İtiÚp
,

899 *cÚ¡ *
__»¡riù
 
__tok’s
,

900 **
__»¡riù
 
__v®u•
)

901 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3)è
__wur
;

905 #ifdeà
__USE_XOPEN


907 
	$£tkey
 (cÚ¡ *
__key
è
__THROW
 
	`__nÚnuÎ
 ((1));

913 #ifdeà
__USE_XOPEN2KXSI


915 
	$posix_İ’±
 (
__oæag
è
__wur
;

918 #ifdeà
__USE_XOPEN


923 
	$g¿Á±
 (
__fd
è
__THROW
;

927 
	$uÆock±
 (
__fd
è
__THROW
;

932 *
	$±¢ame
 (
__fd
è
__THROW
 
__wur
;

935 #ifdeà
__USE_GNU


939 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

940 
__THROW
 
	`__nÚnuÎ
 ((2));

943 
	`g‘±
 ();

946 #ifdeà
__USE_MISC


950 
	$g‘lßdavg
 (
__lßdavg
[], 
__ÃËm
)

951 
__THROW
 
	`__nÚnuÎ
 ((1));

954 
	~<b™s/¡dlib-æßt.h
>

957 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


958 
	~<b™s/¡dlib.h
>

960 #ifdeà
__LDBL_COMPAT


961 
	~<b™s/¡dlib-ldbl.h
>

965 #undeà
__Ãed_m®loc_ªd_ÿÎoc


967 
__END_DECLS


	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


30 
	#__Ãed_size_t


	)

31 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

35 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

36 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

40 
__BEGIN_NAMESPACE_STD


42 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

43 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

46 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

47 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

48 
__END_NAMESPACE_STD


53 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


54 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

60 
__BEGIN_NAMESPACE_STD


62 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

65 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

66 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

69 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


72 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

74 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

75 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

77 #ifdeà
__OPTIMIZE__


78 
__ex‹º_®ways_šlše
 *

79 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


81  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

84 
__ex‹º_®ways_šlše
 const *

85 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


87  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

90 
	}
}

92 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

93 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

95 
__END_NAMESPACE_STD


97 #ifdeà
__USE_GNU


100 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


101 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

103 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

104 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

106 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

107 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


112 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

117 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

123 
__BEGIN_NAMESPACE_STD


125 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

126 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

128 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

129 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

133 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

134 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

137 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

140 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

141 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

150 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

151 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

152 
__THROW
 
	`__nÚnuÎ
 ((2));

153 
__END_NAMESPACE_STD


155 #ifdeà
__USE_XOPEN2K8


159 
	~<xloÿË.h
>

162 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

163 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

165 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

166 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

169 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


171 *
	$¡rdup
 (cÚ¡ *
__s
)

172 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

178 #ià
defšed
 
__USE_XOPEN2K8


179 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

180 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

183 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


185 
	#¡rdu·
(
s
) \

186 (
__ex‹nsiÚ__
 \

188 cÚ¡ *
__Şd
 = (
s
); \

189 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

190 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

191 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

192 
	}
}))

	)

195 
	#¡ºdu·
(
s
, 
n
) \

196 (
__ex‹nsiÚ__
 \

198 cÚ¡ *
__Şd
 = (
s
); \

199 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

200 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

201 
__Ãw
[
__Ën
] = '\0'; \

202 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

203 }))

	)

206 
	g__BEGIN_NAMESPACE_STD


208 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


211 *
¡rchr
 (*
__s
, 
__c
)

212 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

213 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

214 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

216 #ifdeà
__OPTIMIZE__


217 
__ex‹º_®ways_šlše
 *

218 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


220  
__butš_¡rchr
 (
__s
, 
__c
);

223 
__ex‹º_®ways_šlše
 const *

224 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


226  
__butš_¡rchr
 (
__s
, 
__c
);

231 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

232 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

235 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


238 *
	`¡¼chr
 (*
__s
, 
__c
)

239 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

240 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

241 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

243 #ifdeà
__OPTIMIZE__


244 
__ex‹º_®ways_šlše
 *

245 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


247  
	`__butš_¡¼chr
 (
__s
, 
__c
);

250 
__ex‹º_®ways_šlše
 const *

251 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


253  
	`__butš_¡¼chr
 (
__s
, 
__c
);

256 
	}
}

258 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

259 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

261 
__END_NAMESPACE_STD


263 #ifdeà
__USE_GNU


266 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


267 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

268 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

269 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

270 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

272 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

273 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 
__BEGIN_NAMESPACE_STD


280 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

281 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

284 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

285 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

287 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


290 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

291 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

292 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

293 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

295 #ifdeà
__OPTIMIZE__


296 
__ex‹º_®ways_šlše
 *

297 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


299  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

302 
__ex‹º_®ways_šlše
 const *

303 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


305  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

308 
	}
}

310 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

311 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

314 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


317 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

318 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

319 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

320 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

322 #ifdeà
__OPTIMIZE__


323 
__ex‹º_®ways_šlše
 *

324 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


326  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

329 
__ex‹º_®ways_šlše
 const *

330 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


332  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

335 
	}
}

337 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

338 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

343 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

344 
__THROW
 
	`__nÚnuÎ
 ((2));

345 
__END_NAMESPACE_STD


349 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

350 cÚ¡ *
__»¡riù
 
__d–im
,

351 **
__»¡riù
 
__§ve_±r
)

352 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

353 #ifdeà
__USE_POSIX


354 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

355 **
__»¡riù
 
__§ve_±r
)

356 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

359 #ifdeà
__USE_GNU


361 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


362 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

363 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

364 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

365 cÚ¡ *
__ÃedË
)

366 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

368 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

369 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 #ifdeà
__USE_GNU


377 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

378 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

379 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

383 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

384 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

385 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

386 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

387 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

388 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

392 
__BEGIN_NAMESPACE_STD


394 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

395 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

396 
__END_NAMESPACE_STD


398 #ifdef 
__USE_XOPEN2K8


401 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

402 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

406 
__BEGIN_NAMESPACE_STD


408 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

409 
__END_NAMESPACE_STD


410 #ifdeà
__USE_XOPEN2K


418 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


421 #ifdeà
__REDIRECT_NTH


422 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

423 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

424 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

426 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

427 
__THROW
 
	`__nÚnuÎ
 ((2));

428 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

433 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

434 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

438 #ifdeà
__USE_XOPEN2K8


440 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

446 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

448 #ifdeà
__USE_MISC


450 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

451 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

457 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

458 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

461 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


464 *
	`šdex
 (*
__s
, 
__c
)

465 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

466 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

467 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

469 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


470 
__ex‹º_®ways_šlše
 *

471 
	`šdex
 (*
__s
, 
__c
è
__THROW


473  
	`__butš_šdex
 (
__s
, 
__c
);

476 
__ex‹º_®ways_šlše
 const *

477 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


479  
	`__butš_šdex
 (
__s
, 
__c
);

482 
	}
}

484 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

485 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

489 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


492 *
	`ršdex
 (*
__s
, 
__c
)

493 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

495 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

497 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


498 
__ex‹º_®ways_šlše
 *

499 
	`ršdex
 (*
__s
, 
__c
è
__THROW


501  
	`__butš_ršdex
 (
__s
, 
__c
);

504 
__ex‹º_®ways_šlše
 const *

505 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


507  
	`__butš_ršdex
 (
__s
, 
__c
);

510 
	}
}

512 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

513 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

518 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

522 #ifdef 
__USE_GNU


523 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

524 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

525 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

530 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

533 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

534 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

537 #ifdef 
__USE_GNU


540 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

541 
__loÿË_t
 
__loc
)

542 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

544 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

545 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

546 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

549 #ifdef 
__USE_MISC


552 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

553 cÚ¡ *
__»¡riù
 
__d–im
)

554 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdef 
__USE_XOPEN2K8


559 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

562 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

563 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

564 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

565 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

569 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

570 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

571 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

572 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

573 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

574 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

577 #ifdef 
__USE_GNU


579 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

580 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

583 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

586 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

588 #iâdeà
ba£Çme


593 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


594 "C++" *
	$ba£Çme
 (*
__f’ame
)

595 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

596 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

597 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

599 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

605 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

606 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

607 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ılu¥lus


627 
	~<b™s/¡ršg.h
>

630 
	~<b™s/¡ršg2.h
>

633 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


635 
	~<b™s/¡ršg3.h
>

639 #ià
defšed
 
__USE_GNU
 && defšed 
__OPTIMIZE__
 \

640 && 
defšed
 
__ex‹º_®ways_šlše
 && 
	$__GNUC_PREREQ
 (3,2)

641 #ià!
defšed
 
_FORCE_INLINES
 && !defšed 
_HAVE_STRING_ARCH_mempıy


643 #undeà
mempıy


644 #undeà
__mempıy


645 
	#mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

646 
	#__mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

648 
__ex‹º_®ways_šlše
 *

649 
	$__mempıy_šlše
 (*
__»¡riù
 
__de¡
,

650 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

652  (*è
	`memıy
 (
__de¡
, 
__¤c
, 
__n
) + __n;

653 
	}
}

658 
	g__END_DECLS


	@/usr/include/strings.h

18 #iâdef 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

24 #ià!
defšed
 
_STRING_H
 || !defšed 
__USE_MISC


26 
	~<ã©u»s.h
>

27 
	#__Ãed_size_t


	)

28 
	~<¡ddef.h
>

31 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

32 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

35 
	g__BEGIN_DECLS


37 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


39 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

40 
__THROW
 
__©Œibu‹_pu»__
;

43 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
è
__THROW
;

46 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
;

49 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


52 *
	`šdex
 (*
__s
, 
__c
)

53 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

54 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

55 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

57 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRING_H_PROTO


58 
__ex‹º_®ways_šlše
 *

59 
	`šdex
 (*
__s
, 
__c
è
__THROW


61  
	`__butš_šdex
 (
__s
, 
__c
);

64 
__ex‹º_®ways_šlše
 const *

65 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


67  
	`__butš_šdex
 (
__s
, 
__c
);

70 
	}
}

72 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

73 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

77 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


80 *
	`ršdex
 (*
__s
, 
__c
)

81 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

82 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

83 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

85 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRING_H_PROTO


86 
__ex‹º_®ways_šlše
 *

87 
	`ršdex
 (*
__s
, 
__c
è
__THROW


89  
	`__butš_ršdex
 (
__s
, 
__c
);

92 
__ex‹º_®ways_šlše
 const *

93 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


95  
	`__butš_ršdex
 (
__s
, 
__c
);

98 
	}
}

100 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

101 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

105 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8
 || defšed 
__USE_XOPEN2K8XSI


108 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((const));

112 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

113 
__THROW
 
__©Œibu‹_pu»__
;

116 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

117 
__THROW
 
__©Œibu‹_pu»__
;

119 #ifdef 
__USE_XOPEN2K8


123 
	~<xloÿË.h
>

127 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__loc
)

128 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

130 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

131 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

132 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

135 
__END_DECLS


	@/usr/include/stropts.h

18 #iâdeà
_STROPTS_H


19 
	#_STROPTS_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<b™s/ty³s.h
>

23 
	~<b™s/xt™y³s.h
>

25 #iâdeà
__gid_t_defšed


26 
__gid_t
 
	tgid_t
;

27 
	#__gid_t_defšed


	)

30 #iâdeà
__uid_t_defšed


31 
__uid_t
 
	tuid_t
;

32 
	#__uid_t_defšed


	)

35 
__t_sÿÏr_t
 
	tt_sÿÏr_t
;

36 
__t_usÿÏr_t
 
	tt_usÿÏr_t
;

39 
	~<b™s/¡rİts.h
>

42 
__BEGIN_DECLS


45 
	$i§¡»am
 (
__fdes
è
__THROW
;

51 
	`g‘msg
 (
__fdes
, 
¡rbuf
 *
__»¡riù
 
__ùÍŒ
,

52 
¡rbuf
 *
__»¡riù
 
__d©­Œ
,

53 *
__»¡riù
 
__æag¥
);

60 
	`g‘pmsg
 (
__fdes
, 
¡rbuf
 *
__»¡riù
 
__ùÍŒ
,

61 
¡rbuf
 *
__»¡riù
 
__d©­Œ
,

62 *
__»¡riù
 
__bªdp
, *__»¡riù 
__æag¥
);

67 
	$ioùl
 (
__fd
, 
__»que¡
, ...è
__THROW
;

73 
	`putmsg
 (
__fdes
, cÚ¡ 
¡rbuf
 *
__ùÍŒ
,

74 cÚ¡ 
¡rbuf
 *
__d©­Œ
, 
__æags
);

80 
	`pumsg
 (
__fdes
, cÚ¡ 
¡rbuf
 *
__ùÍŒ
,

81 cÚ¡ 
¡rbuf
 *
__d©­Œ
, 
__bªd
, 
__æags
);

85 
	$ç‰ach
 (
__fdes
, cÚ¡ *
__·th
è
__THROW
;

88 
	$fd‘ach
 (cÚ¡ *
__·th
è
__THROW
;

90 
__END_DECLS


	@/usr/include/syslog.h

1 
	~<sys/sy¦og.h
>

	@/usr/include/termios.h

22 #iâdef 
_TERMIOS_H


23 
	#_TERMIOS_H
 1

	)

25 
	~<ã©u»s.h
>

26 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


28 
	~<b™s/ty³s.h
>

29 #iâdeà
__pid_t_defšed


30 
__pid_t
 
	tpid_t
;

31 
	#__pid_t_defšed


	)

35 
	g__BEGIN_DECLS


39 
	~<b™s/‹rmios.h
>

41 #ifdeà
__USE_MISC


44 
	#CCEQ
(
v®
, 
c
è((cè=ğ(v®è&& (v®è!ğ
_POSIX_VDISABLE
)

	)

48 
¥“d_t
 
	$cfg‘o¥“d
 (cÚ¡ 
‹rmios
 *
__‹rmios_p
è
__THROW
;

51 
¥“d_t
 
	$cfg‘i¥“d
 (cÚ¡ 
‹rmios
 *
__‹rmios_p
è
__THROW
;

54 
	$cf£to¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

57 
	$cf£ti¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

59 #ifdef 
__USE_MISC


61 
	$cf£t¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

66 
	$tcg‘©Œ
 (
__fd
, 
‹rmios
 *
__‹rmios_p
è
__THROW
;

70 
	$tc£‰r
 (
__fd
, 
__İtiÚ®_aùiÚs
,

71 cÚ¡ 
‹rmios
 *
__‹rmios_p
è
__THROW
;

74 #ifdef 
__USE_MISC


76 
	$cfmak”aw
 (
‹rmios
 *
__‹rmios_p
è
__THROW
;

80 
	$tc£ndb»ak
 (
__fd
, 
__du¿tiÚ
è
__THROW
;

86 
	`tcd¿š
 (
__fd
);

90 
	$tcæush
 (
__fd
, 
__queue_£ËùÜ
è
__THROW
;

94 
	$tcæow
 (
__fd
, 
__aùiÚ
è
__THROW
;

97 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


99 
__pid_t
 
	$tcg‘sid
 (
__fd
è
__THROW
;

103 #ifdeà
__USE_MISC


104 
	~<sys/‰ydeçuÉs.h
>

107 
__END_DECLS


	@/usr/include/time.h

22 #iâdef 
_TIME_H


24 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

25 ! 
defšed
 
	g__Ãed_time¥ec
)

26 
	#_TIME_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


33 #ifdef 
_TIME_H


35 
	#__Ãed_size_t


	)

36 
	#__Ãed_NULL


	)

37 
	~<¡ddef.h
>

41 
	~<b™s/time.h
>

44 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


45 #iâdeà
CLK_TCK


46 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

52 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

53 
	#__şock_t_defšed
 1

	)

55 
	~<b™s/ty³s.h
>

57 
__BEGIN_NAMESPACE_STD


59 
__şock_t
 
	tşock_t
;

60 
	g__END_NAMESPACE_STD


61 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX


62 
	$__USING_NAMESPACE_STD
(
şock_t
)

66 #undeà
__Ãed_şock_t


68 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

69 
	#__time_t_defšed
 1

	)

71 
	~<b™s/ty³s.h
>

73 
__BEGIN_NAMESPACE_STD


75 
__time_t
 
	ttime_t
;

76 
__END_NAMESPACE_STD


77 #ifdeà
__USE_POSIX


78 
	$__USING_NAMESPACE_STD
(
time_t
)

82 #undeà
__Ãed_time_t


84 #ià!
defšed
 
__şockid_t_defšed
 && \

85 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

86 
	#__şockid_t_defšed
 1

	)

88 
	~<b™s/ty³s.h
>

91 
__şockid_t
 
	tşockid_t
;

94 #undeà
__şockid_time_t


96 #ià!
defšed
 
__tim”_t_defšed
 && \

97 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

98 
	#__tim”_t_defšed
 1

	)

100 
	~<b™s/ty³s.h
>

103 
__tim”_t
 
	ttim”_t
;

106 #undeà
__Ãed_tim”_t


109 #ià(!
defšed
 
__time¥ec_defšed
 \

110 && ((
defšed
 
_TIME_H
 \

111 && (
defšed
 
__USE_POSIX199309
 \

112 || 
defšed
 
__USE_ISOC11
)) \

113 || 
defšed
 
__Ãed_time¥ec
))

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
__sysÿÎ_¦Úg_t
 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_MISC


146 
tm_gmtoff
;

147 cÚ¡ *
tm_zÚe
;

149 
__tm_gmtoff
;

150 cÚ¡ *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 #ifdeà
__USE_ISOC11


182 
	#TIME_UTC
 1

	)

186 
__BEGIN_NAMESPACE_STD


189 
şock_t
 
	$şock
 (è
__THROW
;

192 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

195 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

196 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

199 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

205 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

206 cÚ¡ *
__»¡riù
 
__fÜm©
,

207 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

208 
__END_NAMESPACE_STD


210 #ifdeà
__USE_XOPEN


213 *
	$¡½time
 (cÚ¡ *
__»¡riù
 
__s
,

214 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
)

215 
__THROW
;

218 #ifdeà
__USE_XOPEN2K8


221 
	~<xloÿË.h
>

223 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

224 cÚ¡ *
__»¡riù
 
__fÜm©
,

225 cÚ¡ 
tm
 *
__»¡riù
 
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

229 #ifdeà
__USE_GNU


230 *
	$¡½time_l
 (cÚ¡ *
__»¡riù
 
__s
,

231 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
,

232 
__loÿË_t
 
__loc
è
__THROW
;

236 
__BEGIN_NAMESPACE_STD


239 
tm
 *
	$gmtime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

243 
tm
 *
	$loÿÉime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

244 
__END_NAMESPACE_STD


246 #ifdeà
__USE_POSIX


249 
tm
 *
	$gmtime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

250 
tm
 *
__»¡riù
 
__
è
__THROW
;

254 
tm
 *
	$loÿÉime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

255 
tm
 *
__»¡riù
 
__
è
__THROW
;

258 
__BEGIN_NAMESPACE_STD


261 *
	$asùime
 (cÚ¡ 
tm
 *
__
è
__THROW
;

264 *
	$ùime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

265 
__END_NAMESPACE_STD


267 #ifdeà
__USE_POSIX


272 *
	$asùime_r
 (cÚ¡ 
tm
 *
__»¡riù
 
__
,

273 *
__»¡riù
 
__buf
è
__THROW
;

276 *
	$ùime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

277 *
__»¡riù
 
__buf
è
__THROW
;

282 *
__tzÇme
[2];

283 
__daylight
;

284 
__timezÚe
;

287 #ifdef 
__USE_POSIX


289 *
tzÇme
[2];

293 
	$tz£t
 (è
__THROW
;

296 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


297 
daylight
;

298 
timezÚe
;

301 #ifdeà
__USE_MISC


304 
	$¡ime
 (cÚ¡ 
time_t
 *
__wh’
è
__THROW
;

310 
	#__i¦—p
(
y—r
) \

311 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

314 #ifdeà
__USE_MISC


319 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

322 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

325 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

329 #ifdeà
__USE_POSIX199309


334 
	`Çno¦“p
 (cÚ¡ 
time¥ec
 *
__»que¡ed_time
,

335 
time¥ec
 *
__»maššg
);

339 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

342 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

345 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, cÚ¡ 
time¥ec
 *
__
)

346 
__THROW
;

348 #ifdeà
__USE_XOPEN2K


353 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

354 cÚ¡ 
time¥ec
 *
__»q
,

355 
time¥ec
 *
__»m
);

358 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

363 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

364 
sigev’t
 *
__»¡riù
 
__evp
,

365 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

368 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

371 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

372 cÚ¡ 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

373 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

376 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

377 
__THROW
;

380 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

384 #ifdeà
__USE_ISOC11


386 
	$time¥ec_g‘
 (
time¥ec
 *
__ts
, 
__ba£
)

387 
__THROW
 
	`__nÚnuÎ
 ((1));

391 #ifdeà
__USE_XOPEN_EXTENDED


403 
g‘d©e_”r
;

412 
tm
 *
	`g‘d©e
 (cÚ¡ *
__¡ršg
);

415 #ifdeà
__USE_GNU


426 
	`g‘d©e_r
 (cÚ¡ *
__»¡riù
 
__¡ršg
,

427 
tm
 *
__»¡riù
 
__»sbuå
);

430 
__END_DECLS


	@/usr/include/ucontext.h

20 #iâdeà
_UCONTEXT_H


21 
	#_UCONTEXT_H
 1

	)

23 
	~<ã©u»s.h
>

26 
	~<sys/ucÚ‹xt.h
>

28 
__BEGIN_DECLS


31 
	$g‘cÚ‹xt
 (
ucÚ‹xt_t
 *
__uı
è
__THROWNL
;

34 
	$£tcÚ‹xt
 (cÚ¡ 
ucÚ‹xt_t
 *
__uı
è
__THROWNL
;

38 
	$sw­cÚ‹xt
 (
ucÚ‹xt_t
 *
__»¡riù
 
__ouı
,

39 cÚ¡ 
ucÚ‹xt_t
 *
__»¡riù
 
__uı
è
__THROWNL
;

47 
	$makecÚ‹xt
 (
ucÚ‹xt_t
 *
__uı
, (*
__func
) (),

48 
__¬gc
, ...è
__THROW
;

50 
__END_DECLS


	@/usr/include/unistd.h

22 #iâdef 
_UNISTD_H


23 
	#_UNISTD_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


32 #ifdeà
__USE_XOPEN2K8


34 
	#_POSIX_VERSION
 200809L

	)

35 #–ià
defšed
 
__USE_XOPEN2K


37 
	#_POSIX_VERSION
 200112L

	)

38 #–ià
defšed
 
__USE_POSIX199506


40 
	#_POSIX_VERSION
 199506L

	)

41 #–ià
defšed
 
__USE_POSIX199309


43 
	#_POSIX_VERSION
 199309L

	)

46 
	#_POSIX_VERSION
 199009L

	)

52 #ifdeà
__USE_XOPEN2K8


53 
	#__POSIX2_THIS_VERSION
 200809L

	)

55 #–ià
defšed
 
__USE_XOPEN2K


57 
	#__POSIX2_THIS_VERSION
 200112L

	)

58 #–ià
defšed
 
__USE_POSIX199506


60 
	#__POSIX2_THIS_VERSION
 199506L

	)

63 
	#__POSIX2_THIS_VERSION
 199209L

	)

67 
	#_POSIX2_VERSION
 
__POSIX2_THIS_VERSION


	)

70 
	#_POSIX2_C_VERSION
 
__POSIX2_THIS_VERSION


	)

74 
	#_POSIX2_C_BIND
 
__POSIX2_THIS_VERSION


	)

78 
	#_POSIX2_C_DEV
 
__POSIX2_THIS_VERSION


	)

82 
	#_POSIX2_SW_DEV
 
__POSIX2_THIS_VERSION


	)

86 
	#_POSIX2_LOCALEDEF
 
__POSIX2_THIS_VERSION


	)

89 #ifdeà
__USE_XOPEN2K8


90 
	#_XOPEN_VERSION
 700

	)

91 #–ià
defšed
 
__USE_XOPEN2K


92 
	#_XOPEN_VERSION
 600

	)

93 #–ià
defšed
 
__USE_UNIX98


94 
	#_XOPEN_VERSION
 500

	)

96 
	#_XOPEN_VERSION
 4

	)

100 
	#_XOPEN_XCU_VERSION
 4

	)

103 
	#_XOPEN_XPG2
 1

	)

104 
	#_XOPEN_XPG3
 1

	)

105 
	#_XOPEN_XPG4
 1

	)

108 
	#_XOPEN_UNIX
 1

	)

111 
	#_XOPEN_CRYPT
 1

	)

115 
	#_XOPEN_ENH_I18N
 1

	)

118 
	#_XOPEN_LEGACY
 1

	)

205 
	~<b™s/posix_İt.h
>

208 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


209 
	~<b™s/’vœÚm’ts.h
>

213 
	#STDIN_FILENO
 0

	)

214 
	#STDOUT_FILENO
 1

	)

215 
	#STDERR_FILENO
 2

	)

220 
	~<b™s/ty³s.h
>

222 #iâdef 
__ssize_t_defšed


223 
__ssize_t
 
	tssize_t
;

224 
	#__ssize_t_defšed


	)

227 
	#__Ãed_size_t


	)

228 
	#__Ãed_NULL


	)

229 
	~<¡ddef.h
>

231 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


234 #iâdeà
__gid_t_defšed


235 
__gid_t
 
	tgid_t
;

236 
	#__gid_t_defšed


	)

239 #iâdeà
__uid_t_defšed


240 
__uid_t
 
	tuid_t
;

241 
	#__uid_t_defšed


	)

244 #iâdeà
__off_t_defšed


245 #iâdeà
__USE_FILE_OFFSET64


246 
__off_t
 
	toff_t
;

248 
__off64_t
 
	toff_t
;

250 
	#__off_t_defšed


	)

252 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


253 
__off64_t
 
	toff64_t
;

254 
	#__off64_t_defšed


	)

257 #iâdeà
__u£cÚds_t_defšed


258 
__u£cÚds_t
 
	tu£cÚds_t
;

259 
	#__u£cÚds_t_defšed


	)

262 #iâdeà
__pid_t_defšed


263 
__pid_t
 
	tpid_t
;

264 
	#__pid_t_defšed


	)

268 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


269 #iâdeà
__šŒ_t_defšed


270 
__šŒ_t
 
	tšŒ_t
;

271 
	#__šŒ_t_defšed


	)

275 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


276 #iâdeà
__sockËn_t_defšed


277 
__sockËn_t
 
	tsockËn_t
;

278 
	#__sockËn_t_defšed


	)

284 
	#R_OK
 4

	)

285 
	#W_OK
 2

	)

286 
	#X_OK
 1

	)

287 
	#F_OK
 0

	)

290 
	$acûss
 (cÚ¡ *
__Çme
, 
__ty³
è
__THROW
 
	`__nÚnuÎ
 ((1));

292 #ifdeà
__USE_GNU


295 
	$euidacûss
 (cÚ¡ *
__Çme
, 
__ty³
)

296 
__THROW
 
	`__nÚnuÎ
 ((1));

299 
	$—cûss
 (cÚ¡ *
__Çme
, 
__ty³
)

300 
__THROW
 
	`__nÚnuÎ
 ((1));

303 #ifdeà
__USE_ATFILE


307 
	$çcûs§t
 (
__fd
, cÚ¡ *
__fe
, 
__ty³
, 
__æag
)

308 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

313 #iâdef 
_STDIO_H


314 
	#SEEK_SET
 0

	)

315 
	#SEEK_CUR
 1

	)

316 
	#SEEK_END
 2

	)

317 #ifdeà
__USE_GNU


318 
	#SEEK_DATA
 3

	)

319 
	#SEEK_HOLE
 4

	)

323 #ià
defšed
 
__USE_MISC
 && !defšed 
L_SET


325 
	#L_SET
 
SEEK_SET


	)

326 
	#L_INCR
 
SEEK_CUR


	)

327 
	#L_XTND
 
SEEK_END


	)

336 #iâdeà
__USE_FILE_OFFSET64


337 
__off_t
 
	$l£ek
 (
__fd
, 
__off_t
 
__off£t
, 
__wh’û
è
__THROW
;

339 #ifdeà
__REDIRECT_NTH


340 
__off64_t
 
	`__REDIRECT_NTH
 (
l£ek
,

341 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
),

342 
l£ek64
);

344 
	#l£ek
 
l£ek64


	)

347 #ifdeà
__USE_LARGEFILE64


348 
__off64_t
 
	$l£ek64
 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
)

349 
__THROW
;

356 
	`şo£
 (
__fd
);

363 
ssize_t
 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
è
__wur
;

369 
ssize_t
 
	$wr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
è
__wur
;

371 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


372 #iâdeà
__USE_FILE_OFFSET64


379 
ssize_t
 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

380 
__off_t
 
__off£t
è
__wur
;

387 
ssize_t
 
	$pwr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

388 
__off_t
 
__off£t
è
__wur
;

389 
ssize_t
 
	$pwr™e_sync
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

390 
__off_t
 
__off£t
è
__wur
;

392 #ifdeà
__REDIRECT


393 
ssize_t
 
	`__REDIRECT
 (
´—d
, (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

394 
__off64_t
 
__off£t
),

395 
´—d64
è
__wur
;

396 
ssize_t
 
	`__REDIRECT
 (
pwr™e
, (
__fd
, cÚ¡ *
__buf
,

397 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

398 
pwr™e64
è
__wur
;

399 
ssize_t
 
	`__REDIRECT
 (
pwr™e_sync
, (
__fd
, cÚ¡ *
__buf
,

400 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

401 
pwr™e64_sync
è
__wur
;

404 
	#´—d
 
´—d64


	)

405 
	#pwr™e
 
pwr™e64


	)

406 
	#pwr™e_sync
 
pwr™e64_sync


	)

410 #ifdeà
__USE_LARGEFILE64


414 
ssize_t
 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

415 
__off64_t
 
__off£t
è
__wur
;

418 
ssize_t
 
	$pwr™e64
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

419 
__off64_t
 
__off£t
è
__wur
;

420 
ssize_t
 
	$pwr™e64_sync
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

421 
__off64_t
 
__off£t
è
__wur
;

429 
	$pe
 (
__pedes
[2]è
__THROW
 
__wur
;

431 #ifdeà
__USE_GNU


434 
	$pe2
 (
__pedes
[2], 
__æags
è
__THROW
 
__wur
;

444 
	$®¬m
 (
__£cÚds
è
__THROW
;

456 
	`¦“p
 (
__£cÚds
);

458 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

459 || 
defšed
 
__USE_MISC


464 
__u£cÚds_t
 
	$u®¬m
 (
__u£cÚds_t
 
__v®ue
, __u£cÚds_ˆ
__š‹rv®
)

465 
__THROW
;

472 
	`u¦“p
 (
__u£cÚds_t
 
__u£cÚds
);

481 
	`·u£
 ();

485 
	$chown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

486 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

488 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


490 
	$fchown
 (
__fd
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
è
__THROW
 
__wur
;

495 
	$lchown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

496 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

500 #ifdeà
__USE_ATFILE


503 
	$fchowÇt
 (
__fd
, cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
,

504 
__gid_t
 
__group
, 
__æag
)

505 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

509 
	$chdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

511 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


513 
	$fchdœ
 (
__fd
è
__THROW
 
__wur
;

523 *
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
è
__THROW
 
__wur
;

525 #ifdef 
__USE_GNU


529 *
	$g‘_cu¼’t_dœ_Çme
 (è
__THROW
;

532 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

533 || 
defšed
 
__USE_MISC


537 *
	$g‘wd
 (*
__buf
)

538 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
;

543 
	$dup
 (
__fd
è
__THROW
 
__wur
;

546 
	$dup2
 (
__fd
, 
__fd2
è
__THROW
;

548 #ifdeà
__USE_GNU


551 
	$dup3
 (
__fd
, 
__fd2
, 
__æags
è
__THROW
;

555 **
__’vœÚ
;

556 #ifdeà
__USE_GNU


557 **
’vœÚ
;

563 
	$execve
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[],

564 *cÚ¡ 
__’vp
[]è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

566 #ifdeà
__USE_XOPEN2K8


569 
	$ãxecve
 (
__fd
, *cÚ¡ 
__¬gv
[], *cÚ¡ 
__’vp
[])

570 
__THROW
 
	`__nÚnuÎ
 ((2));

575 
	$execv
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[])

576 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

580 
	$exeşe
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

581 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

585 
	$exeş
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

586 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

590 
	$execvp
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[])

591 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

596 
	$exeşp
 (cÚ¡ *
__fe
, cÚ¡ *
__¬g
, ...)

597 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

599 #ifdeà
__USE_GNU


602 
	$execv³
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[],

603 *cÚ¡ 
__’vp
[])

604 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

608 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


610 
	$niû
 (
__šc
è
__THROW
 
__wur
;

615 
	$_ex™
 (
__¡©us
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

621 
	~<b™s/cÚâame.h
>

624 
	$·thcÚf
 (cÚ¡ *
__·th
, 
__Çme
)

625 
__THROW
 
	`__nÚnuÎ
 ((1));

628 
	$å©hcÚf
 (
__fd
, 
__Çme
è
__THROW
;

631 
	$syscÚf
 (
__Çme
è
__THROW
;

633 #ifdef 
__USE_POSIX2


635 
size_t
 
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

640 
__pid_t
 
	$g‘pid
 (è
__THROW
;

643 
__pid_t
 
	$g‘µid
 (è
__THROW
;

646 
__pid_t
 
	$g‘pg½
 (è
__THROW
;

649 
__pid_t
 
	$__g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

650 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


651 
__pid_t
 
	$g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

658 
	$£gid
 (
__pid_t
 
__pid
, __pid_ˆ
__pgid
è
__THROW
;

660 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


672 
	$£g½
 (è
__THROW
;

679 
__pid_t
 
	$£tsid
 (è
__THROW
;

681 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


683 
__pid_t
 
	$g‘sid
 (
__pid_t
 
__pid
è
__THROW
;

687 
__uid_t
 
	$g‘uid
 (è
__THROW
;

690 
__uid_t
 
	$g‘euid
 (è
__THROW
;

693 
__gid_t
 
	$g‘gid
 (è
__THROW
;

696 
__gid_t
 
	$g‘egid
 (è
__THROW
;

701 
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]è
__THROW
 
__wur
;

703 #ifdef 
__USE_GNU


705 
	$group_memb”
 (
__gid_t
 
__gid
è
__THROW
;

712 
	$£tuid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

714 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


717 
	$£Œeuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
è
__THROW
 
__wur
;

720 #ifdeà
__USE_XOPEN2K


722 
	$£‹uid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

729 
	$£tgid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

731 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


734 
	$£Œegid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
è
__THROW
 
__wur
;

737 #ifdeà
__USE_XOPEN2K


739 
	$£‹gid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

742 #ifdeà
__USE_GNU


745 
	$g‘»suid
 (
__uid_t
 *
__ruid
, __uid_ˆ*
__euid
, __uid_ˆ*
__suid
)

746 
__THROW
;

750 
	$g‘»sgid
 (
__gid_t
 *
__rgid
, __gid_ˆ*
__egid
, __gid_ˆ*
__sgid
)

751 
__THROW
;

755 
	$£Œesuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
, __uid_ˆ
__suid
)

756 
__THROW
 
__wur
;

760 
	$£Œesgid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
, __gid_ˆ
__sgid
)

761 
__THROW
 
__wur
;

768 
__pid_t
 
	$fÜk
 (è
__THROWNL
;

770 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

771 || 
defšed
 
__USE_MISC


776 
__pid_t
 
	$vfÜk
 (è
__THROW
;

782 *
	$‰yÇme
 (
__fd
è
__THROW
;

786 
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

787 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

791 
	$i§‰y
 (
__fd
è
__THROW
;

793 #ià
defšed
 
__USE_MISC
 \

794 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_UNIX98
)

797 
	$‰y¦Ù
 (è
__THROW
;

802 
	$lšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

803 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

805 #ifdeà
__USE_ATFILE


808 
	$lšk©
 (
__äomfd
, cÚ¡ *
__äom
, 
__tofd
,

809 cÚ¡ *
__to
, 
__æags
)

810 
__THROW
 
	`__nÚnuÎ
 ((2, 4)è
__wur
;

813 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


815 
	$symlšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

816 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

821 
ssize_t
 
	$»adlšk
 (cÚ¡ *
__»¡riù
 
__·th
,

822 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

823 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

826 #ifdeà
__USE_ATFILE


828 
	$symlšk©
 (cÚ¡ *
__äom
, 
__tofd
,

829 cÚ¡ *
__to
è
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

832 
ssize_t
 
	$»adlšk©
 (
__fd
, cÚ¡ *
__»¡riù
 
__·th
,

833 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

834 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

838 
	$uÆšk
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

840 #ifdeà
__USE_ATFILE


842 
	$uÆšk©
 (
__fd
, cÚ¡ *
__Çme
, 
__æag
)

843 
__THROW
 
	`__nÚnuÎ
 ((2));

847 
	$rmdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1));

851 
__pid_t
 
	$tcg‘pg½
 (
__fd
è
__THROW
;

854 
	$tc£g½
 (
__fd
, 
__pid_t
 
__pg½_id
è
__THROW
;

861 *
	`g‘logš
 ();

862 #ià
defšed
 
__USE_REENTRANT
 || defšed 
__USE_POSIX199506


869 
	$g‘logš_r
 (*
__Çme
, 
size_t
 
__Çme_Ën
è
	`__nÚnuÎ
 ((1));

872 #ifdef 
__USE_MISC


874 
	$£ogš
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

878 #ifdef 
__USE_POSIX2


882 
	#__Ãed_g‘İt


	)

883 
	~<g‘İt.h
>

887 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


891 
	$g‘ho¡Çme
 (*
__Çme
, 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((1));

895 #ià
defšed
 
__USE_MISC


898 
	$£tho¡Çme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

899 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

903 
	$£tho¡id
 (
__id
è
__THROW
 
__wur
;

909 
	$g‘domašÇme
 (*
__Çme
, 
size_t
 
__Ën
)

910 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

911 
	$£tdomašÇme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

912 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

918 
	$vhªgup
 (è
__THROW
;

921 
	$»voke
 (cÚ¡ *
__fe
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

929 
	$´of
 (*
__§m¶e_bufãr
, 
size_t
 
__size
,

930 
size_t
 
__off£t
, 
__sÿË
)

931 
__THROW
 
	`__nÚnuÎ
 ((1));

937 
	$acù
 (cÚ¡ *
__Çme
è
__THROW
;

941 *
	$g‘u£rsh–l
 (è
__THROW
;

942 
	$’du£rsh–l
 (è
__THROW
;

943 
	$£tu£rsh–l
 (è
__THROW
;

949 
	$d«mÚ
 (
__nochdœ
, 
__noşo£
è
__THROW
 
__wur
;

953 #ià
defšed
 
__USE_MISC
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

956 
	$chroÙ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

960 *
	$g‘·ss
 (cÚ¡ *
__´om±
è
	`__nÚnuÎ
 ((1));

968 
	`fsync
 (
__fd
);

971 #ifdeà
__USE_GNU


974 
	$syncfs
 (
__fd
è
__THROW
;

978 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


981 
	`g‘ho¡id
 ();

984 
	$sync
 (è
__THROW
;

987 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K


990 
	$g‘·gesize
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

995 
	$g‘dbËsize
 (è
__THROW
;

1001 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


1004 #iâdeà
__USE_FILE_OFFSET64


1005 
	$Œunÿ‹
 (cÚ¡ *
__fe
, 
__off_t
 
__Ëngth
)

1006 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1008 #ifdeà
__REDIRECT_NTH


1009 
	`__REDIRECT_NTH
 (
Œunÿ‹
,

1010 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
),

1011 
Œunÿ‹64
è
	`__nÚnuÎ
 ((1)è
__wur
;

1013 
	#Œunÿ‹
 
Œunÿ‹64


	)

1016 #ifdeà
__USE_LARGEFILE64


1017 
	$Œunÿ‹64
 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
)

1018 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1023 #ià
defšed
 
__USE_POSIX199309
 \

1024 || 
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


1027 #iâdeà
__USE_FILE_OFFSET64


1028 
	$árunÿ‹
 (
__fd
, 
__off_t
 
__Ëngth
è
__THROW
 
__wur
;

1030 #ifdeà
__REDIRECT_NTH


1031 
	`__REDIRECT_NTH
 (
árunÿ‹
, (
__fd
, 
__off64_t
 
__Ëngth
),

1032 
árunÿ‹64
è
__wur
;

1034 
	#árunÿ‹
 
árunÿ‹64


	)

1037 #ifdeà
__USE_LARGEFILE64


1038 
	$árunÿ‹64
 (
__fd
, 
__off64_t
 
__Ëngth
è
__THROW
 
__wur
;

1044 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

1045 || 
defšed
 
__USE_MISC


1049 
	$brk
 (*
__addr
è
__THROW
 
__wur
;

1055 *
	$sbrk
 (
šŒ_t
 
__d–
è
__THROW
;

1059 #ifdeà
__USE_MISC


1070 
	$sysÿÎ
 (
__sy¢o
, ...è
__THROW
;

1075 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
è&& !defšed 
F_LOCK


1087 
	#F_ULOCK
 0

	)

1088 
	#F_LOCK
 1

	)

1089 
	#F_TLOCK
 2

	)

1090 
	#F_TEST
 3

	)

1092 #iâdeà
__USE_FILE_OFFSET64


1093 
	$lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
è
__wur
;

1095 #ifdeà
__REDIRECT


1096 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
),

1097 
lockf64
è
__wur
;

1099 
	#lockf
 
lockf64


	)

1102 #ifdeà
__USE_LARGEFILE64


1103 
	$lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
è
__wur
;

1108 #ifdeà
__USE_GNU


1113 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

1114 (
__ex‹nsiÚ__
 \

1115 ({ 
__»suÉ
; \

1116 dØ
__»suÉ
 = (è(
ex´essiÚ
); \

1117 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

1118 
__»suÉ
; 
	}
}))

	)

1121 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


1124 
fd©async
 (
__fdes
);

1130 #ifdef 
__USE_XOPEN


1132 *
	$üy±
 (cÚ¡ *
__key
, cÚ¡ *
__§É
)

1133 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1137 
	$’üy±
 (*
__glibc_block
, 
__edæag
)

1138 
__THROW
 
	`__nÚnuÎ
 ((1));

1145 
	$swab
 (cÚ¡ *
__»¡riù
 
__äom
, *__»¡riù 
__to
,

1146 
ssize_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1152 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K


1154 *
	$ù”mid
 (*
__s
è
__THROW
;

1159 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


1160 
	~<b™s/uni¡d.h
>

1163 
__END_DECLS


	@/usr/include/unwind.h

26 #iâdeà
_UNWIND_H


27 
	#_UNWIND_H


	)

30 
	~<¡dšt.h
>

32 #ifdeà
__ılu¥lus


42 
_URC_NO_REASON
 = 0,

43 
_URC_FOREIGN_EXCEPTION_CAUGHT
 = 1,

44 
_URC_FATAL_PHASE2_ERROR
 = 2,

45 
_URC_FATAL_PHASE1_ERROR
 = 3,

46 
_URC_NORMAL_STOP
 = 4,

47 
_URC_END_OF_STACK
 = 5,

48 
_URC_HANDLER_FOUND
 = 6,

49 
_URC_INSTALL_CONTEXT
 = 7,

50 
_URC_CONTINUE_UNWIND
 = 8

52 
	t_Unwšd_R—sÚ_Code
;

54 
	t_Unwšd_AùiÚ
;

56 
	#_UA_SEARCH_PHASE
 1

	)

57 
	#_UA_CLEANUP_PHASE
 2

	)

58 
	#_UA_HANDLER_FRAME
 4

	)

59 
	#_UA_FORCE_UNWIND
 8

	)

61 
_Unwšd_CÚ‹xt
;

62 
_Unwšd_Exû±iÚ
;

64 (*
_Unwšd_Exû±iÚ_CËªup_Fn
è(
	t_Unwšd_R—sÚ_Code
,

65 
	t_Unwšd_Exû±iÚ
 *);

67 
_Unwšd_R—sÚ_Code
 (*
	t_Unwšd_Stİ_Fn
è(, 
	t_Unwšd_AùiÚ
,

68 
	tušt64_t
,

69 
	t_Unwšd_Exû±iÚ
 *,

70 
	t_Unwšd_CÚ‹xt
 *,

77 
	s_Unwšd_Exû±iÚ


79 
ušt64_t
 
exû±iÚ_şass
;

80 
_Unwšd_Exû±iÚ_CËªup_Fn
 
exû±iÚ_ş—nup
;

81 
´iv©e_1
;

82 
´iv©e_2
;

83 } 
__©Œibu‹__
((
__®igÃd__
));

85 
_Unwšd_R—sÚ_Code
 
_Unwšd_Rai£Exû±iÚ
 (
_Unwšd_Exû±iÚ
 *);

86 
_Unwšd_R—sÚ_Code
 
_Unwšd_FÜûdUnwšd
 (
_Unwšd_Exû±iÚ
 *,

87 
_Unwšd_Stİ_Fn
, *);

88 
_Unwšd_Resume
 (
_Unwšd_Exû±iÚ
 *);

89 
_Unwšd_D–‘eExû±iÚ
 (
_Unwšd_Exû±iÚ
 *);

90 
_Unwšd_G‘GR
 (
_Unwšd_CÚ‹xt
 *, );

91 
_Unwšd_S‘GR
 (
_Unwšd_CÚ‹xt
 *, , );

92 
_Unwšd_G‘IP
 (
_Unwšd_CÚ‹xt
 *);

93 
_Unwšd_G‘IPInfo
 (
_Unwšd_CÚ‹xt
 *, *);

94 
_Unwšd_S‘IP
 (
_Unwšd_CÚ‹xt
 *, );

95 
_Unwšd_G‘LªguageS³cificD©a
 (
_Unwšd_CÚ‹xt
*);

96 
_Unwšd_G‘RegiÚS¹
 (
_Unwšd_CÚ‹xt
 *);

98 #ifdeà
_GNU_SOURCE


102 
_Unwšd_R—sÚ_Code
 (*
	t_Unwšd_T¿û_Fn
è(
	t_Unwšd_CÚ‹xt
 *,

107 
	#_UA_END_OF_STACK
 16

	)

112 
_Unwšd_R—sÚ_Code


113 
_Unwšd_Resume_Ü_R‘hrow
 (
_Unwšd_Exû±iÚ
 *);

117 
_Unwšd_G‘BSP
 (
_Unwšd_CÚ‹xt
 *);

121 
_Unwšd_G‘CFA
 (
_Unwšd_CÚ‹xt
 *);

124 
_Unwšd_G‘D©aR–Ba£
 (
_Unwšd_CÚ‹xt
 *);

127 
_Unwšd_G‘TextR–Ba£
 (
_Unwšd_CÚ‹xt
 *);

135 
_Unwšd_R—sÚ_Code
 
_Unwšd_BackŒaû
 (
_Unwšd_T¿û_Fn
, *);

143 *
_Unwšd_FšdEnşosšgFunùiÚ
 (*);

150 #ifdeà
__ılu¥lus


	@/usr/include/wchar.h

23 #iâdeà
_WCHAR_H


25 #ià!
defšed
 
__Ãed_mb¡©e_t
 && !defšed 
__Ãed_wšt_t


26 
	#_WCHAR_H
 1

	)

27 
	~<ã©u»s.h
>

30 #ifdeà
_WCHAR_H


32 
	#__Ãed___FILE


	)

33 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


34 
	#__Ãed_FILE


	)

36 
	~<¡dio.h
>

38 
	#__Ãed___va_li¡


	)

39 
	~<¡d¬g.h
>

41 
	~<b™s/wch¬.h
>

44 
	#__Ãed_size_t


	)

45 
	#__Ãed_wch¬_t


	)

46 
	#__Ãed_NULL


	)

48 #ià
defšed
 
_WCHAR_H
 || defšed 
__Ãed_wšt_t
 || !defšed 
__WINT_TYPE__


49 #undeà
__Ãed_wšt_t


50 
	#__Ãed_wšt_t


	)

51 
	~<¡ddef.h
>

55 #iâdeà
_WINT_T


60 
	#_WINT_T


	)

61 
	twšt_t
;

65 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES
 \

66 && 
defšed
 
__WINT_TYPE__


67 
__BEGIN_NAMESPACE_STD


68 
__WINT_TYPE__
 
	twšt_t
;

69 
	g__END_NAMESPACE_STD


74 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

75 
	#__CORRECT_ISO_CPP_WCHAR_H_PROTO


	)

79 #ià(
defšed
 
_WCHAR_H
 || defšed 
__Ãed_mb¡©e_t
è&& !defšed 
____mb¡©e_t_defšed


80 
	#____mb¡©e_t_defšed
 1

	)

84 
	m__couÁ
;

87 #ifdeà
__WINT_TYPE__


88 
__WINT_TYPE__
 
	m__wch
;

90 
wšt_t
 
	m__wch
;

92 
	m__wchb
[4];

93 } 
	m__v®ue
;

94 } 
	t__mb¡©e_t
;

96 #undeà
__Ãed_mb¡©e_t


101 #ifdeà
_WCHAR_H


103 #iâdeà
__mb¡©e_t_defšed


104 
__BEGIN_NAMESPACE_C99


106 
__mb¡©e_t
 
	tmb¡©e_t
;

107 
	g__END_NAMESPACE_C99


108 
	#__mb¡©e_t_defšed
 1

	)

111 #ifdeà
__USE_GNU


112 
	$__USING_NAMESPACE_C99
(
mb¡©e_t
)

115 #iâdeà
WCHAR_MIN


117 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

118 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

121 #iâdeà
WEOF


122 
	#WEOF
 (0xffffffffu)

	)

127 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_UNIX98


128 
	~<wùy³.h
>

132 
__BEGIN_DECLS


134 
__BEGIN_NAMESPACE_STD


137 
tm
;

138 
__END_NAMESPACE_STD


142 
	$__USING_NAMESPACE_STD
(
tm
)

145 
__BEGIN_NAMESPACE_STD


147 
wch¬_t
 *
	$wcsıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

148 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
)

149 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

152 
wch¬_t
 *
	$wc¢ıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

153 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

154 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

157 
wch¬_t
 *
	$wcsÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

158 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
)

159 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

161 
wch¬_t
 *
	$wc¢ÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

162 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

163 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

166 
	$wcscmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
)

167 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

169 
	$wc¢cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

170 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

171 
__END_NAMESPACE_STD


173 #ifdeà
__USE_XOPEN2K8


175 
	$wcsÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

178 
	$wc¢ÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

179 
size_t
 
__n
è
__THROW
;

183 
	~<xloÿË.h
>

185 
	$wcsÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

186 
__loÿË_t
 
__loc
è
__THROW
;

188 
	$wc¢ÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

189 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

192 
__BEGIN_NAMESPACE_STD


195 
	$wcscŞl
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

199 
size_t
 
	$wcsxäm
 (
wch¬_t
 *
__»¡riù
 
__s1
,

200 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

201 
__END_NAMESPACE_STD


203 #ifdeà
__USE_XOPEN2K8


209 
	$wcscŞl_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

210 
__loÿË_t
 
__loc
è
__THROW
;

215 
size_t
 
	$wcsxäm_l
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

216 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

219 
wch¬_t
 *
	$wcsdup
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_m®loc__
;

222 
__BEGIN_NAMESPACE_STD


224 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


225 "C++" 
wch¬_t
 *
	$wcschr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

226 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

227 "C++" cÚ¡ 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

228 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

230 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

231 
__THROW
 
__©Œibu‹_pu»__
;

234 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


235 "C++" 
wch¬_t
 *
	$wc¤chr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

236 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

237 "C++" cÚ¡ 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

238 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

240 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

241 
__THROW
 
__©Œibu‹_pu»__
;

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_GNU


248 
wch¬_t
 *
	$wcschºul
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__wc
)

249 
__THROW
 
__©Œibu‹_pu»__
;

252 
__BEGIN_NAMESPACE_STD


255 
size_t
 
	$wcsc¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__»jeù
)

256 
__THROW
 
__©Œibu‹_pu»__
;

259 
size_t
 
	$wcs¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

260 
__THROW
 
__©Œibu‹_pu»__
;

262 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


263 "C++" 
wch¬_t
 *
	$wc¥brk
 (
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

264 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

265 "C++" cÚ¡ 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
,

266 cÚ¡ 
wch¬_t
 *
__acû±
)

267 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

269 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

270 
__THROW
 
__©Œibu‹_pu»__
;

273 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


274 "C++" 
wch¬_t
 *
	$wcs¡r
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

275 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

276 "C++" cÚ¡ 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

277 cÚ¡ 
wch¬_t
 *
__ÃedË
)

278 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

280 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

281 
__THROW
 
__©Œibu‹_pu»__
;

285 
wch¬_t
 *
	$wc¡ok
 (
wch¬_t
 *
__»¡riù
 
__s
,

286 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__d–im
,

287 
wch¬_t
 **
__»¡riù
 
__±r
è
__THROW
;

290 
size_t
 
	$wc¦’
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_pu»__
;

291 
__END_NAMESPACE_STD


293 #ifdeà
__USE_XOPEN


295 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


296 "C++" 
wch¬_t
 *
	$wcswcs
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

297 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

298 "C++" cÚ¡ 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

299 cÚ¡ 
wch¬_t
 *
__ÃedË
)

300 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

302 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

303 
__THROW
 
__©Œibu‹_pu»__
;

307 #ifdeà
__USE_XOPEN2K8


309 
size_t
 
	$wc¢Ën
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__maxËn
)

310 
__THROW
 
__©Œibu‹_pu»__
;

314 
__BEGIN_NAMESPACE_STD


316 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


317 "C++" 
wch¬_t
 *
	$wmemchr
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

318 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

319 "C++" cÚ¡ 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
,

320 
size_t
 
__n
)

321 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

323 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

324 
__THROW
 
__©Œibu‹_pu»__
;

328 
	$wmemcmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

329 
__THROW
 
__©Œibu‹_pu»__
;

332 
wch¬_t
 *
	$wmemıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

333 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

337 
wch¬_t
 *
	$wmemmove
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

338 
__THROW
;

341 
wch¬_t
 *
	$wmem£t
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
è
__THROW
;

342 
__END_NAMESPACE_STD


344 #ifdeà
__USE_GNU


347 
wch¬_t
 *
	$wmempıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

348 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
)

349 
__THROW
;

353 
__BEGIN_NAMESPACE_STD


356 
wšt_t
 
	$btowc
 (
__c
è
__THROW
;

360 
	$wùob
 (
wšt_t
 
__c
è
__THROW
;

364 
	$mbsš™
 (cÚ¡ 
mb¡©e_t
 *
__ps
è
__THROW
 
__©Œibu‹_pu»__
;

368 
size_t
 
	$mb¹owc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

369 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

370 
mb¡©e_t
 *
__»¡riù
 
__p
è
__THROW
;

373 
size_t
 
	$wütomb
 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wc
,

374 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

377 
size_t
 
	$__mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

378 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

379 
size_t
 
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

380 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

381 
__END_NAMESPACE_STD


383 #ifdeà
__USE_EXTERN_INLINES


389 
wšt_t
 
	$__btowc_®Ÿs
 (
__c
è
	`__asm
 ("btowc");

390 
__ex‹º_šlše
 
wšt_t


391 
	`__NTH
 (
	$btowc
 (
__c
))

392 {  (
	`__butš_cÚ¡ªt_p
 (
__c
) && __c >= '\0' && __c <= '\x7f'

393 ? (
wšt_t
è
__c
 : 
	`__btowc_®Ÿs
 (__c)); 
	}
}

395 
	$__wùob_®Ÿs
 (
wšt_t
 
__c
è
	`__asm
 ("wctob");

396 
__ex‹º_šlše
 

397 
	`__NTH
 (
	$wùob
 (
wšt_t
 
__wc
))

398 {  (
	`__butš_cÚ¡ªt_p
 (
__wc
è&& __wø>ğ
L
'\0' && __wc <= L'\x7f'

399 ? (è
__wc
 : 
	`__wùob_®Ÿs
 (__wc)); 
	}
}

401 
__ex‹º_šlše
 
size_t


402 
__NTH
 (
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

403 
mb¡©e_t
 *
__»¡riù
 
__ps
))

404 {  (
__ps
 !ğ
NULL


405 ? 
	`mb¹owc
 (
NULL
, 
__s
, 
__n
, 
__ps
è: 
	`__mb¾’
 (__s, __n, NULL)); 
	}
}

408 
__BEGIN_NAMESPACE_STD


411 
size_t
 
	$mb¤towcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

412 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

413 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

417 
size_t
 
	$wc¤tombs
 (*
__»¡riù
 
__d¡
,

418 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

419 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

420 
__END_NAMESPACE_STD


423 #ifdef 
__USE_XOPEN2K8


426 
size_t
 
	$mb¢¹owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

427 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

428 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

432 
size_t
 
	$wc¢¹ombs
 (*
__»¡riù
 
__d¡
,

433 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
,

434 
size_t
 
__nwc
, size_ˆ
__Ën
,

435 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

440 #ifdeà
__USE_XOPEN


442 
	$wcwidth
 (
wch¬_t
 
__c
è
__THROW
;

446 
	$wcswidth
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__n
è
__THROW
;

450 
__BEGIN_NAMESPACE_STD


453 
	$wc¡od
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

454 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

455 
__END_NAMESPACE_STD


457 #ifdeà
__USE_ISOC99


458 
__BEGIN_NAMESPACE_C99


460 
	$wc¡of
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

461 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

462 
	$wc¡Şd
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

463 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

464 
__END_NAMESPACE_C99


468 
__BEGIN_NAMESPACE_STD


471 
	$wc¡Ş
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

472 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

476 
	$wc¡oul
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

477 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

478 
__THROW
;

479 
__END_NAMESPACE_STD


481 #ifdeà
__USE_ISOC99


482 
__BEGIN_NAMESPACE_C99


485 
__ex‹nsiÚ__


486 
	$wc¡Şl
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

487 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

488 
__THROW
;

492 
__ex‹nsiÚ__


493 
	$wc¡ouÎ
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

494 
wch¬_t
 **
__»¡riù
 
__’d±r
,

495 
__ba£
è
__THROW
;

496 
__END_NAMESPACE_C99


499 #ifdeà
__USE_GNU


502 
__ex‹nsiÚ__


503 
	$wc¡oq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

504 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

505 
__THROW
;

509 
__ex‹nsiÚ__


510 
	$wc¡ouq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

511 
wch¬_t
 **
__»¡riù
 
__’d±r
,

512 
__ba£
è
__THROW
;

515 #ifdeà
__USE_GNU


529 
	~<xloÿË.h
>

533 
	$wc¡Ş_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

534 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
,

535 
__loÿË_t
 
__loc
è
__THROW
;

537 
	$wc¡oul_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

538 
wch¬_t
 **
__»¡riù
 
__’d±r
,

539 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

541 
__ex‹nsiÚ__


542 
	$wc¡Şl_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

543 
wch¬_t
 **
__»¡riù
 
__’d±r
,

544 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

546 
__ex‹nsiÚ__


547 
	$wc¡ouÎ_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

548 
wch¬_t
 **
__»¡riù
 
__’d±r
,

549 
__ba£
, 
__loÿË_t
 
__loc
)

550 
__THROW
;

552 
	$wc¡od_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

553 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

554 
__THROW
;

556 
	$wc¡of_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

557 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

558 
__THROW
;

560 
	$wc¡Şd_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

561 
wch¬_t
 **
__»¡riù
 
__’d±r
,

562 
__loÿË_t
 
__loc
è
__THROW
;

566 #ifdeà
__USE_XOPEN2K8


569 
wch¬_t
 *
	$wııy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

570 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

574 
wch¬_t
 *
	$wınıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

575 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

576 
__THROW
;

583 
__FILE
 *
	$İ’_wmem¡»am
 (
wch¬_t
 **
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
;

586 #ià
defšed
 
__USE_ISOC95
 || defšed 
__USE_UNIX98


587 
__BEGIN_NAMESPACE_STD


590 
	$fwide
 (
__FILE
 *
__å
, 
__mode
è
__THROW
;

597 
	`fw´štf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

598 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

604 
	`w´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

607 
	$sw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

608 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

609 
__THROW
 ;

615 
	`vfw´štf
 (
__FILE
 *
__»¡riù
 
__s
,

616 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

617 
__gnuc_va_li¡
 
__¬g
)

623 
	`vw´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

624 
__gnuc_va_li¡
 
__¬g
)

628 
	$vsw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

629 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

630 
__gnuc_va_li¡
 
__¬g
)

631 
__THROW
 ;

638 
	`fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

639 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

645 
	`wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

648 
	$swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

649 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

650 
__THROW
 ;

652 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

653 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

654 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

655 #ifdeà
__REDIRECT


659 
	`__REDIRECT
 (
fwsÿnf
, (
__FILE
 *
__»¡riù
 
__¡»am
,

660 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

661 
__isoc99_fwsÿnf
)

663 
	`__REDIRECT
 (
wsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

664 
__isoc99_wsÿnf
)

666 
	`__REDIRECT_NTH
 (
swsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

667 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

668 ...), 
__isoc99_swsÿnf
)

671 
	`__isoc99_fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

672 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

673 
	`__isoc99_wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

674 
	$__isoc99_swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

675 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

676 
__THROW
;

677 
	#fwsÿnf
 
__isoc99_fwsÿnf


	)

678 
	#wsÿnf
 
__isoc99_wsÿnf


	)

679 
	#swsÿnf
 
__isoc99_swsÿnf


	)

683 
__END_NAMESPACE_STD


686 #ifdeà
__USE_ISOC99


687 
__BEGIN_NAMESPACE_C99


692 
	`vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

693 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

694 
__gnuc_va_li¡
 
__¬g
)

700 
	`vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

701 
__gnuc_va_li¡
 
__¬g
)

704 
	$vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

705 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

706 
__gnuc_va_li¡
 
__¬g
)

707 
__THROW
 ;

709 #ià!
defšed
 
__USE_GNU
 \

710 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

711 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

712 #ifdeà
__REDIRECT


713 
	`__REDIRECT
 (
vfwsÿnf
, (
__FILE
 *
__»¡riù
 
__s
,

714 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

715 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vfwsÿnf
)

717 
	`__REDIRECT
 (
vwsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

718 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vwsÿnf
)

720 
	`__REDIRECT_NTH
 (
vswsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

721 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

722 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vswsÿnf
)

725 
	`__isoc99_vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

726 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

727 
__gnuc_va_li¡
 
__¬g
);

728 
	`__isoc99_vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

729 
__gnuc_va_li¡
 
__¬g
);

730 
	$__isoc99_vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

731 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

732 
__gnuc_va_li¡
 
__¬g
è
__THROW
;

733 
	#vfwsÿnf
 
__isoc99_vfwsÿnf


	)

734 
	#vwsÿnf
 
__isoc99_vwsÿnf


	)

735 
	#vswsÿnf
 
__isoc99_vswsÿnf


	)

739 
__END_NAMESPACE_C99


743 
__BEGIN_NAMESPACE_STD


748 
wšt_t
 
	`fg‘wc
 (
__FILE
 *
__¡»am
);

749 
wšt_t
 
	`g‘wc
 (
__FILE
 *
__¡»am
);

755 
wšt_t
 
	`g‘wch¬
 ();

762 
wšt_t
 
	`åutwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

763 
wšt_t
 
	`putwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

769 
wšt_t
 
	`putwch¬
 (
wch¬_t
 
__wc
);

777 
wch¬_t
 *
	`fg‘ws
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

778 
__FILE
 *
__»¡riù
 
__¡»am
);

784 
	`åutws
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

785 
__FILE
 *
__»¡riù
 
__¡»am
);

792 
wšt_t
 
	`ung‘wc
 (wšt_ˆ
__wc
, 
__FILE
 *
__¡»am
);

793 
__END_NAMESPACE_STD


796 #ifdeà
__USE_GNU


804 
wšt_t
 
	`g‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

805 
wšt_t
 
	`g‘wch¬_uÆocked
 ();

813 
wšt_t
 
	`fg‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

821 
wšt_t
 
	`åutwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

830 
wšt_t
 
	`putwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

831 
wšt_t
 
	`putwch¬_uÆocked
 (
wch¬_t
 
__wc
);

840 
wch¬_t
 *
	`fg‘ws_uÆocked
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

841 
__FILE
 *
__»¡riù
 
__¡»am
);

849 
	`åutws_uÆocked
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

850 
__FILE
 *
__»¡riù
 
__¡»am
);

854 
__BEGIN_NAMESPACE_C99


858 
size_t
 
	$wcsáime
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

859 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

860 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

861 
__END_NAMESPACE_C99


863 #ifdeà
__USE_GNU


864 
	~<xloÿË.h
>

868 
size_t
 
	$wcsáime_l
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

869 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

870 cÚ¡ 
tm
 *
__»¡riù
 
__
,

871 
__loÿË_t
 
__loc
è
__THROW
;

880 #ià
defšed
 
__USE_UNIX98
 && !defšed 
__USE_GNU


881 
	#__Ãed_iswxxx


	)

882 
	~<wùy³.h
>

886 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


887 
	~<b™s/wch¬2.h
>

890 #ifdeà
__LDBL_COMPAT


891 
	~<b™s/wch¬-ldbl.h
>

894 
__END_DECLS


902 #undeà
__Ãed_mb¡©e_t


903 #undeà
__Ãed_wšt_t


	@/usr/include/getopt.h

19 #iâdeà
_GETOPT_H


21 #iâdeà
__Ãed_g‘İt


22 
	#_GETOPT_H
 1

	)

32 #ià!
defšed
 
__GNU_LIBRARY__


33 
	~<ùy³.h
>

36 #iâdeà
__THROW


37 #iâdeà
__GNUC_PREREQ


38 
	#__GNUC_PREREQ
(
maj
, 
mš
è(0)

	)

40 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

41 
	#__THROW
 
	`throw
 ()

	)

43 
	#__THROW


	)

47 #ifdef 
__ılu¥lus


57 *
İrg
;

71 
İtšd
;

76 
İ‹¼
;

80 
İtİt
;

82 #iâdeà
__Ãed_g‘İt


104 
	sİtiÚ


106 cÚ¡ *
	gÇme
;

109 
	ghas_¬g
;

110 *
	gæag
;

111 
	gv®
;

116 
	#no_¬gum’t
 0

	)

117 
	#»quœed_¬gum’t
 1

	)

118 
	#İtiÚ®_¬gum’t
 2

	)

146 #ifdeà
__GNU_LIBRARY__


150 
g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
, cÚ¡ *
__shÜtİts
)

151 
__THROW
;

153 #ià
defšed
 
__Ãed_g‘İt
 && defšed 
__USE_POSIX2
 \

154 && !
defšed
 
	g__USE_POSIX_IMPLICITLY
 && !defšed 
	g__USE_GNU


158 #ifdeà
__REDIRECT


159 
__REDIRECT_NTH
 (
g‘İt
, (
___¬gc
, *cÚ¡ *
___¬gv
,

160 cÚ¡ *
__shÜtİts
),

161 
__posix_g‘İt
);

163 
__posix_g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
,

164 cÚ¡ *
__shÜtİts
è
__THROW
;

165 
	#g‘İt
 
__posix_g‘İt


	)

169 
g‘İt
 ();

172 #iâdeà
__Ãed_g‘İt


173 
g‘İt_lÚg
 (
___¬gc
, *cÚ¡ *
___¬gv
,

174 cÚ¡ *
__shÜtİts
,

175 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

176 
__THROW
;

177 
g‘İt_lÚg_Úly
 (
___¬gc
, *cÚ¡ *
___¬gv
,

178 cÚ¡ *
__shÜtİts
,

179 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

180 
__THROW
;

184 #ifdef 
__ılu¥lus


189 #undeà
__Ãed_g‘İt


	@/usr/include/libio.h

28 #iâdeà
_IO_STDIO_H


29 
	#_IO_STDIO_H


	)

31 
	~<_G_cÚfig.h
>

33 
	#_IO_åos_t
 
_G_åos_t


	)

34 
	#_IO_åos64_t
 
_G_åos64_t


	)

35 
	#_IO_size_t
 
size_t


	)

36 
	#_IO_ssize_t
 
__ssize_t


	)

37 
	#_IO_off_t
 
__off_t


	)

38 
	#_IO_off64_t
 
__off64_t


	)

39 
	#_IO_pid_t
 
__pid_t


	)

40 
	#_IO_uid_t
 
__uid_t


	)

41 
	#_IO_icÚv_t
 
_G_icÚv_t


	)

42 
	#_IO_HAVE_ST_BLKSIZE
 
_G_HAVE_ST_BLKSIZE


	)

43 
	#_IO_BUFSIZ
 
_G_BUFSIZ


	)

44 
	#_IO_va_li¡
 
_G_va_li¡


	)

45 
	#_IO_wšt_t
 
wšt_t


	)

48 
	#__Ãed___va_li¡


	)

49 
	~<¡d¬g.h
>

50 #ifdeà
__GNUC_VA_LIST


51 #undeà
_IO_va_li¡


52 
	#_IO_va_li¡
 
__gnuc_va_li¡


	)

55 #iâdeà
__P


56 
	~<sys/cdefs.h
>

59 
	#_IO_UNIFIED_JUMPTABLES
 1

	)

61 #iâdeà
EOF


62 
	#EOF
 (-1)

	)

64 #iâdeà
NULL


65 #ià
defšed
 
__GNUG__
 && \

66 (
	g__GNUC__
 > 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 >= 8))

67 
	#NULL
 (
__nuÎ
)

	)

69 #ià!
defšed
(
__ılu¥lus
)

70 
	#NULL
 ((*)0)

	)

72 
	#NULL
 (0)

	)

77 
	#_IOS_INPUT
 1

	)

78 
	#_IOS_OUTPUT
 2

	)

79 
	#_IOS_ATEND
 4

	)

80 
	#_IOS_APPEND
 8

	)

81 
	#_IOS_TRUNC
 16

	)

82 
	#_IOS_NOCREATE
 32

	)

83 
	#_IOS_NOREPLACE
 64

	)

84 
	#_IOS_BIN
 128

	)

92 
	#_IO_MAGIC
 0xFBAD0000

	)

93 
	#_OLD_STDIO_MAGIC
 0xFABC0000

	)

94 
	#_IO_MAGIC_MASK
 0xFFFF0000

	)

95 
	#_IO_USER_BUF
 1

	)

96 
	#_IO_UNBUFFERED
 2

	)

97 
	#_IO_NO_READS
 4

	)

98 
	#_IO_NO_WRITES
 8

	)

99 
	#_IO_EOF_SEEN
 0x10

	)

100 
	#_IO_ERR_SEEN
 0x20

	)

101 
	#_IO_DELETE_DONT_CLOSE
 0x40

	)

102 
	#_IO_LINKED
 0x80

	)

103 
	#_IO_IN_BACKUP
 0x100

	)

104 
	#_IO_LINE_BUF
 0x200

	)

105 
	#_IO_TIED_PUT_GET
 0x400

	)

106 
	#_IO_CURRENTLY_PUTTING
 0x800

	)

107 
	#_IO_IS_APPENDING
 0x1000

	)

108 
	#_IO_IS_FILEBUF
 0x2000

	)

109 
	#_IO_BAD_SEEN
 0x4000

	)

110 
	#_IO_USER_LOCK
 0x8000

	)

112 
	#_IO_FLAGS2_MMAP
 1

	)

113 
	#_IO_FLAGS2_NOTCANCEL
 2

	)

114 #ifdeà
_LIBC


115 
	#_IO_FLAGS2_FORTIFY
 4

	)

117 
	#_IO_FLAGS2_USER_WBUF
 8

	)

118 #ifdeà
_LIBC


119 
	#_IO_FLAGS2_SCANF_STD
 16

	)

120 
	#_IO_FLAGS2_NOCLOSE
 32

	)

121 
	#_IO_FLAGS2_CLOEXEC
 64

	)

125 
	#_IO_SKIPWS
 01

	)

126 
	#_IO_LEFT
 02

	)

127 
	#_IO_RIGHT
 04

	)

128 
	#_IO_INTERNAL
 010

	)

129 
	#_IO_DEC
 020

	)

130 
	#_IO_OCT
 040

	)

131 
	#_IO_HEX
 0100

	)

132 
	#_IO_SHOWBASE
 0200

	)

133 
	#_IO_SHOWPOINT
 0400

	)

134 
	#_IO_UPPERCASE
 01000

	)

135 
	#_IO_SHOWPOS
 02000

	)

136 
	#_IO_SCIENTIFIC
 04000

	)

137 
	#_IO_FIXED
 010000

	)

138 
	#_IO_UNITBUF
 020000

	)

139 
	#_IO_STDIO
 040000

	)

140 
	#_IO_DONT_CLOSE
 0100000

	)

141 
	#_IO_BOOLALPHA
 0200000

	)

144 
_IO_jump_t
; 
	g_IO_FILE
;

147 #ifdeà
_IO_MTSAFE_IO


150 
	t_IO_lock_t
;

156 
	s_IO_m¬k”
 {

157 
_IO_m¬k”
 *
	m_Ãxt
;

158 
_IO_FILE
 *
	m_sbuf
;

162 
	m_pos
;

164 
£t_¡»ampos
(
¡»ampos
 
¥
è{ 
	m_¥os
 = sp; }

165 
£t_off£t
(
off£t
è{ 
	m_pos
 = off£t; 
	m_¥os
 = (
¡»ampos
)(-2); }

166 
	mpublic
:

167 
¡»amm¬k”
(
¡»ambuf
 *
sb
);

168 ~
¡»amm¬k”
();

169 
§všg
(è{  
	m_¥os
 == -2; }

170 
d–
(
¡»amm¬k”
&);

171 
d–
();

176 
	e__codecvt_»suÉ


178 
	m__codecvt_ok
,

179 
	m__codecvt_·¹Ÿl
,

180 
	m__codecvt_”rÜ
,

181 
	m__codecvt_nocÚv


184 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


187 
	s_IO_codecvt


189 (*
	m__codecvt_de¡r
è(
	m_IO_codecvt
 *);

190 
__codecvt_»suÉ
 (*
__codecvt_do_out
è(
	m_IO_codecvt
 *,

191 
	m__mb¡©e_t
 *,

192 cÚ¡ 
	mwch¬_t
 *,

193 cÚ¡ 
	mwch¬_t
 *,

194 cÚ¡ 
	mwch¬_t
 **, *,

196 
__codecvt_»suÉ
 (*
__codecvt_do_unshiá
è(
	m_IO_codecvt
 *,

197 
	m__mb¡©e_t
 *, *,

199 
__codecvt_»suÉ
 (*
__codecvt_do_š
è(
	m_IO_codecvt
 *,

200 
	m__mb¡©e_t
 *,

202 cÚ¡ **, 
	mwch¬_t
 *,

203 
	mwch¬_t
 *, wchar_t **);

204 (*
	m__codecvt_do_’codšg
è(
	m_IO_codecvt
 *);

205 (*
	m__codecvt_do_®ways_nocÚv
è(
	m_IO_codecvt
 *);

206 (*
	m__codecvt_do_Ëngth
è(
	m_IO_codecvt
 *, 
	m__mb¡©e_t
 *,

207 cÚ¡ *, cÚ¡ *, 
	m_IO_size_t
);

208 (*
	m__codecvt_do_max_Ëngth
è(
	m_IO_codecvt
 *);

210 
_IO_icÚv_t
 
	m__cd_š
;

211 
_IO_icÚv_t
 
	m__cd_out
;

215 
	s_IO_wide_d©a


217 
wch¬_t
 *
	m_IO_»ad_±r
;

218 
wch¬_t
 *
	m_IO_»ad_’d
;

219 
wch¬_t
 *
	m_IO_»ad_ba£
;

220 
wch¬_t
 *
	m_IO_wr™e_ba£
;

221 
wch¬_t
 *
	m_IO_wr™e_±r
;

222 
wch¬_t
 *
	m_IO_wr™e_’d
;

223 
wch¬_t
 *
	m_IO_buf_ba£
;

224 
wch¬_t
 *
	m_IO_buf_’d
;

226 
wch¬_t
 *
	m_IO_§ve_ba£
;

227 
wch¬_t
 *
	m_IO_backup_ba£
;

229 
wch¬_t
 *
	m_IO_§ve_’d
;

231 
__mb¡©e_t
 
	m_IO_¡©e
;

232 
__mb¡©e_t
 
	m_IO_Ï¡_¡©e
;

233 
_IO_codecvt
 
	m_codecvt
;

235 
wch¬_t
 
	m_shÜtbuf
[1];

237 cÚ¡ 
_IO_jump_t
 *
	m_wide_vbË
;

241 
	s_IO_FILE
 {

242 
	m_æags
;

243 
	#_IO_fe_æags
 
_æags


	)

247 * 
	m_IO_»ad_±r
;

248 * 
	m_IO_»ad_’d
;

249 * 
	m_IO_»ad_ba£
;

250 * 
	m_IO_wr™e_ba£
;

251 * 
	m_IO_wr™e_±r
;

252 * 
	m_IO_wr™e_’d
;

253 * 
	m_IO_buf_ba£
;

254 * 
	m_IO_buf_’d
;

256 *
	m_IO_§ve_ba£
;

257 *
	m_IO_backup_ba£
;

258 *
	m_IO_§ve_’d
;

260 
_IO_m¬k”
 *
	m_m¬k”s
;

262 
_IO_FILE
 *
	m_chaš
;

264 
	m_f’o
;

266 
	m_blksize
;

268 
	m_æags2
;

270 
_IO_off_t
 
	m_Şd_off£t
;

272 
	#__HAVE_COLUMN


	)

274 
	m_cur_cŞumn
;

275 sigÃd 
	m_vbË_off£t
;

276 
	m_shÜtbuf
[1];

280 
_IO_lock_t
 *
	m_lock
;

281 #ifdeà
_IO_USE_OLD_IO_FILE


284 
	s_IO_FILE_com¶‘e


286 
_IO_FILE
 
	m_fe
;

288 #ià
defšed
 
_G_IO_IO_FILE_VERSION
 && _G_IO_IO_FILE_VERSION == 0x20001

289 
_IO_off64_t
 
	m_off£t
;

290 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


292 
_IO_codecvt
 *
	m_codecvt
;

293 
_IO_wide_d©a
 *
	m_wide_d©a
;

294 
_IO_FILE
 *
	m_ä“»s_li¡
;

295 *
	m_ä“»s_buf
;

297 *
	m__·d1
;

298 *
	m__·d2
;

299 *
	m__·d3
;

300 *
	m__·d4
;

302 
size_t
 
	m__·d5
;

303 
	m_mode
;

305 
	m_unu£d2
[15 *  (è- 4 *  (*è-  (
size_t
)];

309 #iâdeà
__ılu¥lus


310 
_IO_FILE
 
	t_IO_FILE
;

313 
	g_IO_FILE_¶us
;

315 
_IO_FILE_¶us
 
_IO_2_1_¡dš_
;

316 
_IO_FILE_¶us
 
_IO_2_1_¡dout_
;

317 
_IO_FILE_¶us
 
_IO_2_1_¡d”r_
;

318 #iâdeà
_LIBC


319 
	#_IO_¡dš
 ((
_IO_FILE
*)(&
_IO_2_1_¡dš_
))

	)

320 
	#_IO_¡dout
 ((
_IO_FILE
*)(&
_IO_2_1_¡dout_
))

	)

321 
	#_IO_¡d”r
 ((
_IO_FILE
*)(&
_IO_2_1_¡d”r_
))

	)

323 
_IO_FILE
 *
_IO_¡dš
 
©Œibu‹_hidd’
;

324 
_IO_FILE
 *
_IO_¡dout
 
©Œibu‹_hidd’
;

325 
_IO_FILE
 *
_IO_¡d”r
 
©Œibu‹_hidd’
;

333 
__ssize_t
 
	t__io_»ad_â
 (*
	t__cook›
, *
	t__buf
, 
	tsize_t
 
	t__nby‹s
);

341 
__ssize_t
 
	t__io_wr™e_â
 (*
	t__cook›
, cÚ¡ *
	t__buf
,

342 
	tsize_t
 
	t__n
);

350 
	t__io_£ek_â
 (*
	t__cook›
, 
	t_IO_off64_t
 *
	t__pos
, 
	t__w
);

353 
	t__io_şo£_â
 (*
	t__cook›
);

356 #ifdeà
_GNU_SOURCE


358 
__io_»ad_â
 
	tcook›_»ad_funùiÚ_t
;

359 
__io_wr™e_â
 
	tcook›_wr™e_funùiÚ_t
;

360 
__io_£ek_â
 
	tcook›_£ek_funùiÚ_t
;

361 
__io_şo£_â
 
	tcook›_şo£_funùiÚ_t
;

366 
__io_»ad_â
 *
	m»ad
;

367 
__io_wr™e_â
 *
	mwr™e
;

368 
__io_£ek_â
 *
	m£ek
;

369 
__io_şo£_â
 *
	mşo£
;

370 } 
	t_IO_cook›_io_funùiÚs_t
;

371 
_IO_cook›_io_funùiÚs_t
 
	tcook›_io_funùiÚs_t
;

373 
	g_IO_cook›_fe
;

376 
_IO_cook›_š™
 (
_IO_cook›_fe
 *
__cfe
, 
__»ad_wr™e
,

377 *
__cook›
, 
_IO_cook›_io_funùiÚs_t
 
__âs
);

381 #ifdeà
__ılu¥lus


385 
__und”æow
 (
_IO_FILE
 *);

386 
__uæow
 (
_IO_FILE
 *);

387 
__ov”æow
 (
_IO_FILE
 *, );

388 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


389 
_IO_wšt_t
 
__wund”æow
 (
_IO_FILE
 *);

390 
_IO_wšt_t
 
__wuæow
 (
_IO_FILE
 *);

391 
_IO_wšt_t
 
__wov”æow
 (
_IO_FILE
 *, _IO_wint_t);

394 #ià 
__GNUC__
 >= 3

395 
	#_IO_BE
(
ex´
, 
»s
è
	`__butš_ex³ù
 (Óx´),„es)

	)

397 
	#_IO_BE
(
ex´
, 
»s
èÓx´)

	)

400 
	#_IO_g‘c_uÆocked
(
_å
) \

401 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

402 ? 
	`__uæow
 (
_å
è: *(*è(_å)->
_IO_»ad_±r
++)

	)

403 
	#_IO_³ekc_uÆocked
(
_å
) \

404 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

405 && 
	`__und”æow
 (
_å
è=ğ
EOF
 ? EOF \

406 : *(*è(
_å
)->
_IO_»ad_±r
)

	)

407 
	#_IO_putc_uÆocked
(
_ch
, 
_å
) \

408 (
	`_IO_BE
 ((
_å
)->
_IO_wr™e_±r
 >ğ(_å)->
_IO_wr™e_’d
, 0) \

409 ? 
	`__ov”æow
 (
_å
, (è(
_ch
)) \

410 : (è(*(
_å
)->
_IO_wr™e_±r
++ = (
_ch
)))

	)

412 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


413 
	#_IO_g‘wc_uÆocked
(
_å
) \

414 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

415 || ((
_å
)->
_wide_d©a
->
_IO_»ad_±r
 \

416 >ğ(
_å
)->
_wide_d©a
->
_IO_»ad_’d
), 0) \

417 ? 
	`__wuæow
 (
_å
è: (
_IO_wšt_t
è*(_å)->
_wide_d©a
->
_IO_»ad_±r
++)

	)

418 
	#_IO_putwc_uÆocked
(
_wch
, 
_å
) \

419 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

420 || ((
_å
)->
_wide_d©a
->
_IO_wr™e_±r
 \

421 >ğ(
_å
)->
_wide_d©a
->
_IO_wr™e_’d
), 0) \

422 ? 
	`__wov”æow
 (
_å
, 
_wch
) \

423 : (
_IO_wšt_t
è(*(
_å
)->
_wide_d©a
->
_IO_wr™e_±r
++ = (
_wch
)))

	)

426 
	#_IO_ãof_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_EOF_SEEN
è!ğ0)

	)

427 
	#_IO_ã¼Ü_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_ERR_SEEN
è!ğ0)

	)

429 
_IO_g‘c
 (
_IO_FILE
 *
__å
);

430 
_IO_putc
 (
__c
, 
_IO_FILE
 *
__å
);

431 
_IO_ãof
 (
_IO_FILE
 *
__å
è
__THROW
;

432 
_IO_ã¼Ü
 (
_IO_FILE
 *
__å
è
__THROW
;

434 
_IO_³ekc_locked
 (
_IO_FILE
 *
__å
);

437 
	#_IO_PENDING_OUTPUT_COUNT
(
_å
) \

438 ((
_å
)->
_IO_wr™e_±r
 - (_å)->
_IO_wr™e_ba£
)

	)

440 
_IO_æockfe
 (
_IO_FILE
 *è
__THROW
;

441 
_IO_fuÆockfe
 (
_IO_FILE
 *è
__THROW
;

442 
_IO_árylockfe
 (
_IO_FILE
 *è
__THROW
;

444 #ifdeà
_IO_MTSAFE_IO


445 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_locked
 (_å)

	)

446 
	#_IO_æockfe
(
_å
) \

447 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_æockfe
 (_å)

	)

448 
	#_IO_fuÆockfe
(
_å
) \

449 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_fuÆockfe
 (_å)

	)

451 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_uÆocked
 (_å)

	)

452 
	#_IO_æockfe
(
_å
è

	)

453 
	#_IO_fuÆockfe
(
_å
è

	)

454 
	#_IO_árylockfe
(
_å
è

	)

455 
	#_IO_ş—nup_»giÚ_¡¬t
(
_fù
, 
_å
è

	)

456 
	#_IO_ş—nup_»giÚ_’d
(
_Do™
è

	)

459 
_IO_vfsÿnf
 (
_IO_FILE
 * 
__»¡riù
, const * __restrict,

460 
_IO_va_li¡
, *
__»¡riù
);

461 
_IO_vårštf
 (
_IO_FILE
 *
__»¡riù
, const *__restrict,

462 
_IO_va_li¡
);

463 
_IO_ssize_t
 
_IO_·dn
 (
_IO_FILE
 *, , _IO_ssize_t);

464 
_IO_size_t
 
_IO_sg‘n
 (
_IO_FILE
 *, *, _IO_size_t);

466 
_IO_off64_t
 
_IO_£ekoff
 (
_IO_FILE
 *, _IO_off64_t, , );

467 
_IO_off64_t
 
_IO_£ekpos
 (
_IO_FILE
 *, _IO_off64_t, );

469 
_IO_ä“_backup_¬—
 (
_IO_FILE
 *è
__THROW
;

471 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


472 
_IO_wšt_t
 
_IO_g‘wc
 (
_IO_FILE
 *
__å
);

473 
_IO_wšt_t
 
_IO_putwc
 (
wch¬_t
 
__wc
, 
_IO_FILE
 *
__å
);

474 
_IO_fwide
 (
_IO_FILE
 *
__å
, 
__mode
è
__THROW
;

475 #ià
__GNUC__
 >= 2

478 #ià
defšed
 
_LIBC
 && defšed 
SHARED


479 
	~<shlib-com·t.h
>

480 #ià
SHLIB_COMPAT
 (
libc
, 
GLIBC_2_0
, 
GLIBC_2_1
)

481 
	#_IO_fwide_maybe_šcom·tibË
 \

482 (
	`__butš_ex³ù
 (&
_IO_¡dš_u£d
 =ğ
NULL
, 0))

	)

483 cÚ¡ 
_IO_¡dš_u£d
;

484 
w—k_ex‹º
 (
_IO_¡dš_u£d
);

487 #iâdeà
_IO_fwide_maybe_šcom·tibË


488 
	#_IO_fwide_maybe_šcom·tibË
 (0)

	)

492 
	#_IO_fwide
(
__å
, 
__mode
) \

493 ({ 
__»suÉ
 = (
__mode
); \

494 ià(
__»suÉ
 < 0 && ! 
_IO_fwide_maybe_šcom·tibË
) \

496 ià((
__å
)->
_mode
 == 0) \

498 (
__å
)->
_mode
 = -1; \

499 
__»suÉ
 = (
__å
)->
_mode
; \

501 ià(
	`__butš_cÚ¡ªt_p
 (
__mode
) && (__mode) == 0) \

502 
__»suÉ
 = 
_IO_fwide_maybe_šcom·tibË
 ? -1 : (
__å
)->
_mode
; \

504 
__»suÉ
 = 
	`_IO_fwide
 (
__å
, __result); \

505 
__»suÉ
; })

	)

508 
_IO_vfwsÿnf
 (
_IO_FILE
 * 
__»¡riù
, cÚ¡ 
wch¬_t
 * __restrict,

509 
_IO_va_li¡
, *
__»¡riù
);

510 
_IO_vfw´štf
 (
_IO_FILE
 *
__»¡riù
, cÚ¡ 
wch¬_t
 *__restrict,

511 
_IO_va_li¡
);

512 
_IO_ssize_t
 
_IO_w·dn
 (
_IO_FILE
 *, 
wšt_t
, _IO_ssize_t);

513 
_IO_ä“_wbackup_¬—
 (
_IO_FILE
 *è
__THROW
;

516 #ifdeà
__LDBL_COMPAT


517 
	~<b™s/libio-ldbl.h
>

520 #ifdeà
__ılu¥lus


	@/usr/include/libunwind-x86_64.h

28 #iâdeà
LIBUNWIND_H


29 
	#LIBUNWIND_H


	)

31 #ià
defšed
(
__ılu¥lus
è|| defšed(
c_¶u¥lus
)

35 
	~<sys/ty³s.h
>

36 
	~<š‰y³s.h
>

37 
	~<ucÚ‹xt.h
>

39 
	#UNW_TARGET
 
x86_64


	)

40 
	#UNW_TARGET_X86_64
 1

	)

42 
	#_U_TDEP_QP_TRUE
 0

	)

49 
	#UNW_TDEP_CURSOR_LEN
 127

	)

51 
ušt64_t
 
	tunw_wÜd_t
;

52 
št64_t
 
	tunw_swÜd_t
;

54 
	tunw_td•_å»g_t
;

58 
UNW_X86_64_RAX
,

59 
UNW_X86_64_RDX
,

60 
UNW_X86_64_RCX
,

61 
UNW_X86_64_RBX
,

62 
UNW_X86_64_RSI
,

63 
UNW_X86_64_RDI
,

64 
UNW_X86_64_RBP
,

65 
UNW_X86_64_RSP
,

66 
UNW_X86_64_R8
,

67 
UNW_X86_64_R9
,

68 
UNW_X86_64_R10
,

69 
UNW_X86_64_R11
,

70 
UNW_X86_64_R12
,

71 
UNW_X86_64_R13
,

72 
UNW_X86_64_R14
,

73 
UNW_X86_64_R15
,

74 
UNW_X86_64_RIP
,

75 #ifdeà
CONFIG_MSABI_SUPPORT


76 
UNW_X86_64_XMM0
,

77 
UNW_X86_64_XMM1
,

78 
UNW_X86_64_XMM2
,

79 
UNW_X86_64_XMM3
,

80 
UNW_X86_64_XMM4
,

81 
UNW_X86_64_XMM5
,

82 
UNW_X86_64_XMM6
,

83 
UNW_X86_64_XMM7
,

84 
UNW_X86_64_XMM8
,

85 
UNW_X86_64_XMM9
,

86 
UNW_X86_64_XMM10
,

87 
UNW_X86_64_XMM11
,

88 
UNW_X86_64_XMM12
,

89 
UNW_X86_64_XMM13
,

90 
UNW_X86_64_XMM14
,

91 
UNW_X86_64_XMM15
,

92 
UNW_TDEP_LAST_REG
 = 
UNW_X86_64_XMM15
,

94 
UNW_TDEP_LAST_REG
 = 
UNW_X86_64_RIP
,

100 
UNW_X86_64_CFA
,

102 
UNW_TDEP_IP
 = 
UNW_X86_64_RIP
,

103 
UNW_TDEP_SP
 = 
UNW_X86_64_RSP
,

104 
UNW_TDEP_BP
 = 
UNW_X86_64_RBP
,

105 
UNW_TDEP_EH
 = 
UNW_X86_64_RAX


107 
	tx86_64_»gnum_t
;

109 
	#UNW_TDEP_NUM_EH_REGS
 2

	)

111 
	sunw_td•_§ve_loc


115 
unw_td•_§ve_loc_t
;

118 
ucÚ‹xt_t
 
	tunw_td•_cÚ‹xt_t
;

124 
unw_td•_´oc_šfo_t
;

126 
	~"libunwšd-dyÇmic.h
"

127 
	~"libunwšd-commÚ.h
"

129 
	#unw_td•_g‘cÚ‹xt
 
	`UNW_ARCH_OBJ
(
g‘cÚ‹xt
)

	)

130 
	#unw_td•_is_å»g
 
	`UNW_ARCH_OBJ
(
is_å»g
)

	)

132 
unw_td•_g‘cÚ‹xt
 (
unw_td•_cÚ‹xt_t
 *);

133 
unw_td•_is_å»g
 ();

135 #ià
defšed
(
__ılu¥lus
è|| defšed(
c_¶u¥lus
)

	@/usr/include/rpc/netdb.h

36 #iâdeà
_RPC_NETDB_H


37 
	#_RPC_NETDB_H
 1

	)

39 
	~<ã©u»s.h
>

41 
	#__Ãed_size_t


	)

42 
	~<¡ddef.h
>

44 
__BEGIN_DECLS


46 
	s½ûÁ


48 *
	mr_Çme
;

49 **
	mr_®Ÿ£s
;

50 
	mr_numb”
;

53 
	$£ŒpûÁ
 (
__¡ayİ’
è
__THROW
;

54 
	$’d½ûÁ
 (è
__THROW
;

55 
½ûÁ
 *
	$g‘½cbyÇme
 (cÚ¡ *
__Çme
è
__THROW
;

56 
½ûÁ
 *
	$g‘½cbynumb”
 (
__numb”
è
__THROW
;

57 
½ûÁ
 *
	$g‘½ûÁ
 (è
__THROW
;

59 #ifdeà
__USE_MISC


60 
	$g‘½cbyÇme_r
 (cÚ¡ *
__Çme
, 
½ûÁ
 *
__»suÉ_buf
,

61 *
__bufãr
, 
size_t
 
__buæ’
,

62 
½ûÁ
 **
__»suÉ
è
__THROW
;

64 
	$g‘½cbynumb”_r
 (
__numb”
, 
½ûÁ
 *
__»suÉ_buf
,

65 *
__bufãr
, 
size_t
 
__buæ’
,

66 
½ûÁ
 **
__»suÉ
è
__THROW
;

68 
	$g‘½ûÁ_r
 (
½ûÁ
 *
__»suÉ_buf
, *
__bufãr
,

69 
size_t
 
__buæ’
, 
½ûÁ
 **
__»suÉ
è
__THROW
;

72 
__END_DECLS


	@/usr/include/sched.h

19 #iâdef 
_SCHED_H


20 
	#_SCHED_H
 1

	)

22 
	~<ã©u»s.h
>

25 
	~<b™s/ty³s.h
>

27 
	#__Ãed_size_t


	)

28 
	~<¡ddef.h
>

30 #ifdeà
__USE_XOPEN2K


31 
	#__Ãed_time_t


	)

32 
	#__Ãed_time¥ec


	)

34 
	~<time.h
>

36 #iâdeà
__pid_t_defšed


37 
__pid_t
 
	tpid_t
;

38 
	#__pid_t_defšed


	)

43 
	~<b™s/sched.h
>

45 
	#sched_´iÜ™y
 
__sched_´iÜ™y


	)

48 
__BEGIN_DECLS


51 
	$sched_£¬am
 (
__pid_t
 
__pid
, cÚ¡ 
sched_·¿m
 *
__·¿m
)

52 
__THROW
;

55 
	$sched_g‘·¿m
 (
__pid_t
 
__pid
, 
sched_·¿m
 *
__·¿m
è
__THROW
;

58 
	$sched_£tscheduËr
 (
__pid_t
 
__pid
, 
__pŞicy
,

59 cÚ¡ 
sched_·¿m
 *
__·¿m
è
__THROW
;

62 
	$sched_g‘scheduËr
 (
__pid_t
 
__pid
è
__THROW
;

65 
	$sched_y›ld
 (è
__THROW
;

68 
	$sched_g‘_´iÜ™y_max
 (
__®gÜ™hm
è
__THROW
;

71 
	$sched_g‘_´iÜ™y_mš
 (
__®gÜ™hm
è
__THROW
;

74 
	$sched_¼_g‘_š‹rv®
 (
__pid_t
 
__pid
, 
time¥ec
 *
__t
è
__THROW
;

77 #ifdeà
__USE_GNU


79 
	#CPU_SETSIZE
 
__CPU_SETSIZE


	)

80 
	#CPU_SET
(
ıu
, 
ıu£
è
	`__CPU_SET_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

81 
	#CPU_CLR
(
ıu
, 
ıu£
è
	`__CPU_CLR_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

82 
	#CPU_ISSET
(
ıu
, 
ıu£
è
	`__CPU_ISSET_S
 (ıu,  (
ıu_£t_t
), \

83 
ıu£
)

	)

84 
	#CPU_ZERO
(
ıu£
è
	`__CPU_ZERO_S
 ( (
ıu_£t_t
), cpu£)

	)

85 
	#CPU_COUNT
(
ıu£
è
	`__CPU_COUNT_S
 ( (
ıu_£t_t
), cpu£)

	)

87 
	#CPU_SET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_SET_S
 (ıu, s‘size, cpu£)

	)

88 
	#CPU_CLR_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_CLR_S
 (ıu, s‘size, cpu£)

	)

89 
	#CPU_ISSET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_ISSET_S
 (cpu, setsize, \

90 
ıu£
)

	)

91 
	#CPU_ZERO_S
(
£tsize
, 
ıu£
è
	`__CPU_ZERO_S
 (£tsize, cpu£)

	)

92 
	#CPU_COUNT_S
(
£tsize
, 
ıu£
è
	`__CPU_COUNT_S
 (£tsize, cpu£)

	)

94 
	#CPU_EQUAL
(
ıu£1
, 
ıu£2
) \

95 
	`__CPU_EQUAL_S
 ( (
ıu_£t_t
), 
ıu£1
, 
ıu£2
)

	)

96 
	#CPU_EQUAL_S
(
£tsize
, 
ıu£1
, 
ıu£2
) \

97 
	`__CPU_EQUAL_S
 (
£tsize
, 
ıu£1
, 
ıu£2
)

	)

99 
	#CPU_AND
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

100 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

101 
	#CPU_OR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

102 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

103 
	#CPU_XOR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

104 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

105 
	#CPU_AND_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

106 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

107 
	#CPU_OR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

108 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

109 
	#CPU_XOR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

110 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

112 
	#CPU_ALLOC_SIZE
(
couÁ
è
	`__CPU_ALLOC_SIZE
 (couÁ)

	)

113 
	#CPU_ALLOC
(
couÁ
è
	`__CPU_ALLOC
 (couÁ)

	)

114 
	#CPU_FREE
(
ıu£t
è
	`__CPU_FREE
 (ıu£t)

	)

118 
	$sched_£ffš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

119 cÚ¡ 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

122 
	$sched_g‘affš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

123 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

126 
__END_DECLS


	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

55 
	#__STDC_ISO_10646__
 201505L

	)

58 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/wctype.h

23 #iâdeà
_WCTYPE_H


25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 #iâdeà
__Ãed_iswxxx


29 
	#_WCTYPE_H
 1

	)

32 
	#__Ãed_wšt_t


	)

33 
	~<wch¬.h
>

37 #iâdeà
WEOF


38 
	#WEOF
 (0xffffffffu)

	)

41 #undeà
__Ãed_iswxxx


46 #iâdeà
__iswxxx_defšed


47 
	#__iswxxx_defšed
 1

	)

49 
__BEGIN_NAMESPACE_C99


52 
	twùy³_t
;

53 
	g__END_NAMESPACE_C99


55 #iâdeà
_ISwb™


60 
	~<’dŸn.h
>

61 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


62 
	#_ISwb™
(
b™
è(1 << (b™))

	)

64 
	#_ISwb™
(
b™
) \

65 ((
b™
) < 8 ? () ((1UL << (bit)) << 24) \

66 : ((
b™
) < 16 ? () ((1UL << (bit)) << 8) \

67 : ((
b™
) < 24 ? () ((1UL << (bit)) >> 8) \

68 : (è((1UL << (
b™
)è>> 24))))

	)

73 
	m__ISwuµ”
 = 0,

74 
	m__ISwlow”
 = 1,

75 
	m__ISw®pha
 = 2,

76 
	m__ISwdig™
 = 3,

77 
	m__ISwxdig™
 = 4,

78 
	m__ISw¥aû
 = 5,

79 
	m__ISw´št
 = 6,

80 
	m__ISwg¿ph
 = 7,

81 
	m__ISwbÏnk
 = 8,

82 
	m__ISwúŒl
 = 9,

83 
	m__ISwpunù
 = 10,

84 
	m__ISw®num
 = 11,

86 
	m_ISwuµ”
 = 
_ISwb™
 (
__ISwuµ”
),

87 
	m_ISwlow”
 = 
_ISwb™
 (
__ISwlow”
),

88 
	m_ISw®pha
 = 
_ISwb™
 (
__ISw®pha
),

89 
	m_ISwdig™
 = 
_ISwb™
 (
__ISwdig™
),

90 
	m_ISwxdig™
 = 
_ISwb™
 (
__ISwxdig™
),

91 
	m_ISw¥aû
 = 
_ISwb™
 (
__ISw¥aû
),

92 
	m_ISw´št
 = 
_ISwb™
 (
__ISw´št
),

93 
	m_ISwg¿ph
 = 
_ISwb™
 (
__ISwg¿ph
),

94 
	m_ISwbÏnk
 = 
_ISwb™
 (
__ISwbÏnk
),

95 
	m_ISwúŒl
 = 
_ISwb™
 (
__ISwúŒl
),

96 
	m_ISwpunù
 = 
_ISwb™
 (
__ISwpunù
),

97 
	m_ISw®num
 = 
_ISwb™
 (
__ISw®num
)

102 
__BEGIN_DECLS


104 
__BEGIN_NAMESPACE_C99


111 
	$isw®num
 (
wšt_t
 
__wc
è
__THROW
;

117 
	$isw®pha
 (
wšt_t
 
__wc
è
__THROW
;

120 
	$iswúŒl
 (
wšt_t
 
__wc
è
__THROW
;

124 
	$iswdig™
 (
wšt_t
 
__wc
è
__THROW
;

128 
	$iswg¿ph
 (
wšt_t
 
__wc
è
__THROW
;

133 
	$iswlow”
 (
wšt_t
 
__wc
è
__THROW
;

136 
	$isw´št
 (
wšt_t
 
__wc
è
__THROW
;

141 
	$iswpunù
 (
wšt_t
 
__wc
è
__THROW
;

146 
	$isw¥aû
 (
wšt_t
 
__wc
è
__THROW
;

151 
	$iswuµ”
 (
wšt_t
 
__wc
è
__THROW
;

156 
	$iswxdig™
 (
wšt_t
 
__wc
è
__THROW
;

161 #ifdeà
__USE_ISOC99


162 
	$iswbÏnk
 (
wšt_t
 
__wc
è
__THROW
;

171 
wùy³_t
 
	$wùy³
 (cÚ¡ *
__´İ”ty
è
__THROW
;

175 
	$iswùy³
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
è
__THROW
;

176 
__END_NAMESPACE_C99


183 
__BEGIN_NAMESPACE_C99


186 cÚ¡ 
	t__št32_t
 *
	twù¿ns_t
;

187 
__END_NAMESPACE_C99


188 #ifdeà
__USE_GNU


189 
	$__USING_NAMESPACE_C99
(
wù¿ns_t
)

192 
__BEGIN_NAMESPACE_C99


194 
wšt_t
 
	$towlow”
 (
wšt_t
 
__wc
è
__THROW
;

197 
wšt_t
 
	$towuµ”
 (
wšt_t
 
__wc
è
__THROW
;

198 
__END_NAMESPACE_C99


200 
__END_DECLS


207 #ifdeà
_WCTYPE_H


213 
__BEGIN_DECLS


215 
__BEGIN_NAMESPACE_C99


218 
wù¿ns_t
 
	$wù¿ns
 (cÚ¡ *
__´İ”ty
è
__THROW
;

221 
wšt_t
 
	$towù¿ns
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
è
__THROW
;

222 
__END_NAMESPACE_C99


224 #ifdeà
__USE_XOPEN2K8


226 
	~<xloÿË.h
>

230 
	$isw®num_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

236 
	$isw®pha_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

239 
	$iswúŒl_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

243 
	$iswdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

247 
	$iswg¿ph_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

252 
	$iswlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

255 
	$isw´št_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

260 
	$iswpunù_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

265 
	$isw¥aû_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

270 
	$iswuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

275 
	$iswxdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

280 
	$iswbÏnk_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

284 
wùy³_t
 
	$wùy³_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

285 
__THROW
;

289 
	$iswùy³_l
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
, 
__loÿË_t
 
__loÿË
)

290 
__THROW
;

298 
wšt_t
 
	$towlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

301 
wšt_t
 
	$towuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

305 
wù¿ns_t
 
	$wù¿ns_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

306 
__THROW
;

309 
wšt_t
 
	$towù¿ns_l
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
,

310 
__loÿË_t
 
__loÿË
è
__THROW
;

314 
__END_DECLS


	@/usr/include/xlocale.h

20 #iâdeà
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loÿË_¡ruù


30 
__loÿË_d©a
 *
	m__loÿËs
[13];

33 cÚ¡ *
	m__ùy³_b
;

34 cÚ¡ *
	m__ùy³_tŞow”
;

35 cÚ¡ *
	m__ùy³_touµ”
;

38 cÚ¡ *
	m__Çmes
[13];

39 } *
	t__loÿË_t
;

42 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/_G_config.h

4 #iâdeà
_G_cÚfig_h


5 
	#_G_cÚfig_h
 1

	)

9 
	~<b™s/ty³s.h
>

10 
	#__Ãed_size_t


	)

11 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


12 
	#__Ãed_wch¬_t


	)

14 
	#__Ãed_NULL


	)

15 
	~<¡ddef.h
>

16 
	#__Ãed_mb¡©e_t


	)

17 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


18 
	#__Ãed_wšt_t


	)

20 
	~<wch¬.h
>

23 
__off_t
 
	m__pos
;

24 
__mb¡©e_t
 
	m__¡©e
;

25 } 
	t_G_åos_t
;

28 
__off64_t
 
	m__pos
;

29 
__mb¡©e_t
 
	m__¡©e
;

30 } 
	t_G_åos64_t
;

31 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


32 
	~<gcÚv.h
>

35 
__gcÚv_šfo
 
	m__cd
;

38 
__gcÚv_šfo
 
	m__cd
;

39 
__gcÚv_¡•_d©a
 
	m__d©a
;

40 } 
	m__combšed
;

41 } 
	t_G_icÚv_t
;

46 
	#_G_va_li¡
 
__gnuc_va_li¡


	)

48 
	#_G_HAVE_MMAP
 1

	)

49 
	#_G_HAVE_MREMAP
 1

	)

51 
	#_G_IO_IO_FILE_VERSION
 0x20001

	)

54 
	#_G_HAVE_ST_BLKSIZE
 
	`defšed
 (
_STATBUF_ST_BLKSIZE
)

	)

56 
	#_G_BUFSIZ
 8192

	)

	@/usr/include/libunwind-common.h

26 
	#UNW_VERSION_MAJOR
 1

	)

27 
	#UNW_VERSION_MINOR
 1

	)

28 
	#UNW_VERSION_EXTRA


	)

30 
	#UNW_VERSION_CODE
(
maj
,
mš
è(((majè<< 16è| (mš))

	)

31 
	#UNW_VERSION
 
	`UNW_VERSION_CODE
(
UNW_VERSION_MAJOR
, 
UNW_VERSION_MINOR
)

	)

33 
	#UNW_PASTE2
(
x
,
y
èx##
	)
y

34 
	#UNW_PASTE
(
x
,
y
è
	`UNW_PASTE2
(x,y)

	)

35 
	#UNW_OBJ
(
â
è
	`UNW_PASTE
(
UNW_PREFIX
, fn)

	)

36 
	#UNW_ARCH_OBJ
(
â
è
	`UNW_PASTE
(UNW_PASTE(UNW_PASTE(
_U
,
UNW_TARGET
),
_
), fn)

	)

38 #ifdeà
UNW_LOCAL_ONLY


39 
	#UNW_PREFIX
 
	`UNW_PASTE
(UNW_PASTE(
_UL
,
UNW_TARGET
),
_
)

	)

41 
	#UNW_PREFIX
 
	`UNW_PASTE
(UNW_PASTE(
_U
,
UNW_TARGET
),
_
)

	)

48 
	mUNW_ESUCCESS
 = 0,

49 
	mUNW_EUNSPEC
,

50 
	mUNW_ENOMEM
,

51 
	mUNW_EBADREG
,

52 
	mUNW_EREADONLYREG
,

53 
	mUNW_ESTOPUNWIND
,

54 
	mUNW_EINVALIDIP
,

55 
	mUNW_EBADFRAME
,

56 
	mUNW_EINVAL
,

57 
	mUNW_EBADVERSION
,

58 
	mUNW_ENOINFO


60 
	tunw_”rÜ_t
;

71 
	mUNW_REG_IP
 = 
UNW_TDEP_IP
,

72 
	mUNW_REG_SP
 = 
UNW_TDEP_SP
,

73 
	mUNW_REG_EH
 = 
UNW_TDEP_EH
,

74 
	mUNW_REG_LAST
 = 
UNW_TDEP_LAST_REG


76 
	tunw_äame_»gnum_t
;

79 
	#UNW_NUM_EH_REGS
 
UNW_TDEP_NUM_EH_REGS


	)

83 
	mUNW_CACHE_NONE
,

84 
	mUNW_CACHE_GLOBAL
,

85 
	mUNW_CACHE_PER_THREAD


87 
	tunw_ÿchšg_pŞicy_t
;

89 
	tunw_»gnum_t
;

95 
	sunw_cursÜ


97 
unw_wÜd_t
 
	mİaque
[
UNW_TDEP_CURSOR_LEN
];

99 
	tunw_cursÜ_t
;

102 
unw_td•_cÚ‹xt_t
 
	tunw_cÚ‹xt_t
;

108 
	#unw_g‘cÚ‹xt
(
uc
è
	`unw_td•_g‘cÚ‹xt
(uc)

	)

113 
	#unw_is_å»g
(
r
è
	`unw_td•_is_å»g
Ô)

	)

115 
unw_td•_å»g_t
 
	tunw_å»g_t
;

117 
unw_addr_¥aû
 *
	tunw_addr_¥aû_t
;

121 
	#UNW_PI_FLAG_FIRST_TDEP_BIT
 16

	)

123 
	#UNW_PI_FLAG_DEBUG_FRAME
 32

	)

125 
	sunw_´oc_šfo


127 
unw_wÜd_t
 
	m¡¬t_
;

128 
unw_wÜd_t
 
	m’d_
;

129 
unw_wÜd_t
 
	mlsda
;

130 
unw_wÜd_t
 
	mhªdËr
;

131 
unw_wÜd_t
 
	mgp
;

132 
unw_wÜd_t
 
	mæags
;

134 
	mfÜm©
;

135 
	munwšd_šfo_size
;

136 *
	munwšd_šfo
;

137 
unw_td•_´oc_šfo_t
 
	mexŒa
;

139 
	tunw_´oc_šfo_t
;

144 
	sunw_acûssÜs


148 (*
	mfšd_´oc_šfo
è(
	munw_addr_¥aû_t
, 
	munw_wÜd_t
, 
	munw_´oc_šfo_t
 *,

154 (*
	mput_unwšd_šfo
è(
	munw_addr_¥aû_t
, 
	munw_´oc_šfo_t
 *, *);

158 (*
	mg‘_dyn_šfo_li¡_addr
è(
	munw_addr_¥aû_t
, 
	munw_wÜd_t
 *, *);

164 (*
	macûss_mem
è(
	munw_addr_¥aû_t
, 
	munw_wÜd_t
, unw_word_t *, ,

168 (*
	macûss_»g
è(
	munw_addr_¥aû_t
, 
	munw_»gnum_t
, 
	munw_wÜd_t
 *, ,

172 (*
	macûss_å»g
è(
	munw_addr_¥aû_t
, 
	munw_»gnum_t
,

173 
	munw_å»g_t
 *, , *);

175 (*
	m»sume
è(
	munw_addr_¥aû_t
, 
	munw_cursÜ_t
 *, *);

181 (*
	mg‘_´oc_Çme
è(
	munw_addr_¥aû_t
, 
	munw_wÜd_t
, *, 
	msize_t
,

182 
	munw_wÜd_t
 *, *);

184 
	tunw_acûssÜs_t
;

186 
	eunw_§ve_loc_ty³


188 
	mUNW_SLT_NONE
,

189 
	mUNW_SLT_MEMORY
,

190 
	mUNW_SLT_REG


192 
	tunw_§ve_loc_ty³_t
;

194 
	sunw_§ve_loc


196 
unw_§ve_loc_ty³_t
 
	mty³
;

199 
unw_wÜd_t
 
	maddr
;

200 
unw_»gnum_t
 
	m»gnum
;

202 
	mu
;

203 
unw_td•_§ve_loc_t
 
	mexŒa
;

205 
	tunw_§ve_loc_t
;

209 
	#unw_loÿl_addr_¥aû
 
	`UNW_OBJ
(
loÿl_addr_¥aû
)

	)

210 
	#unw_ü—‹_addr_¥aû
 
	`UNW_OBJ
(
ü—‹_addr_¥aû
)

	)

211 
	#unw_de¡roy_addr_¥aû
 
	`UNW_OBJ
(
de¡roy_addr_¥aû
)

	)

212 
	#unw_g‘_acûssÜs
 
	`UNW_ARCH_OBJ
(
g‘_acûssÜs
)

	)

213 
	#unw_š™_loÿl
 
	`UNW_OBJ
(
š™_loÿl
)

	)

214 
	#unw_š™_»mÙe
 
	`UNW_OBJ
(
š™_»mÙe
)

	)

215 
	#unw_¡•
 
	`UNW_OBJ
(
¡•
)

	)

216 
	#unw_»sume
 
	`UNW_OBJ
(
»sume
)

	)

217 
	#unw_g‘_´oc_šfo
 
	`UNW_OBJ
(
g‘_´oc_šfo
)

	)

218 
	#unw_g‘_´oc_šfo_by_
 
	`UNW_OBJ
(
g‘_´oc_šfo_by_
)

	)

219 
	#unw_g‘_»g
 
	`UNW_OBJ
(
g‘_»g
)

	)

220 
	#unw_£t_»g
 
	`UNW_OBJ
(
£t_»g
)

	)

221 
	#unw_g‘_å»g
 
	`UNW_OBJ
(
g‘_å»g
)

	)

222 
	#unw_£t_å»g
 
	`UNW_OBJ
(
£t_å»g
)

	)

223 
	#unw_g‘_§ve_loc
 
	`UNW_OBJ
(
g‘_§ve_loc
)

	)

224 
	#unw_is_sigÇl_äame
 
	`UNW_OBJ
(
is_sigÇl_äame
)

	)

225 
	#unw_hªdË_sigÇl_äame
 
	`UNW_OBJ
(
hªdË_sigÇl_äame
)

	)

226 
	#unw_g‘_´oc_Çme
 
	`UNW_OBJ
(
g‘_´oc_Çme
)

	)

227 
	#unw_£t_ÿchšg_pŞicy
 
	`UNW_OBJ
(
£t_ÿchšg_pŞicy
)

	)

228 
	#unw_»gÇme
 
	`UNW_ARCH_OBJ
(
»gÇme
)

	)

229 
	#unw_æush_ÿche
 
	`UNW_ARCH_OBJ
(
æush_ÿche
)

	)

230 
	#unw_¡»¼Ü
 
	`UNW_ARCH_OBJ
(
¡»¼Ü
)

	)

232 
unw_addr_¥aû_t
 
unw_ü—‹_addr_¥aû
 (
unw_acûssÜs_t
 *, );

233 
unw_de¡roy_addr_¥aû
 (
unw_addr_¥aû_t
);

234 
unw_acûssÜs_t
 *
unw_g‘_acûssÜs
 (
unw_addr_¥aû_t
);

235 
unw_æush_ÿche
 (
unw_addr_¥aû_t
, 
unw_wÜd_t
, unw_word_t);

236 
unw_£t_ÿchšg_pŞicy
 (
unw_addr_¥aû_t
, 
unw_ÿchšg_pŞicy_t
);

237 cÚ¡ *
unw_»gÇme
 (
unw_»gnum_t
);

239 
unw_š™_loÿl
 (
unw_cursÜ_t
 *, 
unw_cÚ‹xt_t
 *);

240 
unw_š™_»mÙe
 (
unw_cursÜ_t
 *, 
unw_addr_¥aû_t
, *);

241 
unw_¡•
 (
unw_cursÜ_t
 *);

242 
unw_»sume
 (
unw_cursÜ_t
 *);

243 
unw_g‘_´oc_šfo
 (
unw_cursÜ_t
 *, 
unw_´oc_šfo_t
 *);

244 
unw_g‘_´oc_šfo_by_
 (
unw_addr_¥aû_t
, 
unw_wÜd_t
,

245 
unw_´oc_šfo_t
 *, *);

246 
unw_g‘_»g
 (
unw_cursÜ_t
 *, , 
unw_wÜd_t
 *);

247 
unw_£t_»g
 (
unw_cursÜ_t
 *, , 
unw_wÜd_t
);

248 
unw_g‘_å»g
 (
unw_cursÜ_t
 *, , 
unw_å»g_t
 *);

249 
unw_£t_å»g
 (
unw_cursÜ_t
 *, , 
unw_å»g_t
);

250 
unw_g‘_§ve_loc
 (
unw_cursÜ_t
 *, , 
unw_§ve_loc_t
 *);

251 
unw_is_sigÇl_äame
 (
unw_cursÜ_t
 *);

252 
unw_hªdË_sigÇl_äame
 (
unw_cursÜ_t
 *);

253 
unw_g‘_´oc_Çme
 (
unw_cursÜ_t
 *, *, 
size_t
, 
unw_wÜd_t
 *);

254 cÚ¡ *
unw_¡»¼Ü
 ();

255 
unw_backŒaû
 (**, );

257 
unw_addr_¥aû_t
 
unw_loÿl_addr_¥aû
;

	@/usr/include/libunwind-dynamic.h

62 
	mUNW_DYN_STOP
 = 0,

63 
	mUNW_DYN_SAVE_REG
,

64 
	mUNW_DYN_SPILL_FP_REL
,

65 
	mUNW_DYN_SPILL_SP_REL
,

66 
	mUNW_DYN_ADD
,

67 
	mUNW_DYN_POP_FRAMES
,

68 
	mUNW_DYN_LABEL_STATE
,

69 
	mUNW_DYN_COPY_STATE
,

70 
	mUNW_DYN_ALIAS


72 
	tunw_dyn_İ”©iÚ_t
;

76 
	mUNW_INFO_FORMAT_DYNAMIC
,

77 
	mUNW_INFO_FORMAT_TABLE
,

78 
	mUNW_INFO_FORMAT_REMOTE_TABLE
,

79 
	mUNW_INFO_FORMAT_ARM_EXIDX


81 
	tunw_dyn_šfo_fÜm©_t
;

83 
	sunw_dyn_İ


85 
št8_t
 
	mg
;

86 
št8_t
 
	mqp
;

87 
št16_t
 
	m»g
;

88 
št32_t
 
	mwh’
;

89 
unw_wÜd_t
 
	mv®
;

91 
	tunw_dyn_İ_t
;

93 
	sunw_dyn_»giÚ_šfo


95 
unw_dyn_»giÚ_šfo
 *
	mÃxt
;

96 
št32_t
 
	mš¢_couÁ
;

97 
ušt32_t
 
	mİ_couÁ
;

98 
unw_dyn_İ_t
 
	mİ
[1];

100 
	tunw_dyn_»giÚ_šfo_t
;

102 
	sunw_dyn_´oc_šfo


104 
unw_wÜd_t
 
	mÇme_±r
;

105 
unw_wÜd_t
 
	mhªdËr
;

106 
ušt32_t
 
	mæags
;

107 
št32_t
 
	m·d0
;

108 
unw_dyn_»giÚ_šfo_t
 *
	m»giÚs
;

110 
	tunw_dyn_´oc_šfo_t
;

112 
	sunw_dyn_bË_šfo


114 
unw_wÜd_t
 
	mÇme_±r
;

115 
unw_wÜd_t
 
	m£gba£
;

116 
unw_wÜd_t
 
	mbË_Ën
;

117 
unw_wÜd_t
 *
	mbË_d©a
;

119 
	tunw_dyn_bË_šfo_t
;

121 
	sunw_dyn_»mÙe_bË_šfo


123 
unw_wÜd_t
 
	mÇme_±r
;

124 
unw_wÜd_t
 
	m£gba£
;

125 
unw_wÜd_t
 
	mbË_Ën
;

126 
unw_wÜd_t
 
	mbË_d©a
;

128 
	tunw_dyn_»mÙe_bË_šfo_t
;

130 
	sunw_dyn_šfo


133 
unw_dyn_šfo
 *
	mÃxt
;

134 
unw_dyn_šfo
 *
	m´ev
;

135 
unw_wÜd_t
 
	m¡¬t_
;

136 
unw_wÜd_t
 
	m’d_
;

137 
unw_wÜd_t
 
	mgp
;

138 
št32_t
 
	mfÜm©
;

139 
št32_t
 
	m·d
;

142 
unw_dyn_´oc_šfo_t
 
	mpi
;

143 
unw_dyn_bË_šfo_t
 
	mti
;

144 
unw_dyn_»mÙe_bË_šfo_t
 
	m¹i
;

146 
	mu
;

148 
	tunw_dyn_šfo_t
;

150 
	sunw_dyn_šfo_li¡


152 
ušt32_t
 
	mv”siÚ
;

153 
ušt32_t
 
	mg’”©iÚ
;

154 
unw_dyn_šfo_t
 *
	mfœ¡
;

156 
	tunw_dyn_šfo_li¡_t
;

160 
	#_U_dyn_»giÚ_šfo_size
(
İ_couÁ
) \

161 ((*è(((
unw_dyn_»giÚ_šfo_t
 *è
NULL
)->
İ
 + (
İ_couÁ
)) \

162 - (*è
NULL
)

	)

166 
_U_dyn_»gi¡”
 (
unw_dyn_šfo_t
 *);

170 
_U_dyn_ÿnûl
 (
unw_dyn_šfo_t
 *);

175 
	#_U_dyn_İ
(
_g
, 
_qp
, 
_wh’
, 
_»g
, 
_v®
) \

176 ((
unw_dyn_İ_t
è{ (
_g
), (
_qp
), (
_»g
), (
_wh’
), (
_v®
è})

	)

178 
	#_U_dyn_İ_§ve_»g
(
İ
, 
qp
, 
wh’
, 
»g
, 
d¡
) \

179 (*(
İ
èğ
	`_U_dyn_İ
 (
UNW_DYN_SAVE_REG
, (
qp
), (
wh’
), (
»g
), (
d¡
)))

	)

181 
	#_U_dyn_İ_¥l_å_»l
(
İ
, 
qp
, 
wh’
, 
»g
, 
off£t
) \

182 (*(
İ
èğ
	`_U_dyn_İ
 (
UNW_DYN_SPILL_FP_REL
, (
qp
), (
wh’
), (
»g
), \

183 (
off£t
)))

	)

185 
	#_U_dyn_İ_¥l_¥_»l
(
İ
, 
qp
, 
wh’
, 
»g
, 
off£t
) \

186 (*(
İ
èğ
	`_U_dyn_İ
 (
UNW_DYN_SPILL_SP_REL
, (
qp
), (
wh’
), (
»g
), \

187 (
off£t
)))

	)

189 
	#_U_dyn_İ_add
(
İ
, 
qp
, 
wh’
, 
»g
, 
v®ue
) \

190 (*(
İ
èğ
	`_U_dyn_İ
 (
UNW_DYN_ADD
, (
qp
), (
wh’
), (
»g
), (
v®ue
)))

	)

192 
	#_U_dyn_İ_pİ_äames
(
İ
, 
qp
, 
wh’
, 
num_äames
) \

193 (*(
İ
èğ
	`_U_dyn_İ
 (
UNW_DYN_POP_FRAMES
, (
qp
), (
wh’
), 0, (
num_äames
)))

	)

195 
	#_U_dyn_İ_Ïb–_¡©e
(
İ
, 
Ïb–
) \

196 (*(
İ
èğ
	`_U_dyn_İ
 (
UNW_DYN_LABEL_STATE
, 
_U_QP_TRUE
, -1, 0, (
Ïb–
)))

	)

198 
	#_U_dyn_İ_cİy_¡©e
(
İ
, 
Ïb–
) \

199 (*(
İ
èğ
	`_U_dyn_İ
 (
UNW_DYN_COPY_STATE
, 
_U_QP_TRUE
, -1, 0, (
Ïb–
)))

	)

201 
	#_U_dyn_İ_®Ÿs
(
İ
, 
qp
, 
wh’
, 
addr
) \

202 (*(
İ
èğ
	`_U_dyn_İ
 (
UNW_DYN_ALIAS
, (
qp
), (
wh’
), 0, (
addr
)))

	)

204 
	#_U_dyn_İ_¡İ
(
İ
) \

205 (*(
İ
èğ
	`_U_dyn_İ
 (
UNW_DYN_STOP
, 
_U_QP_TRUE
, -1, 0, 0))

	)

210 
	#_U_QP_TRUE
 
_U_TDEP_QP_TRUE


	)

	@/usr/include/gconv.h

22 #iâdeà
_GCONV_H


23 
	#_GCONV_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	#__Ãed_mb¡©e_t


	)

27 
	#__Ãed_wšt_t


	)

28 
	~<wch¬.h
>

29 
	#__Ãed_size_t


	)

30 
	#__Ãed_wch¬_t


	)

31 
	~<¡ddef.h
>

34 
	#__UNKNOWN_10646_CHAR
 ((
wch¬_t
è0xfffd)

	)

39 
	m__GCONV_OK
 = 0,

40 
	m__GCONV_NOCONV
,

41 
	m__GCONV_NODB
,

42 
	m__GCONV_NOMEM
,

44 
	m__GCONV_EMPTY_INPUT
,

45 
	m__GCONV_FULL_OUTPUT
,

46 
	m__GCONV_ILLEGAL_INPUT
,

47 
	m__GCONV_INCOMPLETE_INPUT
,

49 
	m__GCONV_ILLEGAL_DESCRIPTOR
,

50 
	m__GCONV_INTERNAL_ERROR


57 
	m__GCONV_IS_LAST
 = 0x0001,

58 
	m__GCONV_IGNORE_ERRORS
 = 0x0002,

59 
	m__GCONV_SWAP
 = 0x0004,

60 
	m__GCONV_TRANSLIT
 = 0x0008

65 
	g__gcÚv_¡•
;

66 
	g__gcÚv_¡•_d©a
;

67 
	g__gcÚv_lßded_objeù
;

71 (*
	t__gcÚv_fù
è(
	t__gcÚv_¡•
 *, 
	t__gcÚv_¡•_d©a
 *,

73 **, 
	tsize_t
 *, , );

76 
	$wšt_t
 (*
	t__gcÚv_btowc_fù
è(
	t__gcÚv_¡•
 *, );

79 (*
	t__gcÚv_š™_fù
è(
	t__gcÚv_¡•
 *);

80 (*
	t__gcÚv_’d_fù
è(
	t__gcÚv_¡•
 *);

84 
	s__gcÚv_¡•


86 
__gcÚv_lßded_objeù
 *
__shlib_hªdË
;

87 cÚ¡ *
__modÇme
;

89 
__couÁ”
;

91 *
__äom_Çme
;

92 *
__to_Çme
;

94 
__gcÚv_fù
 
__fù
;

95 
__gcÚv_btowc_fù
 
__btowc_fù
;

96 
__gcÚv_š™_fù
 
__š™_fù
;

97 
__gcÚv_’d_fù
 
__’d_fù
;

101 
__mš_Ãeded_äom
;

102 
__max_Ãeded_äom
;

103 
__mš_Ãeded_to
;

104 
__max_Ãeded_to
;

107 
__¡©eful
;

109 *
__d©a
;

114 
	s__gcÚv_¡•_d©a


116 *
__outbuf
;

117 *
__outbuãnd
;

121 
__æags
;

125 
__švoÿtiÚ_couÁ”
;

129 
__š‹º®_u£
;

131 
__mb¡©e_t
 *
__¡©•
;

132 
__mb¡©e_t
 
__¡©e
;

138 
	s__gcÚv_šfo


140 
size_t
 
__n¡•s
;

141 
__gcÚv_¡•
 *
__¡•s
;

142 
__ex‹nsiÚ__
 
__gcÚv_¡•_d©a
 
__d©a
 
__æex¬r
;

143 } *
	t__gcÚv_t
;

146 
	`__gcÚv_Œª¦™”©e
 (
__gcÚv_¡•
 *
¡•
,

147 
__gcÚv_¡•_d©a
 *
¡•_d©a
,

148 cÚ¡ *
šbuf¡¬t
,

149 cÚ¡ **
šbuå
,

150 cÚ¡ *
šbuãnd
,

151 **
outbuf¡¬t
,

152 
size_t
 *
œ»v”sibË
);

	@
1
.
1
/usr/include
424
11394
deps/hiredis/adapters/ae.h
deps/hiredis/adapters/glib.h
deps/hiredis/adapters/ivykis.h
deps/hiredis/adapters/libev.h
deps/hiredis/adapters/libevent.h
deps/hiredis/adapters/libuv.h
deps/hiredis/adapters/macosx.h
deps/hiredis/adapters/qt.h
deps/hiredis/async.c
deps/hiredis/async.h
deps/hiredis/dict.c
deps/hiredis/dict.h
deps/hiredis/examples/example-ae.c
deps/hiredis/examples/example-glib.c
deps/hiredis/examples/example-ivykis.c
deps/hiredis/examples/example-libev.c
deps/hiredis/examples/example-libevent.c
deps/hiredis/examples/example-libuv.c
deps/hiredis/examples/example-macosx.c
deps/hiredis/examples/example-qt.cpp
deps/hiredis/examples/example-qt.h
deps/hiredis/examples/example.c
deps/hiredis/fmacros.h
deps/hiredis/hiredis.c
deps/hiredis/hiredis.h
deps/hiredis/net.c
deps/hiredis/net.h
deps/hiredis/read.c
deps/hiredis/read.h
deps/hiredis/sds.c
deps/hiredis/sds.h
deps/hiredis/sdsalloc.h
deps/hiredis/test.c
deps/hiredis/win32.h
deps/jemalloc/include/jemalloc/internal/arena.h
deps/jemalloc/include/jemalloc/internal/atomic.h
deps/jemalloc/include/jemalloc/internal/base.h
deps/jemalloc/include/jemalloc/internal/bitmap.h
deps/jemalloc/include/jemalloc/internal/chunk.h
deps/jemalloc/include/jemalloc/internal/chunk_dss.h
deps/jemalloc/include/jemalloc/internal/chunk_mmap.h
deps/jemalloc/include/jemalloc/internal/ckh.h
deps/jemalloc/include/jemalloc/internal/ctl.h
deps/jemalloc/include/jemalloc/internal/extent.h
deps/jemalloc/include/jemalloc/internal/hash.h
deps/jemalloc/include/jemalloc/internal/huge.h
deps/jemalloc/include/jemalloc/internal/jemalloc_internal.h
deps/jemalloc/include/jemalloc/internal/jemalloc_internal_decls.h
deps/jemalloc/include/jemalloc/internal/jemalloc_internal_defs.h
deps/jemalloc/include/jemalloc/internal/jemalloc_internal_macros.h
deps/jemalloc/include/jemalloc/internal/mb.h
deps/jemalloc/include/jemalloc/internal/mutex.h
deps/jemalloc/include/jemalloc/internal/pages.h
deps/jemalloc/include/jemalloc/internal/private_namespace.h
deps/jemalloc/include/jemalloc/internal/private_unnamespace.h
deps/jemalloc/include/jemalloc/internal/prng.h
deps/jemalloc/include/jemalloc/internal/prof.h
deps/jemalloc/include/jemalloc/internal/public_namespace.h
deps/jemalloc/include/jemalloc/internal/public_unnamespace.h
deps/jemalloc/include/jemalloc/internal/ql.h
deps/jemalloc/include/jemalloc/internal/qr.h
deps/jemalloc/include/jemalloc/internal/quarantine.h
deps/jemalloc/include/jemalloc/internal/rb.h
deps/jemalloc/include/jemalloc/internal/rtree.h
deps/jemalloc/include/jemalloc/internal/size_classes.h
deps/jemalloc/include/jemalloc/internal/stats.h
deps/jemalloc/include/jemalloc/internal/tcache.h
deps/jemalloc/include/jemalloc/internal/tsd.h
deps/jemalloc/include/jemalloc/internal/util.h
deps/jemalloc/include/jemalloc/internal/valgrind.h
deps/jemalloc/include/jemalloc/jemalloc.h
deps/jemalloc/include/jemalloc/jemalloc_defs.h
deps/jemalloc/include/jemalloc/jemalloc_macros.h
deps/jemalloc/include/jemalloc/jemalloc_mangle.h
deps/jemalloc/include/jemalloc/jemalloc_mangle_jet.h
deps/jemalloc/include/jemalloc/jemalloc_protos.h
deps/jemalloc/include/jemalloc/jemalloc_protos_jet.h
deps/jemalloc/include/jemalloc/jemalloc_rename.h
deps/jemalloc/include/jemalloc/jemalloc_typedefs.h
deps/jemalloc/include/msvc_compat/C99/stdbool.h
deps/jemalloc/include/msvc_compat/C99/stdint.h
deps/jemalloc/include/msvc_compat/strings.h
deps/jemalloc/include/msvc_compat/windows_extra.h
deps/jemalloc/src/arena.c
deps/jemalloc/src/atomic.c
deps/jemalloc/src/base.c
deps/jemalloc/src/bitmap.c
deps/jemalloc/src/chunk.c
deps/jemalloc/src/chunk_dss.c
deps/jemalloc/src/chunk_mmap.c
deps/jemalloc/src/ckh.c
deps/jemalloc/src/ctl.c
deps/jemalloc/src/extent.c
deps/jemalloc/src/hash.c
deps/jemalloc/src/huge.c
deps/jemalloc/src/jemalloc.c
deps/jemalloc/src/mb.c
deps/jemalloc/src/mutex.c
deps/jemalloc/src/pages.c
deps/jemalloc/src/prof.c
deps/jemalloc/src/quarantine.c
deps/jemalloc/src/rtree.c
deps/jemalloc/src/stats.c
deps/jemalloc/src/tcache.c
deps/jemalloc/src/tsd.c
deps/jemalloc/src/util.c
deps/jemalloc/src/valgrind.c
deps/jemalloc/src/zone.c
deps/jemalloc/test/include/test/SFMT-alti.h
deps/jemalloc/test/include/test/SFMT-params.h
deps/jemalloc/test/include/test/SFMT-params11213.h
deps/jemalloc/test/include/test/SFMT-params1279.h
deps/jemalloc/test/include/test/SFMT-params132049.h
deps/jemalloc/test/include/test/SFMT-params19937.h
deps/jemalloc/test/include/test/SFMT-params216091.h
deps/jemalloc/test/include/test/SFMT-params2281.h
deps/jemalloc/test/include/test/SFMT-params4253.h
deps/jemalloc/test/include/test/SFMT-params44497.h
deps/jemalloc/test/include/test/SFMT-params607.h
deps/jemalloc/test/include/test/SFMT-params86243.h
deps/jemalloc/test/include/test/SFMT-sse2.h
deps/jemalloc/test/include/test/SFMT.h
deps/jemalloc/test/include/test/btalloc.h
deps/jemalloc/test/include/test/jemalloc_test.h
deps/jemalloc/test/include/test/jemalloc_test_defs.h
deps/jemalloc/test/include/test/math.h
deps/jemalloc/test/include/test/mq.h
deps/jemalloc/test/include/test/mtx.h
deps/jemalloc/test/include/test/test.h
deps/jemalloc/test/include/test/thd.h
deps/jemalloc/test/include/test/timer.h
deps/jemalloc/test/integration/MALLOCX_ARENA.c
deps/jemalloc/test/integration/aligned_alloc.c
deps/jemalloc/test/integration/allocated.c
deps/jemalloc/test/integration/chunk.c
deps/jemalloc/test/integration/mallocx.c
deps/jemalloc/test/integration/overflow.c
deps/jemalloc/test/integration/posix_memalign.c
deps/jemalloc/test/integration/rallocx.c
deps/jemalloc/test/integration/sdallocx.c
deps/jemalloc/test/integration/thread_arena.c
deps/jemalloc/test/integration/thread_tcache_enabled.c
deps/jemalloc/test/integration/xallocx.c
deps/jemalloc/test/src/SFMT.c
deps/jemalloc/test/src/btalloc.c
deps/jemalloc/test/src/btalloc_0.c
deps/jemalloc/test/src/btalloc_1.c
deps/jemalloc/test/src/math.c
deps/jemalloc/test/src/mq.c
deps/jemalloc/test/src/mtx.c
deps/jemalloc/test/src/test.c
deps/jemalloc/test/src/thd.c
deps/jemalloc/test/src/timer.c
deps/jemalloc/test/stress/microbench.c
deps/jemalloc/test/unit/SFMT.c
deps/jemalloc/test/unit/atomic.c
deps/jemalloc/test/unit/bitmap.c
deps/jemalloc/test/unit/ckh.c
deps/jemalloc/test/unit/hash.c
deps/jemalloc/test/unit/junk.c
deps/jemalloc/test/unit/junk_alloc.c
deps/jemalloc/test/unit/junk_free.c
deps/jemalloc/test/unit/lg_chunk.c
deps/jemalloc/test/unit/mallctl.c
deps/jemalloc/test/unit/math.c
deps/jemalloc/test/unit/mq.c
deps/jemalloc/test/unit/mtx.c
deps/jemalloc/test/unit/prof_accum.c
deps/jemalloc/test/unit/prof_active.c
deps/jemalloc/test/unit/prof_gdump.c
deps/jemalloc/test/unit/prof_idump.c
deps/jemalloc/test/unit/prof_reset.c
deps/jemalloc/test/unit/prof_thread_name.c
deps/jemalloc/test/unit/ql.c
deps/jemalloc/test/unit/qr.c
deps/jemalloc/test/unit/quarantine.c
deps/jemalloc/test/unit/rb.c
deps/jemalloc/test/unit/rtree.c
deps/jemalloc/test/unit/size_classes.c
deps/jemalloc/test/unit/stats.c
deps/jemalloc/test/unit/tsd.c
deps/jemalloc/test/unit/util.c
deps/jemalloc/test/unit/zero.c
deps/linenoise/example.c
deps/linenoise/linenoise.c
deps/linenoise/linenoise.h
deps/lua/etc/all.c
deps/lua/etc/lua.hpp
deps/lua/etc/min.c
deps/lua/etc/noparser.c
deps/lua/src/fpconv.c
deps/lua/src/fpconv.h
deps/lua/src/lapi.c
deps/lua/src/lapi.h
deps/lua/src/lauxlib.c
deps/lua/src/lauxlib.h
deps/lua/src/lbaselib.c
deps/lua/src/lcode.c
deps/lua/src/lcode.h
deps/lua/src/ldblib.c
deps/lua/src/ldebug.c
deps/lua/src/ldebug.h
deps/lua/src/ldo.c
deps/lua/src/ldo.h
deps/lua/src/ldump.c
deps/lua/src/lfunc.c
deps/lua/src/lfunc.h
deps/lua/src/lgc.c
deps/lua/src/lgc.h
deps/lua/src/linit.c
deps/lua/src/liolib.c
deps/lua/src/llex.c
deps/lua/src/llex.h
deps/lua/src/llimits.h
deps/lua/src/lmathlib.c
deps/lua/src/lmem.c
deps/lua/src/lmem.h
deps/lua/src/loadlib.c
deps/lua/src/lobject.c
deps/lua/src/lobject.h
deps/lua/src/lopcodes.c
deps/lua/src/lopcodes.h
deps/lua/src/loslib.c
deps/lua/src/lparser.c
deps/lua/src/lparser.h
deps/lua/src/lstate.c
deps/lua/src/lstate.h
deps/lua/src/lstring.c
deps/lua/src/lstring.h
deps/lua/src/lstrlib.c
deps/lua/src/ltable.c
deps/lua/src/ltable.h
deps/lua/src/ltablib.c
deps/lua/src/ltm.c
deps/lua/src/ltm.h
deps/lua/src/lua.c
deps/lua/src/lua.h
deps/lua/src/lua_bit.c
deps/lua/src/lua_cjson.c
deps/lua/src/lua_cmsgpack.c
deps/lua/src/lua_struct.c
deps/lua/src/luac.c
deps/lua/src/luaconf.h
deps/lua/src/lualib.h
deps/lua/src/lundump.c
deps/lua/src/lundump.h
deps/lua/src/lvm.c
deps/lua/src/lvm.h
deps/lua/src/lzio.c
deps/lua/src/lzio.h
deps/lua/src/print.c
deps/lua/src/strbuf.c
deps/lua/src/strbuf.h
src/adlist.c
src/adlist.h
src/ae.c
src/ae.h
src/ae_epoll.c
src/ae_evport.c
src/ae_kqueue.c
src/ae_select.c
src/anet.c
src/anet.h
src/aof.c
src/asciilogo.h
src/atomicvar.h
src/bio.c
src/bio.h
src/bitops.c
src/blocked.c
src/childinfo.c
src/cluster.c
src/cluster.h
src/config.c
src/config.h
src/crc16.c
src/crc64.c
src/crc64.h
src/db.c
src/debug.c
src/debugmacro.h
src/defrag.c
src/dict.c
src/dict.h
src/endianconv.c
src/endianconv.h
src/evict.c
src/expire.c
src/fmacros.h
src/geo.c
src/geo.h
src/geohash.c
src/geohash.h
src/geohash_helper.c
src/geohash_helper.h
src/help.h
src/hyperloglog.c
src/intset.c
src/intset.h
src/latency.c
src/latency.h
src/lazyfree.c
src/lzf.h
src/lzfP.h
src/lzf_c.c
src/lzf_d.c
src/memtest.c
src/module.c
src/modules/helloblock.c
src/modules/hellotype.c
src/modules/helloworld.c
src/modules/testmodule.c
src/multi.c
src/networking.c
src/notify.c
src/object.c
src/pqsort.c
src/pqsort.h
src/pubsub.c
src/quicklist.c
src/quicklist.h
src/rand.c
src/rand.h
src/rax.c
src/rax.h
src/rax_malloc.h
src/rdb.c
src/rdb.h
src/redis-benchmark.c
src/redis-check-aof.c
src/redis-check-rdb.c
src/redis-cli.c
src/redisassert.h
src/redismodule.h
src/release.c
src/release.h
src/replication.c
src/rio.c
src/rio.h
src/scripting.c
src/sds.c
src/sds.h
src/sdsalloc.h
src/sentinel.c
src/server.c
src/server.h
src/setproctitle.c
src/sha1.c
src/sha1.h
src/siphash.c
src/slowlog.c
src/slowlog.h
src/solarisfixes.h
src/sort.c
src/sparkline.c
src/sparkline.h
src/syncio.c
src/t_hash.c
src/t_list.c
src/t_set.c
src/t_string.c
src/t_zset.c
src/testhelp.h
src/util.c
src/util.h
src/version.h
src/ziplist.c
src/ziplist.h
src/zipmap.c
src/zipmap.h
src/zmalloc.c
src/zmalloc.h
utils/corrupt_rdb.c
utils/hashtable/rehashing.c
utils/lru/lfu-simulation.c
/usr/include/alloca.h
/usr/include/arpa/inet.h
/usr/include/assert.h
/usr/include/ctype.h
/usr/include/dlfcn.h
/usr/include/endian.h
/usr/include/errno.h
/usr/include/execinfo.h
/usr/include/fcntl.h
/usr/include/features.h
/usr/include/inttypes.h
/usr/include/libunwind.h
/usr/include/limits.h
/usr/include/linux/version.h
/usr/include/locale.h
/usr/include/malloc.h
/usr/include/math.h
/usr/include/netdb.h
/usr/include/netinet/in.h
/usr/include/netinet/tcp.h
/usr/include/poll.h
/usr/include/pthread.h
/usr/include/setjmp.h
/usr/include/signal.h
/usr/include/stdint.h
/usr/include/stdio.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/strings.h
/usr/include/stropts.h
/usr/include/syslog.h
/usr/include/termios.h
/usr/include/time.h
/usr/include/ucontext.h
/usr/include/unistd.h
/usr/include/unwind.h
/usr/include/wchar.h
/usr/include/getopt.h
/usr/include/libio.h
/usr/include/libunwind-x86_64.h
/usr/include/rpc/netdb.h
/usr/include/sched.h
/usr/include/stdc-predef.h
/usr/include/wctype.h
/usr/include/xlocale.h
/usr/include/_G_config.h
/usr/include/libunwind-common.h
/usr/include/libunwind-dynamic.h
/usr/include/gconv.h
